<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 20077:34e6d6fe6fb76c64b63f080f9d317dc487624f31</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 34e6d6fe6fb76c64b63f080f9d317dc487624f31" />
<meta property="og:url" content="/comm-central/rev/34e6d6fe6fb76c64b63f080f9d317dc487624f31" />
<meta property="og:description" content="Bug 1280898 - Set up eslint for calendar files - enable consistent-this and no-useless-call rule. r=MakeMyDay" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 34e6d6fe6fb76c64b63f080f9d317dc487624f31 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/34e6d6fe6fb76c64b63f080f9d317dc487624f31">shortlog</a> |
<a href="/comm-central/log/34e6d6fe6fb76c64b63f080f9d317dc487624f31">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/34e6d6fe6fb76c64b63f080f9d317dc487624f31">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/34e6d6fe6fb76c64b63f080f9d317dc487624f31">files</a> |
changeset |
<a href="/comm-central/raw-rev/34e6d6fe6fb76c64b63f080f9d317dc487624f31">raw</a>  | <a href="/comm-central/archive/34e6d6fe6fb76c64b63f080f9d317dc487624f31.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1280898">Bug 1280898</a> - Set up eslint for calendar files - enable consistent-this and no-useless-call rule. r=MakeMyDay
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#101;&#115;&#108;&#105;&#110;&#116;&#32;&#60;&#101;&#115;&#108;&#105;&#110;&#116;&#64;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#46;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 08 Jul 2016 14:08:17 +0200</td></tr>

<tr>
 <td>changeset 20077</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/34e6d6fe6fb76c64b63f080f9d317dc487624f31">34e6d6fe6fb76c64b63f080f9d317dc487624f31</a></td>
</tr>



<tr>
<td>parent 20076</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a404e55737c5a45d652384b3a15c6099b9160dbe">a404e55737c5a45d652384b3a15c6099b9160dbe</a>
</td>
</tr>

<tr>
<td>child 20078</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a53c49ed8ab37da97d6a5fc6f660efd9841a259b">a53c49ed8ab37da97d6a5fc6f660efd9841a259b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=34e6d6fe6fb76c64b63f080f9d317dc487624f31">12309</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Sat, 17 Sep 2016 23:27:52 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@5e136b6a5e3e [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5e136b6a5e3e41cb11cdea756880e425c08d853c">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5e136b6a5e3e41cb11cdea756880e425c08d853c&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5e136b6a5e3e41cb11cdea756880e425c08d853c&newProject=comm-central&newRevision=7e687a2148febd47826bef8a486c1d7697287526&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5e136b6a5e3e41cb11cdea756880e425c08d853c&newProject=comm-central&newRevision=7e687a2148febd47826bef8a486c1d7697287526&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5e136b6a5e3e41cb11cdea756880e425c08d853c&newProject=comm-central&newRevision=7e687a2148febd47826bef8a486c1d7697287526&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28MakeMyDay%29&revcount=50">MakeMyDay</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1280898">1280898</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1280898">Bug 1280898</a> - Set up eslint for calendar files - enable consistent-this and no-useless-call rule. r=MakeMyDay

MozReview-Commit-ID: CJ5anO9j2VX</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/.eslintrc">calendar/.eslintrc</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/.eslintrc">file</a> |
<a href="/comm-central/annotate/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/.eslintrc">annotate</a> |
<a href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/.eslintrc">diff</a> |
<a href="/comm-central/comparison/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/.eslintrc">comparison</a> |
<a href="/comm-central/log/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/.eslintrc">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/backend/icaljs/calICSService.js">calendar/base/backend/icaljs/calICSService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/backend/icaljs/calICSService.js">file</a> |
<a href="/comm-central/annotate/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/backend/icaljs/calICSService.js">annotate</a> |
<a href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/backend/icaljs/calICSService.js">diff</a> |
<a href="/comm-central/comparison/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/backend/icaljs/calICSService.js">comparison</a> |
<a href="/comm-central/log/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/backend/icaljs/calICSService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/content/calendar-month-view.xml">calendar/base/content/calendar-month-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/content/calendar-month-view.xml">file</a> |
<a href="/comm-central/annotate/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/content/calendar-month-view.xml">annotate</a> |
<a href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/content/calendar-month-view.xml">diff</a> |
<a href="/comm-central/comparison/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/content/calendar-month-view.xml">comparison</a> |
<a href="/comm-central/log/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/content/calendar-month-view.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/content/calendar-multiday-view.xml">calendar/base/content/calendar-multiday-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/content/calendar-multiday-view.xml">file</a> |
<a href="/comm-central/annotate/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/content/calendar-multiday-view.xml">annotate</a> |
<a href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/content/calendar-multiday-view.xml">diff</a> |
<a href="/comm-central/comparison/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/content/calendar-multiday-view.xml">comparison</a> |
<a href="/comm-central/log/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/content/calendar-multiday-view.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/modules/calItipUtils.jsm">calendar/base/modules/calItipUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/modules/calItipUtils.jsm">file</a> |
<a href="/comm-central/annotate/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/modules/calItipUtils.jsm">annotate</a> |
<a href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/modules/calItipUtils.jsm">diff</a> |
<a href="/comm-central/comparison/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/modules/calItipUtils.jsm">comparison</a> |
<a href="/comm-central/log/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/modules/calItipUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/modules/calProviderUtils.jsm">calendar/base/modules/calProviderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/modules/calProviderUtils.jsm">file</a> |
<a href="/comm-central/annotate/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/modules/calProviderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/modules/calProviderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/modules/calProviderUtils.jsm">comparison</a> |
<a href="/comm-central/log/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/modules/calProviderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calCachedCalendar.js">calendar/base/src/calCachedCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calCachedCalendar.js">file</a> |
<a href="/comm-central/annotate/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calCachedCalendar.js">annotate</a> |
<a href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calCachedCalendar.js">diff</a> |
<a href="/comm-central/comparison/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calCachedCalendar.js">comparison</a> |
<a href="/comm-central/log/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calCachedCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calCalendarSearchService.js">calendar/base/src/calCalendarSearchService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calCalendarSearchService.js">file</a> |
<a href="/comm-central/annotate/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calCalendarSearchService.js">annotate</a> |
<a href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calCalendarSearchService.js">diff</a> |
<a href="/comm-central/comparison/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calCalendarSearchService.js">comparison</a> |
<a href="/comm-central/log/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calCalendarSearchService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calFreeBusyService.js">calendar/base/src/calFreeBusyService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calFreeBusyService.js">file</a> |
<a href="/comm-central/annotate/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calFreeBusyService.js">annotate</a> |
<a href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calFreeBusyService.js">diff</a> |
<a href="/comm-central/comparison/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calFreeBusyService.js">comparison</a> |
<a href="/comm-central/log/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calFreeBusyService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calIcsParser.js">calendar/base/src/calIcsParser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calIcsParser.js">file</a> |
<a href="/comm-central/annotate/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calIcsParser.js">annotate</a> |
<a href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calIcsParser.js">diff</a> |
<a href="/comm-central/comparison/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calIcsParser.js">comparison</a> |
<a href="/comm-central/log/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/base/src/calIcsParser.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/ics/calICSCalendar.js">calendar/providers/ics/calICSCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/ics/calICSCalendar.js">file</a> |
<a href="/comm-central/annotate/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/ics/calICSCalendar.js">annotate</a> |
<a href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/ics/calICSCalendar.js">diff</a> |
<a href="/comm-central/comparison/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/ics/calICSCalendar.js">comparison</a> |
<a href="/comm-central/log/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/ics/calICSCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/memory/calMemoryCalendar.js">calendar/providers/memory/calMemoryCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/memory/calMemoryCalendar.js">file</a> |
<a href="/comm-central/annotate/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/memory/calMemoryCalendar.js">annotate</a> |
<a href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/memory/calMemoryCalendar.js">diff</a> |
<a href="/comm-central/comparison/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/memory/calMemoryCalendar.js">comparison</a> |
<a href="/comm-central/log/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/memory/calMemoryCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/wcap/calWcapCalendar.js">calendar/providers/wcap/calWcapCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/wcap/calWcapCalendar.js">file</a> |
<a href="/comm-central/annotate/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/wcap/calWcapCalendar.js">annotate</a> |
<a href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/wcap/calWcapCalendar.js">diff</a> |
<a href="/comm-central/comparison/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/wcap/calWcapCalendar.js">comparison</a> |
<a href="/comm-central/log/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/wcap/calWcapCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/wcap/calWcapCalendarItems.js">calendar/providers/wcap/calWcapCalendarItems.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/wcap/calWcapCalendarItems.js">file</a> |
<a href="/comm-central/annotate/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/wcap/calWcapCalendarItems.js">annotate</a> |
<a href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/wcap/calWcapCalendarItems.js">diff</a> |
<a href="/comm-central/comparison/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/wcap/calWcapCalendarItems.js">comparison</a> |
<a href="/comm-central/log/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/wcap/calWcapCalendarItems.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/wcap/calWcapSession.js">calendar/providers/wcap/calWcapSession.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/wcap/calWcapSession.js">file</a> |
<a href="/comm-central/annotate/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/wcap/calWcapSession.js">annotate</a> |
<a href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/wcap/calWcapSession.js">diff</a> |
<a href="/comm-central/comparison/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/wcap/calWcapSession.js">comparison</a> |
<a href="/comm-central/log/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/providers/wcap/calWcapSession.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/resources/content/datetimepickers/datetimepickers.xml">calendar/resources/content/datetimepickers/datetimepickers.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/resources/content/datetimepickers/datetimepickers.xml">file</a> |
<a href="/comm-central/annotate/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/resources/content/datetimepickers/datetimepickers.xml">annotate</a> |
<a href="/comm-central/diff/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/resources/content/datetimepickers/datetimepickers.xml">diff</a> |
<a href="/comm-central/comparison/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/resources/content/datetimepickers/datetimepickers.xml">comparison</a> |
<a href="/comm-central/log/34e6d6fe6fb76c64b63f080f9d317dc487624f31/calendar/resources/content/datetimepickers/datetimepickers.xml">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/.eslintrc</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/.eslintrc</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -374,13 +374,19 @@</span>
<a href="#l1.4"></a><span id="l1.4">     &quot;accessor-pairs&quot;: 2,</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">     // Enforce spaces inside of single line blocks</span>
<a href="#l1.7"></a><span id="l1.7">     &quot;block-spacing&quot;: [2, &quot;always&quot;],</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9">     // Disallow spaces inside of computed properties</span>
<a href="#l1.10"></a><span id="l1.10">     &quot;computed-property-spacing&quot;: [2, &quot;never&quot;],</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+    // Require consistent this (using |self|)</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    &quot;consistent-this&quot;: [2, &quot;self&quot;],</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+    // Disallow unnecessary .call() and .apply()</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+    &quot;no-useless-call&quot;: 2,</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+</span>
<a href="#l1.18"></a><span id="l1.18">     // The following rules will not be enabled currently, but are kept here for</span>
<a href="#l1.19"></a><span id="l1.19">     // easier updates in the future.</span>
<a href="#l1.20"></a><span id="l1.20">     &quot;no-else-return&quot;: 0,</span>
<a href="#l1.21"></a><span id="l1.21">   }</span>
<a href="#l1.22"></a><span id="l1.22"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/backend/icaljs/calICSService.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/backend/icaljs/calICSService.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -396,21 +396,21 @@ calIcalComponent.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">             return next.value;</span>
<a href="#l2.6"></a><span id="l2.6">         } else {</span>
<a href="#l2.7"></a><span id="l2.7">             return this.getFirstProperty(kind);</span>
<a href="#l2.8"></a><span id="l2.8">         }</span>
<a href="#l2.9"></a><span id="l2.9">     },</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">     _getNextParentVCalendar: function() {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-        let that = this;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-        while (that &amp;&amp; that.componentType != &quot;VCALENDAR&quot;) {</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-            that = that.parent;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+        let vcalendar = this; // eslint-disable-line consistent-this</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+        while (vcalendar &amp;&amp; vcalendar.componentType != &quot;VCALENDAR&quot;) {</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+            vcalendar = vcalendar.parent;</span>
<a href="#l2.18"></a><span id="l2.18">         }</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-        return that || this;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+        return vcalendar || this;</span>
<a href="#l2.21"></a><span id="l2.21">     },</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23">     addProperty: function(prop) {</span>
<a href="#l2.24"></a><span id="l2.24">         try {</span>
<a href="#l2.25"></a><span id="l2.25">             let dt = prop.valueAsDatetime;</span>
<a href="#l2.26"></a><span id="l2.26">             if (dt &amp;&amp; dt.timezone) {</span>
<a href="#l2.27"></a><span id="l2.27">                 this._getNextParentVCalendar().addTimezoneReference(dt.timezone);</span>
<a href="#l2.28"></a><span id="l2.28">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/content/calendar-month-view.xml</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/content/calendar-month-view.xml</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1091,19 +1091,18 @@</span>
<a href="#l3.4"></a><span id="l3.4">                   itemData.setAttribute(&quot;flashing&quot;, &quot;true&quot;);</span>
<a href="#l3.5"></a><span id="l3.5">                 }</span>
<a href="#l3.6"></a><span id="l3.6">               }</span>
<a href="#l3.7"></a><span id="l3.7">             }</span>
<a href="#l3.8"></a><span id="l3.8">           }</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10">           if (!aStop) {</span>
<a href="#l3.11"></a><span id="l3.11">             // Set up a timer to stop the flashing after the total time.</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-            let this_ = this;</span>
<a href="#l3.13"></a><span id="l3.13">             this.mFlashingEvents[aAlarmItem.hashId] = aAlarmItem;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-            setTimeout(function() { this_.flashAlarm(aAlarmItem, true); }, totaltime);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+            setTimeout(() =&gt; this.flashAlarm(aAlarmItem, true), totaltime);</span>
<a href="#l3.16"></a><span id="l3.16">           } else {</span>
<a href="#l3.17"></a><span id="l3.17">             // We are done flashing, prevent newly created event boxes from flashing.</span>
<a href="#l3.18"></a><span id="l3.18">             delete this.mFlashingEvents[aAlarmItem.hashId];</span>
<a href="#l3.19"></a><span id="l3.19">           }</span>
<a href="#l3.20"></a><span id="l3.20">         ]]&gt;&lt;/body&gt;</span>
<a href="#l3.21"></a><span id="l3.21">       &lt;/method&gt;</span>
<a href="#l3.22"></a><span id="l3.22">     &lt;/implementation&gt;</span>
<a href="#l3.23"></a><span id="l3.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -591,23 +591,22 @@</span>
<a href="#l4.4"></a><span id="l4.4">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.5"></a><span id="l4.5">            this.internalDeleteEvent(aOccurrence);</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">            let chunk = this.createChunk(aOccurrence);</span>
<a href="#l4.8"></a><span id="l4.8">            this.mEventInfos.push(chunk);</span>
<a href="#l4.9"></a><span id="l4.9">            if (this.mEventMapTimeout) {</span>
<a href="#l4.10"></a><span id="l4.10">                clearTimeout(this.mEventMapTimeout);</span>
<a href="#l4.11"></a><span id="l4.11">            }</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-           let column = this;</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14">            if (this.mCreatedNewEvent) {</span>
<a href="#l4.15"></a><span id="l4.15">                this.mEventToEdit = aOccurrence;</span>
<a href="#l4.16"></a><span id="l4.16">            }</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-           // Fun with scoping...</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-           this.mEventMapTimeout = setTimeout(function() { column.relayout.call(column); }, 5);</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+           this.mEventMapTimeout = setTimeout(() =&gt; this.relayout(), 5);</span>
<a href="#l4.21"></a><span id="l4.21">         ]]&gt;&lt;/body&gt;</span>
<a href="#l4.22"></a><span id="l4.22">       &lt;/method&gt;</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24">       &lt;method name=&quot;deleteEvent&quot;&gt;</span>
<a href="#l4.25"></a><span id="l4.25">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l4.26"></a><span id="l4.26">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.27"></a><span id="l4.27">            if (this.internalDeleteEvent(aOccurrence)) {</span>
<a href="#l4.28"></a><span id="l4.28">                this.relayout();</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineat">@@ -1254,18 +1253,18 @@</span>
<a href="#l4.30"></a><span id="l4.30">                    };</span>
<a href="#l4.31"></a><span id="l4.31">         ]]&gt;&lt;/body&gt;</span>
<a href="#l4.32"></a><span id="l4.32">       &lt;/method&gt;</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34">       &lt;method name=&quot;firstLastShadowColumns&quot;&gt;</span>
<a href="#l4.35"></a><span id="l4.35">         &lt;parameter name=&quot;aOffset&quot;/&gt;</span>
<a href="#l4.36"></a><span id="l4.36">         &lt;parameter name=&quot;aShadows&quot;/&gt;</span>
<a href="#l4.37"></a><span id="l4.37">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-          let firstCol = this;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-          let lastCol = this;</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+          let firstCol = this; // eslint-disable-line consistent-this</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+          let lastCol = this; // eslint-disable-line consistent-this</span>
<a href="#l4.42"></a><span id="l4.42">           let firstIndex = (aOffset != null ? aOffset : this.mDragState.offset);</span>
<a href="#l4.43"></a><span id="l4.43">           let lastIndex = firstIndex;</span>
<a href="#l4.44"></a><span id="l4.44">           while (firstCol.previousSibling &amp;&amp; firstIndex &gt; 0) {</span>
<a href="#l4.45"></a><span id="l4.45">               firstCol = firstCol.previousSibling;</span>
<a href="#l4.46"></a><span id="l4.46">               firstIndex--;</span>
<a href="#l4.47"></a><span id="l4.47">           }</span>
<a href="#l4.48"></a><span id="l4.48">           let lastShadow = (aShadows != null ? aShadows : this.mDragState.shadows);</span>
<a href="#l4.49"></a><span id="l4.49">           while (lastCol.nextSibling &amp;&amp; lastIndex &lt; lastShadow - 1) {</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineat">@@ -2674,22 +2673,18 @@</span>
<a href="#l4.51"></a><span id="l4.51">             }</span>
<a href="#l4.52"></a><span id="l4.52">             return;</span>
<a href="#l4.53"></a><span id="l4.53">         ]]&gt;&lt;/body&gt;</span>
<a href="#l4.54"></a><span id="l4.54">       &lt;/method&gt;</span>
<a href="#l4.55"></a><span id="l4.55"> </span>
<a href="#l4.56"></a><span id="l4.56">       &lt;method name=&quot;onResize&quot;&gt;</span>
<a href="#l4.57"></a><span id="l4.57">         &lt;parameter name=&quot;aRealSelf&quot;/&gt;</span>
<a href="#l4.58"></a><span id="l4.58">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-          let self = this;</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-          let isARelayout = true;</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-          if (aRealSelf) {</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-              self = aRealSelf;</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-              isARelayout = false;</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-          }</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+          let self = aRealSelf || this; // eslint-disable-line consistent-this</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+          let isARelayout = !aRealSelf;</span>
<a href="#l4.67"></a><span id="l4.67">           let scrollbox = document.getAnonymousElementByAttribute(self, &quot;anonid&quot;, &quot;scrollbox&quot;);</span>
<a href="#l4.68"></a><span id="l4.68">           let size;</span>
<a href="#l4.69"></a><span id="l4.69">           if (self.orient == &quot;horizontal&quot;) {</span>
<a href="#l4.70"></a><span id="l4.70">               size = scrollbox.boxObject.width;</span>
<a href="#l4.71"></a><span id="l4.71">           } else {</span>
<a href="#l4.72"></a><span id="l4.72">               size = scrollbox.boxObject.height;</span>
<a href="#l4.73"></a><span id="l4.73">           }</span>
<a href="#l4.74"></a><span id="l4.74">           let ppm = size / self.mVisibleMinutes;</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineat">@@ -2765,19 +2760,18 @@</span>
<a href="#l4.76"></a><span id="l4.76">             box = col.header.findBoxForItem(aAlarmItem);</span>
<a href="#l4.77"></a><span id="l4.77">             if (box) {</span>
<a href="#l4.78"></a><span id="l4.78">               setFlashingAttribute(box);</span>
<a href="#l4.79"></a><span id="l4.79">             }</span>
<a href="#l4.80"></a><span id="l4.80">           }</span>
<a href="#l4.81"></a><span id="l4.81"> </span>
<a href="#l4.82"></a><span id="l4.82">           if (!aStop) {</span>
<a href="#l4.83"></a><span id="l4.83">             // Set up a timer to stop the flashing after the total time.</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-            let this_ = this;</span>
<a href="#l4.85"></a><span id="l4.85">             this.mFlashingEvents[aAlarmItem.hashId] = aAlarmItem;</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-            setTimeout(function() { this_.flashAlarm(aAlarmItem, true); }, totaltime);</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+            setTimeout(() =&gt; this.flashAlarm(aAlarmItem, true), totaltime);</span>
<a href="#l4.88"></a><span id="l4.88">           } else {</span>
<a href="#l4.89"></a><span id="l4.89">             // We are done flashing, prevent newly created event boxes from flashing.</span>
<a href="#l4.90"></a><span id="l4.90">             delete this.mFlashingEvents[aAlarmItem.hashId];</span>
<a href="#l4.91"></a><span id="l4.91">           }</span>
<a href="#l4.92"></a><span id="l4.92">         ]]&gt;&lt;/body&gt;</span>
<a href="#l4.93"></a><span id="l4.93">       &lt;/method&gt;</span>
<a href="#l4.94"></a><span id="l4.94"> </span>
<a href="#l4.95"></a><span id="l4.95">       &lt;!-- calICalendarView --&gt;</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineat">@@ -3283,39 +3277,38 @@</span>
<a href="#l4.97"></a><span id="l4.97">           // unselect previous selected event upon switch views, otherwise those</span>
<a href="#l4.98"></a><span id="l4.98">           // events will stay selected forever, if select other events after</span>
<a href="#l4.99"></a><span id="l4.99">           // change week view.</span>
<a href="#l4.100"></a><span id="l4.100">           this.setSelectedItems(0, [], true);</span>
<a href="#l4.101"></a><span id="l4.101"> </span>
<a href="#l4.102"></a><span id="l4.102">           let daybox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;daybox&quot;);</span>
<a href="#l4.103"></a><span id="l4.103">           let headerdaybox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;headerdaybox&quot;);</span>
<a href="#l4.104"></a><span id="l4.104"> </span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-          let calView = this;</span>
<a href="#l4.106"></a><span id="l4.106">           let dayStartMin = this.mDayStartMin;</span>
<a href="#l4.107"></a><span id="l4.107">           let dayEndMin = this.mDayEndMin;</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-          function setUpDayEventsBox(aDayBox, date) {</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+          let setUpDayEventsBox = (aDayBox, date) =&gt; {</span>
<a href="#l4.110"></a><span id="l4.110">               aDayBox.setAttribute(&quot;class&quot;, &quot;calendar-event-column-&quot; + (counter % 2 == 0 ? &quot;even&quot; : &quot;odd&quot;));</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-              aDayBox.setAttribute(&quot;context&quot;, calView.getAttribute(&quot;context&quot;));</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-              aDayBox.setAttribute(&quot;item-context&quot;, calView.getAttribute(&quot;item-context&quot;) || calView.getAttribute(&quot;context&quot;));</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+              aDayBox.setAttribute(&quot;context&quot;, this.getAttribute(&quot;context&quot;));</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+              aDayBox.setAttribute(&quot;item-context&quot;, this.getAttribute(&quot;item-context&quot;) || this.getAttribute(&quot;context&quot;));</span>
<a href="#l4.115"></a><span id="l4.115">               aDayBox.startLayoutBatchChange();</span>
<a href="#l4.116"></a><span id="l4.116">               aDayBox.date = date;</span>
<a href="#l4.117"></a><span id="l4.117">               aDayBox.setAttribute(&quot;orient&quot;, orient);</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-              aDayBox.calendarView = calView;</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+              aDayBox.calendarView = this;</span>
<a href="#l4.120"></a><span id="l4.120">               aDayBox.setDayStartEndMinutes(dayStartMin, dayEndMin);</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-          }</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineminus">-          function setUpDayHeaderBox(aDayBox, date) {</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+          };</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+          let setUpDayHeaderBox = (aDayBox, date) =&gt; {</span>
<a href="#l4.127"></a><span id="l4.127">               aDayBox.date = date;</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineminus">-              aDayBox.calendarView = calView;</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+              aDayBox.calendarView = this;</span>
<a href="#l4.130"></a><span id="l4.130">               aDayBox.setAttribute(&quot;orient&quot;, &quot;vertical&quot;);</span>
<a href="#l4.131"></a><span id="l4.131">               // Since the calendar-header-container boxes have the same vertical</span>
<a href="#l4.132"></a><span id="l4.132">               // orientation for normal and rotated views, it needs an attribute</span>
<a href="#l4.133"></a><span id="l4.133">               // &quot;rotated&quot; in order to have different css rules.</span>
<a href="#l4.134"></a><span id="l4.134">               setBooleanAttribute(aDayBox, &quot;rotated&quot;, orient == &quot;horizontal&quot;);</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-          }</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+          };</span>
<a href="#l4.137"></a><span id="l4.137"> </span>
<a href="#l4.138"></a><span id="l4.138">           this.mDateColumns = [];</span>
<a href="#l4.139"></a><span id="l4.139"> </span>
<a href="#l4.140"></a><span id="l4.140"> </span>
<a href="#l4.141"></a><span id="l4.141">           // get today's date</span>
<a href="#l4.142"></a><span id="l4.142">           let today = this.today();</span>
<a href="#l4.143"></a><span id="l4.143">           let counter = 0;</span>
<a href="#l4.144"></a><span id="l4.144">           let dayboxkids = daybox.childNodes;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1469,22 +1469,21 @@ ItipItemFinder.prototype = {</span>
<a href="#l5.4"></a><span id="l5.4">             // It will likely be the composite calendar, so we should update</span>
<a href="#l5.5"></a><span id="l5.5">             // if an item was added or removed</span>
<a href="#l5.6"></a><span id="l5.6">             this._observeChanges(this.mItipItem.targetCalendar);</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8">             for (let itipItemItem of this.mItipItem.getItemList({})) {</span>
<a href="#l5.9"></a><span id="l5.9">                 switch (method) {</span>
<a href="#l5.10"></a><span id="l5.10">                     case &quot;REQUEST&quot;:</span>
<a href="#l5.11"></a><span id="l5.11">                     case &quot;PUBLISH&quot;: {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-                        let this_ = this;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-                        let action = function(opListener, partStat) {</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+                        let action = (opListener, partStat) =&gt; {</span>
<a href="#l5.15"></a><span id="l5.15">                             let newItem = itipItemItem.clone();</span>
<a href="#l5.16"></a><span id="l5.16">                             setReceivedInfo(newItem, itipItemItem);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-                            newItem.parentItem.calendar = this_.mItipItem.targetCalendar;</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-                            addScheduleAgentClient(newItem, this_.mItipItem.targetCalendar);</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+                            newItem.parentItem.calendar = this.mItipItem.targetCalendar;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+                            addScheduleAgentClient(newItem, this.mItipItem.targetCalendar);</span>
<a href="#l5.21"></a><span id="l5.21">                             if (partStat) {</span>
<a href="#l5.22"></a><span id="l5.22">                                 if (partStat != &quot;DECLINED&quot;) {</span>
<a href="#l5.23"></a><span id="l5.23">                                     cal.alarms.setDefaultValues(newItem);</span>
<a href="#l5.24"></a><span id="l5.24">                                 }</span>
<a href="#l5.25"></a><span id="l5.25">                                 let att = cal.getInvitedAttendee(newItem);</span>
<a href="#l5.26"></a><span id="l5.26">                                 if (!att) { // fall back to using configured organizer</span>
<a href="#l5.27"></a><span id="l5.27">                                     att = createOrganizer(newItem.calendar);</span>
<a href="#l5.28"></a><span id="l5.28">                                     if (att) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -530,28 +530,28 @@ cal.ProviderBase.prototype = {</span>
<a href="#l6.4"></a><span id="l6.4">             if (!cal.ProviderBase.mTransientProperties[aName]) {</span>
<a href="#l6.5"></a><span id="l6.5">                 let value = this.mProperties[aName];</span>
<a href="#l6.6"></a><span id="l6.6">                 if (value !== null) {</span>
<a href="#l6.7"></a><span id="l6.7">                     calMgr.setCalendarPref_(this, aName, value);</span>
<a href="#l6.8"></a><span id="l6.8">                 }</span>
<a href="#l6.9"></a><span id="l6.9">             }</span>
<a href="#l6.10"></a><span id="l6.10">         }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-        let this_ = this;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-        function takeOverIfNotPresent(oldPref, newPref, dontDeleteOldPref) {</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-            let val = calMgr.getCalendarPref_(this_, oldPref);</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+        let takeOverIfNotPresent = (oldPref, newPref, dontDeleteOldPref) =&gt; {</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+            let val = calMgr.getCalendarPref_(this, oldPref);</span>
<a href="#l6.17"></a><span id="l6.17">             if (val !== null) {</span>
<a href="#l6.18"></a><span id="l6.18">                 if (!dontDeleteOldPref) {</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-                    calMgr.deleteCalendarPref_(this_, oldPref);</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+                    calMgr.deleteCalendarPref_(this, oldPref);</span>
<a href="#l6.21"></a><span id="l6.21">                 }</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-                if (calMgr.getCalendarPref_(this_, newPref) === null) {</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-                    calMgr.setCalendarPref_(this_, newPref, val);</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+                if (calMgr.getCalendarPref_(this, newPref) === null) {</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+                    calMgr.setCalendarPref_(this, newPref, val);</span>
<a href="#l6.26"></a><span id="l6.26">                 }</span>
<a href="#l6.27"></a><span id="l6.27">             }</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-        }</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+        };</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+</span>
<a href="#l6.31"></a><span id="l6.31">         // takeover lightning calendar visibility from 0.5:</span>
<a href="#l6.32"></a><span id="l6.32">         takeOverIfNotPresent(&quot;lightning-main-in-composite&quot;, &quot;calendar-main-in-composite&quot;);</span>
<a href="#l6.33"></a><span id="l6.33">         takeOverIfNotPresent(&quot;lightning-main-default&quot;, &quot;calendar-main-default&quot;);</span>
<a href="#l6.34"></a><span id="l6.34"> </span>
<a href="#l6.35"></a><span id="l6.35">         return aValue;</span>
<a href="#l6.36"></a><span id="l6.36">     },</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38">     // attribute AUTF8String name;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/src/calCachedCalendar.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/src/calCachedCalendar.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -218,120 +218,120 @@ calCachedCalendar.prototype = {</span>
<a href="#l7.4"></a><span id="l7.4">                 this.mCachedCalendar = cachedCalendar;</span>
<a href="#l7.5"></a><span id="l7.5">             }</span>
<a href="#l7.6"></a><span id="l7.6">         } catch (exc) {</span>
<a href="#l7.7"></a><span id="l7.7">             Components.utils.reportError(exc);</span>
<a href="#l7.8"></a><span id="l7.8">         }</span>
<a href="#l7.9"></a><span id="l7.9">     },</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11">     getOfflineAddedItems: function cCC_getOfflineAddedItems(callbackFunc) {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-        let this_ = this;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-        this_.offlineCachedItems = {};</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+        let self = this;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+        self.offlineCachedItems = {};</span>
<a href="#l7.16"></a><span id="l7.16">         let getListener = {</span>
<a href="#l7.17"></a><span id="l7.17">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l7.18"></a><span id="l7.18">             onGetResult: function cCC_oOC_cL_onGetResult(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l7.19"></a><span id="l7.19">                 for (let item of aItems) {</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-                    this_.offlineCachedItems[item.hashId] = item;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-                    this_.offlineCachedItemFlags[item.hashId] = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+                    self.offlineCachedItems[item.hashId] = item;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+                    self.offlineCachedItemFlags[item.hashId] = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l7.24"></a><span id="l7.24">                 }</span>
<a href="#l7.25"></a><span id="l7.25">             },</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27">             onOperationComplete: function cCC_oOC_cL_onOperationComplete(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-                this_.getOfflineModifiedItems(callbackFunc);</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+                self.getOfflineModifiedItems(callbackFunc);</span>
<a href="#l7.30"></a><span id="l7.30">             }</span>
<a href="#l7.31"></a><span id="l7.31">         };</span>
<a href="#l7.32"></a><span id="l7.32">         this.mCachedCalendar.getItems(calICalendar.ITEM_FILTER_ALL_ITEMS | calICalendar.ITEM_FILTER_OFFLINE_CREATED,</span>
<a href="#l7.33"></a><span id="l7.33">                                       0, null, null, getListener);</span>
<a href="#l7.34"></a><span id="l7.34">     },</span>
<a href="#l7.35"></a><span id="l7.35"> </span>
<a href="#l7.36"></a><span id="l7.36">     getOfflineModifiedItems: function cCC_getOfflineModifiedItems(callbackFunc) {</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-        let this_ = this;</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+        let self = this;</span>
<a href="#l7.39"></a><span id="l7.39">         let getListener = {</span>
<a href="#l7.40"></a><span id="l7.40">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l7.41"></a><span id="l7.41">             onGetResult: function cCC_oOC_cL_onGetResult(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l7.42"></a><span id="l7.42">                 for (let item of aItems) {</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-                    this_.offlineCachedItems[item.hashId] = item;</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-                    this_.offlineCachedItemFlags[item.hashId] = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+                    self.offlineCachedItems[item.hashId] = item;</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+                    self.offlineCachedItemFlags[item.hashId] = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l7.47"></a><span id="l7.47">                 }</span>
<a href="#l7.48"></a><span id="l7.48">             },</span>
<a href="#l7.49"></a><span id="l7.49"> </span>
<a href="#l7.50"></a><span id="l7.50">             onOperationComplete: function cCC_oOC_cL_onOperationComplete(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-                this_.getOfflineDeletedItems(callbackFunc);</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+                self.getOfflineDeletedItems(callbackFunc);</span>
<a href="#l7.53"></a><span id="l7.53">             }</span>
<a href="#l7.54"></a><span id="l7.54">         };</span>
<a href="#l7.55"></a><span id="l7.55">         this.mCachedCalendar.getItems(calICalendar.ITEM_FILTER_OFFLINE_MODIFIED | calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l7.56"></a><span id="l7.56">                                       0, null, null, getListener);</span>
<a href="#l7.57"></a><span id="l7.57">     },</span>
<a href="#l7.58"></a><span id="l7.58"> </span>
<a href="#l7.59"></a><span id="l7.59">     getOfflineDeletedItems: function cCC_getOfflineDeletedItems(callbackFunc) {</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-        let this_ = this;</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+        let self = this;</span>
<a href="#l7.62"></a><span id="l7.62">         let getListener = {</span>
<a href="#l7.63"></a><span id="l7.63">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l7.64"></a><span id="l7.64">             onGetResult: function cCC_oOC_cL_onGetResult(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l7.65"></a><span id="l7.65">                 for (let item of aItems) {</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-                    this_.offlineCachedItems[item.hashId] = item;</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-                    this_.offlineCachedItemFlags[item.hashId] = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+                    self.offlineCachedItems[item.hashId] = item;</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+                    self.offlineCachedItemFlags[item.hashId] = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l7.70"></a><span id="l7.70">                 }</span>
<a href="#l7.71"></a><span id="l7.71">             },</span>
<a href="#l7.72"></a><span id="l7.72"> </span>
<a href="#l7.73"></a><span id="l7.73">             onOperationComplete: function cCC_oOC_cL_onOperationComplete(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l7.74"></a><span id="l7.74">                 if (callbackFunc) {</span>
<a href="#l7.75"></a><span id="l7.75">                     callbackFunc();</span>
<a href="#l7.76"></a><span id="l7.76">                 }</span>
<a href="#l7.77"></a><span id="l7.77">             }</span>
<a href="#l7.78"></a><span id="l7.78">         };</span>
<a href="#l7.79"></a><span id="l7.79">         this.mCachedCalendar.getItems(calICalendar.ITEM_FILTER_OFFLINE_DELETED | calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l7.80"></a><span id="l7.80">                                       0, null, null, getListener);</span>
<a href="#l7.81"></a><span id="l7.81">     },</span>
<a href="#l7.82"></a><span id="l7.82"> </span>
<a href="#l7.83"></a><span id="l7.83">     mPendingSync: null,</span>
<a href="#l7.84"></a><span id="l7.84">     mSyncQueue: null,</span>
<a href="#l7.85"></a><span id="l7.85">     synchronize: function cCC_synchronize(respFunc) {</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-        let this_ = this;</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+        let self = this;</span>
<a href="#l7.88"></a><span id="l7.88">         if (this.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l7.89"></a><span id="l7.89">             return emptyQueue(Components.results.NS_OK);</span>
<a href="#l7.90"></a><span id="l7.90">         }</span>
<a href="#l7.91"></a><span id="l7.91"> </span>
<a href="#l7.92"></a><span id="l7.92">         this.mSyncQueue.push(respFunc);</span>
<a href="#l7.93"></a><span id="l7.93">         if (this.mSyncQueue.length &gt; 1) { // don't use mPendingSync here</span>
<a href="#l7.94"></a><span id="l7.94">             cal.LOG(&quot;[calCachedCalendar] sync in action/pending.&quot;);</span>
<a href="#l7.95"></a><span id="l7.95">             return this.mPendingSync;</span>
<a href="#l7.96"></a><span id="l7.96">         }</span>
<a href="#l7.97"></a><span id="l7.97"> </span>
<a href="#l7.98"></a><span id="l7.98">         function emptyQueue(status) {</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-            let queue = this_.mSyncQueue;</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-            this_.mSyncQueue = [];</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+            let queue = self.mSyncQueue;</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+            self.mSyncQueue = [];</span>
<a href="#l7.103"></a><span id="l7.103">             function execResponseFunc(func) {</span>
<a href="#l7.104"></a><span id="l7.104">                 try {</span>
<a href="#l7.105"></a><span id="l7.105">                     func(status);</span>
<a href="#l7.106"></a><span id="l7.106">                 } catch (exc) {</span>
<a href="#l7.107"></a><span id="l7.107">                     cal.ASSERT(false, exc);</span>
<a href="#l7.108"></a><span id="l7.108">                 }</span>
<a href="#l7.109"></a><span id="l7.109">             }</span>
<a href="#l7.110"></a><span id="l7.110">             queue.forEach(execResponseFunc);</span>
<a href="#l7.111"></a><span id="l7.111">             cal.LOG(&quot;[calCachedCalendar] sync queue empty.&quot;);</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-            let op = this_.mPendingSync;</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-            this_.mPendingSync = null;</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+            let op = self.mPendingSync;</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+            self.mPendingSync = null;</span>
<a href="#l7.116"></a><span id="l7.116">             return op;</span>
<a href="#l7.117"></a><span id="l7.117">         }</span>
<a href="#l7.118"></a><span id="l7.118"> </span>
<a href="#l7.119"></a><span id="l7.119">         if (this.offline) {</span>
<a href="#l7.120"></a><span id="l7.120">             return emptyQueue(Components.results.NS_OK);</span>
<a href="#l7.121"></a><span id="l7.121">         }</span>
<a href="#l7.122"></a><span id="l7.122"> </span>
<a href="#l7.123"></a><span id="l7.123">         if (this.supportsChangeLog) {</span>
<a href="#l7.124"></a><span id="l7.124">             cal.LOG(&quot;[calCachedCalendar] Doing changelog based sync for calendar &quot; + this.uri.spec);</span>
<a href="#l7.125"></a><span id="l7.125">             let opListener = {</span>
<a href="#l7.126"></a><span id="l7.126">                 onResult: function(op, result) {</span>
<a href="#l7.127"></a><span id="l7.127">                     if (!op || !op.isPending) {</span>
<a href="#l7.128"></a><span id="l7.128">                         let status = (op ? op.status : Components.results.NS_OK);</span>
<a href="#l7.129"></a><span id="l7.129">                         if (!Components.isSuccessCode(status)) {</span>
<a href="#l7.130"></a><span id="l7.130">                             cal.ERROR(&quot;[calCachedCalendar] replay action failed: &quot; +</span>
<a href="#l7.131"></a><span id="l7.131">                                       (op ? op.id : &quot;&lt;unknown&gt;&quot;) + &quot;, uri=&quot; +</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-                                      this_.uri.spec + &quot;, result=&quot; +</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+                                      self.uri.spec + &quot;, result=&quot; +</span>
<a href="#l7.134"></a><span id="l7.134">                                       result + &quot;, op=&quot; + op);</span>
<a href="#l7.135"></a><span id="l7.135">                         }</span>
<a href="#l7.136"></a><span id="l7.136">                         cal.LOG(&quot;[calCachedCalendar] replayChangesOn finished.&quot;);</span>
<a href="#l7.137"></a><span id="l7.137">                         emptyQueue(status);</span>
<a href="#l7.138"></a><span id="l7.138">                     }</span>
<a href="#l7.139"></a><span id="l7.139">                 }</span>
<a href="#l7.140"></a><span id="l7.140">             };</span>
<a href="#l7.141"></a><span id="l7.141">             this.mPendingSync = this.mUncachedCalendar.replayChangesOn(opListener);</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineat">@@ -353,26 +353,26 @@ calCachedCalendar.prototype = {</span>
<a href="#l7.143"></a><span id="l7.143">                                                          aDetail,</span>
<a href="#l7.144"></a><span id="l7.144">                                                          aCount,</span>
<a href="#l7.145"></a><span id="l7.145">                                                          aItems) {</span>
<a href="#l7.146"></a><span id="l7.146">                 if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l7.147"></a><span id="l7.147">                     if (!this.hasRenewedCalendar) {</span>
<a href="#l7.148"></a><span id="l7.148">                         // TODO instead of deleting the calendar and creating a new</span>
<a href="#l7.149"></a><span id="l7.149">                         // one, maybe we want to do a &quot;real&quot; sync between the</span>
<a href="#l7.150"></a><span id="l7.150">                         // existing local calendar and the remote calendar.</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-                        this_.setupCachedCalendar();</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+                        self.setupCachedCalendar();</span>
<a href="#l7.153"></a><span id="l7.153">                         this.hasRenewedCalendar = true;</span>
<a href="#l7.154"></a><span id="l7.154">                     }</span>
<a href="#l7.155"></a><span id="l7.155"> </span>
<a href="#l7.156"></a><span id="l7.156">                     this.getsReceived++;</span>
<a href="#l7.157"></a><span id="l7.157">                     cal.forEach(aItems, function(item) {</span>
<a href="#l7.158"></a><span id="l7.158">                         // Adding items recd from the Memory Calendar</span>
<a href="#l7.159"></a><span id="l7.159">                         // These may be different than what the cache has</span>
<a href="#l7.160"></a><span id="l7.160">                         completeListener.modifiedTimes[item.id] = item.lastModifiedTime;</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-                        this_.mCachedCalendar.addItem(item, null);</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+                        self.mCachedCalendar.addItem(item, null);</span>
<a href="#l7.163"></a><span id="l7.163">                     }, function completed() {</span>
<a href="#l7.164"></a><span id="l7.164">                         completeListener.getsCompleted++;</span>
<a href="#l7.165"></a><span id="l7.165">                         if (completeListener.opCompleted) {</span>
<a href="#l7.166"></a><span id="l7.166">                             // onOperationComplete was called, but we were not ready yet. call it now.</span>
<a href="#l7.167"></a><span id="l7.167">                             completeListener.onOperationComplete.apply(completeListener, completeListener.opCompleted);</span>
<a href="#l7.168"></a><span id="l7.168">                             completeListener.opCompleted = false;</span>
<a href="#l7.169"></a><span id="l7.169">                         }</span>
<a href="#l7.170"></a><span id="l7.170">                     });</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineat">@@ -387,66 +387,66 @@ calCachedCalendar.prototype = {</span>
<a href="#l7.172"></a><span id="l7.172">                 if (this.getsCompleted &lt; this.getsReceived) {</span>
<a href="#l7.173"></a><span id="l7.173">                     // If not all of our gets have been processed, then save the</span>
<a href="#l7.174"></a><span id="l7.174">                     // arguments and finish processing later.</span>
<a href="#l7.175"></a><span id="l7.175">                     this.opCompleted = Array.slice(arguments);</span>
<a href="#l7.176"></a><span id="l7.176">                     return;</span>
<a href="#l7.177"></a><span id="l7.177">                 }</span>
<a href="#l7.178"></a><span id="l7.178"> </span>
<a href="#l7.179"></a><span id="l7.179">                 if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-                    cal.forEach(this_.offlineCachedItems, function(item) {</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-                        switch (this_.offlineCachedItemFlags[item.hashId]) {</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+                    cal.forEach(self.offlineCachedItems, function(item) {</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+                        switch (self.offlineCachedItemFlags[item.hashId]) {</span>
<a href="#l7.184"></a><span id="l7.184">                             case cICL.OFFLINE_FLAG_CREATED_RECORD:</span>
<a href="#l7.185"></a><span id="l7.185">                                 // Created items are not present on the server, so its safe to adopt them</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-                                this_.adoptOfflineItem(item.clone(), null);</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+                                self.adoptOfflineItem(item.clone(), null);</span>
<a href="#l7.188"></a><span id="l7.188">                                 break;</span>
<a href="#l7.189"></a><span id="l7.189">                             case cICL.OFFLINE_FLAG_MODIFIED_RECORD:</span>
<a href="#l7.190"></a><span id="l7.190">                                 // Two Cases Here:</span>
<a href="#l7.191"></a><span id="l7.191">                                 if (item.id in completeListener.modifiedTimes) {</span>
<a href="#l7.192"></a><span id="l7.192">                                     // The item is still on the server, we just retrieved it in the listener above.</span>
<a href="#l7.193"></a><span id="l7.193">                                     if (item.lastModifiedTime.compare(completeListener.modifiedTimes[item.id]) &lt; 0) {</span>
<a href="#l7.194"></a><span id="l7.194">                                         // The item on the server has been modified, ask to overwrite</span>
<a href="#l7.195"></a><span id="l7.195">                                         cal.WARN(&quot;[calCachedCalendar] Item '&quot; + item.title + &quot;' at the server seems to be modified recently.&quot;);</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-                                        this_.promptOverwrite(&quot;modify&quot;, item, null, null);</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+                                        self.promptOverwrite(&quot;modify&quot;, item, null, null);</span>
<a href="#l7.198"></a><span id="l7.198">                                     } else {</span>
<a href="#l7.199"></a><span id="l7.199">                                         // Our item is newer, just modify the item</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineminus">-                                        this_.modifyOfflineItem(item, null, null);</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+                                        self.modifyOfflineItem(item, null, null);</span>
<a href="#l7.202"></a><span id="l7.202">                                     }</span>
<a href="#l7.203"></a><span id="l7.203">                                 } else {</span>
<a href="#l7.204"></a><span id="l7.204">                                     // The item has been deleted from the server, ask if it should be added again</span>
<a href="#l7.205"></a><span id="l7.205">                                     cal.WARN(&quot;[calCachedCalendar] Item '&quot; + item.title + &quot;' has been deleted from the server&quot;);</span>
<a href="#l7.206"></a><span id="l7.206">                                     if (cal.promptOverwrite(&quot;modify&quot;, item, null, null)) {</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-                                        this_.adoptOfflineItem(item.clone(), null);</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+                                        self.adoptOfflineItem(item.clone(), null);</span>
<a href="#l7.209"></a><span id="l7.209">                                     }</span>
<a href="#l7.210"></a><span id="l7.210">                                 }</span>
<a href="#l7.211"></a><span id="l7.211">                                 break;</span>
<a href="#l7.212"></a><span id="l7.212">                             case cICL.OFFLINE_FLAG_DELETED_RECORD:</span>
<a href="#l7.213"></a><span id="l7.213">                                 if (item.id in completeListener.modifiedTimes) {</span>
<a href="#l7.214"></a><span id="l7.214">                                     // The item seems to exist on the server...</span>
<a href="#l7.215"></a><span id="l7.215">                                     if (item.lastModifiedTime.compare(completeListener.modifiedTimes[item.id]) &lt; 0) {</span>
<a href="#l7.216"></a><span id="l7.216">                                         // ...and has been modified on the server. Ask to overwrite</span>
<a href="#l7.217"></a><span id="l7.217">                                         cal.WARN(&quot;[calCachedCalendar] Item '&quot; + item.title + &quot;' at the server seems to be modified recently.&quot;);</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineminus">-                                        this_.promptOverwrite(&quot;delete&quot;, item, null, null);</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+                                        self.promptOverwrite(&quot;delete&quot;, item, null, null);</span>
<a href="#l7.220"></a><span id="l7.220">                                     } else {</span>
<a href="#l7.221"></a><span id="l7.221">                                         // ...and has not been modified. Delete it now.</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineminus">-                                        this_.deleteOfflineItem(item, null);</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+                                        self.deleteOfflineItem(item, null);</span>
<a href="#l7.224"></a><span id="l7.224">                                     }</span>
<a href="#l7.225"></a><span id="l7.225">                                 } else {</span>
<a href="#l7.226"></a><span id="l7.226">                                     // Item has already been deleted from the server, no need to change anything.</span>
<a href="#l7.227"></a><span id="l7.227">                                 }</span>
<a href="#l7.228"></a><span id="l7.228">                                 break;</span>
<a href="#l7.229"></a><span id="l7.229">                         }</span>
<a href="#l7.230"></a><span id="l7.230">                     },</span>
<a href="#l7.231"></a><span id="l7.231">                     function completed() {</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-                        this_.offlineCachedItems = {};</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-                        this_.offlineCachedItemFlags = {};</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineminus">-                        this_.playbackOfflineItems(() =&gt; emptyQueue(aStatus));</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+                        self.offlineCachedItems = {};</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+                        self.offlineCachedItemFlags = {};</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+                        self.playbackOfflineItems(() =&gt; emptyQueue(aStatus));</span>
<a href="#l7.238"></a><span id="l7.238">                     });</span>
<a href="#l7.239"></a><span id="l7.239">                 } else {</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineminus">-                    this_.playbackOfflineItems(function() { this_.mCachedObserver.onLoad(this_.mCachedCalendar); });</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+                    self.playbackOfflineItems(function() { self.mCachedObserver.onLoad(self.mCachedCalendar); });</span>
<a href="#l7.242"></a><span id="l7.242">                     emptyQueue(aStatus);</span>
<a href="#l7.243"></a><span id="l7.243">                 }</span>
<a href="#l7.244"></a><span id="l7.244">             }</span>
<a href="#l7.245"></a><span id="l7.245">         };</span>
<a href="#l7.246"></a><span id="l7.246"> </span>
<a href="#l7.247"></a><span id="l7.247">         this.getOfflineAddedItems(() =&gt; {</span>
<a href="#l7.248"></a><span id="l7.248">             this.mPendingSync = this.mUncachedCalendar.getItems(Components.interfaces.calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l7.249"></a><span id="l7.249">                                                                     0, null, null, completeListener);</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineat">@@ -481,17 +481,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l7.251"></a><span id="l7.251">      * @param aCallback         (optional) The function to be callled when playback is complete.</span>
<a href="#l7.252"></a><span id="l7.252">      * @param aPlaybackType     (optional) The starting operation type. This function will be</span>
<a href="#l7.253"></a><span id="l7.253">      *                          called recursively through playback operations in the order of</span>
<a href="#l7.254"></a><span id="l7.254">      *                          add, modify, delete. By default playback will start with the add</span>
<a href="#l7.255"></a><span id="l7.255">      *                          operation. Valid values for this parameter are defined as</span>
<a href="#l7.256"></a><span id="l7.256">      *                          OFFLINE_FLAG_XXX constants in the calIChangeLog interface.</span>
<a href="#l7.257"></a><span id="l7.257">      */</span>
<a href="#l7.258"></a><span id="l7.258">     playbackOfflineItems: function cCC_playbackOfflineItems(aCallback, aPlaybackType) {</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-        let this_ = this;</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+        let self = this;</span>
<a href="#l7.261"></a><span id="l7.261">         let storage = this.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l7.262"></a><span id="l7.262"> </span>
<a href="#l7.263"></a><span id="l7.263">         let resetListener = gNoOpListener;</span>
<a href="#l7.264"></a><span id="l7.264">         let itemQueue = [];</span>
<a href="#l7.265"></a><span id="l7.265">         let debugOp;</span>
<a href="#l7.266"></a><span id="l7.266">         let nextCallback;</span>
<a href="#l7.267"></a><span id="l7.267">         let uncachedOp;</span>
<a href="#l7.268"></a><span id="l7.268">         let listenerOp;</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineat">@@ -504,17 +504,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l7.270"></a><span id="l7.270">                 nextCallback = this.playbackOfflineItems.bind(this, aCallback, cICL.OFFLINE_FLAG_MODIFIED_RECORD);</span>
<a href="#l7.271"></a><span id="l7.271">                 uncachedOp = this.mUncachedCalendar.addItem.bind(this.mUncachedCalendar);</span>
<a href="#l7.272"></a><span id="l7.272">                 listenerOp = cIOL.ADD;</span>
<a href="#l7.273"></a><span id="l7.273">                 filter = calICalendar.ITEM_FILTER_OFFLINE_CREATED;</span>
<a href="#l7.274"></a><span id="l7.274">                 break;</span>
<a href="#l7.275"></a><span id="l7.275">             case cICL.OFFLINE_FLAG_MODIFIED_RECORD:</span>
<a href="#l7.276"></a><span id="l7.276">                 debugOp = &quot;modify&quot;;</span>
<a href="#l7.277"></a><span id="l7.277">                 nextCallback = this.playbackOfflineItems.bind(this, aCallback, cICL.OFFLINE_FLAG_DELETED_RECORD);</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineminus">-                uncachedOp = function(item, listener) { this_.mUncachedCalendar.modifyItem(item, item, listener); };</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineplus">+                uncachedOp = function(item, listener) { self.mUncachedCalendar.modifyItem(item, item, listener); };</span>
<a href="#l7.280"></a><span id="l7.280">                 listenerOp = cIOL.MODIFY;</span>
<a href="#l7.281"></a><span id="l7.281">                 filter = calICalendar.ITEM_FILTER_OFFLINE_MODIFIED;</span>
<a href="#l7.282"></a><span id="l7.282">                 break;</span>
<a href="#l7.283"></a><span id="l7.283">             case cICL.OFFLINE_FLAG_DELETED_RECORD:</span>
<a href="#l7.284"></a><span id="l7.284">                 debugOp = &quot;delete&quot;;</span>
<a href="#l7.285"></a><span id="l7.285">                 nextCallback = aCallback;</span>
<a href="#l7.286"></a><span id="l7.286">                 uncachedOp = this.mUncachedCalendar.deleteItem.bind(this.mUncachedCalendar);</span>
<a href="#l7.287"></a><span id="l7.287">                 listenerOp = cIOL.MODIFY;</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineat">@@ -525,17 +525,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l7.289"></a><span id="l7.289">                 return;</span>
<a href="#l7.290"></a><span id="l7.290">         }</span>
<a href="#l7.291"></a><span id="l7.291"> </span>
<a href="#l7.292"></a><span id="l7.292">         let opListener = {</span>
<a href="#l7.293"></a><span id="l7.293">             onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l7.294"></a><span id="l7.294">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l7.295"></a><span id="l7.295">                 if (Components.isSuccessCode(status)) {</span>
<a href="#l7.296"></a><span id="l7.296">                     if (aPlaybackType == cICL.OFFLINE_FLAG_DELETED_RECORD) {</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineminus">-                        this_.mCachedCalendar.deleteItem(detail, resetListener);</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineplus">+                        self.mCachedCalendar.deleteItem(detail, resetListener);</span>
<a href="#l7.299"></a><span id="l7.299">                     } else {</span>
<a href="#l7.300"></a><span id="l7.300">                         storage.resetItemOfflineFlag(detail, resetListener);</span>
<a href="#l7.301"></a><span id="l7.301">                     }</span>
<a href="#l7.302"></a><span id="l7.302">                 } else {</span>
<a href="#l7.303"></a><span id="l7.303">                     // If the playback action could not be performed, then there</span>
<a href="#l7.304"></a><span id="l7.304">                     // is no need for further action. The item still has the</span>
<a href="#l7.305"></a><span id="l7.305">                     // offline flag, so it will be taken care of next time.</span>
<a href="#l7.306"></a><span id="l7.306">                     cal.WARN(&quot;[calCachedCalendar] Unable to perform playback action &quot; + debugOp +</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineat">@@ -556,34 +556,34 @@ calCachedCalendar.prototype = {</span>
<a href="#l7.308"></a><span id="l7.308">             } else {</span>
<a href="#l7.309"></a><span id="l7.309">                 // perform operation on the next offline item in the queue</span>
<a href="#l7.310"></a><span id="l7.310">                 let item = itemQueue.pop();</span>
<a href="#l7.311"></a><span id="l7.311">                 try {</span>
<a href="#l7.312"></a><span id="l7.312">                     uncachedOp(item, opListener);</span>
<a href="#l7.313"></a><span id="l7.313">                 } catch (e) {</span>
<a href="#l7.314"></a><span id="l7.314">                     cal.ERROR(&quot;[calCachedCalendar] Could not perform playback operation &quot; + debugOp +</span>
<a href="#l7.315"></a><span id="l7.315">                             &quot; for item &quot; + (item.title || &quot; (none) &quot;) + &quot;: &quot; + e);</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineminus">-                    opListener.onOperationComplete(this_, e.result, listenerOp, item.id, e.message);</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineplus">+                    opListener.onOperationComplete(self, e.result, listenerOp, item.id, e.message);</span>
<a href="#l7.318"></a><span id="l7.318">                 }</span>
<a href="#l7.319"></a><span id="l7.319">             }</span>
<a href="#l7.320"></a><span id="l7.320">         }</span>
<a href="#l7.321"></a><span id="l7.321"> </span>
<a href="#l7.322"></a><span id="l7.322">         let getListener = {</span>
<a href="#l7.323"></a><span id="l7.323">             onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l7.324"></a><span id="l7.324">                 itemQueue = itemQueue.concat(items);</span>
<a href="#l7.325"></a><span id="l7.325">             },</span>
<a href="#l7.326"></a><span id="l7.326">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineminus">-                if (this_.offline) {</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineplus">+                if (self.offline) {</span>
<a href="#l7.329"></a><span id="l7.329">                     cal.LOG(&quot;[calCachedCalendar] back to offline mode, reconciliation aborted&quot;);</span>
<a href="#l7.330"></a><span id="l7.330">                     if (aCallback) {</span>
<a href="#l7.331"></a><span id="l7.331">                         aCallback();</span>
<a href="#l7.332"></a><span id="l7.332">                     }</span>
<a href="#l7.333"></a><span id="l7.333">                 } else {</span>
<a href="#l7.334"></a><span id="l7.334">                     cal.LOG(&quot;[calCachedCalendar] Performing playback operation &quot; + debugOp +</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineminus">-                            &quot; on &quot; + itemQueue.length + &quot; items to &quot; + this_.name);</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineplus">+                            &quot; on &quot; + itemQueue.length + &quot; items to &quot; + self.name);</span>
<a href="#l7.337"></a><span id="l7.337"> </span>
<a href="#l7.338"></a><span id="l7.338">                     // start the first operation</span>
<a href="#l7.339"></a><span id="l7.339">                     popItemQueue();</span>
<a href="#l7.340"></a><span id="l7.340">                 }</span>
<a href="#l7.341"></a><span id="l7.341">             }</span>
<a href="#l7.342"></a><span id="l7.342">         };</span>
<a href="#l7.343"></a><span id="l7.343"> </span>
<a href="#l7.344"></a><span id="l7.344">         this.mCachedCalendar.getItems(calICalendar.ITEM_FILTER_ALL_ITEMS | filter,</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineat">@@ -628,20 +628,20 @@ calCachedCalendar.prototype = {</span>
<a href="#l7.346"></a><span id="l7.346">         } else {</span>
<a href="#l7.347"></a><span id="l7.347">             this.downstreamRefresh();</span>
<a href="#l7.348"></a><span id="l7.348">         }</span>
<a href="#l7.349"></a><span id="l7.349">     },</span>
<a href="#l7.350"></a><span id="l7.350">     downstreamRefresh: function() {</span>
<a href="#l7.351"></a><span id="l7.351">         if (this.mUncachedCalendar.canRefresh &amp;&amp; !this.offline) {</span>
<a href="#l7.352"></a><span id="l7.352">             return this.mUncachedCalendar.refresh(); // will trigger synchronize once the calendar is loaded</span>
<a href="#l7.353"></a><span id="l7.353">         } else {</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineminus">-            let this_ = this;</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineplus">+            let self = this;</span>
<a href="#l7.356"></a><span id="l7.356">             return this.synchronize(</span>
<a href="#l7.357"></a><span id="l7.357">                 function(status) { // fire completing onLoad for this refresh call</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineminus">-                    this_.mCachedObserver.onLoad(this_.mCachedCalendar);</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineplus">+                    self.mCachedObserver.onLoad(self.mCachedCalendar);</span>
<a href="#l7.360"></a><span id="l7.360">                 });</span>
<a href="#l7.361"></a><span id="l7.361">         }</span>
<a href="#l7.362"></a><span id="l7.362">     },</span>
<a href="#l7.363"></a><span id="l7.363"> </span>
<a href="#l7.364"></a><span id="l7.364">     addObserver: function(aObserver) {</span>
<a href="#l7.365"></a><span id="l7.365">         this.mObservers.add(aObserver);</span>
<a href="#l7.366"></a><span id="l7.366">     },</span>
<a href="#l7.367"></a><span id="l7.367">     removeObserver: function(aObserver) {</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineat">@@ -689,27 +689,27 @@ calCachedCalendar.prototype = {</span>
<a href="#l7.369"></a><span id="l7.369">             // If we are offline, don't even try to add the item</span>
<a href="#l7.370"></a><span id="l7.370">             this.adoptOfflineItem(item, listener);</span>
<a href="#l7.371"></a><span id="l7.371">         } else {</span>
<a href="#l7.372"></a><span id="l7.372">             // Otherwise ask the provider to add the item now.</span>
<a href="#l7.373"></a><span id="l7.373">             this.mUncachedCalendar.adoptItem(item, cacheListener);</span>
<a href="#l7.374"></a><span id="l7.374">         }</span>
<a href="#l7.375"></a><span id="l7.375">     },</span>
<a href="#l7.376"></a><span id="l7.376">     adoptOfflineItem: function(item, listener) {</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineminus">-        let this_ = this;</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineplus">+        let self = this;</span>
<a href="#l7.379"></a><span id="l7.379">         let opListener = {</span>
<a href="#l7.380"></a><span id="l7.380">             onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l7.381"></a><span id="l7.381">                 cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l7.382"></a><span id="l7.382">             },</span>
<a href="#l7.383"></a><span id="l7.383">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l7.384"></a><span id="l7.384">                 if (Components.isSuccessCode(status)) {</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineminus">-                    let storage = this_.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineplus">+                    let storage = self.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l7.387"></a><span id="l7.387">                     storage.addOfflineItem(detail, listener);</span>
<a href="#l7.388"></a><span id="l7.388">                 } else if (listener) {</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineminus">-                    listener.onOperationComplete(this_, status, opType, id, detail);</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineplus">+                    listener.onOperationComplete(self, status, opType, id, detail);</span>
<a href="#l7.391"></a><span id="l7.391">                 }</span>
<a href="#l7.392"></a><span id="l7.392">             }</span>
<a href="#l7.393"></a><span id="l7.393">         };</span>
<a href="#l7.394"></a><span id="l7.394">         this.mCachedCalendar.adoptItem(item, opListener);</span>
<a href="#l7.395"></a><span id="l7.395">     },</span>
<a href="#l7.396"></a><span id="l7.396"> </span>
<a href="#l7.397"></a><span id="l7.397">     modifyItem: function(newItem, oldItem, listener) {</span>
<a href="#l7.398"></a><span id="l7.398">         let self = this;</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineat">@@ -765,31 +765,31 @@ calCachedCalendar.prototype = {</span>
<a href="#l7.400"></a><span id="l7.400">         } else {</span>
<a href="#l7.401"></a><span id="l7.401">             // Otherwise, get the item flags, the listener will further</span>
<a href="#l7.402"></a><span id="l7.402">             // process the item.</span>
<a href="#l7.403"></a><span id="l7.403">             this.mCachedCalendar.getItemOfflineFlag(oldItem, flagListener);</span>
<a href="#l7.404"></a><span id="l7.404">         }</span>
<a href="#l7.405"></a><span id="l7.405">     },</span>
<a href="#l7.406"></a><span id="l7.406"> </span>
<a href="#l7.407"></a><span id="l7.407">     modifyOfflineItem: function(newItem, oldItem, listener) {</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineminus">-        let this_ = this;</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineplus">+        let self = this;</span>
<a href="#l7.410"></a><span id="l7.410">         let opListener = {</span>
<a href="#l7.411"></a><span id="l7.411">             onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l7.412"></a><span id="l7.412">                 cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l7.413"></a><span id="l7.413">             },</span>
<a href="#l7.414"></a><span id="l7.414">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l7.415"></a><span id="l7.415">                 if (Components.isSuccessCode(status)) {</span>
<a href="#l7.416"></a><span id="l7.416">                     // Modify the offline item in the storage, passing the</span>
<a href="#l7.417"></a><span id="l7.417">                     // listener will make sure its notified</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineminus">-                    let storage = this_.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineplus">+                    let storage = self.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l7.420"></a><span id="l7.420">                     storage.modifyOfflineItem(detail, listener);</span>
<a href="#l7.421"></a><span id="l7.421">                 } else if (listener) {</span>
<a href="#l7.422"></a><span id="l7.422">                     // If there was not a success, then we need to notify the</span>
<a href="#l7.423"></a><span id="l7.423">                     // listener ourselves</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineminus">-                    listener.onOperationComplete(this_, status, opType, id, detail);</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineplus">+                    listener.onOperationComplete(self, status, opType, id, detail);</span>
<a href="#l7.426"></a><span id="l7.426">                 }</span>
<a href="#l7.427"></a><span id="l7.427">             }</span>
<a href="#l7.428"></a><span id="l7.428">         };</span>
<a href="#l7.429"></a><span id="l7.429"> </span>
<a href="#l7.430"></a><span id="l7.430">         this.mCachedCalendar.modifyItem(newItem, oldItem, opListener);</span>
<a href="#l7.431"></a><span id="l7.431">     },</span>
<a href="#l7.432"></a><span id="l7.432"> </span>
<a href="#l7.433"></a><span id="l7.433">     deleteItem: function(item, listener) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/src/calCalendarSearchService.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/src/calCalendarSearchService.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -2,21 +2,19 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.5"></a><span id="l8.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> function calCalendarSearchListener(numOperations, finalListener) {</span>
<a href="#l8.8"></a><span id="l8.8">     this.mFinalListener = finalListener;</span>
<a href="#l8.9"></a><span id="l8.9">     this.mNumOperations = numOperations;</span>
<a href="#l8.10"></a><span id="l8.10">     this.mResults = [];</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    let this_ = this;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-    function cancelFunc() { // operation group has been cancelled</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-        this_.notifyResult(null);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-    }</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-    this.opGroup = new calOperationGroup(cancelFunc);</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+    this.opGroup = new calOperationGroup(() =&gt; {</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+        this.notifyResult(null);</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+    });</span>
<a href="#l8.20"></a><span id="l8.20"> }</span>
<a href="#l8.21"></a><span id="l8.21"> calCalendarSearchListener.prototype = {</span>
<a href="#l8.22"></a><span id="l8.22">     mFinalListener: null,</span>
<a href="#l8.23"></a><span id="l8.23">     mNumOperations: 0,</span>
<a href="#l8.24"></a><span id="l8.24">     opGroup: null,</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26">     notifyResult: function calCalendarSearchListener_notifyResult(result) {</span>
<a href="#l8.27"></a><span id="l8.27">         let listener = this.mFinalListener;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/src/calFreeBusyService.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/src/calFreeBusyService.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -3,21 +3,19 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> function calFreeBusyListener(numOperations, finalListener) {</span>
<a href="#l9.9"></a><span id="l9.9">     this.mFinalListener = finalListener;</span>
<a href="#l9.10"></a><span id="l9.10">     this.mNumOperations = numOperations;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    let this_ = this;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-    function cancelFunc() { // operation group has been cancelled</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-        this_.notifyResult(null);</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-    }</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-    this.opGroup = new calOperationGroup(cancelFunc);</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+    this.opGroup = new calOperationGroup(() =&gt; {</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+        this.notifyResult(null);</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+    });</span>
<a href="#l9.20"></a><span id="l9.20"> }</span>
<a href="#l9.21"></a><span id="l9.21"> calFreeBusyListener.prototype = {</span>
<a href="#l9.22"></a><span id="l9.22">     mFinalListener: null,</span>
<a href="#l9.23"></a><span id="l9.23">     mNumOperations: 0,</span>
<a href="#l9.24"></a><span id="l9.24">     opGroup: null,</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26">     QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIGenericOperationListener]),</span>
<a href="#l9.27"></a><span id="l9.27"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/src/calIcsParser.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/src/calIcsParser.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -249,57 +249,57 @@ parserState.prototype = {</span>
<a href="#l10.4"></a><span id="l10.4">     },</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6">     /**</span>
<a href="#l10.7"></a><span id="l10.7">      * Submit processing of a subcomponent to the event queue</span>
<a href="#l10.8"></a><span id="l10.8">      *</span>
<a href="#l10.9"></a><span id="l10.9">      * @param subComp       The component to process</span>
<a href="#l10.10"></a><span id="l10.10">      */</span>
<a href="#l10.11"></a><span id="l10.11">     submit: function submit(subComp) {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-        let state = this;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+        let self = this;</span>
<a href="#l10.14"></a><span id="l10.14">         let runner = {</span>
<a href="#l10.15"></a><span id="l10.15">             run: function run() {</span>
<a href="#l10.16"></a><span id="l10.16">                 let item = null;</span>
<a href="#l10.17"></a><span id="l10.17">                 switch (subComp.componentType) {</span>
<a href="#l10.18"></a><span id="l10.18">                     case &quot;VEVENT&quot;:</span>
<a href="#l10.19"></a><span id="l10.19">                         item = cal.createEvent();</span>
<a href="#l10.20"></a><span id="l10.20">                         item.icalComponent = subComp;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-                        state.checkTimezone(item, item.startDate);</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-                        state.checkTimezone(item, item.endDate);</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+                        self.checkTimezone(item, item.startDate);</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+                        self.checkTimezone(item, item.endDate);</span>
<a href="#l10.25"></a><span id="l10.25">                         break;</span>
<a href="#l10.26"></a><span id="l10.26">                     case &quot;VTODO&quot;:</span>
<a href="#l10.27"></a><span id="l10.27">                         item = cal.createTodo();</span>
<a href="#l10.28"></a><span id="l10.28">                         item.icalComponent = subComp;</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-                        state.checkTimezone(item, item.entryDate);</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-                        state.checkTimezone(item, item.dueDate);</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+                        self.checkTimezone(item, item.entryDate);</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+                        self.checkTimezone(item, item.dueDate);</span>
<a href="#l10.33"></a><span id="l10.33">                         // completed is defined to be in UTC</span>
<a href="#l10.34"></a><span id="l10.34">                         break;</span>
<a href="#l10.35"></a><span id="l10.35">                     case &quot;VTIMEZONE&quot;:</span>
<a href="#l10.36"></a><span id="l10.36">                         // this should already be attached to the relevant</span>
<a href="#l10.37"></a><span id="l10.37">                         // events in the calendar, so there's no need to</span>
<a href="#l10.38"></a><span id="l10.38">                         // do anything with it here.</span>
<a href="#l10.39"></a><span id="l10.39">                         break;</span>
<a href="#l10.40"></a><span id="l10.40">                     default:</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-                        state.extraComponents.push(subComp);</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+                        self.extraComponents.push(subComp);</span>
<a href="#l10.43"></a><span id="l10.43">                         break;</span>
<a href="#l10.44"></a><span id="l10.44">                 }</span>
<a href="#l10.45"></a><span id="l10.45"> </span>
<a href="#l10.46"></a><span id="l10.46">                 if (item) {</span>
<a href="#l10.47"></a><span id="l10.47">                     let rid = item.recurrenceId;</span>
<a href="#l10.48"></a><span id="l10.48">                     if (!rid) {</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-                        state.items.push(item);</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+                        self.items.push(item);</span>
<a href="#l10.51"></a><span id="l10.51">                         if (item.recurrenceInfo) {</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-                            state.uid2parent[item.id] = item;</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+                            self.uid2parent[item.id] = item;</span>
<a href="#l10.54"></a><span id="l10.54">                         }</span>
<a href="#l10.55"></a><span id="l10.55">                     } else {</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-                        state.excItems.push(item);</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+                        self.excItems.push(item);</span>
<a href="#l10.58"></a><span id="l10.58">                     }</span>
<a href="#l10.59"></a><span id="l10.59">                 }</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-                state.threadCount--;</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-                state.checkCompletion();</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+                self.threadCount--;</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+                self.checkCompletion();</span>
<a href="#l10.64"></a><span id="l10.64">             }</span>
<a href="#l10.65"></a><span id="l10.65">         };</span>
<a href="#l10.66"></a><span id="l10.66"> </span>
<a href="#l10.67"></a><span id="l10.67">         this.threadCount++;</span>
<a href="#l10.68"></a><span id="l10.68">         if (this.listener) {</span>
<a href="#l10.69"></a><span id="l10.69">             // If we have a listener, we are doing this asynchronously. Go ahead</span>
<a href="#l10.70"></a><span id="l10.70">             // and use the thread manager to dispatch the above runner</span>
<a href="#l10.71"></a><span id="l10.71">             Services.tm.currentThread.dispatch(runner, Components.interfaces.nsIEventTarget.DISPATCH_NORMAL);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -642,76 +642,76 @@ calDavCalendar.prototype = {</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5">         let parentItem = aItem.parentItem;</span>
<a href="#l11.6"></a><span id="l11.6">         parentItem.calendar = this.superCalendar;</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8">         let locationPath = this.getItemLocationPath(parentItem);</span>
<a href="#l11.9"></a><span id="l11.9">         let itemUri = this.makeUri(locationPath);</span>
<a href="#l11.10"></a><span id="l11.10">         cal.LOG(&quot;CalDAV: itemUri.spec = &quot; + itemUri.spec);</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-        let thisCalendar = this;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+        let self = this;</span>
<a href="#l11.14"></a><span id="l11.14">         let serializedItem = this.getSerializedItem(aItem);</span>
<a href="#l11.15"></a><span id="l11.15">         let addListener = {</span>
<a href="#l11.16"></a><span id="l11.16">             onStreamComplete: function onPutComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l11.17"></a><span id="l11.17">                 let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l11.18"></a><span id="l11.18">                 let listenerStatus = Components.results.NS_OK;</span>
<a href="#l11.19"></a><span id="l11.19">                 let listenerDetail = parentItem;</span>
<a href="#l11.20"></a><span id="l11.20">                 let responseStatus;</span>
<a href="#l11.21"></a><span id="l11.21">                 try {</span>
<a href="#l11.22"></a><span id="l11.22">                     responseStatus = request.responseStatus;</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-                    if (thisCalendar.verboseLogging()) {</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+                    if (self.verboseLogging()) {</span>
<a href="#l11.26"></a><span id="l11.26">                         let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l11.27"></a><span id="l11.27">                         cal.LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l11.28"></a><span id="l11.28">                     }</span>
<a href="#l11.29"></a><span id="l11.29">                 } catch (ex) {</span>
<a href="#l11.30"></a><span id="l11.30">                     listenerStatus = ex.result;</span>
<a href="#l11.31"></a><span id="l11.31">                     listenerDetail = &quot;Request Failed: &quot; + ex.message;</span>
<a href="#l11.32"></a><span id="l11.32">                     cal.LOG(&quot;CalDAV: Request error during add: &quot; + ex);</span>
<a href="#l11.33"></a><span id="l11.33">                 }</span>
<a href="#l11.34"></a><span id="l11.34"> </span>
<a href="#l11.35"></a><span id="l11.35"> </span>
<a href="#l11.36"></a><span id="l11.36">                 // Translate the HTTP status code to a status and message for the listener</span>
<a href="#l11.37"></a><span id="l11.37">                 if (responseStatus == 201 || responseStatus == 204) {</span>
<a href="#l11.38"></a><span id="l11.38">                     // 201 = HTTP &quot;Created&quot;</span>
<a href="#l11.39"></a><span id="l11.39">                     // 204 = HTTP &quot;No Content&quot;</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-                    cal.LOG(&quot;CalDAV: Item added to &quot; + thisCalendar.name + &quot; successfully&quot;);</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+                    cal.LOG(&quot;CalDAV: Item added to &quot; + self.name + &quot; successfully&quot;);</span>
<a href="#l11.42"></a><span id="l11.42"> </span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-                    let uriComponentParts = thisCalendar.makeUri().path.replace(/\/{2,}/g, &quot;/&quot;).split(&quot;/&quot;).length;</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+                    let uriComponentParts = self.makeUri().path.replace(/\/{2,}/g, &quot;/&quot;).split(&quot;/&quot;).length;</span>
<a href="#l11.45"></a><span id="l11.45">                     let targetParts = request.URI.path.split(&quot;/&quot;);</span>
<a href="#l11.46"></a><span id="l11.46">                     targetParts.splice(0, uriComponentParts - 1);</span>
<a href="#l11.47"></a><span id="l11.47"> </span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-                    thisCalendar.mItemInfoCache[parentItem.id] = {</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+                    self.mItemInfoCache[parentItem.id] = {</span>
<a href="#l11.50"></a><span id="l11.50">                         locationPath: targetParts.join(&quot;/&quot;)</span>
<a href="#l11.51"></a><span id="l11.51">                     };</span>
<a href="#l11.52"></a><span id="l11.52">                     // TODO: onOpComplete adds the item to the cache, probably after getUpdatedItem!</span>
<a href="#l11.53"></a><span id="l11.53"> </span>
<a href="#l11.54"></a><span id="l11.54">                     // Some CalDAV servers will modify items on PUT (add X-props,</span>
<a href="#l11.55"></a><span id="l11.55">                     // for instance) so we'd best re-fetch in order to know</span>
<a href="#l11.56"></a><span id="l11.56">                     // the current state of the item</span>
<a href="#l11.57"></a><span id="l11.57">                     // Observers will be notified in getUpdatedItem()</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-                    thisCalendar.getUpdatedItem(parentItem, aListener);</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+                    self.getUpdatedItem(parentItem, aListener);</span>
<a href="#l11.60"></a><span id="l11.60">                     return;</span>
<a href="#l11.61"></a><span id="l11.61">                 } else if (responseStatus &gt;= 500 &amp;&amp; responseStatus &lt;= 510) {</span>
<a href="#l11.62"></a><span id="l11.62">                     listenerStatus = Components.results.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l11.63"></a><span id="l11.63">                     listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l11.64"></a><span id="l11.64">                 } else if (responseStatus) {</span>
<a href="#l11.65"></a><span id="l11.65">                     // There is a response status, but we haven't handled it yet. Any</span>
<a href="#l11.66"></a><span id="l11.66">                     // error occurring here should consider being handled!</span>
<a href="#l11.67"></a><span id="l11.67">                     cal.ERROR(&quot;CalDAV: Unexpected status adding item to &quot; +</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-                              thisCalendar.name + &quot;: &quot; + responseStatus + &quot;\n&quot; +</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+                              self.name + &quot;: &quot; + responseStatus + &quot;\n&quot; +</span>
<a href="#l11.70"></a><span id="l11.70">                               serializedItem);</span>
<a href="#l11.71"></a><span id="l11.71"> </span>
<a href="#l11.72"></a><span id="l11.72">                     listenerStatus = Components.results.NS_ERROR_FAILURE;</span>
<a href="#l11.73"></a><span id="l11.73">                     listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l11.74"></a><span id="l11.74">                 }</span>
<a href="#l11.75"></a><span id="l11.75"> </span>
<a href="#l11.76"></a><span id="l11.76">                 // Still need to visually notify for uncached calendars.</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-                if (!thisCalendar.isCached &amp;&amp; !Components.isSuccessCode(listenerStatus)) {</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-                    thisCalendar.reportDavError(calIErrors.DAV_PUT_ERROR, listenerStatus, listenerDetail);</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+                if (!self.isCached &amp;&amp; !Components.isSuccessCode(listenerStatus)) {</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+                    self.reportDavError(calIErrors.DAV_PUT_ERROR, listenerStatus, listenerDetail);</span>
<a href="#l11.81"></a><span id="l11.81">                 }</span>
<a href="#l11.82"></a><span id="l11.82"> </span>
<a href="#l11.83"></a><span id="l11.83">                 // Finally, notify listener.</span>
<a href="#l11.84"></a><span id="l11.84">                 notifyListener(listenerStatus, listenerDetail, true);</span>
<a href="#l11.85"></a><span id="l11.85">             }</span>
<a href="#l11.86"></a><span id="l11.86">         };</span>
<a href="#l11.87"></a><span id="l11.87"> </span>
<a href="#l11.88"></a><span id="l11.88">         this.sendHttpRequest(itemUri, serializedItem, MIME_TEXT_CALENDAR, null, (channel) =&gt; {</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineat">@@ -761,80 +761,80 @@ calDavCalendar.prototype = {</span>
<a href="#l11.90"></a><span id="l11.90">         aNewItem = aNewItem.parentItem.clone();</span>
<a href="#l11.91"></a><span id="l11.91">         if (newItem_.parentItem != newItem_) {</span>
<a href="#l11.92"></a><span id="l11.92">             aNewItem.recurrenceInfo.modifyException(newItem_, false);</span>
<a href="#l11.93"></a><span id="l11.93">         }</span>
<a href="#l11.94"></a><span id="l11.94">         aNewItem.generation += 1;</span>
<a href="#l11.95"></a><span id="l11.95"> </span>
<a href="#l11.96"></a><span id="l11.96">         let eventUri = this.makeUri(this.mItemInfoCache[aNewItem.id].locationPath);</span>
<a href="#l11.97"></a><span id="l11.97"> </span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-        let thisCalendar = this;</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+        let self = this;</span>
<a href="#l11.100"></a><span id="l11.100"> </span>
<a href="#l11.101"></a><span id="l11.101">         let modifiedItemICS = this.getSerializedItem(aNewItem);</span>
<a href="#l11.102"></a><span id="l11.102"> </span>
<a href="#l11.103"></a><span id="l11.103">         let modListener = {</span>
<a href="#l11.104"></a><span id="l11.104">             onStreamComplete: function caldav_mod_onStreamComplete(aLoader, aContext, aStatus,</span>
<a href="#l11.105"></a><span id="l11.105">                                                                    aResultLength, aResult) {</span>
<a href="#l11.106"></a><span id="l11.106">                 let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l11.107"></a><span id="l11.107">                 let listenerStatus = Components.results.NS_OK;</span>
<a href="#l11.108"></a><span id="l11.108">                 let listenerDetail = aNewItem;</span>
<a href="#l11.109"></a><span id="l11.109">                 let responseStatus;</span>
<a href="#l11.110"></a><span id="l11.110">                 try {</span>
<a href="#l11.111"></a><span id="l11.111">                     responseStatus = request.responseStatus;</span>
<a href="#l11.112"></a><span id="l11.112"> </span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-                    if (thisCalendar.verboseLogging()) {</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+                    if (self.verboseLogging()) {</span>
<a href="#l11.115"></a><span id="l11.115">                        let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l11.116"></a><span id="l11.116">                        cal.LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l11.117"></a><span id="l11.117">                     }</span>
<a href="#l11.118"></a><span id="l11.118">                 } catch (ex) {</span>
<a href="#l11.119"></a><span id="l11.119">                     listenerStatus = ex.result;</span>
<a href="#l11.120"></a><span id="l11.120">                     listenerDetail = &quot;Request Failed: &quot; + ex.message;</span>
<a href="#l11.121"></a><span id="l11.121">                     cal.LOG(&quot;CalDAV: Request error during add: &quot; + ex);</span>
<a href="#l11.122"></a><span id="l11.122">                 }</span>
<a href="#l11.123"></a><span id="l11.123"> </span>
<a href="#l11.124"></a><span id="l11.124">                 if (responseStatus == 204 || responseStatus == 201 || responseStatus == 200) {</span>
<a href="#l11.125"></a><span id="l11.125">                     // We should not accept a 201 status here indefinitely: it indicates a server error</span>
<a href="#l11.126"></a><span id="l11.126">                     // of some kind that we want to know about. It's convenient to accept it for now</span>
<a href="#l11.127"></a><span id="l11.127">                     // since a number of server impls don't get this right yet.</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-                    cal.LOG(&quot;CalDAV: Item modified successfully on &quot; + thisCalendar.name);</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+                    cal.LOG(&quot;CalDAV: Item modified successfully on &quot; + self.name);</span>
<a href="#l11.130"></a><span id="l11.130"> </span>
<a href="#l11.131"></a><span id="l11.131">                     // Some CalDAV servers will modify items on PUT (add X-props,</span>
<a href="#l11.132"></a><span id="l11.132">                     // for instance) so we'd best re-fetch in order to know</span>
<a href="#l11.133"></a><span id="l11.133">                     // the current state of the item</span>
<a href="#l11.134"></a><span id="l11.134">                     // Observers will be notified in getUpdatedItem()</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">-                    thisCalendar.getUpdatedItem(aNewItem, aListener);</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+                    self.getUpdatedItem(aNewItem, aListener);</span>
<a href="#l11.137"></a><span id="l11.137"> </span>
<a href="#l11.138"></a><span id="l11.138">                     // SOGo has calendarUri == inboxUri so we need to be careful</span>
<a href="#l11.139"></a><span id="l11.139">                     // about deletions</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineminus">-                    if (wasInboxItem &amp;&amp; thisCalendar.mShouldPollInbox) {</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineminus">-                        thisCalendar.doDeleteItem(aNewItem, null, true, true, null);</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+                    if (wasInboxItem &amp;&amp; self.mShouldPollInbox) {</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+                        self.doDeleteItem(aNewItem, null, true, true, null);</span>
<a href="#l11.144"></a><span id="l11.144">                     }</span>
<a href="#l11.145"></a><span id="l11.145">                     return;</span>
<a href="#l11.146"></a><span id="l11.146">                 } else if (responseStatus == 412 || responseStatus == 409) {</span>
<a href="#l11.147"></a><span id="l11.147">                     // promptOverwrite will ask the user and then re-request</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineminus">-                    thisCalendar.promptOverwrite(CALDAV_MODIFY_ITEM, aNewItem,</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineminus">-                                                 aListener, aOldItem);</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+                    self.promptOverwrite(CALDAV_MODIFY_ITEM, aNewItem,</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+                                         aListener, aOldItem);</span>
<a href="#l11.152"></a><span id="l11.152">                     return;</span>
<a href="#l11.153"></a><span id="l11.153">                 } else if (responseStatus &gt;= 500 &amp;&amp; responseStatus &lt;= 510) {</span>
<a href="#l11.154"></a><span id="l11.154">                     listenerStatus = Components.results.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l11.155"></a><span id="l11.155">                     listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l11.156"></a><span id="l11.156">                 } else if (responseStatus) {</span>
<a href="#l11.157"></a><span id="l11.157">                     // There is a response status, but we haven't handled it yet. Any</span>
<a href="#l11.158"></a><span id="l11.158">                     // error occurring here should consider being handled!</span>
<a href="#l11.159"></a><span id="l11.159">                     cal.ERROR(&quot;CalDAV: Unexpected status modifying item to &quot; +</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-                              thisCalendar.name + &quot;: &quot; + responseStatus + &quot;\n&quot; +</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+                              self.name + &quot;: &quot; + responseStatus + &quot;\n&quot; +</span>
<a href="#l11.162"></a><span id="l11.162">                               modifiedItemICS);</span>
<a href="#l11.163"></a><span id="l11.163"> </span>
<a href="#l11.164"></a><span id="l11.164">                     listenerStatus = Components.results.NS_ERROR_FAILURE;</span>
<a href="#l11.165"></a><span id="l11.165">                     listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l11.166"></a><span id="l11.166">                 }</span>
<a href="#l11.167"></a><span id="l11.167"> </span>
<a href="#l11.168"></a><span id="l11.168">                 // Still need to visually notify for uncached calendars.</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-                if (!thisCalendar.isCached &amp;&amp; !Components.isSuccessCode(listenerStatus)) {</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineminus">-                    thisCalendar.reportDavError(calIErrors.DAV_PUT_ERROR, listenerStatus, listenerDetail);</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+                if (!self.isCached &amp;&amp; !Components.isSuccessCode(listenerStatus)) {</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+                    self.reportDavError(calIErrors.DAV_PUT_ERROR, listenerStatus, listenerDetail);</span>
<a href="#l11.173"></a><span id="l11.173">                 }</span>
<a href="#l11.174"></a><span id="l11.174"> </span>
<a href="#l11.175"></a><span id="l11.175">                 notifyListener(listenerStatus, listenerDetail, true);</span>
<a href="#l11.176"></a><span id="l11.176">             }</span>
<a href="#l11.177"></a><span id="l11.177">         };</span>
<a href="#l11.178"></a><span id="l11.178"> </span>
<a href="#l11.179"></a><span id="l11.179">         this.sendHttpRequest(eventUri, modifiedItemICS, MIME_TEXT_CALENDAR, null, (channel) =&gt; {</span>
<a href="#l11.180"></a><span id="l11.180">             if (!aIgnoreEtag) {</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineat">@@ -892,98 +892,98 @@ calDavCalendar.prototype = {</span>
<a href="#l11.182"></a><span id="l11.182"> </span>
<a href="#l11.183"></a><span id="l11.183">         if (eventUri.path == this.calendarUri.path) {</span>
<a href="#l11.184"></a><span id="l11.184">             notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l11.185"></a><span id="l11.185">                            &quot;eventUri and calendarUri paths are the same, &quot; +</span>
<a href="#l11.186"></a><span id="l11.186">                            &quot;will not go on to delete entire calendar&quot;);</span>
<a href="#l11.187"></a><span id="l11.187">             return;</span>
<a href="#l11.188"></a><span id="l11.188">         }</span>
<a href="#l11.189"></a><span id="l11.189"> </span>
<a href="#l11.190"></a><span id="l11.190" class="difflineminus">-        let thisCalendar = this;</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineplus">+        let self = this;</span>
<a href="#l11.192"></a><span id="l11.192"> </span>
<a href="#l11.193"></a><span id="l11.193">         let delListener = {</span>
<a href="#l11.194"></a><span id="l11.194">             onStreamComplete: function caldav_dDI_del_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l11.195"></a><span id="l11.195">                 let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l11.196"></a><span id="l11.196">                 let listenerStatus = Components.results.NS_OK;</span>
<a href="#l11.197"></a><span id="l11.197">                 let listenerDetail = aItem;</span>
<a href="#l11.198"></a><span id="l11.198">                 let responseStatus;</span>
<a href="#l11.199"></a><span id="l11.199">                 try {</span>
<a href="#l11.200"></a><span id="l11.200">                     responseStatus = request.responseStatus;</span>
<a href="#l11.201"></a><span id="l11.201"> </span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-                    if (thisCalendar.verboseLogging()) {</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+                    if (self.verboseLogging()) {</span>
<a href="#l11.204"></a><span id="l11.204">                         let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l11.205"></a><span id="l11.205">                         cal.LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l11.206"></a><span id="l11.206">                     }</span>
<a href="#l11.207"></a><span id="l11.207">                 } catch (ex) {</span>
<a href="#l11.208"></a><span id="l11.208">                     listenerStatus = ex.result;</span>
<a href="#l11.209"></a><span id="l11.209">                     listenerDetail = &quot;Request Failed: &quot; + ex.message;</span>
<a href="#l11.210"></a><span id="l11.210">                     cal.LOG(&quot;CalDAV: Request error during delete: &quot; + ex);</span>
<a href="#l11.211"></a><span id="l11.211">                 }</span>
<a href="#l11.212"></a><span id="l11.212"> </span>
<a href="#l11.213"></a><span id="l11.213">                 // 204 = HTTP &quot;No content&quot;</span>
<a href="#l11.214"></a><span id="l11.214">                 // 404 = Not Found - This is kind of a success, since the item is already deleted.</span>
<a href="#l11.215"></a><span id="l11.215">                 //</span>
<a href="#l11.216"></a><span id="l11.216">                 if (responseStatus == 204 || responseStatus == 200 || responseStatus == 404) {</span>
<a href="#l11.217"></a><span id="l11.217">                     if (!aFromInbox) {</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineminus">-                        let decodedPath = thisCalendar.ensureDecodedPath(eventUri.path);</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineminus">-                        delete thisCalendar.mHrefIndex[decodedPath];</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineminus">-                        delete thisCalendar.mItemInfoCache[aItem.id];</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineminus">-                        cal.LOG(&quot;CalDAV: Item deleted successfully from calendar &quot; + thisCalendar.name);</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineplus">+                        let decodedPath = self.ensureDecodedPath(eventUri.path);</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineplus">+                        delete self.mHrefIndex[decodedPath];</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineplus">+                        delete self.mItemInfoCache[aItem.id];</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+                        cal.LOG(&quot;CalDAV: Item deleted successfully from calendar &quot; + self.name);</span>
<a href="#l11.226"></a><span id="l11.226"> </span>
<a href="#l11.227"></a><span id="l11.227" class="difflineminus">-                        if (!thisCalendar.isCached) {</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineplus">+                        if (!self.isCached) {</span>
<a href="#l11.229"></a><span id="l11.229">                             // If the calendar is not cached, we need to remove</span>
<a href="#l11.230"></a><span id="l11.230">                             // the item from our memory calendar now. The</span>
<a href="#l11.231"></a><span id="l11.231">                             // listeners will be notified there.</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineminus">-                            thisCalendar.mOfflineStorage.deleteItem(aItem, aListener);</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineplus">+                            self.mOfflineStorage.deleteItem(aItem, aListener);</span>
<a href="#l11.234"></a><span id="l11.234">                             return;</span>
<a href="#l11.235"></a><span id="l11.235">                         }</span>
<a href="#l11.236"></a><span id="l11.236">                     }</span>
<a href="#l11.237"></a><span id="l11.237">                 } else if (responseStatus == 412 || responseStatus == 409) {</span>
<a href="#l11.238"></a><span id="l11.238">                     // item has either been modified or deleted by someone else check to see which</span>
<a href="#l11.239"></a><span id="l11.239">                     cal.LOG(&quot;CalDAV: Item has been modified on server, checking if it has been deleted&quot;);</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineminus">-                    thisCalendar.sendHttpRequest(eventUri, null, null, null, (channel) =&gt; {</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineplus">+                    self.sendHttpRequest(eventUri, null, null, null, (channel) =&gt; {</span>
<a href="#l11.242"></a><span id="l11.242">                         channel.requestMethod = &quot;HEAD&quot;;</span>
<a href="#l11.243"></a><span id="l11.243">                         return delListener2;</span>
<a href="#l11.244"></a><span id="l11.244">                     }, () =&gt; {</span>
<a href="#l11.245"></a><span id="l11.245">                         notifyListener(Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l11.246"></a><span id="l11.246">                                        &quot;Error preparing http channel&quot;);</span>
<a href="#l11.247"></a><span id="l11.247">                     });</span>
<a href="#l11.248"></a><span id="l11.248">                     return;</span>
<a href="#l11.249"></a><span id="l11.249">                 } else if (responseStatus &gt;= 500 &amp;&amp; responseStatus &lt;= 510) {</span>
<a href="#l11.250"></a><span id="l11.250">                     listenerStatus = Components.results.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l11.251"></a><span id="l11.251">                     listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l11.252"></a><span id="l11.252">                 } else if (responseStatus) {</span>
<a href="#l11.253"></a><span id="l11.253">                     cal.ERROR(&quot;CalDAV: Unexpected status deleting item from &quot; +</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineminus">-                              thisCalendar.name + &quot;: &quot; + responseStatus + &quot;\n&quot; +</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineplus">+                              self.name + &quot;: &quot; + responseStatus + &quot;\n&quot; +</span>
<a href="#l11.256"></a><span id="l11.256">                               &quot;uri: &quot; + eventUri.spec);</span>
<a href="#l11.257"></a><span id="l11.257"> </span>
<a href="#l11.258"></a><span id="l11.258">                     listenerStatus = Components.results.NS_ERROR_FAILURE;</span>
<a href="#l11.259"></a><span id="l11.259">                     listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l11.260"></a><span id="l11.260">                 }</span>
<a href="#l11.261"></a><span id="l11.261"> </span>
<a href="#l11.262"></a><span id="l11.262">                 // Still need to visually notify for uncached calendars.</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineminus">-                if (!thisCalendar.isCached &amp;&amp; !Components.isSuccessCode(listenerStatus)) {</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineminus">-                    thisCalendar.reportDavError(calIErrors.DAV_REMOVE_ERROR, listenerStatus, listenerDetail);</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineplus">+                if (!self.isCached &amp;&amp; !Components.isSuccessCode(listenerStatus)) {</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineplus">+                    self.reportDavError(calIErrors.DAV_REMOVE_ERROR, listenerStatus, listenerDetail);</span>
<a href="#l11.267"></a><span id="l11.267">                 }</span>
<a href="#l11.268"></a><span id="l11.268"> </span>
<a href="#l11.269"></a><span id="l11.269">                 // Finally, notify listener.</span>
<a href="#l11.270"></a><span id="l11.270">                 notifyListener(listenerStatus, listenerDetail);</span>
<a href="#l11.271"></a><span id="l11.271">             }</span>
<a href="#l11.272"></a><span id="l11.272">         };</span>
<a href="#l11.273"></a><span id="l11.273"> </span>
<a href="#l11.274"></a><span id="l11.274">         let delListener2 = {</span>
<a href="#l11.275"></a><span id="l11.275">             onStreamComplete: function caldav_dDI_del2_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l11.276"></a><span id="l11.276">                 let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l11.277"></a><span id="l11.277">                 let listenerStatus = Components.results.NS_OK;</span>
<a href="#l11.278"></a><span id="l11.278">                 let listenerDetail = aItem;</span>
<a href="#l11.279"></a><span id="l11.279">                 let responseStatus;</span>
<a href="#l11.280"></a><span id="l11.280">                 try {</span>
<a href="#l11.281"></a><span id="l11.281">                     responseStatus = request.responseStatus;</span>
<a href="#l11.282"></a><span id="l11.282"> </span>
<a href="#l11.283"></a><span id="l11.283" class="difflineminus">-                    if (thisCalendar.verboseLogging()) {</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineplus">+                    if (self.verboseLogging()) {</span>
<a href="#l11.285"></a><span id="l11.285">                         let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l11.286"></a><span id="l11.286">                         cal.LOG(&quot;CalDAV: recv: &quot; + (str || &quot;&quot;));</span>
<a href="#l11.287"></a><span id="l11.287">                     }</span>
<a href="#l11.288"></a><span id="l11.288">                 } catch (ex) {</span>
<a href="#l11.289"></a><span id="l11.289">                     listenerStatus = ex.result;</span>
<a href="#l11.290"></a><span id="l11.290">                     listenerDetail = &quot;Request Failed: &quot; + ex.message;</span>
<a href="#l11.291"></a><span id="l11.291">                     cal.LOG(&quot;CalDAV: Request error during add: &quot; + ex);</span>
<a href="#l11.292"></a><span id="l11.292">                 }</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineat">@@ -993,17 +993,17 @@ calDavCalendar.prototype = {</span>
<a href="#l11.294"></a><span id="l11.294">                     // Someone else has already deleted it</span>
<a href="#l11.295"></a><span id="l11.295">                 } else if (responseStatus &gt;= 500 &amp;&amp; responseStatus &lt;= 510) {</span>
<a href="#l11.296"></a><span id="l11.296">                     listenerStatus = Components.results.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l11.297"></a><span id="l11.297">                     listenerDetail = &quot;Server Replied with &quot; + responseStatus;</span>
<a href="#l11.298"></a><span id="l11.298">                 } else if (responseStatus) {</span>
<a href="#l11.299"></a><span id="l11.299">                     // The item still exists. We need to ask the user if he</span>
<a href="#l11.300"></a><span id="l11.300">                     // really wants to delete the item. Remember, we only</span>
<a href="#l11.301"></a><span id="l11.301">                     // made this request since the actual delete gave 409/412</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineminus">-                    thisCalendar.promptOverwrite(CALDAV_DELETE_ITEM, aItem, aListener, null);</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineplus">+                    self.promptOverwrite(CALDAV_DELETE_ITEM, aItem, aListener, null);</span>
<a href="#l11.304"></a><span id="l11.304">                     return;</span>
<a href="#l11.305"></a><span id="l11.305">                 }</span>
<a href="#l11.306"></a><span id="l11.306"> </span>
<a href="#l11.307"></a><span id="l11.307">                 // Finally, notify listener.</span>
<a href="#l11.308"></a><span id="l11.308">                 notifyListener(listenerStatus, listenerDetail, true);</span>
<a href="#l11.309"></a><span id="l11.309">             }</span>
<a href="#l11.310"></a><span id="l11.310">         };</span>
<a href="#l11.311"></a><span id="l11.311"> </span>
<a href="#l11.312"></a><span id="l11.312" class="difflineat">@@ -1325,26 +1325,26 @@ calDavCalendar.prototype = {</span>
<a href="#l11.313"></a><span id="l11.313">     safeRefresh: function caldav_safeRefresh(aChangeLogListener) {</span>
<a href="#l11.314"></a><span id="l11.314">         let notifyListener = (status) =&gt; {</span>
<a href="#l11.315"></a><span id="l11.315">             if (this.isCached &amp;&amp; aChangeLogListener) {</span>
<a href="#l11.316"></a><span id="l11.316">                 aChangeLogListener.onResult({ status: status }, status);</span>
<a href="#l11.317"></a><span id="l11.317">             }</span>
<a href="#l11.318"></a><span id="l11.318">         };</span>
<a href="#l11.319"></a><span id="l11.319"> </span>
<a href="#l11.320"></a><span id="l11.320">         if (!this.mACLEntry) {</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineminus">-            let thisCalendar = this;</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineplus">+            let self = this;</span>
<a href="#l11.323"></a><span id="l11.323">             let opListener = {</span>
<a href="#l11.324"></a><span id="l11.324">                 QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l11.325"></a><span id="l11.325">                 onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l11.326"></a><span id="l11.326">                     ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l11.327"></a><span id="l11.327">                 },</span>
<a href="#l11.328"></a><span id="l11.328">                 onOperationComplete: function(opCalendar, opStatus, opType, opId, opDetail) {</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineminus">-                    thisCalendar.mACLEntry = opDetail;</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineminus">-                    thisCalendar.fillACLProperties();</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineminus">-                    thisCalendar.safeRefresh(aChangeLogListener);</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineplus">+                    self.mACLEntry = opDetail;</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineplus">+                    self.fillACLProperties();</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineplus">+                    self.safeRefresh(aChangeLogListener);</span>
<a href="#l11.335"></a><span id="l11.335">                 }</span>
<a href="#l11.336"></a><span id="l11.336">             };</span>
<a href="#l11.337"></a><span id="l11.337"> </span>
<a href="#l11.338"></a><span id="l11.338">             this.aclManager.getCalendarEntry(this, opListener);</span>
<a href="#l11.339"></a><span id="l11.339">             return;</span>
<a href="#l11.340"></a><span id="l11.340">         }</span>
<a href="#l11.341"></a><span id="l11.341"> </span>
<a href="#l11.342"></a><span id="l11.342">         this.ensureTargetCalendar();</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineat">@@ -1372,17 +1372,17 @@ calDavCalendar.prototype = {</span>
<a href="#l11.344"></a><span id="l11.344">         // *OR* if webdav Sync is enabled (It is redundant to send a request</span>
<a href="#l11.345"></a><span id="l11.345">         // to get the collection tag (getctag) on a calendar if it supports</span>
<a href="#l11.346"></a><span id="l11.346">         // webdav sync, the sync request will only return data if something</span>
<a href="#l11.347"></a><span id="l11.347">         // changed).</span>
<a href="#l11.348"></a><span id="l11.348">         if (!this.mCtag || !this.mFirstRefreshDone || this.mHasWebdavSyncSupport) {</span>
<a href="#l11.349"></a><span id="l11.349">             this.getUpdatedItems(this.calendarUri, aChangeLogListener);</span>
<a href="#l11.350"></a><span id="l11.350">             return;</span>
<a href="#l11.351"></a><span id="l11.351">         }</span>
<a href="#l11.352"></a><span id="l11.352" class="difflineminus">-        let thisCalendar = this;</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineplus">+        let self = this;</span>
<a href="#l11.354"></a><span id="l11.354">         let queryXml =</span>
<a href="#l11.355"></a><span id="l11.355">             xmlHeader +</span>
<a href="#l11.356"></a><span id="l11.356">             '&lt;D:propfind xmlns:D=&quot;DAV:&quot; xmlns:CS=&quot;http://calendarserver.org/ns/&quot;&gt;' +</span>
<a href="#l11.357"></a><span id="l11.357">               &quot;&lt;D:prop&gt;&quot; +</span>
<a href="#l11.358"></a><span id="l11.358">                 &quot;&lt;CS:getctag/&gt;&quot; +</span>
<a href="#l11.359"></a><span id="l11.359">               &quot;&lt;/D:prop&gt;&quot; +</span>
<a href="#l11.360"></a><span id="l11.360">             &quot;&lt;/D:propfind&gt;&quot;;</span>
<a href="#l11.361"></a><span id="l11.361"> </span>
<a href="#l11.362"></a><span id="l11.362" class="difflineat">@@ -1391,76 +1391,75 @@ calDavCalendar.prototype = {</span>
<a href="#l11.363"></a><span id="l11.363">         }</span>
<a href="#l11.364"></a><span id="l11.364"> </span>
<a href="#l11.365"></a><span id="l11.365">         let streamListener = {};</span>
<a href="#l11.366"></a><span id="l11.366">         streamListener.onStreamComplete =</span>
<a href="#l11.367"></a><span id="l11.367">             function safeRefresh_safeRefresh_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l11.368"></a><span id="l11.368">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l11.369"></a><span id="l11.369">             try {</span>
<a href="#l11.370"></a><span id="l11.370">                 cal.LOG(&quot;CalDAV: Status &quot; + request.responseStatus +</span>
<a href="#l11.371"></a><span id="l11.371" class="difflineminus">-                        &quot; checking ctag for calendar &quot; + thisCalendar.name);</span>
<a href="#l11.372"></a><span id="l11.372" class="difflineplus">+                        &quot; checking ctag for calendar &quot; + self.name);</span>
<a href="#l11.373"></a><span id="l11.373">             } catch (ex) {</span>
<a href="#l11.374"></a><span id="l11.374">                 cal.LOG(&quot;CalDAV: Error without status on checking ctag for calendar &quot; +</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineminus">-                        thisCalendar.name);</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineplus">+                        self.name);</span>
<a href="#l11.377"></a><span id="l11.377">                 notifyListener(Components.results.NS_OK);</span>
<a href="#l11.378"></a><span id="l11.378">                 return;</span>
<a href="#l11.379"></a><span id="l11.379">             }</span>
<a href="#l11.380"></a><span id="l11.380"> </span>
<a href="#l11.381"></a><span id="l11.381">             if (request.responseStatus == 404) {</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineminus">-                cal.LOG(&quot;CalDAV: Disabling calendar &quot; + thisCalendar.name +</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineplus">+                cal.LOG(&quot;CalDAV: Disabling calendar &quot; + self.name +</span>
<a href="#l11.384"></a><span id="l11.384">                         &quot; due to 404&quot;);</span>
<a href="#l11.385"></a><span id="l11.385">                 notifyListener(Components.results.NS_ERROR_FAILURE);</span>
<a href="#l11.386"></a><span id="l11.386">                 return;</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineminus">-            } else if (request.responseStatus == 207 &amp;&amp; thisCalendar.mDisabled) {</span>
<a href="#l11.388"></a><span id="l11.388" class="difflineplus">+            } else if (request.responseStatus == 207 &amp;&amp; self.mDisabled) {</span>
<a href="#l11.389"></a><span id="l11.389">                 // Looks like the calendar is there again, check its resource</span>
<a href="#l11.390"></a><span id="l11.390">                 // type first.</span>
<a href="#l11.391"></a><span id="l11.391" class="difflineminus">-                thisCalendar.setupAuthentication(aChangeLogListener);</span>
<a href="#l11.392"></a><span id="l11.392" class="difflineplus">+                self.setupAuthentication(aChangeLogListener);</span>
<a href="#l11.393"></a><span id="l11.393">                 return;</span>
<a href="#l11.394"></a><span id="l11.394">              }</span>
<a href="#l11.395"></a><span id="l11.395"> </span>
<a href="#l11.396"></a><span id="l11.396">             let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l11.397"></a><span id="l11.397">             if (!str) {</span>
<a href="#l11.398"></a><span id="l11.398">                 cal.LOG(&quot;CalDAV: Failed to get ctag from server for calendar &quot; +</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineminus">-                        thisCalendar.name);</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineminus">-            } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l11.401"></a><span id="l11.401" class="difflineplus">+                        self.name);</span>
<a href="#l11.402"></a><span id="l11.402" class="difflineplus">+            } else if (self.verboseLogging()) {</span>
<a href="#l11.403"></a><span id="l11.403">                 cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l11.404"></a><span id="l11.404">             }</span>
<a href="#l11.405"></a><span id="l11.405"> </span>
<a href="#l11.406"></a><span id="l11.406">             let multistatus;</span>
<a href="#l11.407"></a><span id="l11.407">             try {</span>
<a href="#l11.408"></a><span id="l11.408">                 multistatus = cal.xml.parseString(str);</span>
<a href="#l11.409"></a><span id="l11.409">             } catch (ex) {</span>
<a href="#l11.410"></a><span id="l11.410">                 cal.LOG(&quot;CalDAV: Failed to get ctag from server for calendar &quot; +</span>
<a href="#l11.411"></a><span id="l11.411" class="difflineminus">-                        thisCalendar.name);</span>
<a href="#l11.412"></a><span id="l11.412" class="difflineplus">+                        self.name);</span>
<a href="#l11.413"></a><span id="l11.413">                 notifyListener(Components.results.NS_OK);</span>
<a href="#l11.414"></a><span id="l11.414">                 return;</span>
<a href="#l11.415"></a><span id="l11.415">             }</span>
<a href="#l11.416"></a><span id="l11.416"> </span>
<a href="#l11.417"></a><span id="l11.417">             let ctag = caldavXPathFirst(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop/CS:getctag/text()&quot;);</span>
<a href="#l11.418"></a><span id="l11.418" class="difflineminus">-            if (!ctag || ctag != thisCalendar.mCtag) {</span>
<a href="#l11.419"></a><span id="l11.419" class="difflineplus">+            if (!ctag || ctag != self.mCtag) {</span>
<a href="#l11.420"></a><span id="l11.420">                 // ctag mismatch, need to fetch calendar-data</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineminus">-                thisCalendar.mProposedCtag = ctag;</span>
<a href="#l11.422"></a><span id="l11.422" class="difflineminus">-                thisCalendar.getUpdatedItems(thisCalendar.calendarUri,</span>
<a href="#l11.423"></a><span id="l11.423" class="difflineminus">-                                             aChangeLogListener);</span>
<a href="#l11.424"></a><span id="l11.424" class="difflineminus">-                if (thisCalendar.verboseLogging()) {</span>
<a href="#l11.425"></a><span id="l11.425" class="difflineplus">+                self.mProposedCtag = ctag;</span>
<a href="#l11.426"></a><span id="l11.426" class="difflineplus">+                self.getUpdatedItems(self.calendarUri, aChangeLogListener);</span>
<a href="#l11.427"></a><span id="l11.427" class="difflineplus">+                if (self.verboseLogging()) {</span>
<a href="#l11.428"></a><span id="l11.428">                     cal.LOG(&quot;CalDAV: ctag mismatch on refresh, fetching data for &quot; +</span>
<a href="#l11.429"></a><span id="l11.429" class="difflineminus">-                            &quot;calendar &quot; + thisCalendar.name);</span>
<a href="#l11.430"></a><span id="l11.430" class="difflineplus">+                            &quot;calendar &quot; + self.name);</span>
<a href="#l11.431"></a><span id="l11.431">                 }</span>
<a href="#l11.432"></a><span id="l11.432">             } else {</span>
<a href="#l11.433"></a><span id="l11.433" class="difflineminus">-                if (thisCalendar.verboseLogging()) {</span>
<a href="#l11.434"></a><span id="l11.434" class="difflineplus">+                if (self.verboseLogging()) {</span>
<a href="#l11.435"></a><span id="l11.435">                     cal.LOG(&quot;CalDAV: ctag matches, no need to fetch data for &quot; +</span>
<a href="#l11.436"></a><span id="l11.436" class="difflineminus">-                            &quot;calendar &quot; + thisCalendar.name);</span>
<a href="#l11.437"></a><span id="l11.437" class="difflineplus">+                            &quot;calendar &quot; + self.name);</span>
<a href="#l11.438"></a><span id="l11.438">                 }</span>
<a href="#l11.439"></a><span id="l11.439"> </span>
<a href="#l11.440"></a><span id="l11.440">                 // Notify the listener, but don't return just yet...</span>
<a href="#l11.441"></a><span id="l11.441">                 notifyListener(Components.results.NS_OK);</span>
<a href="#l11.442"></a><span id="l11.442"> </span>
<a href="#l11.443"></a><span id="l11.443">                 // ...we may still need to poll the inbox</span>
<a href="#l11.444"></a><span id="l11.444" class="difflineminus">-                if (thisCalendar.firstInRealm()) {</span>
<a href="#l11.445"></a><span id="l11.445" class="difflineminus">-                    thisCalendar.pollInbox();</span>
<a href="#l11.446"></a><span id="l11.446" class="difflineplus">+                if (self.firstInRealm()) {</span>
<a href="#l11.447"></a><span id="l11.447" class="difflineplus">+                    self.pollInbox();</span>
<a href="#l11.448"></a><span id="l11.448">                 }</span>
<a href="#l11.449"></a><span id="l11.449">             }</span>
<a href="#l11.450"></a><span id="l11.450">         };</span>
<a href="#l11.451"></a><span id="l11.451"> </span>
<a href="#l11.452"></a><span id="l11.452">         this.sendHttpRequest(this.makeUri(), queryXml, MIME_TEXT_XML, null, (channel) =&gt; {</span>
<a href="#l11.453"></a><span id="l11.453">             channel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l11.454"></a><span id="l11.454">             channel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l11.455"></a><span id="l11.455">             return streamListener;</span>
<a href="#l11.456"></a><span id="l11.456" class="difflineat">@@ -1676,17 +1675,17 @@ calDavCalendar.prototype = {</span>
<a href="#l11.457"></a><span id="l11.457">      * findPrincipalNS</span>
<a href="#l11.458"></a><span id="l11.458">      * checkPrincipalsNameSpace</span>
<a href="#l11.459"></a><span id="l11.459">      * completeCheckServerInfo</span>
<a href="#l11.460"></a><span id="l11.460">      */</span>
<a href="#l11.461"></a><span id="l11.461">     checkDavResourceType: function caldav_checkDavResourceType(aChangeLogListener) {</span>
<a href="#l11.462"></a><span id="l11.462">         this.ensureTargetCalendar();</span>
<a href="#l11.463"></a><span id="l11.463"> </span>
<a href="#l11.464"></a><span id="l11.464">         let resourceType = kDavResourceTypeNone;</span>
<a href="#l11.465"></a><span id="l11.465" class="difflineminus">-        let thisCalendar = this;</span>
<a href="#l11.466"></a><span id="l11.466" class="difflineplus">+        let self = this;</span>
<a href="#l11.467"></a><span id="l11.467"> </span>
<a href="#l11.468"></a><span id="l11.468">         let queryXml =</span>
<a href="#l11.469"></a><span id="l11.469">             xmlHeader +</span>
<a href="#l11.470"></a><span id="l11.470">             '&lt;D:propfind xmlns:D=&quot;DAV:&quot; xmlns:CS=&quot;http://calendarserver.org/ns/&quot; xmlns:C=&quot;urn:ietf:params:xml:ns:caldav&quot;&gt;' +</span>
<a href="#l11.471"></a><span id="l11.471">               &quot;&lt;D:prop&gt;&quot; +</span>
<a href="#l11.472"></a><span id="l11.472">                 &quot;&lt;D:resourcetype/&gt;&quot; +</span>
<a href="#l11.473"></a><span id="l11.473">                 &quot;&lt;D:owner/&gt;&quot; +</span>
<a href="#l11.474"></a><span id="l11.474">                 &quot;&lt;D:current-user-principal/&gt;&quot; +</span>
<a href="#l11.475"></a><span id="l11.475" class="difflineat">@@ -1701,212 +1700,212 @@ calDavCalendar.prototype = {</span>
<a href="#l11.476"></a><span id="l11.476">         }</span>
<a href="#l11.477"></a><span id="l11.477">         let streamListener = {};</span>
<a href="#l11.478"></a><span id="l11.478"> </span>
<a href="#l11.479"></a><span id="l11.479">         streamListener.onStreamComplete =</span>
<a href="#l11.480"></a><span id="l11.480">             function checkDavResourceType_oSC(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l11.481"></a><span id="l11.481">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l11.482"></a><span id="l11.482">             try {</span>
<a href="#l11.483"></a><span id="l11.483">                 cal.LOG(&quot;CalDAV: Status &quot; + request.responseStatus +</span>
<a href="#l11.484"></a><span id="l11.484" class="difflineminus">-                        &quot; on initial PROPFIND for calendar &quot; + thisCalendar.name);</span>
<a href="#l11.485"></a><span id="l11.485" class="difflineplus">+                        &quot; on initial PROPFIND for calendar &quot; + self.name);</span>
<a href="#l11.486"></a><span id="l11.486">             } catch (ex) {</span>
<a href="#l11.487"></a><span id="l11.487">                 cal.LOG(&quot;CalDAV: Error without status on initial PROPFIND for calendar &quot; +</span>
<a href="#l11.488"></a><span id="l11.488" class="difflineminus">-                        thisCalendar.name);</span>
<a href="#l11.489"></a><span id="l11.489" class="difflineminus">-                thisCalendar.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l11.490"></a><span id="l11.490" class="difflineminus">-                                                     Components.interfaces.calIErrors.DAV_NOT_DAV);</span>
<a href="#l11.491"></a><span id="l11.491" class="difflineplus">+                        self.name);</span>
<a href="#l11.492"></a><span id="l11.492" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l11.493"></a><span id="l11.493" class="difflineplus">+                                             Components.interfaces.calIErrors.DAV_NOT_DAV);</span>
<a href="#l11.494"></a><span id="l11.494">                 return;</span>
<a href="#l11.495"></a><span id="l11.495">             }</span>
<a href="#l11.496"></a><span id="l11.496"> </span>
<a href="#l11.497"></a><span id="l11.497">             let isText = true;</span>
<a href="#l11.498"></a><span id="l11.498"> </span>
<a href="#l11.499"></a><span id="l11.499">             if ((isText || request.URI.spec != request.originalURI.spec) &amp;&amp;</span>
<a href="#l11.500"></a><span id="l11.500" class="difflineminus">-                thisCalendar.mLastRedirectStatus == 301) {</span>
<a href="#l11.501"></a><span id="l11.501" class="difflineplus">+                self.mLastRedirectStatus == 301) {</span>
<a href="#l11.502"></a><span id="l11.502">                 // The initial PROPFIND essentially goes against the calendar</span>
<a href="#l11.503"></a><span id="l11.503">                 // collection url. If a 301 Moved Permanently redirect occurred</span>
<a href="#l11.504"></a><span id="l11.504">                 // here, we want to modify the url we use in the future.</span>
<a href="#l11.505"></a><span id="l11.505">                 let nIPS = Components.interfaces.nsIPromptService;</span>
<a href="#l11.506"></a><span id="l11.506"> </span>
<a href="#l11.507"></a><span id="l11.507" class="difflineminus">-                let promptTitle = cal.calGetString(&quot;calendar&quot;, &quot;caldavRedirectTitle&quot;, [thisCalendar.name]);</span>
<a href="#l11.508"></a><span id="l11.508" class="difflineminus">-                let promptText = cal.calGetString(&quot;calendar&quot;, &quot;caldavRedirectText&quot;, [thisCalendar.name]) +</span>
<a href="#l11.509"></a><span id="l11.509" class="difflineplus">+                let promptTitle = cal.calGetString(&quot;calendar&quot;, &quot;caldavRedirectTitle&quot;, [self.name]);</span>
<a href="#l11.510"></a><span id="l11.510" class="difflineplus">+                let promptText = cal.calGetString(&quot;calendar&quot;, &quot;caldavRedirectText&quot;, [self.name]) +</span>
<a href="#l11.511"></a><span id="l11.511">                                  &quot;\n\n&quot; + request.URI.spec;</span>
<a href="#l11.512"></a><span id="l11.512">                 let button1Title = cal.calGetString(&quot;calendar&quot;, &quot;caldavRedirectDisableCalendar&quot;);</span>
<a href="#l11.513"></a><span id="l11.513">                 let flags = (nIPS.BUTTON_TITLE_YES * nIPS.BUTTON_POS_0) +</span>
<a href="#l11.514"></a><span id="l11.514">                             (nIPS.BUTTON_TITLE_IS_STRING * nIPS.BUTTON_POS_1);</span>
<a href="#l11.515"></a><span id="l11.515"> </span>
<a href="#l11.516"></a><span id="l11.516">                 let res = Services.prompt.confirmEx(cal.getCalendarWindow(),</span>
<a href="#l11.517"></a><span id="l11.517">                                                     promptTitle, promptText,</span>
<a href="#l11.518"></a><span id="l11.518">                                                     flags, null, button1Title,</span>
<a href="#l11.519"></a><span id="l11.519">                                                     null, null, {});</span>
<a href="#l11.520"></a><span id="l11.520"> </span>
<a href="#l11.521"></a><span id="l11.521">                 if (res == 0) { // YES</span>
<a href="#l11.522"></a><span id="l11.522">                     let newUri = request.URI;</span>
<a href="#l11.523"></a><span id="l11.523">                     cal.LOG(&quot;CalDAV: Migrating url due to redirect: &quot; +</span>
<a href="#l11.524"></a><span id="l11.524" class="difflineminus">-                            thisCalendar.mUri.spec + &quot; -&gt; &quot; + newUri.spec);</span>
<a href="#l11.525"></a><span id="l11.525" class="difflineminus">-                    thisCalendar.mUri = newUri;</span>
<a href="#l11.526"></a><span id="l11.526" class="difflineminus">-                    thisCalendar.setProperty(&quot;uri&quot;, newUri.spec);</span>
<a href="#l11.527"></a><span id="l11.527" class="difflineplus">+                            self.mUri.spec + &quot; -&gt; &quot; + newUri.spec);</span>
<a href="#l11.528"></a><span id="l11.528" class="difflineplus">+                    self.mUri = newUri;</span>
<a href="#l11.529"></a><span id="l11.529" class="difflineplus">+                    self.setProperty(&quot;uri&quot;, newUri.spec);</span>
<a href="#l11.530"></a><span id="l11.530">                 } else if (res == 1) { // DISABLE CALENDAR</span>
<a href="#l11.531"></a><span id="l11.531" class="difflineminus">-                    thisCalendar.setProperty(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.532"></a><span id="l11.532" class="difflineminus">-                    thisCalendar.completeCheckServerInfo(aChangeLogListener, Components.results.NS_ERROR_ABORT);</span>
<a href="#l11.533"></a><span id="l11.533" class="difflineplus">+                    self.setProperty(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.534"></a><span id="l11.534" class="difflineplus">+                    self.completeCheckServerInfo(aChangeLogListener, Components.results.NS_ERROR_ABORT);</span>
<a href="#l11.535"></a><span id="l11.535">                     return;</span>
<a href="#l11.536"></a><span id="l11.536">                 }</span>
<a href="#l11.537"></a><span id="l11.537">             }</span>
<a href="#l11.538"></a><span id="l11.538"> </span>
<a href="#l11.539"></a><span id="l11.539">             let responseStatusCategory = Math.floor(request.responseStatus / 100);</span>
<a href="#l11.540"></a><span id="l11.540"> </span>
<a href="#l11.541"></a><span id="l11.541">             // 4xx codes, which is either an authentication failure or</span>
<a href="#l11.542"></a><span id="l11.542">             // something like method not allowed. This is a failure worth</span>
<a href="#l11.543"></a><span id="l11.543">             // disabling the calendar.</span>
<a href="#l11.544"></a><span id="l11.544">             if (responseStatusCategory == 4) {</span>
<a href="#l11.545"></a><span id="l11.545" class="difflineminus">-                thisCalendar.setProperty(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.546"></a><span id="l11.546" class="difflineminus">-                thisCalendar.setProperty(&quot;auto-enabled&quot;, &quot;true&quot;);</span>
<a href="#l11.547"></a><span id="l11.547" class="difflineminus">-                thisCalendar.completeCheckServerInfo(aChangeLogListener, Components.results.NS_ERROR_ABORT);</span>
<a href="#l11.548"></a><span id="l11.548" class="difflineplus">+                self.setProperty(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.549"></a><span id="l11.549" class="difflineplus">+                self.setProperty(&quot;auto-enabled&quot;, &quot;true&quot;);</span>
<a href="#l11.550"></a><span id="l11.550" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener, Components.results.NS_ERROR_ABORT);</span>
<a href="#l11.551"></a><span id="l11.551">                 return;</span>
<a href="#l11.552"></a><span id="l11.552">             }</span>
<a href="#l11.553"></a><span id="l11.553"> </span>
<a href="#l11.554"></a><span id="l11.554">             // 5xx codes, a server error. This could be a temporary failure,</span>
<a href="#l11.555"></a><span id="l11.555">             // i.e a backend server being disabled.</span>
<a href="#l11.556"></a><span id="l11.556">             if (responseStatusCategory == 5) {</span>
<a href="#l11.557"></a><span id="l11.557">                 cal.LOG(&quot;CalDAV: Server not available &quot; + request.responseStatus +</span>
<a href="#l11.558"></a><span id="l11.558" class="difflineminus">-                        &quot;, abort sync for calendar &quot; + thisCalendar.name);</span>
<a href="#l11.559"></a><span id="l11.559" class="difflineminus">-                thisCalendar.completeCheckServerInfo(aChangeLogListener, Components.results.NS_ERROR_ABORT);</span>
<a href="#l11.560"></a><span id="l11.560" class="difflineplus">+                        &quot;, abort sync for calendar &quot; + self.name);</span>
<a href="#l11.561"></a><span id="l11.561" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener, Components.results.NS_ERROR_ABORT);</span>
<a href="#l11.562"></a><span id="l11.562">                 return;</span>
<a href="#l11.563"></a><span id="l11.563">             }</span>
<a href="#l11.564"></a><span id="l11.564"> </span>
<a href="#l11.565"></a><span id="l11.565">             let wwwauth;</span>
<a href="#l11.566"></a><span id="l11.566">             try {</span>
<a href="#l11.567"></a><span id="l11.567">                 wwwauth = request.getRequestHeader(&quot;Authorization&quot;);</span>
<a href="#l11.568"></a><span id="l11.568" class="difflineminus">-                thisCalendar.mAuthScheme = wwwauth.split(&quot; &quot;)[0];</span>
<a href="#l11.569"></a><span id="l11.569" class="difflineplus">+                self.mAuthScheme = wwwauth.split(&quot; &quot;)[0];</span>
<a href="#l11.570"></a><span id="l11.570">             } catch (ex) {</span>
<a href="#l11.571"></a><span id="l11.571">                 // no auth header could mean a public calendar</span>
<a href="#l11.572"></a><span id="l11.572" class="difflineminus">-                thisCalendar.mAuthScheme = &quot;none&quot;;</span>
<a href="#l11.573"></a><span id="l11.573" class="difflineplus">+                self.mAuthScheme = &quot;none&quot;;</span>
<a href="#l11.574"></a><span id="l11.574">             }</span>
<a href="#l11.575"></a><span id="l11.575"> </span>
<a href="#l11.576"></a><span id="l11.576" class="difflineminus">-            if (thisCalendar.mUriParams) {</span>
<a href="#l11.577"></a><span id="l11.577" class="difflineminus">-                thisCalendar.mAuthScheme = &quot;Ticket&quot;;</span>
<a href="#l11.578"></a><span id="l11.578" class="difflineplus">+            if (self.mUriParams) {</span>
<a href="#l11.579"></a><span id="l11.579" class="difflineplus">+                self.mAuthScheme = &quot;Ticket&quot;;</span>
<a href="#l11.580"></a><span id="l11.580">             }</span>
<a href="#l11.581"></a><span id="l11.581" class="difflineminus">-            cal.LOG(&quot;CalDAV: Authentication scheme for &quot; + thisCalendar.name +</span>
<a href="#l11.582"></a><span id="l11.582" class="difflineminus">-                    &quot; is &quot; + thisCalendar.mAuthScheme);</span>
<a href="#l11.583"></a><span id="l11.583" class="difflineplus">+            cal.LOG(&quot;CalDAV: Authentication scheme for &quot; + self.name +</span>
<a href="#l11.584"></a><span id="l11.584" class="difflineplus">+                    &quot; is &quot; + self.mAuthScheme);</span>
<a href="#l11.585"></a><span id="l11.585">             // we only really need the authrealm for Digest auth</span>
<a href="#l11.586"></a><span id="l11.586">             // since only Digest is going to time out on us</span>
<a href="#l11.587"></a><span id="l11.587" class="difflineminus">-            if (thisCalendar.mAuthScheme == &quot;Digest&quot;) {</span>
<a href="#l11.588"></a><span id="l11.588" class="difflineplus">+            if (self.mAuthScheme == &quot;Digest&quot;) {</span>
<a href="#l11.589"></a><span id="l11.589">                 let realmChop = wwwauth.split(&quot;realm=\&quot;&quot;)[1];</span>
<a href="#l11.590"></a><span id="l11.590" class="difflineminus">-                thisCalendar.mAuthRealm = realmChop.split(&quot;\&quot;, &quot;)[0];</span>
<a href="#l11.591"></a><span id="l11.591" class="difflineminus">-                cal.LOG(&quot;CalDAV: realm &quot; + thisCalendar.mAuthRealm);</span>
<a href="#l11.592"></a><span id="l11.592" class="difflineplus">+                self.mAuthRealm = realmChop.split(&quot;\&quot;, &quot;)[0];</span>
<a href="#l11.593"></a><span id="l11.593" class="difflineplus">+                cal.LOG(&quot;CalDAV: realm &quot; + self.mAuthRealm);</span>
<a href="#l11.594"></a><span id="l11.594">             }</span>
<a href="#l11.595"></a><span id="l11.595"> </span>
<a href="#l11.596"></a><span id="l11.596">             let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l11.597"></a><span id="l11.597">             if (!str || request.responseStatus == 404) {</span>
<a href="#l11.598"></a><span id="l11.598">                 // No response, or the calendar no longer exists.</span>
<a href="#l11.599"></a><span id="l11.599">                 cal.LOG(&quot;CalDAV: Failed to determine resource type for&quot; +</span>
<a href="#l11.600"></a><span id="l11.600" class="difflineminus">-                        thisCalendar.name);</span>
<a href="#l11.601"></a><span id="l11.601" class="difflineminus">-                thisCalendar.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l11.602"></a><span id="l11.602" class="difflineminus">-                                                     Components.interfaces.calIErrors.DAV_NOT_DAV);</span>
<a href="#l11.603"></a><span id="l11.603" class="difflineplus">+                        self.name);</span>
<a href="#l11.604"></a><span id="l11.604" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l11.605"></a><span id="l11.605" class="difflineplus">+                                             Components.interfaces.calIErrors.DAV_NOT_DAV);</span>
<a href="#l11.606"></a><span id="l11.606">                 return;</span>
<a href="#l11.607"></a><span id="l11.607" class="difflineminus">-            } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l11.608"></a><span id="l11.608" class="difflineplus">+            } else if (self.verboseLogging()) {</span>
<a href="#l11.609"></a><span id="l11.609">                 cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l11.610"></a><span id="l11.610">             }</span>
<a href="#l11.611"></a><span id="l11.611"> </span>
<a href="#l11.612"></a><span id="l11.612">             let multistatus;</span>
<a href="#l11.613"></a><span id="l11.613">             try {</span>
<a href="#l11.614"></a><span id="l11.614">                 multistatus = cal.xml.parseString(str);</span>
<a href="#l11.615"></a><span id="l11.615">             } catch (ex) {</span>
<a href="#l11.616"></a><span id="l11.616">                 cal.LOG(&quot;CalDAV: Failed to determine resource type for&quot; +</span>
<a href="#l11.617"></a><span id="l11.617" class="difflineminus">-                        thisCalendar.name + &quot;: &quot; + ex);</span>
<a href="#l11.618"></a><span id="l11.618" class="difflineminus">-                thisCalendar.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l11.619"></a><span id="l11.619" class="difflineminus">-                                                     Components.interfaces.calIErrors.DAV_NOT_DAV);</span>
<a href="#l11.620"></a><span id="l11.620" class="difflineplus">+                        self.name + &quot;: &quot; + ex);</span>
<a href="#l11.621"></a><span id="l11.621" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l11.622"></a><span id="l11.622" class="difflineplus">+                                             Components.interfaces.calIErrors.DAV_NOT_DAV);</span>
<a href="#l11.623"></a><span id="l11.623">                 return;</span>
<a href="#l11.624"></a><span id="l11.624">             }</span>
<a href="#l11.625"></a><span id="l11.625"> </span>
<a href="#l11.626"></a><span id="l11.626">             // check for webdav-sync capability</span>
<a href="#l11.627"></a><span id="l11.627">             // http://tools.ietf.org/html/draft-daboo-webdav-sync</span>
<a href="#l11.628"></a><span id="l11.628">             if (caldavXPath(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop&quot; +</span>
<a href="#l11.629"></a><span id="l11.629">                                  &quot;/D:supported-report-set/D:supported-report/D:report/D:sync-collection&quot;)) {</span>
<a href="#l11.630"></a><span id="l11.630">                 cal.LOG(&quot;CalDAV: Collection has webdav sync support&quot;);</span>
<a href="#l11.631"></a><span id="l11.631" class="difflineminus">-                thisCalendar.mHasWebdavSyncSupport = true;</span>
<a href="#l11.632"></a><span id="l11.632" class="difflineplus">+                self.mHasWebdavSyncSupport = true;</span>
<a href="#l11.633"></a><span id="l11.633">             }</span>
<a href="#l11.634"></a><span id="l11.634"> </span>
<a href="#l11.635"></a><span id="l11.635">             // check for server-side ctag support only if webdav sync is not available</span>
<a href="#l11.636"></a><span id="l11.636">             let ctag = caldavXPathFirst(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop/CS:getctag/text()&quot;);</span>
<a href="#l11.637"></a><span id="l11.637" class="difflineminus">-            if (!thisCalendar.mHasWebdavSyncSupport &amp;&amp; ctag) {</span>
<a href="#l11.638"></a><span id="l11.638" class="difflineplus">+            if (!self.mHasWebdavSyncSupport &amp;&amp; ctag) {</span>
<a href="#l11.639"></a><span id="l11.639">                 // We compare the stored ctag with the one we just got, if</span>
<a href="#l11.640"></a><span id="l11.640">                 // they don't match, we update the items in safeRefresh.</span>
<a href="#l11.641"></a><span id="l11.641" class="difflineminus">-                if (ctag == thisCalendar.mCtag) {</span>
<a href="#l11.642"></a><span id="l11.642" class="difflineminus">-                    thisCalendar.mFirstRefreshDone = true;</span>
<a href="#l11.643"></a><span id="l11.643" class="difflineplus">+                if (ctag == self.mCtag) {</span>
<a href="#l11.644"></a><span id="l11.644" class="difflineplus">+                    self.mFirstRefreshDone = true;</span>
<a href="#l11.645"></a><span id="l11.645">                 }</span>
<a href="#l11.646"></a><span id="l11.646"> </span>
<a href="#l11.647"></a><span id="l11.647" class="difflineminus">-                thisCalendar.mProposedCtag = ctag;</span>
<a href="#l11.648"></a><span id="l11.648" class="difflineminus">-                if (thisCalendar.verboseLogging()) {</span>
<a href="#l11.649"></a><span id="l11.649" class="difflineplus">+                self.mProposedCtag = ctag;</span>
<a href="#l11.650"></a><span id="l11.650" class="difflineplus">+                if (self.verboseLogging()) {</span>
<a href="#l11.651"></a><span id="l11.651">                     cal.LOG(&quot;CalDAV: initial ctag &quot; + ctag + &quot; for calendar &quot; +</span>
<a href="#l11.652"></a><span id="l11.652" class="difflineminus">-                            thisCalendar.name);</span>
<a href="#l11.653"></a><span id="l11.653" class="difflineplus">+                            self.name);</span>
<a href="#l11.654"></a><span id="l11.654">                 }</span>
<a href="#l11.655"></a><span id="l11.655">             }</span>
<a href="#l11.656"></a><span id="l11.656"> </span>
<a href="#l11.657"></a><span id="l11.657"> </span>
<a href="#l11.658"></a><span id="l11.658">             // Use supported-calendar-component-set if the server supports it; some do not</span>
<a href="#l11.659"></a><span id="l11.659">             // Accept name attribute from all namespaces to workaround Cosmo bug see bug 605378 comment 6</span>
<a href="#l11.660"></a><span id="l11.660">             let supportedComponents = caldavXPath(multistatus,</span>
<a href="#l11.661"></a><span id="l11.661">                 &quot;/D:multistatus/D:response/D:propstat/D:prop/C:supported-calendar-component-set/C:comp/@*[local-name()='name']&quot;);</span>
<a href="#l11.662"></a><span id="l11.662">             if (supportedComponents &amp;&amp; supportedComponents.length) {</span>
<a href="#l11.663"></a><span id="l11.663" class="difflineminus">-                thisCalendar.mSupportedItemTypes = [];</span>
<a href="#l11.664"></a><span id="l11.664" class="difflineplus">+                self.mSupportedItemTypes = [];</span>
<a href="#l11.665"></a><span id="l11.665">                 for (compName of supportedComponents) {</span>
<a href="#l11.666"></a><span id="l11.666" class="difflineminus">-                    if (thisCalendar.mGenerallySupportedItemTypes.includes(compName)) {</span>
<a href="#l11.667"></a><span id="l11.667" class="difflineminus">-                        thisCalendar.mSupportedItemTypes.push(compName);</span>
<a href="#l11.668"></a><span id="l11.668" class="difflineplus">+                    if (self.mGenerallySupportedItemTypes.includes(compName)) {</span>
<a href="#l11.669"></a><span id="l11.669" class="difflineplus">+                        self.mSupportedItemTypes.push(compName);</span>
<a href="#l11.670"></a><span id="l11.670">                     }</span>
<a href="#l11.671"></a><span id="l11.671">                 }</span>
<a href="#l11.672"></a><span id="l11.672" class="difflineminus">-                cal.LOG(&quot;Adding supported items: &quot; + thisCalendar.mSupportedItemTypes.join(&quot;,&quot;) + &quot; for calendar: &quot; + thisCalendar.name);</span>
<a href="#l11.673"></a><span id="l11.673" class="difflineplus">+                cal.LOG(&quot;Adding supported items: &quot; + self.mSupportedItemTypes.join(&quot;,&quot;) + &quot; for calendar: &quot; + self.name);</span>
<a href="#l11.674"></a><span id="l11.674">             }</span>
<a href="#l11.675"></a><span id="l11.675"> </span>
<a href="#l11.676"></a><span id="l11.676">             // check if owner is specified; might save some work</span>
<a href="#l11.677"></a><span id="l11.677">             let owner = caldavXPathFirst(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop/D:owner/D:href/text()&quot;);</span>
<a href="#l11.678"></a><span id="l11.678">             let cuprincipal = caldavXPathFirst(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop/D:current-user-principal/D:href/text()&quot;);</span>
<a href="#l11.679"></a><span id="l11.679">             if (cuprincipal) {</span>
<a href="#l11.680"></a><span id="l11.680" class="difflineminus">-                thisCalendar.mPrincipalUrl = cuprincipal;</span>
<a href="#l11.681"></a><span id="l11.681" class="difflineminus">-                cal.LOG(&quot;CalDAV: Found principal url from DAV:current-user-principal &quot; + thisCalendar.mPrincipalUrl);</span>
<a href="#l11.682"></a><span id="l11.682" class="difflineplus">+                self.mPrincipalUrl = cuprincipal;</span>
<a href="#l11.683"></a><span id="l11.683" class="difflineplus">+                cal.LOG(&quot;CalDAV: Found principal url from DAV:current-user-principal &quot; + self.mPrincipalUrl);</span>
<a href="#l11.684"></a><span id="l11.684">             } else if (owner) {</span>
<a href="#l11.685"></a><span id="l11.685" class="difflineminus">-                thisCalendar.mPrincipalUrl = owner;</span>
<a href="#l11.686"></a><span id="l11.686" class="difflineminus">-                cal.LOG(&quot;CalDAV: Found principal url from DAV:owner &quot; + thisCalendar.mPrincipalUrl);</span>
<a href="#l11.687"></a><span id="l11.687" class="difflineplus">+                self.mPrincipalUrl = owner;</span>
<a href="#l11.688"></a><span id="l11.688" class="difflineplus">+                cal.LOG(&quot;CalDAV: Found principal url from DAV:owner &quot; + self.mPrincipalUrl);</span>
<a href="#l11.689"></a><span id="l11.689">             }</span>
<a href="#l11.690"></a><span id="l11.690"> </span>
<a href="#l11.691"></a><span id="l11.691">             let resourceTypeXml = caldavXPath(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop/D:resourcetype&quot;);</span>
<a href="#l11.692"></a><span id="l11.692">             if (!resourceTypeXml) {</span>
<a href="#l11.693"></a><span id="l11.693">                 resourceType = kDavResourceTypeNone;</span>
<a href="#l11.694"></a><span id="l11.694">             } else if (caldavXPath(resourceTypeXml[0], &quot;C:calendar&quot;)) {</span>
<a href="#l11.695"></a><span id="l11.695">                 resourceType = kDavResourceTypeCalendar;</span>
<a href="#l11.696"></a><span id="l11.696">             } else if (caldavXPath(resourceTypeXml[0], &quot;D:collection&quot;)) {</span>
<a href="#l11.697"></a><span id="l11.697">                 resourceType = kDavResourceTypeCollection;</span>
<a href="#l11.698"></a><span id="l11.698">             }</span>
<a href="#l11.699"></a><span id="l11.699"> </span>
<a href="#l11.700"></a><span id="l11.700">             if (resourceType == kDavResourceTypeNone) {</span>
<a href="#l11.701"></a><span id="l11.701" class="difflineminus">-                cal.LOG(&quot;CalDAV: No resource type received, &quot; + thisCalendar.name + &quot; doesn't seem to point to a DAV resource&quot;);</span>
<a href="#l11.702"></a><span id="l11.702" class="difflineminus">-                thisCalendar.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l11.703"></a><span id="l11.703" class="difflineminus">-                                                     Components.interfaces.calIErrors.DAV_NOT_DAV);</span>
<a href="#l11.704"></a><span id="l11.704" class="difflineplus">+                cal.LOG(&quot;CalDAV: No resource type received, &quot; + self.name + &quot; doesn't seem to point to a DAV resource&quot;);</span>
<a href="#l11.705"></a><span id="l11.705" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l11.706"></a><span id="l11.706" class="difflineplus">+                                             Components.interfaces.calIErrors.DAV_NOT_DAV);</span>
<a href="#l11.707"></a><span id="l11.707">                 return;</span>
<a href="#l11.708"></a><span id="l11.708">             }</span>
<a href="#l11.709"></a><span id="l11.709"> </span>
<a href="#l11.710"></a><span id="l11.710">             if (resourceType == kDavResourceTypeCollection) {</span>
<a href="#l11.711"></a><span id="l11.711" class="difflineminus">-                cal.LOG(&quot;CalDAV: &quot; + thisCalendar.name + &quot; points to a DAV resource, but not a CalDAV calendar&quot;);</span>
<a href="#l11.712"></a><span id="l11.712" class="difflineminus">-                thisCalendar.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l11.713"></a><span id="l11.713" class="difflineminus">-                                                     Components.interfaces.calIErrors.DAV_DAV_NOT_CALDAV);</span>
<a href="#l11.714"></a><span id="l11.714" class="difflineplus">+                cal.LOG(&quot;CalDAV: &quot; + self.name + &quot; points to a DAV resource, but not a CalDAV calendar&quot;);</span>
<a href="#l11.715"></a><span id="l11.715" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l11.716"></a><span id="l11.716" class="difflineplus">+                                             Components.interfaces.calIErrors.DAV_DAV_NOT_CALDAV);</span>
<a href="#l11.717"></a><span id="l11.717">                 return;</span>
<a href="#l11.718"></a><span id="l11.718">             }</span>
<a href="#l11.719"></a><span id="l11.719"> </span>
<a href="#l11.720"></a><span id="l11.720">             if (resourceType == kDavResourceTypeCalendar) {</span>
<a href="#l11.721"></a><span id="l11.721">                 // If this calendar was previously offline we want to recover</span>
<a href="#l11.722"></a><span id="l11.722" class="difflineminus">-                if (thisCalendar.mDisabled) {</span>
<a href="#l11.723"></a><span id="l11.723" class="difflineminus">-                    thisCalendar.mDisabled = false;</span>
<a href="#l11.724"></a><span id="l11.724" class="difflineminus">-                    thisCalendar.mReadOnly = false;</span>
<a href="#l11.725"></a><span id="l11.725" class="difflineplus">+                if (self.mDisabled) {</span>
<a href="#l11.726"></a><span id="l11.726" class="difflineplus">+                    self.mDisabled = false;</span>
<a href="#l11.727"></a><span id="l11.727" class="difflineplus">+                    self.mReadOnly = false;</span>
<a href="#l11.728"></a><span id="l11.728">                 }</span>
<a href="#l11.729"></a><span id="l11.729" class="difflineminus">-                thisCalendar.setCalHomeSet(true);</span>
<a href="#l11.730"></a><span id="l11.730" class="difflineminus">-                thisCalendar.checkServerCaps(aChangeLogListener);</span>
<a href="#l11.731"></a><span id="l11.731" class="difflineplus">+                self.setCalHomeSet(true);</span>
<a href="#l11.732"></a><span id="l11.732" class="difflineplus">+                self.checkServerCaps(aChangeLogListener);</span>
<a href="#l11.733"></a><span id="l11.733">                 return;</span>
<a href="#l11.734"></a><span id="l11.734">             }</span>
<a href="#l11.735"></a><span id="l11.735"> </span>
<a href="#l11.736"></a><span id="l11.736">             // If we get here something must have gone wrong. Abort with a</span>
<a href="#l11.737"></a><span id="l11.737">             // general error to avoid an endless loop.</span>
<a href="#l11.738"></a><span id="l11.738" class="difflineminus">-            thisCalendar.completeCheckServerInfo(aChangeLogListener, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l11.739"></a><span id="l11.739" class="difflineplus">+            self.completeCheckServerInfo(aChangeLogListener, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l11.740"></a><span id="l11.740">         };</span>
<a href="#l11.741"></a><span id="l11.741"> </span>
<a href="#l11.742"></a><span id="l11.742">         this.sendHttpRequest(this.makeUri(), queryXml, MIME_TEXT_XML, null, (channel) =&gt; {</span>
<a href="#l11.743"></a><span id="l11.743">             channel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l11.744"></a><span id="l11.744">             channel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l11.745"></a><span id="l11.745">             return streamListener;</span>
<a href="#l11.746"></a><span id="l11.746">         }, () =&gt; {</span>
<a href="#l11.747"></a><span id="l11.747">             notifyListener(Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l11.748"></a><span id="l11.748" class="difflineat">@@ -1921,93 +1920,93 @@ calDavCalendar.prototype = {</span>
<a href="#l11.749"></a><span id="l11.749">      * checkDavResourceType</span>
<a href="#l11.750"></a><span id="l11.750">      * checkServerCaps                              * You are here</span>
<a href="#l11.751"></a><span id="l11.751">      * findPrincipalNS</span>
<a href="#l11.752"></a><span id="l11.752">      * checkPrincipalsNameSpace</span>
<a href="#l11.753"></a><span id="l11.753">      * completeCheckServerInfo</span>
<a href="#l11.754"></a><span id="l11.754">      */</span>
<a href="#l11.755"></a><span id="l11.755">     checkServerCaps: function caldav_checkServerCaps(aChangeLogListener, calHomeSetUrlRetry) {</span>
<a href="#l11.756"></a><span id="l11.756">         let homeSet = this.makeUri(null, this.mCalHomeSet);</span>
<a href="#l11.757"></a><span id="l11.757" class="difflineminus">-        let thisCalendar = this;</span>
<a href="#l11.758"></a><span id="l11.758" class="difflineplus">+        let self = this;</span>
<a href="#l11.759"></a><span id="l11.759"> </span>
<a href="#l11.760"></a><span id="l11.760">         if (this.verboseLogging()) {</span>
<a href="#l11.761"></a><span id="l11.761">             cal.LOG(&quot;CalDAV: send: OPTIONS &quot; + homeSet.spec);</span>
<a href="#l11.762"></a><span id="l11.762">         }</span>
<a href="#l11.763"></a><span id="l11.763"> </span>
<a href="#l11.764"></a><span id="l11.764">         let streamListener = {};</span>
<a href="#l11.765"></a><span id="l11.765">         streamListener.onStreamComplete =</span>
<a href="#l11.766"></a><span id="l11.766">             function checkServerCaps_oSC(aLoader, aContext, aStatus,</span>
<a href="#l11.767"></a><span id="l11.767">                                          aResultLength, aResult) {</span>
<a href="#l11.768"></a><span id="l11.768">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l11.769"></a><span id="l11.769">             if (request.responseStatus != 200) {</span>
<a href="#l11.770"></a><span id="l11.770">                 if (!calHomeSetUrlRetry &amp;&amp; request.responseStatus == 404) {</span>
<a href="#l11.771"></a><span id="l11.771">                     // try again with calendar URL, see https://bugzilla.mozilla.org/show_bug.cgi?id=588799</span>
<a href="#l11.772"></a><span id="l11.772">                     cal.LOG(&quot;CalDAV: Calendar homeset was not found at parent url of calendar URL&quot; +</span>
<a href="#l11.773"></a><span id="l11.773" class="difflineminus">-                            &quot; while querying options &quot; + thisCalendar.name + &quot;, will try calendar URL itself now&quot;);</span>
<a href="#l11.774"></a><span id="l11.774" class="difflineminus">-                    thisCalendar.setCalHomeSet(false);</span>
<a href="#l11.775"></a><span id="l11.775" class="difflineminus">-                    thisCalendar.checkServerCaps(aChangeLogListener, true);</span>
<a href="#l11.776"></a><span id="l11.776" class="difflineplus">+                            &quot; while querying options &quot; + self.name + &quot;, will try calendar URL itself now&quot;);</span>
<a href="#l11.777"></a><span id="l11.777" class="difflineplus">+                    self.setCalHomeSet(false);</span>
<a href="#l11.778"></a><span id="l11.778" class="difflineplus">+                    self.checkServerCaps(aChangeLogListener, true);</span>
<a href="#l11.779"></a><span id="l11.779">                 } else {</span>
<a href="#l11.780"></a><span id="l11.780">                     cal.LOG(&quot;CalDAV: Unexpected status &quot; + request.responseStatus +</span>
<a href="#l11.781"></a><span id="l11.781" class="difflineminus">-                            &quot; while querying options &quot; + thisCalendar.name);</span>
<a href="#l11.782"></a><span id="l11.782" class="difflineminus">-                    thisCalendar.completeCheckServerInfo(aChangeLogListener, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l11.783"></a><span id="l11.783" class="difflineplus">+                            &quot; while querying options &quot; + self.name);</span>
<a href="#l11.784"></a><span id="l11.784" class="difflineplus">+                    self.completeCheckServerInfo(aChangeLogListener, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l11.785"></a><span id="l11.785">                 }</span>
<a href="#l11.786"></a><span id="l11.786"> </span>
<a href="#l11.787"></a><span id="l11.787">                 // No further processing needed, we have called subsequent (async) functions above.</span>
<a href="#l11.788"></a><span id="l11.788">                 return;</span>
<a href="#l11.789"></a><span id="l11.789">             }</span>
<a href="#l11.790"></a><span id="l11.790"> </span>
<a href="#l11.791"></a><span id="l11.791">             let dav = null;</span>
<a href="#l11.792"></a><span id="l11.792">             try {</span>
<a href="#l11.793"></a><span id="l11.793">                 dav = request.getResponseHeader(&quot;DAV&quot;);</span>
<a href="#l11.794"></a><span id="l11.794" class="difflineminus">-                if (thisCalendar.verboseLogging()) {</span>
<a href="#l11.795"></a><span id="l11.795" class="difflineplus">+                if (self.verboseLogging()) {</span>
<a href="#l11.796"></a><span id="l11.796">                     cal.LOG(&quot;CalDAV: DAV header: &quot; + dav);</span>
<a href="#l11.797"></a><span id="l11.797">                 }</span>
<a href="#l11.798"></a><span id="l11.798">             } catch (ex) {</span>
<a href="#l11.799"></a><span id="l11.799" class="difflineminus">-                cal.LOG(&quot;CalDAV: Error getting DAV header for &quot; + thisCalendar.name +</span>
<a href="#l11.800"></a><span id="l11.800" class="difflineplus">+                cal.LOG(&quot;CalDAV: Error getting DAV header for &quot; + self.name +</span>
<a href="#l11.801"></a><span id="l11.801">                         &quot;, status &quot; + request.responseStatus +</span>
<a href="#l11.802"></a><span id="l11.802">                         &quot;, data: &quot; + cal.convertByteArray(aResult, aResultLength));</span>
<a href="#l11.803"></a><span id="l11.803">             }</span>
<a href="#l11.804"></a><span id="l11.804">             // Google does not yet support OPTIONS but does support scheduling</span>
<a href="#l11.805"></a><span id="l11.805">             // so we'll spoof the DAV header until Google gets fixed</span>
<a href="#l11.806"></a><span id="l11.806" class="difflineminus">-            if (thisCalendar.calendarUri.host == &quot;www.google.com&quot;) {</span>
<a href="#l11.807"></a><span id="l11.807" class="difflineplus">+            if (self.calendarUri.host == &quot;www.google.com&quot;) {</span>
<a href="#l11.808"></a><span id="l11.808">                 dav = &quot;calendar-schedule&quot;;</span>
<a href="#l11.809"></a><span id="l11.809">                 // Google also reports an inbox URL distinct from the calendar</span>
<a href="#l11.810"></a><span id="l11.810">                 // URL but a) doesn't use it and b) 405s on etag queries to it</span>
<a href="#l11.811"></a><span id="l11.811" class="difflineminus">-                thisCalendar.mShouldPollInbox = false;</span>
<a href="#l11.812"></a><span id="l11.812" class="difflineplus">+                self.mShouldPollInbox = false;</span>
<a href="#l11.813"></a><span id="l11.813">             }</span>
<a href="#l11.814"></a><span id="l11.814">             if (dav &amp;&amp; dav.includes(&quot;calendar-auto-schedule&quot;)) {</span>
<a href="#l11.815"></a><span id="l11.815" class="difflineminus">-                if (thisCalendar.verboseLogging()) {</span>
<a href="#l11.816"></a><span id="l11.816" class="difflineminus">-                    cal.LOG(&quot;CalDAV: Calendar &quot; + thisCalendar.name +</span>
<a href="#l11.817"></a><span id="l11.817" class="difflineplus">+                if (self.verboseLogging()) {</span>
<a href="#l11.818"></a><span id="l11.818" class="difflineplus">+                    cal.LOG(&quot;CalDAV: Calendar &quot; + self.name +</span>
<a href="#l11.819"></a><span id="l11.819">                             &quot; supports calendar-auto-schedule&quot;);</span>
<a href="#l11.820"></a><span id="l11.820">                 }</span>
<a href="#l11.821"></a><span id="l11.821" class="difflineminus">-                thisCalendar.hasAutoScheduling = true;</span>
<a href="#l11.822"></a><span id="l11.822" class="difflineplus">+                self.hasAutoScheduling = true;</span>
<a href="#l11.823"></a><span id="l11.823">                 // leave outbound inbox/outbox scheduling off</span>
<a href="#l11.824"></a><span id="l11.824">             } else if (dav &amp;&amp; dav.includes(&quot;calendar-schedule&quot;)) {</span>
<a href="#l11.825"></a><span id="l11.825" class="difflineminus">-                if (thisCalendar.verboseLogging()) {</span>
<a href="#l11.826"></a><span id="l11.826" class="difflineminus">-                    cal.LOG(&quot;CalDAV: Calendar &quot; + thisCalendar.name +</span>
<a href="#l11.827"></a><span id="l11.827" class="difflineplus">+                if (self.verboseLogging()) {</span>
<a href="#l11.828"></a><span id="l11.828" class="difflineplus">+                    cal.LOG(&quot;CalDAV: Calendar &quot; + self.name +</span>
<a href="#l11.829"></a><span id="l11.829">                             &quot; generally supports calendar-schedule&quot;);</span>
<a href="#l11.830"></a><span id="l11.830">                 }</span>
<a href="#l11.831"></a><span id="l11.831" class="difflineminus">-                thisCalendar.hasScheduling = true;</span>
<a href="#l11.832"></a><span id="l11.832" class="difflineplus">+                self.hasScheduling = true;</span>
<a href="#l11.833"></a><span id="l11.833">             }</span>
<a href="#l11.834"></a><span id="l11.834"> </span>
<a href="#l11.835"></a><span id="l11.835" class="difflineminus">-            if (thisCalendar.hasAutoScheduling || (dav &amp;&amp; dav.includes(&quot;calendar-schedule&quot;))) {</span>
<a href="#l11.836"></a><span id="l11.836" class="difflineplus">+            if (self.hasAutoScheduling || (dav &amp;&amp; dav.includes(&quot;calendar-schedule&quot;))) {</span>
<a href="#l11.837"></a><span id="l11.837">                 // XXX - we really shouldn't register with the fb service</span>
<a href="#l11.838"></a><span id="l11.838">                 // if another calendar with the same principal-URL has already</span>
<a href="#l11.839"></a><span id="l11.839">                 // done so. We also shouldn't register with the fb service if we</span>
<a href="#l11.840"></a><span id="l11.840">                 // don't have an outbox.</span>
<a href="#l11.841"></a><span id="l11.841" class="difflineminus">-                if (!thisCalendar.hasFreeBusy) {</span>
<a href="#l11.842"></a><span id="l11.842" class="difflineplus">+                if (!self.hasFreeBusy) {</span>
<a href="#l11.843"></a><span id="l11.843">                     // This may have already been set by fetchCachedMetaData,</span>
<a href="#l11.844"></a><span id="l11.844">                     // we only want to add the freebusy provider once.</span>
<a href="#l11.845"></a><span id="l11.845" class="difflineminus">-                    thisCalendar.hasFreeBusy = true;</span>
<a href="#l11.846"></a><span id="l11.846" class="difflineminus">-                    getFreeBusyService().addProvider(thisCalendar);</span>
<a href="#l11.847"></a><span id="l11.847" class="difflineplus">+                    self.hasFreeBusy = true;</span>
<a href="#l11.848"></a><span id="l11.848" class="difflineplus">+                    getFreeBusyService().addProvider(self);</span>
<a href="#l11.849"></a><span id="l11.849">                 }</span>
<a href="#l11.850"></a><span id="l11.850" class="difflineminus">-                thisCalendar.findPrincipalNS(aChangeLogListener);</span>
<a href="#l11.851"></a><span id="l11.851" class="difflineplus">+                self.findPrincipalNS(aChangeLogListener);</span>
<a href="#l11.852"></a><span id="l11.852">             } else {</span>
<a href="#l11.853"></a><span id="l11.853">                 cal.LOG(&quot;CalDAV: Server does not support CalDAV scheduling.&quot;);</span>
<a href="#l11.854"></a><span id="l11.854" class="difflineminus">-                thisCalendar.completeCheckServerInfo(aChangeLogListener);</span>
<a href="#l11.855"></a><span id="l11.855" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener);</span>
<a href="#l11.856"></a><span id="l11.856">             }</span>
<a href="#l11.857"></a><span id="l11.857">         };</span>
<a href="#l11.858"></a><span id="l11.858"> </span>
<a href="#l11.859"></a><span id="l11.859">         this.sendHttpRequest(homeSet, null, null, null, (channel) =&gt; {</span>
<a href="#l11.860"></a><span id="l11.860">             channel.requestMethod = &quot;OPTIONS&quot;;</span>
<a href="#l11.861"></a><span id="l11.861">             return streamListener;</span>
<a href="#l11.862"></a><span id="l11.862">         }, () =&gt; {</span>
<a href="#l11.863"></a><span id="l11.863">             notifyListener(Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l11.864"></a><span id="l11.864" class="difflineat">@@ -2030,17 +2029,17 @@ calDavCalendar.prototype = {</span>
<a href="#l11.865"></a><span id="l11.865">         if (this.principalUrl) {</span>
<a href="#l11.866"></a><span id="l11.866">             // We already have a principal namespace, use it.</span>
<a href="#l11.867"></a><span id="l11.867">             this.checkPrincipalsNameSpace([this.principalUrl],</span>
<a href="#l11.868"></a><span id="l11.868">                                           aChangeLogListener);</span>
<a href="#l11.869"></a><span id="l11.869">             return;</span>
<a href="#l11.870"></a><span id="l11.870">         }</span>
<a href="#l11.871"></a><span id="l11.871"> </span>
<a href="#l11.872"></a><span id="l11.872">         let homeSet = this.makeUri(null, this.mCalHomeSet);</span>
<a href="#l11.873"></a><span id="l11.873" class="difflineminus">-        let thisCalendar = this;</span>
<a href="#l11.874"></a><span id="l11.874" class="difflineplus">+        let self = this;</span>
<a href="#l11.875"></a><span id="l11.875"> </span>
<a href="#l11.876"></a><span id="l11.876">         let queryXml =</span>
<a href="#l11.877"></a><span id="l11.877">             xmlHeader +</span>
<a href="#l11.878"></a><span id="l11.878">             '&lt;D:propfind xmlns:D=&quot;DAV:&quot;&gt;' +</span>
<a href="#l11.879"></a><span id="l11.879">               &quot;&lt;D:prop&gt;&quot; +</span>
<a href="#l11.880"></a><span id="l11.880">                 &quot;&lt;D:principal-collection-set/&gt;&quot; +</span>
<a href="#l11.881"></a><span id="l11.881">               &quot;&lt;/D:prop&gt;&quot; +</span>
<a href="#l11.882"></a><span id="l11.882">             &quot;&lt;/D:propfind&gt;&quot;;</span>
<a href="#l11.883"></a><span id="l11.883" class="difflineat">@@ -2050,49 +2049,49 @@ calDavCalendar.prototype = {</span>
<a href="#l11.884"></a><span id="l11.884">         }</span>
<a href="#l11.885"></a><span id="l11.885">         let streamListener = {};</span>
<a href="#l11.886"></a><span id="l11.886">         streamListener.onStreamComplete =</span>
<a href="#l11.887"></a><span id="l11.887">             function findInOutboxes_oSC(aLoader, aContext, aStatus,</span>
<a href="#l11.888"></a><span id="l11.888">                                          aResultLength, aResult) {</span>
<a href="#l11.889"></a><span id="l11.889">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l11.890"></a><span id="l11.890">             if (request.responseStatus != 207) {</span>
<a href="#l11.891"></a><span id="l11.891">                 cal.LOG(&quot;CalDAV: Unexpected status &quot; + request.responseStatus +</span>
<a href="#l11.892"></a><span id="l11.892" class="difflineminus">-                    &quot; while querying principal namespace for &quot; + thisCalendar.name);</span>
<a href="#l11.893"></a><span id="l11.893" class="difflineminus">-                thisCalendar.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l11.894"></a><span id="l11.894" class="difflineminus">-                                                     Components.results.NS_ERROR_FAILURE);</span>
<a href="#l11.895"></a><span id="l11.895" class="difflineplus">+                    &quot; while querying principal namespace for &quot; + self.name);</span>
<a href="#l11.896"></a><span id="l11.896" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l11.897"></a><span id="l11.897" class="difflineplus">+                                             Components.results.NS_ERROR_FAILURE);</span>
<a href="#l11.898"></a><span id="l11.898">                 return;</span>
<a href="#l11.899"></a><span id="l11.899">             }</span>
<a href="#l11.900"></a><span id="l11.900"> </span>
<a href="#l11.901"></a><span id="l11.901">             let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l11.902"></a><span id="l11.902">             if (!str) {</span>
<a href="#l11.903"></a><span id="l11.903" class="difflineminus">-                cal.LOG(&quot;CalDAV: Failed to propstat principal namespace for &quot; + thisCalendar.name);</span>
<a href="#l11.904"></a><span id="l11.904" class="difflineminus">-                thisCalendar.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l11.905"></a><span id="l11.905" class="difflineminus">-                                                     Components.results.NS_ERROR_FAILURE);</span>
<a href="#l11.906"></a><span id="l11.906" class="difflineplus">+                cal.LOG(&quot;CalDAV: Failed to propstat principal namespace for &quot; + self.name);</span>
<a href="#l11.907"></a><span id="l11.907" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l11.908"></a><span id="l11.908" class="difflineplus">+                                             Components.results.NS_ERROR_FAILURE);</span>
<a href="#l11.909"></a><span id="l11.909">                 return;</span>
<a href="#l11.910"></a><span id="l11.910" class="difflineminus">-            } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l11.911"></a><span id="l11.911" class="difflineplus">+            } else if (self.verboseLogging()) {</span>
<a href="#l11.912"></a><span id="l11.912">                 cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l11.913"></a><span id="l11.913">             }</span>
<a href="#l11.914"></a><span id="l11.914"> </span>
<a href="#l11.915"></a><span id="l11.915">             let multistatus;</span>
<a href="#l11.916"></a><span id="l11.916">             try {</span>
<a href="#l11.917"></a><span id="l11.917">                 multistatus = cal.xml.parseString(str);</span>
<a href="#l11.918"></a><span id="l11.918">             } catch (ex) {</span>
<a href="#l11.919"></a><span id="l11.919" class="difflineminus">-                cal.LOG(&quot;CalDAV: Failed to propstat principal namespace for &quot; + thisCalendar.name);</span>
<a href="#l11.920"></a><span id="l11.920" class="difflineminus">-                thisCalendar.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l11.921"></a><span id="l11.921" class="difflineminus">-                                                     Components.results.NS_ERROR_FAILURE);</span>
<a href="#l11.922"></a><span id="l11.922" class="difflineplus">+                cal.LOG(&quot;CalDAV: Failed to propstat principal namespace for &quot; + self.name);</span>
<a href="#l11.923"></a><span id="l11.923" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l11.924"></a><span id="l11.924" class="difflineplus">+                                             Components.results.NS_ERROR_FAILURE);</span>
<a href="#l11.925"></a><span id="l11.925">                 return;</span>
<a href="#l11.926"></a><span id="l11.926">             }</span>
<a href="#l11.927"></a><span id="l11.927"> </span>
<a href="#l11.928"></a><span id="l11.928">             let pcs = caldavXPath(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop/D:principal-collection-set/D:href/text()&quot;);</span>
<a href="#l11.929"></a><span id="l11.929">             let nsList = [];</span>
<a href="#l11.930"></a><span id="l11.930">             if (pcs) {</span>
<a href="#l11.931"></a><span id="l11.931" class="difflineminus">-                nsList = pcs.map(x =&gt; thisCalendar.ensureDecodedPath(x));</span>
<a href="#l11.932"></a><span id="l11.932" class="difflineplus">+                nsList = pcs.map(x =&gt; self.ensureDecodedPath(x));</span>
<a href="#l11.933"></a><span id="l11.933">             }</span>
<a href="#l11.934"></a><span id="l11.934"> </span>
<a href="#l11.935"></a><span id="l11.935" class="difflineminus">-            thisCalendar.checkPrincipalsNameSpace(nsList, aChangeLogListener);</span>
<a href="#l11.936"></a><span id="l11.936" class="difflineplus">+            self.checkPrincipalsNameSpace(nsList, aChangeLogListener);</span>
<a href="#l11.937"></a><span id="l11.937">         };</span>
<a href="#l11.938"></a><span id="l11.938"> </span>
<a href="#l11.939"></a><span id="l11.939">         this.sendHttpRequest(homeSet, queryXml, MIME_TEXT_XML, null, (channel) =&gt; {</span>
<a href="#l11.940"></a><span id="l11.940">             channel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l11.941"></a><span id="l11.941">             channel.requestMethod = &quot;PROPFIND&quot;;</span>
<a href="#l11.942"></a><span id="l11.942">             return streamListener;</span>
<a href="#l11.943"></a><span id="l11.943">         }, () =&gt; {</span>
<a href="#l11.944"></a><span id="l11.944">             notifyListener(Components.results.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l11.945"></a><span id="l11.945" class="difflineat">@@ -2108,17 +2107,17 @@ calDavCalendar.prototype = {</span>
<a href="#l11.946"></a><span id="l11.946">      * checkServerCaps</span>
<a href="#l11.947"></a><span id="l11.947">      * findPrincipalNS</span>
<a href="#l11.948"></a><span id="l11.948">      * checkPrincipalsNameSpace                     * You are here</span>
<a href="#l11.949"></a><span id="l11.949">      * completeCheckServerInfo</span>
<a href="#l11.950"></a><span id="l11.950">      *</span>
<a href="#l11.951"></a><span id="l11.951">      * @param aNameSpaceList    List of available namespaces</span>
<a href="#l11.952"></a><span id="l11.952">      */</span>
<a href="#l11.953"></a><span id="l11.953">     checkPrincipalsNameSpace: function caldav_checkPrincipalsNameSpace(aNameSpaceList, aChangeLogListener) {</span>
<a href="#l11.954"></a><span id="l11.954" class="difflineminus">-        let thisCalendar = this;</span>
<a href="#l11.955"></a><span id="l11.955" class="difflineplus">+        let self = this;</span>
<a href="#l11.956"></a><span id="l11.956">         let doesntSupportScheduling = () =&gt; {</span>
<a href="#l11.957"></a><span id="l11.957">             this.hasScheduling = false;</span>
<a href="#l11.958"></a><span id="l11.958">             this.mInboxUrl = null;</span>
<a href="#l11.959"></a><span id="l11.959">             this.mOutboxUrl = null;</span>
<a href="#l11.960"></a><span id="l11.960">             this.completeCheckServerInfo(aChangeLogListener);</span>
<a href="#l11.961"></a><span id="l11.961">         };</span>
<a href="#l11.962"></a><span id="l11.962"> </span>
<a href="#l11.963"></a><span id="l11.963">         if (!aNameSpaceList.length) {</span>
<a href="#l11.964"></a><span id="l11.964" class="difflineat">@@ -2177,20 +2176,20 @@ calDavCalendar.prototype = {</span>
<a href="#l11.965"></a><span id="l11.965"> </span>
<a href="#l11.966"></a><span id="l11.966">         let streamListener = {};</span>
<a href="#l11.967"></a><span id="l11.967">         streamListener.onStreamComplete =</span>
<a href="#l11.968"></a><span id="l11.968">             function caldav_cPNS_oSC(aLoader, aContext, aStatus,</span>
<a href="#l11.969"></a><span id="l11.969">                                          aResultLength, aResult) {</span>
<a href="#l11.970"></a><span id="l11.970">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l11.971"></a><span id="l11.971">             let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l11.972"></a><span id="l11.972">             if (!str) {</span>
<a href="#l11.973"></a><span id="l11.973" class="difflineminus">-                cal.LOG(&quot;CalDAV: Failed to report principals namespace for &quot; + thisCalendar.name);</span>
<a href="#l11.974"></a><span id="l11.974" class="difflineplus">+                cal.LOG(&quot;CalDAV: Failed to report principals namespace for &quot; + self.name);</span>
<a href="#l11.975"></a><span id="l11.975">                 doesntSupportScheduling();</span>
<a href="#l11.976"></a><span id="l11.976">                 return;</span>
<a href="#l11.977"></a><span id="l11.977" class="difflineminus">-            } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l11.978"></a><span id="l11.978" class="difflineplus">+            } else if (self.verboseLogging()) {</span>
<a href="#l11.979"></a><span id="l11.979">                 cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l11.980"></a><span id="l11.980">             }</span>
<a href="#l11.981"></a><span id="l11.981"> </span>
<a href="#l11.982"></a><span id="l11.982">             if (request.responseStatus != 207) {</span>
<a href="#l11.983"></a><span id="l11.983">                 cal.LOG(&quot;CalDAV: Bad response to in/outbox query, status &quot; +</span>
<a href="#l11.984"></a><span id="l11.984">                     request.responseStatus);</span>
<a href="#l11.985"></a><span id="l11.985">                 doesntSupportScheduling();</span>
<a href="#l11.986"></a><span id="l11.986">                 return;</span>
<a href="#l11.987"></a><span id="l11.987" class="difflineat">@@ -2203,80 +2202,80 @@ calDavCalendar.prototype = {</span>
<a href="#l11.988"></a><span id="l11.988">                 cal.LOG(&quot;CalDAV: Could not parse multistatus response: &quot; + ex + &quot;\n&quot; + str);</span>
<a href="#l11.989"></a><span id="l11.989">                 doesntSupportScheduling();</span>
<a href="#l11.990"></a><span id="l11.990">                 return;</span>
<a href="#l11.991"></a><span id="l11.991">             }</span>
<a href="#l11.992"></a><span id="l11.992"> </span>
<a href="#l11.993"></a><span id="l11.993">             let homeSets = caldavXPath(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop/C:calendar-home-set/D:href/text()&quot;);</span>
<a href="#l11.994"></a><span id="l11.994">             function homeSetMatches(homeSet) {</span>
<a href="#l11.995"></a><span id="l11.995">                 let normalized = homeSet.replace(/([^\/])$/, &quot;$1/&quot;);</span>
<a href="#l11.996"></a><span id="l11.996" class="difflineminus">-                let chs = thisCalendar.mCalHomeSet;</span>
<a href="#l11.997"></a><span id="l11.997" class="difflineplus">+                let chs = self.mCalHomeSet;</span>
<a href="#l11.998"></a><span id="l11.998">                 return normalized == chs.path || normalized == chs.spec;</span>
<a href="#l11.999"></a><span id="l11.999">             }</span>
<a href="#l11.1000"></a><span id="l11.1000">             function createBoxUrl(path) {</span>
<a href="#l11.1001"></a><span id="l11.1001" class="difflineminus">-                let url = thisCalendar.mUri.clone();</span>
<a href="#l11.1002"></a><span id="l11.1002" class="difflineminus">-                url.path = thisCalendar.ensureDecodedPath(path);</span>
<a href="#l11.1003"></a><span id="l11.1003" class="difflineplus">+                let url = self.mUri.clone();</span>
<a href="#l11.1004"></a><span id="l11.1004" class="difflineplus">+                url.path = self.ensureDecodedPath(path);</span>
<a href="#l11.1005"></a><span id="l11.1005">                 // Make sure the uri has a / at the end, as we do with the calendarUri.</span>
<a href="#l11.1006"></a><span id="l11.1006">                 if (url.path.charAt(url.path.length - 1) != &quot;/&quot;) {</span>
<a href="#l11.1007"></a><span id="l11.1007">                     url.path += &quot;/&quot;;</span>
<a href="#l11.1008"></a><span id="l11.1008">                 }</span>
<a href="#l11.1009"></a><span id="l11.1009">                 return url;</span>
<a href="#l11.1010"></a><span id="l11.1010">             }</span>
<a href="#l11.1011"></a><span id="l11.1011"> </span>
<a href="#l11.1012"></a><span id="l11.1012">             // If there are multiple home sets, we need to match the email addresses for scheduling.</span>
<a href="#l11.1013"></a><span id="l11.1013">             // If there is only one, assume its the right one.</span>
<a href="#l11.1014"></a><span id="l11.1014">             // TODO with multiple address sets, we should just use the ACL manager.</span>
<a href="#l11.1015"></a><span id="l11.1015">             if (homeSets &amp;&amp; (homeSets.length == 1 || homeSets.some(homeSetMatches))) {</span>
<a href="#l11.1016"></a><span id="l11.1016">                 let cuaSets = caldavXPath(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop/C:calendar-user-address-set/D:href/text()&quot;);</span>
<a href="#l11.1017"></a><span id="l11.1017">                 if (cuaSets) {</span>
<a href="#l11.1018"></a><span id="l11.1018">                     for (let addr of cuaSets) {</span>
<a href="#l11.1019"></a><span id="l11.1019">                         if (addr.match(/^mailto:/i)) {</span>
<a href="#l11.1020"></a><span id="l11.1020" class="difflineminus">-                            thisCalendar.mCalendarUserAddress = addr;</span>
<a href="#l11.1021"></a><span id="l11.1021" class="difflineplus">+                            self.mCalendarUserAddress = addr;</span>
<a href="#l11.1022"></a><span id="l11.1022">                         }</span>
<a href="#l11.1023"></a><span id="l11.1023">                     }</span>
<a href="#l11.1024"></a><span id="l11.1024">                 }</span>
<a href="#l11.1025"></a><span id="l11.1025"> </span>
<a href="#l11.1026"></a><span id="l11.1026"> </span>
<a href="#l11.1027"></a><span id="l11.1027">                 let inboxPath = caldavXPathFirst(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop/C:schedule-inbox-URL/D:href/text()&quot;);</span>
<a href="#l11.1028"></a><span id="l11.1028">                 if (!inboxPath) {</span>
<a href="#l11.1029"></a><span id="l11.1029">                     // most likely this is a Kerio server that omits the &quot;href&quot;</span>
<a href="#l11.1030"></a><span id="l11.1030">                     inboxPath = caldavXPathFirst(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop/C:schedule-inbox-URL/text()&quot;);</span>
<a href="#l11.1031"></a><span id="l11.1031">                 }</span>
<a href="#l11.1032"></a><span id="l11.1032" class="difflineminus">-                thisCalendar.mInboxUrl = createBoxUrl(inboxPath);</span>
<a href="#l11.1033"></a><span id="l11.1033" class="difflineplus">+                self.mInboxUrl = createBoxUrl(inboxPath);</span>
<a href="#l11.1034"></a><span id="l11.1034"> </span>
<a href="#l11.1035"></a><span id="l11.1035" class="difflineminus">-                if (thisCalendar.calendarUri.spec == thisCalendar.mInboxUrl.spec) {</span>
<a href="#l11.1036"></a><span id="l11.1036" class="difflineplus">+                if (self.calendarUri.spec == self.mInboxUrl.spec) {</span>
<a href="#l11.1037"></a><span id="l11.1037">                     // If the inbox matches the calendar uri (i.e SOGo), then we</span>
<a href="#l11.1038"></a><span id="l11.1038">                     // don't need to poll the inbox.</span>
<a href="#l11.1039"></a><span id="l11.1039" class="difflineminus">-                    thisCalendar.mShouldPollInbox = false;</span>
<a href="#l11.1040"></a><span id="l11.1040" class="difflineplus">+                    self.mShouldPollInbox = false;</span>
<a href="#l11.1041"></a><span id="l11.1041">                 }</span>
<a href="#l11.1042"></a><span id="l11.1042"> </span>
<a href="#l11.1043"></a><span id="l11.1043">                 let outboxPath = caldavXPathFirst(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop/C:schedule-outbox-URL/D:href/text()&quot;);</span>
<a href="#l11.1044"></a><span id="l11.1044">                 if (!outboxPath) {</span>
<a href="#l11.1045"></a><span id="l11.1045">                     // most likely this is a Kerio server that omits the &quot;href&quot;</span>
<a href="#l11.1046"></a><span id="l11.1046">                     outboxPath = caldavXPathFirst(multistatus, &quot;/D:multistatus/D:response/D:propstat/D:prop/C:schedule-outbox-URL/text()&quot;);</span>
<a href="#l11.1047"></a><span id="l11.1047">                 }</span>
<a href="#l11.1048"></a><span id="l11.1048" class="difflineminus">-                thisCalendar.mOutboxUrl = createBoxUrl(outboxPath);</span>
<a href="#l11.1049"></a><span id="l11.1049" class="difflineplus">+                self.mOutboxUrl = createBoxUrl(outboxPath);</span>
<a href="#l11.1050"></a><span id="l11.1050">             }</span>
<a href="#l11.1051"></a><span id="l11.1051"> </span>
<a href="#l11.1052"></a><span id="l11.1052" class="difflineminus">-            if (!thisCalendar.calendarUserAddress ||</span>
<a href="#l11.1053"></a><span id="l11.1053" class="difflineminus">-                !thisCalendar.mInboxUrl ||</span>
<a href="#l11.1054"></a><span id="l11.1054" class="difflineminus">-                !thisCalendar.mOutboxUrl) {</span>
<a href="#l11.1055"></a><span id="l11.1055" class="difflineplus">+            if (!self.calendarUserAddress ||</span>
<a href="#l11.1056"></a><span id="l11.1056" class="difflineplus">+                !self.mInboxUrl ||</span>
<a href="#l11.1057"></a><span id="l11.1057" class="difflineplus">+                !self.mOutboxUrl) {</span>
<a href="#l11.1058"></a><span id="l11.1058">                 if (aNameSpaceList.length) {</span>
<a href="#l11.1059"></a><span id="l11.1059">                     // Check the next namespace to find the info we need.</span>
<a href="#l11.1060"></a><span id="l11.1060" class="difflineminus">-                    thisCalendar.checkPrincipalsNameSpace(aNameSpaceList, aChangeLogListener);</span>
<a href="#l11.1061"></a><span id="l11.1061" class="difflineplus">+                    self.checkPrincipalsNameSpace(aNameSpaceList, aChangeLogListener);</span>
<a href="#l11.1062"></a><span id="l11.1062">                 } else {</span>
<a href="#l11.1063"></a><span id="l11.1063" class="difflineminus">-                    if (thisCalendar.verboseLogging()) {</span>
<a href="#l11.1064"></a><span id="l11.1064" class="difflineplus">+                    if (self.verboseLogging()) {</span>
<a href="#l11.1065"></a><span id="l11.1065">                         cal.LOG(&quot;CalDAV: principal namespace list empty, calendar &quot; +</span>
<a href="#l11.1066"></a><span id="l11.1066" class="difflineminus">-                                thisCalendar.name + &quot; doesn't support scheduling&quot;);</span>
<a href="#l11.1067"></a><span id="l11.1067" class="difflineplus">+                                self.name + &quot; doesn't support scheduling&quot;);</span>
<a href="#l11.1068"></a><span id="l11.1068">                     }</span>
<a href="#l11.1069"></a><span id="l11.1069">                     doesntSupportScheduling();</span>
<a href="#l11.1070"></a><span id="l11.1070">                 }</span>
<a href="#l11.1071"></a><span id="l11.1071">             } else {</span>
<a href="#l11.1072"></a><span id="l11.1072">                 // We have everything, complete.</span>
<a href="#l11.1073"></a><span id="l11.1073" class="difflineminus">-                thisCalendar.completeCheckServerInfo(aChangeLogListener);</span>
<a href="#l11.1074"></a><span id="l11.1074" class="difflineplus">+                self.completeCheckServerInfo(aChangeLogListener);</span>
<a href="#l11.1075"></a><span id="l11.1075">             }</span>
<a href="#l11.1076"></a><span id="l11.1076">         };</span>
<a href="#l11.1077"></a><span id="l11.1077">         this.sendHttpRequest(requestUri, queryXml, MIME_TEXT_XML, null, (channel) =&gt; {</span>
<a href="#l11.1078"></a><span id="l11.1078">             if (queryDepth == 0) {</span>
<a href="#l11.1079"></a><span id="l11.1079">                 // Set header, doing this for Depth: 1 is not needed since thats the</span>
<a href="#l11.1080"></a><span id="l11.1080">                 // default.</span>
<a href="#l11.1081"></a><span id="l11.1081">                 channel.setRequestHeader(&quot;Depth&quot;, &quot;0&quot;, false);</span>
<a href="#l11.1082"></a><span id="l11.1082">             }</span>
<a href="#l11.1083"></a><span id="l11.1083" class="difflineat">@@ -2412,17 +2411,17 @@ calDavCalendar.prototype = {</span>
<a href="#l11.1084"></a><span id="l11.1084">         if (aCalIdParts[0] != &quot;mailto&quot; &amp;&amp;</span>
<a href="#l11.1085"></a><span id="l11.1085">             aCalIdParts[0] != &quot;http&quot; &amp;&amp;</span>
<a href="#l11.1086"></a><span id="l11.1086">             aCalIdParts[0] != &quot;https&quot;) {</span>
<a href="#l11.1087"></a><span id="l11.1087">             aListener.onResult(null, null);</span>
<a href="#l11.1088"></a><span id="l11.1088">             return;</span>
<a href="#l11.1089"></a><span id="l11.1089">         }</span>
<a href="#l11.1090"></a><span id="l11.1090">         let mailto_aCalId = aCalIdParts.join(&quot;:&quot;);</span>
<a href="#l11.1091"></a><span id="l11.1091"> </span>
<a href="#l11.1092"></a><span id="l11.1092" class="difflineminus">-        let thisCalendar = this;</span>
<a href="#l11.1093"></a><span id="l11.1093" class="difflineplus">+        let self = this;</span>
<a href="#l11.1094"></a><span id="l11.1094"> </span>
<a href="#l11.1095"></a><span id="l11.1095">         let organizer = this.calendarUserAddress;</span>
<a href="#l11.1096"></a><span id="l11.1096"> </span>
<a href="#l11.1097"></a><span id="l11.1097">         let fbQuery = getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span>
<a href="#l11.1098"></a><span id="l11.1098">         calSetProdidVersion(fbQuery);</span>
<a href="#l11.1099"></a><span id="l11.1099">         let prop = getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l11.1100"></a><span id="l11.1100">         prop.value = &quot;REQUEST&quot;;</span>
<a href="#l11.1101"></a><span id="l11.1101">         fbQuery.addProperty(prop);</span>
<a href="#l11.1102"></a><span id="l11.1102" class="difflineat">@@ -2450,18 +2449,18 @@ calDavCalendar.prototype = {</span>
<a href="#l11.1103"></a><span id="l11.1103">         let streamListener = {};</span>
<a href="#l11.1104"></a><span id="l11.1104"> </span>
<a href="#l11.1105"></a><span id="l11.1105">         streamListener.onStreamComplete =</span>
<a href="#l11.1106"></a><span id="l11.1106">             function caldav_GFBI_oSC(aLoader, aContext, aStatus,</span>
<a href="#l11.1107"></a><span id="l11.1107">                                          aResultLength, aResult) {</span>
<a href="#l11.1108"></a><span id="l11.1108">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l11.1109"></a><span id="l11.1109">             let str = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l11.1110"></a><span id="l11.1110">             if (!str) {</span>
<a href="#l11.1111"></a><span id="l11.1111" class="difflineminus">-                cal.LOG(&quot;CalDAV: Failed to parse freebusy response from &quot; + thisCalendar.name);</span>
<a href="#l11.1112"></a><span id="l11.1112" class="difflineminus">-            } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l11.1113"></a><span id="l11.1113" class="difflineplus">+                cal.LOG(&quot;CalDAV: Failed to parse freebusy response from &quot; + self.name);</span>
<a href="#l11.1114"></a><span id="l11.1114" class="difflineplus">+            } else if (self.verboseLogging()) {</span>
<a href="#l11.1115"></a><span id="l11.1115">                 cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l11.1116"></a><span id="l11.1116">             }</span>
<a href="#l11.1117"></a><span id="l11.1117"> </span>
<a href="#l11.1118"></a><span id="l11.1118">             if (request.responseStatus == 200) {</span>
<a href="#l11.1119"></a><span id="l11.1119">                 let periodsToReturn = [];</span>
<a href="#l11.1120"></a><span id="l11.1120">                 let fbTypeMap = {};</span>
<a href="#l11.1121"></a><span id="l11.1121">                 fbTypeMap[&quot;FREE&quot;] = calIFreeBusyInterval.FREE;</span>
<a href="#l11.1122"></a><span id="l11.1122">                 fbTypeMap[&quot;BUSY&quot;] = calIFreeBusyInterval.BUSY;</span>
<a href="#l11.1123"></a><span id="l11.1123" class="difflineat">@@ -2475,23 +2474,23 @@ calDavCalendar.prototype = {</span>
<a href="#l11.1124"></a><span id="l11.1124">                     cal.LOG(&quot;CalDAV: Could not parse freebusy response &quot; + ex);</span>
<a href="#l11.1125"></a><span id="l11.1125">                     aListener.onResult(null, null);</span>
<a href="#l11.1126"></a><span id="l11.1126">                     return;</span>
<a href="#l11.1127"></a><span id="l11.1127">                 }</span>
<a href="#l11.1128"></a><span id="l11.1128"> </span>
<a href="#l11.1129"></a><span id="l11.1129">                 let status = caldavXPathFirst(fbResult, &quot;/C:schedule-response/C:response/C:request-status/text()&quot;);</span>
<a href="#l11.1130"></a><span id="l11.1130">                 if (!status || status.substr(0, 1) != &quot;2&quot;) {</span>
<a href="#l11.1131"></a><span id="l11.1131">                     cal.LOG(&quot;CalDAV: Got status &quot; + status + &quot; in response to &quot; +</span>
<a href="#l11.1132"></a><span id="l11.1132" class="difflineminus">-                            &quot;freebusy query for &quot; + thisCalendar.name);</span>
<a href="#l11.1133"></a><span id="l11.1133" class="difflineplus">+                            &quot;freebusy query for &quot; + self.name);</span>
<a href="#l11.1134"></a><span id="l11.1134">                     aListener.onResult(null, null);</span>
<a href="#l11.1135"></a><span id="l11.1135">                     return;</span>
<a href="#l11.1136"></a><span id="l11.1136">                 }</span>
<a href="#l11.1137"></a><span id="l11.1137">                 if (status.substr(0, 3) != &quot;2.0&quot;) {</span>
<a href="#l11.1138"></a><span id="l11.1138">                     cal.LOG(&quot;CalDAV: Got status &quot; + status + &quot; in response to &quot; +</span>
<a href="#l11.1139"></a><span id="l11.1139" class="difflineminus">-                            &quot;freebusy query for&quot; + thisCalendar.name);</span>
<a href="#l11.1140"></a><span id="l11.1140" class="difflineplus">+                            &quot;freebusy query for&quot; + self.name);</span>
<a href="#l11.1141"></a><span id="l11.1141">                 }</span>
<a href="#l11.1142"></a><span id="l11.1142"> </span>
<a href="#l11.1143"></a><span id="l11.1143">                 let caldata = caldavXPathFirst(fbResult, &quot;/C:schedule-response/C:response/C:calendar-data/text()&quot;);</span>
<a href="#l11.1144"></a><span id="l11.1144">                 try {</span>
<a href="#l11.1145"></a><span id="l11.1145">                     let calComp = cal.getIcsService().parseICS(caldata, null);</span>
<a href="#l11.1146"></a><span id="l11.1146">                     for (let calFbComp of cal.ical.calendarComponentIterator(calComp)) {</span>
<a href="#l11.1147"></a><span id="l11.1147">                         let interval;</span>
<a href="#l11.1148"></a><span id="l11.1148"> </span>
<a href="#l11.1149"></a><span id="l11.1149" class="difflineat">@@ -2538,17 +2537,17 @@ calDavCalendar.prototype = {</span>
<a href="#l11.1150"></a><span id="l11.1150">                     }</span>
<a href="#l11.1151"></a><span id="l11.1151">                 } catch (exc) {</span>
<a href="#l11.1152"></a><span id="l11.1152">                     cal.ERROR(&quot;CalDAV: Error parsing free-busy info.&quot;);</span>
<a href="#l11.1153"></a><span id="l11.1153">                 }</span>
<a href="#l11.1154"></a><span id="l11.1154"> </span>
<a href="#l11.1155"></a><span id="l11.1155">                 aListener.onResult(null, periodsToReturn);</span>
<a href="#l11.1156"></a><span id="l11.1156">             } else {</span>
<a href="#l11.1157"></a><span id="l11.1157">                 cal.LOG(&quot;CalDAV: Received status &quot; + request.responseStatus +</span>
<a href="#l11.1158"></a><span id="l11.1158" class="difflineminus">-                        &quot; from freebusy query for &quot; + thisCalendar.name);</span>
<a href="#l11.1159"></a><span id="l11.1159" class="difflineplus">+                        &quot; from freebusy query for &quot; + self.name);</span>
<a href="#l11.1160"></a><span id="l11.1160">                 aListener.onResult(null, null);</span>
<a href="#l11.1161"></a><span id="l11.1161">             }</span>
<a href="#l11.1162"></a><span id="l11.1162">         };</span>
<a href="#l11.1163"></a><span id="l11.1163"> </span>
<a href="#l11.1164"></a><span id="l11.1164">         let fbUri = this.makeUri(null, this.outboxUrl);</span>
<a href="#l11.1165"></a><span id="l11.1165">         this.sendHttpRequest(fbUri, fbQuery, MIME_TEXT_CALENDAR, null, (channel) =&gt; {</span>
<a href="#l11.1166"></a><span id="l11.1166">             channel.requestMethod = &quot;POST&quot;;</span>
<a href="#l11.1167"></a><span id="l11.1167">             channel.setRequestHeader(&quot;Originator&quot;, organizer, false);</span>
<a href="#l11.1168"></a><span id="l11.1168" class="difflineat">@@ -2638,17 +2637,17 @@ calDavCalendar.prototype = {</span>
<a href="#l11.1169"></a><span id="l11.1169"> </span>
<a href="#l11.1170"></a><span id="l11.1170">     //</span>
<a href="#l11.1171"></a><span id="l11.1171">     // take calISchedulingSupport interface base implementation (cal.ProviderBase)</span>
<a href="#l11.1172"></a><span id="l11.1172">     //</span>
<a href="#l11.1173"></a><span id="l11.1173"> </span>
<a href="#l11.1174"></a><span id="l11.1174">     processItipReply: function caldav_processItipReply(aItem, aPath) {</span>
<a href="#l11.1175"></a><span id="l11.1175">         // modify partstat for in-calendar item</span>
<a href="#l11.1176"></a><span id="l11.1176">         // delete item from inbox</span>
<a href="#l11.1177"></a><span id="l11.1177" class="difflineminus">-        let thisCalendar = this;</span>
<a href="#l11.1178"></a><span id="l11.1178" class="difflineplus">+        let self = this;</span>
<a href="#l11.1179"></a><span id="l11.1179"> </span>
<a href="#l11.1180"></a><span id="l11.1180">         let getItemListener = {};</span>
<a href="#l11.1181"></a><span id="l11.1181">         getItemListener.QueryInterface = XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]);</span>
<a href="#l11.1182"></a><span id="l11.1182">         getItemListener.onOperationComplete = function caldav_gUIs_oOC(aCalendar,</span>
<a href="#l11.1183"></a><span id="l11.1183">                                                                        aStatus,</span>
<a href="#l11.1184"></a><span id="l11.1184">                                                                        aOperationType,</span>
<a href="#l11.1185"></a><span id="l11.1185">                                                                        aId,</span>
<a href="#l11.1186"></a><span id="l11.1186">                                                                        aDetail) {</span>
<a href="#l11.1187"></a><span id="l11.1187" class="difflineat">@@ -2669,35 +2668,35 @@ calDavCalendar.prototype = {</span>
<a href="#l11.1188"></a><span id="l11.1188">                 let att = newItem.getAttendeeById(attendee.id);</span>
<a href="#l11.1189"></a><span id="l11.1189">                 if (att) {</span>
<a href="#l11.1190"></a><span id="l11.1190">                     newItem.removeAttendee(att);</span>
<a href="#l11.1191"></a><span id="l11.1191">                     att = att.clone();</span>
<a href="#l11.1192"></a><span id="l11.1192">                     att.participationStatus = attendee.participationStatus;</span>
<a href="#l11.1193"></a><span id="l11.1193">                     newItem.addAttendee(att);</span>
<a href="#l11.1194"></a><span id="l11.1194">                 }</span>
<a href="#l11.1195"></a><span id="l11.1195">             }</span>
<a href="#l11.1196"></a><span id="l11.1196" class="difflineminus">-            thisCalendar.doModifyItem(newItem, itemToUpdate.parentItem /* related to bug 396182 */,</span>
<a href="#l11.1197"></a><span id="l11.1197" class="difflineminus">-                                      modListener, true);</span>
<a href="#l11.1198"></a><span id="l11.1198" class="difflineplus">+            self.doModifyItem(newItem, itemToUpdate.parentItem /* related to bug 396182 */,</span>
<a href="#l11.1199"></a><span id="l11.1199" class="difflineplus">+                              modListener, true);</span>
<a href="#l11.1200"></a><span id="l11.1200">         };</span>
<a href="#l11.1201"></a><span id="l11.1201"> </span>
<a href="#l11.1202"></a><span id="l11.1202">         let modListener = {};</span>
<a href="#l11.1203"></a><span id="l11.1203">         modListener.QueryInterface = XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]);</span>
<a href="#l11.1204"></a><span id="l11.1204">         modListener.onOperationComplete = function caldav_pIR_moOC(aCalendar,</span>
<a href="#l11.1205"></a><span id="l11.1205">                                                                    aStatus,</span>
<a href="#l11.1206"></a><span id="l11.1206">                                                                    aOperationType,</span>
<a href="#l11.1207"></a><span id="l11.1207">                                                                    aItemId,</span>
<a href="#l11.1208"></a><span id="l11.1208">                                                                    aDetail) {</span>
<a href="#l11.1209"></a><span id="l11.1209">             cal.LOG(&quot;CalDAV: status &quot; + aStatus + &quot; while processing iTIP REPLY &quot; +</span>
<a href="#l11.1210"></a><span id="l11.1210" class="difflineminus">-                    &quot; for &quot; + thisCalendar.name);</span>
<a href="#l11.1211"></a><span id="l11.1211" class="difflineplus">+                    &quot; for &quot; + self.name);</span>
<a href="#l11.1212"></a><span id="l11.1212">             // don't delete the REPLY item from inbox unless modifying the master</span>
<a href="#l11.1213"></a><span id="l11.1213">             // item was successful</span>
<a href="#l11.1214"></a><span id="l11.1214">             if (aStatus == 0) { // aStatus undocumented; 0 seems to indicate no error</span>
<a href="#l11.1215"></a><span id="l11.1215" class="difflineminus">-                let delUri = thisCalendar.calendarUri.clone();</span>
<a href="#l11.1216"></a><span id="l11.1216" class="difflineminus">-                delUri.path = thisCalendar.ensureEncodedPath(aPath);</span>
<a href="#l11.1217"></a><span id="l11.1217" class="difflineminus">-                thisCalendar.doDeleteItem(aItem, null, true, true, delUri);</span>
<a href="#l11.1218"></a><span id="l11.1218" class="difflineplus">+                let delUri = self.calendarUri.clone();</span>
<a href="#l11.1219"></a><span id="l11.1219" class="difflineplus">+                delUri.path = self.ensureEncodedPath(aPath);</span>
<a href="#l11.1220"></a><span id="l11.1220" class="difflineplus">+                self.doDeleteItem(aItem, null, true, true, delUri);</span>
<a href="#l11.1221"></a><span id="l11.1221">             }</span>
<a href="#l11.1222"></a><span id="l11.1222">         };</span>
<a href="#l11.1223"></a><span id="l11.1223"> </span>
<a href="#l11.1224"></a><span id="l11.1224">         this.mOfflineStorage.getItem(aItem.id, getItemListener);</span>
<a href="#l11.1225"></a><span id="l11.1225">     },</span>
<a href="#l11.1226"></a><span id="l11.1226"> </span>
<a href="#l11.1227"></a><span id="l11.1227">     canNotify: function caldav_canNotify(aMethod, aItem) {</span>
<a href="#l11.1228"></a><span id="l11.1228">         if (this.hasAutoScheduling) {</span>
<a href="#l11.1229"></a><span id="l11.1229" class="difflineat">@@ -2762,43 +2761,43 @@ calDavCalendar.prototype = {</span>
<a href="#l11.1230"></a><span id="l11.1230">         for (let item of aItipItem.getItemList({})) {</span>
<a href="#l11.1231"></a><span id="l11.1231">             let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l11.1232"></a><span id="l11.1232">                                        .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l11.1233"></a><span id="l11.1233">             serializer.addItems([item], 1);</span>
<a href="#l11.1234"></a><span id="l11.1234">             let methodProp = getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l11.1235"></a><span id="l11.1235">             methodProp.value = aItipItem.responseMethod;</span>
<a href="#l11.1236"></a><span id="l11.1236">             serializer.addProperty(methodProp);</span>
<a href="#l11.1237"></a><span id="l11.1237"> </span>
<a href="#l11.1238"></a><span id="l11.1238" class="difflineminus">-            let thisCalendar = this;</span>
<a href="#l11.1239"></a><span id="l11.1239" class="difflineplus">+            let self = this;</span>
<a href="#l11.1240"></a><span id="l11.1240">             let streamListener = {</span>
<a href="#l11.1241"></a><span id="l11.1241">                 onStreamComplete: function caldav_sendItems_oSC(aLoader, aContext, aStatus,</span>
<a href="#l11.1242"></a><span id="l11.1242">                                                                 aResultLength, aResult) {</span>
<a href="#l11.1243"></a><span id="l11.1243">                     let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l11.1244"></a><span id="l11.1244">                     let status;</span>
<a href="#l11.1245"></a><span id="l11.1245">                     try {</span>
<a href="#l11.1246"></a><span id="l11.1246">                         status = request.responseStatus;</span>
<a href="#l11.1247"></a><span id="l11.1247">                     } catch (ex) {</span>
<a href="#l11.1248"></a><span id="l11.1248">                         status = Components.interfaces.calIErrors.DAV_POST_ERROR;</span>
<a href="#l11.1249"></a><span id="l11.1249">                         cal.LOG(&quot;CalDAV: no response status when sending iTIP for&quot; +</span>
<a href="#l11.1250"></a><span id="l11.1250" class="difflineminus">-                                thisCalendar.name);</span>
<a href="#l11.1251"></a><span id="l11.1251" class="difflineplus">+                                self.name);</span>
<a href="#l11.1252"></a><span id="l11.1252">                     }</span>
<a href="#l11.1253"></a><span id="l11.1253"> </span>
<a href="#l11.1254"></a><span id="l11.1254">                     if (status != 200) {</span>
<a href="#l11.1255"></a><span id="l11.1255">                         cal.LOG(&quot;CalDAV: Sending iTIP failed with status &quot; + status +</span>
<a href="#l11.1256"></a><span id="l11.1256" class="difflineminus">-                                &quot; for &quot; + thisCalendar.name);</span>
<a href="#l11.1257"></a><span id="l11.1257" class="difflineplus">+                                &quot; for &quot; + self.name);</span>
<a href="#l11.1258"></a><span id="l11.1258">                     }</span>
<a href="#l11.1259"></a><span id="l11.1259"> </span>
<a href="#l11.1260"></a><span id="l11.1260">                     let str = cal.convertByteArray(aResult, aResultLength, &quot;UTF-8&quot;, false);</span>
<a href="#l11.1261"></a><span id="l11.1261">                     if (str) {</span>
<a href="#l11.1262"></a><span id="l11.1262" class="difflineminus">-                        if (thisCalendar.verboseLogging()) {</span>
<a href="#l11.1263"></a><span id="l11.1263" class="difflineplus">+                        if (self.verboseLogging()) {</span>
<a href="#l11.1264"></a><span id="l11.1264">                             cal.LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l11.1265"></a><span id="l11.1265">                         }</span>
<a href="#l11.1266"></a><span id="l11.1266">                     } else {</span>
<a href="#l11.1267"></a><span id="l11.1267">                         cal.LOG(&quot;CalDAV: Failed to parse iTIP response for&quot; +</span>
<a href="#l11.1268"></a><span id="l11.1268" class="difflineminus">-                                thisCalendar.name);</span>
<a href="#l11.1269"></a><span id="l11.1269" class="difflineplus">+                                self.name);</span>
<a href="#l11.1270"></a><span id="l11.1270">                     }</span>
<a href="#l11.1271"></a><span id="l11.1271"> </span>
<a href="#l11.1272"></a><span id="l11.1272">                     let responseXML;</span>
<a href="#l11.1273"></a><span id="l11.1273">                     try {</span>
<a href="#l11.1274"></a><span id="l11.1274">                         responseXML = cal.xml.parseString(str);</span>
<a href="#l11.1275"></a><span id="l11.1275">                     } catch (ex) {</span>
<a href="#l11.1276"></a><span id="l11.1276">                         cal.LOG(&quot;CalDAV: Could not parse multistatus response: &quot; + ex + &quot;\n&quot; + str);</span>
<a href="#l11.1277"></a><span id="l11.1277">                         return;</span>
<a href="#l11.1278"></a><span id="l11.1278" class="difflineat">@@ -2809,41 +2808,41 @@ calDavCalendar.prototype = {</span>
<a href="#l11.1279"></a><span id="l11.1279">                     // untested code, as I don't have a caldav-sched server</span>
<a href="#l11.1280"></a><span id="l11.1280">                     // available. If you find someone who does, please test!</span>
<a href="#l11.1281"></a><span id="l11.1281">                     let responses = caldavXPath(responseXML, &quot;/C:schedule-response/C:response&quot;);</span>
<a href="#l11.1282"></a><span id="l11.1282">                     if (responses) {</span>
<a href="#l11.1283"></a><span id="l11.1283">                         for (let response of responses) {</span>
<a href="#l11.1284"></a><span id="l11.1284">                             let recip = caldavXPathFirst(response, &quot;C:recipient/D:href/text()&quot;);</span>
<a href="#l11.1285"></a><span id="l11.1285">                             let reqstatus = caldavXPathFirst(response, &quot;C:request-status/text()&quot;);</span>
<a href="#l11.1286"></a><span id="l11.1286">                             if (reqstatus.substr(0, 1) != &quot;2&quot;) {</span>
<a href="#l11.1287"></a><span id="l11.1287" class="difflineminus">-                                if (thisCalendar.verboseLogging()) {</span>
<a href="#l11.1288"></a><span id="l11.1288" class="difflineplus">+                                if (self.verboseLogging()) {</span>
<a href="#l11.1289"></a><span id="l11.1289">                                     cal.LOG(&quot;CalDAV: Failed scheduling delivery to &quot; + recip);</span>
<a href="#l11.1290"></a><span id="l11.1290">                                 }</span>
<a href="#l11.1291"></a><span id="l11.1291">                                 for (let att of aRecipients) {</span>
<a href="#l11.1292"></a><span id="l11.1292">                                     if (att.id.toLowerCase() == recip.toLowerCase()) {</span>
<a href="#l11.1293"></a><span id="l11.1293">                                         remainingAttendees.push(att);</span>
<a href="#l11.1294"></a><span id="l11.1294">                                         break;</span>
<a href="#l11.1295"></a><span id="l11.1295">                                     }</span>
<a href="#l11.1296"></a><span id="l11.1296">                                 }</span>
<a href="#l11.1297"></a><span id="l11.1297">                             }</span>
<a href="#l11.1298"></a><span id="l11.1298">                         }</span>
<a href="#l11.1299"></a><span id="l11.1299">                     }</span>
<a href="#l11.1300"></a><span id="l11.1300"> </span>
<a href="#l11.1301"></a><span id="l11.1301">                     if (remainingAttendees.length) {</span>
<a href="#l11.1302"></a><span id="l11.1302">                         // try to fall back to email delivery if CalDAV-sched</span>
<a href="#l11.1303"></a><span id="l11.1303">                         // didn't work</span>
<a href="#l11.1304"></a><span id="l11.1304" class="difflineminus">-                        let imipTransport = cal.getImipTransport(thisCalendar);</span>
<a href="#l11.1305"></a><span id="l11.1305" class="difflineplus">+                        let imipTransport = cal.getImipTransport(self);</span>
<a href="#l11.1306"></a><span id="l11.1306">                         if (imipTransport) {</span>
<a href="#l11.1307"></a><span id="l11.1307" class="difflineminus">-                            if (thisCalendar.verboseLogging()) {</span>
<a href="#l11.1308"></a><span id="l11.1308" class="difflineplus">+                            if (self.verboseLogging()) {</span>
<a href="#l11.1309"></a><span id="l11.1309">                                 cal.LOG(&quot;CalDAV: sending email to &quot; + remainingAttendees.length + &quot; recipients&quot;);</span>
<a href="#l11.1310"></a><span id="l11.1310">                             }</span>
<a href="#l11.1311"></a><span id="l11.1311">                             imipTransport.sendItems(remainingAttendees.length, remainingAttendees, aItipItem);</span>
<a href="#l11.1312"></a><span id="l11.1312">                         } else {</span>
<a href="#l11.1313"></a><span id="l11.1313">                             cal.LOG(&quot;CalDAV: no fallback to iTIP/iMIP transport for &quot; +</span>
<a href="#l11.1314"></a><span id="l11.1314" class="difflineminus">-                                    thisCalendar.name);</span>
<a href="#l11.1315"></a><span id="l11.1315" class="difflineplus">+                                    self.name);</span>
<a href="#l11.1316"></a><span id="l11.1316">                         }</span>
<a href="#l11.1317"></a><span id="l11.1317">                     }</span>
<a href="#l11.1318"></a><span id="l11.1318">                 }</span>
<a href="#l11.1319"></a><span id="l11.1319">             };</span>
<a href="#l11.1320"></a><span id="l11.1320"> </span>
<a href="#l11.1321"></a><span id="l11.1321">             let uploadData = serializer.serializeToString();</span>
<a href="#l11.1322"></a><span id="l11.1322">             let requestUri = this.makeUri(null, this.outboxUrl);</span>
<a href="#l11.1323"></a><span id="l11.1323">             if (this.verboseLogging()) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -260,40 +260,40 @@ calICSCalendar.prototype = {</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5">         this.mObserver.onStartBatch();</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7">         // Wrap parsing in a try block. Will ignore errors. That's a good thing</span>
<a href="#l12.8"></a><span id="l12.8">         // for non-existing or empty files, but not good for invalid files.</span>
<a href="#l12.9"></a><span id="l12.9">         // That's why we put them in readOnly mode</span>
<a href="#l12.10"></a><span id="l12.10">         let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l12.11"></a><span id="l12.11">                                .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-        let this_ = this;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+        let self = this;</span>
<a href="#l12.14"></a><span id="l12.14">         let listener = { // calIIcsParsingListener</span>
<a href="#l12.15"></a><span id="l12.15">             onParsingComplete: function ics_onParsingComplete(rc, parser_) {</span>
<a href="#l12.16"></a><span id="l12.16">                 try {</span>
<a href="#l12.17"></a><span id="l12.17">                     for (let item of parser_.getItems({})) {</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-                        this_.mMemoryCalendar.adoptItem(item, null);</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+                        self.mMemoryCalendar.adoptItem(item, null);</span>
<a href="#l12.20"></a><span id="l12.20">                     }</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-                    this_.unmappedComponents = parser_.getComponents({});</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-                    this_.unmappedProperties = parser_.getProperties({});</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-                    cal.LOG(&quot;[calICSCalendar] Parsing ICS succeeded for &quot; + this_.uri.spec);</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+                    self.unmappedComponents = parser_.getComponents({});</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+                    self.unmappedProperties = parser_.getProperties({});</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+                    cal.LOG(&quot;[calICSCalendar] Parsing ICS succeeded for &quot; + self.uri.spec);</span>
<a href="#l12.27"></a><span id="l12.27">                 } catch (exc) {</span>
<a href="#l12.28"></a><span id="l12.28">                     cal.LOG(&quot;[calICSCalendar] Parsing ICS failed for \nException: &quot; + exc);</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-                    this_.mObserver.onError(this_.superCalendar, exc.result, exc.toString());</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-                    this_.mObserver.onError(this_.superCalendar, calIErrors.READ_FAILED, &quot;&quot;);</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+                    self.mObserver.onError(self.superCalendar, exc.result, exc.toString());</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+                    self.mObserver.onError(self.superCalendar, calIErrors.READ_FAILED, &quot;&quot;);</span>
<a href="#l12.33"></a><span id="l12.33">                 }</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-                this_.mObserver.onEndBatch();</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-                this_.mObserver.onLoad(this_);</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+                self.mObserver.onEndBatch();</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+                self.mObserver.onLoad(self);</span>
<a href="#l12.38"></a><span id="l12.38"> </span>
<a href="#l12.39"></a><span id="l12.39">                 // Now that all items have been stuffed into the memory calendar</span>
<a href="#l12.40"></a><span id="l12.40">                 // we should add ourselves as observer. It is important that this</span>
<a href="#l12.41"></a><span id="l12.41">                 // happens *after* the calls to adoptItem in the above loop to prevent</span>
<a href="#l12.42"></a><span id="l12.42">                 // the views from being notified.</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-                this_.mMemoryCalendar.addObserver(this_.mObserver);</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-                this_.unlock();</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+                self.mMemoryCalendar.addObserver(self.mObserver);</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+                self.unlock();</span>
<a href="#l12.47"></a><span id="l12.47">             }</span>
<a href="#l12.48"></a><span id="l12.48">         };</span>
<a href="#l12.49"></a><span id="l12.49">         parser.parseString(str, null, listener);</span>
<a href="#l12.50"></a><span id="l12.50">     },</span>
<a href="#l12.51"></a><span id="l12.51"> </span>
<a href="#l12.52"></a><span id="l12.52">     writeICS: function() {</span>
<a href="#l12.53"></a><span id="l12.53">         cal.LOG(&quot;[calICSCalendar] Commencing write of ICS Calendar &quot; + this.name);</span>
<a href="#l12.54"></a><span id="l12.54">         this.lock();</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineat">@@ -306,71 +306,71 @@ calICSCalendar.prototype = {</span>
<a href="#l12.56"></a><span id="l12.56">         } catch (exc) {</span>
<a href="#l12.57"></a><span id="l12.57">             this.unlock(calIErrors.MODIFICATION_FAILED);</span>
<a href="#l12.58"></a><span id="l12.58">             throw exc;</span>
<a href="#l12.59"></a><span id="l12.59">         }</span>
<a href="#l12.60"></a><span id="l12.60">     },</span>
<a href="#l12.61"></a><span id="l12.61"> </span>
<a href="#l12.62"></a><span id="l12.62">     doWriteICS: function() {</span>
<a href="#l12.63"></a><span id="l12.63">         cal.LOG(&quot;[calICSCalendar] Writing ICS File &quot; + this.uri.spec);</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-        let savedthis = this;</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+        let self = this;</span>
<a href="#l12.66"></a><span id="l12.66">         let listener =</span>
<a href="#l12.67"></a><span id="l12.67">         {</span>
<a href="#l12.68"></a><span id="l12.68">             serializer: null,</span>
<a href="#l12.69"></a><span id="l12.69">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l12.70"></a><span id="l12.70">             onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l12.71"></a><span id="l12.71">                 let inLastWindowClosingSurvivalArea = false;</span>
<a href="#l12.72"></a><span id="l12.72">                 try {</span>
<a href="#l12.73"></a><span id="l12.73">                     // All events are returned. Now set up a channel and a</span>
<a href="#l12.74"></a><span id="l12.74">                     // streamloader to upload.  onStopRequest will be called</span>
<a href="#l12.75"></a><span id="l12.75">                     // once the write has finished</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-                    let channel = Services.io.newChannelFromURI2(savedthis.mUri,</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+                    let channel = Services.io.newChannelFromURI2(self.mUri,</span>
<a href="#l12.78"></a><span id="l12.78">                                                                  null,</span>
<a href="#l12.79"></a><span id="l12.79">                                                                  Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l12.80"></a><span id="l12.80">                                                                  null,</span>
<a href="#l12.81"></a><span id="l12.81">                                                                  Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l12.82"></a><span id="l12.82">                                                                  Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l12.83"></a><span id="l12.83"> </span>
<a href="#l12.84"></a><span id="l12.84">                     // Allow the hook to add things to the channel, like a</span>
<a href="#l12.85"></a><span id="l12.85">                     // header that checks etags</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-                    let notChanged = savedthis.mHooks.onBeforePut(channel);</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+                    let notChanged = self.mHooks.onBeforePut(channel);</span>
<a href="#l12.88"></a><span id="l12.88">                     if (notChanged) {</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineminus">-                        channel.notificationCallbacks = savedthis;</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+                        channel.notificationCallbacks = self;</span>
<a href="#l12.91"></a><span id="l12.91">                         let uploadChannel = channel.QueryInterface(</span>
<a href="#l12.92"></a><span id="l12.92">                             Components.interfaces.nsIUploadChannel);</span>
<a href="#l12.93"></a><span id="l12.93"> </span>
<a href="#l12.94"></a><span id="l12.94">                         // Serialize</span>
<a href="#l12.95"></a><span id="l12.95">                         let icsStream = this.serializer.serializeToInputStream();</span>
<a href="#l12.96"></a><span id="l12.96"> </span>
<a href="#l12.97"></a><span id="l12.97">                         // Upload</span>
<a href="#l12.98"></a><span id="l12.98">                         uploadChannel.setUploadStream(icsStream,</span>
<a href="#l12.99"></a><span id="l12.99">                                                     &quot;text/calendar&quot;, -1);</span>
<a href="#l12.100"></a><span id="l12.100"> </span>
<a href="#l12.101"></a><span id="l12.101">                         Services.startup.enterLastWindowClosingSurvivalArea();</span>
<a href="#l12.102"></a><span id="l12.102">                         inLastWindowClosingSurvivalArea = true;</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-                        channel.asyncOpen(savedthis, savedthis);</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+                        channel.asyncOpen(self, self);</span>
<a href="#l12.105"></a><span id="l12.105">                     } else {</span>
<a href="#l12.106"></a><span id="l12.106">                         if (inLastWindowClosingSurvivalArea) {</span>
<a href="#l12.107"></a><span id="l12.107">                             Services.startup.exitLastWindowClosingSurvivalArea();</span>
<a href="#l12.108"></a><span id="l12.108">                         }</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-                        savedthis.mObserver.onError(savedthis.superCalendar,</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-                                                    calIErrors.MODIFICATION_FAILED,</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-                                                    &quot;The calendar has been changed remotely. Please reload and apply your changes again!&quot;);</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineminus">-                        savedthis.unlock(calIErrors.MODIFICATION_FAILED);</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+                        self.mObserver.onError(self.superCalendar,</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+                                               calIErrors.MODIFICATION_FAILED,</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+                                               &quot;The calendar has been changed remotely. Please reload and apply your changes again!&quot;);</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+                        self.unlock(calIErrors.MODIFICATION_FAILED);</span>
<a href="#l12.117"></a><span id="l12.117">                     }</span>
<a href="#l12.118"></a><span id="l12.118">                 } catch (ex) {</span>
<a href="#l12.119"></a><span id="l12.119">                     if (inLastWindowClosingSurvivalArea) {</span>
<a href="#l12.120"></a><span id="l12.120">                         Services.startup.exitLastWindowClosingSurvivalArea();</span>
<a href="#l12.121"></a><span id="l12.121">                     }</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineminus">-                    savedthis.mObserver.onError(savedthis.superCalendar,</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineminus">-                                                ex.result, &quot;The calendar could not be saved; there &quot; +</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-                                                &quot;was a failure: 0x&quot; + ex.result.toString(16));</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineminus">-                    savedthis.mObserver.onError(savedthis.superCalendar, calIErrors.MODIFICATION_FAILED, &quot;&quot;);</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineminus">-                    savedthis.unlock(calIErrors.MODIFICATION_FAILED);</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">-                    savedthis.forceRefresh();</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+                    self.mObserver.onError(self.superCalendar,</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+                                           ex.result, &quot;The calendar could not be saved; there &quot; +</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+                                           &quot;was a failure: 0x&quot; + ex.result.toString(16));</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+                    self.mObserver.onError(self.superCalendar, calIErrors.MODIFICATION_FAILED, &quot;&quot;);</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+                    self.unlock(calIErrors.MODIFICATION_FAILED);</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+                    self.forceRefresh();</span>
<a href="#l12.134"></a><span id="l12.134">                 }</span>
<a href="#l12.135"></a><span id="l12.135">             },</span>
<a href="#l12.136"></a><span id="l12.136">             onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l12.137"></a><span id="l12.137">                 this.serializer.addItems(aItems, aCount);</span>
<a href="#l12.138"></a><span id="l12.138">             }</span>
<a href="#l12.139"></a><span id="l12.139">         };</span>
<a href="#l12.140"></a><span id="l12.140">         listener.serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l12.141"></a><span id="l12.141">                                         .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineat">@@ -783,27 +783,27 @@ calICSCalendar.prototype = {</span>
<a href="#l12.143"></a><span id="l12.143">                                                      Components.interfaces.nsILoadInfo.SEC_NORMAL,</span>
<a href="#l12.144"></a><span id="l12.144">                                                      Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l12.145"></a><span id="l12.145">         channel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l12.146"></a><span id="l12.146">         channel.notificationCallbacks = this;</span>
<a href="#l12.147"></a><span id="l12.147"> </span>
<a href="#l12.148"></a><span id="l12.148">         let downloader = Components.classes[&quot;@mozilla.org/network/downloader;1&quot;]</span>
<a href="#l12.149"></a><span id="l12.149">                                    .createInstance(CI.nsIDownloader);</span>
<a href="#l12.150"></a><span id="l12.150"> </span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-        let savedthis = this;</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+        let self = this;</span>
<a href="#l12.153"></a><span id="l12.153">         let listener = {</span>
<a href="#l12.154"></a><span id="l12.154">             onDownloadComplete: function(opdownloader, request, ctxt, status, result) {</span>
<a href="#l12.155"></a><span id="l12.155">                 if (doInitialBackup) {</span>
<a href="#l12.156"></a><span id="l12.156">                     copyToOverwriting(result, backupDir, makeName(&quot;initial&quot;));</span>
<a href="#l12.157"></a><span id="l12.157">                 }</span>
<a href="#l12.158"></a><span id="l12.158">                 if (doDailyBackup) {</span>
<a href="#l12.159"></a><span id="l12.159">                     copyToOverwriting(result, backupDir, dailyBackupFileName);</span>
<a href="#l12.160"></a><span id="l12.160">                 }</span>
<a href="#l12.161"></a><span id="l12.161"> </span>
<a href="#l12.162"></a><span id="l12.162" class="difflineminus">-                aCallback.call(savedthis);</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+                aCallback.call(self);</span>
<a href="#l12.164"></a><span id="l12.164">             }</span>
<a href="#l12.165"></a><span id="l12.165">         };</span>
<a href="#l12.166"></a><span id="l12.166"> </span>
<a href="#l12.167"></a><span id="l12.167">         downloader.init(listener, backupFile);</span>
<a href="#l12.168"></a><span id="l12.168">         try {</span>
<a href="#l12.169"></a><span id="l12.169">             channel.asyncOpen(downloader, null);</span>
<a href="#l12.170"></a><span id="l12.170">         } catch (e) {</span>
<a href="#l12.171"></a><span id="l12.171">             // For local files, asyncOpen throws on new (calendar) files</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineat">@@ -995,17 +995,17 @@ httpHooks.prototype = {</span>
<a href="#l12.173"></a><span id="l12.173">         } catch (e) {</span>
<a href="#l12.174"></a><span id="l12.174">             // There was no ETag header on the response. This means that</span>
<a href="#l12.175"></a><span id="l12.175">             // putting is not atomic. This is bad. Race conditions can happen,</span>
<a href="#l12.176"></a><span id="l12.176">             // because there is a time in which we don't know the right</span>
<a href="#l12.177"></a><span id="l12.177">             // etag.</span>
<a href="#l12.178"></a><span id="l12.178">             // Try to do the best we can, by immediatly getting the etag.</span>
<a href="#l12.179"></a><span id="l12.179"> </span>
<a href="#l12.180"></a><span id="l12.180">             let etagListener = {};</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineminus">-            let thisHook = this; // need to reference in callback</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+            let self = this; // need to reference in callback</span>
<a href="#l12.183"></a><span id="l12.183"> </span>
<a href="#l12.184"></a><span id="l12.184">             etagListener.onStreamComplete =</span>
<a href="#l12.185"></a><span id="l12.185">                 function ics_etLoSC(aLoader, aContext, aStatus, aResultLength,</span>
<a href="#l12.186"></a><span id="l12.186">                                     aResult) {</span>
<a href="#l12.187"></a><span id="l12.187">                 let resultConverter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l12.188"></a><span id="l12.188">                                                 .createInstance(Components</span>
<a href="#l12.189"></a><span id="l12.189">                                                 .interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l12.190"></a><span id="l12.190">                 resultConverter.charset = &quot;UTF-8&quot;;</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineat">@@ -1013,17 +1013,17 @@ httpHooks.prototype = {</span>
<a href="#l12.192"></a><span id="l12.192">                 let multistatus;</span>
<a href="#l12.193"></a><span id="l12.193">                 try {</span>
<a href="#l12.194"></a><span id="l12.194">                     let str = resultConverter.convertFromByteArray(aResult, aResultLength);</span>
<a href="#l12.195"></a><span id="l12.195">                     multistatus = cal.xml.parseString(str);</span>
<a href="#l12.196"></a><span id="l12.196">                 } catch (ex) {</span>
<a href="#l12.197"></a><span id="l12.197">                     cal.LOG(&quot;[calICSCalendar] Failed to fetch channel etag&quot;);</span>
<a href="#l12.198"></a><span id="l12.198">                 }</span>
<a href="#l12.199"></a><span id="l12.199"> </span>
<a href="#l12.200"></a><span id="l12.200" class="difflineminus">-                thisHook.mEtag = icsXPathFirst(multistatus, &quot;/D:propfind/D:response/D:propstat/D:prop/D:getetag&quot;);</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+                self.mEtag = icsXPathFirst(multistatus, &quot;/D:propfind/D:response/D:propstat/D:prop/D:getetag&quot;);</span>
<a href="#l12.202"></a><span id="l12.202">                 aRespFunc();</span>
<a href="#l12.203"></a><span id="l12.203">             };</span>
<a href="#l12.204"></a><span id="l12.204">             let queryXml =</span>
<a href="#l12.205"></a><span id="l12.205">                 '&lt;D:propfind xmlns:D=&quot;DAV:&quot;&gt;' +</span>
<a href="#l12.206"></a><span id="l12.206">                   &quot;&lt;D:prop&gt;&quot; +</span>
<a href="#l12.207"></a><span id="l12.207">                     &quot;&lt;D:getetag/&gt;&quot; +</span>
<a href="#l12.208"></a><span id="l12.208">                   &quot;&lt;/D:prop&gt;&quot; +</span>
<a href="#l12.209"></a><span id="l12.209">                 &quot;&lt;/D:propfind&gt;&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -171,23 +171,23 @@ calMemoryCalendar.prototype = {</span>
<a href="#l13.4"></a><span id="l13.4">     modifyItem: function(aNewItem, aOldItem, aListener) {</span>
<a href="#l13.5"></a><span id="l13.5">         if (this.readOnly) {</span>
<a href="#l13.6"></a><span id="l13.6">             throw Components.interfaces.calIErrors.CAL_IS_READONLY;</span>
<a href="#l13.7"></a><span id="l13.7">         }</span>
<a href="#l13.8"></a><span id="l13.8">         if (!aNewItem) {</span>
<a href="#l13.9"></a><span id="l13.9">             throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l13.10"></a><span id="l13.10">         }</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-        let this_ = this;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+        let self = this;</span>
<a href="#l13.14"></a><span id="l13.14">         function reportError(errStr, errId) {</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-            this_.notifyOperationComplete(aListener,</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-                                          errId ? errId : Components.results.NS_ERROR_FAILURE,</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-                                          Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-                                          aNewItem.id,</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-                                          errStr);</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+            self.notifyOperationComplete(aListener,</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+                                         errId ? errId : Components.results.NS_ERROR_FAILURE,</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+                                         Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+                                         aNewItem.id,</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+                                         errStr);</span>
<a href="#l13.25"></a><span id="l13.25">             return null;</span>
<a href="#l13.26"></a><span id="l13.26">         }</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28">         if (!aNewItem.id) {</span>
<a href="#l13.29"></a><span id="l13.29">             // this is definitely an error</span>
<a href="#l13.30"></a><span id="l13.30">             return reportError(null, &quot;ID for modifyItem item is null&quot;);</span>
<a href="#l13.31"></a><span id="l13.31">         }</span>
<a href="#l13.32"></a><span id="l13.32"> </span>
<a href="#l13.33"></a><span id="l13.33" class="difflineat">@@ -347,20 +347,19 @@ calMemoryCalendar.prototype = {</span>
<a href="#l13.34"></a><span id="l13.34">                                      null);</span>
<a href="#l13.35"></a><span id="l13.35">     },</span>
<a href="#l13.36"></a><span id="l13.36"> </span>
<a href="#l13.37"></a><span id="l13.37">     // void getItems( in unsigned long aItemFilter, in unsigned long aCount,</span>
<a href="#l13.38"></a><span id="l13.38">     //                in calIDateTime aRangeStart, in calIDateTime aRangeEnd,</span>
<a href="#l13.39"></a><span id="l13.39">     //                in calIOperationListener aListener );</span>
<a href="#l13.40"></a><span id="l13.40">     getItems: function(aItemFilter, aCount,</span>
<a href="#l13.41"></a><span id="l13.41">                         aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-        let this_ = this;</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-        cal.postPone(function() {</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-                this_.getItems_(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener);</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-            });</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+        cal.postPone(() =&gt; {</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+            this.getItems_(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener);</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+        });</span>
<a href="#l13.49"></a><span id="l13.49">     },</span>
<a href="#l13.50"></a><span id="l13.50">     getItems_: function(aItemFilter, aCount,</span>
<a href="#l13.51"></a><span id="l13.51">                          aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l13.52"></a><span id="l13.52">         if (!aListener) {</span>
<a href="#l13.53"></a><span id="l13.53">             return;</span>
<a href="#l13.54"></a><span id="l13.54">         }</span>
<a href="#l13.55"></a><span id="l13.55"> </span>
<a href="#l13.56"></a><span id="l13.56">         const calICalendar = Components.interfaces.calICalendar;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -461,25 +461,25 @@ calStorageCalendar.prototype = {</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5">         // notify observers</span>
<a href="#l14.6"></a><span id="l14.6">         this.observers.notify(&quot;onAddItem&quot;, [aItem]);</span>
<a href="#l14.7"></a><span id="l14.7">     },</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9">     // void modifyItem( in calIItemBase aNewItem, in calIItemBase aOldItem, in calIOperationListener aListener );</span>
<a href="#l14.10"></a><span id="l14.10">     // Actually uses doModifyItem</span>
<a href="#l14.11"></a><span id="l14.11">     modifyItem: function cSC_modifyItem(aNewItem, aOldItem, aListener) {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-        let this_ = this;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+        let self = this;</span>
<a href="#l14.14"></a><span id="l14.14"> </span>
<a href="#l14.15"></a><span id="l14.15">         // HACK Just modifying the item would clear the offline flag, we need to</span>
<a href="#l14.16"></a><span id="l14.16">         // retrieve the flag and pass it to the real modify function.</span>
<a href="#l14.17"></a><span id="l14.17">         let offlineJournalFlagListener = {</span>
<a href="#l14.18"></a><span id="l14.18">             onGetResult: function(calendar, status, opType, id, detail) {</span>
<a href="#l14.19"></a><span id="l14.19">             },</span>
<a href="#l14.20"></a><span id="l14.20">             onOperationComplete: function(opcalendar, status, opType, id, offlineFlag) {</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-                this_.doModifyItem(aNewItem, aOldItem, aListener, offlineFlag);</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+                self.doModifyItem(aNewItem, aOldItem, aListener, offlineFlag);</span>
<a href="#l14.23"></a><span id="l14.23">             }</span>
<a href="#l14.24"></a><span id="l14.24">         };</span>
<a href="#l14.25"></a><span id="l14.25">         this.getItemOfflineFlag(aOldItem, offlineJournalFlagListener);</span>
<a href="#l14.26"></a><span id="l14.26">     },</span>
<a href="#l14.27"></a><span id="l14.27"> </span>
<a href="#l14.28"></a><span id="l14.28">     doModifyItem: function cSC_doModifyItem(aNewItem, aOldItem, aListener, offlineFlag) {</span>
<a href="#l14.29"></a><span id="l14.29">         let oldOfflineFlag = offlineFlag;</span>
<a href="#l14.30"></a><span id="l14.30">         if (this.readOnly) {</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineat">@@ -489,23 +489,23 @@ calStorageCalendar.prototype = {</span>
<a href="#l14.32"></a><span id="l14.32">                                          null,</span>
<a href="#l14.33"></a><span id="l14.33">                                          &quot;Calendar is readonly&quot;);</span>
<a href="#l14.34"></a><span id="l14.34">             return null;</span>
<a href="#l14.35"></a><span id="l14.35">         }</span>
<a href="#l14.36"></a><span id="l14.36">         if (!aNewItem) {</span>
<a href="#l14.37"></a><span id="l14.37">             throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l14.38"></a><span id="l14.38">         }</span>
<a href="#l14.39"></a><span id="l14.39"> </span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-        let this_ = this;</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+        let self = this;</span>
<a href="#l14.42"></a><span id="l14.42">         function reportError(errStr, errId) {</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-            this_.notifyOperationComplete(aListener,</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-                                          errId ? errId : Components.results.NS_ERROR_FAILURE,</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-                                          Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-                                          aNewItem.id,</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-                                          errStr);</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+            self.notifyOperationComplete(aListener,</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+                                         errId ? errId : Components.results.NS_ERROR_FAILURE,</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+                                         Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+                                         aNewItem.id,</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+                                         errStr);</span>
<a href="#l14.53"></a><span id="l14.53">             return null;</span>
<a href="#l14.54"></a><span id="l14.54">         }</span>
<a href="#l14.55"></a><span id="l14.55"> </span>
<a href="#l14.56"></a><span id="l14.56">         if (aNewItem.id == null) {</span>
<a href="#l14.57"></a><span id="l14.57">             // this is definitely an error</span>
<a href="#l14.58"></a><span id="l14.58">             return reportError(&quot;ID for modifyItem item is null&quot;);</span>
<a href="#l14.59"></a><span id="l14.59">         }</span>
<a href="#l14.60"></a><span id="l14.60"> </span>
<a href="#l14.61"></a><span id="l14.61" class="difflineat">@@ -656,19 +656,18 @@ calStorageCalendar.prototype = {</span>
<a href="#l14.62"></a><span id="l14.62">                                      null);</span>
<a href="#l14.63"></a><span id="l14.63">     },</span>
<a href="#l14.64"></a><span id="l14.64"> </span>
<a href="#l14.65"></a><span id="l14.65">     // void getItems( in unsigned long aItemFilter, in unsigned long aCount,</span>
<a href="#l14.66"></a><span id="l14.66">     //                in calIDateTime aRangeStart, in calIDateTime aRangeEnd,</span>
<a href="#l14.67"></a><span id="l14.67">     //                in calIOperationListener aListener );</span>
<a href="#l14.68"></a><span id="l14.68">     getItems: function cSC_getItems(aItemFilter, aCount,</span>
<a href="#l14.69"></a><span id="l14.69">                                     aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-        let this_ = this;</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineminus">-        cal.postPone(function() {</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-            this_.getItems_(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener);</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+        cal.postPone(() =&gt; {</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+            this.getItems_(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener);</span>
<a href="#l14.75"></a><span id="l14.75">         });</span>
<a href="#l14.76"></a><span id="l14.76">     },</span>
<a href="#l14.77"></a><span id="l14.77">     getItems_: function cSC_getItems_(aItemFilter, aCount,</span>
<a href="#l14.78"></a><span id="l14.78">                                       aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l14.79"></a><span id="l14.79">         if (!aListener) {</span>
<a href="#l14.80"></a><span id="l14.80">             return;</span>
<a href="#l14.81"></a><span id="l14.81">         }</span>
<a href="#l14.82"></a><span id="l14.82"> </span>
<a href="#l14.83"></a><span id="l14.83" class="difflineat">@@ -946,30 +945,30 @@ calStorageCalendar.prototype = {</span>
<a href="#l14.84"></a><span id="l14.84">     getItemOfflineFlag: function cSC_getOfflineJournalFlag(aItem, aListener) {</span>
<a href="#l14.85"></a><span id="l14.85">         let flag = null;</span>
<a href="#l14.86"></a><span id="l14.86">         if (!aItem) {</span>
<a href="#l14.87"></a><span id="l14.87">             // It is possible that aItem can be null, flag provided should be null in this case</span>
<a href="#l14.88"></a><span id="l14.88">             aListener.onOperationComplete(this, Components.results.NS_OK,</span>
<a href="#l14.89"></a><span id="l14.89">                                                Components.interfaces.calIOperationListener.GET, null, flag);</span>
<a href="#l14.90"></a><span id="l14.90">         } else {</span>
<a href="#l14.91"></a><span id="l14.91">             let aID = aItem.id;</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineminus">-            let this_ = this;</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+            let self = this;</span>
<a href="#l14.94"></a><span id="l14.94">             let listener = {</span>
<a href="#l14.95"></a><span id="l14.95">                 handleResult: function(aResultSet) {</span>
<a href="#l14.96"></a><span id="l14.96">                         let row = aResultSet.getNextRow();</span>
<a href="#l14.97"></a><span id="l14.97">                         flag = row.getResultByName(&quot;offline_journal&quot;) || null;</span>
<a href="#l14.98"></a><span id="l14.98">                 },</span>
<a href="#l14.99"></a><span id="l14.99">                 handleError: function(aError) {</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineminus">-                    this_.logError(&quot;Error getting offline flag&quot;, aError);</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineminus">-                    aListener.onOperationComplete(this_, Components.results.NS_ERROR_FAILURE,</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineminus">-                                                   Components.interfaces.calIOperationListener.GET, aItem.id, aItem);</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+                    self.logError(&quot;Error getting offline flag&quot;, aError);</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+                    aListener.onOperationComplete(self, Components.results.NS_ERROR_FAILURE,</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+                                                  Components.interfaces.calIOperationListener.GET, aItem.id, aItem);</span>
<a href="#l14.106"></a><span id="l14.106">                 },</span>
<a href="#l14.107"></a><span id="l14.107">                 handleCompletion: function(aReason) {</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineminus">-                    aListener.onOperationComplete(this_, Components.results.NS_OK,</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineminus">-                                                   Components.interfaces.calIOperationListener.GET, aItem.id, flag);</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+                    aListener.onOperationComplete(self, Components.results.NS_OK,</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+                                                  Components.interfaces.calIOperationListener.GET, aItem.id, flag);</span>
<a href="#l14.112"></a><span id="l14.112">                 }</span>
<a href="#l14.113"></a><span id="l14.113">             };</span>
<a href="#l14.114"></a><span id="l14.114">             if (cal.isEvent(aItem)) {</span>
<a href="#l14.115"></a><span id="l14.115">                 this.prepareStatement(this.mSelectEvent);</span>
<a href="#l14.116"></a><span id="l14.116">                 this.mSelectEvent.params.id = aID;</span>
<a href="#l14.117"></a><span id="l14.117">                 this.mSelectEvent.executeAsync(listener);</span>
<a href="#l14.118"></a><span id="l14.118">             } else if (cal.isToDo(aItem)) {</span>
<a href="#l14.119"></a><span id="l14.119">                 this.prepareStatement(this.mSelectTodo);</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineat">@@ -1015,64 +1014,64 @@ calStorageCalendar.prototype = {</span>
<a href="#l14.121"></a><span id="l14.121">         this.notifyOperationComplete(aListener,</span>
<a href="#l14.122"></a><span id="l14.122">                                      Components.results.NS_OK,</span>
<a href="#l14.123"></a><span id="l14.123">                                      Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l14.124"></a><span id="l14.124">                                      aItem.id,</span>
<a href="#l14.125"></a><span id="l14.125">                                      aItem);</span>
<a href="#l14.126"></a><span id="l14.126">     },</span>
<a href="#l14.127"></a><span id="l14.127"> </span>
<a href="#l14.128"></a><span id="l14.128">     modifyOfflineItem: function(aItem, aListener) {</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineminus">-        let this_ = this;</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+        let self = this;</span>
<a href="#l14.131"></a><span id="l14.131">         let opListener = {</span>
<a href="#l14.132"></a><span id="l14.132">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l14.133"></a><span id="l14.133">             onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l14.134"></a><span id="l14.134">             },</span>
<a href="#l14.135"></a><span id="l14.135">             onOperationComplete: function(calendar, status, opType, id, oldOfflineJournalFlag) {</span>
<a href="#l14.136"></a><span id="l14.136">                 let newOfflineJournalFlag = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l14.137"></a><span id="l14.137">                 if (oldOfflineJournalFlag == cICL.OFFLINE_FLAG_CREATED_RECORD || oldOfflineJournalFlag == cICL.OFFLINE_FLAG_DELETED_RECORD) {</span>
<a href="#l14.138"></a><span id="l14.138">                     // Do nothing since a flag of &quot;created&quot; or &quot;deleted&quot; exists</span>
<a href="#l14.139"></a><span id="l14.139">                 } else {</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineminus">-                    this_.setOfflineJournalFlag(aItem, newOfflineJournalFlag);</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+                    self.setOfflineJournalFlag(aItem, newOfflineJournalFlag);</span>
<a href="#l14.142"></a><span id="l14.142">                 }</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineminus">-                this_.notifyOperationComplete(aListener,</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineminus">-                                              Components.results.NS_OK,</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineminus">-                                              Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineminus">-                                              aItem.id,</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineminus">-                                              aItem);</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+                self.notifyOperationComplete(aListener,</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineplus">+                                             Components.results.NS_OK,</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineplus">+                                             Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineplus">+                                             aItem.id,</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineplus">+                                             aItem);</span>
<a href="#l14.153"></a><span id="l14.153">             }</span>
<a href="#l14.154"></a><span id="l14.154">         };</span>
<a href="#l14.155"></a><span id="l14.155">         this.getItemOfflineFlag(aItem, opListener);</span>
<a href="#l14.156"></a><span id="l14.156">     },</span>
<a href="#l14.157"></a><span id="l14.157"> </span>
<a href="#l14.158"></a><span id="l14.158">     deleteOfflineItem: function(aItem, aListener) {</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineminus">-        let this_ = this;</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+        let self = this;</span>
<a href="#l14.161"></a><span id="l14.161">         let opListener = {</span>
<a href="#l14.162"></a><span id="l14.162">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l14.163"></a><span id="l14.163">             onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l14.164"></a><span id="l14.164"> </span>
<a href="#l14.165"></a><span id="l14.165">             },</span>
<a href="#l14.166"></a><span id="l14.166">             onOperationComplete: function(calendar, status, opType, id, oldOfflineJournalFlag) {</span>
<a href="#l14.167"></a><span id="l14.167">                 if (oldOfflineJournalFlag) {</span>
<a href="#l14.168"></a><span id="l14.168">                     // Delete item if flag is c</span>
<a href="#l14.169"></a><span id="l14.169">                     if (oldOfflineJournalFlag == cICL.OFFLINE_FLAG_CREATED_RECORD) {</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineminus">-                        this_.deleteItemById(aItem.id);</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineplus">+                        self.deleteItemById(aItem.id);</span>
<a href="#l14.172"></a><span id="l14.172">                     } else if (oldOfflineJournalFlag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) {</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineminus">-                        this_.setOfflineJournalFlag(aItem, cICL.OFFLINE_FLAG_DELETED_RECORD);</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+                        self.setOfflineJournalFlag(aItem, cICL.OFFLINE_FLAG_DELETED_RECORD);</span>
<a href="#l14.175"></a><span id="l14.175">                     }</span>
<a href="#l14.176"></a><span id="l14.176">                 } else {</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineminus">-                    this_.setOfflineJournalFlag(aItem, cICL.OFFLINE_FLAG_DELETED_RECORD);</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineplus">+                    self.setOfflineJournalFlag(aItem, cICL.OFFLINE_FLAG_DELETED_RECORD);</span>
<a href="#l14.179"></a><span id="l14.179">                 }</span>
<a href="#l14.180"></a><span id="l14.180"> </span>
<a href="#l14.181"></a><span id="l14.181" class="difflineminus">-                this_.notifyOperationComplete(aListener,</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineplus">+                self.notifyOperationComplete(aListener,</span>
<a href="#l14.183"></a><span id="l14.183">                                              Components.results.NS_OK,</span>
<a href="#l14.184"></a><span id="l14.184">                                              Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l14.185"></a><span id="l14.185">                                              aItem.id,</span>
<a href="#l14.186"></a><span id="l14.186">                                              aItem);</span>
<a href="#l14.187"></a><span id="l14.187">                 // notify observers</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineminus">-                this_.observers.notify(&quot;onDeleteItem&quot;, [aItem]);</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineplus">+                self.observers.notify(&quot;onDeleteItem&quot;, [aItem]);</span>
<a href="#l14.190"></a><span id="l14.190">             }</span>
<a href="#l14.191"></a><span id="l14.191">         };</span>
<a href="#l14.192"></a><span id="l14.192">         this.getItemOfflineFlag(aItem, opListener);</span>
<a href="#l14.193"></a><span id="l14.193">     },</span>
<a href="#l14.194"></a><span id="l14.194"> </span>
<a href="#l14.195"></a><span id="l14.195">     resetItemOfflineFlag: function(aItem, aListener) {</span>
<a href="#l14.196"></a><span id="l14.196">         this.setOfflineJournalFlag(aItem, null);</span>
<a href="#l14.197"></a><span id="l14.197">         this.notifyOperationComplete(aListener,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendar.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendar.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -207,30 +207,30 @@ calWcapCalendar.prototype = {</span>
<a href="#l15.4"></a><span id="l15.4">         // invalidate cached results:</span>
<a href="#l15.5"></a><span id="l15.5">         delete this.m_cachedResults;</span>
<a href="#l15.6"></a><span id="l15.6">         // notify about refreshed calendar:</span>
<a href="#l15.7"></a><span id="l15.7">         this.notifyObservers(&quot;onLoad&quot;, [this]);</span>
<a href="#l15.8"></a><span id="l15.8">     },</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10">     issueNetworkRequest: function calWcapCalendar_issueNetworkRequest(</span>
<a href="#l15.11"></a><span id="l15.11">               request, respFunc, dataConvFunc, wcapCommand, params, accessRights) {</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-        let this_ = this;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+        let self = this;</span>
<a href="#l15.14"></a><span id="l15.14">         // - bootstrap problem: no cal_props, no access check, no default calId</span>
<a href="#l15.15"></a><span id="l15.15">         // - assure being logged in, thus the default cal_props are available</span>
<a href="#l15.16"></a><span id="l15.16">         // - every subscribed calendar will come along with cal_props</span>
<a href="#l15.17"></a><span id="l15.17">         return this.session.getSessionId(</span>
<a href="#l15.18"></a><span id="l15.18">             request,</span>
<a href="#l15.19"></a><span id="l15.19">             function getSessionId_resp(err, sessionId) {</span>
<a href="#l15.20"></a><span id="l15.20">                 try {</span>
<a href="#l15.21"></a><span id="l15.21">                     if (err) {</span>
<a href="#l15.22"></a><span id="l15.22">                         throw err;</span>
<a href="#l15.23"></a><span id="l15.23">                     }</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-                    this_.assureAccess(accessRights);</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-                    params += (&quot;&amp;calid=&quot; + encodeURIComponent(this_.calId));</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-                    this_.session.issueNetworkRequest(request, respFunc, dataConvFunc, wcapCommand, params);</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+                    self.assureAccess(accessRights);</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+                    params += (&quot;&amp;calid=&quot; + encodeURIComponent(self.calId));</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+                    self.session.issueNetworkRequest(request, respFunc, dataConvFunc, wcapCommand, params);</span>
<a href="#l15.30"></a><span id="l15.30">                 } catch (exc) {</span>
<a href="#l15.31"></a><span id="l15.31">                     request.execSubRespFunc(respFunc, exc);</span>
<a href="#l15.32"></a><span id="l15.32">                 }</span>
<a href="#l15.33"></a><span id="l15.33">             });</span>
<a href="#l15.34"></a><span id="l15.34">     },</span>
<a href="#l15.35"></a><span id="l15.35"> </span>
<a href="#l15.36"></a><span id="l15.36">     // calIWcapCalendar:</span>
<a href="#l15.37"></a><span id="l15.37"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -288,17 +288,17 @@ function calWcapCalendar_storeItem(bAddI</span>
<a href="#l16.4"></a><span id="l16.4">             two = two.id;</span>
<a href="#l16.5"></a><span id="l16.5">             if (one == two) {</span>
<a href="#l16.6"></a><span id="l16.6">                 return 0;</span>
<a href="#l16.7"></a><span id="l16.7">             }</span>
<a href="#l16.8"></a><span id="l16.8">             return (one &lt; two ? -1 : 1);</span>
<a href="#l16.9"></a><span id="l16.9">         }</span>
<a href="#l16.10"></a><span id="l16.10">         atts = atts.concat([]);</span>
<a href="#l16.11"></a><span id="l16.11">         atts.sort(attendeeSort);</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-        return atts.map(this_.encodeAttendee, this_).join(&quot;;&quot;);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+        return atts.map(self.encodeAttendee, self).join(&quot;;&quot;);</span>
<a href="#l16.14"></a><span id="l16.14">     }</span>
<a href="#l16.15"></a><span id="l16.15">     function encodeCategories(cats) {</span>
<a href="#l16.16"></a><span id="l16.16">         cats = cats.concat([]);</span>
<a href="#l16.17"></a><span id="l16.17">         cats.sort();</span>
<a href="#l16.18"></a><span id="l16.18">         return cats.join(&quot;;&quot;);</span>
<a href="#l16.19"></a><span id="l16.19">     }</span>
<a href="#l16.20"></a><span id="l16.20">     function getPrivacy(pitem) {</span>
<a href="#l16.21"></a><span id="l16.21">         return ((pitem.privacy &amp;&amp; pitem.privacy != &quot;&quot;) ? pitem.privacy : &quot;PUBLIC&quot;);</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -310,26 +310,26 @@ function calWcapCalendar_storeItem(bAddI</span>
<a href="#l16.23"></a><span id="l16.23">             let strings = [];</span>
<a href="#l16.24"></a><span id="l16.24">             for (let att of attachments) {</span>
<a href="#l16.25"></a><span id="l16.25">                 let wrappedAtt = cal.wrapInstance(att, Components.interfaces.calIAttachment);</span>
<a href="#l16.26"></a><span id="l16.26">                 if (typeof att == &quot;string&quot;) {</span>
<a href="#l16.27"></a><span id="l16.27">                     strings.push(encodeURIComponent(att));</span>
<a href="#l16.28"></a><span id="l16.28">                 } else if (wrappedAtt &amp;&amp; wrappedAtt.uri) {</span>
<a href="#l16.29"></a><span id="l16.29">                     strings.push(encodeURIComponent(wrappedAtt.uri.spec));</span>
<a href="#l16.30"></a><span id="l16.30">                 } else { // xxx todo</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-                    logError(&quot;only URLs supported as attachment, not: &quot; + att, this_);</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+                    logError(&quot;only URLs supported as attachment, not: &quot; + att, self);</span>
<a href="#l16.33"></a><span id="l16.33">                 }</span>
<a href="#l16.34"></a><span id="l16.34">             }</span>
<a href="#l16.35"></a><span id="l16.35">             strings.sort();</span>
<a href="#l16.36"></a><span id="l16.36">             ret = strings.join(&quot;;&quot;);</span>
<a href="#l16.37"></a><span id="l16.37">         }</span>
<a href="#l16.38"></a><span id="l16.38">         return ret || &quot;&quot;;</span>
<a href="#l16.39"></a><span id="l16.39">     }</span>
<a href="#l16.40"></a><span id="l16.40"> </span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-    let this_ = this;</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+    let self = this;</span>
<a href="#l16.43"></a><span id="l16.43">     let bIsEvent = isEvent(item);</span>
<a href="#l16.44"></a><span id="l16.44">     let bIsParent = isParent(item);</span>
<a href="#l16.45"></a><span id="l16.45"> </span>
<a href="#l16.46"></a><span id="l16.46">     let method = METHOD_PUBLISH;</span>
<a href="#l16.47"></a><span id="l16.47">     let bNoSmtpNotify = false;</span>
<a href="#l16.48"></a><span id="l16.48">     let params = &quot;&quot;;</span>
<a href="#l16.49"></a><span id="l16.49"> </span>
<a href="#l16.50"></a><span id="l16.50">     let calId = this.calId;</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineat">@@ -629,26 +629,26 @@ function calWcapCalendar_tunnelXProps(de</span>
<a href="#l16.52"></a><span id="l16.52">         } catch (exc) {</span>
<a href="#l16.53"></a><span id="l16.53">             logError(exc, this);</span>
<a href="#l16.54"></a><span id="l16.54">         }</span>
<a href="#l16.55"></a><span id="l16.55">     }</span>
<a href="#l16.56"></a><span id="l16.56"> };</span>
<a href="#l16.57"></a><span id="l16.57"> </span>
<a href="#l16.58"></a><span id="l16.58"> calWcapCalendar.prototype.adoptItem =</span>
<a href="#l16.59"></a><span id="l16.59"> function calWcapCalendar_adoptItem(item, listener) {</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineminus">-    let this_ = this;</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+    let self = this;</span>
<a href="#l16.62"></a><span id="l16.62">     let request = new calWcapRequest(</span>
<a href="#l16.63"></a><span id="l16.63">         function adoptItem_resp(oprequest, err, newItem) {</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-            this_.notifyOperationComplete(listener,</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-                                          getResultCode(err),</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-                                          calIOperationListener.ADD,</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-                                          err ? item.id : newItem.id,</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-                                          err ? err : newItem);</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-            if (!err &amp;&amp; this_ == this_.superCalendar) {</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-                this_.notifyObservers(&quot;onAddItem&quot;, [newItem]);</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+            self.notifyOperationComplete(listener,</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+                                         getResultCode(err),</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+                                         calIOperationListener.ADD,</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+                                         err ? item.id : newItem.id,</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+                                         err ? err : newItem);</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+            if (!err &amp;&amp; self == self.superCalendar) {</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+                self.notifyObservers(&quot;onAddItem&quot;, [newItem]);</span>
<a href="#l16.78"></a><span id="l16.78">             }</span>
<a href="#l16.79"></a><span id="l16.79">         },</span>
<a href="#l16.80"></a><span id="l16.80">         log(&quot;adoptItem() call: &quot; + item.title, this));</span>
<a href="#l16.81"></a><span id="l16.81"> </span>
<a href="#l16.82"></a><span id="l16.82">     try {</span>
<a href="#l16.83"></a><span id="l16.83">         this.storeItem(true /* bAddItem */, item, null, request);</span>
<a href="#l16.84"></a><span id="l16.84">     } catch (exc) {</span>
<a href="#l16.85"></a><span id="l16.85">         request.execRespFunc(exc);</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineat">@@ -658,25 +658,25 @@ function calWcapCalendar_adoptItem(item,</span>
<a href="#l16.87"></a><span id="l16.87"> </span>
<a href="#l16.88"></a><span id="l16.88"> calWcapCalendar.prototype.addItem =</span>
<a href="#l16.89"></a><span id="l16.89"> function calWcapCalendar_addItem(item, listener) {</span>
<a href="#l16.90"></a><span id="l16.90">     this.adoptItem(item.clone(), listener);</span>
<a href="#l16.91"></a><span id="l16.91"> };</span>
<a href="#l16.92"></a><span id="l16.92"> </span>
<a href="#l16.93"></a><span id="l16.93"> calWcapCalendar.prototype.modifyItem =</span>
<a href="#l16.94"></a><span id="l16.94"> function calWcapCalendar_modifyItem(newItem, oldItem, listener) {</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-    let this_ = this;</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+    let self = this;</span>
<a href="#l16.97"></a><span id="l16.97">     let request = new calWcapRequest(</span>
<a href="#l16.98"></a><span id="l16.98">         function modifyItem_resp(oprequest, err, item) {</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-            this_.notifyOperationComplete(listener,</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-                                          getResultCode(err),</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-                                          calIOperationListener.MODIFY,</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-                                          newItem.id, err ? err : item);</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-            if (!err &amp;&amp; this_ == this_.superCalendar) {</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-                this_.notifyObservers(&quot;onModifyItem&quot;, [item, oldItem]);</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+            self.notifyOperationComplete(listener,</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+                                         getResultCode(err),</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+                                         calIOperationListener.MODIFY,</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+                                         newItem.id, err ? err : item);</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+            if (!err &amp;&amp; self == self.superCalendar) {</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+                self.notifyObservers(&quot;onModifyItem&quot;, [item, oldItem]);</span>
<a href="#l16.111"></a><span id="l16.111">             }</span>
<a href="#l16.112"></a><span id="l16.112">         },</span>
<a href="#l16.113"></a><span id="l16.113">         log(&quot;modifyItem() call: &quot; + newItem.id, this));</span>
<a href="#l16.114"></a><span id="l16.114"> </span>
<a href="#l16.115"></a><span id="l16.115">     try {</span>
<a href="#l16.116"></a><span id="l16.116">         if (!newItem.id) {</span>
<a href="#l16.117"></a><span id="l16.117">             throw new Components.Exception(&quot;new item has no id!&quot;);</span>
<a href="#l16.118"></a><span id="l16.118">         }</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineat">@@ -713,21 +713,21 @@ function calWcapCalendar_modifyItem(newI</span>
<a href="#l16.120"></a><span id="l16.120"> </span>
<a href="#l16.121"></a><span id="l16.121">                 request.lockPending();</span>
<a href="#l16.122"></a><span id="l16.122">                 this.issueNetworkRequest(request,</span>
<a href="#l16.123"></a><span id="l16.123">                                          function netResp(err, xml) {</span>
<a href="#l16.124"></a><span id="l16.124">                                              try {</span>
<a href="#l16.125"></a><span id="l16.125">                                                  // ignore any error and continue storing the item:</span>
<a href="#l16.126"></a><span id="l16.126">                                                  if (LOG_LEVEL &gt; 0) {</span>
<a href="#l16.127"></a><span id="l16.127">                                                      log(&quot;modifyItem EXDATEs: &quot; +</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineminus">-                                                         (xml ? getWcapRequestStatusString(xml) : &quot;failed!&quot;), this_);</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineplus">+                                                         (xml ? getWcapRequestStatusString(xml) : &quot;failed!&quot;), self);</span>
<a href="#l16.130"></a><span id="l16.130">                                                  }</span>
<a href="#l16.131"></a><span id="l16.131">                                                  // invalidate cached results:</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineminus">-                                                 delete this_.m_cachedResults;</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineminus">-                                                 this_.storeItem(false /* bAddItem */, newItem, oldItem_, request);</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineplus">+                                                 delete self.m_cachedResults;</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+                                                 self.storeItem(false /* bAddItem */, newItem, oldItem_, request);</span>
<a href="#l16.136"></a><span id="l16.136">                                              } finally {</span>
<a href="#l16.137"></a><span id="l16.137">                                                  request.unlockPending();</span>
<a href="#l16.138"></a><span id="l16.138">                                              }</span>
<a href="#l16.139"></a><span id="l16.139">                                          },</span>
<a href="#l16.140"></a><span id="l16.140">                                          stringToXml, isEvent(newItem) ? &quot;deleteevents_by_id&quot; : &quot;deletetodos_by_id&quot;,</span>
<a href="#l16.141"></a><span id="l16.141">                                          params, calIWcapCalendar.AC_COMP_WRITE);</span>
<a href="#l16.142"></a><span id="l16.142">                 return request;</span>
<a href="#l16.143"></a><span id="l16.143">             }</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineat">@@ -739,26 +739,26 @@ function calWcapCalendar_modifyItem(newI</span>
<a href="#l16.145"></a><span id="l16.145">     } catch (exc) {</span>
<a href="#l16.146"></a><span id="l16.146">         request.execRespFunc(exc);</span>
<a href="#l16.147"></a><span id="l16.147">     }</span>
<a href="#l16.148"></a><span id="l16.148">     return request;</span>
<a href="#l16.149"></a><span id="l16.149"> };</span>
<a href="#l16.150"></a><span id="l16.150"> </span>
<a href="#l16.151"></a><span id="l16.151"> calWcapCalendar.prototype.deleteItem =</span>
<a href="#l16.152"></a><span id="l16.152"> function calWcapCalendar_deleteItem(item, listener) {</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineminus">-    let this_ = this;</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineplus">+    let self = this;</span>
<a href="#l16.155"></a><span id="l16.155">     let request = new calWcapRequest(</span>
<a href="#l16.156"></a><span id="l16.156">         function deleteItem_resp(oprequest, err) {</span>
<a href="#l16.157"></a><span id="l16.157">             // xxx todo: need to notify about each deleted item if multiple?</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineminus">-            this_.notifyOperationComplete(listener,</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineminus">-                                          getResultCode(err),</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineminus">-                                          calIOperationListener.DELETE,</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineminus">-                                          item.id, err ? err : item);</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineminus">-            if (!err &amp;&amp; this_ == this_.superCalendar) {</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineminus">-                this_.notifyObservers(&quot;onDeleteItem&quot;, [item]);</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineplus">+            self.notifyOperationComplete(listener,</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineplus">+                                         getResultCode(err),</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+                                         calIOperationListener.DELETE,</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineplus">+                                         item.id, err ? err : item);</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineplus">+            if (!err &amp;&amp; self == self.superCalendar) {</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+                self.notifyObservers(&quot;onDeleteItem&quot;, [item]);</span>
<a href="#l16.170"></a><span id="l16.170">             }</span>
<a href="#l16.171"></a><span id="l16.171">         },</span>
<a href="#l16.172"></a><span id="l16.172">         log(&quot;deleteItem() call: &quot; + item.id, this));</span>
<a href="#l16.173"></a><span id="l16.173"> </span>
<a href="#l16.174"></a><span id="l16.174">     try {</span>
<a href="#l16.175"></a><span id="l16.175">         if (!item.id) {</span>
<a href="#l16.176"></a><span id="l16.176">             throw new Components.Exception(&quot;no item id!&quot;);</span>
<a href="#l16.177"></a><span id="l16.177">         }</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineat">@@ -779,19 +779,19 @@ function calWcapCalendar_deleteItem(item</span>
<a href="#l16.179"></a><span id="l16.179">         params += &quot;&amp;fmt-out=text%2Fxml&quot;;</span>
<a href="#l16.180"></a><span id="l16.180"> </span>
<a href="#l16.181"></a><span id="l16.181">         this.issueNetworkRequest(request,</span>
<a href="#l16.182"></a><span id="l16.182">                                  function netResp(err, xml) {</span>
<a href="#l16.183"></a><span id="l16.183">                                      if (err) {</span>
<a href="#l16.184"></a><span id="l16.184">                                          throw err;</span>
<a href="#l16.185"></a><span id="l16.185">                                      }</span>
<a href="#l16.186"></a><span id="l16.186">                                      // invalidate cached results:</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineminus">-                                     delete this_.m_cachedResults;</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineplus">+                                     delete self.m_cachedResults;</span>
<a href="#l16.189"></a><span id="l16.189">                                      if (LOG_LEVEL &gt; 0) {</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineminus">-                                         log(&quot;deleteItem(): &quot; + getWcapRequestStatusString(xml), this_);</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineplus">+                                         log(&quot;deleteItem(): &quot; + getWcapRequestStatusString(xml), self);</span>
<a href="#l16.192"></a><span id="l16.192">                                      }</span>
<a href="#l16.193"></a><span id="l16.193">                                  },</span>
<a href="#l16.194"></a><span id="l16.194">                                  stringToXml, isEvent(item) ? &quot;deleteevents_by_id&quot; : &quot;deletetodos_by_id&quot;,</span>
<a href="#l16.195"></a><span id="l16.195">                                  params, calIWcapCalendar.AC_COMP_WRITE);</span>
<a href="#l16.196"></a><span id="l16.196">     } catch (exc) {</span>
<a href="#l16.197"></a><span id="l16.197">         request.execRespFunc(exc);</span>
<a href="#l16.198"></a><span id="l16.198">     }</span>
<a href="#l16.199"></a><span id="l16.199">     return request;</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineat">@@ -1030,67 +1030,67 @@ calWcapCalendar.prototype.parseItems = f</span>
<a href="#l16.201"></a><span id="l16.201">     if (LOG_LEVEL &gt; 1) {</span>
<a href="#l16.202"></a><span id="l16.202">         log(&quot;parseItems(): returning &quot; + items.length + &quot; items&quot;, this);</span>
<a href="#l16.203"></a><span id="l16.203">     }</span>
<a href="#l16.204"></a><span id="l16.204">     return items;</span>
<a href="#l16.205"></a><span id="l16.205"> };</span>
<a href="#l16.206"></a><span id="l16.206"> </span>
<a href="#l16.207"></a><span id="l16.207"> calWcapCalendar.prototype.getItem =</span>
<a href="#l16.208"></a><span id="l16.208"> function calWcapCalendar_getItem(id, listener) {</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineminus">-    let this_ = this;</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineplus">+    let self = this;</span>
<a href="#l16.211"></a><span id="l16.211">     let request = new calWcapRequest(</span>
<a href="#l16.212"></a><span id="l16.212">         function getItem_resp(oprequest, err, item) {</span>
<a href="#l16.213"></a><span id="l16.213">             if (checkErrorCode(err, calIWcapErrors.WCAP_FETCH_EVENTS_BY_ID_FAILED) ||</span>
<a href="#l16.214"></a><span id="l16.214">                 checkErrorCode(err, calIWcapErrors.WCAP_COMPONENT_NOT_FOUND)) {</span>
<a href="#l16.215"></a><span id="l16.215">                 // querying by id is a valid use case, even if no item is returned:</span>
<a href="#l16.216"></a><span id="l16.216">                 err = NS_OK;</span>
<a href="#l16.217"></a><span id="l16.217">             }</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineminus">-            this_.notifyOperationComplete(listener,</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineminus">-                                          getResultCode(err),</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineminus">-                                          calIOperationListener.GET,</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineminus">-                                          item ? item.id : null,</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineminus">-                                          err || item);</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineplus">+            self.notifyOperationComplete(listener,</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineplus">+                                         getResultCode(err),</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineplus">+                                         calIOperationListener.GET,</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineplus">+                                         item ? item.id : null,</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineplus">+                                         err || item);</span>
<a href="#l16.228"></a><span id="l16.228">         },</span>
<a href="#l16.229"></a><span id="l16.229">         log(&quot;getItem() call: id=&quot; + id, this));</span>
<a href="#l16.230"></a><span id="l16.230"> </span>
<a href="#l16.231"></a><span id="l16.231">     try {</span>
<a href="#l16.232"></a><span id="l16.232">         if (!id) {</span>
<a href="#l16.233"></a><span id="l16.233">             throw new Components.Exception(&quot;no item id!&quot;);</span>
<a href="#l16.234"></a><span id="l16.234">         }</span>
<a href="#l16.235"></a><span id="l16.235">         let params = &quot;&amp;relativealarm=1&amp;compressed=1&amp;recurring=1&quot;;</span>
<a href="#l16.236"></a><span id="l16.236">         params += &quot;&amp;emailorcalid=1&amp;fmt-out=text%2Fcalendar&amp;uid=&quot;;</span>
<a href="#l16.237"></a><span id="l16.237">         params += encodeURIComponent(id);</span>
<a href="#l16.238"></a><span id="l16.238"> </span>
<a href="#l16.239"></a><span id="l16.239">         // most common: try events first</span>
<a href="#l16.240"></a><span id="l16.240">         this.issueNetworkRequest(</span>
<a href="#l16.241"></a><span id="l16.241">             request,</span>
<a href="#l16.242"></a><span id="l16.242">             function fetchEventById_resp(err, eventRootComp) {</span>
<a href="#l16.243"></a><span id="l16.243">                 function notifyResult(rootComp) {</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineminus">-                    let items = this_.parseItems(rootComp, calICalendar.ITEM_FILTER_ALL_ITEMS, 0, null, null);</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineplus">+                    let items = self.parseItems(rootComp, calICalendar.ITEM_FILTER_ALL_ITEMS, 0, null, null);</span>
<a href="#l16.246"></a><span id="l16.246">                     if (items.length &lt; 1) {</span>
<a href="#l16.247"></a><span id="l16.247">                         throw new Components.Exception(&quot;no such item!&quot;);</span>
<a href="#l16.248"></a><span id="l16.248">                     }</span>
<a href="#l16.249"></a><span id="l16.249">                     if (items.length &gt; 1) {</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineminus">-                        this_.notifyError(NS_ERROR_UNEXPECTED,</span>
<a href="#l16.251"></a><span id="l16.251" class="difflineminus">-                                          &quot;unexpected number of items: &quot; + items.length);</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineplus">+                        self.notifyError(NS_ERROR_UNEXPECTED,</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineplus">+                                         &quot;unexpected number of items: &quot; + items.length);</span>
<a href="#l16.254"></a><span id="l16.254">                     }</span>
<a href="#l16.255"></a><span id="l16.255">                     if (listener) {</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineminus">-                        listener.onGetResult(this_.superCalendar, NS_OK,</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineminus">-                                             calIItemBase, log(&quot;getItem(): success. id=&quot; + id, this_),</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineplus">+                        listener.onGetResult(self.superCalendar, NS_OK,</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineplus">+                                             calIItemBase, log(&quot;getItem(): success. id=&quot; + id, self),</span>
<a href="#l16.260"></a><span id="l16.260">                                              items.length, items);</span>
<a href="#l16.261"></a><span id="l16.261">                     }</span>
<a href="#l16.262"></a><span id="l16.262">                     request.execRespFunc(null, items[0]);</span>
<a href="#l16.263"></a><span id="l16.263">                 }</span>
<a href="#l16.264"></a><span id="l16.264">                 if (err) {</span>
<a href="#l16.265"></a><span id="l16.265">                     if (!checkErrorCode(err, calIWcapErrors.WCAP_FETCH_EVENTS_BY_ID_FAILED) &amp;&amp;</span>
<a href="#l16.266"></a><span id="l16.266">                         !checkErrorCode(err, calIWcapErrors.WCAP_COMPONENT_NOT_FOUND)) {</span>
<a href="#l16.267"></a><span id="l16.267">                         throw err;</span>
<a href="#l16.268"></a><span id="l16.268">                     }</span>
<a href="#l16.269"></a><span id="l16.269">                     // try todos:</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineminus">-                    this_.issueNetworkRequest(</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineplus">+                    self.issueNetworkRequest(</span>
<a href="#l16.272"></a><span id="l16.272">                         request,</span>
<a href="#l16.273"></a><span id="l16.273">                         function fetchTodosById_resp(fetcherr, todoRootComp) {</span>
<a href="#l16.274"></a><span id="l16.274">                             if (fetcherr) {</span>
<a href="#l16.275"></a><span id="l16.275">                                 throw fetcherr;</span>
<a href="#l16.276"></a><span id="l16.276">                             }</span>
<a href="#l16.277"></a><span id="l16.277">                             notifyResult(todoRootComp);</span>
<a href="#l16.278"></a><span id="l16.278">                         },</span>
<a href="#l16.279"></a><span id="l16.279">                         stringToIcal, &quot;fetchtodos_by_id&quot;, params, calIWcapCalendar.AC_COMP_READ);</span>
<a href="#l16.280"></a><span id="l16.280" class="difflineat">@@ -1141,25 +1141,25 @@ function getItemFilterParams(itemFilter)</span>
<a href="#l16.281"></a><span id="l16.281"> </span>
<a href="#l16.282"></a><span id="l16.282"> calWcapCalendar.prototype.getItems =</span>
<a href="#l16.283"></a><span id="l16.283"> function calWcapCalendar_getItems(itemFilter, maxResults, rangeStart, rangeEnd, listener) {</span>
<a href="#l16.284"></a><span id="l16.284">     rangeStart = ensureDateTime(rangeStart);</span>
<a href="#l16.285"></a><span id="l16.285">     rangeEnd = ensureDateTime(rangeEnd);</span>
<a href="#l16.286"></a><span id="l16.286">     let zRangeStart = getIcalUTC(rangeStart);</span>
<a href="#l16.287"></a><span id="l16.287">     let zRangeEnd = getIcalUTC(rangeEnd);</span>
<a href="#l16.288"></a><span id="l16.288"> </span>
<a href="#l16.289"></a><span id="l16.289" class="difflineminus">-    let this_ = this;</span>
<a href="#l16.290"></a><span id="l16.290" class="difflineplus">+    let self = this;</span>
<a href="#l16.291"></a><span id="l16.291">     let request = new calWcapRequest(</span>
<a href="#l16.292"></a><span id="l16.292">         function getItems_resp(oprequest, err, data) {</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineminus">-            log(&quot;getItems() complete: &quot; + errorToString(err), this_);</span>
<a href="#l16.294"></a><span id="l16.294" class="difflineminus">-            this_.notifyOperationComplete(listener,</span>
<a href="#l16.295"></a><span id="l16.295" class="difflineminus">-                                          getResultCode(err),</span>
<a href="#l16.296"></a><span id="l16.296" class="difflineminus">-                                          calIOperationListener.GET,</span>
<a href="#l16.297"></a><span id="l16.297" class="difflineminus">-                                          null,</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineminus">-                                          err);</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineplus">+            log(&quot;getItems() complete: &quot; + errorToString(err), self);</span>
<a href="#l16.300"></a><span id="l16.300" class="difflineplus">+            self.notifyOperationComplete(listener,</span>
<a href="#l16.301"></a><span id="l16.301" class="difflineplus">+                                         getResultCode(err),</span>
<a href="#l16.302"></a><span id="l16.302" class="difflineplus">+                                         calIOperationListener.GET,</span>
<a href="#l16.303"></a><span id="l16.303" class="difflineplus">+                                         null,</span>
<a href="#l16.304"></a><span id="l16.304" class="difflineplus">+                                         err);</span>
<a href="#l16.305"></a><span id="l16.305">         },</span>
<a href="#l16.306"></a><span id="l16.306">         log(&quot;getItems():\n\titemFilter=0x&quot; + itemFilter.toString(0x10) +</span>
<a href="#l16.307"></a><span id="l16.307">             &quot;,\n\tmaxResults=&quot; + maxResults +</span>
<a href="#l16.308"></a><span id="l16.308">             &quot;,\n\trangeStart=&quot; + zRangeStart +</span>
<a href="#l16.309"></a><span id="l16.309">             &quot;,\n\trangeEnd=&quot; + zRangeEnd, this));</span>
<a href="#l16.310"></a><span id="l16.310"> </span>
<a href="#l16.311"></a><span id="l16.311">     if (this.aboutToBeUnregistered) {</span>
<a href="#l16.312"></a><span id="l16.312">         // limiting the amount of network traffic while unregistering</span>
<a href="#l16.313"></a><span id="l16.313" class="difflineat">@@ -1215,90 +1215,90 @@ function calWcapCalendar_getItems(itemFi</span>
<a href="#l16.314"></a><span id="l16.314">                                 onResult: function freeBusyListener_onResult(oprequest, result) {</span>
<a href="#l16.315"></a><span id="l16.315">                                     if (!Components.isSuccessCode(oprequest.status)) {</span>
<a href="#l16.316"></a><span id="l16.316">                                         throw oprequest.status;</span>
<a href="#l16.317"></a><span id="l16.317">                                     }</span>
<a href="#l16.318"></a><span id="l16.318">                                     let items = [];</span>
<a href="#l16.319"></a><span id="l16.319">                                     for (let entry of result) {</span>
<a href="#l16.320"></a><span id="l16.320">                                         let item = createEvent();</span>
<a href="#l16.321"></a><span id="l16.321">                                         item.id = g_busyPhantomItemUuidPrefix + getIcalUTC(entry.interval.start);</span>
<a href="#l16.322"></a><span id="l16.322" class="difflineminus">-                                        item.calendar = this_.superCalendar;</span>
<a href="#l16.323"></a><span id="l16.323" class="difflineplus">+                                        item.calendar = self.superCalendar;</span>
<a href="#l16.324"></a><span id="l16.324">                                         item.title = g_busyItemTitle;</span>
<a href="#l16.325"></a><span id="l16.325">                                         item.startDate = entry.interval.start;</span>
<a href="#l16.326"></a><span id="l16.326">                                         item.endDate = entry.interval.end;</span>
<a href="#l16.327"></a><span id="l16.327">                                         item.makeImmutable();</span>
<a href="#l16.328"></a><span id="l16.328">                                         items.push(item);</span>
<a href="#l16.329"></a><span id="l16.329">                                     }</span>
<a href="#l16.330"></a><span id="l16.330" class="difflineminus">-                                    listener.onGetResult(this_.superCalendar, NS_OK, calIItemBase,</span>
<a href="#l16.331"></a><span id="l16.331" class="difflineplus">+                                    listener.onGetResult(self.superCalendar, NS_OK, calIItemBase,</span>
<a href="#l16.332"></a><span id="l16.332">                                                          &quot;getItems()/free-busy&quot;, items.length, items);</span>
<a href="#l16.333"></a><span id="l16.333">                                 }</span>
<a href="#l16.334"></a><span id="l16.334">                             };</span>
<a href="#l16.335"></a><span id="l16.335">                             request.attachSubRequest(</span>
<a href="#l16.336"></a><span id="l16.336" class="difflineminus">-                                this_.session.getFreeBusyIntervals(</span>
<a href="#l16.337"></a><span id="l16.337" class="difflineminus">-                                    this_.calId, rangeStart, rangeEnd, calIFreeBusyInterval.BUSY_ALL,</span>
<a href="#l16.338"></a><span id="l16.338" class="difflineplus">+                                self.session.getFreeBusyIntervals(</span>
<a href="#l16.339"></a><span id="l16.339" class="difflineplus">+                                    self.calId, rangeStart, rangeEnd, calIFreeBusyInterval.BUSY_ALL,</span>
<a href="#l16.340"></a><span id="l16.340">                                     freeBusyListener));</span>
<a href="#l16.341"></a><span id="l16.341">                         }</span>
<a href="#l16.342"></a><span id="l16.342">                     } else {</span>
<a href="#l16.343"></a><span id="l16.343">                         throw err;</span>
<a href="#l16.344"></a><span id="l16.344">                     }</span>
<a href="#l16.345"></a><span id="l16.345">                 } else if (listener) {</span>
<a href="#l16.346"></a><span id="l16.346" class="difflineminus">-                    let items = this_.parseItems(</span>
<a href="#l16.347"></a><span id="l16.347" class="difflineplus">+                    let items = self.parseItems(</span>
<a href="#l16.348"></a><span id="l16.348">                         icalRootComp, itemFilter, maxResults,</span>
<a href="#l16.349"></a><span id="l16.349">                         rangeStart, rangeEnd);</span>
<a href="#l16.350"></a><span id="l16.350"> </span>
<a href="#l16.351"></a><span id="l16.351">                     if (CACHE_LAST_RESULTS &gt; 0) {</span>
<a href="#l16.352"></a><span id="l16.352">                         // auto invalidate after X minutes:</span>
<a href="#l16.353"></a><span id="l16.353" class="difflineminus">-                        if (!this_.m_cachedResultsTimer) {</span>
<a href="#l16.354"></a><span id="l16.354" class="difflineplus">+                        if (!self.m_cachedResultsTimer) {</span>
<a href="#l16.355"></a><span id="l16.355">                             let callback = {</span>
<a href="#l16.356"></a><span id="l16.356">                                 notify: function notify(timer) {</span>
<a href="#l16.357"></a><span id="l16.357" class="difflineminus">-                                    if (!this_.m_cachedResults) {</span>
<a href="#l16.358"></a><span id="l16.358" class="difflineplus">+                                    if (!self.m_cachedResults) {</span>
<a href="#l16.359"></a><span id="l16.359">                                         return;</span>
<a href="#l16.360"></a><span id="l16.360">                                     }</span>
<a href="#l16.361"></a><span id="l16.361">                                     let now = (new Date()).getTime();</span>
<a href="#l16.362"></a><span id="l16.362">                                     // sort out old entries:</span>
<a href="#l16.363"></a><span id="l16.363">                                     let entries = [];</span>
<a href="#l16.364"></a><span id="l16.364" class="difflineminus">-                                    for (let i = 0; i &lt; this_.m_cachedResults.length; ++i) {</span>
<a href="#l16.365"></a><span id="l16.365" class="difflineminus">-                                        let entry = this_.m_cachedResults[i];</span>
<a href="#l16.366"></a><span id="l16.366" class="difflineplus">+                                    for (let i = 0; i &lt; self.m_cachedResults.length; ++i) {</span>
<a href="#l16.367"></a><span id="l16.367" class="difflineplus">+                                        let entry = self.m_cachedResults[i];</span>
<a href="#l16.368"></a><span id="l16.368">                                         if ((now - entry.stamp) &lt; (CACHE_LAST_RESULTS_INVALIDATE * 1000)) {</span>
<a href="#l16.369"></a><span id="l16.369">                                             entries.push(entry);</span>
<a href="#l16.370"></a><span id="l16.370">                                         } else {</span>
<a href="#l16.371"></a><span id="l16.371">                                             log(&quot;invalidating cached entry:\n\trangeStart=&quot; +</span>
<a href="#l16.372"></a><span id="l16.372">                                                 getIcalUTC(entry.rangeStart) + &quot;\n\trangeEnd=&quot; +</span>
<a href="#l16.373"></a><span id="l16.373" class="difflineminus">-                                                getIcalUTC(entry.rangeEnd), this_);</span>
<a href="#l16.374"></a><span id="l16.374" class="difflineplus">+                                                getIcalUTC(entry.rangeEnd), self);</span>
<a href="#l16.375"></a><span id="l16.375">                                         }</span>
<a href="#l16.376"></a><span id="l16.376">                                     }</span>
<a href="#l16.377"></a><span id="l16.377" class="difflineminus">-                                    this_.m_cachedResults = entries;</span>
<a href="#l16.378"></a><span id="l16.378" class="difflineplus">+                                    self.m_cachedResults = entries;</span>
<a href="#l16.379"></a><span id="l16.379">                                 }</span>
<a href="#l16.380"></a><span id="l16.380">                             };</span>
<a href="#l16.381"></a><span id="l16.381">                             // sort out freq:</span>
<a href="#l16.382"></a><span id="l16.382">                             let freq = Math.min(20, // default: 20secs</span>
<a href="#l16.383"></a><span id="l16.383">                                                 Math.max(1, CACHE_LAST_RESULTS_INVALIDATE));</span>
<a href="#l16.384"></a><span id="l16.384" class="difflineminus">-                            log(&quot;cached results sort out timer freq: &quot; + freq, this_);</span>
<a href="#l16.385"></a><span id="l16.385" class="difflineminus">-                            this_.m_cachedResultsTimer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l16.386"></a><span id="l16.386" class="difflineminus">-                                                                   .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l16.387"></a><span id="l16.387" class="difflineminus">-                            this_.m_cachedResultsTimer.initWithCallback(callback, freq * 1000,</span>
<a href="#l16.388"></a><span id="l16.388" class="difflineminus">-                                                                        Components.interfaces.nsITimer.TYPE_REPEATING_SLACK);</span>
<a href="#l16.389"></a><span id="l16.389" class="difflineplus">+                            log(&quot;cached results sort out timer freq: &quot; + freq, self);</span>
<a href="#l16.390"></a><span id="l16.390" class="difflineplus">+                            self.m_cachedResultsTimer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l16.391"></a><span id="l16.391" class="difflineplus">+                                                                  .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l16.392"></a><span id="l16.392" class="difflineplus">+                            self.m_cachedResultsTimer.initWithCallback(callback, freq * 1000,</span>
<a href="#l16.393"></a><span id="l16.393" class="difflineplus">+                                                                       Components.interfaces.nsITimer.TYPE_REPEATING_SLACK);</span>
<a href="#l16.394"></a><span id="l16.394">                         }</span>
<a href="#l16.395"></a><span id="l16.395" class="difflineminus">-                        if (!this_.m_cachedResults) {</span>
<a href="#l16.396"></a><span id="l16.396" class="difflineminus">-                            this_.m_cachedResults = [];</span>
<a href="#l16.397"></a><span id="l16.397" class="difflineplus">+                        if (!self.m_cachedResults) {</span>
<a href="#l16.398"></a><span id="l16.398" class="difflineplus">+                            self.m_cachedResults = [];</span>
<a href="#l16.399"></a><span id="l16.399">                         }</span>
<a href="#l16.400"></a><span id="l16.400">                         let cacheEntry = {</span>
<a href="#l16.401"></a><span id="l16.401">                             stamp: (new Date()).getTime(),</span>
<a href="#l16.402"></a><span id="l16.402">                             itemFilter: itemFilter,</span>
<a href="#l16.403"></a><span id="l16.403">                             rangeStart: (rangeStart ? rangeStart.clone() : null),</span>
<a href="#l16.404"></a><span id="l16.404">                             rangeEnd: (rangeEnd ? rangeEnd.clone() : null),</span>
<a href="#l16.405"></a><span id="l16.405">                             results: items</span>
<a href="#l16.406"></a><span id="l16.406">                         };</span>
<a href="#l16.407"></a><span id="l16.407" class="difflineminus">-                        this_.m_cachedResults.unshift(cacheEntry);</span>
<a href="#l16.408"></a><span id="l16.408" class="difflineminus">-                        if (this_.m_cachedResults.length &gt; CACHE_LAST_RESULTS) {</span>
<a href="#l16.409"></a><span id="l16.409" class="difflineminus">-                            this_.m_cachedResults.length = CACHE_LAST_RESULTS;</span>
<a href="#l16.410"></a><span id="l16.410" class="difflineplus">+                        self.m_cachedResults.unshift(cacheEntry);</span>
<a href="#l16.411"></a><span id="l16.411" class="difflineplus">+                        if (self.m_cachedResults.length &gt; CACHE_LAST_RESULTS) {</span>
<a href="#l16.412"></a><span id="l16.412" class="difflineplus">+                            self.m_cachedResults.length = CACHE_LAST_RESULTS;</span>
<a href="#l16.413"></a><span id="l16.413">                         }</span>
<a href="#l16.414"></a><span id="l16.414">                     }</span>
<a href="#l16.415"></a><span id="l16.415"> </span>
<a href="#l16.416"></a><span id="l16.416" class="difflineminus">-                    listener.onGetResult(this_.superCalendar, NS_OK, calIItemBase, &quot;getItems()&quot;, items.length, items);</span>
<a href="#l16.417"></a><span id="l16.417" class="difflineplus">+                    listener.onGetResult(self.superCalendar, NS_OK, calIItemBase, &quot;getItems()&quot;, items.length, items);</span>
<a href="#l16.418"></a><span id="l16.418">                 }</span>
<a href="#l16.419"></a><span id="l16.419">             },</span>
<a href="#l16.420"></a><span id="l16.420">             stringToIcal, &quot;fetchcomponents_by_range&quot;, params, calIWcapCalendar.AC_COMP_READ);</span>
<a href="#l16.421"></a><span id="l16.421">     } catch (exc) {</span>
<a href="#l16.422"></a><span id="l16.422">         request.execRespFunc(exc);</span>
<a href="#l16.423"></a><span id="l16.423">     }</span>
<a href="#l16.424"></a><span id="l16.424">     return request;</span>
<a href="#l16.425"></a><span id="l16.425"> };</span>
<a href="#l16.426"></a><span id="l16.426" class="difflineat">@@ -1307,30 +1307,30 @@ calWcapCalendar.prototype.offlineStorage</span>
<a href="#l16.427"></a><span id="l16.427"> </span>
<a href="#l16.428"></a><span id="l16.428"> calWcapCalendar.prototype.resetLog =</span>
<a href="#l16.429"></a><span id="l16.429"> function calWcapCalendar_resetLog() {</span>
<a href="#l16.430"></a><span id="l16.430">     this.deleteProperty(&quot;replay.last_stamp&quot;);</span>
<a href="#l16.431"></a><span id="l16.431"> };</span>
<a href="#l16.432"></a><span id="l16.432"> </span>
<a href="#l16.433"></a><span id="l16.433"> calWcapCalendar.prototype.replayChangesOn =</span>
<a href="#l16.434"></a><span id="l16.434"> function calWcapCalendar_replayChangesOn(listener) {</span>
<a href="#l16.435"></a><span id="l16.435" class="difflineminus">-    let this_ = this;</span>
<a href="#l16.436"></a><span id="l16.436" class="difflineplus">+    let self = this;</span>
<a href="#l16.437"></a><span id="l16.437">     let itemFilter = calICalendar.ITEM_FILTER_ALL_ITEMS;</span>
<a href="#l16.438"></a><span id="l16.438">     let dtFrom = getDatetimeFromIcalString(this.getProperty(&quot;replay.last_stamp&quot;));</span>
<a href="#l16.439"></a><span id="l16.439">     let now = getTime(); // new stamp for this sync</span>
<a href="#l16.440"></a><span id="l16.440"> </span>
<a href="#l16.441"></a><span id="l16.441">     let request_ = new calWcapRequest(</span>
<a href="#l16.442"></a><span id="l16.442">         function replayChangesOn_resp(request, err) {</span>
<a href="#l16.443"></a><span id="l16.443">             if (err) {</span>
<a href="#l16.444"></a><span id="l16.444">                 logError(&quot;error replaying changes: &quot; + errorToString(err));</span>
<a href="#l16.445"></a><span id="l16.445" class="difflineminus">-                this_.notifyError(err);</span>
<a href="#l16.446"></a><span id="l16.446" class="difflineplus">+                self.notifyError(err);</span>
<a href="#l16.447"></a><span id="l16.447">             } else {</span>
<a href="#l16.448"></a><span id="l16.448" class="difflineminus">-                log(&quot;replay succeeded.&quot;, this_);</span>
<a href="#l16.449"></a><span id="l16.449" class="difflineminus">-                this_.setProperty(&quot;replay.last_stamp&quot;, getIcalUTC(now));</span>
<a href="#l16.450"></a><span id="l16.450" class="difflineminus">-                log(&quot;new replay stamp: &quot; + getIcalUTC(now), this_);</span>
<a href="#l16.451"></a><span id="l16.451" class="difflineplus">+                log(&quot;replay succeeded.&quot;, self);</span>
<a href="#l16.452"></a><span id="l16.452" class="difflineplus">+                self.setProperty(&quot;replay.last_stamp&quot;, getIcalUTC(now));</span>
<a href="#l16.453"></a><span id="l16.453" class="difflineplus">+                log(&quot;new replay stamp: &quot; + getIcalUTC(now), self);</span>
<a href="#l16.454"></a><span id="l16.454">             }</span>
<a href="#l16.455"></a><span id="l16.455">             if (listener) {</span>
<a href="#l16.456"></a><span id="l16.456">                 listener.onResult(request, null);</span>
<a href="#l16.457"></a><span id="l16.457">             }</span>
<a href="#l16.458"></a><span id="l16.458">         },</span>
<a href="#l16.459"></a><span id="l16.459">         log(&quot;replayChangesOn():\n\titemFilter=0x&quot; + itemFilter.toString(0x10) +</span>
<a href="#l16.460"></a><span id="l16.460">             &quot;\n\tdtFrom=&quot; + getIcalUTC(dtFrom), this));</span>
<a href="#l16.461"></a><span id="l16.461"> </span>
<a href="#l16.462"></a><span id="l16.462" class="difflineat">@@ -1347,43 +1347,43 @@ function calWcapCalendar_replayChangesOn</span>
<a href="#l16.463"></a><span id="l16.463">         let request = new calWcapRequest(</span>
<a href="#l16.464"></a><span id="l16.464">             function netFinishedRespFunc(err, data) {</span>
<a href="#l16.465"></a><span id="l16.465">                 let modifiedIds = {};</span>
<a href="#l16.466"></a><span id="l16.466">                 for (let item of request.m_modifiedItems) {</span>
<a href="#l16.467"></a><span id="l16.467">                     let dtCreated = item.getProperty(&quot;CREATED&quot;);</span>
<a href="#l16.468"></a><span id="l16.468">                     let bAdd = !dtCreated || !dtFrom || dtCreated.compare(dtFrom) &gt;= 0;</span>
<a href="#l16.469"></a><span id="l16.469">                     modifiedIds[item.id] = true;</span>
<a href="#l16.470"></a><span id="l16.470">                     if (bAdd) {</span>
<a href="#l16.471"></a><span id="l16.471" class="difflineminus">-                        log(&quot;replayChangesOn(): new item &quot; + item.id, this_);</span>
<a href="#l16.472"></a><span id="l16.472" class="difflineminus">-                        if (this_.offlineStorage) {</span>
<a href="#l16.473"></a><span id="l16.473" class="difflineminus">-                            this_.offlineStorage.addItem(item, writeListener);</span>
<a href="#l16.474"></a><span id="l16.474" class="difflineplus">+                        log(&quot;replayChangesOn(): new item &quot; + item.id, self);</span>
<a href="#l16.475"></a><span id="l16.475" class="difflineplus">+                        if (self.offlineStorage) {</span>
<a href="#l16.476"></a><span id="l16.476" class="difflineplus">+                            self.offlineStorage.addItem(item, writeListener);</span>
<a href="#l16.477"></a><span id="l16.477">                         }</span>
<a href="#l16.478"></a><span id="l16.478">                     } else {</span>
<a href="#l16.479"></a><span id="l16.479" class="difflineminus">-                        log(&quot;replayChangesOn(): modified item &quot; + item.id, this_);</span>
<a href="#l16.480"></a><span id="l16.480" class="difflineminus">-                        if (this_.offlineStorage) {</span>
<a href="#l16.481"></a><span id="l16.481" class="difflineminus">-                            this_.modifyItem(item, null, writeListener);</span>
<a href="#l16.482"></a><span id="l16.482" class="difflineplus">+                        log(&quot;replayChangesOn(): modified item &quot; + item.id, self);</span>
<a href="#l16.483"></a><span id="l16.483" class="difflineplus">+                        if (self.offlineStorage) {</span>
<a href="#l16.484"></a><span id="l16.484" class="difflineplus">+                            self.modifyItem(item, null, writeListener);</span>
<a href="#l16.485"></a><span id="l16.485">                         }</span>
<a href="#l16.486"></a><span id="l16.486">                     }</span>
<a href="#l16.487"></a><span id="l16.487">                 }</span>
<a href="#l16.488"></a><span id="l16.488">                 for (let item of request.m_deletedItems) {</span>
<a href="#l16.489"></a><span id="l16.489">                     // don't delete anything that has been touched by lastmods:</span>
<a href="#l16.490"></a><span id="l16.490">                     if (modifiedIds[item.id]) {</span>
<a href="#l16.491"></a><span id="l16.491" class="difflineminus">-                        log(&quot;replayChangesOn(): skipping deletion of &quot; + item.id, this_);</span>
<a href="#l16.492"></a><span id="l16.492" class="difflineplus">+                        log(&quot;replayChangesOn(): skipping deletion of &quot; + item.id, self);</span>
<a href="#l16.493"></a><span id="l16.493">                     } else if (isParent(item)) {</span>
<a href="#l16.494"></a><span id="l16.494" class="difflineminus">-                        log(&quot;replayChangesOn(): deleted item &quot; + item.id, this_);</span>
<a href="#l16.495"></a><span id="l16.495" class="difflineminus">-                        if (this_.offlineStorage) {</span>
<a href="#l16.496"></a><span id="l16.496" class="difflineminus">-                            this_.offlineStorage.deleteItem(item, writeListener);</span>
<a href="#l16.497"></a><span id="l16.497" class="difflineplus">+                        log(&quot;replayChangesOn(): deleted item &quot; + item.id, self);</span>
<a href="#l16.498"></a><span id="l16.498" class="difflineplus">+                        if (self.offlineStorage) {</span>
<a href="#l16.499"></a><span id="l16.499" class="difflineplus">+                            self.offlineStorage.deleteItem(item, writeListener);</span>
<a href="#l16.500"></a><span id="l16.500">                         }</span>
<a href="#l16.501"></a><span id="l16.501">                     } else { // modify parent instead of</span>
<a href="#l16.502"></a><span id="l16.502">                              // straight-forward deleteItem(). WTF.</span>
<a href="#l16.503"></a><span id="l16.503">                         let parent = item.parentItem.clone();</span>
<a href="#l16.504"></a><span id="l16.504">                         parent.recurrenceInfo.removeOccurrenceAt(item.recurrenceId);</span>
<a href="#l16.505"></a><span id="l16.505" class="difflineminus">-                        log(&quot;replayChangesOn(): modified parent &quot; + parent.id, this_);</span>
<a href="#l16.506"></a><span id="l16.506" class="difflineminus">-                        if (this_.offlineStorage) {</span>
<a href="#l16.507"></a><span id="l16.507" class="difflineminus">-                            this_.offlineStorage.modifyItem(parent, item, writeListener);</span>
<a href="#l16.508"></a><span id="l16.508" class="difflineplus">+                        log(&quot;replayChangesOn(): modified parent &quot; + parent.id, self);</span>
<a href="#l16.509"></a><span id="l16.509" class="difflineplus">+                        if (self.offlineStorage) {</span>
<a href="#l16.510"></a><span id="l16.510" class="difflineplus">+                            self.offlineStorage.modifyItem(parent, item, writeListener);</span>
<a href="#l16.511"></a><span id="l16.511">                         }</span>
<a href="#l16.512"></a><span id="l16.512">                     }</span>
<a href="#l16.513"></a><span id="l16.513">                 }</span>
<a href="#l16.514"></a><span id="l16.514">             }, &quot;replayChangesOn() netFinishedRespFunc&quot;);</span>
<a href="#l16.515"></a><span id="l16.515">         request_.attachSubRequest(request);</span>
<a href="#l16.516"></a><span id="l16.516"> </span>
<a href="#l16.517"></a><span id="l16.517">         // assure being logged in to calc server times:</span>
<a href="#l16.518"></a><span id="l16.518">         this.session.getSessionId(</span>
<a href="#l16.519"></a><span id="l16.519" class="difflineat">@@ -1391,46 +1391,46 @@ function calWcapCalendar_replayChangesOn</span>
<a href="#l16.520"></a><span id="l16.520">             function getSessionId_resp(err, sessionId) {</span>
<a href="#l16.521"></a><span id="l16.521">                 try {</span>
<a href="#l16.522"></a><span id="l16.522">                     if (err) {</span>
<a href="#l16.523"></a><span id="l16.523">                         throw err;</span>
<a href="#l16.524"></a><span id="l16.524">                     }</span>
<a href="#l16.525"></a><span id="l16.525">                     let params = &quot;&amp;relativealarm=1&amp;compressed=1&amp;recurring=1&quot; +</span>
<a href="#l16.526"></a><span id="l16.526">                                  &quot;&amp;emailorcalid=1&amp;fmt-out=text%2Fcalendar&quot;;</span>
<a href="#l16.527"></a><span id="l16.527">                     if (dtFrom) {</span>
<a href="#l16.528"></a><span id="l16.528" class="difflineminus">-                        dtFrom = this_.session.getServerTime(dtFrom);</span>
<a href="#l16.529"></a><span id="l16.529" class="difflineplus">+                        dtFrom = self.session.getServerTime(dtFrom);</span>
<a href="#l16.530"></a><span id="l16.530">                     }</span>
<a href="#l16.531"></a><span id="l16.531">                     params += &quot;&amp;dtstart=&quot; + getIcalUTC(dtFrom);</span>
<a href="#l16.532"></a><span id="l16.532" class="difflineminus">-                    params += &quot;&amp;dtend=&quot; + getIcalUTC(this_.session.getServerTime(now));</span>
<a href="#l16.533"></a><span id="l16.533" class="difflineplus">+                    params += &quot;&amp;dtend=&quot; + getIcalUTC(self.session.getServerTime(now));</span>
<a href="#l16.534"></a><span id="l16.534"> </span>
<a href="#l16.535"></a><span id="l16.535" class="difflineminus">-                    log(&quot;replayChangesOn(): getting last modifications...&quot;, this_);</span>
<a href="#l16.536"></a><span id="l16.536" class="difflineminus">-                    this_.issueNetworkRequest(</span>
<a href="#l16.537"></a><span id="l16.537" class="difflineplus">+                    log(&quot;replayChangesOn(): getting last modifications...&quot;, self);</span>
<a href="#l16.538"></a><span id="l16.538" class="difflineplus">+                    self.issueNetworkRequest(</span>
<a href="#l16.539"></a><span id="l16.539">                         request,</span>
<a href="#l16.540"></a><span id="l16.540">                         function modifiedNetResp(fetcherr, icalRootComp) {</span>
<a href="#l16.541"></a><span id="l16.541">                             if (fetcherr) {</span>
<a href="#l16.542"></a><span id="l16.542">                                 throw fetcherr;</span>
<a href="#l16.543"></a><span id="l16.543">                             }</span>
<a href="#l16.544"></a><span id="l16.544" class="difflineminus">-                            request.m_modifiedItems = this_.parseItems(icalRootComp,</span>
<a href="#l16.545"></a><span id="l16.545" class="difflineminus">-                                                                       calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l16.546"></a><span id="l16.546" class="difflineminus">-                                                                       0, null, null);</span>
<a href="#l16.547"></a><span id="l16.547" class="difflineplus">+                            request.m_modifiedItems = self.parseItems(icalRootComp,</span>
<a href="#l16.548"></a><span id="l16.548" class="difflineplus">+                                                                      calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l16.549"></a><span id="l16.549" class="difflineplus">+                                                                      0, null, null);</span>
<a href="#l16.550"></a><span id="l16.550">                         },</span>
<a href="#l16.551"></a><span id="l16.551">                         stringToIcal, &quot;fetchcomponents_by_lastmod&quot;,</span>
<a href="#l16.552"></a><span id="l16.552">                         params + getItemFilterParams(itemFilter),</span>
<a href="#l16.553"></a><span id="l16.553">                         calIWcapCalendar.AC_COMP_READ);</span>
<a href="#l16.554"></a><span id="l16.554"> </span>
<a href="#l16.555"></a><span id="l16.555" class="difflineminus">-                    log(&quot;replayChangesOn(): getting deleted items...&quot;, this_);</span>
<a href="#l16.556"></a><span id="l16.556" class="difflineminus">-                    this_.issueNetworkRequest(</span>
<a href="#l16.557"></a><span id="l16.557" class="difflineplus">+                    log(&quot;replayChangesOn(): getting deleted items...&quot;, self);</span>
<a href="#l16.558"></a><span id="l16.558" class="difflineplus">+                    self.issueNetworkRequest(</span>
<a href="#l16.559"></a><span id="l16.559">                         request,</span>
<a href="#l16.560"></a><span id="l16.560">                         function modifiedNetResp(fetcherr, icalRootComp) {</span>
<a href="#l16.561"></a><span id="l16.561">                             if (fetcherr) {</span>
<a href="#l16.562"></a><span id="l16.562">                                 throw fetcherr;</span>
<a href="#l16.563"></a><span id="l16.563">                             }</span>
<a href="#l16.564"></a><span id="l16.564" class="difflineminus">-                            request.m_deletedItems = this_.parseItems(icalRootComp,</span>
<a href="#l16.565"></a><span id="l16.565" class="difflineminus">-                                                                      calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l16.566"></a><span id="l16.566" class="difflineminus">-                                                                      0, null, null);</span>
<a href="#l16.567"></a><span id="l16.567" class="difflineplus">+                            request.m_deletedItems = self.parseItems(icalRootComp,</span>
<a href="#l16.568"></a><span id="l16.568" class="difflineplus">+                                                                     calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l16.569"></a><span id="l16.569" class="difflineplus">+                                                                     0, null, null);</span>
<a href="#l16.570"></a><span id="l16.570">                         },</span>
<a href="#l16.571"></a><span id="l16.571">                         stringToIcal, &quot;fetch_deletedcomponents&quot;,</span>
<a href="#l16.572"></a><span id="l16.572">                         params + getItemFilterParams(itemFilter &amp; // only component types</span>
<a href="#l16.573"></a><span id="l16.573">                                                      calICalendar.ITEM_FILTER_TYPE_ALL),</span>
<a href="#l16.574"></a><span id="l16.574">                         calIWcapCalendar.AC_COMP_READ);</span>
<a href="#l16.575"></a><span id="l16.575">                 } catch (exc) {</span>
<a href="#l16.576"></a><span id="l16.576">                     request.execRespFunc(exc);</span>
<a href="#l16.577"></a><span id="l16.577">                 }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -216,175 +216,175 @@ calWcapSession.prototype = {</span>
<a href="#l17.4"></a><span id="l17.4">             this.m_sessionId = null; // invalidate for relogin</span>
<a href="#l17.5"></a><span id="l17.5"> </span>
<a href="#l17.6"></a><span id="l17.6">             if (timedOutSessionId) {</span>
<a href="#l17.7"></a><span id="l17.7">                 log(&quot;reconnecting due to session timeout...&quot;, this);</span>
<a href="#l17.8"></a><span id="l17.8">                 getFreeBusyService().removeProvider(this);</span>
<a href="#l17.9"></a><span id="l17.9">                 getCalendarSearchService().removeProvider(this);</span>
<a href="#l17.10"></a><span id="l17.10">             }</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-            let this_ = this;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+            let self = this;</span>
<a href="#l17.14"></a><span id="l17.14">             this.getSessionId_(null, // don't couple to parent request parent may be cancelled</span>
<a href="#l17.15"></a><span id="l17.15">                                function getSessionId_resp_(err, sessionId) {</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-                                   log(&quot;getSessionId_resp_(): &quot; + sessionId, this_);</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+                                   log(&quot;getSessionId_resp_(): &quot; + sessionId, self);</span>
<a href="#l17.18"></a><span id="l17.18">                                    if (!err) {</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-                                       this_.m_sessionId = sessionId;</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-                                       getFreeBusyService().addProvider(this_);</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-                                       getCalendarSearchService().addProvider(this_);</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+                                       self.m_sessionId = sessionId;</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+                                       getFreeBusyService().addProvider(self);</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+                                       getCalendarSearchService().addProvider(self);</span>
<a href="#l17.25"></a><span id="l17.25">                                    }</span>
<a href="#l17.26"></a><span id="l17.26"> </span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-                                   let queue = this_.m_loginQueue;</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-                                   this_.m_loginLock = false;</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-                                   this_.m_loginQueue = [];</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-                                   log(&quot;unlocked login queue.&quot;, this_);</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+                                   let queue = self.m_loginQueue;</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+                                   self.m_loginLock = false;</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+                                   self.m_loginQueue = [];</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+                                   log(&quot;unlocked login queue.&quot;, self);</span>
<a href="#l17.35"></a><span id="l17.35"> </span>
<a href="#l17.36"></a><span id="l17.36">                                    function getSessionId_exec(func) {</span>
<a href="#l17.37"></a><span id="l17.37">                                        try {</span>
<a href="#l17.38"></a><span id="l17.38">                                            func(err, sessionId);</span>
<a href="#l17.39"></a><span id="l17.39">                                        } catch (exc) { // unexpected</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-                                           this_.notifyError(exc);</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+                                           self.notifyError(exc);</span>
<a href="#l17.42"></a><span id="l17.42">                                        }</span>
<a href="#l17.43"></a><span id="l17.43">                                    }</span>
<a href="#l17.44"></a><span id="l17.44">                                    // answer first request:</span>
<a href="#l17.45"></a><span id="l17.45">                                    getSessionId_exec(respFunc);</span>
<a href="#l17.46"></a><span id="l17.46">                                    // and any remaining:</span>
<a href="#l17.47"></a><span id="l17.47">                                    queue.forEach(getSessionId_exec);</span>
<a href="#l17.48"></a><span id="l17.48">                                });</span>
<a href="#l17.49"></a><span id="l17.49">         }</span>
<a href="#l17.50"></a><span id="l17.50">     },</span>
<a href="#l17.51"></a><span id="l17.51"> </span>
<a href="#l17.52"></a><span id="l17.52">     // this is a server limit for recurrencies; default is 60</span>
<a href="#l17.53"></a><span id="l17.53">     recurrenceBound: 60,</span>
<a href="#l17.54"></a><span id="l17.54"> </span>
<a href="#l17.55"></a><span id="l17.55">     getSessionId_: function calWcapSession_getSessionId_(request, respFunc) {</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-        let this_ = this;</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+        let self = this;</span>
<a href="#l17.58"></a><span id="l17.58">         this.checkServerVersion(</span>
<a href="#l17.59"></a><span id="l17.59">             request,</span>
<a href="#l17.60"></a><span id="l17.60">             // probe whether server is accessible and responds:</span>
<a href="#l17.61"></a><span id="l17.61">             function checkServerVersion_resp(err) {</span>
<a href="#l17.62"></a><span id="l17.62">                 if (err) {</span>
<a href="#l17.63"></a><span id="l17.63">                     respFunc(err);</span>
<a href="#l17.64"></a><span id="l17.64">                     return;</span>
<a href="#l17.65"></a><span id="l17.65">                 }</span>
<a href="#l17.66"></a><span id="l17.66">                 // lookup password manager, then try login or prompt/login:</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineminus">-                log(&quot;attempting to get a session id for &quot; + this_.sessionUri.spec, this_);</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+                log(&quot;attempting to get a session id for &quot; + self.sessionUri.spec, self);</span>
<a href="#l17.69"></a><span id="l17.69"> </span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-                if (!this_.sessionUri.schemeIs(&quot;https&quot;) &amp;&amp;</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-                    !confirmInsecureLogin(this_.sessionUri)) {</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-                    log(&quot;user rejected insecure login on &quot; + this_.sessionUri.spec, this_);</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+                if (!self.sessionUri.schemeIs(&quot;https&quot;) &amp;&amp;</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+                    !confirmInsecureLogin(self.sessionUri)) {</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+                    log(&quot;user rejected insecure login on &quot; + self.sessionUri.spec, self);</span>
<a href="#l17.76"></a><span id="l17.76">                     respFunc(new Components.Exception(errorToString(calIWcapErrors.WCAP_LOGIN_FAILED),</span>
<a href="#l17.77"></a><span id="l17.77">                                                       calIWcapErrors.WCAP_LOGIN_FAILED));</span>
<a href="#l17.78"></a><span id="l17.78">                     return;</span>
<a href="#l17.79"></a><span id="l17.79">                 }</span>
<a href="#l17.80"></a><span id="l17.80"> </span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-                let outUser = { value: this_.credentials.userId };</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineminus">-                let outPW = { value: this_.credentials.pw };</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+                let outUser = { value: self.credentials.userId };</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+                let outPW = { value: self.credentials.pw };</span>
<a href="#l17.85"></a><span id="l17.85">                 let outSavePW = { value: false };</span>
<a href="#l17.86"></a><span id="l17.86"> </span>
<a href="#l17.87"></a><span id="l17.87">                 if (outUser.value &amp;&amp; !outPW.value) { // lookup pw manager</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineminus">-                    log(&quot;looking in pw db for: &quot; + this_.uri.spec, this_);</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineminus">-                    cal.auth.passwordManagerGet(outUser.value, outPW, this_.uri.spec, &quot;wcap login&quot;);</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+                    log(&quot;looking in pw db for: &quot; + self.uri.spec, self);</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+                    cal.auth.passwordManagerGet(outUser.value, outPW, self.uri.spec, &quot;wcap login&quot;);</span>
<a href="#l17.92"></a><span id="l17.92">                 }</span>
<a href="#l17.93"></a><span id="l17.93"> </span>
<a href="#l17.94"></a><span id="l17.94">                 function promptAndLoginLoop_resp(loginerr, sessionId) {</span>
<a href="#l17.95"></a><span id="l17.95">                     if (checkErrorCode(loginerr, calIWcapErrors.WCAP_LOGIN_FAILED)) {</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineminus">-                        log(&quot;prompting for [user/]pw...&quot;, this_);</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+                        log(&quot;prompting for [user/]pw...&quot;, self);</span>
<a href="#l17.98"></a><span id="l17.98">                         if (cal.auth.getCredentials(cal.calGetString(&quot;wcap&quot;, &quot;loginDialog.label&quot;),</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineminus">-                                                    this_.sessionUri.hostPort,</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineplus">+                                                    self.sessionUri.hostPort,</span>
<a href="#l17.101"></a><span id="l17.101">                                                     outUser,</span>
<a href="#l17.102"></a><span id="l17.102">                                                     outPW,</span>
<a href="#l17.103"></a><span id="l17.103">                                                     outSavePW,</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-                                                    this_.credentials.userId != null)) {</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineminus">-                            this_.login(request, promptAndLoginLoop_resp,</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineminus">-                                        outUser.value, outPW.value);</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+                                                    self.credentials.userId != null)) {</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+                            self.login(request, promptAndLoginLoop_resp,</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+                                       outUser.value, outPW.value);</span>
<a href="#l17.110"></a><span id="l17.110">                         } else {</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineminus">-                            log(&quot;login prompt cancelled.&quot;, this_);</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineminus">-                            this_.defaultCalendar.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineminus">-                            this_.defaultCalendar.setProperty(&quot;auto-enabled&quot;, true);</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineplus">+                            log(&quot;login prompt cancelled.&quot;, self);</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineplus">+                            self.defaultCalendar.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+                            self.defaultCalendar.setProperty(&quot;auto-enabled&quot;, true);</span>
<a href="#l17.117"></a><span id="l17.117">                             respFunc(new Components.Exception(errorToString(calIWcapErrors.WCAP_LOGIN_FAILED),</span>
<a href="#l17.118"></a><span id="l17.118">                                                               calIWcapErrors.WCAP_LOGIN_FAILED));</span>
<a href="#l17.119"></a><span id="l17.119">                         }</span>
<a href="#l17.120"></a><span id="l17.120">                     } else if (loginerr) {</span>
<a href="#l17.121"></a><span id="l17.121">                         respFunc(loginerr);</span>
<a href="#l17.122"></a><span id="l17.122">                     } else {</span>
<a href="#l17.123"></a><span id="l17.123">                         if (outSavePW.value) {</span>
<a href="#l17.124"></a><span id="l17.124">                             // so try to remove old pw from db first:</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineminus">-                            cal.auth.passwordManagerSave(outUser.value, outPW.value, this_.uri.spec, &quot;wcap login&quot;);</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineplus">+                            cal.auth.passwordManagerSave(outUser.value, outPW.value, self.uri.spec, &quot;wcap login&quot;);</span>
<a href="#l17.127"></a><span id="l17.127">                         }</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineminus">-                        this_.credentials.userId = outUser.value;</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineminus">-                        this_.credentials.pw = outPW.value;</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineminus">-                        this_.setupSession(sessionId,</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineminus">-                                           request,</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineminus">-                                           function setupSession_resp(setuperr) {</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineminus">-                                               respFunc(setuperr, sessionId);</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineminus">-                                           });</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineplus">+                        self.credentials.userId = outUser.value;</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+                        self.credentials.pw = outPW.value;</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+                        self.setupSession(sessionId,</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineplus">+                                          request,</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+                                          function setupSession_resp(setuperr) {</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineplus">+                                              respFunc(setuperr, sessionId);</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineplus">+                                          });</span>
<a href="#l17.142"></a><span id="l17.142">                     }</span>
<a href="#l17.143"></a><span id="l17.143">                 }</span>
<a href="#l17.144"></a><span id="l17.144"> </span>
<a href="#l17.145"></a><span id="l17.145">                 if (outPW.value) {</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineminus">-                    this_.login(request, promptAndLoginLoop_resp, outUser.value, outPW.value);</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineplus">+                    self.login(request, promptAndLoginLoop_resp, outUser.value, outPW.value);</span>
<a href="#l17.148"></a><span id="l17.148">                 } else {</span>
<a href="#l17.149"></a><span id="l17.149">                     promptAndLoginLoop_resp(calIWcapErrors.WCAP_LOGIN_FAILED);</span>
<a href="#l17.150"></a><span id="l17.150">                 }</span>
<a href="#l17.151"></a><span id="l17.151">             });</span>
<a href="#l17.152"></a><span id="l17.152">     },</span>
<a href="#l17.153"></a><span id="l17.153"> </span>
<a href="#l17.154"></a><span id="l17.154">     login: function calWcapSession_login(request, respFunc, user, pw) {</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineminus">-        let this_ = this;</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineplus">+        let self = this;</span>
<a href="#l17.157"></a><span id="l17.157">         issueNetworkRequest(</span>
<a href="#l17.158"></a><span id="l17.158">             request,</span>
<a href="#l17.159"></a><span id="l17.159">             function netResp(err, str) {</span>
<a href="#l17.160"></a><span id="l17.160">                 let sessionId;</span>
<a href="#l17.161"></a><span id="l17.161">                 try {</span>
<a href="#l17.162"></a><span id="l17.162">                     if (err) {</span>
<a href="#l17.163"></a><span id="l17.163">                         throw err;</span>
<a href="#l17.164"></a><span id="l17.164">                     }</span>
<a href="#l17.165"></a><span id="l17.165">                     // currently, xml parsing at an early stage during</span>
<a href="#l17.166"></a><span id="l17.166">                     // process startup does not work reliably, so use</span>
<a href="#l17.167"></a><span id="l17.167">                     // libical parsing for now:</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineminus">-                    let icalRootComp = stringToIcal(this_, str);</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineplus">+                    let icalRootComp = stringToIcal(self, str);</span>
<a href="#l17.170"></a><span id="l17.170">                     let prop = icalRootComp.getFirstProperty(&quot;X-NSCP-WCAP-SESSION-ID&quot;);</span>
<a href="#l17.171"></a><span id="l17.171">                     if (!prop) {</span>
<a href="#l17.172"></a><span id="l17.172">                         throw new Components.Exception(&quot;missing X-NSCP-WCAP-SESSION-ID in\n&quot; + str);</span>
<a href="#l17.173"></a><span id="l17.173">                     }</span>
<a href="#l17.174"></a><span id="l17.174">                     sessionId = prop.value;</span>
<a href="#l17.175"></a><span id="l17.175">                     prop = icalRootComp.getFirstProperty(&quot;X-NSCP-RECURRENCE-BOUND&quot;);</span>
<a href="#l17.176"></a><span id="l17.176">                     if (prop) {</span>
<a href="#l17.177"></a><span id="l17.177">                         let val = parseInt(prop.value, 10);</span>
<a href="#l17.178"></a><span id="l17.178">                         if (!isNaN(val)) {</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineminus">-                            this_.recurrenceBound = val;</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineminus">-                            log(&quot;X-NSCP-RECURRENCE-BOUND:&quot; + this_.recurrenceBound);</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineplus">+                            self.recurrenceBound = val;</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineplus">+                            log(&quot;X-NSCP-RECURRENCE-BOUND:&quot; + self.recurrenceBound);</span>
<a href="#l17.183"></a><span id="l17.183">                         }</span>
<a href="#l17.184"></a><span id="l17.184">                     }</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineminus">-                    log(&quot;login succeeded: &quot; + sessionId, this_);</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineplus">+                    log(&quot;login succeeded: &quot; + sessionId, self);</span>
<a href="#l17.187"></a><span id="l17.187">                 } catch (exc) {</span>
<a href="#l17.188"></a><span id="l17.188">                     err = exc;</span>
<a href="#l17.189"></a><span id="l17.189">                     if (checkErrorCode(err, calIWcapErrors.WCAP_LOGIN_FAILED)) {</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineminus">-                        log(&quot;error: &quot; + errorToString(exc), this_); // log login failure</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineplus">+                        log(&quot;error: &quot; + errorToString(exc), self); // log login failure</span>
<a href="#l17.192"></a><span id="l17.192">                     } else if (getErrorModule(err) == NS_ERROR_MODULE_NETWORK) {</span>
<a href="#l17.193"></a><span id="l17.193">                         // server seems unavailable:</span>
<a href="#l17.194"></a><span id="l17.194">                         err = new Components.Exception(cal.calGetString(&quot;wcap&quot;, &quot;accessingServerFailedError.text&quot;,</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineminus">-                                                                        [this_.sessionUri.hostPort]), exc);</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineplus">+                                                                        [self.sessionUri.hostPort]), exc);</span>
<a href="#l17.197"></a><span id="l17.197">                     }</span>
<a href="#l17.198"></a><span id="l17.198">                 }</span>
<a href="#l17.199"></a><span id="l17.199">                 respFunc(err, sessionId);</span>
<a href="#l17.200"></a><span id="l17.200">             },</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineminus">-            this_.sessionUri.spec + &quot;login.wcap?fmt-out=text%2Fcalendar&amp;user=&quot; +</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineplus">+            self.sessionUri.spec + &quot;login.wcap?fmt-out=text%2Fcalendar&amp;user=&quot; +</span>
<a href="#l17.203"></a><span id="l17.203">             encodeURIComponent(user) + &quot;&amp;password=&quot; + encodeURIComponent(pw),</span>
<a href="#l17.204"></a><span id="l17.204">             false /* no logging */);</span>
<a href="#l17.205"></a><span id="l17.205">     },</span>
<a href="#l17.206"></a><span id="l17.206"> </span>
<a href="#l17.207"></a><span id="l17.207">     logout: function calWcapSession_logout(listener) {</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineminus">-        let this_ = this;</span>
<a href="#l17.209"></a><span id="l17.209" class="difflineplus">+        let self = this;</span>
<a href="#l17.210"></a><span id="l17.210">         let request = new calWcapRequest(</span>
<a href="#l17.211"></a><span id="l17.211">             function logout_resp(oprequest, err) {</span>
<a href="#l17.212"></a><span id="l17.212">                 if (err) {</span>
<a href="#l17.213"></a><span id="l17.213" class="difflineminus">-                    logError(err, this_);</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineplus">+                    logError(err, self);</span>
<a href="#l17.215"></a><span id="l17.215">                 } else {</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineminus">-                    log(&quot;logout succeeded.&quot;, this_);</span>
<a href="#l17.217"></a><span id="l17.217" class="difflineplus">+                    log(&quot;logout succeeded.&quot;, self);</span>
<a href="#l17.218"></a><span id="l17.218">                 }</span>
<a href="#l17.219"></a><span id="l17.219">                 if (listener) {</span>
<a href="#l17.220"></a><span id="l17.220">                     listener.onResult(oprequest, null);</span>
<a href="#l17.221"></a><span id="l17.221">                 }</span>
<a href="#l17.222"></a><span id="l17.222">             },</span>
<a href="#l17.223"></a><span id="l17.223">             log(&quot;logout&quot;, this));</span>
<a href="#l17.224"></a><span id="l17.224"> </span>
<a href="#l17.225"></a><span id="l17.225">         let url = null;</span>
<a href="#l17.226"></a><span id="l17.226" class="difflineat">@@ -402,58 +402,58 @@ calWcapSession.prototype = {</span>
<a href="#l17.227"></a><span id="l17.227">         this.m_credentials = null;</span>
<a href="#l17.228"></a><span id="l17.228"> </span>
<a href="#l17.229"></a><span id="l17.229">         if (url) {</span>
<a href="#l17.230"></a><span id="l17.230">             issueNetworkRequest(request,</span>
<a href="#l17.231"></a><span id="l17.231">                                 function netResp(err, str) {</span>
<a href="#l17.232"></a><span id="l17.232">                                     if (err) {</span>
<a href="#l17.233"></a><span id="l17.233">                                         throw err;</span>
<a href="#l17.234"></a><span id="l17.234">                                     }</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineminus">-                                    stringToXml(this_, str, -1 /* logout successfull */);</span>
<a href="#l17.236"></a><span id="l17.236" class="difflineplus">+                                    stringToXml(self, str, -1 /* logout successfull */);</span>
<a href="#l17.237"></a><span id="l17.237">                                 }, url);</span>
<a href="#l17.238"></a><span id="l17.238">         } else {</span>
<a href="#l17.239"></a><span id="l17.239">             request.execRespFunc();</span>
<a href="#l17.240"></a><span id="l17.240">         }</span>
<a href="#l17.241"></a><span id="l17.241">         return request;</span>
<a href="#l17.242"></a><span id="l17.242">     },</span>
<a href="#l17.243"></a><span id="l17.243"> </span>
<a href="#l17.244"></a><span id="l17.244">     checkServerVersion: function calWcapSession_checkServerVersion(request, respFunc) {</span>
<a href="#l17.245"></a><span id="l17.245">         // currently, xml parsing at an early stage during process startup</span>
<a href="#l17.246"></a><span id="l17.246">         // does not work reliably, so use libical:</span>
<a href="#l17.247"></a><span id="l17.247" class="difflineminus">-        let this_ = this;</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineplus">+        let self = this;</span>
<a href="#l17.249"></a><span id="l17.249">         issueNetworkRequest(</span>
<a href="#l17.250"></a><span id="l17.250">             request,</span>
<a href="#l17.251"></a><span id="l17.251">             function netResp(err, str) {</span>
<a href="#l17.252"></a><span id="l17.252">                 try {</span>
<a href="#l17.253"></a><span id="l17.253">                     let icalRootComp;</span>
<a href="#l17.254"></a><span id="l17.254">                     if (!err) {</span>
<a href="#l17.255"></a><span id="l17.255">                         try {</span>
<a href="#l17.256"></a><span id="l17.256" class="difflineminus">-                            icalRootComp = stringToIcal(this_, str);</span>
<a href="#l17.257"></a><span id="l17.257" class="difflineplus">+                            icalRootComp = stringToIcal(self, str);</span>
<a href="#l17.258"></a><span id="l17.258">                         } catch (exc) {</span>
<a href="#l17.259"></a><span id="l17.259">                             err = exc;</span>
<a href="#l17.260"></a><span id="l17.260">                         }</span>
<a href="#l17.261"></a><span id="l17.261">                     }</span>
<a href="#l17.262"></a><span id="l17.262">                     if (err) {</span>
<a href="#l17.263"></a><span id="l17.263">                         if (checkErrorCode(err, calIErrors.OPERATION_CANCELLED)) {</span>
<a href="#l17.264"></a><span id="l17.264">                             throw err;</span>
<a href="#l17.265"></a><span id="l17.265">                         } else { // soft error; request denied etc.</span>
<a href="#l17.266"></a><span id="l17.266">                                  // map into localized message:</span>
<a href="#l17.267"></a><span id="l17.267">                             throw new Components.Exception(cal.calGetString(&quot;wcap&quot;, &quot;accessingServerFailedError.text&quot;,</span>
<a href="#l17.268"></a><span id="l17.268" class="difflineminus">-                                                                            [this_.sessionUri.hostPort]),</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineplus">+                                                                            [self.sessionUri.hostPort]),</span>
<a href="#l17.270"></a><span id="l17.270">                                                            calIWcapErrors.WCAP_LOGIN_FAILED);</span>
<a href="#l17.271"></a><span id="l17.271">                         }</span>
<a href="#l17.272"></a><span id="l17.272">                     }</span>
<a href="#l17.273"></a><span id="l17.273">                     let prop = icalRootComp.getFirstProperty(&quot;X-NSCP-WCAPVERSION&quot;);</span>
<a href="#l17.274"></a><span id="l17.274">                     if (!prop) {</span>
<a href="#l17.275"></a><span id="l17.275">                         throw new Components.Exception(&quot;missing X-NSCP-WCAPVERSION!&quot;);</span>
<a href="#l17.276"></a><span id="l17.276">                     }</span>
<a href="#l17.277"></a><span id="l17.277">                     let wcapVersion = parseInt(prop.value, 10);</span>
<a href="#l17.278"></a><span id="l17.278">                     if (wcapVersion &lt; 3) {</span>
<a href="#l17.279"></a><span id="l17.279">                         let strVers = prop.value;</span>
<a href="#l17.280"></a><span id="l17.280" class="difflineminus">-                        let vars = [this_.sessionUri.hostPort];</span>
<a href="#l17.281"></a><span id="l17.281" class="difflineplus">+                        let vars = [self.sessionUri.hostPort];</span>
<a href="#l17.282"></a><span id="l17.282">                         prop = icalRootComp.getFirstProperty(&quot;PRODID&quot;);</span>
<a href="#l17.283"></a><span id="l17.283">                         vars.push(prop ? prop.value : &quot;&lt;unknown&gt;&quot;);</span>
<a href="#l17.284"></a><span id="l17.284">                         prop = icalRootComp.getFirstProperty(&quot;X-NSCP-SERVERVERSION&quot;);</span>
<a href="#l17.285"></a><span id="l17.285">                         vars.push(prop ? prop.value : &quot;&lt;unknown&gt;&quot;);</span>
<a href="#l17.286"></a><span id="l17.286">                         vars.push(strVers);</span>
<a href="#l17.287"></a><span id="l17.287"> </span>
<a href="#l17.288"></a><span id="l17.288">                         let prompt = Services.ww.getNewPrompter(null);</span>
<a href="#l17.289"></a><span id="l17.289">                         let labelText = cal.calGetString(&quot;wcap&quot;, &quot;insufficientWcapVersionConfirmation.label&quot;);</span>
<a href="#l17.290"></a><span id="l17.290" class="difflineat">@@ -462,107 +462,107 @@ calWcapSession.prototype = {</span>
<a href="#l17.291"></a><span id="l17.291">                             throw new Components.Exception(labelText, calIWcapErrors.WCAP_LOGIN_FAILED);</span>
<a href="#l17.292"></a><span id="l17.292">                         }</span>
<a href="#l17.293"></a><span id="l17.293">                     }</span>
<a href="#l17.294"></a><span id="l17.294">                 } catch (exc) {</span>
<a href="#l17.295"></a><span id="l17.295">                     err = exc;</span>
<a href="#l17.296"></a><span id="l17.296">                 }</span>
<a href="#l17.297"></a><span id="l17.297">                 respFunc(err);</span>
<a href="#l17.298"></a><span id="l17.298">             },</span>
<a href="#l17.299"></a><span id="l17.299" class="difflineminus">-            this_.sessionUri.spec + &quot;version.wcap?fmt-out=text%2Fcalendar&quot;);</span>
<a href="#l17.300"></a><span id="l17.300" class="difflineplus">+            self.sessionUri.spec + &quot;version.wcap?fmt-out=text%2Fcalendar&quot;);</span>
<a href="#l17.301"></a><span id="l17.301">     },</span>
<a href="#l17.302"></a><span id="l17.302"> </span>
<a href="#l17.303"></a><span id="l17.303">     setupSession: function calWcapSession_setupSession(sessionId, request_, respFunc) {</span>
<a href="#l17.304"></a><span id="l17.304" class="difflineminus">-        let this_ = this;</span>
<a href="#l17.305"></a><span id="l17.305" class="difflineplus">+        let self = this;</span>
<a href="#l17.306"></a><span id="l17.306">         let request = new calWcapRequest(</span>
<a href="#l17.307"></a><span id="l17.307">             function setupSession_resp(oprequest, err) {</span>
<a href="#l17.308"></a><span id="l17.308" class="difflineminus">-                log(&quot;setupSession_resp finished: &quot; + errorToString(err), this_);</span>
<a href="#l17.309"></a><span id="l17.309" class="difflineplus">+                log(&quot;setupSession_resp finished: &quot; + errorToString(err), self);</span>
<a href="#l17.310"></a><span id="l17.310">                 respFunc(err);</span>
<a href="#l17.311"></a><span id="l17.311">             },</span>
<a href="#l17.312"></a><span id="l17.312">             log(&quot;setupSession&quot;, this));</span>
<a href="#l17.313"></a><span id="l17.313">         if (request_) {</span>
<a href="#l17.314"></a><span id="l17.314">             request_.attachSubRequest(request);</span>
<a href="#l17.315"></a><span id="l17.315">         }</span>
<a href="#l17.316"></a><span id="l17.316"> </span>
<a href="#l17.317"></a><span id="l17.317">         request.lockPending();</span>
<a href="#l17.318"></a><span id="l17.318">         try {</span>
<a href="#l17.319"></a><span id="l17.319">             this.issueNetworkRequest_(</span>
<a href="#l17.320"></a><span id="l17.320">                 request,</span>
<a href="#l17.321"></a><span id="l17.321">                 function userprefs_resp(err, data) {</span>
<a href="#l17.322"></a><span id="l17.322">                     if (err) {</span>
<a href="#l17.323"></a><span id="l17.323">                         throw err;</span>
<a href="#l17.324"></a><span id="l17.324">                     }</span>
<a href="#l17.325"></a><span id="l17.325" class="difflineminus">-                    this_.credentials.userPrefs = data;</span>
<a href="#l17.326"></a><span id="l17.326" class="difflineminus">-                    log(&quot;installed user prefs.&quot;, this_);</span>
<a href="#l17.327"></a><span id="l17.327" class="difflineplus">+                    self.credentials.userPrefs = data;</span>
<a href="#l17.328"></a><span id="l17.328" class="difflineplus">+                    log(&quot;installed user prefs.&quot;, self);</span>
<a href="#l17.329"></a><span id="l17.329"> </span>
<a href="#l17.330"></a><span id="l17.330">                     // get calprops for all registered calendars:</span>
<a href="#l17.331"></a><span id="l17.331" class="difflineminus">-                    let cals = this_.getRegisteredCalendars(true);</span>
<a href="#l17.332"></a><span id="l17.332" class="difflineplus">+                    let cals = self.getRegisteredCalendars(true);</span>
<a href="#l17.333"></a><span id="l17.333"> </span>
<a href="#l17.334"></a><span id="l17.334">                     let calprops_resp = null;</span>
<a href="#l17.335"></a><span id="l17.335" class="difflineminus">-                    let defaultCal = this_.defaultCalendar;</span>
<a href="#l17.336"></a><span id="l17.336" class="difflineplus">+                    let defaultCal = self.defaultCalendar;</span>
<a href="#l17.337"></a><span id="l17.337">                     if (defaultCal &amp;&amp; cals[defaultCal.calId] &amp;&amp; // default calendar is registered</span>
<a href="#l17.338"></a><span id="l17.338">                         getPref(&quot;calendar.wcap.subscriptions&quot;, true) &amp;&amp;</span>
<a href="#l17.339"></a><span id="l17.339">                         !defaultCal.getProperty(&quot;subscriptions_registered&quot;)) {</span>
<a href="#l17.340"></a><span id="l17.340">                         let hasSubscriptions = false;</span>
<a href="#l17.341"></a><span id="l17.341">                         // post register subscribed calendars:</span>
<a href="#l17.342"></a><span id="l17.342" class="difflineminus">-                        let list = this_.getUserPreferences(&quot;X-NSCP-WCAP-PREF-icsSubscribed&quot;);</span>
<a href="#l17.343"></a><span id="l17.343" class="difflineplus">+                        let list = self.getUserPreferences(&quot;X-NSCP-WCAP-PREF-icsSubscribed&quot;);</span>
<a href="#l17.344"></a><span id="l17.344">                         for (let item of list) {</span>
<a href="#l17.345"></a><span id="l17.345">                             let ar = item.split(&quot;,&quot;);</span>
<a href="#l17.346"></a><span id="l17.346">                             // ',', '$' are not encoded. ',' can be handled here. WTF.</span>
<a href="#l17.347"></a><span id="l17.347">                             for (let a of ar) {</span>
<a href="#l17.348"></a><span id="l17.348">                                 let dollar = a.indexOf(&quot;$&quot;);</span>
<a href="#l17.349"></a><span id="l17.349">                                 if (dollar &gt;= 0) {</span>
<a href="#l17.350"></a><span id="l17.350">                                     let calId = a.substring(0, dollar);</span>
<a href="#l17.351"></a><span id="l17.351" class="difflineminus">-                                    if (calId != this_.defaultCalId) {</span>
<a href="#l17.352"></a><span id="l17.352" class="difflineplus">+                                    if (calId != self.defaultCalId) {</span>
<a href="#l17.353"></a><span id="l17.353">                                         cals[calId] = null;</span>
<a href="#l17.354"></a><span id="l17.354">                                         hasSubscriptions = true;</span>
<a href="#l17.355"></a><span id="l17.355">                                     }</span>
<a href="#l17.356"></a><span id="l17.356">                                 }</span>
<a href="#l17.357"></a><span id="l17.357">                             }</span>
<a href="#l17.358"></a><span id="l17.358">                         }</span>
<a href="#l17.359"></a><span id="l17.359"> </span>
<a href="#l17.360"></a><span id="l17.360">                         if (hasSubscriptions) {</span>
<a href="#l17.361"></a><span id="l17.361">                             calprops_resp = function(aCalendar) {</span>
<a href="#l17.362"></a><span id="l17.362">                                 if (aCalendar.isDefaultCalendar) {</span>
<a href="#l17.363"></a><span id="l17.363">                                     // tweak name:</span>
<a href="#l17.364"></a><span id="l17.364">                                     aCalendar.setProperty(&quot;name&quot;, aCalendar.displayName);</span>
<a href="#l17.365"></a><span id="l17.365">                                 } else {</span>
<a href="#l17.366"></a><span id="l17.366" class="difflineminus">-                                    log(&quot;registering subscribed calendar: &quot; + aCalendar.calId, this_);</span>
<a href="#l17.367"></a><span id="l17.367" class="difflineplus">+                                    log(&quot;registering subscribed calendar: &quot; + aCalendar.calId, self);</span>
<a href="#l17.368"></a><span id="l17.368">                                     cal.getCalendarManager().registerCalendar(aCalendar);</span>
<a href="#l17.369"></a><span id="l17.369">                                 }</span>
<a href="#l17.370"></a><span id="l17.370">                             };</span>
<a href="#l17.371"></a><span id="l17.371">                             // do only once:</span>
<a href="#l17.372"></a><span id="l17.372">                             defaultCal.setProperty(&quot;subscriptions_registered&quot;, true);</span>
<a href="#l17.373"></a><span id="l17.373">                         }</span>
<a href="#l17.374"></a><span id="l17.374">                     }</span>
<a href="#l17.375"></a><span id="l17.375"> </span>
<a href="#l17.376"></a><span id="l17.376">                     if (!defaultCal.getProperty(&quot;user_id&quot;)) { // nail once:</span>
<a href="#l17.377"></a><span id="l17.377" class="difflineminus">-                        defaultCal.setProperty(&quot;user_id&quot;, this_.credentials.userId);</span>
<a href="#l17.378"></a><span id="l17.378" class="difflineplus">+                        defaultCal.setProperty(&quot;user_id&quot;, self.credentials.userId);</span>
<a href="#l17.379"></a><span id="l17.379">                     }</span>
<a href="#l17.380"></a><span id="l17.380"> </span>
<a href="#l17.381"></a><span id="l17.381">                     if (getPref(&quot;calendar.wcap.no_get_calprops&quot;, false)) {</span>
<a href="#l17.382"></a><span id="l17.382">                         // hack around the get/search calprops mess:</span>
<a href="#l17.383"></a><span id="l17.383" class="difflineminus">-                        this_.installCalProps_search_calprops(calprops_resp, sessionId, cals, request);</span>
<a href="#l17.384"></a><span id="l17.384" class="difflineplus">+                        self.installCalProps_search_calprops(calprops_resp, sessionId, cals, request);</span>
<a href="#l17.385"></a><span id="l17.385">                     } else {</span>
<a href="#l17.386"></a><span id="l17.386" class="difflineminus">-                        this_.installCalProps_get_calprops(calprops_resp, sessionId, cals, request);</span>
<a href="#l17.387"></a><span id="l17.387" class="difflineplus">+                        self.installCalProps_get_calprops(calprops_resp, sessionId, cals, request);</span>
<a href="#l17.388"></a><span id="l17.388">                     }</span>
<a href="#l17.389"></a><span id="l17.389">                 },</span>
<a href="#l17.390"></a><span id="l17.390">                 stringToXml, &quot;get_userprefs&quot;,</span>
<a href="#l17.391"></a><span id="l17.391">                 &quot;&amp;fmt-out=text%2Fxml&amp;userid=&quot; + encodeURIComponent(this.credentials.userId),</span>
<a href="#l17.392"></a><span id="l17.392">                 sessionId);</span>
<a href="#l17.393"></a><span id="l17.393">             this.installServerTimeDiff(sessionId, request);</span>
<a href="#l17.394"></a><span id="l17.394">             this.installServerTimezones(sessionId, request);</span>
<a href="#l17.395"></a><span id="l17.395">         } finally {</span>
<a href="#l17.396"></a><span id="l17.396">             request.unlockPending();</span>
<a href="#l17.397"></a><span id="l17.397">         }</span>
<a href="#l17.398"></a><span id="l17.398">     },</span>
<a href="#l17.399"></a><span id="l17.399"> </span>
<a href="#l17.400"></a><span id="l17.400">     installCalProps_get_calprops:</span>
<a href="#l17.401"></a><span id="l17.401">     function calWcapSession_installCalProps_get_calprops(respFunc, sessionId, cals, request) {</span>
<a href="#l17.402"></a><span id="l17.402" class="difflineminus">-        let this_ = this;</span>
<a href="#l17.403"></a><span id="l17.403" class="difflineplus">+        let self = this;</span>
<a href="#l17.404"></a><span id="l17.404">         function calprops_resp(err, data) {</span>
<a href="#l17.405"></a><span id="l17.405">             if (err) {</span>
<a href="#l17.406"></a><span id="l17.406">                 throw err;</span>
<a href="#l17.407"></a><span id="l17.407">             }</span>
<a href="#l17.408"></a><span id="l17.408">             // string to xml converter func without WCAP errno check:</span>
<a href="#l17.409"></a><span id="l17.409">             if (!data || data.length == 0) { // assuming time-out</span>
<a href="#l17.410"></a><span id="l17.410">                 throw new Components.Exception(errorToString(calIWcapErrors.WCAP_LOGIN_FAILED),</span>
<a href="#l17.411"></a><span id="l17.411">                                                calIWcapErrors.WCAP_LOGIN_FAILED);</span>
<a href="#l17.412"></a><span id="l17.412" class="difflineat">@@ -573,50 +573,50 @@ calWcapSession.prototype = {</span>
<a href="#l17.413"></a><span id="l17.413">                 try {</span>
<a href="#l17.414"></a><span id="l17.414">                     let node = nodeList.item(i);</span>
<a href="#l17.415"></a><span id="l17.415">                     checkWcapXmlErrno(node);</span>
<a href="#l17.416"></a><span id="l17.416">                     let ar = filterXmlNodes(&quot;X-NSCP-CALPROPS-RELATIVE-CALID&quot;, node);</span>
<a href="#l17.417"></a><span id="l17.417">                     if (ar.length &gt; 0) {</span>
<a href="#l17.418"></a><span id="l17.418">                         let calId = ar[0];</span>
<a href="#l17.419"></a><span id="l17.419">                         let calendar = cals[calId];</span>
<a href="#l17.420"></a><span id="l17.420">                         if (calendar === null) {</span>
<a href="#l17.421"></a><span id="l17.421" class="difflineminus">-                            calendar = new calWcapCalendar(this_);</span>
<a href="#l17.422"></a><span id="l17.422" class="difflineminus">-                            let uri = this_.uri.clone();</span>
<a href="#l17.423"></a><span id="l17.423" class="difflineplus">+                            calendar = new calWcapCalendar(self);</span>
<a href="#l17.424"></a><span id="l17.424" class="difflineplus">+                            let uri = self.uri.clone();</span>
<a href="#l17.425"></a><span id="l17.425">                             uri.path += &quot;?calid=&quot; + encodeURIComponent(calId);</span>
<a href="#l17.426"></a><span id="l17.426">                             calendar.uri = uri;</span>
<a href="#l17.427"></a><span id="l17.427">                         }</span>
<a href="#l17.428"></a><span id="l17.428">                         if (calendar) {</span>
<a href="#l17.429"></a><span id="l17.429">                             calendar.m_calProps = node;</span>
<a href="#l17.430"></a><span id="l17.430">                             if (respFunc) {</span>
<a href="#l17.431"></a><span id="l17.431">                                 respFunc(calendar);</span>
<a href="#l17.432"></a><span id="l17.432">                             }</span>
<a href="#l17.433"></a><span id="l17.433">                         }</span>
<a href="#l17.434"></a><span id="l17.434">                     }</span>
<a href="#l17.435"></a><span id="l17.435">                 } catch (exc) { // ignore but log any errors on subscribed calendars:</span>
<a href="#l17.436"></a><span id="l17.436" class="difflineminus">-                    logError(exc, this_);</span>
<a href="#l17.437"></a><span id="l17.437" class="difflineplus">+                    logError(exc, self);</span>
<a href="#l17.438"></a><span id="l17.438">                 }</span>
<a href="#l17.439"></a><span id="l17.439">             }</span>
<a href="#l17.440"></a><span id="l17.440">         }</span>
<a href="#l17.441"></a><span id="l17.441"> </span>
<a href="#l17.442"></a><span id="l17.442">         let calidParam = &quot;&quot;;</span>
<a href="#l17.443"></a><span id="l17.443">         for (let calId in cals) {</span>
<a href="#l17.444"></a><span id="l17.444">             if (calidParam.length &gt; 0) {</span>
<a href="#l17.445"></a><span id="l17.445">                 calidParam += &quot;;&quot;;</span>
<a href="#l17.446"></a><span id="l17.446">             }</span>
<a href="#l17.447"></a><span id="l17.447">             calidParam += encodeURIComponent(calId);</span>
<a href="#l17.448"></a><span id="l17.448">         }</span>
<a href="#l17.449"></a><span id="l17.449" class="difflineminus">-        this_.issueNetworkRequest_(request, calprops_resp,</span>
<a href="#l17.450"></a><span id="l17.450" class="difflineminus">-                                   null, &quot;get_calprops&quot;,</span>
<a href="#l17.451"></a><span id="l17.451" class="difflineminus">-                                   &quot;&amp;fmt-out=text%2Fxml&amp;calid=&quot; + calidParam,</span>
<a href="#l17.452"></a><span id="l17.452" class="difflineminus">-                                   sessionId);</span>
<a href="#l17.453"></a><span id="l17.453" class="difflineplus">+        self.issueNetworkRequest_(request, calprops_resp,</span>
<a href="#l17.454"></a><span id="l17.454" class="difflineplus">+                                  null, &quot;get_calprops&quot;,</span>
<a href="#l17.455"></a><span id="l17.455" class="difflineplus">+                                  &quot;&amp;fmt-out=text%2Fxml&amp;calid=&quot; + calidParam,</span>
<a href="#l17.456"></a><span id="l17.456" class="difflineplus">+                                  sessionId);</span>
<a href="#l17.457"></a><span id="l17.457">     },</span>
<a href="#l17.458"></a><span id="l17.458"> </span>
<a href="#l17.459"></a><span id="l17.459">     installCalProps_search_calprops:</span>
<a href="#l17.460"></a><span id="l17.460">     function calWcapSession_installCalProps_search_calprops(respFunc, sessionId, cals, request) {</span>
<a href="#l17.461"></a><span id="l17.461" class="difflineminus">-        let this_ = this;</span>
<a href="#l17.462"></a><span id="l17.462" class="difflineplus">+        let self = this;</span>
<a href="#l17.463"></a><span id="l17.463">         let retrievedCals = {};</span>
<a href="#l17.464"></a><span id="l17.464">         let issuedSearchRequests = {};</span>
<a href="#l17.465"></a><span id="l17.465">         for (let calId in cals) {</span>
<a href="#l17.466"></a><span id="l17.466">             if (!retrievedCals[calId]) {</span>
<a href="#l17.467"></a><span id="l17.467">                 let listener = {</span>
<a href="#l17.468"></a><span id="l17.468">                     onResult: function search_onResult(oprequest, result) {</span>
<a href="#l17.469"></a><span id="l17.469">                         try {</span>
<a href="#l17.470"></a><span id="l17.470">                             if (!Components.isSuccessCode(oprequest.status)) {</span>
<a href="#l17.471"></a><span id="l17.471" class="difflineat">@@ -632,21 +632,21 @@ calWcapSession.prototype = {</span>
<a href="#l17.472"></a><span id="l17.472">                                     let thisCalId = calendar.calId;</span>
<a href="#l17.473"></a><span id="l17.473">                                     if ((cals[thisCalId] !== undefined) &amp;&amp; !retrievedCals[thisCalId]) {</span>
<a href="#l17.474"></a><span id="l17.474">                                         retrievedCals[thisCalId] = calendar;</span>
<a href="#l17.475"></a><span id="l17.475">                                         if (respFunc) {</span>
<a href="#l17.476"></a><span id="l17.476">                                             respFunc(calendar);</span>
<a href="#l17.477"></a><span id="l17.477">                                         }</span>
<a href="#l17.478"></a><span id="l17.478">                                     }</span>
<a href="#l17.479"></a><span id="l17.479">                                 } catch (exc) { // ignore but log any errors on subscribed calendars:</span>
<a href="#l17.480"></a><span id="l17.480" class="difflineminus">-                                    logError(exc, this_);</span>
<a href="#l17.481"></a><span id="l17.481" class="difflineplus">+                                    logError(exc, self);</span>
<a href="#l17.482"></a><span id="l17.482">                                 }</span>
<a href="#l17.483"></a><span id="l17.483">                             }</span>
<a href="#l17.484"></a><span id="l17.484">                         } catch (exc) { // ignore but log any errors on subscribed calendars:</span>
<a href="#l17.485"></a><span id="l17.485" class="difflineminus">-                            logError(exc, this_);</span>
<a href="#l17.486"></a><span id="l17.486" class="difflineplus">+                            logError(exc, self);</span>
<a href="#l17.487"></a><span id="l17.487">                         }</span>
<a href="#l17.488"></a><span id="l17.488">                     }</span>
<a href="#l17.489"></a><span id="l17.489">                 };</span>
<a href="#l17.490"></a><span id="l17.490"> </span>
<a href="#l17.491"></a><span id="l17.491">                 let colon = calId.indexOf(&quot;:&quot;);</span>
<a href="#l17.492"></a><span id="l17.492">                 if (colon &gt;= 0) { // searching for secondary calendars doesn't work. WTF.</span>
<a href="#l17.493"></a><span id="l17.493">                     calId = calId.substring(0, colon);</span>
<a href="#l17.494"></a><span id="l17.494">                 }</span>
<a href="#l17.495"></a><span id="l17.495" class="difflineat">@@ -654,105 +654,105 @@ calWcapSession.prototype = {</span>
<a href="#l17.496"></a><span id="l17.496">                     issuedSearchRequests[calId] = true;</span>
<a href="#l17.497"></a><span id="l17.497">                     this.searchForCalendars(calId, calICalendarSearchProvider.HINT_EXACT_MATCH, 20, listener);</span>
<a href="#l17.498"></a><span id="l17.498">                 }</span>
<a href="#l17.499"></a><span id="l17.499">             }</span>
<a href="#l17.500"></a><span id="l17.500">         }</span>
<a href="#l17.501"></a><span id="l17.501">     },</span>
<a href="#l17.502"></a><span id="l17.502"> </span>
<a href="#l17.503"></a><span id="l17.503">     installServerTimeDiff: function calWcapSession_installServerTimeDiff(sessionId, request) {</span>
<a href="#l17.504"></a><span id="l17.504" class="difflineminus">-        let this_ = this;</span>
<a href="#l17.505"></a><span id="l17.505" class="difflineplus">+        let self = this;</span>
<a href="#l17.506"></a><span id="l17.506">         this.issueNetworkRequest_(</span>
<a href="#l17.507"></a><span id="l17.507">             request,</span>
<a href="#l17.508"></a><span id="l17.508">             function netResp(err, data) {</span>
<a href="#l17.509"></a><span id="l17.509">                 if (err) {</span>
<a href="#l17.510"></a><span id="l17.510">                     throw err;</span>
<a href="#l17.511"></a><span id="l17.511">                 }</span>
<a href="#l17.512"></a><span id="l17.512">                 // xxx todo: think about</span>
<a href="#l17.513"></a><span id="l17.513">                 // assure that locally calculated server time is smaller</span>
<a href="#l17.514"></a><span id="l17.514">                 // than the current (real) server time:</span>
<a href="#l17.515"></a><span id="l17.515">                 let localTime = getTime();</span>
<a href="#l17.516"></a><span id="l17.516">                 let serverTime = getDatetimeFromIcalProp(data.getFirstProperty(&quot;X-NSCP-WCAPTIME&quot;));</span>
<a href="#l17.517"></a><span id="l17.517" class="difflineminus">-                this_.m_serverTimeDiff = serverTime.subtractDate(localTime);</span>
<a href="#l17.518"></a><span id="l17.518" class="difflineminus">-                log(&quot;server time diff is: &quot; + this_.m_serverTimeDiff, this_);</span>
<a href="#l17.519"></a><span id="l17.519" class="difflineplus">+                self.m_serverTimeDiff = serverTime.subtractDate(localTime);</span>
<a href="#l17.520"></a><span id="l17.520" class="difflineplus">+                log(&quot;server time diff is: &quot; + self.m_serverTimeDiff, self);</span>
<a href="#l17.521"></a><span id="l17.521">             },</span>
<a href="#l17.522"></a><span id="l17.522">             stringToIcal, &quot;gettime&quot;, &quot;&amp;fmt-out=text%2Fcalendar&quot;,</span>
<a href="#l17.523"></a><span id="l17.523">             sessionId);</span>
<a href="#l17.524"></a><span id="l17.524">     },</span>
<a href="#l17.525"></a><span id="l17.525"> </span>
<a href="#l17.526"></a><span id="l17.526">     installServerTimezones: function calWcapSession_installServerTimezones(sessionId, request) {</span>
<a href="#l17.527"></a><span id="l17.527">         this.m_serverTimezones = {};</span>
<a href="#l17.528"></a><span id="l17.528" class="difflineminus">-        let this_ = this;</span>
<a href="#l17.529"></a><span id="l17.529" class="difflineminus">-        this_.issueNetworkRequest_(</span>
<a href="#l17.530"></a><span id="l17.530" class="difflineplus">+        let self = this;</span>
<a href="#l17.531"></a><span id="l17.531" class="difflineplus">+        self.issueNetworkRequest_(</span>
<a href="#l17.532"></a><span id="l17.532">             request,</span>
<a href="#l17.533"></a><span id="l17.533">             function netResp(err, data) {</span>
<a href="#l17.534"></a><span id="l17.534">                 if (err) {</span>
<a href="#l17.535"></a><span id="l17.535">                     throw err;</span>
<a href="#l17.536"></a><span id="l17.536">                 }</span>
<a href="#l17.537"></a><span id="l17.537">                 for (let subComp of cal.ical.calendarComponentIterator(data, &quot;VTIMEZONE&quot;)) {</span>
<a href="#l17.538"></a><span id="l17.538">                     try {</span>
<a href="#l17.539"></a><span id="l17.539">                         let tzid = subComp.getFirstProperty(&quot;TZID&quot;).value;</span>
<a href="#l17.540"></a><span id="l17.540" class="difflineminus">-                        this_.m_serverTimezones[tzid] = new calWcapTimezone(this_, tzid, subComp);</span>
<a href="#l17.541"></a><span id="l17.541" class="difflineplus">+                        self.m_serverTimezones[tzid] = new calWcapTimezone(self, tzid, subComp);</span>
<a href="#l17.542"></a><span id="l17.542">                     } catch (exc) { // ignore but errors:</span>
<a href="#l17.543"></a><span id="l17.543" class="difflineminus">-                        logError(exc, this_);</span>
<a href="#l17.544"></a><span id="l17.544" class="difflineplus">+                        logError(exc, self);</span>
<a href="#l17.545"></a><span id="l17.545">                     }</span>
<a href="#l17.546"></a><span id="l17.546">                 }</span>
<a href="#l17.547"></a><span id="l17.547" class="difflineminus">-                log(&quot;installed timezones.&quot;, this_);</span>
<a href="#l17.548"></a><span id="l17.548" class="difflineplus">+                log(&quot;installed timezones.&quot;, self);</span>
<a href="#l17.549"></a><span id="l17.549">             },</span>
<a href="#l17.550"></a><span id="l17.550">             stringToIcal, &quot;get_all_timezones&quot;, &quot;&amp;fmt-out=text%2Fcalendar&quot;,</span>
<a href="#l17.551"></a><span id="l17.551">             sessionId);</span>
<a href="#l17.552"></a><span id="l17.552">     },</span>
<a href="#l17.553"></a><span id="l17.553"> </span>
<a href="#l17.554"></a><span id="l17.554">     getCommandUrl: function calWcapSession_getCommandUrl(wcapCommand, params, sessionId) {</span>
<a href="#l17.555"></a><span id="l17.555">         let url = this.sessionUri.spec;</span>
<a href="#l17.556"></a><span id="l17.556">         url += wcapCommand + &quot;.wcap?appid=mozilla-calendar&amp;id=&quot;;</span>
<a href="#l17.557"></a><span id="l17.557">         url += sessionId;</span>
<a href="#l17.558"></a><span id="l17.558">         url += params;</span>
<a href="#l17.559"></a><span id="l17.559">         return url;</span>
<a href="#l17.560"></a><span id="l17.560">     },</span>
<a href="#l17.561"></a><span id="l17.561"> </span>
<a href="#l17.562"></a><span id="l17.562">     issueNetworkRequest: function calWcapSession_issueNetworkRequest(</span>
<a href="#l17.563"></a><span id="l17.563">                     request, respFunc, dataConvFunc, wcapCommand, params) {</span>
<a href="#l17.564"></a><span id="l17.564" class="difflineminus">-        let this_ = this;</span>
<a href="#l17.565"></a><span id="l17.565" class="difflineplus">+        let self = this;</span>
<a href="#l17.566"></a><span id="l17.566">         let getSessionId_resp = function(err, sessionId) {</span>
<a href="#l17.567"></a><span id="l17.567">             if (err) {</span>
<a href="#l17.568"></a><span id="l17.568">                 request.execSubRespFunc(respFunc, err);</span>
<a href="#l17.569"></a><span id="l17.569">             } else {</span>
<a href="#l17.570"></a><span id="l17.570">                 // else have session uri and id:</span>
<a href="#l17.571"></a><span id="l17.571" class="difflineminus">-                this_.issueNetworkRequest_(</span>
<a href="#l17.572"></a><span id="l17.572" class="difflineplus">+                self.issueNetworkRequest_(</span>
<a href="#l17.573"></a><span id="l17.573">                     request,</span>
<a href="#l17.574"></a><span id="l17.574">                     function issueNetworkRequest_resp(loginerr, data) {</span>
<a href="#l17.575"></a><span id="l17.575">                         // timeout?</span>
<a href="#l17.576"></a><span id="l17.576">                         if (checkErrorCode(loginerr, calIWcapErrors.WCAP_LOGIN_FAILED)) {</span>
<a href="#l17.577"></a><span id="l17.577">                             // try again:</span>
<a href="#l17.578"></a><span id="l17.578" class="difflineminus">-                            this_.getSessionId(</span>
<a href="#l17.579"></a><span id="l17.579" class="difflineplus">+                            self.getSessionId(</span>
<a href="#l17.580"></a><span id="l17.580">                                 request,</span>
<a href="#l17.581"></a><span id="l17.581">                                 getSessionId_resp,</span>
<a href="#l17.582"></a><span id="l17.582">                                 sessionId/* (old) timed-out session */);</span>
<a href="#l17.583"></a><span id="l17.583">                             return;</span>
<a href="#l17.584"></a><span id="l17.584">                         }</span>
<a href="#l17.585"></a><span id="l17.585">                         request.execSubRespFunc(respFunc, loginerr, data);</span>
<a href="#l17.586"></a><span id="l17.586">                     },</span>
<a href="#l17.587"></a><span id="l17.587">                     dataConvFunc, wcapCommand, params, sessionId);</span>
<a href="#l17.588"></a><span id="l17.588">             }</span>
<a href="#l17.589"></a><span id="l17.589">         };</span>
<a href="#l17.590"></a><span id="l17.590">         this.getSessionId(request, getSessionId_resp);</span>
<a href="#l17.591"></a><span id="l17.591">     },</span>
<a href="#l17.592"></a><span id="l17.592"> </span>
<a href="#l17.593"></a><span id="l17.593">     issueNetworkRequest_: function calWcapSession_issueNetworkRequest_(</span>
<a href="#l17.594"></a><span id="l17.594">                     request, respFunc, dataConvFunc, wcapCommand, params, sessionId) {</span>
<a href="#l17.595"></a><span id="l17.595">         let url = this.getCommandUrl(wcapCommand, params, sessionId);</span>
<a href="#l17.596"></a><span id="l17.596" class="difflineminus">-        let this_ = this;</span>
<a href="#l17.597"></a><span id="l17.597" class="difflineplus">+        let self = this;</span>
<a href="#l17.598"></a><span id="l17.598">         issueNetworkRequest(request,</span>
<a href="#l17.599"></a><span id="l17.599">                             function netResp(err, str) {</span>
<a href="#l17.600"></a><span id="l17.600">                                 let data;</span>
<a href="#l17.601"></a><span id="l17.601">                                 if (!err) {</span>
<a href="#l17.602"></a><span id="l17.602">                                     try {</span>
<a href="#l17.603"></a><span id="l17.603">                                         if (dataConvFunc) {</span>
<a href="#l17.604"></a><span id="l17.604" class="difflineminus">-                                            data = dataConvFunc(this_, str);</span>
<a href="#l17.605"></a><span id="l17.605" class="difflineplus">+                                            data = dataConvFunc(self, str);</span>
<a href="#l17.606"></a><span id="l17.606">                                         } else {</span>
<a href="#l17.607"></a><span id="l17.607">                                             data = str;</span>
<a href="#l17.608"></a><span id="l17.608">                                         }</span>
<a href="#l17.609"></a><span id="l17.609">                                     } catch (exc) {</span>
<a href="#l17.610"></a><span id="l17.610">                                         err = exc;</span>
<a href="#l17.611"></a><span id="l17.611">                                     }</span>
<a href="#l17.612"></a><span id="l17.612">                                 }</span>
<a href="#l17.613"></a><span id="l17.613">                                 request.execSubRespFunc(respFunc, err, data);</span>
<a href="#l17.614"></a><span id="l17.614" class="difflineat">@@ -864,21 +864,21 @@ calWcapSession.prototype = {</span>
<a href="#l17.615"></a><span id="l17.615">         }</span>
<a href="#l17.616"></a><span id="l17.616">         out_count.value = ret.length;</span>
<a href="#l17.617"></a><span id="l17.617">         return ret;</span>
<a href="#l17.618"></a><span id="l17.618">     },</span>
<a href="#l17.619"></a><span id="l17.619"> </span>
<a href="#l17.620"></a><span id="l17.620">     // calICalendarSearchProvider:</span>
<a href="#l17.621"></a><span id="l17.621">     searchForCalendars:</span>
<a href="#l17.622"></a><span id="l17.622">     function calWcapSession_searchForCalendars(searchString, hints, maxResults, listener) {</span>
<a href="#l17.623"></a><span id="l17.623" class="difflineminus">-        let this_ = this;</span>
<a href="#l17.624"></a><span id="l17.624" class="difflineplus">+        let self = this;</span>
<a href="#l17.625"></a><span id="l17.625">         let request = new calWcapRequest(</span>
<a href="#l17.626"></a><span id="l17.626">             function searchForCalendars_resp(oprequest, err, data) {</span>
<a href="#l17.627"></a><span id="l17.627">                 if (err &amp;&amp; !checkErrorCode(err, calIErrors.OPERATION_CANCELLED)) {</span>
<a href="#l17.628"></a><span id="l17.628" class="difflineminus">-                    this_.notifyError(err);</span>
<a href="#l17.629"></a><span id="l17.629" class="difflineplus">+                    self.notifyError(err);</span>
<a href="#l17.630"></a><span id="l17.630">                 }</span>
<a href="#l17.631"></a><span id="l17.631">                 if (listener) {</span>
<a href="#l17.632"></a><span id="l17.632">                     listener.onResult(oprequest, data);</span>
<a href="#l17.633"></a><span id="l17.633">                 }</span>
<a href="#l17.634"></a><span id="l17.634">             },</span>
<a href="#l17.635"></a><span id="l17.635">             log(&quot;searchForCalendars, searchString=&quot; + searchString, this));</span>
<a href="#l17.636"></a><span id="l17.636"> </span>
<a href="#l17.637"></a><span id="l17.637">         try {</span>
<a href="#l17.638"></a><span id="l17.638" class="difflineat">@@ -911,36 +911,36 @@ calWcapSession.prototype = {</span>
<a href="#l17.639"></a><span id="l17.639">                             checkWcapXmlErrno(node);</span>
<a href="#l17.640"></a><span id="l17.640">                             let ar = filterXmlNodes(&quot;X-NSCP-CALPROPS-RELATIVE-CALID&quot;, node);</span>
<a href="#l17.641"></a><span id="l17.641">                             if (ar.length &gt; 0) {</span>
<a href="#l17.642"></a><span id="l17.642">                                 let calId = ar[0];</span>
<a href="#l17.643"></a><span id="l17.643">                                 let calendar = registeredCalendars[calId];</span>
<a href="#l17.644"></a><span id="l17.644">                                 if (calendar) {</span>
<a href="#l17.645"></a><span id="l17.645">                                     calendar.m_calProps = node; // update calprops</span>
<a href="#l17.646"></a><span id="l17.646">                                 } else {</span>
<a href="#l17.647"></a><span id="l17.647" class="difflineminus">-                                    calendar = new calWcapCalendar(this_, node);</span>
<a href="#l17.648"></a><span id="l17.648" class="difflineminus">-                                    let uri = this_.uri.clone();</span>
<a href="#l17.649"></a><span id="l17.649" class="difflineplus">+                                    calendar = new calWcapCalendar(self, node);</span>
<a href="#l17.650"></a><span id="l17.650" class="difflineplus">+                                    let uri = self.uri.clone();</span>
<a href="#l17.651"></a><span id="l17.651">                                     uri.path += &quot;?calid=&quot; + encodeURIComponent(calId);</span>
<a href="#l17.652"></a><span id="l17.652">                                     calendar.uri = uri;</span>
<a href="#l17.653"></a><span id="l17.653">                                 }</span>
<a href="#l17.654"></a><span id="l17.654">                                 ret.push(calendar);</span>
<a href="#l17.655"></a><span id="l17.655">                             }</span>
<a href="#l17.656"></a><span id="l17.656">                         } catch (exc) {</span>
<a href="#l17.657"></a><span id="l17.657">                             switch (getResultCode(exc)) {</span>
<a href="#l17.658"></a><span id="l17.658">                                 case calIWcapErrors.WCAP_NO_ERRNO: // workaround</span>
<a href="#l17.659"></a><span id="l17.659">                                 case calIWcapErrors.WCAP_ACCESS_DENIED_TO_CALENDAR:</span>
<a href="#l17.660"></a><span id="l17.660" class="difflineminus">-                                    log(&quot;searchForCalendars_netResp() ignored error: &quot; + errorToString(exc), this_);</span>
<a href="#l17.661"></a><span id="l17.661" class="difflineplus">+                                    log(&quot;searchForCalendars_netResp() ignored error: &quot; + errorToString(exc), self);</span>
<a href="#l17.662"></a><span id="l17.662">                                     break;</span>
<a href="#l17.663"></a><span id="l17.663">                                 default:</span>
<a href="#l17.664"></a><span id="l17.664" class="difflineminus">-                                    this_.notifyError(exc);</span>
<a href="#l17.665"></a><span id="l17.665" class="difflineplus">+                                    self.notifyError(exc);</span>
<a href="#l17.666"></a><span id="l17.666">                                     break;</span>
<a href="#l17.667"></a><span id="l17.667">                             }</span>
<a href="#l17.668"></a><span id="l17.668">                         }</span>
<a href="#l17.669"></a><span id="l17.669">                     }</span>
<a href="#l17.670"></a><span id="l17.670" class="difflineminus">-                    log(&quot;search done. number of found calendars: &quot; + ret.length, this_);</span>
<a href="#l17.671"></a><span id="l17.671" class="difflineplus">+                    log(&quot;search done. number of found calendars: &quot; + ret.length, self);</span>
<a href="#l17.672"></a><span id="l17.672">                     request.execRespFunc(null, ret);</span>
<a href="#l17.673"></a><span id="l17.673">                 },</span>
<a href="#l17.674"></a><span id="l17.674">                 null, &quot;search_calprops&quot;, params);</span>
<a href="#l17.675"></a><span id="l17.675">         } catch (exc) {</span>
<a href="#l17.676"></a><span id="l17.676">             request.execRespFunc(exc);</span>
<a href="#l17.677"></a><span id="l17.677">         }</span>
<a href="#l17.678"></a><span id="l17.678">         return request;</span>
<a href="#l17.679"></a><span id="l17.679">     },</span>
<a href="#l17.680"></a><span id="l17.680" class="difflineat">@@ -948,29 +948,29 @@ calWcapSession.prototype = {</span>
<a href="#l17.681"></a><span id="l17.681">     // calIFreeBusyProvider:</span>
<a href="#l17.682"></a><span id="l17.682">     getFreeBusyIntervals:</span>
<a href="#l17.683"></a><span id="l17.683">     function calWcapCalendar_getFreeBusyIntervals(calId, rangeStart, rangeEnd, busyTypes, listener) {</span>
<a href="#l17.684"></a><span id="l17.684">         rangeStart = ensureDateTime(rangeStart);</span>
<a href="#l17.685"></a><span id="l17.685">         rangeEnd = ensureDateTime(rangeEnd);</span>
<a href="#l17.686"></a><span id="l17.686">         let zRangeStart = getIcalUTC(rangeStart);</span>
<a href="#l17.687"></a><span id="l17.687">         let zRangeEnd = getIcalUTC(rangeEnd);</span>
<a href="#l17.688"></a><span id="l17.688"> </span>
<a href="#l17.689"></a><span id="l17.689" class="difflineminus">-        let this_ = this;</span>
<a href="#l17.690"></a><span id="l17.690" class="difflineplus">+        let self = this;</span>
<a href="#l17.691"></a><span id="l17.691">         let request = new calWcapRequest(</span>
<a href="#l17.692"></a><span id="l17.692">             function _resp(oprequest, err, data) {</span>
<a href="#l17.693"></a><span id="l17.693">                 let rc = getResultCode(err);</span>
<a href="#l17.694"></a><span id="l17.694">                 switch (rc) {</span>
<a href="#l17.695"></a><span id="l17.695">                     case calIWcapErrors.WCAP_NO_ERRNO: // workaround</span>
<a href="#l17.696"></a><span id="l17.696">                     case calIWcapErrors.WCAP_ACCESS_DENIED_TO_CALENDAR:</span>
<a href="#l17.697"></a><span id="l17.697">                     case calIWcapErrors.WCAP_CALENDAR_DOES_NOT_EXIST:</span>
<a href="#l17.698"></a><span id="l17.698" class="difflineminus">-                        log(&quot;getFreeBusyIntervals_resp() error: &quot; + errorToString(err), this_);</span>
<a href="#l17.699"></a><span id="l17.699" class="difflineplus">+                        log(&quot;getFreeBusyIntervals_resp() error: &quot; + errorToString(err), self);</span>
<a href="#l17.700"></a><span id="l17.700">                         break;</span>
<a href="#l17.701"></a><span id="l17.701">                     default:</span>
<a href="#l17.702"></a><span id="l17.702">                         if (!Components.isSuccessCode(rc)) {</span>
<a href="#l17.703"></a><span id="l17.703" class="difflineminus">-                            this_.notifyError(err);</span>
<a href="#l17.704"></a><span id="l17.704" class="difflineplus">+                            self.notifyError(err);</span>
<a href="#l17.705"></a><span id="l17.705">                         }</span>
<a href="#l17.706"></a><span id="l17.706">                         break;</span>
<a href="#l17.707"></a><span id="l17.707">                 }</span>
<a href="#l17.708"></a><span id="l17.708">                 if (listener) {</span>
<a href="#l17.709"></a><span id="l17.709">                     listener.onResult(oprequest, data);</span>
<a href="#l17.710"></a><span id="l17.710">                 }</span>
<a href="#l17.711"></a><span id="l17.711">             },</span>
<a href="#l17.712"></a><span id="l17.712">             log(&quot;getFreeBusyIntervals():\n\tcalId=&quot; + calId +</span>
<a href="#l17.713"></a><span id="l17.713" class="difflineat">@@ -996,17 +996,17 @@ calWcapSession.prototype = {</span>
<a href="#l17.714"></a><span id="l17.714">             this.issueNetworkRequest(</span>
<a href="#l17.715"></a><span id="l17.715">                 request,</span>
<a href="#l17.716"></a><span id="l17.716">                 function net_resp(err, xml) {</span>
<a href="#l17.717"></a><span id="l17.717">                     if (err) {</span>
<a href="#l17.718"></a><span id="l17.718">                         throw err;</span>
<a href="#l17.719"></a><span id="l17.719">                     }</span>
<a href="#l17.720"></a><span id="l17.720">                     if (LOG_LEVEL &gt; 0) {</span>
<a href="#l17.721"></a><span id="l17.721">                         log(&quot;getFreeBusyIntervals net_resp(): &quot; +</span>
<a href="#l17.722"></a><span id="l17.722" class="difflineminus">-                            getWcapRequestStatusString(xml), this_);</span>
<a href="#l17.723"></a><span id="l17.723" class="difflineplus">+                            getWcapRequestStatusString(xml), self);</span>
<a href="#l17.724"></a><span id="l17.724">                     }</span>
<a href="#l17.725"></a><span id="l17.725">                     if (listener) {</span>
<a href="#l17.726"></a><span id="l17.726">                         let ret = [];</span>
<a href="#l17.727"></a><span id="l17.727">                         let nodeList = xml.getElementsByTagName(&quot;FB&quot;);</span>
<a href="#l17.728"></a><span id="l17.728"> </span>
<a href="#l17.729"></a><span id="l17.729">                         let fbTypeMap = {};</span>
<a href="#l17.730"></a><span id="l17.730">                         fbTypeMap[&quot;FREE&quot;] = calIFreeBusyInterval.FREE;</span>
<a href="#l17.731"></a><span id="l17.731">                         fbTypeMap[&quot;BUSY&quot;] = calIFreeBusyInterval.BUSY;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/resources/content/datetimepickers/datetimepickers.xml</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/resources/content/datetimepickers/datetimepickers.xml</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -131,24 +131,24 @@</span>
<a href="#l18.4"></a><span id="l18.4">            for (let rel of this.mRelativeDates) {</span>
<a href="#l18.5"></a><span id="l18.5">              if (val == rel.word) {</span>
<a href="#l18.6"></a><span id="l18.6">                let now = new Date();</span>
<a href="#l18.7"></a><span id="l18.7">                now.setDate(now.getDate() + rel.offset);</span>
<a href="#l18.8"></a><span id="l18.8">                return now;</span>
<a href="#l18.9"></a><span id="l18.9">              }</span>
<a href="#l18.10"></a><span id="l18.10">            }</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-           let parser = this;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+           let self = this;</span>
<a href="#l18.14"></a><span id="l18.14"> </span>
<a href="#l18.15"></a><span id="l18.15">            // Takes a written day of the week and returns a js-date</span>
<a href="#l18.16"></a><span id="l18.16">            // corresponding to the nearest day in the future that is</span>
<a href="#l18.17"></a><span id="l18.17">            // that day of the week</span>
<a href="#l18.18"></a><span id="l18.18">            function getDateForDay(aWord) {</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-             for (let i in parser.mDayNames) {</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-               if (aWord != parser.mDayNames[i]) {</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+             for (let i in self.mDayNames) {</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+               if (aWord != self.mDayNames[i]) {</span>
<a href="#l18.23"></a><span id="l18.23">                  continue;</span>
<a href="#l18.24"></a><span id="l18.24">                }</span>
<a href="#l18.25"></a><span id="l18.25">                // Figure out what day of the week today is.</span>
<a href="#l18.26"></a><span id="l18.26">                let today = cal.now();</span>
<a href="#l18.27"></a><span id="l18.27"> </span>
<a href="#l18.28"></a><span id="l18.28">                // i-weekday gets the offset. Add 7 to ensure that the %</span>
<a href="#l18.29"></a><span id="l18.29">                // operation stays positive.</span>
<a href="#l18.30"></a><span id="l18.30">                let offset = (i - today.weekday + 7) % 7;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

