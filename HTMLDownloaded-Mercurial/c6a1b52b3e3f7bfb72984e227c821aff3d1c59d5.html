<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 3698:c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5" />
<meta property="og:url" content="/comm-central/rev/c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5" />
<meta property="og:description" content="merge of default" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5">shortlog</a> |
<a href="/comm-central/log/c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5">files</a> |
changeset |
<a href="/comm-central/raw-rev/c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5">raw</a>  | <a href="/comm-central/archive/c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
merge of default
<span class="logtags"><span class="inbranchtag" title="add-protovis">add-protovis</span> </span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 04 Sep 2009 15:55:58 -0700</td></tr>
<tr><td>branch</td><td>add-protovis</td></tr>
<tr>
 <td>changeset 3698</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5">c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5</a></td>
</tr>



<tr>
<td>parent 3691</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2900b9e8de1e35e783dd517583a1d95bcca480b2">2900b9e8de1e35e783dd517583a1d95bcca480b2</a> (current diff)
</td>
</tr>
<tr>
<td>parent 3540</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b11a45aa831d50594e7f23968bda9bc010103ef1">b11a45aa831d50594e7f23968bda9bc010103ef1</a> (<a href="/comm-central/rev/b11a45aa831d50594e7f23968bda9bc010103ef1:c6a1b52b3e3f">diff</a>)
</td>
</tr>

<tr>
<td>child 3699</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b7a1e8bc053a177768b2af5c4c8c3176163a1321">b7a1e8bc053a177768b2af5c4c8c3176163a1321</a>
</td>
</tr>
<tr>
<td>child 3705</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3786d789303cc727aabf6728454556705232a33e">3786d789303cc727aabf6728454556705232a33e</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5">2927</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Thu, 10 Sep 2009 01:15:56 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0b161ed73eb6 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&newProject=comm-central&newRevision=b5e0aff84bf4077a47919481912ad0bd11c6a8d8&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&newProject=comm-central&newRevision=b5e0aff84bf4077a47919481912ad0bd11c6a8d8&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&newProject=comm-central&newRevision=b5e0aff84bf4077a47919481912ad0bd11c6a8d8&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">merge of default</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5/.hgpatchinfo/add-protovis.dep">.hgpatchinfo/add-protovis.dep</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5/.hgpatchinfo/add-protovis.dep">file</a> |
<a href="/comm-central/annotate/c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5/.hgpatchinfo/add-protovis.dep">annotate</a> |
<a href="/comm-central/diff/c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5/.hgpatchinfo/add-protovis.dep">diff</a> |
<a href="/comm-central/comparison/c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5/.hgpatchinfo/add-protovis.dep">comparison</a> |
<a href="/comm-central/log/c6a1b52b3e3f7bfb72984e227c821aff3d1c59d5/.hgpatchinfo/add-protovis.dep">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.hgpatchinfo/add-protovis.dep</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.hgpatchinfo/add-protovis.dep</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,1 +1,1 @@</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineminus">-0bb2a0ee37c1af1c76d758c1eee1d99b18924704</span>
<a href="#l1.5"></a><span id="l1.5">\ No newline at end of file</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+b11a45aa831d50594e7f23968bda9bc010103ef1</span>
<a href="#l1.7"></a><span id="l1.7">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/confvars.sh</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/confvars.sh</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -44,17 +44,17 @@ MOZ_CALENDAR=1</span>
<a href="#l2.4"></a><span id="l2.4"> MOZ_APP_VERSION=$SUNBIRD_VERSION</span>
<a href="#l2.5"></a><span id="l2.5"> MOZ_PLAINTEXT_EDITOR_ONLY=1</span>
<a href="#l2.6"></a><span id="l2.6"> NECKO_PROTOCOLS_DEFAULT=&quot;about data file ftp http res viewsource&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> MOZ_NO_ACTIVEX_SUPPORT=1</span>
<a href="#l2.8"></a><span id="l2.8"> MOZ_ACTIVEX_SCRIPTING_SUPPORT=</span>
<a href="#l2.9"></a><span id="l2.9"> MOZ_INSTALLER=</span>
<a href="#l2.10"></a><span id="l2.10"> MOZ_MATHML=</span>
<a href="#l2.11"></a><span id="l2.11"> NECKO_DISK_CACHE=</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-if test &quot;$MOZILLA_BRANCH_VERSION&quot; = &quot;1.9.1&quot;; then</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+# MOZ_OJI is only required to be cleared for MOZILLA_1_9_1_BRANCH.</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+# mozilla-central does not have this.</span>
<a href="#l2.15"></a><span id="l2.15"> MOZ_OJI=</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-fi</span>
<a href="#l2.17"></a><span id="l2.17"> NECKO_COOKIES=</span>
<a href="#l2.18"></a><span id="l2.18"> MOZ_NO_XPCOM_OBSOLETE=1</span>
<a href="#l2.19"></a><span id="l2.19"> MOZ_EXTENSIONS_DEFAULT=</span>
<a href="#l2.20"></a><span id="l2.20"> MOZ_UNIVERSALCHARDET=</span>
<a href="#l2.21"></a><span id="l2.21"> MOZ_APP_VERSION=`cat $topsrcdir/$MOZ_BUILD_APP/sunbird/config/version.txt`</span>
<a href="#l2.22"></a><span id="l2.22"> SUNBIRD_VERSION=$MOZ_APP_VERSION</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/config/autoconf.mk.in</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/config/autoconf.mk.in</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -468,17 +468,16 @@ TK_CFLAGS	= @TK_CFLAGS@</span>
<a href="#l3.4"></a><span id="l3.4"> TK_LIBS		= @TK_LIBS@</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> CAIRO_FT_CFLAGS		= @CAIRO_FT_CFLAGS@</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> MOZ_TREE_FREETYPE		= @MOZ_TREE_FREETYPE@</span>
<a href="#l3.9"></a><span id="l3.9"> MOZ_ENABLE_GTK2		= @MOZ_ENABLE_GTK2@</span>
<a href="#l3.10"></a><span id="l3.10"> MOZ_ENABLE_QT		= @MOZ_ENABLE_QT@</span>
<a href="#l3.11"></a><span id="l3.11"> MOZ_ENABLE_PHOTON	= @MOZ_ENABLE_PHOTON@</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-MOZ_ENABLE_COCOA	= @MOZ_ENABLE_COCOA@</span>
<a href="#l3.13"></a><span id="l3.13"> MOZ_ENABLE_XREMOTE	= @MOZ_ENABLE_XREMOTE@</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15"> MOZ_GTK2_CFLAGS		= @MOZ_GTK2_CFLAGS@</span>
<a href="#l3.16"></a><span id="l3.16"> MOZ_GTK2_LIBS		= @MOZ_GTK2_LIBS@</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18"> MOZ_QT_CFLAGS		= @MOZ_QT_CFLAGS@</span>
<a href="#l3.19"></a><span id="l3.19"> MOZ_QT_LIBS		= @MOZ_QT_LIBS@</span>
<a href="#l3.20"></a><span id="l3.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/configure.in</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/configure.in</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -4830,17 +4830,16 @@ cairo-os2)</span>
<a href="#l4.4"></a><span id="l4.4">     TK_CFLAGS='$(MOZ_CAIRO_CFLAGS)'</span>
<a href="#l4.5"></a><span id="l4.5">     TK_LIBS='$(MOZ_CAIRO_LIBS)'</span>
<a href="#l4.6"></a><span id="l4.6">     ;;</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> cairo-mac|cairo-cocoa)</span>
<a href="#l4.9"></a><span id="l4.9">     if test &quot;$MOZ_WIDGET_TOOLKIT&quot; = &quot;cairo-cocoa&quot;; then</span>
<a href="#l4.10"></a><span id="l4.10">         MOZ_WIDGET_TOOLKIT=cocoa</span>
<a href="#l4.11"></a><span id="l4.11">         AC_DEFINE(MOZ_WIDGET_COCOA)</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-        MOZ_ENABLE_COCOA=1</span>
<a href="#l4.13"></a><span id="l4.13">     else</span>
<a href="#l4.14"></a><span id="l4.14">         MOZ_WIDGET_TOOLKIT=mac</span>
<a href="#l4.15"></a><span id="l4.15">     fi</span>
<a href="#l4.16"></a><span id="l4.16">     MOZ_USER_DIR=&quot;Mozilla&quot;</span>
<a href="#l4.17"></a><span id="l4.17">     AC_DEFINE(XP_MACOSX)</span>
<a href="#l4.18"></a><span id="l4.18">     AC_DEFINE(TARGET_CARBON)</span>
<a href="#l4.19"></a><span id="l4.19">     AC_DEFINE(TARGET_API_MAC_CARBON)</span>
<a href="#l4.20"></a><span id="l4.20">     TK_LIBS='-framework Carbon -framework AddressBook'</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -4945,17 +4944,16 @@ then</span>
<a href="#l4.22"></a><span id="l4.22"> fi</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24"> AC_SUBST(GTK_CONFIG)</span>
<a href="#l4.25"></a><span id="l4.25"> AC_SUBST(TK_CFLAGS)</span>
<a href="#l4.26"></a><span id="l4.26"> AC_SUBST(TK_LIBS)</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28"> AC_SUBST(MOZ_ENABLE_GTK2)</span>
<a href="#l4.29"></a><span id="l4.29"> AC_SUBST(MOZ_ENABLE_PHOTON)</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-AC_SUBST(MOZ_ENABLE_COCOA)</span>
<a href="#l4.31"></a><span id="l4.31"> AC_SUBST(MOZ_ENABLE_QT)</span>
<a href="#l4.32"></a><span id="l4.32"> AC_SUBST(MOZ_ENABLE_XREMOTE)</span>
<a href="#l4.33"></a><span id="l4.33"> AC_SUBST(MOZ_GTK2_CFLAGS)</span>
<a href="#l4.34"></a><span id="l4.34"> AC_SUBST(MOZ_GTK2_LIBS)</span>
<a href="#l4.35"></a><span id="l4.35"> AC_SUBST(MOZ_QT_CFLAGS)</span>
<a href="#l4.36"></a><span id="l4.36"> AC_SUBST(MOZ_QT_LIBS)</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38"> AC_SUBST(MOC)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/app/profile/all-thunderbird.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/app/profile/all-thunderbird.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -457,12 +457,13 @@ pref(&quot;toolbar.customization.usesheet&quot;, t</span>
<a href="#l5.4"></a><span id="l5.4"> pref(&quot;toolbar.customization.usesheet&quot;, false);</span>
<a href="#l5.5"></a><span id="l5.5"> #endif</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> // Check for missing attachments?</span>
<a href="#l5.8"></a><span id="l5.8"> pref(&quot;mail.compose.attachment_reminder&quot;, true);</span>
<a href="#l5.9"></a><span id="l5.9"> // Words that should trigger a missing attachments warning.</span>
<a href="#l5.10"></a><span id="l5.10"> pref(&quot;mail.compose.attachment_reminder_keywords&quot;, &quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;);</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+pref(&quot;browser.formfill.enable&quot;, true);</span>
<a href="#l5.13"></a><span id="l5.13"> // Override the all.js values so that unit tests pass and we get sane values.</span>
<a href="#l5.14"></a><span id="l5.14"> pref(&quot;browser.history_expire_days&quot;, 180);</span>
<a href="#l5.15"></a><span id="l5.15"> pref(&quot;browser.history_expire_days_min&quot;, 90);</span>
<a href="#l5.16"></a><span id="l5.16"> pref(&quot;browser.history_expire_sites&quot;, 40000);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/content/mailCore.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/content/mailCore.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -116,18 +116,18 @@ function MailToolboxCustomizeDone(aEvent</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">   // make sure the mail views search box is initialized</span>
<a href="#l6.6"></a><span id="l6.6">   if (document.getElementById(&quot;mailviews-container&quot;))</span>
<a href="#l6.7"></a><span id="l6.7">     ViewPickerOnLoad();</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9">   // make sure the folder location picker is initialized</span>
<a href="#l6.10"></a><span id="l6.10">   if (document.getElementById(&quot;folder-location-container&quot;))</span>
<a href="#l6.11"></a><span id="l6.11">   {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    loadFolderViewForTree(gCurrentFolderView, document.getElementById('folderLocationPopup').tree);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-    UpdateFolderLocationPicker(gFolderDisplay.displayedFolder);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+    // XXX FIXME: used to call loadFolderViewForTree  and UpdateFolderLocationPicker</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+    // but those were removed in changeset 1de58e1d7549</span>
<a href="#l6.16"></a><span id="l6.16">   }</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18">   gSearchInput = null;</span>
<a href="#l6.19"></a><span id="l6.19">   if (document.getElementById(&quot;search-container&quot;))</span>
<a href="#l6.20"></a><span id="l6.20">     GetSearchInput();</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22">   var customizePopup = document.getElementById(customizePopupId);</span>
<a href="#l6.23"></a><span id="l6.23">   customizePopup.removeAttribute(&quot;disabled&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -233,21 +233,27 @@ function view_init()</span>
<a href="#l7.4"></a><span id="l7.4"> function InitViewLayoutStyleMenu(event)</span>
<a href="#l7.5"></a><span id="l7.5"> {</span>
<a href="#l7.6"></a><span id="l7.6">   var paneConfig = pref.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l7.7"></a><span id="l7.7">   var layoutStyleMenuitem = event.target.childNodes[paneConfig];</span>
<a href="#l7.8"></a><span id="l7.8">   if (layoutStyleMenuitem)</span>
<a href="#l7.9"></a><span id="l7.9">     layoutStyleMenuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l7.10"></a><span id="l7.10"> }</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+/**</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ * Initialize (check) appropriate folder mode under the View | Folder menu.</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+ */</span>
<a href="#l7.15"></a><span id="l7.15"> function InitViewFolderViewsMenu(event)</span>
<a href="#l7.16"></a><span id="l7.16"> {</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-  var layoutStyleMenuitem = event.target.childNodes[gCurrentFolderView];</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-  if (layoutStyleMenuitem)</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-    layoutStyleMenuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+  for (let i = 0; i &lt; event.target.childNodes.length; i++) {</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+    if (event.target.childNodes[i].value == gFolderTreeView.mode) {</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+      event.target.childNodes[i].setAttribute(&quot;checked&quot;, true);</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+      break;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+    }</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+  }</span>
<a href="#l7.26"></a><span id="l7.26"> }</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28"> function setSortByMenuItemCheckState(id, value)</span>
<a href="#l7.29"></a><span id="l7.29"> {</span>
<a href="#l7.30"></a><span id="l7.30">   var menuitem = document.getElementById(id);</span>
<a href="#l7.31"></a><span id="l7.31">   if (menuitem)</span>
<a href="#l7.32"></a><span id="l7.32">     menuitem.setAttribute(&quot;checked&quot;, value);</span>
<a href="#l7.33"></a><span id="l7.33"> }</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineat">@@ -2278,31 +2284,26 @@ let mailTabType = {</span>
<a href="#l7.35"></a><span id="l7.35">         gFolderTreeView.selection.selectEventsSuppressed = false;</span>
<a href="#l7.36"></a><span id="l7.36">       }</span>
<a href="#l7.37"></a><span id="l7.37">     }</span>
<a href="#l7.38"></a><span id="l7.38"> </span>
<a href="#l7.39"></a><span id="l7.39">     // restore focus</span>
<a href="#l7.40"></a><span id="l7.40">     this.restoreFocus(aTab);</span>
<a href="#l7.41"></a><span id="l7.41">   },</span>
<a href="#l7.42"></a><span id="l7.42"> </span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-  supportsCommand: function(aTab, aCommand) {</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-    return DefaultController.supportsCommand(aCommand);</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-  },</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-  isCommandEnabled: function(aTab, aCommand) {</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-    return DefaultController.isCommandEnabled(aCommand);</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-  },</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-  doCommand: function(aTab, aCommand) {</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-    DefaultController.doCommand(aCommand, aTab);</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-  },</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-  onEvent: function(aTab, aEvent) {</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-    DefaultController.onEvent(aEvent);</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-  }</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+  //</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+  // nsIController implementation</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+  //</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+  // We ignore the aTab parameter sent by tabmail when calling nsIController</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+  // stuff and just delegate the call to a default controller by using it as</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+  // our proto chain:</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+  // - &quot;DefaultController&quot; is the default controller of messenger.xul</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+  // - &quot;MessageWindowController&quot; is the default controller of messageWindow.xul</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+  __proto__: &quot;DefaultController&quot; in window &amp;&amp; window.DefaultController ||</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+             &quot;MessageWindowController&quot; in window &amp;&amp; window.MessageWindowController</span>
<a href="#l7.68"></a><span id="l7.68"> };</span>
<a href="#l7.69"></a><span id="l7.69"> /**</span>
<a href="#l7.70"></a><span id="l7.70">  * The glodaSearch tab mode has a UI widget outside of the mailTabType's</span>
<a href="#l7.71"></a><span id="l7.71">  *  display panel, the #glodaSearchInput textbox.  This means we need to use a</span>
<a href="#l7.72"></a><span id="l7.72">  *  tab monitor so that we can appropriately update the contents of the textbox.</span>
<a href="#l7.73"></a><span id="l7.73">  * Every time a tab is changed, we save the state of the text box and restore</span>
<a href="#l7.74"></a><span id="l7.74">  *  its previous value for the tab we are switching to, as well as whether this</span>
<a href="#l7.75"></a><span id="l7.75">  *  value is a change to the currently-used value (if it is a glodaSearch) tab.</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineat">@@ -2444,27 +2445,29 @@ function MsgOpenNewWindowForMessage(aMsg</span>
<a href="#l7.77"></a><span id="l7.77"> }</span>
<a href="#l7.78"></a><span id="l7.78"> </span>
<a href="#l7.79"></a><span id="l7.79"> function MsgJunk()</span>
<a href="#l7.80"></a><span id="l7.80"> {</span>
<a href="#l7.81"></a><span id="l7.81">   MsgJunkMailInfo(true);</span>
<a href="#l7.82"></a><span id="l7.82">   JunkSelectedMessages(!SelectedMessagesAreJunk());</span>
<a href="#l7.83"></a><span id="l7.83"> }</span>
<a href="#l7.84"></a><span id="l7.84"> </span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+/**</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+ * Update the &quot;mark as junk&quot; button in the message header area.</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+ */</span>
<a href="#l7.89"></a><span id="l7.89"> function UpdateJunkButton()</span>
<a href="#l7.90"></a><span id="l7.90"> {</span>
<a href="#l7.91"></a><span id="l7.91">   // The junk message should slave off the selected message, as the preview pane</span>
<a href="#l7.92"></a><span id="l7.92">   //  may not be visible</span>
<a href="#l7.93"></a><span id="l7.93">   let hdr = gFolderDisplay.selectedMessage;</span>
<a href="#l7.94"></a><span id="l7.94">   // But only the message display knows if we are dealing with a dummy.</span>
<a href="#l7.95"></a><span id="l7.95">   if (!hdr || gMessageDisplay.isDummy) // .eml file</span>
<a href="#l7.96"></a><span id="l7.96">     return;</span>
<a href="#l7.97"></a><span id="l7.97">   let junkScore = hdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-  let hideJunk = (junkScore != &quot;&quot;) &amp;&amp; (junkScore != &quot;0&quot;);</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+  let hideJunk = (junkScore == Components.interfaces.nsIJunkMailPlugin.IS_SPAM_SCORE);</span>
<a href="#l7.100"></a><span id="l7.100">   if (gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l7.101"></a><span id="l7.101">     hideJunk = true;</span>
<a href="#l7.102"></a><span id="l7.102"> </span>
<a href="#l7.103"></a><span id="l7.103">   getCurrentMsgHdrButtonBox().getButton('hdrJunkButton').disabled = hideJunk;</span>
<a href="#l7.104"></a><span id="l7.104"> }</span>
<a href="#l7.105"></a><span id="l7.105"> </span>
<a href="#l7.106"></a><span id="l7.106"> function MsgMarkMsgAsRead()</span>
<a href="#l7.107"></a><span id="l7.107"> {</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineat">@@ -3050,28 +3053,28 @@ function HandleJunkStatusChanged(folder)</span>
<a href="#l7.109"></a><span id="l7.109">     // We may be forcing junk mail to be rendered with sanitized html.</span>
<a href="#l7.110"></a><span id="l7.110">     // In that scenario, we want to reload the message if the status has just</span>
<a href="#l7.111"></a><span id="l7.111">     // changed to not junk.</span>
<a href="#l7.112"></a><span id="l7.112">     var sanitizeJunkMail = gPrefBranch.getBoolPref(&quot;mail.spam.display.sanitize&quot;);</span>
<a href="#l7.113"></a><span id="l7.113"> </span>
<a href="#l7.114"></a><span id="l7.114">     // Only bother doing this if we are modifying the html for junk mail....</span>
<a href="#l7.115"></a><span id="l7.115">     if (sanitizeJunkMail)</span>
<a href="#l7.116"></a><span id="l7.116">     {</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-      var moveJunkMail = (folder &amp;&amp; folder.server &amp;&amp; folder.server.spamSettings) ?</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-                          folder.server.spamSettings.manualMark : false;</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-      var junkScore = msgHdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-      var isJunk = (junkScore == &quot;&quot;) || (junkScore == &quot;0&quot;);</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-      // We used to only reload the message if we were toggling the message</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-      // to NOT JUNK from junk but it can be useful to see the HTML in the</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-      // message get converted to sanitized form when a message is marked as</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-      // junk. Furthermore, if we are about to move the message that was just</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-      // marked as junk then don't bother reloading it.</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-      if (!(isJunk &amp;&amp; moveJunkMail))</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+      let junkScore = msgHdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+      let isJunk = (junkScore == Components.interfaces.nsIJunkMailPlugin.IS_SPAM_SCORE);</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+      // If the current row  isn't going to change, reload to show sanitized or</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+      // unsanitized. Otherwise we wouldn't see the reloaded version anyway.</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+      // 1) When marking as non-junk, the msg would move back to the inbox.</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+      // 2) When marking as junk, the msg will move or delete, if manualMark is set.</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+      // 3) Marking as junk in the junk folder just changes the junk status.</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+      if ((!isJunk &amp;&amp; folder.isSpecialFolder(Components.interfaces.nsMsgFolderFlags.Inbox)) ||</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+          (isJunk &amp;&amp; !folder.server.spamSettings.manualMark) ||</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+          (isJunk &amp;&amp; folder.isSpecialFolder(Components.interfaces.nsMsgFolderFlags.Junk)))</span>
<a href="#l7.141"></a><span id="l7.141">         ReloadMessage();</span>
<a href="#l7.142"></a><span id="l7.142">     }</span>
<a href="#l7.143"></a><span id="l7.143">   }</span>
<a href="#l7.144"></a><span id="l7.144"> }</span>
<a href="#l7.145"></a><span id="l7.145"> </span>
<a href="#l7.146"></a><span id="l7.146"> var gMessageNotificationBar =</span>
<a href="#l7.147"></a><span id="l7.147"> {</span>
<a href="#l7.148"></a><span id="l7.148">   mBarStatus: 0,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1024,29 +1024,38 @@</span>
<a href="#l8.4"></a><span id="l8.4">             &lt;menuitem id=&quot;messagePaneVertical&quot; type=&quot;radio&quot; label=&quot;&amp;messagePaneVertical.label;&quot; name=&quot;viewlayoutgroup&quot;</span>
<a href="#l8.5"></a><span id="l8.5">                       accesskey=&quot;&amp;messagePaneVertical.accesskey;&quot; oncommand=&quot;ChangeMailLayout(kVerticalMailLayout);&quot;/&gt;</span>
<a href="#l8.6"></a><span id="l8.6">             &lt;menuseparator id=&quot;viewMenuAfterPaneVerticalSeparator&quot;/&gt;</span>
<a href="#l8.7"></a><span id="l8.7">             &lt;menuitem id=&quot;menu_showMessage&quot; type=&quot;checkbox&quot; label=&quot;&amp;showMessageCmd.label;&quot; key=&quot;key_toggleMessagePane&quot;</span>
<a href="#l8.8"></a><span id="l8.8">                       accesskey=&quot;&amp;showMessageCmd.accesskey;&quot; oncommand=&quot;MsgToggleMessagePane();&quot;/&gt;</span>
<a href="#l8.9"></a><span id="l8.9">           &lt;/menupopup&gt;</span>
<a href="#l8.10"></a><span id="l8.10">         &lt;/menu&gt;</span>
<a href="#l8.11"></a><span id="l8.11">         &lt;menu id=&quot;menu_FolderViews&quot; label=&quot;&amp;folderView.label;&quot; accesskey=&quot;&amp;folderView.accesskey;&quot;&gt;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-          &lt;menupopup id=&quot;menu_FolderViewsPopup&quot; onpopupshowing=&quot;InitViewFolderViewsMenu(event)&quot;&gt;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-            &lt;menuitem id=&quot;menu_allFolders&quot;      label=&quot;&amp;allFolders.label;&quot; accesskey=&quot;&amp;allFolders.accesskey;&quot;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+          &lt;menupopup id=&quot;menu_FolderViewsPopup&quot;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+                     onpopupshowing=&quot;InitViewFolderViewsMenu(event)&quot;&gt;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+            &lt;menuitem id=&quot;menu_allFolders&quot; value=&quot;all&quot;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+                      label=&quot;&amp;allFolders.label;&quot;</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+                      accesskey=&quot;&amp;allFolders.accesskey;&quot;</span>
<a href="#l8.19"></a><span id="l8.19">                       type=&quot;radio&quot; name=&quot;viewmessages&quot;</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-                      oncommand=&quot;gFolderTreeView.mode = 'all';&quot;/&gt;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-            &lt;menuitem id=&quot;menu_unreadFolders&quot;   label=&quot;&amp;unreadFolders.label;&quot; accesskey=&quot;&amp;unreadFolders.accesskey;&quot;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+                      oncommand=&quot;gFolderTreeView.mode = this.value;&quot;/&gt;</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+            &lt;menuitem id=&quot;menu_unreadFolders&quot;</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+                      label=&quot;&amp;unreadFolders.label;&quot; value=&quot;unread&quot;</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+                      accesskey=&quot;&amp;unreadFolders.accesskey;&quot;</span>
<a href="#l8.26"></a><span id="l8.26">                       type=&quot;radio&quot; name=&quot;viewmessages&quot;</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-                      oncommand=&quot;gFolderTreeView.mode = 'unread';&quot;/&gt;</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-            &lt;menuitem id=&quot;menu_favoriteFolders&quot; label=&quot;&amp;favoriteFolders.label;&quot; accesskey=&quot;&amp;favoriteFolders.accesskey;&quot;</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+                      oncommand=&quot;gFolderTreeView.mode = this.value;&quot;/&gt;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+            &lt;menuitem id=&quot;menu_favoriteFolders&quot; value=&quot;favorite&quot;</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+                      label=&quot;&amp;favoriteFolders.label;&quot;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+                      accesskey=&quot;&amp;favoriteFolders.accesskey;&quot;</span>
<a href="#l8.33"></a><span id="l8.33">                       type=&quot;radio&quot; name=&quot;viewmessages&quot;</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-                      oncommand=&quot;gFolderTreeView.mode = 'favorite';&quot;/&gt;</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-            &lt;menuitem id=&quot;menu_recentFolders&quot;   label=&quot;&amp;recentFolders.label;&quot; accesskey=&quot;&amp;recentFolders.accesskey;&quot;</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+                      oncommand=&quot;gFolderTreeView.mode = this.value;&quot;/&gt;</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+            &lt;menuitem id=&quot;menu_recentFolders&quot; value=&quot;recent&quot;</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+                      label=&quot;&amp;recentFolders.label;&quot;</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+                      accesskey=&quot;&amp;recentFolders.accesskey;&quot;</span>
<a href="#l8.40"></a><span id="l8.40">                       type=&quot;radio&quot; name=&quot;viewmessages&quot;</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-                      oncommand=&quot;gFolderTreeView.mode = 'recent';&quot;/&gt;</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+                      oncommand=&quot;gFolderTreeView.mode = this.value;&quot;/&gt;</span>
<a href="#l8.43"></a><span id="l8.43">           &lt;/menupopup&gt;</span>
<a href="#l8.44"></a><span id="l8.44">         &lt;/menu&gt;</span>
<a href="#l8.45"></a><span id="l8.45">         &lt;menuseparator id=&quot;viewSortMenuSeparator&quot;/&gt;</span>
<a href="#l8.46"></a><span id="l8.46">         &lt;menu id=&quot;viewSortMenu&quot; accesskey=&quot;&amp;sortMenu.accesskey;&quot; label=&quot;&amp;sortMenu.label;&quot;&gt;</span>
<a href="#l8.47"></a><span id="l8.47">           &lt;menupopup id=&quot;menu_viewSortPopup&quot; onpopupshowing=&quot;InitViewSortByMenu()&quot;&gt;</span>
<a href="#l8.48"></a><span id="l8.48">             &lt;menuitem id=&quot;sortByDateMenuitem&quot; type=&quot;radio&quot; name=&quot;sortby&quot; label=&quot;&amp;sortByDateCmd.label;&quot; accesskey=&quot;&amp;sortByDateCmd.accesskey;&quot; oncommand=&quot;MsgSortThreadPane('byDate')&quot;/&gt;</span>
<a href="#l8.49"></a><span id="l8.49">             &lt;menuitem id=&quot;sortByReceivedMenuitem&quot; type=&quot;radio&quot; name=&quot;sortby&quot; label=&quot;&amp;sortByReceivedCmd.label;&quot; accesskey=&quot;&amp;sortByReceivedCmd.accesskey;&quot; oncommand=&quot;MsgSortThreadPane('byReceived')&quot;/&gt;</span>
<a href="#l8.50"></a><span id="l8.50">             &lt;menuitem id=&quot;sortByFlagMenuitem&quot; type=&quot;radio&quot; name=&quot;sortby&quot; label=&quot;&amp;sortByStarCmd.label;&quot; accesskey=&quot;&amp;sortByStarCmd.accesskey;&quot; oncommand=&quot;MsgSortThreadPane('byFlagged')&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -61,17 +61,16 @@ const kVerticalPaneConfig = 2;</span>
<a href="#l9.4"></a><span id="l9.4"> const kNumFolderViews = 4; // total number of folder views</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> /** widget with id=messagepanebox, initialized by GetMessagePane() */</span>
<a href="#l9.7"></a><span id="l9.7"> var gMessagePane;</span>
<a href="#l9.8"></a><span id="l9.8"> /** widget with id=searchInput, initialized by GetSearchInput() */</span>
<a href="#l9.9"></a><span id="l9.9"> var gSearchInput;</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> var gThreadAndMessagePaneSplitter = null;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-var gCurrentFolderView;</span>
<a href="#l9.13"></a><span id="l9.13"> var gStartFolderUri = null;</span>
<a href="#l9.14"></a><span id="l9.14"> /**</span>
<a href="#l9.15"></a><span id="l9.15">  * Tracks whether the right mouse button changed the selection or not.  If the</span>
<a href="#l9.16"></a><span id="l9.16">  * user right clicks on the selection, it stays the same.  If they click outside</span>
<a href="#l9.17"></a><span id="l9.17">  * of it, we alter the selection (but not the current index) to be the row they</span>
<a href="#l9.18"></a><span id="l9.18">  * clicked on.</span>
<a href="#l9.19"></a><span id="l9.19">  *</span>
<a href="#l9.20"></a><span id="l9.20">  * The value of this variable is an object with &quot;view&quot; and &quot;selection&quot; keys</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/base/content/specialTabs.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/base/content/specialTabs.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -159,17 +159,17 @@ var specialTabs = {</span>
<a href="#l10.4"></a><span id="l10.4">     },</span>
<a href="#l10.5"></a><span id="l10.5">     restoreTab: function onRestoreTab(aTabmail, aPersistedState) {</span>
<a href="#l10.6"></a><span id="l10.6">       aTabmail.openTab(&quot;contentTab&quot;, { contentPage: aPersistedState.tabURI,</span>
<a href="#l10.7"></a><span id="l10.7">                                        background: true } );</span>
<a href="#l10.8"></a><span id="l10.8">     },</span>
<a href="#l10.9"></a><span id="l10.9">     onTitleChanged: function onTitleChanged(aTab) {</span>
<a href="#l10.10"></a><span id="l10.10">       aTab.title = aTab.browser.contentDocument.title;</span>
<a href="#l10.11"></a><span id="l10.11">     },</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    supportsCommand: function supportsCommand(aTab, aCommand) {</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    supportsCommand: function supportsCommand(aCommand, aTab) {</span>
<a href="#l10.14"></a><span id="l10.14">       switch (aCommand) {</span>
<a href="#l10.15"></a><span id="l10.15">         case &quot;cmd_fullZoomReduce&quot;:</span>
<a href="#l10.16"></a><span id="l10.16">         case &quot;cmd_fullZoomEnlarge&quot;:</span>
<a href="#l10.17"></a><span id="l10.17">         case &quot;cmd_fullZoomReset&quot;:</span>
<a href="#l10.18"></a><span id="l10.18">         case &quot;cmd_fullZoomToggle&quot;:</span>
<a href="#l10.19"></a><span id="l10.19">         case &quot;cmd_find&quot;:</span>
<a href="#l10.20"></a><span id="l10.20">         case &quot;cmd_findAgain&quot;:</span>
<a href="#l10.21"></a><span id="l10.21">         case &quot;cmd_findPrevious&quot;:</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineat">@@ -178,17 +178,17 @@ var specialTabs = {</span>
<a href="#l10.23"></a><span id="l10.23">         case &quot;button_print&quot;:</span>
<a href="#l10.24"></a><span id="l10.24">         // XXX print preview not currently supported - bug 497994 to implement.</span>
<a href="#l10.25"></a><span id="l10.25">         // case &quot;cmd_printpreview&quot;:</span>
<a href="#l10.26"></a><span id="l10.26">           return true;</span>
<a href="#l10.27"></a><span id="l10.27">         default:</span>
<a href="#l10.28"></a><span id="l10.28">           return false;</span>
<a href="#l10.29"></a><span id="l10.29">       }</span>
<a href="#l10.30"></a><span id="l10.30">     },</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-    isCommandEnabled: function isCommandEnabled(aTab, aCommand) {</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+    isCommandEnabled: function isCommandEnabled(aCommand, aTab) {</span>
<a href="#l10.33"></a><span id="l10.33">       switch (aCommand) {</span>
<a href="#l10.34"></a><span id="l10.34">         case &quot;cmd_fullZoomReduce&quot;:</span>
<a href="#l10.35"></a><span id="l10.35">         case &quot;cmd_fullZoomEnlarge&quot;:</span>
<a href="#l10.36"></a><span id="l10.36">         case &quot;cmd_fullZoomReset&quot;:</span>
<a href="#l10.37"></a><span id="l10.37">         case &quot;cmd_fullZoomToggle&quot;:</span>
<a href="#l10.38"></a><span id="l10.38">         case &quot;cmd_find&quot;:</span>
<a href="#l10.39"></a><span id="l10.39">         case &quot;cmd_findAgain&quot;:</span>
<a href="#l10.40"></a><span id="l10.40">         case &quot;cmd_findPrevious&quot;:</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineat">@@ -197,17 +197,17 @@ var specialTabs = {</span>
<a href="#l10.42"></a><span id="l10.42">         case &quot;button_print&quot;:</span>
<a href="#l10.43"></a><span id="l10.43">         // XXX print preview not currently supported - bug 497994 to implement.</span>
<a href="#l10.44"></a><span id="l10.44">         // case &quot;cmd_printpreview&quot;:</span>
<a href="#l10.45"></a><span id="l10.45">           return true;</span>
<a href="#l10.46"></a><span id="l10.46">         default:</span>
<a href="#l10.47"></a><span id="l10.47">           return false;</span>
<a href="#l10.48"></a><span id="l10.48">       }</span>
<a href="#l10.49"></a><span id="l10.49">     },</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-    doCommand: function isCommandEnabled(aTab, aCommand) {</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+    doCommand: function isCommandEnabled(aCommand, aTab) {</span>
<a href="#l10.52"></a><span id="l10.52">       switch (aCommand) {</span>
<a href="#l10.53"></a><span id="l10.53">         case &quot;cmd_fullZoomReduce&quot;:</span>
<a href="#l10.54"></a><span id="l10.54">           ZoomManager.reduce();</span>
<a href="#l10.55"></a><span id="l10.55">           break;</span>
<a href="#l10.56"></a><span id="l10.56">         case &quot;cmd_fullZoomEnlarge&quot;:</span>
<a href="#l10.57"></a><span id="l10.57">           ZoomManager.enlarge();</span>
<a href="#l10.58"></a><span id="l10.58">           break;</span>
<a href="#l10.59"></a><span id="l10.59">         case &quot;cmd_fullZoomReset&quot;:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/base/content/specialTabs.xul</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/base/content/specialTabs.xul</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -31,21 +31,33 @@</span>
<a href="#l11.4"></a><span id="l11.4">    - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l11.5"></a><span id="l11.5">    - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l11.6"></a><span id="l11.6">    - and other provisions required by the LGPL or the GPL. If you do not delete</span>
<a href="#l11.7"></a><span id="l11.7">    - the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.8"></a><span id="l11.8">    - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.9"></a><span id="l11.9">    -</span>
<a href="#l11.10"></a><span id="l11.10">    - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+&lt;!DOCTYPE overlay [</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+&lt;!ENTITY % globalDTD SYSTEM &quot;chrome://global/locale/global.dtd&quot;&gt;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+%globalDTD;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+]&gt;</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+</span>
<a href="#l11.17"></a><span id="l11.17"> &lt;overlay id=&quot;specialTabs&quot;</span>
<a href="#l11.18"></a><span id="l11.18">          xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+  &lt;popupset id=&quot;mainPopupSet&quot;&gt;</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+    &lt;!-- for search and content formfill/pw manager --&gt;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+    &lt;panel type=&quot;autocomplete&quot; id=&quot;PopupAutoComplete&quot; level=&quot;top&quot;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+           noautofocus=&quot;true&quot; chromedir=&quot;&amp;locale.dir;&quot;/&gt;</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+  &lt;/popupset&gt;</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+</span>
<a href="#l11.26"></a><span id="l11.26">   &lt;vbox id=&quot;contentTab&quot; collapsed=&quot;true&quot;&gt;</span>
<a href="#l11.27"></a><span id="l11.27">     &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l11.28"></a><span id="l11.28">       &lt;notificationbox flex=&quot;1&quot;&gt;</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-        &lt;browser type=&quot;content-targetable&quot; flex=&quot;1&quot; disablehistory=&quot;true&quot;/&gt;</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+        &lt;browser type=&quot;content-targetable&quot; flex=&quot;1&quot; disablehistory=&quot;true&quot;</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+                 autocompletepopup=&quot;PopupAutoComplete&quot;/&gt;</span>
<a href="#l11.32"></a><span id="l11.32">       &lt;/notificationbox&gt;</span>
<a href="#l11.33"></a><span id="l11.33">       &lt;findbar/&gt;</span>
<a href="#l11.34"></a><span id="l11.34">     &lt;/vbox&gt;</span>
<a href="#l11.35"></a><span id="l11.35">   &lt;/vbox&gt;</span>
<a href="#l11.36"></a><span id="l11.36"> &lt;/overlay&gt;</span>
<a href="#l11.37"></a><span id="l11.37"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/base/content/tabmail.xml</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/base/content/tabmail.xml</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -200,25 +200,25 @@</span>
<a href="#l12.4"></a><span id="l12.4">     -     opened.  This may seem odd, but it should help keep your code simple</span>
<a href="#l12.5"></a><span id="l12.5">     -     while letting you do whatever you want.  Since openTab is synchronous</span>
<a href="#l12.6"></a><span id="l12.6">     -     and returns the tabInfo structure built for the tab, you can perform</span>
<a href="#l12.7"></a><span id="l12.7">     -     any additional work you need after the call to openTab.</span>
<a href="#l12.8"></a><span id="l12.8">     - * onTitleChanged(aTab): Called when someone calls tabmail.setTabTitle() to</span>
<a href="#l12.9"></a><span id="l12.9">     -     hint that the tab's title needs to be updated.  This function should</span>
<a href="#l12.10"></a><span id="l12.10">     -     update aTab.title if it can.</span>
<a href="#l12.11"></a><span id="l12.11">     - Mode definition functions to do with menu/toolbar commands:</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    - * supportsCommand(aTab, aCommand): Called when a menu or toolbar needs to</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+    - * supportsCommand(aCommand, aTab): Called when a menu or toolbar needs to</span>
<a href="#l12.14"></a><span id="l12.14">     -     be updated. Return true if you support that command in</span>
<a href="#l12.15"></a><span id="l12.15">     -     isCommandEnabled and doCommand, return false otherwise.</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-    - * isCommandEnabled(aTab, aCommand): Called when a menu or toolbar needs</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+    - * isCommandEnabled(aCommand, aTab): Called when a menu or toolbar needs</span>
<a href="#l12.18"></a><span id="l12.18">     -     to be updated. Return true if the command can be executed at the</span>
<a href="#l12.19"></a><span id="l12.19">     -     current time, false otherwise.</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-    - * doCommand(aTab, aCommand): Called when a menu or toolbar command is to</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+    - * doCommand(aCommand, aTab): Called when a menu or toolbar command is to</span>
<a href="#l12.22"></a><span id="l12.22">     -     be executed. Perform the action appropriate to the command.</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-    - * onEvent(aTab, aEvent): This can be used to handle different events on</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+    - * onEvent(aEvent, aTab): This can be used to handle different events on</span>
<a href="#l12.25"></a><span id="l12.25">     -     the window.</span>
<a href="#l12.26"></a><span id="l12.26">     - * getBrowser(aTab): This function should return the browser element for</span>
<a href="#l12.27"></a><span id="l12.27">     -     your tab if there is one (return null or don't define this function</span>
<a href="#l12.28"></a><span id="l12.28">     -     otherwise). It is used for some toolkit functions that require a</span>
<a href="#l12.29"></a><span id="l12.29">     -     global &quot;getBrowser&quot; function, e.g. ZoomManager.</span>
<a href="#l12.30"></a><span id="l12.30">     -</span>
<a href="#l12.31"></a><span id="l12.31">     - Tab monitoring code is expected to be used for widgets on the screen</span>
<a href="#l12.32"></a><span id="l12.32">     -  outside of the tab box that need to update themselves as the active tab</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineat">@@ -968,17 +968,17 @@</span>
<a href="#l12.34"></a><span id="l12.34">              // This can happen if we're starting up and haven't got a tab</span>
<a href="#l12.35"></a><span id="l12.35">              // loaded yet.</span>
<a href="#l12.36"></a><span id="l12.36">              if (!tab)</span>
<a href="#l12.37"></a><span id="l12.37">                return false;</span>
<a href="#l12.38"></a><span id="l12.38"> </span>
<a href="#l12.39"></a><span id="l12.39">              let supportsCommandFunc = tab.mode.supportsCommand ||</span>
<a href="#l12.40"></a><span id="l12.40">                                        tab.mode.tabType.supportsCommand;</span>
<a href="#l12.41"></a><span id="l12.41">              if (supportsCommandFunc)</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-               return supportsCommandFunc.call(tab.mode.tabType, tab, aCommand);</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+               return supportsCommandFunc.call(tab.mode.tabType, aCommand, tab);</span>
<a href="#l12.44"></a><span id="l12.44"> </span>
<a href="#l12.45"></a><span id="l12.45">              return false;</span>
<a href="#l12.46"></a><span id="l12.46">            ]]&gt;</span>
<a href="#l12.47"></a><span id="l12.47">         &lt;/body&gt;</span>
<a href="#l12.48"></a><span id="l12.48">       &lt;/method&gt;</span>
<a href="#l12.49"></a><span id="l12.49">       &lt;method name=&quot;isCommandEnabled&quot;&gt;</span>
<a href="#l12.50"></a><span id="l12.50">         &lt;parameter name=&quot;aCommand&quot;/&gt;</span>
<a href="#l12.51"></a><span id="l12.51">         &lt;body&gt;</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineat">@@ -988,17 +988,17 @@</span>
<a href="#l12.53"></a><span id="l12.53">              // This can happen if we're starting up and haven't got a tab</span>
<a href="#l12.54"></a><span id="l12.54">              // loaded yet.</span>
<a href="#l12.55"></a><span id="l12.55">              if (!tab)</span>
<a href="#l12.56"></a><span id="l12.56">                return false;</span>
<a href="#l12.57"></a><span id="l12.57"> </span>
<a href="#l12.58"></a><span id="l12.58">              let isCommandEnabledFunc = tab.mode.isCommandEnabled ||</span>
<a href="#l12.59"></a><span id="l12.59">                                         tab.mode.tabType.isCommandEnabled;</span>
<a href="#l12.60"></a><span id="l12.60">              if (isCommandEnabledFunc)</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineminus">-               return isCommandEnabledFunc.call(tab.mode.tabType, tab, aCommand);</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+               return isCommandEnabledFunc.call(tab.mode.tabType, aCommand, tab);</span>
<a href="#l12.63"></a><span id="l12.63"> </span>
<a href="#l12.64"></a><span id="l12.64">              return false;</span>
<a href="#l12.65"></a><span id="l12.65">            ]]&gt;</span>
<a href="#l12.66"></a><span id="l12.66">         &lt;/body&gt;</span>
<a href="#l12.67"></a><span id="l12.67">       &lt;/method&gt;</span>
<a href="#l12.68"></a><span id="l12.68">       &lt;method name=&quot;doCommand&quot;&gt;</span>
<a href="#l12.69"></a><span id="l12.69">         &lt;parameter name=&quot;aCommand&quot;/&gt;</span>
<a href="#l12.70"></a><span id="l12.70">         &lt;body&gt;</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineat">@@ -1008,17 +1008,17 @@</span>
<a href="#l12.72"></a><span id="l12.72">              // This can happen if we're starting up and haven't got a tab</span>
<a href="#l12.73"></a><span id="l12.73">              // loaded yet.</span>
<a href="#l12.74"></a><span id="l12.74">              if (!tab)</span>
<a href="#l12.75"></a><span id="l12.75">                return;</span>
<a href="#l12.76"></a><span id="l12.76"> </span>
<a href="#l12.77"></a><span id="l12.77">              let doCommandFunc = tab.mode.doCommand ||</span>
<a href="#l12.78"></a><span id="l12.78">                                  tab.mode.tabType.doCommand;</span>
<a href="#l12.79"></a><span id="l12.79">              if (doCommandFunc)</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-               doCommandFunc.call(tab.mode.tabType, tab, aCommand);</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+               doCommandFunc.call(tab.mode.tabType, aCommand, tab);</span>
<a href="#l12.82"></a><span id="l12.82">            ]]&gt;</span>
<a href="#l12.83"></a><span id="l12.83">         &lt;/body&gt;</span>
<a href="#l12.84"></a><span id="l12.84">       &lt;/method&gt;</span>
<a href="#l12.85"></a><span id="l12.85">       &lt;method name=&quot;onEvent&quot;&gt;</span>
<a href="#l12.86"></a><span id="l12.86">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l12.87"></a><span id="l12.87">         &lt;body&gt;</span>
<a href="#l12.88"></a><span id="l12.88">            &lt;![CDATA[</span>
<a href="#l12.89"></a><span id="l12.89">              let tab = this.currentTabInfo;</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineat">@@ -1026,17 +1026,17 @@</span>
<a href="#l12.91"></a><span id="l12.91">              // This can happen if we're starting up and haven't got a tab</span>
<a href="#l12.92"></a><span id="l12.92">              // loaded yet.</span>
<a href="#l12.93"></a><span id="l12.93">              if (!tab)</span>
<a href="#l12.94"></a><span id="l12.94">                return;</span>
<a href="#l12.95"></a><span id="l12.95"> </span>
<a href="#l12.96"></a><span id="l12.96">              let onEventFunc = tab.mode.onEvent ||</span>
<a href="#l12.97"></a><span id="l12.97">                                tab.mode.tabType.onEvent;</span>
<a href="#l12.98"></a><span id="l12.98">              if (onEventFunc)</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineminus">-               return onEventFunc.call(tab.mode.tabType, tab, aEvent);</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+               return onEventFunc.call(tab.mode.tabType, aEvent, tab);</span>
<a href="#l12.101"></a><span id="l12.101"> </span>
<a href="#l12.102"></a><span id="l12.102">              return false;</span>
<a href="#l12.103"></a><span id="l12.103">            ]]&gt;</span>
<a href="#l12.104"></a><span id="l12.104">         &lt;/body&gt;</span>
<a href="#l12.105"></a><span id="l12.105">       &lt;/method&gt;</span>
<a href="#l12.106"></a><span id="l12.106">       &lt;!-- Set the document title based on the tab title --&gt;</span>
<a href="#l12.107"></a><span id="l12.107">       &lt;method name=&quot;setDocumentTitle&quot;&gt;</span>
<a href="#l12.108"></a><span id="l12.108">         &lt;parameter name=&quot;aTab&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/components/search/content/searchCommon.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/components/search/content/searchCommon.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -404,41 +404,60 @@ let SearchSupport =</span>
<a href="#l13.4"></a><span id="l13.4">       this.__foldersToIndex = this._foldersToIndexGenerator();</span>
<a href="#l13.5"></a><span id="l13.5">     return this.__foldersToIndex;</span>
<a href="#l13.6"></a><span id="l13.6">   },</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8">   _findNextHdrToIndex: function search_find_next_header()</span>
<a href="#l13.9"></a><span id="l13.9">   {</span>
<a href="#l13.10"></a><span id="l13.10">     try</span>
<a href="#l13.11"></a><span id="l13.11">     {</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+      let reindexTime = this._getLastReindexTime(this._currentFolderToIndex);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+      this._log.debug(&quot;Reindex time for this folder is &quot; + reindexTime);</span>
<a href="#l13.14"></a><span id="l13.14">       if (!this._headerEnumerator)</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-        this._headerEnumerator = this._currentFolderToIndex.messages;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+      {</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+        //  we need to create search terms for messages to index</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+        let searchSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+                              .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+        let searchTerms = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+        searchSession.addScopeTerm(Ci.nsMsgSearchScope.offlineMail, this._currentFolderToIndex);</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+        let nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+        let nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+        // first term: (_hdrIndexProperty &lt; reindexTime)</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+        let searchTerm = searchSession.createTerm();</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+        searchTerm.booleanAnd = false; // actually don't care here</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+        searchTerm.attrib = nsMsgSearchAttrib.Uint32HdrProperty;</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+        searchTerm.op = nsMsgSearchOp.IsLessThan;</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+        value = searchTerm.value;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+        value.attrib = searchTerm.attrib;</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+        searchTerm.hdrProperty = this._hdrIndexedProperty;</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+        value.status = reindexTime;</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+        searchTerm.value = value;</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+        searchTerms.appendElement(searchTerm, false);</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+        this._headerEnumerator = this._currentFolderToIndex.msgDatabase</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+                                 .getFilterEnumerator(searchTerms);</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+      }</span>
<a href="#l13.39"></a><span id="l13.39"> </span>
<a href="#l13.40"></a><span id="l13.40">       // iterate over the folder finding the next message to index</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-      let reindexTime = this._getLastReindexTime(this._currentFolderToIndex);</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-      this._log.debug(&quot;Reindex time for this folder is &quot; + reindexTime);</span>
<a href="#l13.43"></a><span id="l13.43">       while (this._headerEnumerator.hasMoreElements())</span>
<a href="#l13.44"></a><span id="l13.44">       {</span>
<a href="#l13.45"></a><span id="l13.45">         let msgHdr = this._headerEnumerator.getNext()</span>
<a href="#l13.46"></a><span id="l13.46">                          .QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l13.47"></a><span id="l13.47"> </span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-        if (msgHdr.getUint32Property(this._hdrIndexedProperty) &lt; reindexTime)</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+        // Check if the file exists. If it does, then assume indexing to be</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+        // complete for this file</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+        if (this._getSupportFile(msgHdr).exists())</span>
<a href="#l13.52"></a><span id="l13.52">         {</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-          // Check if the file exists. If it does, then assume indexing to be</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-          // complete for this file</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-          if (this._getSupportFile(msgHdr).exists())</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-          {</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-            this._log.debug(&quot;Message time not set but file exists; setting &quot; +</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-                            &quot;time to &quot; + reindexTime);</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-            msgHdr.setUint32Property(this._hdrIndexedProperty, reindexTime);</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-          }</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-          else</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-          {</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-            return [msgHdr, reindexTime];</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-          }</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+          this._log.debug(&quot;Message time not set but file exists; setting &quot; +</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+                          &quot;time to &quot; + reindexTime);</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+          msgHdr.setUint32Property(this._hdrIndexedProperty, reindexTime);</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+        }</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+        else</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+        {</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+          return [msgHdr, reindexTime];</span>
<a href="#l13.72"></a><span id="l13.72">         }</span>
<a href="#l13.73"></a><span id="l13.73">       }</span>
<a href="#l13.74"></a><span id="l13.74">     }</span>
<a href="#l13.75"></a><span id="l13.75">     catch(ex) { this._log.debug(&quot;Error while finding next header: &quot; + ex); }</span>
<a href="#l13.76"></a><span id="l13.76"> </span>
<a href="#l13.77"></a><span id="l13.77">     // If we couldn't find any headers to index, null out the enumerator</span>
<a href="#l13.78"></a><span id="l13.78">     this._headerEnumerator = null;</span>
<a href="#l13.79"></a><span id="l13.79">     if (! (this._currentFolderToIndex.flags &amp; Ci.nsMsgFolderFlags.Inbox))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/confvars.sh</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/confvars.sh</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -36,19 +36,19 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #</span>
<a href="#l14.5"></a><span id="l14.5"> # ***** END LICENSE BLOCK *****</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7"> MOZ_APP_NAME=thunderbird</span>
<a href="#l14.8"></a><span id="l14.8"> MOZ_UPDATER=1</span>
<a href="#l14.9"></a><span id="l14.9"> MOZ_THUNDERBIRD=1</span>
<a href="#l14.10"></a><span id="l14.10"> MOZ_NO_ACTIVEX_SUPPORT=1</span>
<a href="#l14.11"></a><span id="l14.11"> MOZ_ACTIVEX_SCRIPTING_SUPPORT=</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-if test &quot;$MOZILLA_BRANCH_VERSION&quot; = &quot;1.9.1&quot;; then</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+# MOZ_OJI is only required to be cleared for MOZILLA_1_9_1_BRANCH.</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+# mozilla-central does not have this.</span>
<a href="#l14.15"></a><span id="l14.15"> MOZ_OJI=</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-fi</span>
<a href="#l14.17"></a><span id="l14.17"> NECKO_PROTOCOLS_DEFAULT=&quot;about data file ftp http res viewsource&quot;</span>
<a href="#l14.18"></a><span id="l14.18"> MOZ_IMG_DECODERS_DEFAULT=`echo &quot;$MOZ_IMG_DECODERS_DEFAULT&quot; | sed &quot;s/ xbm//&quot;`</span>
<a href="#l14.19"></a><span id="l14.19"> MOZ_MAIL_NEWS=1</span>
<a href="#l14.20"></a><span id="l14.20"> if [ &quot;$COMM_BUILD&quot; ]; then</span>
<a href="#l14.21"></a><span id="l14.21">   MOZ_LDAP_XPCOM=1</span>
<a href="#l14.22"></a><span id="l14.22"> fi</span>
<a href="#l14.23"></a><span id="l14.23"> MOZ_STATIC_MAIL_BUILD=1</span>
<a href="#l14.24"></a><span id="l14.24"> MOZ_COMPOSER=1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/installer/removed-files.in</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/installer/removed-files.in</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -45,22 +45,31 @@ components/accessibility-atk.xpt</span>
<a href="#l15.4"></a><span id="l15.4"> components/airbag.xpt</span>
<a href="#l15.5"></a><span id="l15.5"> components/bookmarks.xpt</span>
<a href="#l15.6"></a><span id="l15.6"> components/downloadmanager.xpt</span>
<a href="#l15.7"></a><span id="l15.7"> components/compreg.dat</span>
<a href="#l15.8"></a><span id="l15.8"> components/history.xpt</span>
<a href="#l15.9"></a><span id="l15.9"> components/jsconsole.xpt</span>
<a href="#l15.10"></a><span id="l15.10"> components/mailnews.xpt</span>
<a href="#l15.11"></a><span id="l15.11"> components/mozgnome.xpt</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+#ifdef MOZILLA_1_9_1_BRANCH</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+components/satchel.xpt</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+#endif</span>
<a href="#l15.15"></a><span id="l15.15"> components/@DLL_PREFIX@myspell@DLL_SUFFIX@</span>
<a href="#l15.16"></a><span id="l15.16"> components/necko_data.xpt</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+#ifdef MOZILLA_1_9_1_BRANCH</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+components/GPSDGeolocationProvider.js</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+#endif</span>
<a href="#l15.20"></a><span id="l15.20"> components/nsBackgroundUpdateService.js</span>
<a href="#l15.21"></a><span id="l15.21"> components/nsCloseAllWindows.js</span>
<a href="#l15.22"></a><span id="l15.22"> components/nsComposerCmdLineHandler.js</span>
<a href="#l15.23"></a><span id="l15.23"> components/nsDownloadProgressListener.js</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+#ifdef MOZILLA_1_9_1_BRANCH</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+components/nsFormAutoComplete.js</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+#endif</span>
<a href="#l15.27"></a><span id="l15.27"> components/nsInterfaceInfoToIDL.js</span>
<a href="#l15.28"></a><span id="l15.28"> components/nsLDAPPrefsService.js</span>
<a href="#l15.29"></a><span id="l15.29"> #ifdef XP_WIN</span>
<a href="#l15.30"></a><span id="l15.30"> #ifndef MOZILLA_1_9_1_BRANCH</span>
<a href="#l15.31"></a><span id="l15.31"> components/nsPostUpdateWin.js</span>
<a href="#l15.32"></a><span id="l15.32"> #endif</span>
<a href="#l15.33"></a><span id="l15.33"> #endif</span>
<a href="#l15.34"></a><span id="l15.34"> components/nsScriptableIO.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/installer/windows/packages-static</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/installer/windows/packages-static</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -278,16 +278,19 @@ bin\components\pref.xpt</span>
<a href="#l16.4"></a><span id="l16.4"> ; profile</span>
<a href="#l16.5"></a><span id="l16.5"> bin\components\profile.xpt</span>
<a href="#l16.6"></a><span id="l16.6"> bin\components\toolkitprofile.xpt</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> ; toolkit</span>
<a href="#l16.9"></a><span id="l16.9"> bin\components\commandlines.xpt</span>
<a href="#l16.10"></a><span id="l16.10"> bin\components\chrome.xpt</span>
<a href="#l16.11"></a><span id="l16.11"> bin\components\nsDefaultCLH.js</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+#ifndef MOZILLA_1_9_1_BRANCH</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+bin\components\nsFormAutoComplete.js</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+#endif</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16"> ; rdf</span>
<a href="#l16.17"></a><span id="l16.17"> bin\components\rdf.xpt</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19"> ; required i18n libraries</span>
<a href="#l16.20"></a><span id="l16.20"> bin\components\intl.xpt</span>
<a href="#l16.21"></a><span id="l16.21"> bin\components\locale.xpt</span>
<a href="#l16.22"></a><span id="l16.22"> bin\components\uconv.xpt</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineat">@@ -313,16 +316,19 @@ bin\components\dom_storage.xpt</span>
<a href="#l16.24"></a><span id="l16.24"> bin\components\dom_stylesheets.xpt</span>
<a href="#l16.25"></a><span id="l16.25"> bin\components\dom_threads.xpt</span>
<a href="#l16.26"></a><span id="l16.26"> bin\components\dom_traversal.xpt</span>
<a href="#l16.27"></a><span id="l16.27"> bin\components\dom_views.xpt</span>
<a href="#l16.28"></a><span id="l16.28"> bin\components\dom_xbl.xpt</span>
<a href="#l16.29"></a><span id="l16.29"> bin\components\dom_xul.xpt</span>
<a href="#l16.30"></a><span id="l16.30"> bin\components\dom_loadsave.xpt</span>
<a href="#l16.31"></a><span id="l16.31"> bin\components\NetworkGeolocationProvider.js</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+#ifndef MOZILLA_1_9_1_BRANCH</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+bin\components\GPSDGeolocationProvider.js</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+#endif</span>
<a href="#l16.35"></a><span id="l16.35"> </span>
<a href="#l16.36"></a><span id="l16.36"> ; editor / composer for HTML compose</span>
<a href="#l16.37"></a><span id="l16.37"> bin\components\editor.xpt</span>
<a href="#l16.38"></a><span id="l16.38"> bin\components\composer.xpt</span>
<a href="#l16.39"></a><span id="l16.39"> bin\components\txmgr.xpt</span>
<a href="#l16.40"></a><span id="l16.40"> </span>
<a href="#l16.41"></a><span id="l16.41"> ; find functionality</span>
<a href="#l16.42"></a><span id="l16.42"> ; Optional - only if your code uses nsIWebBrowserFind</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineat">@@ -409,16 +415,19 @@ bin\components\windowds.xpt</span>
<a href="#l16.44"></a><span id="l16.44"> bin\components\dom_xpath.xpt</span>
<a href="#l16.45"></a><span id="l16.45"> bin\AccessibleMarshal.dll</span>
<a href="#l16.46"></a><span id="l16.46"> bin\components\lwbrk.xpt</span>
<a href="#l16.47"></a><span id="l16.47"> bin\components\nsTryToClose.js</span>
<a href="#l16.48"></a><span id="l16.48"> bin\components\pluginGlue.js</span>
<a href="#l16.49"></a><span id="l16.49"> bin\components\txEXSLTRegExFunctions.js</span>
<a href="#l16.50"></a><span id="l16.50"> bin\components\feeds.xpt</span>
<a href="#l16.51"></a><span id="l16.51"> bin\components\saxparser.xpt</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+#ifndef MOZILLA_1_9_1_BRANCH</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+bin\components\satchel.xpt</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+#endif</span>
<a href="#l16.55"></a><span id="l16.55"> bin\components\shistory.xpt</span>
<a href="#l16.56"></a><span id="l16.56"> bin\components\zipwriter.xpt</span>
<a href="#l16.57"></a><span id="l16.57"> bin\components\nsBadCertHandler.js</span>
<a href="#l16.58"></a><span id="l16.58"> bin\components\cookie.xpt</span>
<a href="#l16.59"></a><span id="l16.59"> bin\components\places.xpt</span>
<a href="#l16.60"></a><span id="l16.60"> bin\components\prefetch.xpt</span>
<a href="#l16.61"></a><span id="l16.61"> </span>
<a href="#l16.62"></a><span id="l16.62"> bin\res\hiddenWindow.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/themes/gnomestripe/mail/folderPane.css</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/themes/gnomestripe/mail/folderPane.css</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -135,17 +135,16 @@ treechildren::-moz-tree-image(folderName</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5"> .tabmail-tab[type=&quot;folder&quot;][SpecialFolder=&quot;Archive&quot;] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image,</span>
<a href="#l17.6"></a><span id="l17.6"> treechildren::-moz-tree-image(folderNameCol, specialFolder-Archive) {</span>
<a href="#l17.7"></a><span id="l17.7">   background-image: url(&quot;chrome://messenger/skin/icons/folder-pane.png&quot;);</span>
<a href="#l17.8"></a><span id="l17.8">   background-position: left -192px;</span>
<a href="#l17.9"></a><span id="l17.9">   list-style-image: url(&quot;chrome://messenger/skin/icons/folder-blank.png&quot;);</span>
<a href="#l17.10"></a><span id="l17.10"> }</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-</span>
<a href="#l17.13"></a><span id="l17.13"> /* ..... Shared folders .....</span>
<a href="#l17.14"></a><span id="l17.14"> </span>
<a href="#l17.15"></a><span id="l17.15"> treechildren::-moz-tree-image(folderNameCol, imapShared-true) {</span>
<a href="#l17.16"></a><span id="l17.16">   -moz-image-region: rect(0 192px 16px 176px);</span>
<a href="#l17.17"></a><span id="l17.17"> }</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19"> */ </span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21" class="difflineat">@@ -153,16 +152,23 @@ treechildren::-moz-tree-image(folderName</span>
<a href="#l17.22"></a><span id="l17.22"> </span>
<a href="#l17.23"></a><span id="l17.23"> .tabmail-tab[type=&quot;folder&quot;][SpecialFolder=&quot;Virtual&quot;] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image,</span>
<a href="#l17.24"></a><span id="l17.24"> treechildren::-moz-tree-image(folderNameCol, specialFolder-Virtual) {</span>
<a href="#l17.25"></a><span id="l17.25">   background-image: url(&quot;chrome://messenger/skin/icons/folder-pane.png&quot;);</span>
<a href="#l17.26"></a><span id="l17.26">   background-position: left -128px;</span>
<a href="#l17.27"></a><span id="l17.27">   list-style-image: url(&quot;chrome://messenger/skin/icons/folder-blank.png&quot;);</span>
<a href="#l17.28"></a><span id="l17.28"> }</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+/* .....  Newsgroup .....  */</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+.tabmail-tab[type=&quot;folder&quot;][ServerType=&quot;nntp&quot;] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image {</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+  background-image: url(&quot;chrome://messenger/skin/icons/folder-pane.png&quot;);</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+  background-position: left -208px;</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/folder-blank.png&quot;);</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+}</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+</span>
<a href="#l17.37"></a><span id="l17.37"> /* ..... Account nodes ..... */</span>
<a href="#l17.38"></a><span id="l17.38"> .tabmail-tab[type=&quot;folder&quot;][IsServer=&quot;true&quot;] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image {</span>
<a href="#l17.39"></a><span id="l17.39">   -moz-margin-start: 0px;</span>
<a href="#l17.40"></a><span id="l17.40">   background-image: url(&quot;chrome://messenger/skin/icons/folder-pane.png&quot;);</span>
<a href="#l17.41"></a><span id="l17.41">   background-position: left -16px;</span>
<a href="#l17.42"></a><span id="l17.42">   list-style-image: url(&quot;chrome://messenger/skin/icons/folder-blank.png&quot;);</span>
<a href="#l17.43"></a><span id="l17.43"> }</span>
<a href="#l17.44"></a><span id="l17.44"> </span>
<a href="#l17.45"></a><span id="l17.45" class="difflineat">@@ -188,23 +194,16 @@ treechildren::-moz-tree-image(folderName</span>
<a href="#l17.46"></a><span id="l17.46"> </span>
<a href="#l17.47"></a><span id="l17.47"> /* ..... Secure news server ..... */</span>
<a href="#l17.48"></a><span id="l17.48"> .tabmail-tab[type=&quot;folder&quot;][IsServer=&quot;true&quot;][ServerType=&quot;nntp&quot;][IsSecure=&quot;true&quot;] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image {</span>
<a href="#l17.49"></a><span id="l17.49">   background-image: none;</span>
<a href="#l17.50"></a><span id="l17.50">   list-style-image: url(&quot;chrome://messenger/skin/icons/server.png&quot;);</span>
<a href="#l17.51"></a><span id="l17.51">   -moz-image-region: rect(0 80px 16px 64px);</span>
<a href="#l17.52"></a><span id="l17.52"> }</span>
<a href="#l17.53"></a><span id="l17.53"> </span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-/* .....  Newsgroup .....  */</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-.tabmail-tab[type=&quot;folder&quot;][ServerType=&quot;nntp&quot;] &gt; .tab-image-middle &gt; .tab-icon &gt; .tab-icon-image {</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-  background-image: none;</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-  list-style-image: url(&quot;chrome://messenger/skin/icons/server.png&quot;);</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-  -moz-image-region: rect(0 160px 16px 144px);</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-}</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-</span>
<a href="#l17.61"></a><span id="l17.61"> treechildren::-moz-tree-image(folderNameCol, specialFolder-Virtual, newMessages-true) {</span>
<a href="#l17.62"></a><span id="l17.62">   list-style-image: url(&quot;chrome://messenger/skin/icons/folder.png&quot;);</span>
<a href="#l17.63"></a><span id="l17.63">   -moz-image-region: rect(16px 176px 32px 160px);</span>
<a href="#l17.64"></a><span id="l17.64"> }</span>
<a href="#l17.65"></a><span id="l17.65"> </span>
<a href="#l17.66"></a><span id="l17.66"> treechildren::-moz-tree-cell-text(folderNameCol, newMessages-true),</span>
<a href="#l17.67"></a><span id="l17.67"> treechildren::-moz-tree-cell-text(folderNameCol, specialFolder-Inbox, newMessages-true) {</span>
<a href="#l17.68"></a><span id="l17.68">   font-weight: bold;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">index 106eba272d621db42bfc67d0ffaee5da67ed5fe4..5427e77b8ffc21649cd8b7884421eadc2c86f2b5</span>
<a href="#l18.2"></a><span id="l18.2">GIT binary patch
literal 6546
zc$@)}8Exi?P)&lt;h;3K|Lk000e1NJLTq000mG007_!1^@s63Ss7W00001b5ch_0Itp)
z=&gt;Px#24YJ`L;(K){{a7&gt;y{D4^000SaNLh0L01FcU01FcV0GgZ_00007bV*G`2iXT7
z2q`ouUPgET02vZVL_t(&amp;-tC)rm{vuW|36jtzNvF0=g`oosD!})0)k&gt;f)ODR;_#rrk
zaes`XGUKeP4!AlfhB1vJm}VT;urf1&lt;2^7&gt;pf}*H^3f(9YyPMA8P50ia+CSdF+jKY3
zJNw5zzvoxaQ_sD(-a6kpRdwprsZ-|_B-6tWKYWR0S&lt;eU|BwZw948U#k=FNLDRVGp|
zk38~7+qAQ$X6NMO;&lt;~y6v26=H*Wt}K-ceG@?0NI%#R2Rzk`Pv5VF6cN{WpTSAOsi^
zPk?x&lt;;F%&gt;CBLp-wG^880+qWa|gu*U%5eS3;Ap|XLQR-_9t*vp);hd%Whrt*_+=DjP
zj}YK`ih~WU#2pVS9z-ckJQnX9pt-3TV+@|Qh?oGLr-?Z(R#p*NS)gMIV+@UrjRb?i
zP5_#l0fBG@ZM)oLsZ5Wu9W&amp;(S254$(vI+`vP6O7o188b$(oWpr^;a+HY8G)_m&amp;V3M
zQ`)2OrF-sKaK-Jn-}P=9ps}&amp;&gt;#_O)VeyPC-jFHA98aKwI=3jv!6v|qVo0GHG_W5rG
z-W7+pa=}FxOdB_5?5eA0&amp;ymGNMKrfG^X8jxs1&lt;L#dE1KRD;@xN;)y46Y@cWh1#=3-
zL$5v*DvlRa219|qQc9#Hks|T5q=l3MDXkP2NGU&lt;EqiSze?d;jtOtPKbk?Fn1l$V}x
z{0aDcer(&amp;uXZx@$8!0U?25mIaXp~4af+Z#E*MC%|jCwvHp|&lt;~r1$l-3NF&gt;IAs-5I!
z=OqPPB!sA?g@FSGpp;_&amp;fqnGvKajkFLUvSCx&amp;XE%&lt;@p5#1z-&amp;Q`wYO-s@&lt;66=jGwL
zE+7~(cqp-WoZdZqiGbht6W~ExDYa+C8?Q?t1jm|;F&lt;_|X|BWP8t$yn)Ddn?Dseaud
zv@C0%)_M-_y}xpAI2&lt;&lt;JO&gt;J$h=Dqjd*=sB1^$P?7M4}Nw!5|&gt;g@}I~${jPQ5JMP5E
z%gskA)lVkbAr_5t@L&amp;x}d1$TBTBEgY2L^_QhI-&lt;$7?x$Blp?Kxv$C&gt;qU5_0V+wnXP
zrBYd?bLGwolu~48XQ!8U8o={B3JMAcg|gYOaXqf&lt;qLhc{d3c`7$DeE@J3E_#f&amp;!FM
zX#hL5$~@0at~P&lt;^d8}OZ4r5L}8Gy~7ZzeB4A1NhT&gt;vjspc3m$mp3N=I)YQ~4ZtOVf
z&gt;g)O7?;ij#Y2su`ii@eJtUw4seqMeOz{B?3M9bkw7$@#fHoOdglHy`6p4DExl?^YW
zwzigVBurspabgS-eN|Y}qO`R1r~*`4T8bqTGmsjCeQj;6{d)KA+bt1pY-#}5XUAf(
zIV;}$+p~`A_Dj#XZZAZ-U0EXAwzbc3-8ugYR^y`k?=k-ffDQ1g`TzRgBEE0&amp;y@$58
zg9i_Gi?~OR9v$t2yYIdmfN|r-@#&amp;|Zrr*y!_gnzpe*0~J^mk(W?Ifj$4}b4+3{vTi
zJMK7Q&lt;;&lt;2l1xT@&amp;NpN`C;XwA`KMoi$0DwJv_H@~5mmGAKj+q0;aXM6V9EWMsrgd80
zB?l?iQ)$hbH5~xXJoC&amp;nNE#sSI82%}DQR6M9!}h0!h{K6%pr?2$w3DICm!d64?dtB
zf}kC7qR231@&gt;Ei)&amp;&lt;3cjt0NwFIQ7(1@jNeSTo^C{1lX3HY0RRGO4dsNy!PdnUtBt&gt;
zd{kOpAA^O!XP&lt;2XSS&lt;h+-G9$V!0FvxjJN&amp;r_S@{Io_gxF&gt;gww5694e7yY6}wfCUQ{
zbbDuBuwa4dAP4pJ_32$F(_Tuw3n8#9i~Rij&amp;P7&gt;kO+`gTJA!t)PYBA(%a6PkMvNG7
zL=KL)n1m4RIOw2#kA;J&gt;va(KEjA2Y5VIv=HIagLzw)=79$dNz@hylT)ccC*5gb)Z3
zIyQw;QBiTk!Ao#-lv(JU195Z?gb?i5v7^(LQ={J*P^TPp269w6C@L!Y?`^InB_(ez
zT)6Q3?huufl)UmkXCHL+!&gt;pzLddsr20F?4PV&lt;&gt;t3S|{F}jV15e^Y5~a@L2Ntzbj=_
zr;W)Yu_q;b(DVq}bge7xMfcxxS|AYkeWUrld~4QoeubN~T-){30u#M(i609eqa$;j
z0x_T&gt;9*_Tv9S8)T`r$wS`1l?@da~ufEEcW#XJ(&amp;wGYELU=@9^~yXbZ&gt;@W;0w;+Ioi
z;l#ev{M9v8$G`fYFFz+8#~InPXD`~qtqjf^%eCVl=Y^GzV2c3ScquK;pI1G~|2cUv
zL-NPd7H*|?uRb`AGdMknOP2m2trL3(rt&lt;U~zh%w^zXaf!H-Ag-&lt;}=vx&amp;Ox^DBtD;y
zo95k|ISU3M1Y^gINy3d`b5jw|y&gt;%bb7L3Z8!NmS^(&lt;8EV%eM3w*_i`2c+gNR%K~5+
zzams=(GWYpRVOS$Bt=Fk#nvs`I+ug``r3A?&gt;(s)lFh)~fS4*b$P7loCYJKfTA0@?8
zGGfGV^78WlXl-j_$MzkEhz)6XkezY?&amp;As}kX%nDwXC)u4Tib4&lt;IsLSWj3^tKc&gt;&gt;Si
zz(B&gt;$?P)JXj~+dlGkb2kx=k&amp;O?5O-EU1!Wm&lt;JxzjM~_~R;iqay94HPmZ+oWQAhvBM
zeQdVxyV|;gWdr*U?A9W#IarNt+xu&lt;Tb#8d+&lt;rkmPS`X@$9uRV`QtG;+x-IUw^VY$6
z`FRthFiU|fphjzP+5B7Y{OG8L=Hdqy4wBNW1Cu{&lt;=4HXsk{&amp;V;%!&gt;d1$@?Dye$WA6
z@dJ0ugpM%B3Bjd8n47Qt=}lR&amp;SPa{?F~%UJEX&gt;W#&amp;wc(+PhLCwsvDMwWJ_g2nk5+V
zg%IZIls=g|cV5VIT`P5dE-C5Bwr!i;K79tPUiIFJ5wowlVTf4#z{1{AnzzqBYu4yh
z?=I*1&gt;uwfWYwGK3@%sb#d_LORT4`%*0bx&lt;GW1BZ+$_$pTc=h%Ay85f75L^%R4+Q*T
z;DEuxaU5c?7`t}uq^fE^(P#wQ_OW;09$H!&amp;IrGeOt&amp;cxms~a2YE(Fe!2y@Qdx%2Y;
zen0VeoHc9S!sqibWXN!$(J;ms_8-_oNpTO#hL0i^iweu&lt;^PhC$cuPvNKnfTu!1nut
zOqp^H!C)4fH*X{-Cy&amp;vi$C964$mkQsFmmK^IF7^iim&amp;kbe4KLX6adT4&amp;dDVbX){7d
zkvi74wY9Ku&lt;A;=&amp;k0vWCht}3+_V3@zuHD}&lt;s(dtkdiTR&lt;Wq@p32w7uUR&amp;S*YmSr(~
zcsb3@jnvg0O!t4?x;5nF&lt;S=;P5c2c#sjl9K=P3ge+gj^QLdcn+kWVP3&gt;DjY4mSs^^
zHY)8$5kjzg_b!xD96VUV$tREJ(@!@@ZNyyL@AnUV^|crF6yz5U6jF-fq7p32A{5HT
z7)2&lt;Q&amp;FQC4rLC=vhK4!@4H`yaVIjM|uM`;Zt!-J&gt;W06R-AQp|xJO8{(OZ|SI|DBb~
zO=)RQ6YvLRV^agMXq2X=2F8pzg}l519((*=v=)ywH@AG1UQ7=&gt;xNwmW=BhC#Pblr(
zyFWvRmLY_&amp;jWM`xoOnFWbI(7XRIFmw{9EsQy~FOj_&lt;@BZ5KNWA+z9jn3IOYnW)k&lt;_
zddr&gt;v_CM=CIMR&gt;nU*J(-pjKQoaW&lt;w~+xz-Iai`xe=Z3Q7bZPO2Zn3rQkNoV@SM0D`
zGt;;=GtH;3$hP%=qSKSPc&lt;AB9cW9&amp;M8)JL`rGYQ3@}lLwF;l0~QvVhJxy9%3#rq$!
zz41J^CN^Fr_X&lt;x+&gt;v0x8xG2)n(ri4&gt;Gj)63G#g(G8mH&lt;!&lt;5rz#8ou_K`fV7e&gt;Kx-7
zILB;!F=*;`zivFwGc7I6=Dx-EdbZZumz|x%!Mz`{d*jt;1D~#5gZ5&amp;aa_%geYnQX&gt;
z-Bk$b2Vm!hxePjO8Kr$s#~5?yMESyNAEWip(|w!R&lt;Bs$`X*8^&gt;`8C=ks{5)oa?`xi
zj$|JIdj$qfZt3|*&gt;upXRa}o&amp;uvD*hVwY~UkO=7o}z9NPWDMLvAvD*jMu-Dp6SA9d%
z|F;jivJZq1s&lt;o}v?yh~%+SUS~ZOgJAU;6YPZjw@3-C1y2Ywh#-mx#?*FhE-JVWZ8=
z)Pg#?ae*tOSfQ2qg)MFCk&lt;ybUURXM2vXr*JotuM{Pu&amp;&gt;MDxI|x^VM!ye^K4npGsRR
zJ+sGzvnAE*5W_A;^gadCumjVu9qPZqG&lt;^puL1&gt;hh0FePoMo*Lnw{4nfV~iz(Ss2Tp
z!x8MfA&amp;BDR52&gt;uZ@8f;47$S8DV-oYEVo2KtLvl5GE+!Vidw&amp;7Wikp$8BawZ^Vx4&gt;?
z*0AZ=B`2ac{uZ@sRhk=;*GUq&lt;xN%IR6|47Pe1k?I?I&gt;pVO5!hEfV2DtgyqMYx)|B-
zj6_}60WY2b5R0NCt%&amp;j~ux9=dYwA77&lt;Npb(v@dGgOT?ZS2TmK-&gt;34z%V&amp;YM7V;KPP
zFecK9i93jbVOXPngzuau@SVRDS=b*Ft-^VGJ|epmd&amp;)vgG@JlA#6cJnZpB;quS6H*
z5nVh4we?lx;4`t$eh}k0c$=1@cD{#Iela4aKPDE**cY5=0wg&amp;wrg0bXmwt%a`YP72
zv$2Ms3tFK*e&lt;4BCcPyC9K{SbFYfrqH&amp;~5v%CnnBA&amp;O5gyl*{lL3GqGfSrT9zBx#cB
z$AVx8-=td+d42Frx)p*UOn5&amp;g-iqvfA_PO|=I_9bAp4Dn)M^Bfp%CO1;I4ZJ-)X&lt;V
zUH&gt;pvUIA!@xAp-LGV!ex?%x*!CP9+~Q22e8DC~v#&gt;Q6-1{|+m^2vLymCwLnl0s&amp;U9
ze#!3#K}hV;GXaz&gt;B`cb~`eat&amp;s0o687M3yT{((XE*Xf0o=)cBzE=@bO7%5qiSk97%
zjb^3+-!a+*u8^$InqU0m2FB(&amp;p#`|{+cCPmMhaxD81qcz!lPeMxbfTj{^&amp;Oy)Y&lt;-*
z?&gt;Z*GijC0{;JXdW(}hD$odw3o%~wgc3&amp;st;z$0UxiOjbX{@-M@LWb9&amp;?~fNAQv1S?
zye$L-T0r$H3+4gyZNM1ig4XGMVb97XSPlC+ZCjNNX2A5&gt;pp`E%h*w~wKZMEHRDAh8
z81%Cx$Y5T3RUT_)_ftP3Uh^Fo!&lt;auKY+?H;Td+Dqcp$R-OAfqp7vb-=5bQIMtg;jE
z7x%(nQpTWvc^Y8_*#7HG1H)*Vw&lt;erZPVE80JHDa+Rlg%^$Z15rThHD&lt;{v1Xo8gS|=
z$RGXVq`%#Cv=bv0Tj_V@Lo{so54PS=Lc@mtpx;#w6RFtRe$PnSs2u=eRlCU^I*G=Q
zUM6o$;u#t+o&gt;&lt;lH&amp;geS=1P2bIZO3Ygr(HwKmJJk7orBwW04pcI-874?ILID8n!V58
zL~i*Mj(hMsN~YWZ$|KZ!6wRAHJj6oM8tHI$_7#*+aLObOu3SX?+3OJg5Oz*4hR%P7
z?;pFAme1CbfBa?XJ|rbgl7GTw?c8656ApdUtoR+f9=jBOQGeo9;lv&amp;(QmgR_j7aUu
zLZthad8d*H%8_J&gt;yN&lt;On=FbT6-UlnIwbnh8rc2HADKmPl{&amp;3Z9rPKf^Wv$kFfRyrp
zF(yw6Sv_sa+5O)8VC6w$Opy?xK{`&amp;n=kzHvm_B6&amp;0+IjLsuji&lt;({tM7v#~8JM=39A
zTXyiwGtROQl)U}!8%7G5d*&amp;HuS)S*Xir3%zi#dPBERH1xBlFVsgSD%po^oq#W6YlS
z-d|aA)|uyI-M_4o_1hadT*zdm@_yMY_;DHGNZ1c%lpTx3PxL&amp;m+8D!^yPBAGQW1Wi
z?DSA&amp;fHyYQ;CUW?pFbXpM|Vk#`O;_GDsjx!c*+oSR60j9vQj2d$MZP#2d8B@PQ28P
z#bX0zo_A3)OhBQu#?xI|XK15Q%45yn--{Y!YNghuan&lt;U#+C0xgX@jc_aZeL&gt;J7(8A
z#6dV5_Q&amp;J#5w_#R%j+BJcc;6c4X&amp;p&lt;JtX&gt;UnFMgLEXz^K+axVZerVf1&lt;#`@jYm_!P
zO5=F#bKF(9N~2Yxe-lrg6mlGAn5~o=cJ5iztwa|R07{#~+`&gt;tnXh0&gt;80P8lajYuJ@
zr4S;zZsWSPROE-zhMa&amp;+Zm?rE8NlI4IN&amp;L7w5_!+Z*Fed2{3kOE^9xpIifU&lt;9+Zdx
z2?j%s6OVr@o__Ahia;RHcj_6_vWzk53yPG;cJ&amp;Rg;_c&lt;wN~^(&gt;Cr-8B`{3PZJRbA;
ze10`!+Btz$YgWcx*RfLHso!nO*3+h(&lt;xidN#M0+}UxlI2U}9S95-H_DfygqL$hC8B
zEL!^P@2izoJ*Bj2wN`y&gt;+x}cBH8Q#U52P+EuK-@?hFNgsZNI$z#q&gt;&amp;BbpJiwx^GMd
zJ(P4%s+%@#YBxxAb#;szHxApju`CPQwlf3!WCyh_gg{D}zH^!}V+NZyZ$9E&gt;m27{b
zA(2vISr${LP6c4&gt;*s&lt;j0&lt;#l}vaySQ&gt;Emc)jVT_@np`m*m?AWmbpU+1{MFmnywr&lt;_p
zWj8u-V2ok&lt;^y!q8lrU=4C&lt;+S;Iq}33357z()`gUW)z#G@grK#xH4$&lt;ZiyfT&lt;fUmy#
zD$Q=@`^O)Dd~98qK7Bfcg@xF*%}FPnL{3f)Qc5OFn2&lt;iXAJvnU2&gt;48-Xf&amp;E0o6OX+
zXOBP!fUm#)I=usFt@+}MFWQAmY}l~j(2iYmFy29wFT3orcCAdFJo$*&lt;nE+SbxA@*}
ztwzB4UlLvjaM_iEFVR{q&gt;mI58)oU;Ay5GL^@}ZZNm!JO16+iiPx5$_M&lt;&lt;a|K)n*%b
z&lt;%*yDnx#vh=fK`QNNHhN@`%sLQzr3Gm(1hS&amp;sM!F4_&amp;~0h2QVT?+*|Nq;im8Fi0&gt;M
zN&lt;M=G0s*QHRJEVR%F54q^s&amp;X=&gt;cZyFRwoAW(#wY~0e(7p@(-x0-ib~|LMqSTc?RWa
z97p523ePoY4PG){(HOH-09&lt;&lt;cP;&lt;-t%V}uZn)DGFTAJbrk%MjJ)6le+)|M!dutzMe
zC@dJlCm(;pYcGB)?9Qz*C@$*9fW8TTS~&amp;bQU+s8@a8@hPs6l&amp;H$JHpsp~60;Gm%!1
zo!&gt;uAB=Sun+!*lLA%ejGrN#Lj0R$G7^b_zG5DW~UU$4t?y%^u_Ud7Ju-=|mUaY_3~
z;SUBn0{DHo_&lt;VT?Au&amp;Kz?J@*{f&amp;DH(V9~etDQIJG;vQB8w;2Hp5@Qmf&lt;&lt;+%+p(yVZ
z{Pr+%vU^fq_9M1^^BSJ#qK(4M2uV%@cv@jh!b)+RX1?G57OtZZ!pHW?zv9FdIu*m3
zj73TT1OUF@+29Twe4&lt;YogLXBZ)`{TvXf^$MO+YD)QU=FSe7|d-OTty)w*kkAdw0I{
z&gt;Wd4zA&amp;9&lt;M)V&amp;Mv#G?D}&gt;EZVWKJ+|ySZ0mzriUyqn)sK1&lt;&lt;BK&amp;!hDa6zcxrIqf%P`
z#^MJT-Ld@jzeXL$F`4;}Sw8dqvdhh$zg}tXx;S7W;g)v4SJzaV#Sh*WwxyImA6hmz
zSn=K0hZ*@Mxz#78ta8_OtPF&gt;xF%a&lt;k586`7Eyj~mN0lFUn5q)(jO&gt;v^kHhvKipTll
z%g&lt;3-ZL&gt;YkJ4N~o-&amp;Ahxz(L-Svk{gLc!llXe$|eHK$eZx`Yc;(?dw_6m!iVLMEr5m
zxhoKSx$I`71f^Vt4&lt;3PK2QbFq_xo{Nm$&amp;shwk?Dp;1BS|TW@f|c{A}mkC$J0k=%*D
z;S)fk$vzDpd-4ecg6y0eCZ0NxvJoQ@LSSPO!OmmHjN&gt;nVTgJt+E@Ahc-CQ&amp;Gr|dtl
zk60|qzyU)jDlDR=wuWb)dxlU}7CzgT05HiO7ZnvUe%yHex_lYoaG32ozGn49=OI&amp;Z
zdB!m9mNyB9!xR-4Wv&lt;4A1@3tsMMXuFk1VI9wUyG+o@nJU=i&lt;|ubMfhkzWaQH+rlW%
zI~22&lt;LRZQo91hde+(0}Ur*H3s^X=(nYm;hDQBqV&amp;Boe_&gt;UfSo9zF&amp;w&amp;qck+ubLxai
zJo)5P?A^DAv**8)h&gt;*_BCqKV{y!;|O&amp;m$6zw7*|4#^AUP$CZyJ9Bw5yCx?H(=We7B
z&gt;9dnap7KMX5Yh;A3P4I3bDVh2fPRB;TnB$3$Tino%aga9&amp;cG5M$Mv(x3rV&amp;eFxWlD
zGwz}r88T!zZQ(WmS3LOe{Woi^@3C#$mx@m`#?Z3&lt;UJEZmwjVCO@LYWU5cSOw-delW
z&lt;c&lt;5kT6sz#SdcRJEe`V~#&amp;@p{s@4M`)4X#5nAt)Ine_A@$ewt28Q|Xb%iGmIZXf(@
z!L{`QQE;@7%1(+JXZ&gt;bLi7kc9pML%I(rAs=3ZpbeYfS1Gs1omqvP7Mn(t)gA`e=T7
z8r@j5Bcaw9rIJKRkYt@qpMVYEMPrH9GYHc}8D+s}oT6|HHf*M#F-&amp;_7l9hEQET&gt;xT
z(-y-TRgP(Bq(|jmk#vcs0NS(si97&gt;G%jABL0KRhPv&amp;hCKoXYR0sgGLsy|lH?27{Lz
zgG{!apybNQebWkb=eIjqx@;fQ&gt;h{yt)JC6Q-GL69{6rU`u|r)*vaEbMO{{_1x_X@B
zPiDZ4&amp;!UXL^+3J0B{_((XvZnc)@fp8;N&lt;ZW7(H$R%7E*E&lt;0XQdYy&lt;TF!4wYvL*2(;
znly1{P7%8vcuHd%W18Pz`b7TWg656ARVst%ia5c6#=ht`ONu)a-p5|Q#Zv~WE8-MD
zmv`?&lt;X^uqf9xFgs#OW?{1&gt;m|~^OOI%H9sXtUF4?!0zdL=wqe?+o&amp;W#&lt;07*qoM6N&lt;$
Eg57}I+W-In</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/themes/qute/jar.mn</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/themes/qute/jar.mn</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -23,18 +23,28 @@ classic.jar:</span>
<a href="#l19.4"></a><span id="l19.4">   skin/classic/editor/EditorDialog.css                        (editor/EditorDialog.css)</span>
<a href="#l19.5"></a><span id="l19.5">   skin/classic/editor/icons/img-align-bottom.gif              (editor/img-align-bottom.gif)</span>
<a href="#l19.6"></a><span id="l19.6">   skin/classic/editor/icons/img-align-left.gif                (editor/img-align-left.gif)</span>
<a href="#l19.7"></a><span id="l19.7">   skin/classic/editor/icons/img-align-middle.gif              (editor/img-align-middle.gif)</span>
<a href="#l19.8"></a><span id="l19.8">   skin/classic/editor/icons/img-align-right.gif               (editor/img-align-right.gif)</span>
<a href="#l19.9"></a><span id="l19.9">   skin/classic/editor/icons/img-align-top.gif                 (editor/img-align-top.gif)</span>
<a href="#l19.10"></a><span id="l19.10"> % skin messenger classic/1.0 %skin/classic/messenger/ os=WINNT osversion&lt;6</span>
<a href="#l19.11"></a><span id="l19.11"> % skin messenger classic/1.0 %skin/classic/messenger/ os!=WINNT</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-# NOTE: If you add a new file here, you'll need to add it to the aero</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-# section at the bottom of this file, too.</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+# ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION!</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+# ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION!</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+#</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+# If you add a new file here, you'll need to add it to the aero section at the</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+# bottom of this file, too. If you do not, people using Windows prior to Vista</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+# will be able to enjoy your additions, but people using Vista and above will</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+# not.</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+#</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+# ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION!</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+# ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION! ATTENTION!</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+</span>
<a href="#l19.26"></a><span id="l19.26">   skin/classic/messenger/primaryToolbar.css                   (mail/primaryToolbar.css)</span>
<a href="#l19.27"></a><span id="l19.27">   skin/classic/messenger/accountCentral.css                   (mail/accountCentral.css)</span>
<a href="#l19.28"></a><span id="l19.28">   skin/classic/messenger/accountCreation.css                  (mail/accountCreation.css)</span>
<a href="#l19.29"></a><span id="l19.29">   skin/classic/messenger/accountManage.css                    (mail/accountManage.css)</span>
<a href="#l19.30"></a><span id="l19.30">   skin/classic/messenger/accountWizard.css                    (mail/accountWizard.css)</span>
<a href="#l19.31"></a><span id="l19.31">   skin/classic/messenger/section_collapsed.png                (mail/section_collapsed.png)</span>
<a href="#l19.32"></a><span id="l19.32">   skin/classic/messenger/section_expanded.png                 (mail/section_expanded.png)</span>
<a href="#l19.33"></a><span id="l19.33">   skin/classic/messenger/messageHeader.css                    (mail/messageHeader.css)</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineat">@@ -221,16 +231,18 @@ classic.jar:</span>
<a href="#l19.35"></a><span id="l19.35">   skin/classic/messenger-newsblog/icons/server-rss.png        (mail/newsblog/server-rss.png)</span>
<a href="#l19.36"></a><span id="l19.36"> #ifdef XP_WIN</span>
<a href="#l19.37"></a><span id="l19.37"> % skin messenger classic/1.0 %skin/classic/aero/messenger/ os=WINNT osversion&gt;=6</span>
<a href="#l19.38"></a><span id="l19.38">   skin/classic/aero/messenger/primaryToolbar.css                   (mail/primaryToolbar.css)</span>
<a href="#l19.39"></a><span id="l19.39">   skin/classic/aero/messenger/accountCentral.css                   (mail/accountCentral.css)</span>
<a href="#l19.40"></a><span id="l19.40">   skin/classic/aero/messenger/accountCreation.css                  (mail/accountCreation.css)</span>
<a href="#l19.41"></a><span id="l19.41">   skin/classic/aero/messenger/accountManage.css                    (mail/accountManage.css)</span>
<a href="#l19.42"></a><span id="l19.42">   skin/classic/aero/messenger/accountWizard.css                    (mail/accountWizard.css)</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+  skin/classic/aero/messenger/section_collapsed.png                (mail/section_collapsed.png)</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+  skin/classic/aero/messenger/section_expanded.png                 (mail/section_expanded.png)</span>
<a href="#l19.45"></a><span id="l19.45">   skin/classic/aero/messenger/messageHeader.css                    (mail/messageHeader.css)</span>
<a href="#l19.46"></a><span id="l19.46">   skin/classic/aero/messenger/messageBody.css                      (mail/messageBody.css)</span>
<a href="#l19.47"></a><span id="l19.47">   skin/classic/aero/messenger/messageQuotes.css                    (mail/messageQuotes.css)</span>
<a href="#l19.48"></a><span id="l19.48"> * skin/classic/aero/messenger/messenger.css                        (mail/messenger-aero.css)</span>
<a href="#l19.49"></a><span id="l19.49">   skin/classic/aero/messenger/mailWindow1.css                      (mail/mailWindow1.css)</span>
<a href="#l19.50"></a><span id="l19.50">   skin/classic/aero/messenger/tagColors.css                        (mail/tagColors.css)</span>
<a href="#l19.51"></a><span id="l19.51">   skin/classic/aero/messenger/messageWindow.css                    (mail/messageWindow.css)</span>
<a href="#l19.52"></a><span id="l19.52">   skin/classic/aero/messenger/searchBox.css                        (mail/searchBox.css)</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineat">@@ -280,23 +292,27 @@ classic.jar:</span>
<a href="#l19.54"></a><span id="l19.54">   skin/classic/aero/messenger/addressbook/icons/abcard-large.png   (mail/addrbook/abcard-large.png)</span>
<a href="#l19.55"></a><span id="l19.55">   skin/classic/aero/messenger/addressbook/icons/remote-addrbook.png (mail/addrbook/remote-addrbook.png)</span>
<a href="#l19.56"></a><span id="l19.56">   skin/classic/aero/messenger/addressbook/icons/remote-addrbook-error.png      (mail/addrbook/remote-addrbook-error.png)</span>
<a href="#l19.57"></a><span id="l19.57">   skin/classic/aero/messenger/addressbook/icons/secure-remote-addrbook.png     (mail/addrbook/secure-remote-addrbook.png)</span>
<a href="#l19.58"></a><span id="l19.58">   skin/classic/aero/messenger/messengercompose/messengercompose.css (mail/compose/messengercompose-aero.css)</span>
<a href="#l19.59"></a><span id="l19.59">   skin/classic/aero/messenger/messengercompose/compose-toolbar.png  (mail/compose/compose-toolbar.png)</span>
<a href="#l19.60"></a><span id="l19.60">   skin/classic/aero/messenger/messengercompose/compose-toolbar-small.png   (mail/compose/compose-toolbar-small.png)</span>
<a href="#l19.61"></a><span id="l19.61">   skin/classic/aero/messenger/messengercompose/format-buttons.png  (mail/compose/format-buttons-aero.png)</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+  skin/classic/aero/messenger/preferences/alwaysAsk.png            (mail/preferences/alwaysAsk.png)</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+  skin/classic/aero/messenger/preferences/application.png          (mail/preferences/application.png)</span>
<a href="#l19.64"></a><span id="l19.64"> * skin/classic/aero/messenger/preferences/preferences.css          (mail/preferences/preferences-aero.css)</span>
<a href="#l19.65"></a><span id="l19.65">   skin/classic/aero/messenger/preferences/general.png              (mail/preferences/general-aero.png)</span>
<a href="#l19.66"></a><span id="l19.66">   skin/classic/aero/messenger/preferences/display.png              (mail/preferences/display-aero.png)</span>
<a href="#l19.67"></a><span id="l19.67">   skin/classic/aero/messenger/preferences/composition.png          (mail/preferences/composition-aero.png)</span>
<a href="#l19.68"></a><span id="l19.68">   skin/classic/aero/messenger/preferences/junk.png                 (mail/preferences/junk-aero.png)</span>
<a href="#l19.69"></a><span id="l19.69">   skin/classic/aero/messenger/preferences/security.png             (mail/preferences/security-aero.png)</span>
<a href="#l19.70"></a><span id="l19.70">   skin/classic/aero/messenger/preferences/attachments.png          (mail/preferences/attachments-aero.png)</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+  skin/classic/aero/messenger/preferences/applications.css         (mail/preferences/applications.css)</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+  skin/classic/aero/messenger/preferences/saveFile.png             (mail/preferences/saveFile.png)</span>
<a href="#l19.73"></a><span id="l19.73">   skin/classic/aero/messenger/preferences/advanced.png             (mail/preferences/advanced-aero.png)</span>
<a href="#l19.74"></a><span id="l19.74">   skin/classic/aero/messenger/preferences/background.png           (mail/preferences/background.png)</span>
<a href="#l19.75"></a><span id="l19.75">   skin/classic/aero/messenger/preferences/hover.png                (mail/preferences/hover.png)</span>
<a href="#l19.76"></a><span id="l19.76">   skin/classic/aero/messenger/preferences/selected.png             (mail/preferences/selected.png)</span>
<a href="#l19.77"></a><span id="l19.77">   skin/classic/aero/messenger/smime/msgCompSMIMEOverlay.css        (mail/smime/msgCompSMIMEOverlay.css)</span>
<a href="#l19.78"></a><span id="l19.78">   skin/classic/aero/messenger/smime/msgHdrViewSMIMEOverlay.css     (mail/smime/msgHdrViewSMIMEOverlay.css)</span>
<a href="#l19.79"></a><span id="l19.79">   skin/classic/aero/messenger/smime/msgReadSMIMEOverlay.css        (mail/smime/msgReadSMIMEOverlay.css)</span>
<a href="#l19.80"></a><span id="l19.80">   skin/classic/aero/messenger/smime/msgReadSecurityInfo.css        (mail/smime/msgReadSecurityInfo.css)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/content/folderProps.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/content/folderProps.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -146,17 +146,17 @@ function folderPropsOKButton()</span>
<a href="#l20.4"></a><span id="l20.4">     else</span>
<a href="#l20.5"></a><span id="l20.5">       gMsgFolder.clearFlag(nsMsgFolderFlags.Offline);</span>
<a href="#l20.6"></a><span id="l20.6"> </span>
<a href="#l20.7"></a><span id="l20.7">     if(document.getElementById(&quot;folderCheckForNewMessages&quot;).checked)</span>
<a href="#l20.8"></a><span id="l20.8">       gMsgFolder.setFlag(nsMsgFolderFlags.CheckNew);</span>
<a href="#l20.9"></a><span id="l20.9">     else</span>
<a href="#l20.10"></a><span id="l20.10">       gMsgFolder.clearFlag(nsMsgFolderFlags.CheckNew);</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-    var retentionSettings = saveCommonRetentionSettings();</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+    var retentionSettings = saveCommonRetentionSettings(gMsgFolder.retentionSettings);</span>
<a href="#l20.14"></a><span id="l20.14">     retentionSettings.useServerDefaults = document.getElementById(&quot;retention.useDefault&quot;).checked;</span>
<a href="#l20.15"></a><span id="l20.15">     gMsgFolder.retentionSettings = retentionSettings;</span>
<a href="#l20.16"></a><span id="l20.16"> </span>
<a href="#l20.17"></a><span id="l20.17">   }</span>
<a href="#l20.18"></a><span id="l20.18"> </span>
<a href="#l20.19"></a><span id="l20.19">   try</span>
<a href="#l20.20"></a><span id="l20.20">   {</span>
<a href="#l20.21"></a><span id="l20.21">     // This throws an exception when an illegal folder name was entered.</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -236,17 +236,17 @@ function folderPropsOnLoad()</span>
<a href="#l20.23"></a><span id="l20.23">     else {</span>
<a href="#l20.24"></a><span id="l20.24">       if(serverType == &quot;imap&quot; || serverType == &quot;pop3&quot;)</span>
<a href="#l20.25"></a><span id="l20.25">         document.getElementById(&quot;offline.selectForOfflineFolder&quot;).checked = false;</span>
<a href="#l20.26"></a><span id="l20.26"> </span>
<a href="#l20.27"></a><span id="l20.27">       if(serverType == &quot;nntp&quot;)</span>
<a href="#l20.28"></a><span id="l20.28">         document.getElementById(&quot;offline.selectForOfflineNewsgroup&quot;).checked = false;</span>
<a href="#l20.29"></a><span id="l20.29">     }</span>
<a href="#l20.30"></a><span id="l20.30"> </span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-    // select the menu item </span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+    // select the menu item</span>
<a href="#l20.33"></a><span id="l20.33">     var folderCharsetList = document.getElementById(&quot;folderCharsetList&quot;);</span>
<a href="#l20.34"></a><span id="l20.34">     var elements = folderCharsetList.getElementsByAttribute(&quot;value&quot;, gMsgFolder.charset);</span>
<a href="#l20.35"></a><span id="l20.35">     folderCharsetList.selectedItem = elements[0];</span>
<a href="#l20.36"></a><span id="l20.36"> </span>
<a href="#l20.37"></a><span id="l20.37">     // set override checkbox</span>
<a href="#l20.38"></a><span id="l20.38">     document.getElementById(&quot;folderCharsetOverride&quot;).checked = gMsgFolder.charsetOverride;</span>
<a href="#l20.39"></a><span id="l20.39"> </span>
<a href="#l20.40"></a><span id="l20.40">     // set check for new mail checkbox</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineat">@@ -337,27 +337,27 @@ function hideShowControls(serverType)</span>
<a href="#l20.42"></a><span id="l20.42">     // Retention policy doesn't apply to Drafts/Templates/Outbox.</span>
<a href="#l20.43"></a><span id="l20.43">     if (gMsgFolder.isSpecialFolder(nsMsgFolderFlags.Drafts |</span>
<a href="#l20.44"></a><span id="l20.44">                                    nsMsgFolderFlags.Templates |</span>
<a href="#l20.45"></a><span id="l20.45">                                    nsMsgFolderFlags.Queue, true))</span>
<a href="#l20.46"></a><span id="l20.46">       document.getElementById(&quot;Retention&quot;).hidden = true;</span>
<a href="#l20.47"></a><span id="l20.47">   }</span>
<a href="#l20.48"></a><span id="l20.48"> }</span>
<a href="#l20.49"></a><span id="l20.49"> </span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-function getEnclosingContainer(startNode) </span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+function getEnclosingContainer(startNode)</span>
<a href="#l20.52"></a><span id="l20.52"> {</span>
<a href="#l20.53"></a><span id="l20.53">   var parent = startNode;</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-  var box; </span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-  while (parent &amp;&amp; parent != document) </span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+  var box;</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+  while (parent &amp;&amp; parent != document)</span>
<a href="#l20.58"></a><span id="l20.58">   {</span>
<a href="#l20.59"></a><span id="l20.59">     var isContainer = (parent.getAttribute(&quot;iscontrolcontainer&quot;) == &quot;true&quot;);</span>
<a href="#l20.60"></a><span id="l20.60"> </span>
<a href="#l20.61"></a><span id="l20.61">     // remember the FIRST container we encounter, or the first controlcontainer</span>
<a href="#l20.62"></a><span id="l20.62">     if (!box || isContainer) box=parent;</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineminus">-        </span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+</span>
<a href="#l20.65"></a><span id="l20.65">     // break out with a controlcontainer</span>
<a href="#l20.66"></a><span id="l20.66">     if (isContainer) break;</span>
<a href="#l20.67"></a><span id="l20.67">       parent = parent.parentNode;</span>
<a href="#l20.68"></a><span id="l20.68">   }</span>
<a href="#l20.69"></a><span id="l20.69">   return box;</span>
<a href="#l20.70"></a><span id="l20.70"> }</span>
<a href="#l20.71"></a><span id="l20.71"> </span>
<a href="#l20.72"></a><span id="l20.72"> function onOfflineFolderDownload()</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineat">@@ -367,17 +367,17 @@ function onOfflineFolderDownload()</span>
<a href="#l20.74"></a><span id="l20.74"> }</span>
<a href="#l20.75"></a><span id="l20.75"> </span>
<a href="#l20.76"></a><span id="l20.76"> function onFolderPrivileges()</span>
<a href="#l20.77"></a><span id="l20.77"> {</span>
<a href="#l20.78"></a><span id="l20.78">   var imapFolder = gMsgFolder.QueryInterface(Components.interfaces.nsIMsgImapMailFolder);</span>
<a href="#l20.79"></a><span id="l20.79">   if (imapFolder)</span>
<a href="#l20.80"></a><span id="l20.80">     imapFolder.folderPrivileges(window.arguments[0].msgWindow);</span>
<a href="#l20.81"></a><span id="l20.81">   // let's try closing the modal dialog to see if it fixes the various problems running this url</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineminus">-  window.close(); </span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+  window.close();</span>
<a href="#l20.84"></a><span id="l20.84"> }</span>
<a href="#l20.85"></a><span id="l20.85"> </span>
<a href="#l20.86"></a><span id="l20.86"> </span>
<a href="#l20.87"></a><span id="l20.87"> function onUseDefaultRetentionSettings()</span>
<a href="#l20.88"></a><span id="l20.88"> {</span>
<a href="#l20.89"></a><span id="l20.89">   var useDefault = document.getElementById(&quot;retention.useDefault&quot;).checked;</span>
<a href="#l20.90"></a><span id="l20.90">   document.getElementById('retention.keepMsg').disabled = useDefault;</span>
<a href="#l20.91"></a><span id="l20.91">   document.getElementById('retention.keepNewMsgMinLabel').disabled = useDefault;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/content/retention.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/content/retention.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -38,41 +38,37 @@</span>
<a href="#l21.4"></a><span id="l21.4">  * ***** END LICENSE BLOCK ****** */</span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6"> </span>
<a href="#l21.7"></a><span id="l21.7"> function initCommonRetentionSettings(retentionSettings)</span>
<a href="#l21.8"></a><span id="l21.8"> {</span>
<a href="#l21.9"></a><span id="l21.9">   document.getElementById(&quot;retention.keepUnread&quot;).checked =  retentionSettings.keepUnreadMessagesOnly;</span>
<a href="#l21.10"></a><span id="l21.10">   document.getElementById(&quot;retention.keepMsg&quot;).value = retentionSettings.retainByPreference;</span>
<a href="#l21.11"></a><span id="l21.11">   if(retentionSettings.daysToKeepHdrs &gt; 0)</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-    document.getElementById(&quot;retention.keepOldMsgMin&quot;).value = </span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+    document.getElementById(&quot;retention.keepOldMsgMin&quot;).value =</span>
<a href="#l21.14"></a><span id="l21.14">     (retentionSettings.daysToKeepHdrs &gt; 0) ? retentionSettings.daysToKeepHdrs : 30;</span>
<a href="#l21.15"></a><span id="l21.15">   document.getElementById(&quot;retention.keepNewMsgMin&quot;).value =</span>
<a href="#l21.16"></a><span id="l21.16">     (retentionSettings.numHeadersToKeep &gt; 0) ? retentionSettings.numHeadersToKeep : 2000;</span>
<a href="#l21.17"></a><span id="l21.17"> </span>
<a href="#l21.18"></a><span id="l21.18">   document.getElementById(&quot;retention.applyToFlagged&quot;).checked =</span>
<a href="#l21.19"></a><span id="l21.19">     !retentionSettings.applyToFlaggedMessages;</span>
<a href="#l21.20"></a><span id="l21.20"> }</span>
<a href="#l21.21"></a><span id="l21.21"> </span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-function saveCommonRetentionSettings()</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+function saveCommonRetentionSettings(aRetentionSettings)</span>
<a href="#l21.24"></a><span id="l21.24"> {</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineminus">-  var retentionSettings =</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineminus">-    Components.classes[&quot;@mozilla.org/msgDatabase/retentionSettings;1&quot;]</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-              .createInstance(Components.interfaces.nsIMsgRetentionSettings);</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+  aRetentionSettings.retainByPreference = document.getElementById(&quot;retention.keepMsg&quot;).value;</span>
<a href="#l21.29"></a><span id="l21.29"> </span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-  retentionSettings.retainByPreference = document.getElementById(&quot;retention.keepMsg&quot;).value;</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+  aRetentionSettings.daysToKeepHdrs = document.getElementById(&quot;retention.keepOldMsgMin&quot;).value;</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+  aRetentionSettings.numHeadersToKeep = document.getElementById(&quot;retention.keepNewMsgMin&quot;).value;</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+  aRetentionSettings.keepUnreadMessagesOnly = document.getElementById(&quot;retention.keepUnread&quot;).checked;</span>
<a href="#l21.34"></a><span id="l21.34"> </span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-  retentionSettings.daysToKeepHdrs = document.getElementById(&quot;retention.keepOldMsgMin&quot;).value;</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-  retentionSettings.numHeadersToKeep = document.getElementById(&quot;retention.keepNewMsgMin&quot;).value;</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-  retentionSettings.keepUnreadMessagesOnly = document.getElementById(&quot;retention.keepUnread&quot;).checked;</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-  retentionSettings.applyToFlaggedMessages =</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+  aRetentionSettings.applyToFlaggedMessages =</span>
<a href="#l21.41"></a><span id="l21.41">     !document.getElementById(&quot;retention.applyToFlagged&quot;).checked;</span>
<a href="#l21.42"></a><span id="l21.42"> </span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-  return retentionSettings;</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+  return aRetentionSettings;</span>
<a href="#l21.45"></a><span id="l21.45"> }</span>
<a href="#l21.46"></a><span id="l21.46"> </span>
<a href="#l21.47"></a><span id="l21.47"> function onCheckKeepMsg()</span>
<a href="#l21.48"></a><span id="l21.48"> {</span>
<a href="#l21.49"></a><span id="l21.49">   if (gLockedPref &amp;&amp; gLockedPref[&quot;retention.keepMsg&quot;]) {</span>
<a href="#l21.50"></a><span id="l21.50">     // if the pref associated with the radiobutton is locked, as indicated</span>
<a href="#l21.51"></a><span id="l21.51">     // by the gLockedPref, skip this function.  All elements in this</span>
<a href="#l21.52"></a><span id="l21.52">     // radiogroup have been locked by the function onLockPreference.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-offline.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-offline.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -160,17 +160,17 @@ function onSave()</span>
<a href="#l22.4"></a><span id="l22.4"> {</span>
<a href="#l22.5"></a><span id="l22.5">     var downloadSettings =</span>
<a href="#l22.6"></a><span id="l22.6">       Components.classes[&quot;@mozilla.org/msgDatabase/downloadSettings;1&quot;]</span>
<a href="#l22.7"></a><span id="l22.7">                 .createInstance(Components.interfaces.nsIMsgDownloadSettings);</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9">     gIncomingServer.limitOfflineMessageSize = document.getElementById(&quot;offline.notDownload&quot;).checked;</span>
<a href="#l22.10"></a><span id="l22.10">     gIncomingServer.maxMessageSize = document.getElementById(&quot;offline.notDownloadMin&quot;).value;</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-    var retentionSettings = saveCommonRetentionSettings();</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+    var retentionSettings = saveCommonRetentionSettings(gIncomingServer.retentionSettings);</span>
<a href="#l22.14"></a><span id="l22.14"> </span>
<a href="#l22.15"></a><span id="l22.15">     retentionSettings.daysToKeepBodies = document.getElementById(&quot;nntp.removeBodyMin&quot;).value;</span>
<a href="#l22.16"></a><span id="l22.16">     retentionSettings.cleanupBodiesByDays = document.getElementById(&quot;nntp.removeBody&quot;).checked;</span>
<a href="#l22.17"></a><span id="l22.17"> </span>
<a href="#l22.18"></a><span id="l22.18">     downloadSettings.downloadByDate = document.getElementById(&quot;nntp.downloadMsg&quot;).checked;</span>
<a href="#l22.19"></a><span id="l22.19">     downloadSettings.downloadUnreadOnly = document.getElementById(&quot;nntp.notDownloadRead&quot;).checked;</span>
<a href="#l22.20"></a><span id="l22.20">     downloadSettings.ageLimitOfMsgsToDownload = document.getElementById(&quot;nntp.downloadMsgMin&quot;).value;</span>
<a href="#l22.21"></a><span id="l22.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolderListener.idl</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolderListener.idl</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -47,17 +47,17 @@ interface nsIArray;</span>
<a href="#l23.4"></a><span id="l23.4">  * especially w.r.t. moving messages and folders.  Some listeners want to know</span>
<a href="#l23.5"></a><span id="l23.5">  * about moves, instead of getting an itemAdded and itemRemoved notification.</span>
<a href="#l23.6"></a><span id="l23.6">  * Folder listeners also only tend to get called if a view is open on the folder,</span>
<a href="#l23.7"></a><span id="l23.7">  * which is not always the case. I don't want to change nsIFolderListener at this</span>
<a href="#l23.8"></a><span id="l23.8">  * point since there are lots of extensions that rely on it. Eventually,</span>
<a href="#l23.9"></a><span id="l23.9">  * these two interfaces should be combined somehow.</span>
<a href="#l23.10"></a><span id="l23.10">  */</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-[scriptable, uuid(4dee6994-1a7d-4200-b9a7-b1fc54df3397)]</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+[scriptable, uuid(eebbedae-ce43-4151-9798-3f1c6e5a5af0)]</span>
<a href="#l23.14"></a><span id="l23.14"> interface nsIMsgFolderListener : nsISupports {</span>
<a href="#l23.15"></a><span id="l23.15">   /**</span>
<a href="#l23.16"></a><span id="l23.16">    * Notified immediately after a message is added to a folder. This could be a new incoming</span>
<a href="#l23.17"></a><span id="l23.17">    * message to a local folder, or a new message in an IMAP folder when it is opened.</span>
<a href="#l23.18"></a><span id="l23.18">    *</span>
<a href="#l23.19"></a><span id="l23.19">    * @param aMsg The message header that was just added</span>
<a href="#l23.20"></a><span id="l23.20">    */</span>
<a href="#l23.21"></a><span id="l23.21">   void msgAdded(in nsIMsgDBHdr aMsg);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolderNotificationService.idl</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolderNotificationService.idl</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -40,17 +40,17 @@</span>
<a href="#l24.4"></a><span id="l24.4"> </span>
<a href="#l24.5"></a><span id="l24.5"> interface nsIMsgDBHdr;</span>
<a href="#l24.6"></a><span id="l24.6"> interface nsIMsgFolder;</span>
<a href="#l24.7"></a><span id="l24.7"> interface nsIMsgFolderListener;</span>
<a href="#l24.8"></a><span id="l24.8"> interface nsIArray;</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> typedef unsigned long msgFolderListenerFlag;</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-[scriptable, uuid(54900730-ba1f-4315-af44-cfbb2121d115)]</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+[scriptable, uuid(e5d75176-a3d7-4f80-a1fe-b915a679ca53)]</span>
<a href="#l24.14"></a><span id="l24.14"> interface nsIMsgFolderNotificationService : nsISupports {</span>
<a href="#l24.15"></a><span id="l24.15">   /**</span>
<a href="#l24.16"></a><span id="l24.16">    * @name Notification flags</span>
<a href="#l24.17"></a><span id="l24.17">    * These flags determine which notifications will be sent.</span>
<a href="#l24.18"></a><span id="l24.18">    * @{</span>
<a href="#l24.19"></a><span id="l24.19">    */</span>
<a href="#l24.20"></a><span id="l24.20">   /// nsIMsgFolderListener::msgAdded notification</span>
<a href="#l24.21"></a><span id="l24.21">   const msgFolderListenerFlag msgAdded = 0x1;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/base/public/nsISpamSettings.idl</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/base/public/nsISpamSettings.idl</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -76,20 +76,24 @@ interface nsISpamSettings: nsISupports {</span>
<a href="#l25.4"></a><span id="l25.4">    * interval, in days</span>
<a href="#l25.5"></a><span id="l25.5">    */</span>
<a href="#l25.6"></a><span id="l25.6">   attribute long purgeInterval;</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8">   attribute boolean useWhiteList;</span>
<a href="#l25.9"></a><span id="l25.9">   attribute string whiteListAbURI;</span>
<a href="#l25.10"></a><span id="l25.10"> </span>
<a href="#l25.11"></a><span id="l25.11">   /**</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-   * should we do something (move or delete)</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-   * when the user manually marks a message as junk?</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+   * Should we do something when the user manually marks a message as junk?</span>
<a href="#l25.15"></a><span id="l25.15">    */</span>
<a href="#l25.16"></a><span id="l25.16">   readonly attribute boolean manualMark;</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+  /**</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+   * With manualMark true, which action (move to the Junk folder, or delete)</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineplus">+   * should we take when the user marks a message as junk.</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineplus">+   */</span>
<a href="#l25.22"></a><span id="l25.22">   readonly attribute long manualMarkMode;</span>
<a href="#l25.23"></a><span id="l25.23">   const long MANUAL_MARK_MODE_MOVE = 0;</span>
<a href="#l25.24"></a><span id="l25.24">   const long MANUAL_MARK_MODE_DELETE = 1;</span>
<a href="#l25.25"></a><span id="l25.25"> </span>
<a href="#l25.26"></a><span id="l25.26">   /**</span>
<a href="#l25.27"></a><span id="l25.27">    * integrate with server-side spam detection programs</span>
<a href="#l25.28"></a><span id="l25.28">    */</span>
<a href="#l25.29"></a><span id="l25.29">   attribute boolean useServerFilter;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/base/search/public/nsIMsgSearchCustomTerm.idl</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgSearchCustomTerm.idl</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -34,32 +34,35 @@</span>
<a href="#l26.4"></a><span id="l26.4">  *</span>
<a href="#l26.5"></a><span id="l26.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7"> #include &quot;nsMsgSearchCore.idl&quot;</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9"> /**</span>
<a href="#l26.10"></a><span id="l26.10">  * describes a custom term added to a message search or filter</span>
<a href="#l26.11"></a><span id="l26.11">  */</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-[scriptable,uuid(8DD6E135-6790-475e-9547-3C1408CF2F08)]</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+[scriptable,uuid(925DB5AA-21AF-494c-8652-984BC7BAD13A)]</span>
<a href="#l26.14"></a><span id="l26.14"> interface nsIMsgSearchCustomTerm : nsISupports</span>
<a href="#l26.15"></a><span id="l26.15"> {</span>
<a href="#l26.16"></a><span id="l26.16">   /**</span>
<a href="#l26.17"></a><span id="l26.17">    * globally unique string to identify this search term.</span>
<a href="#l26.18"></a><span id="l26.18">    * recommended form: ExtensionName@example.com#TermName</span>
<a href="#l26.19"></a><span id="l26.19">    * Commas and quotes are not allowed, the id must not</span>
<a href="#l26.20"></a><span id="l26.20">    * parse to an integer, and names of standard search</span>
<a href="#l26.21"></a><span id="l26.21">    * attributes in SearchAttribEntryTable in nsMsgSearchTerm.cpp</span>
<a href="#l26.22"></a><span id="l26.22">    * are not allowed.</span>
<a href="#l26.23"></a><span id="l26.23">    */</span>
<a href="#l26.24"></a><span id="l26.24">   readonly attribute ACString id;</span>
<a href="#l26.25"></a><span id="l26.25"> </span>
<a href="#l26.26"></a><span id="l26.26">   /// name to display in term list. This should be localized. */</span>
<a href="#l26.27"></a><span id="l26.27">   readonly attribute AString name;</span>
<a href="#l26.28"></a><span id="l26.28"> </span>
<a href="#l26.29"></a><span id="l26.29" class="difflineplus">+  /// Does this term need the message body?</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineplus">+  readonly attribute boolean needsBody;</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineplus">+</span>
<a href="#l26.32"></a><span id="l26.32">   /**</span>
<a href="#l26.33"></a><span id="l26.33">    * Is this custom term enabled?</span>
<a href="#l26.34"></a><span id="l26.34">    *</span>
<a href="#l26.35"></a><span id="l26.35">    * @param scope          search scope (nsMsgSearchScope)</span>
<a href="#l26.36"></a><span id="l26.36">    * @param op             search operator (nsMsgSearchOp). If null, determine</span>
<a href="#l26.37"></a><span id="l26.37">    *                       if term is available for any operator.</span>
<a href="#l26.38"></a><span id="l26.38">    *</span>
<a href="#l26.39"></a><span id="l26.39">    * @return               true if enabled</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgImapSearch.cpp</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgImapSearch.cpp</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -595,18 +595,22 @@ nsMsgSearchValidityManager::InitOnlineMa</span>
<a href="#l27.4"></a><span id="l27.4">   m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l27.5"></a><span id="l27.5">   m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l27.6"></a><span id="l27.6">   m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsEmpty, 1);</span>
<a href="#l27.7"></a><span id="l27.7">   m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l27.8"></a><span id="l27.8">   m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::Keywords, nsMsgSearchOp::IsntEmpty, 1);</span>
<a href="#l27.9"></a><span id="l27.9"> </span>
<a href="#l27.10"></a><span id="l27.10">   m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l27.11"></a><span id="l27.11">   m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Contains, 1);</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::DoesntContain, 1);</span>
<a href="#l27.14"></a><span id="l27.14">   m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l27.15"></a><span id="l27.15">   m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Is, 1);</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineplus">+  m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::Isnt, 1);</span>
<a href="#l27.18"></a><span id="l27.18">   m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l27.19"></a><span id="l27.19">   m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::BeginsWith, 1);</span>
<a href="#l27.20"></a><span id="l27.20">   m_onlineMailFilterTable-&gt;SetAvailable (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l27.21"></a><span id="l27.21">   m_onlineMailFilterTable-&gt;SetEnabled   (nsMsgSearchAttrib::OtherHeader, nsMsgSearchOp::EndsWith, 1);</span>
<a href="#l27.22"></a><span id="l27.22"> </span>
<a href="#l27.23"></a><span id="l27.23">   return rv;</span>
<a href="#l27.24"></a><span id="l27.24"> }</span>
<a href="#l27.25"></a><span id="l27.25"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -190,16 +190,17 @@ nsMsgAccountManager::~nsMsgAccountManage</span>
<a href="#l28.4"></a><span id="l28.4">     Shutdown();</span>
<a href="#l28.5"></a><span id="l28.5">     //Don't remove from Observer service in Shutdown because Shutdown also gets called</span>
<a href="#l28.6"></a><span id="l28.6">     //from xpcom shutdown observer.  And we don't want to remove from the service in that case.</span>
<a href="#l28.7"></a><span id="l28.7">     nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l28.8"></a><span id="l28.8">          do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv);</span>
<a href="#l28.9"></a><span id="l28.9">     if (NS_SUCCEEDED(rv))</span>
<a href="#l28.10"></a><span id="l28.10">     {</span>
<a href="#l28.11"></a><span id="l28.11">       observerService-&gt;RemoveObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID);</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+      observerService-&gt;RemoveObserver(this, &quot;quit-application-granted&quot;);</span>
<a href="#l28.13"></a><span id="l28.13">       observerService-&gt;RemoveObserver(this, ABOUT_TO_GO_OFFLINE_TOPIC);</span>
<a href="#l28.14"></a><span id="l28.14">     }</span>
<a href="#l28.15"></a><span id="l28.15">   }</span>
<a href="#l28.16"></a><span id="l28.16"> }</span>
<a href="#l28.17"></a><span id="l28.17"> </span>
<a href="#l28.18"></a><span id="l28.18"> nsresult nsMsgAccountManager::Init()</span>
<a href="#l28.19"></a><span id="l28.19"> {</span>
<a href="#l28.20"></a><span id="l28.20">   nsresult rv;</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineat">@@ -212,17 +213,17 @@ nsresult nsMsgAccountManager::Init()</span>
<a href="#l28.22"></a><span id="l28.22"> </span>
<a href="#l28.23"></a><span id="l28.23">   rv = NS_NewISupportsArray(getter_AddRefs(mFolderListeners));</span>
<a href="#l28.24"></a><span id="l28.24"> </span>
<a href="#l28.25"></a><span id="l28.25">   nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l28.26"></a><span id="l28.26">            do_GetService(&quot;@mozilla.org/observer-service;1&quot;, &amp;rv);</span>
<a href="#l28.27"></a><span id="l28.27">   if (NS_SUCCEEDED(rv))</span>
<a href="#l28.28"></a><span id="l28.28">   {</span>
<a href="#l28.29"></a><span id="l28.29">     observerService-&gt;AddObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID, PR_TRUE);</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineminus">-    observerService-&gt;AddObserver(this, &quot;quit-application&quot; , PR_TRUE);</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineplus">+    observerService-&gt;AddObserver(this, &quot;quit-application-granted&quot; , PR_TRUE);</span>
<a href="#l28.32"></a><span id="l28.32">     observerService-&gt;AddObserver(this, ABOUT_TO_GO_OFFLINE_TOPIC, PR_TRUE);</span>
<a href="#l28.33"></a><span id="l28.33">     observerService-&gt;AddObserver(this, &quot;profile-before-change&quot;, PR_TRUE);</span>
<a href="#l28.34"></a><span id="l28.34">   }</span>
<a href="#l28.35"></a><span id="l28.35"> </span>
<a href="#l28.36"></a><span id="l28.36">   return NS_OK;</span>
<a href="#l28.37"></a><span id="l28.37"> }</span>
<a href="#l28.38"></a><span id="l28.38"> </span>
<a href="#l28.39"></a><span id="l28.39"> nsresult nsMsgAccountManager::Shutdown()</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineat">@@ -288,23 +289,22 @@ nsMsgAccountManager::SetUserNeedsToAuthe</span>
<a href="#l28.41"></a><span id="l28.41"> </span>
<a href="#l28.42"></a><span id="l28.42"> NS_IMETHODIMP nsMsgAccountManager::Observe(nsISupports *aSubject, const char *aTopic, const PRUnichar *someData)</span>
<a href="#l28.43"></a><span id="l28.43"> {</span>
<a href="#l28.44"></a><span id="l28.44">   if(!strcmp(aTopic,NS_XPCOM_SHUTDOWN_OBSERVER_ID))</span>
<a href="#l28.45"></a><span id="l28.45">   {</span>
<a href="#l28.46"></a><span id="l28.46">     Shutdown();</span>
<a href="#l28.47"></a><span id="l28.47">     return NS_OK;</span>
<a href="#l28.48"></a><span id="l28.48">   }</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineminus">-</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineminus">-  if (!strcmp(aTopic,&quot;quit-application&quot;))</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineplus">+  if (!strcmp(aTopic, &quot;quit-application-granted&quot;))</span>
<a href="#l28.52"></a><span id="l28.52">   {</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineminus">-    m_shutdownInProgress = PR_TRUE;</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineplus">+    // CleanupOnExit will set m_shutdownInProgress to true.</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineplus">+    CleanupOnExit();</span>
<a href="#l28.56"></a><span id="l28.56">     return NS_OK;</span>
<a href="#l28.57"></a><span id="l28.57">   }</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineminus">-</span>
<a href="#l28.59"></a><span id="l28.59">   if (!strcmp(aTopic, ABOUT_TO_GO_OFFLINE_TOPIC))</span>
<a href="#l28.60"></a><span id="l28.60">   {</span>
<a href="#l28.61"></a><span id="l28.61">     nsAutoString dataString(NS_LITERAL_STRING(&quot;offline&quot;));</span>
<a href="#l28.62"></a><span id="l28.62">     if (someData)</span>
<a href="#l28.63"></a><span id="l28.63">     {</span>
<a href="#l28.64"></a><span id="l28.64">       nsAutoString someDataString(someData);</span>
<a href="#l28.65"></a><span id="l28.65">       if (dataString.Equals(someDataString))</span>
<a href="#l28.66"></a><span id="l28.66">         CloseCachedConnections();</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineat">@@ -1486,16 +1486,21 @@ nsMsgAccountManager::CloseCachedConnecti</span>
<a href="#l28.68"></a><span id="l28.68"> {</span>
<a href="#l28.69"></a><span id="l28.69">   m_incomingServers.Enumerate(hashCloseCachedConnections, nsnull);</span>
<a href="#l28.70"></a><span id="l28.70">   return NS_OK;</span>
<a href="#l28.71"></a><span id="l28.71"> }</span>
<a href="#l28.72"></a><span id="l28.72"> </span>
<a href="#l28.73"></a><span id="l28.73"> NS_IMETHODIMP</span>
<a href="#l28.74"></a><span id="l28.74"> nsMsgAccountManager::CleanupOnExit()</span>
<a href="#l28.75"></a><span id="l28.75"> {</span>
<a href="#l28.76"></a><span id="l28.76" class="difflineplus">+  // This can get called multiple times, and potentially re-entrantly.</span>
<a href="#l28.77"></a><span id="l28.77" class="difflineplus">+  // So add some protection against that.</span>
<a href="#l28.78"></a><span id="l28.78" class="difflineplus">+  if (m_shutdownInProgress)</span>
<a href="#l28.79"></a><span id="l28.79" class="difflineplus">+    return NS_OK;</span>
<a href="#l28.80"></a><span id="l28.80" class="difflineplus">+  m_shutdownInProgress = PR_TRUE;</span>
<a href="#l28.81"></a><span id="l28.81">   m_incomingServers.Enumerate(hashCleanupOnExit, nsnull);</span>
<a href="#l28.82"></a><span id="l28.82">   // Try to do this early on in the shutdown process before</span>
<a href="#l28.83"></a><span id="l28.83">   // necko shuts itself down.</span>
<a href="#l28.84"></a><span id="l28.84">   CloseCachedConnections();</span>
<a href="#l28.85"></a><span id="l28.85">   return NS_OK;</span>
<a href="#l28.86"></a><span id="l28.86"> }</span>
<a href="#l28.87"></a><span id="l28.87"> </span>
<a href="#l28.88"></a><span id="l28.88"> NS_IMETHODIMP</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/base/src/nsMsgMailSession.cpp</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgMailSession.cpp</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -389,25 +389,30 @@ NS_IMETHODIMP nsMsgMailSession::AddMsgWi</span>
<a href="#l29.4"></a><span id="l29.4">   NS_ENSURE_ARG_POINTER(msgWindow);</span>
<a href="#l29.5"></a><span id="l29.5">   mWindows.AppendObject(msgWindow);</span>
<a href="#l29.6"></a><span id="l29.6">   return NS_OK;</span>
<a href="#l29.7"></a><span id="l29.7"> }</span>
<a href="#l29.8"></a><span id="l29.8"> </span>
<a href="#l29.9"></a><span id="l29.9"> NS_IMETHODIMP nsMsgMailSession::RemoveMsgWindow(nsIMsgWindow *msgWindow)</span>
<a href="#l29.10"></a><span id="l29.10"> {</span>
<a href="#l29.11"></a><span id="l29.11">   mWindows.RemoveObject(msgWindow);</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+  // Mac keeps a hidden window open so the app doesn't shut down when</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+  // the last window is closed. So don't shutdown the account manager in that</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+  // case.</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+#ifndef XP_MACOSX</span>
<a href="#l29.16"></a><span id="l29.16">   if (!mWindows.Count())</span>
<a href="#l29.17"></a><span id="l29.17">   {</span>
<a href="#l29.18"></a><span id="l29.18">     nsresult rv;</span>
<a href="#l29.19"></a><span id="l29.19">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager = </span>
<a href="#l29.20"></a><span id="l29.20">       do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l29.21"></a><span id="l29.21">     if (NS_FAILED(rv))</span>
<a href="#l29.22"></a><span id="l29.22">       return rv;</span>
<a href="#l29.23"></a><span id="l29.23">     accountManager-&gt;CleanupOnExit();</span>
<a href="#l29.24"></a><span id="l29.24">   }</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineplus">+#endif</span>
<a href="#l29.26"></a><span id="l29.26">   return NS_OK;</span>
<a href="#l29.27"></a><span id="l29.27"> }</span>
<a href="#l29.28"></a><span id="l29.28"> </span>
<a href="#l29.29"></a><span id="l29.29"> NS_IMETHODIMP nsMsgMailSession::IsFolderOpenInWindow(nsIMsgFolder *folder, PRBool *aResult)</span>
<a href="#l29.30"></a><span id="l29.30"> {</span>
<a href="#l29.31"></a><span id="l29.31">   if (!aResult)</span>
<a href="#l29.32"></a><span id="l29.32">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l29.33"></a><span id="l29.33">   *aResult = PR_FALSE;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -128,16 +128,17 @@ nsIAtom* nsMsgDBFolder::kNumNewBiffMessa</span>
<a href="#l30.4"></a><span id="l30.4"> nsIAtom* nsMsgDBFolder::kTotalUnreadMessagesAtom=nsnull;</span>
<a href="#l30.5"></a><span id="l30.5"> nsIAtom* nsMsgDBFolder::kFlaggedAtom=nsnull;</span>
<a href="#l30.6"></a><span id="l30.6"> nsIAtom* nsMsgDBFolder::kStatusAtom=nsnull;</span>
<a href="#l30.7"></a><span id="l30.7"> nsIAtom* nsMsgDBFolder::kNameAtom=nsnull;</span>
<a href="#l30.8"></a><span id="l30.8"> nsIAtom* nsMsgDBFolder::kSynchronizeAtom=nsnull;</span>
<a href="#l30.9"></a><span id="l30.9"> nsIAtom* nsMsgDBFolder::kOpenAtom=nsnull;</span>
<a href="#l30.10"></a><span id="l30.10"> nsIAtom* nsMsgDBFolder::kIsDeferred=nsnull;</span>
<a href="#l30.11"></a><span id="l30.11"> nsIAtom* nsMsgDBFolder::kKeywords=nsnull;</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+nsIAtom* nsMsgDBFolder::mFiltersAppliedAtom=nsnull;</span>
<a href="#l30.13"></a><span id="l30.13"> </span>
<a href="#l30.14"></a><span id="l30.14"> nsICollation * nsMsgDBFolder::gCollationKeyGenerator = nsnull;</span>
<a href="#l30.15"></a><span id="l30.15"> </span>
<a href="#l30.16"></a><span id="l30.16"> PRUnichar *nsMsgDBFolder::kLocalizedInboxName;</span>
<a href="#l30.17"></a><span id="l30.17"> PRUnichar *nsMsgDBFolder::kLocalizedTrashName;</span>
<a href="#l30.18"></a><span id="l30.18"> PRUnichar *nsMsgDBFolder::kLocalizedSentName;</span>
<a href="#l30.19"></a><span id="l30.19"> PRUnichar *nsMsgDBFolder::kLocalizedDraftsName;</span>
<a href="#l30.20"></a><span id="l30.20"> PRUnichar *nsMsgDBFolder::kLocalizedTemplatesName;</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineat">@@ -169,17 +170,18 @@ const nsStaticAtom nsMsgDBFolder::folder</span>
<a href="#l30.22"></a><span id="l30.22">   { &quot;TotalUnreadMessages&quot;, &amp;nsMsgDBFolder::kTotalUnreadMessagesAtom },</span>
<a href="#l30.23"></a><span id="l30.23">   { &quot;TotalMessages&quot;, &amp;nsMsgDBFolder::kTotalMessagesAtom },</span>
<a href="#l30.24"></a><span id="l30.24">   { &quot;FolderSize&quot;, &amp;nsMsgDBFolder::kFolderSizeAtom },</span>
<a href="#l30.25"></a><span id="l30.25">   { &quot;Status&quot;, &amp;nsMsgDBFolder::kStatusAtom },</span>
<a href="#l30.26"></a><span id="l30.26">   { &quot;Flagged&quot;, &amp;nsMsgDBFolder::kFlaggedAtom },</span>
<a href="#l30.27"></a><span id="l30.27">   { &quot;Synchronize&quot;, &amp;nsMsgDBFolder::kSynchronizeAtom },</span>
<a href="#l30.28"></a><span id="l30.28">   { &quot;open&quot;, &amp;nsMsgDBFolder::kOpenAtom },</span>
<a href="#l30.29"></a><span id="l30.29">   { &quot;isDeferred&quot;, &amp;nsMsgDBFolder::kIsDeferred },</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineminus">-  { &quot;Keywords&quot;, &amp;nsMsgDBFolder::kKeywords }</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+  { &quot;Keywords&quot;, &amp;nsMsgDBFolder::kKeywords },</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+  { &quot;FiltersApplied&quot;, &amp;nsMsgDBFolder::mFiltersAppliedAtom }</span>
<a href="#l30.33"></a><span id="l30.33"> };</span>
<a href="#l30.34"></a><span id="l30.34"> </span>
<a href="#l30.35"></a><span id="l30.35"> nsMsgDBFolder::nsMsgDBFolder(void)</span>
<a href="#l30.36"></a><span id="l30.36"> : mAddListener(PR_TRUE),</span>
<a href="#l30.37"></a><span id="l30.37">   mNewMessages(PR_FALSE),</span>
<a href="#l30.38"></a><span id="l30.38">   mGettingNewMessages(PR_FALSE),</span>
<a href="#l30.39"></a><span id="l30.39">   mLastMessageLoaded(nsMsgKey_None),</span>
<a href="#l30.40"></a><span id="l30.40">   mFlags(0),</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineat">@@ -1698,17 +1700,18 @@ nsresult nsMsgDBFolder::CompactOfflineSt</span>
<a href="#l30.42"></a><span id="l30.42">   nsCOMPtr &lt;nsIMsgFolderCompactor&gt; folderCompactor =  do_CreateInstance(NS_MSGOFFLINESTORECOMPACTOR_CONTRACTID, &amp;rv);</span>
<a href="#l30.43"></a><span id="l30.43">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.44"></a><span id="l30.44">   return folderCompactor-&gt;Compact(this, PR_TRUE, aListener, inWindow);</span>
<a href="#l30.45"></a><span id="l30.45"> }</span>
<a href="#l30.46"></a><span id="l30.46"> </span>
<a href="#l30.47"></a><span id="l30.47"> nsresult</span>
<a href="#l30.48"></a><span id="l30.48"> nsMsgDBFolder::AutoCompact(nsIMsgWindow *aWindow)</span>
<a href="#l30.49"></a><span id="l30.49"> {</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineplus">+  // we don't check for null aWindow, because this routine can get called</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineplus">+  // in unit tests where we have no window. Just assume not OK if no window.</span>
<a href="#l30.53"></a><span id="l30.53">   PRBool prompt;</span>
<a href="#l30.54"></a><span id="l30.54">   nsresult rv = GetPromptPurgeThreshold(&amp;prompt);</span>
<a href="#l30.55"></a><span id="l30.55">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.56"></a><span id="l30.56">   PRTime timeNow = PR_Now();   //time in microseconds</span>
<a href="#l30.57"></a><span id="l30.57">   PRTime timeAfterOneHourOfLastPurgeCheck;</span>
<a href="#l30.58"></a><span id="l30.58">   LL_ADD(timeAfterOneHourOfLastPurgeCheck, gtimeOfLastPurgeCheck, oneHour);</span>
<a href="#l30.59"></a><span id="l30.59">   if (LL_CMP(timeAfterOneHourOfLastPurgeCheck, &lt;, timeNow) &amp;&amp; prompt)</span>
<a href="#l30.60"></a><span id="l30.60">   {</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineat">@@ -1790,17 +1793,17 @@ nsMsgDBFolder::AutoCompact(nsIMsgWindow </span>
<a href="#l30.62"></a><span id="l30.62">        {</span>
<a href="#l30.63"></a><span id="l30.63">          PRBool okToCompact = PR_FALSE;</span>
<a href="#l30.64"></a><span id="l30.64">          nsCOMPtr&lt;nsIPrefService&gt; pref = do_GetService(NS_PREFSERVICE_CONTRACTID);</span>
<a href="#l30.65"></a><span id="l30.65">          nsCOMPtr&lt;nsIPrefBranch&gt; branch;</span>
<a href="#l30.66"></a><span id="l30.66">          pref-&gt;GetBranch(&quot;&quot;, getter_AddRefs(branch));</span>
<a href="#l30.67"></a><span id="l30.67"> </span>
<a href="#l30.68"></a><span id="l30.68">          PRBool askBeforePurge;</span>
<a href="#l30.69"></a><span id="l30.69">          branch-&gt;GetBoolPref(PREF_MAIL_PURGE_ASK, &amp;askBeforePurge);</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineminus">-         if (askBeforePurge)</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineplus">+         if (askBeforePurge &amp;&amp; aWindow)</span>
<a href="#l30.72"></a><span id="l30.72">          {</span>
<a href="#l30.73"></a><span id="l30.73">            nsCOMPtr &lt;nsIStringBundle&gt; bundle;</span>
<a href="#l30.74"></a><span id="l30.74">            rv = GetBaseStringBundle(getter_AddRefs(bundle));</span>
<a href="#l30.75"></a><span id="l30.75">            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.76"></a><span id="l30.76">            nsString dialogTitle;</span>
<a href="#l30.77"></a><span id="l30.77">            nsString confirmString;</span>
<a href="#l30.78"></a><span id="l30.78">            nsString checkboxText;</span>
<a href="#l30.79"></a><span id="l30.79">            nsString buttonCompactNowText;</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineat">@@ -1831,17 +1834,17 @@ nsMsgDBFolder::AutoCompact(nsIMsgWindow </span>
<a href="#l30.81"></a><span id="l30.81">            if (!buttonPressed)</span>
<a href="#l30.82"></a><span id="l30.82">            {</span>
<a href="#l30.83"></a><span id="l30.83">              okToCompact = PR_TRUE;</span>
<a href="#l30.84"></a><span id="l30.84">              if (!alwaysAsk) // [ ] Always ask me before compacting folders automatically</span>
<a href="#l30.85"></a><span id="l30.85">                branch-&gt;SetBoolPref(PREF_MAIL_PURGE_ASK, PR_FALSE);</span>
<a href="#l30.86"></a><span id="l30.86">            }</span>
<a href="#l30.87"></a><span id="l30.87">          }</span>
<a href="#l30.88"></a><span id="l30.88">          else</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineminus">-           okToCompact = PR_TRUE;</span>
<a href="#l30.90"></a><span id="l30.90" class="difflineplus">+           okToCompact = aWindow || !askBeforePurge;</span>
<a href="#l30.91"></a><span id="l30.91"> </span>
<a href="#l30.92"></a><span id="l30.92">          if (okToCompact)</span>
<a href="#l30.93"></a><span id="l30.93">          {</span>
<a href="#l30.94"></a><span id="l30.94">             nsCOMPtr &lt;nsIAtom&gt; aboutToCompactAtom = do_GetAtom(&quot;AboutToCompact&quot;);</span>
<a href="#l30.95"></a><span id="l30.95">             NotifyFolderEvent(aboutToCompactAtom);</span>
<a href="#l30.96"></a><span id="l30.96"> </span>
<a href="#l30.97"></a><span id="l30.97">            if ( localExpungedBytes &gt; 0)</span>
<a href="#l30.98"></a><span id="l30.98">            {</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineat">@@ -2312,46 +2315,39 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l30.100"></a><span id="l30.100"> </span>
<a href="#l30.101"></a><span id="l30.101">   nsCOMPtr &lt;nsIJunkMailPlugin&gt; junkMailPlugin = do_QueryInterface(filterPlugin);</span>
<a href="#l30.102"></a><span id="l30.102">   if (!junkMailPlugin) // we currently only support the junk mail plugin</span>
<a href="#l30.103"></a><span id="l30.103">     return NS_OK;</span>
<a href="#l30.104"></a><span id="l30.104"> </span>
<a href="#l30.105"></a><span id="l30.105">   // if it's a news folder, then we really don't support junk in the ui</span>
<a href="#l30.106"></a><span id="l30.106">   // yet the legacy spamLevel seems to think we should analyze it.</span>
<a href="#l30.107"></a><span id="l30.107">   // Maybe we should upgrade that, but for now let's not analyze. We'll</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineminus">-  // use the preference &quot;mail.filter_news_for_junk&quot;, and/or</span>
<a href="#l30.109"></a><span id="l30.109">   // let an extension set an inherited property if they really want us to</span>
<a href="#l30.110"></a><span id="l30.110">   // analyze this. We need that anyway to allow extension-based overrides.</span>
<a href="#l30.111"></a><span id="l30.111">   // When we finalize adding junk in news to core, we'll deal with the</span>
<a href="#l30.112"></a><span id="l30.112">   // spamLevel issue</span>
<a href="#l30.113"></a><span id="l30.113"> </span>
<a href="#l30.114"></a><span id="l30.114" class="difflineminus">-  PRBool filterNewsForJunk = PR_FALSE;</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l30.116"></a><span id="l30.116" class="difflineminus">-  if (prefBranch)</span>
<a href="#l30.117"></a><span id="l30.117" class="difflineminus">-    prefBranch-&gt;GetBoolPref(&quot;mail.filter_news_for_junk&quot;, &amp;filterNewsForJunk);</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineminus">-</span>
<a href="#l30.119"></a><span id="l30.119">   // if this is the junk folder, or the trash folder</span>
<a href="#l30.120"></a><span id="l30.120">   // don't analyze for spam, because we don't care</span>
<a href="#l30.121"></a><span id="l30.121">   //</span>
<a href="#l30.122"></a><span id="l30.122">   // if it's the sent, unsent, templates, or drafts,</span>
<a href="#l30.123"></a><span id="l30.123">   // don't analyze for spam, because the user</span>
<a href="#l30.124"></a><span id="l30.124">   // created that message</span>
<a href="#l30.125"></a><span id="l30.125">   //</span>
<a href="#l30.126"></a><span id="l30.126">   // if it's a public imap folder, or another users</span>
<a href="#l30.127"></a><span id="l30.127">   // imap folder, don't analyze for spam, because</span>
<a href="#l30.128"></a><span id="l30.128">   // it's not ours to analyze</span>
<a href="#l30.129"></a><span id="l30.129">   //</span>
<a href="#l30.130"></a><span id="l30.130"> </span>
<a href="#l30.131"></a><span id="l30.131">   PRBool filterForJunk = PR_TRUE;</span>
<a href="#l30.132"></a><span id="l30.132">   if (serverType.EqualsLiteral(&quot;rss&quot;) ||</span>
<a href="#l30.133"></a><span id="l30.133" class="difflineminus">-      (mFlags &amp; nsMsgFolderFlags::Newsgroup &amp;&amp; !filterNewsForJunk) ||</span>
<a href="#l30.134"></a><span id="l30.134">       (mFlags &amp; (nsMsgFolderFlags::Junk | nsMsgFolderFlags::Trash |</span>
<a href="#l30.135"></a><span id="l30.135">                  nsMsgFolderFlags::SentMail | nsMsgFolderFlags::Queue |</span>
<a href="#l30.136"></a><span id="l30.136">                  nsMsgFolderFlags::Drafts | nsMsgFolderFlags::Templates |</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineminus">-                 nsMsgFolderFlags::ImapPublic |</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineplus">+                 nsMsgFolderFlags::ImapPublic | nsMsgFolderFlags::Newsgroup |</span>
<a href="#l30.139"></a><span id="l30.139">                  nsMsgFolderFlags::ImapOtherUser) &amp;&amp;</span>
<a href="#l30.140"></a><span id="l30.140">        !(mFlags &amp; nsMsgFolderFlags::Inbox)))</span>
<a href="#l30.141"></a><span id="l30.141">     filterForJunk = PR_FALSE;</span>
<a href="#l30.142"></a><span id="l30.142"> </span>
<a href="#l30.143"></a><span id="l30.143">   spamSettings-&gt;GetLevel(&amp;spamLevel);</span>
<a href="#l30.144"></a><span id="l30.144">   if (!spamLevel)</span>
<a href="#l30.145"></a><span id="l30.145">     filterForJunk = PR_FALSE;</span>
<a href="#l30.146"></a><span id="l30.146"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -193,16 +193,17 @@ protected:</span>
<a href="#l31.4"></a><span id="l31.4">   nsCOMPtr&lt;nsIOutputStream&gt; m_tempMessageStream;</span>
<a href="#l31.5"></a><span id="l31.5"> </span>
<a href="#l31.6"></a><span id="l31.6">   nsCOMPtr &lt;nsIMsgRetentionSettings&gt; m_retentionSettings;</span>
<a href="#l31.7"></a><span id="l31.7">   nsCOMPtr &lt;nsIMsgDownloadSettings&gt; m_downloadSettings;</span>
<a href="#l31.8"></a><span id="l31.8">   static NS_MSG_BASE_STATIC_MEMBER_(nsIAtom*) mFolderLoadedAtom;</span>
<a href="#l31.9"></a><span id="l31.9">   static NS_MSG_BASE_STATIC_MEMBER_(nsIAtom*) mDeleteOrMoveMsgCompletedAtom;</span>
<a href="#l31.10"></a><span id="l31.10">   static NS_MSG_BASE_STATIC_MEMBER_(nsIAtom*) mDeleteOrMoveMsgFailedAtom;</span>
<a href="#l31.11"></a><span id="l31.11">   static NS_MSG_BASE_STATIC_MEMBER_(nsIAtom*) mJunkStatusChangedAtom;</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+  static NS_MSG_BASE_STATIC_MEMBER_(nsIAtom*) mFiltersAppliedAtom;</span>
<a href="#l31.13"></a><span id="l31.13">   static NS_MSG_BASE_STATIC_MEMBER_(nsrefcnt) mInstanceCount;</span>
<a href="#l31.14"></a><span id="l31.14"> </span>
<a href="#l31.15"></a><span id="l31.15"> protected:</span>
<a href="#l31.16"></a><span id="l31.16">   PRUint32 mFlags;</span>
<a href="#l31.17"></a><span id="l31.17">   nsWeakPtr mParent;     //This won't be refcounted for ownership reasons.</span>
<a href="#l31.18"></a><span id="l31.18">   PRInt32 mNumUnreadMessages;        /* count of unread messages (-1 means unknown; -2 means unknown but we already tried to find out.) */</span>
<a href="#l31.19"></a><span id="l31.19">   PRInt32 mNumTotalMessages;         /* count of existing messages. */</span>
<a href="#l31.20"></a><span id="l31.20">   PRBool mNotifyCountChanges;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -274,16 +274,24 @@ nsresult nsMsgProtocol::OpenFileSocket(n</span>
<a href="#l32.4"></a><span id="l32.4">   rv = sts-&gt;CreateInputTransport(stream, nsInt64(aStartPosition),</span>
<a href="#l32.5"></a><span id="l32.5">                                  nsInt64(aReadCount), PR_TRUE,</span>
<a href="#l32.6"></a><span id="l32.6">                                  getter_AddRefs(m_transport));</span>
<a href="#l32.7"></a><span id="l32.7"> </span>
<a href="#l32.8"></a><span id="l32.8">   m_socketIsOpen = PR_FALSE;</span>
<a href="#l32.9"></a><span id="l32.9">   return rv;</span>
<a href="#l32.10"></a><span id="l32.10"> }</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineplus">+nsresult nsMsgProtocol::GetTopmostMsgWindow(nsIMsgWindow **aWindow)</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+{</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+  nsresult rv;</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession(do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv));</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+  return mailSession-&gt;GetTopmostMsgWindow(aWindow);</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineplus">+}</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineplus">+</span>
<a href="#l32.20"></a><span id="l32.20"> nsresult nsMsgProtocol::SetupTransportState()</span>
<a href="#l32.21"></a><span id="l32.21"> {</span>
<a href="#l32.22"></a><span id="l32.22">   if (!m_socketIsOpen &amp;&amp; m_transport)</span>
<a href="#l32.23"></a><span id="l32.23">   {</span>
<a href="#l32.24"></a><span id="l32.24">     nsresult rv;</span>
<a href="#l32.25"></a><span id="l32.25"> </span>
<a href="#l32.26"></a><span id="l32.26">     // open buffered, blocking output stream</span>
<a href="#l32.27"></a><span id="l32.27">     rv = m_transport-&gt;OpenOutputStream(nsITransport::OPEN_BLOCKING, 0, 0, getter_AddRefs(m_outputStream));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.h</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.h</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -49,16 +49,18 @@</span>
<a href="#l33.4"></a><span id="l33.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l33.5"></a><span id="l33.5"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l33.6"></a><span id="l33.6"> #include &quot;nsIInterfaceRequestorUtils.h&quot;</span>
<a href="#l33.7"></a><span id="l33.7"> #include &quot;nsIProgressEventSink.h&quot;</span>
<a href="#l33.8"></a><span id="l33.8"> #include &quot;nsITransport.h&quot;</span>
<a href="#l33.9"></a><span id="l33.9"> #include &quot;nsIAsyncOutputStream.h&quot;</span>
<a href="#l33.10"></a><span id="l33.10"> #include &quot;nsIAuthModule.h&quot;</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineplus">+class nsIMsgWindow;</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+</span>
<a href="#l33.14"></a><span id="l33.14"> #define UNKNOWN_ERROR             101</span>
<a href="#l33.15"></a><span id="l33.15"> #define UNKNOWN_HOST_ERROR        102</span>
<a href="#l33.16"></a><span id="l33.16"> #define CONNECTION_REFUSED_ERROR  103</span>
<a href="#l33.17"></a><span id="l33.17"> #define NET_TIMEOUT_ERROR         104</span>
<a href="#l33.18"></a><span id="l33.18"> </span>
<a href="#l33.19"></a><span id="l33.19"> class nsIPrompt;</span>
<a href="#l33.20"></a><span id="l33.20"> class nsIMsgMailNewsUrl;</span>
<a href="#l33.21"></a><span id="l33.21"> class nsMsgFilePostHelper;</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineat">@@ -118,16 +120,18 @@ protected:</span>
<a href="#l33.23"></a><span id="l33.23">                                              PRInt32 aGetPort,</span>
<a href="#l33.24"></a><span id="l33.24">                                              const char *connectionType,</span>
<a href="#l33.25"></a><span id="l33.25">                                              nsIProxyInfo *aProxyInfo,</span>
<a href="#l33.26"></a><span id="l33.26">                                              nsIInterfaceRequestor* callbacks);</span>
<a href="#l33.27"></a><span id="l33.27">   // helper routine</span>
<a href="#l33.28"></a><span id="l33.28">   nsresult GetFileFromURL(nsIURI * aURL, nsIFile **aResult);</span>
<a href="#l33.29"></a><span id="l33.29">   virtual nsresult OpenFileSocket(nsIURI * aURL, PRUint32 aStartPosition, PRInt32 aReadCount); // used to open a file socket connection</span>
<a href="#l33.30"></a><span id="l33.30"> </span>
<a href="#l33.31"></a><span id="l33.31" class="difflineplus">+  nsresult GetTopmostMsgWindow(nsIMsgWindow **aWindow);</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+</span>
<a href="#l33.33"></a><span id="l33.33">   // a Protocol typically overrides this method. They free any of their own connection state and then</span>
<a href="#l33.34"></a><span id="l33.34">   // they call up into the base class to free the generic connection objects</span>
<a href="#l33.35"></a><span id="l33.35">   virtual nsresult CloseSocket(); </span>
<a href="#l33.36"></a><span id="l33.36"> </span>
<a href="#l33.37"></a><span id="l33.37">   virtual nsresult SetupTransportState(); // private method used by OpenNetworkSocket and OpenFileSocket</span>
<a href="#l33.38"></a><span id="l33.38"> </span>
<a href="#l33.39"></a><span id="l33.39">   // ProcessProtocolState - This is the function that gets churned by calls to OnDataAvailable. </span>
<a href="#l33.40"></a><span id="l33.40">   // As data arrives on the socket, OnDataAvailable calls ProcessProtocolState.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/db/gloda/modules/datamodel.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/datamodel.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -444,17 +444,18 @@ GlodaMessage.prototype = {</span>
<a href="#l34.4"></a><span id="l34.4">   toString: function gloda_message_toString() {</span>
<a href="#l34.5"></a><span id="l34.5">     // uh, this is a tough one...</span>
<a href="#l34.6"></a><span id="l34.6">     return &quot;Message:&quot; + this._id;</span>
<a href="#l34.7"></a><span id="l34.7">   },</span>
<a href="#l34.8"></a><span id="l34.8"> </span>
<a href="#l34.9"></a><span id="l34.9">   _clone: function gloda_message_clone() {</span>
<a href="#l34.10"></a><span id="l34.10">     return new GlodaMessage(this._datastore, this._id, this._folderID,</span>
<a href="#l34.11"></a><span id="l34.11">       this._messageKey, this._conversationID, this._conversation, this._date,</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-      this._headerMessageID, this._deleted);</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+      this._headerMessageID, this._deleted, this._jsonText, this._notability,</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+      this._subject, this._indexedBodyText, this._attachmentNames);</span>
<a href="#l34.15"></a><span id="l34.15">   },</span>
<a href="#l34.16"></a><span id="l34.16"> </span>
<a href="#l34.17"></a><span id="l34.17">   _ghost: function gloda_message_ghost() {</span>
<a href="#l34.18"></a><span id="l34.18">     this._folderID = null;</span>
<a href="#l34.19"></a><span id="l34.19">     this._messageKey = null;</span>
<a href="#l34.20"></a><span id="l34.20">   },</span>
<a href="#l34.21"></a><span id="l34.21"> </span>
<a href="#l34.22"></a><span id="l34.22">   _nuke: function gloda_message_nuke() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -15,16 +15,17 @@</span>
<a href="#l35.4"></a><span id="l35.4">  *</span>
<a href="#l35.5"></a><span id="l35.5">  * The Initial Developer of the Original Code is</span>
<a href="#l35.6"></a><span id="l35.6">  * Mozilla Messaging, Inc.</span>
<a href="#l35.7"></a><span id="l35.7">  * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l35.8"></a><span id="l35.8">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l35.9"></a><span id="l35.9">  *</span>
<a href="#l35.10"></a><span id="l35.10">  * Contributor(s):</span>
<a href="#l35.11"></a><span id="l35.11">  *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+ *   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l35.13"></a><span id="l35.13">  *</span>
<a href="#l35.14"></a><span id="l35.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l35.15"></a><span id="l35.15">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l35.16"></a><span id="l35.16">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l35.17"></a><span id="l35.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l35.18"></a><span id="l35.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l35.19"></a><span id="l35.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l35.20"></a><span id="l35.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineat">@@ -48,62 +49,16 @@ const Cr = Components.results;</span>
<a href="#l35.22"></a><span id="l35.22"> const Cu = Components.utils;</span>
<a href="#l35.23"></a><span id="l35.23"> </span>
<a href="#l35.24"></a><span id="l35.24"> Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l35.25"></a><span id="l35.25"> </span>
<a href="#l35.26"></a><span id="l35.26"> Cu.import(&quot;resource://app/modules/gloda/datamodel.js&quot;);</span>
<a href="#l35.27"></a><span id="l35.27"> Cu.import(&quot;resource://app/modules/gloda/databind.js&quot;);</span>
<a href="#l35.28"></a><span id="l35.28"> Cu.import(&quot;resource://app/modules/gloda/collection.js&quot;);</span>
<a href="#l35.29"></a><span id="l35.29"> </span>
<a href="#l35.30"></a><span id="l35.30" class="difflineminus">-let MBM_LOG = Log4Moz.repository.getLogger(&quot;gloda.ds.mbm&quot;);</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineminus">-</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineminus">-/**</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineminus">- * @class This callback handles processing the asynchronous query results of</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineminus">- *  GlodaDatastore.getMessagesByMessageID.  Because that method is only</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineminus">- *  called as part of the indexing process, we are guaranteed that there will</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineminus">- *  be no real caching ramifications.  Accordingly, we can also defer our cache</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineminus">- *  processing (via GlodaCollectionManager) until the query completes.</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineminus">- *</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineminus">- * @param aMsgIDToIndex Map from message-id to the desired</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineminus">- *</span>
<a href="#l35.41"></a><span id="l35.41" class="difflineminus">- * @constructor</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineminus">- */</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineminus">-function MessagesByMessageIdCallback(aMsgIDToIndex, aResults,</span>
<a href="#l35.44"></a><span id="l35.44" class="difflineminus">-                                     aCallback, aCallbackThis) {</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineminus">-  this.msgIDToIndex = aMsgIDToIndex;</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineminus">-  this.results = aResults;</span>
<a href="#l35.47"></a><span id="l35.47" class="difflineminus">-  this.callback = aCallback;</span>
<a href="#l35.48"></a><span id="l35.48" class="difflineminus">-  this.callbackThis = aCallbackThis;</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineminus">-}</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineminus">-</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineminus">-MessagesByMessageIdCallback.prototype = {</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineminus">-  onItemsAdded: function gloda_ds_mbmi_onItemsAdded(aItems, aCollection) {</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineminus">-    // just outright bail if we are shutdown</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineminus">-    if (GlodaDatastore.datastoreIsShutdown)</span>
<a href="#l35.55"></a><span id="l35.55" class="difflineminus">-      return;</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineminus">-</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineminus">-    MBM_LOG.debug(&quot;getting results...&quot;);</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineminus">-    for each (let [, message] in Iterator(aItems)) {</span>
<a href="#l35.59"></a><span id="l35.59" class="difflineminus">-      this.results[this.msgIDToIndex[message.headerMessageID]].push(message);</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineminus">-    }</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineminus">-  },</span>
<a href="#l35.62"></a><span id="l35.62" class="difflineminus">-  onItemsModified: function () {},</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineminus">-  onItemsRemoved: function () {},</span>
<a href="#l35.64"></a><span id="l35.64" class="difflineminus">-  onQueryCompleted: function gloda_ds_mbmi_onQueryCompleted(aCollection) {</span>
<a href="#l35.65"></a><span id="l35.65" class="difflineminus">-    // just outright bail if we are shutdown</span>
<a href="#l35.66"></a><span id="l35.66" class="difflineminus">-    if (GlodaDatastore.datastoreIsShutdown)</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineminus">-      return;</span>
<a href="#l35.68"></a><span id="l35.68" class="difflineminus">-</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineminus">-    MBM_LOG.debug(&quot;query completed, notifying... &quot; + this.results);</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineminus">-    // we no longer need to unify; it is done for us.</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineminus">-</span>
<a href="#l35.72"></a><span id="l35.72" class="difflineminus">-    this.callback.call(this.callbackThis, this.results);</span>
<a href="#l35.73"></a><span id="l35.73" class="difflineminus">-  }</span>
<a href="#l35.74"></a><span id="l35.74" class="difflineminus">-};</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineminus">-</span>
<a href="#l35.76"></a><span id="l35.76"> let PCH_LOG = Log4Moz.repository.getLogger(&quot;gloda.ds.pch&quot;);</span>
<a href="#l35.77"></a><span id="l35.77"> </span>
<a href="#l35.78"></a><span id="l35.78"> function PostCommitHandler(aCallbacks) {</span>
<a href="#l35.79"></a><span id="l35.79">   this.callbacks = aCallbacks;</span>
<a href="#l35.80"></a><span id="l35.80">   GlodaDatastore._pendingAsyncStatements++;</span>
<a href="#l35.81"></a><span id="l35.81"> }</span>
<a href="#l35.82"></a><span id="l35.82"> </span>
<a href="#l35.83"></a><span id="l35.83"> PostCommitHandler.prototype = {</span>
<a href="#l35.84"></a><span id="l35.84" class="difflineat">@@ -1883,44 +1838,56 @@ var GlodaDatastore = {</span>
<a href="#l35.85"></a><span id="l35.85">        ims.executeAsync(this.trackAsync());</span>
<a href="#l35.86"></a><span id="l35.86">     }</span>
<a href="#l35.87"></a><span id="l35.87">     catch(ex) {</span>
<a href="#l35.88"></a><span id="l35.88">        throw(&quot;error executing statement... &quot; +</span>
<a href="#l35.89"></a><span id="l35.89">              this.asyncConnection.lastError + &quot;: &quot; +</span>
<a href="#l35.90"></a><span id="l35.90">              this.asyncConnection.lastErrorString + &quot; - &quot; + ex);</span>
<a href="#l35.91"></a><span id="l35.91">     }</span>
<a href="#l35.92"></a><span id="l35.92"> </span>
<a href="#l35.93"></a><span id="l35.93" class="difflineminus">-    // we only create the full-text row if the body is non-null.</span>
<a href="#l35.94"></a><span id="l35.94" class="difflineminus">-    // so, even though body might be null, we still want to create the</span>
<a href="#l35.95"></a><span id="l35.95" class="difflineminus">-    //  full-text search row</span>
<a href="#l35.96"></a><span id="l35.96" class="difflineminus">-    if (aMessage._bodyLines) {</span>
<a href="#l35.97"></a><span id="l35.97" class="difflineminus">-      if (aMessage._content &amp;&amp; aMessage._content.hasContent())</span>
<a href="#l35.98"></a><span id="l35.98" class="difflineminus">-        aMessage._indexedBodyText = aMessage._content.getContentString(true);</span>
<a href="#l35.99"></a><span id="l35.99" class="difflineminus">-      else</span>
<a href="#l35.100"></a><span id="l35.100" class="difflineminus">-        aMessage._indexedBodyText = aMessage._bodyLines.join(&quot;\n&quot;);</span>
<a href="#l35.101"></a><span id="l35.101" class="difflineminus">-</span>
<a href="#l35.102"></a><span id="l35.102" class="difflineminus">-      let imts = this._insertMessageTextStatement;</span>
<a href="#l35.103"></a><span id="l35.103" class="difflineminus">-      imts.bindInt64Parameter(0, aMessage.id);</span>
<a href="#l35.104"></a><span id="l35.104" class="difflineminus">-      imts.bindStringParameter(1, aMessage._subject);</span>
<a href="#l35.105"></a><span id="l35.105" class="difflineplus">+    // we create the full-text row for any message that isn't a ghost,</span>
<a href="#l35.106"></a><span id="l35.106" class="difflineplus">+    // whether we have the body or not</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineplus">+    if (aMessage.folderID !== null)</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineplus">+      this._insertMessageText(aMessage);</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineplus">+  },</span>
<a href="#l35.110"></a><span id="l35.110" class="difflineplus">+</span>
<a href="#l35.111"></a><span id="l35.111" class="difflineplus">+  /**</span>
<a href="#l35.112"></a><span id="l35.112" class="difflineplus">+   * Inserts a full-text row. This should only be called if you're sure you want</span>
<a href="#l35.113"></a><span id="l35.113" class="difflineplus">+   * to insert a row into the table.</span>
<a href="#l35.114"></a><span id="l35.114" class="difflineplus">+   */</span>
<a href="#l35.115"></a><span id="l35.115" class="difflineplus">+  _insertMessageText: function gloda_ds__insertMessageText(aMessage) {</span>
<a href="#l35.116"></a><span id="l35.116" class="difflineplus">+    if (aMessage._content &amp;&amp; aMessage._content.hasContent())</span>
<a href="#l35.117"></a><span id="l35.117" class="difflineplus">+      aMessage._indexedBodyText = aMessage._content.getContentString(true);</span>
<a href="#l35.118"></a><span id="l35.118" class="difflineplus">+    else if (aMessage._bodyLines)</span>
<a href="#l35.119"></a><span id="l35.119" class="difflineplus">+      aMessage._indexedBodyText = aMessage._bodyLines.join(&quot;\n&quot;);</span>
<a href="#l35.120"></a><span id="l35.120" class="difflineplus">+    else</span>
<a href="#l35.121"></a><span id="l35.121" class="difflineplus">+      aMessage._indexedBodyText = null;</span>
<a href="#l35.122"></a><span id="l35.122" class="difflineplus">+</span>
<a href="#l35.123"></a><span id="l35.123" class="difflineplus">+    let imts = this._insertMessageTextStatement;</span>
<a href="#l35.124"></a><span id="l35.124" class="difflineplus">+    imts.bindInt64Parameter(0, aMessage.id);</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineplus">+    imts.bindStringParameter(1, aMessage._subject);</span>
<a href="#l35.126"></a><span id="l35.126" class="difflineplus">+    if (aMessage._indexedBodyText == null)</span>
<a href="#l35.127"></a><span id="l35.127" class="difflineplus">+      imts.bindNullParameter(2);</span>
<a href="#l35.128"></a><span id="l35.128" class="difflineplus">+    else</span>
<a href="#l35.129"></a><span id="l35.129">       imts.bindStringParameter(2, aMessage._indexedBodyText);</span>
<a href="#l35.130"></a><span id="l35.130" class="difflineminus">-      if (aMessage._attachmentNames === null)</span>
<a href="#l35.131"></a><span id="l35.131" class="difflineminus">-        imts.bindNullParameter(3);</span>
<a href="#l35.132"></a><span id="l35.132" class="difflineminus">-      else</span>
<a href="#l35.133"></a><span id="l35.133" class="difflineminus">-        imts.bindStringParameter(3, aMessage._attachmentNames.join(&quot;\n&quot;));</span>
<a href="#l35.134"></a><span id="l35.134" class="difflineminus">-      imts.bindStringParameter(4, aMessage._indexAuthor);</span>
<a href="#l35.135"></a><span id="l35.135" class="difflineminus">-      imts.bindStringParameter(5, aMessage._indexRecipients);</span>
<a href="#l35.136"></a><span id="l35.136" class="difflineminus">-</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineminus">-      try {</span>
<a href="#l35.138"></a><span id="l35.138" class="difflineminus">-         imts.executeAsync(this.trackAsync());</span>
<a href="#l35.139"></a><span id="l35.139" class="difflineminus">-      }</span>
<a href="#l35.140"></a><span id="l35.140" class="difflineminus">-      catch(ex) {</span>
<a href="#l35.141"></a><span id="l35.141" class="difflineminus">-         throw(&quot;error executing fulltext statement... &quot; +</span>
<a href="#l35.142"></a><span id="l35.142" class="difflineminus">-               this.asyncConnection.lastError + &quot;: &quot; +</span>
<a href="#l35.143"></a><span id="l35.143" class="difflineminus">-               this.asyncConnection.lastErrorString + &quot; - &quot; + ex);</span>
<a href="#l35.144"></a><span id="l35.144" class="difflineminus">-      }</span>
<a href="#l35.145"></a><span id="l35.145" class="difflineplus">+    if (aMessage._attachmentNames === null)</span>
<a href="#l35.146"></a><span id="l35.146" class="difflineplus">+      imts.bindNullParameter(3);</span>
<a href="#l35.147"></a><span id="l35.147" class="difflineplus">+    else</span>
<a href="#l35.148"></a><span id="l35.148" class="difflineplus">+      imts.bindStringParameter(3, aMessage._attachmentNames.join(&quot;\n&quot;));</span>
<a href="#l35.149"></a><span id="l35.149" class="difflineplus">+</span>
<a href="#l35.150"></a><span id="l35.150" class="difflineplus">+    imts.bindStringParameter(4, aMessage._indexAuthor);</span>
<a href="#l35.151"></a><span id="l35.151" class="difflineplus">+    imts.bindStringParameter(5, aMessage._indexRecipients);</span>
<a href="#l35.152"></a><span id="l35.152" class="difflineplus">+</span>
<a href="#l35.153"></a><span id="l35.153" class="difflineplus">+    try {</span>
<a href="#l35.154"></a><span id="l35.154" class="difflineplus">+      imts.executeAsync(this.trackAsync());</span>
<a href="#l35.155"></a><span id="l35.155" class="difflineplus">+    }</span>
<a href="#l35.156"></a><span id="l35.156" class="difflineplus">+    catch(ex) {</span>
<a href="#l35.157"></a><span id="l35.157" class="difflineplus">+      throw(&quot;error executing fulltext statement... &quot; +</span>
<a href="#l35.158"></a><span id="l35.158" class="difflineplus">+            this.asyncConnection.lastError + &quot;: &quot; +</span>
<a href="#l35.159"></a><span id="l35.159" class="difflineplus">+            this.asyncConnection.lastErrorString + &quot; - &quot; + ex);</span>
<a href="#l35.160"></a><span id="l35.160">     }</span>
<a href="#l35.161"></a><span id="l35.161">   },</span>
<a href="#l35.162"></a><span id="l35.162"> </span>
<a href="#l35.163"></a><span id="l35.163">   get _updateMessageStatement() {</span>
<a href="#l35.164"></a><span id="l35.164">     let statement = this._createAsyncStatement(</span>
<a href="#l35.165"></a><span id="l35.165">       &quot;UPDATE messages SET folderID = ?1, \</span>
<a href="#l35.166"></a><span id="l35.166">                            messageKey = ?2, \</span>
<a href="#l35.167"></a><span id="l35.167">                            conversationID = ?3, \</span>
<a href="#l35.168"></a><span id="l35.168" class="difflineat">@@ -1928,20 +1895,34 @@ var GlodaDatastore = {</span>
<a href="#l35.169"></a><span id="l35.169">                            headerMessageID = ?5, \</span>
<a href="#l35.170"></a><span id="l35.170">                            jsonAttributes = ?6, \</span>
<a href="#l35.171"></a><span id="l35.171">                            notability = ?7 \</span>
<a href="#l35.172"></a><span id="l35.172">               WHERE id = ?8&quot;);</span>
<a href="#l35.173"></a><span id="l35.173">     this.__defineGetter__(&quot;_updateMessageStatement&quot;, function() statement);</span>
<a href="#l35.174"></a><span id="l35.174">     return this._updateMessageStatement;</span>
<a href="#l35.175"></a><span id="l35.175">   },</span>
<a href="#l35.176"></a><span id="l35.176"> </span>
<a href="#l35.177"></a><span id="l35.177" class="difflineplus">+  get _updateMessageTextStatement() {</span>
<a href="#l35.178"></a><span id="l35.178" class="difflineplus">+    let statement = this._createAsyncStatement(</span>
<a href="#l35.179"></a><span id="l35.179" class="difflineplus">+      &quot;UPDATE messagesText SET body = ?1, \</span>
<a href="#l35.180"></a><span id="l35.180" class="difflineplus">+                               attachmentNames = ?2 \</span>
<a href="#l35.181"></a><span id="l35.181" class="difflineplus">+              WHERE docid = ?3&quot;);</span>
<a href="#l35.182"></a><span id="l35.182" class="difflineplus">+</span>
<a href="#l35.183"></a><span id="l35.183" class="difflineplus">+    this.__defineGetter__(&quot;_updateMessageTextStatement&quot;, function() statement);</span>
<a href="#l35.184"></a><span id="l35.184" class="difflineplus">+    return this._updateMessageTextStatement;</span>
<a href="#l35.185"></a><span id="l35.185" class="difflineplus">+  },</span>
<a href="#l35.186"></a><span id="l35.186" class="difflineplus">+</span>
<a href="#l35.187"></a><span id="l35.187">   /**</span>
<a href="#l35.188"></a><span id="l35.188" class="difflineminus">-   * Update the database row associated with the message.  If aBody is supplied,</span>
<a href="#l35.189"></a><span id="l35.189" class="difflineminus">-   *  the associated full-text row is created; it is assumed that it did not</span>
<a href="#l35.190"></a><span id="l35.190" class="difflineminus">-   *  previously exist.</span>
<a href="#l35.191"></a><span id="l35.191" class="difflineplus">+   * Update the database row associated with the message. If the message is</span>
<a href="#l35.192"></a><span id="l35.192" class="difflineplus">+   * not a ghost and has _isNew defined, messagesText is affected.</span>
<a href="#l35.193"></a><span id="l35.193" class="difflineplus">+   *</span>
<a href="#l35.194"></a><span id="l35.194" class="difflineplus">+   * aMessage._isNew is currently equivalent to the fact that there is no</span>
<a href="#l35.195"></a><span id="l35.195" class="difflineplus">+   * full-text row associated with this message, and we work with this</span>
<a href="#l35.196"></a><span id="l35.196" class="difflineplus">+   * assumption here. Note that if aMessage._isNew is not defined, then</span>
<a href="#l35.197"></a><span id="l35.197" class="difflineplus">+   * we don't do anything.</span>
<a href="#l35.198"></a><span id="l35.198">    */</span>
<a href="#l35.199"></a><span id="l35.199">   updateMessage: function gloda_ds_updateMessage(aMessage) {</span>
<a href="#l35.200"></a><span id="l35.200">     let ums = this._updateMessageStatement;</span>
<a href="#l35.201"></a><span id="l35.201">     ums.bindInt64Parameter(7, aMessage.id);</span>
<a href="#l35.202"></a><span id="l35.202">     if (aMessage.folderID === null)</span>
<a href="#l35.203"></a><span id="l35.203">       ums.bindNullParameter(0);</span>
<a href="#l35.204"></a><span id="l35.204">     else</span>
<a href="#l35.205"></a><span id="l35.205">       ums.bindInt64Parameter(0, aMessage.folderID);</span>
<a href="#l35.206"></a><span id="l35.206" class="difflineat">@@ -1958,49 +1939,74 @@ var GlodaDatastore = {</span>
<a href="#l35.207"></a><span id="l35.207">     if (aMessage._jsonText)</span>
<a href="#l35.208"></a><span id="l35.208">       ums.bindStringParameter(5, aMessage._jsonText);</span>
<a href="#l35.209"></a><span id="l35.209">     else</span>
<a href="#l35.210"></a><span id="l35.210">       ums.bindNullParameter(5);</span>
<a href="#l35.211"></a><span id="l35.211">     ums.bindInt64Parameter(6, aMessage.notability);</span>
<a href="#l35.212"></a><span id="l35.212"> </span>
<a href="#l35.213"></a><span id="l35.213">     ums.executeAsync(this.trackAsync());</span>
<a href="#l35.214"></a><span id="l35.214"> </span>
<a href="#l35.215"></a><span id="l35.215" class="difflineminus">-    if (aMessage._isNew &amp;&amp; aMessage._bodyLines) {</span>
<a href="#l35.216"></a><span id="l35.216" class="difflineminus">-      if (aMessage._content &amp;&amp; aMessage._content.hasContent())</span>
<a href="#l35.217"></a><span id="l35.217" class="difflineminus">-        aMessage._indexedBodyText = aMessage._content.getContentString(true);</span>
<a href="#l35.218"></a><span id="l35.218" class="difflineminus">-      else</span>
<a href="#l35.219"></a><span id="l35.219" class="difflineminus">-        aMessage._indexedBodyText = aMessage._bodyLines.join(&quot;\n&quot;);</span>
<a href="#l35.220"></a><span id="l35.220" class="difflineminus">-</span>
<a href="#l35.221"></a><span id="l35.221" class="difflineminus">-      let imts = this._insertMessageTextStatement;</span>
<a href="#l35.222"></a><span id="l35.222" class="difflineminus">-      imts.bindInt64Parameter(0, aMessage.id);</span>
<a href="#l35.223"></a><span id="l35.223" class="difflineminus">-      imts.bindStringParameter(1, aMessage._subject);</span>
<a href="#l35.224"></a><span id="l35.224" class="difflineminus">-      imts.bindStringParameter(2, aMessage._indexedBodyText);</span>
<a href="#l35.225"></a><span id="l35.225" class="difflineminus">-      if (aMessage._attachmentNames === null)</span>
<a href="#l35.226"></a><span id="l35.226" class="difflineminus">-        imts.bindNullParameter(3);</span>
<a href="#l35.227"></a><span id="l35.227" class="difflineplus">+    if (aMessage.folderID !== null) {</span>
<a href="#l35.228"></a><span id="l35.228" class="difflineplus">+      if (aMessage._isNew === true)</span>
<a href="#l35.229"></a><span id="l35.229" class="difflineplus">+        this._insertMessageText(aMessage);</span>
<a href="#l35.230"></a><span id="l35.230">       else</span>
<a href="#l35.231"></a><span id="l35.231" class="difflineminus">-        imts.bindStringParameter(3, aMessage._attachmentNames.join(&quot;\n&quot;));</span>
<a href="#l35.232"></a><span id="l35.232" class="difflineminus">-      imts.bindStringParameter(4, aMessage._indexAuthor);</span>
<a href="#l35.233"></a><span id="l35.233" class="difflineminus">-      imts.bindStringParameter(5, aMessage._indexRecipients);</span>
<a href="#l35.234"></a><span id="l35.234" class="difflineminus">-</span>
<a href="#l35.235"></a><span id="l35.235" class="difflineminus">-      try {</span>
<a href="#l35.236"></a><span id="l35.236" class="difflineminus">-         imts.executeAsync(this.trackAsync());</span>
<a href="#l35.237"></a><span id="l35.237" class="difflineminus">-      }</span>
<a href="#l35.238"></a><span id="l35.238" class="difflineminus">-      catch(ex) {</span>
<a href="#l35.239"></a><span id="l35.239" class="difflineminus">-         throw(&quot;error executing fulltext statement... &quot; +</span>
<a href="#l35.240"></a><span id="l35.240" class="difflineminus">-               this.asyncConnection.lastError + &quot;: &quot; +</span>
<a href="#l35.241"></a><span id="l35.241" class="difflineminus">-               this.asyncConnection.lastErrorString + &quot; - &quot; + ex);</span>
<a href="#l35.242"></a><span id="l35.242" class="difflineminus">-      }</span>
<a href="#l35.243"></a><span id="l35.243" class="difflineplus">+        this._updateMessageText(aMessage);</span>
<a href="#l35.244"></a><span id="l35.244">     }</span>
<a href="#l35.245"></a><span id="l35.245"> </span>
<a href="#l35.246"></a><span id="l35.246">     // In completely abstract theory, this is where we would call</span>
<a href="#l35.247"></a><span id="l35.247">     //  GlodaCollectionManager.itemsModified, except that the attributes may</span>
<a href="#l35.248"></a><span id="l35.248">     //  also have changed, so it's out of our hands.  (Gloda.grokNoun</span>
<a href="#l35.249"></a><span id="l35.249">     //  handles it.)</span>
<a href="#l35.250"></a><span id="l35.250">   },</span>
<a href="#l35.251"></a><span id="l35.251"> </span>
<a href="#l35.252"></a><span id="l35.252" class="difflineplus">+  /**</span>
<a href="#l35.253"></a><span id="l35.253" class="difflineplus">+   * Updates the full-text row associated with this message. This only performs</span>
<a href="#l35.254"></a><span id="l35.254" class="difflineplus">+   * the UPDATE query if the indexed body text has changed, which means that if</span>
<a href="#l35.255"></a><span id="l35.255" class="difflineplus">+   * the body hasn't changed but the attachments have, we don't update.</span>
<a href="#l35.256"></a><span id="l35.256" class="difflineplus">+   */</span>
<a href="#l35.257"></a><span id="l35.257" class="difflineplus">+  _updateMessageText: function gloda_ds__updateMessageText(aMessage) {</span>
<a href="#l35.258"></a><span id="l35.258" class="difflineplus">+    let newIndexedBodyText;</span>
<a href="#l35.259"></a><span id="l35.259" class="difflineplus">+    if (aMessage._content &amp;&amp; aMessage._content.hasContent())</span>
<a href="#l35.260"></a><span id="l35.260" class="difflineplus">+      newIndexedBodyText = aMessage._content.getContentString(true);</span>
<a href="#l35.261"></a><span id="l35.261" class="difflineplus">+    else if (aMessage._bodyLines)</span>
<a href="#l35.262"></a><span id="l35.262" class="difflineplus">+      newIndexedBodyText = aMessage._bodyLines.join(&quot;\n&quot;);</span>
<a href="#l35.263"></a><span id="l35.263" class="difflineplus">+    else</span>
<a href="#l35.264"></a><span id="l35.264" class="difflineplus">+      newIndexedBodyText = null;</span>
<a href="#l35.265"></a><span id="l35.265" class="difflineplus">+</span>
<a href="#l35.266"></a><span id="l35.266" class="difflineplus">+    // If the body text matches, don't perform an update</span>
<a href="#l35.267"></a><span id="l35.267" class="difflineplus">+    if (newIndexedBodyText == aMessage._indexedBodyText) {</span>
<a href="#l35.268"></a><span id="l35.268" class="difflineplus">+      this._log.debug(&quot;in _updateMessageText, skipping update because body matches&quot;);</span>
<a href="#l35.269"></a><span id="l35.269" class="difflineplus">+      return;</span>
<a href="#l35.270"></a><span id="l35.270" class="difflineplus">+    }</span>
<a href="#l35.271"></a><span id="l35.271" class="difflineplus">+</span>
<a href="#l35.272"></a><span id="l35.272" class="difflineplus">+    aMessage._indexedBodyText = newIndexedBodyText;</span>
<a href="#l35.273"></a><span id="l35.273" class="difflineplus">+</span>
<a href="#l35.274"></a><span id="l35.274" class="difflineplus">+    let umts = this._updateMessageTextStatement;</span>
<a href="#l35.275"></a><span id="l35.275" class="difflineplus">+    umts.bindInt64Parameter(2, aMessage.id);</span>
<a href="#l35.276"></a><span id="l35.276" class="difflineplus">+</span>
<a href="#l35.277"></a><span id="l35.277" class="difflineplus">+    if (aMessage._indexedBodyText == null)</span>
<a href="#l35.278"></a><span id="l35.278" class="difflineplus">+      umts.bindNullParameter(0);</span>
<a href="#l35.279"></a><span id="l35.279" class="difflineplus">+    else</span>
<a href="#l35.280"></a><span id="l35.280" class="difflineplus">+      umts.bindStringParameter(0, aMessage._indexedBodyText);</span>
<a href="#l35.281"></a><span id="l35.281" class="difflineplus">+</span>
<a href="#l35.282"></a><span id="l35.282" class="difflineplus">+    if (aMessage._attachmentNames == null)</span>
<a href="#l35.283"></a><span id="l35.283" class="difflineplus">+      umts.bindNullParameter(1);</span>
<a href="#l35.284"></a><span id="l35.284" class="difflineplus">+    else</span>
<a href="#l35.285"></a><span id="l35.285" class="difflineplus">+      umts.bindStringParameter(1, aMessage._attachmentNames.join(&quot;\n&quot;));</span>
<a href="#l35.286"></a><span id="l35.286" class="difflineplus">+</span>
<a href="#l35.287"></a><span id="l35.287" class="difflineplus">+    try {</span>
<a href="#l35.288"></a><span id="l35.288" class="difflineplus">+      umts.executeAsync(this.trackAsync());</span>
<a href="#l35.289"></a><span id="l35.289" class="difflineplus">+    }</span>
<a href="#l35.290"></a><span id="l35.290" class="difflineplus">+    catch(ex) {</span>
<a href="#l35.291"></a><span id="l35.291" class="difflineplus">+      throw(&quot;error executing fulltext statement... &quot; +</span>
<a href="#l35.292"></a><span id="l35.292" class="difflineplus">+            this.asyncConnection.lastError + &quot;: &quot; +</span>
<a href="#l35.293"></a><span id="l35.293" class="difflineplus">+            this.asyncConnection.lastErrorString + &quot; - &quot; + ex);</span>
<a href="#l35.294"></a><span id="l35.294" class="difflineplus">+    }</span>
<a href="#l35.295"></a><span id="l35.295" class="difflineplus">+  },</span>
<a href="#l35.296"></a><span id="l35.296" class="difflineplus">+</span>
<a href="#l35.297"></a><span id="l35.297">   get _updateMessageLocationStatement() {</span>
<a href="#l35.298"></a><span id="l35.298">     let statement = this._createAsyncStatement(</span>
<a href="#l35.299"></a><span id="l35.299">       &quot;UPDATE messages SET folderID = ?1, messageKey = ?2 WHERE id = ?3&quot;);</span>
<a href="#l35.300"></a><span id="l35.300">     this.__defineGetter__(&quot;_updateMessageLocationStatement&quot;,</span>
<a href="#l35.301"></a><span id="l35.301">                           function() statement);</span>
<a href="#l35.302"></a><span id="l35.302">     return this._updateMessageLocationStatement;</span>
<a href="#l35.303"></a><span id="l35.303">   },</span>
<a href="#l35.304"></a><span id="l35.304"> </span>
<a href="#l35.305"></a><span id="l35.305" class="difflineat">@@ -2207,59 +2213,16 @@ var GlodaDatastore = {</span>
<a href="#l35.306"></a><span id="l35.306">     while (this._syncStep(smidbfs)) {</span>
<a href="#l35.307"></a><span id="l35.307">       messageIDs.push(smidbfs.getInt64(0));</span>
<a href="#l35.308"></a><span id="l35.308">     }</span>
<a href="#l35.309"></a><span id="l35.309">     smidbfs.reset();</span>
<a href="#l35.310"></a><span id="l35.310"> </span>
<a href="#l35.311"></a><span id="l35.311">     return messageIDs;</span>
<a href="#l35.312"></a><span id="l35.312">   },</span>
<a href="#l35.313"></a><span id="l35.313"> </span>
<a href="#l35.314"></a><span id="l35.314" class="difflineminus">-  /**</span>
<a href="#l35.315"></a><span id="l35.315" class="difflineminus">-   * Given a list of Message-ID's, return a matching list of lists of messages</span>
<a href="#l35.316"></a><span id="l35.316" class="difflineminus">-   *  matching those Message-ID's.  So if you pass an array with three</span>
<a href="#l35.317"></a><span id="l35.317" class="difflineminus">-   *  Message-ID's [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;], you would get back an array containing</span>
<a href="#l35.318"></a><span id="l35.318" class="difflineminus">-   *  3 lists, where the first list contains all the messages with a message-id</span>
<a href="#l35.319"></a><span id="l35.319" class="difflineminus">-   *  of &quot;a&quot;, and so forth.  The reason a list is returned rather than null/a</span>
<a href="#l35.320"></a><span id="l35.320" class="difflineminus">-   *  message is that we accept the reality that we have multiple copies of</span>
<a href="#l35.321"></a><span id="l35.321" class="difflineminus">-   *  messages with the same ID.</span>
<a href="#l35.322"></a><span id="l35.322" class="difflineminus">-   * This call is asynchronous because it depends on previously created messages</span>
<a href="#l35.323"></a><span id="l35.323" class="difflineminus">-   *  to be reflected in our results, which requires us to execute on the async</span>
<a href="#l35.324"></a><span id="l35.324" class="difflineminus">-   *  thread where all our writes happen.  This also turns out to be a</span>
<a href="#l35.325"></a><span id="l35.325" class="difflineminus">-   *  reasonable thing because we could imagine pathological cases where there</span>
<a href="#l35.326"></a><span id="l35.326" class="difflineminus">-   *  could be a lot of message-id's and/or a lot of messages with those</span>
<a href="#l35.327"></a><span id="l35.327" class="difflineminus">-   *  message-id's.</span>
<a href="#l35.328"></a><span id="l35.328" class="difflineminus">-   */</span>
<a href="#l35.329"></a><span id="l35.329" class="difflineminus">-  getMessagesByMessageID: function gloda_ds_getMessagesByMessageID(aMessageIDs,</span>
<a href="#l35.330"></a><span id="l35.330" class="difflineminus">-      aCallback, aCallbackThis) {</span>
<a href="#l35.331"></a><span id="l35.331" class="difflineminus">-    let msgIDToIndex = {};</span>
<a href="#l35.332"></a><span id="l35.332" class="difflineminus">-    let results = [];</span>
<a href="#l35.333"></a><span id="l35.333" class="difflineminus">-    for (let iID = 0; iID &lt; aMessageIDs.length; ++iID) {</span>
<a href="#l35.334"></a><span id="l35.334" class="difflineminus">-      let msgID = aMessageIDs[iID];</span>
<a href="#l35.335"></a><span id="l35.335" class="difflineminus">-      results.push([]);</span>
<a href="#l35.336"></a><span id="l35.336" class="difflineminus">-      msgIDToIndex[msgID] = iID;</span>
<a href="#l35.337"></a><span id="l35.337" class="difflineminus">-    }</span>
<a href="#l35.338"></a><span id="l35.338" class="difflineminus">-</span>
<a href="#l35.339"></a><span id="l35.339" class="difflineminus">-    // Unfortunately, IN doesn't work with statement binding mechanisms, and</span>
<a href="#l35.340"></a><span id="l35.340" class="difflineminus">-    //  a chain of ORed tests really can't be bound unless we create one per</span>
<a href="#l35.341"></a><span id="l35.341" class="difflineminus">-    //  value of N (seems silly).</span>
<a href="#l35.342"></a><span id="l35.342" class="difflineminus">-    let quotedIDs = [&quot;'&quot; + msgID.replace(&quot;'&quot;, &quot;''&quot;, &quot;g&quot;) + &quot;'&quot; for each</span>
<a href="#l35.343"></a><span id="l35.343" class="difflineminus">-                     ([i, msgID] in Iterator(aMessageIDs))]</span>
<a href="#l35.344"></a><span id="l35.344" class="difflineminus">-    let sqlString = &quot;SELECT * FROM messages WHERE headerMessageID IN (&quot; +</span>
<a href="#l35.345"></a><span id="l35.345" class="difflineminus">-                    quotedIDs + &quot;)&quot;;</span>
<a href="#l35.346"></a><span id="l35.346" class="difflineminus">-</span>
<a href="#l35.347"></a><span id="l35.347" class="difflineminus">-    let nounDef = GlodaMessage.prototype.NOUN_DEF;</span>
<a href="#l35.348"></a><span id="l35.348" class="difflineminus">-    let listener = new MessagesByMessageIdCallback(msgIDToIndex, results,</span>
<a href="#l35.349"></a><span id="l35.349" class="difflineminus">-        aCallback, aCallbackThis);</span>
<a href="#l35.350"></a><span id="l35.350" class="difflineminus">-    // Use a null query because we don't want any update notifications about our</span>
<a href="#l35.351"></a><span id="l35.351" class="difflineminus">-    //  collection.  They would just confuse and anger the listener.</span>
<a href="#l35.352"></a><span id="l35.352" class="difflineminus">-    let query = new nounDef.nullQueryClass();</span>
<a href="#l35.353"></a><span id="l35.353" class="difflineminus">-    return this._queryFromSQLString(sqlString, [], nounDef,</span>
<a href="#l35.354"></a><span id="l35.354" class="difflineminus">-        query, listener);</span>
<a href="#l35.355"></a><span id="l35.355" class="difflineminus">-  },</span>
<a href="#l35.356"></a><span id="l35.356" class="difflineminus">-</span>
<a href="#l35.357"></a><span id="l35.357">   get _updateMessagesMarkDeletedByFolderID() {</span>
<a href="#l35.358"></a><span id="l35.358">     let statement = this._createAsyncStatement(</span>
<a href="#l35.359"></a><span id="l35.359">       &quot;UPDATE messages SET folderID = NULL, messageKey = NULL, \</span>
<a href="#l35.360"></a><span id="l35.360">               deleted = 1 WHERE folderID = ?1&quot;);</span>
<a href="#l35.361"></a><span id="l35.361">     this.__defineGetter__(&quot;_updateMessagesMarkDeletedByFolderID&quot;,</span>
<a href="#l35.362"></a><span id="l35.362">       function() statement);</span>
<a href="#l35.363"></a><span id="l35.363">     return this._updateMessagesMarkDeletedByFolderID;</span>
<a href="#l35.364"></a><span id="l35.364">   },</span>
<a href="#l35.365"></a><span id="l35.365" class="difflineat">@@ -2758,18 +2721,22 @@ var GlodaDatastore = {</span>
<a href="#l35.366"></a><span id="l35.366">     let unionQueries = [aQuery].concat(aQuery._unions);</span>
<a href="#l35.367"></a><span id="l35.367">     let boundArgs = [];</span>
<a href="#l35.368"></a><span id="l35.368"> </span>
<a href="#l35.369"></a><span id="l35.369">     // Use the dbQueryValidityConstraintSuffix to provide constraints that</span>
<a href="#l35.370"></a><span id="l35.370">     //  filter items down to those that are valid for the query mechanism to</span>
<a href="#l35.371"></a><span id="l35.371">     //  return.  For example, in the case of messages, deleted or ghost</span>
<a href="#l35.372"></a><span id="l35.372">     //  messages should not be returned by this query layer.  We require</span>
<a href="#l35.373"></a><span id="l35.373">     //  hand-rolled SQL to do that for now.</span>
<a href="#l35.374"></a><span id="l35.374" class="difflineminus">-    let validityConstraintSuffix  =</span>
<a href="#l35.375"></a><span id="l35.375" class="difflineminus">-      nounDef.dbQueryValidityConstraintSuffix || &quot;&quot;;</span>
<a href="#l35.376"></a><span id="l35.376" class="difflineplus">+    let validityConstraintSuffix;</span>
<a href="#l35.377"></a><span id="l35.377" class="difflineplus">+    if (nounDef.dbQueryValidityConstraintSuffix &amp;&amp;</span>
<a href="#l35.378"></a><span id="l35.378" class="difflineplus">+        !aQuery.options.noDbQueryValidityConstraints)</span>
<a href="#l35.379"></a><span id="l35.379" class="difflineplus">+      validityConstraintSuffix = nounDef.dbQueryValidityConstraintSuffix;</span>
<a href="#l35.380"></a><span id="l35.380" class="difflineplus">+    else</span>
<a href="#l35.381"></a><span id="l35.381" class="difflineplus">+      validityConstraintSuffix = &quot;&quot;;</span>
<a href="#l35.382"></a><span id="l35.382"> </span>
<a href="#l35.383"></a><span id="l35.383">     for (let iUnion = 0; iUnion &lt; unionQueries.length; iUnion++) {</span>
<a href="#l35.384"></a><span id="l35.384">       let curQuery = unionQueries[iUnion];</span>
<a href="#l35.385"></a><span id="l35.385">       let selects = [];</span>
<a href="#l35.386"></a><span id="l35.386"> </span>
<a href="#l35.387"></a><span id="l35.387">       let lastConstraintWasSpecial = false;</span>
<a href="#l35.388"></a><span id="l35.388">       let curConstraintIsSpecial;</span>
<a href="#l35.389"></a><span id="l35.389"> </span>
<a href="#l35.390"></a><span id="l35.390" class="difflineat">@@ -2907,18 +2874,24 @@ var GlodaDatastore = {</span>
<a href="#l35.391"></a><span id="l35.391">       }</span>
<a href="#l35.392"></a><span id="l35.392"> </span>
<a href="#l35.393"></a><span id="l35.393">       if (selects.length)</span>
<a href="#l35.394"></a><span id="l35.394">         whereClauses.push(&quot;id IN (&quot; + selects.join(&quot; INTERSECT &quot;) + &quot;)&quot; +</span>
<a href="#l35.395"></a><span id="l35.395">                           validityConstraintSuffix);</span>
<a href="#l35.396"></a><span id="l35.396">     }</span>
<a href="#l35.397"></a><span id="l35.397"> </span>
<a href="#l35.398"></a><span id="l35.398">     let sqlString = &quot;SELECT * FROM &quot; + nounDef.tableName;</span>
<a href="#l35.399"></a><span id="l35.399" class="difflineminus">-    if (nounDef.dbQueryJoinMagic &amp;&amp; !aQuery.options.noMagic)</span>
<a href="#l35.400"></a><span id="l35.400" class="difflineminus">-      sqlString += nounDef.dbQueryJoinMagic;</span>
<a href="#l35.401"></a><span id="l35.401" class="difflineplus">+    if (!aQuery.options.noMagic) {</span>
<a href="#l35.402"></a><span id="l35.402" class="difflineplus">+      if (aQuery.options.noDbQueryValidityConstraints &amp;&amp;</span>
<a href="#l35.403"></a><span id="l35.403" class="difflineplus">+          nounDef.dbQueryJoinMagicWithNoValidityConstraints)</span>
<a href="#l35.404"></a><span id="l35.404" class="difflineplus">+        sqlString += nounDef.dbQueryJoinMagicWithNoValidityConstraints;</span>
<a href="#l35.405"></a><span id="l35.405" class="difflineplus">+      else if (nounDef.dbQueryJoinMagic)</span>
<a href="#l35.406"></a><span id="l35.406" class="difflineplus">+        sqlString += nounDef.dbQueryJoinMagic;</span>
<a href="#l35.407"></a><span id="l35.407" class="difflineplus">+    }</span>
<a href="#l35.408"></a><span id="l35.408" class="difflineplus">+</span>
<a href="#l35.409"></a><span id="l35.409">     if (whereClauses.length)</span>
<a href="#l35.410"></a><span id="l35.410">       sqlString += &quot; WHERE (&quot; + whereClauses.join(&quot;) OR (&quot;) + &quot;)&quot;;</span>
<a href="#l35.411"></a><span id="l35.411"> </span>
<a href="#l35.412"></a><span id="l35.412">     if (aQuery.options.explicitSQL)</span>
<a href="#l35.413"></a><span id="l35.413">       sqlString = aQuery.options.explicitSQL;</span>
<a href="#l35.414"></a><span id="l35.414"> </span>
<a href="#l35.415"></a><span id="l35.415">     if (aQuery.options.outerWrapColumns)</span>
<a href="#l35.416"></a><span id="l35.416">       sqlString = &quot;SELECT *, &quot; + aQuery.options.outerWrapColumns.join(&quot;, &quot;) +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/db/gloda/modules/fundattr.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/fundattr.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -44,17 +44,17 @@ const Cu = Components.utils;</span>
<a href="#l36.4"></a><span id="l36.4"> </span>
<a href="#l36.5"></a><span id="l36.5"> Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l36.6"></a><span id="l36.6"> </span>
<a href="#l36.7"></a><span id="l36.7"> Cu.import(&quot;resource://app/modules/gloda/utils.js&quot;);</span>
<a href="#l36.8"></a><span id="l36.8"> Cu.import(&quot;resource://app/modules/gloda/gloda.js&quot;);</span>
<a href="#l36.9"></a><span id="l36.9"> Cu.import(&quot;resource://app/modules/gloda/datastore.js&quot;);</span>
<a href="#l36.10"></a><span id="l36.10"> </span>
<a href="#l36.11"></a><span id="l36.11"> Cu.import(&quot;resource://app/modules/gloda/noun_mimetype.js&quot;);</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+Cu.import(&quot;resource://app/modules/gloda/connotent.js&quot;);</span>
<a href="#l36.14"></a><span id="l36.14"> </span>
<a href="#l36.15"></a><span id="l36.15"> /**</span>
<a href="#l36.16"></a><span id="l36.16">  * @namespace The Gloda Fundamental Attribute provider is a special attribute</span>
<a href="#l36.17"></a><span id="l36.17">  *  provider; it provides attributes that the rest of the providers should be</span>
<a href="#l36.18"></a><span id="l36.18">  *  able to assume exist.  Also, it may end up accessing things at a lower level</span>
<a href="#l36.19"></a><span id="l36.19">  *  than most extension providers should do.  In summary, don't mimic this code</span>
<a href="#l36.20"></a><span id="l36.20">  *  unless you won't complain when your code breaks.</span>
<a href="#l36.21"></a><span id="l36.21">  */</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineat">@@ -95,16 +95,17 @@ var GlodaFundAttr = {</span>
<a href="#l36.23"></a><span id="l36.23">   _attrBody: null,</span>
<a href="#l36.24"></a><span id="l36.24">   _attrFrom: null,</span>
<a href="#l36.25"></a><span id="l36.25">   _attrFromMe: null,</span>
<a href="#l36.26"></a><span id="l36.26">   _attrTo: null,</span>
<a href="#l36.27"></a><span id="l36.27">   _attrToMe: null,</span>
<a href="#l36.28"></a><span id="l36.28">   _attrCc: null,</span>
<a href="#l36.29"></a><span id="l36.29">   _attrCcMe: null,</span>
<a href="#l36.30"></a><span id="l36.30">   _attrDate: null,</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineplus">+  _attrHeaderMessageID: null,</span>
<a href="#l36.32"></a><span id="l36.32"> </span>
<a href="#l36.33"></a><span id="l36.33">   defineAttributes: function() {</span>
<a href="#l36.34"></a><span id="l36.34">     /* ***** Conversations ***** */</span>
<a href="#l36.35"></a><span id="l36.35">     // conversation: subjectMatches</span>
<a href="#l36.36"></a><span id="l36.36">     this._attrConvSubject = Gloda.defineAttribute({</span>
<a href="#l36.37"></a><span id="l36.37">       provider: this,</span>
<a href="#l36.38"></a><span id="l36.38">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l36.39"></a><span id="l36.39">       attributeType: Gloda.kAttrDerived,</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineat">@@ -281,16 +282,29 @@ var GlodaFundAttr = {</span>
<a href="#l36.41"></a><span id="l36.41">                         attributeName: &quot;date&quot;,</span>
<a href="#l36.42"></a><span id="l36.42">                         singular: true,</span>
<a href="#l36.43"></a><span id="l36.43">                         special: Gloda.kSpecialColumn,</span>
<a href="#l36.44"></a><span id="l36.44">                         specialColumnName: &quot;date&quot;,</span>
<a href="#l36.45"></a><span id="l36.45">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l36.46"></a><span id="l36.46">                         objectNoun: Gloda.NOUN_DATE,</span>
<a href="#l36.47"></a><span id="l36.47">                         }); // tested-by: test_attributes_fundamental</span>
<a href="#l36.48"></a><span id="l36.48"> </span>
<a href="#l36.49"></a><span id="l36.49" class="difflineplus">+    // Header message ID.</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineplus">+    this._attrHeaderMessageID = Gloda.defineAttribute({</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineplus">+                        provider: this,</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineplus">+                        extensionName: Gloda.BUILT_IN,</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineplus">+                        attributeType: Gloda.kAttrFundamental,</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineplus">+                        attributeName: &quot;headerMessageID&quot;,</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineplus">+                        singular: true,</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineplus">+                        special: Gloda.kSpecialColumn,</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineplus">+                        specialColumnName: &quot;headerMessageID&quot;,</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineplus">+                        subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineplus">+                        objectNoun: Gloda.NOUN_STRING,</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineplus">+                        }); // tested-by: test_attributes_fundamental</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineplus">+</span>
<a href="#l36.62"></a><span id="l36.62">     // Attachment MIME Types</span>
<a href="#l36.63"></a><span id="l36.63">     this._attrAttachmentTypes = Gloda.defineAttribute({</span>
<a href="#l36.64"></a><span id="l36.64">       provider: this,</span>
<a href="#l36.65"></a><span id="l36.65">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l36.66"></a><span id="l36.66">       attributeType: Gloda.kAttrFundamental,</span>
<a href="#l36.67"></a><span id="l36.67">       attributeName: &quot;attachmentTypes&quot;,</span>
<a href="#l36.68"></a><span id="l36.68">       singular: false,</span>
<a href="#l36.69"></a><span id="l36.69">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineat">@@ -427,29 +441,31 @@ var GlodaFundAttr = {</span>
<a href="#l36.71"></a><span id="l36.71">     let authorIdentity = authorIdentities[0];</span>
<a href="#l36.72"></a><span id="l36.72">     aGlodaMessage.from = authorIdentity;</span>
<a href="#l36.73"></a><span id="l36.73"> </span>
<a href="#l36.74"></a><span id="l36.74">     // -- To, Cc</span>
<a href="#l36.75"></a><span id="l36.75">     aGlodaMessage.to = toIdentities;</span>
<a href="#l36.76"></a><span id="l36.76">     aGlodaMessage.cc = ccIdentities;</span>
<a href="#l36.77"></a><span id="l36.77"> </span>
<a href="#l36.78"></a><span id="l36.78">     // -- Attachments</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineminus">-    let attachmentTypes = [];</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineminus">-    for each (let [, attachment] in Iterator(aMimeMsg.allAttachments)) {</span>
<a href="#l36.81"></a><span id="l36.81" class="difflineminus">-      // We don't care about would-be attachments that are not user-intended</span>
<a href="#l36.82"></a><span id="l36.82" class="difflineminus">-      //  attachments but rather artifacts of the message content.</span>
<a href="#l36.83"></a><span id="l36.83" class="difflineminus">-      // We also want to avoid dealing with obviously bogus mime types.</span>
<a href="#l36.84"></a><span id="l36.84" class="difflineminus">-      //  (If you don't have a &quot;/&quot;, you are probably bogus.)</span>
<a href="#l36.85"></a><span id="l36.85" class="difflineminus">-      if (attachment.isRealAttachment &amp;&amp;</span>
<a href="#l36.86"></a><span id="l36.86" class="difflineminus">-          (attachment.contentType.indexOf(&quot;/&quot;) != -1)) {</span>
<a href="#l36.87"></a><span id="l36.87" class="difflineminus">-        attachmentTypes.push(MimeTypeNoun.getMimeType(attachment.contentType));</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineplus">+    if (aMimeMsg) {</span>
<a href="#l36.89"></a><span id="l36.89" class="difflineplus">+      let attachmentTypes = [];</span>
<a href="#l36.90"></a><span id="l36.90" class="difflineplus">+      for each (let [, attachment] in Iterator(aMimeMsg.allAttachments)) {</span>
<a href="#l36.91"></a><span id="l36.91" class="difflineplus">+        // We don't care about would-be attachments that are not user-intended</span>
<a href="#l36.92"></a><span id="l36.92" class="difflineplus">+        //  attachments but rather artifacts of the message content.</span>
<a href="#l36.93"></a><span id="l36.93" class="difflineplus">+        // We also want to avoid dealing with obviously bogus mime types.</span>
<a href="#l36.94"></a><span id="l36.94" class="difflineplus">+        //  (If you don't have a &quot;/&quot;, you are probably bogus.)</span>
<a href="#l36.95"></a><span id="l36.95" class="difflineplus">+        if (attachment.isRealAttachment &amp;&amp;</span>
<a href="#l36.96"></a><span id="l36.96" class="difflineplus">+            (attachment.contentType.indexOf(&quot;/&quot;) != -1)) {</span>
<a href="#l36.97"></a><span id="l36.97" class="difflineplus">+          attachmentTypes.push(MimeTypeNoun.getMimeType(attachment.contentType));</span>
<a href="#l36.98"></a><span id="l36.98" class="difflineplus">+        }</span>
<a href="#l36.99"></a><span id="l36.99">       }</span>
<a href="#l36.100"></a><span id="l36.100" class="difflineminus">-    }</span>
<a href="#l36.101"></a><span id="l36.101" class="difflineminus">-    if (attachmentTypes.length) {</span>
<a href="#l36.102"></a><span id="l36.102" class="difflineminus">-      aGlodaMessage.attachmentTypes = attachmentTypes;</span>
<a href="#l36.103"></a><span id="l36.103" class="difflineplus">+      if (attachmentTypes.length) {</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineplus">+        aGlodaMessage.attachmentTypes = attachmentTypes;</span>
<a href="#l36.105"></a><span id="l36.105" class="difflineplus">+      }</span>
<a href="#l36.106"></a><span id="l36.106">     }</span>
<a href="#l36.107"></a><span id="l36.107"> </span>
<a href="#l36.108"></a><span id="l36.108">     // TODO: deal with mailing lists, including implicit-to.  this will require</span>
<a href="#l36.109"></a><span id="l36.109">     //  convincing the indexer to pass us in the previous message if it is</span>
<a href="#l36.110"></a><span id="l36.110">     //  available.  (which we'll simply pass to everyone... it can help body</span>
<a href="#l36.111"></a><span id="l36.111">     //  logic for quoting purposes, etc. too.)</span>
<a href="#l36.112"></a><span id="l36.112"> </span>
<a href="#l36.113"></a><span id="l36.113">     yield Gloda.kWorkDone;</span>
<a href="#l36.114"></a><span id="l36.114" class="difflineat">@@ -560,19 +576,22 @@ var GlodaFundAttr = {</span>
<a href="#l36.115"></a><span id="l36.115">     }</span>
<a href="#l36.116"></a><span id="l36.116">     if (fromMeTo.length)</span>
<a href="#l36.117"></a><span id="l36.117">       aGlodaMessage.fromMeTo = fromMeTo;</span>
<a href="#l36.118"></a><span id="l36.118">     if (ccMe.length)</span>
<a href="#l36.119"></a><span id="l36.119">       aGlodaMessage.ccMe = ccMe;</span>
<a href="#l36.120"></a><span id="l36.120">     if (fromMeCc.length)</span>
<a href="#l36.121"></a><span id="l36.121">       aGlodaMessage.fromMeCc = fromMeCc;</span>
<a href="#l36.122"></a><span id="l36.122"> </span>
<a href="#l36.123"></a><span id="l36.123" class="difflineminus">-    if (aRawReps.bodyLines &amp;&amp;</span>
<a href="#l36.124"></a><span id="l36.124" class="difflineminus">-        this.contentWhittle({}, aRawReps.bodyLines, aRawReps.content)) {</span>
<a href="#l36.125"></a><span id="l36.125" class="difflineminus">-      // we were going to do something here?</span>
<a href="#l36.126"></a><span id="l36.126" class="difflineplus">+    // Content</span>
<a href="#l36.127"></a><span id="l36.127" class="difflineplus">+    if (aRawReps.bodyLines) {</span>
<a href="#l36.128"></a><span id="l36.128" class="difflineplus">+      aGlodaMessage._content = new GlodaContent();</span>
<a href="#l36.129"></a><span id="l36.129" class="difflineplus">+      if (this.contentWhittle({}, aRawReps.bodyLines, aGlodaMessage._content)) {</span>
<a href="#l36.130"></a><span id="l36.130" class="difflineplus">+        // we were going to do something here?</span>
<a href="#l36.131"></a><span id="l36.131" class="difflineplus">+      }</span>
<a href="#l36.132"></a><span id="l36.132">     }</span>
<a href="#l36.133"></a><span id="l36.133"> </span>
<a href="#l36.134"></a><span id="l36.134">     yield Gloda.kWorkDone;</span>
<a href="#l36.135"></a><span id="l36.135">   },</span>
<a href="#l36.136"></a><span id="l36.136"> </span>
<a href="#l36.137"></a><span id="l36.137">   /**</span>
<a href="#l36.138"></a><span id="l36.138">    * Duplicates the notability logic from optimize().  Arguably optimize should</span>
<a href="#l36.139"></a><span id="l36.139">    *  be factored to call us, grokNounItem should be factored to call us, or we</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/db/gloda/modules/gloda.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/gloda.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -49,16 +49,59 @@ Cu.import(&quot;resource://app/modules/gloda/</span>
<a href="#l37.4"></a><span id="l37.4"> Cu.import(&quot;resource://app/modules/gloda/databind.js&quot;);</span>
<a href="#l37.5"></a><span id="l37.5"> Cu.import(&quot;resource://app/modules/gloda/collection.js&quot;);</span>
<a href="#l37.6"></a><span id="l37.6"> Cu.import(&quot;resource://app/modules/gloda/connotent.js&quot;);</span>
<a href="#l37.7"></a><span id="l37.7"> Cu.import(&quot;resource://app/modules/gloda/query.js&quot;);</span>
<a href="#l37.8"></a><span id="l37.8"> Cu.import(&quot;resource://app/modules/gloda/utils.js&quot;);</span>
<a href="#l37.9"></a><span id="l37.9"> </span>
<a href="#l37.10"></a><span id="l37.10"> Cu.import(&quot;resource://app/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineplus">+let MBM_LOG = Log4Moz.repository.getLogger(&quot;gloda.NS.mbm&quot;);</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+/**</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+ * @class This callback handles processing the asynchronous query results of</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineplus">+ *  Gloda.getMessagesByMessageID.</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineplus">+ *</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineplus">+ * @param aMsgIDToIndex Map from message-id to the desired</span>
<a href="#l37.19"></a><span id="l37.19" class="difflineplus">+ *</span>
<a href="#l37.20"></a><span id="l37.20" class="difflineplus">+ * @constructor</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineplus">+ */</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineplus">+function MessagesByMessageIdCallback(aMsgIDToIndex, aResults,</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineplus">+                                     aCallback, aCallbackThis) {</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineplus">+  this.msgIDToIndex = aMsgIDToIndex;</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineplus">+  this.results = aResults;</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineplus">+  this.callback = aCallback;</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineplus">+  this.callbackThis = aCallbackThis;</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineplus">+}</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineplus">+</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineplus">+MessagesByMessageIdCallback.prototype = {</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineplus">+  onItemsAdded: function gloda_ds_mbmi_onItemsAdded(aItems, aCollection) {</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineplus">+    // just outright bail if we are shutdown</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineplus">+    if (GlodaDatastore.datastoreIsShutdown)</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineplus">+      return;</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineplus">+</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineplus">+    MBM_LOG.debug(&quot;getting results...&quot;);</span>
<a href="#l37.37"></a><span id="l37.37" class="difflineplus">+    for each (let [, message] in Iterator(aItems)) {</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineplus">+      this.results[this.msgIDToIndex[message.headerMessageID]].push(message);</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineplus">+    }</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineplus">+  },</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineplus">+  onItemsModified: function () {},</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineplus">+  onItemsRemoved: function () {},</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineplus">+  onQueryCompleted: function gloda_ds_mbmi_onQueryCompleted(aCollection) {</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineplus">+    // just outright bail if we are shutdown</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineplus">+    if (GlodaDatastore.datastoreIsShutdown)</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineplus">+      return;</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineplus">+</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineplus">+    MBM_LOG.debug(&quot;query completed, notifying... &quot; + this.results);</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineplus">+    // we no longer need to unify; it is done for us.</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineplus">+</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineplus">+    this.callback.call(this.callbackThis, this.results);</span>
<a href="#l37.52"></a><span id="l37.52" class="difflineplus">+  }</span>
<a href="#l37.53"></a><span id="l37.53" class="difflineplus">+};</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineplus">+</span>
<a href="#l37.55"></a><span id="l37.55"> /**</span>
<a href="#l37.56"></a><span id="l37.56">  * Provides the user-visible (and extension visible) global database</span>
<a href="#l37.57"></a><span id="l37.57">  *  functionality.  There is currently a dependency/ordering</span>
<a href="#l37.58"></a><span id="l37.58">  *  problem in that the concept of 'gloda' also includes some logic that is</span>
<a href="#l37.59"></a><span id="l37.59">  *  contributed by built-in extensions, if you will.  Those built-in extensions</span>
<a href="#l37.60"></a><span id="l37.60">  *  (fundattr.js, explattr.js) also import this file.  To avoid a circular</span>
<a href="#l37.61"></a><span id="l37.61">  *  dependency, those built-in extensions are loaded by everybody.js.  The</span>
<a href="#l37.62"></a><span id="l37.62">  *  simplest/best solution is probably to move everybody.js to be gloda.js and</span>
<a href="#l37.63"></a><span id="l37.63" class="difflineat">@@ -322,16 +365,55 @@ var Gloda = {</span>
<a href="#l37.64"></a><span id="l37.64">       let messageKeys = [hdr.messageKey for each (hdr in headersForFolder)];</span>
<a href="#l37.65"></a><span id="l37.65">       clause.messageKey.apply(clause, messageKeys);</span>
<a href="#l37.66"></a><span id="l37.66">     }</span>
<a href="#l37.67"></a><span id="l37.67"> </span>
<a href="#l37.68"></a><span id="l37.68">     return query.getCollection(aListener, aData);</span>
<a href="#l37.69"></a><span id="l37.69">   },</span>
<a href="#l37.70"></a><span id="l37.70"> </span>
<a href="#l37.71"></a><span id="l37.71">   /**</span>
<a href="#l37.72"></a><span id="l37.72" class="difflineplus">+   * Given a list of Message-ID's, return a matching list of lists of messages</span>
<a href="#l37.73"></a><span id="l37.73" class="difflineplus">+   *  matching those Message-ID's.  So if you pass an array with three</span>
<a href="#l37.74"></a><span id="l37.74" class="difflineplus">+   *  Message-ID's [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;], you would get back an array containing</span>
<a href="#l37.75"></a><span id="l37.75" class="difflineplus">+   *  3 lists, where the first list contains all the messages with a message-id</span>
<a href="#l37.76"></a><span id="l37.76" class="difflineplus">+   *  of &quot;a&quot;, and so forth.  The reason a list is returned rather than null/a</span>
<a href="#l37.77"></a><span id="l37.77" class="difflineplus">+   *  message is that we accept the reality that we have multiple copies of</span>
<a href="#l37.78"></a><span id="l37.78" class="difflineplus">+   *  messages with the same ID.</span>
<a href="#l37.79"></a><span id="l37.79" class="difflineplus">+   * This call is asynchronous because it depends on previously created messages</span>
<a href="#l37.80"></a><span id="l37.80" class="difflineplus">+   *  to be reflected in our results, which requires us to execute on the async</span>
<a href="#l37.81"></a><span id="l37.81" class="difflineplus">+   *  thread where all our writes happen.  This also turns out to be a</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineplus">+   *  reasonable thing because we could imagine pathological cases where there</span>
<a href="#l37.83"></a><span id="l37.83" class="difflineplus">+   *  could be a lot of message-id's and/or a lot of messages with those</span>
<a href="#l37.84"></a><span id="l37.84" class="difflineplus">+   *  message-id's.</span>
<a href="#l37.85"></a><span id="l37.85" class="difflineplus">+   */</span>
<a href="#l37.86"></a><span id="l37.86" class="difflineplus">+  getMessagesByMessageID: function gloda_ns_getMessagesByMessageID(aMessageIDs,</span>
<a href="#l37.87"></a><span id="l37.87" class="difflineplus">+      aCallback, aCallbackThis) {</span>
<a href="#l37.88"></a><span id="l37.88" class="difflineplus">+    let msgIDToIndex = {};</span>
<a href="#l37.89"></a><span id="l37.89" class="difflineplus">+    let results = [];</span>
<a href="#l37.90"></a><span id="l37.90" class="difflineplus">+    for (let iID = 0; iID &lt; aMessageIDs.length; ++iID) {</span>
<a href="#l37.91"></a><span id="l37.91" class="difflineplus">+      let msgID = aMessageIDs[iID];</span>
<a href="#l37.92"></a><span id="l37.92" class="difflineplus">+      results.push([]);</span>
<a href="#l37.93"></a><span id="l37.93" class="difflineplus">+      msgIDToIndex[msgID] = iID;</span>
<a href="#l37.94"></a><span id="l37.94" class="difflineplus">+    }</span>
<a href="#l37.95"></a><span id="l37.95" class="difflineplus">+</span>
<a href="#l37.96"></a><span id="l37.96" class="difflineplus">+    let quotedIDs = [&quot;'&quot; + msgID.replace(&quot;'&quot;, &quot;''&quot;, &quot;g&quot;) + &quot;'&quot; for each</span>
<a href="#l37.97"></a><span id="l37.97" class="difflineplus">+                      ([i, msgID] in Iterator(aMessageIDs))];</span>
<a href="#l37.98"></a><span id="l37.98" class="difflineplus">+</span>
<a href="#l37.99"></a><span id="l37.99" class="difflineplus">+    let query = Gloda.newQuery(Gloda.NOUN_MESSAGE, {</span>
<a href="#l37.100"></a><span id="l37.100" class="difflineplus">+      noDbQueryValidityConstraints: true,</span>
<a href="#l37.101"></a><span id="l37.101" class="difflineplus">+    });</span>
<a href="#l37.102"></a><span id="l37.102" class="difflineplus">+    query.headerMessageID.apply(query, quotedIDs);</span>
<a href="#l37.103"></a><span id="l37.103" class="difflineplus">+    query.frozen = true;</span>
<a href="#l37.104"></a><span id="l37.104" class="difflineplus">+</span>
<a href="#l37.105"></a><span id="l37.105" class="difflineplus">+    let listener = new MessagesByMessageIdCallback(msgIDToIndex, results,</span>
<a href="#l37.106"></a><span id="l37.106" class="difflineplus">+                                                   aCallback, aCallbackThis);</span>
<a href="#l37.107"></a><span id="l37.107" class="difflineplus">+    return query.getCollection(listener);</span>
<a href="#l37.108"></a><span id="l37.108" class="difflineplus">+  },</span>
<a href="#l37.109"></a><span id="l37.109" class="difflineplus">+</span>
<a href="#l37.110"></a><span id="l37.110" class="difflineplus">+  /**</span>
<a href="#l37.111"></a><span id="l37.111">    * @testpoint gloda.ns.getMessageContent</span>
<a href="#l37.112"></a><span id="l37.112">    */</span>
<a href="#l37.113"></a><span id="l37.113">   getMessageContent: function gloda_ns_getMessageContent(aGlodaMessage, aMimeMsg) {</span>
<a href="#l37.114"></a><span id="l37.114">     return mimeMsgToContentAndMeta(aMimeMsg, aGlodaMessage.folderMessage.folder)[0];</span>
<a href="#l37.115"></a><span id="l37.115">   },</span>
<a href="#l37.116"></a><span id="l37.116"> </span>
<a href="#l37.117"></a><span id="l37.117">   getFolderForFolder: function gloda_ns_getFolderForFolder(aMsgFolder) {</span>
<a href="#l37.118"></a><span id="l37.118">     return GlodaDatastore._mapFolder(aMsgFolder);</span>
<a href="#l37.119"></a><span id="l37.119" class="difflineat">@@ -1072,16 +1154,20 @@ var Gloda = {</span>
<a href="#l37.120"></a><span id="l37.120">       //  have the body available.  this is because we want the subject indexed.</span>
<a href="#l37.121"></a><span id="l37.121">       dbQueryJoinMagic:</span>
<a href="#l37.122"></a><span id="l37.122">         &quot; INNER JOIN messagesText ON messages.id = messagesText.rowid&quot;,</span>
<a href="#l37.123"></a><span id="l37.123">       attrTableName: &quot;messageAttributes&quot;, attrIDColumnName: &quot;messageID&quot;,</span>
<a href="#l37.124"></a><span id="l37.124">       datastore: GlodaDatastore, objFromRow: GlodaDatastore._messageFromRow,</span>
<a href="#l37.125"></a><span id="l37.125">       dbAttribAdjuster: GlodaDatastore.adjustMessageAttributes,</span>
<a href="#l37.126"></a><span id="l37.126">       dbQueryValidityConstraintSuffix:</span>
<a href="#l37.127"></a><span id="l37.127">         &quot; AND +deleted = 0 AND +folderID IS NOT NULL AND +messageKey IS NOT NULL&quot;,</span>
<a href="#l37.128"></a><span id="l37.128" class="difflineplus">+      // This is what's used when we have no validity constraints, i.e. we allow</span>
<a href="#l37.129"></a><span id="l37.129" class="difflineplus">+      // for ghost messages, which do not have a row in the messagesText table.</span>
<a href="#l37.130"></a><span id="l37.130" class="difflineplus">+      dbQueryJoinMagicWithNoValidityConstraints:</span>
<a href="#l37.131"></a><span id="l37.131" class="difflineplus">+        &quot; LEFT JOIN messagesText ON messages.id = messagesText.rowid&quot;,</span>
<a href="#l37.132"></a><span id="l37.132">       objInsert: GlodaDatastore.insertMessage,</span>
<a href="#l37.133"></a><span id="l37.133">       objUpdate: GlodaDatastore.updateMessage,</span>
<a href="#l37.134"></a><span id="l37.134">       toParamAndValue: function(aMessage) {</span>
<a href="#l37.135"></a><span id="l37.135">         if (aMessage instanceof GlodaMessage)</span>
<a href="#l37.136"></a><span id="l37.136">           return [null, aMessage.id];</span>
<a href="#l37.137"></a><span id="l37.137">         else // assume they're just passing the id directly</span>
<a href="#l37.138"></a><span id="l37.138">           return [null, aMessage];</span>
<a href="#l37.139"></a><span id="l37.139">       }}, this.NOUN_MESSAGE);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/db/gloda/modules/indexer.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/indexer.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -16,16 +16,17 @@</span>
<a href="#l38.4"></a><span id="l38.4">  * The Initial Developer of the Original Code is</span>
<a href="#l38.5"></a><span id="l38.5">  * Mozilla Messaging, Inc.</span>
<a href="#l38.6"></a><span id="l38.6">  * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l38.7"></a><span id="l38.7">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l38.8"></a><span id="l38.8">  *</span>
<a href="#l38.9"></a><span id="l38.9">  * Contributor(s):</span>
<a href="#l38.10"></a><span id="l38.10">  *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l38.11"></a><span id="l38.11">  *   Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineplus">+ *   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l38.13"></a><span id="l38.13">  *</span>
<a href="#l38.14"></a><span id="l38.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l38.15"></a><span id="l38.15">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l38.16"></a><span id="l38.16">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l38.17"></a><span id="l38.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l38.18"></a><span id="l38.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l38.19"></a><span id="l38.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l38.20"></a><span id="l38.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineat">@@ -238,17 +239,18 @@ IndexingJob.prototype = {</span>
<a href="#l38.22"></a><span id="l38.22">  *   header that indicates the message is dirty.</span>
<a href="#l38.23"></a><span id="l38.23">  * - We store a property on folders that indicate that the folder's index is</span>
<a href="#l38.24"></a><span id="l38.24">  *   up-to-date.  Absence of this property is akin to a 0=folder not up to date.</span>
<a href="#l38.25"></a><span id="l38.25">  *   There is no particular reason for the choice of using the folder's</span>
<a href="#l38.26"></a><span id="l38.26">  *   properties (via the folder cache implementation) over gloda's own folder</span>
<a href="#l38.27"></a><span id="l38.27">  *   meta-data.</span>
<a href="#l38.28"></a><span id="l38.28">  *</span>
<a href="#l38.29"></a><span id="l38.29">  * Indexing Message Control</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineminus">- * - We index IMAP messages that are offline.  We index all local messages.</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineplus">+ * - We index the headers of all IMAP messages. We index the bodies of all IMAP</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+ *   messages that are offline.  We index all local messages.</span>
<a href="#l38.33"></a><span id="l38.33">  *   We plan to avoid indexing news messages.</span>
<a href="#l38.34"></a><span id="l38.34">  * - We would like a way to express desires about indexing that either don't</span>
<a href="#l38.35"></a><span id="l38.35">  *   confound offline storage with indexing, or actually allow some choice.</span>
<a href="#l38.36"></a><span id="l38.36">  *</span>
<a href="#l38.37"></a><span id="l38.37">  * Indexing</span>
<a href="#l38.38"></a><span id="l38.38">  * - We process one folder at a time, walking the headers in the folder,</span>
<a href="#l38.39"></a><span id="l38.39">  *   indexing those which should be indexed, but which have never been indexed</span>
<a href="#l38.40"></a><span id="l38.40">  *   or are dirty.</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineat">@@ -1056,18 +1058,18 @@ var GlodaIndexer = {</span>
<a href="#l38.42"></a><span id="l38.42"> </span>
<a href="#l38.43"></a><span id="l38.43">     else {</span>
<a href="#l38.44"></a><span id="l38.44">       // We need to create search terms for messages to index. Messages should</span>
<a href="#l38.45"></a><span id="l38.45">       //  be indexed if they're indexable (local or offline and not expunged)</span>
<a href="#l38.46"></a><span id="l38.46">       //  and either haven't been indexed or are dirty.</span>
<a href="#l38.47"></a><span id="l38.47">       // The basic search expression is:</span>
<a href="#l38.48"></a><span id="l38.48">       //  ((GLODA_MESSAGE_ID_PROPERTY Is 0) || (GLODA_DIRTY_PROPERTY Isnt 0))</span>
<a href="#l38.49"></a><span id="l38.49">       // If the folder !isLocal we add the terms:</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineminus">-      //  &amp;&amp; (Status Is nsMsgMessageFlags.Offline)</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineminus">-      //  &amp;&amp; (Status Isnt nsMsgMessageFlags.Expunged)</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineplus">+      //  - if the folder is offline -- &amp;&amp; (Status Is nsMsgMessageFlags.Offline)</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineplus">+      //  - &amp;&amp; (Status Isnt nsMsgMessageFlags.Expunged)</span>
<a href="#l38.54"></a><span id="l38.54"> </span>
<a href="#l38.55"></a><span id="l38.55">       let searchSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l38.56"></a><span id="l38.56">                             .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l38.57"></a><span id="l38.57">       let searchTerms = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l38.58"></a><span id="l38.58">                          .createInstance(Ci.nsIMutableArray);</span>
<a href="#l38.59"></a><span id="l38.59">       let isLocal = this._indexingFolder instanceof Ci.nsIMsgLocalMailFolder;</span>
<a href="#l38.60"></a><span id="l38.60"> </span>
<a href="#l38.61"></a><span id="l38.61">       searchSession.addScopeTerm(Ci.nsMsgSearchScope.offlineMail,</span>
<a href="#l38.62"></a><span id="l38.62" class="difflineat">@@ -1076,17 +1078,17 @@ var GlodaIndexer = {</span>
<a href="#l38.63"></a><span id="l38.63">       let nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l38.64"></a><span id="l38.64"> </span>
<a href="#l38.65"></a><span id="l38.65">       // first term: (GLODA_MESSAGE_ID_PROPERTY Is 0</span>
<a href="#l38.66"></a><span id="l38.66">       let searchTerm = searchSession.createTerm();</span>
<a href="#l38.67"></a><span id="l38.67">       searchTerm.booleanAnd = false; // actually don't care here</span>
<a href="#l38.68"></a><span id="l38.68">       searchTerm.beginsGrouping = true;</span>
<a href="#l38.69"></a><span id="l38.69">       searchTerm.attrib = nsMsgSearchAttrib.Uint32HdrProperty;</span>
<a href="#l38.70"></a><span id="l38.70">       searchTerm.op = nsMsgSearchOp.Is;</span>
<a href="#l38.71"></a><span id="l38.71" class="difflineminus">-      value = searchTerm.value;</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineplus">+      let value = searchTerm.value;</span>
<a href="#l38.73"></a><span id="l38.73">       value.attrib = searchTerm.attrib;</span>
<a href="#l38.74"></a><span id="l38.74">       value.status = 0;</span>
<a href="#l38.75"></a><span id="l38.75">       searchTerm.value = value;</span>
<a href="#l38.76"></a><span id="l38.76">       searchTerm.hdrProperty = GLODA_MESSAGE_ID_PROPERTY;</span>
<a href="#l38.77"></a><span id="l38.77">       searchTerms.appendElement(searchTerm, false);</span>
<a href="#l38.78"></a><span id="l38.78"> </span>
<a href="#l38.79"></a><span id="l38.79">       //  second term: || GLODA_DIRTY_PROPERTY Isnt 0 )</span>
<a href="#l38.80"></a><span id="l38.80">       searchTerm = searchSession.createTerm();</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineat">@@ -1098,26 +1100,29 @@ var GlodaIndexer = {</span>
<a href="#l38.82"></a><span id="l38.82">       value.attrib = searchTerm.attrib;</span>
<a href="#l38.83"></a><span id="l38.83">       value.status = 0;</span>
<a href="#l38.84"></a><span id="l38.84">       searchTerm.value = value;</span>
<a href="#l38.85"></a><span id="l38.85">       searchTerm.hdrProperty = GLODA_DIRTY_PROPERTY;</span>
<a href="#l38.86"></a><span id="l38.86">       searchTerms.appendElement(searchTerm, false);</span>
<a href="#l38.87"></a><span id="l38.87"> </span>
<a href="#l38.88"></a><span id="l38.88">       if (!isLocal)</span>
<a href="#l38.89"></a><span id="l38.89">       {</span>
<a href="#l38.90"></a><span id="l38.90" class="difflineminus">-        //  third term: &amp;&amp; Status Is nsMsgMessageFlags.Offline</span>
<a href="#l38.91"></a><span id="l38.91" class="difflineminus">-        searchTerm = searchSession.createTerm();</span>
<a href="#l38.92"></a><span id="l38.92" class="difflineminus">-        searchTerm.booleanAnd = true;</span>
<a href="#l38.93"></a><span id="l38.93" class="difflineminus">-        searchTerm.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineminus">-        searchTerm.op = nsMsgSearchOp.Is;</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineminus">-        value = searchTerm.value;</span>
<a href="#l38.96"></a><span id="l38.96" class="difflineminus">-        value.attrib = searchTerm.attrib;</span>
<a href="#l38.97"></a><span id="l38.97" class="difflineminus">-        value.status = Ci.nsMsgMessageFlags.Offline;</span>
<a href="#l38.98"></a><span id="l38.98" class="difflineminus">-        searchTerm.value = value;</span>
<a href="#l38.99"></a><span id="l38.99" class="difflineminus">-        searchTerms.appendElement(searchTerm, false);</span>
<a href="#l38.100"></a><span id="l38.100" class="difflineplus">+        // If the folder is offline, then the message should be too</span>
<a href="#l38.101"></a><span id="l38.101" class="difflineplus">+        if (this._indexingFolder.flags &amp; Ci.nsMsgFolderFlags.Offline) {</span>
<a href="#l38.102"></a><span id="l38.102" class="difflineplus">+          // third term: &amp;&amp; Status Is nsMsgMessageFlags.Offline</span>
<a href="#l38.103"></a><span id="l38.103" class="difflineplus">+          searchTerm = searchSession.createTerm();</span>
<a href="#l38.104"></a><span id="l38.104" class="difflineplus">+          searchTerm.booleanAnd = true;</span>
<a href="#l38.105"></a><span id="l38.105" class="difflineplus">+          searchTerm.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l38.106"></a><span id="l38.106" class="difflineplus">+          searchTerm.op = nsMsgSearchOp.Is;</span>
<a href="#l38.107"></a><span id="l38.107" class="difflineplus">+          value = searchTerm.value;</span>
<a href="#l38.108"></a><span id="l38.108" class="difflineplus">+          value.attrib = searchTerm.attrib;</span>
<a href="#l38.109"></a><span id="l38.109" class="difflineplus">+          value.status = Ci.nsMsgMessageFlags.Offline;</span>
<a href="#l38.110"></a><span id="l38.110" class="difflineplus">+          searchTerm.value = value;</span>
<a href="#l38.111"></a><span id="l38.111" class="difflineplus">+          searchTerms.appendElement(searchTerm, false);</span>
<a href="#l38.112"></a><span id="l38.112" class="difflineplus">+        }</span>
<a href="#l38.113"></a><span id="l38.113"> </span>
<a href="#l38.114"></a><span id="l38.114">         // fourth term: &amp;&amp; Status Isnt nsMsgMessageFlags.Expunged</span>
<a href="#l38.115"></a><span id="l38.115">         searchTerm = searchSession.createTerm();</span>
<a href="#l38.116"></a><span id="l38.116">         searchTerm.booleanAnd = true;</span>
<a href="#l38.117"></a><span id="l38.117">         searchTerm.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l38.118"></a><span id="l38.118">         searchTerm.op = nsMsgSearchOp.Isnt;</span>
<a href="#l38.119"></a><span id="l38.119">         value = searchTerm.value;</span>
<a href="#l38.120"></a><span id="l38.120">         value.attrib = searchTerm.attrib;</span>
<a href="#l38.121"></a><span id="l38.121" class="difflineat">@@ -1647,20 +1652,20 @@ var GlodaIndexer = {</span>
<a href="#l38.122"></a><span id="l38.122">           createInstance(Ci.nsISupportsArray);</span>
<a href="#l38.123"></a><span id="l38.123">         rootFolder.ListDescendents(allFolders);</span>
<a href="#l38.124"></a><span id="l38.124">         let numFolders = allFolders.Count();</span>
<a href="#l38.125"></a><span id="l38.125">         for (let folderIndex = 0; folderIndex &lt; numFolders; folderIndex++) {</span>
<a href="#l38.126"></a><span id="l38.126">           let folder = allFolders.GetElementAt(folderIndex).QueryInterface(</span>
<a href="#l38.127"></a><span id="l38.127">             Ci.nsIMsgFolder);</span>
<a href="#l38.128"></a><span id="l38.128">           if (!this.shouldIndexFolder(folder))</span>
<a href="#l38.129"></a><span id="l38.129">             continue;</span>
<a href="#l38.130"></a><span id="l38.130" class="difflineminus">-          // we could also check nsMsgFolderFlags.Mail conceivably...</span>
<a href="#l38.131"></a><span id="l38.131" class="difflineminus">-          let isLocal = folder instanceof Ci.nsIMsgLocalMailFolder;</span>
<a href="#l38.132"></a><span id="l38.132" class="difflineminus">-          // we only index local folders or IMAP folders that are marked offline</span>
<a href="#l38.133"></a><span id="l38.133" class="difflineminus">-          if (!isLocal &amp;&amp; !(folder.flags &amp; Ci.nsMsgFolderFlags.Offline))</span>
<a href="#l38.134"></a><span id="l38.134" class="difflineplus">+</span>
<a href="#l38.135"></a><span id="l38.135" class="difflineplus">+          // we only index local or IMAP folders</span>
<a href="#l38.136"></a><span id="l38.136" class="difflineplus">+          if (!(folder instanceof Ci.nsIMsgLocalMailFolder) &amp;&amp;</span>
<a href="#l38.137"></a><span id="l38.137" class="difflineplus">+              !(folder instanceof Ci.nsIMsgImapMailFolder))</span>
<a href="#l38.138"></a><span id="l38.138">             continue;</span>
<a href="#l38.139"></a><span id="l38.139"> </span>
<a href="#l38.140"></a><span id="l38.140">           let glodaFolder = Gloda.getFolderForFolder(folder);</span>
<a href="#l38.141"></a><span id="l38.141">           if (glodaFolder.indexingPriority !=</span>
<a href="#l38.142"></a><span id="l38.142">               glodaFolder.kIndexingNeverPriority)</span>
<a href="#l38.143"></a><span id="l38.143">             foldersToProcess.push(glodaFolder);</span>
<a href="#l38.144"></a><span id="l38.144">         }</span>
<a href="#l38.145"></a><span id="l38.145">       }</span>
<a href="#l38.146"></a><span id="l38.146" class="difflineat">@@ -1729,17 +1734,16 @@ var GlodaIndexer = {</span>
<a href="#l38.147"></a><span id="l38.147"> </span>
<a href="#l38.148"></a><span id="l38.148">     // Make sure listeners get notified about this job.</span>
<a href="#l38.149"></a><span id="l38.149">     this._notifyListeners();</span>
<a href="#l38.150"></a><span id="l38.150"> </span>
<a href="#l38.151"></a><span id="l38.151">     // there is of course a cost to all this header investigation even if we</span>
<a href="#l38.152"></a><span id="l38.152">     //  don't do something.  so we will yield with kWorkSync for every block.</span>
<a href="#l38.153"></a><span id="l38.153">     const HEADER_CHECK_BLOCK_SIZE = 25;</span>
<a href="#l38.154"></a><span id="l38.154"> </span>
<a href="#l38.155"></a><span id="l38.155" class="difflineminus">-    let isLocal = this._indexingFolder instanceof Ci.nsIMsgLocalMailFolder;</span>
<a href="#l38.156"></a><span id="l38.156">     // we can safely presume if we are here that this folder has been selected</span>
<a href="#l38.157"></a><span id="l38.157">     //  for offline processing...</span>
<a href="#l38.158"></a><span id="l38.158"> </span>
<a href="#l38.159"></a><span id="l38.159">     // Handle the filthy case.  A filthy folder may have misleading properties</span>
<a href="#l38.160"></a><span id="l38.160">     //  on the message that claim the message is indexed.  They are misleading</span>
<a href="#l38.161"></a><span id="l38.161">     //  because the database, for whatever reason, does not have the messages</span>
<a href="#l38.162"></a><span id="l38.162">     //  (accurately) indexed.</span>
<a href="#l38.163"></a><span id="l38.163">     // We need to walk all the messages and mark them filthy if they have a</span>
<a href="#l38.164"></a><span id="l38.164" class="difflineat">@@ -1830,50 +1834,42 @@ var GlodaIndexer = {</span>
<a href="#l38.165"></a><span id="l38.165">   /**</span>
<a href="#l38.166"></a><span id="l38.166">    * Index a specific list of messages that we know to index from</span>
<a href="#l38.167"></a><span id="l38.167">    *  event-notification hints.</span>
<a href="#l38.168"></a><span id="l38.168">    */</span>
<a href="#l38.169"></a><span id="l38.169">   _worker_messageIndex: function gloda_worker_messageAdd(aJob) {</span>
<a href="#l38.170"></a><span id="l38.170">     // if we are already in the correct folder, our &quot;get in the folder&quot; clause</span>
<a href="#l38.171"></a><span id="l38.171">     //  will not execute, so we need to make sure this value is accurate in</span>
<a href="#l38.172"></a><span id="l38.172">     //  that case.  (and we want to avoid multiple checks...)</span>
<a href="#l38.173"></a><span id="l38.173" class="difflineminus">-    let folderIsLocal =</span>
<a href="#l38.174"></a><span id="l38.174" class="difflineminus">-      this._indexingFolder instanceof Ci.nsIMsgLocalMailFolder;</span>
<a href="#l38.175"></a><span id="l38.175">     for (; aJob.offset &lt; aJob.items.length; aJob.offset++) {</span>
<a href="#l38.176"></a><span id="l38.176">       let item = aJob.items[aJob.offset];</span>
<a href="#l38.177"></a><span id="l38.177">       // item is either [folder ID, message key] or</span>
<a href="#l38.178"></a><span id="l38.178">       //                [folder ID, message ID]</span>
<a href="#l38.179"></a><span id="l38.179"> </span>
<a href="#l38.180"></a><span id="l38.180">       // get in the folder</span>
<a href="#l38.181"></a><span id="l38.181">       if (!this._indexingGlodaFolder ||</span>
<a href="#l38.182"></a><span id="l38.182">           this._indexingGlodaFolder.id != item[0]) {</span>
<a href="#l38.183"></a><span id="l38.183">         yield this._indexerEnterFolder(item[0]);</span>
<a href="#l38.184"></a><span id="l38.184"> </span>
<a href="#l38.185"></a><span id="l38.185">         // stay out of folders we should not be in!</span>
<a href="#l38.186"></a><span id="l38.186">         if (!this.shouldIndexFolder(this._indexingFolder))</span>
<a href="#l38.187"></a><span id="l38.187">           continue;</span>
<a href="#l38.188"></a><span id="l38.188" class="difflineminus">-</span>
<a href="#l38.189"></a><span id="l38.189" class="difflineminus">-        folderIsLocal =</span>
<a href="#l38.190"></a><span id="l38.190" class="difflineminus">-          this._indexingFolder instanceof Ci.nsIMsgLocalMailFolder;</span>
<a href="#l38.191"></a><span id="l38.191">       }</span>
<a href="#l38.192"></a><span id="l38.192"> </span>
<a href="#l38.193"></a><span id="l38.193">       let msgHdr;</span>
<a href="#l38.194"></a><span id="l38.194">       if (typeof item[1] == &quot;number&quot;)</span>
<a href="#l38.195"></a><span id="l38.195">         msgHdr = this._indexingFolder.GetMessageHeader(item[1]);</span>
<a href="#l38.196"></a><span id="l38.196">       else</span>
<a href="#l38.197"></a><span id="l38.197">         // same deal as in move processing.</span>
<a href="#l38.198"></a><span id="l38.198">         // TODO fixme to not assume singular message-id's.</span>
<a href="#l38.199"></a><span id="l38.199">         msgHdr = this._indexingDatabase.getMsgHdrForMessageID(item[1]);</span>
<a href="#l38.200"></a><span id="l38.200"> </span>
<a href="#l38.201"></a><span id="l38.201" class="difflineminus">-      // it needs a header, the header needs to not be expunged, plus, the</span>
<a href="#l38.202"></a><span id="l38.202" class="difflineminus">-      //  message needs to be considered offline.</span>
<a href="#l38.203"></a><span id="l38.203" class="difflineplus">+      // it needs a header, and the header needs to not be expunged.</span>
<a href="#l38.204"></a><span id="l38.204">       if (msgHdr &amp;&amp;</span>
<a href="#l38.205"></a><span id="l38.205" class="difflineminus">-          !(msgHdr.flags &amp; Components.interfaces.nsMsgMessageFlags.Expunged) &amp;&amp;</span>
<a href="#l38.206"></a><span id="l38.206" class="difflineminus">-          (folderIsLocal ||</span>
<a href="#l38.207"></a><span id="l38.207" class="difflineminus">-           (msgHdr.flags &amp; Components.interfaces.nsMsgMessageFlags.Offline)))</span>
<a href="#l38.208"></a><span id="l38.208" class="difflineplus">+          !(msgHdr.flags &amp; Components.interfaces.nsMsgMessageFlags.Expunged))</span>
<a href="#l38.209"></a><span id="l38.209">         yield this._callbackHandle.pushAndGo(this._indexMessage(msgHdr,</span>
<a href="#l38.210"></a><span id="l38.210">             this._callbackHandle));</span>
<a href="#l38.211"></a><span id="l38.211">       else</span>
<a href="#l38.212"></a><span id="l38.212">         yield this.kWorkSync;</span>
<a href="#l38.213"></a><span id="l38.213">     }</span>
<a href="#l38.214"></a><span id="l38.214">     yield this.kWorkDone;</span>
<a href="#l38.215"></a><span id="l38.215">   },</span>
<a href="#l38.216"></a><span id="l38.216"> </span>
<a href="#l38.217"></a><span id="l38.217" class="difflineat">@@ -2064,19 +2060,26 @@ var GlodaIndexer = {</span>
<a href="#l38.218"></a><span id="l38.218">      *  is conceivable we will see a number of these events in fairly rapid</span>
<a href="#l38.219"></a><span id="l38.219">      *  succession.)</span>
<a href="#l38.220"></a><span id="l38.220">      */</span>
<a href="#l38.221"></a><span id="l38.221">     msgAdded: function gloda_indexer_msgAdded(aMsgHdr) {</span>
<a href="#l38.222"></a><span id="l38.222">       // make sure the message is eligible for indexing...</span>
<a href="#l38.223"></a><span id="l38.223">       let msgFolder = aMsgHdr.folder;</span>
<a href="#l38.224"></a><span id="l38.224">       if (!this.indexer.shouldIndexFolder(msgFolder))</span>
<a href="#l38.225"></a><span id="l38.225">         return;</span>
<a href="#l38.226"></a><span id="l38.226" class="difflineplus">+</span>
<a href="#l38.227"></a><span id="l38.227" class="difflineplus">+      // Make sure the message is eligible for indexing.</span>
<a href="#l38.228"></a><span id="l38.228" class="difflineplus">+      // We index local messages, IMAP messages that are offline, and IMAP</span>
<a href="#l38.229"></a><span id="l38.229" class="difflineplus">+      // messages that aren't offline but whose folders aren't offline either</span>
<a href="#l38.230"></a><span id="l38.230">       let isFolderLocal = msgFolder instanceof Ci.nsIMsgLocalMailFolder;</span>
<a href="#l38.231"></a><span id="l38.231" class="difflineminus">-      if (!isFolderLocal &amp;&amp; !(msgFolder.flags&amp;Ci.nsMsgFolderFlags.Offline))</span>
<a href="#l38.232"></a><span id="l38.232" class="difflineminus">-        return;</span>
<a href="#l38.233"></a><span id="l38.233" class="difflineplus">+      if (!isFolderLocal) {</span>
<a href="#l38.234"></a><span id="l38.234" class="difflineplus">+        if (!(aMsgHdr.flags &amp; Ci.nsMsgMessageFlags.Offline) &amp;&amp;</span>
<a href="#l38.235"></a><span id="l38.235" class="difflineplus">+            (msgFolder.flags &amp; Ci.nsMsgFolderFlags.Offline))</span>
<a href="#l38.236"></a><span id="l38.236" class="difflineplus">+          return;</span>
<a href="#l38.237"></a><span id="l38.237" class="difflineplus">+      }</span>
<a href="#l38.238"></a><span id="l38.238"> </span>
<a href="#l38.239"></a><span id="l38.239">       // mark the folder dirty so we know to look in it, but there is no need</span>
<a href="#l38.240"></a><span id="l38.240">       //  to mark the message because it will lack a gloda-id anyways.</span>
<a href="#l38.241"></a><span id="l38.241">       let glodaFolder = GlodaDatastore._mapFolder(msgFolder);</span>
<a href="#l38.242"></a><span id="l38.242">       glodaFolder.dirtyStatus = true;</span>
<a href="#l38.243"></a><span id="l38.243"> </span>
<a href="#l38.244"></a><span id="l38.244">       if (this.indexer._pendingAddJob === null) {</span>
<a href="#l38.245"></a><span id="l38.245">         this.indexer._pendingAddJob = new IndexingJob(&quot;message&quot;, 1, null);</span>
<a href="#l38.246"></a><span id="l38.246" class="difflineat">@@ -2374,19 +2377,26 @@ var GlodaIndexer = {</span>
<a href="#l38.247"></a><span id="l38.247">      *  the indexer will cleanly map this to the existing gloda message.</span>
<a href="#l38.248"></a><span id="l38.248">      */</span>
<a href="#l38.249"></a><span id="l38.249">     _reindexChangedMessage: function gloda_indexer_reindexChangedMessage(</span>
<a href="#l38.250"></a><span id="l38.250">         aMsgHdr) {</span>
<a href="#l38.251"></a><span id="l38.251">       // make sure the message is eligible for indexing...</span>
<a href="#l38.252"></a><span id="l38.252">       let msgFolder = aMsgHdr.folder;</span>
<a href="#l38.253"></a><span id="l38.253">       if (!this.indexer.shouldIndexFolder(msgFolder))</span>
<a href="#l38.254"></a><span id="l38.254">         return;</span>
<a href="#l38.255"></a><span id="l38.255" class="difflineplus">+</span>
<a href="#l38.256"></a><span id="l38.256" class="difflineplus">+      // Make sure the message is eligible for indexing.</span>
<a href="#l38.257"></a><span id="l38.257" class="difflineplus">+      // We index local messages, IMAP messages that are offline, and IMAP</span>
<a href="#l38.258"></a><span id="l38.258" class="difflineplus">+      // messages that aren't offline but whose folders aren't offline either</span>
<a href="#l38.259"></a><span id="l38.259">       let isFolderLocal = msgFolder instanceof Ci.nsIMsgLocalMailFolder;</span>
<a href="#l38.260"></a><span id="l38.260" class="difflineminus">-      if (!isFolderLocal &amp;&amp; !(msgFolder.flags&amp;Ci.nsMsgFolderFlags.Offline))</span>
<a href="#l38.261"></a><span id="l38.261" class="difflineminus">-        return;</span>
<a href="#l38.262"></a><span id="l38.262" class="difflineplus">+      if (!isFolderLocal) {</span>
<a href="#l38.263"></a><span id="l38.263" class="difflineplus">+        if (!(aMsgHdr.flags &amp; Ci.nsMsgMessageFlags.Offline) &amp;&amp;</span>
<a href="#l38.264"></a><span id="l38.264" class="difflineplus">+            (msgFolder.flags &amp; Ci.nsMsgFolderFlags.Offline))</span>
<a href="#l38.265"></a><span id="l38.265" class="difflineplus">+          return;</span>
<a href="#l38.266"></a><span id="l38.266" class="difflineplus">+      }</span>
<a href="#l38.267"></a><span id="l38.267"> </span>
<a href="#l38.268"></a><span id="l38.268">       // mark the message as dirty</span>
<a href="#l38.269"></a><span id="l38.269">       // (We could check for the presence of the gloda message id property</span>
<a href="#l38.270"></a><span id="l38.270">       //  first to know whether we technically need the dirty property.  I'm</span>
<a href="#l38.271"></a><span id="l38.271">       //  not sure whether it is worth the high-probability exception cost.)</span>
<a href="#l38.272"></a><span id="l38.272">       aMsgHdr.setUint32Property(GLODA_DIRTY_PROPERTY, 1);</span>
<a href="#l38.273"></a><span id="l38.273">       // mark the folder dirty too, so we know to look inside</span>
<a href="#l38.274"></a><span id="l38.274">       let glodaFolder = GlodaDatastore._mapFolder(msgFolder);</span>
<a href="#l38.275"></a><span id="l38.275" class="difflineat">@@ -2394,23 +2404,25 @@ var GlodaIndexer = {</span>
<a href="#l38.276"></a><span id="l38.276"> </span>
<a href="#l38.277"></a><span id="l38.277">       if (this.indexer._pendingAddJob === null) {</span>
<a href="#l38.278"></a><span id="l38.278">         this.indexer._pendingAddJob = new IndexingJob(&quot;message&quot;, 1, null);</span>
<a href="#l38.279"></a><span id="l38.279">         this.indexer._indexQueue.push(this.indexer._pendingAddJob);</span>
<a href="#l38.280"></a><span id="l38.280">         this.indexer._indexingJobGoal++;</span>
<a href="#l38.281"></a><span id="l38.281">       }</span>
<a href="#l38.282"></a><span id="l38.282">       // only queue the message if we haven't overflowed our event-driven budget</span>
<a href="#l38.283"></a><span id="l38.283">       if (this.indexer._pendingAddJob.items.length &lt;</span>
<a href="#l38.284"></a><span id="l38.284" class="difflineminus">-          this.indexer._indexMaxEventQueueMessages)</span>
<a href="#l38.285"></a><span id="l38.285" class="difflineplus">+          this.indexer._indexMaxEventQueueMessages) {</span>
<a href="#l38.286"></a><span id="l38.286">         this.indexer._pendingAddJob.items.push(</span>
<a href="#l38.287"></a><span id="l38.287">           [GlodaDatastore._mapFolder(msgFolder).id,</span>
<a href="#l38.288"></a><span id="l38.288">            aMsgHdr.messageKey]);</span>
<a href="#l38.289"></a><span id="l38.289" class="difflineminus">-      else</span>
<a href="#l38.290"></a><span id="l38.290" class="difflineplus">+        this.indexer.indexing = true;</span>
<a href="#l38.291"></a><span id="l38.291" class="difflineplus">+      }</span>
<a href="#l38.292"></a><span id="l38.292" class="difflineplus">+      else {</span>
<a href="#l38.293"></a><span id="l38.293">         this.indexer.indexingSweepNeeded = true;</span>
<a href="#l38.294"></a><span id="l38.294" class="difflineminus">-      this.indexer.indexing = true;</span>
<a href="#l38.295"></a><span id="l38.295" class="difflineplus">+      }</span>
<a href="#l38.296"></a><span id="l38.296">     },</span>
<a href="#l38.297"></a><span id="l38.297"> </span>
<a href="#l38.298"></a><span id="l38.298">     OnItemAdded: function gloda_indexer_OnItemAdded(aParentItem, aItem) {</span>
<a href="#l38.299"></a><span id="l38.299">     },</span>
<a href="#l38.300"></a><span id="l38.300">     OnItemRemoved: function gloda_indexer_OnItemRemoved(aParentItem, aItem) {</span>
<a href="#l38.301"></a><span id="l38.301">     },</span>
<a href="#l38.302"></a><span id="l38.302">     OnItemPropertyChanged: function gloda_indexer_OnItemPropertyChanged(</span>
<a href="#l38.303"></a><span id="l38.303">                              aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l38.304"></a><span id="l38.304" class="difflineat">@@ -2480,23 +2492,37 @@ var GlodaIndexer = {</span>
<a href="#l38.305"></a><span id="l38.305">     onJunkScoreChanged: function(aInstigator) {},</span>
<a href="#l38.306"></a><span id="l38.306">     onHdrPropertyChanged: function (aHdrToChange, aPreChange, aStatus,</span>
<a href="#l38.307"></a><span id="l38.307">                                     aInstigator) {},</span>
<a href="#l38.308"></a><span id="l38.308">     onEvent: function (aDB, aEvent) {},</span>
<a href="#l38.309"></a><span id="l38.309">   },</span>
<a href="#l38.310"></a><span id="l38.310"> </span>
<a href="#l38.311"></a><span id="l38.311">   _indexMessage: function gloda_indexMessage(aMsgHdr, aCallbackHandle) {</span>
<a href="#l38.312"></a><span id="l38.312">     let logDebug = this._log.level &lt;= Log4Moz.Level.Debug;</span>
<a href="#l38.313"></a><span id="l38.313" class="difflineminus">-</span>
<a href="#l38.314"></a><span id="l38.314">     if (logDebug)</span>
<a href="#l38.315"></a><span id="l38.315">       this._log.debug(&quot;*** Indexing message: &quot; + aMsgHdr.messageKey + &quot; : &quot; +</span>
<a href="#l38.316"></a><span id="l38.316">                       aMsgHdr.subject);</span>
<a href="#l38.317"></a><span id="l38.317" class="difflineminus">-    MsgHdrToMimeMessage(aMsgHdr, aCallbackHandle.callbackThis,</span>
<a href="#l38.318"></a><span id="l38.318" class="difflineminus">-        aCallbackHandle.callback);</span>
<a href="#l38.319"></a><span id="l38.319" class="difflineminus">-    let [,aMimeMsg] = yield this.kWorkAsync;</span>
<a href="#l38.320"></a><span id="l38.320" class="difflineplus">+</span>
<a href="#l38.321"></a><span id="l38.321" class="difflineplus">+    // If the message is offline, then get the message body as well</span>
<a href="#l38.322"></a><span id="l38.322" class="difflineplus">+    let isMsgOffline = false;</span>
<a href="#l38.323"></a><span id="l38.323" class="difflineplus">+    let aMimeMsg;</span>
<a href="#l38.324"></a><span id="l38.324" class="difflineplus">+    if ((aMsgHdr.flags &amp; Ci.nsMsgMessageFlags.Offline) ||</span>
<a href="#l38.325"></a><span id="l38.325" class="difflineplus">+        (aMsgHdr.folder instanceof Ci.nsIMsgLocalMailFolder)) {</span>
<a href="#l38.326"></a><span id="l38.326" class="difflineplus">+      isMsgOffline = true;</span>
<a href="#l38.327"></a><span id="l38.327" class="difflineplus">+      MsgHdrToMimeMessage(aMsgHdr, aCallbackHandle.callbackThis,</span>
<a href="#l38.328"></a><span id="l38.328" class="difflineplus">+          aCallbackHandle.callback);</span>
<a href="#l38.329"></a><span id="l38.329" class="difflineplus">+      [,aMimeMsg] = yield this.kWorkAsync;</span>
<a href="#l38.330"></a><span id="l38.330" class="difflineplus">+    }</span>
<a href="#l38.331"></a><span id="l38.331" class="difflineplus">+    else {</span>
<a href="#l38.332"></a><span id="l38.332" class="difflineplus">+      if (logDebug)</span>
<a href="#l38.333"></a><span id="l38.333" class="difflineplus">+        this._log.debug(&quot;  * Message is not offline -- only headers indexed&quot;);</span>
<a href="#l38.334"></a><span id="l38.334" class="difflineplus">+    }</span>
<a href="#l38.335"></a><span id="l38.335" class="difflineplus">+</span>
<a href="#l38.336"></a><span id="l38.336" class="difflineplus">+    if (logDebug)</span>
<a href="#l38.337"></a><span id="l38.337" class="difflineplus">+      this._log.debug(&quot;  * Got message, subject &quot; + aMsgHdr.subject);</span>
<a href="#l38.338"></a><span id="l38.338"> </span>
<a href="#l38.339"></a><span id="l38.339">     if (this._unitTestSuperVerbose) {</span>
<a href="#l38.340"></a><span id="l38.340">       if (aMimeMsg)</span>
<a href="#l38.341"></a><span id="l38.341">         this._log.debug(&quot;  * Got Mime &quot; + aMimeMsg.prettyString());</span>
<a href="#l38.342"></a><span id="l38.342">       else</span>
<a href="#l38.343"></a><span id="l38.343">         this._log.debug(&quot;  * NO MIME MESSAGE!!!\n&quot;);</span>
<a href="#l38.344"></a><span id="l38.344">     }</span>
<a href="#l38.345"></a><span id="l38.345"> </span>
<a href="#l38.346"></a><span id="l38.346" class="difflineat">@@ -2506,18 +2532,18 @@ var GlodaIndexer = {</span>
<a href="#l38.347"></a><span id="l38.347"> </span>
<a href="#l38.348"></a><span id="l38.348">     // - See if any of the ancestors exist and have a conversationID...</span>
<a href="#l38.349"></a><span id="l38.349">     // (references are ordered from old [0] to new [n-1])</span>
<a href="#l38.350"></a><span id="l38.350">     let references = [aMsgHdr.getStringReference(i) for each</span>
<a href="#l38.351"></a><span id="l38.351">                       (i in range(0, aMsgHdr.numReferences))];</span>
<a href="#l38.352"></a><span id="l38.352">     // also see if we already know about the message...</span>
<a href="#l38.353"></a><span id="l38.353">     references.push(aMsgHdr.messageId);</span>
<a href="#l38.354"></a><span id="l38.354"> </span>
<a href="#l38.355"></a><span id="l38.355" class="difflineminus">-    this._datastore.getMessagesByMessageID(references, aCallbackHandle.callback,</span>
<a href="#l38.356"></a><span id="l38.356" class="difflineminus">-      aCallbackHandle.callbackThis);</span>
<a href="#l38.357"></a><span id="l38.357" class="difflineplus">+    Gloda.getMessagesByMessageID(references, aCallbackHandle.callback,</span>
<a href="#l38.358"></a><span id="l38.358" class="difflineplus">+                                 aCallbackHandle.callbackThis);</span>
<a href="#l38.359"></a><span id="l38.359">     // (ancestorLists has a direct correspondence to the message ids)</span>
<a href="#l38.360"></a><span id="l38.360">     let ancestorLists = yield this.kWorkAsync;</span>
<a href="#l38.361"></a><span id="l38.361"> </span>
<a href="#l38.362"></a><span id="l38.362">     if (logDebug) {</span>
<a href="#l38.363"></a><span id="l38.363">       this._log.debug(&quot;ancestors raw: &quot; + ancestorLists);</span>
<a href="#l38.364"></a><span id="l38.364">       this._log.debug(&quot;ref len: &quot; + references.length + &quot; anc len: &quot; + ancestorLists.length);</span>
<a href="#l38.365"></a><span id="l38.365">       this._log.debug(&quot;references: &quot; + Log4Moz.enumerateProperties(references).join(&quot;,&quot;));</span>
<a href="#l38.366"></a><span id="l38.366">       this._log.debug(&quot;ancestors: &quot; + Log4Moz.enumerateProperties(ancestorLists).join(&quot;,&quot;));</span>
<a href="#l38.367"></a><span id="l38.367" class="difflineat">@@ -2663,38 +2689,38 @@ var GlodaIndexer = {</span>
<a href="#l38.368"></a><span id="l38.368">       //  associated with the id is still exactly the same.  It is conceivable</span>
<a href="#l38.369"></a><span id="l38.369">       //  that there are cases where this is not true.</span>
<a href="#l38.370"></a><span id="l38.370">     }</span>
<a href="#l38.371"></a><span id="l38.371"> </span>
<a href="#l38.372"></a><span id="l38.372">     if (aMimeMsg) {</span>
<a href="#l38.373"></a><span id="l38.373">       let bodyPlain = aMimeMsg.coerceBodyToPlaintext(aMsgHdr.folder);</span>
<a href="#l38.374"></a><span id="l38.374">       if (bodyPlain) {</span>
<a href="#l38.375"></a><span id="l38.375">         curMsg._bodyLines = bodyPlain.split(/\r?\n/);</span>
<a href="#l38.376"></a><span id="l38.376" class="difflineminus">-        curMsg._content = new GlodaContent();</span>
<a href="#l38.377"></a><span id="l38.377" class="difflineplus">+        // curMsg._content gets set by fundattr.js</span>
<a href="#l38.378"></a><span id="l38.378">       }</span>
<a href="#l38.379"></a><span id="l38.379">     }</span>
<a href="#l38.380"></a><span id="l38.380"> </span>
<a href="#l38.381"></a><span id="l38.381">     if (isConceptuallyNew) {</span>
<a href="#l38.382"></a><span id="l38.382">       curMsg._isNew = true;</span>
<a href="#l38.383"></a><span id="l38.383">       // curMsg._indexedBodyText is set by GlodaDatastore.insertMessage or</span>
<a href="#l38.384"></a><span id="l38.384">       //  GlodaDatastore.updateMessage</span>
<a href="#l38.385"></a><span id="l38.385" class="difflineminus">-      curMsg._subject = aMsgHdr.mime2DecodedSubject;</span>
<a href="#l38.386"></a><span id="l38.386" class="difflineminus">-      curMsg._attachmentNames = attachmentNames;</span>
<a href="#l38.387"></a><span id="l38.387" class="difflineplus">+    }</span>
<a href="#l38.388"></a><span id="l38.388"> </span>
<a href="#l38.389"></a><span id="l38.389" class="difflineminus">-      // curMsg._indexAuthor gets set by fundattr.js</span>
<a href="#l38.390"></a><span id="l38.390" class="difflineminus">-      // curMsg._indexRecipients gets set by fundattr.js</span>
<a href="#l38.391"></a><span id="l38.391" class="difflineminus">-    }</span>
<a href="#l38.392"></a><span id="l38.392" class="difflineplus">+    curMsg._subject = aMsgHdr.mime2DecodedSubject;</span>
<a href="#l38.393"></a><span id="l38.393" class="difflineplus">+    curMsg._attachmentNames = attachmentNames;</span>
<a href="#l38.394"></a><span id="l38.394" class="difflineplus">+</span>
<a href="#l38.395"></a><span id="l38.395" class="difflineplus">+    // curMsg._indexAuthor gets set by fundattr.js</span>
<a href="#l38.396"></a><span id="l38.396" class="difflineplus">+    // curMsg._indexRecipients gets set by fundattr.js</span>
<a href="#l38.397"></a><span id="l38.397"> </span>
<a href="#l38.398"></a><span id="l38.398">     // zero the notability so everything in grokNounItem can just increment</span>
<a href="#l38.399"></a><span id="l38.399">     curMsg.notability = 0;</span>
<a href="#l38.400"></a><span id="l38.400"> </span>
<a href="#l38.401"></a><span id="l38.401">     yield aCallbackHandle.pushAndGo(</span>
<a href="#l38.402"></a><span id="l38.402">         Gloda.grokNounItem(curMsg,</span>
<a href="#l38.403"></a><span id="l38.403" class="difflineminus">-            {header: aMsgHdr, mime: aMimeMsg,</span>
<a href="#l38.404"></a><span id="l38.404" class="difflineminus">-             bodyLines: curMsg._bodyLines, content: curMsg._content},</span>
<a href="#l38.405"></a><span id="l38.405" class="difflineplus">+            {header: aMsgHdr, mime: aMimeMsg, bodyLines: curMsg._bodyLines},</span>
<a href="#l38.406"></a><span id="l38.406">             isConceptuallyNew, isRecordNew,</span>
<a href="#l38.407"></a><span id="l38.407">             aCallbackHandle));</span>
<a href="#l38.408"></a><span id="l38.408"> </span>
<a href="#l38.409"></a><span id="l38.409">     delete curMsg._bodyLines;</span>
<a href="#l38.410"></a><span id="l38.410">     delete curMsg._content;</span>
<a href="#l38.411"></a><span id="l38.411">     delete curMsg._isNew;</span>
<a href="#l38.412"></a><span id="l38.412">     delete curMsg._indexAuthor;</span>
<a href="#l38.413"></a><span id="l38.413">     delete curMsg._indexRecipients;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/db/gloda/modules/query.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/query.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -68,16 +68,19 @@ Cu.import(&quot;resource://app/modules/gloda/</span>
<a href="#l39.4"></a><span id="l39.4">  *     - outerWrapColumns: If provided, wraps the query in a &quot;SELECT *,blah</span>
<a href="#l39.5"></a><span id="l39.5">  *           FROM (actual query)&quot; where blah is your list of outerWrapColumns</span>
<a href="#l39.6"></a><span id="l39.6">  *           made comma-delimited.  The idea is that this allows you to</span>
<a href="#l39.7"></a><span id="l39.7">  *           reference the result of expressions inside the query using their</span>
<a href="#l39.8"></a><span id="l39.8">  *           names rather than having to duplicate the logic.  In practice,</span>
<a href="#l39.9"></a><span id="l39.9">  *           this makes things more readable but is unlikely to improve</span>
<a href="#l39.10"></a><span id="l39.10">  *           performance.  (Namely, my use of 'offsets' for full-text stuff</span>
<a href="#l39.11"></a><span id="l39.11">  *           ends up in the EXPLAIN plan twice despite this.)</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineplus">+ *     - noDbQueryValidityConstraints: Indicates that any validity constraints</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+ *           should be ignored. This should be used when you need to get every</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+ *           match regardless of whether it's valid.</span>
<a href="#l39.15"></a><span id="l39.15">  *</span>
<a href="#l39.16"></a><span id="l39.16">  * @property _owner The query instance that holds the list of unions...</span>
<a href="#l39.17"></a><span id="l39.17">  * @property _constraints A list of (lists of OR constraints) that are ANDed</span>
<a href="#l39.18"></a><span id="l39.18">  *     together.  For example [[FROM bob, FROM jim], [DATE last week]] would</span>
<a href="#l39.19"></a><span id="l39.19">  *     be requesting us to find all the messages from either bob or jim, and</span>
<a href="#l39.20"></a><span id="l39.20">  *     sent in the last week.</span>
<a href="#l39.21"></a><span id="l39.21">  * @property _unions A list of other queries whose results are unioned with our</span>
<a href="#l39.22"></a><span id="l39.22">  *     own.  There is no concept of nesting or sub-queries apart from this</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/resources/glodaTestHelper.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/resources/glodaTestHelper.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -15,33 +15,35 @@</span>
<a href="#l40.4"></a><span id="l40.4">  *</span>
<a href="#l40.5"></a><span id="l40.5">  * The Initial Developer of the Original Code is</span>
<a href="#l40.6"></a><span id="l40.6">  * Mozilla Messaging, Inc.</span>
<a href="#l40.7"></a><span id="l40.7">  * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l40.8"></a><span id="l40.8">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l40.9"></a><span id="l40.9">  *</span>
<a href="#l40.10"></a><span id="l40.10">  * Contributor(s):</span>
<a href="#l40.11"></a><span id="l40.11">  *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineplus">+ *   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l40.13"></a><span id="l40.13">  *</span>
<a href="#l40.14"></a><span id="l40.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l40.15"></a><span id="l40.15">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l40.16"></a><span id="l40.16">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l40.17"></a><span id="l40.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l40.18"></a><span id="l40.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l40.19"></a><span id="l40.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l40.20"></a><span id="l40.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l40.21"></a><span id="l40.21">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l40.22"></a><span id="l40.22">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l40.23"></a><span id="l40.23">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l40.24"></a><span id="l40.24">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l40.25"></a><span id="l40.25">  *</span>
<a href="#l40.26"></a><span id="l40.26">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l40.27"></a><span id="l40.27"> </span>
<a href="#l40.28"></a><span id="l40.28" class="difflineminus">-// -- Pull in the POP3 fake-server / local account helper code</span>
<a href="#l40.29"></a><span id="l40.29" class="difflineminus">-load(&quot;../../test_mailnewslocal/unit/head_maillocal.js&quot;);</span>
<a href="#l40.30"></a><span id="l40.30" class="difflineplus">+// Import the main scripts that mailnews tests need to set up and tear down</span>
<a href="#l40.31"></a><span id="l40.31" class="difflineplus">+load(&quot;../../mailnews/resources/mailDirService.js&quot;);</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineplus">+load(&quot;../../mailnews/resources/mailTestUtils.js&quot;);</span>
<a href="#l40.33"></a><span id="l40.33"> </span>
<a href="#l40.34"></a><span id="l40.34"> /**</span>
<a href="#l40.35"></a><span id="l40.35">  * Create a 'me' identity of &quot;me@localhost&quot; for the benefit of Gloda.  At the</span>
<a href="#l40.36"></a><span id="l40.36">  *  time of this writing, Gloda only initializes Gloda.myIdentities and</span>
<a href="#l40.37"></a><span id="l40.37">  *  Gloda.myContact at startup with no event-driven updates.  As such, this</span>
<a href="#l40.38"></a><span id="l40.38">  *  function needs to be called prior to gloda startup.</span>
<a href="#l40.39"></a><span id="l40.39">  */</span>
<a href="#l40.40"></a><span id="l40.40"> function createMeIdentity() {</span>
<a href="#l40.41"></a><span id="l40.41" class="difflineat">@@ -212,27 +214,54 @@ function getObjectTree(o, recurse, compr</span>
<a href="#l40.42"></a><span id="l40.42">  *     never really needed it anyways.  I just didn't know about the local</span>
<a href="#l40.43"></a><span id="l40.43">  *     folder addMessage method.  (so sad!)</span>
<a href="#l40.44"></a><span id="l40.44">  */</span>
<a href="#l40.45"></a><span id="l40.45"> const INJECT_FAKE_SERVER = 1;</span>
<a href="#l40.46"></a><span id="l40.46"> /** Inject messages using freshly created mboxes. */</span>
<a href="#l40.47"></a><span id="l40.47"> const INJECT_MBOX = 2;</span>
<a href="#l40.48"></a><span id="l40.48"> /** Inject messages using addMessage. */</span>
<a href="#l40.49"></a><span id="l40.49"> const INJECT_ADDMESSAGE = 3;</span>
<a href="#l40.50"></a><span id="l40.50" class="difflineplus">+/** Inject messages using the IMAP fakeserver. */</span>
<a href="#l40.51"></a><span id="l40.51" class="difflineplus">+const INJECT_IMAP_FAKE_SERVER = 4;</span>
<a href="#l40.52"></a><span id="l40.52"> </span>
<a href="#l40.53"></a><span id="l40.53"> /**</span>
<a href="#l40.54"></a><span id="l40.54">  * Convert a list of synthetic messages to a form appropriate to feed to the</span>
<a href="#l40.55"></a><span id="l40.55">  *  POP3 fakeserver.</span>
<a href="#l40.56"></a><span id="l40.56">  */</span>
<a href="#l40.57"></a><span id="l40.57"> function _synthMessagesToFakeRep(aSynthMessages) {</span>
<a href="#l40.58"></a><span id="l40.58">   return [{fileData: msg.toMessageString(), size: -1} for each</span>
<a href="#l40.59"></a><span id="l40.59">           (msg in aSynthMessages)];</span>
<a href="#l40.60"></a><span id="l40.60"> }</span>
<a href="#l40.61"></a><span id="l40.61"> </span>
<a href="#l40.62"></a><span id="l40.62" class="difflineplus">+function lobotomizeAdaptiveIndexer() {</span>
<a href="#l40.63"></a><span id="l40.63" class="difflineplus">+  // The indexer doesn't need to worry about load; zero his rescheduling time.</span>
<a href="#l40.64"></a><span id="l40.64" class="difflineplus">+  GlodaIndexer._INDEX_INTERVAL = 0;</span>
<a href="#l40.65"></a><span id="l40.65" class="difflineplus">+</span>
<a href="#l40.66"></a><span id="l40.66" class="difflineplus">+  let realIdleService = GlodaIndexer._idleService;</span>
<a href="#l40.67"></a><span id="l40.67" class="difflineplus">+  // pretend we are always idle</span>
<a href="#l40.68"></a><span id="l40.68" class="difflineplus">+  GlodaIndexer._idleService = {</span>
<a href="#l40.69"></a><span id="l40.69" class="difflineplus">+    idleTime: 1000,</span>
<a href="#l40.70"></a><span id="l40.70" class="difflineplus">+    addIdleObserver: function() {</span>
<a href="#l40.71"></a><span id="l40.71" class="difflineplus">+      realIdleService.addIdleObserver.apply(realIdleService, arguments);</span>
<a href="#l40.72"></a><span id="l40.72" class="difflineplus">+    },</span>
<a href="#l40.73"></a><span id="l40.73" class="difflineplus">+    removeIdleObserver: function() {</span>
<a href="#l40.74"></a><span id="l40.74" class="difflineplus">+      realIdleService.removeIdleObserver.apply(realIdleService, arguments);</span>
<a href="#l40.75"></a><span id="l40.75" class="difflineplus">+    }</span>
<a href="#l40.76"></a><span id="l40.76" class="difflineplus">+  };</span>
<a href="#l40.77"></a><span id="l40.77" class="difflineplus">+</span>
<a href="#l40.78"></a><span id="l40.78" class="difflineplus">+  // Lobotomize the adaptive indexer</span>
<a href="#l40.79"></a><span id="l40.79" class="difflineplus">+  GlodaIndexer._cpuTargetIndexTime = 10000;</span>
<a href="#l40.80"></a><span id="l40.80" class="difflineplus">+  GlodaIndexer._CPU_TARGET_INDEX_TIME_ACTIVE = 10000;</span>
<a href="#l40.81"></a><span id="l40.81" class="difflineplus">+  GlodaIndexer._CPU_TARGET_INDEX_TIME_IDLE = 10000;</span>
<a href="#l40.82"></a><span id="l40.82" class="difflineplus">+  GlodaIndexer._CPU_IS_BUSY_TIME = 10000;</span>
<a href="#l40.83"></a><span id="l40.83" class="difflineplus">+  GlodaIndexer._PAUSE_LATE_IS_BUSY_TIME = 10000;</span>
<a href="#l40.84"></a><span id="l40.84" class="difflineplus">+}</span>
<a href="#l40.85"></a><span id="l40.85" class="difflineplus">+</span>
<a href="#l40.86"></a><span id="l40.86"> function imsInit() {</span>
<a href="#l40.87"></a><span id="l40.87" class="difflineplus">+  dump(&quot;Initializing index message state\n&quot;);</span>
<a href="#l40.88"></a><span id="l40.88">   let ims = indexMessageState;</span>
<a href="#l40.89"></a><span id="l40.89"> </span>
<a href="#l40.90"></a><span id="l40.90">   if (!ims.inited) {</span>
<a href="#l40.91"></a><span id="l40.91">     // Disable new mail notifications</span>
<a href="#l40.92"></a><span id="l40.92">     var prefSvc = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l40.93"></a><span id="l40.93">       .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l40.94"></a><span id="l40.94"> </span>
<a href="#l40.95"></a><span id="l40.95">     prefSvc.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l40.96"></a><span id="l40.96" class="difflineat">@@ -241,55 +270,74 @@ function imsInit() {</span>
<a href="#l40.97"></a><span id="l40.97">     prefSvc.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l40.98"></a><span id="l40.98"> </span>
<a href="#l40.99"></a><span id="l40.99">     Gloda.addIndexerListener(messageIndexerListener.onIndexNotification);</span>
<a href="#l40.100"></a><span id="l40.100">     ims.catchAllCollection = Gloda._wildcardCollection(Gloda.NOUN_MESSAGE);</span>
<a href="#l40.101"></a><span id="l40.101">     ims.catchAllCollection.listener = messageCollectionListener;</span>
<a href="#l40.102"></a><span id="l40.102"> </span>
<a href="#l40.103"></a><span id="l40.103">     // Make the indexer be more verbose about indexing for us...</span>
<a href="#l40.104"></a><span id="l40.104">     GlodaIndexer._unitTestSuperVerbose = true;</span>
<a href="#l40.105"></a><span id="l40.105" class="difflineminus">-    // The indexer doesn't need to worry about load; zero his rescheduling time.</span>
<a href="#l40.106"></a><span id="l40.106" class="difflineminus">-    GlodaIndexer._INDEX_INTERVAL = 0;</span>
<a href="#l40.107"></a><span id="l40.107"> </span>
<a href="#l40.108"></a><span id="l40.108" class="difflineminus">-    let realIdleService = GlodaIndexer._idleService;</span>
<a href="#l40.109"></a><span id="l40.109" class="difflineminus">-    // pretend we are always idle</span>
<a href="#l40.110"></a><span id="l40.110" class="difflineminus">-    GlodaIndexer._idleService = {</span>
<a href="#l40.111"></a><span id="l40.111" class="difflineminus">-      idleTime: 1000,</span>
<a href="#l40.112"></a><span id="l40.112" class="difflineminus">-      addIdleObserver: function() {</span>
<a href="#l40.113"></a><span id="l40.113" class="difflineminus">-        realIdleService.addIdleObserver.apply(realIdleService, arguments);</span>
<a href="#l40.114"></a><span id="l40.114" class="difflineminus">-      },</span>
<a href="#l40.115"></a><span id="l40.115" class="difflineminus">-      removeIdleObserver: function() {</span>
<a href="#l40.116"></a><span id="l40.116" class="difflineminus">-        realIdleService.removeIdleObserver.apply(realIdleService, arguments);</span>
<a href="#l40.117"></a><span id="l40.117" class="difflineminus">-      }</span>
<a href="#l40.118"></a><span id="l40.118" class="difflineminus">-    };</span>
<a href="#l40.119"></a><span id="l40.119" class="difflineminus">-</span>
<a href="#l40.120"></a><span id="l40.120" class="difflineminus">-    // Lobotomize the adaptive indexer</span>
<a href="#l40.121"></a><span id="l40.121" class="difflineminus">-    GlodaIndexer._cpuTargetIndexTime = 10000;</span>
<a href="#l40.122"></a><span id="l40.122" class="difflineminus">-    GlodaIndexer._CPU_TARGET_INDEX_TIME_ACTIVE = 10000;</span>
<a href="#l40.123"></a><span id="l40.123" class="difflineminus">-    GlodaIndexer._CPU_TARGET_INDEX_TIME_IDLE = 10000;</span>
<a href="#l40.124"></a><span id="l40.124" class="difflineminus">-    GlodaIndexer._CPU_IS_BUSY_TIME = 10000;</span>
<a href="#l40.125"></a><span id="l40.125" class="difflineminus">-    GlodaIndexer._PAUSE_LATE_IS_BUSY_TIME = 10000;</span>
<a href="#l40.126"></a><span id="l40.126" class="difflineplus">+    lobotomizeAdaptiveIndexer();</span>
<a href="#l40.127"></a><span id="l40.127"> </span>
<a href="#l40.128"></a><span id="l40.128">     if (ims.injectMechanism == INJECT_FAKE_SERVER) {</span>
<a href="#l40.129"></a><span id="l40.129" class="difflineplus">+      // -- Pull in the POP3 fake-server / local account helper code</span>
<a href="#l40.130"></a><span id="l40.130" class="difflineplus">+      load(&quot;../../test_mailnewslocal/unit/head_maillocal.js&quot;);</span>
<a href="#l40.131"></a><span id="l40.131">       // set up POP3 fakeserver to feed things in...</span>
<a href="#l40.132"></a><span id="l40.132">       [ims.daemon, ims.server] = setupServerDaemon();</span>
<a href="#l40.133"></a><span id="l40.133">       // (this will call loadLocalMailAccount())</span>
<a href="#l40.134"></a><span id="l40.134">       ims.incomingServer = createPop3ServerAndLocalFolders();</span>
<a href="#l40.135"></a><span id="l40.135"> </span>
<a href="#l40.136"></a><span id="l40.136">       ims.pop3Service = Cc[&quot;@mozilla.org/messenger/popservice;1&quot;]</span>
<a href="#l40.137"></a><span id="l40.137">                           .getService(Ci.nsIPop3Service);</span>
<a href="#l40.138"></a><span id="l40.138">     }</span>
<a href="#l40.139"></a><span id="l40.139">     else if (ims.injectMechanism == INJECT_MBOX) {</span>
<a href="#l40.140"></a><span id="l40.140">       // we need a local account to stash the mboxes under.</span>
<a href="#l40.141"></a><span id="l40.141">       loadLocalMailAccount();</span>
<a href="#l40.142"></a><span id="l40.142">     }</span>
<a href="#l40.143"></a><span id="l40.143">     else if (ims.injectMechanism == INJECT_ADDMESSAGE) {</span>
<a href="#l40.144"></a><span id="l40.144">       // we need an inbox</span>
<a href="#l40.145"></a><span id="l40.145">       loadLocalMailAccount();</span>
<a href="#l40.146"></a><span id="l40.146">     }</span>
<a href="#l40.147"></a><span id="l40.147" class="difflineplus">+    else if (ims.injectMechanism == INJECT_IMAP_FAKE_SERVER) {</span>
<a href="#l40.148"></a><span id="l40.148" class="difflineplus">+      // Pull in the IMAP fake server code</span>
<a href="#l40.149"></a><span id="l40.149" class="difflineplus">+      load(&quot;../../test_imap/unit/head_server.js&quot;);</span>
<a href="#l40.150"></a><span id="l40.150" class="difflineplus">+</span>
<a href="#l40.151"></a><span id="l40.151" class="difflineplus">+      // set up IMAP fakeserver and incoming server</span>
<a href="#l40.152"></a><span id="l40.152" class="difflineplus">+      ims.daemon = new imapDaemon();</span>
<a href="#l40.153"></a><span id="l40.153" class="difflineplus">+      ims.server = makeServer(ims.daemon, &quot;&quot;);</span>
<a href="#l40.154"></a><span id="l40.154" class="difflineplus">+      ims.incomingServer = createLocalIMAPServer();</span>
<a href="#l40.155"></a><span id="l40.155" class="difflineplus">+      // we need a local account for the IMAP server to have its sent messages in</span>
<a href="#l40.156"></a><span id="l40.156" class="difflineplus">+      loadLocalMailAccount();</span>
<a href="#l40.157"></a><span id="l40.157" class="difflineplus">+</span>
<a href="#l40.158"></a><span id="l40.158" class="difflineplus">+      // We need an identity so that updateFolder doesn't fail</span>
<a href="#l40.159"></a><span id="l40.159" class="difflineplus">+      let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l40.160"></a><span id="l40.160" class="difflineplus">+                      .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l40.161"></a><span id="l40.161" class="difflineplus">+      let localAccount = acctMgr.createAccount();</span>
<a href="#l40.162"></a><span id="l40.162" class="difflineplus">+      let identity = acctMgr.createIdentity();</span>
<a href="#l40.163"></a><span id="l40.163" class="difflineplus">+      localAccount.addIdentity(identity);</span>
<a href="#l40.164"></a><span id="l40.164" class="difflineplus">+      localAccount.defaultIdentity = identity;</span>
<a href="#l40.165"></a><span id="l40.165" class="difflineplus">+      localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l40.166"></a><span id="l40.166" class="difflineplus">+      acctMgr.defaultAccount = localAccount;</span>
<a href="#l40.167"></a><span id="l40.167" class="difflineplus">+</span>
<a href="#l40.168"></a><span id="l40.168" class="difflineplus">+      // Let's also have another account, using the same identity</span>
<a href="#l40.169"></a><span id="l40.169" class="difflineplus">+      let imapAccount = acctMgr.createAccount();</span>
<a href="#l40.170"></a><span id="l40.170" class="difflineplus">+      imapAccount.addIdentity(identity);</span>
<a href="#l40.171"></a><span id="l40.171" class="difflineplus">+      imapAccount.defaultIdentity = identity;</span>
<a href="#l40.172"></a><span id="l40.172" class="difflineplus">+      imapAccount.incomingServer = ims.incomingServer;</span>
<a href="#l40.173"></a><span id="l40.173" class="difflineplus">+</span>
<a href="#l40.174"></a><span id="l40.174" class="difflineplus">+      // The server doesn't support more than one connection</span>
<a href="#l40.175"></a><span id="l40.175" class="difflineplus">+      prefSvc.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l40.176"></a><span id="l40.176" class="difflineplus">+      // We aren't interested in downloading messages automatically</span>
<a href="#l40.177"></a><span id="l40.177" class="difflineplus">+      prefSvc.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l40.178"></a><span id="l40.178" class="difflineplus">+</span>
<a href="#l40.179"></a><span id="l40.179" class="difflineplus">+      // Set the inbox to not be offline</span>
<a href="#l40.180"></a><span id="l40.180" class="difflineplus">+      ims.imapInbox = ims.incomingServer.rootFolder.getChildNamed(&quot;Inbox&quot;);</span>
<a href="#l40.181"></a><span id="l40.181" class="difflineplus">+      ims.imapInbox.flags &amp;= ~Ci.nsMsgFolderFlags.Offline;</span>
<a href="#l40.182"></a><span id="l40.182" class="difflineplus">+    }</span>
<a href="#l40.183"></a><span id="l40.183"> </span>
<a href="#l40.184"></a><span id="l40.184">     ims.inited = true;</span>
<a href="#l40.185"></a><span id="l40.185">   }</span>
<a href="#l40.186"></a><span id="l40.186"> }</span>
<a href="#l40.187"></a><span id="l40.187"> </span>
<a href="#l40.188"></a><span id="l40.188"> /**</span>
<a href="#l40.189"></a><span id="l40.189">  * Have gloda index the given synthetic messages, calling the verifier function</span>
<a href="#l40.190"></a><span id="l40.190">  *  (with accumulator field) once the message has been succesfully indexed.</span>
<a href="#l40.191"></a><span id="l40.191" class="difflineat">@@ -307,26 +355,21 @@ function imsInit() {</span>
<a href="#l40.192"></a><span id="l40.192">  *     indexed message), and aPreviousResult (the value last returned by the</span>
<a href="#l40.193"></a><span id="l40.193">  *     verifier function for this given set of messages, or undefined if it is</span>
<a href="#l40.194"></a><span id="l40.194">  *     the first message.)</span>
<a href="#l40.195"></a><span id="l40.195">  * @param aOnDone The function to call when we complete processing this set of</span>
<a href="#l40.196"></a><span id="l40.196">  *     messages.</span>
<a href="#l40.197"></a><span id="l40.197">  */</span>
<a href="#l40.198"></a><span id="l40.198"> function indexMessages(aSynthMessages, aVerifier, aOnDone) {</span>
<a href="#l40.199"></a><span id="l40.199">   let ims = indexMessageState;</span>
<a href="#l40.200"></a><span id="l40.200" class="difflineminus">-</span>
<a href="#l40.201"></a><span id="l40.201" class="difflineminus">-  ims.inputMessages = aSynthMessages;</span>
<a href="#l40.202"></a><span id="l40.202" class="difflineminus">-  ims.glodaMessages = [];</span>
<a href="#l40.203"></a><span id="l40.203" class="difflineminus">-  ims.verifier = aVerifier;</span>
<a href="#l40.204"></a><span id="l40.204" class="difflineminus">-  ims.previousValue = undefined;</span>
<a href="#l40.205"></a><span id="l40.205" class="difflineminus">-  ims.onDone = aOnDone;</span>
<a href="#l40.206"></a><span id="l40.206" class="difflineplus">+  ims.expectMessages(aSynthMessages, aVerifier, aOnDone);</span>
<a href="#l40.207"></a><span id="l40.207"> </span>
<a href="#l40.208"></a><span id="l40.208">   if (ims.injectMechanism == INJECT_FAKE_SERVER) {</span>
<a href="#l40.209"></a><span id="l40.209">     ims.daemon.setMessages(_synthMessagesToFakeRep(aSynthMessages));</span>
<a href="#l40.210"></a><span id="l40.210" class="difflineminus">-    do_timeout(0, &quot;driveFakeServer();&quot;);</span>
<a href="#l40.211"></a><span id="l40.211" class="difflineplus">+    do_timeout(0, &quot;drivePOP3FakeServer();&quot;);</span>
<a href="#l40.212"></a><span id="l40.212">   }</span>
<a href="#l40.213"></a><span id="l40.213">   else if (ims.injectMechanism == INJECT_MBOX) {</span>
<a href="#l40.214"></a><span id="l40.214">     ims.mboxName = &quot;injecty&quot; + ims.nextMboxNumber++;</span>
<a href="#l40.215"></a><span id="l40.215">     writeMessagesToMbox(aSynthMessages, gProfileDir,</span>
<a href="#l40.216"></a><span id="l40.216">                         &quot;Mail&quot;, &quot;Local Folders&quot;, ims.mboxName);</span>
<a href="#l40.217"></a><span id="l40.217"> </span>
<a href="#l40.218"></a><span id="l40.218">     let rootFolder = gLocalIncomingServer.rootMsgFolder;</span>
<a href="#l40.219"></a><span id="l40.219">     let subFolder = rootFolder.addSubfolder(ims.mboxName);</span>
<a href="#l40.220"></a><span id="l40.220" class="difflineat">@@ -339,57 +382,101 @@ function indexMessages(aSynthMessages, a</span>
<a href="#l40.221"></a><span id="l40.221">     });</span>
<a href="#l40.222"></a><span id="l40.222">   }</span>
<a href="#l40.223"></a><span id="l40.223">   else if (ims.injectMechanism == INJECT_ADDMESSAGE) {</span>
<a href="#l40.224"></a><span id="l40.224">     let localFolder = gLocalInboxFolder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l40.225"></a><span id="l40.225">     for (let [, msg] in Iterator(aSynthMessages)) {</span>
<a href="#l40.226"></a><span id="l40.226">       localFolder.addMessage(msg.toMboxString());</span>
<a href="#l40.227"></a><span id="l40.227">     }</span>
<a href="#l40.228"></a><span id="l40.228">   }</span>
<a href="#l40.229"></a><span id="l40.229" class="difflineplus">+  else if (ims.injectMechanism == INJECT_IMAP_FAKE_SERVER) {</span>
<a href="#l40.230"></a><span id="l40.230" class="difflineplus">+    let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l40.231"></a><span id="l40.231" class="difflineplus">+                      .getService(Ci.nsIIOService);</span>
<a href="#l40.232"></a><span id="l40.232" class="difflineplus">+    let serverInbox = ims.daemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l40.233"></a><span id="l40.233"> </span>
<a href="#l40.234"></a><span id="l40.234" class="difflineplus">+    for (let [, msg] in Iterator(aSynthMessages)) {</span>
<a href="#l40.235"></a><span id="l40.235" class="difflineplus">+      // Generate a URI out of the message</span>
<a href="#l40.236"></a><span id="l40.236" class="difflineplus">+      let URI = ioService.newURI(&quot;data:text/plain;base64,&quot; + btoa(msg.toMessageString()), null, null);</span>
<a href="#l40.237"></a><span id="l40.237" class="difflineplus">+      // Add it to the server</span>
<a href="#l40.238"></a><span id="l40.238" class="difflineplus">+      serverInbox.addMessage(new imapMessage(URI.spec, serverInbox.uidnext++, []));</span>
<a href="#l40.239"></a><span id="l40.239" class="difflineplus">+    }</span>
<a href="#l40.240"></a><span id="l40.240" class="difflineplus">+    // Time to do stuff with the fakeserver</span>
<a href="#l40.241"></a><span id="l40.241" class="difflineplus">+    driveIMAPFakeServer();</span>
<a href="#l40.242"></a><span id="l40.242" class="difflineplus">+  }</span>
<a href="#l40.243"></a><span id="l40.243"> }</span>
<a href="#l40.244"></a><span id="l40.244"> </span>
<a href="#l40.245"></a><span id="l40.245"> function injectMessagesUsing(aInjectMechanism) {</span>
<a href="#l40.246"></a><span id="l40.246">   indexMessageState.injectMechanism = aInjectMechanism;</span>
<a href="#l40.247"></a><span id="l40.247"> }</span>
<a href="#l40.248"></a><span id="l40.248"> </span>
<a href="#l40.249"></a><span id="l40.249"> var indexMessageState = {</span>
<a href="#l40.250"></a><span id="l40.250">   /** have we been initialized (hooked listeners, etc.) */</span>
<a href="#l40.251"></a><span id="l40.251">   inited: false,</span>
<a href="#l40.252"></a><span id="l40.252" class="difflineplus">+  /** whether we're due for any index notifications */</span>
<a href="#l40.253"></a><span id="l40.253" class="difflineplus">+  expectingIndexNotifications: false,</span>
<a href="#l40.254"></a><span id="l40.254">   /** our catch-all message collection that nets us all messages passing by */</span>
<a href="#l40.255"></a><span id="l40.255">   catchAllCollection: null,</span>
<a href="#l40.256"></a><span id="l40.256">   /** the set of synthetic messages passed in to indexMessages */</span>
<a href="#l40.257"></a><span id="l40.257">   inputMessages: null,</span>
<a href="#l40.258"></a><span id="l40.258">   /** the gloda messages resulting from indexing corresponding to input ones */</span>
<a href="#l40.259"></a><span id="l40.259">   glodaMessages: null,</span>
<a href="#l40.260"></a><span id="l40.260">   /** the user-specified accumulate-style verification func */</span>
<a href="#l40.261"></a><span id="l40.261">   verifier: null,</span>
<a href="#l40.262"></a><span id="l40.262">   /** the result of the last call to the verification function */</span>
<a href="#l40.263"></a><span id="l40.263">   previousValue: undefined,</span>
<a href="#l40.264"></a><span id="l40.264">   /** the function to call once we have indexed all the messages */</span>
<a href="#l40.265"></a><span id="l40.265">   onDone: null,</span>
<a href="#l40.266"></a><span id="l40.266"> </span>
<a href="#l40.267"></a><span id="l40.267">   injectMechanism: INJECT_ADDMESSAGE,</span>
<a href="#l40.268"></a><span id="l40.268"> </span>
<a href="#l40.269"></a><span id="l40.269">   /* === Fake Server State === */</span>
<a href="#l40.270"></a><span id="l40.270" class="difflineminus">-  /** nsMailServer instance with POP3_RFC1939 handler */</span>
<a href="#l40.271"></a><span id="l40.271" class="difflineplus">+  /** nsMailServer instance (if POP3, with POP3_RFC1939 handler) */</span>
<a href="#l40.272"></a><span id="l40.272">   server: null,</span>
<a href="#l40.273"></a><span id="l40.273">   serverStarted: false,</span>
<a href="#l40.274"></a><span id="l40.274" class="difflineminus">-  /** pop3Daemon instance */</span>
<a href="#l40.275"></a><span id="l40.275" class="difflineplus">+  /** pop3Daemon/imapDaemon instance */</span>
<a href="#l40.276"></a><span id="l40.276">   daemon: null,</span>
<a href="#l40.277"></a><span id="l40.277" class="difflineminus">-  /** incoming pop3 server */</span>
<a href="#l40.278"></a><span id="l40.278" class="difflineplus">+  /** incoming pop3/imap server */</span>
<a href="#l40.279"></a><span id="l40.279">   incomingServer: null,</span>
<a href="#l40.280"></a><span id="l40.280" class="difflineminus">-  /** pop3 service */</span>
<a href="#l40.281"></a><span id="l40.281" class="difflineplus">+  /** pop3 service (not used for imap) */</span>
<a href="#l40.282"></a><span id="l40.282">   pop3Service: null,</span>
<a href="#l40.283"></a><span id="l40.283" class="difflineplus">+  /** IMAP inbox */</span>
<a href="#l40.284"></a><span id="l40.284" class="difflineplus">+  imapInbox: null,</span>
<a href="#l40.285"></a><span id="l40.285"> </span>
<a href="#l40.286"></a><span id="l40.286">   /* === MBox Injection State === */</span>
<a href="#l40.287"></a><span id="l40.287">   nextMboxNumber: 0,</span>
<a href="#l40.288"></a><span id="l40.288">   mboxName: null,</span>
<a href="#l40.289"></a><span id="l40.289"> </span>
<a href="#l40.290"></a><span id="l40.290">   /**</span>
<a href="#l40.291"></a><span id="l40.291" class="difflineplus">+   * Sets up messages to expect index notifications for.</span>
<a href="#l40.292"></a><span id="l40.292" class="difflineplus">+   *</span>
<a href="#l40.293"></a><span id="l40.293" class="difflineplus">+   * @param aSynthMessages The synthetic messages to expect notifications</span>
<a href="#l40.294"></a><span id="l40.294" class="difflineplus">+   *     for. We currently don't do anything with these other than count them,</span>
<a href="#l40.295"></a><span id="l40.295" class="difflineplus">+   *     so pass whatever you want and it will be the 'source message' (1st</span>
<a href="#l40.296"></a><span id="l40.296" class="difflineplus">+   *     argument) to your verifier function.</span>
<a href="#l40.297"></a><span id="l40.297" class="difflineplus">+   * @param aVerifier The function to call to verify that the indexing had the</span>
<a href="#l40.298"></a><span id="l40.298" class="difflineplus">+   *     desired result.  Takes arguments aSynthMessage (the synthetic message</span>
<a href="#l40.299"></a><span id="l40.299" class="difflineplus">+   *     just indexed), aGlodaMessage (the gloda message representation of the</span>
<a href="#l40.300"></a><span id="l40.300" class="difflineplus">+   *     indexed message), and aPreviousResult (the value last returned by the</span>
<a href="#l40.301"></a><span id="l40.301" class="difflineplus">+   *     verifier function for this given set of messages, or undefined if it is</span>
<a href="#l40.302"></a><span id="l40.302" class="difflineplus">+   *     the first message.)</span>
<a href="#l40.303"></a><span id="l40.303" class="difflineplus">+   * @param aOnDone The function to call when we complete processing this set of</span>
<a href="#l40.304"></a><span id="l40.304" class="difflineplus">+   *     messages.</span>
<a href="#l40.305"></a><span id="l40.305" class="difflineplus">+   */</span>
<a href="#l40.306"></a><span id="l40.306" class="difflineplus">+  expectMessages: function indexMessageState_expectMessages(aSynthMessages, aVerifier,</span>
<a href="#l40.307"></a><span id="l40.307" class="difflineplus">+                                                            aOnDone) {</span>
<a href="#l40.308"></a><span id="l40.308" class="difflineplus">+    dump(&quot;^^^ setting up &quot; + aSynthMessages.length + &quot; message(s) to expect\n&quot;);</span>
<a href="#l40.309"></a><span id="l40.309" class="difflineplus">+    this.inputMessages = aSynthMessages;</span>
<a href="#l40.310"></a><span id="l40.310" class="difflineplus">+    this.expectingIndexNotifications = true;</span>
<a href="#l40.311"></a><span id="l40.311" class="difflineplus">+    this.glodaMessages = [];</span>
<a href="#l40.312"></a><span id="l40.312" class="difflineplus">+    this.verifier = aVerifier;</span>
<a href="#l40.313"></a><span id="l40.313" class="difflineplus">+    this.previousValue = undefined;</span>
<a href="#l40.314"></a><span id="l40.314" class="difflineplus">+    this.onDone = aOnDone;</span>
<a href="#l40.315"></a><span id="l40.315" class="difflineplus">+  },</span>
<a href="#l40.316"></a><span id="l40.316" class="difflineplus">+</span>
<a href="#l40.317"></a><span id="l40.317" class="difflineplus">+  /**</span>
<a href="#l40.318"></a><span id="l40.318">    * Listener to handle the completion of the POP3 message retrieval (one way or</span>
<a href="#l40.319"></a><span id="l40.319">    *  the other.)</span>
<a href="#l40.320"></a><span id="l40.320">    */</span>
<a href="#l40.321"></a><span id="l40.321">   urlListener: {</span>
<a href="#l40.322"></a><span id="l40.322">     OnStartRunningUrl: function (url) {</span>
<a href="#l40.323"></a><span id="l40.323">     },</span>
<a href="#l40.324"></a><span id="l40.324">     OnStopRunningUrl: function (url, result) {</span>
<a href="#l40.325"></a><span id="l40.325">       let ims = indexMessageState;</span>
<a href="#l40.326"></a><span id="l40.326" class="difflineat">@@ -413,48 +500,22 @@ var indexMessageState = {</span>
<a href="#l40.327"></a><span id="l40.327"> </span>
<a href="#l40.328"></a><span id="l40.328">       // we are expecting the gloda indexer to receive some notification as the</span>
<a href="#l40.329"></a><span id="l40.329">       //  result of the new messages showing up, so we don't actually need to</span>
<a href="#l40.330"></a><span id="l40.330">       //  do anything here.</span>
<a href="#l40.331"></a><span id="l40.331">     }</span>
<a href="#l40.332"></a><span id="l40.332">   }</span>
<a href="#l40.333"></a><span id="l40.333"> };</span>
<a href="#l40.334"></a><span id="l40.334"> </span>
<a href="#l40.335"></a><span id="l40.335" class="difflineminus">-</span>
<a href="#l40.336"></a><span id="l40.336"> /**</span>
<a href="#l40.337"></a><span id="l40.337" class="difflineminus">- * Indicate that we should expect some modified messages to be indexed.</span>
<a href="#l40.338"></a><span id="l40.338" class="difflineminus">- *</span>
<a href="#l40.339"></a><span id="l40.339" class="difflineminus">- * @param aMessages The messages that will be modified and we should expect</span>
<a href="#l40.340"></a><span id="l40.340" class="difflineminus">- *   notifications about.  We currently don't do anything with these other than</span>
<a href="#l40.341"></a><span id="l40.341" class="difflineminus">- *   count them, so pass whatever you want and it will be the 'source message'</span>
<a href="#l40.342"></a><span id="l40.342" class="difflineminus">- *   (1st argument) to your verifier function.</span>
<a href="#l40.343"></a><span id="l40.343" class="difflineminus">- * @param aVerifier See indexMessage's aVerifier argument.</span>
<a href="#l40.344"></a><span id="l40.344" class="difflineminus">- * @param aDone The (optional) callback to call on completion.</span>
<a href="#l40.345"></a><span id="l40.345" class="difflineplus">+ * Perform POP3 mail fetching, seeing it through to completion.</span>
<a href="#l40.346"></a><span id="l40.346">  */</span>
<a href="#l40.347"></a><span id="l40.347" class="difflineminus">-function expectModifiedMessages(aMessages, aVerifier, aOnDone) {</span>
<a href="#l40.348"></a><span id="l40.348" class="difflineplus">+function drivePOP3FakeServer() {</span>
<a href="#l40.349"></a><span id="l40.349">   let ims = indexMessageState;</span>
<a href="#l40.350"></a><span id="l40.350" class="difflineminus">-</span>
<a href="#l40.351"></a><span id="l40.351" class="difflineminus">-  ims.inputMessages = aMessages;</span>
<a href="#l40.352"></a><span id="l40.352" class="difflineminus">-  ims.glodaMessages = [];</span>
<a href="#l40.353"></a><span id="l40.353" class="difflineminus">-  ims.verifier = aVerifier;</span>
<a href="#l40.354"></a><span id="l40.354" class="difflineminus">-  ims.previousValue = undefined;</span>
<a href="#l40.355"></a><span id="l40.355" class="difflineminus">-  ims.onDone = aOnDone;</span>
<a href="#l40.356"></a><span id="l40.356" class="difflineminus">-</span>
<a href="#l40.357"></a><span id="l40.357" class="difflineminus">-  // we don't actually need to do anything.  the caller is going to be</span>
<a href="#l40.358"></a><span id="l40.358" class="difflineminus">-  //  triggering a notification which will spur the indexer into action.  the</span>
<a href="#l40.359"></a><span id="l40.359" class="difflineminus">-  //  indexer uses its own scheduling mechanism to drive itself, so as long</span>
<a href="#l40.360"></a><span id="l40.360" class="difflineminus">-  //  as an event loop is active, we're good.</span>
<a href="#l40.361"></a><span id="l40.361" class="difflineminus">-}</span>
<a href="#l40.362"></a><span id="l40.362" class="difflineminus">-</span>
<a href="#l40.363"></a><span id="l40.363" class="difflineminus">-/**</span>
<a href="#l40.364"></a><span id="l40.364" class="difflineminus">- * Perform the mail fetching, seeing it through to completion.</span>
<a href="#l40.365"></a><span id="l40.365" class="difflineminus">- */</span>
<a href="#l40.366"></a><span id="l40.366" class="difflineminus">-function driveFakeServer() {</span>
<a href="#l40.367"></a><span id="l40.367" class="difflineminus">-  let ims = indexMessageState;</span>
<a href="#l40.368"></a><span id="l40.368" class="difflineminus">-dump(&quot;&gt;&gt;&gt; enter driveFakeServer\n&quot;);</span>
<a href="#l40.369"></a><span id="l40.369" class="difflineplus">+dump(&quot;&gt;&gt;&gt; enter drivePOP3FakeServer\n&quot;);</span>
<a href="#l40.370"></a><span id="l40.370">   // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l40.371"></a><span id="l40.371">   // the server if something fails.</span>
<a href="#l40.372"></a><span id="l40.372">   try {</span>
<a href="#l40.373"></a><span id="l40.373">     if (!(ims.serverStarted)) {</span>
<a href="#l40.374"></a><span id="l40.374">       dump(&quot;  starting fake server\n&quot;);</span>
<a href="#l40.375"></a><span id="l40.375">       ims.server.start(POP3_PORT);</span>
<a href="#l40.376"></a><span id="l40.376">       ims.serverStarted = true;</span>
<a href="#l40.377"></a><span id="l40.377">     }</span>
<a href="#l40.378"></a><span id="l40.378" class="difflineat">@@ -475,35 +536,70 @@ dump(&quot;&gt;&gt;&gt; enter driveFakeServer\n&quot;);</span>
<a href="#l40.379"></a><span id="l40.379">     do_throw(e);</span>
<a href="#l40.380"></a><span id="l40.380">   }</span>
<a href="#l40.381"></a><span id="l40.381">   finally {</span>
<a href="#l40.382"></a><span id="l40.382">     dump(&quot;  draining events\n&quot;);</span>
<a href="#l40.383"></a><span id="l40.383">     var thread = gThreadManager.currentThread;</span>
<a href="#l40.384"></a><span id="l40.384">     while (thread.hasPendingEvents())</span>
<a href="#l40.385"></a><span id="l40.385">       thread.processNextEvent(true);</span>
<a href="#l40.386"></a><span id="l40.386">   }</span>
<a href="#l40.387"></a><span id="l40.387" class="difflineminus">-dump(&quot;&lt;&lt;&lt; exit driveFakeServer\n&quot;);</span>
<a href="#l40.388"></a><span id="l40.388" class="difflineplus">+dump(&quot;&lt;&lt;&lt; exit drivePOP3FakeServer\n&quot;);</span>
<a href="#l40.389"></a><span id="l40.389"> }</span>
<a href="#l40.390"></a><span id="l40.390"> </span>
<a href="#l40.391"></a><span id="l40.391"> /**</span>
<a href="#l40.392"></a><span id="l40.392" class="difflineplus">+ * Perform an IMAP mail fetch, seeing it through to completion</span>
<a href="#l40.393"></a><span id="l40.393" class="difflineplus">+ */</span>
<a href="#l40.394"></a><span id="l40.394" class="difflineplus">+function driveIMAPFakeServer() {</span>
<a href="#l40.395"></a><span id="l40.395" class="difflineplus">+  dump(&quot;&gt;&gt;&gt; enter driveIMAPFakeServer\n&quot;);</span>
<a href="#l40.396"></a><span id="l40.396" class="difflineplus">+  let ims = indexMessageState;</span>
<a href="#l40.397"></a><span id="l40.397" class="difflineplus">+  // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l40.398"></a><span id="l40.398" class="difflineplus">+  // the server if something fails.</span>
<a href="#l40.399"></a><span id="l40.399" class="difflineplus">+  try {</span>
<a href="#l40.400"></a><span id="l40.400" class="difflineplus">+    dump(&quot;  resetting fake server\n&quot;);</span>
<a href="#l40.401"></a><span id="l40.401" class="difflineplus">+    ims.server.resetTest();</span>
<a href="#l40.402"></a><span id="l40.402" class="difflineplus">+</span>
<a href="#l40.403"></a><span id="l40.403" class="difflineplus">+    // Update the inbox</span>
<a href="#l40.404"></a><span id="l40.404" class="difflineplus">+    dump(&quot;  issuing updateFolder\n&quot;);</span>
<a href="#l40.405"></a><span id="l40.405" class="difflineplus">+    ims.imapInbox.updateFolder(null);</span>
<a href="#l40.406"></a><span id="l40.406" class="difflineplus">+    // performTest won't work here because that seemingly blocks until the</span>
<a href="#l40.407"></a><span id="l40.407" class="difflineplus">+    // socket is closed, which is something undesirable here</span>
<a href="#l40.408"></a><span id="l40.408" class="difflineplus">+  }</span>
<a href="#l40.409"></a><span id="l40.409" class="difflineplus">+  catch (e) {</span>
<a href="#l40.410"></a><span id="l40.410" class="difflineplus">+    ims.server.stop();</span>
<a href="#l40.411"></a><span id="l40.411" class="difflineplus">+    do_throw(e);</span>
<a href="#l40.412"></a><span id="l40.412" class="difflineplus">+  }</span>
<a href="#l40.413"></a><span id="l40.413" class="difflineplus">+  finally {</span>
<a href="#l40.414"></a><span id="l40.414" class="difflineplus">+    dump(&quot;  draining events\n&quot;);</span>
<a href="#l40.415"></a><span id="l40.415" class="difflineplus">+    let thread = gThreadManager.currentThread;</span>
<a href="#l40.416"></a><span id="l40.416" class="difflineplus">+    while (thread.hasPendingEvents())</span>
<a href="#l40.417"></a><span id="l40.417" class="difflineplus">+      thread.processNextEvent(true);</span>
<a href="#l40.418"></a><span id="l40.418" class="difflineplus">+  }</span>
<a href="#l40.419"></a><span id="l40.419" class="difflineplus">+  dump(&quot;&lt;&lt;&lt; exit driveIMAPFakeServer\n&quot;);</span>
<a href="#l40.420"></a><span id="l40.420" class="difflineplus">+}</span>
<a href="#l40.421"></a><span id="l40.421" class="difflineplus">+</span>
<a href="#l40.422"></a><span id="l40.422" class="difflineplus">+</span>
<a href="#l40.423"></a><span id="l40.423" class="difflineplus">+/**</span>
<a href="#l40.424"></a><span id="l40.424">  * Tear down the fake server.  This is very important to avoid things getting</span>
<a href="#l40.425"></a><span id="l40.425">  *  upset during shutdown.  (Namely, XPConnect will get mad about running in</span>
<a href="#l40.426"></a><span id="l40.426">  *  a context without &quot;Components&quot; defined.)</span>
<a href="#l40.427"></a><span id="l40.427">  */</span>
<a href="#l40.428"></a><span id="l40.428"> function killFakeServer() {</span>
<a href="#l40.429"></a><span id="l40.429" class="difflineplus">+  dump(&quot;Killing fake server\n&quot;);</span>
<a href="#l40.430"></a><span id="l40.430">   let ims = indexMessageState;</span>
<a href="#l40.431"></a><span id="l40.431"> </span>
<a href="#l40.432"></a><span id="l40.432">   ims.incomingServer.closeCachedConnections();</span>
<a href="#l40.433"></a><span id="l40.433"> </span>
<a href="#l40.434"></a><span id="l40.434">   // No more tests, let everything finish</span>
<a href="#l40.435"></a><span id="l40.435">   ims.server.stop();</span>
<a href="#l40.436"></a><span id="l40.436"> </span>
<a href="#l40.437"></a><span id="l40.437">   var thread = gThreadManager.currentThread;</span>
<a href="#l40.438"></a><span id="l40.438">   while (thread.hasPendingEvents())</span>
<a href="#l40.439"></a><span id="l40.439">     thread.processNextEvent(true);</span>
<a href="#l40.440"></a><span id="l40.440" class="difflineplus">+</span>
<a href="#l40.441"></a><span id="l40.441" class="difflineplus">+  do_test_finished();</span>
<a href="#l40.442"></a><span id="l40.442"> }</span>
<a href="#l40.443"></a><span id="l40.443"> </span>
<a href="#l40.444"></a><span id="l40.444"> /**</span>
<a href="#l40.445"></a><span id="l40.445">  * Our catch-all collection listener.  Any time a new message gets indexed,</span>
<a href="#l40.446"></a><span id="l40.446">  *  we should receive an onItemsAdded call.  Any time an existing message</span>
<a href="#l40.447"></a><span id="l40.447">  *  gets reindexed, we should receive an onItemsModified call.  Any time an</span>
<a href="#l40.448"></a><span id="l40.448">  *  existing message actually gets purged from the system, we should receive</span>
<a href="#l40.449"></a><span id="l40.449">  *  an onItemsRemoved call.</span>
<a href="#l40.450"></a><span id="l40.450" class="difflineat">@@ -544,47 +640,65 @@ function runOnIndexingComplete(aCallback</span>
<a href="#l40.451"></a><span id="l40.451">  * Gloda indexer listener, used to know when all active indexing jobs have</span>
<a href="#l40.452"></a><span id="l40.452">  *  completed so that we can try and process all the things that should have</span>
<a href="#l40.453"></a><span id="l40.453">  *  been processed.</span>
<a href="#l40.454"></a><span id="l40.454">  */</span>
<a href="#l40.455"></a><span id="l40.455"> var messageIndexerListener = {</span>
<a href="#l40.456"></a><span id="l40.456">   callbackOnDone: null,</span>
<a href="#l40.457"></a><span id="l40.457">   onIndexNotification: function(aStatus, aPrettyName, aJobIndex, aJobTotal,</span>
<a href="#l40.458"></a><span id="l40.458">                                 aJobItemIndex, aJobItemGoal) {</span>
<a href="#l40.459"></a><span id="l40.459" class="difflineplus">+    dump(&quot;((( Index listener notified! aStatus = &quot; + aStatus + &quot;\n&quot;);</span>
<a href="#l40.460"></a><span id="l40.460" class="difflineplus">+    // Ignore moving/removing notifications</span>
<a href="#l40.461"></a><span id="l40.461" class="difflineplus">+    if (aStatus == Gloda.kIndexerMoving || aStatus == Gloda.kIndexerRemoving)</span>
<a href="#l40.462"></a><span id="l40.462" class="difflineplus">+      return;</span>
<a href="#l40.463"></a><span id="l40.463" class="difflineplus">+</span>
<a href="#l40.464"></a><span id="l40.464" class="difflineplus">+    let ims = indexMessageState;</span>
<a href="#l40.465"></a><span id="l40.465" class="difflineplus">+    // If we shouldn't be receiving notifications and we receive one with aStatus</span>
<a href="#l40.466"></a><span id="l40.466" class="difflineplus">+    // != kIndexerIdle. throw.</span>
<a href="#l40.467"></a><span id="l40.467" class="difflineplus">+    if (!ims.expectingIndexNotifications) {</span>
<a href="#l40.468"></a><span id="l40.468" class="difflineplus">+      if (aStatus == Gloda.kIndexerIdle) {</span>
<a href="#l40.469"></a><span id="l40.469" class="difflineplus">+        dump(&quot;((( Ignoring indexing notification since it's just kIndexerIdle.\n&quot;);</span>
<a href="#l40.470"></a><span id="l40.470" class="difflineplus">+        return;</span>
<a href="#l40.471"></a><span id="l40.471" class="difflineplus">+      }</span>
<a href="#l40.472"></a><span id="l40.472" class="difflineplus">+      else {</span>
<a href="#l40.473"></a><span id="l40.473" class="difflineplus">+        do_throw(&quot;Exception during index notification -- we weren't &quot; +</span>
<a href="#l40.474"></a><span id="l40.474" class="difflineplus">+                 &quot;expecting one.&quot;);</span>
<a href="#l40.475"></a><span id="l40.475" class="difflineplus">+      }</span>
<a href="#l40.476"></a><span id="l40.476" class="difflineplus">+    }</span>
<a href="#l40.477"></a><span id="l40.477" class="difflineplus">+</span>
<a href="#l40.478"></a><span id="l40.478">     // we only care if indexing has just completed...</span>
<a href="#l40.479"></a><span id="l40.479" class="difflineminus">-    if (!GlodaIndexer.indexing) {</span>
<a href="#l40.480"></a><span id="l40.480" class="difflineplus">+    if (aStatus == Gloda.kIndexerIdle) {</span>
<a href="#l40.481"></a><span id="l40.481">       if (messageIndexerListener.callbackOnDone) {</span>
<a href="#l40.482"></a><span id="l40.482">         let callback = messageIndexerListener.callbackOnDone;</span>
<a href="#l40.483"></a><span id="l40.483">         messageIndexerListener.callbackOnDone = null;</span>
<a href="#l40.484"></a><span id="l40.484">         callback();</span>
<a href="#l40.485"></a><span id="l40.485">       }</span>
<a href="#l40.486"></a><span id="l40.486"> </span>
<a href="#l40.487"></a><span id="l40.487" class="difflineminus">-      let ims = indexMessageState;</span>
<a href="#l40.488"></a><span id="l40.488" class="difflineminus">-</span>
<a href="#l40.489"></a><span id="l40.489" class="difflineminus">-      // this is just the synthetic notification if inputMessages is null</span>
<a href="#l40.490"></a><span id="l40.490" class="difflineminus">-      if (ims.inputMessages === null) {</span>
<a href="#l40.491"></a><span id="l40.491" class="difflineminus">-        dump(&quot;((( ignoring indexing notification, assuming synthetic &quot; +</span>
<a href="#l40.492"></a><span id="l40.492" class="difflineminus">-             &quot;notification.\n&quot;);</span>
<a href="#l40.493"></a><span id="l40.493" class="difflineminus">-        return;</span>
<a href="#l40.494"></a><span id="l40.494" class="difflineminus">-      }</span>
<a href="#l40.495"></a><span id="l40.495" class="difflineminus">-</span>
<a href="#l40.496"></a><span id="l40.496">       // if we haven't seen all the messages we should see, assume that the</span>
<a href="#l40.497"></a><span id="l40.497">       //  rest are on their way, and are just coming in a subsequent job...</span>
<a href="#l40.498"></a><span id="l40.498">       // (Also, the first time we register our listener, we will get a synthetic</span>
<a href="#l40.499"></a><span id="l40.499">       //  idle status; at least if the indexer is idle.)</span>
<a href="#l40.500"></a><span id="l40.500" class="difflineminus">-      if (ims.glodaMessages.length &lt; ims.inputMessages.length) {</span>
<a href="#l40.501"></a><span id="l40.501" class="difflineplus">+      let glodaLen = ims.glodaMessages.length, inputLen =</span>
<a href="#l40.502"></a><span id="l40.502" class="difflineplus">+        ims.inputMessages.length;</span>
<a href="#l40.503"></a><span id="l40.503" class="difflineplus">+      if (glodaLen &lt; inputLen) {</span>
<a href="#l40.504"></a><span id="l40.504">         dump(&quot;((( indexing is no longer indexing, but we're still expecting &quot; +</span>
<a href="#l40.505"></a><span id="l40.505" class="difflineminus">-             &quot;more results, ignoring.\n&quot;);</span>
<a href="#l40.506"></a><span id="l40.506" class="difflineplus">+             inputLen + &quot; - &quot; + glodaLen + &quot; = &quot; + (inputLen - glodaLen) +</span>
<a href="#l40.507"></a><span id="l40.507" class="difflineplus">+             &quot; more results, ignoring.\n&quot;);</span>
<a href="#l40.508"></a><span id="l40.508" class="difflineplus">+        // If we're running IMAP, then update the folder once more</span>
<a href="#l40.509"></a><span id="l40.509" class="difflineplus">+        if (ims.imapInbox)</span>
<a href="#l40.510"></a><span id="l40.510" class="difflineplus">+          ims.imapInbox.updateFolder(null);</span>
<a href="#l40.511"></a><span id="l40.511">         return;</span>
<a href="#l40.512"></a><span id="l40.512">       }</span>
<a href="#l40.513"></a><span id="l40.513"> </span>
<a href="#l40.514"></a><span id="l40.514">       dump(&quot;((( indexer notification (&quot; + ims.glodaMessages.length +</span>
<a href="#l40.515"></a><span id="l40.515">            &quot; messages) about to verify: &quot; +</span>
<a href="#l40.516"></a><span id="l40.516">            (ims.verifier ? ims.verifier.name : &quot;none&quot;) + &quot; and complete: &quot; +</span>
<a href="#l40.517"></a><span id="l40.517">            (ims.onDone ? ims.onDone.name : &quot;none&quot;) + &quot;\n&quot;);</span>
<a href="#l40.518"></a><span id="l40.518" class="difflineplus">+      // If we're verifying messages, we shouldn't be expecting them</span>
<a href="#l40.519"></a><span id="l40.519" class="difflineplus">+      ims.expectingIndexNotifications = false;</span>
<a href="#l40.520"></a><span id="l40.520"> </span>
<a href="#l40.521"></a><span id="l40.521">       // call the verifier.  (we expect them to generate an exception if the</span>
<a href="#l40.522"></a><span id="l40.522">       //  verification fails, using do_check_*/do_throw; we don't care about</span>
<a href="#l40.523"></a><span id="l40.523">       //  the return value except to propagate forward to subsequent calls.)</span>
<a href="#l40.524"></a><span id="l40.524">       for (let iMessage=0; iMessage &lt; ims.inputMessages.length; iMessage++) {</span>
<a href="#l40.525"></a><span id="l40.525">         if (ims.verifier) {</span>
<a href="#l40.526"></a><span id="l40.526">           try {</span>
<a href="#l40.527"></a><span id="l40.527">             ims.previousValue = ims.verifier(ims.inputMessages[iMessage],</span>
<a href="#l40.528"></a><span id="l40.528" class="difflineat">@@ -595,16 +709,17 @@ var messageIndexerListener = {</span>
<a href="#l40.529"></a><span id="l40.529">             do_throw(&quot;Exception during verification via &quot; + ims.verifier.name +</span>
<a href="#l40.530"></a><span id="l40.530">                 &quot; on message index: &quot; + iMessage + &quot; previous value: &quot; +</span>
<a href="#l40.531"></a><span id="l40.531">                 ims.previousValue + &quot; gloda message: &quot; +</span>
<a href="#l40.532"></a><span id="l40.532">                 ims.glodaMessages[iMessage] + &quot;\nexception: &quot; + ex);</span>
<a href="#l40.533"></a><span id="l40.533">           }</span>
<a href="#l40.534"></a><span id="l40.534">         }</span>
<a href="#l40.535"></a><span id="l40.535">       }</span>
<a href="#l40.536"></a><span id="l40.536"> </span>
<a href="#l40.537"></a><span id="l40.537" class="difflineplus">+      dump(&quot;((( Verification complete\n&quot;);</span>
<a href="#l40.538"></a><span id="l40.538">       if (ims.onDone) {</span>
<a href="#l40.539"></a><span id="l40.539">         try {</span>
<a href="#l40.540"></a><span id="l40.540">           ims.onDone();</span>
<a href="#l40.541"></a><span id="l40.541">         }</span>
<a href="#l40.542"></a><span id="l40.542">         catch (ex) {</span>
<a href="#l40.543"></a><span id="l40.543">           do_throw(&quot;Exception calling ims.onDone (&quot; + ims.onDone.name + &quot;): &quot; +</span>
<a href="#l40.544"></a><span id="l40.544">               ex);</span>
<a href="#l40.545"></a><span id="l40.545">         }</span>
<a href="#l40.546"></a><span id="l40.546" class="difflineat">@@ -765,19 +880,18 @@ function twiddleAndTest(aSynthMsg, aActi</span>
<a href="#l40.547"></a><span id="l40.547">   function twiddle_next_attr(smsg, gmsg) {</span>
<a href="#l40.548"></a><span id="l40.548">     let curTwiddling = aActionsAndTests[iTwiddling];</span>
<a href="#l40.549"></a><span id="l40.549">     let twiddleFunc = curTwiddling[0];</span>
<a href="#l40.550"></a><span id="l40.550">     let desiredState = curTwiddling[2];</span>
<a href="#l40.551"></a><span id="l40.551"> </span>
<a href="#l40.552"></a><span id="l40.552">     // the underlying nsIMsgDBHdr should exist at this point...</span>
<a href="#l40.553"></a><span id="l40.553">     do_check_neq(gmsg.folderMessage, null);</span>
<a href="#l40.554"></a><span id="l40.554">     // prepare</span>
<a href="#l40.555"></a><span id="l40.555" class="difflineminus">-    expectModifiedMessages([gmsg.folderMessage], verify_next_attr);</span>
<a href="#l40.556"></a><span id="l40.556" class="difflineplus">+    indexMessageState.expectMessages([gmsg.folderMessage], verify_next_attr);</span>
<a href="#l40.557"></a><span id="l40.557">     // tell the function to perform its mutation to the desired state</span>
<a href="#l40.558"></a><span id="l40.558" class="difflineminus">-    dump(&quot;twiddling: &quot; + twiddleFunc.name + &quot;: &quot; + desiredState + &quot;\n&quot;);</span>
<a href="#l40.559"></a><span id="l40.559">     twiddleFunc(gmsg.folderMessage, desiredState);</span>
<a href="#l40.560"></a><span id="l40.560">   }</span>
<a href="#l40.561"></a><span id="l40.561">   function verify_next_attr(smsg, gmsg) {</span>
<a href="#l40.562"></a><span id="l40.562">     let curTwiddling = aActionsAndTests[iTwiddling];</span>
<a href="#l40.563"></a><span id="l40.563">     let verifyFunc = curTwiddling[1];</span>
<a href="#l40.564"></a><span id="l40.564">     let expectedVal = curTwiddling[curTwiddling.length == 3 ? 2 : 3];</span>
<a href="#l40.565"></a><span id="l40.565">     dump(&quot;verifying: &quot; + verifyFunc.name + &quot;: &quot; + expectedVal + &quot;\n&quot;);</span>
<a href="#l40.566"></a><span id="l40.566">     verifyFunc(smsg, gmsg, expectedVal);</span>
<a href="#l40.567"></a><span id="l40.567" class="difflineat">@@ -1016,18 +1130,21 @@ function _gh_test_iterator() {</span>
<a href="#l40.568"></a><span id="l40.568">       }</span>
<a href="#l40.569"></a><span id="l40.569">     }</span>
<a href="#l40.570"></a><span id="l40.570">     else {</span>
<a href="#l40.571"></a><span id="l40.571">       dump(&quot;====== Test function: &quot; + test.name + &quot;\n&quot;);</span>
<a href="#l40.572"></a><span id="l40.572">       yield test();</span>
<a href="#l40.573"></a><span id="l40.573">     }</span>
<a href="#l40.574"></a><span id="l40.574">   }</span>
<a href="#l40.575"></a><span id="l40.575"> </span>
<a href="#l40.576"></a><span id="l40.576" class="difflineminus">-  if (indexMessageState.injectMechanism == INJECT_FAKE_SERVER) {</span>
<a href="#l40.577"></a><span id="l40.577" class="difflineminus">-    killFakeServer();</span>
<a href="#l40.578"></a><span id="l40.578" class="difflineplus">+  if (indexMessageState.injectMechanism == INJECT_FAKE_SERVER ||</span>
<a href="#l40.579"></a><span id="l40.579" class="difflineplus">+      indexMessageState.injectMechanism == INJECT_IMAP_FAKE_SERVER) {</span>
<a href="#l40.580"></a><span id="l40.580" class="difflineplus">+    do_test_pending();</span>
<a href="#l40.581"></a><span id="l40.581" class="difflineplus">+    // Give a bit of time for any remaining notifications to go through.</span>
<a href="#l40.582"></a><span id="l40.582" class="difflineplus">+    do_timeout(500, &quot;killFakeServer()&quot;);</span>
<a href="#l40.583"></a><span id="l40.583">   }</span>
<a href="#l40.584"></a><span id="l40.584"> </span>
<a href="#l40.585"></a><span id="l40.585">   do_test_finished();</span>
<a href="#l40.586"></a><span id="l40.586"> </span>
<a href="#l40.587"></a><span id="l40.587">   // once the control flow hits the root after do_test_finished, we're done,</span>
<a href="#l40.588"></a><span id="l40.588">   //  so let's just yield something to avoid callers having to deal with an</span>
<a href="#l40.589"></a><span id="l40.589">   //  exception indicating completion.</span>
<a href="#l40.590"></a><span id="l40.590">   yield null;</span>
<a href="#l40.591"></a><span id="l40.591" class="difflineat">@@ -1067,25 +1184,33 @@ function parameterizeTest(aTestFunc, aPa</span>
<a href="#l40.592"></a><span id="l40.592"> }</span>
<a href="#l40.593"></a><span id="l40.593"> </span>
<a href="#l40.594"></a><span id="l40.594"> /**</span>
<a href="#l40.595"></a><span id="l40.595">  * Test driving logic that takes a list of tests to run.  Every completed test</span>
<a href="#l40.596"></a><span id="l40.596">  *  needs to call (or cause to be called) next_test.</span>
<a href="#l40.597"></a><span id="l40.597">  *</span>
<a href="#l40.598"></a><span id="l40.598">  * @param aTests A list of test functions to call.</span>
<a href="#l40.599"></a><span id="l40.599">  * @param aLongestTestRunTimeConceivableInSecs Optional parameter</span>
<a href="#l40.600"></a><span id="l40.600" class="difflineplus">+ * @param aDontInitIMS Optional parameter. If this is specified then the index</span>
<a href="#l40.601"></a><span id="l40.601" class="difflineplus">+ *                     message state is not initialized</span>
<a href="#l40.602"></a><span id="l40.602">  */</span>
<a href="#l40.603"></a><span id="l40.603" class="difflineminus">-function glodaHelperRunTests(aTests, aLongestTestRunTimeConceivableInSecs) {</span>
<a href="#l40.604"></a><span id="l40.604" class="difflineplus">+function glodaHelperRunTests(aTests, aLongestTestRunTimeConceivableInSecs,</span>
<a href="#l40.605"></a><span id="l40.605" class="difflineplus">+                             aDontInitIMS) {</span>
<a href="#l40.606"></a><span id="l40.606">   if (aLongestTestRunTimeConceivableInSecs == null)</span>
<a href="#l40.607"></a><span id="l40.607">     aLongestTestRunTimeConceivableInSecs =</span>
<a href="#l40.608"></a><span id="l40.608">         DEFAULT_LONGEST_TEST_RUN_CONCEIVABLE_SECS;</span>
<a href="#l40.609"></a><span id="l40.609">   do_timeout(aLongestTestRunTimeConceivableInSecs * 1000,</span>
<a href="#l40.610"></a><span id="l40.610">       &quot;do_throw('Timeout running test, and we want you to have the log.');&quot;);</span>
<a href="#l40.611"></a><span id="l40.611"> </span>
<a href="#l40.612"></a><span id="l40.612" class="difflineminus">-  imsInit();</span>
<a href="#l40.613"></a><span id="l40.613" class="difflineplus">+  if (!aDontInitIMS)</span>
<a href="#l40.614"></a><span id="l40.614" class="difflineplus">+    imsInit();</span>
<a href="#l40.615"></a><span id="l40.615" class="difflineplus">+  // even if we don't want to init IMS, we want to avoid anything adaptive</span>
<a href="#l40.616"></a><span id="l40.616" class="difflineplus">+  //  happening.</span>
<a href="#l40.617"></a><span id="l40.617" class="difflineplus">+  else</span>
<a href="#l40.618"></a><span id="l40.618" class="difflineplus">+    lobotomizeAdaptiveIndexer();</span>
<a href="#l40.619"></a><span id="l40.619">   glodaHelperTests = aTests;</span>
<a href="#l40.620"></a><span id="l40.620">   glodaHelperIterator = _gh_test_iterator();</span>
<a href="#l40.621"></a><span id="l40.621">   next_test();</span>
<a href="#l40.622"></a><span id="l40.622"> }</span>
<a href="#l40.623"></a><span id="l40.623"> </span>
<a href="#l40.624"></a><span id="l40.624"> /**</span>
<a href="#l40.625"></a><span id="l40.625">  * Wipe out almost everything from the clutches of the GlodaCollectionManager.</span>
<a href="#l40.626"></a><span id="l40.626">  * By default, it is caching things and knows about all the non-GC'ed</span>
<a href="#l40.627"></a><span id="l40.627" class="difflineat">@@ -1130,8 +1255,24 @@ function nukeGlodaCachesAndCollections()</span>
<a href="#l40.628"></a><span id="l40.628">   // caches aren't intended to be cleared, but we also don't want to lose our</span>
<a href="#l40.629"></a><span id="l40.629">   //  caches, so we need to create new ones from the ashes of the old ones.</span>
<a href="#l40.630"></a><span id="l40.630">   let oldCaches = GlodaCollectionManager._cachesByNoun;</span>
<a href="#l40.631"></a><span id="l40.631">   GlodaCollectionManager._cachesByNoun = {};</span>
<a href="#l40.632"></a><span id="l40.632">   for each (let cache in oldCaches) {</span>
<a href="#l40.633"></a><span id="l40.633">     GlodaCollectionManager.defineCache(cache._nounDef, cache._maxCacheSize);</span>
<a href="#l40.634"></a><span id="l40.634">   }</span>
<a href="#l40.635"></a><span id="l40.635"> }</span>
<a href="#l40.636"></a><span id="l40.636" class="difflineplus">+</span>
<a href="#l40.637"></a><span id="l40.637" class="difflineplus">+/**</span>
<a href="#l40.638"></a><span id="l40.638" class="difflineplus">+ * Given an IMAP folder, marks it offline and downloads its messages.</span>
<a href="#l40.639"></a><span id="l40.639" class="difflineplus">+ *</span>
<a href="#l40.640"></a><span id="l40.640" class="difflineplus">+ * @param aFolder an IMAP message folder</span>
<a href="#l40.641"></a><span id="l40.641" class="difflineplus">+ * @param aSynthMessages see indexMessageState.expectMessages</span>
<a href="#l40.642"></a><span id="l40.642" class="difflineplus">+ * @param aVerifier see indexMessageState.expectMessages</span>
<a href="#l40.643"></a><span id="l40.643" class="difflineplus">+ * @param aDone see indexMessageState.expectMessages</span>
<a href="#l40.644"></a><span id="l40.644" class="difflineplus">+ */</span>
<a href="#l40.645"></a><span id="l40.645" class="difflineplus">+function imapDownloadAllMessages(aFolder, aSynthMessages, aVerifier, aDone) {</span>
<a href="#l40.646"></a><span id="l40.646" class="difflineplus">+  // Let the message state know that we're expecting messages</span>
<a href="#l40.647"></a><span id="l40.647" class="difflineplus">+  indexMessageState.expectMessages(aSynthMessages, aVerifier, aDone);</span>
<a href="#l40.648"></a><span id="l40.648" class="difflineplus">+  aFolder.setFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l40.649"></a><span id="l40.649" class="difflineplus">+  aFolder.downloadAllForOffline(null, null);</span>
<a href="#l40.650"></a><span id="l40.650" class="difflineplus">+  // The indexer listener is going to call aDone, so our job is done here</span>
<a href="#l40.651"></a><span id="l40.651" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/test_gloda_content.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_gloda_content.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -92,16 +92,27 @@ var messageInfos = [</span>
<a href="#l41.4"></a><span id="l41.4">            [false, &quot;&gt; wrote&quot;],</span>
<a href="#l41.5"></a><span id="l41.5">            [true, &quot;cheese&quot;],</span>
<a href="#l41.6"></a><span id="l41.6">            [false, &quot;&quot;]]</span>
<a href="#l41.7"></a><span id="l41.7">   }</span>
<a href="#l41.8"></a><span id="l41.8"> ];</span>
<a href="#l41.9"></a><span id="l41.9"> </span>
<a href="#l41.10"></a><span id="l41.10"> /* ===== Tests ===== */</span>
<a href="#l41.11"></a><span id="l41.11"> </span>
<a href="#l41.12"></a><span id="l41.12" class="difflineplus">+/**</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+ * Hooks for pre/post setup message, used for the IMAP tests.</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineplus">+ */</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineplus">+var pre_inject_message_hook = function default_pre_inject_message_hook() {</span>
<a href="#l41.16"></a><span id="l41.16" class="difflineplus">+  next_test();</span>
<a href="#l41.17"></a><span id="l41.17" class="difflineplus">+};</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineplus">+</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineplus">+var post_inject_message_hook = function default_post_inject_message_hook() {</span>
<a href="#l41.20"></a><span id="l41.20" class="difflineplus">+  next_test();</span>
<a href="#l41.21"></a><span id="l41.21" class="difflineplus">+};</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineplus">+</span>
<a href="#l41.23"></a><span id="l41.23"> function setup_create_message(info) {</span>
<a href="#l41.24"></a><span id="l41.24">   info.body = {body: [tupe[1] for each</span>
<a href="#l41.25"></a><span id="l41.25">                       ([, tupe] in Iterator(info.bode))].join(&quot;\r\n&quot;)};</span>
<a href="#l41.26"></a><span id="l41.26">   info.expected = [tupe[1] for each</span>
<a href="#l41.27"></a><span id="l41.27">                    ([, tupe] in Iterator(info.bode)) if</span>
<a href="#l41.28"></a><span id="l41.28">                    (tupe[0])].join(&quot;\n&quot;);</span>
<a href="#l41.29"></a><span id="l41.29"> </span>
<a href="#l41.30"></a><span id="l41.30">   info._synMsg = msgGen.makeMessage(info);</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineat">@@ -120,20 +131,22 @@ function glodaInfoStasher(aSynthMessage,</span>
<a href="#l41.32"></a><span id="l41.32">       messageInfos[iMsg]._glodaMsg = aGlodaMessage;</span>
<a href="#l41.33"></a><span id="l41.33">     }</span>
<a href="#l41.34"></a><span id="l41.34">   }</span>
<a href="#l41.35"></a><span id="l41.35"> }</span>
<a href="#l41.36"></a><span id="l41.36"> </span>
<a href="#l41.37"></a><span id="l41.37"> /**</span>
<a href="#l41.38"></a><span id="l41.38">  * Actually inject all the messages we created above.</span>
<a href="#l41.39"></a><span id="l41.39">  */</span>
<a href="#l41.40"></a><span id="l41.40" class="difflineplus">+var gSynMessages;</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineplus">+</span>
<a href="#l41.42"></a><span id="l41.42"> function setup_inject_messages() {</span>
<a href="#l41.43"></a><span id="l41.43" class="difflineminus">-  let synMessages = [info._synMsg for each</span>
<a href="#l41.44"></a><span id="l41.44" class="difflineminus">-                      ([, info] in Iterator(messageInfos))];</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineminus">-  indexMessages(synMessages, glodaInfoStasher, next_test);</span>
<a href="#l41.46"></a><span id="l41.46" class="difflineplus">+  gSynMessages = [info._synMsg for each</span>
<a href="#l41.47"></a><span id="l41.47" class="difflineplus">+                  ([, info] in Iterator(messageInfos))];</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineplus">+  indexMessages(gSynMessages, glodaInfoStasher, next_test);</span>
<a href="#l41.49"></a><span id="l41.49"> }</span>
<a href="#l41.50"></a><span id="l41.50"> </span>
<a href="#l41.51"></a><span id="l41.51"> function test_stream_message(info) {</span>
<a href="#l41.52"></a><span id="l41.52">   let msgHdr = info._glodaMsg.folderMessage;</span>
<a href="#l41.53"></a><span id="l41.53"> </span>
<a href="#l41.54"></a><span id="l41.54">   MsgHdrToMimeMessage(msgHdr, null, function(aMsgHdr, aMimeMsg) {</span>
<a href="#l41.55"></a><span id="l41.55">     verify_message_content(info, info._synMsg, info._glodaMsg, aMsgHdr,</span>
<a href="#l41.56"></a><span id="l41.56">                            aMimeMsg);</span>
<a href="#l41.57"></a><span id="l41.57" class="difflineat">@@ -161,16 +174,20 @@ function verify_message_content(aInfo, a</span>
<a href="#l41.58"></a><span id="l41.58"> </span>
<a href="#l41.59"></a><span id="l41.59">   next_test();</span>
<a href="#l41.60"></a><span id="l41.60"> }</span>
<a href="#l41.61"></a><span id="l41.61"> </span>
<a href="#l41.62"></a><span id="l41.62"> /* ===== Driver ===== */</span>
<a href="#l41.63"></a><span id="l41.63"> </span>
<a href="#l41.64"></a><span id="l41.64"> var tests = [</span>
<a href="#l41.65"></a><span id="l41.65">   parameterizeTest(setup_create_message, messageInfos),</span>
<a href="#l41.66"></a><span id="l41.66" class="difflineplus">+  function pre_inject_message() { pre_inject_message_hook(); },</span>
<a href="#l41.67"></a><span id="l41.67">   setup_inject_messages,</span>
<a href="#l41.68"></a><span id="l41.68" class="difflineplus">+  function post_inject_message() { post_inject_message_hook(); },</span>
<a href="#l41.69"></a><span id="l41.69" class="difflineplus">+ // disable_index_notifications,</span>
<a href="#l41.70"></a><span id="l41.70">   parameterizeTest(test_stream_message, messageInfos),</span>
<a href="#l41.71"></a><span id="l41.71"> ];</span>
<a href="#l41.72"></a><span id="l41.72"> </span>
<a href="#l41.73"></a><span id="l41.73"> function run_test() {</span>
<a href="#l41.74"></a><span id="l41.74" class="difflineminus">-  injectMessagesUsing(INJECT_MBOX);</span>
<a href="#l41.75"></a><span id="l41.75">   glodaHelperRunTests(tests);</span>
<a href="#l41.76"></a><span id="l41.76"> }</span>
<a href="#l41.77"></a><span id="l41.77" class="difflineplus">+</span>
<a href="#l41.78"></a><span id="l41.78" class="difflineplus">+injectMessagesUsing(INJECT_MBOX);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1">new file mode 100644</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineminus">--- /dev/null</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_gloda_content_imap_originally_offline.js</span>
<a href="#l42.4"></a><span id="l42.4" class="difflineat">@@ -0,0 +1,17 @@</span>
<a href="#l42.5"></a><span id="l42.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l42.6"></a><span id="l42.6" class="difflineplus">+/**</span>
<a href="#l42.7"></a><span id="l42.7" class="difflineplus">+ * Tests the operation of the GlodaContent (in connotent.js) and its exposure</span>
<a href="#l42.8"></a><span id="l42.8" class="difflineplus">+ * via Gloda.getMessageContent for IMAP messages that are originally offline.</span>
<a href="#l42.9"></a><span id="l42.9" class="difflineplus">+ */</span>
<a href="#l42.10"></a><span id="l42.10" class="difflineplus">+</span>
<a href="#l42.11"></a><span id="l42.11" class="difflineplus">+load(&quot;test_gloda_content.js&quot;);</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineplus">+</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+/**</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineplus">+ * Set the imap folder to offline before adding the messages.</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineplus">+ */</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineplus">+var pre_inject_message_hook = function imap_pre_inject_message_hook() {</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineplus">+  indexMessageState.imapInbox.setFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineplus">+  next_test();</span>
<a href="#l42.19"></a><span id="l42.19" class="difflineplus">+};</span>
<a href="#l42.20"></a><span id="l42.20" class="difflineplus">+</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1">new file mode 100644</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineminus">--- /dev/null</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_gloda_content_imap_switched_to_offline.js</span>
<a href="#l43.4"></a><span id="l43.4" class="difflineat">@@ -0,0 +1,19 @@</span>
<a href="#l43.5"></a><span id="l43.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l43.6"></a><span id="l43.6" class="difflineplus">+/**</span>
<a href="#l43.7"></a><span id="l43.7" class="difflineplus">+ * Tests the operation of the GlodaContent (in connotent.js) and its exposure</span>
<a href="#l43.8"></a><span id="l43.8" class="difflineplus">+ * via Gloda.getMessageContent for IMAP messages that were not originally</span>
<a href="#l43.9"></a><span id="l43.9" class="difflineplus">+ * offline, but were later made offline.</span>
<a href="#l43.10"></a><span id="l43.10" class="difflineplus">+ */</span>
<a href="#l43.11"></a><span id="l43.11" class="difflineplus">+</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineplus">+load(&quot;test_gloda_content.js&quot;);</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+/**</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineplus">+ * Set the imap folder to offline after adding the messages, then force a</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+ * download of all messages.</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineplus">+ */</span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+var post_inject_message_hook = function imap_post_inject_message_hook() {</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineplus">+  imapDownloadAllMessages(indexMessageState.imapInbox, gSynMessages,</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineplus">+                          glodaInfoStasher, next_test);</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineplus">+};</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineplus">+</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/test_index_messages.js</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_index_messages.js</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -5,30 +5,45 @@</span>
<a href="#l44.4"></a><span id="l44.4">  *</span>
<a href="#l44.5"></a><span id="l44.5">  * Things we don't test that you think we might test:</span>
<a href="#l44.6"></a><span id="l44.6">  * - Full-text search.  Happens in query testing.</span>
<a href="#l44.7"></a><span id="l44.7">  */</span>
<a href="#l44.8"></a><span id="l44.8"> </span>
<a href="#l44.9"></a><span id="l44.9"> load(&quot;../../mailnews/resources/messageGenerator.js&quot;);</span>
<a href="#l44.10"></a><span id="l44.10"> load(&quot;resources/glodaTestHelper.js&quot;);</span>
<a href="#l44.11"></a><span id="l44.11"> </span>
<a href="#l44.12"></a><span id="l44.12" class="difflineplus">+// Whether we can expect fulltext results</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+var expectFulltextResults = true;</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineplus">+</span>
<a href="#l44.15"></a><span id="l44.15"> // Create a message generator</span>
<a href="#l44.16"></a><span id="l44.16"> var msgGen = new MessageGenerator();</span>
<a href="#l44.17"></a><span id="l44.17"> // Create a message scenario generator using that message generator</span>
<a href="#l44.18"></a><span id="l44.18"> var scenarios = new MessageScenarioFactory(msgGen);</span>
<a href="#l44.19"></a><span id="l44.19"> </span>
<a href="#l44.20"></a><span id="l44.20"> /* ===== Threading / Conversation Grouping ===== */</span>
<a href="#l44.21"></a><span id="l44.21"> </span>
<a href="#l44.22"></a><span id="l44.22" class="difflineplus">+var gSynMessages = [];</span>
<a href="#l44.23"></a><span id="l44.23"> function allMessageInSameConversation(aSynthMessage, aGlodaMessage, aConvID) {</span>
<a href="#l44.24"></a><span id="l44.24">   if (aConvID === undefined)</span>
<a href="#l44.25"></a><span id="l44.25">     return aGlodaMessage.conversationID;</span>
<a href="#l44.26"></a><span id="l44.26">   do_check_eq(aConvID, aGlodaMessage.conversationID);</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineplus">+  // Cheat and stash the synthetic message (we need them for one of the IMAP</span>
<a href="#l44.28"></a><span id="l44.28" class="difflineplus">+  // tests)</span>
<a href="#l44.29"></a><span id="l44.29" class="difflineplus">+  gSynMessages.push(aSynthMessage);</span>
<a href="#l44.30"></a><span id="l44.30">   return aConvID;</span>
<a href="#l44.31"></a><span id="l44.31"> }</span>
<a href="#l44.32"></a><span id="l44.32"> </span>
<a href="#l44.33"></a><span id="l44.33" class="difflineplus">+// These are overridden by the IMAP tests as needed</span>
<a href="#l44.34"></a><span id="l44.34" class="difflineplus">+var pre_test_threading_hook = function default_pre_test_threading_hook() {</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineplus">+  next_test();</span>
<a href="#l44.36"></a><span id="l44.36" class="difflineplus">+};</span>
<a href="#l44.37"></a><span id="l44.37" class="difflineplus">+var post_test_threading_hook = function default_post_test_threading_hook() {</span>
<a href="#l44.38"></a><span id="l44.38" class="difflineplus">+  next_test();</span>
<a href="#l44.39"></a><span id="l44.39" class="difflineplus">+};</span>
<a href="#l44.40"></a><span id="l44.40" class="difflineplus">+</span>
<a href="#l44.41"></a><span id="l44.41"> /**</span>
<a href="#l44.42"></a><span id="l44.42">  * Test our conversation/threading logic in the straight-forward direct</span>
<a href="#l44.43"></a><span id="l44.43">  *  reply case, the missing intermediary case, and the siblings with missing</span>
<a href="#l44.44"></a><span id="l44.44">  *  parent case.  We also test all permutations of receipt of those messages.</span>
<a href="#l44.45"></a><span id="l44.45">  * (Also tests that we index new messages.)</span>
<a href="#l44.46"></a><span id="l44.46">  */</span>
<a href="#l44.47"></a><span id="l44.47"> function test_threading() {</span>
<a href="#l44.48"></a><span id="l44.48">   indexAndPermuteMessages(scenarios.directReply,</span>
<a href="#l44.49"></a><span id="l44.49" class="difflineat">@@ -67,22 +82,27 @@ function test_attributes_fundamental() {</span>
<a href="#l44.50"></a><span id="l44.50">     ],</span>
<a href="#l44.51"></a><span id="l44.51">   });</span>
<a href="#l44.52"></a><span id="l44.52">   // save it off for test_attributes_fundamental_from_disk</span>
<a href="#l44.53"></a><span id="l44.53">   fundamentalSyntheticMessage = smsg;</span>
<a href="#l44.54"></a><span id="l44.54"> </span>
<a href="#l44.55"></a><span id="l44.55">   indexMessages([smsg], verify_attributes_fundamental, next_test);</span>
<a href="#l44.56"></a><span id="l44.56"> }</span>
<a href="#l44.57"></a><span id="l44.57"> </span>
<a href="#l44.58"></a><span id="l44.58" class="difflineplus">+// Overridden by test_index_imap_mesasges</span>
<a href="#l44.59"></a><span id="l44.59" class="difflineplus">+var get_expected_folder_URI = function local_get_expected_folder_URI() {</span>
<a href="#l44.60"></a><span id="l44.60" class="difflineplus">+  return gLocalInboxFolder.URI;</span>
<a href="#l44.61"></a><span id="l44.61" class="difflineplus">+};</span>
<a href="#l44.62"></a><span id="l44.62" class="difflineplus">+</span>
<a href="#l44.63"></a><span id="l44.63"> function verify_attributes_fundamental(smsg, gmsg) {</span>
<a href="#l44.64"></a><span id="l44.64">   try {</span>
<a href="#l44.65"></a><span id="l44.65">     // save off the message id for test_attributes_fundamental_from_disk</span>
<a href="#l44.66"></a><span id="l44.66">     fundamentalGlodaMessageId = gmsg.id;</span>
<a href="#l44.67"></a><span id="l44.67"> </span>
<a href="#l44.68"></a><span id="l44.68" class="difflineminus">-    do_check_eq(gmsg.folderURI, gLocalInboxFolder.URI);</span>
<a href="#l44.69"></a><span id="l44.69" class="difflineplus">+    do_check_eq(gmsg.folderURI, get_expected_folder_URI());</span>
<a href="#l44.70"></a><span id="l44.70"> </span>
<a href="#l44.71"></a><span id="l44.71">     // -- subject</span>
<a href="#l44.72"></a><span id="l44.72">     do_check_eq(smsg.subject, gmsg.conversation.subject);</span>
<a href="#l44.73"></a><span id="l44.73">     do_check_eq(smsg.subject, gmsg.subject);</span>
<a href="#l44.74"></a><span id="l44.74"> </span>
<a href="#l44.75"></a><span id="l44.75">     // -- contact/identity information</span>
<a href="#l44.76"></a><span id="l44.76">     // - from</span>
<a href="#l44.77"></a><span id="l44.77">     // check the e-mail address</span>
<a href="#l44.78"></a><span id="l44.78" class="difflineat">@@ -92,22 +112,32 @@ function verify_attributes_fundamental(s</span>
<a href="#l44.79"></a><span id="l44.79">     do_check_eq(smsg.fromName, gmsg.from.contact.name);</span>
<a href="#l44.80"></a><span id="l44.80"> </span>
<a href="#l44.81"></a><span id="l44.81">     // - to</span>
<a href="#l44.82"></a><span id="l44.82">     do_check_eq(smsg.toAddress, gmsg.to[0].value);</span>
<a href="#l44.83"></a><span id="l44.83">     do_check_eq(smsg.toName, gmsg.to[0].contact.name);</span>
<a href="#l44.84"></a><span id="l44.84"> </span>
<a href="#l44.85"></a><span id="l44.85">     // date</span>
<a href="#l44.86"></a><span id="l44.86">     do_check_eq(smsg.date.valueOf(), gmsg.date.valueOf());</span>
<a href="#l44.87"></a><span id="l44.87" class="difflineplus">+    </span>
<a href="#l44.88"></a><span id="l44.88" class="difflineplus">+    // -- message ID</span>
<a href="#l44.89"></a><span id="l44.89" class="difflineplus">+    do_check_eq(smsg.messageId, gmsg.headerMessageID);</span>
<a href="#l44.90"></a><span id="l44.90"> </span>
<a href="#l44.91"></a><span id="l44.91" class="difflineminus">-    // -- attachments</span>
<a href="#l44.92"></a><span id="l44.92" class="difflineminus">-    do_check_eq(gmsg.attachmentTypes.length, 1);</span>
<a href="#l44.93"></a><span id="l44.93" class="difflineminus">-    do_check_eq(gmsg.attachmentTypes[0], &quot;text/plain&quot;);</span>
<a href="#l44.94"></a><span id="l44.94" class="difflineminus">-    do_check_eq(gmsg.attachmentNames.length, 1);</span>
<a href="#l44.95"></a><span id="l44.95" class="difflineminus">-    do_check_eq(gmsg.attachmentNames[0], &quot;bob.txt&quot;);</span>
<a href="#l44.96"></a><span id="l44.96" class="difflineplus">+    // -- attachments. We won't have these if we don't have fulltext results</span>
<a href="#l44.97"></a><span id="l44.97" class="difflineplus">+    if (expectFulltextResults) {</span>
<a href="#l44.98"></a><span id="l44.98" class="difflineplus">+      do_check_eq(gmsg.attachmentTypes.length, 1);</span>
<a href="#l44.99"></a><span id="l44.99" class="difflineplus">+      do_check_eq(gmsg.attachmentTypes[0], &quot;text/plain&quot;);</span>
<a href="#l44.100"></a><span id="l44.100" class="difflineplus">+      do_check_eq(gmsg.attachmentNames.length, 1);</span>
<a href="#l44.101"></a><span id="l44.101" class="difflineplus">+      do_check_eq(gmsg.attachmentNames[0], &quot;bob.txt&quot;);</span>
<a href="#l44.102"></a><span id="l44.102" class="difflineplus">+    }</span>
<a href="#l44.103"></a><span id="l44.103" class="difflineplus">+    else {</span>
<a href="#l44.104"></a><span id="l44.104" class="difflineplus">+      // Make sure we don't actually get attachments!</span>
<a href="#l44.105"></a><span id="l44.105" class="difflineplus">+      do_check_eq(gmsg.attachmentTypes, null);</span>
<a href="#l44.106"></a><span id="l44.106" class="difflineplus">+      do_check_eq(gmsg.attachmentNames, null);</span>
<a href="#l44.107"></a><span id="l44.107" class="difflineplus">+    }</span>
<a href="#l44.108"></a><span id="l44.108">   }</span>
<a href="#l44.109"></a><span id="l44.109">   catch (ex) {</span>
<a href="#l44.110"></a><span id="l44.110">     // print out some info on the various states of the messages...</span>
<a href="#l44.111"></a><span id="l44.111">     dump(&quot;***** FUNDAMENTAL ATTRIBUTE NON-MATCH\n&quot;);</span>
<a href="#l44.112"></a><span id="l44.112">     ddumpObject(smsg, &quot;smsg&quot;, 0);</span>
<a href="#l44.113"></a><span id="l44.113">     ddumpObject(gmsg, &quot;gmsg&quot;, 0);</span>
<a href="#l44.114"></a><span id="l44.114">     throw ex;</span>
<a href="#l44.115"></a><span id="l44.115">   }</span>
<a href="#l44.116"></a><span id="l44.116" class="difflineat">@@ -224,17 +254,19 @@ function test_message_moving() {</span>
<a href="#l44.117"></a><span id="l44.117"> /* ===== Message Deletion ===== */</span>
<a href="#l44.118"></a><span id="l44.118"> function test_message_deletion() {</span>
<a href="#l44.119"></a><span id="l44.119"> }</span>
<a href="#l44.120"></a><span id="l44.120"> </span>
<a href="#l44.121"></a><span id="l44.121"> /* ===== Folder Move/Rename/Copy (Single and Nested) ===== */</span>
<a href="#l44.122"></a><span id="l44.122"> </span>
<a href="#l44.123"></a><span id="l44.123"> </span>
<a href="#l44.124"></a><span id="l44.124"> var tests = [</span>
<a href="#l44.125"></a><span id="l44.125" class="difflineplus">+  function pre_test_threading() { pre_test_threading_hook(); },</span>
<a href="#l44.126"></a><span id="l44.126">   test_threading,</span>
<a href="#l44.127"></a><span id="l44.127" class="difflineplus">+  function post_test_threading() { post_test_threading_hook(); },</span>
<a href="#l44.128"></a><span id="l44.128">   test_attributes_fundamental,</span>
<a href="#l44.129"></a><span id="l44.129">   test_attributes_fundamental_from_disk,</span>
<a href="#l44.130"></a><span id="l44.130">   test_attributes_explicit,</span>
<a href="#l44.131"></a><span id="l44.131"> ];</span>
<a href="#l44.132"></a><span id="l44.132"> </span>
<a href="#l44.133"></a><span id="l44.133"> function run_test() {</span>
<a href="#l44.134"></a><span id="l44.134">   glodaHelperRunTests(tests);</span>
<a href="#l44.135"></a><span id="l44.135"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/test_index_messages_in_bulk.js</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_index_messages_in_bulk.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -9,27 +9,40 @@ load(&quot;resources/glodaTestHelper.js&quot;);</span>
<a href="#l45.4"></a><span id="l45.4"> // Create a message generator</span>
<a href="#l45.5"></a><span id="l45.5"> var msgGen = new MessageGenerator();</span>
<a href="#l45.6"></a><span id="l45.6"> // Create a message scenario generator using that message generator</span>
<a href="#l45.7"></a><span id="l45.7"> var scenarios = new MessageScenarioFactory(msgGen);</span>
<a href="#l45.8"></a><span id="l45.8"> </span>
<a href="#l45.9"></a><span id="l45.9"> /**</span>
<a href="#l45.10"></a><span id="l45.10">  * Provide a bunch of messages to be indexed.</span>
<a href="#l45.11"></a><span id="l45.11">  */</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineplus">+var gSynMessages;</span>
<a href="#l45.13"></a><span id="l45.13"> function test_index_a_bunch() {</span>
<a href="#l45.14"></a><span id="l45.14">   // 4-children-per, 3-deep = 21</span>
<a href="#l45.15"></a><span id="l45.15" class="difflineplus">+  // 6-children-per, 3 deep = 43</span>
<a href="#l45.16"></a><span id="l45.16" class="difflineplus">+  // 7-children-per, 3-deep = 57</span>
<a href="#l45.17"></a><span id="l45.17">   // 4-children-per, 4-deep = 85</span>
<a href="#l45.18"></a><span id="l45.18">   // 4-children-per, 5-deep pyramid = 341</span>
<a href="#l45.19"></a><span id="l45.19">   // 5-children-per, 5-deep pyramid = 781</span>
<a href="#l45.20"></a><span id="l45.20">   // 4-children-per, 6-deep pyramid = 1365 messages</span>
<a href="#l45.21"></a><span id="l45.21" class="difflineminus">-  let messages = scenarios.fullPyramid(4, 3);</span>
<a href="#l45.22"></a><span id="l45.22" class="difflineplus">+  gSynMessages = scenarios.fullPyramid(6, 3);</span>
<a href="#l45.23"></a><span id="l45.23">   // we have no need to verify.</span>
<a href="#l45.24"></a><span id="l45.24" class="difflineminus">-  indexMessages(messages, null, next_test);</span>
<a href="#l45.25"></a><span id="l45.25" class="difflineplus">+  indexMessages(gSynMessages, null, next_test);</span>
<a href="#l45.26"></a><span id="l45.26"> }</span>
<a href="#l45.27"></a><span id="l45.27"> </span>
<a href="#l45.28"></a><span id="l45.28" class="difflineplus">+var pre_test_hook = function default_pre_test_hook() {</span>
<a href="#l45.29"></a><span id="l45.29" class="difflineplus">+  next_test();</span>
<a href="#l45.30"></a><span id="l45.30" class="difflineplus">+};</span>
<a href="#l45.31"></a><span id="l45.31" class="difflineplus">+var post_test_hook = function default_post_test_hook() {</span>
<a href="#l45.32"></a><span id="l45.32" class="difflineplus">+  next_test();</span>
<a href="#l45.33"></a><span id="l45.33" class="difflineplus">+};</span>
<a href="#l45.34"></a><span id="l45.34" class="difflineplus">+</span>
<a href="#l45.35"></a><span id="l45.35"> var tests = [</span>
<a href="#l45.36"></a><span id="l45.36" class="difflineplus">+  function pre_test() { pre_test_hook(); },</span>
<a href="#l45.37"></a><span id="l45.37">   test_index_a_bunch,</span>
<a href="#l45.38"></a><span id="l45.38" class="difflineplus">+  function post_test() { post_test_hook(); },</span>
<a href="#l45.39"></a><span id="l45.39"> ];</span>
<a href="#l45.40"></a><span id="l45.40"> </span>
<a href="#l45.41"></a><span id="l45.41"> function run_test() {</span>
<a href="#l45.42"></a><span id="l45.42" class="difflineminus">-  injectMessagesUsing(INJECT_MBOX);</span>
<a href="#l45.43"></a><span id="l45.43">   glodaHelperRunTests(tests);</span>
<a href="#l45.44"></a><span id="l45.44"> }</span>
<a href="#l45.45"></a><span id="l45.45" class="difflineplus">+</span>
<a href="#l45.46"></a><span id="l45.46" class="difflineplus">+injectMessagesUsing(INJECT_MBOX);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1">new file mode 100644</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineminus">--- /dev/null</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_index_non_offline_imap_messages.js</span>
<a href="#l46.4"></a><span id="l46.4" class="difflineat">@@ -0,0 +1,16 @@</span>
<a href="#l46.5"></a><span id="l46.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l46.6"></a><span id="l46.6" class="difflineplus">+/**</span>
<a href="#l46.7"></a><span id="l46.7" class="difflineplus">+ * Tests how well gloda indexes IMAP messages that aren't offline.</span>
<a href="#l46.8"></a><span id="l46.8" class="difflineplus">+ */</span>
<a href="#l46.9"></a><span id="l46.9" class="difflineplus">+</span>
<a href="#l46.10"></a><span id="l46.10" class="difflineplus">+// Most of the definitions are common, so just re-use those</span>
<a href="#l46.11"></a><span id="l46.11" class="difflineplus">+load(&quot;test_index_messages.js&quot;);</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineplus">+</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineplus">+var get_expected_folder_URI = function imap_get_expected_folder_URI() {</span>
<a href="#l46.14"></a><span id="l46.14" class="difflineplus">+  return indexMessageState.imapInbox.URI;</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineplus">+};</span>
<a href="#l46.16"></a><span id="l46.16" class="difflineplus">+</span>
<a href="#l46.17"></a><span id="l46.17" class="difflineplus">+var expectFulltextResults = false;</span>
<a href="#l46.18"></a><span id="l46.18" class="difflineplus">+</span>
<a href="#l46.19"></a><span id="l46.19" class="difflineplus">+// Switch to the IMAP fake server</span>
<a href="#l46.20"></a><span id="l46.20" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1">new file mode 100644</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineminus">--- /dev/null</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_index_non_offline_imap_messages_in_bulk.js</span>
<a href="#l47.4"></a><span id="l47.4" class="difflineat">@@ -0,0 +1,10 @@</span>
<a href="#l47.5"></a><span id="l47.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l47.6"></a><span id="l47.6" class="difflineplus">+/**</span>
<a href="#l47.7"></a><span id="l47.7" class="difflineplus">+ * Tests how well gloda indexes IMAP messages that aren't offline in bulk.</span>
<a href="#l47.8"></a><span id="l47.8" class="difflineplus">+ */</span>
<a href="#l47.9"></a><span id="l47.9" class="difflineplus">+</span>
<a href="#l47.10"></a><span id="l47.10" class="difflineplus">+// The definitions are common, so just re-use those</span>
<a href="#l47.11"></a><span id="l47.11" class="difflineplus">+load(&quot;test_index_messages_in_bulk.js&quot;);</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineplus">+</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+// Switch to the IMAP fake server</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1">new file mode 100644</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineminus">--- /dev/null</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_index_originally_offline_imap_messages.js</span>
<a href="#l48.4"></a><span id="l48.4" class="difflineat">@@ -0,0 +1,19 @@</span>
<a href="#l48.5"></a><span id="l48.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l48.6"></a><span id="l48.6" class="difflineplus">+/**</span>
<a href="#l48.7"></a><span id="l48.7" class="difflineplus">+ * Tests how well gloda indexes IMAP messages that are offline from the start.</span>
<a href="#l48.8"></a><span id="l48.8" class="difflineplus">+ */</span>
<a href="#l48.9"></a><span id="l48.9" class="difflineplus">+</span>
<a href="#l48.10"></a><span id="l48.10" class="difflineplus">+// Most of the definitions are common, so just re-use those</span>
<a href="#l48.11"></a><span id="l48.11" class="difflineplus">+load(&quot;test_index_messages.js&quot;);</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineplus">+</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+var get_expected_folder_URI = function imap_get_expected_folder_URI() {</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineplus">+  return indexMessageState.imapInbox.URI;</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineplus">+};</span>
<a href="#l48.16"></a><span id="l48.16" class="difflineplus">+</span>
<a href="#l48.17"></a><span id="l48.17" class="difflineplus">+var pre_test_threading_hook = function imap_pre_test_threading_hook() {</span>
<a href="#l48.18"></a><span id="l48.18" class="difflineplus">+  indexMessageState.imapInbox.setFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l48.19"></a><span id="l48.19" class="difflineplus">+  next_test();</span>
<a href="#l48.20"></a><span id="l48.20" class="difflineplus">+};</span>
<a href="#l48.21"></a><span id="l48.21" class="difflineplus">+</span>
<a href="#l48.22"></a><span id="l48.22" class="difflineplus">+// Switch to the IMAP fake server</span>
<a href="#l48.23"></a><span id="l48.23" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1">new file mode 100644</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineminus">--- /dev/null</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_index_originally_offline_imap_messages_in_bulk.js</span>
<a href="#l49.4"></a><span id="l49.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l49.5"></a><span id="l49.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l49.6"></a><span id="l49.6" class="difflineplus">+/**</span>
<a href="#l49.7"></a><span id="l49.7" class="difflineplus">+ * Tests how well gloda indexes IMAP messages that aren't offline in bulk.</span>
<a href="#l49.8"></a><span id="l49.8" class="difflineplus">+ */</span>
<a href="#l49.9"></a><span id="l49.9" class="difflineplus">+</span>
<a href="#l49.10"></a><span id="l49.10" class="difflineplus">+// The definitions are common, so just re-use those</span>
<a href="#l49.11"></a><span id="l49.11" class="difflineplus">+load(&quot;test_index_messages_in_bulk.js&quot;);</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineplus">+</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+var pre_test_hook = function imap_pre_test_hook() {</span>
<a href="#l49.14"></a><span id="l49.14" class="difflineplus">+  indexMessageState.imapInbox.setFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l49.15"></a><span id="l49.15" class="difflineplus">+  next_test();</span>
<a href="#l49.16"></a><span id="l49.16" class="difflineplus">+};</span>
<a href="#l49.17"></a><span id="l49.17" class="difflineplus">+</span>
<a href="#l49.18"></a><span id="l49.18" class="difflineplus">+// Switch to the IMAP fake server</span>
<a href="#l49.19"></a><span id="l49.19" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1">new file mode 100644</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineminus">--- /dev/null</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_index_switched_to_offline_imap_messages.js</span>
<a href="#l50.4"></a><span id="l50.4" class="difflineat">@@ -0,0 +1,21 @@</span>
<a href="#l50.5"></a><span id="l50.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l50.6"></a><span id="l50.6" class="difflineplus">+/**</span>
<a href="#l50.7"></a><span id="l50.7" class="difflineplus">+ * Tests how well gloda indexes IMAP messages that are not offline at first, but</span>
<a href="#l50.8"></a><span id="l50.8" class="difflineplus">+ * are made offline later.</span>
<a href="#l50.9"></a><span id="l50.9" class="difflineplus">+ */</span>
<a href="#l50.10"></a><span id="l50.10" class="difflineplus">+</span>
<a href="#l50.11"></a><span id="l50.11" class="difflineplus">+// Most of the definitions are common, so just re-use those</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineplus">+load(&quot;test_index_messages.js&quot;);</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+</span>
<a href="#l50.14"></a><span id="l50.14" class="difflineplus">+var get_expected_folder_URI = function imap_get_expected_folder_URI() {</span>
<a href="#l50.15"></a><span id="l50.15" class="difflineplus">+  return indexMessageState.imapInbox.URI;</span>
<a href="#l50.16"></a><span id="l50.16" class="difflineplus">+};</span>
<a href="#l50.17"></a><span id="l50.17" class="difflineplus">+</span>
<a href="#l50.18"></a><span id="l50.18" class="difflineplus">+var post_test_threading_hook = function imap_post_test_threading_hook() {</span>
<a href="#l50.19"></a><span id="l50.19" class="difflineplus">+  // We aren't concerned about verification here, so just pass in null</span>
<a href="#l50.20"></a><span id="l50.20" class="difflineplus">+  imapDownloadAllMessages(indexMessageState.imapInbox, gSynMessages, null,</span>
<a href="#l50.21"></a><span id="l50.21" class="difflineplus">+                          next_test);</span>
<a href="#l50.22"></a><span id="l50.22" class="difflineplus">+};</span>
<a href="#l50.23"></a><span id="l50.23" class="difflineplus">+</span>
<a href="#l50.24"></a><span id="l50.24" class="difflineplus">+// Switch to the IMAP fake server</span>
<a href="#l50.25"></a><span id="l50.25" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1">new file mode 100644</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineminus">--- /dev/null</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_index_switched_to_offline_imap_messages_in_bulk.js</span>
<a href="#l51.4"></a><span id="l51.4" class="difflineat">@@ -0,0 +1,16 @@</span>
<a href="#l51.5"></a><span id="l51.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l51.6"></a><span id="l51.6" class="difflineplus">+/**</span>
<a href="#l51.7"></a><span id="l51.7" class="difflineplus">+ * Tests how well gloda indexes IMAP messages that aren't offline in bulk.</span>
<a href="#l51.8"></a><span id="l51.8" class="difflineplus">+ */</span>
<a href="#l51.9"></a><span id="l51.9" class="difflineplus">+</span>
<a href="#l51.10"></a><span id="l51.10" class="difflineplus">+// The definitions are common, so just re-use those</span>
<a href="#l51.11"></a><span id="l51.11" class="difflineplus">+load(&quot;test_index_messages_in_bulk.js&quot;);</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineplus">+</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+var post_test_hook = function imap_post_test_hook() {</span>
<a href="#l51.14"></a><span id="l51.14" class="difflineplus">+  // We're not verifying anything</span>
<a href="#l51.15"></a><span id="l51.15" class="difflineplus">+  imapDownloadAllMessages(indexMessageState.imapInbox, gSynMessages,</span>
<a href="#l51.16"></a><span id="l51.16" class="difflineplus">+                          null, next_test);</span>
<a href="#l51.17"></a><span id="l51.17" class="difflineplus">+};</span>
<a href="#l51.18"></a><span id="l51.18" class="difflineplus">+</span>
<a href="#l51.19"></a><span id="l51.19" class="difflineplus">+// Switch to the IMAP fake server</span>
<a href="#l51.20"></a><span id="l51.20" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/test_query_core.js</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_query_core.js</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -236,17 +236,32 @@ function setup_search_ranking_idiom() {</span>
<a href="#l52.4"></a><span id="l52.4">     new Widget(6, daymore, &quot;&quot;, 0, &quot;&quot;, &quot;bar&quot;), // 1 + 0+</span>
<a href="#l52.5"></a><span id="l52.5">     new Widget(5, origin, &quot;&quot;, 1, &quot;&quot;, &quot;bar&quot;), // 2 + 0</span>
<a href="#l52.6"></a><span id="l52.6">     new Widget(4, daymore, &quot;&quot;, 0, &quot;bar&quot;, &quot;bar&quot;), // 2 + 0+</span>
<a href="#l52.7"></a><span id="l52.7">     new Widget(3, origin, &quot;&quot;, 1, &quot;bar&quot;, &quot;baz&quot;), // 3 + 0</span>
<a href="#l52.8"></a><span id="l52.8">     new Widget(2, monthmore, &quot;&quot;, 0, &quot;&quot;, &quot;bar&quot;), // 1 + 4</span>
<a href="#l52.9"></a><span id="l52.9">     new Widget(1, origin, &quot;&quot;, 0, &quot;bar baz&quot;, &quot;bar baz bar bar&quot;), // 6 + 0</span>
<a href="#l52.10"></a><span id="l52.10">     new Widget(0, origin, &quot;&quot;, 1, &quot;bar baz&quot;, &quot;bar baz bar bar&quot;) // 7 + 0</span>
<a href="#l52.11"></a><span id="l52.11">   ];</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-  runOnIndexingComplete(next_test);</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineplus">+  let indexingInProgress = false;</span>
<a href="#l52.15"></a><span id="l52.15" class="difflineplus">+</span>
<a href="#l52.16"></a><span id="l52.16" class="difflineplus">+  // Since we don't use the message indexer listener any more in this test, we</span>
<a href="#l52.17"></a><span id="l52.17" class="difflineplus">+  // need to add our own listener.</span>
<a href="#l52.18"></a><span id="l52.18" class="difflineplus">+  function genericIndexerCallback(aStatus) {</span>
<a href="#l52.19"></a><span id="l52.19" class="difflineplus">+    // If indexingInProgress is false, we've received the synthetic</span>
<a href="#l52.20"></a><span id="l52.20" class="difflineplus">+    // notification, so ignore it</span>
<a href="#l52.21"></a><span id="l52.21" class="difflineplus">+    if (indexingInProgress &amp;&amp; aStatus == Gloda.kIndexerIdle) {</span>
<a href="#l52.22"></a><span id="l52.22" class="difflineplus">+      // We're done, so remove ourselves and move to the next test</span>
<a href="#l52.23"></a><span id="l52.23" class="difflineplus">+      Gloda.removeIndexerListener(genericIndexerCallback);</span>
<a href="#l52.24"></a><span id="l52.24" class="difflineplus">+      next_test();</span>
<a href="#l52.25"></a><span id="l52.25" class="difflineplus">+    }</span>
<a href="#l52.26"></a><span id="l52.26" class="difflineplus">+  }</span>
<a href="#l52.27"></a><span id="l52.27" class="difflineplus">+  Gloda.addIndexerListener(genericIndexerCallback);</span>
<a href="#l52.28"></a><span id="l52.28" class="difflineplus">+  indexingInProgress = true;</span>
<a href="#l52.29"></a><span id="l52.29">   GenericIndexer.indexNewObjects(fooWidgets.concat(barBazWidgets));</span>
<a href="#l52.30"></a><span id="l52.30"> }</span>
<a href="#l52.31"></a><span id="l52.31"> </span>
<a href="#l52.32"></a><span id="l52.32"> // add one because the last snippet shouldn't have a trailing space</span>
<a href="#l52.33"></a><span id="l52.33"> const OFFSET_SCORE_SQL_SNIPPET =</span>
<a href="#l52.34"></a><span id="l52.34">   &quot;(((length(osets) + 1) / &quot; + OFFSET_CHARS_PER_FULLTEXT_MATCH + &quot;) * &quot; +</span>
<a href="#l52.35"></a><span id="l52.35">   SCORE_FOR_FULLTEXT_MATCH + &quot;)&quot;;</span>
<a href="#l52.36"></a><span id="l52.36"> </span>
<a href="#l52.37"></a><span id="l52.37" class="difflineat">@@ -312,12 +327,11 @@ var tests = [</span>
<a href="#l52.38"></a><span id="l52.38">   setup_test_noun_and_attributes,</span>
<a href="#l52.39"></a><span id="l52.39">   test_lots_of_string_constraints,</span>
<a href="#l52.40"></a><span id="l52.40">   setup_search_ranking_idiom,</span>
<a href="#l52.41"></a><span id="l52.41">   test_search_ranking_idiom_offsets,</span>
<a href="#l52.42"></a><span id="l52.42">   test_search_ranking_idiom_score,</span>
<a href="#l52.43"></a><span id="l52.43"> ];</span>
<a href="#l52.44"></a><span id="l52.44"> </span>
<a href="#l52.45"></a><span id="l52.45"> function run_test() {</span>
<a href="#l52.46"></a><span id="l52.46" class="difflineminus">-  // use mbox injection so we get multiple folders...</span>
<a href="#l52.47"></a><span id="l52.47" class="difflineminus">-  injectMessagesUsing(INJECT_MBOX);</span>
<a href="#l52.48"></a><span id="l52.48" class="difflineminus">-  glodaHelperRunTests(tests);</span>
<a href="#l52.49"></a><span id="l52.49" class="difflineplus">+  // Don't initialize the index message state</span>
<a href="#l52.50"></a><span id="l52.50" class="difflineplus">+  glodaHelperRunTests(tests, null, true);</span>
<a href="#l52.51"></a><span id="l52.51"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/test_query_messages.js</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_query_messages.js</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -17,16 +17,22 @@</span>
<a href="#l53.4"></a><span id="l53.4"> </span>
<a href="#l53.5"></a><span id="l53.5"> load(&quot;../../mailnews/resources/messageGenerator.js&quot;);</span>
<a href="#l53.6"></a><span id="l53.6"> load(&quot;resources/glodaTestHelper.js&quot;);</span>
<a href="#l53.7"></a><span id="l53.7"> </span>
<a href="#l53.8"></a><span id="l53.8"> // Create a message generator</span>
<a href="#l53.9"></a><span id="l53.9"> var msgGen = new MessageGenerator();</span>
<a href="#l53.10"></a><span id="l53.10"> // Create a message scenario generator using that message generator</span>
<a href="#l53.11"></a><span id="l53.11"> var scenarios = new MessageScenarioFactory(msgGen);</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineplus">+// Whether we're using a single folder to test. We need to skip a few tests if</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineplus">+// we're doing so</span>
<a href="#l53.14"></a><span id="l53.14" class="difflineplus">+var singleFolder = false;</span>
<a href="#l53.15"></a><span id="l53.15" class="difflineplus">+// Whether we expect fulltext results. IMAP folders that are offline shouldn't</span>
<a href="#l53.16"></a><span id="l53.16" class="difflineplus">+// have their bodies indexed.</span>
<a href="#l53.17"></a><span id="l53.17" class="difflineplus">+var expectFulltextResults = true;</span>
<a href="#l53.18"></a><span id="l53.18"> </span>
<a href="#l53.19"></a><span id="l53.19"> /* ===== Populate ===== */</span>
<a href="#l53.20"></a><span id="l53.20"> var world = {</span>
<a href="#l53.21"></a><span id="l53.21">   phase: 0,</span>
<a href="#l53.22"></a><span id="l53.22"> </span>
<a href="#l53.23"></a><span id="l53.23">   // a list of tuples of [name, email] of length NUM_AUTHORS</span>
<a href="#l53.24"></a><span id="l53.24">   peoples: null,</span>
<a href="#l53.25"></a><span id="l53.25">   NUM_AUTHORS: 5,</span>
<a href="#l53.26"></a><span id="l53.26" class="difflineat">@@ -196,38 +202,56 @@ function generateFolderMessages() {</span>
<a href="#l53.27"></a><span id="l53.27"> function glodaInfoStasher(aSynthMessage, aGlodaMessage) {</span>
<a href="#l53.28"></a><span id="l53.28">   if (aSynthMessage.iConvo !== undefined)</span>
<a href="#l53.29"></a><span id="l53.29">     world.glodaConversationIds[aSynthMessage.iConvo] =</span>
<a href="#l53.30"></a><span id="l53.30">       aGlodaMessage.conversation.id;</span>
<a href="#l53.31"></a><span id="l53.31">   if (world.glodaFolders.length &lt;= world.phase)</span>
<a href="#l53.32"></a><span id="l53.32">     world.glodaFolders.push(aGlodaMessage.folder);</span>
<a href="#l53.33"></a><span id="l53.33"> }</span>
<a href="#l53.34"></a><span id="l53.34"> </span>
<a href="#l53.35"></a><span id="l53.35" class="difflineplus">+// We override these for the IMAP tests</span>
<a href="#l53.36"></a><span id="l53.36" class="difflineplus">+var pre_setup_populate_hook = function default_pre_setup_populate_hook() {</span>
<a href="#l53.37"></a><span id="l53.37" class="difflineplus">+  next_test();</span>
<a href="#l53.38"></a><span id="l53.38" class="difflineplus">+};</span>
<a href="#l53.39"></a><span id="l53.39" class="difflineplus">+var post_setup_populate_hook = function default_post_setup_populate_hook() {</span>
<a href="#l53.40"></a><span id="l53.40" class="difflineplus">+  next_test();</span>
<a href="#l53.41"></a><span id="l53.41" class="difflineplus">+};</span>
<a href="#l53.42"></a><span id="l53.42" class="difflineplus">+</span>
<a href="#l53.43"></a><span id="l53.43" class="difflineplus">+var gSynMessages = [];</span>
<a href="#l53.44"></a><span id="l53.44"> // first, we must populate our message store with delicious messages.</span>
<a href="#l53.45"></a><span id="l53.45"> function setup_populate() {</span>
<a href="#l53.46"></a><span id="l53.46">   world.glodaHolderCollection = Gloda.explicitCollection(Gloda.NOUN_MESSAGE,</span>
<a href="#l53.47"></a><span id="l53.47">     []);</span>
<a href="#l53.48"></a><span id="l53.48"> </span>
<a href="#l53.49"></a><span id="l53.49">   world.peoples = msgGen.makeNamesAndAddresses(world.NUM_AUTHORS);</span>
<a href="#l53.50"></a><span id="l53.50">   world.outlierAuthor = msgGen.makeNameAndAddress();</span>
<a href="#l53.51"></a><span id="l53.51">   world.outlierFriend = msgGen.makeNameAndAddress();</span>
<a href="#l53.52"></a><span id="l53.52">   // set up the per-conversation values with blanks initially</span>
<a href="#l53.53"></a><span id="l53.53">   for (let iConvo = 0; iConvo &lt; world.NUM_CONVERSATIONS; iConvo++) {</span>
<a href="#l53.54"></a><span id="l53.54">     world.lastMessagesInConvos.push(null);</span>
<a href="#l53.55"></a><span id="l53.55">     world.conversationLists.push([]);</span>
<a href="#l53.56"></a><span id="l53.56">     world.glodaConversationIds.push(null);</span>
<a href="#l53.57"></a><span id="l53.57">   }</span>
<a href="#l53.58"></a><span id="l53.58"> </span>
<a href="#l53.59"></a><span id="l53.59" class="difflineminus">-  indexMessages(generateFolderMessages(), glodaInfoStasher,</span>
<a href="#l53.60"></a><span id="l53.60" class="difflineminus">-                setup_populate_phase_two);</span>
<a href="#l53.61"></a><span id="l53.61" class="difflineplus">+  let messages = generateFolderMessages();</span>
<a href="#l53.62"></a><span id="l53.62" class="difflineplus">+  gSynMessages = gSynMessages.concat(messages);</span>
<a href="#l53.63"></a><span id="l53.63" class="difflineplus">+  indexMessages(messages, glodaInfoStasher, setup_populate_phase_two);</span>
<a href="#l53.64"></a><span id="l53.64"> }</span>
<a href="#l53.65"></a><span id="l53.65"> </span>
<a href="#l53.66"></a><span id="l53.66"> function setup_populate_phase_two() {</span>
<a href="#l53.67"></a><span id="l53.67" class="difflineminus">-  world.phase++;</span>
<a href="#l53.68"></a><span id="l53.68" class="difflineminus">-  indexMessages(generateFolderMessages(), glodaInfoStasher, next_test);</span>
<a href="#l53.69"></a><span id="l53.69" class="difflineplus">+  // If we have one folder, we don't attempt to populate the other one</span>
<a href="#l53.70"></a><span id="l53.70" class="difflineplus">+  if (singleFolder) {</span>
<a href="#l53.71"></a><span id="l53.71" class="difflineplus">+    next_test();</span>
<a href="#l53.72"></a><span id="l53.72" class="difflineplus">+  }</span>
<a href="#l53.73"></a><span id="l53.73" class="difflineplus">+  else {</span>
<a href="#l53.74"></a><span id="l53.74" class="difflineplus">+    world.phase++;</span>
<a href="#l53.75"></a><span id="l53.75" class="difflineplus">+    let messages = generateFolderMessages();</span>
<a href="#l53.76"></a><span id="l53.76" class="difflineplus">+    gSynMessages = gSynMessages.concat(messages);</span>
<a href="#l53.77"></a><span id="l53.77" class="difflineplus">+    indexMessages(messages, glodaInfoStasher, next_test);</span>
<a href="#l53.78"></a><span id="l53.78" class="difflineplus">+  }</span>
<a href="#l53.79"></a><span id="l53.79"> }</span>
<a href="#l53.80"></a><span id="l53.80"> </span>
<a href="#l53.81"></a><span id="l53.81"> /* ===== Non-text queries ===== */</span>
<a href="#l53.82"></a><span id="l53.82"> </span>
<a href="#l53.83"></a><span id="l53.83"> /* === messages === */</span>
<a href="#l53.84"></a><span id="l53.84"> </span>
<a href="#l53.85"></a><span id="l53.85"> /**</span>
<a href="#l53.86"></a><span id="l53.86">  * Takes a list of mutually exclusive queries and a list of the resulting</span>
<a href="#l53.87"></a><span id="l53.87" class="difflineat">@@ -289,30 +313,38 @@ function test_query_messages_by_conversa</span>
<a href="#l53.88"></a><span id="l53.88"> var ts_folderNum = 0;</span>
<a href="#l53.89"></a><span id="l53.89"> var ts_folderQueries = [];</span>
<a href="#l53.90"></a><span id="l53.90"> var ts_folderCollections = [];</span>
<a href="#l53.91"></a><span id="l53.91"> /**</span>
<a href="#l53.92"></a><span id="l53.92">  * @tests gloda.noun.message.attr.folder</span>
<a href="#l53.93"></a><span id="l53.93">  * @tests gloda.datastore.sqlgen.kConstraintIn</span>
<a href="#l53.94"></a><span id="l53.94">  */</span>
<a href="#l53.95"></a><span id="l53.95"> function test_query_messages_by_folder() {</span>
<a href="#l53.96"></a><span id="l53.96" class="difflineplus">+  // If we have one folder to test with, we can't do this test more times</span>
<a href="#l53.97"></a><span id="l53.97" class="difflineplus">+  if (singleFolder &amp;&amp; ts_folderNum &gt;= 1) {</span>
<a href="#l53.98"></a><span id="l53.98" class="difflineplus">+    next_test();</span>
<a href="#l53.99"></a><span id="l53.99" class="difflineplus">+    return;</span>
<a href="#l53.100"></a><span id="l53.100" class="difflineplus">+  }</span>
<a href="#l53.101"></a><span id="l53.101" class="difflineplus">+</span>
<a href="#l53.102"></a><span id="l53.102">   let folderNum = ts_folderNum++;</span>
<a href="#l53.103"></a><span id="l53.103">   let query = Gloda.newQuery(Gloda.NOUN_MESSAGE);</span>
<a href="#l53.104"></a><span id="l53.104">   query.folder(world.glodaFolders[folderNum]);</span>
<a href="#l53.105"></a><span id="l53.105"> </span>
<a href="#l53.106"></a><span id="l53.106">   ts_folderQueries.push(query);</span>
<a href="#l53.107"></a><span id="l53.107">   ts_folderCollections.push(queryExpect(query, world.folderClumps[folderNum]));</span>
<a href="#l53.108"></a><span id="l53.108">   // queryExpect calls next_test</span>
<a href="#l53.109"></a><span id="l53.109"> }</span>
<a href="#l53.110"></a><span id="l53.110"> </span>
<a href="#l53.111"></a><span id="l53.111"> /**</span>
<a href="#l53.112"></a><span id="l53.112">  * @tests gloda.query.test.kConstraintIn</span>
<a href="#l53.113"></a><span id="l53.113">  */</span>
<a href="#l53.114"></a><span id="l53.114"> function test_query_messages_by_folder_nonmatches() {</span>
<a href="#l53.115"></a><span id="l53.115" class="difflineminus">-  verify_nonMatches(ts_folderQueries, ts_folderCollections);</span>
<a href="#l53.116"></a><span id="l53.116" class="difflineplus">+  // No can do with one folder</span>
<a href="#l53.117"></a><span id="l53.117" class="difflineplus">+  if (!singleFolder)</span>
<a href="#l53.118"></a><span id="l53.118" class="difflineplus">+    verify_nonMatches(ts_folderQueries, ts_folderCollections);</span>
<a href="#l53.119"></a><span id="l53.119">   next_test();</span>
<a href="#l53.120"></a><span id="l53.120"> }</span>
<a href="#l53.121"></a><span id="l53.121"> </span>
<a href="#l53.122"></a><span id="l53.122"> /**</span>
<a href="#l53.123"></a><span id="l53.123">  * @tests Gloda.ns.getMessageCollectionForHeader()</span>
<a href="#l53.124"></a><span id="l53.124">  */</span>
<a href="#l53.125"></a><span id="l53.125"> function test_get_message_for_header() {</span>
<a href="#l53.126"></a><span id="l53.126">   // pick an arbitrary message</span>
<a href="#l53.127"></a><span id="l53.127" class="difflineat">@@ -453,32 +485,34 @@ dump(&quot;convNum: &quot; + convNum + &quot; blah: &quot; +</span>
<a href="#l53.128"></a><span id="l53.128">  */</span>
<a href="#l53.129"></a><span id="l53.129"> function test_query_messages_by_body_text() {</span>
<a href="#l53.130"></a><span id="l53.130">   // we only need to use one conversation</span>
<a href="#l53.131"></a><span id="l53.131">   let convNum = 0;</span>
<a href="#l53.132"></a><span id="l53.132">   let query = Gloda.newQuery(Gloda.NOUN_MESSAGE);</span>
<a href="#l53.133"></a><span id="l53.133">   let convBodyTerm = uniqueTermGenerator(</span>
<a href="#l53.134"></a><span id="l53.134">     UNIQUE_OFFSET_BODY + UNIQUE_OFFSET_CONV + convNum);</span>
<a href="#l53.135"></a><span id="l53.135">   query.bodyMatches(convBodyTerm);</span>
<a href="#l53.136"></a><span id="l53.136" class="difflineminus">-  queryExpect(query, world.conversationLists[convNum]); // calls next_test</span>
<a href="#l53.137"></a><span id="l53.137" class="difflineplus">+  queryExpect(query, expectFulltextResults ? world.conversationLists[convNum] :</span>
<a href="#l53.138"></a><span id="l53.138" class="difflineplus">+                                             []); // calls next_test</span>
<a href="#l53.139"></a><span id="l53.139"> }</span>
<a href="#l53.140"></a><span id="l53.140"> </span>
<a href="#l53.141"></a><span id="l53.141"> /**</span>
<a href="#l53.142"></a><span id="l53.142">  * Test attachment name searching using the conversation unique attachment term.</span>
<a href="#l53.143"></a><span id="l53.143">  *</span>
<a href="#l53.144"></a><span id="l53.144">  * @tests gloda.noun.message.attr.attachmentNamesMatch</span>
<a href="#l53.145"></a><span id="l53.145">  * @tests gloda.datastore.sqlgen.kConstraintFulltext</span>
<a href="#l53.146"></a><span id="l53.146">  */</span>
<a href="#l53.147"></a><span id="l53.147"> function test_query_messages_by_attachment_names() {</span>
<a href="#l53.148"></a><span id="l53.148">   let convNum = 0;</span>
<a href="#l53.149"></a><span id="l53.149">   let query = Gloda.newQuery(Gloda.NOUN_MESSAGE);</span>
<a href="#l53.150"></a><span id="l53.150">   let convUniqueAttachment = uniqueTermGenerator(</span>
<a href="#l53.151"></a><span id="l53.151">     UNIQUE_OFFSET_ATTACHMENT + UNIQUE_OFFSET_CONV + convNum);</span>
<a href="#l53.152"></a><span id="l53.152">   query.attachmentNamesMatch(convUniqueAttachment);</span>
<a href="#l53.153"></a><span id="l53.153" class="difflineminus">-  queryExpect(query, world.conversationLists[convNum]); // calls next_test</span>
<a href="#l53.154"></a><span id="l53.154" class="difflineplus">+  queryExpect(query, expectFulltextResults ? world.conversationLists[convNum] :</span>
<a href="#l53.155"></a><span id="l53.155" class="difflineplus">+                                             []); // calls next_test</span>
<a href="#l53.156"></a><span id="l53.156"> }</span>
<a href="#l53.157"></a><span id="l53.157"> </span>
<a href="#l53.158"></a><span id="l53.158"> /**</span>
<a href="#l53.159"></a><span id="l53.159">  * Test author name fulltext searching using an arbitrary author.</span>
<a href="#l53.160"></a><span id="l53.160">  *</span>
<a href="#l53.161"></a><span id="l53.161">  * @tests gloda.noun.message.attr.authorMatches</span>
<a href="#l53.162"></a><span id="l53.162">  * @tests gloda.datastore.sqlgen.kConstraintFulltext</span>
<a href="#l53.163"></a><span id="l53.163">  */</span>
<a href="#l53.164"></a><span id="l53.164" class="difflineat">@@ -590,17 +624,19 @@ function test_query_identities_by_kind_a</span>
<a href="#l53.165"></a><span id="l53.165">                     [peoplesIdentityCollection, outlierIdentityCollection]);</span>
<a href="#l53.166"></a><span id="l53.166">   next_test();</span>
<a href="#l53.167"></a><span id="l53.167"> }</span>
<a href="#l53.168"></a><span id="l53.168"> </span>
<a href="#l53.169"></a><span id="l53.169"> </span>
<a href="#l53.170"></a><span id="l53.170"> /* ===== Driver ===== */</span>
<a href="#l53.171"></a><span id="l53.171"> </span>
<a href="#l53.172"></a><span id="l53.172"> var tests = [</span>
<a href="#l53.173"></a><span id="l53.173" class="difflineplus">+  function pre_setup_populate() { pre_setup_populate_hook(); },</span>
<a href="#l53.174"></a><span id="l53.174">   setup_populate,</span>
<a href="#l53.175"></a><span id="l53.175" class="difflineplus">+  function post_setup_populate() { post_setup_populate_hook(); },</span>
<a href="#l53.176"></a><span id="l53.176">   test_query_messages_by_conversation,</span>
<a href="#l53.177"></a><span id="l53.177">   test_query_messages_by_conversation,</span>
<a href="#l53.178"></a><span id="l53.178">   test_query_messages_by_conversation_nonmatches,</span>
<a href="#l53.179"></a><span id="l53.179">   test_query_messages_by_folder,</span>
<a href="#l53.180"></a><span id="l53.180">   test_query_messages_by_folder,</span>
<a href="#l53.181"></a><span id="l53.181">   test_query_messages_by_folder_nonmatches,</span>
<a href="#l53.182"></a><span id="l53.182">   test_get_message_for_header,</span>
<a href="#l53.183"></a><span id="l53.183">   test_get_messages_for_headers,</span>
<a href="#l53.184"></a><span id="l53.184" class="difflineat">@@ -624,12 +660,13 @@ var tests = [</span>
<a href="#l53.185"></a><span id="l53.185">   test_query_messages_by_recipients_name,</span>
<a href="#l53.186"></a><span id="l53.186">   test_query_messages_by_recipients_email,</span>
<a href="#l53.187"></a><span id="l53.187">   // like</span>
<a href="#l53.188"></a><span id="l53.188">   test_query_contacts_by_name,</span>
<a href="#l53.189"></a><span id="l53.189">   test_query_contacts_by_name_nonmatch</span>
<a href="#l53.190"></a><span id="l53.190"> ];</span>
<a href="#l53.191"></a><span id="l53.191"> </span>
<a href="#l53.192"></a><span id="l53.192"> function run_test() {</span>
<a href="#l53.193"></a><span id="l53.193" class="difflineminus">-  // use mbox injection so we get multiple folders...</span>
<a href="#l53.194"></a><span id="l53.194" class="difflineminus">-  injectMessagesUsing(INJECT_MBOX);</span>
<a href="#l53.195"></a><span id="l53.195">   glodaHelperRunTests(tests);</span>
<a href="#l53.196"></a><span id="l53.196"> }</span>
<a href="#l53.197"></a><span id="l53.197" class="difflineplus">+</span>
<a href="#l53.198"></a><span id="l53.198" class="difflineplus">+// use mbox injection so we get multiple folders...</span>
<a href="#l53.199"></a><span id="l53.199" class="difflineplus">+injectMessagesUsing(INJECT_MBOX);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1">new file mode 100644</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineminus">--- /dev/null</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_query_non_offline_imap_messages.js</span>
<a href="#l54.4"></a><span id="l54.4" class="difflineat">@@ -0,0 +1,10 @@</span>
<a href="#l54.5"></a><span id="l54.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l54.6"></a><span id="l54.6" class="difflineplus">+/**</span>
<a href="#l54.7"></a><span id="l54.7" class="difflineplus">+ * Test query support for IMAP messages that aren't offline.</span>
<a href="#l54.8"></a><span id="l54.8" class="difflineplus">+ */</span>
<a href="#l54.9"></a><span id="l54.9" class="difflineplus">+load(&quot;test_query_messages.js&quot;);</span>
<a href="#l54.10"></a><span id="l54.10" class="difflineplus">+</span>
<a href="#l54.11"></a><span id="l54.11" class="difflineplus">+var expectFulltextResults = false;</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineplus">+// TODO: Make this use multiple folders, like the local folders test</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineplus">+var singleFolder = true;</span>
<a href="#l54.14"></a><span id="l54.14" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1">new file mode 100644</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineminus">--- /dev/null</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_query_originally_offline_imap_messages.js</span>
<a href="#l55.4"></a><span id="l55.4" class="difflineat">@@ -0,0 +1,16 @@</span>
<a href="#l55.5"></a><span id="l55.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l55.6"></a><span id="l55.6" class="difflineplus">+/**</span>
<a href="#l55.7"></a><span id="l55.7" class="difflineplus">+ * Test query support for IMAP messages that were offline before they were</span>
<a href="#l55.8"></a><span id="l55.8" class="difflineplus">+ * indexed.</span>
<a href="#l55.9"></a><span id="l55.9" class="difflineplus">+ */</span>
<a href="#l55.10"></a><span id="l55.10" class="difflineplus">+load(&quot;test_query_messages.js&quot;);</span>
<a href="#l55.11"></a><span id="l55.11" class="difflineplus">+</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineplus">+// Set the inbox to offline before proceeding</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+var pre_setup_populate_hook = function imap_pre_setup_populate_hook() {</span>
<a href="#l55.14"></a><span id="l55.14" class="difflineplus">+  indexMessageState.imapInbox.setFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l55.15"></a><span id="l55.15" class="difflineplus">+  next_test();</span>
<a href="#l55.16"></a><span id="l55.16" class="difflineplus">+};</span>
<a href="#l55.17"></a><span id="l55.17" class="difflineplus">+</span>
<a href="#l55.18"></a><span id="l55.18" class="difflineplus">+// TODO: Make this use multiple folders, like the local folders test</span>
<a href="#l55.19"></a><span id="l55.19" class="difflineplus">+var singleFolder = true;</span>
<a href="#l55.20"></a><span id="l55.20" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1">new file mode 100644</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineminus">--- /dev/null</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_query_switched_to_offline_imap_messages.js</span>
<a href="#l56.4"></a><span id="l56.4" class="difflineat">@@ -0,0 +1,19 @@</span>
<a href="#l56.5"></a><span id="l56.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l56.6"></a><span id="l56.6" class="difflineplus">+/**</span>
<a href="#l56.7"></a><span id="l56.7" class="difflineplus">+ * Test query support for IMAP messages that were indexed, then made available</span>
<a href="#l56.8"></a><span id="l56.8" class="difflineplus">+ * offline.</span>
<a href="#l56.9"></a><span id="l56.9" class="difflineplus">+ */</span>
<a href="#l56.10"></a><span id="l56.10" class="difflineplus">+load(&quot;test_query_messages.js&quot;);</span>
<a href="#l56.11"></a><span id="l56.11" class="difflineplus">+</span>
<a href="#l56.12"></a><span id="l56.12" class="difflineplus">+/**</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineplus">+ * Set the imap folder to offline after adding the messages, then force a</span>
<a href="#l56.14"></a><span id="l56.14" class="difflineplus">+ * download of all messages.</span>
<a href="#l56.15"></a><span id="l56.15" class="difflineplus">+ */</span>
<a href="#l56.16"></a><span id="l56.16" class="difflineplus">+var post_setup_populate_hook = function imap_post_setup_populate_hook() {</span>
<a href="#l56.17"></a><span id="l56.17" class="difflineplus">+  imapDownloadAllMessages(indexMessageState.imapInbox, gSynMessages, null,</span>
<a href="#l56.18"></a><span id="l56.18" class="difflineplus">+                          next_test);</span>
<a href="#l56.19"></a><span id="l56.19" class="difflineplus">+};</span>
<a href="#l56.20"></a><span id="l56.20" class="difflineplus">+</span>
<a href="#l56.21"></a><span id="l56.21" class="difflineplus">+// TODO: Make this use multiple folders, like the local folders test</span>
<a href="#l56.22"></a><span id="l56.22" class="difflineplus">+var singleFolder = true;</span>
<a href="#l56.23"></a><span id="l56.23" class="difflineplus">+injectMessagesUsing(INJECT_IMAP_FAKE_SERVER);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -237,17 +237,17 @@ interface nsIMsgDBService : nsISupports</span>
<a href="#l57.4"></a><span id="l57.4">    *</span>
<a href="#l57.5"></a><span id="l57.5">    * @param aFolder   The folder to get the cached (open) db for.</span>
<a href="#l57.6"></a><span id="l57.6">    *</span>
<a href="#l57.7"></a><span id="l57.7">    * @returns         null if the db isn't open, otherwise the db.</span>
<a href="#l57.8"></a><span id="l57.8">    */</span>
<a href="#l57.9"></a><span id="l57.9">   nsIMsgDatabase cachedDBForFolder(in nsIMsgFolder aFolder);</span>
<a href="#l57.10"></a><span id="l57.10"> };</span>
<a href="#l57.11"></a><span id="l57.11"> </span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-[scriptable, uuid(51fd11c9-5be6-4cad-af6b-fb18d6232be4)]</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+[scriptable, uuid(231E3473-DA59-4d18-AD54-F5A9D24AE3FC)]</span>
<a href="#l57.14"></a><span id="l57.14"> interface nsIMsgDatabase : nsIDBChangeAnnouncer {</span>
<a href="#l57.15"></a><span id="l57.15">   /**</span>
<a href="#l57.16"></a><span id="l57.16">    * Opens a database folder.</span>
<a href="#l57.17"></a><span id="l57.17">    *</span>
<a href="#l57.18"></a><span id="l57.18">    * @param aFolderName     The name of the folder to create.</span>
<a href="#l57.19"></a><span id="l57.19">    * @param aCreate         Whether or not the file should be created.</span>
<a href="#l57.20"></a><span id="l57.20">    * @param aLeaveInvalidDB Set to true if you do not want the database to be</span>
<a href="#l57.21"></a><span id="l57.21">    *                        deleted if it is invalid.</span>
<a href="#l57.22"></a><span id="l57.22" class="difflineat">@@ -338,16 +338,24 @@ interface nsIMsgDatabase : nsIDBChangeAn</span>
<a href="#l57.23"></a><span id="l57.23">   void MarkHdrRead(in nsIMsgDBHdr msgHdr, in boolean bRead,</span>
<a href="#l57.24"></a><span id="l57.24">                          in nsIDBChangeListener instigator);</span>
<a href="#l57.25"></a><span id="l57.25"> </span>
<a href="#l57.26"></a><span id="l57.26">   void MarkHdrReplied(in nsIMsgDBHdr msgHdr, in boolean bReplied,</span>
<a href="#l57.27"></a><span id="l57.27">                          in nsIDBChangeListener instigator);</span>
<a href="#l57.28"></a><span id="l57.28"> </span>
<a href="#l57.29"></a><span id="l57.29">   void MarkHdrMarked(in nsIMsgDBHdr msgHdr, in boolean mark,</span>
<a href="#l57.30"></a><span id="l57.30">                          in nsIDBChangeListener instigator);</span>
<a href="#l57.31"></a><span id="l57.31" class="difflineplus">+  /**</span>
<a href="#l57.32"></a><span id="l57.32" class="difflineplus">+   * Remove the new status from a message.</span>
<a href="#l57.33"></a><span id="l57.33" class="difflineplus">+   *</span>
<a href="#l57.34"></a><span id="l57.34" class="difflineplus">+   * @param aMsgHdr        The database reference header for the message</span>
<a href="#l57.35"></a><span id="l57.35" class="difflineplus">+   * @param aInstigator    Reference to original calling object</span>
<a href="#l57.36"></a><span id="l57.36" class="difflineplus">+   */</span>
<a href="#l57.37"></a><span id="l57.37" class="difflineplus">+  void MarkHdrNotNew(in nsIMsgDBHdr aMsgHdr,</span>
<a href="#l57.38"></a><span id="l57.38" class="difflineplus">+                     in nsIDBChangeListener aInstigator);</span>
<a href="#l57.39"></a><span id="l57.39"> </span>
<a href="#l57.40"></a><span id="l57.40">   // MDN support</span>
<a href="#l57.41"></a><span id="l57.41">   void MarkMDNNeeded(in nsMsgKey key, in boolean bNeeded,</span>
<a href="#l57.42"></a><span id="l57.42">                            in nsIDBChangeListener instigator);</span>
<a href="#l57.43"></a><span id="l57.43"> </span>
<a href="#l57.44"></a><span id="l57.44">   // MarkMDNneeded only used when mail server is a POP3 server</span>
<a href="#l57.45"></a><span id="l57.45">   // or when the IMAP server does not support user defined</span>
<a href="#l57.46"></a><span id="l57.46">   // PERMANENTFLAGS</span>
<a href="#l57.47"></a><span id="l57.47" class="difflineat">@@ -402,25 +410,35 @@ interface nsIMsgDatabase : nsIDBChangeAn</span>
<a href="#l57.48"></a><span id="l57.48">   void UndoDelete(in nsIMsgDBHdr msgHdr);</span>
<a href="#l57.49"></a><span id="l57.49"> </span>
<a href="#l57.50"></a><span id="l57.50">   void MarkMarked(in nsMsgKey key, in boolean mark,</span>
<a href="#l57.51"></a><span id="l57.51">                         in nsIDBChangeListener instigator);</span>
<a href="#l57.52"></a><span id="l57.52">   void MarkOffline(in nsMsgKey key, in boolean offline,</span>
<a href="#l57.53"></a><span id="l57.53">                          in nsIDBChangeListener instigator);</span>
<a href="#l57.54"></a><span id="l57.54">   void SetLabel(in nsMsgKey key, in nsMsgLabelValue label);</span>
<a href="#l57.55"></a><span id="l57.55">   void setStringProperty(in nsMsgKey aKey, in string aProperty, in string aValue);</span>
<a href="#l57.56"></a><span id="l57.56" class="difflineminus">-  /*</span>
<a href="#l57.57"></a><span id="l57.57" class="difflineplus">+  /**</span>
<a href="#l57.58"></a><span id="l57.58">    * Set the value of a string property in a message header</span>
<a href="#l57.59"></a><span id="l57.59">    *</span>
<a href="#l57.60"></a><span id="l57.60">    * @param msgHdr    Header of the message whose property will be changed</span>
<a href="#l57.61"></a><span id="l57.61">    * @param aProperty the property to change</span>
<a href="#l57.62"></a><span id="l57.62">    * @param aValue    new value for the property</span>
<a href="#l57.63"></a><span id="l57.63">    */</span>
<a href="#l57.64"></a><span id="l57.64">   void setStringPropertyByHdr(in nsIMsgDBHdr msgHdr, in string aProperty, in string aValue);</span>
<a href="#l57.65"></a><span id="l57.65"> </span>
<a href="#l57.66"></a><span id="l57.66" class="difflineplus">+  /**</span>
<a href="#l57.67"></a><span id="l57.67" class="difflineplus">+   * Set the value of a uint32 property in a message header.</span>
<a href="#l57.68"></a><span id="l57.68" class="difflineplus">+   *</span>
<a href="#l57.69"></a><span id="l57.69" class="difflineplus">+   * @param aMsgHdr   header of the message whose property will be changed</span>
<a href="#l57.70"></a><span id="l57.70" class="difflineplus">+   * @param aProperty the property to change</span>
<a href="#l57.71"></a><span id="l57.71" class="difflineplus">+   * @param aValue    new value for the property</span>
<a href="#l57.72"></a><span id="l57.72" class="difflineplus">+   */</span>
<a href="#l57.73"></a><span id="l57.73" class="difflineplus">+  void setUint32PropertyByHdr(in nsIMsgDBHdr aMsgHdr,</span>
<a href="#l57.74"></a><span id="l57.74" class="difflineplus">+                              in string aProperty, in unsigned long aValue);</span>
<a href="#l57.75"></a><span id="l57.75" class="difflineplus">+</span>
<a href="#l57.76"></a><span id="l57.76">   void MarkImapDeleted(in nsMsgKey key, in boolean deleted,</span>
<a href="#l57.77"></a><span id="l57.77">                              in nsIDBChangeListener instigator);</span>
<a href="#l57.78"></a><span id="l57.78"> </span>
<a href="#l57.79"></a><span id="l57.79">   readonly attribute nsMsgKey FirstNew;</span>
<a href="#l57.80"></a><span id="l57.80"> </span>
<a href="#l57.81"></a><span id="l57.81">   attribute nsIMsgRetentionSettings msgRetentionSettings;</span>
<a href="#l57.82"></a><span id="l57.82">   // purge unwanted message headers and/or bodies. If deleteViaFolder is</span>
<a href="#l57.83"></a><span id="l57.83">   // true, we'll call nsIMsgFolder::DeleteMessages to delete the messages.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMsgDatabase.h</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMsgDatabase.h</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -399,17 +399,16 @@ public:</span>
<a href="#l58.4"></a><span id="l58.4">   virtual ~nsMsgRetentionSettings();</span>
<a href="#l58.5"></a><span id="l58.5"> </span>
<a href="#l58.6"></a><span id="l58.6">   NS_DECL_ISUPPORTS</span>
<a href="#l58.7"></a><span id="l58.7">   NS_DECL_NSIMSGRETENTIONSETTINGS</span>
<a href="#l58.8"></a><span id="l58.8"> protected:</span>
<a href="#l58.9"></a><span id="l58.9">   nsMsgRetainByPreference m_retainByPreference;</span>
<a href="#l58.10"></a><span id="l58.10">   PRUint32                m_daysToKeepHdrs;</span>
<a href="#l58.11"></a><span id="l58.11">   PRUint32                m_numHeadersToKeep;</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-  PRUint32                m_keepUnreadMessagesProp;</span>
<a href="#l58.13"></a><span id="l58.13">   PRBool                  m_keepUnreadMessagesOnly;</span>
<a href="#l58.14"></a><span id="l58.14">   PRBool                  m_useServerDefaults;</span>
<a href="#l58.15"></a><span id="l58.15">   PRBool                  m_cleanupBodiesByDays;</span>
<a href="#l58.16"></a><span id="l58.16">   PRUint32                m_daysToKeepBodies;</span>
<a href="#l58.17"></a><span id="l58.17">   PRBool                  m_applyToFlaggedMessages;</span>
<a href="#l58.18"></a><span id="l58.18"> };</span>
<a href="#l58.19"></a><span id="l58.19"> </span>
<a href="#l58.20"></a><span id="l58.20"> class nsMsgDownloadSettings : public nsIMsgDownloadSettings</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -676,17 +676,30 @@ NS_IMETHODIMP nsMsgDatabase::RemoveListe</span>
<a href="#l59.4"></a><span id="l59.4">   PR_END_MACRO</span>
<a href="#l59.5"></a><span id="l59.5"> </span>
<a href="#l59.6"></a><span id="l59.6"> // change announcer methods - just broadcast to all listeners.</span>
<a href="#l59.7"></a><span id="l59.7"> NS_IMETHODIMP nsMsgDatabase::NotifyHdrChangeAll(nsIMsgDBHdr *aHdrChanged,</span>
<a href="#l59.8"></a><span id="l59.8">                                                 PRUint32 aOldFlags,</span>
<a href="#l59.9"></a><span id="l59.9">                                                 PRUint32 aNewFlags,</span>
<a href="#l59.10"></a><span id="l59.10">                                                 nsIDBChangeListener *aInstigator)</span>
<a href="#l59.11"></a><span id="l59.11"> {</span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-  NOTIFY_LISTENERS(OnHdrFlagsChanged, (aHdrChanged, aOldFlags, aNewFlags, aInstigator));</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineplus">+  // We will only notify the change if the header exists in the database.</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineplus">+  // This allows database functions to be usable in both the case where the</span>
<a href="#l59.15"></a><span id="l59.15" class="difflineplus">+  // header is in the db, or the header is not so no notifications should be</span>
<a href="#l59.16"></a><span id="l59.16" class="difflineplus">+  // given.</span>
<a href="#l59.17"></a><span id="l59.17" class="difflineplus">+  nsMsgKey key;</span>
<a href="#l59.18"></a><span id="l59.18" class="difflineplus">+  PRBool inDb = PR_FALSE;</span>
<a href="#l59.19"></a><span id="l59.19" class="difflineplus">+  if (aHdrChanged)</span>
<a href="#l59.20"></a><span id="l59.20" class="difflineplus">+  {</span>
<a href="#l59.21"></a><span id="l59.21" class="difflineplus">+    aHdrChanged-&gt;GetMessageKey(&amp;key);</span>
<a href="#l59.22"></a><span id="l59.22" class="difflineplus">+    ContainsKey(key, &amp;inDb);</span>
<a href="#l59.23"></a><span id="l59.23" class="difflineplus">+  }</span>
<a href="#l59.24"></a><span id="l59.24" class="difflineplus">+  if (inDb)</span>
<a href="#l59.25"></a><span id="l59.25" class="difflineplus">+    NOTIFY_LISTENERS(OnHdrFlagsChanged,</span>
<a href="#l59.26"></a><span id="l59.26" class="difflineplus">+                     (aHdrChanged, aOldFlags, aNewFlags, aInstigator));</span>
<a href="#l59.27"></a><span id="l59.27">   return NS_OK;</span>
<a href="#l59.28"></a><span id="l59.28"> }</span>
<a href="#l59.29"></a><span id="l59.29"> </span>
<a href="#l59.30"></a><span id="l59.30"> NS_IMETHODIMP nsMsgDatabase::NotifyReadChanged(nsIDBChangeListener *aInstigator)</span>
<a href="#l59.31"></a><span id="l59.31"> {</span>
<a href="#l59.32"></a><span id="l59.32">   NOTIFY_LISTENERS(OnReadChanged, (aInstigator));</span>
<a href="#l59.33"></a><span id="l59.33">   return NS_OK;</span>
<a href="#l59.34"></a><span id="l59.34"> }</span>
<a href="#l59.35"></a><span id="l59.35" class="difflineat">@@ -2181,16 +2194,69 @@ NS_IMETHODIMP nsMsgDatabase::SetStringPr</span>
<a href="#l59.36"></a><span id="l59.36">       listener-&gt;OnHdrPropertyChanged(msgHdr, PR_FALSE, &amp;status, nsnull);</span>
<a href="#l59.37"></a><span id="l59.37">       // ignore errors</span>
<a href="#l59.38"></a><span id="l59.38">     }</span>
<a href="#l59.39"></a><span id="l59.39">   }</span>
<a href="#l59.40"></a><span id="l59.40"> </span>
<a href="#l59.41"></a><span id="l59.41">   return NS_OK;</span>
<a href="#l59.42"></a><span id="l59.42"> }</span>
<a href="#l59.43"></a><span id="l59.43"> </span>
<a href="#l59.44"></a><span id="l59.44" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l59.45"></a><span id="l59.45" class="difflineplus">+nsMsgDatabase::SetUint32PropertyByHdr(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l59.46"></a><span id="l59.46" class="difflineplus">+                                      const char *aProperty,</span>
<a href="#l59.47"></a><span id="l59.47" class="difflineplus">+                                      PRUint32 aValue)</span>
<a href="#l59.48"></a><span id="l59.48" class="difflineplus">+{</span>
<a href="#l59.49"></a><span id="l59.49" class="difflineplus">+  // If no change to this property, bail out.</span>
<a href="#l59.50"></a><span id="l59.50" class="difflineplus">+  PRUint32 oldValue;</span>
<a href="#l59.51"></a><span id="l59.51" class="difflineplus">+  nsresult rv = aMsgHdr-&gt;GetUint32Property(aProperty, &amp;oldValue);</span>
<a href="#l59.52"></a><span id="l59.52" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l59.53"></a><span id="l59.53" class="difflineplus">+  if (oldValue == aValue)</span>
<a href="#l59.54"></a><span id="l59.54" class="difflineplus">+    return NS_OK;</span>
<a href="#l59.55"></a><span id="l59.55" class="difflineplus">+</span>
<a href="#l59.56"></a><span id="l59.56" class="difflineplus">+  // Don't do notifications if message not yet added to database.</span>
<a href="#l59.57"></a><span id="l59.57" class="difflineplus">+  PRBool notify = PR_TRUE;  </span>
<a href="#l59.58"></a><span id="l59.58" class="difflineplus">+  nsMsgKey key = nsMsgKey_None;</span>
<a href="#l59.59"></a><span id="l59.59" class="difflineplus">+  aMsgHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l59.60"></a><span id="l59.60" class="difflineplus">+  ContainsKey(key, &amp;notify);</span>
<a href="#l59.61"></a><span id="l59.61" class="difflineplus">+</span>
<a href="#l59.62"></a><span id="l59.62" class="difflineplus">+  // Precall OnHdrPropertyChanged to store prechange status.</span>
<a href="#l59.63"></a><span id="l59.63" class="difflineplus">+  nsTArray&lt;PRUint32&gt; statusArray(m_ChangeListeners.Length());</span>
<a href="#l59.64"></a><span id="l59.64" class="difflineplus">+  PRUint32 status;</span>
<a href="#l59.65"></a><span id="l59.65" class="difflineplus">+  nsCOMPtr&lt;nsIDBChangeListener&gt; listener;</span>
<a href="#l59.66"></a><span id="l59.66" class="difflineplus">+  if (notify)</span>
<a href="#l59.67"></a><span id="l59.67" class="difflineplus">+  {</span>
<a href="#l59.68"></a><span id="l59.68" class="difflineplus">+    nsTObserverArray&lt;nsCOMPtr&lt;nsIDBChangeListener&gt; &gt;::ForwardIterator listeners(m_ChangeListeners);</span>
<a href="#l59.69"></a><span id="l59.69" class="difflineplus">+    while (listeners.HasMore())</span>
<a href="#l59.70"></a><span id="l59.70" class="difflineplus">+    {</span>
<a href="#l59.71"></a><span id="l59.71" class="difflineplus">+      listener = listeners.GetNext();</span>
<a href="#l59.72"></a><span id="l59.72" class="difflineplus">+      listener-&gt;OnHdrPropertyChanged(aMsgHdr, PR_TRUE, &amp;status, nsnull);</span>
<a href="#l59.73"></a><span id="l59.73" class="difflineplus">+      // Ignore errors, but append element to keep arrays in sync.</span>
<a href="#l59.74"></a><span id="l59.74" class="difflineplus">+      statusArray.AppendElement(status);</span>
<a href="#l59.75"></a><span id="l59.75" class="difflineplus">+    }</span>
<a href="#l59.76"></a><span id="l59.76" class="difflineplus">+  }</span>
<a href="#l59.77"></a><span id="l59.77" class="difflineplus">+</span>
<a href="#l59.78"></a><span id="l59.78" class="difflineplus">+  rv = aMsgHdr-&gt;SetUint32Property(aProperty, aValue);</span>
<a href="#l59.79"></a><span id="l59.79" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l59.80"></a><span id="l59.80" class="difflineplus">+</span>
<a href="#l59.81"></a><span id="l59.81" class="difflineplus">+  // Postcall OnHdrPropertyChanged to process the change.</span>
<a href="#l59.82"></a><span id="l59.82" class="difflineplus">+  if (notify)</span>
<a href="#l59.83"></a><span id="l59.83" class="difflineplus">+  {</span>
<a href="#l59.84"></a><span id="l59.84" class="difflineplus">+    nsTObserverArray&lt;nsCOMPtr&lt;nsIDBChangeListener&gt; &gt;::ForwardIterator listeners(m_ChangeListeners);</span>
<a href="#l59.85"></a><span id="l59.85" class="difflineplus">+    for (PRUint32 i = 0; listeners.HasMore(); i++)</span>
<a href="#l59.86"></a><span id="l59.86" class="difflineplus">+    {</span>
<a href="#l59.87"></a><span id="l59.87" class="difflineplus">+      listener = listeners.GetNext();</span>
<a href="#l59.88"></a><span id="l59.88" class="difflineplus">+      status = statusArray[i];</span>
<a href="#l59.89"></a><span id="l59.89" class="difflineplus">+      listener-&gt;OnHdrPropertyChanged(aMsgHdr, PR_FALSE, &amp;status, nsnull);</span>
<a href="#l59.90"></a><span id="l59.90" class="difflineplus">+      // Ignore errors.</span>
<a href="#l59.91"></a><span id="l59.91" class="difflineplus">+    }</span>
<a href="#l59.92"></a><span id="l59.92" class="difflineplus">+  }</span>
<a href="#l59.93"></a><span id="l59.93" class="difflineplus">+</span>
<a href="#l59.94"></a><span id="l59.94" class="difflineplus">+  return NS_OK;</span>
<a href="#l59.95"></a><span id="l59.95" class="difflineplus">+}</span>
<a href="#l59.96"></a><span id="l59.96" class="difflineplus">+</span>
<a href="#l59.97"></a><span id="l59.97"> NS_IMETHODIMP nsMsgDatabase::SetLabel(nsMsgKey key, nsMsgLabelValue label)</span>
<a href="#l59.98"></a><span id="l59.98"> {</span>
<a href="#l59.99"></a><span id="l59.99">   nsresult rv;</span>
<a href="#l59.100"></a><span id="l59.100">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l59.101"></a><span id="l59.101"> </span>
<a href="#l59.102"></a><span id="l59.102">   rv = GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l59.103"></a><span id="l59.103">   if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l59.104"></a><span id="l59.104">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l59.105"></a><span id="l59.105" class="difflineat">@@ -2367,16 +2433,26 @@ NS_IMETHODIMP nsMsgDatabase::MarkHdrRepl</span>
<a href="#l59.106"></a><span id="l59.106"> </span>
<a href="#l59.107"></a><span id="l59.107"> </span>
<a href="#l59.108"></a><span id="l59.108"> NS_IMETHODIMP nsMsgDatabase::MarkHdrMarked(nsIMsgDBHdr *msgHdr, PRBool mark,</span>
<a href="#l59.109"></a><span id="l59.109">                          nsIDBChangeListener *instigator)</span>
<a href="#l59.110"></a><span id="l59.110"> {</span>
<a href="#l59.111"></a><span id="l59.111">   return SetMsgHdrFlag(msgHdr, mark, nsMsgMessageFlags::Marked, instigator);</span>
<a href="#l59.112"></a><span id="l59.112"> }</span>
<a href="#l59.113"></a><span id="l59.113"> </span>
<a href="#l59.114"></a><span id="l59.114" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l59.115"></a><span id="l59.115" class="difflineplus">+nsMsgDatabase::MarkHdrNotNew(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l59.116"></a><span id="l59.116" class="difflineplus">+                             nsIDBChangeListener *aInstigator)</span>
<a href="#l59.117"></a><span id="l59.117" class="difflineplus">+{</span>
<a href="#l59.118"></a><span id="l59.118" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l59.119"></a><span id="l59.119" class="difflineplus">+  nsMsgKey msgKey;</span>
<a href="#l59.120"></a><span id="l59.120" class="difflineplus">+  aMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l59.121"></a><span id="l59.121" class="difflineplus">+  m_newSet.RemoveElement(msgKey);</span>
<a href="#l59.122"></a><span id="l59.122" class="difflineplus">+  return SetMsgHdrFlag(aMsgHdr, PR_FALSE, nsMsgMessageFlags::New, aInstigator);</span>
<a href="#l59.123"></a><span id="l59.123" class="difflineplus">+}</span>
<a href="#l59.124"></a><span id="l59.124"> </span>
<a href="#l59.125"></a><span id="l59.125"> NS_IMETHODIMP nsMsgDatabase::MarkAllRead(nsTArray&lt;nsMsgKey&gt; *thoseMarked)</span>
<a href="#l59.126"></a><span id="l59.126"> {</span>
<a href="#l59.127"></a><span id="l59.127">   nsresult    rv;</span>
<a href="#l59.128"></a><span id="l59.128">   nsMsgHdr  *pHeader;</span>
<a href="#l59.129"></a><span id="l59.129"> </span>
<a href="#l59.130"></a><span id="l59.130">   nsCOMPtr &lt;nsISimpleEnumerator&gt; hdrs;</span>
<a href="#l59.131"></a><span id="l59.131">   rv = EnumerateMessages(getter_AddRefs(hdrs));</span>
<a href="#l59.132"></a><span id="l59.132" class="difflineat">@@ -5025,17 +5101,26 @@ nsresult nsMsgDatabase::PurgeExcessMessa</span>
<a href="#l59.133"></a><span id="l59.133">         Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l59.134"></a><span id="l59.134">     }</span>
<a href="#l59.135"></a><span id="l59.135">   }</span>
<a href="#l59.136"></a><span id="l59.136">   return rv;</span>
<a href="#l59.137"></a><span id="l59.137"> }</span>
<a href="#l59.138"></a><span id="l59.138"> </span>
<a href="#l59.139"></a><span id="l59.139"> NS_IMPL_ISUPPORTS1(nsMsgRetentionSettings, nsIMsgRetentionSettings)</span>
<a href="#l59.140"></a><span id="l59.140"> </span>
<a href="#l59.141"></a><span id="l59.141" class="difflineplus">+// Initialise the member variables to resonable defaults.</span>
<a href="#l59.142"></a><span id="l59.142"> nsMsgRetentionSettings::nsMsgRetentionSettings()</span>
<a href="#l59.143"></a><span id="l59.143" class="difflineplus">+: m_retainByPreference(1),</span>
<a href="#l59.144"></a><span id="l59.144" class="difflineplus">+  m_daysToKeepHdrs(0),</span>
<a href="#l59.145"></a><span id="l59.145" class="difflineplus">+  m_numHeadersToKeep(0),</span>
<a href="#l59.146"></a><span id="l59.146" class="difflineplus">+  m_keepUnreadMessagesOnly(PR_FALSE),</span>
<a href="#l59.147"></a><span id="l59.147" class="difflineplus">+  m_useServerDefaults(PR_TRUE),</span>
<a href="#l59.148"></a><span id="l59.148" class="difflineplus">+  m_cleanupBodiesByDays(PR_FALSE),</span>
<a href="#l59.149"></a><span id="l59.149" class="difflineplus">+  m_daysToKeepBodies(0),</span>
<a href="#l59.150"></a><span id="l59.150" class="difflineplus">+  m_applyToFlaggedMessages(PR_FALSE)</span>
<a href="#l59.151"></a><span id="l59.151"> {</span>
<a href="#l59.152"></a><span id="l59.152"> }</span>
<a href="#l59.153"></a><span id="l59.153"> </span>
<a href="#l59.154"></a><span id="l59.154"> nsMsgRetentionSettings::~nsMsgRetentionSettings()</span>
<a href="#l59.155"></a><span id="l59.155"> {</span>
<a href="#l59.156"></a><span id="l59.156"> }</span>
<a href="#l59.157"></a><span id="l59.157"> </span>
<a href="#l59.158"></a><span id="l59.158"> /* attribute unsigned long retainByPreference */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -406,16 +406,28 @@ nsImapIncomingServer::SetIsAOLServer(PRB</span>
<a href="#l60.4"></a><span id="l60.4">   return NS_OK;</span>
<a href="#l60.5"></a><span id="l60.5"> }</span>
<a href="#l60.6"></a><span id="l60.6"> </span>
<a href="#l60.7"></a><span id="l60.7"> NS_IMETHODIMP</span>
<a href="#l60.8"></a><span id="l60.8"> nsImapIncomingServer::GetImapConnectionAndLoadUrl(nsIEventTarget * aClientEventTarget,</span>
<a href="#l60.9"></a><span id="l60.9">                                                   nsIImapUrl* aImapUrl,</span>
<a href="#l60.10"></a><span id="l60.10">                                                   nsISupports* aConsumer)</span>
<a href="#l60.11"></a><span id="l60.11"> {</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineplus">+  // if we're shutting down, and not running the kinds of urls we run at</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+  // shutdown, then this should fail because running urls during</span>
<a href="#l60.14"></a><span id="l60.14" class="difflineplus">+  // shutdown will very likely fail and potentially hang.</span>
<a href="#l60.15"></a><span id="l60.15" class="difflineplus">+  if (m_shuttingDown)</span>
<a href="#l60.16"></a><span id="l60.16" class="difflineplus">+  {</span>
<a href="#l60.17"></a><span id="l60.17" class="difflineplus">+    nsImapAction imapAction;</span>
<a href="#l60.18"></a><span id="l60.18" class="difflineplus">+    aImapUrl-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l60.19"></a><span id="l60.19" class="difflineplus">+    if (imapAction != nsIImapUrl::nsImapExpungeFolder &amp;&amp;</span>
<a href="#l60.20"></a><span id="l60.20" class="difflineplus">+        imapAction != nsIImapUrl::nsImapDeleteAllMsgs &amp;&amp;</span>
<a href="#l60.21"></a><span id="l60.21" class="difflineplus">+        imapAction != nsIImapUrl::nsImapDeleteFolder)</span>
<a href="#l60.22"></a><span id="l60.22" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l60.23"></a><span id="l60.23" class="difflineplus">+  }</span>
<a href="#l60.24"></a><span id="l60.24">   nsresult rv = NS_OK;</span>
<a href="#l60.25"></a><span id="l60.25">   nsCOMPtr &lt;nsIImapProtocol&gt; aProtocol;</span>
<a href="#l60.26"></a><span id="l60.26"> </span>
<a href="#l60.27"></a><span id="l60.27">   rv = GetImapConnection(aClientEventTarget, aImapUrl, getter_AddRefs(aProtocol));</span>
<a href="#l60.28"></a><span id="l60.28">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l60.29"></a><span id="l60.29"> </span>
<a href="#l60.30"></a><span id="l60.30">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(aImapUrl, &amp;rv);</span>
<a href="#l60.31"></a><span id="l60.31">   if (aProtocol)</span>
<a href="#l60.32"></a><span id="l60.32" class="difflineat">@@ -2906,17 +2918,35 @@ nsImapIncomingServer::GetSupportsSubscri</span>
<a href="#l60.33"></a><span id="l60.33">   *retVal = PR_FALSE;</span>
<a href="#l60.34"></a><span id="l60.34">   return NS_OK;</span>
<a href="#l60.35"></a><span id="l60.35"> }</span>
<a href="#l60.36"></a><span id="l60.36"> </span>
<a href="#l60.37"></a><span id="l60.37"> NS_IMETHODIMP</span>
<a href="#l60.38"></a><span id="l60.38"> nsImapIncomingServer::GetFilterScope(nsMsgSearchScopeValue *filterScope)</span>
<a href="#l60.39"></a><span id="l60.39"> {</span>
<a href="#l60.40"></a><span id="l60.40">   NS_ENSURE_ARG_POINTER(filterScope);</span>
<a href="#l60.41"></a><span id="l60.41" class="difflineminus">-  *filterScope = nsMsgSearchScope::onlineMailFilter;</span>
<a href="#l60.42"></a><span id="l60.42" class="difflineplus">+  // If the inbox is enabled for offline use, then use the offline filter</span>
<a href="#l60.43"></a><span id="l60.43" class="difflineplus">+  // scope, else use the online filter scope.</span>
<a href="#l60.44"></a><span id="l60.44" class="difflineplus">+  //</span>
<a href="#l60.45"></a><span id="l60.45" class="difflineplus">+  // XXX We use the same scope for all folders with the same incoming server,</span>
<a href="#l60.46"></a><span id="l60.46" class="difflineplus">+  // yet it is possible to set the offline flag separately for each folder.</span>
<a href="#l60.47"></a><span id="l60.47" class="difflineplus">+  // Manual filters could perhaps check the offline status of each folder,</span>
<a href="#l60.48"></a><span id="l60.48" class="difflineplus">+  // though it's hard to see how to make that work since we only store filters</span>
<a href="#l60.49"></a><span id="l60.49" class="difflineplus">+  // per server.</span>
<a href="#l60.50"></a><span id="l60.50" class="difflineplus">+  // </span>
<a href="#l60.51"></a><span id="l60.51" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l60.52"></a><span id="l60.52" class="difflineplus">+  nsresult rv = GetRootMsgFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l60.53"></a><span id="l60.53" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l60.54"></a><span id="l60.54" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; offlineInboxMsgFolder;</span>
<a href="#l60.55"></a><span id="l60.55" class="difflineplus">+  rv = rootMsgFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox |</span>
<a href="#l60.56"></a><span id="l60.56" class="difflineplus">+                                           nsMsgFolderFlags::Offline,</span>
<a href="#l60.57"></a><span id="l60.57" class="difflineplus">+                                         getter_AddRefs(offlineInboxMsgFolder));</span>
<a href="#l60.58"></a><span id="l60.58" class="difflineplus">+</span>
<a href="#l60.59"></a><span id="l60.59" class="difflineplus">+  *filterScope = offlineInboxMsgFolder ? nsMsgSearchScope::offlineMailFilter</span>
<a href="#l60.60"></a><span id="l60.60" class="difflineplus">+                                       : nsMsgSearchScope::onlineMailFilter;</span>
<a href="#l60.61"></a><span id="l60.61">   return NS_OK;</span>
<a href="#l60.62"></a><span id="l60.62"> }</span>
<a href="#l60.63"></a><span id="l60.63"> </span>
<a href="#l60.64"></a><span id="l60.64"> NS_IMETHODIMP</span>
<a href="#l60.65"></a><span id="l60.65"> nsImapIncomingServer::GetSearchScope(nsMsgSearchScopeValue *searchScope)</span>
<a href="#l60.66"></a><span id="l60.66"> {</span>
<a href="#l60.67"></a><span id="l60.67">   NS_ENSURE_ARG_POINTER(searchScope);</span>
<a href="#l60.68"></a><span id="l60.68">  *searchScope = WeAreOffline() ? nsMsgSearchScope::offlineMail : nsMsgSearchScope::onlineMail;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -71,16 +71,18 @@</span>
<a href="#l61.4"></a><span id="l61.4"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l61.5"></a><span id="l61.5"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l61.6"></a><span id="l61.6"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l61.7"></a><span id="l61.7"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l61.8"></a><span id="l61.8"> #include &quot;nsICacheSession.h&quot;</span>
<a href="#l61.9"></a><span id="l61.9"> #include &quot;nsEscape.h&quot;</span>
<a href="#l61.10"></a><span id="l61.10"> #include &quot;nsIDOMWindowInternal.h&quot;</span>
<a href="#l61.11"></a><span id="l61.11"> #include &quot;nsIMsgFilter.h&quot;</span>
<a href="#l61.12"></a><span id="l61.12" class="difflineplus">+#include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineplus">+#include &quot;nsIMsgSearchCustomTerm.h&quot;</span>
<a href="#l61.14"></a><span id="l61.14"> #include &quot;nsImapMoveCoalescer.h&quot;</span>
<a href="#l61.15"></a><span id="l61.15"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l61.16"></a><span id="l61.16"> #include &quot;nsIPromptService.h&quot;</span>
<a href="#l61.17"></a><span id="l61.17"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l61.18"></a><span id="l61.18"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l61.19"></a><span id="l61.19"> #include &quot;nsIInterfaceRequestorUtils.h&quot;</span>
<a href="#l61.20"></a><span id="l61.20"> #include &quot;nsReadableUtils.h&quot;</span>
<a href="#l61.21"></a><span id="l61.21"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l61.22"></a><span id="l61.22" class="difflineat">@@ -217,17 +219,18 @@ nsImapMailFolder::nsImapMailFolder() :</span>
<a href="#l61.23"></a><span id="l61.23">     m_folderNeedsACLListed(PR_TRUE),</span>
<a href="#l61.24"></a><span id="l61.24">     m_performingBiff(PR_FALSE),</span>
<a href="#l61.25"></a><span id="l61.25">     m_folderQuotaCommandIssued(PR_FALSE),</span>
<a href="#l61.26"></a><span id="l61.26">     m_folderQuotaDataIsValid(PR_FALSE),</span>
<a href="#l61.27"></a><span id="l61.27">     m_updatingFolder(PR_FALSE),</span>
<a href="#l61.28"></a><span id="l61.28">     m_downloadingFolderForOfflineUse(PR_FALSE),</span>
<a href="#l61.29"></a><span id="l61.29">     m_folderQuotaUsedKB(0),</span>
<a href="#l61.30"></a><span id="l61.30">     m_folderQuotaMaxKB(0),</span>
<a href="#l61.31"></a><span id="l61.31" class="difflineminus">-    m_applyIncomingFilters(PR_FALSE)</span>
<a href="#l61.32"></a><span id="l61.32" class="difflineplus">+    m_applyIncomingFilters(PR_FALSE),</span>
<a href="#l61.33"></a><span id="l61.33" class="difflineplus">+    m_filterListRequiresBody(PR_FALSE)</span>
<a href="#l61.34"></a><span id="l61.34"> {</span>
<a href="#l61.35"></a><span id="l61.35">   MOZ_COUNT_CTOR(nsImapMailFolder); // double count these for now.</span>
<a href="#l61.36"></a><span id="l61.36"> </span>
<a href="#l61.37"></a><span id="l61.37">   if (mImapHdrDownloadedAtom == nsnull)</span>
<a href="#l61.38"></a><span id="l61.38">     mImapHdrDownloadedAtom = NS_NewAtom(&quot;ImapHdrDownloaded&quot;);</span>
<a href="#l61.39"></a><span id="l61.39">   m_appendMsgMonitor = nsnull;  // since we're not using this (yet?) make it null.</span>
<a href="#l61.40"></a><span id="l61.40">   // if we do start using it, it should be created lazily</span>
<a href="#l61.41"></a><span id="l61.41"> </span>
<a href="#l61.42"></a><span id="l61.42" class="difflineat">@@ -721,16 +724,78 @@ NS_IMETHODIMP nsImapMailFolder::UpdateFo</span>
<a href="#l61.43"></a><span id="l61.43">     // the mdn filter is for filing return receipts into the sent folder</span>
<a href="#l61.44"></a><span id="l61.44">     // some servers (like AOL mail servers)</span>
<a href="#l61.45"></a><span id="l61.45">     // can't file to the sent folder, so we don't add the filter for those servers</span>
<a href="#l61.46"></a><span id="l61.46">     if (canFileMessagesOnServer)</span>
<a href="#l61.47"></a><span id="l61.47">     {</span>
<a href="#l61.48"></a><span id="l61.48">       rv = server-&gt;ConfigureTemporaryFilters(m_filterList);</span>
<a href="#l61.49"></a><span id="l61.49">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.50"></a><span id="l61.50">     }</span>
<a href="#l61.51"></a><span id="l61.51" class="difflineplus">+</span>
<a href="#l61.52"></a><span id="l61.52" class="difflineplus">+    // If a body filter is enabled for an offline folder, delay the filter</span>
<a href="#l61.53"></a><span id="l61.53" class="difflineplus">+    // application until after message has been downloaded.</span>
<a href="#l61.54"></a><span id="l61.54" class="difflineplus">+    m_filterListRequiresBody = PR_FALSE;</span>
<a href="#l61.55"></a><span id="l61.55" class="difflineplus">+</span>
<a href="#l61.56"></a><span id="l61.56" class="difflineplus">+    if (mFlags &amp; nsMsgFolderFlags::Offline)</span>
<a href="#l61.57"></a><span id="l61.57" class="difflineplus">+    {</span>
<a href="#l61.58"></a><span id="l61.58" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFilterService&gt; filterService =</span>
<a href="#l61.59"></a><span id="l61.59" class="difflineplus">+        do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l61.60"></a><span id="l61.60" class="difflineplus">+      PRUint32 filterCount = 0;</span>
<a href="#l61.61"></a><span id="l61.61" class="difflineplus">+      m_filterList-&gt;GetFilterCount(&amp;filterCount);</span>
<a href="#l61.62"></a><span id="l61.62" class="difflineplus">+      for (PRUint32 index = 0;</span>
<a href="#l61.63"></a><span id="l61.63" class="difflineplus">+           index &lt; filterCount &amp;&amp; !m_filterListRequiresBody;</span>
<a href="#l61.64"></a><span id="l61.64" class="difflineplus">+           ++index)</span>
<a href="#l61.65"></a><span id="l61.65" class="difflineplus">+      {</span>
<a href="#l61.66"></a><span id="l61.66" class="difflineplus">+        nsCOMPtr&lt;nsIMsgFilter&gt; filter;</span>
<a href="#l61.67"></a><span id="l61.67" class="difflineplus">+        m_filterList-&gt;GetFilterAt(index, getter_AddRefs(filter));</span>
<a href="#l61.68"></a><span id="l61.68" class="difflineplus">+        if (!filter)</span>
<a href="#l61.69"></a><span id="l61.69" class="difflineplus">+          continue;</span>
<a href="#l61.70"></a><span id="l61.70" class="difflineplus">+        nsMsgFilterTypeType filterType;</span>
<a href="#l61.71"></a><span id="l61.71" class="difflineplus">+        filter-&gt;GetFilterType(&amp;filterType);</span>
<a href="#l61.72"></a><span id="l61.72" class="difflineplus">+        if (!(filterType &amp; nsMsgFilterType::Incoming))</span>
<a href="#l61.73"></a><span id="l61.73" class="difflineplus">+          continue;</span>
<a href="#l61.74"></a><span id="l61.74" class="difflineplus">+        PRBool enabled = PR_FALSE;</span>
<a href="#l61.75"></a><span id="l61.75" class="difflineplus">+        filter-&gt;GetEnabled(&amp;enabled);</span>
<a href="#l61.76"></a><span id="l61.76" class="difflineplus">+        if (!enabled)</span>
<a href="#l61.77"></a><span id="l61.77" class="difflineplus">+          continue;</span>
<a href="#l61.78"></a><span id="l61.78" class="difflineplus">+        nsCOMPtr&lt;nsISupportsArray&gt; searchTerms;</span>
<a href="#l61.79"></a><span id="l61.79" class="difflineplus">+        PRUint32 numSearchTerms = 0;</span>
<a href="#l61.80"></a><span id="l61.80" class="difflineplus">+        filter-&gt;GetSearchTerms(getter_AddRefs(searchTerms));</span>
<a href="#l61.81"></a><span id="l61.81" class="difflineplus">+        if (searchTerms)</span>
<a href="#l61.82"></a><span id="l61.82" class="difflineplus">+          searchTerms-&gt;Count(&amp;numSearchTerms);</span>
<a href="#l61.83"></a><span id="l61.83" class="difflineplus">+        for (PRUint32 termIndex = 0;</span>
<a href="#l61.84"></a><span id="l61.84" class="difflineplus">+             termIndex &lt; numSearchTerms &amp;&amp; !m_filterListRequiresBody;</span>
<a href="#l61.85"></a><span id="l61.85" class="difflineplus">+             termIndex++)</span>
<a href="#l61.86"></a><span id="l61.86" class="difflineplus">+        {</span>
<a href="#l61.87"></a><span id="l61.87" class="difflineplus">+          nsCOMPtr&lt;nsIMsgSearchTerm&gt; term;</span>
<a href="#l61.88"></a><span id="l61.88" class="difflineplus">+          rv = searchTerms-&gt;QueryElementAt(termIndex,</span>
<a href="#l61.89"></a><span id="l61.89" class="difflineplus">+                                           NS_GET_IID(nsIMsgSearchTerm),</span>
<a href="#l61.90"></a><span id="l61.90" class="difflineplus">+                                           getter_AddRefs(term));</span>
<a href="#l61.91"></a><span id="l61.91" class="difflineplus">+          nsMsgSearchAttribValue attrib;</span>
<a href="#l61.92"></a><span id="l61.92" class="difflineplus">+          rv = term-&gt;GetAttrib(&amp;attrib);</span>
<a href="#l61.93"></a><span id="l61.93" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.94"></a><span id="l61.94" class="difflineplus">+          if (attrib == nsMsgSearchAttrib::Body)</span>
<a href="#l61.95"></a><span id="l61.95" class="difflineplus">+            m_filterListRequiresBody = PR_TRUE;</span>
<a href="#l61.96"></a><span id="l61.96" class="difflineplus">+          else if (attrib == nsMsgSearchAttrib::Custom)</span>
<a href="#l61.97"></a><span id="l61.97" class="difflineplus">+          {</span>
<a href="#l61.98"></a><span id="l61.98" class="difflineplus">+            nsCAutoString customId;</span>
<a href="#l61.99"></a><span id="l61.99" class="difflineplus">+            rv = term-&gt;GetCustomId(customId);</span>
<a href="#l61.100"></a><span id="l61.100" class="difflineplus">+            nsCOMPtr&lt;nsIMsgSearchCustomTerm&gt; customTerm;</span>
<a href="#l61.101"></a><span id="l61.101" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; filterService)</span>
<a href="#l61.102"></a><span id="l61.102" class="difflineplus">+              rv = filterService-&gt;GetCustomTerm(customId,</span>
<a href="#l61.103"></a><span id="l61.103" class="difflineplus">+                                                getter_AddRefs(customTerm));</span>
<a href="#l61.104"></a><span id="l61.104" class="difflineplus">+            PRBool needsBody = PR_FALSE;</span>
<a href="#l61.105"></a><span id="l61.105" class="difflineplus">+            if (NS_SUCCEEDED(rv))</span>
<a href="#l61.106"></a><span id="l61.106" class="difflineplus">+              rv = customTerm-&gt;GetNeedsBody(&amp;needsBody);</span>
<a href="#l61.107"></a><span id="l61.107" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; needsBody)</span>
<a href="#l61.108"></a><span id="l61.108" class="difflineplus">+              m_filterListRequiresBody = PR_TRUE;</span>
<a href="#l61.109"></a><span id="l61.109" class="difflineplus">+          }</span>
<a href="#l61.110"></a><span id="l61.110" class="difflineplus">+        }</span>
<a href="#l61.111"></a><span id="l61.111" class="difflineplus">+      }</span>
<a href="#l61.112"></a><span id="l61.112" class="difflineplus">+    }</span>
<a href="#l61.113"></a><span id="l61.113">   }</span>
<a href="#l61.114"></a><span id="l61.114"> </span>
<a href="#l61.115"></a><span id="l61.115">   selectFolder = PR_TRUE;</span>
<a href="#l61.116"></a><span id="l61.116"> </span>
<a href="#l61.117"></a><span id="l61.117">   PRBool isServer;</span>
<a href="#l61.118"></a><span id="l61.118">   rv = GetIsServer(&amp;isServer);</span>
<a href="#l61.119"></a><span id="l61.119">   if (NS_SUCCEEDED(rv) &amp;&amp; isServer)</span>
<a href="#l61.120"></a><span id="l61.120">   {</span>
<a href="#l61.121"></a><span id="l61.121" class="difflineat">@@ -3046,23 +3111,25 @@ nsresult nsImapMailFolder::NormalEndHead</span>
<a href="#l61.122"></a><span id="l61.122">           }</span>
<a href="#l61.123"></a><span id="l61.123">           PRInt32 numNewMessages;</span>
<a href="#l61.124"></a><span id="l61.124">           GetNumNewMessages(PR_FALSE, &amp;numNewMessages);</span>
<a href="#l61.125"></a><span id="l61.125">           SetNumNewMessages(numNewMessages - 1);</span>
<a href="#l61.126"></a><span id="l61.126">         }</span>
<a href="#l61.127"></a><span id="l61.127">       }</span>
<a href="#l61.128"></a><span id="l61.128">       rv = m_msgParser-&gt;GetAllHeaders(&amp;headers, &amp;headersSize);</span>
<a href="#l61.129"></a><span id="l61.129"> </span>
<a href="#l61.130"></a><span id="l61.130" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; headers &amp;&amp; !m_msgMovedByFilter)</span>
<a href="#l61.131"></a><span id="l61.131" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; headers &amp;&amp; !m_msgMovedByFilter &amp;&amp;</span>
<a href="#l61.132"></a><span id="l61.132" class="difflineplus">+          !m_filterListRequiresBody)</span>
<a href="#l61.133"></a><span id="l61.133">       {</span>
<a href="#l61.134"></a><span id="l61.134">         if (m_filterList)</span>
<a href="#l61.135"></a><span id="l61.135">         {</span>
<a href="#l61.136"></a><span id="l61.136">           GetMoveCoalescer();  // not sure why we're doing this here.</span>
<a href="#l61.137"></a><span id="l61.137">           m_filterList-&gt;ApplyFiltersToHdr(nsMsgFilterType::InboxRule, newMsgHdr, this, mDatabase,</span>
<a href="#l61.138"></a><span id="l61.138">                                           headers, headersSize, this, msgWindow, nsnull);</span>
<a href="#l61.139"></a><span id="l61.139" class="difflineplus">+          NotifyFolderEvent(mFiltersAppliedAtom);</span>
<a href="#l61.140"></a><span id="l61.140">         }</span>
<a href="#l61.141"></a><span id="l61.141">       }</span>
<a href="#l61.142"></a><span id="l61.142">     }</span>
<a href="#l61.143"></a><span id="l61.143">   }</span>
<a href="#l61.144"></a><span id="l61.144">   // here we need to tweak flags from uid state..</span>
<a href="#l61.145"></a><span id="l61.145">   if (mDatabase &amp;&amp; (!m_msgMovedByFilter || ShowDeletedMessages()))</span>
<a href="#l61.146"></a><span id="l61.146">   {</span>
<a href="#l61.147"></a><span id="l61.147">     mDatabase-&gt;AddNewHdrToDB(newMsgHdr, PR_TRUE);</span>
<a href="#l61.148"></a><span id="l61.148" class="difflineat">@@ -3259,30 +3326,46 @@ NS_IMETHODIMP nsImapMailFolder::StartMes</span>
<a href="#l61.149"></a><span id="l61.149"> // just finished the current message.</span>
<a href="#l61.150"></a><span id="l61.150"> NS_IMETHODIMP nsImapMailFolder::EndMessage(nsMsgKey key)</span>
<a href="#l61.151"></a><span id="l61.151"> {</span>
<a href="#l61.152"></a><span id="l61.152">   return NS_OK;</span>
<a href="#l61.153"></a><span id="l61.153"> }</span>
<a href="#l61.154"></a><span id="l61.154"> </span>
<a href="#l61.155"></a><span id="l61.155"> NS_IMETHODIMP nsImapMailFolder::ApplyFilterHit(nsIMsgFilter *filter, nsIMsgWindow *msgWindow, PRBool *applyMore)</span>
<a href="#l61.156"></a><span id="l61.156"> {</span>
<a href="#l61.157"></a><span id="l61.157" class="difflineplus">+  //</span>
<a href="#l61.158"></a><span id="l61.158" class="difflineplus">+  //  This routine is called indirectly from ApplyFiltersToHdr in two</span>
<a href="#l61.159"></a><span id="l61.159" class="difflineplus">+  //  circumstances, controlled by m_filterListRequiresBody:</span>
<a href="#l61.160"></a><span id="l61.160" class="difflineplus">+  //</span>
<a href="#l61.161"></a><span id="l61.161" class="difflineplus">+  //  If false, after headers are parsed in NormalEndHeaderParseStream.</span>
<a href="#l61.162"></a><span id="l61.162" class="difflineplus">+  //  If true, after the message body is downloaded in NormalEndMsgWriteStream.</span>
<a href="#l61.163"></a><span id="l61.163" class="difflineplus">+  //</span>
<a href="#l61.164"></a><span id="l61.164" class="difflineplus">+  //  In NormalEndHeaderParseStream, the message has not been added to the</span>
<a href="#l61.165"></a><span id="l61.165" class="difflineplus">+  //  database, and it is important that database notifications and count </span>
<a href="#l61.166"></a><span id="l61.166" class="difflineplus">+  //  updates do not occur. In NormalEndMsgWriteStream, the message has been</span>
<a href="#l61.167"></a><span id="l61.167" class="difflineplus">+  //  added to the database, and database notifications and count updates</span>
<a href="#l61.168"></a><span id="l61.168" class="difflineplus">+  //  should be performed.</span>
<a href="#l61.169"></a><span id="l61.169" class="difflineplus">+  //</span>
<a href="#l61.170"></a><span id="l61.170" class="difflineplus">+</span>
<a href="#l61.171"></a><span id="l61.171">   NS_ENSURE_ARG_POINTER(applyMore);</span>
<a href="#l61.172"></a><span id="l61.172"> </span>
<a href="#l61.173"></a><span id="l61.173">   nsMsgRuleActionType actionType;</span>
<a href="#l61.174"></a><span id="l61.174">   nsCString actionTargetFolderUri;</span>
<a href="#l61.175"></a><span id="l61.175">   PRUint32  newFlags;</span>
<a href="#l61.176"></a><span id="l61.176">   nsresult rv = NS_OK;</span>
<a href="#l61.177"></a><span id="l61.177"> </span>
<a href="#l61.178"></a><span id="l61.178">   // look at action - currently handle move</span>
<a href="#l61.179"></a><span id="l61.179"> #ifdef DEBUG_bienvenu</span>
<a href="#l61.180"></a><span id="l61.180">   printf(&quot;got a rule hit!\n&quot;);</span>
<a href="#l61.181"></a><span id="l61.181"> #endif</span>
<a href="#l61.182"></a><span id="l61.182"> </span>
<a href="#l61.183"></a><span id="l61.183">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l61.184"></a><span id="l61.184" class="difflineminus">-  if (m_msgParser)</span>
<a href="#l61.185"></a><span id="l61.185" class="difflineplus">+  if (m_filterListRequiresBody)</span>
<a href="#l61.186"></a><span id="l61.186" class="difflineplus">+    GetMessageHeader(m_curMsgUid, getter_AddRefs(msgHdr));</span>
<a href="#l61.187"></a><span id="l61.187" class="difflineplus">+  else if (m_msgParser)</span>
<a href="#l61.188"></a><span id="l61.188">     m_msgParser-&gt;GetNewMsgHdr(getter_AddRefs(msgHdr));</span>
<a href="#l61.189"></a><span id="l61.189">   if (!msgHdr)</span>
<a href="#l61.190"></a><span id="l61.190">     return NS_ERROR_NULL_POINTER; //fatal error, cannot apply filters</span>
<a href="#l61.191"></a><span id="l61.191"> </span>
<a href="#l61.192"></a><span id="l61.192">   PRBool deleteToTrash = DeleteIsMoveToTrash();</span>
<a href="#l61.193"></a><span id="l61.193">   nsCOMPtr&lt;nsISupportsArray&gt; filterActionList = do_CreateInstance(NS_SUPPORTSARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l61.194"></a><span id="l61.194">   NS_ENSURE_TRUE(filterActionList, rv);</span>
<a href="#l61.195"></a><span id="l61.195">   rv = filter-&gt;GetSortedActionList(filterActionList);</span>
<a href="#l61.196"></a><span id="l61.196" class="difflineat">@@ -3334,17 +3417,18 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l61.197"></a><span id="l61.197">             nsCOMPtr &lt;nsIMsgFolder&gt; mailTrash;</span>
<a href="#l61.198"></a><span id="l61.198">             rv = GetTrashFolder(getter_AddRefs(mailTrash));</span>
<a href="#l61.199"></a><span id="l61.199">             if (NS_SUCCEEDED(rv) &amp;&amp; mailTrash)</span>
<a href="#l61.200"></a><span id="l61.200">               rv = mailTrash-&gt;GetURI(actionTargetFolderUri);</span>
<a href="#l61.201"></a><span id="l61.201">             // msgHdr-&gt;OrFlags(nsMsgMessageFlags::Read, &amp;newFlags);  // mark read in trash.</span>
<a href="#l61.202"></a><span id="l61.202">           }</span>
<a href="#l61.203"></a><span id="l61.203">           else  // (!deleteToTrash)</span>
<a href="#l61.204"></a><span id="l61.204">           {</span>
<a href="#l61.205"></a><span id="l61.205" class="difflineminus">-            msgHdr-&gt;OrFlags(nsMsgMessageFlags::Read | nsMsgMessageFlags::IMAPDeleted, &amp;newFlags);</span>
<a href="#l61.206"></a><span id="l61.206" class="difflineplus">+            mDatabase-&gt;MarkHdrRead(msgHdr, PR_TRUE, nsnull);</span>
<a href="#l61.207"></a><span id="l61.207" class="difflineplus">+            mDatabase-&gt;MarkImapDeleted(msgKey, PR_TRUE, nsnull);</span>
<a href="#l61.208"></a><span id="l61.208">             StoreImapFlags(kImapMsgSeenFlag | kImapMsgDeletedFlag, PR_TRUE,</span>
<a href="#l61.209"></a><span id="l61.209">                            &amp;msgKey, 1, nsnull);</span>
<a href="#l61.210"></a><span id="l61.210">             m_msgMovedByFilter = PR_TRUE; // this will prevent us from adding the header to the db.</span>
<a href="#l61.211"></a><span id="l61.211">           }</span>
<a href="#l61.212"></a><span id="l61.212">           msgIsNew = PR_FALSE;</span>
<a href="#l61.213"></a><span id="l61.213">         }</span>
<a href="#l61.214"></a><span id="l61.214">         // note that delete falls through to move.</span>
<a href="#l61.215"></a><span id="l61.215">         case nsMsgFilterAction::MoveToFolder:</span>
<a href="#l61.216"></a><span id="l61.216" class="difflineat">@@ -3354,18 +3438,18 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l61.217"></a><span id="l61.217">           rv = GetURI(uri);</span>
<a href="#l61.218"></a><span id="l61.218"> </span>
<a href="#l61.219"></a><span id="l61.219">           if (!actionTargetFolderUri.Equals(uri))</span>
<a href="#l61.220"></a><span id="l61.220">           {</span>
<a href="#l61.221"></a><span id="l61.221">             msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l61.222"></a><span id="l61.222"> </span>
<a href="#l61.223"></a><span id="l61.223">             if (msgFlags &amp; nsMsgMessageFlags::MDNReportNeeded &amp;&amp; !isRead)</span>
<a href="#l61.224"></a><span id="l61.224">             {</span>
<a href="#l61.225"></a><span id="l61.225" class="difflineminus">-               msgHdr-&gt;SetFlags(msgFlags &amp; ~nsMsgMessageFlags::MDNReportNeeded);</span>
<a href="#l61.226"></a><span id="l61.226" class="difflineminus">-               msgHdr-&gt;OrFlags(nsMsgMessageFlags::MDNReportSent, &amp;newFlags);</span>
<a href="#l61.227"></a><span id="l61.227" class="difflineplus">+               mDatabase-&gt;MarkMDNNeeded(msgKey, PR_FALSE, nsnull);</span>
<a href="#l61.228"></a><span id="l61.228" class="difflineplus">+               mDatabase-&gt;MarkMDNSent(msgKey, PR_TRUE, nsnull);</span>
<a href="#l61.229"></a><span id="l61.229">             }</span>
<a href="#l61.230"></a><span id="l61.230">             nsresult err = MoveIncorporatedMessage(msgHdr, mDatabase, actionTargetFolderUri, filter, msgWindow);</span>
<a href="#l61.231"></a><span id="l61.231">             if (NS_SUCCEEDED(err))</span>
<a href="#l61.232"></a><span id="l61.232">               m_msgMovedByFilter = PR_TRUE;</span>
<a href="#l61.233"></a><span id="l61.233">           }</span>
<a href="#l61.234"></a><span id="l61.234">           // don't apply any more filters, even if it was a move to the same folder</span>
<a href="#l61.235"></a><span id="l61.235">           *applyMore = PR_FALSE; </span>
<a href="#l61.236"></a><span id="l61.236">         }</span>
<a href="#l61.237"></a><span id="l61.237" class="difflineat">@@ -3378,18 +3462,18 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l61.238"></a><span id="l61.238">           if (!actionTargetFolderUri.Equals(uri))</span>
<a href="#l61.239"></a><span id="l61.239">           {</span>
<a href="#l61.240"></a><span id="l61.240">             // XXXshaver I'm not actually 100% what the right semantics are for</span>
<a href="#l61.241"></a><span id="l61.241">             // MDNs and copied messages, but I suspect deep down inside that</span>
<a href="#l61.242"></a><span id="l61.242">             // we probably want to suppress them only on the copies.</span>
<a href="#l61.243"></a><span id="l61.243">             msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l61.244"></a><span id="l61.244">             if (msgFlags &amp; nsMsgMessageFlags::MDNReportNeeded &amp;&amp; !isRead)</span>
<a href="#l61.245"></a><span id="l61.245">             {</span>
<a href="#l61.246"></a><span id="l61.246" class="difflineminus">-               msgHdr-&gt;SetFlags(msgFlags &amp; ~nsMsgMessageFlags::MDNReportNeeded);</span>
<a href="#l61.247"></a><span id="l61.247" class="difflineminus">-               msgHdr-&gt;OrFlags(nsMsgMessageFlags::MDNReportSent, &amp;newFlags);</span>
<a href="#l61.248"></a><span id="l61.248" class="difflineplus">+               mDatabase-&gt;MarkMDNNeeded(msgKey, PR_FALSE, nsnull);</span>
<a href="#l61.249"></a><span id="l61.249" class="difflineplus">+               mDatabase-&gt;MarkMDNSent(msgKey, PR_TRUE, nsnull);</span>
<a href="#l61.250"></a><span id="l61.250">             }</span>
<a href="#l61.251"></a><span id="l61.251"> </span>
<a href="#l61.252"></a><span id="l61.252">             nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l61.253"></a><span id="l61.253">             NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l61.254"></a><span id="l61.254">             messageArray-&gt;AppendElement(msgHdr, PR_FALSE);</span>
<a href="#l61.255"></a><span id="l61.255"> </span>
<a href="#l61.256"></a><span id="l61.256">             nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder;</span>
<a href="#l61.257"></a><span id="l61.257">             rv = GetExistingFolder(actionTargetFolderUri, getter_AddRefs(dstFolder));</span>
<a href="#l61.258"></a><span id="l61.258" class="difflineat">@@ -3413,36 +3497,66 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l61.259"></a><span id="l61.259">         break;</span>
<a href="#l61.260"></a><span id="l61.260">         case nsMsgFilterAction::MarkFlagged:</span>
<a href="#l61.261"></a><span id="l61.261">         {</span>
<a href="#l61.262"></a><span id="l61.262">           mDatabase-&gt;MarkHdrMarked(msgHdr, PR_TRUE, nsnull);</span>
<a href="#l61.263"></a><span id="l61.263">           StoreImapFlags(kImapMsgFlaggedFlag, PR_TRUE, &amp;msgKey, 1, nsnull);</span>
<a href="#l61.264"></a><span id="l61.264">         }</span>
<a href="#l61.265"></a><span id="l61.265">         break;</span>
<a href="#l61.266"></a><span id="l61.266">         case nsMsgFilterAction::KillThread:</span>
<a href="#l61.267"></a><span id="l61.267" class="difflineminus">-          msgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;, nsMsgMessageFlags::Ignored);</span>
<a href="#l61.268"></a><span id="l61.268" class="difflineminus">-          break;</span>
<a href="#l61.269"></a><span id="l61.269" class="difflineplus">+        case nsMsgFilterAction::WatchThread:</span>
<a href="#l61.270"></a><span id="l61.270" class="difflineplus">+        {</span>
<a href="#l61.271"></a><span id="l61.271" class="difflineplus">+          nsCOMPtr &lt;nsIMsgThread&gt; msgThread;</span>
<a href="#l61.272"></a><span id="l61.272" class="difflineplus">+          nsMsgKey threadKey;</span>
<a href="#l61.273"></a><span id="l61.273" class="difflineplus">+          mDatabase-&gt;GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(msgThread));</span>
<a href="#l61.274"></a><span id="l61.274" class="difflineplus">+          if (msgThread)</span>
<a href="#l61.275"></a><span id="l61.275" class="difflineplus">+          {</span>
<a href="#l61.276"></a><span id="l61.276" class="difflineplus">+            msgThread-&gt;GetThreadKey(&amp;threadKey);</span>
<a href="#l61.277"></a><span id="l61.277" class="difflineplus">+            if (actionType == nsMsgFilterAction::KillThread)</span>
<a href="#l61.278"></a><span id="l61.278" class="difflineplus">+              mDatabase-&gt;MarkThreadIgnored(msgThread, threadKey, PR_TRUE, nsnull);</span>
<a href="#l61.279"></a><span id="l61.279" class="difflineplus">+            else</span>
<a href="#l61.280"></a><span id="l61.280" class="difflineplus">+              mDatabase-&gt;MarkThreadWatched(msgThread, threadKey, PR_TRUE, nsnull);</span>
<a href="#l61.281"></a><span id="l61.281" class="difflineplus">+          }</span>
<a href="#l61.282"></a><span id="l61.282" class="difflineplus">+          else</span>
<a href="#l61.283"></a><span id="l61.283" class="difflineplus">+          {</span>
<a href="#l61.284"></a><span id="l61.284" class="difflineplus">+            if (actionType == nsMsgFilterAction::KillThread)</span>
<a href="#l61.285"></a><span id="l61.285" class="difflineplus">+              msgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;, nsMsgMessageFlags::Ignored);</span>
<a href="#l61.286"></a><span id="l61.286" class="difflineplus">+            else</span>
<a href="#l61.287"></a><span id="l61.287" class="difflineplus">+              msgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;, nsMsgMessageFlags::Watched);</span>
<a href="#l61.288"></a><span id="l61.288" class="difflineplus">+          }</span>
<a href="#l61.289"></a><span id="l61.289" class="difflineplus">+          if (actionType == nsMsgFilterAction::KillThread)</span>
<a href="#l61.290"></a><span id="l61.290" class="difflineplus">+          {</span>
<a href="#l61.291"></a><span id="l61.291" class="difflineplus">+            mDatabase-&gt;MarkHdrRead(msgHdr, PR_TRUE, nsnull);</span>
<a href="#l61.292"></a><span id="l61.292" class="difflineplus">+            StoreImapFlags(kImapMsgSeenFlag, PR_TRUE, &amp;msgKey, 1, nsnull);</span>
<a href="#l61.293"></a><span id="l61.293" class="difflineplus">+            msgIsNew = PR_FALSE;</span>
<a href="#l61.294"></a><span id="l61.294" class="difflineplus">+          }</span>
<a href="#l61.295"></a><span id="l61.295" class="difflineplus">+        }</span>
<a href="#l61.296"></a><span id="l61.296" class="difflineplus">+        break;</span>
<a href="#l61.297"></a><span id="l61.297">         case nsMsgFilterAction::KillSubthread:</span>
<a href="#l61.298"></a><span id="l61.298" class="difflineminus">-          msgHdr-&gt;OrFlags(nsMsgMessageFlags::Ignored, &amp;newFlags);</span>
<a href="#l61.299"></a><span id="l61.299" class="difflineminus">-          break;</span>
<a href="#l61.300"></a><span id="l61.300" class="difflineminus">-        case nsMsgFilterAction::WatchThread:</span>
<a href="#l61.301"></a><span id="l61.301" class="difflineminus">-          msgHdr-&gt;OrFlags(nsMsgMessageFlags::Watched, &amp;newFlags);</span>
<a href="#l61.302"></a><span id="l61.302" class="difflineplus">+        {</span>
<a href="#l61.303"></a><span id="l61.303" class="difflineplus">+          mDatabase-&gt;MarkHeaderKilled(msgHdr, PR_TRUE, nsnull);</span>
<a href="#l61.304"></a><span id="l61.304" class="difflineplus">+          mDatabase-&gt;MarkHdrRead(msgHdr, PR_TRUE, nsnull);</span>
<a href="#l61.305"></a><span id="l61.305" class="difflineplus">+          StoreImapFlags(kImapMsgSeenFlag, PR_TRUE, &amp;msgKey, 1, nsnull);</span>
<a href="#l61.306"></a><span id="l61.306" class="difflineplus">+          msgIsNew = PR_FALSE;</span>
<a href="#l61.307"></a><span id="l61.307" class="difflineplus">+        }</span>
<a href="#l61.308"></a><span id="l61.308">         break;</span>
<a href="#l61.309"></a><span id="l61.309">         case nsMsgFilterAction::ChangePriority:</span>
<a href="#l61.310"></a><span id="l61.310">         {</span>
<a href="#l61.311"></a><span id="l61.311" class="difflineminus">-          nsMsgPriorityValue filterPriority;</span>
<a href="#l61.312"></a><span id="l61.312" class="difflineplus">+          nsMsgPriorityValue filterPriority; // a PRInt32</span>
<a href="#l61.313"></a><span id="l61.313">           filterAction-&gt;GetPriority(&amp;filterPriority);</span>
<a href="#l61.314"></a><span id="l61.314" class="difflineminus">-          msgHdr-&gt;SetPriority(filterPriority);</span>
<a href="#l61.315"></a><span id="l61.315" class="difflineplus">+          mDatabase-&gt;SetUint32PropertyByHdr(msgHdr, &quot;priority&quot;,</span>
<a href="#l61.316"></a><span id="l61.316" class="difflineplus">+                                            static_cast&lt;PRUint32&gt;(filterPriority));</span>
<a href="#l61.317"></a><span id="l61.317">         }</span>
<a href="#l61.318"></a><span id="l61.318">         break;</span>
<a href="#l61.319"></a><span id="l61.319">         case nsMsgFilterAction::Label:</span>
<a href="#l61.320"></a><span id="l61.320">         {</span>
<a href="#l61.321"></a><span id="l61.321">           nsMsgLabelValue filterLabel;</span>
<a href="#l61.322"></a><span id="l61.322">           filterAction-&gt;GetLabel(&amp;filterLabel);</span>
<a href="#l61.323"></a><span id="l61.323" class="difflineminus">-          msgHdr-&gt;SetLabel(filterLabel);</span>
<a href="#l61.324"></a><span id="l61.324" class="difflineplus">+          mDatabase-&gt;SetUint32PropertyByHdr(msgHdr, &quot;label&quot;,</span>
<a href="#l61.325"></a><span id="l61.325" class="difflineplus">+                                            static_cast&lt;PRUint32&gt;(filterLabel));</span>
<a href="#l61.326"></a><span id="l61.326">           StoreImapFlags((filterLabel &lt;&lt; 9), PR_TRUE, &amp;msgKey, 1, nsnull);</span>
<a href="#l61.327"></a><span id="l61.327">         }</span>
<a href="#l61.328"></a><span id="l61.328">         break;</span>
<a href="#l61.329"></a><span id="l61.329">         case nsMsgFilterAction::AddTag:</span>
<a href="#l61.330"></a><span id="l61.330">         {</span>
<a href="#l61.331"></a><span id="l61.331">           nsCString keyword;</span>
<a href="#l61.332"></a><span id="l61.332">           filterAction-&gt;GetStrValue(keyword);</span>
<a href="#l61.333"></a><span id="l61.333">           nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l61.334"></a><span id="l61.334" class="difflineat">@@ -3464,18 +3578,38 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l61.335"></a><span id="l61.335">           if (junkScore == nsIJunkMailPlugin::IS_SPAM_SCORE ||</span>
<a href="#l61.336"></a><span id="l61.336">               junkScore == nsIJunkMailPlugin::IS_HAM_SCORE)</span>
<a href="#l61.337"></a><span id="l61.337">           {</span>
<a href="#l61.338"></a><span id="l61.338">             nsTArray&lt;nsMsgKey&gt; *keysToClassify = m_moveCoalescer-&gt;GetKeyBucket(</span>
<a href="#l61.339"></a><span id="l61.339">                        (junkScore == nsIJunkMailPlugin::IS_SPAM_SCORE) ? 0 : 1);</span>
<a href="#l61.340"></a><span id="l61.340">             NS_ASSERTION(keysToClassify, &quot;error getting key bucket&quot;);</span>
<a href="#l61.341"></a><span id="l61.341">             if (keysToClassify)</span>
<a href="#l61.342"></a><span id="l61.342">               keysToClassify-&gt;AppendElement(msgKey);</span>
<a href="#l61.343"></a><span id="l61.343" class="difflineminus">-            if (junkScore == nsIJunkMailPlugin::IS_SPAM_SCORE)</span>
<a href="#l61.344"></a><span id="l61.344" class="difflineplus">+            if (msgIsNew &amp;&amp; junkScore == nsIJunkMailPlugin::IS_SPAM_SCORE)</span>
<a href="#l61.345"></a><span id="l61.345" class="difflineplus">+            {              </span>
<a href="#l61.346"></a><span id="l61.346">               msgIsNew = PR_FALSE;</span>
<a href="#l61.347"></a><span id="l61.347" class="difflineplus">+              mDatabase-&gt;MarkHdrNotNew(msgHdr, nsnull);</span>
<a href="#l61.348"></a><span id="l61.348" class="difflineplus">+              // nsMsgDBFolder::SendFlagNotifications by the call to</span>
<a href="#l61.349"></a><span id="l61.349" class="difflineplus">+              // SetBiffState(nsMsgBiffState_NoMail) will reset numNewMessages</span>
<a href="#l61.350"></a><span id="l61.350" class="difflineplus">+              // only if the message is also read and database notifications</span>
<a href="#l61.351"></a><span id="l61.351" class="difflineplus">+              // are active, but we are not going to mark it read in this</span>
<a href="#l61.352"></a><span id="l61.352" class="difflineplus">+              // action, preferring to leave the choice to the user.</span>
<a href="#l61.353"></a><span id="l61.353" class="difflineplus">+              // So correct numNewMessages.</span>
<a href="#l61.354"></a><span id="l61.354" class="difflineplus">+              if (m_filterListRequiresBody)</span>
<a href="#l61.355"></a><span id="l61.355" class="difflineplus">+              {</span>
<a href="#l61.356"></a><span id="l61.356" class="difflineplus">+                msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l61.357"></a><span id="l61.357" class="difflineplus">+                if (!(msgFlags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l61.358"></a><span id="l61.358" class="difflineplus">+                {</span>
<a href="#l61.359"></a><span id="l61.359" class="difflineplus">+                  PRInt32 numNewMessages;</span>
<a href="#l61.360"></a><span id="l61.360" class="difflineplus">+                  GetNumNewMessages(PR_FALSE, &amp;numNewMessages);</span>
<a href="#l61.361"></a><span id="l61.361" class="difflineplus">+                  SetNumNewMessages(--numNewMessages);</span>
<a href="#l61.362"></a><span id="l61.362" class="difflineplus">+                  SetHasNewMessages(numNewMessages != 0);</span>
<a href="#l61.363"></a><span id="l61.363" class="difflineplus">+                }</span>
<a href="#l61.364"></a><span id="l61.364" class="difflineplus">+              }</span>
<a href="#l61.365"></a><span id="l61.365" class="difflineplus">+            }</span>
<a href="#l61.366"></a><span id="l61.366">           }</span>
<a href="#l61.367"></a><span id="l61.367">         }</span>
<a href="#l61.368"></a><span id="l61.368">         break;</span>
<a href="#l61.369"></a><span id="l61.369">       case nsMsgFilterAction::Forward:</span>
<a href="#l61.370"></a><span id="l61.370">         {</span>
<a href="#l61.371"></a><span id="l61.371">           nsCString forwardTo;</span>
<a href="#l61.372"></a><span id="l61.372">           filterAction-&gt;GetStrValue(forwardTo);</span>
<a href="#l61.373"></a><span id="l61.373">           nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l61.374"></a><span id="l61.374" class="difflineat">@@ -3524,16 +3658,20 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l61.375"></a><span id="l61.375"> </span>
<a href="#l61.376"></a><span id="l61.376">           nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l61.377"></a><span id="l61.377">               do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l61.378"></a><span id="l61.378">           NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l61.379"></a><span id="l61.379">           messageArray-&gt;AppendElement(msgHdr, PR_FALSE);</span>
<a href="#l61.380"></a><span id="l61.380"> </span>
<a href="#l61.381"></a><span id="l61.381">           customAction-&gt;Apply(messageArray, value, nsnull,</span>
<a href="#l61.382"></a><span id="l61.382">                               nsMsgFilterType::InboxRule, msgWindow);</span>
<a href="#l61.383"></a><span id="l61.383" class="difflineplus">+          // allow custom action to affect new</span>
<a href="#l61.384"></a><span id="l61.384" class="difflineplus">+          msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l61.385"></a><span id="l61.385" class="difflineplus">+          if (!(msgFlags &amp; nsMsgMessageFlags::New))</span>
<a href="#l61.386"></a><span id="l61.386" class="difflineplus">+            msgIsNew = PR_FALSE;</span>
<a href="#l61.387"></a><span id="l61.387">         }</span>
<a href="#l61.388"></a><span id="l61.388">         break;</span>
<a href="#l61.389"></a><span id="l61.389"> </span>
<a href="#l61.390"></a><span id="l61.390">         default:</span>
<a href="#l61.391"></a><span id="l61.391">           break;</span>
<a href="#l61.392"></a><span id="l61.392">       }</span>
<a href="#l61.393"></a><span id="l61.393">       if (loggingEnabled)</span>
<a href="#l61.394"></a><span id="l61.394">       {</span>
<a href="#l61.395"></a><span id="l61.395" class="difflineat">@@ -3543,17 +3681,23 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l61.396"></a><span id="l61.396">           (void) filter-&gt;LogRuleHit(filterAction, msgHdr);</span>
<a href="#l61.397"></a><span id="l61.397">       }</span>
<a href="#l61.398"></a><span id="l61.398">     }</span>
<a href="#l61.399"></a><span id="l61.399">   }</span>
<a href="#l61.400"></a><span id="l61.400">   if (!msgIsNew)</span>
<a href="#l61.401"></a><span id="l61.401">   {</span>
<a href="#l61.402"></a><span id="l61.402">     PRInt32 numNewMessages;</span>
<a href="#l61.403"></a><span id="l61.403">     GetNumNewMessages(PR_FALSE, &amp;numNewMessages);</span>
<a href="#l61.404"></a><span id="l61.404" class="difflineminus">-    SetNumNewMessages(numNewMessages - 1);</span>
<a href="#l61.405"></a><span id="l61.405" class="difflineplus">+    // When database notifications are active, new counts will be reset</span>
<a href="#l61.406"></a><span id="l61.406" class="difflineplus">+    // to zero in nsMsgDBFolder::SendFlagNotifications by the call to</span>
<a href="#l61.407"></a><span id="l61.407" class="difflineplus">+    // SetBiffState(nsMsgBiffState_NoMail), so don't repeat them here.</span>
<a href="#l61.408"></a><span id="l61.408" class="difflineplus">+    if (!m_filterListRequiresBody)</span>
<a href="#l61.409"></a><span id="l61.409" class="difflineplus">+      SetNumNewMessages(--numNewMessages);</span>
<a href="#l61.410"></a><span id="l61.410" class="difflineplus">+    if (mDatabase)</span>
<a href="#l61.411"></a><span id="l61.411" class="difflineplus">+      mDatabase-&gt;MarkHdrNotNew(msgHdr, nsnull);</span>
<a href="#l61.412"></a><span id="l61.412">   }</span>
<a href="#l61.413"></a><span id="l61.413">   return NS_OK;</span>
<a href="#l61.414"></a><span id="l61.414"> }</span>
<a href="#l61.415"></a><span id="l61.415"> </span>
<a href="#l61.416"></a><span id="l61.416"> NS_IMETHODIMP nsImapMailFolder::SetImapFlags(const char *uids, PRInt32 flags, nsIURI **url)</span>
<a href="#l61.417"></a><span id="l61.417"> {</span>
<a href="#l61.418"></a><span id="l61.418">   nsresult rv;</span>
<a href="#l61.419"></a><span id="l61.419">   nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l61.420"></a><span id="l61.420" class="difflineat">@@ -4292,16 +4436,71 @@ void nsImapMailFolder::EndOfflineDownloa</span>
<a href="#l61.421"></a><span id="l61.421"> NS_IMETHODIMP</span>
<a href="#l61.422"></a><span id="l61.422"> nsImapMailFolder::NormalEndMsgWriteStream(nsMsgKey uidOfMessage,</span>
<a href="#l61.423"></a><span id="l61.423">                                           PRBool markRead,</span>
<a href="#l61.424"></a><span id="l61.424">                                           nsIImapUrl *imapUrl)</span>
<a href="#l61.425"></a><span id="l61.425"> {</span>
<a href="#l61.426"></a><span id="l61.426">   if (m_offlineHeader)</span>
<a href="#l61.427"></a><span id="l61.427">     EndNewOfflineMessage();</span>
<a href="#l61.428"></a><span id="l61.428">   m_curMsgUid = uidOfMessage;</span>
<a href="#l61.429"></a><span id="l61.429" class="difflineplus">+</span>
<a href="#l61.430"></a><span id="l61.430" class="difflineplus">+  // Apply filter now if it needed a body</span>
<a href="#l61.431"></a><span id="l61.431" class="difflineplus">+  if (m_filterListRequiresBody)</span>
<a href="#l61.432"></a><span id="l61.432" class="difflineplus">+  {</span>
<a href="#l61.433"></a><span id="l61.433" class="difflineplus">+    if (m_filterList)</span>
<a href="#l61.434"></a><span id="l61.434" class="difflineplus">+    {</span>
<a href="#l61.435"></a><span id="l61.435" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; newMsgHdr;</span>
<a href="#l61.436"></a><span id="l61.436" class="difflineplus">+      GetMessageHeader(uidOfMessage, getter_AddRefs(newMsgHdr));</span>
<a href="#l61.437"></a><span id="l61.437" class="difflineplus">+      GetMoveCoalescer();</span>
<a href="#l61.438"></a><span id="l61.438" class="difflineplus">+      nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l61.439"></a><span id="l61.439" class="difflineplus">+      if (imapUrl)</span>
<a href="#l61.440"></a><span id="l61.440" class="difflineplus">+      {</span>
<a href="#l61.441"></a><span id="l61.441" class="difflineplus">+        nsresult rv;</span>
<a href="#l61.442"></a><span id="l61.442" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl;</span>
<a href="#l61.443"></a><span id="l61.443" class="difflineplus">+        msgUrl = do_QueryInterface(imapUrl, &amp;rv);</span>
<a href="#l61.444"></a><span id="l61.444" class="difflineplus">+        if (msgUrl &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l61.445"></a><span id="l61.445" class="difflineplus">+          msgUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l61.446"></a><span id="l61.446" class="difflineplus">+      }</span>
<a href="#l61.447"></a><span id="l61.447" class="difflineplus">+      m_filterList-&gt;ApplyFiltersToHdr(nsMsgFilterType::InboxRule, newMsgHdr,</span>
<a href="#l61.448"></a><span id="l61.448" class="difflineplus">+                                      this, mDatabase, nsnull, nsnull, this,</span>
<a href="#l61.449"></a><span id="l61.449" class="difflineplus">+                                      msgWindow, nsnull);</span>
<a href="#l61.450"></a><span id="l61.450" class="difflineplus">+      NotifyFolderEvent(mFiltersAppliedAtom);</span>
<a href="#l61.451"></a><span id="l61.451" class="difflineplus">+    }</span>
<a href="#l61.452"></a><span id="l61.452" class="difflineplus">+    // Process filter plugins and other items normally done at the end of</span>
<a href="#l61.453"></a><span id="l61.453" class="difflineplus">+    // HeaderFetchCompleted.</span>
<a href="#l61.454"></a><span id="l61.454" class="difflineplus">+    PRBool pendingMoves = m_moveCoalescer &amp;&amp; m_moveCoalescer-&gt;HasPendingMoves();</span>
<a href="#l61.455"></a><span id="l61.455" class="difflineplus">+    PlaybackCoalescedOperations();</span>
<a href="#l61.456"></a><span id="l61.456" class="difflineplus">+</span>
<a href="#l61.457"></a><span id="l61.457" class="difflineplus">+    PRBool filtersRun;</span>
<a href="#l61.458"></a><span id="l61.458" class="difflineplus">+    CallFilterPlugins(nsnull, &amp;filtersRun);</span>
<a href="#l61.459"></a><span id="l61.459" class="difflineplus">+    PRInt32 numNewBiffMsgs = 0;</span>
<a href="#l61.460"></a><span id="l61.460" class="difflineplus">+    if (m_performingBiff)</span>
<a href="#l61.461"></a><span id="l61.461" class="difflineplus">+      GetNumNewMessages(PR_FALSE, &amp;numNewBiffMsgs);</span>
<a href="#l61.462"></a><span id="l61.462" class="difflineplus">+</span>
<a href="#l61.463"></a><span id="l61.463" class="difflineplus">+    if (!filtersRun &amp;&amp; m_performingBiff &amp;&amp; mDatabase &amp;&amp; numNewBiffMsgs &gt; 0 &amp;&amp;</span>
<a href="#l61.464"></a><span id="l61.464" class="difflineplus">+        (!pendingMoves || !ShowPreviewText()))</span>
<a href="#l61.465"></a><span id="l61.465" class="difflineplus">+    {</span>
<a href="#l61.466"></a><span id="l61.466" class="difflineplus">+      // If we are performing biff for this folder, tell the</span>
<a href="#l61.467"></a><span id="l61.467" class="difflineplus">+      // stand-alone biff about the new high water mark</span>
<a href="#l61.468"></a><span id="l61.468" class="difflineplus">+      // We must ensure that the server knows that we are performing biff.</span>
<a href="#l61.469"></a><span id="l61.469" class="difflineplus">+      // Otherwise the stand-alone biff won't fire.</span>
<a href="#l61.470"></a><span id="l61.470" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l61.471"></a><span id="l61.471" class="difflineplus">+      if (NS_SUCCEEDED(GetServer(getter_AddRefs(server))) &amp;&amp; server)</span>
<a href="#l61.472"></a><span id="l61.472" class="difflineplus">+        server-&gt;SetPerformingBiff(PR_TRUE);</span>
<a href="#l61.473"></a><span id="l61.473" class="difflineplus">+</span>
<a href="#l61.474"></a><span id="l61.474" class="difflineplus">+      SetBiffState(nsIMsgFolder::nsMsgBiffState_NewMail);</span>
<a href="#l61.475"></a><span id="l61.475" class="difflineplus">+      if (server)</span>
<a href="#l61.476"></a><span id="l61.476" class="difflineplus">+        server-&gt;SetPerformingBiff(PR_FALSE);</span>
<a href="#l61.477"></a><span id="l61.477" class="difflineplus">+      m_performingBiff = PR_FALSE;</span>
<a href="#l61.478"></a><span id="l61.478" class="difflineplus">+    }</span>
<a href="#l61.479"></a><span id="l61.479" class="difflineplus">+</span>
<a href="#l61.480"></a><span id="l61.480" class="difflineplus">+    if (m_filterList)</span>
<a href="#l61.481"></a><span id="l61.481" class="difflineplus">+      (void)m_filterList-&gt;FlushLogIfNecessary();</span>
<a href="#l61.482"></a><span id="l61.482" class="difflineplus">+  }</span>
<a href="#l61.483"></a><span id="l61.483" class="difflineplus">+</span>
<a href="#l61.484"></a><span id="l61.484">   return NS_OK;</span>
<a href="#l61.485"></a><span id="l61.485"> }</span>
<a href="#l61.486"></a><span id="l61.486"> </span>
<a href="#l61.487"></a><span id="l61.487"> NS_IMETHODIMP</span>
<a href="#l61.488"></a><span id="l61.488"> nsImapMailFolder::AbortMsgWriteStream()</span>
<a href="#l61.489"></a><span id="l61.489"> {</span>
<a href="#l61.490"></a><span id="l61.490">   m_offlineHeader = nsnull;</span>
<a href="#l61.491"></a><span id="l61.491">   return NS_ERROR_FAILURE;</span>
<a href="#l61.492"></a><span id="l61.492" class="difflineat">@@ -5365,16 +5564,18 @@ nsImapMailFolder::HeaderFetchCompleted(n</span>
<a href="#l61.493"></a><span id="l61.493"> </span>
<a href="#l61.494"></a><span id="l61.494">     PRBool autoDownloadNewHeaders = PR_FALSE;</span>
<a href="#l61.495"></a><span id="l61.495">     PRBool autoSyncOfflineStores = PR_FALSE;</span>
<a href="#l61.496"></a><span id="l61.496"> </span>
<a href="#l61.497"></a><span id="l61.497">     if (imapServer)</span>
<a href="#l61.498"></a><span id="l61.498">     {</span>
<a href="#l61.499"></a><span id="l61.499">       imapServer-&gt;GetAutoSyncOfflineStores(&amp;autoSyncOfflineStores);</span>
<a href="#l61.500"></a><span id="l61.500">       imapServer-&gt;GetDownloadBodiesOnGetNewMail(&amp;autoDownloadNewHeaders);</span>
<a href="#l61.501"></a><span id="l61.501" class="difflineplus">+      if (m_filterListRequiresBody)</span>
<a href="#l61.502"></a><span id="l61.502" class="difflineplus">+        autoDownloadNewHeaders = PR_TRUE;</span>
<a href="#l61.503"></a><span id="l61.503">     }</span>
<a href="#l61.504"></a><span id="l61.504">     PRBool notifiedBodies = PR_FALSE;</span>
<a href="#l61.505"></a><span id="l61.505">     if (m_downloadingFolderForOfflineUse || autoSyncOfflineStores ||</span>
<a href="#l61.506"></a><span id="l61.506">         autoDownloadNewHeaders)</span>
<a href="#l61.507"></a><span id="l61.507">     {</span>
<a href="#l61.508"></a><span id="l61.508">       nsTArray&lt;nsMsgKey&gt; keysToDownload;</span>
<a href="#l61.509"></a><span id="l61.509">       GetBodysToDownload(&amp;keysToDownload);</span>
<a href="#l61.510"></a><span id="l61.510">       if (!keysToDownload.IsEmpty())</span>
<a href="#l61.511"></a><span id="l61.511" class="difflineat">@@ -5405,40 +5606,41 @@ nsImapMailFolder::HeaderFetchCompleted(n</span>
<a href="#l61.512"></a><span id="l61.512">     if (runningUri)</span>
<a href="#l61.513"></a><span id="l61.513">     {</span>
<a href="#l61.514"></a><span id="l61.514">       nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(runningUri);</span>
<a href="#l61.515"></a><span id="l61.515">       if (mailnewsUrl)</span>
<a href="#l61.516"></a><span id="l61.516">         mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l61.517"></a><span id="l61.517">     }</span>
<a href="#l61.518"></a><span id="l61.518">   }</span>
<a href="#l61.519"></a><span id="l61.519"> </span>
<a href="#l61.520"></a><span id="l61.520" class="difflineminus">-  PRBool filtersRun;</span>
<a href="#l61.521"></a><span id="l61.521" class="difflineminus">-  CallFilterPlugins(msgWindow, &amp;filtersRun);</span>
<a href="#l61.522"></a><span id="l61.522" class="difflineminus">-  if (!filtersRun &amp;&amp; m_performingBiff &amp;&amp; mDatabase &amp;&amp; numNewBiffMsgs &gt; 0 &amp;&amp;</span>
<a href="#l61.523"></a><span id="l61.523" class="difflineminus">-      (!pendingMoves || !ShowPreviewText()))</span>
<a href="#l61.524"></a><span id="l61.524" class="difflineminus">-  {</span>
<a href="#l61.525"></a><span id="l61.525" class="difflineminus">-    if (!pendingMoves)</span>
<a href="#l61.526"></a><span id="l61.526" class="difflineminus">-      SetHasNewMessages(PR_TRUE);</span>
<a href="#l61.527"></a><span id="l61.527" class="difflineminus">-</span>
<a href="#l61.528"></a><span id="l61.528" class="difflineminus">-    // If we are performing biff for this folder, tell the</span>
<a href="#l61.529"></a><span id="l61.529" class="difflineminus">-    // stand-alone biff about the new high water mark</span>
<a href="#l61.530"></a><span id="l61.530" class="difflineminus">-    // We must ensure that the server knows that we are performing biff.</span>
<a href="#l61.531"></a><span id="l61.531" class="difflineminus">-    // Otherwise the stand-alone biff won't fire.</span>
<a href="#l61.532"></a><span id="l61.532" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l61.533"></a><span id="l61.533" class="difflineminus">-    if (NS_SUCCEEDED(GetServer(getter_AddRefs(server))) &amp;&amp; server)</span>
<a href="#l61.534"></a><span id="l61.534" class="difflineminus">-      server-&gt;SetPerformingBiff(PR_TRUE);</span>
<a href="#l61.535"></a><span id="l61.535" class="difflineminus">-</span>
<a href="#l61.536"></a><span id="l61.536" class="difflineminus">-    SetBiffState(nsIMsgFolder::nsMsgBiffState_NewMail);</span>
<a href="#l61.537"></a><span id="l61.537" class="difflineminus">-    if (server)</span>
<a href="#l61.538"></a><span id="l61.538" class="difflineminus">-      server-&gt;SetPerformingBiff(PR_FALSE);</span>
<a href="#l61.539"></a><span id="l61.539" class="difflineminus">-    m_performingBiff = PR_FALSE;</span>
<a href="#l61.540"></a><span id="l61.540" class="difflineminus">-  }</span>
<a href="#l61.541"></a><span id="l61.541" class="difflineminus">-</span>
<a href="#l61.542"></a><span id="l61.542" class="difflineminus">-  if (m_filterList)</span>
<a href="#l61.543"></a><span id="l61.543" class="difflineminus">-    (void)m_filterList-&gt;FlushLogIfNecessary();</span>
<a href="#l61.544"></a><span id="l61.544" class="difflineplus">+  // delay calling plugins if filter application is also delayed</span>
<a href="#l61.545"></a><span id="l61.545" class="difflineplus">+  if (!m_filterListRequiresBody)</span>
<a href="#l61.546"></a><span id="l61.546" class="difflineplus">+  {</span>
<a href="#l61.547"></a><span id="l61.547" class="difflineplus">+    PRBool filtersRun;</span>
<a href="#l61.548"></a><span id="l61.548" class="difflineplus">+    CallFilterPlugins(msgWindow, &amp;filtersRun);</span>
<a href="#l61.549"></a><span id="l61.549" class="difflineplus">+    if (!filtersRun &amp;&amp; m_performingBiff &amp;&amp; mDatabase &amp;&amp; numNewBiffMsgs &gt; 0 &amp;&amp;</span>
<a href="#l61.550"></a><span id="l61.550" class="difflineplus">+        (!pendingMoves || !ShowPreviewText()))</span>
<a href="#l61.551"></a><span id="l61.551" class="difflineplus">+    {</span>
<a href="#l61.552"></a><span id="l61.552" class="difflineplus">+      // If we are performing biff for this folder, tell the</span>
<a href="#l61.553"></a><span id="l61.553" class="difflineplus">+      // stand-alone biff about the new high water mark</span>
<a href="#l61.554"></a><span id="l61.554" class="difflineplus">+      // We must ensure that the server knows that we are performing biff.</span>
<a href="#l61.555"></a><span id="l61.555" class="difflineplus">+      // Otherwise the stand-alone biff won't fire.</span>
<a href="#l61.556"></a><span id="l61.556" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l61.557"></a><span id="l61.557" class="difflineplus">+      if (NS_SUCCEEDED(GetServer(getter_AddRefs(server))) &amp;&amp; server)</span>
<a href="#l61.558"></a><span id="l61.558" class="difflineplus">+        server-&gt;SetPerformingBiff(PR_TRUE);</span>
<a href="#l61.559"></a><span id="l61.559" class="difflineplus">+</span>
<a href="#l61.560"></a><span id="l61.560" class="difflineplus">+      SetBiffState(nsIMsgFolder::nsMsgBiffState_NewMail);</span>
<a href="#l61.561"></a><span id="l61.561" class="difflineplus">+      if (server)</span>
<a href="#l61.562"></a><span id="l61.562" class="difflineplus">+        server-&gt;SetPerformingBiff(PR_FALSE);</span>
<a href="#l61.563"></a><span id="l61.563" class="difflineplus">+      m_performingBiff = PR_FALSE;</span>
<a href="#l61.564"></a><span id="l61.564" class="difflineplus">+    }</span>
<a href="#l61.565"></a><span id="l61.565" class="difflineplus">+</span>
<a href="#l61.566"></a><span id="l61.566" class="difflineplus">+    if (m_filterList)</span>
<a href="#l61.567"></a><span id="l61.567" class="difflineplus">+      (void)m_filterList-&gt;FlushLogIfNecessary();</span>
<a href="#l61.568"></a><span id="l61.568" class="difflineplus">+  }</span>
<a href="#l61.569"></a><span id="l61.569"> </span>
<a href="#l61.570"></a><span id="l61.570">   return NS_OK;</span>
<a href="#l61.571"></a><span id="l61.571"> }</span>
<a href="#l61.572"></a><span id="l61.572"> </span>
<a href="#l61.573"></a><span id="l61.573"> NS_IMETHODIMP</span>
<a href="#l61.574"></a><span id="l61.574"> nsImapMailFolder::SetBiffStateAndUpdate(nsMsgBiffState biffState)</span>
<a href="#l61.575"></a><span id="l61.575"> {</span>
<a href="#l61.576"></a><span id="l61.576">   SetBiffState(biffState);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -502,16 +502,17 @@ protected:</span>
<a href="#l62.4"></a><span id="l62.4">   nsMsgIMAPFolderACL *m_folderACL;</span>
<a href="#l62.5"></a><span id="l62.5">   PRUint32     m_aclFlags;</span>
<a href="#l62.6"></a><span id="l62.6">   PRUint32     m_supportedUserFlags;</span>
<a href="#l62.7"></a><span id="l62.7"> </span>
<a href="#l62.8"></a><span id="l62.8">   static nsIAtom* mImapHdrDownloadedAtom;</span>
<a href="#l62.9"></a><span id="l62.9"> </span>
<a href="#l62.10"></a><span id="l62.10">   // offline imap support</span>
<a href="#l62.11"></a><span id="l62.11">   PRBool m_downloadingFolderForOfflineUse;</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineplus">+  PRBool m_filterListRequiresBody;</span>
<a href="#l62.13"></a><span id="l62.13">   </span>
<a href="#l62.14"></a><span id="l62.14">   // auto-sync (preemptive download) support</span>
<a href="#l62.15"></a><span id="l62.15">   nsRefPtr&lt;nsAutoSyncState&gt; m_autoSyncStateObj;</span>
<a href="#l62.16"></a><span id="l62.16">   </span>
<a href="#l62.17"></a><span id="l62.17">   // Quota support</span>
<a href="#l62.18"></a><span id="l62.18">   nsCString m_folderQuotaRoot;</span>
<a href="#l62.19"></a><span id="l62.19">   PRUint32 m_folderQuotaUsedKB;</span>
<a href="#l62.20"></a><span id="l62.20">   PRUint32 m_folderQuotaMaxKB;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -764,16 +764,18 @@ nsresult nsImapProtocol::SetupWithUrl(ns</span>
<a href="#l63.4"></a><span id="l63.4">       // if we have a listener from a mock channel, over-ride the consumer that was passed in</span>
<a href="#l63.5"></a><span id="l63.5">       nsCOMPtr&lt;nsIStreamListener&gt; channelListener;</span>
<a href="#l63.6"></a><span id="l63.6">       m_mockChannel-&gt;GetChannelListener(getter_AddRefs(channelListener));</span>
<a href="#l63.7"></a><span id="l63.7">       if (channelListener) // only over-ride if we have a non null channel listener</span>
<a href="#l63.8"></a><span id="l63.8">         aRealStreamListener = channelListener;</span>
<a href="#l63.9"></a><span id="l63.9">       m_mockChannel-&gt;GetChannelContext(getter_AddRefs(m_channelContext));</span>
<a href="#l63.10"></a><span id="l63.10">       nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l63.11"></a><span id="l63.11">       GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineplus">+      if (!msgWindow)</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineplus">+        GetTopmostMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l63.14"></a><span id="l63.14">       if (msgWindow)</span>
<a href="#l63.15"></a><span id="l63.15">       {</span>
<a href="#l63.16"></a><span id="l63.16">         nsCOMPtr&lt;nsIInterfaceRequestor&gt; interfaceRequestor;</span>
<a href="#l63.17"></a><span id="l63.17">         msgWindow-&gt;GetNotificationCallbacks(getter_AddRefs(interfaceRequestor));</span>
<a href="#l63.18"></a><span id="l63.18">         m_mockChannel-&gt;SetNotificationCallbacks(interfaceRequestor);</span>
<a href="#l63.19"></a><span id="l63.19">       }</span>
<a href="#l63.20"></a><span id="l63.20">     }</span>
<a href="#l63.21"></a><span id="l63.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1">new file mode 100644</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineminus">--- /dev/null</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFilterActions.js</span>
<a href="#l64.4"></a><span id="l64.4" class="difflineat">@@ -0,0 +1,774 @@</span>
<a href="#l64.5"></a><span id="l64.5" class="difflineplus">+/*</span>
<a href="#l64.6"></a><span id="l64.6" class="difflineplus">+ * This file tests imap filter actions, particularly as affected by the</span>
<a href="#l64.7"></a><span id="l64.7" class="difflineplus">+ * addition of body searches in bug 127250. Actions that involves sending</span>
<a href="#l64.8"></a><span id="l64.8" class="difflineplus">+ * mail are not tested. The tests check various counts, and the effects</span>
<a href="#l64.9"></a><span id="l64.9" class="difflineplus">+ * on the message database of the filters. Effects on IMAP server</span>
<a href="#l64.10"></a><span id="l64.10" class="difflineplus">+ * flags, if any, are not tested.</span>
<a href="#l64.11"></a><span id="l64.11" class="difflineplus">+ *</span>
<a href="#l64.12"></a><span id="l64.12" class="difflineplus">+ * Original author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineplus">+ * adapted from test_localToImapFilter.js</span>
<a href="#l64.14"></a><span id="l64.14" class="difflineplus">+ */</span>
<a href="#l64.15"></a><span id="l64.15" class="difflineplus">+</span>
<a href="#l64.16"></a><span id="l64.16" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l64.17"></a><span id="l64.17" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/folderUtils.jsm&quot;);</span>
<a href="#l64.18"></a><span id="l64.18" class="difflineplus">+</span>
<a href="#l64.19"></a><span id="l64.19" class="difflineplus">+const nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l64.20"></a><span id="l64.20" class="difflineplus">+const nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l64.21"></a><span id="l64.21" class="difflineplus">+const nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l64.22"></a><span id="l64.22" class="difflineplus">+const Is = nsMsgSearchOp.Is;</span>
<a href="#l64.23"></a><span id="l64.23" class="difflineplus">+const Contains = nsMsgSearchOp.Contains;</span>
<a href="#l64.24"></a><span id="l64.24" class="difflineplus">+const Subject = nsMsgSearchAttrib.Subject;</span>
<a href="#l64.25"></a><span id="l64.25" class="difflineplus">+const Body = nsMsgSearchAttrib.Body;</span>
<a href="#l64.26"></a><span id="l64.26" class="difflineplus">+</span>
<a href="#l64.27"></a><span id="l64.27" class="difflineplus">+// Globals</span>
<a href="#l64.28"></a><span id="l64.28" class="difflineplus">+var gIMAPDaemon; // the imap fake server daemon</span>
<a href="#l64.29"></a><span id="l64.29" class="difflineplus">+var gServer; // the imap fake server</span>
<a href="#l64.30"></a><span id="l64.30" class="difflineplus">+var gIMAPIncomingServer; // nsIMsgIncomingServer for the imap server</span>
<a href="#l64.31"></a><span id="l64.31" class="difflineplus">+var gRootFolder; // root message folder for the imap server</span>
<a href="#l64.32"></a><span id="l64.32" class="difflineplus">+var gIMAPInbox; // imap inbox message folder</span>
<a href="#l64.33"></a><span id="l64.33" class="difflineplus">+var gIMAPTrashFolder; // imap trash message folder</span>
<a href="#l64.34"></a><span id="l64.34" class="difflineplus">+var gSubfolder; // a local message folder used as a target for moves and copies</span>
<a href="#l64.35"></a><span id="l64.35" class="difflineplus">+var gLastKey; // the last message key</span>
<a href="#l64.36"></a><span id="l64.36" class="difflineplus">+var gFilter; // a message filter with a subject search</span>
<a href="#l64.37"></a><span id="l64.37" class="difflineplus">+var gAction; // current message action (reused)</span>
<a href="#l64.38"></a><span id="l64.38" class="difflineplus">+var gBodyFilter; // a message filter with a body search</span>
<a href="#l64.39"></a><span id="l64.39" class="difflineplus">+var gInboxListener; // database listener object</span>
<a href="#l64.40"></a><span id="l64.40" class="difflineplus">+var gContinueListener; // what listener is used to continue the test?</span>
<a href="#l64.41"></a><span id="l64.41" class="difflineplus">+var gHeader; // the current message db header</span>
<a href="#l64.42"></a><span id="l64.42" class="difflineplus">+var gChecks; // the function that will be used to check the results of the filter</span>
<a href="#l64.43"></a><span id="l64.43" class="difflineplus">+var gInboxCount; // the previous number of messages in the Inbox</span>
<a href="#l64.44"></a><span id="l64.44" class="difflineplus">+var gSubfolderCount; // the previous number of messages in the subfolder</span>
<a href="#l64.45"></a><span id="l64.45" class="difflineplus">+var gMoveCallbackCount; // the number of callbacks from the move listener</span>
<a href="#l64.46"></a><span id="l64.46" class="difflineplus">+const gMessage = &quot;draft1&quot;; // message file used as the test message</span>
<a href="#l64.47"></a><span id="l64.47" class="difflineplus">+</span>
<a href="#l64.48"></a><span id="l64.48" class="difflineplus">+// subject of the test message</span>
<a href="#l64.49"></a><span id="l64.49" class="difflineplus">+const gMessageSubject = &quot;Hello, did you receive my bugmail?&quot;;</span>
<a href="#l64.50"></a><span id="l64.50" class="difflineplus">+</span>
<a href="#l64.51"></a><span id="l64.51" class="difflineplus">+// a string in the body of the test message</span>
<a href="#l64.52"></a><span id="l64.52" class="difflineplus">+const gMessageInBody = &quot;an HTML message&quot;;</span>
<a href="#l64.53"></a><span id="l64.53" class="difflineplus">+</span>
<a href="#l64.54"></a><span id="l64.54" class="difflineplus">+// various object references</span>
<a href="#l64.55"></a><span id="l64.55" class="difflineplus">+const gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l64.56"></a><span id="l64.56" class="difflineplus">+                       .getService(Ci.nsIMsgCopyService);</span>
<a href="#l64.57"></a><span id="l64.57" class="difflineplus">+const gDbService = Components.classes[&quot;@mozilla.org/msgDatabase/msgDBService;1&quot;]</span>
<a href="#l64.58"></a><span id="l64.58" class="difflineplus">+                             .getService(Components.interfaces.nsIMsgDBService);</span>
<a href="#l64.59"></a><span id="l64.59" class="difflineplus">+const gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l64.60"></a><span id="l64.60" class="difflineplus">+                       .getService(Ci.nsIMsgMessageService);</span>
<a href="#l64.61"></a><span id="l64.61" class="difflineplus">+const gMailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l64.62"></a><span id="l64.62" class="difflineplus">+                     .getService(Ci.nsIMsgMailSession);</span>
<a href="#l64.63"></a><span id="l64.63" class="difflineplus">+const kFiltersAppliedAtom = Cc[&quot;@mozilla.org/atom-service;1&quot;]</span>
<a href="#l64.64"></a><span id="l64.64" class="difflineplus">+                              .getService(Ci.nsIAtomService)</span>
<a href="#l64.65"></a><span id="l64.65" class="difflineplus">+                              .getAtom(&quot;FiltersApplied&quot;);</span>
<a href="#l64.66"></a><span id="l64.66" class="difflineplus">+const kDeleteOrMoveMsgCompleted = Cc[&quot;@mozilla.org/atom-service;1&quot;]</span>
<a href="#l64.67"></a><span id="l64.67" class="difflineplus">+                                    .getService(Ci.nsIAtomService)</span>
<a href="#l64.68"></a><span id="l64.68" class="difflineplus">+                                    .getAtom(&quot;DeleteOrMoveMsgCompleted&quot;);</span>
<a href="#l64.69"></a><span id="l64.69" class="difflineplus">+</span>
<a href="#l64.70"></a><span id="l64.70" class="difflineplus">+// Definition of tests. The test function name is the filter action</span>
<a href="#l64.71"></a><span id="l64.71" class="difflineplus">+// being tested, with &quot;Body&quot; appended to tests that use delayed</span>
<a href="#l64.72"></a><span id="l64.72" class="difflineplus">+// application of filters due to a body search</span>
<a href="#l64.73"></a><span id="l64.73" class="difflineplus">+const gTestArray =</span>
<a href="#l64.74"></a><span id="l64.74" class="difflineplus">+[  // The initial tests do not result in new messages added.</span>
<a href="#l64.75"></a><span id="l64.75" class="difflineplus">+  function MoveToFolder() {</span>
<a href="#l64.76"></a><span id="l64.76" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l64.77"></a><span id="l64.77" class="difflineplus">+    gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l64.78"></a><span id="l64.78" class="difflineplus">+    gChecks = function checkMoveToFolder() {</span>
<a href="#l64.79"></a><span id="l64.79" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l64.80"></a><span id="l64.80" class="difflineplus">+      do_check_eq(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l64.81"></a><span id="l64.81" class="difflineplus">+      // no net messages were added to the inbox</span>
<a href="#l64.82"></a><span id="l64.82" class="difflineplus">+      do_check_eq(gInboxCount, folderCount(gIMAPInbox));</span>
<a href="#l64.83"></a><span id="l64.83" class="difflineplus">+    }</span>
<a href="#l64.84"></a><span id="l64.84" class="difflineplus">+    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l64.85"></a><span id="l64.85" class="difflineplus">+    gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l64.86"></a><span id="l64.86" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l64.87"></a><span id="l64.87" class="difflineplus">+  },</span>
<a href="#l64.88"></a><span id="l64.88" class="difflineplus">+  function MoveToFolderBody() {</span>
<a href="#l64.89"></a><span id="l64.89" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l64.90"></a><span id="l64.90" class="difflineplus">+    gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l64.91"></a><span id="l64.91" class="difflineplus">+    gChecks = function checkMoveToFolderBody() {</span>
<a href="#l64.92"></a><span id="l64.92" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l64.93"></a><span id="l64.93" class="difflineplus">+      do_check_eq(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l64.94"></a><span id="l64.94" class="difflineplus">+      // no net messsages were added to the inbox</span>
<a href="#l64.95"></a><span id="l64.95" class="difflineplus">+      do_check_eq(gInboxCount, folderCount(gIMAPInbox));</span>
<a href="#l64.96"></a><span id="l64.96" class="difflineplus">+    }</span>
<a href="#l64.97"></a><span id="l64.97" class="difflineplus">+    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l64.98"></a><span id="l64.98" class="difflineplus">+    gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l64.99"></a><span id="l64.99" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l64.100"></a><span id="l64.100" class="difflineplus">+  },</span>
<a href="#l64.101"></a><span id="l64.101" class="difflineplus">+  function MarkRead() {</span>
<a href="#l64.102"></a><span id="l64.102" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MarkRead;</span>
<a href="#l64.103"></a><span id="l64.103" class="difflineplus">+    gChecks = function checks() {</span>
<a href="#l64.104"></a><span id="l64.104" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l64.105"></a><span id="l64.105" class="difflineplus">+      do_check_true(gHeader.isRead);</span>
<a href="#l64.106"></a><span id="l64.106" class="difflineplus">+    }</span>
<a href="#l64.107"></a><span id="l64.107" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l64.108"></a><span id="l64.108" class="difflineplus">+  },</span>
<a href="#l64.109"></a><span id="l64.109" class="difflineplus">+  function MarkReadBody() {</span>
<a href="#l64.110"></a><span id="l64.110" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MarkRead;</span>
<a href="#l64.111"></a><span id="l64.111" class="difflineplus">+    gChecks = function checkMarkRead() {</span>
<a href="#l64.112"></a><span id="l64.112" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l64.113"></a><span id="l64.113" class="difflineplus">+      do_check_true(gHeader.isRead);</span>
<a href="#l64.114"></a><span id="l64.114" class="difflineplus">+    }</span>
<a href="#l64.115"></a><span id="l64.115" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l64.116"></a><span id="l64.116" class="difflineplus">+</span>
<a href="#l64.117"></a><span id="l64.117" class="difflineplus">+  },</span>
<a href="#l64.118"></a><span id="l64.118" class="difflineplus">+  function KillThread() {</span>
<a href="#l64.119"></a><span id="l64.119" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.KillThread;</span>
<a href="#l64.120"></a><span id="l64.120" class="difflineplus">+    gChecks = function checkKillThread() {</span>
<a href="#l64.121"></a><span id="l64.121" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l64.122"></a><span id="l64.122" class="difflineplus">+      let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l64.123"></a><span id="l64.123" class="difflineplus">+      do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l64.124"></a><span id="l64.124" class="difflineplus">+    }</span>
<a href="#l64.125"></a><span id="l64.125" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l64.126"></a><span id="l64.126" class="difflineplus">+  },</span>
<a href="#l64.127"></a><span id="l64.127" class="difflineplus">+  function KillThreadBody() {</span>
<a href="#l64.128"></a><span id="l64.128" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.KillThread;</span>
<a href="#l64.129"></a><span id="l64.129" class="difflineplus">+    gChecks = function checkKillThread() {</span>
<a href="#l64.130"></a><span id="l64.130" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l64.131"></a><span id="l64.131" class="difflineplus">+      let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l64.132"></a><span id="l64.132" class="difflineplus">+      do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l64.133"></a><span id="l64.133" class="difflineplus">+    }</span>
<a href="#l64.134"></a><span id="l64.134" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l64.135"></a><span id="l64.135" class="difflineplus">+  },</span>
<a href="#l64.136"></a><span id="l64.136" class="difflineplus">+  function KillSubthread() {</span>
<a href="#l64.137"></a><span id="l64.137" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.KillSubthread;</span>
<a href="#l64.138"></a><span id="l64.138" class="difflineplus">+    gChecks = function checkKillSubthread() {</span>
<a href="#l64.139"></a><span id="l64.139" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l64.140"></a><span id="l64.140" class="difflineplus">+      do_check_neq(0, gHeader.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l64.141"></a><span id="l64.141" class="difflineplus">+    }</span>
<a href="#l64.142"></a><span id="l64.142" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l64.143"></a><span id="l64.143" class="difflineplus">+  },</span>
<a href="#l64.144"></a><span id="l64.144" class="difflineplus">+  function KillSubthreadBody() {</span>
<a href="#l64.145"></a><span id="l64.145" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.KillSubthread;</span>
<a href="#l64.146"></a><span id="l64.146" class="difflineplus">+    gChecks = function checkKillSubthreadBody() {</span>
<a href="#l64.147"></a><span id="l64.147" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l64.148"></a><span id="l64.148" class="difflineplus">+      do_check_neq(0, gHeader.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l64.149"></a><span id="l64.149" class="difflineplus">+    }</span>
<a href="#l64.150"></a><span id="l64.150" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l64.151"></a><span id="l64.151" class="difflineplus">+  },</span>
<a href="#l64.152"></a><span id="l64.152" class="difflineplus">+  // this tests for marking message as junk</span>
<a href="#l64.153"></a><span id="l64.153" class="difflineplus">+  function JunkScore() {</span>
<a href="#l64.154"></a><span id="l64.154" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l64.155"></a><span id="l64.155" class="difflineplus">+    gAction.junkScore = 100;</span>
<a href="#l64.156"></a><span id="l64.156" class="difflineplus">+    gChecks = function checkJunkScore() {</span>
<a href="#l64.157"></a><span id="l64.157" class="difflineplus">+      // marking as junk resets new but not unread</span>
<a href="#l64.158"></a><span id="l64.158" class="difflineplus">+      testCounts(false, 1, 0, 0);</span>
<a href="#l64.159"></a><span id="l64.159" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;100&quot;);</span>
<a href="#l64.160"></a><span id="l64.160" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l64.161"></a><span id="l64.161" class="difflineplus">+    }</span>
<a href="#l64.162"></a><span id="l64.162" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l64.163"></a><span id="l64.163" class="difflineplus">+  },</span>
<a href="#l64.164"></a><span id="l64.164" class="difflineplus">+  // this tests for marking message as junk</span>
<a href="#l64.165"></a><span id="l64.165" class="difflineplus">+  function JunkScoreBody() {</span>
<a href="#l64.166"></a><span id="l64.166" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l64.167"></a><span id="l64.167" class="difflineplus">+    gAction.junkScore = 100;</span>
<a href="#l64.168"></a><span id="l64.168" class="difflineplus">+    gChecks = function checkJunkScoreBody() {</span>
<a href="#l64.169"></a><span id="l64.169" class="difflineplus">+      // marking as junk resets new but not unread</span>
<a href="#l64.170"></a><span id="l64.170" class="difflineplus">+      testCounts(false, 1, 0, 0);</span>
<a href="#l64.171"></a><span id="l64.171" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;100&quot;);</span>
<a href="#l64.172"></a><span id="l64.172" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l64.173"></a><span id="l64.173" class="difflineplus">+    }</span>
<a href="#l64.174"></a><span id="l64.174" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l64.175"></a><span id="l64.175" class="difflineplus">+  },</span>
<a href="#l64.176"></a><span id="l64.176" class="difflineplus">+</span>
<a href="#l64.177"></a><span id="l64.177" class="difflineplus">+  // The remaining tests add new messages</span>
<a href="#l64.178"></a><span id="l64.178" class="difflineplus">+  function WatchThread() {</span>
<a href="#l64.179"></a><span id="l64.179" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.WatchThread;</span>
<a href="#l64.180"></a><span id="l64.180" class="difflineplus">+    gChecks = function checkWatchThread() {</span>
<a href="#l64.181"></a><span id="l64.181" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l64.182"></a><span id="l64.182" class="difflineplus">+      let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l64.183"></a><span id="l64.183" class="difflineplus">+      do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Watched);</span>
<a href="#l64.184"></a><span id="l64.184" class="difflineplus">+    }</span>
<a href="#l64.185"></a><span id="l64.185" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l64.186"></a><span id="l64.186" class="difflineplus">+  },</span>
<a href="#l64.187"></a><span id="l64.187" class="difflineplus">+  function WatchThreadBody() {</span>
<a href="#l64.188"></a><span id="l64.188" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.WatchThread;</span>
<a href="#l64.189"></a><span id="l64.189" class="difflineplus">+    gChecks = function checkWatchThreadBody() {</span>
<a href="#l64.190"></a><span id="l64.190" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l64.191"></a><span id="l64.191" class="difflineplus">+      let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l64.192"></a><span id="l64.192" class="difflineplus">+      do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Watched);</span>
<a href="#l64.193"></a><span id="l64.193" class="difflineplus">+    }</span>
<a href="#l64.194"></a><span id="l64.194" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l64.195"></a><span id="l64.195" class="difflineplus">+  },</span>
<a href="#l64.196"></a><span id="l64.196" class="difflineplus">+  function MarkFlagged() {</span>
<a href="#l64.197"></a><span id="l64.197" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MarkFlagged;</span>
<a href="#l64.198"></a><span id="l64.198" class="difflineplus">+    gChecks = function checkMarkFlagged() {</span>
<a href="#l64.199"></a><span id="l64.199" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l64.200"></a><span id="l64.200" class="difflineplus">+      do_check_true(gHeader.isFlagged);</span>
<a href="#l64.201"></a><span id="l64.201" class="difflineplus">+    }</span>
<a href="#l64.202"></a><span id="l64.202" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l64.203"></a><span id="l64.203" class="difflineplus">+  },</span>
<a href="#l64.204"></a><span id="l64.204" class="difflineplus">+  function MarkFlaggedBody() {</span>
<a href="#l64.205"></a><span id="l64.205" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MarkFlagged;</span>
<a href="#l64.206"></a><span id="l64.206" class="difflineplus">+    gChecks = function checkMarkFlaggedBody() {</span>
<a href="#l64.207"></a><span id="l64.207" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l64.208"></a><span id="l64.208" class="difflineplus">+      do_check_true(gHeader.isFlagged);</span>
<a href="#l64.209"></a><span id="l64.209" class="difflineplus">+    }</span>
<a href="#l64.210"></a><span id="l64.210" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l64.211"></a><span id="l64.211" class="difflineplus">+  },</span>
<a href="#l64.212"></a><span id="l64.212" class="difflineplus">+  function ChangePriority() {</span>
<a href="#l64.213"></a><span id="l64.213" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.ChangePriority;</span>
<a href="#l64.214"></a><span id="l64.214" class="difflineplus">+    gAction.priority = Ci.nsMsgPriority.highest;</span>
<a href="#l64.215"></a><span id="l64.215" class="difflineplus">+    gChecks = function checkChangePriority() {</span>
<a href="#l64.216"></a><span id="l64.216" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l64.217"></a><span id="l64.217" class="difflineplus">+      do_check_eq(Ci.nsMsgPriority.highest, gHeader.priority);</span>
<a href="#l64.218"></a><span id="l64.218" class="difflineplus">+    }</span>
<a href="#l64.219"></a><span id="l64.219" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l64.220"></a><span id="l64.220" class="difflineplus">+  },</span>
<a href="#l64.221"></a><span id="l64.221" class="difflineplus">+  function ChangePriorityBody() {</span>
<a href="#l64.222"></a><span id="l64.222" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.ChangePriority;</span>
<a href="#l64.223"></a><span id="l64.223" class="difflineplus">+    gAction.priority = Ci.nsMsgPriority.highest;</span>
<a href="#l64.224"></a><span id="l64.224" class="difflineplus">+    gChecks = function checkChangePriorityBody() {</span>
<a href="#l64.225"></a><span id="l64.225" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l64.226"></a><span id="l64.226" class="difflineplus">+      do_check_eq(Ci.nsMsgPriority.highest, gHeader.priority);</span>
<a href="#l64.227"></a><span id="l64.227" class="difflineplus">+    }</span>
<a href="#l64.228"></a><span id="l64.228" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l64.229"></a><span id="l64.229" class="difflineplus">+  },</span>
<a href="#l64.230"></a><span id="l64.230" class="difflineplus">+  function Label() {</span>
<a href="#l64.231"></a><span id="l64.231" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.Label;</span>
<a href="#l64.232"></a><span id="l64.232" class="difflineplus">+    gAction.label = 2;</span>
<a href="#l64.233"></a><span id="l64.233" class="difflineplus">+    gChecks = function checkLabel() {</span>
<a href="#l64.234"></a><span id="l64.234" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l64.235"></a><span id="l64.235" class="difflineplus">+      do_check_eq(2, gHeader.label);</span>
<a href="#l64.236"></a><span id="l64.236" class="difflineplus">+    }</span>
<a href="#l64.237"></a><span id="l64.237" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l64.238"></a><span id="l64.238" class="difflineplus">+  },</span>
<a href="#l64.239"></a><span id="l64.239" class="difflineplus">+  function LabelBody() {</span>
<a href="#l64.240"></a><span id="l64.240" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.Label;</span>
<a href="#l64.241"></a><span id="l64.241" class="difflineplus">+    gAction.label = 3;</span>
<a href="#l64.242"></a><span id="l64.242" class="difflineplus">+    gChecks = function checkLabelBody() {</span>
<a href="#l64.243"></a><span id="l64.243" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l64.244"></a><span id="l64.244" class="difflineplus">+      do_check_eq(3, gHeader.label);</span>
<a href="#l64.245"></a><span id="l64.245" class="difflineplus">+    }</span>
<a href="#l64.246"></a><span id="l64.246" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l64.247"></a><span id="l64.247" class="difflineplus">+  },</span>
<a href="#l64.248"></a><span id="l64.248" class="difflineplus">+  function AddTag() {</span>
<a href="#l64.249"></a><span id="l64.249" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.AddTag;</span>
<a href="#l64.250"></a><span id="l64.250" class="difflineplus">+    gAction.strValue = &quot;TheTag&quot;;</span>
<a href="#l64.251"></a><span id="l64.251" class="difflineplus">+    gChecks = function checkAddTag() {</span>
<a href="#l64.252"></a><span id="l64.252" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l64.253"></a><span id="l64.253" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;keywords&quot;), &quot;TheTag&quot;);</span>
<a href="#l64.254"></a><span id="l64.254" class="difflineplus">+    }</span>
<a href="#l64.255"></a><span id="l64.255" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l64.256"></a><span id="l64.256" class="difflineplus">+  },</span>
<a href="#l64.257"></a><span id="l64.257" class="difflineplus">+  function AddTagBody() {</span>
<a href="#l64.258"></a><span id="l64.258" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.AddTag;</span>
<a href="#l64.259"></a><span id="l64.259" class="difflineplus">+    gAction.strValue = &quot;TheTag2&quot;;</span>
<a href="#l64.260"></a><span id="l64.260" class="difflineplus">+    gChecks = function checkAddTagBody() {</span>
<a href="#l64.261"></a><span id="l64.261" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l64.262"></a><span id="l64.262" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;keywords&quot;), &quot;TheTag2&quot;);</span>
<a href="#l64.263"></a><span id="l64.263" class="difflineplus">+    }</span>
<a href="#l64.264"></a><span id="l64.264" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l64.265"></a><span id="l64.265" class="difflineplus">+  },</span>
<a href="#l64.266"></a><span id="l64.266" class="difflineplus">+  // this tests for marking message as good</span>
<a href="#l64.267"></a><span id="l64.267" class="difflineplus">+  function JunkScoreAsGood() {</span>
<a href="#l64.268"></a><span id="l64.268" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l64.269"></a><span id="l64.269" class="difflineplus">+    gAction.junkScore = 0;</span>
<a href="#l64.270"></a><span id="l64.270" class="difflineplus">+    gChecks = function checkJunkScore() {</span>
<a href="#l64.271"></a><span id="l64.271" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l64.272"></a><span id="l64.272" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;0&quot;);</span>
<a href="#l64.273"></a><span id="l64.273" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l64.274"></a><span id="l64.274" class="difflineplus">+    }</span>
<a href="#l64.275"></a><span id="l64.275" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l64.276"></a><span id="l64.276" class="difflineplus">+  },</span>
<a href="#l64.277"></a><span id="l64.277" class="difflineplus">+  // this tests for marking message as good</span>
<a href="#l64.278"></a><span id="l64.278" class="difflineplus">+  function JunkScoreAsGoodBody() {</span>
<a href="#l64.279"></a><span id="l64.279" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l64.280"></a><span id="l64.280" class="difflineplus">+    gAction.junkScore = 0;</span>
<a href="#l64.281"></a><span id="l64.281" class="difflineplus">+    gChecks = function checkJunkScoreBody() {</span>
<a href="#l64.282"></a><span id="l64.282" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l64.283"></a><span id="l64.283" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;0&quot;);</span>
<a href="#l64.284"></a><span id="l64.284" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l64.285"></a><span id="l64.285" class="difflineplus">+    }</span>
<a href="#l64.286"></a><span id="l64.286" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l64.287"></a><span id="l64.287" class="difflineplus">+  },</span>
<a href="#l64.288"></a><span id="l64.288" class="difflineplus">+  function CopyToFolder() {</span>
<a href="#l64.289"></a><span id="l64.289" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.CopyToFolder;</span>
<a href="#l64.290"></a><span id="l64.290" class="difflineplus">+    gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l64.291"></a><span id="l64.291" class="difflineplus">+    gChecks = function checkCopyToFolder() {</span>
<a href="#l64.292"></a><span id="l64.292" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l64.293"></a><span id="l64.293" class="difflineplus">+      do_check_eq(gInboxCount + 1, folderCount(gIMAPInbox));</span>
<a href="#l64.294"></a><span id="l64.294" class="difflineplus">+      do_check_eq(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l64.295"></a><span id="l64.295" class="difflineplus">+    }</span>
<a href="#l64.296"></a><span id="l64.296" class="difflineplus">+    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l64.297"></a><span id="l64.297" class="difflineplus">+    gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l64.298"></a><span id="l64.298" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l64.299"></a><span id="l64.299" class="difflineplus">+  },</span>
<a href="#l64.300"></a><span id="l64.300" class="difflineplus">+  function CopyToFolderBody() {</span>
<a href="#l64.301"></a><span id="l64.301" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.CopyToFolder;</span>
<a href="#l64.302"></a><span id="l64.302" class="difflineplus">+    gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l64.303"></a><span id="l64.303" class="difflineplus">+    gChecks = function checkCopyToFolderBody() {</span>
<a href="#l64.304"></a><span id="l64.304" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l64.305"></a><span id="l64.305" class="difflineplus">+      do_check_eq(gInboxCount + 1, folderCount(gIMAPInbox));</span>
<a href="#l64.306"></a><span id="l64.306" class="difflineplus">+      do_check_eq(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l64.307"></a><span id="l64.307" class="difflineplus">+    }</span>
<a href="#l64.308"></a><span id="l64.308" class="difflineplus">+    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l64.309"></a><span id="l64.309" class="difflineplus">+    gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l64.310"></a><span id="l64.310" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l64.311"></a><span id="l64.311" class="difflineplus">+  },</span>
<a href="#l64.312"></a><span id="l64.312" class="difflineplus">+</span>
<a href="#l64.313"></a><span id="l64.313" class="difflineplus">+];</span>
<a href="#l64.314"></a><span id="l64.314" class="difflineplus">+</span>
<a href="#l64.315"></a><span id="l64.315" class="difflineplus">+function run_test()</span>
<a href="#l64.316"></a><span id="l64.316" class="difflineplus">+{</span>
<a href="#l64.317"></a><span id="l64.317" class="difflineplus">+  // This is before any of the actual tests, so...</span>
<a href="#l64.318"></a><span id="l64.318" class="difflineplus">+  gTest = 0;</span>
<a href="#l64.319"></a><span id="l64.319" class="difflineplus">+</span>
<a href="#l64.320"></a><span id="l64.320" class="difflineplus">+  // Add a listener.</span>
<a href="#l64.321"></a><span id="l64.321" class="difflineplus">+  gIMAPDaemon = new imapDaemon();</span>
<a href="#l64.322"></a><span id="l64.322" class="difflineplus">+  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l64.323"></a><span id="l64.323" class="difflineplus">+</span>
<a href="#l64.324"></a><span id="l64.324" class="difflineplus">+  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l64.325"></a><span id="l64.325" class="difflineplus">+</span>
<a href="#l64.326"></a><span id="l64.326" class="difflineplus">+  if (!gLocalInboxFolder)</span>
<a href="#l64.327"></a><span id="l64.327" class="difflineplus">+    loadLocalMailAccount();</span>
<a href="#l64.328"></a><span id="l64.328" class="difflineplus">+</span>
<a href="#l64.329"></a><span id="l64.329" class="difflineplus">+  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l64.330"></a><span id="l64.330" class="difflineplus">+  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l64.331"></a><span id="l64.331" class="difflineplus">+                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l64.332"></a><span id="l64.332" class="difflineplus">+  let localAccount = acctMgr.createAccount();</span>
<a href="#l64.333"></a><span id="l64.333" class="difflineplus">+  let identity = acctMgr.createIdentity();</span>
<a href="#l64.334"></a><span id="l64.334" class="difflineplus">+  localAccount.addIdentity(identity);</span>
<a href="#l64.335"></a><span id="l64.335" class="difflineplus">+  localAccount.defaultIdentity = identity;</span>
<a href="#l64.336"></a><span id="l64.336" class="difflineplus">+  localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l64.337"></a><span id="l64.337" class="difflineplus">+  acctMgr.defaultAccount = localAccount;</span>
<a href="#l64.338"></a><span id="l64.338" class="difflineplus">+</span>
<a href="#l64.339"></a><span id="l64.339" class="difflineplus">+  // Let's also have another account, using the same identity</span>
<a href="#l64.340"></a><span id="l64.340" class="difflineplus">+  let imapAccount = acctMgr.createAccount();</span>
<a href="#l64.341"></a><span id="l64.341" class="difflineplus">+  imapAccount.addIdentity(identity);</span>
<a href="#l64.342"></a><span id="l64.342" class="difflineplus">+  imapAccount.defaultIdentity = identity;</span>
<a href="#l64.343"></a><span id="l64.343" class="difflineplus">+  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l64.344"></a><span id="l64.344" class="difflineplus">+</span>
<a href="#l64.345"></a><span id="l64.345" class="difflineplus">+  // The server doesn't support more than one connection</span>
<a href="#l64.346"></a><span id="l64.346" class="difflineplus">+  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l64.347"></a><span id="l64.347" class="difflineplus">+                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l64.348"></a><span id="l64.348" class="difflineplus">+  prefBranch.setIntPref(&quot;mail.server.default.max_cached_connections&quot;, 1);</span>
<a href="#l64.349"></a><span id="l64.349" class="difflineplus">+  // We aren't interested in downloading messages automatically</span>
<a href="#l64.350"></a><span id="l64.350" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.server.default.download_on_biff&quot;, false);</span>
<a href="#l64.351"></a><span id="l64.351" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l64.352"></a><span id="l64.352" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l64.353"></a><span id="l64.353" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l64.354"></a><span id="l64.354" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l64.355"></a><span id="l64.355" class="difflineplus">+</span>
<a href="#l64.356"></a><span id="l64.356" class="difflineplus">+  gSubfolder = gLocalIncomingServer.rootFolder.addSubfolder(&quot;Subfolder&quot;);</span>
<a href="#l64.357"></a><span id="l64.357" class="difflineplus">+  gIMAPIncomingServer.performExpand(null);</span>
<a href="#l64.358"></a><span id="l64.358" class="difflineplus">+</span>
<a href="#l64.359"></a><span id="l64.359" class="difflineplus">+  gRootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l64.360"></a><span id="l64.360" class="difflineplus">+  gIMAPInbox = gRootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l64.361"></a><span id="l64.361" class="difflineplus">+  gIMAPMailbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l64.362"></a><span id="l64.362" class="difflineplus">+  dump(&quot;gIMAPInbox uri = &quot; + gIMAPInbox.URI + &quot;\n&quot;);</span>
<a href="#l64.363"></a><span id="l64.363" class="difflineplus">+  msgImapFolder = gIMAPInbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l64.364"></a><span id="l64.364" class="difflineplus">+  // these hacks are required because we've created the inbox before</span>
<a href="#l64.365"></a><span id="l64.365" class="difflineplus">+  // running initial folder discovery, and adding the folder bails</span>
<a href="#l64.366"></a><span id="l64.366" class="difflineplus">+  // out before we set it as verified online, so we bail out, and</span>
<a href="#l64.367"></a><span id="l64.367" class="difflineplus">+  // then remove the INBOX folder since it's not verified.</span>
<a href="#l64.368"></a><span id="l64.368" class="difflineplus">+  msgImapFolder.hierarchyDelimiter = '/';</span>
<a href="#l64.369"></a><span id="l64.369" class="difflineplus">+  msgImapFolder.verifiedAsOnlineFolder = true;</span>
<a href="#l64.370"></a><span id="l64.370" class="difflineplus">+</span>
<a href="#l64.371"></a><span id="l64.371" class="difflineplus">+// Create a non-body filter.</span>
<a href="#l64.372"></a><span id="l64.372" class="difflineplus">+  let filterList = gIMAPIncomingServer.getFilterList(null);</span>
<a href="#l64.373"></a><span id="l64.373" class="difflineplus">+  gFilter = filterList.createFilter(&quot;subject&quot;);</span>
<a href="#l64.374"></a><span id="l64.374" class="difflineplus">+  let searchTerm = gFilter.createTerm();</span>
<a href="#l64.375"></a><span id="l64.375" class="difflineplus">+  searchTerm.attrib = Subject;</span>
<a href="#l64.376"></a><span id="l64.376" class="difflineplus">+  searchTerm.op = Is;</span>
<a href="#l64.377"></a><span id="l64.377" class="difflineplus">+  var value = searchTerm.value;</span>
<a href="#l64.378"></a><span id="l64.378" class="difflineplus">+  value.attrib = Subject;</span>
<a href="#l64.379"></a><span id="l64.379" class="difflineplus">+  value.str = gMessageSubject;</span>
<a href="#l64.380"></a><span id="l64.380" class="difflineplus">+  searchTerm.value = value;</span>
<a href="#l64.381"></a><span id="l64.381" class="difflineplus">+  searchTerm.booleanAnd = false;</span>
<a href="#l64.382"></a><span id="l64.382" class="difflineplus">+  gFilter.appendTerm(searchTerm);</span>
<a href="#l64.383"></a><span id="l64.383" class="difflineplus">+  gFilter.enabled = true;</span>
<a href="#l64.384"></a><span id="l64.384" class="difflineplus">+</span>
<a href="#l64.385"></a><span id="l64.385" class="difflineplus">+  // Create a filter with a body term that that forces delayed application of</span>
<a href="#l64.386"></a><span id="l64.386" class="difflineplus">+  // filters until after body download.</span>
<a href="#l64.387"></a><span id="l64.387" class="difflineplus">+  gBodyFilter = filterList.createFilter(&quot;body&quot;);</span>
<a href="#l64.388"></a><span id="l64.388" class="difflineplus">+  searchTerm = gBodyFilter.createTerm();</span>
<a href="#l64.389"></a><span id="l64.389" class="difflineplus">+  searchTerm.attrib = Body;</span>
<a href="#l64.390"></a><span id="l64.390" class="difflineplus">+  searchTerm.op = Contains;</span>
<a href="#l64.391"></a><span id="l64.391" class="difflineplus">+  value = searchTerm.value;</span>
<a href="#l64.392"></a><span id="l64.392" class="difflineplus">+  value.attrib = Body;</span>
<a href="#l64.393"></a><span id="l64.393" class="difflineplus">+  value.str = gMessageInBody;</span>
<a href="#l64.394"></a><span id="l64.394" class="difflineplus">+  searchTerm.value = value;</span>
<a href="#l64.395"></a><span id="l64.395" class="difflineplus">+  searchTerm.booleanAnd = false;</span>
<a href="#l64.396"></a><span id="l64.396" class="difflineplus">+  gBodyFilter.appendTerm(searchTerm);</span>
<a href="#l64.397"></a><span id="l64.397" class="difflineplus">+  gBodyFilter.enabled = true;</span>
<a href="#l64.398"></a><span id="l64.398" class="difflineplus">+</span>
<a href="#l64.399"></a><span id="l64.399" class="difflineplus">+  // an action that can be modified by tests</span>
<a href="#l64.400"></a><span id="l64.400" class="difflineplus">+  gAction = gFilter.createAction();</span>
<a href="#l64.401"></a><span id="l64.401" class="difflineplus">+</span>
<a href="#l64.402"></a><span id="l64.402" class="difflineplus">+  gMailSession.AddFolderListener(FolderListener, Ci.nsIFolderListener.event);</span>
<a href="#l64.403"></a><span id="l64.403" class="difflineplus">+</span>
<a href="#l64.404"></a><span id="l64.404" class="difflineplus">+  // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l64.405"></a><span id="l64.405" class="difflineplus">+  // all the operations.</span>
<a href="#l64.406"></a><span id="l64.406" class="difflineplus">+  do_test_pending();</span>
<a href="#l64.407"></a><span id="l64.407" class="difflineplus">+</span>
<a href="#l64.408"></a><span id="l64.408" class="difflineplus">+  //start first test</span>
<a href="#l64.409"></a><span id="l64.409" class="difflineplus">+  gCurTestNum = 1;</span>
<a href="#l64.410"></a><span id="l64.410" class="difflineplus">+  doTest();</span>
<a href="#l64.411"></a><span id="l64.411" class="difflineplus">+}</span>
<a href="#l64.412"></a><span id="l64.412" class="difflineplus">+</span>
<a href="#l64.413"></a><span id="l64.413" class="difflineplus">+/*</span>
<a href="#l64.414"></a><span id="l64.414" class="difflineplus">+ * functions used to support test setup and execution</span>
<a href="#l64.415"></a><span id="l64.415" class="difflineplus">+ */</span>
<a href="#l64.416"></a><span id="l64.416" class="difflineplus">+</span>
<a href="#l64.417"></a><span id="l64.417" class="difflineplus">+// if the source matches the listener used to continue a test,</span>
<a href="#l64.418"></a><span id="l64.418" class="difflineplus">+// run the test checks, and start the next test.</span>
<a href="#l64.419"></a><span id="l64.419" class="difflineplus">+function testContinue(source)</span>
<a href="#l64.420"></a><span id="l64.420" class="difflineplus">+{</span>
<a href="#l64.421"></a><span id="l64.421" class="difflineplus">+  if (gContinueListener === source)</span>
<a href="#l64.422"></a><span id="l64.422" class="difflineplus">+  {</span>
<a href="#l64.423"></a><span id="l64.423" class="difflineplus">+    if (gContinueListener == kDeleteOrMoveMsgCompleted &amp;&amp;</span>
<a href="#l64.424"></a><span id="l64.424" class="difflineplus">+        gAction.type == Ci.nsMsgFilterAction.MoveToFolder)</span>
<a href="#l64.425"></a><span id="l64.425" class="difflineplus">+    {</span>
<a href="#l64.426"></a><span id="l64.426" class="difflineplus">+      // Moves give 2 events, just use the second.</span>
<a href="#l64.427"></a><span id="l64.427" class="difflineplus">+      gMoveCallbackCount++;</span>
<a href="#l64.428"></a><span id="l64.428" class="difflineplus">+      if (gMoveCallbackCount != 2)</span>
<a href="#l64.429"></a><span id="l64.429" class="difflineplus">+        return;</span>
<a href="#l64.430"></a><span id="l64.430" class="difflineplus">+    }</span>
<a href="#l64.431"></a><span id="l64.431" class="difflineplus">+    if (gChecks)</span>
<a href="#l64.432"></a><span id="l64.432" class="difflineplus">+      gChecks();</span>
<a href="#l64.433"></a><span id="l64.433" class="difflineplus">+    gCurTestNum++;</span>
<a href="#l64.434"></a><span id="l64.434" class="difflineplus">+    do_timeout(100, &quot;doTest();&quot;);</span>
<a href="#l64.435"></a><span id="l64.435" class="difflineplus">+  }</span>
<a href="#l64.436"></a><span id="l64.436" class="difflineplus">+}</span>
<a href="#l64.437"></a><span id="l64.437" class="difflineplus">+</span>
<a href="#l64.438"></a><span id="l64.438" class="difflineplus">+// basic preparation done for each test</span>
<a href="#l64.439"></a><span id="l64.439" class="difflineplus">+function setupTest(aFilter, aAction)</span>
<a href="#l64.440"></a><span id="l64.440" class="difflineplus">+{</span>
<a href="#l64.441"></a><span id="l64.441" class="difflineplus">+  if (aAction &amp;&amp;</span>
<a href="#l64.442"></a><span id="l64.442" class="difflineplus">+      ((aAction.type == Ci.nsMsgFilterAction.CopyToFolder) ||</span>
<a href="#l64.443"></a><span id="l64.443" class="difflineplus">+       (aAction.type == Ci.nsMsgFilterAction.MoveToFolder)))</span>
<a href="#l64.444"></a><span id="l64.444" class="difflineplus">+    gContinueListener = kDeleteOrMoveMsgCompleted;</span>
<a href="#l64.445"></a><span id="l64.445" class="difflineplus">+  else if (aFilter === gBodyFilter)</span>
<a href="#l64.446"></a><span id="l64.446" class="difflineplus">+    gContinueListener = kFiltersAppliedAtom;</span>
<a href="#l64.447"></a><span id="l64.447" class="difflineplus">+  else</span>
<a href="#l64.448"></a><span id="l64.448" class="difflineplus">+    gContinueListener = URLListener;</span>
<a href="#l64.449"></a><span id="l64.449" class="difflineplus">+  let filterList = gIMAPIncomingServer.getFilterList(null);</span>
<a href="#l64.450"></a><span id="l64.450" class="difflineplus">+  while (filterList.filterCount)</span>
<a href="#l64.451"></a><span id="l64.451" class="difflineplus">+    filterList.removeFilterAt(0);</span>
<a href="#l64.452"></a><span id="l64.452" class="difflineplus">+  if (aFilter)</span>
<a href="#l64.453"></a><span id="l64.453" class="difflineplus">+  {</span>
<a href="#l64.454"></a><span id="l64.454" class="difflineplus">+    aFilter.clearActionList();</span>
<a href="#l64.455"></a><span id="l64.455" class="difflineplus">+    if (aAction) {</span>
<a href="#l64.456"></a><span id="l64.456" class="difflineplus">+      aFilter.appendAction(aAction);</span>
<a href="#l64.457"></a><span id="l64.457" class="difflineplus">+      filterList.insertFilterAt(0, aFilter);</span>
<a href="#l64.458"></a><span id="l64.458" class="difflineplus">+    }</span>
<a href="#l64.459"></a><span id="l64.459" class="difflineplus">+  }</span>
<a href="#l64.460"></a><span id="l64.460" class="difflineplus">+  if (gInboxListener)</span>
<a href="#l64.461"></a><span id="l64.461" class="difflineplus">+  {</span>
<a href="#l64.462"></a><span id="l64.462" class="difflineplus">+    try {</span>
<a href="#l64.463"></a><span id="l64.463" class="difflineplus">+      gIMAPInbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l64.464"></a><span id="l64.464" class="difflineplus">+    }</span>
<a href="#l64.465"></a><span id="l64.465" class="difflineplus">+    catch(e) {}</span>
<a href="#l64.466"></a><span id="l64.466" class="difflineplus">+    try {</span>
<a href="#l64.467"></a><span id="l64.467" class="difflineplus">+      gDbService.UnregisterPendingListener(gInboxListener);</span>
<a href="#l64.468"></a><span id="l64.468" class="difflineplus">+    }</span>
<a href="#l64.469"></a><span id="l64.469" class="difflineplus">+    catch(e) {}</span>
<a href="#l64.470"></a><span id="l64.470" class="difflineplus">+  }</span>
<a href="#l64.471"></a><span id="l64.471" class="difflineplus">+</span>
<a href="#l64.472"></a><span id="l64.472" class="difflineplus">+  gInboxListener = new DBListener();</span>
<a href="#l64.473"></a><span id="l64.473" class="difflineplus">+  gDbService.registerPendingListener(gIMAPInbox, gInboxListener);</span>
<a href="#l64.474"></a><span id="l64.474" class="difflineplus">+  gMoveCallbackCount = 0;</span>
<a href="#l64.475"></a><span id="l64.475" class="difflineplus">+  gIMAPMailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l64.476"></a><span id="l64.476" class="difflineplus">+                          gIMAPMailbox.uidnext++, []));</span>
<a href="#l64.477"></a><span id="l64.477" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, URLListener);</span>
<a href="#l64.478"></a><span id="l64.478" class="difflineplus">+}</span>
<a href="#l64.479"></a><span id="l64.479" class="difflineplus">+</span>
<a href="#l64.480"></a><span id="l64.480" class="difflineplus">+// run the next test</span>
<a href="#l64.481"></a><span id="l64.481" class="difflineplus">+function doTest()</span>
<a href="#l64.482"></a><span id="l64.482" class="difflineplus">+{</span>
<a href="#l64.483"></a><span id="l64.483" class="difflineplus">+  test = gCurTestNum;</span>
<a href="#l64.484"></a><span id="l64.484" class="difflineplus">+  if (test &lt;= gTestArray.length)</span>
<a href="#l64.485"></a><span id="l64.485" class="difflineplus">+  {</span>
<a href="#l64.486"></a><span id="l64.486" class="difflineplus">+</span>
<a href="#l64.487"></a><span id="l64.487" class="difflineplus">+    var testFn = gTestArray[test-1];</span>
<a href="#l64.488"></a><span id="l64.488" class="difflineplus">+    dump(&quot;Doing test &quot; + test + &quot; &quot; + testFn.name + &quot;\n&quot;);</span>
<a href="#l64.489"></a><span id="l64.489" class="difflineplus">+    // Set a limit of ten seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l64.490"></a><span id="l64.490" class="difflineplus">+    do_timeout(10000, &quot;if (gCurTestNum == &quot;+test+&quot;) \</span>
<a href="#l64.491"></a><span id="l64.491" class="difflineplus">+      do_throw('Notifications not received in 10000 ms for operation &quot;+testFn.name+&quot;, current status is '+gCurrStatus);&quot;);</span>
<a href="#l64.492"></a><span id="l64.492" class="difflineplus">+    try {</span>
<a href="#l64.493"></a><span id="l64.493" class="difflineplus">+    testFn();</span>
<a href="#l64.494"></a><span id="l64.494" class="difflineplus">+    } catch(ex) {</span>
<a href="#l64.495"></a><span id="l64.495" class="difflineplus">+      gServer.stop();</span>
<a href="#l64.496"></a><span id="l64.496" class="difflineplus">+      do_throw ('TEST FAILED ' + e);</span>
<a href="#l64.497"></a><span id="l64.497" class="difflineplus">+    }</span>
<a href="#l64.498"></a><span id="l64.498" class="difflineplus">+  }</span>
<a href="#l64.499"></a><span id="l64.499" class="difflineplus">+  else</span>
<a href="#l64.500"></a><span id="l64.500" class="difflineplus">+    do_timeout(1000, &quot;endTest();&quot;);</span>
<a href="#l64.501"></a><span id="l64.501" class="difflineplus">+}</span>
<a href="#l64.502"></a><span id="l64.502" class="difflineplus">+</span>
<a href="#l64.503"></a><span id="l64.503" class="difflineplus">+// Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l64.504"></a><span id="l64.504" class="difflineplus">+// server</span>
<a href="#l64.505"></a><span id="l64.505" class="difflineplus">+function endTest()</span>
<a href="#l64.506"></a><span id="l64.506" class="difflineplus">+{</span>
<a href="#l64.507"></a><span id="l64.507" class="difflineplus">+  dump(&quot; Exiting mail tests\n&quot;);</span>
<a href="#l64.508"></a><span id="l64.508" class="difflineplus">+  if (gInboxListener)</span>
<a href="#l64.509"></a><span id="l64.509" class="difflineplus">+  {</span>
<a href="#l64.510"></a><span id="l64.510" class="difflineplus">+    try {</span>
<a href="#l64.511"></a><span id="l64.511" class="difflineplus">+      gIMAPInbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l64.512"></a><span id="l64.512" class="difflineplus">+    }</span>
<a href="#l64.513"></a><span id="l64.513" class="difflineplus">+    catch(e) {}</span>
<a href="#l64.514"></a><span id="l64.514" class="difflineplus">+    try {</span>
<a href="#l64.515"></a><span id="l64.515" class="difflineplus">+      gDbService.UnregisterPendingListener(gInboxListener);</span>
<a href="#l64.516"></a><span id="l64.516" class="difflineplus">+    }</span>
<a href="#l64.517"></a><span id="l64.517" class="difflineplus">+    catch(e) {}</span>
<a href="#l64.518"></a><span id="l64.518" class="difflineplus">+  }</span>
<a href="#l64.519"></a><span id="l64.519" class="difflineplus">+  gRootFolder = null;</span>
<a href="#l64.520"></a><span id="l64.520" class="difflineplus">+  gIMAPInbox = null;</span>
<a href="#l64.521"></a><span id="l64.521" class="difflineplus">+  gIMAPTrashFolder = null;</span>
<a href="#l64.522"></a><span id="l64.522" class="difflineplus">+  gSubfolder = null;</span>
<a href="#l64.523"></a><span id="l64.523" class="difflineplus">+  gServer.resetTest();</span>
<a href="#l64.524"></a><span id="l64.524" class="difflineplus">+  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l64.525"></a><span id="l64.525" class="difflineplus">+  gServer.performTest();</span>
<a href="#l64.526"></a><span id="l64.526" class="difflineplus">+  gServer.stop();</span>
<a href="#l64.527"></a><span id="l64.527" class="difflineplus">+  let thread = gThreadManager.currentThread;</span>
<a href="#l64.528"></a><span id="l64.528" class="difflineplus">+  while (thread.hasPendingEvents())</span>
<a href="#l64.529"></a><span id="l64.529" class="difflineplus">+    thread.processNextEvent(true);</span>
<a href="#l64.530"></a><span id="l64.530" class="difflineplus">+</span>
<a href="#l64.531"></a><span id="l64.531" class="difflineplus">+  do_test_finished(); // for the one in run_test()</span>
<a href="#l64.532"></a><span id="l64.532" class="difflineplus">+}</span>
<a href="#l64.533"></a><span id="l64.533" class="difflineplus">+</span>
<a href="#l64.534"></a><span id="l64.534" class="difflineplus">+/*</span>
<a href="#l64.535"></a><span id="l64.535" class="difflineplus">+ * listener objects</span>
<a href="#l64.536"></a><span id="l64.536" class="difflineplus">+ */</span>
<a href="#l64.537"></a><span id="l64.537" class="difflineplus">+</span>
<a href="#l64.538"></a><span id="l64.538" class="difflineplus">+// nsIFolderListener implementation</span>
<a href="#l64.539"></a><span id="l64.539" class="difflineplus">+var FolderListener = {</span>
<a href="#l64.540"></a><span id="l64.540" class="difflineplus">+  OnItemEvent: function OnItemEvent(aEventFolder, aEvent) {</span>
<a href="#l64.541"></a><span id="l64.541" class="difflineplus">+    dump(&quot;received folder event &quot; + aEvent.toString() +</span>
<a href="#l64.542"></a><span id="l64.542" class="difflineplus">+         &quot; folder &quot; + aEventFolder.name +</span>
<a href="#l64.543"></a><span id="l64.543" class="difflineplus">+         &quot;\n&quot;);</span>
<a href="#l64.544"></a><span id="l64.544" class="difflineplus">+    testContinue(aEvent);</span>
<a href="#l64.545"></a><span id="l64.545" class="difflineplus">+  }</span>
<a href="#l64.546"></a><span id="l64.546" class="difflineplus">+};</span>
<a href="#l64.547"></a><span id="l64.547" class="difflineplus">+</span>
<a href="#l64.548"></a><span id="l64.548" class="difflineplus">+// nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l64.549"></a><span id="l64.549" class="difflineplus">+// is completed.</span>
<a href="#l64.550"></a><span id="l64.550" class="difflineplus">+var CopyListener =</span>
<a href="#l64.551"></a><span id="l64.551" class="difflineplus">+{</span>
<a href="#l64.552"></a><span id="l64.552" class="difflineplus">+  OnStartCopy: function OnStartCopy() {},</span>
<a href="#l64.553"></a><span id="l64.553" class="difflineplus">+  OnProgress: function OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l64.554"></a><span id="l64.554" class="difflineplus">+  SetMessageKey: function SetMessageKey(aKey)</span>
<a href="#l64.555"></a><span id="l64.555" class="difflineplus">+  {</span>
<a href="#l64.556"></a><span id="l64.556" class="difflineplus">+    gLastKey = aKey;</span>
<a href="#l64.557"></a><span id="l64.557" class="difflineplus">+  },</span>
<a href="#l64.558"></a><span id="l64.558" class="difflineplus">+  SetMessageId: function SetMessageId(aMessageId) {},</span>
<a href="#l64.559"></a><span id="l64.559" class="difflineplus">+  OnStopCopy: function OnStopCopy(aStatus)</span>
<a href="#l64.560"></a><span id="l64.560" class="difflineplus">+  {</span>
<a href="#l64.561"></a><span id="l64.561" class="difflineplus">+    dump(&quot;in OnStopCopy &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l64.562"></a><span id="l64.562" class="difflineplus">+    // Check: message successfully copied.</span>
<a href="#l64.563"></a><span id="l64.563" class="difflineplus">+    do_check_eq(aStatus, 0);</span>
<a href="#l64.564"></a><span id="l64.564" class="difflineplus">+    // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l64.565"></a><span id="l64.565" class="difflineplus">+    // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l64.566"></a><span id="l64.566" class="difflineplus">+    // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l64.567"></a><span id="l64.567" class="difflineplus">+    // to return</span>
<a href="#l64.568"></a><span id="l64.568" class="difflineplus">+    testContinue(this);</span>
<a href="#l64.569"></a><span id="l64.569" class="difflineplus">+  }</span>
<a href="#l64.570"></a><span id="l64.570" class="difflineplus">+};</span>
<a href="#l64.571"></a><span id="l64.571" class="difflineplus">+</span>
<a href="#l64.572"></a><span id="l64.572" class="difflineplus">+// nsIURLListener implementation - runs next test</span>
<a href="#l64.573"></a><span id="l64.573" class="difflineplus">+var URLListener =</span>
<a href="#l64.574"></a><span id="l64.574" class="difflineplus">+{</span>
<a href="#l64.575"></a><span id="l64.575" class="difflineplus">+  OnStartRunningUrl: function OnStartRunningUrl(aURL) {},</span>
<a href="#l64.576"></a><span id="l64.576" class="difflineplus">+  OnStopRunningUrl: function OnStopRunningUrl(aURL, aStatus)</span>
<a href="#l64.577"></a><span id="l64.577" class="difflineplus">+  {</span>
<a href="#l64.578"></a><span id="l64.578" class="difflineplus">+    dump(&quot;in OnStopRunningURL &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l64.579"></a><span id="l64.579" class="difflineplus">+    do_check_eq(aStatus, 0);</span>
<a href="#l64.580"></a><span id="l64.580" class="difflineplus">+    testContinue(this);</span>
<a href="#l64.581"></a><span id="l64.581" class="difflineplus">+  }</span>
<a href="#l64.582"></a><span id="l64.582" class="difflineplus">+}</span>
<a href="#l64.583"></a><span id="l64.583" class="difflineplus">+</span>
<a href="#l64.584"></a><span id="l64.584" class="difflineplus">+// nsIDBChangeListener implementation. Counts of calls are kept, but not</span>
<a href="#l64.585"></a><span id="l64.585" class="difflineplus">+// currently used in the tests. Current role is to provide a reference</span>
<a href="#l64.586"></a><span id="l64.586" class="difflineplus">+// to the new message header (plus give some examples of using db listeners</span>
<a href="#l64.587"></a><span id="l64.587" class="difflineplus">+// in javascript).</span>
<a href="#l64.588"></a><span id="l64.588" class="difflineplus">+function DBListener()</span>
<a href="#l64.589"></a><span id="l64.589" class="difflineplus">+{</span>
<a href="#l64.590"></a><span id="l64.590" class="difflineplus">+  this.counts = {};</span>
<a href="#l64.591"></a><span id="l64.591" class="difflineplus">+  counts = this.counts;</span>
<a href="#l64.592"></a><span id="l64.592" class="difflineplus">+  counts.onHdrFlagsChanged = 0;</span>
<a href="#l64.593"></a><span id="l64.593" class="difflineplus">+  counts.onHdrDeleted = 0;</span>
<a href="#l64.594"></a><span id="l64.594" class="difflineplus">+  counts.onHdrAdded = 0;</span>
<a href="#l64.595"></a><span id="l64.595" class="difflineplus">+  counts.onParentChanged = 0;</span>
<a href="#l64.596"></a><span id="l64.596" class="difflineplus">+  counts.onAnnouncerGoingAway = 0;</span>
<a href="#l64.597"></a><span id="l64.597" class="difflineplus">+  counts.onReadChanged = 0;</span>
<a href="#l64.598"></a><span id="l64.598" class="difflineplus">+  counts.onJunkScoreChanged = 0;</span>
<a href="#l64.599"></a><span id="l64.599" class="difflineplus">+  counts.onHdrPropertyChanged = 0;</span>
<a href="#l64.600"></a><span id="l64.600" class="difflineplus">+  counts.onEvent = 0;</span>
<a href="#l64.601"></a><span id="l64.601" class="difflineplus">+}</span>
<a href="#l64.602"></a><span id="l64.602" class="difflineplus">+</span>
<a href="#l64.603"></a><span id="l64.603" class="difflineplus">+DBListener.prototype =</span>
<a href="#l64.604"></a><span id="l64.604" class="difflineplus">+{</span>
<a href="#l64.605"></a><span id="l64.605" class="difflineplus">+  onHdrFlagsChanged:</span>
<a href="#l64.606"></a><span id="l64.606" class="difflineplus">+    function onHdrFlagsChanged(aHdrChanged, aOldFlags, aNewFlags, aInstigator)</span>
<a href="#l64.607"></a><span id="l64.607" class="difflineplus">+    {</span>
<a href="#l64.608"></a><span id="l64.608" class="difflineplus">+      this.counts.onHdrFlagsChanged++;</span>
<a href="#l64.609"></a><span id="l64.609" class="difflineplus">+    },</span>
<a href="#l64.610"></a><span id="l64.610" class="difflineplus">+</span>
<a href="#l64.611"></a><span id="l64.611" class="difflineplus">+  onHdrDeleted:</span>
<a href="#l64.612"></a><span id="l64.612" class="difflineplus">+    function onHdrDeleted(aHdrChanged, aParentKey, Flags, aInstigator)</span>
<a href="#l64.613"></a><span id="l64.613" class="difflineplus">+    {</span>
<a href="#l64.614"></a><span id="l64.614" class="difflineplus">+      this.counts.onHdrDeleted++;</span>
<a href="#l64.615"></a><span id="l64.615" class="difflineplus">+    },</span>
<a href="#l64.616"></a><span id="l64.616" class="difflineplus">+</span>
<a href="#l64.617"></a><span id="l64.617" class="difflineplus">+  onHdrAdded:</span>
<a href="#l64.618"></a><span id="l64.618" class="difflineplus">+    function onHdrAdded(aHdrChanged, aParentKey, aFlags, aInstigator)</span>
<a href="#l64.619"></a><span id="l64.619" class="difflineplus">+    {</span>
<a href="#l64.620"></a><span id="l64.620" class="difflineplus">+      this.counts.onHdrAdded++;</span>
<a href="#l64.621"></a><span id="l64.621" class="difflineplus">+      gHeader = aHdrChanged;</span>
<a href="#l64.622"></a><span id="l64.622" class="difflineplus">+    },</span>
<a href="#l64.623"></a><span id="l64.623" class="difflineplus">+</span>
<a href="#l64.624"></a><span id="l64.624" class="difflineplus">+  onParentChanged:</span>
<a href="#l64.625"></a><span id="l64.625" class="difflineplus">+    function onParentChanged(aKeyChanged, oldParent, newParent, aInstigator)</span>
<a href="#l64.626"></a><span id="l64.626" class="difflineplus">+    {</span>
<a href="#l64.627"></a><span id="l64.627" class="difflineplus">+      this.counts.onParentChanged++;</span>
<a href="#l64.628"></a><span id="l64.628" class="difflineplus">+    },</span>
<a href="#l64.629"></a><span id="l64.629" class="difflineplus">+    </span>
<a href="#l64.630"></a><span id="l64.630" class="difflineplus">+  onAnnouncerGoingAway:</span>
<a href="#l64.631"></a><span id="l64.631" class="difflineplus">+    function onAnnouncerGoingAway(instigator)</span>
<a href="#l64.632"></a><span id="l64.632" class="difflineplus">+    {</span>
<a href="#l64.633"></a><span id="l64.633" class="difflineplus">+      if (gInboxListener)</span>
<a href="#l64.634"></a><span id="l64.634" class="difflineplus">+        try {</span>
<a href="#l64.635"></a><span id="l64.635" class="difflineplus">+          gIMAPInbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l64.636"></a><span id="l64.636" class="difflineplus">+        }</span>
<a href="#l64.637"></a><span id="l64.637" class="difflineplus">+        catch (e) {dump(&quot; listener not found\n&quot;);}</span>
<a href="#l64.638"></a><span id="l64.638" class="difflineplus">+      this.counts.onAnnouncerGoingAway++;</span>
<a href="#l64.639"></a><span id="l64.639" class="difflineplus">+    },</span>
<a href="#l64.640"></a><span id="l64.640" class="difflineplus">+    </span>
<a href="#l64.641"></a><span id="l64.641" class="difflineplus">+  onReadChanged:</span>
<a href="#l64.642"></a><span id="l64.642" class="difflineplus">+    function onReadChanged(aInstigator)</span>
<a href="#l64.643"></a><span id="l64.643" class="difflineplus">+    {</span>
<a href="#l64.644"></a><span id="l64.644" class="difflineplus">+      this.counts.onReadChanged++;</span>
<a href="#l64.645"></a><span id="l64.645" class="difflineplus">+    },</span>
<a href="#l64.646"></a><span id="l64.646" class="difflineplus">+    </span>
<a href="#l64.647"></a><span id="l64.647" class="difflineplus">+  onJunkScoreChanged:</span>
<a href="#l64.648"></a><span id="l64.648" class="difflineplus">+    function onJunkScoreChanged(aInstigator)</span>
<a href="#l64.649"></a><span id="l64.649" class="difflineplus">+    {</span>
<a href="#l64.650"></a><span id="l64.650" class="difflineplus">+      this.counts.onJunkScoreChanged++;</span>
<a href="#l64.651"></a><span id="l64.651" class="difflineplus">+    },</span>
<a href="#l64.652"></a><span id="l64.652" class="difflineplus">+    </span>
<a href="#l64.653"></a><span id="l64.653" class="difflineplus">+  onHdrPropertyChanged:</span>
<a href="#l64.654"></a><span id="l64.654" class="difflineplus">+    function onHdrPropertyChanged(aHdrToChange, aPreChange, aStatus, aInstigator)</span>
<a href="#l64.655"></a><span id="l64.655" class="difflineplus">+    {</span>
<a href="#l64.656"></a><span id="l64.656" class="difflineplus">+      this.counts.onHdrPropertyChanged++;</span>
<a href="#l64.657"></a><span id="l64.657" class="difflineplus">+    },</span>
<a href="#l64.658"></a><span id="l64.658" class="difflineplus">+    </span>
<a href="#l64.659"></a><span id="l64.659" class="difflineplus">+  onEvent:</span>
<a href="#l64.660"></a><span id="l64.660" class="difflineplus">+    function onEvent(aDB, aEvent)</span>
<a href="#l64.661"></a><span id="l64.661" class="difflineplus">+    {</span>
<a href="#l64.662"></a><span id="l64.662" class="difflineplus">+      this.counts.onEvent++;</span>
<a href="#l64.663"></a><span id="l64.663" class="difflineplus">+    },</span>
<a href="#l64.664"></a><span id="l64.664" class="difflineplus">+</span>
<a href="#l64.665"></a><span id="l64.665" class="difflineplus">+};</span>
<a href="#l64.666"></a><span id="l64.666" class="difflineplus">+</span>
<a href="#l64.667"></a><span id="l64.667" class="difflineplus">+/*</span>
<a href="#l64.668"></a><span id="l64.668" class="difflineplus">+ * helper functions</span>
<a href="#l64.669"></a><span id="l64.669" class="difflineplus">+ */</span>
<a href="#l64.670"></a><span id="l64.670" class="difflineplus">+</span>
<a href="#l64.671"></a><span id="l64.671" class="difflineplus">+// return the number of messages in a folder (and check that the</span>
<a href="#l64.672"></a><span id="l64.672" class="difflineplus">+// folder counts match the database counts)</span>
<a href="#l64.673"></a><span id="l64.673" class="difflineplus">+function folderCount(folder)</span>
<a href="#l64.674"></a><span id="l64.674" class="difflineplus">+{</span>
<a href="#l64.675"></a><span id="l64.675" class="difflineplus">+  // count using the database</span>
<a href="#l64.676"></a><span id="l64.676" class="difflineplus">+  let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l64.677"></a><span id="l64.677" class="difflineplus">+  let dbCount = 0;</span>
<a href="#l64.678"></a><span id="l64.678" class="difflineplus">+  while (enumerator.hasMoreElements())</span>
<a href="#l64.679"></a><span id="l64.679" class="difflineplus">+  {</span>
<a href="#l64.680"></a><span id="l64.680" class="difflineplus">+    dbCount++;</span>
<a href="#l64.681"></a><span id="l64.681" class="difflineplus">+    let hdr = enumerator.getNext();</span>
<a href="#l64.682"></a><span id="l64.682" class="difflineplus">+  }</span>
<a href="#l64.683"></a><span id="l64.683" class="difflineplus">+</span>
<a href="#l64.684"></a><span id="l64.684" class="difflineplus">+  // count using the folder</span>
<a href="#l64.685"></a><span id="l64.685" class="difflineplus">+  let folderCount = folder.getTotalMessages(false);</span>
<a href="#l64.686"></a><span id="l64.686" class="difflineplus">+</span>
<a href="#l64.687"></a><span id="l64.687" class="difflineplus">+  // compare the two</span>
<a href="#l64.688"></a><span id="l64.688" class="difflineplus">+  do_check_eq(dbCount, folderCount);</span>
<a href="#l64.689"></a><span id="l64.689" class="difflineplus">+  return dbCount;</span>
<a href="#l64.690"></a><span id="l64.690" class="difflineplus">+}</span>
<a href="#l64.691"></a><span id="l64.691" class="difflineplus">+</span>
<a href="#l64.692"></a><span id="l64.692" class="difflineplus">+// list all of the messages in a folder for debug</span>
<a href="#l64.693"></a><span id="l64.693" class="difflineplus">+function listMessages(folder) {</span>
<a href="#l64.694"></a><span id="l64.694" class="difflineplus">+  let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l64.695"></a><span id="l64.695" class="difflineplus">+  var msgCount = 0;</span>
<a href="#l64.696"></a><span id="l64.696" class="difflineplus">+  dump(&quot;listing messages for &quot; + folder.prettyName + &quot;\n&quot;);</span>
<a href="#l64.697"></a><span id="l64.697" class="difflineplus">+  while(enumerator.hasMoreElements())</span>
<a href="#l64.698"></a><span id="l64.698" class="difflineplus">+  {</span>
<a href="#l64.699"></a><span id="l64.699" class="difflineplus">+    msgCount++;</span>
<a href="#l64.700"></a><span id="l64.700" class="difflineplus">+    let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l64.701"></a><span id="l64.701" class="difflineplus">+    dump(msgCount + &quot;: &quot; + hdr.subject + &quot;\n&quot;);</span>
<a href="#l64.702"></a><span id="l64.702" class="difflineplus">+  }</span>
<a href="#l64.703"></a><span id="l64.703" class="difflineplus">+}</span>
<a href="#l64.704"></a><span id="l64.704" class="difflineplus">+</span>
<a href="#l64.705"></a><span id="l64.705" class="difflineplus">+// given a test file, return the file uri spec</span>
<a href="#l64.706"></a><span id="l64.706" class="difflineplus">+function specForFileName(aFileName)</span>
<a href="#l64.707"></a><span id="l64.707" class="difflineplus">+{</span>
<a href="#l64.708"></a><span id="l64.708" class="difflineplus">+  let file = do_get_file(&quot;../../mailnews/data/&quot; + aFileName);</span>
<a href="#l64.709"></a><span id="l64.709" class="difflineplus">+  let msgfileuri = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l64.710"></a><span id="l64.710" class="difflineplus">+                     .getService(Ci.nsIIOService)</span>
<a href="#l64.711"></a><span id="l64.711" class="difflineplus">+                     .newFileURI(file)</span>
<a href="#l64.712"></a><span id="l64.712" class="difflineplus">+                     .QueryInterface(Ci.nsIFileURL);</span>
<a href="#l64.713"></a><span id="l64.713" class="difflineplus">+  return msgfileuri.spec;</span>
<a href="#l64.714"></a><span id="l64.714" class="difflineplus">+}</span>
<a href="#l64.715"></a><span id="l64.715" class="difflineplus">+</span>
<a href="#l64.716"></a><span id="l64.716" class="difflineplus">+// shorthand for the inbox message summary database</span>
<a href="#l64.717"></a><span id="l64.717" class="difflineplus">+function db()</span>
<a href="#l64.718"></a><span id="l64.718" class="difflineplus">+{</span>
<a href="#l64.719"></a><span id="l64.719" class="difflineplus">+  return gIMAPInbox.msgDatabase;</span>
<a href="#l64.720"></a><span id="l64.720" class="difflineplus">+}</span>
<a href="#l64.721"></a><span id="l64.721" class="difflineplus">+</span>
<a href="#l64.722"></a><span id="l64.722" class="difflineplus">+// This function may be used in the test array to show</span>
<a href="#l64.723"></a><span id="l64.723" class="difflineplus">+// more detailed results after a particular test.</span>
<a href="#l64.724"></a><span id="l64.724" class="difflineplus">+function showResults() {</span>
<a href="#l64.725"></a><span id="l64.725" class="difflineplus">+  listMessages(gIMAPInbox);</span>
<a href="#l64.726"></a><span id="l64.726" class="difflineplus">+  if (gInboxListener)</span>
<a href="#l64.727"></a><span id="l64.727" class="difflineplus">+    printListener(gInboxListener);</span>
<a href="#l64.728"></a><span id="l64.728" class="difflineplus">+  gCurTestNum++;</span>
<a href="#l64.729"></a><span id="l64.729" class="difflineplus">+  do_timeout(100, &quot;doTest();&quot;);</span>
<a href="#l64.730"></a><span id="l64.730" class="difflineplus">+}</span>
<a href="#l64.731"></a><span id="l64.731" class="difflineplus">+</span>
<a href="#l64.732"></a><span id="l64.732" class="difflineplus">+// static variables used in testCounts</span>
<a href="#l64.733"></a><span id="l64.733" class="difflineplus">+var gPreviousUnread = 0;</span>
<a href="#l64.734"></a><span id="l64.734" class="difflineplus">+var gPreviousDbNew = 0;</span>
<a href="#l64.735"></a><span id="l64.735" class="difflineplus">+</span>
<a href="#l64.736"></a><span id="l64.736" class="difflineplus">+// Test various counts.</span>
<a href="#l64.737"></a><span id="l64.737" class="difflineplus">+//</span>
<a href="#l64.738"></a><span id="l64.738" class="difflineplus">+//  aHasNew:         folder hasNew flag</span>
<a href="#l64.739"></a><span id="l64.739" class="difflineplus">+//  aUnreadDelta:    change in unread count for the folder</span>
<a href="#l64.740"></a><span id="l64.740" class="difflineplus">+//  aFolderNewDelta: change in new count for the folder</span>
<a href="#l64.741"></a><span id="l64.741" class="difflineplus">+//  aDbNewDelta:     change in new count for the database</span>
<a href="#l64.742"></a><span id="l64.742" class="difflineplus">+//</span>
<a href="#l64.743"></a><span id="l64.743" class="difflineplus">+function testCounts(aHasNew, aUnreadDelta, aFolderNewDelta, aDbNewDelta)</span>
<a href="#l64.744"></a><span id="l64.744" class="difflineplus">+{</span>
<a href="#l64.745"></a><span id="l64.745" class="difflineplus">+  try {</span>
<a href="#l64.746"></a><span id="l64.746" class="difflineplus">+  let folderNew = gIMAPInbox.getNumNewMessages(false);</span>
<a href="#l64.747"></a><span id="l64.747" class="difflineplus">+  let hasNew = gIMAPInbox.hasNewMessages;</span>
<a href="#l64.748"></a><span id="l64.748" class="difflineplus">+  let unread = gIMAPInbox.getNumUnread(false);</span>
<a href="#l64.749"></a><span id="l64.749" class="difflineplus">+  let countOut = {};</span>
<a href="#l64.750"></a><span id="l64.750" class="difflineplus">+  let arrayOut = {};</span>
<a href="#l64.751"></a><span id="l64.751" class="difflineplus">+  db().getNewList(countOut, arrayOut);</span>
<a href="#l64.752"></a><span id="l64.752" class="difflineplus">+  let dbNew = countOut.value ? countOut.value : 0;</span>
<a href="#l64.753"></a><span id="l64.753" class="difflineplus">+  let folderNewFlag = gIMAPInbox.getFlag(Ci.nsMsgFolderFlags.GotNew);</span>
<a href="#l64.754"></a><span id="l64.754" class="difflineplus">+  dump(&quot; hasNew: &quot; + hasNew +</span>
<a href="#l64.755"></a><span id="l64.755" class="difflineplus">+       &quot; unread: &quot; + unread +</span>
<a href="#l64.756"></a><span id="l64.756" class="difflineplus">+       &quot; folderNew: &quot; + folderNew +</span>
<a href="#l64.757"></a><span id="l64.757" class="difflineplus">+       &quot; folderNewFlag: &quot; + folderNewFlag +</span>
<a href="#l64.758"></a><span id="l64.758" class="difflineplus">+       &quot; dbNew: &quot; + dbNew +</span>
<a href="#l64.759"></a><span id="l64.759" class="difflineplus">+       &quot;\n&quot;);</span>
<a href="#l64.760"></a><span id="l64.760" class="difflineplus">+  do_check_eq(aHasNew, hasNew);</span>
<a href="#l64.761"></a><span id="l64.761" class="difflineplus">+  do_check_eq(aUnreadDelta, unread - gPreviousUnread);</span>
<a href="#l64.762"></a><span id="l64.762" class="difflineplus">+  gPreviousUnread = unread;</span>
<a href="#l64.763"></a><span id="l64.763" class="difflineplus">+  // this seems to be rest for each folder update</span>
<a href="#l64.764"></a><span id="l64.764" class="difflineplus">+  do_check_eq(aFolderNewDelta, folderNew);</span>
<a href="#l64.765"></a><span id="l64.765" class="difflineplus">+  do_check_eq(aDbNewDelta, dbNew - gPreviousDbNew);</span>
<a href="#l64.766"></a><span id="l64.766" class="difflineplus">+  gPreviousDbNew = dbNew;</span>
<a href="#l64.767"></a><span id="l64.767" class="difflineplus">+  } catch (e) {dump(e);}</span>
<a href="#l64.768"></a><span id="l64.768" class="difflineplus">+}</span>
<a href="#l64.769"></a><span id="l64.769" class="difflineplus">+</span>
<a href="#l64.770"></a><span id="l64.770" class="difflineplus">+// print the counts for debugging purposes in this test</span>
<a href="#l64.771"></a><span id="l64.771" class="difflineplus">+function printListener(listener)</span>
<a href="#l64.772"></a><span id="l64.772" class="difflineplus">+{</span>
<a href="#l64.773"></a><span id="l64.773" class="difflineplus">+  print(&quot;DBListener counts: &quot;);</span>
<a href="#l64.774"></a><span id="l64.774" class="difflineplus">+  for (var item in listener.counts) {</span>
<a href="#l64.775"></a><span id="l64.775" class="difflineplus">+      dump(item + &quot;: &quot; + listener.counts[item] + &quot; &quot;);</span>
<a href="#l64.776"></a><span id="l64.776" class="difflineplus">+  }</span>
<a href="#l64.777"></a><span id="l64.777" class="difflineplus">+  dump(&quot;\n&quot;);</span>
<a href="#l64.778"></a><span id="l64.778" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -2752,22 +2752,27 @@ NS_IMETHODIMP nsMsgLocalMailFolder::EndC</span>
<a href="#l65.4"></a><span id="l65.4"> </span>
<a href="#l65.5"></a><span id="l65.5">         if (mCopyState-&gt;m_msgWindow &amp;&amp; mCopyState-&gt;m_undoMsgTxn)</span>
<a href="#l65.6"></a><span id="l65.6">         {</span>
<a href="#l65.7"></a><span id="l65.7">           nsCOMPtr&lt;nsITransactionManager&gt; txnMgr;</span>
<a href="#l65.8"></a><span id="l65.8">           mCopyState-&gt;m_msgWindow-&gt;GetTransactionManager(getter_AddRefs(txnMgr));</span>
<a href="#l65.9"></a><span id="l65.9">           if (txnMgr)</span>
<a href="#l65.10"></a><span id="l65.10">             txnMgr-&gt;DoTransaction(mCopyState-&gt;m_undoMsgTxn);</span>
<a href="#l65.11"></a><span id="l65.11">         }</span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-        if (srcFolder &amp;&amp; !mCopyState-&gt;m_isFolder)</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineminus">-          srcFolder-&gt;NotifyFolderEvent(mDeleteOrMoveMsgCompletedAtom);</span>
<a href="#l65.14"></a><span id="l65.14" class="difflineminus">-</span>
<a href="#l65.15"></a><span id="l65.15" class="difflineminus">-        (void) OnCopyCompleted(mCopyState-&gt;m_srcSupport, PR_TRUE);</span>
<a href="#l65.16"></a><span id="l65.16" class="difflineplus">+</span>
<a href="#l65.17"></a><span id="l65.17">         // enable the dest folder</span>
<a href="#l65.18"></a><span id="l65.18">         EnableNotifications(allMessageCountNotifications, PR_TRUE, PR_FALSE /*dbBatching*/); //dest folder doesn't need db batching</span>
<a href="#l65.19"></a><span id="l65.19" class="difflineplus">+        if (srcFolder &amp;&amp; !mCopyState-&gt;m_isFolder)</span>
<a href="#l65.20"></a><span id="l65.20" class="difflineplus">+        {</span>
<a href="#l65.21"></a><span id="l65.21" class="difflineplus">+          // I'm not too sure of the proper location of this event. It seems to need to be</span>
<a href="#l65.22"></a><span id="l65.22" class="difflineplus">+          // after the EnableNotifications, or the folder counts can be incorrect</span>
<a href="#l65.23"></a><span id="l65.23" class="difflineplus">+          // during the mDeleteOrMoveMsgCompletedAtom call.</span>
<a href="#l65.24"></a><span id="l65.24" class="difflineplus">+          srcFolder-&gt;NotifyFolderEvent(mDeleteOrMoveMsgCompletedAtom);</span>
<a href="#l65.25"></a><span id="l65.25" class="difflineplus">+        }</span>
<a href="#l65.26"></a><span id="l65.26" class="difflineplus">+        (void) OnCopyCompleted(mCopyState-&gt;m_srcSupport, PR_TRUE);</span>
<a href="#l65.27"></a><span id="l65.27">       }</span>
<a href="#l65.28"></a><span id="l65.28">     }</span>
<a href="#l65.29"></a><span id="l65.29">     // Send the itemAdded notification in case we didn't send the itemMoveCopyCompleted notification earlier.</span>
<a href="#l65.30"></a><span id="l65.30">     // Posting news messages involves this, yet doesn't have the newHdr initialized, so don't send any</span>
<a href="#l65.31"></a><span id="l65.31">     // notifications in that case.</span>
<a href="#l65.32"></a><span id="l65.32">     if (!numHdrs &amp;&amp; newHdr)</span>
<a href="#l65.33"></a><span id="l65.33">     {</span>
<a href="#l65.34"></a><span id="l65.34">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l65.35"></a><span id="l65.35" class="difflineat">@@ -2834,21 +2839,24 @@ NS_IMETHODIMP nsMsgLocalMailFolder::EndM</span>
<a href="#l65.36"></a><span id="l65.36">         // we call DeleteMessages on the source folder. So don't mark it for deletion</span>
<a href="#l65.37"></a><span id="l65.37">         // here, in that case.</span>
<a href="#l65.38"></a><span id="l65.38">         if (!GetDeleteFromServerOnMove())</span>
<a href="#l65.39"></a><span id="l65.39">           localSrcFolder-&gt;MarkMsgsOnPop3Server(mCopyState-&gt;m_messages, POP3_DELETE);</span>
<a href="#l65.40"></a><span id="l65.40">       }</span>
<a href="#l65.41"></a><span id="l65.41">     }</span>
<a href="#l65.42"></a><span id="l65.42">     // lets delete these all at once - much faster that way</span>
<a href="#l65.43"></a><span id="l65.43">     rv = srcFolder-&gt;DeleteMessages(mCopyState-&gt;m_messages, mCopyState-&gt;m_msgWindow, PR_TRUE, PR_TRUE, nsnull, mCopyState-&gt;m_allowUndo);</span>
<a href="#l65.44"></a><span id="l65.44" class="difflineminus">-    srcFolder-&gt;NotifyFolderEvent(NS_SUCCEEDED(rv) ? mDeleteOrMoveMsgCompletedAtom : mDeleteOrMoveMsgFailedAtom);</span>
<a href="#l65.45"></a><span id="l65.45">     AutoCompact(mCopyState-&gt;m_msgWindow);</span>
<a href="#l65.46"></a><span id="l65.46"> </span>
<a href="#l65.47"></a><span id="l65.47">     // enable the dest folder</span>
<a href="#l65.48"></a><span id="l65.48">     EnableNotifications(allMessageCountNotifications, PR_TRUE, PR_FALSE /*dbBatching*/); //dest folder doesn't need db batching</span>
<a href="#l65.49"></a><span id="l65.49" class="difflineplus">+    // I'm not too sure of the proper location of this event. It seems to need to be</span>
<a href="#l65.50"></a><span id="l65.50" class="difflineplus">+    // after the EnableNotifications, or the folder counts can be incorrect</span>
<a href="#l65.51"></a><span id="l65.51" class="difflineplus">+    // during the mDeleteOrMoveMsgCompletedAtom call.</span>
<a href="#l65.52"></a><span id="l65.52" class="difflineplus">+    srcFolder-&gt;NotifyFolderEvent(NS_SUCCEEDED(rv) ? mDeleteOrMoveMsgCompletedAtom : mDeleteOrMoveMsgFailedAtom);</span>
<a href="#l65.53"></a><span id="l65.53"> </span>
<a href="#l65.54"></a><span id="l65.54">     if (NS_SUCCEEDED(rv) &amp;&amp; mCopyState-&gt;m_msgWindow &amp;&amp; mCopyState-&gt;m_undoMsgTxn)</span>
<a href="#l65.55"></a><span id="l65.55">     {</span>
<a href="#l65.56"></a><span id="l65.56">       nsCOMPtr&lt;nsITransactionManager&gt; txnMgr;</span>
<a href="#l65.57"></a><span id="l65.57">       mCopyState-&gt;m_msgWindow-&gt;GetTransactionManager(getter_AddRefs(txnMgr));</span>
<a href="#l65.58"></a><span id="l65.58">       if (txnMgr)</span>
<a href="#l65.59"></a><span id="l65.59">         txnMgr-&gt;DoTransaction(mCopyState-&gt;m_undoMsgTxn);</span>
<a href="#l65.60"></a><span id="l65.60">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -534,16 +534,18 @@ nsresult nsPop3Protocol::Initialize(nsIU</span>
<a href="#l66.4"></a><span id="l66.4">     // When we are making a secure connection, we need to make sure that we</span>
<a href="#l66.5"></a><span id="l66.5">     // pass an interface requestor down to the socket transport so that PSM can</span>
<a href="#l66.6"></a><span id="l66.6">     // retrieve a nsIPrompt instance if needed.</span>
<a href="#l66.7"></a><span id="l66.7">     nsCOMPtr&lt;nsIInterfaceRequestor&gt; ir;</span>
<a href="#l66.8"></a><span id="l66.8">     if (m_socketType != nsIMsgIncomingServer::defaultSocket)</span>
<a href="#l66.9"></a><span id="l66.9">     {</span>
<a href="#l66.10"></a><span id="l66.10">       nsCOMPtr&lt;nsIMsgWindow&gt; msgwin;</span>
<a href="#l66.11"></a><span id="l66.11">       mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgwin));</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineplus">+      if (!msgwin)</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineplus">+        GetTopmostMsgWindow(getter_AddRefs(msgwin));</span>
<a href="#l66.14"></a><span id="l66.14">       if (msgwin)</span>
<a href="#l66.15"></a><span id="l66.15">       {</span>
<a href="#l66.16"></a><span id="l66.16">         nsCOMPtr&lt;nsIDocShell&gt; docshell;</span>
<a href="#l66.17"></a><span id="l66.17">         msgwin-&gt;GetRootDocShell(getter_AddRefs(docshell));</span>
<a href="#l66.18"></a><span id="l66.18">         ir = do_QueryInterface(docshell);</span>
<a href="#l66.19"></a><span id="l66.19">         nsCOMPtr&lt;nsIInterfaceRequestor&gt; notificationCallbacks;</span>
<a href="#l66.20"></a><span id="l66.20">         msgwin-&gt;GetNotificationCallbacks(getter_AddRefs(notificationCallbacks));</span>
<a href="#l66.21"></a><span id="l66.21">         if (notificationCallbacks)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/mailnews/test/fakeserver/maild.js</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/mailnews/test/fakeserver/maild.js</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -34,16 +34,21 @@</span>
<a href="#l67.4"></a><span id="l67.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l67.5"></a><span id="l67.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l67.6"></a><span id="l67.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l67.7"></a><span id="l67.7">  *</span>
<a href="#l67.8"></a><span id="l67.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l67.9"></a><span id="l67.9"> </span>
<a href="#l67.10"></a><span id="l67.10"> // Much of the original code is taken from netwerk's httpserver implementation</span>
<a href="#l67.11"></a><span id="l67.11"> </span>
<a href="#l67.12"></a><span id="l67.12" class="difflineplus">+// Make sure we execute this file exactly once</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+var gMaild_js__;</span>
<a href="#l67.14"></a><span id="l67.14" class="difflineplus">+if (!gMaild_js__) {</span>
<a href="#l67.15"></a><span id="l67.15" class="difflineplus">+gMaild_js__ = true;</span>
<a href="#l67.16"></a><span id="l67.16" class="difflineplus">+</span>
<a href="#l67.17"></a><span id="l67.17"> var Cc = Components.classes;</span>
<a href="#l67.18"></a><span id="l67.18"> var Ci = Components.interfaces;</span>
<a href="#l67.19"></a><span id="l67.19"> var Cr = Components.results;</span>
<a href="#l67.20"></a><span id="l67.20"> var CC = Components.Constructor;</span>
<a href="#l67.21"></a><span id="l67.21"> </span>
<a href="#l67.22"></a><span id="l67.22"> /** The XPCOM thread manager. */</span>
<a href="#l67.23"></a><span id="l67.23"> var gThreadManager = null;</span>
<a href="#l67.24"></a><span id="l67.24"> </span>
<a href="#l67.25"></a><span id="l67.25" class="difflineat">@@ -115,26 +120,33 @@ function nsMailServer(handler) {</span>
<a href="#l67.26"></a><span id="l67.26">    * True if the socket in this is closed (and closure notifications have been</span>
<a href="#l67.27"></a><span id="l67.27">    * sent and processed if the socket was ever opened), false otherwise.</span>
<a href="#l67.28"></a><span id="l67.28">    */</span>
<a href="#l67.29"></a><span id="l67.29">   this._socketClosed = true;</span>
<a href="#l67.30"></a><span id="l67.30"> </span>
<a href="#l67.31"></a><span id="l67.31">   this._handler = handler;</span>
<a href="#l67.32"></a><span id="l67.32">   this._readers = [];</span>
<a href="#l67.33"></a><span id="l67.33">   this._test = false;</span>
<a href="#l67.34"></a><span id="l67.34" class="difflineplus">+</span>
<a href="#l67.35"></a><span id="l67.35" class="difflineplus">+  /**</span>
<a href="#l67.36"></a><span id="l67.36" class="difflineplus">+   * An array to hold refs to all the input streams below, so that they don't</span>
<a href="#l67.37"></a><span id="l67.37" class="difflineplus">+   * get GCed</span>
<a href="#l67.38"></a><span id="l67.38" class="difflineplus">+   */</span>
<a href="#l67.39"></a><span id="l67.39" class="difflineplus">+  this._inputStreams = [];</span>
<a href="#l67.40"></a><span id="l67.40"> }</span>
<a href="#l67.41"></a><span id="l67.41"> nsMailServer.prototype = {</span>
<a href="#l67.42"></a><span id="l67.42">   onSocketAccepted : function (socket, trans) {</span>
<a href="#l67.43"></a><span id="l67.43">     if (this._debug != fsDebugNone)</span>
<a href="#l67.44"></a><span id="l67.44">       print(&quot;Received Connection from &quot; + trans.host + &quot;:&quot; + trans.port);</span>
<a href="#l67.45"></a><span id="l67.45"> </span>
<a href="#l67.46"></a><span id="l67.46">     const SEGMENT_SIZE = 1024;</span>
<a href="#l67.47"></a><span id="l67.47">     const SEGMENT_COUNT = 1024;</span>
<a href="#l67.48"></a><span id="l67.48">     var input = trans.openInputStream(0, SEGMENT_SIZE, SEGMENT_COUNT)</span>
<a href="#l67.49"></a><span id="l67.49">                      .QueryInterface(Ci.nsIAsyncInputStream);</span>
<a href="#l67.50"></a><span id="l67.50" class="difflineplus">+    this._inputStreams.push(input);</span>
<a href="#l67.51"></a><span id="l67.51"> </span>
<a href="#l67.52"></a><span id="l67.52">     var reader = new nsMailReader(this, this._handler, trans, this._debug);</span>
<a href="#l67.53"></a><span id="l67.53">     this._readers.push(reader);</span>
<a href="#l67.54"></a><span id="l67.54"> </span>
<a href="#l67.55"></a><span id="l67.55">     // Note: must use main thread here, or we might get a GC that will cause</span>
<a href="#l67.56"></a><span id="l67.56">     //       threadsafety assertions.  We really need to fix XPConnect so that</span>
<a href="#l67.57"></a><span id="l67.57">     //       you can actually do things in multi-threaded JS.  :-(</span>
<a href="#l67.58"></a><span id="l67.58">     input.asyncWait(reader, 0, 0, gThreadManager.mainThread);</span>
<a href="#l67.59"></a><span id="l67.59" class="difflineat">@@ -521,8 +533,10 @@ nsMailReader.prototype = {</span>
<a href="#l67.60"></a><span id="l67.60">  *   use on the server</span>
<a href="#l67.61"></a><span id="l67.61">  */</span>
<a href="#l67.62"></a><span id="l67.62"> function server(port, handler) {</span>
<a href="#l67.63"></a><span id="l67.63">   var srv = new nsMailServer(handler);</span>
<a href="#l67.64"></a><span id="l67.64">   srv.start(port);</span>
<a href="#l67.65"></a><span id="l67.65">   srv.performTest();</span>
<a href="#l67.66"></a><span id="l67.66">   return srv.playTransaction();</span>
<a href="#l67.67"></a><span id="l67.67"> }</span>
<a href="#l67.68"></a><span id="l67.68" class="difflineplus">+</span>
<a href="#l67.69"></a><span id="l67.69" class="difflineplus">+} // gMaild_js__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/mailnews/test/resources/mailDirService.js</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/mailnews/test/resources/mailDirService.js</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -4,16 +4,21 @@</span>
<a href="#l68.4"></a><span id="l68.4">  * directory under the process directory and use that as the profile</span>
<a href="#l68.5"></a><span id="l68.5">  * directory for the mailnews tests to locate files during unit tests.</span>
<a href="#l68.6"></a><span id="l68.6">  *</span>
<a href="#l68.7"></a><span id="l68.7">  * For xpcshell tests, the &quot;profile&quot; directory will be:</span>
<a href="#l68.8"></a><span id="l68.8">  * &lt;objdir&gt;/dist/bin/mailtest/  (on Windows and Linux)</span>
<a href="#l68.9"></a><span id="l68.9">  * &lt;objdir&gt;/dist/Thunderbird{Debug}.app/Contents/MacOS/mailtest/  (on Mac OS X)</span>
<a href="#l68.10"></a><span id="l68.10">  */</span>
<a href="#l68.11"></a><span id="l68.11"> </span>
<a href="#l68.12"></a><span id="l68.12" class="difflineplus">+// Make sure we execute this file exactly once</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineplus">+var gMailDirService_js__;</span>
<a href="#l68.14"></a><span id="l68.14" class="difflineplus">+if (!gMailDirService_js__) {</span>
<a href="#l68.15"></a><span id="l68.15" class="difflineplus">+gMailDirService_js__ = true;</span>
<a href="#l68.16"></a><span id="l68.16" class="difflineplus">+</span>
<a href="#l68.17"></a><span id="l68.17"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l68.18"></a><span id="l68.18"> </span>
<a href="#l68.19"></a><span id="l68.19"> // Declare these globally for unit tests and be done with it.</span>
<a href="#l68.20"></a><span id="l68.20"> var Cc = Components.classes;</span>
<a href="#l68.21"></a><span id="l68.21"> var Ci = Components.interfaces;</span>
<a href="#l68.22"></a><span id="l68.22"> var Cr = Components.results;</span>
<a href="#l68.23"></a><span id="l68.23"> var CC = Components.Constructor;</span>
<a href="#l68.24"></a><span id="l68.24"> </span>
<a href="#l68.25"></a><span id="l68.25" class="difflineat">@@ -128,8 +133,10 @@ catch (e) {</span>
<a href="#l68.26"></a><span id="l68.26">   if (gProfileDir.exists())</span>
<a href="#l68.27"></a><span id="l68.27">     gProfileDir.remove(true);</span>
<a href="#l68.28"></a><span id="l68.28"> </span>
<a href="#l68.29"></a><span id="l68.29">   // This throw is so that we know if this bug happens</span>
<a href="#l68.30"></a><span id="l68.30">   throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l68.31"></a><span id="l68.31"> }</span>
<a href="#l68.32"></a><span id="l68.32"> // Always ensure the profile directory exists before we start the tests</span>
<a href="#l68.33"></a><span id="l68.33"> gProfileDir.create(Ci.nsIFile.DIRECTORY_TYPE, 0700);</span>
<a href="#l68.34"></a><span id="l68.34" class="difflineplus">+</span>
<a href="#l68.35"></a><span id="l68.35" class="difflineplus">+} // gMailDirService_js__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/mailnews/test/resources/mailTestUtils.js</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/mailnews/test/resources/mailTestUtils.js</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -30,16 +30,21 @@</span>
<a href="#l69.4"></a><span id="l69.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l69.5"></a><span id="l69.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l69.6"></a><span id="l69.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l69.7"></a><span id="l69.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l69.8"></a><span id="l69.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l69.9"></a><span id="l69.9">  *</span>
<a href="#l69.10"></a><span id="l69.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l69.11"></a><span id="l69.11"> </span>
<a href="#l69.12"></a><span id="l69.12" class="difflineplus">+// Make sure we execute this file exactly once</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineplus">+var gMailTestUtils_js__;</span>
<a href="#l69.14"></a><span id="l69.14" class="difflineplus">+if (!gMailTestUtils_js__) {</span>
<a href="#l69.15"></a><span id="l69.15" class="difflineplus">+gMailTestUtils_js__ = true;</span>
<a href="#l69.16"></a><span id="l69.16" class="difflineplus">+</span>
<a href="#l69.17"></a><span id="l69.17"> // we would like for everyone to have fixIterator and toXPComArray</span>
<a href="#l69.18"></a><span id="l69.18"> Components.utils.import(&quot;resource://gre/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l69.19"></a><span id="l69.19"> </span>
<a href="#l69.20"></a><span id="l69.20"> // Local Mail Folders. Requires prior setup of profile directory</span>
<a href="#l69.21"></a><span id="l69.21"> </span>
<a href="#l69.22"></a><span id="l69.22"> var gLocalIncomingServer;</span>
<a href="#l69.23"></a><span id="l69.23"> var gLocalInboxFolder;</span>
<a href="#l69.24"></a><span id="l69.24"> </span>
<a href="#l69.25"></a><span id="l69.25" class="difflineat">@@ -270,8 +275,10 @@ function updateFolderAndNotify(aFolder, </span>
<a href="#l69.26"></a><span id="l69.26">       }</span>
<a href="#l69.27"></a><span id="l69.27">     }</span>
<a href="#l69.28"></a><span id="l69.28">   };</span>
<a href="#l69.29"></a><span id="l69.29"> </span>
<a href="#l69.30"></a><span id="l69.30">   mailSession.AddFolderListener(folderListener, Ci.nsIFolderListener.event);</span>
<a href="#l69.31"></a><span id="l69.31"> </span>
<a href="#l69.32"></a><span id="l69.32">   aFolder.updateFolder(null);</span>
<a href="#l69.33"></a><span id="l69.33"> }</span>
<a href="#l69.34"></a><span id="l69.34" class="difflineplus">+</span>
<a href="#l69.35"></a><span id="l69.35" class="difflineplus">+} // gMailTestUtils_js__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/suite/common/downloads/downloadmanager.xul</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/suite/common/downloads/downloadmanager.xul</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -167,17 +167,18 @@</span>
<a href="#l70.4"></a><span id="l70.4">       &lt;menuitem id=&quot;dlContext-remove&quot;</span>
<a href="#l70.5"></a><span id="l70.5">                 label=&quot;&amp;cmd.remove.label;&quot;</span>
<a href="#l70.6"></a><span id="l70.6">                 accesskey=&quot;&amp;cmd.remove.accesskey;&quot;</span>
<a href="#l70.7"></a><span id="l70.7">                 command=&quot;cmd_remove&quot;/&gt;</span>
<a href="#l70.8"></a><span id="l70.8">       &lt;menuseparator/&gt;</span>
<a href="#l70.9"></a><span id="l70.9">       &lt;menuitem id=&quot;dlContext-open&quot;</span>
<a href="#l70.10"></a><span id="l70.10">                 label=&quot;&amp;cmd.open.label;&quot;</span>
<a href="#l70.11"></a><span id="l70.11">                 accesskey=&quot;&amp;cmd.open.accesskey;&quot;</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-                command=&quot;cmd_open&quot;/&gt;</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineplus">+                command=&quot;cmd_open&quot;</span>
<a href="#l70.14"></a><span id="l70.14" class="difflineplus">+                default=&quot;true&quot;/&gt;</span>
<a href="#l70.15"></a><span id="l70.15">       &lt;menuitem id=&quot;dlContext-show&quot;</span>
<a href="#l70.16"></a><span id="l70.16">                 label=&quot;&amp;cmd.show.label;&quot;</span>
<a href="#l70.17"></a><span id="l70.17">                 accesskey=&quot;&amp;cmd.show.accesskey;&quot;</span>
<a href="#l70.18"></a><span id="l70.18">                 command=&quot;cmd_show&quot;/&gt;</span>
<a href="#l70.19"></a><span id="l70.19">       &lt;menuitem id=&quot;dlContext-openReferrer&quot;</span>
<a href="#l70.20"></a><span id="l70.20">                 label=&quot;&amp;cmd.goToDownloadPage.label;&quot;</span>
<a href="#l70.21"></a><span id="l70.21">                 accesskey=&quot;&amp;cmd.goToDownloadPage.accesskey;&quot;</span>
<a href="#l70.22"></a><span id="l70.22">                 command=&quot;cmd_openReferrer&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/suite/common/pref/pref-download.xul</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/suite/common/pref/pref-download.xul</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -33,17 +33,16 @@</span>
<a href="#l71.4"></a><span id="l71.4">  decision by deleting the provisions above and replace them with the notice</span>
<a href="#l71.5"></a><span id="l71.5">  and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l71.6"></a><span id="l71.6">  the provisions above, a recipient may use your version of this file under</span>
<a href="#l71.7"></a><span id="l71.7">  the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l71.8"></a><span id="l71.8"> </span>
<a href="#l71.9"></a><span id="l71.9">  ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l71.10"></a><span id="l71.10"> </span>
<a href="#l71.11"></a><span id="l71.11"> &lt;?xml-stylesheet href=&quot;chrome://communicator/skin/&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l71.12"></a><span id="l71.12" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://mozapps/content/preferences/preferences.css&quot;?&gt;</span>
<a href="#l71.13"></a><span id="l71.13"> </span>
<a href="#l71.14"></a><span id="l71.14"> &lt;!DOCTYPE overlay SYSTEM &quot;chrome://communicator/locale/pref/pref-download.dtd&quot;&gt;</span>
<a href="#l71.15"></a><span id="l71.15"> </span>
<a href="#l71.16"></a><span id="l71.16"> &lt;overlay xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l71.17"></a><span id="l71.17">   &lt;prefpane id=&quot;download_pane&quot;</span>
<a href="#l71.18"></a><span id="l71.18">             label=&quot;&amp;pref.download.title;&quot;</span>
<a href="#l71.19"></a><span id="l71.19">             script=&quot;chrome://communicator/content/pref/pref-download.js&quot;&gt;</span>
<a href="#l71.20"></a><span id="l71.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/suite/common/pref/preferences.xul</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/suite/common/pref/preferences.xul</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -34,17 +34,16 @@</span>
<a href="#l72.4"></a><span id="l72.4">    - the provisions above, a recipient may use your version of this file under</span>
<a href="#l72.5"></a><span id="l72.5">    - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l72.6"></a><span id="l72.6">    -</span>
<a href="#l72.7"></a><span id="l72.7">    - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l72.8"></a><span id="l72.8"> </span>
<a href="#l72.9"></a><span id="l72.9"> &lt;?xml-stylesheet type=&quot;text/css&quot; href=&quot;chrome://communicator/skin/&quot;?&gt;</span>
<a href="#l72.10"></a><span id="l72.10"> &lt;?xml-stylesheet type=&quot;text/css&quot; href=&quot;chrome://communicator/content/communicator.css&quot;?&gt;</span>
<a href="#l72.11"></a><span id="l72.11"> &lt;?xml-stylesheet type=&quot;text/css&quot; href=&quot;chrome://communicator/content/pref/prefpanels.css&quot;?&gt;</span>
<a href="#l72.12"></a><span id="l72.12" class="difflineminus">-&lt;?xml-stylesheet type=&quot;text/css&quot; href=&quot;chrome://mozapps/content/preferences/preferences.css&quot;?&gt;</span>
<a href="#l72.13"></a><span id="l72.13"> &lt;?xml-stylesheet type=&quot;text/css&quot; href=&quot;chrome://communicator/skin/prefpanels.css&quot;?&gt;</span>
<a href="#l72.14"></a><span id="l72.14"> &lt;?xml-stylesheet type=&quot;text/css&quot; href=&quot;chrome://communicator/skin/preferences.css&quot;?&gt;</span>
<a href="#l72.15"></a><span id="l72.15"> </span>
<a href="#l72.16"></a><span id="l72.16"> &lt;!DOCTYPE prefwindow [</span>
<a href="#l72.17"></a><span id="l72.17">   &lt;!ENTITY % dtdPrefs    SYSTEM &quot;chrome://communicator/locale/pref/preferences.dtd&quot;&gt; %dtdPrefs;</span>
<a href="#l72.18"></a><span id="l72.18">   &lt;!ENTITY % dtdPlatform SYSTEM &quot;chrome://communicator-platform/locale/pref/platformPrefOverlay.dtd&quot;&gt; %dtdPlatform;</span>
<a href="#l72.19"></a><span id="l72.19"> ]&gt;</span>
<a href="#l72.20"></a><span id="l72.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/suite/common/src/nsSessionStore.js</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/suite/common/src/nsSessionStore.js</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -313,17 +313,17 @@ SessionStoreService.prototype = {</span>
<a href="#l73.4"></a><span id="l73.4">         this._prefBranch.setBoolPref(&quot;sessionstore.resume_session_once&quot;, true);</span>
<a href="#l73.5"></a><span id="l73.5">       this._loadState = STATE_QUITTING; // just to be sure</span>
<a href="#l73.6"></a><span id="l73.6">       this._uninit();</span>
<a href="#l73.7"></a><span id="l73.7">       break;</span>
<a href="#l73.8"></a><span id="l73.8">     case &quot;browser:purge-session-history&quot;: // catch sanitization</span>
<a href="#l73.9"></a><span id="l73.9">       let openWindows = {};</span>
<a href="#l73.10"></a><span id="l73.10">       this._forEachBrowserWindow(function(aWindow) {</span>
<a href="#l73.11"></a><span id="l73.11">         Array.forEach(aWindow.getBrowser().browsers, function(aBrowser) {</span>
<a href="#l73.12"></a><span id="l73.12" class="difflineminus">-          delete aBrowser.parentNode.__SS_data;</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineplus">+          delete aBrowser.__SS_data;</span>
<a href="#l73.14"></a><span id="l73.14">         });</span>
<a href="#l73.15"></a><span id="l73.15">         openWindows[aWindow.__SSi] = true;</span>
<a href="#l73.16"></a><span id="l73.16">       });</span>
<a href="#l73.17"></a><span id="l73.17">       // also clear all data about closed tabs and windows</span>
<a href="#l73.18"></a><span id="l73.18">       for (let ix in this._windows) {</span>
<a href="#l73.19"></a><span id="l73.19">         if (ix in openWindows)</span>
<a href="#l73.20"></a><span id="l73.20">           this._windows[ix]._closedTabs = [];</span>
<a href="#l73.21"></a><span id="l73.21">         else</span>
<a href="#l73.22"></a><span id="l73.22" class="difflineat">@@ -372,46 +372,45 @@ SessionStoreService.prototype = {</span>
<a href="#l73.23"></a><span id="l73.23">   },</span>
<a href="#l73.24"></a><span id="l73.24"> </span>
<a href="#l73.25"></a><span id="l73.25"> /* ........ Window Event Handlers .............. */</span>
<a href="#l73.26"></a><span id="l73.26"> </span>
<a href="#l73.27"></a><span id="l73.27">   /**</span>
<a href="#l73.28"></a><span id="l73.28">    * Implement nsIDOMEventListener for handling various window and tab events</span>
<a href="#l73.29"></a><span id="l73.29">    */</span>
<a href="#l73.30"></a><span id="l73.30">   handleEvent: function sss_handleEvent(aEvent) {</span>
<a href="#l73.31"></a><span id="l73.31" class="difflineplus">+    var win = aEvent.currentTarget.ownerDocument.defaultView;</span>
<a href="#l73.32"></a><span id="l73.32">     switch (aEvent.type) {</span>
<a href="#l73.33"></a><span id="l73.33">       case &quot;load&quot;:</span>
<a href="#l73.34"></a><span id="l73.34">       case &quot;pageshow&quot;:</span>
<a href="#l73.35"></a><span id="l73.35" class="difflineminus">-        this.onTabLoad(aEvent.currentTarget.ownerDocument.defaultView, aEvent.currentTarget, aEvent);</span>
<a href="#l73.36"></a><span id="l73.36" class="difflineplus">+        this.onTabLoad(win, aEvent.currentTarget, aEvent);</span>
<a href="#l73.37"></a><span id="l73.37">         break;</span>
<a href="#l73.38"></a><span id="l73.38">       case &quot;change&quot;:</span>
<a href="#l73.39"></a><span id="l73.39">       case &quot;input&quot;:</span>
<a href="#l73.40"></a><span id="l73.40">       case &quot;DOMAutoComplete&quot;:</span>
<a href="#l73.41"></a><span id="l73.41" class="difflineminus">-        this.onTabInput(aEvent.currentTarget.ownerDocument.defaultView, aEvent.currentTarget);</span>
<a href="#l73.42"></a><span id="l73.42" class="difflineplus">+        this.onTabInput(win, aEvent.currentTarget);</span>
<a href="#l73.43"></a><span id="l73.43">         break;</span>
<a href="#l73.44"></a><span id="l73.44">       case &quot;scroll&quot;:</span>
<a href="#l73.45"></a><span id="l73.45" class="difflineminus">-        this.onTabScroll(aEvent.currentTarget.ownerDocument.defaultView);</span>
<a href="#l73.46"></a><span id="l73.46" class="difflineplus">+        this.onTabScroll(win);</span>
<a href="#l73.47"></a><span id="l73.47">         break;</span>
<a href="#l73.48"></a><span id="l73.48">       case &quot;TabOpen&quot;:</span>
<a href="#l73.49"></a><span id="l73.49">       case &quot;TabClose&quot;:</span>
<a href="#l73.50"></a><span id="l73.50" class="difflineminus">-        var panelID = aEvent.originalTarget.linkedPanel;</span>
<a href="#l73.51"></a><span id="l73.51" class="difflineminus">-        var tabpanel = aEvent.originalTarget.ownerDocument.getElementById(panelID);</span>
<a href="#l73.52"></a><span id="l73.52" class="difflineplus">+        let browser = aEvent.originalTarget.linkedBrowser;</span>
<a href="#l73.53"></a><span id="l73.53">         if (aEvent.type == &quot;TabOpen&quot;) {</span>
<a href="#l73.54"></a><span id="l73.54" class="difflineminus">-          this.onTabAdd(aEvent.currentTarget.ownerDocument.defaultView, tabpanel);</span>
<a href="#l73.55"></a><span id="l73.55" class="difflineplus">+          this.onTabAdd(win, browser);</span>
<a href="#l73.56"></a><span id="l73.56">         }</span>
<a href="#l73.57"></a><span id="l73.57">         else {</span>
<a href="#l73.58"></a><span id="l73.58">           // aEvent.detail determines if the tab was closed by moving to a different window</span>
<a href="#l73.59"></a><span id="l73.59">           if (!aEvent.detail)</span>
<a href="#l73.60"></a><span id="l73.60" class="difflineminus">-            this.onTabClose(aEvent.currentTarget.ownerDocument.defaultView, aEvent.originalTarget);</span>
<a href="#l73.61"></a><span id="l73.61" class="difflineminus">-          this.onTabRemove(aEvent.currentTarget.ownerDocument.defaultView, tabpanel);</span>
<a href="#l73.62"></a><span id="l73.62" class="difflineplus">+            this.onTabClose(win, aEvent.originalTarget);</span>
<a href="#l73.63"></a><span id="l73.63" class="difflineplus">+          this.onTabRemove(win, browser);</span>
<a href="#l73.64"></a><span id="l73.64">         }</span>
<a href="#l73.65"></a><span id="l73.65">         break;</span>
<a href="#l73.66"></a><span id="l73.66">       case &quot;TabSelect&quot;:</span>
<a href="#l73.67"></a><span id="l73.67" class="difflineminus">-        var tabpanels = aEvent.currentTarget.mPanelContainer;</span>
<a href="#l73.68"></a><span id="l73.68" class="difflineminus">-        this.onTabSelect(aEvent.currentTarget.ownerDocument.defaultView, tabpanels);</span>
<a href="#l73.69"></a><span id="l73.69" class="difflineplus">+        this.onTabSelect(win);</span>
<a href="#l73.70"></a><span id="l73.70">         break;</span>
<a href="#l73.71"></a><span id="l73.71">     }</span>
<a href="#l73.72"></a><span id="l73.72">   },</span>
<a href="#l73.73"></a><span id="l73.73"> </span>
<a href="#l73.74"></a><span id="l73.74">   /**</span>
<a href="#l73.75"></a><span id="l73.75">    * If it's the first window load since app start...</span>
<a href="#l73.76"></a><span id="l73.76">    * - determine if we're reloading after a crash or a forced-restart</span>
<a href="#l73.77"></a><span id="l73.77">    * - restore window state</span>
<a href="#l73.78"></a><span id="l73.78" class="difflineat">@@ -466,21 +465,20 @@ SessionStoreService.prototype = {</span>
<a href="#l73.79"></a><span id="l73.79">     }</span>
<a href="#l73.80"></a><span id="l73.80">     // this window was opened by _openWindowWithState</span>
<a href="#l73.81"></a><span id="l73.81">     else if (!this._isWindowLoaded(aWindow)) {</span>
<a href="#l73.82"></a><span id="l73.82">       let followUp = this._statesToRestore[aWindow.__SS_restoreID].windows.length == 1;</span>
<a href="#l73.83"></a><span id="l73.83">       this.restoreWindow(aWindow, this._statesToRestore[aWindow.__SS_restoreID], true, followUp);</span>
<a href="#l73.84"></a><span id="l73.84">     }</span>
<a href="#l73.85"></a><span id="l73.85"> </span>
<a href="#l73.86"></a><span id="l73.86">     var tabbrowser = aWindow.getBrowser();</span>
<a href="#l73.87"></a><span id="l73.87" class="difflineminus">-    var tabpanels = tabbrowser.mPanelContainer;</span>
<a href="#l73.88"></a><span id="l73.88"> </span>
<a href="#l73.89"></a><span id="l73.89">     // add tab change listeners to all already existing tabs</span>
<a href="#l73.90"></a><span id="l73.90" class="difflineminus">-    for (var i = 0; i &lt; tabpanels.childNodes.length; i++) {</span>
<a href="#l73.91"></a><span id="l73.91" class="difflineminus">-      this.onTabAdd(aWindow, tabpanels.childNodes[i], true);</span>
<a href="#l73.92"></a><span id="l73.92" class="difflineplus">+    for (let i = 0; i &lt; tabbrowser.browsers.length; i++) {</span>
<a href="#l73.93"></a><span id="l73.93" class="difflineplus">+      this.onTabAdd(aWindow, tabbrowser.browsers[i], true);</span>
<a href="#l73.94"></a><span id="l73.94">     }</span>
<a href="#l73.95"></a><span id="l73.95">     // notification of tab add/remove/selection</span>
<a href="#l73.96"></a><span id="l73.96">     tabbrowser.addEventListener(&quot;TabOpen&quot;, this, true);</span>
<a href="#l73.97"></a><span id="l73.97">     tabbrowser.addEventListener(&quot;TabClose&quot;, this, true);</span>
<a href="#l73.98"></a><span id="l73.98">     tabbrowser.addEventListener(&quot;TabSelect&quot;, this, true);</span>
<a href="#l73.99"></a><span id="l73.99">   },</span>
<a href="#l73.100"></a><span id="l73.100"> </span>
<a href="#l73.101"></a><span id="l73.101">   /**</span>
<a href="#l73.102"></a><span id="l73.102" class="difflineat">@@ -506,17 +504,16 @@ SessionStoreService.prototype = {</span>
<a href="#l73.103"></a><span id="l73.103">       return;</span>
<a href="#l73.104"></a><span id="l73.104">     }</span>
<a href="#l73.105"></a><span id="l73.105"> </span>
<a href="#l73.106"></a><span id="l73.106">     if (this.windowToFocus &amp;&amp; this.windowToFocus == aWindow) {</span>
<a href="#l73.107"></a><span id="l73.107">       delete this.windowToFocus;</span>
<a href="#l73.108"></a><span id="l73.108">     }</span>
<a href="#l73.109"></a><span id="l73.109"> </span>
<a href="#l73.110"></a><span id="l73.110">     var tabbrowser = aWindow.getBrowser();</span>
<a href="#l73.111"></a><span id="l73.111" class="difflineminus">-    var tabpanels = tabbrowser.mPanelContainer;</span>
<a href="#l73.112"></a><span id="l73.112"> </span>
<a href="#l73.113"></a><span id="l73.113">     tabbrowser.removeEventListener(&quot;TabOpen&quot;, this, true);</span>
<a href="#l73.114"></a><span id="l73.114">     tabbrowser.removeEventListener(&quot;TabClose&quot;, this, true);</span>
<a href="#l73.115"></a><span id="l73.115">     tabbrowser.removeEventListener(&quot;TabSelect&quot;, this, true);</span>
<a href="#l73.116"></a><span id="l73.116"> </span>
<a href="#l73.117"></a><span id="l73.117">     let winData = this._windows[aWindow.__SSi];</span>
<a href="#l73.118"></a><span id="l73.118">     if (this._loadState == STATE_RUNNING) { // window not closed during a regular shut-down</span>
<a href="#l73.119"></a><span id="l73.119">       // update all window data for a last time</span>
<a href="#l73.120"></a><span id="l73.120" class="difflineat">@@ -538,78 +535,78 @@ SessionStoreService.prototype = {</span>
<a href="#l73.121"></a><span id="l73.121"> </span>
<a href="#l73.122"></a><span id="l73.122">       // clear this window from the list</span>
<a href="#l73.123"></a><span id="l73.123">       delete this._windows[aWindow.__SSi];</span>
<a href="#l73.124"></a><span id="l73.124"> </span>
<a href="#l73.125"></a><span id="l73.125">       // save the state without this window to disk</span>
<a href="#l73.126"></a><span id="l73.126">       this.saveStateDelayed();</span>
<a href="#l73.127"></a><span id="l73.127">     }</span>
<a href="#l73.128"></a><span id="l73.128"> </span>
<a href="#l73.129"></a><span id="l73.129" class="difflineminus">-    for (var i = 0; i &lt; tabpanels.childNodes.length; i++) {</span>
<a href="#l73.130"></a><span id="l73.130" class="difflineminus">-      this.onTabRemove(aWindow, tabpanels.childNodes[i], true);</span>
<a href="#l73.131"></a><span id="l73.131" class="difflineplus">+    for (let i = 0; i &lt; tabbrowser.browsers.length; i++) {</span>
<a href="#l73.132"></a><span id="l73.132" class="difflineplus">+      this.onTabRemove(aWindow, tabbrowser.browsers[i], true);</span>
<a href="#l73.133"></a><span id="l73.133">     }</span>
<a href="#l73.134"></a><span id="l73.134"> </span>
<a href="#l73.135"></a><span id="l73.135">     // cache the window state until the window is completely gone</span>
<a href="#l73.136"></a><span id="l73.136">     aWindow.__SS_dyingCache = winData;</span>
<a href="#l73.137"></a><span id="l73.137"> </span>
<a href="#l73.138"></a><span id="l73.138">     delete aWindow.__SSi;</span>
<a href="#l73.139"></a><span id="l73.139">   },</span>
<a href="#l73.140"></a><span id="l73.140"> </span>
<a href="#l73.141"></a><span id="l73.141">   /**</span>
<a href="#l73.142"></a><span id="l73.142">    * set up listeners for a new tab</span>
<a href="#l73.143"></a><span id="l73.143">    * @param aWindow</span>
<a href="#l73.144"></a><span id="l73.144">    *        Window reference</span>
<a href="#l73.145"></a><span id="l73.145" class="difflineminus">-   * @param aPanel</span>
<a href="#l73.146"></a><span id="l73.146" class="difflineminus">-   *        TabPanel reference</span>
<a href="#l73.147"></a><span id="l73.147" class="difflineplus">+   * @param aBrowser</span>
<a href="#l73.148"></a><span id="l73.148" class="difflineplus">+   *        Browser reference</span>
<a href="#l73.149"></a><span id="l73.149">    * @param aNoNotification</span>
<a href="#l73.150"></a><span id="l73.150">    *        bool Do not save state if we're updating an existing tab</span>
<a href="#l73.151"></a><span id="l73.151">    */</span>
<a href="#l73.152"></a><span id="l73.152" class="difflineminus">-  onTabAdd: function sss_onTabAdd(aWindow, aPanel, aNoNotification) {</span>
<a href="#l73.153"></a><span id="l73.153" class="difflineminus">-    aPanel.addEventListener(&quot;load&quot;, this, true);</span>
<a href="#l73.154"></a><span id="l73.154" class="difflineminus">-    aPanel.addEventListener(&quot;pageshow&quot;, this, true);</span>
<a href="#l73.155"></a><span id="l73.155" class="difflineminus">-    aPanel.addEventListener(&quot;change&quot;, this, true);</span>
<a href="#l73.156"></a><span id="l73.156" class="difflineminus">-    aPanel.addEventListener(&quot;input&quot;, this, true);</span>
<a href="#l73.157"></a><span id="l73.157" class="difflineminus">-    aPanel.addEventListener(&quot;DOMAutoComplete&quot;, this, true);</span>
<a href="#l73.158"></a><span id="l73.158" class="difflineminus">-    aPanel.addEventListener(&quot;scroll&quot;, this, true);</span>
<a href="#l73.159"></a><span id="l73.159" class="difflineplus">+  onTabAdd: function sss_onTabAdd(aWindow, aBrowser, aNoNotification) {</span>
<a href="#l73.160"></a><span id="l73.160" class="difflineplus">+    aBrowser.addEventListener(&quot;load&quot;, this, true);</span>
<a href="#l73.161"></a><span id="l73.161" class="difflineplus">+    aBrowser.addEventListener(&quot;pageshow&quot;, this, true);</span>
<a href="#l73.162"></a><span id="l73.162" class="difflineplus">+    aBrowser.addEventListener(&quot;change&quot;, this, true);</span>
<a href="#l73.163"></a><span id="l73.163" class="difflineplus">+    aBrowser.addEventListener(&quot;input&quot;, this, true);</span>
<a href="#l73.164"></a><span id="l73.164" class="difflineplus">+    aBrowser.addEventListener(&quot;DOMAutoComplete&quot;, this, true);</span>
<a href="#l73.165"></a><span id="l73.165" class="difflineplus">+    aBrowser.addEventListener(&quot;scroll&quot;, this, true);</span>
<a href="#l73.166"></a><span id="l73.166"> </span>
<a href="#l73.167"></a><span id="l73.167">     if (!aNoNotification) {</span>
<a href="#l73.168"></a><span id="l73.168">       this.saveStateDelayed(aWindow);</span>
<a href="#l73.169"></a><span id="l73.169">     }</span>
<a href="#l73.170"></a><span id="l73.170">   },</span>
<a href="#l73.171"></a><span id="l73.171"> </span>
<a href="#l73.172"></a><span id="l73.172">   /**</span>
<a href="#l73.173"></a><span id="l73.173">    * remove listeners for a tab</span>
<a href="#l73.174"></a><span id="l73.174">    * @param aWindow</span>
<a href="#l73.175"></a><span id="l73.175">    *        Window reference</span>
<a href="#l73.176"></a><span id="l73.176" class="difflineminus">-   * @param aPanel</span>
<a href="#l73.177"></a><span id="l73.177" class="difflineminus">-   *        TabPanel reference</span>
<a href="#l73.178"></a><span id="l73.178" class="difflineplus">+   * @param aBrowser</span>
<a href="#l73.179"></a><span id="l73.179" class="difflineplus">+   *        Browser reference</span>
<a href="#l73.180"></a><span id="l73.180">    * @param aNoNotification</span>
<a href="#l73.181"></a><span id="l73.181">    *        bool Do not save state if we're updating an existing tab</span>
<a href="#l73.182"></a><span id="l73.182">    */</span>
<a href="#l73.183"></a><span id="l73.183" class="difflineminus">-  onTabRemove: function sss_onTabRemove(aWindow, aPanel, aNoNotification) {</span>
<a href="#l73.184"></a><span id="l73.184" class="difflineminus">-    aPanel.removeEventListener(&quot;load&quot;, this, true);</span>
<a href="#l73.185"></a><span id="l73.185" class="difflineminus">-    aPanel.removeEventListener(&quot;pageshow&quot;, this, true);</span>
<a href="#l73.186"></a><span id="l73.186" class="difflineminus">-    aPanel.removeEventListener(&quot;change&quot;, this, true);</span>
<a href="#l73.187"></a><span id="l73.187" class="difflineminus">-    aPanel.removeEventListener(&quot;input&quot;, this, true);</span>
<a href="#l73.188"></a><span id="l73.188" class="difflineminus">-    aPanel.removeEventListener(&quot;DOMAutoComplete&quot;, this, true);</span>
<a href="#l73.189"></a><span id="l73.189" class="difflineminus">-    aPanel.removeEventListener(&quot;scroll&quot;, this, true);</span>
<a href="#l73.190"></a><span id="l73.190" class="difflineplus">+  onTabRemove: function sss_onTabRemove(aWindow, aBrowser, aNoNotification) {</span>
<a href="#l73.191"></a><span id="l73.191" class="difflineplus">+    aBrowser.removeEventListener(&quot;load&quot;, this, true);</span>
<a href="#l73.192"></a><span id="l73.192" class="difflineplus">+    aBrowser.removeEventListener(&quot;pageshow&quot;, this, true);</span>
<a href="#l73.193"></a><span id="l73.193" class="difflineplus">+    aBrowser.removeEventListener(&quot;change&quot;, this, true);</span>
<a href="#l73.194"></a><span id="l73.194" class="difflineplus">+    aBrowser.removeEventListener(&quot;input&quot;, this, true);</span>
<a href="#l73.195"></a><span id="l73.195" class="difflineplus">+    aBrowser.removeEventListener(&quot;DOMAutoComplete&quot;, this, true);</span>
<a href="#l73.196"></a><span id="l73.196" class="difflineplus">+    aBrowser.removeEventListener(&quot;scroll&quot;, this, true);</span>
<a href="#l73.197"></a><span id="l73.197"> </span>
<a href="#l73.198"></a><span id="l73.198" class="difflineminus">-    delete aPanel.__SS_data;</span>
<a href="#l73.199"></a><span id="l73.199" class="difflineplus">+    delete aBrowser.__SS_data;</span>
<a href="#l73.200"></a><span id="l73.200"> </span>
<a href="#l73.201"></a><span id="l73.201">     if (!aNoNotification) {</span>
<a href="#l73.202"></a><span id="l73.202">       this.saveStateDelayed(aWindow);</span>
<a href="#l73.203"></a><span id="l73.203">     }</span>
<a href="#l73.204"></a><span id="l73.204">   },</span>
<a href="#l73.205"></a><span id="l73.205"> </span>
<a href="#l73.206"></a><span id="l73.206">   /**</span>
<a href="#l73.207"></a><span id="l73.207">    * When a tab closes, collect its properties</span>
<a href="#l73.208"></a><span id="l73.208">    * @param aWindow</span>
<a href="#l73.209"></a><span id="l73.209">    *        Window reference</span>
<a href="#l73.210"></a><span id="l73.210">    * @param aTab</span>
<a href="#l73.211"></a><span id="l73.211" class="difflineminus">-   *        TabPanel reference</span>
<a href="#l73.212"></a><span id="l73.212" class="difflineplus">+   *        Tab reference</span>
<a href="#l73.213"></a><span id="l73.213">    */</span>
<a href="#l73.214"></a><span id="l73.214">   onTabClose: function sss_onTabClose(aWindow, aTab) {</span>
<a href="#l73.215"></a><span id="l73.215">     // notify the tabbrowser that the tab state will be retrieved for the last time</span>
<a href="#l73.216"></a><span id="l73.216">     // (so that extension authors can easily set data on soon-to-be-closed tabs)</span>
<a href="#l73.217"></a><span id="l73.217">     var event = aWindow.document.createEvent(&quot;Events&quot;);</span>
<a href="#l73.218"></a><span id="l73.218">     event.initEvent(&quot;SSTabClosing&quot;, true, false);</span>
<a href="#l73.219"></a><span id="l73.219">     aTab.dispatchEvent(event);</span>
<a href="#l73.220"></a><span id="l73.220"> </span>
<a href="#l73.221"></a><span id="l73.221" class="difflineat">@@ -638,68 +635,66 @@ SessionStoreService.prototype = {</span>
<a href="#l73.222"></a><span id="l73.222">       aTab.tabData = tabsData;</span>
<a href="#l73.223"></a><span id="l73.223">     };</span>
<a href="#l73.224"></a><span id="l73.224">   },</span>
<a href="#l73.225"></a><span id="l73.225"> </span>
<a href="#l73.226"></a><span id="l73.226">   /**</span>
<a href="#l73.227"></a><span id="l73.227">    * When a tab loads, save state.</span>
<a href="#l73.228"></a><span id="l73.228">    * @param aWindow</span>
<a href="#l73.229"></a><span id="l73.229">    *        Window reference</span>
<a href="#l73.230"></a><span id="l73.230" class="difflineminus">-   * @param aPanel</span>
<a href="#l73.231"></a><span id="l73.231" class="difflineminus">-   *        TabPanel reference</span>
<a href="#l73.232"></a><span id="l73.232" class="difflineplus">+   * @param aBrowser</span>
<a href="#l73.233"></a><span id="l73.233" class="difflineplus">+   *        Browser reference</span>
<a href="#l73.234"></a><span id="l73.234">    * @param aEvent</span>
<a href="#l73.235"></a><span id="l73.235">    *        Event obj</span>
<a href="#l73.236"></a><span id="l73.236">    */</span>
<a href="#l73.237"></a><span id="l73.237" class="difflineminus">-  onTabLoad: function sss_onTabLoad(aWindow, aPanel, aEvent) {</span>
<a href="#l73.238"></a><span id="l73.238" class="difflineplus">+  onTabLoad: function sss_onTabLoad(aWindow, aBrowser, aEvent) {</span>
<a href="#l73.239"></a><span id="l73.239">     // react on &quot;load&quot; and solitary &quot;pageshow&quot; events (the first &quot;pageshow&quot;</span>
<a href="#l73.240"></a><span id="l73.240">     // following &quot;load&quot; is too late for deleting the data caches)</span>
<a href="#l73.241"></a><span id="l73.241">     if (aEvent.type != &quot;load&quot; &amp;&amp; !aEvent.persisted) {</span>
<a href="#l73.242"></a><span id="l73.242">       return;</span>
<a href="#l73.243"></a><span id="l73.243">     }</span>
<a href="#l73.244"></a><span id="l73.244"> </span>
<a href="#l73.245"></a><span id="l73.245" class="difflineminus">-    delete aPanel.__SS_data;</span>
<a href="#l73.246"></a><span id="l73.246" class="difflineplus">+    delete aBrowser.__SS_data;</span>
<a href="#l73.247"></a><span id="l73.247">     this.saveStateDelayed(aWindow);</span>
<a href="#l73.248"></a><span id="l73.248"> </span>
<a href="#l73.249"></a><span id="l73.249">     // attempt to update the current URL we send in a crash report</span>
<a href="#l73.250"></a><span id="l73.250">     this._updateCrashReportURL(aWindow);</span>
<a href="#l73.251"></a><span id="l73.251">   },</span>
<a href="#l73.252"></a><span id="l73.252"> </span>
<a href="#l73.253"></a><span id="l73.253">   /**</span>
<a href="#l73.254"></a><span id="l73.254" class="difflineminus">-   * Called when a tabpanel sends the &quot;input&quot; notification</span>
<a href="#l73.255"></a><span id="l73.255" class="difflineplus">+   * Called when a browser sends the &quot;input&quot; notification</span>
<a href="#l73.256"></a><span id="l73.256">    * @param aWindow</span>
<a href="#l73.257"></a><span id="l73.257">    *        Window reference</span>
<a href="#l73.258"></a><span id="l73.258" class="difflineminus">-   * @param aPanel</span>
<a href="#l73.259"></a><span id="l73.259" class="difflineminus">-   *        TabPanel reference</span>
<a href="#l73.260"></a><span id="l73.260" class="difflineplus">+   * @param aBrowser</span>
<a href="#l73.261"></a><span id="l73.261" class="difflineplus">+   *        Browser reference</span>
<a href="#l73.262"></a><span id="l73.262">    */</span>
<a href="#l73.263"></a><span id="l73.263" class="difflineminus">-  onTabInput: function sss_onTabInput(aWindow, aPanel) {</span>
<a href="#l73.264"></a><span id="l73.264" class="difflineminus">-    if (aPanel.__SS_data)</span>
<a href="#l73.265"></a><span id="l73.265" class="difflineminus">-      delete aPanel.__SS_data._formDataSaved;</span>
<a href="#l73.266"></a><span id="l73.266" class="difflineplus">+  onTabInput: function sss_onTabInput(aWindow, aBrowser) {</span>
<a href="#l73.267"></a><span id="l73.267" class="difflineplus">+    if (aBrowser.__SS_data)</span>
<a href="#l73.268"></a><span id="l73.268" class="difflineplus">+      delete aBrowser.__SS_data._formDataSaved;</span>
<a href="#l73.269"></a><span id="l73.269"> </span>
<a href="#l73.270"></a><span id="l73.270">     this.saveStateDelayed(aWindow, 3000);</span>
<a href="#l73.271"></a><span id="l73.271">   },</span>
<a href="#l73.272"></a><span id="l73.272"> </span>
<a href="#l73.273"></a><span id="l73.273">   /**</span>
<a href="#l73.274"></a><span id="l73.274" class="difflineminus">-   * Called when a tabpanel sends a &quot;scroll&quot; notification</span>
<a href="#l73.275"></a><span id="l73.275" class="difflineplus">+   * Called when a browser sends a &quot;scroll&quot; notification</span>
<a href="#l73.276"></a><span id="l73.276">    * @param aWindow</span>
<a href="#l73.277"></a><span id="l73.277">    *        Window reference</span>
<a href="#l73.278"></a><span id="l73.278">    */</span>
<a href="#l73.279"></a><span id="l73.279">   onTabScroll: function sss_onTabScroll(aWindow) {</span>
<a href="#l73.280"></a><span id="l73.280">     this.saveStateDelayed(aWindow, 3000);</span>
<a href="#l73.281"></a><span id="l73.281">   },</span>
<a href="#l73.282"></a><span id="l73.282"> </span>
<a href="#l73.283"></a><span id="l73.283">   /**</span>
<a href="#l73.284"></a><span id="l73.284">    * When a tab is selected, save session data</span>
<a href="#l73.285"></a><span id="l73.285">    * @param aWindow</span>
<a href="#l73.286"></a><span id="l73.286">    *        Window reference</span>
<a href="#l73.287"></a><span id="l73.287" class="difflineminus">-   * @param aPanels</span>
<a href="#l73.288"></a><span id="l73.288" class="difflineminus">-   *        TabPanel reference</span>
<a href="#l73.289"></a><span id="l73.289">    */</span>
<a href="#l73.290"></a><span id="l73.290" class="difflineminus">-  onTabSelect: function sss_onTabSelect(aWindow, aPanels) {</span>
<a href="#l73.291"></a><span id="l73.291" class="difflineplus">+  onTabSelect: function sss_onTabSelect(aWindow) {</span>
<a href="#l73.292"></a><span id="l73.292">     if (this._loadState == STATE_RUNNING) {</span>
<a href="#l73.293"></a><span id="l73.293" class="difflineminus">-      this._windows[aWindow.__SSi].selected = aPanels.selectedIndex;</span>
<a href="#l73.294"></a><span id="l73.294" class="difflineplus">+      this._windows[aWindow.__SSi].selected = aWindow.getBrowser().tabContainer.selectedIndex;</span>
<a href="#l73.295"></a><span id="l73.295">       this.saveStateDelayed(aWindow);</span>
<a href="#l73.296"></a><span id="l73.296"> </span>
<a href="#l73.297"></a><span id="l73.297">       // attempt to update the current URL we send in a crash report</span>
<a href="#l73.298"></a><span id="l73.298">       this._updateCrashReportURL(aWindow);</span>
<a href="#l73.299"></a><span id="l73.299">     }</span>
<a href="#l73.300"></a><span id="l73.300">   },</span>
<a href="#l73.301"></a><span id="l73.301"> </span>
<a href="#l73.302"></a><span id="l73.302"> /* ........ nsISessionStore API .............. */</span>
<a href="#l73.303"></a><span id="l73.303" class="difflineat">@@ -938,43 +933,43 @@ SessionStoreService.prototype = {</span>
<a href="#l73.304"></a><span id="l73.304">    */</span>
<a href="#l73.305"></a><span id="l73.305">   _collectTabData: function sss_collectTabData(aTab, aFullData) {</span>
<a href="#l73.306"></a><span id="l73.306">     var tabData = { entries: [] };</span>
<a href="#l73.307"></a><span id="l73.307">     var browser = aTab.linkedBrowser;</span>
<a href="#l73.308"></a><span id="l73.308"> </span>
<a href="#l73.309"></a><span id="l73.309">     if (!browser || !browser.currentURI)</span>
<a href="#l73.310"></a><span id="l73.310">       // can happen when calling this function right after .addTab()</span>
<a href="#l73.311"></a><span id="l73.311">       return tabData;</span>
<a href="#l73.312"></a><span id="l73.312" class="difflineminus">-    else if (browser.parentNode.__SS_data &amp;&amp; browser.parentNode.__SS_data._tabStillLoading)</span>
<a href="#l73.313"></a><span id="l73.313" class="difflineplus">+    else if (browser.__SS_data &amp;&amp; browser.__SS_data._tabStillLoading)</span>
<a href="#l73.314"></a><span id="l73.314">       // use the data to be restored when the tab hasn't been completely loaded</span>
<a href="#l73.315"></a><span id="l73.315" class="difflineminus">-      return browser.parentNode.__SS_data;</span>
<a href="#l73.316"></a><span id="l73.316" class="difflineplus">+      return browser.__SS_data;</span>
<a href="#l73.317"></a><span id="l73.317"> </span>
<a href="#l73.318"></a><span id="l73.318">     var history = null;</span>
<a href="#l73.319"></a><span id="l73.319">     try {</span>
<a href="#l73.320"></a><span id="l73.320">       history = browser.sessionHistory;</span>
<a href="#l73.321"></a><span id="l73.321">     }</span>
<a href="#l73.322"></a><span id="l73.322">     catch (ex) { } // this could happen if we catch a tab during (de)initialization</span>
<a href="#l73.323"></a><span id="l73.323"> </span>
<a href="#l73.324"></a><span id="l73.324">     // XXXzeniko anchor navigation doesn't reset __SS_data, so we could reuse</span>
<a href="#l73.325"></a><span id="l73.325">     //           data even when we shouldn't (e.g. Back, different anchor)</span>
<a href="#l73.326"></a><span id="l73.326" class="difflineminus">-    if (history &amp;&amp; browser.parentNode.__SS_data &amp;&amp;</span>
<a href="#l73.327"></a><span id="l73.327" class="difflineminus">-        browser.parentNode.__SS_data.entries[history.index] &amp;&amp;</span>
<a href="#l73.328"></a><span id="l73.328" class="difflineplus">+    if (history &amp;&amp; browser.__SS_data &amp;&amp;</span>
<a href="#l73.329"></a><span id="l73.329" class="difflineplus">+        browser.__SS_data.entries[history.index] &amp;&amp;</span>
<a href="#l73.330"></a><span id="l73.330">         history.index &lt; this._sessionhistory_max_entries - 1 &amp;&amp; !aFullData) {</span>
<a href="#l73.331"></a><span id="l73.331" class="difflineminus">-      tabData = browser.parentNode.__SS_data;</span>
<a href="#l73.332"></a><span id="l73.332" class="difflineplus">+      tabData = browser.__SS_data;</span>
<a href="#l73.333"></a><span id="l73.333">       tabData.index = history.index + 1;</span>
<a href="#l73.334"></a><span id="l73.334">     }</span>
<a href="#l73.335"></a><span id="l73.335">     else if (history &amp;&amp; history.count &gt; 0) {</span>
<a href="#l73.336"></a><span id="l73.336">       for (var j = 0; j &lt; history.count; j++)</span>
<a href="#l73.337"></a><span id="l73.337">         tabData.entries.push(this._serializeHistoryEntry(history.getEntryAtIndex(j, false),</span>
<a href="#l73.338"></a><span id="l73.338">                                                          aFullData));</span>
<a href="#l73.339"></a><span id="l73.339">       tabData.index = history.index + 1;</span>
<a href="#l73.340"></a><span id="l73.340"> </span>
<a href="#l73.341"></a><span id="l73.341">       // make sure not to cache privacy sensitive data which shouldn't get out</span>
<a href="#l73.342"></a><span id="l73.342">       if (!aFullData)</span>
<a href="#l73.343"></a><span id="l73.343" class="difflineminus">-        browser.parentNode.__SS_data = tabData;</span>
<a href="#l73.344"></a><span id="l73.344" class="difflineplus">+        browser.__SS_data = tabData;</span>
<a href="#l73.345"></a><span id="l73.345">     }</span>
<a href="#l73.346"></a><span id="l73.346">     else if (browser.currentURI.spec != &quot;about:blank&quot; ||</span>
<a href="#l73.347"></a><span id="l73.347">              browser.contentDocument.body.hasChildNodes()) {</span>
<a href="#l73.348"></a><span id="l73.348">       tabData.entries[0] = { url: browser.currentURI.spec };</span>
<a href="#l73.349"></a><span id="l73.349">       tabData.index = 1;</span>
<a href="#l73.350"></a><span id="l73.350">     }</span>
<a href="#l73.351"></a><span id="l73.351"> </span>
<a href="#l73.352"></a><span id="l73.352">     var disallow = [];</span>
<a href="#l73.353"></a><span id="l73.353" class="difflineat">@@ -1179,18 +1174,18 @@ SessionStoreService.prototype = {</span>
<a href="#l73.354"></a><span id="l73.354">    * @param aWindow</span>
<a href="#l73.355"></a><span id="l73.355">    *        Window reference</span>
<a href="#l73.356"></a><span id="l73.356">    */</span>
<a href="#l73.357"></a><span id="l73.357">   _updateTextAndScrollData: function sss_updateTextAndScrollData(aWindow) {</span>
<a href="#l73.358"></a><span id="l73.358">     var browsers = aWindow.getBrowser().browsers;</span>
<a href="#l73.359"></a><span id="l73.359">     for (var i = 0; i &lt; browsers.length; i++) {</span>
<a href="#l73.360"></a><span id="l73.360">       try {</span>
<a href="#l73.361"></a><span id="l73.361">         var tabData = this._windows[aWindow.__SSi].tabs[i];</span>
<a href="#l73.362"></a><span id="l73.362" class="difflineminus">-        if (browsers[i].parentNode.__SS_data &amp;&amp;</span>
<a href="#l73.363"></a><span id="l73.363" class="difflineminus">-            browsers[i].parentNode.__SS_data._tabStillLoading)</span>
<a href="#l73.364"></a><span id="l73.364" class="difflineplus">+        if (browsers[i].__SS_data &amp;&amp;</span>
<a href="#l73.365"></a><span id="l73.365" class="difflineplus">+            browsers[i].__SS_data._tabStillLoading)</span>
<a href="#l73.366"></a><span id="l73.366">           continue; // ignore incompletely initialized tabs</span>
<a href="#l73.367"></a><span id="l73.367">         this._updateTextAndScrollDataForTab(aWindow, browsers[i], tabData);</span>
<a href="#l73.368"></a><span id="l73.368">       }</span>
<a href="#l73.369"></a><span id="l73.369">       catch (ex) { debug(ex); } // get as much data as possible, ignore failures (might succeed the next time)</span>
<a href="#l73.370"></a><span id="l73.370">     }</span>
<a href="#l73.371"></a><span id="l73.371">   },</span>
<a href="#l73.372"></a><span id="l73.372"> </span>
<a href="#l73.373"></a><span id="l73.373">   /**</span>
<a href="#l73.374"></a><span id="l73.374" class="difflineat">@@ -1728,17 +1723,17 @@ SessionStoreService.prototype = {</span>
<a href="#l73.375"></a><span id="l73.375">       // wall-paper fix for bug 439675: make sure that the URL to be loaded</span>
<a href="#l73.376"></a><span id="l73.376">       // is always visible in the address bar</span>
<a href="#l73.377"></a><span id="l73.377">       let activeIndex = (aTabData[t].index || aTabData[t].entries.length) - 1;</span>
<a href="#l73.378"></a><span id="l73.378">       let activePageData = aTabData[t].entries[activeIndex] || null;</span>
<a href="#l73.379"></a><span id="l73.379">       browser.userTypedValue = activePageData ? activePageData.url || null : null;</span>
<a href="#l73.380"></a><span id="l73.380"> </span>
<a href="#l73.381"></a><span id="l73.381">       // keep the data around to prevent dataloss in case</span>
<a href="#l73.382"></a><span id="l73.382">       // a tab gets closed before it's been properly restored</span>
<a href="#l73.383"></a><span id="l73.383" class="difflineminus">-      browser.parentNode.__SS_data = aTabData[t];</span>
<a href="#l73.384"></a><span id="l73.384" class="difflineplus">+      browser.__SS_data = aTabData[t];</span>
<a href="#l73.385"></a><span id="l73.385">     }</span>
<a href="#l73.386"></a><span id="l73.386"> </span>
<a href="#l73.387"></a><span id="l73.387">     // make sure to restore the selected tab first (if any)</span>
<a href="#l73.388"></a><span id="l73.388">     if (aSelectTab-- &amp;&amp; aTabs[aSelectTab]) {</span>
<a href="#l73.389"></a><span id="l73.389">         aTabs.unshift(aTabs.splice(aSelectTab, 1)[0]);</span>
<a href="#l73.390"></a><span id="l73.390">         aTabData.unshift(aTabData.splice(aSelectTab, 1)[0]);</span>
<a href="#l73.391"></a><span id="l73.391">         tabbrowser.selectedTab = aTabs[0];</span>
<a href="#l73.392"></a><span id="l73.392">     }</span>
<a href="#l73.393"></a><span id="l73.393" class="difflineat">@@ -2135,17 +2130,17 @@ SessionStoreService.prototype = {</span>
<a href="#l73.394"></a><span id="l73.394">       }</span>
<a href="#l73.395"></a><span id="l73.395">     }</span>
<a href="#l73.396"></a><span id="l73.396">     var sidebar = aWindow.document.getElementById(&quot;sidebar-box&quot;);</span>
<a href="#l73.397"></a><span id="l73.397">     if (sidebar.getAttribute(&quot;sidebarcommand&quot;) != aSidebar) {</span>
<a href="#l73.398"></a><span id="l73.398">       aWindow.toggleSidebar(aSidebar);</span>
<a href="#l73.399"></a><span id="l73.399">     }</span>
<a href="#l73.400"></a><span id="l73.400">     // since resizing/moving a window brings it to the foreground,</span>
<a href="#l73.401"></a><span id="l73.401">     // we might want to re-focus the last focused window</span>
<a href="#l73.402"></a><span id="l73.402" class="difflineminus">-    if (this.windowToFocus) {</span>
<a href="#l73.403"></a><span id="l73.403" class="difflineplus">+    if (this.windowToFocus &amp;&amp; this.windowToFocus.content) {</span>
<a href="#l73.404"></a><span id="l73.404">       this.windowToFocus.content.focus();</span>
<a href="#l73.405"></a><span id="l73.405">     }</span>
<a href="#l73.406"></a><span id="l73.406">   },</span>
<a href="#l73.407"></a><span id="l73.407"> </span>
<a href="#l73.408"></a><span id="l73.408">   /**</span>
<a href="#l73.409"></a><span id="l73.409">    * Restores cookies (accepting both Firefox 2.0 and current format)</span>
<a href="#l73.410"></a><span id="l73.410">    * @param aCookies</span>
<a href="#l73.411"></a><span id="l73.411">    *        Array of cookie objects</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/suite/mailnews/search/FilterListDialog.js</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/suite/mailnews/search/FilterListDialog.js</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -178,32 +178,34 @@ function onLoad()</span>
<a href="#l74.4"></a><span id="l74.4">     gReorderUpButton = document.getElementById(&quot;reorderUpButton&quot;);</span>
<a href="#l74.5"></a><span id="l74.5">     gReorderDownButton = document.getElementById(&quot;reorderDownButton&quot;);</span>
<a href="#l74.6"></a><span id="l74.6">     gRunFiltersFolderPickerLabel = document.getElementById(&quot;folderPickerPrefix&quot;);</span>
<a href="#l74.7"></a><span id="l74.7">     gRunFiltersFolderPicker = document.getElementById(&quot;runFiltersFolder&quot;);</span>
<a href="#l74.8"></a><span id="l74.8">     gRunFiltersButton = document.getElementById(&quot;runFiltersButton&quot;);</span>
<a href="#l74.9"></a><span id="l74.9">     gStatusBar = document.getElementById(&quot;statusbar-icon&quot;);</span>
<a href="#l74.10"></a><span id="l74.10">     gStatusText = document.getElementById(&quot;statusText&quot;);</span>
<a href="#l74.11"></a><span id="l74.11"> </span>
<a href="#l74.12"></a><span id="l74.12" class="difflineminus">-    updateButtons();</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineplus">+    gFilterTree.view = gFilterTreeView;</span>
<a href="#l74.14"></a><span id="l74.14"> </span>
<a href="#l74.15"></a><span id="l74.15">     // get the selected server if it can have filters.</span>
<a href="#l74.16"></a><span id="l74.16">     var firstItem = getSelectedServerForFilters();</span>
<a href="#l74.17"></a><span id="l74.17"> </span>
<a href="#l74.18"></a><span id="l74.18">     // if the selected server cannot have filters, get the default server</span>
<a href="#l74.19"></a><span id="l74.19">     // if the default server cannot have filters, check all accounts</span>
<a href="#l74.20"></a><span id="l74.20">     // and get a server that can have filters.</span>
<a href="#l74.21"></a><span id="l74.21">     if (!firstItem)</span>
<a href="#l74.22"></a><span id="l74.22" class="difflineminus">-        firstItem = getServerThatCanHaveFilters();</span>
<a href="#l74.23"></a><span id="l74.23" class="difflineplus">+      firstItem = getServerThatCanHaveFilters();</span>
<a href="#l74.24"></a><span id="l74.24"> </span>
<a href="#l74.25"></a><span id="l74.25" class="difflineminus">-    if (firstItem) {</span>
<a href="#l74.26"></a><span id="l74.26" class="difflineminus">-        selectServer(firstItem);</span>
<a href="#l74.27"></a><span id="l74.27" class="difflineminus">-    }</span>
<a href="#l74.28"></a><span id="l74.28" class="difflineplus">+    if (firstItem)</span>
<a href="#l74.29"></a><span id="l74.29" class="difflineplus">+      selectServer(firstItem);</span>
<a href="#l74.30"></a><span id="l74.30" class="difflineplus">+    else</span>
<a href="#l74.31"></a><span id="l74.31" class="difflineplus">+      updateButtons();</span>
<a href="#l74.32"></a><span id="l74.32"> </span>
<a href="#l74.33"></a><span id="l74.33" class="difflineminus">-    gFilterTree.view = gFilterTreeView;</span>
<a href="#l74.34"></a><span id="l74.34" class="difflineplus">+    // Focus the list.</span>
<a href="#l74.35"></a><span id="l74.35" class="difflineplus">+    gFilterTree.focus();</span>
<a href="#l74.36"></a><span id="l74.36"> </span>
<a href="#l74.37"></a><span id="l74.37">     window.tryToClose = onFilterClose;</span>
<a href="#l74.38"></a><span id="l74.38"> }</span>
<a href="#l74.39"></a><span id="l74.39"> </span>
<a href="#l74.40"></a><span id="l74.40"> /*</span>
<a href="#l74.41"></a><span id="l74.41"> function onCancel()</span>
<a href="#l74.42"></a><span id="l74.42"> {</span>
<a href="#l74.43"></a><span id="l74.43">     var firstItem = getSelectedServerForFilters();</span>
<a href="#l74.44"></a><span id="l74.44" class="difflineat">@@ -268,16 +270,20 @@ function setServer(uri)</span>
<a href="#l74.45"></a><span id="l74.45">      return;</span>
<a href="#l74.46"></a><span id="l74.46"> </span>
<a href="#l74.47"></a><span id="l74.47">    var resource = gRDF.GetResource(uri);</span>
<a href="#l74.48"></a><span id="l74.48">    var msgFolder = resource.QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l74.49"></a><span id="l74.49"> </span>
<a href="#l74.50"></a><span id="l74.50">    //Calling getFilterList will detect any errors in rules.dat, backup the file, and alert the user</span>
<a href="#l74.51"></a><span id="l74.51">    gFilterTreeView.filterList = msgFolder.getEditableFilterList(gFilterListMsgWindow);</span>
<a href="#l74.52"></a><span id="l74.52"> </span>
<a href="#l74.53"></a><span id="l74.53" class="difflineplus">+   // Select the first item in the list, if there is one.</span>
<a href="#l74.54"></a><span id="l74.54" class="difflineplus">+   if (gFilterTreeView.rowCount)</span>
<a href="#l74.55"></a><span id="l74.55" class="difflineplus">+     gFilterTreeView.selection.select(0);</span>
<a href="#l74.56"></a><span id="l74.56" class="difflineplus">+</span>
<a href="#l74.57"></a><span id="l74.57">    // this will get the deferred to account root folder, if server is deferred</span>
<a href="#l74.58"></a><span id="l74.58">    msgFolder = msgFolder.server.rootMsgFolder;</span>
<a href="#l74.59"></a><span id="l74.59">    var rootFolderUri = msgFolder.URI;</span>
<a href="#l74.60"></a><span id="l74.60"> </span>
<a href="#l74.61"></a><span id="l74.61">    // root the folder picker to this server</span>
<a href="#l74.62"></a><span id="l74.62">    gRunFiltersFolderPicker.setAttribute(&quot;ref&quot;, rootFolderUri);</span>
<a href="#l74.63"></a><span id="l74.63">  </span>
<a href="#l74.64"></a><span id="l74.64">    // run filters after the fact not supported by news</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1" class="difflineminus">--- a/suite/mailnews/tabmail.xml</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineplus">+++ b/suite/mailnews/tabmail.xml</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineat">@@ -607,18 +607,19 @@</span>
<a href="#l75.4"></a><span id="l75.4">             let closeFunc = tabInfo.mode.closeTab ||</span>
<a href="#l75.5"></a><span id="l75.5">                             tabInfo.mode.tabType.closeTab;</span>
<a href="#l75.6"></a><span id="l75.6">             if (closeFunc)</span>
<a href="#l75.7"></a><span id="l75.7">               closeFunc.call(tabInfo.mode.tabType, tabInfo);</span>
<a href="#l75.8"></a><span id="l75.8"> </span>
<a href="#l75.9"></a><span id="l75.9">             this.tabInfo.splice(iTab, 1);</span>
<a href="#l75.10"></a><span id="l75.10">             tabInfo.mode.tabs.splice(tabInfo.mode.tabs.indexOf(tabInfo), 1);</span>
<a href="#l75.11"></a><span id="l75.11">             this.tabContainer.removeChild(aTabNode);</span>
<a href="#l75.12"></a><span id="l75.12" class="difflineplus">+            --numTabs;</span>
<a href="#l75.13"></a><span id="l75.13">             if (this.tabContainer.selectedIndex == -1)</span>
<a href="#l75.14"></a><span id="l75.14" class="difflineminus">-              this.tabContainer.selectedIndex = (iTab == --numTabs) ? iTab - 1 : iTab;</span>
<a href="#l75.15"></a><span id="l75.15" class="difflineplus">+              this.tabContainer.selectedIndex = (iTab == numTabs) ? iTab - 1 : iTab;</span>
<a href="#l75.16"></a><span id="l75.16">             if (this.currentTabInfo == tabInfo)</span>
<a href="#l75.17"></a><span id="l75.17">               this.updateCurrentTab();</span>
<a href="#l75.18"></a><span id="l75.18"> </span>
<a href="#l75.19"></a><span id="l75.19">             if (tabInfo.panel)</span>
<a href="#l75.20"></a><span id="l75.20">             {</span>
<a href="#l75.21"></a><span id="l75.21">               this.panelContainer.removeChild(tabInfo.panel);</span>
<a href="#l75.22"></a><span id="l75.22">               delete tabInfo.panel;</span>
<a href="#l75.23"></a><span id="l75.23">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/suite/smile/test/browser_Browser.js</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/suite/smile/test/browser_Browser.js</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -1,79 +1,88 @@</span>
<a href="#l76.4"></a><span id="l76.4" class="difflineminus">-const Ci = Components.interfaces;</span>
<a href="#l76.5"></a><span id="l76.5" class="difflineminus">-const Cc = Components.classes;</span>
<a href="#l76.6"></a><span id="l76.6" class="difflineminus">-</span>
<a href="#l76.7"></a><span id="l76.7" class="difflineminus">-function url(spec) {</span>
<a href="#l76.8"></a><span id="l76.8" class="difflineminus">-  var ios = Cc[&quot;@mozilla.org/network/io-service;1&quot;].getService(Ci.nsIIOService);</span>
<a href="#l76.9"></a><span id="l76.9" class="difflineminus">-  return ios.newURI(spec, null, null);</span>
<a href="#l76.10"></a><span id="l76.10" class="difflineminus">-}</span>
<a href="#l76.11"></a><span id="l76.11" class="difflineminus">-</span>
<a href="#l76.12"></a><span id="l76.12"> var gPageA = null;</span>
<a href="#l76.13"></a><span id="l76.13"> var gPageB = null;</span>
<a href="#l76.14"></a><span id="l76.14"> </span>
<a href="#l76.15"></a><span id="l76.15"> // cached data from events</span>
<a href="#l76.16"></a><span id="l76.16"> var gTabOpenPageA = null;</span>
<a href="#l76.17"></a><span id="l76.17"> var gTabOpenPageB = null;</span>
<a href="#l76.18"></a><span id="l76.18"> var gTabOpenCount = 0;</span>
<a href="#l76.19"></a><span id="l76.19"> var gTabCloseCount = 0;</span>
<a href="#l76.20"></a><span id="l76.20"> var gTabMoveCount = 0;</span>
<a href="#l76.21"></a><span id="l76.21"> var gPageLoadCount = 0;</span>
<a href="#l76.22"></a><span id="l76.22"> </span>
<a href="#l76.23"></a><span id="l76.23"> function test() {</span>
<a href="#l76.24"></a><span id="l76.24" class="difflineplus">+  waitForExplicitFinish();</span>
<a href="#l76.25"></a><span id="l76.25" class="difflineplus">+</span>
<a href="#l76.26"></a><span id="l76.26" class="difflineplus">+  // nsIFocusManager is not available on MOZILLA_1_9_1</span>
<a href="#l76.27"></a><span id="l76.27" class="difflineplus">+  if (&quot;nsIFocusManager&quot; in Ci) {</span>
<a href="#l76.28"></a><span id="l76.28" class="difflineplus">+    if (Cc[&quot;@mozilla.org/focus-manager;1&quot;].getService(Ci.nsIFocusManager)</span>
<a href="#l76.29"></a><span id="l76.29" class="difflineplus">+                                          .activeWindow != window) {</span>
<a href="#l76.30"></a><span id="l76.30" class="difflineplus">+      setTimeout(test, 0);</span>
<a href="#l76.31"></a><span id="l76.31" class="difflineplus">+      window.focus();</span>
<a href="#l76.32"></a><span id="l76.32" class="difflineplus">+      return;</span>
<a href="#l76.33"></a><span id="l76.33" class="difflineplus">+    }</span>
<a href="#l76.34"></a><span id="l76.34" class="difflineplus">+  } else if (!document.hasFocus()) {</span>
<a href="#l76.35"></a><span id="l76.35" class="difflineplus">+    setTimeout(test, 0);</span>
<a href="#l76.36"></a><span id="l76.36" class="difflineplus">+    window.focus();</span>
<a href="#l76.37"></a><span id="l76.37" class="difflineplus">+    return;</span>
<a href="#l76.38"></a><span id="l76.38" class="difflineplus">+  }</span>
<a href="#l76.39"></a><span id="l76.39" class="difflineplus">+</span>
<a href="#l76.40"></a><span id="l76.40">   var windows = Application.windows;</span>
<a href="#l76.41"></a><span id="l76.41">   ok(windows, &quot;Check access to browser windows&quot;);</span>
<a href="#l76.42"></a><span id="l76.42" class="difflineminus">-  ok(windows.length, &quot;There should be at least one browser window open&quot;);</span>
<a href="#l76.43"></a><span id="l76.43" class="difflineplus">+  is(windows.length, 1, &quot;There should be one browser window open&quot;);</span>
<a href="#l76.44"></a><span id="l76.44"> </span>
<a href="#l76.45"></a><span id="l76.45">   var activeWin = Application.activeWindow;</span>
<a href="#l76.46"></a><span id="l76.46">   activeWin.events.addListener(&quot;TabOpen&quot;, onTabOpen);</span>
<a href="#l76.47"></a><span id="l76.47">   activeWin.events.addListener(&quot;TabClose&quot;, onTabClose);</span>
<a href="#l76.48"></a><span id="l76.48">   activeWin.events.addListener(&quot;TabMove&quot;, onTabMove);</span>
<a href="#l76.49"></a><span id="l76.49"> </span>
<a href="#l76.50"></a><span id="l76.50" class="difflineminus">-  gPageA = activeWin.open(url(&quot;chrome://mochikit/content/browser/suite/smile/test/ContentA.html&quot;));</span>
<a href="#l76.51"></a><span id="l76.51" class="difflineplus">+  gPageA = activeWin.open(makeURI(&quot;chrome://mochikit/content/browser/suite/smile/test/ContentA.html&quot;));</span>
<a href="#l76.52"></a><span id="l76.52">   gPageA.events.addListener(&quot;load&quot;, onPageAFirstLoad);</span>
<a href="#l76.53"></a><span id="l76.53"> </span>
<a href="#l76.54"></a><span id="l76.54">   is(activeWin.tabs.length, 2, &quot;Checking length of 'Browser.tabs' after opening 1 additional tab&quot;);</span>
<a href="#l76.55"></a><span id="l76.55"> </span>
<a href="#l76.56"></a><span id="l76.56" class="difflineminus">-  waitForExplicitFinish();</span>
<a href="#l76.57"></a><span id="l76.57" class="difflineminus">-</span>
<a href="#l76.58"></a><span id="l76.58" class="difflineminus">-  function execAfterOpen() {</span>
<a href="#l76.59"></a><span id="l76.59" class="difflineminus">-    executeSoon(afterOpen);</span>
<a href="#l76.60"></a><span id="l76.60" class="difflineminus">-  }</span>
<a href="#l76.61"></a><span id="l76.61" class="difflineminus">-</span>
<a href="#l76.62"></a><span id="l76.62">   function onPageAFirstLoad(event) {</span>
<a href="#l76.63"></a><span id="l76.63">     gPageA.events.removeListener(&quot;load&quot;, onPageAFirstLoad);</span>
<a href="#l76.64"></a><span id="l76.64">     is(gPageA.uri.spec, event.data.uri.spec, &quot;Checking event browser tab is equal to page A&quot;);</span>
<a href="#l76.65"></a><span id="l76.65"> </span>
<a href="#l76.66"></a><span id="l76.66" class="difflineminus">-    gPageB = activeWin.open(url(&quot;chrome://mochikit/content/browser/suite/smile/test/ContentB.html&quot;));</span>
<a href="#l76.67"></a><span id="l76.67" class="difflineminus">-    gPageB.events.addListener(&quot;load&quot;, execAfterOpen);</span>
<a href="#l76.68"></a><span id="l76.68" class="difflineplus">+    gPageB = activeWin.open(makeURI(&quot;chrome://mochikit/content/browser/suite/smile/test/ContentB.html&quot;));</span>
<a href="#l76.69"></a><span id="l76.69" class="difflineplus">+    gPageB.events.addListener(&quot;load&quot;, delayAfterOpen);</span>
<a href="#l76.70"></a><span id="l76.70">     gPageB.focus();</span>
<a href="#l76.71"></a><span id="l76.71"> </span>
<a href="#l76.72"></a><span id="l76.72">     is(activeWin.tabs.length, 3, &quot;Checking length of 'Browser.tabs' after opening a second additional tab&quot;);</span>
<a href="#l76.73"></a><span id="l76.73">     is(activeWin.activeTab.index, gPageB.index, &quot;Checking 'Browser.activeTab' after setting focus&quot;);</span>
<a href="#l76.74"></a><span id="l76.74">   }</span>
<a href="#l76.75"></a><span id="l76.75"> </span>
<a href="#l76.76"></a><span id="l76.76" class="difflineplus">+  function delayAfterOpen() {</span>
<a href="#l76.77"></a><span id="l76.77" class="difflineplus">+    executeSoon(afterOpen);</span>
<a href="#l76.78"></a><span id="l76.78" class="difflineplus">+  }</span>
<a href="#l76.79"></a><span id="l76.79" class="difflineplus">+</span>
<a href="#l76.80"></a><span id="l76.80">   // need to wait for the url's to be refreshed during the load</span>
<a href="#l76.81"></a><span id="l76.81">   function afterOpen(event) {</span>
<a href="#l76.82"></a><span id="l76.82" class="difflineminus">-    gPageB.events.removeListener(&quot;load&quot;, execAfterOpen);</span>
<a href="#l76.83"></a><span id="l76.83" class="difflineplus">+    gPageB.events.removeListener(&quot;load&quot;, delayAfterOpen);</span>
<a href="#l76.84"></a><span id="l76.84">     // check actuals</span>
<a href="#l76.85"></a><span id="l76.85">     is(gPageA.uri.spec, &quot;chrome://mochikit/content/browser/suite/smile/test/ContentA.html&quot;, &quot;Checking 'BrowserTab.uri' after opening&quot;);</span>
<a href="#l76.86"></a><span id="l76.86">     is(gPageB.uri.spec, &quot;chrome://mochikit/content/browser/suite/smile/test/ContentB.html&quot;, &quot;Checking 'BrowserTab.uri' after opening&quot;);</span>
<a href="#l76.87"></a><span id="l76.87"> </span>
<a href="#l76.88"></a><span id="l76.88">     // check cached values from TabOpen event</span>
<a href="#l76.89"></a><span id="l76.89">     is(gPageA.uri.spec, gTabOpenPageA.uri.spec, &quot;Checking first browser tab open is equal to page A&quot;);</span>
<a href="#l76.90"></a><span id="l76.90">     is(gPageB.uri.spec, gTabOpenPageB.uri.spec, &quot;Checking second browser tab open is equal to page B&quot;);</span>
<a href="#l76.91"></a><span id="l76.91">     // check event</span>
<a href="#l76.92"></a><span id="l76.92">     is(gTabOpenCount, 2, &quot;Checking event handler for tab open&quot;);</span>
<a href="#l76.93"></a><span id="l76.93"> </span>
<a href="#l76.94"></a><span id="l76.94">     // test document access</span>
<a href="#l76.95"></a><span id="l76.95">     var test1 = gPageA.document.getElementById(&quot;test1&quot;);</span>
<a href="#l76.96"></a><span id="l76.96">     ok(test1, &quot;Checking existence of element in content DOM&quot;);</span>
<a href="#l76.97"></a><span id="l76.97">     is(test1.innerHTML, &quot;A&quot;, &quot;Checking content of element in content DOM&quot;);</span>
<a href="#l76.98"></a><span id="l76.98"> </span>
<a href="#l76.99"></a><span id="l76.99">     // test moving tab</span>
<a href="#l76.100"></a><span id="l76.100" class="difflineplus">+    is(gTabMoveCount, 0, &quot;Checking initial tab move count&quot;);</span>
<a href="#l76.101"></a><span id="l76.101" class="difflineplus">+</span>
<a href="#l76.102"></a><span id="l76.102" class="difflineplus">+    // move the tab</span>
<a href="#l76.103"></a><span id="l76.103">     gPageA.moveToEnd();</span>
<a href="#l76.104"></a><span id="l76.104">     is(gPageA.index, 2, &quot;Checking index after moving tab&quot;);</span>
<a href="#l76.105"></a><span id="l76.105"> </span>
<a href="#l76.106"></a><span id="l76.106">     // check event</span>
<a href="#l76.107"></a><span id="l76.107">     is(gTabMoveCount, 1, &quot;Checking event handler for tab move&quot;);</span>
<a href="#l76.108"></a><span id="l76.108"> </span>
<a href="#l76.109"></a><span id="l76.109">     let browser = gBrowser.getBrowserAtIndex(gPageB.index);</span>
<a href="#l76.110"></a><span id="l76.110">     browser.addProgressListener({</span>
<a href="#l76.111"></a><span id="l76.111" class="difflineat">@@ -97,34 +106,34 @@ function test() {</span>
<a href="#l76.112"></a><span id="l76.112">            iid.equals(Ci.nsISupports))</span>
<a href="#l76.113"></a><span id="l76.113">            return this;</span>
<a href="#l76.114"></a><span id="l76.114"> </span>
<a href="#l76.115"></a><span id="l76.115">         throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l76.116"></a><span id="l76.116">       }</span>
<a href="#l76.117"></a><span id="l76.117">     });</span>
<a href="#l76.118"></a><span id="l76.118"> </span>
<a href="#l76.119"></a><span id="l76.119">     // test loading new content with a frame into a tab</span>
<a href="#l76.120"></a><span id="l76.120" class="difflineminus">-    // the event will be checked in afterClose</span>
<a href="#l76.121"></a><span id="l76.121" class="difflineplus">+    // the event will be checked in onPageBLoadComplete</span>
<a href="#l76.122"></a><span id="l76.122">     gPageB.events.addListener(&quot;load&quot;, onPageBLoadWithFrames);</span>
<a href="#l76.123"></a><span id="l76.123" class="difflineminus">-    gPageB.load(url(&quot;chrome://mochikit/content/browser/suite/smile/test/ContentWithFrames.html&quot;));</span>
<a href="#l76.124"></a><span id="l76.124" class="difflineplus">+    gPageB.load(makeURI(&quot;chrome://mochikit/content/browser/suite/smile/test/ContentWithFrames.html&quot;));</span>
<a href="#l76.125"></a><span id="l76.125">   }</span>
<a href="#l76.126"></a><span id="l76.126"> </span>
<a href="#l76.127"></a><span id="l76.127">   function onPageBLoadWithFrames(event) {</span>
<a href="#l76.128"></a><span id="l76.128">     gPageLoadCount++;</span>
<a href="#l76.129"></a><span id="l76.129">   }</span>
<a href="#l76.130"></a><span id="l76.130"> </span>
<a href="#l76.131"></a><span id="l76.131">   function onPageBLoadComplete() {</span>
<a href="#l76.132"></a><span id="l76.132">     gPageB.events.removeListener(&quot;load&quot;, onPageBLoadWithFrames);</span>
<a href="#l76.133"></a><span id="l76.133">     // check page load with frame event</span>
<a href="#l76.134"></a><span id="l76.134">     is(gPageLoadCount, 1, &quot;Checking load count after loading new content with a frame&quot;);</span>
<a href="#l76.135"></a><span id="l76.135"> </span>
<a href="#l76.136"></a><span id="l76.136">     // test loading new content into a tab</span>
<a href="#l76.137"></a><span id="l76.137" class="difflineminus">-    // the event will be checked in onPageLoad</span>
<a href="#l76.138"></a><span id="l76.138" class="difflineplus">+    // the event will be checked in onPageASecondLoad</span>
<a href="#l76.139"></a><span id="l76.139">     gPageA.events.addListener(&quot;load&quot;, onPageASecondLoad);</span>
<a href="#l76.140"></a><span id="l76.140" class="difflineminus">-    gPageA.load(url(&quot;chrome://mochikit/content/browser/suite/smile/test/ContentB.html&quot;));</span>
<a href="#l76.141"></a><span id="l76.141" class="difflineplus">+    gPageA.load(makeURI(&quot;chrome://mochikit/content/browser/suite/smile/test/ContentB.html&quot;));</span>
<a href="#l76.142"></a><span id="l76.142">   }</span>
<a href="#l76.143"></a><span id="l76.143"> </span>
<a href="#l76.144"></a><span id="l76.144">   function onPageASecondLoad(event) {</span>
<a href="#l76.145"></a><span id="l76.145">     gPageA.events.removeListener(&quot;load&quot;, onPageASecondLoad);</span>
<a href="#l76.146"></a><span id="l76.146">     is(gPageA.uri.spec, &quot;chrome://mochikit/content/browser/suite/smile/test/ContentB.html&quot;, &quot;Checking 'BrowserTab.uri' after loading new content&quot;);</span>
<a href="#l76.147"></a><span id="l76.147"> </span>
<a href="#l76.148"></a><span id="l76.148">     // start testing closing tabs</span>
<a href="#l76.149"></a><span id="l76.149">     // the event will be checked in afterClose</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/suite/themes/classic/communicator/preferences.css</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/suite/themes/classic/communicator/preferences.css</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -42,38 +42,8 @@</span>
<a href="#l77.4"></a><span id="l77.4"> /* ::::: Main Window ::::: */</span>
<a href="#l77.5"></a><span id="l77.5"> </span>
<a href="#l77.6"></a><span id="l77.6"> prefwindow {</span>
<a href="#l77.7"></a><span id="l77.7">   padding-top: 8px;</span>
<a href="#l77.8"></a><span id="l77.8">   padding-bottom: 0px;</span>
<a href="#l77.9"></a><span id="l77.9">   -moz-padding-start: 8px;</span>
<a href="#l77.10"></a><span id="l77.10">   -moz-padding-end: 10px;</span>
<a href="#l77.11"></a><span id="l77.11"> }</span>
<a href="#l77.12"></a><span id="l77.12" class="difflineminus">-</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineminus">-/* File Field Widget */</span>
<a href="#l77.14"></a><span id="l77.14" class="difflineminus">-filefield {</span>
<a href="#l77.15"></a><span id="l77.15" class="difflineminus">-  margin: 2px 4px;</span>
<a href="#l77.16"></a><span id="l77.16" class="difflineminus">-  -moz-appearance: textfield;</span>
<a href="#l77.17"></a><span id="l77.17" class="difflineminus">-}</span>
<a href="#l77.18"></a><span id="l77.18" class="difflineminus">-</span>
<a href="#l77.19"></a><span id="l77.19" class="difflineminus">-.fileFieldContentBox {</span>
<a href="#l77.20"></a><span id="l77.20" class="difflineminus">-  background-color: -moz-Dialog;</span>
<a href="#l77.21"></a><span id="l77.21" class="difflineminus">-}</span>
<a href="#l77.22"></a><span id="l77.22" class="difflineminus">-</span>
<a href="#l77.23"></a><span id="l77.23" class="difflineminus">-.fileFieldIcon[disabled=&quot;true&quot;] {</span>
<a href="#l77.24"></a><span id="l77.24" class="difflineminus">-  opacity: 0.4;</span>
<a href="#l77.25"></a><span id="l77.25" class="difflineminus">-}</span>
<a href="#l77.26"></a><span id="l77.26" class="difflineminus">-</span>
<a href="#l77.27"></a><span id="l77.27" class="difflineminus">-.fileFieldIcon {</span>
<a href="#l77.28"></a><span id="l77.28" class="difflineminus">-  width: 16px;</span>
<a href="#l77.29"></a><span id="l77.29" class="difflineminus">-  height: 16px;</span>
<a href="#l77.30"></a><span id="l77.30" class="difflineminus">-  margin-top: 1px;</span>
<a href="#l77.31"></a><span id="l77.31" class="difflineminus">-  margin-bottom: 1px;</span>
<a href="#l77.32"></a><span id="l77.32" class="difflineminus">-  -moz-margin-start: 1px;</span>
<a href="#l77.33"></a><span id="l77.33" class="difflineminus">-  -moz-margin-end: 4px;</span>
<a href="#l77.34"></a><span id="l77.34" class="difflineminus">-}</span>
<a href="#l77.35"></a><span id="l77.35" class="difflineminus">-</span>
<a href="#l77.36"></a><span id="l77.36" class="difflineminus">-.fileFieldLabel {</span>
<a href="#l77.37"></a><span id="l77.37" class="difflineminus">-  -moz-appearance: none;</span>
<a href="#l77.38"></a><span id="l77.38" class="difflineminus">-  background-color: transparent;</span>
<a href="#l77.39"></a><span id="l77.39" class="difflineminus">-  border: none;</span>
<a href="#l77.40"></a><span id="l77.40" class="difflineminus">-  margin: 0px;</span>
<a href="#l77.41"></a><span id="l77.41" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1" class="difflineminus">--- a/suite/themes/classic/mac/communicator/button.css</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineplus">+++ b/suite/themes/classic/mac/communicator/button.css</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineat">@@ -44,16 +44,21 @@</span>
<a href="#l78.4"></a><span id="l78.4"> </span>
<a href="#l78.5"></a><span id="l78.5"> /* ::::: large toolbar buttons ::::: */</span>
<a href="#l78.6"></a><span id="l78.6"> </span>
<a href="#l78.7"></a><span id="l78.7"> .toolbarbutton-1,</span>
<a href="#l78.8"></a><span id="l78.8"> .toolbarbutton-1 &gt; .toolbarbutton-menubutton-button {</span>
<a href="#l78.9"></a><span id="l78.9">   -moz-box-orient: vertical;</span>
<a href="#l78.10"></a><span id="l78.10"> }</span>
<a href="#l78.11"></a><span id="l78.11"> </span>
<a href="#l78.12"></a><span id="l78.12" class="difflineplus">+.toolbarbutton-1[open],</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineplus">+.toolbarbutton-1[open] &gt; .toolbarbutton-menubutton-button {</span>
<a href="#l78.14"></a><span id="l78.14" class="difflineplus">+  text-shadow: none;</span>
<a href="#l78.15"></a><span id="l78.15" class="difflineplus">+}</span>
<a href="#l78.16"></a><span id="l78.16" class="difflineplus">+</span>
<a href="#l78.17"></a><span id="l78.17"> .toolbarbutton-1[type=&quot;menu-button&quot;] {</span>
<a href="#l78.18"></a><span id="l78.18">   -moz-box-orient: horizontal;</span>
<a href="#l78.19"></a><span id="l78.19">   padding: 0;</span>
<a href="#l78.20"></a><span id="l78.20"> }</span>
<a href="#l78.21"></a><span id="l78.21"> </span>
<a href="#l78.22"></a><span id="l78.22"> .toolbarbutton-1[type=&quot;menu&quot;] {</span>
<a href="#l78.23"></a><span id="l78.23">   -moz-binding: url(&quot;chrome://global/content/bindings/toolbarbutton.xml#menu-vertical&quot;);</span>
<a href="#l78.24"></a><span id="l78.24"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1" class="difflineminus">--- a/suite/themes/classic/mac/communicator/helpOverlay.css</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineplus">+++ b/suite/themes/classic/mac/communicator/helpOverlay.css</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineat">@@ -65,30 +65,32 @@</span>
<a href="#l79.4"></a><span id="l79.4">   -moz-image-region: inherit;</span>
<a href="#l79.5"></a><span id="l79.5"> }</span>
<a href="#l79.6"></a><span id="l79.6"> </span>
<a href="#l79.7"></a><span id="l79.7"> #help-back-button,</span>
<a href="#l79.8"></a><span id="l79.8"> #help-back-button:not([disabled=&quot;true&quot;]):hover {</span>
<a href="#l79.9"></a><span id="l79.9">   -moz-image-region: rect(60px 29px 89px 0);</span>
<a href="#l79.10"></a><span id="l79.10"> }</span>
<a href="#l79.11"></a><span id="l79.11"> </span>
<a href="#l79.12"></a><span id="l79.12" class="difflineminus">-#help-back-button:not([disabled=&quot;true&quot;]):hover:active {</span>
<a href="#l79.13"></a><span id="l79.13" class="difflineplus">+#help-back-button:not([disabled=&quot;true&quot;]):hover:active,</span>
<a href="#l79.14"></a><span id="l79.14" class="difflineplus">+#help-back-button[open]:not([disabled=&quot;true&quot;]) {</span>
<a href="#l79.15"></a><span id="l79.15">   -moz-image-region: rect(60px 59px 89px 30px);</span>
<a href="#l79.16"></a><span id="l79.16"> }</span>
<a href="#l79.17"></a><span id="l79.17"> </span>
<a href="#l79.18"></a><span id="l79.18"> #help-back-button[disabled=&quot;true&quot;] {</span>
<a href="#l79.19"></a><span id="l79.19">   -moz-image-region: rect(60px 89px 89px 60px);</span>
<a href="#l79.20"></a><span id="l79.20"> }</span>
<a href="#l79.21"></a><span id="l79.21"> </span>
<a href="#l79.22"></a><span id="l79.22"> #help-forward-button,</span>
<a href="#l79.23"></a><span id="l79.23"> #help-forward-button:not([disabled=&quot;true&quot;]):hover {</span>
<a href="#l79.24"></a><span id="l79.24">   -moz-image-region: rect(90px 29px 119px 0);</span>
<a href="#l79.25"></a><span id="l79.25"> }</span>
<a href="#l79.26"></a><span id="l79.26"> </span>
<a href="#l79.27"></a><span id="l79.27" class="difflineminus">-#help-forward-button:not([disabled=&quot;true&quot;]):hover:active {</span>
<a href="#l79.28"></a><span id="l79.28" class="difflineplus">+#help-forward-button:not([disabled=&quot;true&quot;]):hover:active,</span>
<a href="#l79.29"></a><span id="l79.29" class="difflineplus">+#help-forward-button[open]:not([disabled=&quot;true&quot;]) {</span>
<a href="#l79.30"></a><span id="l79.30">   -moz-image-region: rect(90px 59px 119px 30px);</span>
<a href="#l79.31"></a><span id="l79.31"> }</span>
<a href="#l79.32"></a><span id="l79.32"> </span>
<a href="#l79.33"></a><span id="l79.33"> #help-forward-button[disabled=&quot;true&quot;] {</span>
<a href="#l79.34"></a><span id="l79.34">   -moz-image-region: rect(90px 89px 119px 60px);</span>
<a href="#l79.35"></a><span id="l79.35"> }</span>
<a href="#l79.36"></a><span id="l79.36"> </span>
<a href="#l79.37"></a><span id="l79.37"> #help-home-button,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/suite/themes/classic/mac/editor/editorPrimaryToolbar.css</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/suite/themes/classic/mac/editor/editorPrimaryToolbar.css</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -106,17 +106,18 @@</span>
<a href="#l80.4"></a><span id="l80.4">   -moz-image-region: rect(180px 89px 209px 60px) !important;</span>
<a href="#l80.5"></a><span id="l80.5"> }</span>
<a href="#l80.6"></a><span id="l80.6"> </span>
<a href="#l80.7"></a><span id="l80.7"> #printButton {</span>
<a href="#l80.8"></a><span id="l80.8">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons.png&quot;);</span>
<a href="#l80.9"></a><span id="l80.9">   -moz-image-region: rect(0 29px 29px 0);</span>
<a href="#l80.10"></a><span id="l80.10"> }</span>
<a href="#l80.11"></a><span id="l80.11"> </span>
<a href="#l80.12"></a><span id="l80.12" class="difflineminus">-#printButton:hover:active {</span>
<a href="#l80.13"></a><span id="l80.13" class="difflineplus">+#printButton:hover:active,</span>
<a href="#l80.14"></a><span id="l80.14" class="difflineplus">+#printButton[open] {</span>
<a href="#l80.15"></a><span id="l80.15">   -moz-image-region: rect(0 59px 29px 30px);</span>
<a href="#l80.16"></a><span id="l80.16"> }</span>
<a href="#l80.17"></a><span id="l80.17"> </span>
<a href="#l80.18"></a><span id="l80.18"> #printButton[disabled=&quot;true&quot;] {</span>
<a href="#l80.19"></a><span id="l80.19">   -moz-image-region: rect(0 89px 29px 60px);</span>
<a href="#l80.20"></a><span id="l80.20"> }</span>
<a href="#l80.21"></a><span id="l80.21"> </span>
<a href="#l80.22"></a><span id="l80.22"> #linkButton {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/suite/themes/classic/mac/messenger/messengercompose/messengercompose.css</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/suite/themes/classic/mac/messenger/messengercompose/messengercompose.css</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -52,67 +52,70 @@</span>
<a href="#l81.4"></a><span id="l81.4"> }</span>
<a href="#l81.5"></a><span id="l81.5"> </span>
<a href="#l81.6"></a><span id="l81.6"> #button-send {</span>
<a href="#l81.7"></a><span id="l81.7">   -moz-image-region: rect(330px 29px 359px 0);</span>
<a href="#l81.8"></a><span id="l81.8"> }</span>
<a href="#l81.9"></a><span id="l81.9"> </span>
<a href="#l81.10"></a><span id="l81.10"> #button-send:hover:active {</span>
<a href="#l81.11"></a><span id="l81.11">   -moz-image-region: rect(330px 59px 359px 30px);</span>
<a href="#l81.12"></a><span id="l81.12" class="difflineminus">-} </span>
<a href="#l81.13"></a><span id="l81.13" class="difflineplus">+}</span>
<a href="#l81.14"></a><span id="l81.14"> </span>
<a href="#l81.15"></a><span id="l81.15"> #button-send[disabled=&quot;true&quot;] {</span>
<a href="#l81.16"></a><span id="l81.16">   -moz-image-region: rect(330px 89px 359px 60px) !important;</span>
<a href="#l81.17"></a><span id="l81.17" class="difflineminus">-} </span>
<a href="#l81.18"></a><span id="l81.18" class="difflineplus">+}</span>
<a href="#l81.19"></a><span id="l81.19"> </span>
<a href="#l81.20"></a><span id="l81.20"> #button-address {</span>
<a href="#l81.21"></a><span id="l81.21">   -moz-image-region: rect(270px 29px 299px 0);</span>
<a href="#l81.22"></a><span id="l81.22"> }</span>
<a href="#l81.23"></a><span id="l81.23"> </span>
<a href="#l81.24"></a><span id="l81.24"> #button-address:hover:active {</span>
<a href="#l81.25"></a><span id="l81.25">   -moz-image-region: rect(270px 59px 299px 30px);</span>
<a href="#l81.26"></a><span id="l81.26" class="difflineminus">-} </span>
<a href="#l81.27"></a><span id="l81.27" class="difflineplus">+}</span>
<a href="#l81.28"></a><span id="l81.28"> </span>
<a href="#l81.29"></a><span id="l81.29"> #button-address[disabled=&quot;true&quot;] {</span>
<a href="#l81.30"></a><span id="l81.30">   -moz-image-region: rect(270px 89px 299px 60px) !important;</span>
<a href="#l81.31"></a><span id="l81.31" class="difflineminus">-} </span>
<a href="#l81.32"></a><span id="l81.32" class="difflineplus">+}</span>
<a href="#l81.33"></a><span id="l81.33"> </span>
<a href="#l81.34"></a><span id="l81.34"> #button-attach {</span>
<a href="#l81.35"></a><span id="l81.35">   -moz-image-region: rect(300px 29px 329px 0);</span>
<a href="#l81.36"></a><span id="l81.36"> }</span>
<a href="#l81.37"></a><span id="l81.37"> </span>
<a href="#l81.38"></a><span id="l81.38" class="difflineminus">-#button-attach:hover:active {</span>
<a href="#l81.39"></a><span id="l81.39" class="difflineplus">+#button-attach:hover:active,</span>
<a href="#l81.40"></a><span id="l81.40" class="difflineplus">+#button-attach[open] {</span>
<a href="#l81.41"></a><span id="l81.41">   -moz-image-region: rect(300px 59px 329px 30px);</span>
<a href="#l81.42"></a><span id="l81.42" class="difflineminus">-} </span>
<a href="#l81.43"></a><span id="l81.43" class="difflineplus">+}</span>
<a href="#l81.44"></a><span id="l81.44"> </span>
<a href="#l81.45"></a><span id="l81.45"> #button-attach[disabled=&quot;true&quot;] {</span>
<a href="#l81.46"></a><span id="l81.46">   -moz-image-region: rect(300px 89px 329px 60px) !important;</span>
<a href="#l81.47"></a><span id="l81.47" class="difflineminus">-} </span>
<a href="#l81.48"></a><span id="l81.48" class="difflineplus">+}</span>
<a href="#l81.49"></a><span id="l81.49"> </span>
<a href="#l81.50"></a><span id="l81.50"> #spellingButton {</span>
<a href="#l81.51"></a><span id="l81.51">   list-style-image: url(&quot;chrome://editor/skin/icons/editoricons.png&quot;);</span>
<a href="#l81.52"></a><span id="l81.52">   -moz-image-region: rect(240px 29px 269px 0);</span>
<a href="#l81.53"></a><span id="l81.53"> }</span>
<a href="#l81.54"></a><span id="l81.54"> </span>
<a href="#l81.55"></a><span id="l81.55" class="difflineminus">-#spellingButton:hover:active {</span>
<a href="#l81.56"></a><span id="l81.56" class="difflineplus">+#spellingButton:hover:active,</span>
<a href="#l81.57"></a><span id="l81.57" class="difflineplus">+#spellingButton[open] {</span>
<a href="#l81.58"></a><span id="l81.58">   -moz-image-region: rect(240px 59px 269px 30px);</span>
<a href="#l81.59"></a><span id="l81.59"> }</span>
<a href="#l81.60"></a><span id="l81.60"> </span>
<a href="#l81.61"></a><span id="l81.61"> #spellingButton[disabled=&quot;true&quot;] {</span>
<a href="#l81.62"></a><span id="l81.62">   -moz-image-region: rect(240px 89px 269px 60px) !important;</span>
<a href="#l81.63"></a><span id="l81.63"> }</span>
<a href="#l81.64"></a><span id="l81.64"> </span>
<a href="#l81.65"></a><span id="l81.65"> #button-save {</span>
<a href="#l81.66"></a><span id="l81.66">   list-style-image: url(&quot;chrome://editor/skin/icons/editoricons.png&quot;);</span>
<a href="#l81.67"></a><span id="l81.67">   -moz-image-region: rect(210px 29px 239px 0);</span>
<a href="#l81.68"></a><span id="l81.68"> }</span>
<a href="#l81.69"></a><span id="l81.69"> </span>
<a href="#l81.70"></a><span id="l81.70" class="difflineminus">-#button-save:hover:active {</span>
<a href="#l81.71"></a><span id="l81.71" class="difflineplus">+#button-save:hover:active,</span>
<a href="#l81.72"></a><span id="l81.72" class="difflineplus">+#button-save[open] {</span>
<a href="#l81.73"></a><span id="l81.73">   -moz-image-region: rect(210px 59px 239px 30px);</span>
<a href="#l81.74"></a><span id="l81.74" class="difflineminus">-} </span>
<a href="#l81.75"></a><span id="l81.75" class="difflineplus">+}</span>
<a href="#l81.76"></a><span id="l81.76"> </span>
<a href="#l81.77"></a><span id="l81.77"> #button-save[disabled=&quot;true&quot;] {</span>
<a href="#l81.78"></a><span id="l81.78">   -moz-image-region: rect(210px 89px 239px 60px) !important;</span>
<a href="#l81.79"></a><span id="l81.79"> }</span>
<a href="#l81.80"></a><span id="l81.80"> </span>
<a href="#l81.81"></a><span id="l81.81"> #attachmentbucket-sizer {</span>
<a href="#l81.82"></a><span id="l81.82">   border-top: none;</span>
<a href="#l81.83"></a><span id="l81.83">   border-bottom: none;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1" class="difflineminus">--- a/suite/themes/classic/mac/messenger/primaryToolbar.css</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineplus">+++ b/suite/themes/classic/mac/messenger/primaryToolbar.css</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineat">@@ -44,128 +44,134 @@</span>
<a href="#l82.4"></a><span id="l82.4"> </span>
<a href="#l82.5"></a><span id="l82.5"> /* ::::: primary toolbar buttons ::::: */</span>
<a href="#l82.6"></a><span id="l82.6"> </span>
<a href="#l82.7"></a><span id="l82.7"> #button-getmsg {</span>
<a href="#l82.8"></a><span id="l82.8">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l82.9"></a><span id="l82.9">   -moz-image-region: rect(90px 29px 119px 0);</span>
<a href="#l82.10"></a><span id="l82.10"> }</span>
<a href="#l82.11"></a><span id="l82.11"> </span>
<a href="#l82.12"></a><span id="l82.12" class="difflineminus">-#button-getmsg:hover:active {</span>
<a href="#l82.13"></a><span id="l82.13" class="difflineplus">+#button-getmsg:hover:active,</span>
<a href="#l82.14"></a><span id="l82.14" class="difflineplus">+#button-getmsg[open] {</span>
<a href="#l82.15"></a><span id="l82.15">   -moz-image-region: rect(90px 59px 119px 30px);</span>
<a href="#l82.16"></a><span id="l82.16"> } </span>
<a href="#l82.17"></a><span id="l82.17"> </span>
<a href="#l82.18"></a><span id="l82.18"> #button-getmsg[disabled=&quot;true&quot;] {</span>
<a href="#l82.19"></a><span id="l82.19">   -moz-image-region: rect(90px 89px 119px 60px) !important;</span>
<a href="#l82.20"></a><span id="l82.20" class="difflineminus">-} </span>
<a href="#l82.21"></a><span id="l82.21" class="difflineplus">+}</span>
<a href="#l82.22"></a><span id="l82.22"> </span>
<a href="#l82.23"></a><span id="l82.23"> #button-newmsg {</span>
<a href="#l82.24"></a><span id="l82.24">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l82.25"></a><span id="l82.25">   -moz-image-region: rect(150px 29px 179px 0);</span>
<a href="#l82.26"></a><span id="l82.26"> }</span>
<a href="#l82.27"></a><span id="l82.27"> </span>
<a href="#l82.28"></a><span id="l82.28" class="difflineminus">-#button-newmsg:hover:active {</span>
<a href="#l82.29"></a><span id="l82.29" class="difflineplus">+#button-newmsg:hover:active,</span>
<a href="#l82.30"></a><span id="l82.30" class="difflineplus">+#button-newmsg[open] {</span>
<a href="#l82.31"></a><span id="l82.31">   -moz-image-region: rect(150px 59px 179px 30px);</span>
<a href="#l82.32"></a><span id="l82.32" class="difflineminus">-} </span>
<a href="#l82.33"></a><span id="l82.33" class="difflineplus">+}</span>
<a href="#l82.34"></a><span id="l82.34"> </span>
<a href="#l82.35"></a><span id="l82.35"> #button-newmsg[disabled=&quot;true&quot;] {</span>
<a href="#l82.36"></a><span id="l82.36">   -moz-image-region: rect(150px 89px 179px 60px) !important;</span>
<a href="#l82.37"></a><span id="l82.37" class="difflineminus">-} </span>
<a href="#l82.38"></a><span id="l82.38" class="difflineplus">+}</span>
<a href="#l82.39"></a><span id="l82.39"> </span>
<a href="#l82.40"></a><span id="l82.40"> #button-reply {</span>
<a href="#l82.41"></a><span id="l82.41">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l82.42"></a><span id="l82.42">   -moz-image-region: rect(210px 29px 239px 0);</span>
<a href="#l82.43"></a><span id="l82.43"> }</span>
<a href="#l82.44"></a><span id="l82.44"> </span>
<a href="#l82.45"></a><span id="l82.45"> #button-reply:hover:active {</span>
<a href="#l82.46"></a><span id="l82.46">   -moz-image-region: rect(210px 59px 239px 30px);</span>
<a href="#l82.47"></a><span id="l82.47" class="difflineminus">-} </span>
<a href="#l82.48"></a><span id="l82.48" class="difflineplus">+}</span>
<a href="#l82.49"></a><span id="l82.49"> </span>
<a href="#l82.50"></a><span id="l82.50"> #button-reply[disabled=&quot;true&quot;] {</span>
<a href="#l82.51"></a><span id="l82.51">   -moz-image-region: rect(210px 89px 239px 60px) !important;</span>
<a href="#l82.52"></a><span id="l82.52" class="difflineminus">-} </span>
<a href="#l82.53"></a><span id="l82.53" class="difflineplus">+}</span>
<a href="#l82.54"></a><span id="l82.54"> </span>
<a href="#l82.55"></a><span id="l82.55"> #button-replyall {</span>
<a href="#l82.56"></a><span id="l82.56">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l82.57"></a><span id="l82.57">   -moz-image-region: rect(240px 29px 269px 0);</span>
<a href="#l82.58"></a><span id="l82.58"> }</span>
<a href="#l82.59"></a><span id="l82.59"> </span>
<a href="#l82.60"></a><span id="l82.60"> #button-replyall:hover:active {</span>
<a href="#l82.61"></a><span id="l82.61">   -moz-image-region: rect(240px 59px 269px 30px);</span>
<a href="#l82.62"></a><span id="l82.62"> } </span>
<a href="#l82.63"></a><span id="l82.63"> </span>
<a href="#l82.64"></a><span id="l82.64"> #button-replyall[disabled=&quot;true&quot;] {</span>
<a href="#l82.65"></a><span id="l82.65">   -moz-image-region: rect(240px 89px 269px 60px) !important;</span>
<a href="#l82.66"></a><span id="l82.66" class="difflineminus">-} </span>
<a href="#l82.67"></a><span id="l82.67" class="difflineplus">+}</span>
<a href="#l82.68"></a><span id="l82.68"> </span>
<a href="#l82.69"></a><span id="l82.69"> #button-forward {</span>
<a href="#l82.70"></a><span id="l82.70">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l82.71"></a><span id="l82.71">   -moz-image-region: rect(60px 29px 89px 0);</span>
<a href="#l82.72"></a><span id="l82.72"> }</span>
<a href="#l82.73"></a><span id="l82.73"> </span>
<a href="#l82.74"></a><span id="l82.74" class="difflineminus">-#button-forward:hover:active {</span>
<a href="#l82.75"></a><span id="l82.75" class="difflineplus">+#button-forward:hover:active,</span>
<a href="#l82.76"></a><span id="l82.76" class="difflineplus">+#button-forward[open] {</span>
<a href="#l82.77"></a><span id="l82.77">   -moz-image-region: rect(60px 59px 89px 30px);</span>
<a href="#l82.78"></a><span id="l82.78"> } </span>
<a href="#l82.79"></a><span id="l82.79"> </span>
<a href="#l82.80"></a><span id="l82.80"> #button-forward[disabled=&quot;true&quot;] {</span>
<a href="#l82.81"></a><span id="l82.81">   -moz-image-region: rect(60px 89px 89px 60px) !important;</span>
<a href="#l82.82"></a><span id="l82.82"> } </span>
<a href="#l82.83"></a><span id="l82.83"> </span>
<a href="#l82.84"></a><span id="l82.84"> #button-file {</span>
<a href="#l82.85"></a><span id="l82.85">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l82.86"></a><span id="l82.86">   -moz-image-region: rect(30px 29px 59px 0);</span>
<a href="#l82.87"></a><span id="l82.87"> }</span>
<a href="#l82.88"></a><span id="l82.88"> </span>
<a href="#l82.89"></a><span id="l82.89"> #button-file:hover:active,</span>
<a href="#l82.90"></a><span id="l82.90"> #button-file[open] {</span>
<a href="#l82.91"></a><span id="l82.91">   -moz-image-region: rect(30px 59px 59px 30px);</span>
<a href="#l82.92"></a><span id="l82.92" class="difflineminus">-} </span>
<a href="#l82.93"></a><span id="l82.93" class="difflineplus">+}</span>
<a href="#l82.94"></a><span id="l82.94"> </span>
<a href="#l82.95"></a><span id="l82.95"> #button-file[disabled=&quot;true&quot;] {</span>
<a href="#l82.96"></a><span id="l82.96">   -moz-image-region: rect(30px 89px 59px 60px) !important;</span>
<a href="#l82.97"></a><span id="l82.97" class="difflineminus">-} </span>
<a href="#l82.98"></a><span id="l82.98" class="difflineplus">+}</span>
<a href="#l82.99"></a><span id="l82.99"> </span>
<a href="#l82.100"></a><span id="l82.100"> #button-goback {</span>
<a href="#l82.101"></a><span id="l82.101">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons.png&quot;);</span>
<a href="#l82.102"></a><span id="l82.102">   -moz-image-region: rect(60px 29px 89px 0);</span>
<a href="#l82.103"></a><span id="l82.103"> }</span>
<a href="#l82.104"></a><span id="l82.104"> </span>
<a href="#l82.105"></a><span id="l82.105" class="difflineminus">-#button-goback:hover:active {</span>
<a href="#l82.106"></a><span id="l82.106" class="difflineplus">+#button-goback:hover:active,</span>
<a href="#l82.107"></a><span id="l82.107" class="difflineplus">+#button-goback[open] {</span>
<a href="#l82.108"></a><span id="l82.108">   -moz-image-region: rect(60px 59px 89px 30px);</span>
<a href="#l82.109"></a><span id="l82.109"> }</span>
<a href="#l82.110"></a><span id="l82.110"> </span>
<a href="#l82.111"></a><span id="l82.111"> #button-goback[disabled=&quot;true&quot;] {</span>
<a href="#l82.112"></a><span id="l82.112">   -moz-image-region: rect(60px 89px 89px 60px) !important;</span>
<a href="#l82.113"></a><span id="l82.113"> }</span>
<a href="#l82.114"></a><span id="l82.114"> </span>
<a href="#l82.115"></a><span id="l82.115"> #button-goforward {</span>
<a href="#l82.116"></a><span id="l82.116">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons.png&quot;);</span>
<a href="#l82.117"></a><span id="l82.117">   -moz-image-region: rect(90px 29px 119px 0);</span>
<a href="#l82.118"></a><span id="l82.118"> }</span>
<a href="#l82.119"></a><span id="l82.119"> </span>
<a href="#l82.120"></a><span id="l82.120" class="difflineminus">-#button-goforward:hover:active {</span>
<a href="#l82.121"></a><span id="l82.121" class="difflineplus">+#button-goforward:hover:active,</span>
<a href="#l82.122"></a><span id="l82.122" class="difflineplus">+#button-goforward[open] {</span>
<a href="#l82.123"></a><span id="l82.123">   -moz-image-region: rect(90px 59px 119px 30px);</span>
<a href="#l82.124"></a><span id="l82.124"> }</span>
<a href="#l82.125"></a><span id="l82.125"> </span>
<a href="#l82.126"></a><span id="l82.126"> #button-goforward[disabled=&quot;true&quot;] {</span>
<a href="#l82.127"></a><span id="l82.127">   -moz-image-region: rect(90px 89px 119px 60px) !important;</span>
<a href="#l82.128"></a><span id="l82.128"> }</span>
<a href="#l82.129"></a><span id="l82.129"> </span>
<a href="#l82.130"></a><span id="l82.130"> #button-next {</span>
<a href="#l82.131"></a><span id="l82.131">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l82.132"></a><span id="l82.132">   -moz-image-region: rect(180px 29px 209px 0);</span>
<a href="#l82.133"></a><span id="l82.133"> }</span>
<a href="#l82.134"></a><span id="l82.134"> </span>
<a href="#l82.135"></a><span id="l82.135" class="difflineminus">-#button-next:hover:active {</span>
<a href="#l82.136"></a><span id="l82.136" class="difflineplus">+#button-next:hover:active,</span>
<a href="#l82.137"></a><span id="l82.137" class="difflineplus">+#button-next[open] {</span>
<a href="#l82.138"></a><span id="l82.138">   -moz-image-region: rect(180px 59px 209px 30px);</span>
<a href="#l82.139"></a><span id="l82.139" class="difflineminus">-} </span>
<a href="#l82.140"></a><span id="l82.140" class="difflineplus">+}</span>
<a href="#l82.141"></a><span id="l82.141"> </span>
<a href="#l82.142"></a><span id="l82.142"> #button-next[disabled=&quot;true&quot;] {</span>
<a href="#l82.143"></a><span id="l82.143">   -moz-image-region: rect(180px 89px 209px 60px) !important;</span>
<a href="#l82.144"></a><span id="l82.144" class="difflineminus">-} </span>
<a href="#l82.145"></a><span id="l82.145" class="difflineplus">+}</span>
<a href="#l82.146"></a><span id="l82.146"> </span>
<a href="#l82.147"></a><span id="l82.147"> #button-delete {</span>
<a href="#l82.148"></a><span id="l82.148">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l82.149"></a><span id="l82.149">   -moz-image-region: rect(0 29px 29px 0);</span>
<a href="#l82.150"></a><span id="l82.150"> }</span>
<a href="#l82.151"></a><span id="l82.151"> </span>
<a href="#l82.152"></a><span id="l82.152"> #button-delete:hover:active {</span>
<a href="#l82.153"></a><span id="l82.153">   -moz-image-region: rect(0 59px 29px 30px);</span>
<a href="#l82.154"></a><span id="l82.154" class="difflineat">@@ -179,23 +185,24 @@ toolbarpaletteitem &gt; #button-delete {</span>
<a href="#l82.155"></a><span id="l82.155">   display: -moz-box;</span>
<a href="#l82.156"></a><span id="l82.156"> }</span>
<a href="#l82.157"></a><span id="l82.157"> </span>
<a href="#l82.158"></a><span id="l82.158"> #button-mark {</span>
<a href="#l82.159"></a><span id="l82.159">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l82.160"></a><span id="l82.160">   -moz-image-region: rect(120px 29px 149px 0);</span>
<a href="#l82.161"></a><span id="l82.161"> }</span>
<a href="#l82.162"></a><span id="l82.162"> </span>
<a href="#l82.163"></a><span id="l82.163" class="difflineminus">-#button-mark:hover:active {</span>
<a href="#l82.164"></a><span id="l82.164" class="difflineplus">+#button-mark:hover:active,</span>
<a href="#l82.165"></a><span id="l82.165" class="difflineplus">+#button-mark[open] {</span>
<a href="#l82.166"></a><span id="l82.166">   -moz-image-region: rect(120px 59px 149px 30px);</span>
<a href="#l82.167"></a><span id="l82.167" class="difflineminus">-} </span>
<a href="#l82.168"></a><span id="l82.168" class="difflineplus">+}</span>
<a href="#l82.169"></a><span id="l82.169"> </span>
<a href="#l82.170"></a><span id="l82.170"> #button-mark[disabled=&quot;true&quot;] {</span>
<a href="#l82.171"></a><span id="l82.171">   -moz-image-region: rect(120px 89px 149px 60px) !important;</span>
<a href="#l82.172"></a><span id="l82.172" class="difflineminus">-} </span>
<a href="#l82.173"></a><span id="l82.173" class="difflineplus">+}</span>
<a href="#l82.174"></a><span id="l82.174"> </span>
<a href="#l82.175"></a><span id="l82.175"> #button-junk {</span>
<a href="#l82.176"></a><span id="l82.176">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons.png&quot;);</span>
<a href="#l82.177"></a><span id="l82.177">   -moz-image-region: rect(360px 29px 389px 0);</span>
<a href="#l82.178"></a><span id="l82.178"> }</span>
<a href="#l82.179"></a><span id="l82.179"> </span>
<a href="#l82.180"></a><span id="l82.180"> #button-junk:hover:active {</span>
<a href="#l82.181"></a><span id="l82.181">   -moz-image-region: rect(360px 59px 389px 30px);</span>
<a href="#l82.182"></a><span id="l82.182" class="difflineat">@@ -205,17 +212,18 @@ toolbarpaletteitem &gt; #button-delete {</span>
<a href="#l82.183"></a><span id="l82.183">   -moz-image-region: rect(360px 89px 389px 60px) !important;</span>
<a href="#l82.184"></a><span id="l82.184"> }</span>
<a href="#l82.185"></a><span id="l82.185"> </span>
<a href="#l82.186"></a><span id="l82.186"> #button-print {</span>
<a href="#l82.187"></a><span id="l82.187">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons.png&quot;);</span>
<a href="#l82.188"></a><span id="l82.188">   -moz-image-region: rect(0 29px 29px 0);</span>
<a href="#l82.189"></a><span id="l82.189"> }</span>
<a href="#l82.190"></a><span id="l82.190"> </span>
<a href="#l82.191"></a><span id="l82.191" class="difflineminus">-#button-print:hover:active {</span>
<a href="#l82.192"></a><span id="l82.192" class="difflineplus">+#button-print:hover:active,</span>
<a href="#l82.193"></a><span id="l82.193" class="difflineplus">+#button-print[open] {</span>
<a href="#l82.194"></a><span id="l82.194">   -moz-image-region: rect(0 59px 29px 30px);</span>
<a href="#l82.195"></a><span id="l82.195"> }</span>
<a href="#l82.196"></a><span id="l82.196"> </span>
<a href="#l82.197"></a><span id="l82.197"> #button-print[disabled=&quot;true&quot;] {</span>
<a href="#l82.198"></a><span id="l82.198">   -moz-image-region: rect(0 89px 29px 60px) !important;</span>
<a href="#l82.199"></a><span id="l82.199"> }</span>
<a href="#l82.200"></a><span id="l82.200"> </span>
<a href="#l82.201"></a><span id="l82.201"> #button-stop {</span>
<a href="#l82.202"></a><span id="l82.202" class="difflineat">@@ -233,30 +241,32 @@ toolbarpaletteitem &gt; #button-delete {</span>
<a href="#l82.203"></a><span id="l82.203"> </span>
<a href="#l82.204"></a><span id="l82.204"> /* ::::: small primary toolbar buttons ::::: */</span>
<a href="#l82.205"></a><span id="l82.205"> </span>
<a href="#l82.206"></a><span id="l82.206"> toolbar[iconsize=&quot;small&quot;] &gt; #button-getmsg {</span>
<a href="#l82.207"></a><span id="l82.207">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons-small.png&quot;);</span>
<a href="#l82.208"></a><span id="l82.208">   -moz-image-region: rect(60px 19px 79px 0);</span>
<a href="#l82.209"></a><span id="l82.209"> }</span>
<a href="#l82.210"></a><span id="l82.210"> </span>
<a href="#l82.211"></a><span id="l82.211" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-getmsg:hover:active {</span>
<a href="#l82.212"></a><span id="l82.212" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-getmsg:hover:active,</span>
<a href="#l82.213"></a><span id="l82.213" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-getmsg[open] {</span>
<a href="#l82.214"></a><span id="l82.214">   -moz-image-region: rect(60px 39px 79px 20px);</span>
<a href="#l82.215"></a><span id="l82.215"> }</span>
<a href="#l82.216"></a><span id="l82.216"> </span>
<a href="#l82.217"></a><span id="l82.217"> toolbar[iconsize=&quot;small&quot;] &gt; #button-getmsg[disabled=&quot;true&quot;] {</span>
<a href="#l82.218"></a><span id="l82.218">   -moz-image-region: rect(60px 59px 79px 40px) !important;</span>
<a href="#l82.219"></a><span id="l82.219"> }</span>
<a href="#l82.220"></a><span id="l82.220"> </span>
<a href="#l82.221"></a><span id="l82.221"> toolbar[iconsize=&quot;small&quot;] &gt; #button-newmsg {</span>
<a href="#l82.222"></a><span id="l82.222">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons-small.png&quot;);</span>
<a href="#l82.223"></a><span id="l82.223">   -moz-image-region: rect(100px 19px 119px 0);</span>
<a href="#l82.224"></a><span id="l82.224"> }</span>
<a href="#l82.225"></a><span id="l82.225"> </span>
<a href="#l82.226"></a><span id="l82.226" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-newmsg:hover:active {</span>
<a href="#l82.227"></a><span id="l82.227" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-newmsg:hover:active,</span>
<a href="#l82.228"></a><span id="l82.228" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-newmsg[open] {</span>
<a href="#l82.229"></a><span id="l82.229">   -moz-image-region: rect(100px 39px 119px 20px);</span>
<a href="#l82.230"></a><span id="l82.230"> }</span>
<a href="#l82.231"></a><span id="l82.231"> </span>
<a href="#l82.232"></a><span id="l82.232"> toolbar[iconsize=&quot;small&quot;] &gt; #button-newmsg[disabled=&quot;true&quot;] {</span>
<a href="#l82.233"></a><span id="l82.233">   -moz-image-region: rect(100px 59px 119px 40px) !important;</span>
<a href="#l82.234"></a><span id="l82.234"> }</span>
<a href="#l82.235"></a><span id="l82.235"> </span>
<a href="#l82.236"></a><span id="l82.236"> toolbar[iconsize=&quot;small&quot;] &gt; #button-reply {</span>
<a href="#l82.237"></a><span id="l82.237" class="difflineat">@@ -285,17 +295,18 @@ toolbar[iconsize=&quot;small&quot;] &gt; #button-repl</span>
<a href="#l82.238"></a><span id="l82.238">   -moz-image-region: rect(160px 59px 179px 40px) !important;</span>
<a href="#l82.239"></a><span id="l82.239"> }</span>
<a href="#l82.240"></a><span id="l82.240"> </span>
<a href="#l82.241"></a><span id="l82.241"> toolbar[iconsize=&quot;small&quot;] &gt; #button-forward {</span>
<a href="#l82.242"></a><span id="l82.242">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons-small.png&quot;);</span>
<a href="#l82.243"></a><span id="l82.243">   -moz-image-region: rect(40px 19px 59px 0);</span>
<a href="#l82.244"></a><span id="l82.244"> }</span>
<a href="#l82.245"></a><span id="l82.245"> </span>
<a href="#l82.246"></a><span id="l82.246" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-forward:hover:active {</span>
<a href="#l82.247"></a><span id="l82.247" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-forward:hover:active,</span>
<a href="#l82.248"></a><span id="l82.248" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-forward[open] {</span>
<a href="#l82.249"></a><span id="l82.249">   -moz-image-region: rect(40px 39px 59px 20px);</span>
<a href="#l82.250"></a><span id="l82.250"> }</span>
<a href="#l82.251"></a><span id="l82.251"> </span>
<a href="#l82.252"></a><span id="l82.252"> toolbar[iconsize=&quot;small&quot;] &gt; #button-forward[disabled=&quot;true&quot;] {</span>
<a href="#l82.253"></a><span id="l82.253">   -moz-image-region: rect(40px 59px 59px 40px) !important;</span>
<a href="#l82.254"></a><span id="l82.254"> }</span>
<a href="#l82.255"></a><span id="l82.255"> </span>
<a href="#l82.256"></a><span id="l82.256"> toolbar[iconsize=&quot;small&quot;] &gt; #button-file {</span>
<a href="#l82.257"></a><span id="l82.257" class="difflineat">@@ -312,43 +323,46 @@ toolbar[iconsize=&quot;small&quot;] &gt; #button-file</span>
<a href="#l82.258"></a><span id="l82.258">   -moz-image-region: rect(20px 59px 39px 40px) !important;</span>
<a href="#l82.259"></a><span id="l82.259"> }</span>
<a href="#l82.260"></a><span id="l82.260"> </span>
<a href="#l82.261"></a><span id="l82.261"> toolbar[iconsize=&quot;small&quot;] &gt; #button-goback {</span>
<a href="#l82.262"></a><span id="l82.262">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons-small.png&quot;);</span>
<a href="#l82.263"></a><span id="l82.263">   -moz-image-region: rect(40px 19px 59px 0);</span>
<a href="#l82.264"></a><span id="l82.264"> }</span>
<a href="#l82.265"></a><span id="l82.265"> </span>
<a href="#l82.266"></a><span id="l82.266" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-goback:hover:active {</span>
<a href="#l82.267"></a><span id="l82.267" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-goback:hover:active,</span>
<a href="#l82.268"></a><span id="l82.268" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-goback[open] {</span>
<a href="#l82.269"></a><span id="l82.269">   -moz-image-region: rect(40px 39px 59px 20px);</span>
<a href="#l82.270"></a><span id="l82.270"> }</span>
<a href="#l82.271"></a><span id="l82.271"> </span>
<a href="#l82.272"></a><span id="l82.272"> toolbar[iconsize=&quot;small&quot;] &gt; #button-goback[disabled=&quot;true&quot;] {</span>
<a href="#l82.273"></a><span id="l82.273">   -moz-image-region: rect(40px 59px 59px 40px) !important;</span>
<a href="#l82.274"></a><span id="l82.274"> }</span>
<a href="#l82.275"></a><span id="l82.275"> </span>
<a href="#l82.276"></a><span id="l82.276"> toolbar[iconsize=&quot;small&quot;] &gt; #button-goforward {</span>
<a href="#l82.277"></a><span id="l82.277">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons-small.png&quot;);</span>
<a href="#l82.278"></a><span id="l82.278">   -moz-image-region: rect(60px 19px 79px 0);</span>
<a href="#l82.279"></a><span id="l82.279"> }</span>
<a href="#l82.280"></a><span id="l82.280"> </span>
<a href="#l82.281"></a><span id="l82.281" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-goforward:hover:active {</span>
<a href="#l82.282"></a><span id="l82.282" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-goforward:hover:active,</span>
<a href="#l82.283"></a><span id="l82.283" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-goforward[open] {</span>
<a href="#l82.284"></a><span id="l82.284">   -moz-image-region: rect(60px 39px 79px 20px);</span>
<a href="#l82.285"></a><span id="l82.285"> }</span>
<a href="#l82.286"></a><span id="l82.286"> </span>
<a href="#l82.287"></a><span id="l82.287"> toolbar[iconsize=&quot;small&quot;] &gt; #button-goforward[disabled=&quot;true&quot;] {</span>
<a href="#l82.288"></a><span id="l82.288">   -moz-image-region: rect(60px 59px 79px 40px) !important;</span>
<a href="#l82.289"></a><span id="l82.289"> }</span>
<a href="#l82.290"></a><span id="l82.290"> </span>
<a href="#l82.291"></a><span id="l82.291"> toolbar[iconsize=&quot;small&quot;] &gt; #button-next {</span>
<a href="#l82.292"></a><span id="l82.292">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons-small.png&quot;);</span>
<a href="#l82.293"></a><span id="l82.293">   -moz-image-region: rect(120px 19px 139px 0);</span>
<a href="#l82.294"></a><span id="l82.294"> }</span>
<a href="#l82.295"></a><span id="l82.295"> </span>
<a href="#l82.296"></a><span id="l82.296" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-next:hover:active {</span>
<a href="#l82.297"></a><span id="l82.297" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-next:hover:active,</span>
<a href="#l82.298"></a><span id="l82.298" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-next[open] {</span>
<a href="#l82.299"></a><span id="l82.299">   -moz-image-region: rect(120px 39px 139px 20px);</span>
<a href="#l82.300"></a><span id="l82.300"> }</span>
<a href="#l82.301"></a><span id="l82.301"> </span>
<a href="#l82.302"></a><span id="l82.302"> toolbar[iconsize=&quot;small&quot;] &gt; #button-next[disabled=&quot;true&quot;] {</span>
<a href="#l82.303"></a><span id="l82.303">   -moz-image-region: rect(120px 59px 139px 40px) !important;</span>
<a href="#l82.304"></a><span id="l82.304"> }</span>
<a href="#l82.305"></a><span id="l82.305"> </span>
<a href="#l82.306"></a><span id="l82.306"> toolbar[iconsize=&quot;small&quot;] &gt; #button-delete {</span>
<a href="#l82.307"></a><span id="l82.307" class="difflineat">@@ -364,17 +378,18 @@ toolbar[iconsize=&quot;small&quot;] &gt; #button-dele</span>
<a href="#l82.308"></a><span id="l82.308">   -moz-image-region: rect(0 59px 19px 40px) !important;</span>
<a href="#l82.309"></a><span id="l82.309"> }</span>
<a href="#l82.310"></a><span id="l82.310"> </span>
<a href="#l82.311"></a><span id="l82.311"> toolbar[iconsize=&quot;small&quot;] &gt; #button-mark {</span>
<a href="#l82.312"></a><span id="l82.312">   list-style-image: url(&quot;chrome://messenger/skin/icons/messengericons-small.png&quot;);</span>
<a href="#l82.313"></a><span id="l82.313">   -moz-image-region: rect(80px 19px 99px 0);</span>
<a href="#l82.314"></a><span id="l82.314"> }</span>
<a href="#l82.315"></a><span id="l82.315"> </span>
<a href="#l82.316"></a><span id="l82.316" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-mark:hover:active {</span>
<a href="#l82.317"></a><span id="l82.317" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-mark:hover:active,</span>
<a href="#l82.318"></a><span id="l82.318" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-mark[open] {</span>
<a href="#l82.319"></a><span id="l82.319">   -moz-image-region: rect(80px 39px 99px 20px);</span>
<a href="#l82.320"></a><span id="l82.320"> }</span>
<a href="#l82.321"></a><span id="l82.321"> </span>
<a href="#l82.322"></a><span id="l82.322"> toolbar[iconsize=&quot;small&quot;] &gt; #button-mark[disabled=&quot;true&quot;] {</span>
<a href="#l82.323"></a><span id="l82.323">   -moz-image-region: rect(80px 59px 99px 40px) !important;</span>
<a href="#l82.324"></a><span id="l82.324"> }</span>
<a href="#l82.325"></a><span id="l82.325"> </span>
<a href="#l82.326"></a><span id="l82.326"> toolbar[iconsize=&quot;small&quot;] &gt; #button-junk &gt; #junk-deck &gt; .toolbarbutton-1 {</span>
<a href="#l82.327"></a><span id="l82.327" class="difflineat">@@ -390,17 +405,18 @@ toolbar[iconsize=&quot;small&quot;] &gt; #button-junk</span>
<a href="#l82.328"></a><span id="l82.328">   -moz-image-region: rect(240px 59px 259px 40px) !important;</span>
<a href="#l82.329"></a><span id="l82.329"> }</span>
<a href="#l82.330"></a><span id="l82.330"> </span>
<a href="#l82.331"></a><span id="l82.331"> toolbar[iconsize=&quot;small&quot;] &gt; #button-print {</span>
<a href="#l82.332"></a><span id="l82.332">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons-small.png&quot;);</span>
<a href="#l82.333"></a><span id="l82.333">   -moz-image-region: rect(0 19px 19px 0);</span>
<a href="#l82.334"></a><span id="l82.334"> }</span>
<a href="#l82.335"></a><span id="l82.335"> </span>
<a href="#l82.336"></a><span id="l82.336" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #button-print:hover:active {</span>
<a href="#l82.337"></a><span id="l82.337" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-print:hover:active,</span>
<a href="#l82.338"></a><span id="l82.338" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #button-print[open] {</span>
<a href="#l82.339"></a><span id="l82.339">   -moz-image-region: rect(0 39px 19px 20px);</span>
<a href="#l82.340"></a><span id="l82.340"> }</span>
<a href="#l82.341"></a><span id="l82.341"> </span>
<a href="#l82.342"></a><span id="l82.342"> toolbar[iconsize=&quot;small&quot;] &gt; #button-print[disabled=&quot;true&quot;] {</span>
<a href="#l82.343"></a><span id="l82.343">   -moz-image-region: rect(0 59px 19px 40px) !important;</span>
<a href="#l82.344"></a><span id="l82.344"> }</span>
<a href="#l82.345"></a><span id="l82.345"> </span>
<a href="#l82.346"></a><span id="l82.346"> toolbar[iconsize=&quot;small&quot;] &gt; #button-stop {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1" class="difflineminus">--- a/suite/themes/classic/mac/messenger/smime/msgCompSMIMEOverlay.css</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineplus">+++ b/suite/themes/classic/mac/messenger/smime/msgCompSMIMEOverlay.css</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineat">@@ -41,17 +41,18 @@</span>
<a href="#l83.4"></a><span id="l83.4"> </span>
<a href="#l83.5"></a><span id="l83.5"> @namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l83.6"></a><span id="l83.6"> </span>
<a href="#l83.7"></a><span id="l83.7"> #button-security {</span>
<a href="#l83.8"></a><span id="l83.8">   list-style-image: url(&quot;chrome://messenger/skin/smime/icons/smimeicons.png&quot;);</span>
<a href="#l83.9"></a><span id="l83.9">   -moz-image-region: rect(0 29px 29px 0px);</span>
<a href="#l83.10"></a><span id="l83.10"> }</span>
<a href="#l83.11"></a><span id="l83.11"> </span>
<a href="#l83.12"></a><span id="l83.12" class="difflineminus">-#button-security:hover:active {</span>
<a href="#l83.13"></a><span id="l83.13" class="difflineplus">+#button-security:hover:active,</span>
<a href="#l83.14"></a><span id="l83.14" class="difflineplus">+#button-security[open] {</span>
<a href="#l83.15"></a><span id="l83.15">   -moz-image-region: rect(0 59px 29px 30px);</span>
<a href="#l83.16"></a><span id="l83.16"> }</span>
<a href="#l83.17"></a><span id="l83.17"> </span>
<a href="#l83.18"></a><span id="l83.18"> #button-security[disabled] {</span>
<a href="#l83.19"></a><span id="l83.19">   -moz-image-region: rect(0 89px 29px 60px) !important;</span>
<a href="#l83.20"></a><span id="l83.20"> }</span>
<a href="#l83.21"></a><span id="l83.21"> </span>
<a href="#l83.22"></a><span id="l83.22"> #msgcomposeWindow #signing-status {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1" class="difflineminus">--- a/suite/themes/classic/mac/navigator/navigator.css</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineplus">+++ b/suite/themes/classic/mac/navigator/navigator.css</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineat">@@ -61,30 +61,32 @@</span>
<a href="#l84.4"></a><span id="l84.4"> </span>
<a href="#l84.5"></a><span id="l84.5"> /* ::::: primary toolbar buttons ::::: */</span>
<a href="#l84.6"></a><span id="l84.6"> </span>
<a href="#l84.7"></a><span id="l84.7"> #back-button {</span>
<a href="#l84.8"></a><span id="l84.8">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons.png&quot;);</span>
<a href="#l84.9"></a><span id="l84.9">   -moz-image-region: rect(60px 29px 89px 0);</span>
<a href="#l84.10"></a><span id="l84.10"> }</span>
<a href="#l84.11"></a><span id="l84.11"> </span>
<a href="#l84.12"></a><span id="l84.12" class="difflineminus">-#back-button:hover:active {</span>
<a href="#l84.13"></a><span id="l84.13" class="difflineplus">+#back-button:hover:active,</span>
<a href="#l84.14"></a><span id="l84.14" class="difflineplus">+#back-button[open] {</span>
<a href="#l84.15"></a><span id="l84.15">   -moz-image-region: rect(60px 59px 89px 30px);</span>
<a href="#l84.16"></a><span id="l84.16"> }</span>
<a href="#l84.17"></a><span id="l84.17"> </span>
<a href="#l84.18"></a><span id="l84.18"> #back-button[disabled=&quot;true&quot;] {</span>
<a href="#l84.19"></a><span id="l84.19">   -moz-image-region: rect(60px 89px 89px 60px) !important;</span>
<a href="#l84.20"></a><span id="l84.20"> }</span>
<a href="#l84.21"></a><span id="l84.21"> </span>
<a href="#l84.22"></a><span id="l84.22"> #forward-button {</span>
<a href="#l84.23"></a><span id="l84.23">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons.png&quot;);</span>
<a href="#l84.24"></a><span id="l84.24">   -moz-image-region: rect(90px 29px 119px 0);</span>
<a href="#l84.25"></a><span id="l84.25"> }</span>
<a href="#l84.26"></a><span id="l84.26"> </span>
<a href="#l84.27"></a><span id="l84.27" class="difflineminus">-#forward-button:hover:active {</span>
<a href="#l84.28"></a><span id="l84.28" class="difflineplus">+#forward-button:hover:active,</span>
<a href="#l84.29"></a><span id="l84.29" class="difflineplus">+#forward-button[open] {</span>
<a href="#l84.30"></a><span id="l84.30">   -moz-image-region: rect(90px 59px 119px 30px);</span>
<a href="#l84.31"></a><span id="l84.31"> }</span>
<a href="#l84.32"></a><span id="l84.32"> </span>
<a href="#l84.33"></a><span id="l84.33"> #forward-button[disabled=&quot;true&quot;] {</span>
<a href="#l84.34"></a><span id="l84.34">   -moz-image-region: rect(90px 89px 119px 60px) !important;</span>
<a href="#l84.35"></a><span id="l84.35"> }</span>
<a href="#l84.36"></a><span id="l84.36"> </span>
<a href="#l84.37"></a><span id="l84.37"> #reload-button {</span>
<a href="#l84.38"></a><span id="l84.38" class="difflineat">@@ -113,17 +115,18 @@</span>
<a href="#l84.39"></a><span id="l84.39">   -moz-image-region: rect(30px 89px 59px 60px) !important;</span>
<a href="#l84.40"></a><span id="l84.40"> }</span>
<a href="#l84.41"></a><span id="l84.41"> </span>
<a href="#l84.42"></a><span id="l84.42"> #print-button {</span>
<a href="#l84.43"></a><span id="l84.43">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons.png&quot;);</span>
<a href="#l84.44"></a><span id="l84.44">   -moz-image-region: rect(0 29px 29px 0);</span>
<a href="#l84.45"></a><span id="l84.45"> }</span>
<a href="#l84.46"></a><span id="l84.46"> </span>
<a href="#l84.47"></a><span id="l84.47" class="difflineminus">-#print-button:not([disabled=&quot;true&quot;]):hover:active {</span>
<a href="#l84.48"></a><span id="l84.48" class="difflineplus">+#print-button:hover:active,</span>
<a href="#l84.49"></a><span id="l84.49" class="difflineplus">+#print-button[open] {</span>
<a href="#l84.50"></a><span id="l84.50">   -moz-image-region: rect(0 59px 29px 30px);</span>
<a href="#l84.51"></a><span id="l84.51"> }</span>
<a href="#l84.52"></a><span id="l84.52"> </span>
<a href="#l84.53"></a><span id="l84.53"> #print-button[disabled=&quot;true&quot;] {</span>
<a href="#l84.54"></a><span id="l84.54">   -moz-image-region: rect(0 89px 29px 60px) !important;</span>
<a href="#l84.55"></a><span id="l84.55"> }</span>
<a href="#l84.56"></a><span id="l84.56"> </span>
<a href="#l84.57"></a><span id="l84.57"> #home-button {</span>
<a href="#l84.58"></a><span id="l84.58" class="difflineat">@@ -142,102 +145,93 @@</span>
<a href="#l84.59"></a><span id="l84.59"> /* ::::: small primary toolbar buttons ::::: */</span>
<a href="#l84.60"></a><span id="l84.60"> </span>
<a href="#l84.61"></a><span id="l84.61"> toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #back-button,</span>
<a href="#l84.62"></a><span id="l84.62"> toolbar[iconsize=&quot;small&quot;] &gt; #back-button {</span>
<a href="#l84.63"></a><span id="l84.63">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons-small.png&quot;);</span>
<a href="#l84.64"></a><span id="l84.64">   -moz-image-region: rect(40px 19px 59px 0);</span>
<a href="#l84.65"></a><span id="l84.65"> }</span>
<a href="#l84.66"></a><span id="l84.66"> </span>
<a href="#l84.67"></a><span id="l84.67" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #back-button:hover:active,</span>
<a href="#l84.68"></a><span id="l84.68" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #back-button:hover:active {</span>
<a href="#l84.69"></a><span id="l84.69" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #back-button:hover:active,</span>
<a href="#l84.70"></a><span id="l84.70" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #back-button[open] {</span>
<a href="#l84.71"></a><span id="l84.71">   -moz-image-region: rect(40px 39px 59px 20px);</span>
<a href="#l84.72"></a><span id="l84.72"> }</span>
<a href="#l84.73"></a><span id="l84.73"> </span>
<a href="#l84.74"></a><span id="l84.74" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #back-button[disabled=&quot;true&quot;],</span>
<a href="#l84.75"></a><span id="l84.75"> toolbar[iconsize=&quot;small&quot;] &gt; #back-button[disabled=&quot;true&quot;] {</span>
<a href="#l84.76"></a><span id="l84.76">   -moz-image-region: rect(40px 59px 59px 40px) !important;</span>
<a href="#l84.77"></a><span id="l84.77"> }</span>
<a href="#l84.78"></a><span id="l84.78"> </span>
<a href="#l84.79"></a><span id="l84.79"> toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #forward-button,</span>
<a href="#l84.80"></a><span id="l84.80"> toolbar[iconsize=&quot;small&quot;] &gt; #forward-button {</span>
<a href="#l84.81"></a><span id="l84.81">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons-small.png&quot;);</span>
<a href="#l84.82"></a><span id="l84.82">   -moz-image-region: rect(60px 19px 79px 0);</span>
<a href="#l84.83"></a><span id="l84.83"> }</span>
<a href="#l84.84"></a><span id="l84.84"> </span>
<a href="#l84.85"></a><span id="l84.85" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #forward-button:hover:active,</span>
<a href="#l84.86"></a><span id="l84.86" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #forward-button:hover:active {</span>
<a href="#l84.87"></a><span id="l84.87" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #forward-button:hover:active,</span>
<a href="#l84.88"></a><span id="l84.88" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #forward-button[open] {</span>
<a href="#l84.89"></a><span id="l84.89">   -moz-image-region: rect(60px 39px 79px 20px);</span>
<a href="#l84.90"></a><span id="l84.90"> }</span>
<a href="#l84.91"></a><span id="l84.91"> </span>
<a href="#l84.92"></a><span id="l84.92" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #forward-button[disabled=&quot;true&quot;],</span>
<a href="#l84.93"></a><span id="l84.93"> toolbar[iconsize=&quot;small&quot;] &gt; #forward-button[disabled=&quot;true&quot;] {</span>
<a href="#l84.94"></a><span id="l84.94">   -moz-image-region: rect(60px 59px 79px 40px) !important;</span>
<a href="#l84.95"></a><span id="l84.95"> }</span>
<a href="#l84.96"></a><span id="l84.96"> </span>
<a href="#l84.97"></a><span id="l84.97"> toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #reload-button,</span>
<a href="#l84.98"></a><span id="l84.98"> toolbar[iconsize=&quot;small&quot;] &gt; #reload-button {</span>
<a href="#l84.99"></a><span id="l84.99">   list-style-image: url(&quot;chrome://navigator/skin/icons/navigatoricons-small.png&quot;);</span>
<a href="#l84.100"></a><span id="l84.100">   -moz-image-region: rect(0 19px 19px 0);</span>
<a href="#l84.101"></a><span id="l84.101"> }</span>
<a href="#l84.102"></a><span id="l84.102"> </span>
<a href="#l84.103"></a><span id="l84.103" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #reload-button:hover:active,</span>
<a href="#l84.104"></a><span id="l84.104"> toolbar[iconsize=&quot;small&quot;] &gt; #reload-button:hover:active {</span>
<a href="#l84.105"></a><span id="l84.105">   -moz-image-region: rect(0 39px 19px 20px);</span>
<a href="#l84.106"></a><span id="l84.106"> }</span>
<a href="#l84.107"></a><span id="l84.107"> </span>
<a href="#l84.108"></a><span id="l84.108" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #reload-button[disabled=&quot;true&quot;],</span>
<a href="#l84.109"></a><span id="l84.109"> toolbar[iconsize=&quot;small&quot;] &gt; #reload-button[disabled=&quot;true&quot;] {</span>
<a href="#l84.110"></a><span id="l84.110">   -moz-image-region: rect(0 59px 19px 40px) !important;</span>
<a href="#l84.111"></a><span id="l84.111"> }</span>
<a href="#l84.112"></a><span id="l84.112"> </span>
<a href="#l84.113"></a><span id="l84.113"> toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #stop-button,</span>
<a href="#l84.114"></a><span id="l84.114"> toolbar[iconsize=&quot;small&quot;] &gt; #stop-button {</span>
<a href="#l84.115"></a><span id="l84.115">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons-small.png&quot;);</span>
<a href="#l84.116"></a><span id="l84.116">   -moz-image-region: rect(20px 19px 39px 0);</span>
<a href="#l84.117"></a><span id="l84.117"> }</span>
<a href="#l84.118"></a><span id="l84.118"> </span>
<a href="#l84.119"></a><span id="l84.119" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #stop-button:hover:active,</span>
<a href="#l84.120"></a><span id="l84.120"> toolbar[iconsize=&quot;small&quot;] &gt; #stop-button:hover:active {</span>
<a href="#l84.121"></a><span id="l84.121">   -moz-image-region: rect(20px 39px 39px 20px);</span>
<a href="#l84.122"></a><span id="l84.122"> }</span>
<a href="#l84.123"></a><span id="l84.123"> </span>
<a href="#l84.124"></a><span id="l84.124" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #stop-button[disabled=&quot;true&quot;],</span>
<a href="#l84.125"></a><span id="l84.125"> toolbar[iconsize=&quot;small&quot;] &gt; #stop-button[disabled=&quot;true&quot;] {</span>
<a href="#l84.126"></a><span id="l84.126">   -moz-image-region: rect(20px 59px 39px 40px) !important;</span>
<a href="#l84.127"></a><span id="l84.127"> }</span>
<a href="#l84.128"></a><span id="l84.128"> </span>
<a href="#l84.129"></a><span id="l84.129"> toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #print-button,</span>
<a href="#l84.130"></a><span id="l84.130"> toolbar[iconsize=&quot;small&quot;] &gt; #print-button {</span>
<a href="#l84.131"></a><span id="l84.131">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons-small.png&quot;);</span>
<a href="#l84.132"></a><span id="l84.132">   -moz-image-region: rect(0 19px 19px 0);</span>
<a href="#l84.133"></a><span id="l84.133"> }</span>
<a href="#l84.134"></a><span id="l84.134"> </span>
<a href="#l84.135"></a><span id="l84.135" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #print-button:hover:active,</span>
<a href="#l84.136"></a><span id="l84.136" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; #print-button:hover:active {</span>
<a href="#l84.137"></a><span id="l84.137" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #print-button:hover:active,</span>
<a href="#l84.138"></a><span id="l84.138" class="difflineplus">+toolbar[iconsize=&quot;small&quot;] &gt; #print-button[open] {</span>
<a href="#l84.139"></a><span id="l84.139">   -moz-image-region: rect(0 39px 19px 20px);</span>
<a href="#l84.140"></a><span id="l84.140"> }</span>
<a href="#l84.141"></a><span id="l84.141"> </span>
<a href="#l84.142"></a><span id="l84.142" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #print-button[disabled=&quot;true&quot;],</span>
<a href="#l84.143"></a><span id="l84.143"> toolbar[iconsize=&quot;small&quot;] &gt; #print-button[disabled=&quot;true&quot;] {</span>
<a href="#l84.144"></a><span id="l84.144">   -moz-image-region: rect(0 59px 19px 40px) !important;</span>
<a href="#l84.145"></a><span id="l84.145"> }</span>
<a href="#l84.146"></a><span id="l84.146"> </span>
<a href="#l84.147"></a><span id="l84.147"> toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #home-button,</span>
<a href="#l84.148"></a><span id="l84.148"> toolbar[iconsize=&quot;small&quot;] &gt; #home-button {</span>
<a href="#l84.149"></a><span id="l84.149">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons-small.png&quot;);</span>
<a href="#l84.150"></a><span id="l84.150">   -moz-image-region: rect(80px 19px 99px 0);</span>
<a href="#l84.151"></a><span id="l84.151"> }</span>
<a href="#l84.152"></a><span id="l84.152"> </span>
<a href="#l84.153"></a><span id="l84.153" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #home-button:hover:active,</span>
<a href="#l84.154"></a><span id="l84.154"> toolbar[iconsize=&quot;small&quot;] &gt; #home-button:hover:active {</span>
<a href="#l84.155"></a><span id="l84.155">   -moz-image-region: rect(80px 39px 99px 20px);</span>
<a href="#l84.156"></a><span id="l84.156"> }</span>
<a href="#l84.157"></a><span id="l84.157"> </span>
<a href="#l84.158"></a><span id="l84.158" class="difflineminus">-toolbar[iconsize=&quot;small&quot;] &gt; toolbarpaletteitem &gt; #home-button[disabled=&quot;true&quot;],</span>
<a href="#l84.159"></a><span id="l84.159"> toolbar[iconsize=&quot;small&quot;] &gt; #home-button[disabled=&quot;true&quot;] {</span>
<a href="#l84.160"></a><span id="l84.160">   -moz-image-region: rect(80px 59px 99px 40px) !important;</span>
<a href="#l84.161"></a><span id="l84.161"> }</span>
<a href="#l84.162"></a><span id="l84.162"> </span>
<a href="#l84.163"></a><span id="l84.163"> /* ::::: fullscreen window controls ::::: */</span>
<a href="#l84.164"></a><span id="l84.164"> </span>
<a href="#l84.165"></a><span id="l84.165"> #window-controls {</span>
<a href="#l84.166"></a><span id="l84.166">   -moz-box-align: center;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1" class="difflineminus">--- a/suite/themes/modern/communicator/preferences.css</span>
<a href="#l85.2"></a><span id="l85.2" class="difflineplus">+++ b/suite/themes/modern/communicator/preferences.css</span>
<a href="#l85.3"></a><span id="l85.3" class="difflineat">@@ -44,47 +44,8 @@</span>
<a href="#l85.4"></a><span id="l85.4"> prefwindow {</span>
<a href="#l85.5"></a><span id="l85.5">   padding: 7px 5px 5px;</span>
<a href="#l85.6"></a><span id="l85.6"> }</span>
<a href="#l85.7"></a><span id="l85.7"> </span>
<a href="#l85.8"></a><span id="l85.8"> prefpane,</span>
<a href="#l85.9"></a><span id="l85.9"> .prefWindow-dlgbuttons {</span>
<a href="#l85.10"></a><span id="l85.10">   padding: 0px;</span>
<a href="#l85.11"></a><span id="l85.11"> }</span>
<a href="#l85.12"></a><span id="l85.12" class="difflineminus">-</span>
<a href="#l85.13"></a><span id="l85.13" class="difflineminus">-/* File Field Widget */</span>
<a href="#l85.14"></a><span id="l85.14" class="difflineminus">-filefield {</span>
<a href="#l85.15"></a><span id="l85.15" class="difflineminus">-  margin: 2px 4px;</span>
<a href="#l85.16"></a><span id="l85.16" class="difflineminus">-  border: 2px solid;</span>
<a href="#l85.17"></a><span id="l85.17" class="difflineminus">-  -moz-border-top-colors: #BEC3D3 #5D616E;</span>
<a href="#l85.18"></a><span id="l85.18" class="difflineminus">-  -moz-border-right-colors: #F8FAFE #5D616E;</span>
<a href="#l85.19"></a><span id="l85.19" class="difflineminus">-  -moz-border-bottom-colors: #F8FAFE #5D616E;</span>
<a href="#l85.20"></a><span id="l85.20" class="difflineminus">-  -moz-border-left-colors: #BEC3D3 #5D616E;</span>
<a href="#l85.21"></a><span id="l85.21" class="difflineminus">-}</span>
<a href="#l85.22"></a><span id="l85.22" class="difflineminus">-</span>
<a href="#l85.23"></a><span id="l85.23" class="difflineminus">-.fileFieldContentBox {</span>
<a href="#l85.24"></a><span id="l85.24" class="difflineminus">-  background-color: #C7D0D9;</span>
<a href="#l85.25"></a><span id="l85.25" class="difflineminus">-}</span>
<a href="#l85.26"></a><span id="l85.26" class="difflineminus">-</span>
<a href="#l85.27"></a><span id="l85.27" class="difflineminus">-filefield[disabled=&quot;true&quot;] {</span>
<a href="#l85.28"></a><span id="l85.28" class="difflineminus">-  -moz-border-top-colors: #BEC3D3 #98A5B2;</span>
<a href="#l85.29"></a><span id="l85.29" class="difflineminus">-  -moz-border-right-colors: #F8FAFE #98A5B2;</span>
<a href="#l85.30"></a><span id="l85.30" class="difflineminus">-  -moz-border-bottom-colors: #F8FAFE #98A5B2;</span>
<a href="#l85.31"></a><span id="l85.31" class="difflineminus">-  -moz-border-left-colors: #BEC3D3 #98A5B2;</span>
<a href="#l85.32"></a><span id="l85.32" class="difflineminus">-}</span>
<a href="#l85.33"></a><span id="l85.33" class="difflineminus">-</span>
<a href="#l85.34"></a><span id="l85.34" class="difflineminus">-.fileFieldIcon[disabled=&quot;true&quot;] {</span>
<a href="#l85.35"></a><span id="l85.35" class="difflineminus">- opacity: 0.4;</span>
<a href="#l85.36"></a><span id="l85.36" class="difflineminus">-}</span>
<a href="#l85.37"></a><span id="l85.37" class="difflineminus">-</span>
<a href="#l85.38"></a><span id="l85.38" class="difflineminus">-.fileFieldIcon {</span>
<a href="#l85.39"></a><span id="l85.39" class="difflineminus">-  width: 16px;</span>
<a href="#l85.40"></a><span id="l85.40" class="difflineminus">-  height: 16px;</span>
<a href="#l85.41"></a><span id="l85.41" class="difflineminus">-  margin-top: 1px;</span>
<a href="#l85.42"></a><span id="l85.42" class="difflineminus">-  margin-bottom: 1px;</span>
<a href="#l85.43"></a><span id="l85.43" class="difflineminus">-  -moz-margin-start: 1px;</span>
<a href="#l85.44"></a><span id="l85.44" class="difflineminus">-  -moz-margin-end: 4px;</span>
<a href="#l85.45"></a><span id="l85.45" class="difflineminus">-}</span>
<a href="#l85.46"></a><span id="l85.46" class="difflineminus">-</span>
<a href="#l85.47"></a><span id="l85.47" class="difflineminus">-.fileFieldLabel {</span>
<a href="#l85.48"></a><span id="l85.48" class="difflineminus">-  border: none;</span>
<a href="#l85.49"></a><span id="l85.49" class="difflineminus">-  margin: 0px;</span>
<a href="#l85.50"></a><span id="l85.50" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1">copy from suite/themes/modern/communicator/preferences.css</span>
<a href="#l86.2"></a><span id="l86.2">copy to suite/themes/modern/global/filefield.css</span>
<a href="#l86.3"></a><span id="l86.3" class="difflineminus">--- a/suite/themes/modern/communicator/preferences.css</span>
<a href="#l86.4"></a><span id="l86.4" class="difflineplus">+++ b/suite/themes/modern/global/filefield.css</span>
<a href="#l86.5"></a><span id="l86.5" class="difflineat">@@ -6,55 +6,41 @@</span>
<a href="#l86.6"></a><span id="l86.6">  * the License. You may obtain a copy of the License at</span>
<a href="#l86.7"></a><span id="l86.7">  * http://www.mozilla.org/MPL/</span>
<a href="#l86.8"></a><span id="l86.8">  *</span>
<a href="#l86.9"></a><span id="l86.9">  * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l86.10"></a><span id="l86.10">  * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l86.11"></a><span id="l86.11">  * for the specific language governing rights and limitations under the</span>
<a href="#l86.12"></a><span id="l86.12">  * License.</span>
<a href="#l86.13"></a><span id="l86.13">  *</span>
<a href="#l86.14"></a><span id="l86.14" class="difflineminus">- * The Original Code is SeaMonkey prefwindow code.</span>
<a href="#l86.15"></a><span id="l86.15" class="difflineplus">+ * The Original Code is SeaMonkey filefield code.</span>
<a href="#l86.16"></a><span id="l86.16">  *</span>
<a href="#l86.17"></a><span id="l86.17">  * The Initial Developer of the Original Code is the SeaMonkey project.</span>
<a href="#l86.18"></a><span id="l86.18" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l86.19"></a><span id="l86.19" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l86.20"></a><span id="l86.20">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l86.21"></a><span id="l86.21">  *</span>
<a href="#l86.22"></a><span id="l86.22">  * Contributor(s):</span>
<a href="#l86.23"></a><span id="l86.23" class="difflineminus">- *   Karsten Düsterloh &lt;mnyromyr@tprac.de&gt;</span>
<a href="#l86.24"></a><span id="l86.24">  *   Ian Neal &lt;iann_bugzilla@blueyonder.co.uk&gt;</span>
<a href="#l86.25"></a><span id="l86.25">  *</span>
<a href="#l86.26"></a><span id="l86.26">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l86.27"></a><span id="l86.27">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l86.28"></a><span id="l86.28">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l86.29"></a><span id="l86.29">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l86.30"></a><span id="l86.30">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l86.31"></a><span id="l86.31">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l86.32"></a><span id="l86.32">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l86.33"></a><span id="l86.33">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l86.34"></a><span id="l86.34">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l86.35"></a><span id="l86.35">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l86.36"></a><span id="l86.36">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l86.37"></a><span id="l86.37">  *</span>
<a href="#l86.38"></a><span id="l86.38">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l86.39"></a><span id="l86.39"> </span>
<a href="#l86.40"></a><span id="l86.40" class="difflineminus">-/* Styles used by all preference windows and panes of SeaMonkey */</span>
<a href="#l86.41"></a><span id="l86.41" class="difflineminus">-</span>
<a href="#l86.42"></a><span id="l86.42"> @namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l86.43"></a><span id="l86.43"> </span>
<a href="#l86.44"></a><span id="l86.44" class="difflineminus">-/* ::::: Main Window ::::: */</span>
<a href="#l86.45"></a><span id="l86.45" class="difflineminus">-</span>
<a href="#l86.46"></a><span id="l86.46" class="difflineminus">-prefwindow {</span>
<a href="#l86.47"></a><span id="l86.47" class="difflineminus">-  padding: 7px 5px 5px;</span>
<a href="#l86.48"></a><span id="l86.48" class="difflineminus">-}</span>
<a href="#l86.49"></a><span id="l86.49" class="difflineminus">-</span>
<a href="#l86.50"></a><span id="l86.50" class="difflineminus">-prefpane,</span>
<a href="#l86.51"></a><span id="l86.51" class="difflineminus">-.prefWindow-dlgbuttons {</span>
<a href="#l86.52"></a><span id="l86.52" class="difflineminus">-  padding: 0px;</span>
<a href="#l86.53"></a><span id="l86.53" class="difflineminus">-}</span>
<a href="#l86.54"></a><span id="l86.54" class="difflineminus">-</span>
<a href="#l86.55"></a><span id="l86.55"> /* File Field Widget */</span>
<a href="#l86.56"></a><span id="l86.56"> filefield {</span>
<a href="#l86.57"></a><span id="l86.57">   margin: 2px 4px;</span>
<a href="#l86.58"></a><span id="l86.58">   border: 2px solid;</span>
<a href="#l86.59"></a><span id="l86.59">   -moz-border-top-colors: #BEC3D3 #5D616E;</span>
<a href="#l86.60"></a><span id="l86.60">   -moz-border-right-colors: #F8FAFE #5D616E;</span>
<a href="#l86.61"></a><span id="l86.61">   -moz-border-bottom-colors: #F8FAFE #5D616E;</span>
<a href="#l86.62"></a><span id="l86.62">   -moz-border-left-colors: #BEC3D3 #5D616E;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1" class="difflineminus">--- a/suite/themes/modern/global/scrollbox.css</span>
<a href="#l87.2"></a><span id="l87.2" class="difflineplus">+++ b/suite/themes/modern/global/scrollbox.css</span>
<a href="#l87.3"></a><span id="l87.3" class="difflineat">@@ -37,37 +37,92 @@</span>
<a href="#l87.4"></a><span id="l87.4"> </span>
<a href="#l87.5"></a><span id="l87.5"> /* ===== arrowscrollbox.css =============================================</span>
<a href="#l87.6"></a><span id="l87.6">   == Styles used by the XUL arrowscrollbox and related elements.</span>
<a href="#l87.7"></a><span id="l87.7">   ======================================================================= */</span>
<a href="#l87.8"></a><span id="l87.8"> </span>
<a href="#l87.9"></a><span id="l87.9"> @namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l87.10"></a><span id="l87.10"> </span>
<a href="#l87.11"></a><span id="l87.11"> /* ::::: auto-repeat button ::::: */</span>
<a href="#l87.12"></a><span id="l87.12" class="difflineminus">- </span>
<a href="#l87.13"></a><span id="l87.13" class="difflineplus">+</span>
<a href="#l87.14"></a><span id="l87.14"> autorepeatbutton {</span>
<a href="#l87.15"></a><span id="l87.15">   -moz-box-align: center;</span>
<a href="#l87.16"></a><span id="l87.16">   -moz-box-pack: center;</span>
<a href="#l87.17"></a><span id="l87.17">   margin-top: 1px;</span>
<a href="#l87.18"></a><span id="l87.18">   margin-bottom: 2px;</span>
<a href="#l87.19"></a><span id="l87.19">   -moz-margin-start: 1px;</span>
<a href="#l87.20"></a><span id="l87.20">   -moz-margin-end: 2px;</span>
<a href="#l87.21"></a><span id="l87.21">   border: 1px solid transparent;</span>
<a href="#l87.22"></a><span id="l87.22">   padding: 3px;</span>
<a href="#l87.23"></a><span id="l87.23"> }</span>
<a href="#l87.24"></a><span id="l87.24"> </span>
<a href="#l87.25"></a><span id="l87.25" class="difflineminus">-autorepeatbutton:hover {</span>
<a href="#l87.26"></a><span id="l87.26" class="difflineplus">+autorepeatbutton:not([disabled=&quot;true&quot;]):hover {</span>
<a href="#l87.27"></a><span id="l87.27">   margin: 1px;</span>
<a href="#l87.28"></a><span id="l87.28">   border: 1px inset #A5B2C2;</span>
<a href="#l87.29"></a><span id="l87.29">   padding-top: 4px;</span>
<a href="#l87.30"></a><span id="l87.30">   padding-bottom: 3px;</span>
<a href="#l87.31"></a><span id="l87.31">   -moz-padding-start: 4px;</span>
<a href="#l87.32"></a><span id="l87.32">   -moz-padding-end: 3px;</span>
<a href="#l87.33"></a><span id="l87.33">   background-color: #A5B2C2;</span>
<a href="#l87.34"></a><span id="l87.34"> }</span>
<a href="#l87.35"></a><span id="l87.35"> </span>
<a href="#l87.36"></a><span id="l87.36" class="difflineminus">-.autorepeatbutton-up {</span>
<a href="#l87.37"></a><span id="l87.37" class="difflineplus">+.scrollbutton-up,</span>
<a href="#l87.38"></a><span id="l87.38" class="difflineplus">+.scrollbutton-down {</span>
<a href="#l87.39"></a><span id="l87.39" class="difflineplus">+  -moz-box-align: center;</span>
<a href="#l87.40"></a><span id="l87.40" class="difflineplus">+  -moz-box-pack: center;</span>
<a href="#l87.41"></a><span id="l87.41" class="difflineplus">+}</span>
<a href="#l87.42"></a><span id="l87.42" class="difflineplus">+</span>
<a href="#l87.43"></a><span id="l87.43" class="difflineplus">+.scrollbutton-up &gt; .toolbarbutton-text,</span>
<a href="#l87.44"></a><span id="l87.44" class="difflineplus">+.scrollbutton-down &gt; .toolbarbutton-text {</span>
<a href="#l87.45"></a><span id="l87.45" class="difflineplus">+  display: none;</span>
<a href="#l87.46"></a><span id="l87.46" class="difflineplus">+}</span>
<a href="#l87.47"></a><span id="l87.47" class="difflineplus">+</span>
<a href="#l87.48"></a><span id="l87.48" class="difflineplus">+/* Vertical enabled */</span>
<a href="#l87.49"></a><span id="l87.49" class="difflineplus">+.autorepeatbutton-up,</span>
<a href="#l87.50"></a><span id="l87.50" class="difflineplus">+.scrollbutton-up {</span>
<a href="#l87.51"></a><span id="l87.51">   list-style-image: url(&quot;chrome://global/skin/arrow/arrow-up.gif&quot;)</span>
<a href="#l87.52"></a><span id="l87.52"> }</span>
<a href="#l87.53"></a><span id="l87.53"> </span>
<a href="#l87.54"></a><span id="l87.54" class="difflineminus">-.autorepeatbutton-down {</span>
<a href="#l87.55"></a><span id="l87.55" class="difflineplus">+.autorepeatbutton-down,</span>
<a href="#l87.56"></a><span id="l87.56" class="difflineplus">+.scrollbutton-down {</span>
<a href="#l87.57"></a><span id="l87.57">   list-style-image: url(&quot;chrome://global/skin/arrow/arrow-dn.gif&quot;)</span>
<a href="#l87.58"></a><span id="l87.58"> }</span>
<a href="#l87.59"></a><span id="l87.59" class="difflineplus">+</span>
<a href="#l87.60"></a><span id="l87.60" class="difflineplus">+/* Vertical disabled */</span>
<a href="#l87.61"></a><span id="l87.61" class="difflineplus">+.autorepeatbutton-up[disabled=&quot;true&quot;],</span>
<a href="#l87.62"></a><span id="l87.62" class="difflineplus">+.scrollbutton-up[disabled=&quot;true&quot;] {</span>
<a href="#l87.63"></a><span id="l87.63" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/arrow/arrow-up-dis.gif&quot;);</span>
<a href="#l87.64"></a><span id="l87.64" class="difflineplus">+}</span>
<a href="#l87.65"></a><span id="l87.65" class="difflineplus">+</span>
<a href="#l87.66"></a><span id="l87.66" class="difflineplus">+.autorepeatbutton-down[disabled=&quot;true&quot;],</span>
<a href="#l87.67"></a><span id="l87.67" class="difflineplus">+.scrollbutton-down[disabled=&quot;true&quot;] {</span>
<a href="#l87.68"></a><span id="l87.68" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/arrow/arrow-dn-dis.gif&quot;);</span>
<a href="#l87.69"></a><span id="l87.69" class="difflineplus">+}</span>
<a href="#l87.70"></a><span id="l87.70" class="difflineplus">+</span>
<a href="#l87.71"></a><span id="l87.71" class="difflineplus">+/* Horizontal enabled */</span>
<a href="#l87.72"></a><span id="l87.72" class="difflineplus">+.autorepeatbutton-up[orient=&quot;horizontal&quot;],</span>
<a href="#l87.73"></a><span id="l87.73" class="difflineplus">+.autorepeatbutton-down[orient=&quot;horizontal&quot;][chromedir=&quot;rtl&quot;],</span>
<a href="#l87.74"></a><span id="l87.74" class="difflineplus">+.scrollbutton-up[orient=&quot;horizontal&quot;],</span>
<a href="#l87.75"></a><span id="l87.75" class="difflineplus">+.scrollbutton-down[orient=&quot;horizontal&quot;][chromedir=&quot;rtl&quot;] {</span>
<a href="#l87.76"></a><span id="l87.76" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/arrow/arrow-lft.gif&quot;);</span>
<a href="#l87.77"></a><span id="l87.77" class="difflineplus">+}</span>
<a href="#l87.78"></a><span id="l87.78" class="difflineplus">+</span>
<a href="#l87.79"></a><span id="l87.79" class="difflineplus">+.autorepeatbutton-down[orient=&quot;horizontal&quot;],</span>
<a href="#l87.80"></a><span id="l87.80" class="difflineplus">+.autorepeatbutton-up[orient=&quot;horizontal&quot;][chromedir=&quot;rtl&quot;],</span>
<a href="#l87.81"></a><span id="l87.81" class="difflineplus">+.scrollbutton-down[orient=&quot;horizontal&quot;],</span>
<a href="#l87.82"></a><span id="l87.82" class="difflineplus">+.scrollbutton-up[orient=&quot;horizontal&quot;][chromedir=&quot;rtl&quot;] {</span>
<a href="#l87.83"></a><span id="l87.83" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/arrow/arrow-rit.gif&quot;);</span>
<a href="#l87.84"></a><span id="l87.84" class="difflineplus">+}</span>
<a href="#l87.85"></a><span id="l87.85" class="difflineplus">+</span>
<a href="#l87.86"></a><span id="l87.86" class="difflineplus">+ /* Horizontal disabled */</span>
<a href="#l87.87"></a><span id="l87.87" class="difflineplus">+.autorepeatbutton-up[orient=&quot;horizontal&quot;][disabled=&quot;true&quot;],</span>
<a href="#l87.88"></a><span id="l87.88" class="difflineplus">+.autorepeatbutton-down[orient=&quot;horizontal&quot;][chromedir=&quot;rtl&quot;][disabled=&quot;true&quot;],</span>
<a href="#l87.89"></a><span id="l87.89" class="difflineplus">+.scrollbutton-up[orient=&quot;horizontal&quot;][disabled=&quot;true&quot;],</span>
<a href="#l87.90"></a><span id="l87.90" class="difflineplus">+.scrollbutton-down[orient=&quot;horizontal&quot;][chromedir=&quot;rtl&quot;][disabled=&quot;true&quot;] {</span>
<a href="#l87.91"></a><span id="l87.91" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/arrow/arrow-lft-dis.gif&quot;);</span>
<a href="#l87.92"></a><span id="l87.92" class="difflineplus">+}</span>
<a href="#l87.93"></a><span id="l87.93" class="difflineplus">+</span>
<a href="#l87.94"></a><span id="l87.94" class="difflineplus">+.autorepeatbutton-down[orient=&quot;horizontal&quot;][disabled=&quot;true&quot;],</span>
<a href="#l87.95"></a><span id="l87.95" class="difflineplus">+.autorepeatbutton-up[orient=&quot;horizontal&quot;][chromedir=&quot;rtl&quot;][disabled=&quot;true&quot;],</span>
<a href="#l87.96"></a><span id="l87.96" class="difflineplus">+.scrollbutton-down[orient=&quot;horizontal&quot;][disabled=&quot;true&quot;],</span>
<a href="#l87.97"></a><span id="l87.97" class="difflineplus">+.scrollbutton-up[orient=&quot;horizontal&quot;][chromedir=&quot;rtl&quot;][disabled=&quot;true&quot;] {</span>
<a href="#l87.98"></a><span id="l87.98" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/arrow/arrow-rit-dis.gif&quot;);</span>
<a href="#l87.99"></a><span id="l87.99" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1" class="difflineminus">--- a/suite/themes/modern/global/textbox.css</span>
<a href="#l88.2"></a><span id="l88.2" class="difflineplus">+++ b/suite/themes/modern/global/textbox.css</span>
<a href="#l88.3"></a><span id="l88.3" class="difflineat">@@ -35,17 +35,17 @@</span>
<a href="#l88.4"></a><span id="l88.4">  *</span>
<a href="#l88.5"></a><span id="l88.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l88.6"></a><span id="l88.6"> </span>
<a href="#l88.7"></a><span id="l88.7"> /* ===== textbox.css ==================================================</span>
<a href="#l88.8"></a><span id="l88.8">   == Styles used by the XUL textbox element.</span>
<a href="#l88.9"></a><span id="l88.9">   ======================================================================= */</span>
<a href="#l88.10"></a><span id="l88.10"> </span>
<a href="#l88.11"></a><span id="l88.11"> @import url(&quot;chrome://global/content/autocomplete.css&quot;);</span>
<a href="#l88.12"></a><span id="l88.12" class="difflineminus">-  </span>
<a href="#l88.13"></a><span id="l88.13" class="difflineplus">+</span>
<a href="#l88.14"></a><span id="l88.14"> @namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l88.15"></a><span id="l88.15"> @namespace html url(&quot;http://www.w3.org/1999/xhtml&quot;); /* namespace for HTML elements */</span>
<a href="#l88.16"></a><span id="l88.16"> </span>
<a href="#l88.17"></a><span id="l88.17"> /* ::::: textbox ::::: */</span>
<a href="#l88.18"></a><span id="l88.18"> </span>
<a href="#l88.19"></a><span id="l88.19"> textbox {</span>
<a href="#l88.20"></a><span id="l88.20">   margin: 2px 4px;</span>
<a href="#l88.21"></a><span id="l88.21">   border: 2px solid;</span>
<a href="#l88.22"></a><span id="l88.22" class="difflineat">@@ -53,56 +53,61 @@ textbox {</span>
<a href="#l88.23"></a><span id="l88.23">   padding-bottom: 1px;</span>
<a href="#l88.24"></a><span id="l88.24">   -moz-padding-start: 2px;</span>
<a href="#l88.25"></a><span id="l88.25">   -moz-padding-end: 0px;</span>
<a href="#l88.26"></a><span id="l88.26">   background-color: #FFFFFF;</span>
<a href="#l88.27"></a><span id="l88.27">   color: #000000;</span>
<a href="#l88.28"></a><span id="l88.28">   font: inherit;</span>
<a href="#l88.29"></a><span id="l88.29"> }</span>
<a href="#l88.30"></a><span id="l88.30"> </span>
<a href="#l88.31"></a><span id="l88.31" class="difflineplus">+textbox[empty=&quot;true&quot;],</span>
<a href="#l88.32"></a><span id="l88.32" class="difflineplus">+textbox[isempty=&quot;true&quot;] {</span>
<a href="#l88.33"></a><span id="l88.33" class="difflineplus">+  color: #999999;</span>
<a href="#l88.34"></a><span id="l88.34" class="difflineplus">+}</span>
<a href="#l88.35"></a><span id="l88.35" class="difflineplus">+</span>
<a href="#l88.36"></a><span id="l88.36"> textbox,</span>
<a href="#l88.37"></a><span id="l88.37"> textbox[readonly=&quot;true&quot;][focused=&quot;true&quot;] {</span>
<a href="#l88.38"></a><span id="l88.38">   -moz-border-top-colors: #BEC3D3 #5D616E;</span>
<a href="#l88.39"></a><span id="l88.39">   -moz-border-right-colors: #F8FAFE #5D616E;</span>
<a href="#l88.40"></a><span id="l88.40">   -moz-border-bottom-colors: #F8FAFE #5D616E;</span>
<a href="#l88.41"></a><span id="l88.41">   -moz-border-left-colors: #BEC3D3 #5D616E;</span>
<a href="#l88.42"></a><span id="l88.42"> }</span>
<a href="#l88.43"></a><span id="l88.43"> </span>
<a href="#l88.44"></a><span id="l88.44" class="difflineminus">-html|*.textbox-input, </span>
<a href="#l88.45"></a><span id="l88.45" class="difflineplus">+html|*.textbox-input,</span>
<a href="#l88.46"></a><span id="l88.46"> html|*.textbox-textarea {</span>
<a href="#l88.47"></a><span id="l88.47">   cursor: text;</span>
<a href="#l88.48"></a><span id="l88.48">   margin: 0px !important;</span>
<a href="#l88.49"></a><span id="l88.49">   border: none !important;</span>
<a href="#l88.50"></a><span id="l88.50">   padding: 0px !important;</span>
<a href="#l88.51"></a><span id="l88.51">   background-color: inherit;</span>
<a href="#l88.52"></a><span id="l88.52">   color: inherit;</span>
<a href="#l88.53"></a><span id="l88.53">   font: inherit;</span>
<a href="#l88.54"></a><span id="l88.54"> }</span>
<a href="#l88.55"></a><span id="l88.55"> </span>
<a href="#l88.56"></a><span id="l88.56"> /* ..... focused state ..... */</span>
<a href="#l88.57"></a><span id="l88.57" class="difflineminus">-  </span>
<a href="#l88.58"></a><span id="l88.58" class="difflineplus">+</span>
<a href="#l88.59"></a><span id="l88.59"> textbox[focused=&quot;true&quot;] {</span>
<a href="#l88.60"></a><span id="l88.60">   -moz-border-top-colors: #98A5B2 #000000;</span>
<a href="#l88.61"></a><span id="l88.61">   -moz-border-right-colors: #98A5B2 #000000;</span>
<a href="#l88.62"></a><span id="l88.62">   -moz-border-bottom-colors: #98A5B2 #000000;</span>
<a href="#l88.63"></a><span id="l88.63">   -moz-border-left-colors: #98A5B2 #000000;</span>
<a href="#l88.64"></a><span id="l88.64"> }</span>
<a href="#l88.65"></a><span id="l88.65" class="difflineminus">-    </span>
<a href="#l88.66"></a><span id="l88.66" class="difflineplus">+</span>
<a href="#l88.67"></a><span id="l88.67"> /* ..... disabled state ..... */</span>
<a href="#l88.68"></a><span id="l88.68"> </span>
<a href="#l88.69"></a><span id="l88.69"> textbox[disabled=&quot;true&quot;] {</span>
<a href="#l88.70"></a><span id="l88.70">   -moz-border-top-colors: #BEC3D3 #98A5B2;</span>
<a href="#l88.71"></a><span id="l88.71">   -moz-border-right-colors: #F8FAFE #98A5B2;</span>
<a href="#l88.72"></a><span id="l88.72">   -moz-border-bottom-colors: #F8FAFE #98A5B2;</span>
<a href="#l88.73"></a><span id="l88.73">   -moz-border-left-colors: #BEC3D3 #98A5B2;</span>
<a href="#l88.74"></a><span id="l88.74">   background-color: #C7D0D9;</span>
<a href="#l88.75"></a><span id="l88.75">   color: #999999;</span>
<a href="#l88.76"></a><span id="l88.76">   cursor: default !important;</span>
<a href="#l88.77"></a><span id="l88.77" class="difflineminus">-} </span>
<a href="#l88.78"></a><span id="l88.78" class="difflineminus">-    </span>
<a href="#l88.79"></a><span id="l88.79" class="difflineplus">+}</span>
<a href="#l88.80"></a><span id="l88.80" class="difflineplus">+</span>
<a href="#l88.81"></a><span id="l88.81"> /* ..... readonly state ..... */</span>
<a href="#l88.82"></a><span id="l88.82"> </span>
<a href="#l88.83"></a><span id="l88.83"> textbox[readonly=&quot;true&quot;] {</span>
<a href="#l88.84"></a><span id="l88.84">   background-color: #C7D0D9;</span>
<a href="#l88.85"></a><span id="l88.85"> }</span>
<a href="#l88.86"></a><span id="l88.86"> </span>
<a href="#l88.87"></a><span id="l88.87"> /* ::::: plain textbox ::::: */</span>
<a href="#l88.88"></a><span id="l88.88"> </span>
<a href="#l88.89"></a><span id="l88.89" class="difflineat">@@ -123,25 +128,31 @@ textbox.plain {</span>
<a href="#l88.90"></a><span id="l88.90">   list-style-image: url(&quot;chrome://global/skin/icons/closebox.gif&quot;);</span>
<a href="#l88.91"></a><span id="l88.91"> }</span>
<a href="#l88.92"></a><span id="l88.92"> </span>
<a href="#l88.93"></a><span id="l88.93"> /* ::::: scrollable textbox ::::: */</span>
<a href="#l88.94"></a><span id="l88.94"> </span>
<a href="#l88.95"></a><span id="l88.95"> .scrollfield {</span>
<a href="#l88.96"></a><span id="l88.96">   border: none !important;</span>
<a href="#l88.97"></a><span id="l88.97">   margin: 0px;</span>
<a href="#l88.98"></a><span id="l88.98" class="difflineminus">-  margin-top: 1px;      </span>
<a href="#l88.99"></a><span id="l88.99" class="difflineplus">+  margin-top: 1px;</span>
<a href="#l88.100"></a><span id="l88.100">   padding: 0px !important;</span>
<a href="#l88.101"></a><span id="l88.101">   background: inherit;</span>
<a href="#l88.102"></a><span id="l88.102" class="difflineminus">-}    </span>
<a href="#l88.103"></a><span id="l88.103" class="difflineminus">-    </span>
<a href="#l88.104"></a><span id="l88.104" class="difflineplus">+}</span>
<a href="#l88.105"></a><span id="l88.105" class="difflineplus">+</span>
<a href="#l88.106"></a><span id="l88.106"> .scrollfield &gt; .textbox-internal-box {</span>
<a href="#l88.107"></a><span id="l88.107">   border: none !important;</span>
<a href="#l88.108"></a><span id="l88.108">   margin: 0px !important;</span>
<a href="#l88.109"></a><span id="l88.109">   padding: 0px !important;</span>
<a href="#l88.110"></a><span id="l88.110"> }</span>
<a href="#l88.111"></a><span id="l88.111"> </span>
<a href="#l88.112"></a><span id="l88.112"> /* ::::: inline-edit textbox ::::: */</span>
<a href="#l88.113"></a><span id="l88.113" class="difflineminus">-    </span>
<a href="#l88.114"></a><span id="l88.114" class="difflineplus">+</span>
<a href="#l88.115"></a><span id="l88.115"> .textbox-inline-edit {</span>
<a href="#l88.116"></a><span id="l88.116">   margin: 0px !important;</span>
<a href="#l88.117"></a><span id="l88.117">   border: 1px solid #000000 !important;</span>
<a href="#l88.118"></a><span id="l88.118"> }</span>
<a href="#l88.119"></a><span id="l88.119" class="difflineplus">+</span>
<a href="#l88.120"></a><span id="l88.120" class="difflineplus">+/* ::::: textboxes inside toolbarpaletteitems ::::: */</span>
<a href="#l88.121"></a><span id="l88.121" class="difflineplus">+</span>
<a href="#l88.122"></a><span id="l88.122" class="difflineplus">+toolbarpaletteitem &gt; toolbaritem &gt; textbox &gt; .textbox-input-box &gt; html|*.textbox-input {</span>
<a href="#l88.123"></a><span id="l88.123" class="difflineplus">+  visibility: hidden;</span>
<a href="#l88.124"></a><span id="l88.124" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1" class="difflineminus">--- a/suite/themes/modern/global/wizard.css</span>
<a href="#l89.2"></a><span id="l89.2" class="difflineplus">+++ b/suite/themes/modern/global/wizard.css</span>
<a href="#l89.3"></a><span id="l89.3" class="difflineat">@@ -31,35 +31,57 @@</span>
<a href="#l89.4"></a><span id="l89.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l89.5"></a><span id="l89.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l89.6"></a><span id="l89.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l89.7"></a><span id="l89.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l89.8"></a><span id="l89.8">  *</span>
<a href="#l89.9"></a><span id="l89.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l89.10"></a><span id="l89.10"> </span>
<a href="#l89.11"></a><span id="l89.11"> /* ===== wizard.css =====================================================</span>
<a href="#l89.12"></a><span id="l89.12" class="difflineminus">-  == Styles used by the wizards which contains buttons for stepping </span>
<a href="#l89.13"></a><span id="l89.13" class="difflineplus">+  == Styles used by the wizards which contains buttons for stepping</span>
<a href="#l89.14"></a><span id="l89.14">   == through a wizard.</span>
<a href="#l89.15"></a><span id="l89.15">   ======================================================================= */</span>
<a href="#l89.16"></a><span id="l89.16"> </span>
<a href="#l89.17"></a><span id="l89.17"> @namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l89.18"></a><span id="l89.18"> </span>
<a href="#l89.19"></a><span id="l89.19"> .wizard-header {</span>
<a href="#l89.20"></a><span id="l89.20">   border-top: 1px solid #94AACE;</span>
<a href="#l89.21"></a><span id="l89.21">   border-bottom: 1px solid #000000;</span>
<a href="#l89.22"></a><span id="l89.22">   padding: 10px 0px;</span>
<a href="#l89.23"></a><span id="l89.23">   background-color: #5B7693;</span>
<a href="#l89.24"></a><span id="l89.24">   color: #ffffff;</span>
<a href="#l89.25"></a><span id="l89.25"> }</span>
<a href="#l89.26"></a><span id="l89.26"> </span>
<a href="#l89.27"></a><span id="l89.27" class="difflineplus">+.wizard-header-description[value=&quot;&quot;] {</span>
<a href="#l89.28"></a><span id="l89.28" class="difflineplus">+  display: none;</span>
<a href="#l89.29"></a><span id="l89.29" class="difflineplus">+}</span>
<a href="#l89.30"></a><span id="l89.30" class="difflineplus">+</span>
<a href="#l89.31"></a><span id="l89.31"> .wizard-header-label {</span>
<a href="#l89.32"></a><span id="l89.32">   -moz-margin-start: 23px;</span>
<a href="#l89.33"></a><span id="l89.33">   font-weight: bold;</span>
<a href="#l89.34"></a><span id="l89.34"> }</span>
<a href="#l89.35"></a><span id="l89.35"> </span>
<a href="#l89.36"></a><span id="l89.36"> .wizard-header-description {</span>
<a href="#l89.37"></a><span id="l89.37">   -moz-margin-start: 44px;</span>
<a href="#l89.38"></a><span id="l89.38">   -moz-margin-end: 5px;</span>
<a href="#l89.39"></a><span id="l89.39"> }</span>
<a href="#l89.40"></a><span id="l89.40"> </span>
<a href="#l89.41"></a><span id="l89.41"> .wizard-page-box {</span>
<a href="#l89.42"></a><span id="l89.42">   margin: 10px 44px;</span>
<a href="#l89.43"></a><span id="l89.43"> }</span>
<a href="#l89.44"></a><span id="l89.44" class="difflineplus">+</span>
<a href="#l89.45"></a><span id="l89.45" class="difflineplus">+.wizard-buttons-separator {</span>
<a href="#l89.46"></a><span id="l89.46" class="difflineplus">+  margin-bottom: 0px !important;</span>
<a href="#l89.47"></a><span id="l89.47" class="difflineplus">+}</span>
<a href="#l89.48"></a><span id="l89.48" class="difflineplus">+</span>
<a href="#l89.49"></a><span id="l89.49" class="difflineplus">+.wizard-buttons-box-2,</span>
<a href="#l89.50"></a><span id="l89.50" class="difflineplus">+.wizard-buttons-btm {</span>
<a href="#l89.51"></a><span id="l89.51" class="difflineplus">+  padding: 5px;</span>
<a href="#l89.52"></a><span id="l89.52" class="difflineplus">+}</span>
<a href="#l89.53"></a><span id="l89.53" class="difflineplus">+</span>
<a href="#l89.54"></a><span id="l89.54" class="difflineplus">+.wizard-button[dlgtype=&quot;finish&quot;],</span>
<a href="#l89.55"></a><span id="l89.55" class="difflineplus">+.wizard-button[dlgtype=&quot;next&quot;] {</span>
<a href="#l89.56"></a><span id="l89.56" class="difflineplus">+  -moz-margin-start: 0px;</span>
<a href="#l89.57"></a><span id="l89.57" class="difflineplus">+}</span>
<a href="#l89.58"></a><span id="l89.58" class="difflineplus">+</span>
<a href="#l89.59"></a><span id="l89.59" class="difflineplus">+.wizard-button[dlgtype=&quot;back&quot;] {</span>
<a href="#l89.60"></a><span id="l89.60" class="difflineplus">+  -moz-margin-end: 0px;</span>
<a href="#l89.61"></a><span id="l89.61" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1" class="difflineminus">--- a/suite/themes/modern/jar.mn</span>
<a href="#l90.2"></a><span id="l90.2" class="difflineplus">+++ b/suite/themes/modern/jar.mn</span>
<a href="#l90.3"></a><span id="l90.3" class="difflineat">@@ -154,16 +154,17 @@ modern.jar:</span>
<a href="#l90.4"></a><span id="l90.4">   skin/modern/global/button.css                                    (global/button.css)</span>
<a href="#l90.5"></a><span id="l90.5">   skin/modern/global/checkbox.css                                  (global/checkbox.css)</span>
<a href="#l90.6"></a><span id="l90.6">   skin/modern/global/colorpicker.css                               (global/colorpicker.css)</span>
<a href="#l90.7"></a><span id="l90.7">   skin/modern/global/config.css                                    (global/config.css)</span>
<a href="#l90.8"></a><span id="l90.8">   skin/modern/global/customizeToolbar.css                          (global/customizeToolbar.css)</span>
<a href="#l90.9"></a><span id="l90.9">   skin/modern/global/datetimepicker.css                            (global/datetimepicker.css)</span>
<a href="#l90.10"></a><span id="l90.10">   skin/modern/global/dialog.css                                    (global/dialog.css)</span>
<a href="#l90.11"></a><span id="l90.11">   skin/modern/global/dropmarker.css                                (global/dropmarker.css)</span>
<a href="#l90.12"></a><span id="l90.12" class="difflineplus">+  skin/modern/global/filefield.css                                 (global/filefield.css)</span>
<a href="#l90.13"></a><span id="l90.13">   skin/modern/global/filepicker.css                                (global/filepicker.css)</span>
<a href="#l90.14"></a><span id="l90.14">   skin/modern/global/findBar.css                                   (global/findBar.css)</span>
<a href="#l90.15"></a><span id="l90.15">   skin/modern/global/global.css                                    (global/global.css)</span>
<a href="#l90.16"></a><span id="l90.16">   skin/modern/global/groupbox.css                                  (global/groupbox.css)</span>
<a href="#l90.17"></a><span id="l90.17">   skin/modern/global/listbox.css                                   (global/listbox.css)</span>
<a href="#l90.18"></a><span id="l90.18">   skin/modern/global/menu.css                                      (global/menu.css)</span>
<a href="#l90.19"></a><span id="l90.19">   skin/modern/global/menulist.css                                  (global/menulist.css)</span>
<a href="#l90.20"></a><span id="l90.20">   skin/modern/global/numberbox.css                                 (global/numberbox.css)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

