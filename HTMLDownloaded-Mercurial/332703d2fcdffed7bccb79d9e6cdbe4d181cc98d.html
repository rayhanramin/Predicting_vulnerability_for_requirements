<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 17430:332703d2fcdffed7bccb79d9e6cdbe4d181cc98d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 332703d2fcdffed7bccb79d9e6cdbe4d181cc98d" />
<meta property="og:url" content="/comm-central/rev/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d" />
<meta property="og:description" content="Bug 894012 - convert folder property 'expungedBytes' to int64. r=rkent, r=Neil" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 332703d2fcdffed7bccb79d9e6cdbe4d181cc98d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d">shortlog</a> |
<a href="/comm-central/log/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d">files</a> |
changeset |
<a href="/comm-central/raw-rev/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d">raw</a>  | <a href="/comm-central/archive/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=894012">Bug 894012</a> - convert folder property 'expungedBytes' to int64. r=rkent, r=Neil
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#99;&#101;&#109;&#97;&#110;&#32;&#60;&#97;&#99;&#101;&#108;&#105;&#115;&#116;&#115;&#64;&#97;&#116;&#108;&#97;&#115;&#46;&#115;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 30 Jan 2015 21:44:26 +0100</td></tr>

<tr>
 <td>changeset 17430</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d">332703d2fcdffed7bccb79d9e6cdbe4d181cc98d</a></td>
</tr>



<tr>
<td>parent 17429</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/613cf9f167f3e92e07f4af151e61181736bc677c">613cf9f167f3e92e07f4af151e61181736bc677c</a>
</td>
</tr>

<tr>
<td>child 17431</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b4f8676e81cd552e465512f160a321c60968ad20">b4f8676e81cd552e465512f160a321c60968ad20</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=332703d2fcdffed7bccb79d9e6cdbe4d181cc98d">10738</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Fri, 30 Jan 2015 20:45:28 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b4f8676e81cd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b4f8676e81cd552e465512f160a321c60968ad20">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b4f8676e81cd552e465512f160a321c60968ad20&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b4f8676e81cd552e465512f160a321c60968ad20&newProject=comm-central&newRevision=e742cc8cfe94b91bcf00c92128808d56c503e460&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b4f8676e81cd552e465512f160a321c60968ad20&newProject=comm-central&newRevision=e742cc8cfe94b91bcf00c92128808d56c503e460&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b4f8676e81cd552e465512f160a321c60968ad20&newProject=comm-central&newRevision=e742cc8cfe94b91bcf00c92128808d56c503e460&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28rkent%29&revcount=50">rkent</a>, <a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=894012">894012</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=894012">Bug 894012</a> - convert folder property 'expungedBytes' to int64. r=rkent, r=Neil</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/public/nsIMsgFolder.idl">mailnews/base/public/nsIMsgFolder.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/public/nsIMsgFolder.idl">file</a> |
<a href="/comm-central/annotate/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/public/nsIMsgFolder.idl">annotate</a> |
<a href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/public/nsIMsgFolder.idl">diff</a> |
<a href="/comm-central/comparison/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/public/nsIMsgFolder.idl">comparison</a> |
<a href="/comm-central/log/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/public/nsIMsgFolder.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/src/nsMsgFolderCompactor.cpp">mailnews/base/src/nsMsgFolderCompactor.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/src/nsMsgFolderCompactor.cpp">file</a> |
<a href="/comm-central/annotate/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/src/nsMsgFolderCompactor.cpp">annotate</a> |
<a href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/src/nsMsgFolderCompactor.cpp">diff</a> |
<a href="/comm-central/comparison/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/src/nsMsgFolderCompactor.cpp">comparison</a> |
<a href="/comm-central/log/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/src/nsMsgFolderCompactor.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/util/nsMsgDBFolder.h">mailnews/base/util/nsMsgDBFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/util/nsMsgDBFolder.h">file</a> |
<a href="/comm-central/annotate/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/util/nsMsgDBFolder.h">annotate</a> |
<a href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/util/nsMsgDBFolder.h">diff</a> |
<a href="/comm-central/comparison/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/util/nsMsgDBFolder.h">comparison</a> |
<a href="/comm-central/log/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/base/util/nsMsgDBFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/db/msgdb/public/nsDBFolderInfo.h">mailnews/db/msgdb/public/nsDBFolderInfo.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/db/msgdb/public/nsDBFolderInfo.h">file</a> |
<a href="/comm-central/annotate/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/db/msgdb/public/nsDBFolderInfo.h">annotate</a> |
<a href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/db/msgdb/public/nsDBFolderInfo.h">diff</a> |
<a href="/comm-central/comparison/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/db/msgdb/public/nsDBFolderInfo.h">comparison</a> |
<a href="/comm-central/log/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/db/msgdb/public/nsDBFolderInfo.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/db/msgdb/public/nsIDBFolderInfo.idl">mailnews/db/msgdb/public/nsIDBFolderInfo.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/db/msgdb/public/nsIDBFolderInfo.idl">file</a> |
<a href="/comm-central/annotate/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/db/msgdb/public/nsIDBFolderInfo.idl">annotate</a> |
<a href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/db/msgdb/public/nsIDBFolderInfo.idl">diff</a> |
<a href="/comm-central/comparison/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/db/msgdb/public/nsIDBFolderInfo.idl">comparison</a> |
<a href="/comm-central/log/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/db/msgdb/public/nsIDBFolderInfo.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/db/msgdb/src/nsDBFolderInfo.cpp">mailnews/db/msgdb/src/nsDBFolderInfo.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/db/msgdb/src/nsDBFolderInfo.cpp">file</a> |
<a href="/comm-central/annotate/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/db/msgdb/src/nsDBFolderInfo.cpp">annotate</a> |
<a href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/db/msgdb/src/nsDBFolderInfo.cpp">diff</a> |
<a href="/comm-central/comparison/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/db/msgdb/src/nsDBFolderInfo.cpp">comparison</a> |
<a href="/comm-central/log/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/db/msgdb/src/nsDBFolderInfo.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/local/src/nsMsgBrkMBoxStore.cpp">mailnews/local/src/nsMsgBrkMBoxStore.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/local/src/nsMsgBrkMBoxStore.cpp">file</a> |
<a href="/comm-central/annotate/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/local/src/nsMsgBrkMBoxStore.cpp">annotate</a> |
<a href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/local/src/nsMsgBrkMBoxStore.cpp">diff</a> |
<a href="/comm-central/comparison/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/local/src/nsMsgBrkMBoxStore.cpp">comparison</a> |
<a href="/comm-central/log/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/local/src/nsMsgBrkMBoxStore.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/local/test/unit/test_over4GBMailboxes.js">mailnews/local/test/unit/test_over4GBMailboxes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/local/test/unit/test_over4GBMailboxes.js">file</a> |
<a href="/comm-central/annotate/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/local/test/unit/test_over4GBMailboxes.js">annotate</a> |
<a href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/local/test/unit/test_over4GBMailboxes.js">diff</a> |
<a href="/comm-central/comparison/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/local/test/unit/test_over4GBMailboxes.js">comparison</a> |
<a href="/comm-central/log/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/local/test/unit/test_over4GBMailboxes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/news/src/nsNewsFolder.cpp">mailnews/news/src/nsNewsFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/news/src/nsNewsFolder.cpp">file</a> |
<a href="/comm-central/annotate/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/news/src/nsNewsFolder.cpp">annotate</a> |
<a href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/news/src/nsNewsFolder.cpp">diff</a> |
<a href="/comm-central/comparison/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/news/src/nsNewsFolder.cpp">comparison</a> |
<a href="/comm-central/log/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/news/src/nsNewsFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/news/src/nsNewsFolder.h">mailnews/news/src/nsNewsFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/news/src/nsNewsFolder.h">file</a> |
<a href="/comm-central/annotate/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/news/src/nsNewsFolder.h">annotate</a> |
<a href="/comm-central/diff/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/news/src/nsNewsFolder.h">diff</a> |
<a href="/comm-central/comparison/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/news/src/nsNewsFolder.h">comparison</a> |
<a href="/comm-central/log/332703d2fcdffed7bccb79d9e6cdbe4d181cc98d/mailnews/news/src/nsNewsFolder.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -25,17 +25,17 @@ interface nsIArray;</span>
<a href="#l1.4"></a><span id="l1.4"> interface nsIMutableArray;</span>
<a href="#l1.5"></a><span id="l1.5"> interface nsIMsgPluggableStore;</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> typedef long nsMsgBiffState;</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> // enumerated type for determining if a message has been replied to, forwarded, etc.</span>
<a href="#l1.10"></a><span id="l1.10"> typedef long nsMsgDispositionState;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-[scriptable, uuid(8EC4D122-1082-4fa2-B97C-4AE852B254D2)]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+[scriptable, uuid(d277b1d2-e820-42f9-8706-914df7d429b3)]</span>
<a href="#l1.14"></a><span id="l1.14"> interface nsIMsgFolder : nsISupports {</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">   const nsMsgBiffState nsMsgBiffState_NewMail = 0; // User has new mail waiting.</span>
<a href="#l1.17"></a><span id="l1.17">   const nsMsgBiffState nsMsgBiffState_NoMail =  1; // No new mail is waiting.</span>
<a href="#l1.18"></a><span id="l1.18">   const nsMsgBiffState nsMsgBiffState_Unknown = 2; // We dunno whether there is new mail.</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20">   /// Returns an enumerator containing the messages within the current database.</span>
<a href="#l1.21"></a><span id="l1.21">   readonly attribute nsISimpleEnumerator messages;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -261,17 +261,17 @@ interface nsIMsgFolder : nsISupports {</span>
<a href="#l1.23"></a><span id="l1.23">    */</span>
<a href="#l1.24"></a><span id="l1.24">   readonly attribute nsIMsgDBHdr firstNewMessage;</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26">   /**</span>
<a href="#l1.27"></a><span id="l1.27">    * clear new status flag of all of the new messages</span>
<a href="#l1.28"></a><span id="l1.28">    */</span>
<a href="#l1.29"></a><span id="l1.29">   void clearNewMessages();</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-  readonly attribute unsigned long expungedBytes;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+  readonly attribute long long expungedBytes;</span>
<a href="#l1.33"></a><span id="l1.33"> </span>
<a href="#l1.34"></a><span id="l1.34">   /**</span>
<a href="#l1.35"></a><span id="l1.35">    * Can this folder be deleted?</span>
<a href="#l1.36"></a><span id="l1.36">    * For example, special folders and isServer folders cannot be deleted.</span>
<a href="#l1.37"></a><span id="l1.37">    */</span>
<a href="#l1.38"></a><span id="l1.38">   readonly attribute boolean deletable;</span>
<a href="#l1.39"></a><span id="l1.39"> </span>
<a href="#l1.40"></a><span id="l1.40">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCompactor.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCompactor.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -162,17 +162,17 @@ nsFolderCompactState::Compact(nsIMsgFold</span>
<a href="#l2.4"></a><span id="l2.4">   m_listener = aListener;</span>
<a href="#l2.5"></a><span id="l2.5">   if (!m_compactingOfflineFolders &amp;&amp; !aOfflineStore)</span>
<a href="#l2.6"></a><span id="l2.6">   {</span>
<a href="#l2.7"></a><span id="l2.7">     nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(folder);</span>
<a href="#l2.8"></a><span id="l2.8">     if (imapFolder)</span>
<a href="#l2.9"></a><span id="l2.9">       return imapFolder-&gt;Expunge(this, aMsgWindow);</span>
<a href="#l2.10"></a><span id="l2.10">   }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-   uint32_t expunged;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+   int64_t expunged;</span>
<a href="#l2.14"></a><span id="l2.14">    folder-&gt;GetExpungedBytes(&amp;expunged);</span>
<a href="#l2.15"></a><span id="l2.15">    m_totalExpungedBytes += expunged;</span>
<a href="#l2.16"></a><span id="l2.16">    m_window = aMsgWindow;</span>
<a href="#l2.17"></a><span id="l2.17">    nsresult rv;</span>
<a href="#l2.18"></a><span id="l2.18">    nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l2.19"></a><span id="l2.19">    nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l2.20"></a><span id="l2.20">    nsCOMPtr&lt;nsIMsgDatabase&gt; mailDBFactory;</span>
<a href="#l2.21"></a><span id="l2.21">    nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -1079,17 +1079,17 @@ nsOfflineStoreCompactState::FinishCompac</span>
<a href="#l2.23"></a><span id="l2.23">   }</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25">     // make sure the new database is valid</span>
<a href="#l2.26"></a><span id="l2.26">   nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l2.27"></a><span id="l2.27">   m_db-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l2.28"></a><span id="l2.28">   if (dbFolderInfo)</span>
<a href="#l2.29"></a><span id="l2.29">     dbFolderInfo-&gt;SetExpungedBytes(0);</span>
<a href="#l2.30"></a><span id="l2.30">   // this forces the m_folder to update mExpungedBytes from the db folder info.</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  uint32_t expungedBytes;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  int64_t expungedBytes;</span>
<a href="#l2.33"></a><span id="l2.33">   m_folder-&gt;GetExpungedBytes(&amp;expungedBytes);</span>
<a href="#l2.34"></a><span id="l2.34">   m_folder-&gt;UpdateSummaryTotals(true);</span>
<a href="#l2.35"></a><span id="l2.35">   m_db-&gt;SetSummaryValid(true);</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37">     // remove the old folder </span>
<a href="#l2.38"></a><span id="l2.38">   path-&gt;Remove(false);</span>
<a href="#l2.39"></a><span id="l2.39"> </span>
<a href="#l2.40"></a><span id="l2.40">     // rename the copied folder to be the original folder </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -381,27 +381,27 @@ NS_IMETHODIMP nsMsgDBFolder::EndFolderLo</span>
<a href="#l3.4"></a><span id="l3.4">   //GGGG       check for new mail here and call SetNewMessages...?? -- ONE OF THE 2 PLACES</span>
<a href="#l3.5"></a><span id="l3.5">   if(mDatabase)</span>
<a href="#l3.6"></a><span id="l3.6">     m_newMsgs.Clear();</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">   return NS_OK;</span>
<a href="#l3.9"></a><span id="l3.9"> }</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> NS_IMETHODIMP</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-nsMsgDBFolder::GetExpungedBytes(uint32_t *count)</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+nsMsgDBFolder::GetExpungedBytes(int64_t *count)</span>
<a href="#l3.14"></a><span id="l3.14"> {</span>
<a href="#l3.15"></a><span id="l3.15">   NS_ENSURE_ARG_POINTER(count);</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17">   if (mDatabase)</span>
<a href="#l3.18"></a><span id="l3.18">   {</span>
<a href="#l3.19"></a><span id="l3.19">     nsresult rv;</span>
<a href="#l3.20"></a><span id="l3.20">     nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l3.21"></a><span id="l3.21">     rv = mDatabase-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l3.22"></a><span id="l3.22">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-    rv = folderInfo-&gt;GetExpungedBytes((int32_t *) count);</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+    rv = folderInfo-&gt;GetExpungedBytes(count);</span>
<a href="#l3.25"></a><span id="l3.25">     if (NS_SUCCEEDED(rv))</span>
<a href="#l3.26"></a><span id="l3.26">       mExpungedBytes = *count; // sync up with the database</span>
<a href="#l3.27"></a><span id="l3.27">     return rv;</span>
<a href="#l3.28"></a><span id="l3.28">   }</span>
<a href="#l3.29"></a><span id="l3.29">   else</span>
<a href="#l3.30"></a><span id="l3.30">   {</span>
<a href="#l3.31"></a><span id="l3.31">     ReadDBFolderInfo(false);</span>
<a href="#l3.32"></a><span id="l3.32">     *count = mExpungedBytes;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineat">@@ -663,17 +663,17 @@ nsresult nsMsgDBFolder::ReadDBFolderInfo</span>
<a href="#l3.34"></a><span id="l3.34">           GetName(name);</span>
<a href="#l3.35"></a><span id="l3.35">           NS_ASSERTION(Compare(name, kLocalizedTrashName) || (mFlags &amp; nsMsgFolderFlags::Trash), &quot;lost trash flag&quot;);</span>
<a href="#l3.36"></a><span id="l3.36"> #endif</span>
<a href="#l3.37"></a><span id="l3.37">           mInitializedFromCache = true;</span>
<a href="#l3.38"></a><span id="l3.38">         }</span>
<a href="#l3.39"></a><span id="l3.39"> </span>
<a href="#l3.40"></a><span id="l3.40">         folderInfo-&gt;GetNumMessages(&amp;mNumTotalMessages);</span>
<a href="#l3.41"></a><span id="l3.41">         folderInfo-&gt;GetNumUnreadMessages(&amp;mNumUnreadMessages);</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-        folderInfo-&gt;GetExpungedBytes((int32_t *)&amp;mExpungedBytes);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+        folderInfo-&gt;GetExpungedBytes(&amp;mExpungedBytes);</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45">         nsCString utf8Name;</span>
<a href="#l3.46"></a><span id="l3.46">         folderInfo-&gt;GetFolderName(utf8Name);</span>
<a href="#l3.47"></a><span id="l3.47">         if (!utf8Name.IsEmpty())</span>
<a href="#l3.48"></a><span id="l3.48">           CopyUTF8toUTF16(utf8Name, mName);</span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50">         //These should be put in IMAP folder only.</span>
<a href="#l3.51"></a><span id="l3.51">         //folderInfo-&gt;GetImapTotalPendingMessages(&amp;mNumPendingTotalMessages);</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineat">@@ -1285,17 +1285,17 @@ NS_IMETHODIMP nsMsgDBFolder::ReadFromFol</span>
<a href="#l3.53"></a><span id="l3.53">   nsresult rv = NS_OK;</span>
<a href="#l3.54"></a><span id="l3.54">   nsCString charset;</span>
<a href="#l3.55"></a><span id="l3.55"> </span>
<a href="#l3.56"></a><span id="l3.56">   element-&gt;GetInt32Property(&quot;flags&quot;, (int32_t *) &amp;mFlags);</span>
<a href="#l3.57"></a><span id="l3.57">   element-&gt;GetInt32Property(&quot;totalMsgs&quot;, &amp;mNumTotalMessages);</span>
<a href="#l3.58"></a><span id="l3.58">   element-&gt;GetInt32Property(&quot;totalUnreadMsgs&quot;, &amp;mNumUnreadMessages);</span>
<a href="#l3.59"></a><span id="l3.59">   element-&gt;GetInt32Property(&quot;pendingUnreadMsgs&quot;, &amp;mNumPendingUnreadMessages);</span>
<a href="#l3.60"></a><span id="l3.60">   element-&gt;GetInt32Property(&quot;pendingMsgs&quot;, &amp;mNumPendingTotalMessages);</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-  element-&gt;GetInt32Property(&quot;expungedBytes&quot;, (int32_t *) &amp;mExpungedBytes);</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+  element-&gt;GetInt64Property(&quot;expungedBytes&quot;, &amp;mExpungedBytes);</span>
<a href="#l3.63"></a><span id="l3.63">   element-&gt;GetInt64Property(&quot;folderSize&quot;, &amp;mFolderSize);</span>
<a href="#l3.64"></a><span id="l3.64">   element-&gt;GetStringProperty(&quot;charset&quot;, mCharset);</span>
<a href="#l3.65"></a><span id="l3.65"> </span>
<a href="#l3.66"></a><span id="l3.66"> #ifdef DEBUG_bienvenu1</span>
<a href="#l3.67"></a><span id="l3.67">   nsCString uri;</span>
<a href="#l3.68"></a><span id="l3.68">   GetURI(uri);</span>
<a href="#l3.69"></a><span id="l3.69">   printf(&quot;read total %ld for %s\n&quot;, mNumTotalMessages, uri.get());</span>
<a href="#l3.70"></a><span id="l3.70"> #endif</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineat">@@ -1408,17 +1408,17 @@ NS_IMETHODIMP nsMsgDBFolder::WriteToFold</span>
<a href="#l3.72"></a><span id="l3.72"> {</span>
<a href="#l3.73"></a><span id="l3.73">   nsresult rv = NS_OK;</span>
<a href="#l3.74"></a><span id="l3.74"> </span>
<a href="#l3.75"></a><span id="l3.75">   element-&gt;SetInt32Property(&quot;flags&quot;, (int32_t) mFlags);</span>
<a href="#l3.76"></a><span id="l3.76">   element-&gt;SetInt32Property(&quot;totalMsgs&quot;, mNumTotalMessages);</span>
<a href="#l3.77"></a><span id="l3.77">   element-&gt;SetInt32Property(&quot;totalUnreadMsgs&quot;, mNumUnreadMessages);</span>
<a href="#l3.78"></a><span id="l3.78">   element-&gt;SetInt32Property(&quot;pendingUnreadMsgs&quot;, mNumPendingUnreadMessages);</span>
<a href="#l3.79"></a><span id="l3.79">   element-&gt;SetInt32Property(&quot;pendingMsgs&quot;, mNumPendingTotalMessages);</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-  element-&gt;SetInt32Property(&quot;expungedBytes&quot;, mExpungedBytes);</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+  element-&gt;SetInt64Property(&quot;expungedBytes&quot;, mExpungedBytes);</span>
<a href="#l3.82"></a><span id="l3.82">   element-&gt;SetInt64Property(&quot;folderSize&quot;, mFolderSize);</span>
<a href="#l3.83"></a><span id="l3.83">   element-&gt;SetStringProperty(&quot;charset&quot;, mCharset);</span>
<a href="#l3.84"></a><span id="l3.84"> </span>
<a href="#l3.85"></a><span id="l3.85"> #ifdef DEBUG_bienvenu1</span>
<a href="#l3.86"></a><span id="l3.86">   nsCString uri;</span>
<a href="#l3.87"></a><span id="l3.87">   GetURI(uri);</span>
<a href="#l3.88"></a><span id="l3.88">   printf(&quot;writing total %ld for %s\n&quot;, mNumTotalMessages, uri.get());</span>
<a href="#l3.89"></a><span id="l3.89"> #endif</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineat">@@ -1836,19 +1836,19 @@ nsresult nsMsgDBFolder::HandleAutoCompac</span>
<a href="#l3.91"></a><span id="l3.91">     rv = allServers-&gt;GetLength(&amp;numServers);</span>
<a href="#l3.92"></a><span id="l3.92">     int32_t offlineSupportLevel;</span>
<a href="#l3.93"></a><span id="l3.93">     if (numServers &gt; 0)</span>
<a href="#l3.94"></a><span id="l3.94">     {</span>
<a href="#l3.95"></a><span id="l3.95">       nsCOMPtr&lt;nsIMutableArray&gt; folderArray = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l3.96"></a><span id="l3.96">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.97"></a><span id="l3.97">       nsCOMPtr&lt;nsIMutableArray&gt; offlineFolderArray = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l3.98"></a><span id="l3.98">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-      int32_t totalExpungedBytes = 0;</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-      int32_t offlineExpungedBytes = 0;</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-      int32_t localExpungedBytes = 0;</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+      int64_t totalExpungedBytes = 0;</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+      int64_t offlineExpungedBytes = 0;</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+      int64_t localExpungedBytes = 0;</span>
<a href="#l3.105"></a><span id="l3.105">       do</span>
<a href="#l3.106"></a><span id="l3.106">       {</span>
<a href="#l3.107"></a><span id="l3.107">         nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryElementAt(allServers, serverIndex, &amp;rv);</span>
<a href="#l3.108"></a><span id="l3.108">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.109"></a><span id="l3.109">         nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l3.110"></a><span id="l3.110">         rv = server-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l3.111"></a><span id="l3.111">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.112"></a><span id="l3.112">         if (!msgStore)</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineat">@@ -1863,17 +1863,17 @@ nsresult nsMsgDBFolder::HandleAutoCompac</span>
<a href="#l3.114"></a><span id="l3.114">         {</span>
<a href="#l3.115"></a><span id="l3.115">           rv = server-&gt;GetOfflineSupportLevel(&amp;offlineSupportLevel);</span>
<a href="#l3.116"></a><span id="l3.116">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.117"></a><span id="l3.117">           nsCOMPtr&lt;nsIArray&gt; allDescendents;</span>
<a href="#l3.118"></a><span id="l3.118">           rootFolder-&gt;GetDescendants(getter_AddRefs(allDescendents));</span>
<a href="#l3.119"></a><span id="l3.119">           uint32_t cnt = 0;</span>
<a href="#l3.120"></a><span id="l3.120">           rv = allDescendents-&gt;GetLength(&amp;cnt);</span>
<a href="#l3.121"></a><span id="l3.121">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-          uint32_t expungedBytes=0;</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+          int64_t expungedBytes = 0;</span>
<a href="#l3.124"></a><span id="l3.124">           if (offlineSupportLevel &gt; 0)</span>
<a href="#l3.125"></a><span id="l3.125">           {</span>
<a href="#l3.126"></a><span id="l3.126">             uint32_t flags;</span>
<a href="#l3.127"></a><span id="l3.127">             for (uint32_t i = 0; i &lt; cnt; i++)</span>
<a href="#l3.128"></a><span id="l3.128">             {</span>
<a href="#l3.129"></a><span id="l3.129">               nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryElementAt(allDescendents, i);</span>
<a href="#l3.130"></a><span id="l3.130">               expungedBytes = 0;</span>
<a href="#l3.131"></a><span id="l3.131">               folder-&gt;GetFlags(&amp;flags);</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineat">@@ -1963,17 +1963,17 @@ nsresult nsMsgDBFolder::HandleAutoCompac</span>
<a href="#l3.133"></a><span id="l3.133">         else</span>
<a href="#l3.134"></a><span id="l3.134">           okToCompact = aWindow || !askBeforePurge;</span>
<a href="#l3.135"></a><span id="l3.135"> </span>
<a href="#l3.136"></a><span id="l3.136">         if (okToCompact)</span>
<a href="#l3.137"></a><span id="l3.137">         {</span>
<a href="#l3.138"></a><span id="l3.138">           nsCOMPtr &lt;nsIAtom&gt; aboutToCompactAtom = MsgGetAtom(&quot;AboutToCompact&quot;);</span>
<a href="#l3.139"></a><span id="l3.139">           NotifyFolderEvent(aboutToCompactAtom);</span>
<a href="#l3.140"></a><span id="l3.140"> </span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-         if ( localExpungedBytes &gt; 0)</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+         if (localExpungedBytes &gt; 0)</span>
<a href="#l3.143"></a><span id="l3.143">          {</span>
<a href="#l3.144"></a><span id="l3.144">             nsCOMPtr&lt;nsIMsgFolderCompactor&gt; folderCompactor =</span>
<a href="#l3.145"></a><span id="l3.145">               do_CreateInstance(NS_MSGLOCALFOLDERCOMPACTOR_CONTRACTID, &amp;rv);</span>
<a href="#l3.146"></a><span id="l3.146">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.147"></a><span id="l3.147"> </span>
<a href="#l3.148"></a><span id="l3.148">             if (offlineExpungedBytes &gt; 0)</span>
<a href="#l3.149"></a><span id="l3.149">               folderCompactor-&gt;CompactFolders(folderArray, offlineFolderArray, nullptr, aWindow);</span>
<a href="#l3.150"></a><span id="l3.150">             else</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -192,17 +192,17 @@ protected:</span>
<a href="#l4.4"></a><span id="l4.4">   static NS_MSG_BASE_STATIC_MEMBER_(nsrefcnt) mInstanceCount;</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> protected:</span>
<a href="#l4.7"></a><span id="l4.7">   uint32_t mFlags;</span>
<a href="#l4.8"></a><span id="l4.8">   nsWeakPtr mParent;     //This won't be refcounted for ownership reasons.</span>
<a href="#l4.9"></a><span id="l4.9">   int32_t mNumUnreadMessages;        /* count of unread messages (-1 means unknown; -2 means unknown but we already tried to find out.) */</span>
<a href="#l4.10"></a><span id="l4.10">   int32_t mNumTotalMessages;         /* count of existing messages. */</span>
<a href="#l4.11"></a><span id="l4.11">   bool mNotifyCountChanges;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  uint32_t mExpungedBytes;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  int64_t mExpungedBytes;</span>
<a href="#l4.14"></a><span id="l4.14">   nsCOMArray&lt;nsIMsgFolder&gt; mSubFolders;</span>
<a href="#l4.15"></a><span id="l4.15">   // This can't be refcounted due to ownsership issues</span>
<a href="#l4.16"></a><span id="l4.16">   nsTObserverArray&lt;nsIFolderListener*&gt; mListeners;</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18">   bool mInitializedFromCache;</span>
<a href="#l4.19"></a><span id="l4.19">   nsISupports *mSemaphoreHolder; // set when the folder is being written to</span>
<a href="#l4.20"></a><span id="l4.20">                                  //Due to ownership issues, this won't be AddRef'd.</span>
<a href="#l4.21"></a><span id="l4.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsDBFolderInfo.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsDBFolderInfo.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -45,16 +45,17 @@ public:</span>
<a href="#l5.4"></a><span id="l5.4">   void      SetIMAPHierarchySeparator(int16_t hierarchyDelimiter) ;</span>
<a href="#l5.5"></a><span id="l5.5">   void      ChangeImapTotalPendingMessages(int32_t delta);</span>
<a href="#l5.6"></a><span id="l5.6">   void      ChangeImapUnreadPendingMessages(int32_t delta) ;</span>
<a href="#l5.7"></a><span id="l5.7">   </span>
<a href="#l5.8"></a><span id="l5.8">   nsresult      InitFromExistingDB();</span>
<a href="#l5.9"></a><span id="l5.9">   // get and set arbitrary property, aka row cell value.</span>
<a href="#l5.10"></a><span id="l5.10">   nsresult SetPropertyWithToken(mdb_token aProperty, const nsAString &amp;propertyStr);</span>
<a href="#l5.11"></a><span id="l5.11">   nsresult SetUint32PropertyWithToken(mdb_token aProperty, uint32_t propertyValue);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+  nsresult SetUint64PropertyWithToken(mdb_token aProperty, uint64_t propertyValue);</span>
<a href="#l5.13"></a><span id="l5.13">   nsresult SetInt32PropertyWithToken(mdb_token aProperty, int32_t propertyValue);</span>
<a href="#l5.14"></a><span id="l5.14">   nsresult GetPropertyWithToken(mdb_token aProperty, nsAString &amp;resultProperty);</span>
<a href="#l5.15"></a><span id="l5.15">   nsresult GetUint32PropertyWithToken(mdb_token aProperty, uint32_t &amp;propertyValue, uint32_t defaultValue = 0);</span>
<a href="#l5.16"></a><span id="l5.16">   nsresult GetInt32PropertyWithToken(mdb_token aProperty, int32_t &amp;propertyValue, int32_t defaultValue = 0);</span>
<a href="#l5.17"></a><span id="l5.17">   nsresult SetUint64Property(const char *aProperty, uint64_t propertyValue);</span>
<a href="#l5.18"></a><span id="l5.18">   nsresult GetUint64PropertyWithToken(mdb_token columnToken,</span>
<a href="#l5.19"></a><span id="l5.19">                                       uint64_t *propertyValue);</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -74,18 +75,18 @@ protected:</span>
<a href="#l5.22"></a><span id="l5.22">   // initialize from appropriate table and row in existing db.</span>
<a href="#l5.23"></a><span id="l5.23">   nsresult InitMDBInfo();</span>
<a href="#l5.24"></a><span id="l5.24">   nsresult LoadMemberVariables();</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26">   nsresult AdjustHighWater(nsMsgKey highWater, bool force);</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28">   void ReleaseExternalReferences(); // let go of any references to other objects.</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-  uint64_t  m_folderSize;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-  int32_t   m_expungedBytes; // sum of size of deleted messages in folder</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  uint64_t  m_folderSize;    // TODO: In nsIMsgFolder folder size is int64_t.</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+  int64_t   m_expungedBytes; // sum of size of deleted messages in folder</span>
<a href="#l5.34"></a><span id="l5.34">   uint32_t  m_folderDate;</span>
<a href="#l5.35"></a><span id="l5.35">   nsMsgKey  m_highWaterMessageKey; // largest news article number or imap uid whose header we've seen</span>
<a href="#l5.36"></a><span id="l5.36"> </span>
<a href="#l5.37"></a><span id="l5.37">   //  m_numUnreadMessages and m_numMessages can never be negative. 0 means 'no msgs'.</span>
<a href="#l5.38"></a><span id="l5.38">   int32_t   m_numUnreadMessages;</span>
<a href="#l5.39"></a><span id="l5.39">   int32_t   m_numMessages;    // includes expunged and ignored messages</span>
<a href="#l5.40"></a><span id="l5.40"> </span>
<a href="#l5.41"></a><span id="l5.41">   int32_t   m_flags;  // folder specific flags. This holds things like re-use thread pane,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsIDBFolderInfo.idl</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsIDBFolderInfo.idl</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -41,17 +41,17 @@ interface  nsIDBFolderInfo : nsISupports</span>
<a href="#l6.4"></a><span id="l6.4">   attribute unsigned long folderDate;</span>
<a href="#l6.5"></a><span id="l6.5">   void changeNumUnreadMessages(in long aDelta);</span>
<a href="#l6.6"></a><span id="l6.6">   void changeNumMessages(in long aDelta);</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8">   // numUnreadMessages and numMessages will never return negative numbers. 0 means 'no msgs'.</span>
<a href="#l6.9"></a><span id="l6.9">   attribute long numUnreadMessages;</span>
<a href="#l6.10"></a><span id="l6.10">   attribute long numMessages;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  attribute long expungedBytes;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  attribute long long expungedBytes;</span>
<a href="#l6.14"></a><span id="l6.14">   attribute long imapUidValidity;</span>
<a href="#l6.15"></a><span id="l6.15">   attribute unsigned long version;</span>
<a href="#l6.16"></a><span id="l6.16">   attribute long imapTotalPendingMessages;</span>
<a href="#l6.17"></a><span id="l6.17">   attribute long imapUnreadPendingMessages;</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">   attribute nsMsgViewTypeValue viewType;</span>
<a href="#l6.20"></a><span id="l6.20">   attribute nsMsgViewFlagsTypeValue viewFlags;</span>
<a href="#l6.21"></a><span id="l6.21">   attribute nsMsgViewSortTypeValue sortType;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsDBFolderInfo.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsDBFolderInfo.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -354,17 +354,17 @@ nsresult nsDBFolderInfo::LoadMemberVaria</span>
<a href="#l7.4"></a><span id="l7.4">   // it's really not an error for these properties to not exist...</span>
<a href="#l7.5"></a><span id="l7.5">   GetInt32PropertyWithToken(m_numMessagesColumnToken, m_numMessages);</span>
<a href="#l7.6"></a><span id="l7.6">   GetInt32PropertyWithToken(m_numUnreadMessagesColumnToken, m_numUnreadMessages);</span>
<a href="#l7.7"></a><span id="l7.7">   GetInt32PropertyWithToken(m_flagsColumnToken, m_flags);</span>
<a href="#l7.8"></a><span id="l7.8">   GetUint64PropertyWithToken(m_folderSizeColumnToken, &amp;m_folderSize);</span>
<a href="#l7.9"></a><span id="l7.9">   GetInt32PropertyWithToken(m_folderDateColumnToken, (int32_t &amp;) m_folderDate);</span>
<a href="#l7.10"></a><span id="l7.10">   GetInt32PropertyWithToken(m_imapUidValidityColumnToken, m_ImapUidValidity, kUidUnknown);</span>
<a href="#l7.11"></a><span id="l7.11">   GetInt32PropertyWithToken(m_expiredMarkColumnToken, (int32_t &amp;) m_expiredMark);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  GetInt32PropertyWithToken(m_expungedBytesColumnToken, (int32_t &amp;) m_expungedBytes);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  GetUint64PropertyWithToken(m_expungedBytesColumnToken, (uint64_t *) &amp;m_expungedBytes);</span>
<a href="#l7.14"></a><span id="l7.14">   GetInt32PropertyWithToken(m_highWaterMessageKeyColumnToken, (int32_t &amp;) m_highWaterMessageKey);</span>
<a href="#l7.15"></a><span id="l7.15">   int32_t version;</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17">   GetInt32PropertyWithToken(m_versionColumnToken, version);</span>
<a href="#l7.18"></a><span id="l7.18">   m_version = (uint16_t) version;</span>
<a href="#l7.19"></a><span id="l7.19">   m_charSetOverride = gDefaultCharacterOverride;</span>
<a href="#l7.20"></a><span id="l7.20">   uint32_t propertyValue;</span>
<a href="#l7.21"></a><span id="l7.21">   nsresult rv = GetUint32Property(kCharacterSetOverrideColumnName, gDefaultCharacterOverride, &amp;propertyValue);</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -482,20 +482,20 @@ NS_IMETHODIMP nsDBFolderInfo::SetExpired</span>
<a href="#l7.23"></a><span id="l7.23"> }</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25"> NS_IMETHODIMP nsDBFolderInfo::GetExpiredMark(nsMsgKey *result)</span>
<a href="#l7.26"></a><span id="l7.26"> {</span>
<a href="#l7.27"></a><span id="l7.27">   *result = m_expiredMark;</span>
<a href="#l7.28"></a><span id="l7.28">   return NS_OK;</span>
<a href="#l7.29"></a><span id="l7.29"> }</span>
<a href="#l7.30"></a><span id="l7.30"> </span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-nsDBFolderInfo::ChangeExpungedBytes(int32_t delta)</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+// The size of the argument depends on the maximum size of a single message</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::ChangeExpungedBytes(int32_t delta)</span>
<a href="#l7.35"></a><span id="l7.35"> {</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-    return SetExpungedBytes(m_expungedBytes + delta);</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+  return SetExpungedBytes(m_expungedBytes + delta);</span>
<a href="#l7.38"></a><span id="l7.38"> }</span>
<a href="#l7.39"></a><span id="l7.39"> </span>
<a href="#l7.40"></a><span id="l7.40"> NS_IMETHODIMP nsDBFolderInfo::SetMailboxName(const nsAString &amp;newBoxName)</span>
<a href="#l7.41"></a><span id="l7.41"> {</span>
<a href="#l7.42"></a><span id="l7.42">   return SetPropertyWithToken(m_mailboxNameColumnToken, newBoxName);</span>
<a href="#l7.43"></a><span id="l7.43"> }</span>
<a href="#l7.44"></a><span id="l7.44"> </span>
<a href="#l7.45"></a><span id="l7.45"> NS_IMETHODIMP nsDBFolderInfo::GetMailboxName(nsAString &amp;boxName)</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineat">@@ -551,26 +551,26 @@ NS_IMETHODIMP nsDBFolderInfo::GetNumMess</span>
<a href="#l7.47"></a><span id="l7.47"> }</span>
<a href="#l7.48"></a><span id="l7.48"> </span>
<a href="#l7.49"></a><span id="l7.49"> NS_IMETHODIMP nsDBFolderInfo::SetNumMessages(int32_t numMessages)</span>
<a href="#l7.50"></a><span id="l7.50"> {</span>
<a href="#l7.51"></a><span id="l7.51">   m_numMessages = numMessages;</span>
<a href="#l7.52"></a><span id="l7.52">   return SetUint32PropertyWithToken(m_numMessagesColumnToken, m_numMessages);</span>
<a href="#l7.53"></a><span id="l7.53"> }</span>
<a href="#l7.54"></a><span id="l7.54"> </span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetExpungedBytes(int32_t *result)</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetExpungedBytes(int64_t *result)</span>
<a href="#l7.57"></a><span id="l7.57"> {</span>
<a href="#l7.58"></a><span id="l7.58">   *result = m_expungedBytes;</span>
<a href="#l7.59"></a><span id="l7.59">   return NS_OK;</span>
<a href="#l7.60"></a><span id="l7.60"> }</span>
<a href="#l7.61"></a><span id="l7.61"> </span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetExpungedBytes(int32_t expungedBytes)</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetExpungedBytes(int64_t expungedBytes)</span>
<a href="#l7.64"></a><span id="l7.64"> {</span>
<a href="#l7.65"></a><span id="l7.65">   m_expungedBytes = expungedBytes;</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-  return SetUint32PropertyWithToken(m_expungedBytesColumnToken, m_expungedBytes);</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+  return SetUint64PropertyWithToken(m_expungedBytesColumnToken, m_expungedBytes);</span>
<a href="#l7.68"></a><span id="l7.68"> }</span>
<a href="#l7.69"></a><span id="l7.69"> </span>
<a href="#l7.70"></a><span id="l7.70"> </span>
<a href="#l7.71"></a><span id="l7.71"> NS_IMETHODIMP nsDBFolderInfo::GetFlags(int32_t *result)</span>
<a href="#l7.72"></a><span id="l7.72"> {</span>
<a href="#l7.73"></a><span id="l7.73">   *result = m_flags;</span>
<a href="#l7.74"></a><span id="l7.74">   return NS_OK;</span>
<a href="#l7.75"></a><span id="l7.75"> }</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineat">@@ -827,16 +827,21 @@ nsresult nsDBFolderInfo::SetPropertyWith</span>
<a href="#l7.77"></a><span id="l7.77">   return m_mdb-&gt;SetNSStringPropertyWithToken(m_mdbRow, aProperty, propertyStr);</span>
<a href="#l7.78"></a><span id="l7.78"> }</span>
<a href="#l7.79"></a><span id="l7.79"> </span>
<a href="#l7.80"></a><span id="l7.80"> nsresult  nsDBFolderInfo::SetUint32PropertyWithToken(mdb_token aProperty, uint32_t propertyValue)</span>
<a href="#l7.81"></a><span id="l7.81"> {</span>
<a href="#l7.82"></a><span id="l7.82">   return m_mdb-&gt;UInt32ToRowCellColumn(m_mdbRow, aProperty, propertyValue);</span>
<a href="#l7.83"></a><span id="l7.83"> }</span>
<a href="#l7.84"></a><span id="l7.84"> </span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+nsresult  nsDBFolderInfo::SetUint64PropertyWithToken(mdb_token aProperty, uint64_t propertyValue)</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+{</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+  return m_mdb-&gt;UInt64ToRowCellColumn(m_mdbRow, aProperty, propertyValue);</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+}</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+</span>
<a href="#l7.90"></a><span id="l7.90"> nsresult  nsDBFolderInfo::SetUint64Property(const char *aProperty,</span>
<a href="#l7.91"></a><span id="l7.91">                                             uint64_t propertyValue)</span>
<a href="#l7.92"></a><span id="l7.92"> {</span>
<a href="#l7.93"></a><span id="l7.93">   return m_mdb-&gt;SetUint64Property(m_mdbRow, aProperty, propertyValue);</span>
<a href="#l7.94"></a><span id="l7.94"> }</span>
<a href="#l7.95"></a><span id="l7.95"> </span>
<a href="#l7.96"></a><span id="l7.96"> nsresult  nsDBFolderInfo::SetInt32PropertyWithToken(mdb_token aProperty, int32_t propertyValue)</span>
<a href="#l7.97"></a><span id="l7.97"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -598,17 +598,17 @@ NS_IMETHODIMP nsMsgLocalMailFolder::Comp</span>
<a href="#l8.4"></a><span id="l8.4">   if (NS_SUCCEEDED(rv) &amp;&amp; rootFolder)</span>
<a href="#l8.5"></a><span id="l8.5">   {</span>
<a href="#l8.6"></a><span id="l8.6">     rv = rootFolder-&gt;GetDescendants(getter_AddRefs(allDescendents));</span>
<a href="#l8.7"></a><span id="l8.7">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.8"></a><span id="l8.8">     uint32_t cnt = 0;</span>
<a href="#l8.9"></a><span id="l8.9">     rv = allDescendents-&gt;GetLength(&amp;cnt);</span>
<a href="#l8.10"></a><span id="l8.10">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.11"></a><span id="l8.11">     folderArray = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    uint32_t expungedBytes = 0;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+    int64_t expungedBytes = 0;</span>
<a href="#l8.14"></a><span id="l8.14">     for (uint32_t i = 0; i &lt; cnt; i++)</span>
<a href="#l8.15"></a><span id="l8.15">     {</span>
<a href="#l8.16"></a><span id="l8.16">       nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryElementAt(allDescendents, i, &amp;rv);</span>
<a href="#l8.17"></a><span id="l8.17">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19">       expungedBytes = 0;</span>
<a href="#l8.20"></a><span id="l8.20">       if (folder)</span>
<a href="#l8.21"></a><span id="l8.21">         rv = folder-&gt;GetExpungedBytes(&amp;expungedBytes);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/local/src/nsMsgBrkMBoxStore.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/local/src/nsMsgBrkMBoxStore.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -798,17 +798,17 @@ NS_IMETHODIMP nsMsgBrkMBoxStore::Compact</span>
<a href="#l9.4"></a><span id="l9.4">                                                nsIMsgWindow *aMsgWindow)</span>
<a href="#l9.5"></a><span id="l9.5"> {</span>
<a href="#l9.6"></a><span id="l9.6">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l9.7"></a><span id="l9.7">   nsresult rv;</span>
<a href="#l9.8"></a><span id="l9.8">   nsCOMPtr&lt;nsIMsgFolderCompactor&gt; folderCompactor =</span>
<a href="#l9.9"></a><span id="l9.9">     do_CreateInstance(NS_MSGLOCALFOLDERCOMPACTOR_CONTRACTID, &amp;rv);</span>
<a href="#l9.10"></a><span id="l9.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  uint32_t expungedBytes = 0;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  int64_t expungedBytes = 0;</span>
<a href="#l9.14"></a><span id="l9.14">   aFolder-&gt;GetExpungedBytes(&amp;expungedBytes);</span>
<a href="#l9.15"></a><span id="l9.15">   // check if we need to compact the folder</span>
<a href="#l9.16"></a><span id="l9.16">   return (expungedBytes &gt; 0) ?</span>
<a href="#l9.17"></a><span id="l9.17">     folderCompactor-&gt;Compact(aFolder, false, aListener, aMsgWindow) :</span>
<a href="#l9.18"></a><span id="l9.18">     aFolder-&gt;NotifyCompactCompleted();</span>
<a href="#l9.19"></a><span id="l9.19"> }</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21"> NS_IMETHODIMP nsMsgBrkMBoxStore::RebuildIndex(nsIMsgFolder *aFolder,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/local/test/unit/test_over4GBMailboxes.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_over4GBMailboxes.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -288,23 +288,24 @@ function copyIntoOver4GiB()</span>
<a href="#l10.4"></a><span id="l10.4">   let file = do_get_file(&quot;../../../data/multipart-complex2&quot;);</span>
<a href="#l10.5"></a><span id="l10.5">   copyFileMessageInLocalFolder(file, 0, &quot;&quot;, gDummyMsgWindow,</span>
<a href="#l10.6"></a><span id="l10.6">                                function(aMessageHeadersKeys, aStatus) {</span>
<a href="#l10.7"></a><span id="l10.7">     do_check_false(Components.isSuccessCode(aStatus));</span>
<a href="#l10.8"></a><span id="l10.8">   });</span>
<a href="#l10.9"></a><span id="l10.9">   do_check_true(gGotAlert);</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">   // Make sure inbox file did not grow (i.e., no data were appended).</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  let newLocalInboxSize = gInbox.filePath.fileSize;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  let newLocalInboxSize = gInboxFile.fileSize;</span>
<a href="#l10.14"></a><span id="l10.14">   do_print(&quot;Local inbox size (after copyFileMessageInLocalFolder()) = &quot; +</span>
<a href="#l10.15"></a><span id="l10.15">            newLocalInboxSize);</span>
<a href="#l10.16"></a><span id="l10.16">   do_check_eq(newLocalInboxSize, localInboxSize);</span>
<a href="#l10.17"></a><span id="l10.17"> </span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-  // Append a new small message to the folder (+1 MiB).</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-  growInbox(gInboxFile.fileSize + 0x100000);</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+  // Append 2 new small messages to the folder (+1 MiB each).</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+  growInbox(gInboxFile.fileSize + 0x100000); // will be removed in compactOver4GB</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+  growInbox(gInboxFile.fileSize + 0x100000); // will be preserved in CompactUnder4GB</span>
<a href="#l10.23"></a><span id="l10.23">   do_check_true(gInboxFile.fileSize &gt; kSizeLimit);</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25">   // Force the db closed, so that getDatabaseWithReparse will notice</span>
<a href="#l10.26"></a><span id="l10.26">   // that it's out of date.</span>
<a href="#l10.27"></a><span id="l10.27">   gInbox.msgDatabase.ForceClosed();</span>
<a href="#l10.28"></a><span id="l10.28">   gInbox.msgDatabase = null;</span>
<a href="#l10.29"></a><span id="l10.29">   try {</span>
<a href="#l10.30"></a><span id="l10.30">     gInbox.getDatabaseWithReparse(ParseListener_copyIntoOver4GiB, gDummyMsgWindow);</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineat">@@ -318,27 +319,28 @@ function copyIntoOver4GiB()</span>
<a href="#l10.32"></a><span id="l10.32">  * Bug 794303</span>
<a href="#l10.33"></a><span id="l10.33">  * Check we can compact a folder that stays above 4 GiB after compact.</span>
<a href="#l10.34"></a><span id="l10.34">  */</span>
<a href="#l10.35"></a><span id="l10.35"> function compactOver4GiB()</span>
<a href="#l10.36"></a><span id="l10.36"> {</span>
<a href="#l10.37"></a><span id="l10.37">   gInboxSize = gInboxFile.fileSize;</span>
<a href="#l10.38"></a><span id="l10.38">   do_check_true(gInboxSize &gt; kSizeLimit);</span>
<a href="#l10.39"></a><span id="l10.39">   // Delete the last small message at folder end.</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-  let msgDB = gInbox.msgDatabase;</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-  let enumerator = msgDB.EnumerateMessages();</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+  let enumerator = gInbox.messages;</span>
<a href="#l10.43"></a><span id="l10.43">   let messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+  let sizeToExpunge = 0;</span>
<a href="#l10.45"></a><span id="l10.45">   while (enumerator.hasMoreElements()) {</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-    let header = enumerator.getNext();</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+    let header = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l10.48"></a><span id="l10.48">     if (!enumerator.hasMoreElements()) {</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-      do_check_true(header instanceof Ci.nsIMsgDBHdr);</span>
<a href="#l10.50"></a><span id="l10.50">       messages.appendElement(header, false);</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+      sizeToExpunge = header.messageSize;</span>
<a href="#l10.52"></a><span id="l10.52">     }</span>
<a href="#l10.53"></a><span id="l10.53">   }</span>
<a href="#l10.54"></a><span id="l10.54">   gInbox.deleteMessages(messages, null, true, false, null, false);</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+  do_check_eq(gInbox.expungedBytes, sizeToExpunge);</span>
<a href="#l10.56"></a><span id="l10.56"> </span>
<a href="#l10.57"></a><span id="l10.57">   /* Unfortunately, the compaction now would kill the sparse markings in the file</span>
<a href="#l10.58"></a><span id="l10.58">    * so it will really take 4GiB of space in the filesystem and may be slow</span>
<a href="#l10.59"></a><span id="l10.59">    * (e.g. it takes ~450s on TB-try). Therefore we run this part of the test randomly,</span>
<a href="#l10.60"></a><span id="l10.60">    * only in 1 of 100 runs. Considering the number of times all the tests are run</span>
<a href="#l10.61"></a><span id="l10.61">    * per check-in, this still runs this test after several check-ins.*/</span>
<a href="#l10.62"></a><span id="l10.62">   if (Math.random() * 100 &lt; 1) {</span>
<a href="#l10.63"></a><span id="l10.63">     // Note: compact() will also add 'X-Mozilla-Status' and 'X-Mozilla-Status2'</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineat">@@ -367,30 +369,35 @@ function compactUnder4GiB()</span>
<a href="#l10.65"></a><span id="l10.65">   // the values were properly serialized to the database.</span>
<a href="#l10.66"></a><span id="l10.66">   gInbox.ForceDBClosed();</span>
<a href="#l10.67"></a><span id="l10.67">   gInbox.msgDatabase = null;</span>
<a href="#l10.68"></a><span id="l10.68">   gInbox.getDatabaseWOReparse();</span>
<a href="#l10.69"></a><span id="l10.69"> </span>
<a href="#l10.70"></a><span id="l10.70">   do_check_eq(gInbox.sizeOnDisk, folderSize);</span>
<a href="#l10.71"></a><span id="l10.71">   do_check_eq(gInbox.getTotalMessages(false), totalMsgs);</span>
<a href="#l10.72"></a><span id="l10.72"> </span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-  // Very first header in msgDB is retained,</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-  // then all other headers are marked as deleted.</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-  let msgDB = gInbox.msgDatabase;</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-  let enumerator = msgDB.EnumerateMessages();</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-  let firstHdr = true;</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+  // Very last header in folder is retained,</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+  // but all other preceding headers are marked as deleted.</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+  let enumerator = gInbox.messages;</span>
<a href="#l10.81"></a><span id="l10.81">   let messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+  let sizeToExpunge = gInbox.expungedBytes; // If compact in compactOver4GB was skipped, this is not 0.</span>
<a href="#l10.83"></a><span id="l10.83">   while (enumerator.hasMoreElements()) {</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-    let header = enumerator.getNext();</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-    if (header instanceof Ci.nsIMsgDBHdr &amp;&amp; !firstHdr)</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+    let header = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+    if (enumerator.hasMoreElements()) {</span>
<a href="#l10.88"></a><span id="l10.88">       messages.appendElement(header, false);</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-    firstHdr = false;</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+      sizeToExpunge += header.messageSize;</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+    }</span>
<a href="#l10.92"></a><span id="l10.92">   }</span>
<a href="#l10.93"></a><span id="l10.93">   gInbox.deleteMessages(messages, null, true, false, null, false);</span>
<a href="#l10.94"></a><span id="l10.94"> </span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+  // Bug 894012: size of messages to expunge is now higher than 4GB.</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+  // Only the small 1MiB message remains.</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+  do_check_eq(gInbox.expungedBytes, sizeToExpunge);</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+  do_check_true(sizeToExpunge &gt; kSizeLimit);</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+</span>
<a href="#l10.100"></a><span id="l10.100">   // Note: compact() will also add 'X-Mozilla-Status' and 'X-Mozilla-Status2'</span>
<a href="#l10.101"></a><span id="l10.101">   // lines to message(s).</span>
<a href="#l10.102"></a><span id="l10.102">   gInbox.compact(CompactListener_compactUnder4GiB, null);</span>
<a href="#l10.103"></a><span id="l10.103">   // Test ends after compaction is done.</span>
<a href="#l10.104"></a><span id="l10.104"> }</span>
<a href="#l10.105"></a><span id="l10.105"> </span>
<a href="#l10.106"></a><span id="l10.106"> var ParseListener_run_test =</span>
<a href="#l10.107"></a><span id="l10.107"> {</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineat">@@ -424,16 +431,17 @@ var ParseListener_growOver4GiB =</span>
<a href="#l10.109"></a><span id="l10.109">     do_check_true(gInbox.sizeOnDisk &gt; kSizeLimit);</span>
<a href="#l10.110"></a><span id="l10.110">     // Bug 813459</span>
<a href="#l10.111"></a><span id="l10.111">     // Check if the OnItemIntPropertyChanged folder listener hook can return</span>
<a href="#l10.112"></a><span id="l10.112">     // values above 2^32 for properties where it is relevant.</span>
<a href="#l10.113"></a><span id="l10.113">     do_check_eq(FListener.sizeHistory(0), gInbox.sizeOnDisk);</span>
<a href="#l10.114"></a><span id="l10.114">     do_check_true(FListener.sizeHistory(1) &lt; FListener.sizeHistory(0));</span>
<a href="#l10.115"></a><span id="l10.115">     do_check_eq(FListener.msgsHistory(0),</span>
<a href="#l10.116"></a><span id="l10.116">                 FListener.msgsHistory(1) + gExpectedNewMessages);</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+    do_check_eq(gInbox.expungedBytes, 0);</span>
<a href="#l10.118"></a><span id="l10.118"> </span>
<a href="#l10.119"></a><span id="l10.119">     copyIntoOver4GiB();</span>
<a href="#l10.120"></a><span id="l10.120">   }</span>
<a href="#l10.121"></a><span id="l10.121"> };</span>
<a href="#l10.122"></a><span id="l10.122"> </span>
<a href="#l10.123"></a><span id="l10.123"> var ParseListener_copyIntoOver4GiB =</span>
<a href="#l10.124"></a><span id="l10.124"> {</span>
<a href="#l10.125"></a><span id="l10.125">   OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineat">@@ -485,15 +493,15 @@ var CompactListener_compactUnder4GiB =</span>
<a href="#l10.127"></a><span id="l10.127">     do_check_eq(FListener.msgsHistory(0), 1);</span>
<a href="#l10.128"></a><span id="l10.128"> </span>
<a href="#l10.129"></a><span id="l10.129">     endTest();</span>
<a href="#l10.130"></a><span id="l10.130">   }</span>
<a href="#l10.131"></a><span id="l10.131"> };</span>
<a href="#l10.132"></a><span id="l10.132"> </span>
<a href="#l10.133"></a><span id="l10.133"> function endTest()</span>
<a href="#l10.134"></a><span id="l10.134"> {</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineminus">-   MailServices.mailSession.RemoveFolderListener(FListener);</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+  MailServices.mailSession.RemoveFolderListener(FListener);</span>
<a href="#l10.137"></a><span id="l10.137">   // Free up disk space - if you want to look at the file after running</span>
<a href="#l10.138"></a><span id="l10.138">   // this test, comment out this line.</span>
<a href="#l10.139"></a><span id="l10.139">   gInbox.filePath.remove(false);</span>
<a href="#l10.140"></a><span id="l10.140"> </span>
<a href="#l10.141"></a><span id="l10.141">   do_test_finished();</span>
<a href="#l10.142"></a><span id="l10.142"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -724,17 +724,17 @@ nsMsgNewsFolder::UpdateSummaryFromNNTPIn</span>
<a href="#l11.4"></a><span id="l11.4">   {</span>
<a href="#l11.5"></a><span id="l11.5">     mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l11.6"></a><span id="l11.6">     mDatabase-&gt;RemoveListener(this);</span>
<a href="#l11.7"></a><span id="l11.7">     mDatabase = nullptr;</span>
<a href="#l11.8"></a><span id="l11.8">   }</span>
<a href="#l11.9"></a><span id="l11.9">   return NS_OK;</span>
<a href="#l11.10"></a><span id="l11.10"> }</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-NS_IMETHODIMP nsMsgNewsFolder::GetExpungedBytesCount(uint32_t *count)</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+NS_IMETHODIMP nsMsgNewsFolder::GetExpungedBytesCount(int64_t *count)</span>
<a href="#l11.14"></a><span id="l11.14"> {</span>
<a href="#l11.15"></a><span id="l11.15">   NS_ENSURE_ARG_POINTER(count);</span>
<a href="#l11.16"></a><span id="l11.16">   *count = mExpungedBytes;</span>
<a href="#l11.17"></a><span id="l11.17">   return NS_OK;</span>
<a href="#l11.18"></a><span id="l11.18"> }</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20"> NS_IMETHODIMP nsMsgNewsFolder::GetDeletable(bool *deletable)</span>
<a href="#l11.21"></a><span id="l11.21"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/news/src/nsNewsFolder.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsFolder.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -43,17 +43,17 @@ public:</span>
<a href="#l12.4"></a><span id="l12.4">   NS_IMETHOD Delete() MOZ_OVERRIDE;</span>
<a href="#l12.5"></a><span id="l12.5">   NS_IMETHOD Rename(const nsAString&amp; newName,</span>
<a href="#l12.6"></a><span id="l12.6">                      nsIMsgWindow *msgWindow) MOZ_OVERRIDE;</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8">   NS_IMETHOD GetAbbreviatedName(nsAString&amp; aAbbreviatedName) MOZ_OVERRIDE;</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10">   NS_IMETHOD GetFolderURL(nsACString&amp; url) MOZ_OVERRIDE;</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  NS_IMETHOD GetExpungedBytesCount(uint32_t *count);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  NS_IMETHOD GetExpungedBytesCount(int64_t *count);</span>
<a href="#l12.14"></a><span id="l12.14">   NS_IMETHOD GetDeletable(bool *deletable) MOZ_OVERRIDE;</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16">   NS_IMETHOD RefreshSizeOnDisk();</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18">   NS_IMETHOD GetSizeOnDisk(int64_t *size) MOZ_OVERRIDE;</span>
<a href="#l12.19"></a><span id="l12.19"> </span>
<a href="#l12.20"></a><span id="l12.20">   NS_IMETHOD GetDBFolderInfoAndDB(nsIDBFolderInfo **folderInfo,</span>
<a href="#l12.21"></a><span id="l12.21">                                   nsIMsgDatabase **db) MOZ_OVERRIDE;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -111,17 +111,17 @@ protected:</span>
<a href="#l12.23"></a><span id="l12.23">   int32_t HandleNewsrcLine(const char * line, uint32_t line_size);</span>
<a href="#l12.24"></a><span id="l12.24">   virtual void GetIncomingServerType(nsCString&amp; serverType) MOZ_OVERRIDE</span>
<a href="#l12.25"></a><span id="l12.25">   {</span>
<a href="#l12.26"></a><span id="l12.26">     serverType.AssignLiteral(&quot;nntp&quot;);</span>
<a href="#l12.27"></a><span id="l12.27">   }</span>
<a href="#l12.28"></a><span id="l12.28">   virtual nsresult CreateBaseMessageURI(const nsACString&amp; aURI) MOZ_OVERRIDE;</span>
<a href="#l12.29"></a><span id="l12.29"> </span>
<a href="#l12.30"></a><span id="l12.30"> protected:</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-  uint32_t  mExpungedBytes;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+  int64_t mExpungedBytes;</span>
<a href="#l12.33"></a><span id="l12.33">   bool mGettingNews;</span>
<a href="#l12.34"></a><span id="l12.34">   bool mInitialized;</span>
<a href="#l12.35"></a><span id="l12.35">   bool m_downloadMessageForOfflineUse;</span>
<a href="#l12.36"></a><span id="l12.36">   bool m_downloadingMultipleMessages;</span>
<a href="#l12.37"></a><span id="l12.37"> </span>
<a href="#l12.38"></a><span id="l12.38">   nsCString mOptionLines;</span>
<a href="#l12.39"></a><span id="l12.39">   nsCString mUnsubscribedNewsgroupLines;</span>
<a href="#l12.40"></a><span id="l12.40">   nsMsgKeySet *mReadSet;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

