<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26006:6fb9189f3a628e1bd1af3a91c004ce25a99b102a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 6fb9189f3a628e1bd1af3a91c004ce25a99b102a" />
<meta property="og:url" content="/comm-central/rev/6fb9189f3a628e1bd1af3a91c004ce25a99b102a" />
<meta property="og:description" content="Bug 1515877 - Turn on ESLint in mailnews/test/resources; r=aceman DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 6fb9189f3a628e1bd1af3a91c004ce25a99b102a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/6fb9189f3a628e1bd1af3a91c004ce25a99b102a">shortlog</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/6fb9189f3a628e1bd1af3a91c004ce25a99b102a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a">files</a> |
changeset |
<a href="/comm-central/raw-rev/6fb9189f3a628e1bd1af3a91c004ce25a99b102a">raw</a>  | <a href="/comm-central/archive/6fb9189f3a628e1bd1af3a91c004ce25a99b102a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">Bug 1515877</a> - Turn on ESLint in mailnews/test/resources; r=aceman DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 04 Mar 2019 21:13:38 +1300</td></tr>

<tr>
 <td>changeset 26006</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/6fb9189f3a628e1bd1af3a91c004ce25a99b102a">6fb9189f3a628e1bd1af3a91c004ce25a99b102a</a></td>
</tr>



<tr>
<td>parent 26005</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b24cc1864097a56af4fa184f3be9d41aa4a5b554">b24cc1864097a56af4fa184f3be9d41aa4a5b554</a>
</td>
</tr>

<tr>
<td>child 26007</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9385db6fc2ae25f9f3c436aa3147e130c539f1d4">9385db6fc2ae25f9f3c436aa3147e130c539f1d4</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=6fb9189f3a628e1bd1af3a91c004ce25a99b102a">15605</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Mon, 04 Mar 2019 08:14:12 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@6fb9189f3a62 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6fb9189f3a628e1bd1af3a91c004ce25a99b102a">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6fb9189f3a628e1bd1af3a91c004ce25a99b102a&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6fb9189f3a628e1bd1af3a91c004ce25a99b102a&newProject=comm-central&newRevision=6fb9189f3a628e1bd1af3a91c004ce25a99b102a&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6fb9189f3a628e1bd1af3a91c004ce25a99b102a&newProject=comm-central&newRevision=6fb9189f3a628e1bd1af3a91c004ce25a99b102a&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6fb9189f3a628e1bd1af3a91c004ce25a99b102a&newProject=comm-central&newRevision=6fb9189f3a628e1bd1af3a91c004ce25a99b102a&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">1515877</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">Bug 1515877</a> - Turn on ESLint in mailnews/test/resources; r=aceman DONTBUILD</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/.eslintignore">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/.eslintignore">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/.eslintignore">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/.eslintignore">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mail/test/mozmill/shared-modules/test-nntp-helpers.js">mail/test/mozmill/shared-modules/test-nntp-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mail/test/mozmill/shared-modules/test-nntp-helpers.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mail/test/mozmill/shared-modules/test-nntp-helpers.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mail/test/mozmill/shared-modules/test-nntp-helpers.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mail/test/mozmill/shared-modules/test-nntp-helpers.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mail/test/mozmill/shared-modules/test-nntp-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/.eslintrc.js">mailnews/test/resources/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/IMAPpump.js">mailnews/test/resources/IMAPpump.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/IMAPpump.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/IMAPpump.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/IMAPpump.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/IMAPpump.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/IMAPpump.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/MockFactory.js">mailnews/test/resources/MockFactory.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/MockFactory.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/MockFactory.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/MockFactory.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/MockFactory.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/MockFactory.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/NetworkTestUtils.jsm">mailnews/test/resources/NetworkTestUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/NetworkTestUtils.jsm">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/NetworkTestUtils.jsm">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/NetworkTestUtils.jsm">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/NetworkTestUtils.jsm">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/NetworkTestUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/POP3pump.js">mailnews/test/resources/POP3pump.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/POP3pump.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/POP3pump.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/POP3pump.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/POP3pump.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/POP3pump.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/PromiseTestUtils.jsm">mailnews/test/resources/PromiseTestUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/PromiseTestUtils.jsm">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/PromiseTestUtils.jsm">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/PromiseTestUtils.jsm">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/PromiseTestUtils.jsm">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/PromiseTestUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/abSetup.js">mailnews/test/resources/abSetup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/abSetup.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/abSetup.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/abSetup.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/abSetup.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/abSetup.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/alertTestUtils.js">mailnews/test/resources/alertTestUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/alertTestUtils.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/alertTestUtils.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/alertTestUtils.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/alertTestUtils.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/alertTestUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/asyncTestUtils.js">mailnews/test/resources/asyncTestUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/asyncTestUtils.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/asyncTestUtils.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/asyncTestUtils.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/asyncTestUtils.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/asyncTestUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/filterTestUtils.js">mailnews/test/resources/filterTestUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/filterTestUtils.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/filterTestUtils.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/filterTestUtils.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/filterTestUtils.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/filterTestUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/folderEventLogHelper.js">mailnews/test/resources/folderEventLogHelper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/folderEventLogHelper.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/folderEventLogHelper.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/folderEventLogHelper.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/folderEventLogHelper.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/folderEventLogHelper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/localAccountUtils.js">mailnews/test/resources/localAccountUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/localAccountUtils.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/localAccountUtils.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/localAccountUtils.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/localAccountUtils.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/localAccountUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/logHelper.js">mailnews/test/resources/logHelper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/logHelper.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/logHelper.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/logHelper.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/logHelper.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/logHelper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/mailShutdown.js">mailnews/test/resources/mailShutdown.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/mailShutdown.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/mailShutdown.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/mailShutdown.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/mailShutdown.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/mailShutdown.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/mailTestUtils.js">mailnews/test/resources/mailTestUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/mailTestUtils.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/mailTestUtils.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/mailTestUtils.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/mailTestUtils.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/mailTestUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/messageGenerator.js">mailnews/test/resources/messageGenerator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/messageGenerator.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/messageGenerator.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/messageGenerator.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/messageGenerator.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/messageGenerator.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/messageInjection.js">mailnews/test/resources/messageInjection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/messageInjection.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/messageInjection.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/messageInjection.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/messageInjection.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/messageInjection.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/messageModifier.js">mailnews/test/resources/messageModifier.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/messageModifier.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/messageModifier.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/messageModifier.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/messageModifier.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/messageModifier.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/msgFolderListenerSetup.js">mailnews/test/resources/msgFolderListenerSetup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/msgFolderListenerSetup.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/msgFolderListenerSetup.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/msgFolderListenerSetup.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/msgFolderListenerSetup.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/msgFolderListenerSetup.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/passwordStorage.js">mailnews/test/resources/passwordStorage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/passwordStorage.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/passwordStorage.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/passwordStorage.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/passwordStorage.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/passwordStorage.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/searchTestUtils.js">mailnews/test/resources/searchTestUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/searchTestUtils.js">file</a> |
<a href="/comm-central/annotate/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/searchTestUtils.js">annotate</a> |
<a href="/comm-central/diff/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/searchTestUtils.js">diff</a> |
<a href="/comm-central/comparison/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/searchTestUtils.js">comparison</a> |
<a href="/comm-central/log/6fb9189f3a628e1bd1af3a91c004ce25a99b102a/mailnews/test/resources/searchTestUtils.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -32,17 +32,17 @@ mailnews/base/*</span>
<a href="#l1.4"></a><span id="l1.4"> mailnews/build/*</span>
<a href="#l1.5"></a><span id="l1.5"> mailnews/compose/*</span>
<a href="#l1.6"></a><span id="l1.6"> mailnews/db/*</span>
<a href="#l1.7"></a><span id="l1.7"> mailnews/imap/*</span>
<a href="#l1.8"></a><span id="l1.8"> mailnews/import/*</span>
<a href="#l1.9"></a><span id="l1.9"> mailnews/intl/*</span>
<a href="#l1.10"></a><span id="l1.10"> mailnews/jsaccount/*</span>
<a href="#l1.11"></a><span id="l1.11"> mailnews/mime/*</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-mailnews/test/*</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+mailnews/test/fakeserver/*</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15"> # mailnews/extensions exclusions</span>
<a href="#l1.16"></a><span id="l1.16"> mailnews/extensions/*</span>
<a href="#l1.17"></a><span id="l1.17"> !mailnews/extensions/newsblog</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> # mail exclusions</span>
<a href="#l1.20"></a><span id="l1.20"> mail/app/profile/all-thunderbird.js</span>
<a href="#l1.21"></a><span id="l1.21"> mail/app/profile/channel-prefs.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-nntp-helpers.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-nntp-helpers.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -45,18 +45,16 @@ function setupModule() {</span>
<a href="#l2.4"></a><span id="l2.4">     Cc: Cc,</span>
<a href="#l2.5"></a><span id="l2.5">     Ci: Ci,</span>
<a href="#l2.6"></a><span id="l2.6">     Cu: Cu,</span>
<a href="#l2.7"></a><span id="l2.7">     // fake some xpcshell stuff</span>
<a href="#l2.8"></a><span id="l2.8">     _TEST_FILE: [&quot;mozmill&quot;],</span>
<a href="#l2.9"></a><span id="l2.9">     do_throw: function(aMsg) {</span>
<a href="#l2.10"></a><span id="l2.10">       throw new Error(aMsg);</span>
<a href="#l2.11"></a><span id="l2.11">     },</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    do_check_eq: function() {},</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-    do_check_neq: function() {},</span>
<a href="#l2.14"></a><span id="l2.14">   };</span>
<a href="#l2.15"></a><span id="l2.15">   folderDisplayHelper.load_via_src_path(&quot;fakeserver/nntpd.js&quot;, testHelperModule);</span>
<a href="#l2.16"></a><span id="l2.16">   folderDisplayHelper.load_via_src_path(&quot;fakeserver/maild.js&quot;, testHelperModule);</span>
<a href="#l2.17"></a><span id="l2.17"> }</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> function installInto(module) {</span>
<a href="#l2.20"></a><span id="l2.20">   setupModule();</span>
<a href="#l2.21"></a><span id="l2.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -46,46 +46,46 @@ function addFolder(parent, folderName, s</span>
<a href="#l3.4"></a><span id="l3.4">  * classification because no messages have yet been marked as junk and there</span>
<a href="#l3.5"></a><span id="l3.5">  * are no traits configured, aJunkProcessed and aTraitProcessed will be false.</span>
<a href="#l3.6"></a><span id="l3.6">  */</span>
<a href="#l3.7"></a><span id="l3.7"> function copyFileMessage(file, destFolder, isDraftOrTemplate)</span>
<a href="#l3.8"></a><span id="l3.8"> {</span>
<a href="#l3.9"></a><span id="l3.9">   copyListener.mFolderStoredIn = destFolder;</span>
<a href="#l3.10"></a><span id="l3.10">   gExpectedEvents = [[MailServices.mfn.msgAdded, gHdrsReceived],</span>
<a href="#l3.11"></a><span id="l3.11">                      [MailServices.mfn.msgsClassified, gHdrsReceived, false, false]];</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  gCopyService.CopyFileMessage(file, destFolder, null, isDraftOrTemplate, 0, &quot;&quot;,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-                               copyListener, null);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  MailServices.copy.CopyFileMessage(file, destFolder, null, isDraftOrTemplate, 0, &quot;&quot;,</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+                                    copyListener, null);</span>
<a href="#l3.16"></a><span id="l3.16">   gCurrStatus |= kStatus.functionCallDone;</span>
<a href="#l3.17"></a><span id="l3.17">   if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l3.18"></a><span id="l3.18">     resetStatusAndProceed();</span>
<a href="#l3.19"></a><span id="l3.19"> }</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21"> function copyMessages(items, isMove, srcFolder, destFolder)</span>
<a href="#l3.22"></a><span id="l3.22"> {</span>
<a href="#l3.23"></a><span id="l3.23">   var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l3.24"></a><span id="l3.24">   items.forEach(function (item) {</span>
<a href="#l3.25"></a><span id="l3.25">     array.appendElement(item);</span>
<a href="#l3.26"></a><span id="l3.26">   });</span>
<a href="#l3.27"></a><span id="l3.27">   gExpectedEvents = [</span>
<a href="#l3.28"></a><span id="l3.28">     [MailServices.mfn.msgsMoveCopyCompleted, isMove, items, destFolder, true]];</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-  gCopyService.CopyMessages(srcFolder, array, destFolder, isMove, copyListener,</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-                            null, true);</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+  MailServices.copy.CopyMessages(srcFolder, array, destFolder, isMove, copyListener,</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+                                 null, true);</span>
<a href="#l3.33"></a><span id="l3.33">   gCurrStatus |= kStatus.functionCallDone;</span>
<a href="#l3.34"></a><span id="l3.34">   if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l3.35"></a><span id="l3.35">     resetStatusAndProceed();</span>
<a href="#l3.36"></a><span id="l3.36"> }</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38"> function copyFolders(items, isMove, destFolder)</span>
<a href="#l3.39"></a><span id="l3.39"> {</span>
<a href="#l3.40"></a><span id="l3.40">   var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l3.41"></a><span id="l3.41">   items.forEach(function (item) {</span>
<a href="#l3.42"></a><span id="l3.42">     array.appendElement(item);</span>
<a href="#l3.43"></a><span id="l3.43">   });</span>
<a href="#l3.44"></a><span id="l3.44">   gExpectedEvents = [[MailServices.mfn.folderMoveCopyCompleted, isMove, items, destFolder]];</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-  gCopyService.CopyFolders(array, destFolder, isMove, copyListener, null);</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+  MailServices.copy.CopyFolders(array, destFolder, isMove, copyListener, null);</span>
<a href="#l3.47"></a><span id="l3.47">   gCurrStatus |= kStatus.functionCallDone;</span>
<a href="#l3.48"></a><span id="l3.48">   if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l3.49"></a><span id="l3.49">     resetStatusAndProceed();</span>
<a href="#l3.50"></a><span id="l3.50"> }</span>
<a href="#l3.51"></a><span id="l3.51"> </span>
<a href="#l3.52"></a><span id="l3.52"> function deleteMessages(srcFolder, items, deleteStorage, isMove)</span>
<a href="#l3.53"></a><span id="l3.53"> {</span>
<a href="#l3.54"></a><span id="l3.54">   var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -64,17 +64,17 @@ function copyFileMessage(file, messageId</span>
<a href="#l4.4"></a><span id="l4.4">   // message header, and fakeserver doesn't implement it yet. So get it to fail</span>
<a href="#l4.5"></a><span id="l4.5">   // earlier by *not* sending the message id.</span>
<a href="#l4.6"></a><span id="l4.6">   // copyListener.mMessageId = messageId;</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8">   // Instead store the message id in gExpectedEvents, so we can match that up</span>
<a href="#l4.9"></a><span id="l4.9">   gExpectedEvents = [[MailServices.mfn.msgAdded, {expectedMessageId: messageId}],</span>
<a href="#l4.10"></a><span id="l4.10">                      [MailServices.mfn.msgsClassified, [messageId], false, false]];</span>
<a href="#l4.11"></a><span id="l4.11">   destFolder.updateFolder(null);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  gCopyService.CopyFileMessage(file, destFolder, null, true, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  MailServices.copy.CopyFileMessage(file, destFolder, null, true, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l4.14"></a><span id="l4.14">   gCurrStatus |= kStatus.functionCallDone;</span>
<a href="#l4.15"></a><span id="l4.15">   gServer.performTest(&quot;APPEND&quot;);</span>
<a href="#l4.16"></a><span id="l4.16">   // Allow some time for the append operation to complete, so update folder</span>
<a href="#l4.17"></a><span id="l4.17">   // every second</span>
<a href="#l4.18"></a><span id="l4.18">   gFolderBeingUpdated = destFolder;</span>
<a href="#l4.19"></a><span id="l4.19">   doUpdateFolder(gTest);</span>
<a href="#l4.20"></a><span id="l4.20"> }</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -133,17 +133,17 @@ function copyMessages(messages, isMove, </span>
<a href="#l4.23"></a><span id="l4.23">     gExpectedEvents.push([MailServices.mfn.msgKeyChanged,</span>
<a href="#l4.24"></a><span id="l4.24">                           {expectedMessageId: message.messageId}]);</span>
<a href="#l4.25"></a><span id="l4.25">     gExpectedEvents.push([MailServices.mfn.msgAdded,</span>
<a href="#l4.26"></a><span id="l4.26">                           {expectedMessageId: message.messageId}]);</span>
<a href="#l4.27"></a><span id="l4.27">   });</span>
<a href="#l4.28"></a><span id="l4.28">   gExpectedEvents.push([MailServices.mfn.msgsClassified,</span>
<a href="#l4.29"></a><span id="l4.29">                         messages.map(hdr =&gt; hdr.messageId),</span>
<a href="#l4.30"></a><span id="l4.30">                         false, false]);</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  gCopyService.CopyMessages(srcFolder, array, destFolder, isMove, copyListener, gMsgWindow, true);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+  MailServices.copy.CopyMessages(srcFolder, array, destFolder, isMove, copyListener, gMsgWindow, true);</span>
<a href="#l4.33"></a><span id="l4.33">   gCurrStatus |= kStatus.functionCallDone;</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35">   gServer.performTest(&quot;COPY&quot;);</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37">   gFolderBeingUpdated = destFolder;</span>
<a href="#l4.38"></a><span id="l4.38">   doUpdateFolder(gTest);</span>
<a href="#l4.39"></a><span id="l4.39">   if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l4.40"></a><span id="l4.40">     resetStatusAndProceed();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mailnews/test/resources/.eslintrc.js</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,5 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+module.exports = {</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+  &quot;extends&quot;: &quot;plugin:mozilla/xpcshell-test&quot;,</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/test/resources/IMAPpump.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/test/resources/IMAPpump.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,25 +1,25 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.5"></a><span id="l6.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> /*</span>
<a href="#l6.10"></a><span id="l6.10">  * This file provides a simple interface to the imap fake server. Demonstration</span>
<a href="#l6.11"></a><span id="l6.11">  *  of its use can be found in test_imapPump.js</span>
<a href="#l6.12"></a><span id="l6.12">  *</span>
<a href="#l6.13"></a><span id="l6.13">  * The code that forms the core of this file, in its original incarnation,</span>
<a href="#l6.14"></a><span id="l6.14">  *  was test_imapFolderCopy.js  There have been several iterations since</span>
<a href="#l6.15"></a><span id="l6.15">  *  then.</span>
<a href="#l6.16"></a><span id="l6.16">  */</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18"> var EXPORTED_SYMBOLS = [</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-  'IMAPPump',</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-  'setupIMAPPump',</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-  'teardownIMAPPump'</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+  &quot;IMAPPump&quot;,</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+  &quot;setupIMAPPump&quot;,</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+  &quot;teardownIMAPPump&quot;,</span>
<a href="#l6.25"></a><span id="l6.25"> ];</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.28"></a><span id="l6.28"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l6.29"></a><span id="l6.29"> var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l6.30"></a><span id="l6.30"> var {localAccountUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/localAccountUtils.js&quot;);</span>
<a href="#l6.31"></a><span id="l6.31"> var {gThreadManager, nsMailServer} = ChromeUtils.import(&quot;resource://testing-common/mailnews/maild.js&quot;);</span>
<a href="#l6.32"></a><span id="l6.32"> var {</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineat">@@ -32,21 +32,20 @@ ChromeUtils.import(&quot;resource://testing-c</span>
<a href="#l6.34"></a><span id="l6.34"> var {updateAppInfo} = ChromeUtils.import(&quot;resource://testing-common/AppInfo.jsm&quot;);</span>
<a href="#l6.35"></a><span id="l6.35"> </span>
<a href="#l6.36"></a><span id="l6.36"> // define globals</span>
<a href="#l6.37"></a><span id="l6.37"> var IMAPPump = {</span>
<a href="#l6.38"></a><span id="l6.38">   daemon: null,         // the imap fake server daemon</span>
<a href="#l6.39"></a><span id="l6.39">   server: null,         // the imap fake server</span>
<a href="#l6.40"></a><span id="l6.40">   incomingServer: null, // nsIMsgIncomingServer for the imap server</span>
<a href="#l6.41"></a><span id="l6.41">   inbox: null,          // nsIMsgFolder/nsIMsgImapMailFolder for imap inbox</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-  mailbox: null         // imap fake server mailbox</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+  mailbox: null,        // imap fake server mailbox</span>
<a href="#l6.44"></a><span id="l6.44"> };</span>
<a href="#l6.45"></a><span id="l6.45"> </span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-function setupIMAPPump(extensions)</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-{</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+function setupIMAPPump(extensions) {</span>
<a href="#l6.49"></a><span id="l6.49">   // Create Application info if we need it.</span>
<a href="#l6.50"></a><span id="l6.50">   updateAppInfo();</span>
<a href="#l6.51"></a><span id="l6.51"> </span>
<a href="#l6.52"></a><span id="l6.52">   // These are copied from imap's head_server.js to here so we can run</span>
<a href="#l6.53"></a><span id="l6.53">   //   this from any directory.</span>
<a href="#l6.54"></a><span id="l6.54">   function makeServer(daemon, infoString) {</span>
<a href="#l6.55"></a><span id="l6.55">     if (infoString in imapd.configurations)</span>
<a href="#l6.56"></a><span id="l6.56">       return makeServer(daemon, imapd.configurations[infoString].join(&quot;,&quot;));</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineat">@@ -111,27 +110,25 @@ function setupIMAPPump(extensions)</span>
<a href="#l6.58"></a><span id="l6.58">   IMAPPump.incomingServer.performExpand(null);</span>
<a href="#l6.59"></a><span id="l6.59"> </span>
<a href="#l6.60"></a><span id="l6.60">   IMAPPump.inbox = IMAPPump.incomingServer.rootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l6.61"></a><span id="l6.61">   IMAPPump.mailbox = IMAPPump.daemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l6.62"></a><span id="l6.62">   IMAPPump.inbox instanceof Ci.nsIMsgImapMailFolder;</span>
<a href="#l6.63"></a><span id="l6.63"> }</span>
<a href="#l6.64"></a><span id="l6.64"> </span>
<a href="#l6.65"></a><span id="l6.65"> // This will clear not only the imap accounts but also local accounts.</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-function teardownIMAPPump()</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-{</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+function teardownIMAPPump() {</span>
<a href="#l6.69"></a><span id="l6.69">   // try to finish any pending operations</span>
<a href="#l6.70"></a><span id="l6.70">   let thread = gThreadManager.currentThread;</span>
<a href="#l6.71"></a><span id="l6.71">   while (thread.hasPendingEvents())</span>
<a href="#l6.72"></a><span id="l6.72">     thread.processNextEvent(true);</span>
<a href="#l6.73"></a><span id="l6.73"> </span>
<a href="#l6.74"></a><span id="l6.74">   IMAPPump.inbox = null;</span>
<a href="#l6.75"></a><span id="l6.75">   try {</span>
<a href="#l6.76"></a><span id="l6.76">     let serverSink = IMAPPump.incomingServer.QueryInterface(Ci.nsIImapServerSink);</span>
<a href="#l6.77"></a><span id="l6.77">     serverSink.abortQueuedUrls();</span>
<a href="#l6.78"></a><span id="l6.78">     IMAPPump.incomingServer.closeCachedConnections();</span>
<a href="#l6.79"></a><span id="l6.79">     IMAPPump.server.resetTest();</span>
<a href="#l6.80"></a><span id="l6.80">     IMAPPump.server.stop();</span>
<a href="#l6.81"></a><span id="l6.81">     MailServices.accounts.removeIncomingServer(IMAPPump.incomingServer, false);</span>
<a href="#l6.82"></a><span id="l6.82">     localAccountUtils.clearAll();</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-  } catch (ex) {dump(ex);}</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+  } catch (ex) { dump(ex); }</span>
<a href="#l6.86"></a><span id="l6.86"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/test/resources/MockFactory.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/test/resources/MockFactory.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,8 +1,12 @@</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+</span>
<a href="#l7.8"></a><span id="l7.8"> this.EXPORTED_SYMBOLS = [&quot;MockFactory&quot;];</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10"> var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12"> var Cm = Components.manager;</span>
<a href="#l7.13"></a><span id="l7.13"> </span>
<a href="#l7.14"></a><span id="l7.14"> var MockFactory = {</span>
<a href="#l7.15"></a><span id="l7.15">   _registeredComponents: {},</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineat">@@ -13,27 +17,27 @@ var MockFactory = {</span>
<a href="#l7.17"></a><span id="l7.17">    * @param contractID The contract ID of the interface which is overridden by</span>
<a href="#l7.18"></a><span id="l7.18">                        the mock.</span>
<a href="#l7.19"></a><span id="l7.19">    *                   e.g. &quot;@mozilla.org/messenger/account-manager;1&quot;</span>
<a href="#l7.20"></a><span id="l7.20">    * @param mock An object which implements interfaces for the contract ID.</span>
<a href="#l7.21"></a><span id="l7.21">    * @param args       An array which is passed in the constructor of mock.</span>
<a href="#l7.22"></a><span id="l7.22">    *</span>
<a href="#l7.23"></a><span id="l7.23">    * @return           The UUID of the mock.</span>
<a href="#l7.24"></a><span id="l7.24">    */</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-  register: function(contractID, mock, args) {</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+  register(contractID, mock, args) {</span>
<a href="#l7.27"></a><span id="l7.27">     let uuid = Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l7.28"></a><span id="l7.28">                  .getService(Ci.nsIUUIDGenerator)</span>
<a href="#l7.29"></a><span id="l7.29">                  .generateUUID()</span>
<a href="#l7.30"></a><span id="l7.30">                  .toString();</span>
<a href="#l7.31"></a><span id="l7.31"> </span>
<a href="#l7.32"></a><span id="l7.32">     let originalCID = Cm.nsIComponentRegistrar.contractIDToCID(contractID);</span>
<a href="#l7.33"></a><span id="l7.33">     let originalFactory = Cm.getClassObject(Cc[contractID], Ci.nsIFactory);</span>
<a href="#l7.34"></a><span id="l7.34"> </span>
<a href="#l7.35"></a><span id="l7.35">     let factory = {</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-      createInstance: function(outer, iid) {</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+      createInstance(outer, iid) {</span>
<a href="#l7.38"></a><span id="l7.38">         if (outer)</span>
<a href="#l7.39"></a><span id="l7.39">           do_throw(Cr.NS_ERROR_NO_AGGREGATION);</span>
<a href="#l7.40"></a><span id="l7.40"> </span>
<a href="#l7.41"></a><span id="l7.41">         let wrappedMock;</span>
<a href="#l7.42"></a><span id="l7.42">         if (mock.prototype &amp;&amp; mock.prototype.constructor)</span>
<a href="#l7.43"></a><span id="l7.43">           wrappedMock = new (mock.bind(null, args));</span>
<a href="#l7.44"></a><span id="l7.44">         else</span>
<a href="#l7.45"></a><span id="l7.45">           wrappedMock = mock;</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineat">@@ -41,55 +45,55 @@ var MockFactory = {</span>
<a href="#l7.47"></a><span id="l7.47">         /*</span>
<a href="#l7.48"></a><span id="l7.48">          * Some interfaces fail to be created an instance since</span>
<a href="#l7.49"></a><span id="l7.49">          * the interface is not registered in xpcshell tests.</span>
<a href="#l7.50"></a><span id="l7.50">          * ex. nsIXULAppInfo.</span>
<a href="#l7.51"></a><span id="l7.51">          */</span>
<a href="#l7.52"></a><span id="l7.52">         try {</span>
<a href="#l7.53"></a><span id="l7.53">           let genuine = originalFactory.createInstance(outer, iid);</span>
<a href="#l7.54"></a><span id="l7.54">           wrappedMock._genuine = genuine;</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-        } catch(ex) {</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+        } catch (ex) {</span>
<a href="#l7.57"></a><span id="l7.57">           dump(ex);</span>
<a href="#l7.58"></a><span id="l7.58">         }</span>
<a href="#l7.59"></a><span id="l7.59"> </span>
<a href="#l7.60"></a><span id="l7.60">         return wrappedMock.QueryInterface(iid);</span>
<a href="#l7.61"></a><span id="l7.61">       },</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-      QueryInterface: ChromeUtils.generateQI([Ci.nsIFactory])</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+      QueryInterface: ChromeUtils.generateQI([Ci.nsIFactory]),</span>
<a href="#l7.64"></a><span id="l7.64">     };</span>
<a href="#l7.65"></a><span id="l7.65"> </span>
<a href="#l7.66"></a><span id="l7.66">     Cm.QueryInterface(Ci.nsIComponentRegistrar)</span>
<a href="#l7.67"></a><span id="l7.67">       .registerFactory(Components.ID(uuid),</span>
<a href="#l7.68"></a><span id="l7.68">                        &quot;A Mock for &quot; + contractID,</span>
<a href="#l7.69"></a><span id="l7.69">                        contractID, factory);</span>
<a href="#l7.70"></a><span id="l7.70"> </span>
<a href="#l7.71"></a><span id="l7.71">     this._registeredComponents[uuid] = {</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-      contractID: contractID,</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-      originalCID: originalCID,</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-      factory: factory</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+      contractID,</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+      originalCID,</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+      factory,</span>
<a href="#l7.78"></a><span id="l7.78">     };</span>
<a href="#l7.79"></a><span id="l7.79"> </span>
<a href="#l7.80"></a><span id="l7.80">     return uuid;</span>
<a href="#l7.81"></a><span id="l7.81">   },</span>
<a href="#l7.82"></a><span id="l7.82"> </span>
<a href="#l7.83"></a><span id="l7.83">   /**</span>
<a href="#l7.84"></a><span id="l7.84">    * Unregister the mock.</span>
<a href="#l7.85"></a><span id="l7.85">    *</span>
<a href="#l7.86"></a><span id="l7.86">    * @param uuid The UUID of the mock.</span>
<a href="#l7.87"></a><span id="l7.87">    */</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-  unregister: function(uuid) {</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+  unregister(uuid) {</span>
<a href="#l7.90"></a><span id="l7.90">     if (!this._registeredComponents[uuid])</span>
<a href="#l7.91"></a><span id="l7.91">       return;</span>
<a href="#l7.92"></a><span id="l7.92"> </span>
<a href="#l7.93"></a><span id="l7.93">     Cm.QueryInterface(Ci.nsIComponentRegistrar)</span>
<a href="#l7.94"></a><span id="l7.94">       .unregisterFactory(Components.ID(uuid),</span>
<a href="#l7.95"></a><span id="l7.95">                          this._registeredComponents[uuid].factory);</span>
<a href="#l7.96"></a><span id="l7.96">     Cm.QueryInterface(Ci.nsIComponentRegistrar)</span>
<a href="#l7.97"></a><span id="l7.97">       .registerFactory(this._registeredComponents[uuid].originalCID, &quot;&quot;,</span>
<a href="#l7.98"></a><span id="l7.98">                        this._registeredComponents[uuid].contractID, null);</span>
<a href="#l7.99"></a><span id="l7.99"> </span>
<a href="#l7.100"></a><span id="l7.100">     delete this._registeredComponents[uuid];</span>
<a href="#l7.101"></a><span id="l7.101">   },</span>
<a href="#l7.102"></a><span id="l7.102"> </span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-  unregisterAll: function() {</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+  unregisterAll() {</span>
<a href="#l7.105"></a><span id="l7.105">     for (let uuid in this._registeredComponents)</span>
<a href="#l7.106"></a><span id="l7.106">       this.unregister(uuid);</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-  }</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+  },</span>
<a href="#l7.109"></a><span id="l7.109"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/test/resources/NetworkTestUtils.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/test/resources/NetworkTestUtils.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,26 +1,23 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.5"></a><span id="l8.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> /**</span>
<a href="#l8.10"></a><span id="l8.10">  * This file provides utilities useful in testing more advanced networking</span>
<a href="#l8.11"></a><span id="l8.11">  * scenarios, such as proxies and SSL connections.</span>
<a href="#l8.12"></a><span id="l8.12">  */</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-this.EXPORTED_SYMBOLS = ['NetworkTestUtils'];</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;NetworkTestUtils&quot;];</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17"> var CC = Components.Constructor;</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> const {NetUtil} = ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-var {Promise} = ChromeUtils.import(&quot;resource://gre/modules/Promise.jsm&quot;);</span>
<a href="#l8.21"></a><span id="l8.21"> const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25"> const ServerSocket = CC(&quot;@mozilla.org/network/server-socket;1&quot;,</span>
<a href="#l8.26"></a><span id="l8.26">                         &quot;nsIServerSocket&quot;,</span>
<a href="#l8.27"></a><span id="l8.27">                         &quot;init&quot;);</span>
<a href="#l8.28"></a><span id="l8.28"> const BinaryInputStream = CC(&quot;@mozilla.org/binaryinputstream;1&quot;,</span>
<a href="#l8.29"></a><span id="l8.29">                              &quot;nsIBinaryInputStream&quot;,</span>
<a href="#l8.30"></a><span id="l8.30">                              &quot;setInputStream&quot;);</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32" class="difflineat">@@ -66,78 +63,75 @@ SocksClient.prototype = {</span>
<a href="#l8.33"></a><span id="l8.33">         this.handleSocks5Request();</span>
<a href="#l8.34"></a><span id="l8.34">         break;</span>
<a href="#l8.35"></a><span id="l8.35">     }</span>
<a href="#l8.36"></a><span id="l8.36"> </span>
<a href="#l8.37"></a><span id="l8.37">     if (!this.sub_transport)</span>
<a href="#l8.38"></a><span id="l8.38">       this.waitRead(input);</span>
<a href="#l8.39"></a><span id="l8.39">   },</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-  /// Listen on the input for the next packet</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+  // Listen on the input for the next packet</span>
<a href="#l8.43"></a><span id="l8.43">   waitRead(input) {</span>
<a href="#l8.44"></a><span id="l8.44">     input.asyncWait(this, 0, 0, currentThread);</span>
<a href="#l8.45"></a><span id="l8.45">   },</span>
<a href="#l8.46"></a><span id="l8.46"> </span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-  /// Simple handler to write out a binary string (because xpidl sucks here)</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+  // Simple handler to write out a binary string (because xpidl sucks here)</span>
<a href="#l8.49"></a><span id="l8.49">   write(buf) {</span>
<a href="#l8.50"></a><span id="l8.50">     this.client_out.write(buf, buf.length);</span>
<a href="#l8.51"></a><span id="l8.51">   },</span>
<a href="#l8.52"></a><span id="l8.52"> </span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-  /// Handle the first SOCKSv5 client message</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+  // Handle the first SOCKSv5 client message</span>
<a href="#l8.55"></a><span id="l8.55">   handleGreeting() {</span>
<a href="#l8.56"></a><span id="l8.56">     if (this.inbuf.length == 0)</span>
<a href="#l8.57"></a><span id="l8.57">       return;</span>
<a href="#l8.58"></a><span id="l8.58"> </span>
<a href="#l8.59"></a><span id="l8.59">     if (this.inbuf[0] != 5) {</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-      dump(&quot;Unknown protocol version: &quot; + this.inbuf[0] + '\n');</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+      dump(&quot;Unknown protocol version: &quot; + this.inbuf[0] + &quot;\n&quot;);</span>
<a href="#l8.62"></a><span id="l8.62">       this.close();</span>
<a href="#l8.63"></a><span id="l8.63">       return;</span>
<a href="#l8.64"></a><span id="l8.64">     }</span>
<a href="#l8.65"></a><span id="l8.65"> </span>
<a href="#l8.66"></a><span id="l8.66">     // Some quality checks to make sure we've read the entire greeting.</span>
<a href="#l8.67"></a><span id="l8.67">     if (this.inbuf.length &lt; 2)</span>
<a href="#l8.68"></a><span id="l8.68">       return;</span>
<a href="#l8.69"></a><span id="l8.69">     var nmethods = this.inbuf[1];</span>
<a href="#l8.70"></a><span id="l8.70">     if (this.inbuf.length &lt; 2 + nmethods)</span>
<a href="#l8.71"></a><span id="l8.71">       return;</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-    var methods = this.inbuf.slice(2, 2 + nmethods);</span>
<a href="#l8.73"></a><span id="l8.73">     this.inbuf = [];</span>
<a href="#l8.74"></a><span id="l8.74"> </span>
<a href="#l8.75"></a><span id="l8.75">     // Tell them that we don't log into this SOCKS server.</span>
<a href="#l8.76"></a><span id="l8.76">     this.state = STATE_WAIT_SOCKS5_REQUEST;</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-    this.write('\x05\x00');</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+    this.write(&quot;\x05\x00&quot;);</span>
<a href="#l8.79"></a><span id="l8.79">   },</span>
<a href="#l8.80"></a><span id="l8.80"> </span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-  /// Handle the second SOCKSv5 message</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+  // Handle the second SOCKSv5 message</span>
<a href="#l8.83"></a><span id="l8.83">   handleSocks5Request() {</span>
<a href="#l8.84"></a><span id="l8.84">     if (this.inbuf.length &lt; 4)</span>
<a href="#l8.85"></a><span id="l8.85">       return;</span>
<a href="#l8.86"></a><span id="l8.86"> </span>
<a href="#l8.87"></a><span id="l8.87">     // Find the address:port requested.</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-    var version = this.inbuf[0];</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-    var cmd = this.inbuf[1];</span>
<a href="#l8.90"></a><span id="l8.90">     var atype = this.inbuf[3];</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+    var len, addr;</span>
<a href="#l8.92"></a><span id="l8.92">     if (atype == 0x01) { // IPv4 Address</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-      var len = 4;</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-      var addr = this.inbuf.slice(4, 8).join('.');</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+      len = 4;</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+      addr = this.inbuf.slice(4, 8).join(&quot;.&quot;);</span>
<a href="#l8.97"></a><span id="l8.97">     } else if (atype == 0x03) { // Domain name</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-      var len = this.inbuf[4];</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-      var addr = String.fromCharCode.apply(null,</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-        this.inbuf.slice(5, 5 + len));</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+      len = this.inbuf[4];</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+      addr = String.fromCharCode.apply(null, this.inbuf.slice(5, 5 + len));</span>
<a href="#l8.103"></a><span id="l8.103">       len = len + 1;</span>
<a href="#l8.104"></a><span id="l8.104">     } else if (atype == 0x04) { // IPv6 address</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-      var len = 16;</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-      var addr = this.inbuf.slice(4, 20).map(i =&gt; i.toString(16)).join(':');</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+      len = 16;</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+      addr = this.inbuf.slice(4, 20).map(i =&gt; i.toString(16)).join(&quot;:&quot;);</span>
<a href="#l8.109"></a><span id="l8.109">     }</span>
<a href="#l8.110"></a><span id="l8.110">     var port = this.inbuf[4 + len] &lt;&lt; 8 | this.inbuf[5 + len];</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-    dump(&quot;Requesting &quot; + addr + &quot;:&quot; + port + '\n');</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+    dump(&quot;Requesting &quot; + addr + &quot;:&quot; + port + &quot;\n&quot;);</span>
<a href="#l8.113"></a><span id="l8.113"> </span>
<a href="#l8.114"></a><span id="l8.114">     // Map that data to the port we report.</span>
<a href="#l8.115"></a><span id="l8.115">     var foundPort = gPortMap.get(addr + &quot;:&quot; + port);</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-    dump(&quot;This was mapped to &quot; + foundPort + '\n');</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+    dump(&quot;This was mapped to &quot; + foundPort + &quot;\n&quot;);</span>
<a href="#l8.118"></a><span id="l8.118"> </span>
<a href="#l8.119"></a><span id="l8.119">     if (foundPort !== undefined) {</span>
<a href="#l8.120"></a><span id="l8.120">       this.write(&quot;\x05\x00\x00&quot; + // Header for response</span>
<a href="#l8.121"></a><span id="l8.121">           &quot;\x04&quot; + &quot;\x00&quot;.repeat(15) + &quot;\x01&quot; + // IPv6 address ::1</span>
<a href="#l8.122"></a><span id="l8.122">           String.fromCharCode(foundPort &gt;&gt; 8) +</span>
<a href="#l8.123"></a><span id="l8.123">           String.fromCharCode(foundPort &amp; 0xff) // Port number</span>
<a href="#l8.124"></a><span id="l8.124">       );</span>
<a href="#l8.125"></a><span id="l8.125">     } else {</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineat">@@ -161,23 +155,23 @@ SocksClient.prototype = {</span>
<a href="#l8.127"></a><span id="l8.127">     NetUtil.asyncCopy(this.client_in, tunnelOutput);</span>
<a href="#l8.128"></a><span id="l8.128">   },</span>
<a href="#l8.129"></a><span id="l8.129"> </span>
<a href="#l8.130"></a><span id="l8.130">   close() {</span>
<a href="#l8.131"></a><span id="l8.131">     this.client_in.close();</span>
<a href="#l8.132"></a><span id="l8.132">     this.client_out.close();</span>
<a href="#l8.133"></a><span id="l8.133">     if (this.sub_transport)</span>
<a href="#l8.134"></a><span id="l8.134">       this.sub_transport.close(Cr.NS_OK);</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-  }</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+  },</span>
<a href="#l8.137"></a><span id="l8.137"> };</span>
<a href="#l8.138"></a><span id="l8.138"> </span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-/// A SOCKS server that runs on a random port.</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+// A SOCKS server that runs on a random port.</span>
<a href="#l8.141"></a><span id="l8.141"> function SocksTestServer() {</span>
<a href="#l8.142"></a><span id="l8.142">   this.listener = ServerSocket(-1, true, -1);</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineminus">-  dump(&quot;Starting SOCKS server on &quot; + this.listener.port + '\n');</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+  dump(&quot;Starting SOCKS server on &quot; + this.listener.port + &quot;\n&quot;);</span>
<a href="#l8.145"></a><span id="l8.145">   this.port = this.listener.port;</span>
<a href="#l8.146"></a><span id="l8.146">   this.listener.asyncListen(this);</span>
<a href="#l8.147"></a><span id="l8.147">   this.client_connections = [];</span>
<a href="#l8.148"></a><span id="l8.148"> }</span>
<a href="#l8.149"></a><span id="l8.149"> SocksTestServer.prototype = {</span>
<a href="#l8.150"></a><span id="l8.150">   QueryInterface: ChromeUtils.generateQI([Ci.nsIServerSocketListener]),</span>
<a href="#l8.151"></a><span id="l8.151"> </span>
<a href="#l8.152"></a><span id="l8.152">   onSocketAccepted(socket, trans) {</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineat">@@ -192,21 +186,21 @@ SocksTestServer.prototype = {</span>
<a href="#l8.154"></a><span id="l8.154">   close() {</span>
<a href="#l8.155"></a><span id="l8.155">     for (let client of this.client_connections)</span>
<a href="#l8.156"></a><span id="l8.156">       client.close();</span>
<a href="#l8.157"></a><span id="l8.157">     this.client_connections = [];</span>
<a href="#l8.158"></a><span id="l8.158">     if (this.listener) {</span>
<a href="#l8.159"></a><span id="l8.159">       this.listener.close();</span>
<a href="#l8.160"></a><span id="l8.160">       this.listener = null;</span>
<a href="#l8.161"></a><span id="l8.161">     }</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-  }</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+  },</span>
<a href="#l8.164"></a><span id="l8.164"> };</span>
<a href="#l8.165"></a><span id="l8.165"> </span>
<a href="#l8.166"></a><span id="l8.166"> var gSocksServer = null;</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-/// hostname:port -&gt; the port on localhost that the server really runs on.</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+// hostname:port -&gt; the port on localhost that the server really runs on.</span>
<a href="#l8.169"></a><span id="l8.169"> var gPortMap = new Map();</span>
<a href="#l8.170"></a><span id="l8.170"> </span>
<a href="#l8.171"></a><span id="l8.171"> var NetworkTestUtils = {</span>
<a href="#l8.172"></a><span id="l8.172">   /**</span>
<a href="#l8.173"></a><span id="l8.173">    * Set up a proxy entry such that requesting a connection to hostName:port</span>
<a href="#l8.174"></a><span id="l8.174">    * will instead cause a connection to localRemappedPort. This will use a SOCKS</span>
<a href="#l8.175"></a><span id="l8.175">    * proxy (because any other mechanism is too complicated). Since this is</span>
<a href="#l8.176"></a><span id="l8.176">    * starting up a server, it does behoove you to call shutdownServers when you</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/test/resources/POP3pump.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/test/resources/POP3pump.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,8 +1,12 @@</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+</span>
<a href="#l9.8"></a><span id="l9.8"> /**</span>
<a href="#l9.9"></a><span id="l9.9">  * This routine will allow the easy processing of</span>
<a href="#l9.10"></a><span id="l9.10">  * messages through the fake POP3 server into the local</span>
<a href="#l9.11"></a><span id="l9.11">  * folder. It uses a single global defined as:</span>
<a href="#l9.12"></a><span id="l9.12">  *</span>
<a href="#l9.13"></a><span id="l9.13">  *  gPOP3Pump:        the main access to the routine</span>
<a href="#l9.14"></a><span id="l9.14">  *  gPOP3Pump.run()   function to run to load the messages. Returns promise that</span>
<a href="#l9.15"></a><span id="l9.15">  *                    resolves when done.</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineat">@@ -15,16 +19,17 @@</span>
<a href="#l9.17"></a><span id="l9.17">  *                                   (in) pluggable store contract ID</span>
<a href="#l9.18"></a><span id="l9.18">  *</span>
<a href="#l9.19"></a><span id="l9.19">  * adapted from test_pop3GetNewMail.js</span>
<a href="#l9.20"></a><span id="l9.20">  *</span>
<a href="#l9.21"></a><span id="l9.21">  * Original Author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l9.22"></a><span id="l9.22">  *</span>
<a href="#l9.23"></a><span id="l9.23">  */</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.26"></a><span id="l9.26"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l9.27"></a><span id="l9.27"> var {localAccountUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/localAccountUtils.js&quot;);</span>
<a href="#l9.28"></a><span id="l9.28"> </span>
<a href="#l9.29"></a><span id="l9.29"> // Import the pop3 server scripts</span>
<a href="#l9.30"></a><span id="l9.30"> var {nsMailServer} = ChromeUtils.import(&quot;resource://testing-common/mailnews/maild.js&quot;);</span>
<a href="#l9.31"></a><span id="l9.31"> var {</span>
<a href="#l9.32"></a><span id="l9.32">   AuthPLAIN,</span>
<a href="#l9.33"></a><span id="l9.33">   AuthLOGIN,</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineat">@@ -33,18 +38,17 @@ var {</span>
<a href="#l9.35"></a><span id="l9.35"> var {</span>
<a href="#l9.36"></a><span id="l9.36">   pop3Daemon,</span>
<a href="#l9.37"></a><span id="l9.37">   POP3_RFC1939_handler,</span>
<a href="#l9.38"></a><span id="l9.38">   POP3_RFC2449_handler,</span>
<a href="#l9.39"></a><span id="l9.39">   POP3_RFC5034_handler,</span>
<a href="#l9.40"></a><span id="l9.40"> } = ChromeUtils.import(&quot;resource://testing-common/mailnews/pop3d.js&quot;);</span>
<a href="#l9.41"></a><span id="l9.41"> var {Promise} = ChromeUtils.import(&quot;resource://gre/modules/Promise.jsm&quot;);</span>
<a href="#l9.42"></a><span id="l9.42"> </span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-function POP3Pump()</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-{</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+function POP3Pump() {</span>
<a href="#l9.46"></a><span id="l9.46">   // public attributes</span>
<a href="#l9.47"></a><span id="l9.47">   this.fakeServer = null;</span>
<a href="#l9.48"></a><span id="l9.48">   this.onDone = null;</span>
<a href="#l9.49"></a><span id="l9.49">   this.files = null;</span>
<a href="#l9.50"></a><span id="l9.50"> </span>
<a href="#l9.51"></a><span id="l9.51">   // local private variables</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53">   this.kPOP3_PORT = 1024 + 110;</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineat">@@ -57,65 +61,59 @@ function POP3Pump()</span>
<a href="#l9.55"></a><span id="l9.55">   this._finalCleanup = false;</span>
<a href="#l9.56"></a><span id="l9.56">   this._expectedResult = Cr.NS_OK;</span>
<a href="#l9.57"></a><span id="l9.57">   this._actualResult = Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l9.58"></a><span id="l9.58">   this._mailboxStoreContractID =</span>
<a href="#l9.59"></a><span id="l9.59">     Services.prefs.getCharPref(&quot;mail.serverDefaultStoreContractID&quot;);</span>
<a href="#l9.60"></a><span id="l9.60"> }</span>
<a href="#l9.61"></a><span id="l9.61"> </span>
<a href="#l9.62"></a><span id="l9.62"> // nsIUrlListener implementation</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-POP3Pump.prototype.OnStartRunningUrl = function OnStartRunningUrl(url) {};</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+POP3Pump.prototype.OnStartRunningUrl = function(url) {};</span>
<a href="#l9.65"></a><span id="l9.65"> </span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-POP3Pump.prototype.OnStopRunningUrl = function OnStopRunningUrl(aUrl, aResult)</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-{</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+POP3Pump.prototype.OnStopRunningUrl = function(aUrl, aResult) {</span>
<a href="#l9.69"></a><span id="l9.69">   this._actualResult = aResult;</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-  if (aResult != Cr.NS_OK)</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-  {</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+  if (aResult != Cr.NS_OK) {</span>
<a href="#l9.73"></a><span id="l9.73">     // If we have an error, clean up nicely.</span>
<a href="#l9.74"></a><span id="l9.74">     this._server.stop();</span>
<a href="#l9.75"></a><span id="l9.75"> </span>
<a href="#l9.76"></a><span id="l9.76">     var thread = Services.tm.currentThread;</span>
<a href="#l9.77"></a><span id="l9.77">     while (thread.hasPendingEvents())</span>
<a href="#l9.78"></a><span id="l9.78">       thread.processNextEvent(true);</span>
<a href="#l9.79"></a><span id="l9.79">   }</span>
<a href="#l9.80"></a><span id="l9.80">   Assert.equal(aResult, this._expectedResult);</span>
<a href="#l9.81"></a><span id="l9.81"> </span>
<a href="#l9.82"></a><span id="l9.82">   // Let OnStopRunningUrl return cleanly before doing anything else.</span>
<a href="#l9.83"></a><span id="l9.83">   do_timeout(0, _checkPumpBusy);</span>
<a href="#l9.84"></a><span id="l9.84"> };</span>
<a href="#l9.85"></a><span id="l9.85"> </span>
<a href="#l9.86"></a><span id="l9.86"> // Setup the daemon and server</span>
<a href="#l9.87"></a><span id="l9.87"> // If the debugOption is set, then it will be applied to the server.</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-POP3Pump.prototype._setupServerDaemon = function _setupServerDaemon(aDebugOption)</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-{</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+POP3Pump.prototype._setupServerDaemon = function(aDebugOption) {</span>
<a href="#l9.91"></a><span id="l9.91">   this._daemon = new pop3Daemon();</span>
<a href="#l9.92"></a><span id="l9.92">   function createHandler(d) {</span>
<a href="#l9.93"></a><span id="l9.93">     return new POP3_RFC1939_handler(d);</span>
<a href="#l9.94"></a><span id="l9.94">   }</span>
<a href="#l9.95"></a><span id="l9.95">   this._server = new nsMailServer(createHandler, this._daemon);</span>
<a href="#l9.96"></a><span id="l9.96">   if (aDebugOption)</span>
<a href="#l9.97"></a><span id="l9.97">     this._server.setDebugLevel(aDebugOption);</span>
<a href="#l9.98"></a><span id="l9.98">   return [this._daemon, this._server];</span>
<a href="#l9.99"></a><span id="l9.99"> };</span>
<a href="#l9.100"></a><span id="l9.100"> </span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-POP3Pump.prototype._createPop3ServerAndLocalFolders =</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-  function _createPop3ServerAndLocalFolders()</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-{</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-  if (typeof localAccountUtils.inboxFolder == 'undefined')</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+POP3Pump.prototype._createPop3ServerAndLocalFolders = function() {</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+  if (typeof localAccountUtils.inboxFolder == &quot;undefined&quot;)</span>
<a href="#l9.107"></a><span id="l9.107">     localAccountUtils.loadLocalMailAccount();</span>
<a href="#l9.108"></a><span id="l9.108"> </span>
<a href="#l9.109"></a><span id="l9.109">   if (!this.fakeServer)</span>
<a href="#l9.110"></a><span id="l9.110">     this.fakeServer = localAccountUtils.create_incoming_server(&quot;pop3&quot;, this.kPOP3_PORT,</span>
<a href="#l9.111"></a><span id="l9.111">                                                                &quot;fred&quot;, &quot;wilma&quot;);</span>
<a href="#l9.112"></a><span id="l9.112"> </span>
<a href="#l9.113"></a><span id="l9.113">   return this.fakeServer;</span>
<a href="#l9.114"></a><span id="l9.114"> };</span>
<a href="#l9.115"></a><span id="l9.115"> </span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-POP3Pump.prototype.resetPluggableStore = function(aStoreContractID)</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-{</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+POP3Pump.prototype.resetPluggableStore = function(aStoreContractID) {</span>
<a href="#l9.119"></a><span id="l9.119">   if (aStoreContractID == this._mailboxStoreContractID)</span>
<a href="#l9.120"></a><span id="l9.120">     return;</span>
<a href="#l9.121"></a><span id="l9.121"> </span>
<a href="#l9.122"></a><span id="l9.122">   Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;, aStoreContractID);</span>
<a href="#l9.123"></a><span id="l9.123"> </span>
<a href="#l9.124"></a><span id="l9.124">   // Cleanup existing files, server and account instances, if any.</span>
<a href="#l9.125"></a><span id="l9.125">   if (this._server)</span>
<a href="#l9.126"></a><span id="l9.126">     this._server.stop();</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineat">@@ -127,105 +125,93 @@ POP3Pump.prototype.resetPluggableStore =</span>
<a href="#l9.128"></a><span id="l9.128"> </span>
<a href="#l9.129"></a><span id="l9.129">   this.fakeServer = null;</span>
<a href="#l9.130"></a><span id="l9.130">   localAccountUtils.clearAll();</span>
<a href="#l9.131"></a><span id="l9.131"> </span>
<a href="#l9.132"></a><span id="l9.132">   this._incomingServer = this._createPop3ServerAndLocalFolders();</span>
<a href="#l9.133"></a><span id="l9.133">   this._mailboxStoreContractID = aStoreContractID;</span>
<a href="#l9.134"></a><span id="l9.134"> };</span>
<a href="#l9.135"></a><span id="l9.135"> </span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-POP3Pump.prototype._checkBusy = function _checkBusy()</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-{</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-  if (this._tests.length == 0 &amp;&amp; !this._finalCleanup)</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-  {</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+POP3Pump.prototype._checkBusy = function() {</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+  if (this._tests.length == 0 &amp;&amp; !this._finalCleanup) {</span>
<a href="#l9.142"></a><span id="l9.142">     this._incomingServer.closeCachedConnections();</span>
<a href="#l9.143"></a><span id="l9.143"> </span>
<a href="#l9.144"></a><span id="l9.144">     // No more tests, let everything finish</span>
<a href="#l9.145"></a><span id="l9.145">     this._server.stop();</span>
<a href="#l9.146"></a><span id="l9.146">     this._finalCleanup = true;</span>
<a href="#l9.147"></a><span id="l9.147">     do_timeout(20, _checkPumpBusy);</span>
<a href="#l9.148"></a><span id="l9.148">     return;</span>
<a href="#l9.149"></a><span id="l9.149">   }</span>
<a href="#l9.150"></a><span id="l9.150"> </span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-  if (this._finalCleanup)</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-  {</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-    if (Services.tm.currentThread.hasPendingEvents())</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+  if (this._finalCleanup) {</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineplus">+    if (Services.tm.currentThread.hasPendingEvents()) {</span>
<a href="#l9.156"></a><span id="l9.156">       do_timeout(20, _checkPumpBusy);</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-    else</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-    {</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+    } else {</span>
<a href="#l9.160"></a><span id="l9.160">       // exit this module</span>
<a href="#l9.161"></a><span id="l9.161">       do_test_finished();</span>
<a href="#l9.162"></a><span id="l9.162">       if (this.onDone)</span>
<a href="#l9.163"></a><span id="l9.163">         this._promise.then(this.onDone, this.onDone);</span>
<a href="#l9.164"></a><span id="l9.164">       if (this._actualResult == Cr.NS_OK)</span>
<a href="#l9.165"></a><span id="l9.165">         this._resolve();</span>
<a href="#l9.166"></a><span id="l9.166">       else</span>
<a href="#l9.167"></a><span id="l9.167">         this._reject(this._actualResult);</span>
<a href="#l9.168"></a><span id="l9.168">     }</span>
<a href="#l9.169"></a><span id="l9.169">     return;</span>
<a href="#l9.170"></a><span id="l9.170">   }</span>
<a href="#l9.171"></a><span id="l9.171"> </span>
<a href="#l9.172"></a><span id="l9.172">   // If the server hasn't quite finished, just delay a little longer.</span>
<a href="#l9.173"></a><span id="l9.173">   if (this._incomingServer.serverBusy ||</span>
<a href="#l9.174"></a><span id="l9.174">       (this._incomingServer instanceof Ci.nsIPop3IncomingServer &amp;&amp;</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-       this._incomingServer.runningProtocol))</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineminus">-  {</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+       this._incomingServer.runningProtocol)) {</span>
<a href="#l9.178"></a><span id="l9.178">     do_timeout(20, _checkPumpBusy);</span>
<a href="#l9.179"></a><span id="l9.179">     return;</span>
<a href="#l9.180"></a><span id="l9.180">   }</span>
<a href="#l9.181"></a><span id="l9.181"> </span>
<a href="#l9.182"></a><span id="l9.182">   this._testNext();</span>
<a href="#l9.183"></a><span id="l9.183"> };</span>
<a href="#l9.184"></a><span id="l9.184"> </span>
<a href="#l9.185"></a><span id="l9.185" class="difflineminus">-POP3Pump.prototype._testNext = function _testNext()</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineminus">-{</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineplus">+POP3Pump.prototype._testNext = function() {</span>
<a href="#l9.188"></a><span id="l9.188">   let thisFiles = this._tests.shift();</span>
<a href="#l9.189"></a><span id="l9.189">   if (!thisFiles)</span>
<a href="#l9.190"></a><span id="l9.190">     this._checkBusy();  // exit</span>
<a href="#l9.191"></a><span id="l9.191"> </span>
<a href="#l9.192"></a><span id="l9.192">   // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l9.193"></a><span id="l9.193">   // the server if something fails.</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineminus">-  try</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineminus">-  {</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-    if (this._firstFile)</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-    {</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+  try {</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+    if (this._firstFile) {</span>
<a href="#l9.200"></a><span id="l9.200">       this._firstFile = false;</span>
<a href="#l9.201"></a><span id="l9.201"> </span>
<a href="#l9.202"></a><span id="l9.202">       // Start the fake POP3 server</span>
<a href="#l9.203"></a><span id="l9.203">       this._server.start();</span>
<a href="#l9.204"></a><span id="l9.204">       this.kPOP3_PORT = this._server.port;</span>
<a href="#l9.205"></a><span id="l9.205">       if (this.fakeServer)</span>
<a href="#l9.206"></a><span id="l9.206">         this.fakeServer.port = this.kPOP3_PORT;</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineminus">-    }</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineminus">-    else</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineminus">-    {</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineplus">+    } else {</span>
<a href="#l9.211"></a><span id="l9.211">       this._server.resetTest();</span>
<a href="#l9.212"></a><span id="l9.212">     }</span>
<a href="#l9.213"></a><span id="l9.213"> </span>
<a href="#l9.214"></a><span id="l9.214">     // Set up the test</span>
<a href="#l9.215"></a><span id="l9.215">     this._daemon.setMessages(thisFiles);</span>
<a href="#l9.216"></a><span id="l9.216"> </span>
<a href="#l9.217"></a><span id="l9.217">     // Now get the mail, get inbox in case it got un-deferred.</span>
<a href="#l9.218"></a><span id="l9.218">     let inbox = this._incomingServer</span>
<a href="#l9.219"></a><span id="l9.219">                     .rootMsgFolder</span>
<a href="#l9.220"></a><span id="l9.220">                     .getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l9.221"></a><span id="l9.221">     this._pop3Service.GetNewMail(null, this, inbox,</span>
<a href="#l9.222"></a><span id="l9.222">                                  this._incomingServer);</span>
<a href="#l9.223"></a><span id="l9.223"> </span>
<a href="#l9.224"></a><span id="l9.224">     this._server.performTest();</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineminus">-  } catch (e)</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineminus">-  {</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineplus">+  } catch (e) {</span>
<a href="#l9.228"></a><span id="l9.228">     this._server.stop();</span>
<a href="#l9.229"></a><span id="l9.229"> </span>
<a href="#l9.230"></a><span id="l9.230">     do_throw(e);</span>
<a href="#l9.231"></a><span id="l9.231">   }</span>
<a href="#l9.232"></a><span id="l9.232"> };</span>
<a href="#l9.233"></a><span id="l9.233"> </span>
<a href="#l9.234"></a><span id="l9.234" class="difflineminus">-POP3Pump.prototype.run = function run(aExpectedResult)</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineminus">-{</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineplus">+POP3Pump.prototype.run = function(aExpectedResult) {</span>
<a href="#l9.237"></a><span id="l9.237">   do_test_pending();</span>
<a href="#l9.238"></a><span id="l9.238">   // Disable new mail notifications</span>
<a href="#l9.239"></a><span id="l9.239">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l9.240"></a><span id="l9.240">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l9.241"></a><span id="l9.241">   Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l9.242"></a><span id="l9.242">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l9.243"></a><span id="l9.243"> </span>
<a href="#l9.244"></a><span id="l9.244">   this._server = this._setupServerDaemon();</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineat">@@ -246,17 +232,17 @@ POP3Pump.prototype.run = function run(aE</span>
<a href="#l9.246"></a><span id="l9.246">   // a POP3 server.</span>
<a href="#l9.247"></a><span id="l9.247"> </span>
<a href="#l9.248"></a><span id="l9.248">   this._tests[0] = this.files;</span>
<a href="#l9.249"></a><span id="l9.249"> </span>
<a href="#l9.250"></a><span id="l9.250">   this._pop3Service = MailServices.pop3;</span>
<a href="#l9.251"></a><span id="l9.251">   this._testNext();</span>
<a href="#l9.252"></a><span id="l9.252"> </span>
<a href="#l9.253"></a><span id="l9.253">   // This probably does not work with multiple tests, but nobody is using that.</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineminus">-  this._promise = new Promise( (resolve, reject) =&gt; {</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineplus">+  this._promise = new Promise((resolve, reject) =&gt; {</span>
<a href="#l9.256"></a><span id="l9.256">     this._resolve = resolve;</span>
<a href="#l9.257"></a><span id="l9.257">     this._reject = reject;</span>
<a href="#l9.258"></a><span id="l9.258">   });</span>
<a href="#l9.259"></a><span id="l9.259">   return this._promise;</span>
<a href="#l9.260"></a><span id="l9.260"> };</span>
<a href="#l9.261"></a><span id="l9.261"> </span>
<a href="#l9.262"></a><span id="l9.262"> var gPOP3Pump = new POP3Pump();</span>
<a href="#l9.263"></a><span id="l9.263"> gPOP3Pump._incomingServer = gPOP3Pump._createPop3ServerAndLocalFolders();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/test/resources/PromiseTestUtils.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/test/resources/PromiseTestUtils.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,22 +1,19 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.5"></a><span id="l10.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> /**</span>
<a href="#l10.10"></a><span id="l10.10">  * This file provides utilities useful in using Promises and Task.jsm</span>
<a href="#l10.11"></a><span id="l10.11">  * with mailnews tests.</span>
<a href="#l10.12"></a><span id="l10.12">  */</span>
<a href="#l10.13"></a><span id="l10.13"> </span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-this.EXPORTED_SYMBOLS = ['PromiseTestUtils'];</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;PromiseTestUtils&quot;];</span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-var CC = Components.Constructor;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l10.20"></a><span id="l10.20"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l10.21"></a><span id="l10.21"> </span>
<a href="#l10.22"></a><span id="l10.22"> /**</span>
<a href="#l10.23"></a><span id="l10.23">  * Url listener that can wrap another listener and trigger a callback.</span>
<a href="#l10.24"></a><span id="l10.24">  *</span>
<a href="#l10.25"></a><span id="l10.25">  * @param [aWrapped] The nsIUrlListener to pass all notifications through to.</span>
<a href="#l10.26"></a><span id="l10.26">  *     This gets called prior to the callback (or async resumption).</span>
<a href="#l10.27"></a><span id="l10.27">  */</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineat">@@ -29,21 +26,21 @@ PromiseTestUtils.PromiseUrlListener = fu</span>
<a href="#l10.29"></a><span id="l10.29">     this._resolve = resolve;</span>
<a href="#l10.30"></a><span id="l10.30">     this._reject = reject;</span>
<a href="#l10.31"></a><span id="l10.31">   });</span>
<a href="#l10.32"></a><span id="l10.32"> };</span>
<a href="#l10.33"></a><span id="l10.33"> </span>
<a href="#l10.34"></a><span id="l10.34"> PromiseTestUtils.PromiseUrlListener.prototype = {</span>
<a href="#l10.35"></a><span id="l10.35">   QueryInterface:   ChromeUtils.generateQI([Ci.nsIUrlListener]),</span>
<a href="#l10.36"></a><span id="l10.36"> </span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-  OnStartRunningUrl: function(aUrl) {</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+  OnStartRunningUrl(aUrl) {</span>
<a href="#l10.39"></a><span id="l10.39">     if (this.wrapped &amp;&amp; this.wrapped.OnStartRunningUrl)</span>
<a href="#l10.40"></a><span id="l10.40">       this.wrapped.OnStartRunningUrl(aUrl);</span>
<a href="#l10.41"></a><span id="l10.41">   },</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-  OnStopRunningUrl: function(aUrl, aExitCode) {</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l10.44"></a><span id="l10.44">     if (this.wrapped &amp;&amp; this.wrapped.OnStopRunningUrl)</span>
<a href="#l10.45"></a><span id="l10.45">       this.wrapped.OnStopRunningUrl(aUrl, aExitCode);</span>
<a href="#l10.46"></a><span id="l10.46">     if (aExitCode == Cr.NS_OK)</span>
<a href="#l10.47"></a><span id="l10.47">       this._resolve();</span>
<a href="#l10.48"></a><span id="l10.48">     else</span>
<a href="#l10.49"></a><span id="l10.49">       this._reject(aExitCode);</span>
<a href="#l10.50"></a><span id="l10.50">   },</span>
<a href="#l10.51"></a><span id="l10.51">   get promise() { return this._promise; },</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineat">@@ -62,46 +59,46 @@ PromiseTestUtils.PromiseCopyListener = f</span>
<a href="#l10.53"></a><span id="l10.53">     this._resolve = resolve;</span>
<a href="#l10.54"></a><span id="l10.54">     this._reject = reject;</span>
<a href="#l10.55"></a><span id="l10.55">   });</span>
<a href="#l10.56"></a><span id="l10.56">   this._result = { messageKeys: [], messageIds: [] };</span>
<a href="#l10.57"></a><span id="l10.57"> };</span>
<a href="#l10.58"></a><span id="l10.58"> </span>
<a href="#l10.59"></a><span id="l10.59"> PromiseTestUtils.PromiseCopyListener.prototype = {</span>
<a href="#l10.60"></a><span id="l10.60">   QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgCopyServiceListener]),</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-  OnStartCopy: function() {</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+  OnStartCopy() {</span>
<a href="#l10.63"></a><span id="l10.63">     if (this.wrapped &amp;&amp; this.wrapped.OnStartCopy)</span>
<a href="#l10.64"></a><span id="l10.64">       this.wrapped.OnStartCopy();</span>
<a href="#l10.65"></a><span id="l10.65">   },</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {</span>
<a href="#l10.68"></a><span id="l10.68">     if (this.wrapped &amp;&amp; this.wrapped.OnProgress)</span>
<a href="#l10.69"></a><span id="l10.69">       this.wrapped.OnProgress(aProgress, aProgressMax);</span>
<a href="#l10.70"></a><span id="l10.70">   },</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-  SetMessageKey: function(aKey) {</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+  SetMessageKey(aKey) {</span>
<a href="#l10.73"></a><span id="l10.73">     if (this.wrapped &amp;&amp; this.wrapped.SetMessageKey)</span>
<a href="#l10.74"></a><span id="l10.74">       this.wrapped.SetMessageKey(aKey);</span>
<a href="#l10.75"></a><span id="l10.75"> </span>
<a href="#l10.76"></a><span id="l10.76">     this._result.messageKeys.push(aKey);</span>
<a href="#l10.77"></a><span id="l10.77">   },</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-  SetMessageId: function(aMessageId) {</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+  SetMessageId(aMessageId) {</span>
<a href="#l10.80"></a><span id="l10.80">     if (this.wrapped &amp;&amp; this.wrapped.SetMessageId)</span>
<a href="#l10.81"></a><span id="l10.81">       this.wrapped.SetMessageId(aMessageId);</span>
<a href="#l10.82"></a><span id="l10.82"> </span>
<a href="#l10.83"></a><span id="l10.83">     this._result.messageIds.push(aMessageId);</span>
<a href="#l10.84"></a><span id="l10.84">   },</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-  OnStopCopy: function(aStatus) {</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l10.87"></a><span id="l10.87">     if (this.wrapped &amp;&amp; this.wrapped.OnStopCopy)</span>
<a href="#l10.88"></a><span id="l10.88">       this.wrapped.OnStopCopy(aStatus);</span>
<a href="#l10.89"></a><span id="l10.89"> </span>
<a href="#l10.90"></a><span id="l10.90">     if (aStatus == Cr.NS_OK)</span>
<a href="#l10.91"></a><span id="l10.91">       this._resolve(this._result);</span>
<a href="#l10.92"></a><span id="l10.92">     else</span>
<a href="#l10.93"></a><span id="l10.93">       this._reject(aStatus);</span>
<a href="#l10.94"></a><span id="l10.94">   },</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-  get promise() { return this._promise; }</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+  get promise() { return this._promise; },</span>
<a href="#l10.97"></a><span id="l10.97"> };</span>
<a href="#l10.98"></a><span id="l10.98"> </span>
<a href="#l10.99"></a><span id="l10.99"> /**</span>
<a href="#l10.100"></a><span id="l10.100">  * Stream listener that can wrap another listener and trigger a callback.</span>
<a href="#l10.101"></a><span id="l10.101">  *</span>
<a href="#l10.102"></a><span id="l10.102">  * @param [aWrapped] The nsIStreamListener to pass all notifications through to.</span>
<a href="#l10.103"></a><span id="l10.103">  *     This gets called prior to the callback (or async resumption).</span>
<a href="#l10.104"></a><span id="l10.104">  */</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineat">@@ -113,61 +110,59 @@ PromiseTestUtils.PromiseStreamListener =</span>
<a href="#l10.106"></a><span id="l10.106">   });</span>
<a href="#l10.107"></a><span id="l10.107">   this._data = null;</span>
<a href="#l10.108"></a><span id="l10.108">   this._stream = null;</span>
<a href="#l10.109"></a><span id="l10.109"> };</span>
<a href="#l10.110"></a><span id="l10.110"> </span>
<a href="#l10.111"></a><span id="l10.111"> PromiseTestUtils.PromiseStreamListener.prototype = {</span>
<a href="#l10.112"></a><span id="l10.112">   QueryInterface: ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l10.113"></a><span id="l10.113"> </span>
<a href="#l10.114"></a><span id="l10.114" class="difflineminus">-  onStartRequest : function (aRequest) {</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+  onStartRequest(aRequest) {</span>
<a href="#l10.116"></a><span id="l10.116">     if (this.wrapped &amp;&amp; this.wrapped.onStartRequest)</span>
<a href="#l10.117"></a><span id="l10.117">       this.wrapped.onStartRequest(aRequest);</span>
<a href="#l10.118"></a><span id="l10.118">     this._data = &quot;&quot;;</span>
<a href="#l10.119"></a><span id="l10.119">     this._stream = null;</span>
<a href="#l10.120"></a><span id="l10.120">   },</span>
<a href="#l10.121"></a><span id="l10.121"> </span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-  onStopRequest : function (aRequest, aStatusCode) {</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+  onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l10.124"></a><span id="l10.124">     if (this.wrapped &amp;&amp; this.wrapped.onStopRequest)</span>
<a href="#l10.125"></a><span id="l10.125">       this.wrapped.onStopRequest(aRequest, aStatusCode);</span>
<a href="#l10.126"></a><span id="l10.126">     if (aStatusCode == Cr.NS_OK)</span>
<a href="#l10.127"></a><span id="l10.127">       this._resolve(this._data);</span>
<a href="#l10.128"></a><span id="l10.128">     else</span>
<a href="#l10.129"></a><span id="l10.129">       this._reject(aStatusCode);</span>
<a href="#l10.130"></a><span id="l10.130">   },</span>
<a href="#l10.131"></a><span id="l10.131"> </span>
<a href="#l10.132"></a><span id="l10.132" class="difflineminus">-  onDataAvailable : function (aRequest, aInputStream, aOff, aCount) {</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+  onDataAvailable(aRequest, aInputStream, aOff, aCount) {</span>
<a href="#l10.134"></a><span id="l10.134">     if (this.wrapped &amp;&amp; this.wrapped.onDataAvailable)</span>
<a href="#l10.135"></a><span id="l10.135">       this.wrapped.onDataAvailable(aRequest, aInputStream, aOff, aCount);</span>
<a href="#l10.136"></a><span id="l10.136">     if (!this._stream) {</span>
<a href="#l10.137"></a><span id="l10.137">       this._stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l10.138"></a><span id="l10.138">                      .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l10.139"></a><span id="l10.139">       this._stream.init(aInputStream);</span>
<a href="#l10.140"></a><span id="l10.140">     }</span>
<a href="#l10.141"></a><span id="l10.141">     this._data += this._stream.read(aCount);</span>
<a href="#l10.142"></a><span id="l10.142">   },</span>
<a href="#l10.143"></a><span id="l10.143"> </span>
<a href="#l10.144"></a><span id="l10.144" class="difflineminus">-  get promise() { return this._promise; }</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+  get promise() { return this._promise; },</span>
<a href="#l10.146"></a><span id="l10.146"> };</span>
<a href="#l10.147"></a><span id="l10.147"> </span>
<a href="#l10.148"></a><span id="l10.148"> /**</span>
<a href="#l10.149"></a><span id="l10.149">  * Folder listener to resolve a promise when a certain folder event occurs.</span>
<a href="#l10.150"></a><span id="l10.150">  *</span>
<a href="#l10.151"></a><span id="l10.151">  * @param folder   nsIMsgFolder to listen to</span>
<a href="#l10.152"></a><span id="l10.152">  * @param event    string event name to listen for. Example event is</span>
<a href="#l10.153"></a><span id="l10.153">  *                 &quot;DeleteOrMoveMsgCompleted&quot;.</span>
<a href="#l10.154"></a><span id="l10.154">  * @return         promise that resolves when the event occurs</span>
<a href="#l10.155"></a><span id="l10.155">  */</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineminus">-</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineminus">-var nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineminus">-PromiseTestUtils.promiseFolderEvent = function promiseFolderEvent(folder, event) {</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineminus">-  return new Promise( (resolve, reject) =&gt; {</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+PromiseTestUtils.promiseFolderEvent = function(folder, event) {</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+  return new Promise((resolve, reject) =&gt; {</span>
<a href="#l10.162"></a><span id="l10.162">     let folderListener = {</span>
<a href="#l10.163"></a><span id="l10.163">       QueryInterface: ChromeUtils.generateQI([Ci.nsIFolderListener]),</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineminus">-      OnItemEvent: function onItemEvent(aEventFolder, aEvent) {</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+      OnItemEvent(aEventFolder, aEvent) {</span>
<a href="#l10.166"></a><span id="l10.166">         if (folder === aEventFolder &amp;&amp;</span>
<a href="#l10.167"></a><span id="l10.167">             event == aEvent) {</span>
<a href="#l10.168"></a><span id="l10.168">           MailServices.mailSession.RemoveFolderListener(folderListener);</span>
<a href="#l10.169"></a><span id="l10.169">           resolve();</span>
<a href="#l10.170"></a><span id="l10.170">         }</span>
<a href="#l10.171"></a><span id="l10.171">       },</span>
<a href="#l10.172"></a><span id="l10.172">     };</span>
<a href="#l10.173"></a><span id="l10.173">     MailServices.mailSession.AddFolderListener(folderListener, Ci.nsIFolderListener.event);</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineat">@@ -178,17 +173,17 @@ PromiseTestUtils.promiseFolderEvent = fu</span>
<a href="#l10.175"></a><span id="l10.175">  * Folder listener to resolve a promise when a certain folder event occurs.</span>
<a href="#l10.176"></a><span id="l10.176">  *</span>
<a href="#l10.177"></a><span id="l10.177">  * @param folder            nsIMsgFolder to listen to</span>
<a href="#l10.178"></a><span id="l10.178">  * @param listenerMethod    string listener method to listen for. Example listener</span>
<a href="#l10.179"></a><span id="l10.179">                             method is &quot;msgsClassified&quot;.</span>
<a href="#l10.180"></a><span id="l10.180">  * @return                  promise that resolves when the event occurs</span>
<a href="#l10.181"></a><span id="l10.181">  */</span>
<a href="#l10.182"></a><span id="l10.182"> PromiseTestUtils.promiseFolderNotification = function(folder, listenerMethod) {</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineminus">-  return new Promise( (resolve, reject) =&gt; {</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+  return new Promise((resolve, reject) =&gt; {</span>
<a href="#l10.185"></a><span id="l10.185">     let mfnListener = {};</span>
<a href="#l10.186"></a><span id="l10.186">     mfnListener[listenerMethod] = function() {</span>
<a href="#l10.187"></a><span id="l10.187">       let args = Array.from(arguments);</span>
<a href="#l10.188"></a><span id="l10.188">       let flag = true;</span>
<a href="#l10.189"></a><span id="l10.189">       for (let arg of args) {</span>
<a href="#l10.190"></a><span id="l10.190">         if (folder &amp;&amp; arg instanceof Ci.nsIMsgFolder) {</span>
<a href="#l10.191"></a><span id="l10.191">           if (arg == folder) {</span>
<a href="#l10.192"></a><span id="l10.192">             flag = true;</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineat">@@ -198,60 +193,59 @@ PromiseTestUtils.promiseFolderNotificati</span>
<a href="#l10.194"></a><span id="l10.194">           }</span>
<a href="#l10.195"></a><span id="l10.195">         }</span>
<a href="#l10.196"></a><span id="l10.196">       }</span>
<a href="#l10.197"></a><span id="l10.197"> </span>
<a href="#l10.198"></a><span id="l10.198">       if (flag) {</span>
<a href="#l10.199"></a><span id="l10.199">         MailServices.mfn.removeListener(mfnListener);</span>
<a href="#l10.200"></a><span id="l10.200">         resolve(args);</span>
<a href="#l10.201"></a><span id="l10.201">       }</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineminus">-    }</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+    };</span>
<a href="#l10.204"></a><span id="l10.204">     MailServices.mfn.addListener(</span>
<a href="#l10.205"></a><span id="l10.205">       mfnListener, Ci.nsIMsgFolderNotificationService[listenerMethod]);</span>
<a href="#l10.206"></a><span id="l10.206">   });</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineminus">-}</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineplus">+};</span>
<a href="#l10.209"></a><span id="l10.209"> </span>
<a href="#l10.210"></a><span id="l10.210"> /**</span>
<a href="#l10.211"></a><span id="l10.211">  * Folder listener to resolve a promise when a folder with a certain</span>
<a href="#l10.212"></a><span id="l10.212">  * name is added.</span>
<a href="#l10.213"></a><span id="l10.213">  *</span>
<a href="#l10.214"></a><span id="l10.214">  * @param name     folder name to listen for</span>
<a href="#l10.215"></a><span id="l10.215">  * @return         promise{folder} that resolves with the new folder when the</span>
<a href="#l10.216"></a><span id="l10.216">  *                 folder add completes</span>
<a href="#l10.217"></a><span id="l10.217">  */</span>
<a href="#l10.218"></a><span id="l10.218"> </span>
<a href="#l10.219"></a><span id="l10.219" class="difflineminus">-PromiseTestUtils.promiseFolderAdded = function promiseFolderAdded(folderName) {</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineplus">+PromiseTestUtils.promiseFolderAdded = function(folderName) {</span>
<a href="#l10.221"></a><span id="l10.221">   return new Promise((resolve, reject) =&gt; {</span>
<a href="#l10.222"></a><span id="l10.222">     var listener = {</span>
<a href="#l10.223"></a><span id="l10.223">        folderAdded: aFolder =&gt; {</span>
<a href="#l10.224"></a><span id="l10.224">          if (aFolder.name == folderName) {</span>
<a href="#l10.225"></a><span id="l10.225">            MailServices.mfn.removeListener(listener);</span>
<a href="#l10.226"></a><span id="l10.226">            resolve(aFolder);</span>
<a href="#l10.227"></a><span id="l10.227">          }</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineminus">-       }</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineplus">+       },</span>
<a href="#l10.230"></a><span id="l10.230">     };</span>
<a href="#l10.231"></a><span id="l10.231">     MailServices.mfn.addListener(listener,</span>
<a href="#l10.232"></a><span id="l10.232">       Ci.nsIMsgFolderNotificationService.folderAdded);</span>
<a href="#l10.233"></a><span id="l10.233">   });</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineminus">-}</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineplus">+};</span>
<a href="#l10.236"></a><span id="l10.236"> </span>
<a href="#l10.237"></a><span id="l10.237"> /**</span>
<a href="#l10.238"></a><span id="l10.238">  * Timer to resolve a promise after a delay</span>
<a href="#l10.239"></a><span id="l10.239">  *</span>
<a href="#l10.240"></a><span id="l10.240">  * @param aDelay    delay in milliseconds</span>
<a href="#l10.241"></a><span id="l10.241">  * @return          promise that resolves after the delay</span>
<a href="#l10.242"></a><span id="l10.242">  */</span>
<a href="#l10.243"></a><span id="l10.243"> </span>
<a href="#l10.244"></a><span id="l10.244" class="difflineminus">-PromiseTestUtils.promiseDelay = function promiseDelay(aDelay)</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineminus">-{</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineplus">+PromiseTestUtils.promiseDelay = function(aDelay) {</span>
<a href="#l10.247"></a><span id="l10.247">   return new Promise((resolve, reject) =&gt; {</span>
<a href="#l10.248"></a><span id="l10.248">     let timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l10.249"></a><span id="l10.249">     timer.initWithCallback(resolve, aDelay, Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l10.250"></a><span id="l10.250">   });</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineminus">-}</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+};</span>
<a href="#l10.253"></a><span id="l10.253"> </span>
<a href="#l10.254"></a><span id="l10.254"> /**</span>
<a href="#l10.255"></a><span id="l10.255">  * Search listener to resolve a promise when a search completes</span>
<a href="#l10.256"></a><span id="l10.256">  *</span>
<a href="#l10.257"></a><span id="l10.257">  * @param [aSearchSession] The nsIMsgSearchSession to search</span>
<a href="#l10.258"></a><span id="l10.258">  * @param [aWrapped] The nsIMsgSearchNotify to pass all notifications through to.</span>
<a href="#l10.259"></a><span id="l10.259">  *     This gets called prior to the callback (or async resumption).</span>
<a href="#l10.260"></a><span id="l10.260">  */</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineat">@@ -259,30 +253,30 @@ PromiseTestUtils.promiseDelay = function</span>
<a href="#l10.262"></a><span id="l10.262"> PromiseTestUtils.PromiseSearchNotify = function(aSearchSession, aWrapped) {</span>
<a href="#l10.263"></a><span id="l10.263">   this._searchSession = aSearchSession;</span>
<a href="#l10.264"></a><span id="l10.264">   this._searchSession.registerListener(this);</span>
<a href="#l10.265"></a><span id="l10.265">   this.wrapped = aWrapped;</span>
<a href="#l10.266"></a><span id="l10.266">   this._promise = new Promise((resolve, reject) =&gt; {</span>
<a href="#l10.267"></a><span id="l10.267">     this._resolve = resolve;</span>
<a href="#l10.268"></a><span id="l10.268">     this._reject = reject;</span>
<a href="#l10.269"></a><span id="l10.269">   });</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineminus">-}</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineplus">+};</span>
<a href="#l10.272"></a><span id="l10.272"> </span>
<a href="#l10.273"></a><span id="l10.273"> PromiseTestUtils.PromiseSearchNotify.prototype = {</span>
<a href="#l10.274"></a><span id="l10.274">   QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgSearchNotify]),</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineminus">-  onSearchHit: function(aHeader, aFolder) {</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineplus">+  onSearchHit(aHeader, aFolder) {</span>
<a href="#l10.277"></a><span id="l10.277">     if (this.wrapped &amp;&amp; this.wrapped.onSearchHit)</span>
<a href="#l10.278"></a><span id="l10.278">       this.wrapped.onSearchHit(aHeader, aFolder);</span>
<a href="#l10.279"></a><span id="l10.279">   },</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineminus">-  onSearchDone: function onSearchDone(aResult) {</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+  onSearchDone(aResult) {</span>
<a href="#l10.282"></a><span id="l10.282">     this._searchSession.unregisterListener(this);</span>
<a href="#l10.283"></a><span id="l10.283">     if (this.wrapped &amp;&amp; this.wrapped.onSearchDone)</span>
<a href="#l10.284"></a><span id="l10.284">       this.wrapped.onSearchDone(aResult);</span>
<a href="#l10.285"></a><span id="l10.285">     if (aResult == Cr.NS_OK)</span>
<a href="#l10.286"></a><span id="l10.286">       this._resolve();</span>
<a href="#l10.287"></a><span id="l10.287">     else</span>
<a href="#l10.288"></a><span id="l10.288">       this._reject(aResult);</span>
<a href="#l10.289"></a><span id="l10.289">   },</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineminus">-  onNewSearch: function onNewSearch() {</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineplus">+  onNewSearch() {</span>
<a href="#l10.292"></a><span id="l10.292">     if (this.wrapped &amp;&amp; this.wrapped.onNewSearch)</span>
<a href="#l10.293"></a><span id="l10.293">       this.wrapped.onNewSearch();</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineminus">-  }</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineminus">-}</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineplus">+  },</span>
<a href="#l10.297"></a><span id="l10.297" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/test/resources/abSetup.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/test/resources/abSetup.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,45 +1,47 @@</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+</span>
<a href="#l11.8"></a><span id="l11.8"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l11.9"></a><span id="l11.9"> /*</span>
<a href="#l11.10"></a><span id="l11.10">  * Sets up the directory service provider to return the app dir as the profile</span>
<a href="#l11.11"></a><span id="l11.11">  * directory for the address book to use for locating its files during the</span>
<a href="#l11.12"></a><span id="l11.12">  * tests.</span>
<a href="#l11.13"></a><span id="l11.13">  *</span>
<a href="#l11.14"></a><span id="l11.14">  * Note there are further configuration setup items below this.</span>
<a href="#l11.15"></a><span id="l11.15">  */</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19"> /**</span>
<a href="#l11.20"></a><span id="l11.20">  * General Configuration Data that applies to the address book.</span>
<a href="#l11.21"></a><span id="l11.21">  */</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23"> // Personal Address Book configuration items.</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-var kPABData =</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-{</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+var kPABData = {</span>
<a href="#l11.27"></a><span id="l11.27">   URI: &quot;moz-abmdbdirectory://abook.mab&quot;,</span>
<a href="#l11.28"></a><span id="l11.28">   fileName: &quot;abook.mab&quot;,</span>
<a href="#l11.29"></a><span id="l11.29">   dirName: &quot;Personal Address Book&quot;,</span>
<a href="#l11.30"></a><span id="l11.30">   dirType: 2,</span>
<a href="#l11.31"></a><span id="l11.31">   dirPrefID: &quot;ldap_2.servers.pab&quot;,</span>
<a href="#l11.32"></a><span id="l11.32">   readOnly: false,</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-  position: 1</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+  position: 1,</span>
<a href="#l11.35"></a><span id="l11.35"> };</span>
<a href="#l11.36"></a><span id="l11.36"> </span>
<a href="#l11.37"></a><span id="l11.37"> // Collected Address Book configuration items.</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-var kCABData =</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-{</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+var kCABData = {</span>
<a href="#l11.41"></a><span id="l11.41">   URI: &quot;moz-abmdbdirectory://history.mab&quot;,</span>
<a href="#l11.42"></a><span id="l11.42">   fileName: &quot;history.mab&quot;,</span>
<a href="#l11.43"></a><span id="l11.43">   dirName: &quot;Collected Addresses&quot;,</span>
<a href="#l11.44"></a><span id="l11.44">   dirType: 2,</span>
<a href="#l11.45"></a><span id="l11.45">   dirPrefID: &quot;ldap_2.servers.history&quot;,</span>
<a href="#l11.46"></a><span id="l11.46">   readOnly: false,</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-  position: 2</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+  position: 2,</span>
<a href="#l11.49"></a><span id="l11.49"> };</span>
<a href="#l11.50"></a><span id="l11.50"> </span>
<a href="#l11.51"></a><span id="l11.51"> // Windows (Outlook Express) Address Book deactivation. (Bug 448859)</span>
<a href="#l11.52"></a><span id="l11.52"> Services.prefs.deleteBranch(&quot;ldap_2.servers.oe.&quot;);</span>
<a href="#l11.53"></a><span id="l11.53"> </span>
<a href="#l11.54"></a><span id="l11.54"> // OSX Address Book deactivation (Bug 955842)</span>
<a href="#l11.55"></a><span id="l11.55"> Services.prefs.deleteBranch(&quot;ldap_2.servers.osx.&quot;);</span>
<a href="#l11.56"></a><span id="l11.56"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/test/resources/alertTestUtils.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/test/resources/alertTestUtils.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,8 +1,12 @@</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+</span>
<a href="#l12.8"></a><span id="l12.8"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l12.9"></a><span id="l12.9"> /*</span>
<a href="#l12.10"></a><span id="l12.10">  * This file provides support for writing mailnews tests that require hooking</span>
<a href="#l12.11"></a><span id="l12.11">  * into the alerts system. Normally these tests would require a UI and fail in</span>
<a href="#l12.12"></a><span id="l12.12">  * debug mode, but with this method you can hook into the alerts system and</span>
<a href="#l12.13"></a><span id="l12.13">  * avoid the UI.</span>
<a href="#l12.14"></a><span id="l12.14">  *</span>
<a href="#l12.15"></a><span id="l12.15">  * This file registers prompts for nsIWindowWatcher::getNewPrompter and also</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineat">@@ -31,232 +35,236 @@</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18"> var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l12.19"></a><span id="l12.19"> var {MockRegistrar} = ChromeUtils.import(&quot;resource://testing-common/MockRegistrar.jsm&quot;);</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21"> // Wrapper to the nsIPrompt interface.</span>
<a href="#l12.22"></a><span id="l12.22"> // This allows the send code to attempt to display errors to the user without</span>
<a href="#l12.23"></a><span id="l12.23"> // failing.</span>
<a href="#l12.24"></a><span id="l12.24"> var alertUtilsPrompts = {</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-  alert: function(aDialogTitle, aText) {</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+  alert(aDialogTitle, aText) {</span>
<a href="#l12.27"></a><span id="l12.27">     if (typeof alert == &quot;function&quot;) {</span>
<a href="#l12.28"></a><span id="l12.28">       alert(aDialogTitle, aText);</span>
<a href="#l12.29"></a><span id="l12.29">       return;</span>
<a href="#l12.30"></a><span id="l12.30">     }</span>
<a href="#l12.31"></a><span id="l12.31"> </span>
<a href="#l12.32"></a><span id="l12.32">     do_throw(&quot;alert unexpectedly called: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-    return;</span>
<a href="#l12.34"></a><span id="l12.34">   },</span>
<a href="#l12.35"></a><span id="l12.35"> </span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-  alertCheck: function(aDialogTitle, aText, aCheckMsg, aCheckState) {</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+  alertCheck(aDialogTitle, aText, aCheckMsg, aCheckState) {</span>
<a href="#l12.38"></a><span id="l12.38">     if (typeof alertCheck == &quot;function&quot;) {</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+      // eslint-disable-next-line no-undef</span>
<a href="#l12.40"></a><span id="l12.40">       alertCheck(aDialogTitle, aText, aCheckMsg, aCheckState);</span>
<a href="#l12.41"></a><span id="l12.41">       return;</span>
<a href="#l12.42"></a><span id="l12.42">     }</span>
<a href="#l12.43"></a><span id="l12.43"> </span>
<a href="#l12.44"></a><span id="l12.44">     do_throw(&quot;alertCheck unexpectedly called: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-    return;</span>
<a href="#l12.46"></a><span id="l12.46">   },</span>
<a href="#l12.47"></a><span id="l12.47"> </span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-  confirm: function(aDialogTitle, aText) {</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+  confirm(aDialogTitle, aText) {</span>
<a href="#l12.50"></a><span id="l12.50">     if (typeof confirm == &quot;function&quot;) {</span>
<a href="#l12.51"></a><span id="l12.51">       return confirm(aDialogTitle, aText);</span>
<a href="#l12.52"></a><span id="l12.52">     }</span>
<a href="#l12.53"></a><span id="l12.53"> </span>
<a href="#l12.54"></a><span id="l12.54">     do_throw(&quot;confirm unexpectedly called: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l12.55"></a><span id="l12.55">     return false;</span>
<a href="#l12.56"></a><span id="l12.56">   },</span>
<a href="#l12.57"></a><span id="l12.57"> </span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-  confirmCheck: function(aDialogTitle, aText, aCheckMsg, aCheckState) {</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+  confirmCheck(aDialogTitle, aText, aCheckMsg, aCheckState) {</span>
<a href="#l12.60"></a><span id="l12.60">     if (typeof confirmCheck == &quot;function&quot;) {</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+      // eslint-disable-next-line no-undef</span>
<a href="#l12.62"></a><span id="l12.62">       return confirmCheck(aDialogTitle, aText, aCheckMsg, aCheckState);</span>
<a href="#l12.63"></a><span id="l12.63">     }</span>
<a href="#l12.64"></a><span id="l12.64"> </span>
<a href="#l12.65"></a><span id="l12.65">     do_throw(&quot;confirmCheck unexpectedly called: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l12.66"></a><span id="l12.66">     return false;</span>
<a href="#l12.67"></a><span id="l12.67">   },</span>
<a href="#l12.68"></a><span id="l12.68"> </span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-  confirmEx: function(aDialogTitle, aText, aButtonFlags, aButton0Title,</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-                      aButton1Title, aButton2Title, aCheckMsg, aCheckState) {</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+  confirmEx(aDialogTitle, aText, aButtonFlags, aButton0Title,</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+            aButton1Title, aButton2Title, aCheckMsg, aCheckState) {</span>
<a href="#l12.73"></a><span id="l12.73">     if (typeof confirmEx == &quot;function&quot;) {</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+      // eslint-disable-next-line no-undef</span>
<a href="#l12.75"></a><span id="l12.75">       return confirmEx(aDialogTitle, aText, aButtonFlags, aButton0Title,</span>
<a href="#l12.76"></a><span id="l12.76">                        aButton1Title, aButton2Title, aCheckMsg, aCheckState);</span>
<a href="#l12.77"></a><span id="l12.77">     }</span>
<a href="#l12.78"></a><span id="l12.78"> </span>
<a href="#l12.79"></a><span id="l12.79">     do_throw(&quot;confirmEx unexpectedly called: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l12.80"></a><span id="l12.80">     return 0;</span>
<a href="#l12.81"></a><span id="l12.81">   },</span>
<a href="#l12.82"></a><span id="l12.82"> </span>
<a href="#l12.83"></a><span id="l12.83" class="difflineminus">-  prompt: function(aDialogTitle, aText, aValue, aCheckMsg, aCheckState) {</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+  prompt(aDialogTitle, aText, aValue, aCheckMsg, aCheckState) {</span>
<a href="#l12.85"></a><span id="l12.85">     if (typeof prompt == &quot;function&quot;) {</span>
<a href="#l12.86"></a><span id="l12.86">       return prompt(aDialogTitle, aText, aValue, aCheckMsg, aCheckState);</span>
<a href="#l12.87"></a><span id="l12.87">     }</span>
<a href="#l12.88"></a><span id="l12.88"> </span>
<a href="#l12.89"></a><span id="l12.89">     do_throw(&quot;prompt unexpectedly called: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l12.90"></a><span id="l12.90">     return false;</span>
<a href="#l12.91"></a><span id="l12.91">   },</span>
<a href="#l12.92"></a><span id="l12.92"> </span>
<a href="#l12.93"></a><span id="l12.93" class="difflineminus">-  promptUsernameAndPassword: function(aDialogTitle, aText, aUsername,</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineminus">-                                      aPassword, aCheckMsg, aCheckState) {</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+  promptUsernameAndPassword(aDialogTitle, aText, aUsername, aPassword, aCheckMsg, aCheckState) {</span>
<a href="#l12.96"></a><span id="l12.96">     if (typeof promptUsernameAndPassword == &quot;function&quot;) {</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+      // eslint-disable-next-line no-undef</span>
<a href="#l12.98"></a><span id="l12.98">       return promptUsernameAndPassword(aDialogTitle, aText, aUsername,</span>
<a href="#l12.99"></a><span id="l12.99">                                        aPassword, aCheckMsg, aCheckState);</span>
<a href="#l12.100"></a><span id="l12.100">     }</span>
<a href="#l12.101"></a><span id="l12.101"> </span>
<a href="#l12.102"></a><span id="l12.102">     do_throw(&quot;promptUsernameAndPassword unexpectedly called: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l12.103"></a><span id="l12.103">     return false;</span>
<a href="#l12.104"></a><span id="l12.104">   },</span>
<a href="#l12.105"></a><span id="l12.105"> </span>
<a href="#l12.106"></a><span id="l12.106" class="difflineminus">-  promptPassword: function(aDialogTitle, aText, aPassword, aCheckMsg,</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineminus">-                           aCheckState) {</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+  promptPassword(aDialogTitle, aText, aPassword, aCheckMsg, aCheckState) {</span>
<a href="#l12.109"></a><span id="l12.109">     if (typeof promptPassword == &quot;function&quot;) {</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+      // eslint-disable-next-line no-undef</span>
<a href="#l12.111"></a><span id="l12.111">       return promptPassword(aDialogTitle, aText, aPassword, aCheckMsg,</span>
<a href="#l12.112"></a><span id="l12.112">                             aCheckState);</span>
<a href="#l12.113"></a><span id="l12.113">     }</span>
<a href="#l12.114"></a><span id="l12.114"> </span>
<a href="#l12.115"></a><span id="l12.115">     do_throw(&quot;promptPassword unexpectedly called: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l12.116"></a><span id="l12.116">     return false;</span>
<a href="#l12.117"></a><span id="l12.117">   },</span>
<a href="#l12.118"></a><span id="l12.118"> </span>
<a href="#l12.119"></a><span id="l12.119" class="difflineminus">-  select: function(aDialogTitle, aText, aCount, aSelectList,</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineminus">-                   aOutSelection) {</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+  select(aDialogTitle, aText, aCount, aSelectList, aOutSelection) {</span>
<a href="#l12.122"></a><span id="l12.122">     if (typeof select == &quot;function&quot;) {</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+      // eslint-disable-next-line no-undef</span>
<a href="#l12.124"></a><span id="l12.124">       return select(aDialogTitle, aText, aCount, aSelectList,</span>
<a href="#l12.125"></a><span id="l12.125">                     aOutSelection);</span>
<a href="#l12.126"></a><span id="l12.126">     }</span>
<a href="#l12.127"></a><span id="l12.127"> </span>
<a href="#l12.128"></a><span id="l12.128">     do_throw(&quot;select unexpectedly called: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l12.129"></a><span id="l12.129">     return false;</span>
<a href="#l12.130"></a><span id="l12.130">   },</span>
<a href="#l12.131"></a><span id="l12.131"> </span>
<a href="#l12.132"></a><span id="l12.132" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIPrompt])</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIPrompt]),</span>
<a href="#l12.134"></a><span id="l12.134"> };</span>
<a href="#l12.135"></a><span id="l12.135"> </span>
<a href="#l12.136"></a><span id="l12.136"> var alertUtilsPromptService = {</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineminus">-   alert: function(aParent, aDialogTitle, aText) {</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+   alert(aParent, aDialogTitle, aText) {</span>
<a href="#l12.139"></a><span id="l12.139">     if (typeof alertPS == &quot;function&quot;) {</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+      // eslint-disable-next-line no-undef</span>
<a href="#l12.141"></a><span id="l12.141">       alertPS(aParent, aDialogTitle, aText);</span>
<a href="#l12.142"></a><span id="l12.142">       return;</span>
<a href="#l12.143"></a><span id="l12.143">     }</span>
<a href="#l12.144"></a><span id="l12.144"> </span>
<a href="#l12.145"></a><span id="l12.145">     do_throw(&quot;alertPS unexpectedly called: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineminus">-    return;</span>
<a href="#l12.147"></a><span id="l12.147">   },</span>
<a href="#l12.148"></a><span id="l12.148"> </span>
<a href="#l12.149"></a><span id="l12.149" class="difflineminus">-  alertCheck: function(aParent, aDialogTitle, aText, aCheckMsg, aCheckState) {</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+  alertCheck(aParent, aDialogTitle, aText, aCheckMsg, aCheckState) {</span>
<a href="#l12.151"></a><span id="l12.151">     if (typeof alertCheckPS == &quot;function&quot;) {</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+      // eslint-disable-next-line no-undef</span>
<a href="#l12.153"></a><span id="l12.153">       alertCheckPS(aParent, aDialogTitle, aText, aCheckMsg, aCheckState);</span>
<a href="#l12.154"></a><span id="l12.154">       return;</span>
<a href="#l12.155"></a><span id="l12.155">     }</span>
<a href="#l12.156"></a><span id="l12.156"> </span>
<a href="#l12.157"></a><span id="l12.157">     do_throw(&quot;alertCheckPS unexpectedly called: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineminus">-    return;</span>
<a href="#l12.159"></a><span id="l12.159">   },</span>
<a href="#l12.160"></a><span id="l12.160"> </span>
<a href="#l12.161"></a><span id="l12.161" class="difflineminus">-  confirm: function(aParent, aDialogTitle, aText) {</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+  confirm(aParent, aDialogTitle, aText) {</span>
<a href="#l12.163"></a><span id="l12.163">     if (typeof confirmPS == &quot;function&quot;) {</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+      // eslint-disable-next-line no-undef</span>
<a href="#l12.165"></a><span id="l12.165">       return confirmPS(aParent, aDialogTitle, aText);</span>
<a href="#l12.166"></a><span id="l12.166">     }</span>
<a href="#l12.167"></a><span id="l12.167"> </span>
<a href="#l12.168"></a><span id="l12.168">     do_throw(&quot;confirmPS unexpectedly called: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l12.169"></a><span id="l12.169">     return false;</span>
<a href="#l12.170"></a><span id="l12.170">   },</span>
<a href="#l12.171"></a><span id="l12.171"> </span>
<a href="#l12.172"></a><span id="l12.172" class="difflineminus">-  confirmCheck: function(aParent, aDialogTitle, aText, aCheckMsg, aCheckState) {</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+  confirmCheck(aParent, aDialogTitle, aText, aCheckMsg, aCheckState) {</span>
<a href="#l12.174"></a><span id="l12.174">     if (typeof confirmCheckPS == &quot;function&quot;) {</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+      // eslint-disable-next-line no-undef</span>
<a href="#l12.176"></a><span id="l12.176">       return confirmCheckPS(aParent, aDialogTitle, aText, aCheckMsg,</span>
<a href="#l12.177"></a><span id="l12.177">                             aCheckState);</span>
<a href="#l12.178"></a><span id="l12.178">     }</span>
<a href="#l12.179"></a><span id="l12.179"> </span>
<a href="#l12.180"></a><span id="l12.180">     do_throw(&quot;confirmCheckPS unexpectedly called: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l12.181"></a><span id="l12.181">     return false;</span>
<a href="#l12.182"></a><span id="l12.182">   },</span>
<a href="#l12.183"></a><span id="l12.183"> </span>
<a href="#l12.184"></a><span id="l12.184" class="difflineminus">-  confirmEx: function(aParent, aDialogTitle, aText, aButtonFlags, aButton0Title,</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineminus">-                      aButton1Title, aButton2Title, aCheckMsg, aCheckState) {</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+  confirmEx(aParent, aDialogTitle, aText, aButtonFlags, aButton0Title,</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+            aButton1Title, aButton2Title, aCheckMsg, aCheckState) {</span>
<a href="#l12.188"></a><span id="l12.188">     if (typeof confirmExPS == &quot;function&quot;) {</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+      // eslint-disable-next-line no-undef</span>
<a href="#l12.190"></a><span id="l12.190">       return confirmExPS(aParent, aDialogTitle, aText, aButtonFlags,</span>
<a href="#l12.191"></a><span id="l12.191">                          aButton0Title, aButton1Title, aButton2Title, aCheckMsg,</span>
<a href="#l12.192"></a><span id="l12.192">                          aCheckState);</span>
<a href="#l12.193"></a><span id="l12.193">     }</span>
<a href="#l12.194"></a><span id="l12.194"> </span>
<a href="#l12.195"></a><span id="l12.195">     do_throw(&quot;confirmExPS unexpectedly called: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l12.196"></a><span id="l12.196">     return 0;</span>
<a href="#l12.197"></a><span id="l12.197">   },</span>
<a href="#l12.198"></a><span id="l12.198"> </span>
<a href="#l12.199"></a><span id="l12.199" class="difflineminus">-  prompt: function(aParent, aDialogTitle, aText, aValue, aCheckMsg,</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineminus">-                   aCheckState) {</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+  prompt(aParent, aDialogTitle, aText, aValue, aCheckMsg, aCheckState) {</span>
<a href="#l12.202"></a><span id="l12.202">     if (typeof promptPS == &quot;function&quot;) {</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineplus">+      // eslint-disable-next-line no-undef</span>
<a href="#l12.204"></a><span id="l12.204">       return promptPS(aParent, aDialogTitle, aText, aValue, aCheckMsg,</span>
<a href="#l12.205"></a><span id="l12.205">                       aCheckState);</span>
<a href="#l12.206"></a><span id="l12.206">     }</span>
<a href="#l12.207"></a><span id="l12.207"> </span>
<a href="#l12.208"></a><span id="l12.208">     do_throw(&quot;promptPS unexpectedly called: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l12.209"></a><span id="l12.209">     return false;</span>
<a href="#l12.210"></a><span id="l12.210">   },</span>
<a href="#l12.211"></a><span id="l12.211"> </span>
<a href="#l12.212"></a><span id="l12.212" class="difflineminus">-  promptUsernameAndPassword: function(aParent, aDialogTitle, aText, aUsername,</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineminus">-                                      aPassword, aCheckMsg, aCheckState) {</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineplus">+  promptUsernameAndPassword(aParent, aDialogTitle, aText, aUsername,</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+                            aPassword, aCheckMsg, aCheckState) {</span>
<a href="#l12.216"></a><span id="l12.216">     if (typeof promptUsernameAndPasswordPS == &quot;function&quot;) {</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+      // eslint-disable-next-line no-undef</span>
<a href="#l12.218"></a><span id="l12.218">       return promptUsernameAndPasswordPS(aParent, aDialogTitle, aText,</span>
<a href="#l12.219"></a><span id="l12.219">                                          aUsername, aPassword, aCheckMsg,</span>
<a href="#l12.220"></a><span id="l12.220">                                          aCheckState);</span>
<a href="#l12.221"></a><span id="l12.221">     }</span>
<a href="#l12.222"></a><span id="l12.222"> </span>
<a href="#l12.223"></a><span id="l12.223">     do_throw(&quot;promptUsernameAndPasswordPS unexpectedly called: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l12.224"></a><span id="l12.224">     return false;</span>
<a href="#l12.225"></a><span id="l12.225">   },</span>
<a href="#l12.226"></a><span id="l12.226"> </span>
<a href="#l12.227"></a><span id="l12.227" class="difflineminus">-  promptPassword: function(aParent, aDialogTitle, aText, aPassword, aCheckMsg,</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineminus">-                           aCheckState) {</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+  promptPassword(aParent, aDialogTitle, aText, aPassword, aCheckMsg, aCheckState) {</span>
<a href="#l12.230"></a><span id="l12.230">     if (typeof promptPasswordPS == &quot;function&quot;) {</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineplus">+      // eslint-disable-next-line no-undef</span>
<a href="#l12.232"></a><span id="l12.232">       return promptPasswordPS(aParent, aDialogTitle, aText, aPassword,</span>
<a href="#l12.233"></a><span id="l12.233">                               aCheckMsg, aCheckState);</span>
<a href="#l12.234"></a><span id="l12.234">     }</span>
<a href="#l12.235"></a><span id="l12.235"> </span>
<a href="#l12.236"></a><span id="l12.236">     do_throw(&quot;promptPasswordPS unexpectedly called: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l12.237"></a><span id="l12.237">     return false;</span>
<a href="#l12.238"></a><span id="l12.238">   },</span>
<a href="#l12.239"></a><span id="l12.239"> </span>
<a href="#l12.240"></a><span id="l12.240" class="difflineminus">-  select: function(aParent, aDialogTitle, aText, aCount, aSelectList,</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineminus">-                   aOutSelection) {</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineplus">+  select(aParent, aDialogTitle, aText, aCount, aSelectList, aOutSelection) {</span>
<a href="#l12.243"></a><span id="l12.243">     if (typeof selectPS == &quot;function&quot;) {</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+      // eslint-disable-next-line no-undef</span>
<a href="#l12.245"></a><span id="l12.245">       return selectPS(aParent, aDialogTitle, aText, aCount, aSelectList,</span>
<a href="#l12.246"></a><span id="l12.246">                       aOutSelection);</span>
<a href="#l12.247"></a><span id="l12.247">     }</span>
<a href="#l12.248"></a><span id="l12.248"> </span>
<a href="#l12.249"></a><span id="l12.249">     do_throw(&quot;selectPS unexpectedly called: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l12.250"></a><span id="l12.250">     return false;</span>
<a href="#l12.251"></a><span id="l12.251">   },</span>
<a href="#l12.252"></a><span id="l12.252"> </span>
<a href="#l12.253"></a><span id="l12.253" class="difflineminus">-  createInstance: function createInstance(outer, iid) {</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+  createInstance(outer, iid) {</span>
<a href="#l12.255"></a><span id="l12.255">     if (outer != null)</span>
<a href="#l12.256"></a><span id="l12.256">       throw Cr.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l12.257"></a><span id="l12.257">     return this.QueryInterface(iid);</span>
<a href="#l12.258"></a><span id="l12.258">   },</span>
<a href="#l12.259"></a><span id="l12.259"> </span>
<a href="#l12.260"></a><span id="l12.260">   QueryInterface: ChromeUtils.generateQI([Ci.nsIPromptService,</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineminus">-                                          Ci.nsIPromptService2])</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineplus">+                                          Ci.nsIPromptService2]),</span>
<a href="#l12.263"></a><span id="l12.263"> };</span>
<a href="#l12.264"></a><span id="l12.264"> </span>
<a href="#l12.265"></a><span id="l12.265"> var alertUtilsWindowWatcher = {</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineminus">-  getNewPrompter: function(aParent) {</span>
<a href="#l12.267"></a><span id="l12.267" class="difflineplus">+  getNewPrompter(aParent) {</span>
<a href="#l12.268"></a><span id="l12.268">     return alertUtilsPrompts;</span>
<a href="#l12.269"></a><span id="l12.269">   },</span>
<a href="#l12.270"></a><span id="l12.270"> </span>
<a href="#l12.271"></a><span id="l12.271" class="difflineminus">-  getNewAuthPrompter: function(aParent) {</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineplus">+  getNewAuthPrompter(aParent) {</span>
<a href="#l12.273"></a><span id="l12.273">     return Cc[&quot;@mozilla.org/login-manager/prompter;1&quot;]</span>
<a href="#l12.274"></a><span id="l12.274">             .getService(Ci.nsIAuthPrompt);</span>
<a href="#l12.275"></a><span id="l12.275">   },</span>
<a href="#l12.276"></a><span id="l12.276"> </span>
<a href="#l12.277"></a><span id="l12.277" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIWindowWatcher])</span>
<a href="#l12.278"></a><span id="l12.278" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIWindowWatcher]),</span>
<a href="#l12.279"></a><span id="l12.279"> };</span>
<a href="#l12.280"></a><span id="l12.280"> </span>
<a href="#l12.281"></a><span id="l12.281" class="difflineminus">-function registerAlertTestUtils()</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineminus">-{</span>
<a href="#l12.283"></a><span id="l12.283" class="difflineplus">+function registerAlertTestUtils() {</span>
<a href="#l12.284"></a><span id="l12.284">   MockRegistrar.register(&quot;@mozilla.org/embedcomp/window-watcher;1&quot;,</span>
<a href="#l12.285"></a><span id="l12.285">                       alertUtilsWindowWatcher);</span>
<a href="#l12.286"></a><span id="l12.286">   MockRegistrar.register(&quot;@mozilla.org/embedcomp/prompt-service;1&quot;,</span>
<a href="#l12.287"></a><span id="l12.287">                       alertUtilsPromptService);</span>
<a href="#l12.288"></a><span id="l12.288"> }</span>
<a href="#l12.289"></a><span id="l12.289"> </span>
<a href="#l12.290"></a><span id="l12.290"> // Dummy message window that ensures we get prompted for logins.</span>
<a href="#l12.291"></a><span id="l12.291"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/test/resources/asyncTestUtils.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/test/resources/asyncTestUtils.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,8 +1,14 @@</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+/* import-globals-from logHelper.js */</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+</span>
<a href="#l13.10"></a><span id="l13.10"> /*</span>
<a href="#l13.11"></a><span id="l13.11">  * This file provides support for writing mailnews tests using generators so</span>
<a href="#l13.12"></a><span id="l13.12">  *  your test code can be simple and straight-forward.  We provide both the</span>
<a href="#l13.13"></a><span id="l13.13">  *  core routines to do this (async_run, async_driver), as well as helper</span>
<a href="#l13.14"></a><span id="l13.14">  *  routines specialized to</span>
<a href="#l13.15"></a><span id="l13.15">  *</span>
<a href="#l13.16"></a><span id="l13.16">  * Here's some example-ish code:</span>
<a href="#l13.17"></a><span id="l13.17">  *</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineat">@@ -39,51 +45,49 @@ var {logException} = ChromeUtils.import(</span>
<a href="#l13.19"></a><span id="l13.19">  *     simply call async_driver instead.</span>
<a href="#l13.20"></a><span id="l13.20">  */</span>
<a href="#l13.21"></a><span id="l13.21"> function AsyncUrlListener(aWrapped, aCallback, aPromise) {</span>
<a href="#l13.22"></a><span id="l13.22">   this.wrapped = aWrapped ? aWrapped.QueryInterface(Ci.nsIUrlListener) : null;</span>
<a href="#l13.23"></a><span id="l13.23">   this.callback = aCallback;</span>
<a href="#l13.24"></a><span id="l13.24">   this.promise = aPromise;</span>
<a href="#l13.25"></a><span id="l13.25"> }</span>
<a href="#l13.26"></a><span id="l13.26"> AsyncUrlListener.prototype = {</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-  OnStartRunningUrl: function asyncUrlListener_OnStartRunningUrl(</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-                         aUrl) {</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+  OnStartRunningUrl(aUrl) {</span>
<a href="#l13.30"></a><span id="l13.30">     if (this.wrapped)</span>
<a href="#l13.31"></a><span id="l13.31">       this.wrapped.OnStartRunningUrl(aUrl);</span>
<a href="#l13.32"></a><span id="l13.32">   },</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-  OnStopRunningUrl: function asyncUrlListener_OnStopRunningUrl(</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-                         aUrl, aExitCode) {</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l13.36"></a><span id="l13.36">     if (this.wrapped)</span>
<a href="#l13.37"></a><span id="l13.37">       this.wrapped.OnStopRunningUrl(aUrl, aExitCode);</span>
<a href="#l13.38"></a><span id="l13.38">     if (this.callback)</span>
<a href="#l13.39"></a><span id="l13.39">       this.callback(aUrl, aExitCode);</span>
<a href="#l13.40"></a><span id="l13.40">     if (this.promise)</span>
<a href="#l13.41"></a><span id="l13.41">       this.promise();</span>
<a href="#l13.42"></a><span id="l13.42">     else</span>
<a href="#l13.43"></a><span id="l13.43">       async_driver();</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-  }</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+  },</span>
<a href="#l13.46"></a><span id="l13.46"> };</span>
<a href="#l13.47"></a><span id="l13.47"> </span>
<a href="#l13.48"></a><span id="l13.48"> /**</span>
<a href="#l13.49"></a><span id="l13.49">  * nsIUrlListener that calls async_driver when the URL stops running.  Pass this</span>
<a href="#l13.50"></a><span id="l13.50">  *  in as an argument to asynchronous native mechanisms that use a URL listener</span>
<a href="#l13.51"></a><span id="l13.51">  *  to notify when they complete.  If you need to wrap an existing listener</span>
<a href="#l13.52"></a><span id="l13.52">  *  and/or have a callback notified before triggering the async process, create</span>
<a href="#l13.53"></a><span id="l13.53">  *  your own instance of |AsyncUrlListener|.</span>
<a href="#l13.54"></a><span id="l13.54">  */</span>
<a href="#l13.55"></a><span id="l13.55"> var asyncUrlListener = new AsyncUrlListener();</span>
<a href="#l13.56"></a><span id="l13.56"> </span>
<a href="#l13.57"></a><span id="l13.57"> var asyncCopyListener = {</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-  SetMessageKey: function(aMsgKey) {},</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-  GetMessageId: function() {},</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-  OnStopCopy: function(aStatus) {</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+  SetMessageKey(aMsgKey) {},</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+  GetMessageId() {},</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l13.68"></a><span id="l13.68">     async_driver();</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-  }</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+  },</span>
<a href="#l13.71"></a><span id="l13.71"> };</span>
<a href="#l13.72"></a><span id="l13.72"> </span>
<a href="#l13.73"></a><span id="l13.73"> var asyncGeneratorStack = [], asyncGeneratorSendValue = undefined;</span>
<a href="#l13.74"></a><span id="l13.74"> </span>
<a href="#l13.75"></a><span id="l13.75"> /**</span>
<a href="#l13.76"></a><span id="l13.76">  * Run a function that may or may not be a generator.  All functions, generator</span>
<a href="#l13.77"></a><span id="l13.77">  *  or not, must return false if they do not want the async_driver to run the</span>
<a href="#l13.78"></a><span id="l13.78">  *  next logical work step.  Returning no value (undefined) or true indicates to</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineat">@@ -108,22 +112,20 @@ function async_run(aArgs) {</span>
<a href="#l13.80"></a><span id="l13.80">   if (result &amp;&amp; result.next) {</span>
<a href="#l13.81"></a><span id="l13.81">     asyncGeneratorStack.push([result, aArgs.func.name]);</span>
<a href="#l13.82"></a><span id="l13.82">     // Use the timer variant in case the asynchronous sub-call is able to run</span>
<a href="#l13.83"></a><span id="l13.83">     //  to completion.  If we didn't do this, we might end up trying to re-call</span>
<a href="#l13.84"></a><span id="l13.84">     //  into the same generator that is currently active.  We can obviously</span>
<a href="#l13.85"></a><span id="l13.85">     //  make _async_driver more clever to deal with this if we have a reason.</span>
<a href="#l13.86"></a><span id="l13.86">     return async_driver();</span>
<a href="#l13.87"></a><span id="l13.87">   }</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineminus">-  else {</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineminus">-    if (result === undefined)</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineminus">-      return true;</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineminus">-    else</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineminus">-      return result;</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineminus">-  }</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+  if (result === undefined)</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+    return true;</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+  return result;</span>
<a href="#l13.98"></a><span id="l13.98"> }</span>
<a href="#l13.99"></a><span id="l13.99"> </span>
<a href="#l13.100"></a><span id="l13.100"> /**</span>
<a href="#l13.101"></a><span id="l13.101">  * Function to kick off/resume asynchronous processing.  Any function invoked by</span>
<a href="#l13.102"></a><span id="l13.102">  *  async_run that returns/yields false at any point is responsible for ensuring</span>
<a href="#l13.103"></a><span id="l13.103">  *  async_driver() is called again once the async operation completes.</span>
<a href="#l13.104"></a><span id="l13.104">  *</span>
<a href="#l13.105"></a><span id="l13.105">  * Note: This function actually schedules the real driver to run after a</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineat">@@ -146,34 +148,33 @@ function async_driver(val) {</span>
<a href="#l13.107"></a><span id="l13.107">  *  after each step.</span>
<a href="#l13.108"></a><span id="l13.108">  */</span>
<a href="#l13.109"></a><span id="l13.109"> var asyncExpectedEarlyAbort = &quot;REAP!&quot;;</span>
<a href="#l13.110"></a><span id="l13.110"> </span>
<a href="#l13.111"></a><span id="l13.111"> // the real driver!</span>
<a href="#l13.112"></a><span id="l13.112"> function _async_driver() {</span>
<a href="#l13.113"></a><span id="l13.113">   let curGenerator;</span>
<a href="#l13.114"></a><span id="l13.114">   while (asyncGeneratorStack.length) {</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineminus">-    curGenerator = asyncGeneratorStack[asyncGeneratorStack.length-1][0];</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+    curGenerator = asyncGeneratorStack[asyncGeneratorStack.length - 1][0];</span>
<a href="#l13.117"></a><span id="l13.117">     try {</span>
<a href="#l13.118"></a><span id="l13.118">       let nextItem;</span>
<a href="#l13.119"></a><span id="l13.119">       do {</span>
<a href="#l13.120"></a><span id="l13.120">         nextItem = curGenerator.next(asyncGeneratorSendValue);</span>
<a href="#l13.121"></a><span id="l13.121">         if (!nextItem.value || nextItem.done)</span>
<a href="#l13.122"></a><span id="l13.122">           break;</span>
<a href="#l13.123"></a><span id="l13.123">         asyncGeneratorSendValue = undefined;</span>
<a href="#l13.124"></a><span id="l13.124">       } while (true);</span>
<a href="#l13.125"></a><span id="l13.125"> </span>
<a href="#l13.126"></a><span id="l13.126">       if (nextItem.done) {</span>
<a href="#l13.127"></a><span id="l13.127">         asyncGeneratorStack.pop();</span>
<a href="#l13.128"></a><span id="l13.128">       } else {</span>
<a href="#l13.129"></a><span id="l13.129">         asyncGeneratorSendValue = undefined;</span>
<a href="#l13.130"></a><span id="l13.130">         return false;</span>
<a href="#l13.131"></a><span id="l13.131">       }</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineminus">-    }</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineminus">-    catch (ex) {</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+    } catch (ex) {</span>
<a href="#l13.135"></a><span id="l13.135">       if (ex != asyncExpectedEarlyAbort) {</span>
<a href="#l13.136"></a><span id="l13.136">         let asyncStack = [];</span>
<a href="#l13.137"></a><span id="l13.137">         dump(&quot;*******************************************\n&quot;);</span>
<a href="#l13.138"></a><span id="l13.138">         dump(&quot;Generator explosion!\n&quot;);</span>
<a href="#l13.139"></a><span id="l13.139">         dump(&quot;Unhappiness at: &quot; + (ex.fileName || ex.filename) + &quot;:&quot; + ex.lineNumber + &quot;\n&quot;);</span>
<a href="#l13.140"></a><span id="l13.140">         dump(&quot;Because: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l13.141"></a><span id="l13.141">         if (ex.stack)</span>
<a href="#l13.142"></a><span id="l13.142">           dump(&quot;Stack:\n  &quot; + ex.stack.replace(/\n/g, &quot;\n  &quot;) + &quot;\n&quot;);</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineat">@@ -222,23 +223,22 @@ function _async_test_runner_postTest() {</span>
<a href="#l13.144"></a><span id="l13.144">   }</span>
<a href="#l13.145"></a><span id="l13.145"> }</span>
<a href="#l13.146"></a><span id="l13.146"> </span>
<a href="#l13.147"></a><span id="l13.147"> function _async_test_runner_timeout() {</span>
<a href="#l13.148"></a><span id="l13.148">   for (let helper of ASYNC_TEST_RUNNER_HELPERS) {</span>
<a href="#l13.149"></a><span id="l13.149">     try {</span>
<a href="#l13.150"></a><span id="l13.150">       if (helper.onTimeout)</span>
<a href="#l13.151"></a><span id="l13.151">         helper.onTimeout();</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineminus">-    }</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineminus">-    catch (ex) {</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+    } catch (ex) {</span>
<a href="#l13.155"></a><span id="l13.155">       dump(&quot;warning: helper failure: (&quot; + ex.fileName + &quot;:&quot; + ex.lineNumber +</span>
<a href="#l13.156"></a><span id="l13.156">            &quot;): &quot; + ex + &quot;\n&quot;);</span>
<a href="#l13.157"></a><span id="l13.157">     }</span>
<a href="#l13.158"></a><span id="l13.158">   }</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineminus">-  do_throw('Timeout running test, and we want you to have the log.');</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+  do_throw(&quot;Timeout running test, and we want you to have the log.&quot;);</span>
<a href="#l13.161"></a><span id="l13.161"> }</span>
<a href="#l13.162"></a><span id="l13.162"> </span>
<a href="#l13.163"></a><span id="l13.163"> /**</span>
<a href="#l13.164"></a><span id="l13.164">  * Purely decorative function to help explain to people reading lists of tests</span>
<a href="#l13.165"></a><span id="l13.165">  *  using async_run_tests what is going on.  We just return a tuple of our</span>
<a href="#l13.166"></a><span id="l13.166">  *  arguments and _async_test_runner understands what to do with this, namely</span>
<a href="#l13.167"></a><span id="l13.167">  *  to run the test once for each element in the aParameters list.  If the</span>
<a href="#l13.168"></a><span id="l13.168">  *  elements in the aParameters list have a 'name' attribute, it will get</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineat">@@ -270,48 +270,43 @@ function* _async_test_runner(aTests) {</span>
<a href="#l13.170"></a><span id="l13.170">     if (test.length) {</span>
<a href="#l13.171"></a><span id="l13.171">       let [testFunc, parameters] = test;</span>
<a href="#l13.172"></a><span id="l13.172">       for (let parameter of parameters) {</span>
<a href="#l13.173"></a><span id="l13.173">         let paramDesc, args;</span>
<a href="#l13.174"></a><span id="l13.174">         if (typeof(parameter) == &quot;object&quot;) {</span>
<a href="#l13.175"></a><span id="l13.175">           if (parameter.length) {</span>
<a href="#l13.176"></a><span id="l13.176">             paramDesc = parameter.toString();</span>
<a href="#l13.177"></a><span id="l13.177">             args = parameter;</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineminus">-          }</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineminus">-          else {</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+          } else {</span>
<a href="#l13.181"></a><span id="l13.181">             paramDesc = parameter.name;</span>
<a href="#l13.182"></a><span id="l13.182">             args = [parameter];</span>
<a href="#l13.183"></a><span id="l13.183">           }</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineminus">-        }</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineminus">-        else {</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+        } else {</span>
<a href="#l13.187"></a><span id="l13.187">           paramDesc = parameter.toString();</span>
<a href="#l13.188"></a><span id="l13.188">           args = [parameter];</span>
<a href="#l13.189"></a><span id="l13.189">         }</span>
<a href="#l13.190"></a><span id="l13.190">         mark_test_start(testFunc.name, paramDesc);</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineminus">-        yield async_run({func: testFunc, args: args});</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+        yield async_run({func: testFunc, args});</span>
<a href="#l13.193"></a><span id="l13.193">         _async_test_runner_postTest();</span>
<a href="#l13.194"></a><span id="l13.194">         mark_test_end();</span>
<a href="#l13.195"></a><span id="l13.195">       }</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineminus">-</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineminus">-    }</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineminus">-    else {</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+    } else {</span>
<a href="#l13.200"></a><span id="l13.200">       mark_test_start(test.name);</span>
<a href="#l13.201"></a><span id="l13.201">       yield async_run({func: test});</span>
<a href="#l13.202"></a><span id="l13.202">       _async_test_runner_postTest();</span>
<a href="#l13.203"></a><span id="l13.203">       mark_test_end();</span>
<a href="#l13.204"></a><span id="l13.204">     }</span>
<a href="#l13.205"></a><span id="l13.205">   }</span>
<a href="#l13.206"></a><span id="l13.206"> </span>
<a href="#l13.207"></a><span id="l13.207">   dump(&quot;=== (Done With Tests)\n&quot;);</span>
<a href="#l13.208"></a><span id="l13.208"> </span>
<a href="#l13.209"></a><span id="l13.209">   for (let cleanupHelper of ASYNC_TEST_RUNNER_FINAL_CLEANUP_HELPERS) {</span>
<a href="#l13.210"></a><span id="l13.210">     try {</span>
<a href="#l13.211"></a><span id="l13.211">       cleanupHelper();</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineminus">-    }</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineminus">-    catch (ex) {</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+    } catch (ex) {</span>
<a href="#l13.215"></a><span id="l13.215">       mark_failure([&quot;Problem during asyncTestUtils cleanup helper&quot;,</span>
<a href="#l13.216"></a><span id="l13.216">                      cleanupHelper.name, &quot;exception:&quot;, ex]);</span>
<a href="#l13.217"></a><span id="l13.217">     }</span>
<a href="#l13.218"></a><span id="l13.218">   }</span>
<a href="#l13.219"></a><span id="l13.219"> </span>
<a href="#l13.220"></a><span id="l13.220">   mark_all_tests_run();</span>
<a href="#l13.221"></a><span id="l13.221"> </span>
<a href="#l13.222"></a><span id="l13.222">   do_test_finished();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/test/resources/filterTestUtils.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/test/resources/filterTestUtils.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,35 +1,37 @@</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+</span>
<a href="#l14.8"></a><span id="l14.8"> // Utility functions for testing interactions with filters.</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> var contains = Ci.nsMsgSearchOp.Contains;</span>
<a href="#l14.11"></a><span id="l14.11"> // This maps strings to a filter attribute (excluding the parameter)</span>
<a href="#l14.12"></a><span id="l14.12"> var ATTRIB_MAP = {</span>
<a href="#l14.13"></a><span id="l14.13">   // Template : [attrib, op, field of value, otherHeader]</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-  &quot;subject&quot; : [Ci.nsMsgSearchAttrib.Subject, contains, &quot;str&quot;, null],</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-  &quot;from&quot; : [Ci.nsMsgSearchAttrib.Sender, contains, &quot;str&quot;, null],</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-  &quot;date&quot; : [Ci.nsMsgSearchAttrib.Date, Ci.nsMsgSearchOp.Is, &quot;date&quot;, null],</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-  &quot;size&quot; : [Ci.nsMsgSearchAttrib.Size, Ci.nsMsgSearchOp.Is, &quot;size&quot;, null],</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-  &quot;message-id&quot; : [Ci.nsMsgSearchAttrib.OtherHeader+1, contains, &quot;str&quot;,</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-                  &quot;Message-ID&quot;],</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-  &quot;user-agent&quot; : [Ci.nsMsgSearchAttrib.OtherHeader+2, contains, &quot;str&quot;,</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-                  &quot;User-Agent&quot;]</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+  &quot;subject&quot;: [Ci.nsMsgSearchAttrib.Subject, contains, &quot;str&quot;, null],</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+  &quot;from&quot;: [Ci.nsMsgSearchAttrib.Sender, contains, &quot;str&quot;, null],</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+  &quot;date&quot;: [Ci.nsMsgSearchAttrib.Date, Ci.nsMsgSearchOp.Is, &quot;date&quot;, null],</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+  &quot;size&quot;: [Ci.nsMsgSearchAttrib.Size, Ci.nsMsgSearchOp.Is, &quot;size&quot;, null],</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+  &quot;message-id&quot;: [Ci.nsMsgSearchAttrib.OtherHeader + 1, contains, &quot;str&quot;, &quot;Message-ID&quot;],</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+  &quot;user-agent&quot;: [Ci.nsMsgSearchAttrib.OtherHeader + 2, contains, &quot;str&quot;, &quot;User-Agent&quot;],</span>
<a href="#l14.28"></a><span id="l14.28"> };</span>
<a href="#l14.29"></a><span id="l14.29"> // And this maps strings to filter actions</span>
<a href="#l14.30"></a><span id="l14.30"> var ACTION_MAP = {</span>
<a href="#l14.31"></a><span id="l14.31">   // Template : [action, auxiliary attribute field, auxiliary value]</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-  &quot;priority&quot; : [Ci.nsMsgFilterAction.ChangePriority, &quot;priority&quot;, 6],</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-  &quot;delete&quot; : [Ci.nsMsgFilterAction.Delete],</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-  &quot;read&quot; : [Ci.nsMsgFilterAction.MarkRead],</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-  &quot;unread&quot; : [Ci.nsMsgFilterAction.MarkUnread],</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-  &quot;kill&quot; : [Ci.nsMsgFilterAction.KillThread],</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-  &quot;watch&quot; : [Ci.nsMsgFilterAction.WatchThread],</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-  &quot;flag&quot; : [Ci.nsMsgFilterAction.MarkFlagged],</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+  &quot;priority&quot;: [Ci.nsMsgFilterAction.ChangePriority, &quot;priority&quot;, 6],</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+  &quot;delete&quot;: [Ci.nsMsgFilterAction.Delete],</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+  &quot;read&quot;: [Ci.nsMsgFilterAction.MarkRead],</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+  &quot;unread&quot;: [Ci.nsMsgFilterAction.MarkUnread],</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+  &quot;kill&quot;: [Ci.nsMsgFilterAction.KillThread],</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+  &quot;watch&quot;: [Ci.nsMsgFilterAction.WatchThread],</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+  &quot;flag&quot;: [Ci.nsMsgFilterAction.MarkFlagged],</span>
<a href="#l14.46"></a><span id="l14.46">   &quot;stop&quot;: [Ci.nsMsgFilterAction.StopExecution],</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-  &quot;tag&quot; : [Ci.nsMsgFilterAction.AddTag, &quot;strValue&quot;, &quot;tag&quot;]</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+  &quot;tag&quot;: [Ci.nsMsgFilterAction.AddTag, &quot;strValue&quot;, &quot;tag&quot;],</span>
<a href="#l14.49"></a><span id="l14.49"> };</span>
<a href="#l14.50"></a><span id="l14.50"> </span>
<a href="#l14.51"></a><span id="l14.51"> /**</span>
<a href="#l14.52"></a><span id="l14.52">  * Creates a filter and appends it to the nsIMsgFilterList.</span>
<a href="#l14.53"></a><span id="l14.53">  *</span>
<a href="#l14.54"></a><span id="l14.54">  * @param list    An nsIMsgFilter to which the new filter will be appended.</span>
<a href="#l14.55"></a><span id="l14.55">  * @param trigger A key of ATTRIB_MAP that represents the filter trigger.</span>
<a href="#l14.56"></a><span id="l14.56">  * @param value   The value of the filter trigger.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/test/resources/folderEventLogHelper.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/test/resources/folderEventLogHelper.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,11 +1,13 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.5"></a><span id="l15.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+/* import-globals-from logHelper.js */</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11"> /*</span>
<a href="#l15.12"></a><span id="l15.12">  * Hook up folder notifications to logHelper.js.  This is for the benefit of</span>
<a href="#l15.13"></a><span id="l15.13">  *  gloda but others can benefit too.  Cramming it in gloda's file structure</span>
<a href="#l15.14"></a><span id="l15.14">  *  for now.</span>
<a href="#l15.15"></a><span id="l15.15">  */</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineat">@@ -35,125 +37,115 @@ function registerFolderEventLogHelper() </span>
<a href="#l15.19"></a><span id="l15.19">         Ci.nsIMsgFolderNotificationService.itemEvent);</span>
<a href="#l15.20"></a><span id="l15.20"> }</span>
<a href="#l15.21"></a><span id="l15.21"> </span>
<a href="#l15.22"></a><span id="l15.22"> /**</span>
<a href="#l15.23"></a><span id="l15.23">  * nsIMsgFolderListener implementation to logHelper events that gloda cares</span>
<a href="#l15.24"></a><span id="l15.24">  *  about.</span>
<a href="#l15.25"></a><span id="l15.25">  */</span>
<a href="#l15.26"></a><span id="l15.26"> var _folderEventLogHelper_msgFolderListener = {</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-  msgAdded: function felh_msgAdded(aMsg) {</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+  msgAdded(aMsg) {</span>
<a href="#l15.29"></a><span id="l15.29">     mark_action(&quot;msgEvent&quot;, &quot;msgAdded&quot;, [aMsg]);</span>
<a href="#l15.30"></a><span id="l15.30">   },</span>
<a href="#l15.31"></a><span id="l15.31"> </span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-  msgsClassified: function felh_msgsClassified(aMsgs, aJunkProcessed,</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-                                               aTraitProcessed) {</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+  msgsClassified(aMsgs, aJunkProcessed, aTraitProcessed) {</span>
<a href="#l15.35"></a><span id="l15.35">     let args = [</span>
<a href="#l15.36"></a><span id="l15.36">       aJunkProcessed ? &quot;junk processed&quot; : &quot;did not junk process&quot;,</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-      aTraitProcessed ? &quot;trait processed&quot; : &quot;did not trait process&quot;</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+      aTraitProcessed ? &quot;trait processed&quot; : &quot;did not trait process&quot;,</span>
<a href="#l15.39"></a><span id="l15.39">     ];</span>
<a href="#l15.40"></a><span id="l15.40">     for (let msgHdr of fixIterator(aMsgs, Ci.nsIMsgDBHdr)) {</span>
<a href="#l15.41"></a><span id="l15.41">       args.push(msgHdr);</span>
<a href="#l15.42"></a><span id="l15.42">     }</span>
<a href="#l15.43"></a><span id="l15.43">     mark_action(&quot;msgEvent&quot;, &quot;msgsClassified&quot;, args);</span>
<a href="#l15.44"></a><span id="l15.44">   },</span>
<a href="#l15.45"></a><span id="l15.45"> </span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-  msgsDeleted: function felh_msgsDeleted(aMsgs) {</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+  msgsDeleted(aMsgs) {</span>
<a href="#l15.48"></a><span id="l15.48">     let args = [];</span>
<a href="#l15.49"></a><span id="l15.49">     for (let msgHdr of fixIterator(aMsgs, Ci.nsIMsgDBHdr)) {</span>
<a href="#l15.50"></a><span id="l15.50">       args.push(msgHdr);</span>
<a href="#l15.51"></a><span id="l15.51">     }</span>
<a href="#l15.52"></a><span id="l15.52">     mark_action(&quot;msgEvent&quot;, &quot;msgsDeleted&quot;, args);</span>
<a href="#l15.53"></a><span id="l15.53">   },</span>
<a href="#l15.54"></a><span id="l15.54"> </span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-  msgsMoveCopyCompleted: function felh_msgsMoveCopyCompleted(aMove, aSrcMsgs,</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-                                                             aDestFolder,</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-                                                             aDestMsgs) {</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+  msgsMoveCopyCompleted(aMove, aSrcMsgs, aDestFolder, aDestMsgs) {</span>
<a href="#l15.59"></a><span id="l15.59">     let args = [aMove ? &quot;moved&quot; : &quot;copied&quot;];</span>
<a href="#l15.60"></a><span id="l15.60">     for (let msgHdr of fixIterator(aSrcMsgs, Ci.nsIMsgDBHdr)) {</span>
<a href="#l15.61"></a><span id="l15.61">       args.push(msgHdr);</span>
<a href="#l15.62"></a><span id="l15.62">     }</span>
<a href="#l15.63"></a><span id="l15.63">     args.push(&quot;to&quot;);</span>
<a href="#l15.64"></a><span id="l15.64">     args.push(aDestFolder);</span>
<a href="#l15.65"></a><span id="l15.65">     if (aDestMsgs) {</span>
<a href="#l15.66"></a><span id="l15.66">       args.push(&quot;dest headers:&quot;);</span>
<a href="#l15.67"></a><span id="l15.67">       for (let msgHdr of fixIterator(aDestMsgs, Ci.nsIMsgDBHdr)) {</span>
<a href="#l15.68"></a><span id="l15.68">         args.push(msgHdr);</span>
<a href="#l15.69"></a><span id="l15.69">       }</span>
<a href="#l15.70"></a><span id="l15.70">     }</span>
<a href="#l15.71"></a><span id="l15.71">     mark_action(&quot;msgEvent&quot;, &quot;msgsMoveCopyCompleted&quot;, args);</span>
<a href="#l15.72"></a><span id="l15.72">   },</span>
<a href="#l15.73"></a><span id="l15.73"> </span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-  msgKeyChanged: function felh_msgKeyChanged(aOldMsgKey, aNewMsgHdr) {</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+  msgKeyChanged(aOldMsgKey, aNewMsgHdr) {</span>
<a href="#l15.76"></a><span id="l15.76">     let args = [&quot;old key&quot;, aOldMsgKey, &quot;new header&quot;, aNewMsgHdr];</span>
<a href="#l15.77"></a><span id="l15.77">     mark_action(&quot;msgEvent&quot;, &quot;msgKeyChanged&quot;, args);</span>
<a href="#l15.78"></a><span id="l15.78">   },</span>
<a href="#l15.79"></a><span id="l15.79"> </span>
<a href="#l15.80"></a><span id="l15.80" class="difflineminus">-  folderAdded: function felh_folderAdded(aFolder) {</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+  folderAdded(aFolder) {</span>
<a href="#l15.82"></a><span id="l15.82">     mark_action(&quot;msgEvent&quot;, &quot;folderAdded&quot;, [aFolder]);</span>
<a href="#l15.83"></a><span id="l15.83">   },</span>
<a href="#l15.84"></a><span id="l15.84"> </span>
<a href="#l15.85"></a><span id="l15.85" class="difflineminus">-  folderDeleted: function felh_folderDeleted(aFolder) {</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+  folderDeleted(aFolder) {</span>
<a href="#l15.87"></a><span id="l15.87">     mark_action(&quot;msgEvent&quot;, &quot;folderDeleted&quot;, [aFolder]);</span>
<a href="#l15.88"></a><span id="l15.88">   },</span>
<a href="#l15.89"></a><span id="l15.89"> </span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-  folderMoveCopyCompleted: function felh_folderMoveCopyCompleted(aMove,</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-                                                                 aSrcFolder,</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-                                                                 aDestFolder) {</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+  folderMoveCopyCompleted(aMove, aSrcFolder, aDestFolder) {</span>
<a href="#l15.94"></a><span id="l15.94">     mark_action(&quot;msgEvent&quot;, &quot;folderMoveCopyCompleted&quot;,</span>
<a href="#l15.95"></a><span id="l15.95">                 [aMove ? &quot;move&quot; : &quot;copy&quot;,</span>
<a href="#l15.96"></a><span id="l15.96">                  aSrcFolder, &quot;to&quot;, aDestFolder]);</span>
<a href="#l15.97"></a><span id="l15.97">   },</span>
<a href="#l15.98"></a><span id="l15.98"> </span>
<a href="#l15.99"></a><span id="l15.99" class="difflineminus">-  folderRenamed: function felh_folderRenamed(aOrigFolder, aNewFolder) {</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+  folderRenamed(aOrigFolder, aNewFolder) {</span>
<a href="#l15.101"></a><span id="l15.101">     mark_action(&quot;msgEvent&quot;, &quot;folderRenamed&quot;, [aOrigFolder, &quot;to&quot;, aNewFolder]);</span>
<a href="#l15.102"></a><span id="l15.102">   },</span>
<a href="#l15.103"></a><span id="l15.103"> </span>
<a href="#l15.104"></a><span id="l15.104" class="difflineminus">-  itemEvent: function felh_itemEvent(aItem, aEvent, aData, aString) {</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineplus">+  itemEvent(aItem, aEvent, aData, aString) {</span>
<a href="#l15.106"></a><span id="l15.106">     mark_action(&quot;msgEvent&quot;, &quot;itemEvent&quot;, [aItem, aEvent, aData, aString]);</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineminus">-  }</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineplus">+  },</span>
<a href="#l15.109"></a><span id="l15.109"> };</span>
<a href="#l15.110"></a><span id="l15.110"> </span>
<a href="#l15.111"></a><span id="l15.111"> </span>
<a href="#l15.112"></a><span id="l15.112"> /**</span>
<a href="#l15.113"></a><span id="l15.113">  * nsIFolderListener implementation to logHelper stuff that gloda cares about.</span>
<a href="#l15.114"></a><span id="l15.114">  */</span>
<a href="#l15.115"></a><span id="l15.115"> var _folderEventLogHelper_folderListener = {</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineminus">-  OnItemAdded: function felh_OnItemAdded(aParentItem, aItem) {</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineplus">+  OnItemAdded(aParentItem, aItem) {</span>
<a href="#l15.118"></a><span id="l15.118">   },</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineminus">-  OnItemRemoved: function felh_OnItemRemoved(aParentItem, aItem) {</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineplus">+  OnItemRemoved(aParentItem, aItem) {</span>
<a href="#l15.121"></a><span id="l15.121">   },</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-  OnItemPropertyChanged: function felh_OnItemPropertyChanged(</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-    aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineplus">+  OnItemPropertyChanged(aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l15.125"></a><span id="l15.125">   },</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineminus">-  OnItemIntPropertyChanged: function felh_OnItemIntPropertyChanged(</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineminus">-    aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineplus">+  OnItemIntPropertyChanged(aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l15.129"></a><span id="l15.129">   },</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-  OnItemBoolPropertyChanged: function felh_OnItemBoolPropertyChanged(</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineminus">-    aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+  OnItemBoolPropertyChanged(aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l15.133"></a><span id="l15.133">   },</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineminus">-  OnItemUnicharPropertyChanged: function felh_OnItemUnicharPropertyChanged(</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineminus">-    aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineplus">+  OnItemUnicharPropertyChanged(aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l15.137"></a><span id="l15.137">   },</span>
<a href="#l15.138"></a><span id="l15.138">   /**</span>
<a href="#l15.139"></a><span id="l15.139">    * Notice when user activity adds/removes tags or changes a message's</span>
<a href="#l15.140"></a><span id="l15.140">    *  status.</span>
<a href="#l15.141"></a><span id="l15.141">    */</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineminus">-  OnItemPropertyFlagChanged: function felh_OnItemPropertyFlagChanged(</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineminus">-      aMsgHdr, aProperty, aOldValue, aNewValue) {</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineplus">+  OnItemPropertyFlagChanged(aMsgHdr, aProperty, aOldValue, aNewValue) {</span>
<a href="#l15.145"></a><span id="l15.145">     mark_action(&quot;msgEvent&quot;, &quot;OnItemPropertyFlagChanged&quot;,</span>
<a href="#l15.146"></a><span id="l15.146">                 [&quot;Header&quot;, aMsgHdr,</span>
<a href="#l15.147"></a><span id="l15.147">                  &quot;had property &quot; + aProperty + &quot; have the &quot; +</span>
<a href="#l15.148"></a><span id="l15.148">                  &quot;following bits change: &quot; +</span>
<a href="#l15.149"></a><span id="l15.149">                  _explode_flags(aOldValue ^ aNewValue,</span>
<a href="#l15.150"></a><span id="l15.150">                                 Ci.nsMsgMessageFlags)]);</span>
<a href="#l15.151"></a><span id="l15.151">   },</span>
<a href="#l15.152"></a><span id="l15.152"> </span>
<a href="#l15.153"></a><span id="l15.153">   /**</span>
<a href="#l15.154"></a><span id="l15.154">    * Get folder loaded notifications for folders that had to do some</span>
<a href="#l15.155"></a><span id="l15.155">    *  (asynchronous) processing before they could be opened.</span>
<a href="#l15.156"></a><span id="l15.156">    */</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineminus">-  OnItemEvent: function felh_OnItemEvent(aFolder, aEvent) {</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineplus">+  OnItemEvent(aFolder, aEvent) {</span>
<a href="#l15.159"></a><span id="l15.159">     mark_action(&quot;msgEvent&quot;, &quot;OnItemEvent&quot;,</span>
<a href="#l15.160"></a><span id="l15.160">                 [aFolder, aEvent]);</span>
<a href="#l15.161"></a><span id="l15.161">   },</span>
<a href="#l15.162"></a><span id="l15.162"> };</span>
<a href="#l15.163"></a><span id="l15.163"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/test/resources/localAccountUtils.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/test/resources/localAccountUtils.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,20 +1,18 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.5"></a><span id="l16.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9"> this.EXPORTED_SYMBOLS = [&quot;localAccountUtils&quot;];</span>
<a href="#l16.10"></a><span id="l16.10"> </span>
<a href="#l16.11"></a><span id="l16.11"> // MailServices</span>
<a href="#l16.12"></a><span id="l16.12"> const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l16.13"></a><span id="l16.13"> const {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l16.14"></a><span id="l16.14"> </span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-var CC = Components.Constructor;</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-</span>
<a href="#l16.17"></a><span id="l16.17"> // Local Mail Folders. Requires prior setup of profile directory</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19"> var localAccountUtils = {</span>
<a href="#l16.20"></a><span id="l16.20">   inboxFolder: undefined,</span>
<a href="#l16.21"></a><span id="l16.21">   incomingServer: undefined,</span>
<a href="#l16.22"></a><span id="l16.22">   rootFolder: undefined,</span>
<a href="#l16.23"></a><span id="l16.23">   msgAccount: undefined,</span>
<a href="#l16.24"></a><span id="l16.24"> </span>
<a href="#l16.25"></a><span id="l16.25" class="difflineat">@@ -57,57 +55,52 @@ var localAccountUtils = {</span>
<a href="#l16.26"></a><span id="l16.26">     // Note: Inbox is not created automatically when there is no deferred server,</span>
<a href="#l16.27"></a><span id="l16.27">     // so we need to create it.</span>
<a href="#l16.28"></a><span id="l16.28">     this.inboxFolder = this.rootFolder.createLocalSubfolder(&quot;Inbox&quot;)</span>
<a href="#l16.29"></a><span id="l16.29">                          .QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l16.30"></a><span id="l16.30">     // a local inbox should have a Mail flag!</span>
<a href="#l16.31"></a><span id="l16.31">     this.inboxFolder.setFlag(Ci.nsMsgFolderFlags.Mail);</span>
<a href="#l16.32"></a><span id="l16.32"> </span>
<a href="#l16.33"></a><span id="l16.33">     // Force an initialization of the Inbox folder database.</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-    var folderName = this.inboxFolder.prettyName;</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+    this.inboxFolder.prettyName;</span>
<a href="#l16.36"></a><span id="l16.36"> </span>
<a href="#l16.37"></a><span id="l16.37">     this._localAccountInitialized = true;</span>
<a href="#l16.38"></a><span id="l16.38">   },</span>
<a href="#l16.39"></a><span id="l16.39"> </span>
<a href="#l16.40"></a><span id="l16.40">   /**</span>
<a href="#l16.41"></a><span id="l16.41">    * Create an nsIMsgIncomingServer and an nsIMsgAccount to go with it.</span>
<a href="#l16.42"></a><span id="l16.42">    *</span>
<a href="#l16.43"></a><span id="l16.43">    * @param aType The type of the server (pop3, imap etc).</span>
<a href="#l16.44"></a><span id="l16.44">    * @param aPort The port the server is on.</span>
<a href="#l16.45"></a><span id="l16.45">    * @param aUsername The username for the server.</span>
<a href="#l16.46"></a><span id="l16.46">    * @param aPassword The password for the server.</span>
<a href="#l16.47"></a><span id="l16.47">    * @param aHostname The hostname for the server (defaults to localhost).</span>
<a href="#l16.48"></a><span id="l16.48">    * @return The newly-created nsIMsgIncomingServer.</span>
<a href="#l16.49"></a><span id="l16.49">    */</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-  create_incoming_server(aType, aPort, aUsername, aPassword,</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-                         aHostname=&quot;localhost&quot;) {</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+  create_incoming_server(aType, aPort, aUsername, aPassword, aHostname = &quot;localhost&quot;) {</span>
<a href="#l16.53"></a><span id="l16.53">     let serverAndAccount = localAccountUtils.</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-      create_incoming_server_and_account(aType, aPort, aUsername, aPassword,</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-                                         aHostname);</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+      create_incoming_server_and_account(aType, aPort, aUsername, aPassword, aHostname);</span>
<a href="#l16.57"></a><span id="l16.57">     return serverAndAccount.server;</span>
<a href="#l16.58"></a><span id="l16.58">   },</span>
<a href="#l16.59"></a><span id="l16.59"> </span>
<a href="#l16.60"></a><span id="l16.60">   /**</span>
<a href="#l16.61"></a><span id="l16.61">    * Create an nsIMsgIncomingServer and an nsIMsgAccount to go with it.</span>
<a href="#l16.62"></a><span id="l16.62">    * There are no identities created for the account.</span>
<a href="#l16.63"></a><span id="l16.63">    *</span>
<a href="#l16.64"></a><span id="l16.64">    * @param aType The type of the server (pop3, imap etc).</span>
<a href="#l16.65"></a><span id="l16.65">    * @param aPort The port the server is on.</span>
<a href="#l16.66"></a><span id="l16.66">    * @param aUsername The username for the server.</span>
<a href="#l16.67"></a><span id="l16.67">    * @param aPassword The password for the server.</span>
<a href="#l16.68"></a><span id="l16.68">    * @param aHostname The hostname for the server (defaults to localhost).</span>
<a href="#l16.69"></a><span id="l16.69">    * @return An object with the newly-created nsIMsgIncomingServer as the</span>
<a href="#l16.70"></a><span id="l16.70">              &quot;server&quot; property and the newly-created nsIMsgAccount as the</span>
<a href="#l16.71"></a><span id="l16.71">              &quot;account&quot; property.</span>
<a href="#l16.72"></a><span id="l16.72">    */</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineminus">-  create_incoming_server_and_account(aType, aPort, aUsername, aPassword,</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-                                     aHostname=&quot;localhost&quot;) {</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-    let server = MailServices.accounts.createIncomingServer(aUsername,</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-                                                            aHostname,</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-                                                            aType);</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+  create_incoming_server_and_account(aType, aPort, aUsername, aPassword, aHostname = &quot;localhost&quot;) {</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+    let server = MailServices.accounts.createIncomingServer(aUsername, aHostname, aType);</span>
<a href="#l16.80"></a><span id="l16.80">     server.port = aPort;</span>
<a href="#l16.81"></a><span id="l16.81">     if (aUsername != null)</span>
<a href="#l16.82"></a><span id="l16.82">       server.username = aUsername;</span>
<a href="#l16.83"></a><span id="l16.83">     if (aPassword != null)</span>
<a href="#l16.84"></a><span id="l16.84">       server.password = aPassword;</span>
<a href="#l16.85"></a><span id="l16.85"> </span>
<a href="#l16.86"></a><span id="l16.86">     server.valid = false;</span>
<a href="#l16.87"></a><span id="l16.87"> </span>
<a href="#l16.88"></a><span id="l16.88" class="difflineat">@@ -117,29 +110,29 @@ var localAccountUtils = {</span>
<a href="#l16.89"></a><span id="l16.89">       // Several tests expect that mail is deferred to the local folders account,</span>
<a href="#l16.90"></a><span id="l16.90">       // so do that.</span>
<a href="#l16.91"></a><span id="l16.91">       this.loadLocalMailAccount();</span>
<a href="#l16.92"></a><span id="l16.92">       server.QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l16.93"></a><span id="l16.93">       server.deferredToAccount = this.msgAccount.key;</span>
<a href="#l16.94"></a><span id="l16.94">     }</span>
<a href="#l16.95"></a><span id="l16.95">     server.valid = true;</span>
<a href="#l16.96"></a><span id="l16.96"> </span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-    return {server: server, account: account};</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+    return {server, account};</span>
<a href="#l16.99"></a><span id="l16.99">   },</span>
<a href="#l16.100"></a><span id="l16.100"> </span>
<a href="#l16.101"></a><span id="l16.101">   /**</span>
<a href="#l16.102"></a><span id="l16.102">    * Create an outgoing nsISmtpServer with the given parameters.</span>
<a href="#l16.103"></a><span id="l16.103">    *</span>
<a href="#l16.104"></a><span id="l16.104">    * @param aPort The port the server is on.</span>
<a href="#l16.105"></a><span id="l16.105">    * @param aUsername The username for the server</span>
<a href="#l16.106"></a><span id="l16.106">    * @param aPassword The password for the server</span>
<a href="#l16.107"></a><span id="l16.107">    * @param aHostname The hostname for the server (defaults to localhost).</span>
<a href="#l16.108"></a><span id="l16.108">    * @return The newly-created nsISmtpServer.</span>
<a href="#l16.109"></a><span id="l16.109">    */</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineminus">-  create_outgoing_server(aPort, aUsername, aPassword, aHostname=&quot;localhost&quot;) {</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+  create_outgoing_server(aPort, aUsername, aPassword, aHostname = &quot;localhost&quot;) {</span>
<a href="#l16.112"></a><span id="l16.112">     let server = MailServices.smtp.createServer();</span>
<a href="#l16.113"></a><span id="l16.113">     server.hostname = aHostname;</span>
<a href="#l16.114"></a><span id="l16.114">     server.port = aPort;</span>
<a href="#l16.115"></a><span id="l16.115">     server.authMethod = Ci.nsMsgAuthMethod.none;</span>
<a href="#l16.116"></a><span id="l16.116">     return server;</span>
<a href="#l16.117"></a><span id="l16.117">   },</span>
<a href="#l16.118"></a><span id="l16.118"> </span>
<a href="#l16.119"></a><span id="l16.119">   /**</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineat">@@ -158,10 +151,10 @@ var localAccountUtils = {</span>
<a href="#l16.121"></a><span id="l16.121"> </span>
<a href="#l16.122"></a><span id="l16.122">     let identity = MailServices.accounts.createIdentity();</span>
<a href="#l16.123"></a><span id="l16.123">     identity.smtpServerKey = aOutgoingServer.key;</span>
<a href="#l16.124"></a><span id="l16.124"> </span>
<a href="#l16.125"></a><span id="l16.125">     aIncoming.addIdentity(identity);</span>
<a href="#l16.126"></a><span id="l16.126"> </span>
<a href="#l16.127"></a><span id="l16.127">     if (aSetAsDefault)</span>
<a href="#l16.128"></a><span id="l16.128">       aIncoming.defaultIdentity = identity;</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineminus">-  }</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineplus">+  },</span>
<a href="#l16.131"></a><span id="l16.131"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/test/resources/logHelper.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/test/resources/logHelper.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1,21 +1,26 @@</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineplus">+</span>
<a href="#l17.8"></a><span id="l17.8"> /*</span>
<a href="#l17.9"></a><span id="l17.9">  * Makes everything awesome if you are Andrew.  Some day it will make everything</span>
<a href="#l17.10"></a><span id="l17.10">  *  awesome if you are not awesome too.</span>
<a href="#l17.11"></a><span id="l17.11">  *</span>
<a href="#l17.12"></a><span id="l17.12">  * Right now the most meaningful thing to know is that if XPCOM failures happen</span>
<a href="#l17.13"></a><span id="l17.13">  *  (and get reported to the error console), this will induce a unit test</span>
<a href="#l17.14"></a><span id="l17.14">  *  failure.  You should think this is awesome no matter whether you are Andrew</span>
<a href="#l17.15"></a><span id="l17.15">  *  or not.</span>
<a href="#l17.16"></a><span id="l17.16">  */</span>
<a href="#l17.17"></a><span id="l17.17"> </span>
<a href="#l17.18"></a><span id="l17.18"> var {Log4Moz} = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l17.19"></a><span id="l17.19"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l17.20"></a><span id="l17.20"> var {IOUtils} = ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+// eslint-disable-next-line mozilla/reject-importGlobalProperties</span>
<a href="#l17.22"></a><span id="l17.22"> Cu.importGlobalProperties([&quot;Element&quot;, &quot;Node&quot;]);</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24"> var _mailnewsTestLogger;</span>
<a href="#l17.25"></a><span id="l17.25"> var _xpcshellLogger;</span>
<a href="#l17.26"></a><span id="l17.26"> var _testLoggerContexts = [];</span>
<a href="#l17.27"></a><span id="l17.27"> var _testLoggerActiveContext;</span>
<a href="#l17.28"></a><span id="l17.28"> </span>
<a href="#l17.29"></a><span id="l17.29"> var _logHelperInterestedListeners = false;</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineat">@@ -38,74 +43,69 @@ function logHelperHasInterestedListeners</span>
<a href="#l17.31"></a><span id="l17.31">  * Tunnel nsIScriptErrors that show up on the error console to Log4Moz.  We could</span>
<a href="#l17.32"></a><span id="l17.32">  *  send everything but I think only script errors are likely of much concern.</span>
<a href="#l17.33"></a><span id="l17.33">  *  Also, this nicely avoids infinite recursions no matter what you do since</span>
<a href="#l17.34"></a><span id="l17.34">  *  what we publish is not going to end up as an nsIScriptError.</span>
<a href="#l17.35"></a><span id="l17.35">  *</span>
<a href="#l17.36"></a><span id="l17.36">  * This is based on my (asuth') exmmad extension.</span>
<a href="#l17.37"></a><span id="l17.37">  */</span>
<a href="#l17.38"></a><span id="l17.38"> var _errorConsoleTunnel = {</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-  initialize: function () {</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+  initialize() {</span>
<a href="#l17.41"></a><span id="l17.41">     Services.console.registerListener(this);</span>
<a href="#l17.42"></a><span id="l17.42"> </span>
<a href="#l17.43"></a><span id="l17.43">     // we need to unregister our listener at shutdown if we don't want explosions</span>
<a href="#l17.44"></a><span id="l17.44">     Services.obs.addObserver(this, &quot;quit-application&quot;);</span>
<a href="#l17.45"></a><span id="l17.45">   },</span>
<a href="#l17.46"></a><span id="l17.46"> </span>
<a href="#l17.47"></a><span id="l17.47" class="difflineminus">-  shutdown: function () {</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+  shutdown() {</span>
<a href="#l17.49"></a><span id="l17.49">     Services.console.unregisterListener(this);</span>
<a href="#l17.50"></a><span id="l17.50">     Services.obs.removeObserver(this, &quot;quit-application&quot;);</span>
<a href="#l17.51"></a><span id="l17.51">   },</span>
<a href="#l17.52"></a><span id="l17.52"> </span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-  observe: function (aMessage, aTopic, aData) {</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+  observe(aMessage, aTopic, aData) {</span>
<a href="#l17.55"></a><span id="l17.55">     if (aTopic == &quot;quit-application&quot;) {</span>
<a href="#l17.56"></a><span id="l17.56">       this.shutdown();</span>
<a href="#l17.57"></a><span id="l17.57">       return;</span>
<a href="#l17.58"></a><span id="l17.58">     }</span>
<a href="#l17.59"></a><span id="l17.59"> </span>
<a href="#l17.60"></a><span id="l17.60">     try {</span>
<a href="#l17.61"></a><span id="l17.61">       // meh, let's just use mark_failure for now.</span>
<a href="#l17.62"></a><span id="l17.62">       // and let's avoid feedback loops (happens in mozmill)</span>
<a href="#l17.63"></a><span id="l17.63">       if ((aMessage instanceof Ci.nsIScriptError) &amp;&amp;</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineminus">-        (!aMessage.errorMessage.includes(&quot;Error console says&quot;)))</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineminus">-        {</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">-          // Unfortunately changes to mozilla-central are throwing lots</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineminus">-          // of console errors during testing, so disable (we hope temporarily)</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-          // failing on XPCOM console errors (see bug 1014350).</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-          // An XPCOM error aMessage looks like this:</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-          //   [JavaScript Error: &quot;uncaught exception: 2147500037&quot;]</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-          // Capture the number, and allow known XPCOM results.</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-          let matches = /exception: (\d+)/.exec(aMessage);</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineminus">-          let XPCOMresult = null;</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineminus">-          if (matches) {</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineminus">-            for (let result in Cr) {</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineminus">-              if (matches[1] == Cr[result])</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineminus">-              {</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-                XPCOMresult = result;</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineminus">-                break;</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineminus">-              }</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineplus">+          (!aMessage.errorMessage.includes(&quot;Error console says&quot;))) {</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+        // Unfortunately changes to mozilla-central are throwing lots</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+        // of console errors during testing, so disable (we hope temporarily)</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+        // failing on XPCOM console errors (see bug 1014350).</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+        // An XPCOM error aMessage looks like this:</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+        //   [JavaScript Error: &quot;uncaught exception: 2147500037&quot;]</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+        // Capture the number, and allow known XPCOM results.</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+        let matches = /exception: (\d+)/.exec(aMessage);</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+        let XPCOMresult = null;</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+        if (matches) {</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+          for (let result in Cr) {</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+            if (matches[1] == Cr[result]) {</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+              XPCOMresult = result;</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+              break;</span>
<a href="#l17.95"></a><span id="l17.95">             }</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineminus">-            let message = XPCOMresult || aMessage;</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineminus">-            if (logHelperAllowedErrors.some(e =&gt; e == matches[1]))</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineminus">-            {</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineminus">-              if (XPCOMresult)</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineminus">-                info(&quot;Ignoring XPCOM error: &quot; + message);</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineminus">-              return;</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-            }</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineminus">-            else</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-              info(&quot;Found XPCOM error: &quot; + message);</span>
<a href="#l17.105"></a><span id="l17.105">           }</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineminus">-          mark_failure([&quot;Error console says&quot;, aMessage]);</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+          let message = XPCOMresult || aMessage;</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+          if (logHelperAllowedErrors.some(e =&gt; e == matches[1])) {</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+            if (XPCOMresult)</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+              info(&quot;Ignoring XPCOM error: &quot; + message);</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineplus">+            return;</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineplus">+          }</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineplus">+          info(&quot;Found XPCOM error: &quot; + message);</span>
<a href="#l17.114"></a><span id="l17.114">         }</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-    }</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineminus">-    catch (ex) {</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineplus">+        mark_failure([&quot;Error console says&quot;, aMessage]);</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineplus">+      }</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+    } catch (ex) {</span>
<a href="#l17.120"></a><span id="l17.120">       // This is to avoid pathological error loops.  we definitely do not</span>
<a href="#l17.121"></a><span id="l17.121">       // want to propagate an error here.</span>
<a href="#l17.122"></a><span id="l17.122">     }</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineminus">-  }</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineplus">+  },</span>
<a href="#l17.125"></a><span id="l17.125"> };</span>
<a href="#l17.126"></a><span id="l17.126"> </span>
<a href="#l17.127"></a><span id="l17.127"> // This defaults to undefined and is for use by test-folder-display-helpers</span>
<a href="#l17.128"></a><span id="l17.128"> //  so that it can pre-initialize the value so that when we are evaluated in</span>
<a href="#l17.129"></a><span id="l17.129"> //  its subscript loader we see a value of 'true'.</span>
<a href="#l17.130"></a><span id="l17.130"> var _do_not_wrap_xpcshell;</span>
<a href="#l17.131"></a><span id="l17.131"> </span>
<a href="#l17.132"></a><span id="l17.132"> /**</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineat">@@ -193,22 +193,22 @@ function mark_test_start(aName, aParamet</span>
<a href="#l17.134"></a><span id="l17.134"> </span>
<a href="#l17.135"></a><span id="l17.135">   // clear out any existing contexts</span>
<a href="#l17.136"></a><span id="l17.136">   mark_test_end(aDepth);</span>
<a href="#l17.137"></a><span id="l17.137"> </span>
<a href="#l17.138"></a><span id="l17.138">   let term = (aDepth == 0) ? &quot;test&quot; : &quot;subtest&quot;;</span>
<a href="#l17.139"></a><span id="l17.139">   _testLoggerActiveContext = _mailnewsTestLogger.newContext({</span>
<a href="#l17.140"></a><span id="l17.140">     type: term,</span>
<a href="#l17.141"></a><span id="l17.141">     name: aName,</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineminus">-    parameter: aParameter</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+    parameter: aParameter,</span>
<a href="#l17.144"></a><span id="l17.144">   });</span>
<a href="#l17.145"></a><span id="l17.145">   if (_testLoggerContexts.length) {</span>
<a href="#l17.146"></a><span id="l17.146">     _testLoggerActiveContext._contextDepth = _testLoggerContexts.length;</span>
<a href="#l17.147"></a><span id="l17.147">     _testLoggerActiveContext._contextParentId =</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineminus">-      _testLoggerContexts[_testLoggerContexts.length-1]._id;</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineplus">+      _testLoggerContexts[_testLoggerContexts.length - 1]._id;</span>
<a href="#l17.150"></a><span id="l17.150">   }</span>
<a href="#l17.151"></a><span id="l17.151">   _testLoggerContexts.push(_testLoggerActiveContext);</span>
<a href="#l17.152"></a><span id="l17.152"> </span>
<a href="#l17.153"></a><span id="l17.153">   _mailnewsTestLogger.info(_testLoggerActiveContext,</span>
<a href="#l17.154"></a><span id="l17.154">                            &quot;Starting &quot; + term + &quot;: &quot; + aName +</span>
<a href="#l17.155"></a><span id="l17.155">                            (aParameter ? (&quot;, &quot; + aParameter) : &quot;&quot;));</span>
<a href="#l17.156"></a><span id="l17.156"> }</span>
<a href="#l17.157"></a><span id="l17.157"> </span>
<a href="#l17.158"></a><span id="l17.158" class="difflineat">@@ -315,31 +315,27 @@ function __simple_obj_copy(aObj, aDepthA</span>
<a href="#l17.159"></a><span id="l17.159">     if (aObj.__lookupGetter__(key)) {</span>
<a href="#l17.160"></a><span id="l17.160">       oot[key] = &quot;*getter*&quot;;</span>
<a href="#l17.161"></a><span id="l17.161">       continue;</span>
<a href="#l17.162"></a><span id="l17.162">     }</span>
<a href="#l17.163"></a><span id="l17.163">     let value = aObj[key];</span>
<a href="#l17.164"></a><span id="l17.164"> </span>
<a href="#l17.165"></a><span id="l17.165">     if (value == null) {</span>
<a href="#l17.166"></a><span id="l17.166">       oot[key] = null;</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineminus">-    }</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineminus">-    else if (typeof(value) != &quot;object&quot;) {</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineplus">+    } else if (typeof(value) != &quot;object&quot;) {</span>
<a href="#l17.170"></a><span id="l17.170">       oot[key] = value;</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineminus">-    }</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineminus">-    // steal control flow if no more depth is allowed</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineminus">-    else if (!aDepthAllowed) {</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineplus">+    } else if (!aDepthAllowed) {</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineplus">+      // steal control flow if no more depth is allowed</span>
<a href="#l17.176"></a><span id="l17.176">       oot[key] = &quot;truncated, string rep: &quot; + value.toString();</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineminus">-    }</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineminus">-    // array?  (not directly counted, but we will terminate because the</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineminus">-    //  child copying occurs using nextDepth...)</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineminus">-    else if (Array.isArray(value)) {</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineplus">+    } else if (Array.isArray(value)) {</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineplus">+      // array?  (not directly counted, but we will terminate because the</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineplus">+      //  child copying occurs using nextDepth...)</span>
<a href="#l17.184"></a><span id="l17.184">       oot[key] = value.map(v =&gt; __value_copy(v, nextDepth));</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineminus">-    }</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineminus">-    // it's another object! woo!</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineminus">-    else {</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineplus">+    } else {</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineplus">+      // it's another object! woo!</span>
<a href="#l17.190"></a><span id="l17.190">       oot[key] = _normalize_for_json(value, nextDepth, true);</span>
<a href="#l17.191"></a><span id="l17.191">     }</span>
<a href="#l17.192"></a><span id="l17.192">   }</span>
<a href="#l17.193"></a><span id="l17.193"> </span>
<a href="#l17.194"></a><span id="l17.194">   // let's take advantage of the object's native toString now</span>
<a href="#l17.195"></a><span id="l17.195">   oot._stringRep = aObj.toString();</span>
<a href="#l17.196"></a><span id="l17.196"> </span>
<a href="#l17.197"></a><span id="l17.197">   return oot;</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineat">@@ -375,26 +371,24 @@ function _normalize_for_json(aObj, aDept</span>
<a href="#l17.199"></a><span id="l17.199"> </span>
<a href="#l17.200"></a><span id="l17.200">   // recursively transform arrays outright</span>
<a href="#l17.201"></a><span id="l17.201">   if (Array.isArray(aObj))</span>
<a href="#l17.202"></a><span id="l17.202">       return aObj.map(v =&gt; __value_copy(v, aDepthAllowed - 1));</span>
<a href="#l17.203"></a><span id="l17.203"> </span>
<a href="#l17.204"></a><span id="l17.204">   // === Mail Specific ===</span>
<a href="#l17.205"></a><span id="l17.205">   // (but common and few enough to not split out)</span>
<a href="#l17.206"></a><span id="l17.206">   if (aObj instanceof Ci.nsIMsgFolder) {</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineminus">-    let flags = aObj.flags;</span>
<a href="#l17.208"></a><span id="l17.208">     return {</span>
<a href="#l17.209"></a><span id="l17.209">       type: &quot;folder&quot;,</span>
<a href="#l17.210"></a><span id="l17.210">       name: aObj.prettyName,</span>
<a href="#l17.211"></a><span id="l17.211">       uri: aObj.URI,</span>
<a href="#l17.212"></a><span id="l17.212">       flags: _explode_flags(aObj.flags,</span>
<a href="#l17.213"></a><span id="l17.213">                             Ci.nsMsgFolderFlags),</span>
<a href="#l17.214"></a><span id="l17.214">     };</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineminus">-  }</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineminus">-  else if (aObj instanceof Ci.nsIMsgDBHdr) {</span>
<a href="#l17.217"></a><span id="l17.217" class="difflineplus">+  } else if (aObj instanceof Ci.nsIMsgDBHdr) {</span>
<a href="#l17.218"></a><span id="l17.218">     let properties = {};</span>
<a href="#l17.219"></a><span id="l17.219">     for (let name in _INTERESTING_MESSAGE_HEADER_PROPERTIES) {</span>
<a href="#l17.220"></a><span id="l17.220">       let propType = _INTERESTING_MESSAGE_HEADER_PROPERTIES[name];</span>
<a href="#l17.221"></a><span id="l17.221">       if (propType === 0)</span>
<a href="#l17.222"></a><span id="l17.222">         properties[name] = (aObj.getStringProperty(name) != &quot;&quot;) ?</span>
<a href="#l17.223"></a><span id="l17.223">                              aObj.getUint32Property(name) : null;</span>
<a href="#l17.224"></a><span id="l17.224">       else</span>
<a href="#l17.225"></a><span id="l17.225">         properties[name] = aObj.getStringProperty(name);</span>
<a href="#l17.226"></a><span id="l17.226" class="difflineat">@@ -406,122 +400,114 @@ function _normalize_for_json(aObj, aDept</span>
<a href="#l17.227"></a><span id="l17.227">       from: aObj.mime2DecodedAuthor,</span>
<a href="#l17.228"></a><span id="l17.228">       to: aObj.mime2DecodedRecipients,</span>
<a href="#l17.229"></a><span id="l17.229">       messageKey: aObj.messageKey,</span>
<a href="#l17.230"></a><span id="l17.230">       messageId: aObj.messageId,</span>
<a href="#l17.231"></a><span id="l17.231">       flags: _explode_flags(aObj.flags,</span>
<a href="#l17.232"></a><span id="l17.232">                             Ci.nsMsgMessageFlags),</span>
<a href="#l17.233"></a><span id="l17.233">       interestingProperties: properties,</span>
<a href="#l17.234"></a><span id="l17.234">     };</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineminus">-  }</span>
<a href="#l17.236"></a><span id="l17.236" class="difflineminus">-  // === Generic ===</span>
<a href="#l17.237"></a><span id="l17.237" class="difflineminus">-  // DOM nodes, including elements</span>
<a href="#l17.238"></a><span id="l17.238" class="difflineminus">-  else if (Node.isInstance(aObj)) {</span>
<a href="#l17.239"></a><span id="l17.239" class="difflineplus">+  } else if (Node.isInstance(aObj)) {</span>
<a href="#l17.240"></a><span id="l17.240" class="difflineplus">+    // === Generic ===</span>
<a href="#l17.241"></a><span id="l17.241" class="difflineplus">+    // DOM nodes, including elements</span>
<a href="#l17.242"></a><span id="l17.242">     let name = aObj.nodeName;</span>
<a href="#l17.243"></a><span id="l17.243">     let objAttrs = {};</span>
<a href="#l17.244"></a><span id="l17.244"> </span>
<a href="#l17.245"></a><span id="l17.245">     if (Element.isInstance(aObj))</span>
<a href="#l17.246"></a><span id="l17.246">       name += &quot;#&quot; + aObj.getAttribute(&quot;id&quot;);</span>
<a href="#l17.247"></a><span id="l17.247"> </span>
<a href="#l17.248"></a><span id="l17.248">     if (&quot;attributes&quot; in aObj) {</span>
<a href="#l17.249"></a><span id="l17.249">       let nodeAttrs = aObj.attributes;</span>
<a href="#l17.250"></a><span id="l17.250">       for (let iAttr = 0; iAttr &lt; nodeAttrs.length; iAttr++) {</span>
<a href="#l17.251"></a><span id="l17.251">         objAttrs[nodeAttrs[iAttr].name] = nodeAttrs[iAttr].value;</span>
<a href="#l17.252"></a><span id="l17.252">       }</span>
<a href="#l17.253"></a><span id="l17.253">     }</span>
<a href="#l17.254"></a><span id="l17.254"> </span>
<a href="#l17.255"></a><span id="l17.255" class="difflineminus">-    let bounds = { left: null, top: null, width: null, height: null }</span>
<a href="#l17.256"></a><span id="l17.256" class="difflineplus">+    let bounds = { left: null, top: null, width: null, height: null };</span>
<a href="#l17.257"></a><span id="l17.257">     if (&quot;getBoundingClientRect&quot; in aObj)</span>
<a href="#l17.258"></a><span id="l17.258">       bounds = aObj.getBoundingClientRect();</span>
<a href="#l17.259"></a><span id="l17.259"> </span>
<a href="#l17.260"></a><span id="l17.260">     return {</span>
<a href="#l17.261"></a><span id="l17.261">       type: &quot;domNode&quot;,</span>
<a href="#l17.262"></a><span id="l17.262" class="difflineminus">-      name: name,</span>
<a href="#l17.263"></a><span id="l17.263" class="difflineplus">+      name,</span>
<a href="#l17.264"></a><span id="l17.264">       value: aObj.nodeValue,</span>
<a href="#l17.265"></a><span id="l17.265">       namespace: aObj.namespaceURI,</span>
<a href="#l17.266"></a><span id="l17.266">       boundingClientRect: bounds,</span>
<a href="#l17.267"></a><span id="l17.267">       attrs: objAttrs,</span>
<a href="#l17.268"></a><span id="l17.268">     };</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineminus">-  }</span>
<a href="#l17.270"></a><span id="l17.270" class="difflineminus">-  else if (aObj instanceof Ci.nsIDOMWindow) {</span>
<a href="#l17.271"></a><span id="l17.271" class="difflineplus">+  } else if (aObj instanceof Ci.nsIDOMWindow) {</span>
<a href="#l17.272"></a><span id="l17.272">     let winId, title;</span>
<a href="#l17.273"></a><span id="l17.273">     if (aObj.document &amp;&amp; aObj.document.documentElement) {</span>
<a href="#l17.274"></a><span id="l17.274">       title = aObj.document.title;</span>
<a href="#l17.275"></a><span id="l17.275">       winId = aObj.document.documentElement.getAttribute(&quot;windowtype&quot;) ||</span>
<a href="#l17.276"></a><span id="l17.276">               aObj.document.documentElement.getAttribute(&quot;id&quot;) ||</span>
<a href="#l17.277"></a><span id="l17.277">               &quot;unnamed&quot;;</span>
<a href="#l17.278"></a><span id="l17.278" class="difflineminus">-    }</span>
<a href="#l17.279"></a><span id="l17.279" class="difflineminus">-    else {</span>
<a href="#l17.280"></a><span id="l17.280" class="difflineplus">+    } else {</span>
<a href="#l17.281"></a><span id="l17.281">       winId = &quot;n/a&quot;;</span>
<a href="#l17.282"></a><span id="l17.282">       title = &quot;no document&quot;;</span>
<a href="#l17.283"></a><span id="l17.283">     }</span>
<a href="#l17.284"></a><span id="l17.284">     return {</span>
<a href="#l17.285"></a><span id="l17.285">       type: &quot;domWindow&quot;,</span>
<a href="#l17.286"></a><span id="l17.286">       id: winId,</span>
<a href="#l17.287"></a><span id="l17.287" class="difflineminus">-      title: title,</span>
<a href="#l17.288"></a><span id="l17.288" class="difflineplus">+      title,</span>
<a href="#l17.289"></a><span id="l17.289">       location: &quot;&quot; + aObj.location,</span>
<a href="#l17.290"></a><span id="l17.290">       coords: {x: aObj.screenX, y: aObj.screenY},</span>
<a href="#l17.291"></a><span id="l17.291">       dims: {width: aObj.outerWidth, height: aObj.outerHeight},</span>
<a href="#l17.292"></a><span id="l17.292">     };</span>
<a href="#l17.293"></a><span id="l17.293" class="difflineminus">-  }</span>
<a href="#l17.294"></a><span id="l17.294" class="difflineminus">-  // Although straight JS exceptions should serialize pretty well, we can</span>
<a href="#l17.295"></a><span id="l17.295" class="difflineminus">-  //  improve things by making &quot;stack&quot; more friendly.</span>
<a href="#l17.296"></a><span id="l17.296" class="difflineminus">-  else if (aObj instanceof Error) {</span>
<a href="#l17.297"></a><span id="l17.297" class="difflineplus">+  } else if (aObj instanceof Error) {</span>
<a href="#l17.298"></a><span id="l17.298" class="difflineplus">+    // Although straight JS exceptions should serialize pretty well, we can</span>
<a href="#l17.299"></a><span id="l17.299" class="difflineplus">+    //  improve things by making &quot;stack&quot; more friendly.</span>
<a href="#l17.300"></a><span id="l17.300">     return {</span>
<a href="#l17.301"></a><span id="l17.301">       type: &quot;error&quot;,</span>
<a href="#l17.302"></a><span id="l17.302">       message: aObj.message,</span>
<a href="#l17.303"></a><span id="l17.303">       fileName: aObj.fileName,</span>
<a href="#l17.304"></a><span id="l17.304">       lineNumber: aObj.lineNumber,</span>
<a href="#l17.305"></a><span id="l17.305">       name: aObj.name,</span>
<a href="#l17.306"></a><span id="l17.306">       stack: aObj.stack ? aObj.stack.split(/\n\r?/g) : null,</span>
<a href="#l17.307"></a><span id="l17.307">       _stringRep: aObj.message,</span>
<a href="#l17.308"></a><span id="l17.308">     };</span>
<a href="#l17.309"></a><span id="l17.309" class="difflineminus">-  }</span>
<a href="#l17.310"></a><span id="l17.310" class="difflineminus">-  else if (aObj instanceof Ci.nsIException) {</span>
<a href="#l17.311"></a><span id="l17.311" class="difflineplus">+  } else if (aObj instanceof Ci.nsIException) {</span>
<a href="#l17.312"></a><span id="l17.312">     return {</span>
<a href="#l17.313"></a><span id="l17.313">       type: &quot;error&quot;,</span>
<a href="#l17.314"></a><span id="l17.314">       message: &quot;nsIException: &quot; + aObj.name,</span>
<a href="#l17.315"></a><span id="l17.315">       fileName: aObj.filename, // intentionally lower-case</span>
<a href="#l17.316"></a><span id="l17.316">       lineNumber: aObj.lineNumber,</span>
<a href="#l17.317"></a><span id="l17.317">       name: aObj.name,</span>
<a href="#l17.318"></a><span id="l17.318">       result: aObj.result,</span>
<a href="#l17.319"></a><span id="l17.319">       stack: null,</span>
<a href="#l17.320"></a><span id="l17.320">     };</span>
<a href="#l17.321"></a><span id="l17.321" class="difflineminus">-  }</span>
<a href="#l17.322"></a><span id="l17.322" class="difflineminus">-  else if (aObj instanceof Ci.nsIStackFrame) {</span>
<a href="#l17.323"></a><span id="l17.323" class="difflineplus">+  } else if (aObj instanceof Ci.nsIStackFrame) {</span>
<a href="#l17.324"></a><span id="l17.324">     return {</span>
<a href="#l17.325"></a><span id="l17.325">       type: &quot;stackFrame&quot;,</span>
<a href="#l17.326"></a><span id="l17.326">       name: aObj.name,</span>
<a href="#l17.327"></a><span id="l17.327">       fileName: aObj.filename, // intentionally lower-case</span>
<a href="#l17.328"></a><span id="l17.328">       lineNumber: aObj.lineNumber,</span>
<a href="#l17.329"></a><span id="l17.329">     };</span>
<a href="#l17.330"></a><span id="l17.330" class="difflineminus">-  }</span>
<a href="#l17.331"></a><span id="l17.331" class="difflineminus">-  else if (aObj instanceof Ci.nsIScriptError) {</span>
<a href="#l17.332"></a><span id="l17.332" class="difflineplus">+  } else if (aObj instanceof Ci.nsIScriptError) {</span>
<a href="#l17.333"></a><span id="l17.333">     return {</span>
<a href="#l17.334"></a><span id="l17.334">       type: &quot;stackFrame&quot;,</span>
<a href="#l17.335"></a><span id="l17.335">       name: aObj.errorMessage,</span>
<a href="#l17.336"></a><span id="l17.336">       category: aObj.category,</span>
<a href="#l17.337"></a><span id="l17.337">       fileName: aObj.sourceName,</span>
<a href="#l17.338"></a><span id="l17.338">       lineNumber: aObj.lineNumber,</span>
<a href="#l17.339"></a><span id="l17.339">     };</span>
<a href="#l17.340"></a><span id="l17.340">   }</span>
<a href="#l17.341"></a><span id="l17.341" class="difflineminus">-  else {</span>
<a href="#l17.342"></a><span id="l17.342" class="difflineminus">-    for (let [checkType, handler] of _registered_json_normalizers) {</span>
<a href="#l17.343"></a><span id="l17.343" class="difflineminus">-      if (aObj instanceof checkType)</span>
<a href="#l17.344"></a><span id="l17.344" class="difflineminus">-        return handler(aObj);</span>
<a href="#l17.345"></a><span id="l17.345" class="difflineminus">-    }</span>
<a href="#l17.346"></a><span id="l17.346" class="difflineplus">+</span>
<a href="#l17.347"></a><span id="l17.347" class="difflineplus">+  for (let [checkType, handler] of _registered_json_normalizers) {</span>
<a href="#l17.348"></a><span id="l17.348" class="difflineplus">+    if (aObj instanceof checkType)</span>
<a href="#l17.349"></a><span id="l17.349" class="difflineplus">+      return handler(aObj);</span>
<a href="#l17.350"></a><span id="l17.350" class="difflineplus">+  }</span>
<a href="#l17.351"></a><span id="l17.351"> </span>
<a href="#l17.352"></a><span id="l17.352" class="difflineminus">-    // Do not fall into simple object walking if this is an XPCOM interface.</span>
<a href="#l17.353"></a><span id="l17.353" class="difflineminus">-    //  We might run across getters and that leads to nothing good.</span>
<a href="#l17.354"></a><span id="l17.354" class="difflineminus">-    if (aObj instanceof Ci.nsISupports) {</span>
<a href="#l17.355"></a><span id="l17.355" class="difflineminus">-      return {</span>
<a href="#l17.356"></a><span id="l17.356" class="difflineminus">-        type: &quot;XPCOM&quot;,</span>
<a href="#l17.357"></a><span id="l17.357" class="difflineminus">-        name: aObj.toString(),</span>
<a href="#l17.358"></a><span id="l17.358" class="difflineminus">-      }</span>
<a href="#l17.359"></a><span id="l17.359" class="difflineminus">-    }</span>
<a href="#l17.360"></a><span id="l17.360" class="difflineplus">+  // Do not fall into simple object walking if this is an XPCOM interface.</span>
<a href="#l17.361"></a><span id="l17.361" class="difflineplus">+  // We might run across getters and that leads to nothing good.</span>
<a href="#l17.362"></a><span id="l17.362" class="difflineplus">+  if (aObj instanceof Ci.nsISupports) {</span>
<a href="#l17.363"></a><span id="l17.363" class="difflineplus">+    return {</span>
<a href="#l17.364"></a><span id="l17.364" class="difflineplus">+      type: &quot;XPCOM&quot;,</span>
<a href="#l17.365"></a><span id="l17.365" class="difflineplus">+      name: aObj.toString(),</span>
<a href="#l17.366"></a><span id="l17.366" class="difflineplus">+    };</span>
<a href="#l17.367"></a><span id="l17.367">   }</span>
<a href="#l17.368"></a><span id="l17.368"> </span>
<a href="#l17.369"></a><span id="l17.369">   let simple_obj = __simple_obj_copy(aObj, aDepthAllowed);</span>
<a href="#l17.370"></a><span id="l17.370">   if (!aJsonMeNotNeeded)</span>
<a href="#l17.371"></a><span id="l17.371">     simple_obj._jsonMe = true;</span>
<a href="#l17.372"></a><span id="l17.372">   return simple_obj;</span>
<a href="#l17.373"></a><span id="l17.373"> }</span>
<a href="#l17.374"></a><span id="l17.374"> </span>
<a href="#l17.375"></a><span id="l17.375" class="difflineat">@@ -536,35 +522,35 @@ function register_json_normalizer(aType,</span>
<a href="#l17.376"></a><span id="l17.376"> function _MarkAction(aWho, aWhat, aArgs) {</span>
<a href="#l17.377"></a><span id="l17.377">   this.type = &quot;action&quot;;</span>
<a href="#l17.378"></a><span id="l17.378">   this.who = aWho;</span>
<a href="#l17.379"></a><span id="l17.379">   this.what = aWhat;</span>
<a href="#l17.380"></a><span id="l17.380">   this.args = aArgs;</span>
<a href="#l17.381"></a><span id="l17.381"> }</span>
<a href="#l17.382"></a><span id="l17.382"> _MarkAction.prototype = {</span>
<a href="#l17.383"></a><span id="l17.383">   _jsonMe: true,</span>
<a href="#l17.384"></a><span id="l17.384" class="difflineminus">-  toString: function() {</span>
<a href="#l17.385"></a><span id="l17.385" class="difflineplus">+  toString() {</span>
<a href="#l17.386"></a><span id="l17.386">     let argStr;</span>
<a href="#l17.387"></a><span id="l17.387">     if (this.args) {</span>
<a href="#l17.388"></a><span id="l17.388">       argStr = &quot;:&quot;;</span>
<a href="#l17.389"></a><span id="l17.389">       for (let arg of this.args) {</span>
<a href="#l17.390"></a><span id="l17.390">         if (arg != null &amp;&amp; (typeof(arg) == &quot;object&quot;) &amp;&amp; (&quot;type&quot; in arg)) {</span>
<a href="#l17.391"></a><span id="l17.391">           if (&quot;name&quot; in arg)</span>
<a href="#l17.392"></a><span id="l17.392">             argStr += &quot; &quot; + arg.type + &quot;: &quot; + arg.name;</span>
<a href="#l17.393"></a><span id="l17.393">           else</span>
<a href="#l17.394"></a><span id="l17.394">             argStr += &quot; &quot; + arg.type;</span>
<a href="#l17.395"></a><span id="l17.395" class="difflineplus">+        } else {</span>
<a href="#l17.396"></a><span id="l17.396" class="difflineplus">+          argStr += &quot; &quot; + arg;</span>
<a href="#l17.397"></a><span id="l17.397">         }</span>
<a href="#l17.398"></a><span id="l17.398" class="difflineminus">-        else</span>
<a href="#l17.399"></a><span id="l17.399" class="difflineminus">-          argStr += &quot; &quot; + arg;</span>
<a href="#l17.400"></a><span id="l17.400">       }</span>
<a href="#l17.401"></a><span id="l17.401" class="difflineplus">+    } else {</span>
<a href="#l17.402"></a><span id="l17.402" class="difflineplus">+      argStr = &quot;&quot;;</span>
<a href="#l17.403"></a><span id="l17.403">     }</span>
<a href="#l17.404"></a><span id="l17.404" class="difflineminus">-    else</span>
<a href="#l17.405"></a><span id="l17.405" class="difflineminus">-      argStr = &quot;&quot;;</span>
<a href="#l17.406"></a><span id="l17.406">     return this.who + &quot; &quot; + this.what + argStr;</span>
<a href="#l17.407"></a><span id="l17.407" class="difflineminus">-  }</span>
<a href="#l17.408"></a><span id="l17.408" class="difflineplus">+  },</span>
<a href="#l17.409"></a><span id="l17.409"> };</span>
<a href="#l17.410"></a><span id="l17.410"> </span>
<a href="#l17.411"></a><span id="l17.411"> /**</span>
<a href="#l17.412"></a><span id="l17.412">  * Report performance of an action (by testing code).  You would use this rather</span>
<a href="#l17.413"></a><span id="l17.413">  *  than dump because we attempt to do interesting and useful logging things.</span>
<a href="#l17.414"></a><span id="l17.414">  *  In the future, this may mean prettier logs when buildbot runs a test and it</span>
<a href="#l17.415"></a><span id="l17.415">  *  fails, but right now it means great fun for people who use logsploder and</span>
<a href="#l17.416"></a><span id="l17.416">  *  just nicely formatted text for people looking at the console output.</span>
<a href="#l17.417"></a><span id="l17.417" class="difflineat">@@ -626,18 +612,17 @@ function _Failure(aText, aStack) {</span>
<a href="#l17.418"></a><span id="l17.418"> function mark_failure(aRichString) {</span>
<a href="#l17.419"></a><span id="l17.419">   let args = [_testLoggerActiveContext];</span>
<a href="#l17.420"></a><span id="l17.420">   let text = &quot;&quot;;</span>
<a href="#l17.421"></a><span id="l17.421">   for (let [i, richThing] of aRichString.entries()) {</span>
<a href="#l17.422"></a><span id="l17.422">     text += (i ? &quot; &quot; : &quot;&quot;);</span>
<a href="#l17.423"></a><span id="l17.423">     if (richThing == null || typeof(richThing) != &quot;object&quot;) {</span>
<a href="#l17.424"></a><span id="l17.424">       text += richThing;</span>
<a href="#l17.425"></a><span id="l17.425">       args.push(richThing);</span>
<a href="#l17.426"></a><span id="l17.426" class="difflineminus">-    }</span>
<a href="#l17.427"></a><span id="l17.427" class="difflineminus">-    else {</span>
<a href="#l17.428"></a><span id="l17.428" class="difflineplus">+    } else {</span>
<a href="#l17.429"></a><span id="l17.429">       let jsonThing = _normalize_for_json(richThing);</span>
<a href="#l17.430"></a><span id="l17.430">       if ((&quot;type&quot; in jsonThing) &amp;&amp; (&quot;name&quot; in jsonThing))</span>
<a href="#l17.431"></a><span id="l17.431">         text += &quot;[&quot; + jsonThing.type + &quot; &quot; + jsonThing.name + &quot;]&quot;;</span>
<a href="#l17.432"></a><span id="l17.432">       else</span>
<a href="#l17.433"></a><span id="l17.433">         text += &quot;[&quot; + jsonThing + &quot;]&quot;;</span>
<a href="#l17.434"></a><span id="l17.434"> </span>
<a href="#l17.435"></a><span id="l17.435">       // hook things up to be json serialized.</span>
<a href="#l17.436"></a><span id="l17.436">       if (!(&quot;_jsonMe&quot; in jsonThing))</span>
<a href="#l17.437"></a><span id="l17.437" class="difflineat">@@ -657,38 +642,12 @@ function _wrapped_do_throw(text, stack) </span>
<a href="#l17.438"></a><span id="l17.438">   // We need to use an info because otherwise explosion loggers can get angry</span>
<a href="#l17.439"></a><span id="l17.439">   //  and they may be indiscriminate about what they subscribe to.</span>
<a href="#l17.440"></a><span id="l17.440">   _xpcshellLogger.info(_testLoggerActiveContext,</span>
<a href="#l17.441"></a><span id="l17.441">                         new _Failure(text, stack));</span>
<a href="#l17.442"></a><span id="l17.442"> </span>
<a href="#l17.443"></a><span id="l17.443">   return _orig_do_throw(text, stack);</span>
<a href="#l17.444"></a><span id="l17.444"> }</span>
<a href="#l17.445"></a><span id="l17.445"> </span>
<a href="#l17.446"></a><span id="l17.446" class="difflineminus">-function _wrapped_do_check_neq(left, right, stack) {</span>
<a href="#l17.447"></a><span id="l17.447" class="difflineminus">-  if (!stack)</span>
<a href="#l17.448"></a><span id="l17.448" class="difflineminus">-    stack = Components.stack.caller;</span>
<a href="#l17.449"></a><span id="l17.449" class="difflineminus">-</span>
<a href="#l17.450"></a><span id="l17.450" class="difflineminus">-  _xpcshellLogger.info(_testLoggerActiveContext,</span>
<a href="#l17.451"></a><span id="l17.451" class="difflineminus">-                       new _CheckAction(left != right,</span>
<a href="#l17.452"></a><span id="l17.452" class="difflineminus">-                                        left, right, stack));</span>
<a href="#l17.453"></a><span id="l17.453" class="difflineminus">-</span>
<a href="#l17.454"></a><span id="l17.454" class="difflineminus">-  return _orig_do_check_neq(left, right, stack);</span>
<a href="#l17.455"></a><span id="l17.455" class="difflineminus">-}</span>
<a href="#l17.456"></a><span id="l17.456" class="difflineminus">-</span>
<a href="#l17.457"></a><span id="l17.457" class="difflineminus">-function _wrapped_do_check_eq(left, right, stack) {</span>
<a href="#l17.458"></a><span id="l17.458" class="difflineminus">-  if (!stack)</span>
<a href="#l17.459"></a><span id="l17.459" class="difflineminus">-    stack = Components.stack.caller;</span>
<a href="#l17.460"></a><span id="l17.460" class="difflineminus">-</span>
<a href="#l17.461"></a><span id="l17.461" class="difflineminus">-  _xpcshellLogger.info(_testLoggerActiveContext,</span>
<a href="#l17.462"></a><span id="l17.462" class="difflineminus">-                       new _CheckAction(left == right,</span>
<a href="#l17.463"></a><span id="l17.463" class="difflineminus">-                                        left, right, stack));</span>
<a href="#l17.464"></a><span id="l17.464" class="difflineminus">-</span>
<a href="#l17.465"></a><span id="l17.465" class="difflineminus">-  return _orig_do_check_eq(left, right, stack);</span>
<a href="#l17.466"></a><span id="l17.466" class="difflineminus">-}</span>
<a href="#l17.467"></a><span id="l17.467" class="difflineminus">-</span>
<a href="#l17.468"></a><span id="l17.468"> function _wrap_xpcshell_functions() {</span>
<a href="#l17.469"></a><span id="l17.469">   _orig_do_throw = do_throw;</span>
<a href="#l17.470"></a><span id="l17.470" class="difflineminus">-  do_throw = _wrapped_do_throw;</span>
<a href="#l17.471"></a><span id="l17.471" class="difflineminus">-  _orig_do_check_neq = do_check_neq;</span>
<a href="#l17.472"></a><span id="l17.472" class="difflineminus">-  do_check_neq = _wrapped_do_check_neq;</span>
<a href="#l17.473"></a><span id="l17.473" class="difflineminus">-  _orig_do_check_eq = do_check_eq;</span>
<a href="#l17.474"></a><span id="l17.474" class="difflineminus">-  do_check_eq = _wrapped_do_check_eq;</span>
<a href="#l17.475"></a><span id="l17.475" class="difflineplus">+  do_throw = _wrapped_do_throw; // eslint-disable-line no-global-assign</span>
<a href="#l17.476"></a><span id="l17.476"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/test/resources/mailShutdown.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/test/resources/mailShutdown.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,19 +1,23 @@</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8"> /* Provides methods to make sure our test shuts down mailnews properly. */</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+</span>
<a href="#l18.12"></a><span id="l18.12"> // Notifies everyone that the we're shutting down. This is needed to make sure</span>
<a href="#l18.13"></a><span id="l18.13"> // that e.g. the account manager closes and cleans up correctly. It is semi-fake</span>
<a href="#l18.14"></a><span id="l18.14"> // because we don't actually do any work to make sure the profile goes away, but</span>
<a href="#l18.15"></a><span id="l18.15"> // it will mimic the behaviour in the app sufficiently.</span>
<a href="#l18.16"></a><span id="l18.16"> //</span>
<a href="#l18.17"></a><span id="l18.17"> // See also http://developer.mozilla.org/en/Observer_Notifications</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-function postShutdownNotifications()</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-{</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+function postShutdownNotifications() {</span>
<a href="#l18.21"></a><span id="l18.21">   // first give everyone a heads up about us shutting down. if someone wants</span>
<a href="#l18.22"></a><span id="l18.22">   // to cancel this, our test should fail.</span>
<a href="#l18.23"></a><span id="l18.23">   var cancelQuit = Cc[&quot;@mozilla.org/supports-PRBool;1&quot;]</span>
<a href="#l18.24"></a><span id="l18.24">                      .createInstance(Ci.nsISupportsPRBool);</span>
<a href="#l18.25"></a><span id="l18.25">   Services.obs.notifyObservers(cancelQuit, &quot;quit-application-requested&quot;);</span>
<a href="#l18.26"></a><span id="l18.26">   if (cancelQuit.data) {</span>
<a href="#l18.27"></a><span id="l18.27">     do_throw(&quot;Cannot shutdown: Someone cancelled the quit request!&quot;);</span>
<a href="#l18.28"></a><span id="l18.28">   }</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineat">@@ -25,16 +29,16 @@ function postShutdownNotifications()</span>
<a href="#l18.30"></a><span id="l18.30">                        &quot;profile-before-change&quot;];</span>
<a href="#l18.31"></a><span id="l18.31">   notifications.forEach(function(notification) {</span>
<a href="#l18.32"></a><span id="l18.32">                           Services.obs.notifyObservers(null, notification);</span>
<a href="#l18.33"></a><span id="l18.33">                         });</span>
<a href="#l18.34"></a><span id="l18.34"> </span>
<a href="#l18.35"></a><span id="l18.35">   // finally, the xpcom-shutdown notification is handled by XPCOM itself.</span>
<a href="#l18.36"></a><span id="l18.36"> }</span>
<a href="#l18.37"></a><span id="l18.37"> </span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-if (typeof MockFactory != &quot;undefined&quot;)</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-  MockFactory.unregisterAll();</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+if (&quot;MockFactory&quot; in this)</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+  this.MockFactory.unregisterAll();</span>
<a href="#l18.42"></a><span id="l18.42"> </span>
<a href="#l18.43"></a><span id="l18.43"> // First do a gc to let anything not being referenced be cleaned up.</span>
<a href="#l18.44"></a><span id="l18.44"> gc();</span>
<a href="#l18.45"></a><span id="l18.45"> </span>
<a href="#l18.46"></a><span id="l18.46"> // Now shut everything down.</span>
<a href="#l18.47"></a><span id="l18.47"> postShutdownNotifications();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/test/resources/mailTestUtils.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/test/resources/mailTestUtils.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -1,101 +1,92 @@</span>
<a href="#l19.4"></a><span id="l19.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.5"></a><span id="l19.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.8"></a><span id="l19.8"> </span>
<a href="#l19.9"></a><span id="l19.9" class="difflineminus">-this.EXPORTED_SYMBOLS = ['mailTestUtils'];</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;mailTestUtils&quot;];</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12"> var {ctypes} = ChromeUtils.import(&quot;resource://gre/modules/ctypes.jsm&quot;);</span>
<a href="#l19.13"></a><span id="l19.13"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.14"></a><span id="l19.14"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l19.15"></a><span id="l19.15"> var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-var CC = Components.Constructor;</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-</span>
<a href="#l19.19"></a><span id="l19.19"> // See Bug 903946</span>
<a href="#l19.20"></a><span id="l19.20"> function avoidUncaughtExceptionInExternalProtocolService() {</span>
<a href="#l19.21"></a><span id="l19.21">   try {</span>
<a href="#l19.22"></a><span id="l19.22">     Services.prefs.setCharPref(&quot;helpers.private_mime_types_file&quot;,</span>
<a href="#l19.23"></a><span id="l19.23">       Services.prefs.getCharPref(&quot;helpers.global_mime_types_file&quot;));</span>
<a href="#l19.24"></a><span id="l19.24">   } catch (ex) {}</span>
<a href="#l19.25"></a><span id="l19.25">   try {</span>
<a href="#l19.26"></a><span id="l19.26">     Services.prefs.setCharPref(&quot;helpers.private_mailcap_file&quot;,</span>
<a href="#l19.27"></a><span id="l19.27">       Services.prefs.getCharPref(&quot;helpers.global_mailcap_file&quot;));</span>
<a href="#l19.28"></a><span id="l19.28">   } catch (ex) {}</span>
<a href="#l19.29"></a><span id="l19.29"> }</span>
<a href="#l19.30"></a><span id="l19.30"> avoidUncaughtExceptionInExternalProtocolService();</span>
<a href="#l19.31"></a><span id="l19.31"> </span>
<a href="#l19.32"></a><span id="l19.32"> var mailTestUtils = {</span>
<a href="#l19.33"></a><span id="l19.33">   // Loads a file to a string</span>
<a href="#l19.34"></a><span id="l19.34">   // If aCharset is specified, treats the file as being of that charset</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-  loadFileToString: function(aFile, aCharset) {</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+  loadFileToString(aFile, aCharset) {</span>
<a href="#l19.37"></a><span id="l19.37">     var data = &quot;&quot;;</span>
<a href="#l19.38"></a><span id="l19.38">     var fstream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l19.39"></a><span id="l19.39">                     .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l19.40"></a><span id="l19.40">     fstream.init(aFile, -1, 0, 0);</span>
<a href="#l19.41"></a><span id="l19.41"> </span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-    if (aCharset)</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-    {</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+    if (aCharset) {</span>
<a href="#l19.45"></a><span id="l19.45">       var cstream = Cc[&quot;@mozilla.org/intl/converter-input-stream;1&quot;]</span>
<a href="#l19.46"></a><span id="l19.46">                       .createInstance(Ci.nsIConverterInputStream);</span>
<a href="#l19.47"></a><span id="l19.47">       cstream.init(fstream, aCharset, 4096, 0x0000);</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-      var str = {};</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+      let str = {};</span>
<a href="#l19.50"></a><span id="l19.50">       while (cstream.readString(4096, str) != 0)</span>
<a href="#l19.51"></a><span id="l19.51">         data += str.value;</span>
<a href="#l19.52"></a><span id="l19.52"> </span>
<a href="#l19.53"></a><span id="l19.53">       cstream.close();</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineminus">-    }</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineminus">-    else</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineminus">-    {</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+    } else {</span>
<a href="#l19.58"></a><span id="l19.58">       var sstream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l19.59"></a><span id="l19.59">                       .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l19.60"></a><span id="l19.60"> </span>
<a href="#l19.61"></a><span id="l19.61">       sstream.init(fstream);</span>
<a href="#l19.62"></a><span id="l19.62"> </span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-      var str = sstream.read(4096);</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+      let str = sstream.read(4096);</span>
<a href="#l19.65"></a><span id="l19.65">       while (str.length &gt; 0) {</span>
<a href="#l19.66"></a><span id="l19.66">         data += str;</span>
<a href="#l19.67"></a><span id="l19.67">         str = sstream.read(4096);</span>
<a href="#l19.68"></a><span id="l19.68">       }</span>
<a href="#l19.69"></a><span id="l19.69"> </span>
<a href="#l19.70"></a><span id="l19.70">       sstream.close();</span>
<a href="#l19.71"></a><span id="l19.71">     }</span>
<a href="#l19.72"></a><span id="l19.72"> </span>
<a href="#l19.73"></a><span id="l19.73">     fstream.close();</span>
<a href="#l19.74"></a><span id="l19.74"> </span>
<a href="#l19.75"></a><span id="l19.75">     return data;</span>
<a href="#l19.76"></a><span id="l19.76">   },</span>
<a href="#l19.77"></a><span id="l19.77"> </span>
<a href="#l19.78"></a><span id="l19.78">   // Loads a message to a string</span>
<a href="#l19.79"></a><span id="l19.79">   // If aCharset is specified, treats the file as being of that charset</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineminus">-  loadMessageToString: function(aFolder, aMsgHdr, aCharset)</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineminus">-  {</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineplus">+  loadMessageToString(aFolder, aMsgHdr, aCharset) {</span>
<a href="#l19.83"></a><span id="l19.83">     var data = &quot;&quot;;</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineminus">-    let reusable = new Object;</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+    let reusable = {};</span>
<a href="#l19.86"></a><span id="l19.86">     let bytesLeft = aMsgHdr.messageSize;</span>
<a href="#l19.87"></a><span id="l19.87">     let stream = aFolder.getMsgInputStream(aMsgHdr, reusable);</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineminus">-    if (aCharset)</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineminus">-    {</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+    if (aCharset) {</span>
<a href="#l19.91"></a><span id="l19.91">       let cstream = Cc[&quot;@mozilla.org/intl/converter-input-stream;1&quot;]</span>
<a href="#l19.92"></a><span id="l19.92">                       .createInstance(Ci.nsIConverterInputStream);</span>
<a href="#l19.93"></a><span id="l19.93">       cstream.init(stream, aCharset, 4096, 0x0000);</span>
<a href="#l19.94"></a><span id="l19.94">       let str = {};</span>
<a href="#l19.95"></a><span id="l19.95">       let bytesToRead = Math.min(bytesLeft, 4096);</span>
<a href="#l19.96"></a><span id="l19.96">       while (cstream.readString(bytesToRead, str) != 0) {</span>
<a href="#l19.97"></a><span id="l19.97">         data += str.value;</span>
<a href="#l19.98"></a><span id="l19.98">         bytesLeft -= bytesToRead;</span>
<a href="#l19.99"></a><span id="l19.99">         if (bytesLeft &lt;= 0)</span>
<a href="#l19.100"></a><span id="l19.100">           break;</span>
<a href="#l19.101"></a><span id="l19.101">         bytesToRead = Math.min(bytesLeft, 4096);</span>
<a href="#l19.102"></a><span id="l19.102">       }</span>
<a href="#l19.103"></a><span id="l19.103">       cstream.close();</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineminus">-    }</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineminus">-    else</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineminus">-    {</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineplus">+    } else {</span>
<a href="#l19.108"></a><span id="l19.108">       var sstream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l19.109"></a><span id="l19.109">                       .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l19.110"></a><span id="l19.110"> </span>
<a href="#l19.111"></a><span id="l19.111">       sstream.init(stream);</span>
<a href="#l19.112"></a><span id="l19.112"> </span>
<a href="#l19.113"></a><span id="l19.113">       let bytesToRead = Math.min(bytesLeft, 4096);</span>
<a href="#l19.114"></a><span id="l19.114">       var str = sstream.read(bytesToRead);</span>
<a href="#l19.115"></a><span id="l19.115">       bytesLeft -= bytesToRead;</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineat">@@ -109,28 +100,26 @@ var mailTestUtils = {</span>
<a href="#l19.117"></a><span id="l19.117">       }</span>
<a href="#l19.118"></a><span id="l19.118">       sstream.close();</span>
<a href="#l19.119"></a><span id="l19.119">     }</span>
<a href="#l19.120"></a><span id="l19.120">     stream.close();</span>
<a href="#l19.121"></a><span id="l19.121"> </span>
<a href="#l19.122"></a><span id="l19.122">     return data;</span>
<a href="#l19.123"></a><span id="l19.123">   },</span>
<a href="#l19.124"></a><span id="l19.124"> </span>
<a href="#l19.125"></a><span id="l19.125" class="difflineminus">-  /// Gets the first message header in a folder.</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineminus">-  firstMsgHdr: function(folder)</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineminus">-  {</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineplus">+  // Gets the first message header in a folder.</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineplus">+  firstMsgHdr(folder) {</span>
<a href="#l19.130"></a><span id="l19.130">     let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l19.131"></a><span id="l19.131">     if (enumerator.hasMoreElements())</span>
<a href="#l19.132"></a><span id="l19.132">       return enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l19.133"></a><span id="l19.133">     return null;</span>
<a href="#l19.134"></a><span id="l19.134">   },</span>
<a href="#l19.135"></a><span id="l19.135"> </span>
<a href="#l19.136"></a><span id="l19.136" class="difflineminus">-  /// Gets message header number N (0 based index) in a folder.</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineminus">-  getMsgHdrN: function(folder, n)</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineminus">-  {</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineplus">+  // Gets message header number N (0 based index) in a folder.</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineplus">+  getMsgHdrN(folder, n) {</span>
<a href="#l19.141"></a><span id="l19.141">     let i = 0;</span>
<a href="#l19.142"></a><span id="l19.142">     let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l19.143"></a><span id="l19.143">     while (enumerator.hasMoreElements()) {</span>
<a href="#l19.144"></a><span id="l19.144">       let next = enumerator.getNext();</span>
<a href="#l19.145"></a><span id="l19.145">       if (i == n)</span>
<a href="#l19.146"></a><span id="l19.146">         return next.QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l19.147"></a><span id="l19.147">       i++;</span>
<a href="#l19.148"></a><span id="l19.148">     }</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineat">@@ -139,17 +128,17 @@ var mailTestUtils = {</span>
<a href="#l19.150"></a><span id="l19.150"> </span>
<a href="#l19.151"></a><span id="l19.151">   /**</span>
<a href="#l19.152"></a><span id="l19.152">    * Returns the file system a particular file is on.</span>
<a href="#l19.153"></a><span id="l19.153">    * Currently supported on Windows only.</span>
<a href="#l19.154"></a><span id="l19.154">    *</span>
<a href="#l19.155"></a><span id="l19.155">    * @param aFile The file to get the file system for.</span>
<a href="#l19.156"></a><span id="l19.156">    * @return The file system a particular file is on, or 'null' if not on Windows.</span>
<a href="#l19.157"></a><span id="l19.157">    */</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineminus">-  get_file_system: function(aFile) {</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineplus">+  get_file_system(aFile) {</span>
<a href="#l19.160"></a><span id="l19.160">     if (!(&quot;@mozilla.org/windows-registry-key;1&quot; in Cc)) {</span>
<a href="#l19.161"></a><span id="l19.161">       dump(&quot;get_file_system() is supported on Windows only.\n&quot;);</span>
<a href="#l19.162"></a><span id="l19.162">       return null;</span>
<a href="#l19.163"></a><span id="l19.163">     }</span>
<a href="#l19.164"></a><span id="l19.164"> </span>
<a href="#l19.165"></a><span id="l19.165">     // Win32 type and other constants.</span>
<a href="#l19.166"></a><span id="l19.166">     const BOOL = ctypes.int32_t;</span>
<a href="#l19.167"></a><span id="l19.167">     const MAX_PATH = 260;</span>
<a href="#l19.168"></a><span id="l19.168" class="difflineat">@@ -200,18 +189,17 @@ var mailTestUtils = {</span>
<a href="#l19.169"></a><span id="l19.169"> </span>
<a href="#l19.170"></a><span id="l19.170">       if (!GetVolumeInformation(volumePath, null, 0, null, null, null, fsName,</span>
<a href="#l19.171"></a><span id="l19.171">                                 fsName.length)) {</span>
<a href="#l19.172"></a><span id="l19.172">         throw new Error(&quot;Unable to get volume information for &quot; +</span>
<a href="#l19.173"></a><span id="l19.173">                         volumePath.readString() + &quot;, error &quot; + ctypes.winLastError);</span>
<a href="#l19.174"></a><span id="l19.174">       }</span>
<a href="#l19.175"></a><span id="l19.175"> </span>
<a href="#l19.176"></a><span id="l19.176">       return fsName.readString();</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineminus">-    }</span>
<a href="#l19.178"></a><span id="l19.178" class="difflineminus">-    finally {</span>
<a href="#l19.179"></a><span id="l19.179" class="difflineplus">+    } finally {</span>
<a href="#l19.180"></a><span id="l19.180">       kernel32.close();</span>
<a href="#l19.181"></a><span id="l19.181">     }</span>
<a href="#l19.182"></a><span id="l19.182">   },</span>
<a href="#l19.183"></a><span id="l19.183"> </span>
<a href="#l19.184"></a><span id="l19.184">   /**</span>
<a href="#l19.185"></a><span id="l19.185">    * Try marking a region of a file as sparse, so that zeros don't consume</span>
<a href="#l19.186"></a><span id="l19.186">    * significant amounts of disk space.  This is a platform-dependent routine and</span>
<a href="#l19.187"></a><span id="l19.187">    * is not supported on all platforms. The current status of this function is:</span>
<a href="#l19.188"></a><span id="l19.188" class="difflineat">@@ -225,17 +213,17 @@ var mailTestUtils = {</span>
<a href="#l19.189"></a><span id="l19.189">    * @param aRegionBytes The number of bytes to mark as sparse.</span>
<a href="#l19.190"></a><span id="l19.190">    * @return Whether the OS and file system supports marking files as sparse. If</span>
<a href="#l19.191"></a><span id="l19.191">    *          this is true, then the file has been marked as sparse. If this is</span>
<a href="#l19.192"></a><span id="l19.192">    *          false, then the underlying system doesn't support marking files as</span>
<a href="#l19.193"></a><span id="l19.193">    *          sparse. If an exception is thrown, then the system does support</span>
<a href="#l19.194"></a><span id="l19.194">    *          marking files as sparse, but an error occurred while doing so.</span>
<a href="#l19.195"></a><span id="l19.195">    *</span>
<a href="#l19.196"></a><span id="l19.196">    */</span>
<a href="#l19.197"></a><span id="l19.197" class="difflineminus">-  mark_file_region_sparse: function(aFile, aRegionStart, aRegionBytes) {</span>
<a href="#l19.198"></a><span id="l19.198" class="difflineplus">+  mark_file_region_sparse(aFile, aRegionStart, aRegionBytes) {</span>
<a href="#l19.199"></a><span id="l19.199">     let fileSystem = this.get_file_system(aFile);</span>
<a href="#l19.200"></a><span id="l19.200">     dump(&quot;[mark_file_region_sparse()] File system = &quot; + (fileSystem || &quot;(unknown)&quot;) +</span>
<a href="#l19.201"></a><span id="l19.201">            &quot;, file region = at &quot; + this.toMiBString(aRegionStart) +</span>
<a href="#l19.202"></a><span id="l19.202">            &quot; for &quot; + this.toMiBString(aRegionBytes) + &quot;\n&quot;);</span>
<a href="#l19.203"></a><span id="l19.203"> </span>
<a href="#l19.204"></a><span id="l19.204">     if (&quot;@mozilla.org/windows-registry-key;1&quot; in Cc) {</span>
<a href="#l19.205"></a><span id="l19.205">       // On Windows, check whether the drive is NTFS. If it is, proceed.</span>
<a href="#l19.206"></a><span id="l19.206">       // If it isn't, then bail out now, because in all probability it is</span>
<a href="#l19.207"></a><span id="l19.207" class="difflineat">@@ -359,72 +347,67 @@ var mailTestUtils = {</span>
<a href="#l19.208"></a><span id="l19.208">             ctypes.winapi_abi,</span>
<a href="#l19.209"></a><span id="l19.209">             BOOL,  // return type: 1 indicates success, 0 failure</span>
<a href="#l19.210"></a><span id="l19.210">             HANDLE // in: hFile</span>
<a href="#l19.211"></a><span id="l19.211">           );</span>
<a href="#l19.212"></a><span id="l19.212">           if (!SetEndOfFile(hFile))</span>
<a href="#l19.213"></a><span id="l19.213">             throw new Error(&quot;Unable to set end of file, error &quot; + ctypes.winLastError);</span>
<a href="#l19.214"></a><span id="l19.214"> </span>
<a href="#l19.215"></a><span id="l19.215">           return true;</span>
<a href="#l19.216"></a><span id="l19.216" class="difflineminus">-        }</span>
<a href="#l19.217"></a><span id="l19.217" class="difflineminus">-        finally {</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineplus">+        } finally {</span>
<a href="#l19.219"></a><span id="l19.219">           let CloseHandle = kernel32.declare(</span>
<a href="#l19.220"></a><span id="l19.220">             &quot;CloseHandle&quot;,</span>
<a href="#l19.221"></a><span id="l19.221">             ctypes.winapi_abi,</span>
<a href="#l19.222"></a><span id="l19.222">             BOOL,  // return type: 1 indicates success, 0 failure</span>
<a href="#l19.223"></a><span id="l19.223">             HANDLE // in: hObject</span>
<a href="#l19.224"></a><span id="l19.224">           );</span>
<a href="#l19.225"></a><span id="l19.225">           CloseHandle(hFile);</span>
<a href="#l19.226"></a><span id="l19.226">         }</span>
<a href="#l19.227"></a><span id="l19.227" class="difflineminus">-      }</span>
<a href="#l19.228"></a><span id="l19.228" class="difflineminus">-      finally {</span>
<a href="#l19.229"></a><span id="l19.229" class="difflineplus">+      } finally {</span>
<a href="#l19.230"></a><span id="l19.230">         kernel32.close();</span>
<a href="#l19.231"></a><span id="l19.231">       }</span>
<a href="#l19.232"></a><span id="l19.232" class="difflineminus">-    }</span>
<a href="#l19.233"></a><span id="l19.233" class="difflineminus">-    else if (&quot;nsILocalFileMac&quot; in Ci) {</span>
<a href="#l19.234"></a><span id="l19.234" class="difflineplus">+    } else if (&quot;nsILocalFileMac&quot; in Ci) {</span>
<a href="#l19.235"></a><span id="l19.235">       // Macs don't support marking files as sparse.</span>
<a href="#l19.236"></a><span id="l19.236">       return false;</span>
<a href="#l19.237"></a><span id="l19.237" class="difflineminus">-    }</span>
<a href="#l19.238"></a><span id="l19.238" class="difflineminus">-    else {</span>
<a href="#l19.239"></a><span id="l19.239" class="difflineplus">+    } else {</span>
<a href="#l19.240"></a><span id="l19.240">       // Assuming Unix here. Unix file systems generally automatically sparsify</span>
<a href="#l19.241"></a><span id="l19.241">       // files.</span>
<a href="#l19.242"></a><span id="l19.242">       return true;</span>
<a href="#l19.243"></a><span id="l19.243">     }</span>
<a href="#l19.244"></a><span id="l19.244">   },</span>
<a href="#l19.245"></a><span id="l19.245"> </span>
<a href="#l19.246"></a><span id="l19.246">   /**</span>
<a href="#l19.247"></a><span id="l19.247">    * Converts a size in bytes into its mebibytes string representation.</span>
<a href="#l19.248"></a><span id="l19.248">    * NB: 1 MiB = 1024 * 1024 = 1048576 B.</span>
<a href="#l19.249"></a><span id="l19.249">    *</span>
<a href="#l19.250"></a><span id="l19.250">    * @param aSize The size in bytes.</span>
<a href="#l19.251"></a><span id="l19.251">    * @return A string representing the size in medibytes.</span>
<a href="#l19.252"></a><span id="l19.252">    */</span>
<a href="#l19.253"></a><span id="l19.253" class="difflineminus">-  toMiBString: function(aSize) {</span>
<a href="#l19.254"></a><span id="l19.254" class="difflineplus">+  toMiBString(aSize) {</span>
<a href="#l19.255"></a><span id="l19.255">     return (aSize / 1048576) + &quot; MiB&quot;;</span>
<a href="#l19.256"></a><span id="l19.256">   },</span>
<a href="#l19.257"></a><span id="l19.257"> </span>
<a href="#l19.258"></a><span id="l19.258">   /**</span>
<a href="#l19.259"></a><span id="l19.259">    * A variant of do_timeout that accepts an actual function instead of</span>
<a href="#l19.260"></a><span id="l19.260">    *  requiring you to pass a string to evaluate.  If the function throws an</span>
<a href="#l19.261"></a><span id="l19.261">    *  exception when invoked, we will use do_throw to ensure that the test fails.</span>
<a href="#l19.262"></a><span id="l19.262">    *</span>
<a href="#l19.263"></a><span id="l19.263">    * @param aDelayInMS The number of milliseconds to wait before firing the timer.</span>
<a href="#l19.264"></a><span id="l19.264">    * @param aFunc The function to invoke when the timer fires.</span>
<a href="#l19.265"></a><span id="l19.265">    * @param aFuncThis Optional 'this' pointer to use.</span>
<a href="#l19.266"></a><span id="l19.266">    * @param aFuncArgs Optional list of arguments to pass to the function.</span>
<a href="#l19.267"></a><span id="l19.267">    */</span>
<a href="#l19.268"></a><span id="l19.268">   _timer: null,</span>
<a href="#l19.269"></a><span id="l19.269" class="difflineminus">-  do_timeout_function: function(aDelayInMS, aFunc, aFuncThis, aFuncArgs) {</span>
<a href="#l19.270"></a><span id="l19.270" class="difflineplus">+  do_timeout_function(aDelayInMS, aFunc, aFuncThis, aFuncArgs) {</span>
<a href="#l19.271"></a><span id="l19.271">     this._timer = Cc[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l19.272"></a><span id="l19.272">                     .createInstance(Ci.nsITimer);</span>
<a href="#l19.273"></a><span id="l19.273">     let wrappedFunc = function() {</span>
<a href="#l19.274"></a><span id="l19.274">       try {</span>
<a href="#l19.275"></a><span id="l19.275">         aFunc.apply(aFuncThis, aFuncArgs);</span>
<a href="#l19.276"></a><span id="l19.276" class="difflineminus">-      }</span>
<a href="#l19.277"></a><span id="l19.277" class="difflineminus">-      catch (ex) {</span>
<a href="#l19.278"></a><span id="l19.278" class="difflineplus">+      } catch (ex) {</span>
<a href="#l19.279"></a><span id="l19.279">         // we want to make sure that if the thing we call throws an exception,</span>
<a href="#l19.280"></a><span id="l19.280">         //  that this terminates the test.</span>
<a href="#l19.281"></a><span id="l19.281">         do_throw(ex);</span>
<a href="#l19.282"></a><span id="l19.282">       }</span>
<a href="#l19.283"></a><span id="l19.283">     };</span>
<a href="#l19.284"></a><span id="l19.284">     this._timer.initWithCallback(wrappedFunc, aDelayInMS,</span>
<a href="#l19.285"></a><span id="l19.285">       Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l19.286"></a><span id="l19.286">   },</span>
<a href="#l19.287"></a><span id="l19.287" class="difflineat">@@ -442,38 +425,38 @@ var mailTestUtils = {</span>
<a href="#l19.288"></a><span id="l19.288">    *     if your callback does not rely on 'this'.</span>
<a href="#l19.289"></a><span id="l19.289">    * @param aCallbackArgs A list of arguments to pass to the callback via apply.</span>
<a href="#l19.290"></a><span id="l19.290">    *     If you provide [1,2,3], we will effectively call:</span>
<a href="#l19.291"></a><span id="l19.291">    *     aCallbackThis.aCallback(1,2,3);</span>
<a href="#l19.292"></a><span id="l19.292">    * @param [aSomeoneElseWillTriggerTheUpdate=false] If this is true, we do not</span>
<a href="#l19.293"></a><span id="l19.293">    *     trigger the updateFolder call and it is assumed someone else is taking</span>
<a href="#l19.294"></a><span id="l19.294">    *     care of that.</span>
<a href="#l19.295"></a><span id="l19.295">    */</span>
<a href="#l19.296"></a><span id="l19.296" class="difflineminus">-  updateFolderAndNotify: function(aFolder, aCallback, aCallbackThis,</span>
<a href="#l19.297"></a><span id="l19.297" class="difflineminus">-      aCallbackArgs, aSomeoneElseWillTriggerTheUpdate) {</span>
<a href="#l19.298"></a><span id="l19.298" class="difflineplus">+  updateFolderAndNotify(aFolder, aCallback, aCallbackThis,</span>
<a href="#l19.299"></a><span id="l19.299" class="difflineplus">+                        aCallbackArgs, aSomeoneElseWillTriggerTheUpdate) {</span>
<a href="#l19.300"></a><span id="l19.300">     // register for the folder loaded notification ahead of time... even though</span>
<a href="#l19.301"></a><span id="l19.301">     //  we may not need it...</span>
<a href="#l19.302"></a><span id="l19.302">     let folderListener = {</span>
<a href="#l19.303"></a><span id="l19.303" class="difflineminus">-      OnItemEvent: function (aEventFolder, aEvent) {</span>
<a href="#l19.304"></a><span id="l19.304" class="difflineplus">+      OnItemEvent(aEventFolder, aEvent) {</span>
<a href="#l19.305"></a><span id="l19.305">         if (aEvent == &quot;FolderLoaded&quot; &amp;&amp; aFolder.URI == aEventFolder.URI) {</span>
<a href="#l19.306"></a><span id="l19.306">           MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l19.307"></a><span id="l19.307">           aCallback.apply(aCallbackThis, aCallbackArgs);</span>
<a href="#l19.308"></a><span id="l19.308">         }</span>
<a href="#l19.309"></a><span id="l19.309" class="difflineminus">-      }</span>
<a href="#l19.310"></a><span id="l19.310" class="difflineplus">+      },</span>
<a href="#l19.311"></a><span id="l19.311">     };</span>
<a href="#l19.312"></a><span id="l19.312"> </span>
<a href="#l19.313"></a><span id="l19.313">     MailServices.mailSession.AddFolderListener(folderListener, Ci.nsIFolderListener.event);</span>
<a href="#l19.314"></a><span id="l19.314"> </span>
<a href="#l19.315"></a><span id="l19.315">     if (!aSomeoneElseWillTriggerTheUpdate)</span>
<a href="#l19.316"></a><span id="l19.316">       aFolder.updateFolder(null);</span>
<a href="#l19.317"></a><span id="l19.317">   },</span>
<a href="#l19.318"></a><span id="l19.318"> </span>
<a href="#l19.319"></a><span id="l19.319">   /**</span>
<a href="#l19.320"></a><span id="l19.320">    * For when you want to compare elements non-strictly.</span>
<a href="#l19.321"></a><span id="l19.321">    */</span>
<a href="#l19.322"></a><span id="l19.322" class="difflineminus">-  non_strict_index_of: function(aArray, aElem) {</span>
<a href="#l19.323"></a><span id="l19.323" class="difflineplus">+  non_strict_index_of(aArray, aElem) {</span>
<a href="#l19.324"></a><span id="l19.324">     for (let [i, elem] of aArray.entries()) {</span>
<a href="#l19.325"></a><span id="l19.325">       if (elem == aElem)</span>
<a href="#l19.326"></a><span id="l19.326">         return i;</span>
<a href="#l19.327"></a><span id="l19.327">     }</span>
<a href="#l19.328"></a><span id="l19.328">     return -1;</span>
<a href="#l19.329"></a><span id="l19.329" class="difflineminus">-  }</span>
<a href="#l19.330"></a><span id="l19.330" class="difflineplus">+  },</span>
<a href="#l19.331"></a><span id="l19.331"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/test/resources/messageGenerator.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/test/resources/messageGenerator.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,38 +1,38 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.5"></a><span id="l20.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9" class="difflineminus">-this.EXPORTED_SYMBOLS = ['MessageGenerator'];</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;MessageGenerator&quot;];</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12"> /**</span>
<a href="#l20.13"></a><span id="l20.13">  * A list of first names for use by MessageGenerator to create deterministic,</span>
<a href="#l20.14"></a><span id="l20.14">  *  reversible names.  To keep things easily reversible, if you add names, make</span>
<a href="#l20.15"></a><span id="l20.15">  *  sure they have no spaces in them!</span>
<a href="#l20.16"></a><span id="l20.16">  */</span>
<a href="#l20.17"></a><span id="l20.17"> var FIRST_NAMES = [</span>
<a href="#l20.18"></a><span id="l20.18">   &quot;Andy&quot;, &quot;Bob&quot;, &quot;Chris&quot;, &quot;David&quot;, &quot;Emily&quot;, &quot;Felix&quot;,</span>
<a href="#l20.19"></a><span id="l20.19">   &quot;Gillian&quot;, &quot;Helen&quot;, &quot;Idina&quot;, &quot;Johnny&quot;, &quot;Kate&quot;, &quot;Lilia&quot;,</span>
<a href="#l20.20"></a><span id="l20.20">   &quot;Martin&quot;, &quot;Neil&quot;, &quot;Olof&quot;, &quot;Pete&quot;, &quot;Quinn&quot;, &quot;Rasmus&quot;,</span>
<a href="#l20.21"></a><span id="l20.21">   &quot;Sarah&quot;, &quot;Troels&quot;, &quot;Ulf&quot;, &quot;Vince&quot;, &quot;Will&quot;, &quot;Xavier&quot;,</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-  &quot;Yoko&quot;, &quot;Zig&quot;</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+  &quot;Yoko&quot;, &quot;Zig&quot;,</span>
<a href="#l20.24"></a><span id="l20.24">   ];</span>
<a href="#l20.25"></a><span id="l20.25"> </span>
<a href="#l20.26"></a><span id="l20.26"> /**</span>
<a href="#l20.27"></a><span id="l20.27">  * A list of last names for use by MessageGenerator to create deterministic,</span>
<a href="#l20.28"></a><span id="l20.28">  *  reversible names.  To keep things easily reversible, if you add names, make</span>
<a href="#l20.29"></a><span id="l20.29">  *  sure they have no spaces in them!</span>
<a href="#l20.30"></a><span id="l20.30">  */</span>
<a href="#l20.31"></a><span id="l20.31"> var LAST_NAMES = [</span>
<a href="#l20.32"></a><span id="l20.32">   &quot;Anway&quot;, &quot;Bell&quot;, &quot;Clarke&quot;, &quot;Davol&quot;, &quot;Ekberg&quot;, &quot;Flowers&quot;,</span>
<a href="#l20.33"></a><span id="l20.33">   &quot;Gilbert&quot;, &quot;Hook&quot;, &quot;Ivarsson&quot;, &quot;Jones&quot;, &quot;Kurtz&quot;, &quot;Lowe&quot;,</span>
<a href="#l20.34"></a><span id="l20.34">   &quot;Morris&quot;, &quot;Nagel&quot;, &quot;Orzabal&quot;, &quot;Price&quot;, &quot;Quinn&quot;, &quot;Rolinski&quot;,</span>
<a href="#l20.35"></a><span id="l20.35">   &quot;Stanley&quot;, &quot;Tennant&quot;, &quot;Ulvaeus&quot;, &quot;Vannucci&quot;, &quot;Wiggs&quot;, &quot;Xavier&quot;,</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-  &quot;Young&quot;, &quot;Zig&quot;</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+  &quot;Young&quot;, &quot;Zig&quot;,</span>
<a href="#l20.38"></a><span id="l20.38">   ];</span>
<a href="#l20.39"></a><span id="l20.39"> </span>
<a href="#l20.40"></a><span id="l20.40"> /**</span>
<a href="#l20.41"></a><span id="l20.41">  * A list of adjectives used to construct a deterministic, reversible subject</span>
<a href="#l20.42"></a><span id="l20.42">  *  by MessageGenerator.  To keep things easily reversible, if you add more,</span>
<a href="#l20.43"></a><span id="l20.43">  *  make sure they have no spaces in them!  Also, make sure your additions</span>
<a href="#l20.44"></a><span id="l20.44">  *  don't break the secret Monty Python reference!</span>
<a href="#l20.45"></a><span id="l20.45">  */</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineat">@@ -94,51 +94,51 @@ function SyntheticPart(aProperties) {</span>
<a href="#l20.47"></a><span id="l20.47"> }</span>
<a href="#l20.48"></a><span id="l20.48"> SyntheticPart.prototype = {</span>
<a href="#l20.49"></a><span id="l20.49">   _forceDisposition: null,</span>
<a href="#l20.50"></a><span id="l20.50">   _encoding: null,</span>
<a href="#l20.51"></a><span id="l20.51"> </span>
<a href="#l20.52"></a><span id="l20.52">   get contentTypeHeaderValue() {</span>
<a href="#l20.53"></a><span id="l20.53">     let s = this._contentType;</span>
<a href="#l20.54"></a><span id="l20.54">     if (this._charset)</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-      s += '; charset=' + this._charset;</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+      s += &quot;; charset=&quot; + this._charset;</span>
<a href="#l20.57"></a><span id="l20.57">     if (this._format)</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-      s += '; format=' + this._format;</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+      s += &quot;; format=&quot; + this._format;</span>
<a href="#l20.60"></a><span id="l20.60">     if (this._filename)</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineminus">-      s += ';\r\n name=&quot;' + this._filename +'&quot;';</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+      s += ';\r\n name=&quot;' + this._filename + '&quot;';</span>
<a href="#l20.63"></a><span id="l20.63">     if (this._contentTypeExtra) {</span>
<a href="#l20.64"></a><span id="l20.64">       for (let [key, value] of Object.entries(this._contentTypeExtra))</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineminus">-        s += ';\r\n ' + key + '=&quot;' + value + '&quot;';</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+        s += &quot;;\r\n &quot; + key + '=&quot;' + value + '&quot;';</span>
<a href="#l20.67"></a><span id="l20.67">     }</span>
<a href="#l20.68"></a><span id="l20.68">     if (this._boundary)</span>
<a href="#l20.69"></a><span id="l20.69">       s += ';\r\n boundary=&quot;' + this._boundary + '&quot;';</span>
<a href="#l20.70"></a><span id="l20.70">     return s;</span>
<a href="#l20.71"></a><span id="l20.71">   },</span>
<a href="#l20.72"></a><span id="l20.72">   get hasTransferEncoding() {</span>
<a href="#l20.73"></a><span id="l20.73">     return this._encoding;</span>
<a href="#l20.74"></a><span id="l20.74">   },</span>
<a href="#l20.75"></a><span id="l20.75">   get contentTransferEncodingHeaderValue() {</span>
<a href="#l20.76"></a><span id="l20.76">     return this._encoding;</span>
<a href="#l20.77"></a><span id="l20.77">   },</span>
<a href="#l20.78"></a><span id="l20.78">   get hasDisposition() {</span>
<a href="#l20.79"></a><span id="l20.79">     return this._forceDisposition || this._filename || false;</span>
<a href="#l20.80"></a><span id="l20.80">   },</span>
<a href="#l20.81"></a><span id="l20.81">   get contentDispositionHeaderValue() {</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineminus">-    let s = '';</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+    let s = &quot;&quot;;</span>
<a href="#l20.84"></a><span id="l20.84">     if (this._forceDisposition)</span>
<a href="#l20.85"></a><span id="l20.85">       s += this._forceDisposition;</span>
<a href="#l20.86"></a><span id="l20.86">     else if (this._filename)</span>
<a href="#l20.87"></a><span id="l20.87">       s += 'attachment;\r\n filename=&quot;' + this._filename + '&quot;';</span>
<a href="#l20.88"></a><span id="l20.88">     return s;</span>
<a href="#l20.89"></a><span id="l20.89">   },</span>
<a href="#l20.90"></a><span id="l20.90">   get hasContentId() {</span>
<a href="#l20.91"></a><span id="l20.91">     return this._contentId || false;</span>
<a href="#l20.92"></a><span id="l20.92">   },</span>
<a href="#l20.93"></a><span id="l20.93">   get contentIdHeaderValue() {</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineminus">-    return '&lt;' + this._contentId + '&gt;';</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineplus">+    return &quot;&lt;&quot; + this._contentId + &quot;&gt;&quot;;</span>
<a href="#l20.96"></a><span id="l20.96">   },</span>
<a href="#l20.97"></a><span id="l20.97">   get hasExtraHeaders() {</span>
<a href="#l20.98"></a><span id="l20.98">     return this._extraHeaders || false;</span>
<a href="#l20.99"></a><span id="l20.99">   },</span>
<a href="#l20.100"></a><span id="l20.100">   get extraHeaders() {</span>
<a href="#l20.101"></a><span id="l20.101">     return this._extraHeaders || false;</span>
<a href="#l20.102"></a><span id="l20.102">   },</span>
<a href="#l20.103"></a><span id="l20.103"> };</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineat">@@ -147,181 +147,181 @@ SyntheticPart.prototype = {</span>
<a href="#l20.105"></a><span id="l20.105">  * Leaf MIME part, defaulting to text/plain.</span>
<a href="#l20.106"></a><span id="l20.106">  */</span>
<a href="#l20.107"></a><span id="l20.107"> function SyntheticPartLeaf(aBody, aProperties) {</span>
<a href="#l20.108"></a><span id="l20.108">   SyntheticPart.call(this, aProperties);</span>
<a href="#l20.109"></a><span id="l20.109">   this.body = aBody;</span>
<a href="#l20.110"></a><span id="l20.110"> }</span>
<a href="#l20.111"></a><span id="l20.111"> SyntheticPartLeaf.prototype = {</span>
<a href="#l20.112"></a><span id="l20.112">   __proto__: SyntheticPart.prototype,</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineminus">-  _contentType: 'text/plain',</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineminus">-  _charset: 'ISO-8859-1',</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineminus">-  _format: 'flowed',</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineminus">-  _encoding: '7bit',</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineminus">-  toMessageString: function() {</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineplus">+  _contentType: &quot;text/plain&quot;,</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineplus">+  _charset: &quot;ISO-8859-1&quot;,</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineplus">+  _format: &quot;flowed&quot;,</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineplus">+  _encoding: &quot;7bit&quot;,</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineplus">+  toMessageString() {</span>
<a href="#l20.123"></a><span id="l20.123">     return this.body;</span>
<a href="#l20.124"></a><span id="l20.124">   },</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineminus">-  prettyString: function MimeMessage_prettyString(aIndent) {</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineplus">+  prettyString(aIndent) {</span>
<a href="#l20.127"></a><span id="l20.127">     return &quot;Leaf: &quot; + this._contentType;</span>
<a href="#l20.128"></a><span id="l20.128">   },</span>
<a href="#l20.129"></a><span id="l20.129"> };</span>
<a href="#l20.130"></a><span id="l20.130"> </span>
<a href="#l20.131"></a><span id="l20.131"> /**</span>
<a href="#l20.132"></a><span id="l20.132">  * A part that tells us to produce NO output in a multipart section.  So if our</span>
<a href="#l20.133"></a><span id="l20.133">  *  separator is &quot;--BOB&quot;, we might produce &quot;--BOB\n--BOB--\n&quot; instead of having</span>
<a href="#l20.134"></a><span id="l20.134">  *  some headers and actual content in there.</span>
<a href="#l20.135"></a><span id="l20.135">  * This is not a good idea and probably not legal either, but it happens and</span>
<a href="#l20.136"></a><span id="l20.136">  *  we need to test for it.</span>
<a href="#l20.137"></a><span id="l20.137">  */</span>
<a href="#l20.138"></a><span id="l20.138"> function SyntheticDegeneratePartEmpty() {</span>
<a href="#l20.139"></a><span id="l20.139"> }</span>
<a href="#l20.140"></a><span id="l20.140"> SyntheticDegeneratePartEmpty.prototype = {</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">-  prettyString: function SyntheticDegeneratePartEmpty_prettyString(aIndent) {</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineplus">+  prettyString(aIndent) {</span>
<a href="#l20.143"></a><span id="l20.143">     return &quot;Degenerate Empty Part&quot;;</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineminus">-  }</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineplus">+  },</span>
<a href="#l20.146"></a><span id="l20.146"> };</span>
<a href="#l20.147"></a><span id="l20.147"> </span>
<a href="#l20.148"></a><span id="l20.148"> /**</span>
<a href="#l20.149"></a><span id="l20.149">  * Multipart (multipart/*) MIME part base class.</span>
<a href="#l20.150"></a><span id="l20.150">  */</span>
<a href="#l20.151"></a><span id="l20.151"> function SyntheticPartMulti(aParts, aProperties) {</span>
<a href="#l20.152"></a><span id="l20.152">   SyntheticPart.call(this, aProperties);</span>
<a href="#l20.153"></a><span id="l20.153"> </span>
<a href="#l20.154"></a><span id="l20.154" class="difflineminus">-  this._boundary = '--------------CHOPCHOP' + this.BOUNDARY_COUNTER;</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineplus">+  this._boundary = &quot;--------------CHOPCHOP&quot; + this.BOUNDARY_COUNTER;</span>
<a href="#l20.156"></a><span id="l20.156">   this.BOUNDARY_COUNTER_HOME.BOUNDARY_COUNTER += 1;</span>
<a href="#l20.157"></a><span id="l20.157">   this.parts = (aParts != null) ? aParts : [];</span>
<a href="#l20.158"></a><span id="l20.158"> }</span>
<a href="#l20.159"></a><span id="l20.159"> SyntheticPartMulti.prototype = {</span>
<a href="#l20.160"></a><span id="l20.160">   __proto__: SyntheticPart.prototype,</span>
<a href="#l20.161"></a><span id="l20.161">   BOUNDARY_COUNTER: 0,</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineminus">-  toMessageString: function() {</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineplus">+  toMessageString() {</span>
<a href="#l20.164"></a><span id="l20.164">     let s = &quot;This is a multi-part message in MIME format.\r\n&quot;;</span>
<a href="#l20.165"></a><span id="l20.165">     for (let part of this.parts) {</span>
<a href="#l20.166"></a><span id="l20.166">       s += &quot;--&quot; + this._boundary + &quot;\r\n&quot;;</span>
<a href="#l20.167"></a><span id="l20.167">       if (part instanceof SyntheticDegeneratePartEmpty)</span>
<a href="#l20.168"></a><span id="l20.168">         continue;</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineminus">-      s += &quot;Content-Type: &quot; + part.contentTypeHeaderValue + '\r\n';</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineplus">+      s += &quot;Content-Type: &quot; + part.contentTypeHeaderValue + &quot;\r\n&quot;;</span>
<a href="#l20.171"></a><span id="l20.171">       if (part.hasTransferEncoding)</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineminus">-        s += 'Content-Transfer-Encoding: ' +</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineminus">-             part.contentTransferEncodingHeaderValue + '\r\n';</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineplus">+        s += &quot;Content-Transfer-Encoding: &quot; +</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineplus">+             part.contentTransferEncodingHeaderValue + &quot;\r\n&quot;;</span>
<a href="#l20.176"></a><span id="l20.176">       if (part.hasDisposition)</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineminus">-        s += 'Content-Disposition: ' + part.contentDispositionHeaderValue +</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineminus">-             '\r\n';</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineplus">+        s += &quot;Content-Disposition: &quot; + part.contentDispositionHeaderValue +</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineplus">+             &quot;\r\n&quot;;</span>
<a href="#l20.181"></a><span id="l20.181">       if (part.hasContentId)</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineminus">-        s += 'Content-ID: ' + part.contentIdHeaderValue + '\r\n';</span>
<a href="#l20.183"></a><span id="l20.183" class="difflineplus">+        s += &quot;Content-ID: &quot; + part.contentIdHeaderValue + &quot;\r\n&quot;;</span>
<a href="#l20.184"></a><span id="l20.184">       if (part.hasExtraHeaders)</span>
<a href="#l20.185"></a><span id="l20.185">         for (let k in part.extraHeaders) {</span>
<a href="#l20.186"></a><span id="l20.186">           let v = part.extraHeaders[k];</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineminus">-          s += k + ': ' + v + '\r\n';</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineplus">+          s += k + &quot;: &quot; + v + &quot;\r\n&quot;;</span>
<a href="#l20.189"></a><span id="l20.189">         }</span>
<a href="#l20.190"></a><span id="l20.190" class="difflineminus">-      s += '\r\n';</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineminus">-      s += part.toMessageString() + '\r\n\r\n';</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineplus">+      s += &quot;\r\n&quot;;</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineplus">+      s += part.toMessageString() + &quot;\r\n\r\n&quot;;</span>
<a href="#l20.194"></a><span id="l20.194">     }</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineminus">-    s += &quot;--&quot; + this._boundary + '--';</span>
<a href="#l20.196"></a><span id="l20.196" class="difflineplus">+    s += &quot;--&quot; + this._boundary + &quot;--&quot;;</span>
<a href="#l20.197"></a><span id="l20.197">     return s;</span>
<a href="#l20.198"></a><span id="l20.198">   },</span>
<a href="#l20.199"></a><span id="l20.199" class="difflineminus">-  prettyString: function(aIndent) {</span>
<a href="#l20.200"></a><span id="l20.200" class="difflineplus">+  prettyString(aIndent) {</span>
<a href="#l20.201"></a><span id="l20.201">     let nextIndent = (aIndent != null) ? (aIndent + &quot;  &quot;) : &quot;&quot;;</span>
<a href="#l20.202"></a><span id="l20.202"> </span>
<a href="#l20.203"></a><span id="l20.203">     let s = &quot;Container: &quot; + this._contentType;</span>
<a href="#l20.204"></a><span id="l20.204"> </span>
<a href="#l20.205"></a><span id="l20.205">     for (let iPart = 0; iPart &lt; this.parts.length; iPart++) {</span>
<a href="#l20.206"></a><span id="l20.206">       let part = this.parts[iPart];</span>
<a href="#l20.207"></a><span id="l20.207" class="difflineminus">-      s += &quot;\n&quot; + nextIndent + (iPart+1) + &quot; &quot; + part.prettyString(nextIndent);</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineplus">+      s += &quot;\n&quot; + nextIndent + (iPart + 1) + &quot; &quot; + part.prettyString(nextIndent);</span>
<a href="#l20.209"></a><span id="l20.209">     }</span>
<a href="#l20.210"></a><span id="l20.210"> </span>
<a href="#l20.211"></a><span id="l20.211">     return s;</span>
<a href="#l20.212"></a><span id="l20.212" class="difflineminus">-  }</span>
<a href="#l20.213"></a><span id="l20.213" class="difflineplus">+  },</span>
<a href="#l20.214"></a><span id="l20.214"> };</span>
<a href="#l20.215"></a><span id="l20.215"> SyntheticPartMulti.prototype.BOUNDARY_COUNTER_HOME = SyntheticPartMulti.prototype;</span>
<a href="#l20.216"></a><span id="l20.216"> </span>
<a href="#l20.217"></a><span id="l20.217"> /**</span>
<a href="#l20.218"></a><span id="l20.218">  * Multipart mixed (multipart/mixed) MIME part.</span>
<a href="#l20.219"></a><span id="l20.219">  */</span>
<a href="#l20.220"></a><span id="l20.220"> function SyntheticPartMultiMixed(...aArgs) {</span>
<a href="#l20.221"></a><span id="l20.221">   SyntheticPartMulti.apply(this, aArgs);</span>
<a href="#l20.222"></a><span id="l20.222"> }</span>
<a href="#l20.223"></a><span id="l20.223"> SyntheticPartMultiMixed.prototype = {</span>
<a href="#l20.224"></a><span id="l20.224">   __proto__: SyntheticPartMulti.prototype,</span>
<a href="#l20.225"></a><span id="l20.225" class="difflineminus">-  _contentType: 'multipart/mixed',</span>
<a href="#l20.226"></a><span id="l20.226" class="difflineplus">+  _contentType: &quot;multipart/mixed&quot;,</span>
<a href="#l20.227"></a><span id="l20.227"> };</span>
<a href="#l20.228"></a><span id="l20.228"> </span>
<a href="#l20.229"></a><span id="l20.229"> /**</span>
<a href="#l20.230"></a><span id="l20.230">  * Multipart mixed (multipart/mixed) MIME part.</span>
<a href="#l20.231"></a><span id="l20.231">  */</span>
<a href="#l20.232"></a><span id="l20.232"> function SyntheticPartMultiParallel(...aArgs) {</span>
<a href="#l20.233"></a><span id="l20.233">   SyntheticPartMulti.apply(this, aArgs);</span>
<a href="#l20.234"></a><span id="l20.234"> }</span>
<a href="#l20.235"></a><span id="l20.235"> SyntheticPartMultiParallel.prototype = {</span>
<a href="#l20.236"></a><span id="l20.236">   __proto__: SyntheticPartMulti.prototype,</span>
<a href="#l20.237"></a><span id="l20.237" class="difflineminus">-  _contentType: 'multipart/parallel',</span>
<a href="#l20.238"></a><span id="l20.238" class="difflineplus">+  _contentType: &quot;multipart/parallel&quot;,</span>
<a href="#l20.239"></a><span id="l20.239"> };</span>
<a href="#l20.240"></a><span id="l20.240"> </span>
<a href="#l20.241"></a><span id="l20.241"> /**</span>
<a href="#l20.242"></a><span id="l20.242">  * Multipart digest (multipart/digest) MIME part.</span>
<a href="#l20.243"></a><span id="l20.243">  */</span>
<a href="#l20.244"></a><span id="l20.244"> function SyntheticPartMultiDigest(...aArgs) {</span>
<a href="#l20.245"></a><span id="l20.245">   SyntheticPartMulti.apply(this, aArgs);</span>
<a href="#l20.246"></a><span id="l20.246"> }</span>
<a href="#l20.247"></a><span id="l20.247"> SyntheticPartMultiDigest.prototype = {</span>
<a href="#l20.248"></a><span id="l20.248">   __proto__: SyntheticPartMulti.prototype,</span>
<a href="#l20.249"></a><span id="l20.249" class="difflineminus">-  _contentType: 'multipart/digest',</span>
<a href="#l20.250"></a><span id="l20.250" class="difflineplus">+  _contentType: &quot;multipart/digest&quot;,</span>
<a href="#l20.251"></a><span id="l20.251"> };</span>
<a href="#l20.252"></a><span id="l20.252"> </span>
<a href="#l20.253"></a><span id="l20.253"> /**</span>
<a href="#l20.254"></a><span id="l20.254">  * Multipart alternative (multipart/alternative) MIME part.</span>
<a href="#l20.255"></a><span id="l20.255">  */</span>
<a href="#l20.256"></a><span id="l20.256"> function SyntheticPartMultiAlternative(...aArgs) {</span>
<a href="#l20.257"></a><span id="l20.257">   SyntheticPartMulti.apply(this, aArgs);</span>
<a href="#l20.258"></a><span id="l20.258"> }</span>
<a href="#l20.259"></a><span id="l20.259"> SyntheticPartMultiAlternative.prototype = {</span>
<a href="#l20.260"></a><span id="l20.260">   __proto__: SyntheticPartMulti.prototype,</span>
<a href="#l20.261"></a><span id="l20.261" class="difflineminus">-  _contentType: 'multipart/alternative',</span>
<a href="#l20.262"></a><span id="l20.262" class="difflineplus">+  _contentType: &quot;multipart/alternative&quot;,</span>
<a href="#l20.263"></a><span id="l20.263"> };</span>
<a href="#l20.264"></a><span id="l20.264"> </span>
<a href="#l20.265"></a><span id="l20.265"> /**</span>
<a href="#l20.266"></a><span id="l20.266">  * Multipart related (multipart/related) MIME part.</span>
<a href="#l20.267"></a><span id="l20.267">  */</span>
<a href="#l20.268"></a><span id="l20.268"> function SyntheticPartMultiRelated(...aArgs) {</span>
<a href="#l20.269"></a><span id="l20.269">   SyntheticPartMulti.apply(this, aArgs);</span>
<a href="#l20.270"></a><span id="l20.270"> }</span>
<a href="#l20.271"></a><span id="l20.271"> SyntheticPartMultiRelated.prototype = {</span>
<a href="#l20.272"></a><span id="l20.272">   __proto__: SyntheticPartMulti.prototype,</span>
<a href="#l20.273"></a><span id="l20.273" class="difflineminus">-  _contentType: 'multipart/related',</span>
<a href="#l20.274"></a><span id="l20.274" class="difflineplus">+  _contentType: &quot;multipart/related&quot;,</span>
<a href="#l20.275"></a><span id="l20.275"> };</span>
<a href="#l20.276"></a><span id="l20.276"> </span>
<a href="#l20.277"></a><span id="l20.277" class="difflineminus">-var PKCS_SIGNATURE_MIME_TYPE = 'application/x-pkcs7-signature';</span>
<a href="#l20.278"></a><span id="l20.278" class="difflineplus">+var PKCS_SIGNATURE_MIME_TYPE = &quot;application/x-pkcs7-signature&quot;;</span>
<a href="#l20.279"></a><span id="l20.279"> /**</span>
<a href="#l20.280"></a><span id="l20.280">  * Multipart signed (multipart/signed) SMIME part.  This is helperish and makes</span>
<a href="#l20.281"></a><span id="l20.281">  *  up a gibberish signature.  We wrap the provided parts in the standard</span>
<a href="#l20.282"></a><span id="l20.282">  *  signature idiom</span>
<a href="#l20.283"></a><span id="l20.283">  *</span>
<a href="#l20.284"></a><span id="l20.284">  * @param aPart The content part to wrap. Only one part!  Use a multipart if</span>
<a href="#l20.285"></a><span id="l20.285">  *     you need to cram extra stuff in there.</span>
<a href="#l20.286"></a><span id="l20.286">  * @param aProperties Properties, propagated to SyntheticPart, see that.</span>
<a href="#l20.287"></a><span id="l20.287">  */</span>
<a href="#l20.288"></a><span id="l20.288"> function SyntheticPartMultiSignedSMIME(aPart, aProperties) {</span>
<a href="#l20.289"></a><span id="l20.289">   SyntheticPartMulti.call(this, [aPart], aProperties);</span>
<a href="#l20.290"></a><span id="l20.290">   this.parts.push(new SyntheticPartLeaf(</span>
<a href="#l20.291"></a><span id="l20.291">     &quot;I am not really a signature but let's hope no one figures it out.&quot;,</span>
<a href="#l20.292"></a><span id="l20.292">     {</span>
<a href="#l20.293"></a><span id="l20.293">       contentType: PKCS_SIGNATURE_MIME_TYPE,</span>
<a href="#l20.294"></a><span id="l20.294" class="difflineminus">-      name: 'smime.p7s',</span>
<a href="#l20.295"></a><span id="l20.295" class="difflineplus">+      name: &quot;smime.p7s&quot;,</span>
<a href="#l20.296"></a><span id="l20.296">     }));</span>
<a href="#l20.297"></a><span id="l20.297"> }</span>
<a href="#l20.298"></a><span id="l20.298"> SyntheticPartMultiSignedSMIME.prototype = {</span>
<a href="#l20.299"></a><span id="l20.299">   __proto__: SyntheticPartMulti.prototype,</span>
<a href="#l20.300"></a><span id="l20.300" class="difflineminus">-  _contentType: 'multipart/signed',</span>
<a href="#l20.301"></a><span id="l20.301" class="difflineplus">+  _contentType: &quot;multipart/signed&quot;,</span>
<a href="#l20.302"></a><span id="l20.302">   _contentTypeExtra: {</span>
<a href="#l20.303"></a><span id="l20.303">     protocol: PKCS_SIGNATURE_MIME_TYPE,</span>
<a href="#l20.304"></a><span id="l20.304" class="difflineminus">-    micalg: 'SHA1'</span>
<a href="#l20.305"></a><span id="l20.305" class="difflineplus">+    micalg: &quot;SHA1&quot;,</span>
<a href="#l20.306"></a><span id="l20.306">   },</span>
<a href="#l20.307"></a><span id="l20.307"> };</span>
<a href="#l20.308"></a><span id="l20.308"> </span>
<a href="#l20.309"></a><span id="l20.309" class="difflineminus">-var PGP_SIGNATURE_MIME_TYPE = 'application/pgp-signature';</span>
<a href="#l20.310"></a><span id="l20.310" class="difflineplus">+var PGP_SIGNATURE_MIME_TYPE = &quot;application/pgp-signature&quot;;</span>
<a href="#l20.311"></a><span id="l20.311"> /**</span>
<a href="#l20.312"></a><span id="l20.312">  * Multipart signed (multipart/signed) PGP part.  This is helperish and makes</span>
<a href="#l20.313"></a><span id="l20.313">  *  up a gibberish signature.  We wrap the provided parts in the standard</span>
<a href="#l20.314"></a><span id="l20.314">  *  signature idiom</span>
<a href="#l20.315"></a><span id="l20.315">  *</span>
<a href="#l20.316"></a><span id="l20.316">  * @param aPart The content part to wrap. Only one part!  Use a multipart if</span>
<a href="#l20.317"></a><span id="l20.317">  *     you need to cram extra stuff in there.</span>
<a href="#l20.318"></a><span id="l20.318">  * @param aProperties Properties, propagated to SyntheticPart, see that.</span>
<a href="#l20.319"></a><span id="l20.319" class="difflineat">@@ -331,20 +331,20 @@ function SyntheticPartMultiSignedPGP(aPa</span>
<a href="#l20.320"></a><span id="l20.320">   this.parts.push(new SyntheticPartLeaf(</span>
<a href="#l20.321"></a><span id="l20.321">     &quot;I am not really a signature but let's hope no one figures it out.&quot;,</span>
<a href="#l20.322"></a><span id="l20.322">     {</span>
<a href="#l20.323"></a><span id="l20.323">       contentType: PGP_SIGNATURE_MIME_TYPE,</span>
<a href="#l20.324"></a><span id="l20.324">     }));</span>
<a href="#l20.325"></a><span id="l20.325"> }</span>
<a href="#l20.326"></a><span id="l20.326"> SyntheticPartMultiSignedPGP.prototype = {</span>
<a href="#l20.327"></a><span id="l20.327">   __proto__: SyntheticPartMulti.prototype,</span>
<a href="#l20.328"></a><span id="l20.328" class="difflineminus">-  _contentType: 'multipart/signed',</span>
<a href="#l20.329"></a><span id="l20.329" class="difflineplus">+  _contentType: &quot;multipart/signed&quot;,</span>
<a href="#l20.330"></a><span id="l20.330">   _contentTypeExtra: {</span>
<a href="#l20.331"></a><span id="l20.331">     protocol: PGP_SIGNATURE_MIME_TYPE,</span>
<a href="#l20.332"></a><span id="l20.332" class="difflineminus">-    micalg: 'pgp-sha1'</span>
<a href="#l20.333"></a><span id="l20.333" class="difflineplus">+    micalg: &quot;pgp-sha1&quot;,</span>
<a href="#l20.334"></a><span id="l20.334">   },</span>
<a href="#l20.335"></a><span id="l20.335"> };</span>
<a href="#l20.336"></a><span id="l20.336"> </span>
<a href="#l20.337"></a><span id="l20.337"> </span>
<a href="#l20.338"></a><span id="l20.338"> var _DEFAULT_META_STATES = {</span>
<a href="#l20.339"></a><span id="l20.339">   junk: false,</span>
<a href="#l20.340"></a><span id="l20.340">   read: false,</span>
<a href="#l20.341"></a><span id="l20.341"> };</span>
<a href="#l20.342"></a><span id="l20.342" class="difflineat">@@ -373,17 +373,17 @@ function SyntheticMessage(aHeaders, aBod</span>
<a href="#l20.343"></a><span id="l20.343">     let value = _DEFAULT_META_STATES[key];</span>
<a href="#l20.344"></a><span id="l20.344">     if (!(key in this.metaState))</span>
<a href="#l20.345"></a><span id="l20.345">       this.metaState[key] = value;</span>
<a href="#l20.346"></a><span id="l20.346">   }</span>
<a href="#l20.347"></a><span id="l20.347"> }</span>
<a href="#l20.348"></a><span id="l20.348"> </span>
<a href="#l20.349"></a><span id="l20.349"> SyntheticMessage.prototype = {</span>
<a href="#l20.350"></a><span id="l20.350">   __proto__: SyntheticPart.prototype,</span>
<a href="#l20.351"></a><span id="l20.351" class="difflineminus">-  _contentType: 'message/rfc822',</span>
<a href="#l20.352"></a><span id="l20.352" class="difflineplus">+  _contentType: &quot;message/rfc822&quot;,</span>
<a href="#l20.353"></a><span id="l20.353">   _charset: null,</span>
<a href="#l20.354"></a><span id="l20.354">   _format: null,</span>
<a href="#l20.355"></a><span id="l20.355">   _encoding: null,</span>
<a href="#l20.356"></a><span id="l20.356"> </span>
<a href="#l20.357"></a><span id="l20.357">   /** @returns the Message-Id header value. */</span>
<a href="#l20.358"></a><span id="l20.358">   get messageId() { return this._messageId; },</span>
<a href="#l20.359"></a><span id="l20.359">   /**</span>
<a href="#l20.360"></a><span id="l20.360">    * Sets the Message-Id header value.</span>
<a href="#l20.361"></a><span id="l20.361" class="difflineat">@@ -401,57 +401,57 @@ SyntheticMessage.prototype = {</span>
<a href="#l20.362"></a><span id="l20.362">   /**</span>
<a href="#l20.363"></a><span id="l20.363">    * Sets the Date header to the given javascript Date object.</span>
<a href="#l20.364"></a><span id="l20.364">    *</span>
<a href="#l20.365"></a><span id="l20.365">    * @param aDate The date you want the message to claim to be from.</span>
<a href="#l20.366"></a><span id="l20.366">    */</span>
<a href="#l20.367"></a><span id="l20.367">   set date(aDate) {</span>
<a href="#l20.368"></a><span id="l20.368">     this._date = aDate;</span>
<a href="#l20.369"></a><span id="l20.369">     let dateParts = aDate.toString().split(&quot; &quot;);</span>
<a href="#l20.370"></a><span id="l20.370" class="difflineminus">-    this.headers[&quot;Date&quot;] = dateParts[0] + &quot;, &quot; + dateParts[2] + &quot; &quot; +</span>
<a href="#l20.371"></a><span id="l20.371" class="difflineminus">-                           dateParts[1] + &quot; &quot; + dateParts[3] + &quot; &quot; +</span>
<a href="#l20.372"></a><span id="l20.372" class="difflineminus">-                           dateParts[4] + &quot; &quot; + dateParts[5].substring(3);</span>
<a href="#l20.373"></a><span id="l20.373" class="difflineplus">+    this.headers.Date = dateParts[0] + &quot;, &quot; + dateParts[2] + &quot; &quot; +</span>
<a href="#l20.374"></a><span id="l20.374" class="difflineplus">+                        dateParts[1] + &quot; &quot; + dateParts[3] + &quot; &quot; +</span>
<a href="#l20.375"></a><span id="l20.375" class="difflineplus">+                        dateParts[4] + &quot; &quot; + dateParts[5].substring(3);</span>
<a href="#l20.376"></a><span id="l20.376">   },</span>
<a href="#l20.377"></a><span id="l20.377"> </span>
<a href="#l20.378"></a><span id="l20.378">   /** @returns the message subject */</span>
<a href="#l20.379"></a><span id="l20.379">   get subject() { return this._subject; },</span>
<a href="#l20.380"></a><span id="l20.380">   /**</span>
<a href="#l20.381"></a><span id="l20.381">    * Sets the message subject.</span>
<a href="#l20.382"></a><span id="l20.382">    *</span>
<a href="#l20.383"></a><span id="l20.383">    * @param aSubject A string sans newlines or other illegal characters.</span>
<a href="#l20.384"></a><span id="l20.384">    */</span>
<a href="#l20.385"></a><span id="l20.385">   set subject(aSubject) {</span>
<a href="#l20.386"></a><span id="l20.386">     this._subject = aSubject;</span>
<a href="#l20.387"></a><span id="l20.387" class="difflineminus">-    this.headers[&quot;Subject&quot;] = aSubject;</span>
<a href="#l20.388"></a><span id="l20.388" class="difflineplus">+    this.headers.Subject = aSubject;</span>
<a href="#l20.389"></a><span id="l20.389">   },</span>
<a href="#l20.390"></a><span id="l20.390"> </span>
<a href="#l20.391"></a><span id="l20.391">   /**</span>
<a href="#l20.392"></a><span id="l20.392">    * Given a tuple containing [a display name, an e-mail address], returns a</span>
<a href="#l20.393"></a><span id="l20.393">    *  string suitable for use in a to/from/cc header line.</span>
<a href="#l20.394"></a><span id="l20.394">    *</span>
<a href="#l20.395"></a><span id="l20.395">    * @param aNameAndAddress A list with two elements.  The first should be the</span>
<a href="#l20.396"></a><span id="l20.396">    *     display name (sans wrapping quotes).  The second element should be the</span>
<a href="#l20.397"></a><span id="l20.397">    *     e-mail address (sans wrapping greater-than/less-than).</span>
<a href="#l20.398"></a><span id="l20.398">    */</span>
<a href="#l20.399"></a><span id="l20.399" class="difflineminus">-  _formatMailFromNameAndAddress: function(aNameAndAddress) {</span>
<a href="#l20.400"></a><span id="l20.400" class="difflineplus">+  _formatMailFromNameAndAddress(aNameAndAddress) {</span>
<a href="#l20.401"></a><span id="l20.401">     // if the name is encoded, do not put it in quotes!</span>
<a href="#l20.402"></a><span id="l20.402" class="difflineminus">-    return (aNameAndAddress[0].startsWith(&quot;=&quot;) ?</span>
<a href="#l20.403"></a><span id="l20.403" class="difflineminus">-              (aNameAndAddress[0] + &quot; &quot;) :</span>
<a href="#l20.404"></a><span id="l20.404" class="difflineminus">-              ('&quot;' + aNameAndAddress[0] + '&quot; ')) +</span>
<a href="#l20.405"></a><span id="l20.405" class="difflineminus">-           '&lt;' + aNameAndAddress[1] + '&gt;';</span>
<a href="#l20.406"></a><span id="l20.406" class="difflineplus">+    if (aNameAndAddress[0].startsWith(&quot;=&quot;)) {</span>
<a href="#l20.407"></a><span id="l20.407" class="difflineplus">+      return aNameAndAddress[0] + &quot; &lt;&quot; + aNameAndAddress[1] + &quot;&gt;&quot;;</span>
<a href="#l20.408"></a><span id="l20.408" class="difflineplus">+    }</span>
<a href="#l20.409"></a><span id="l20.409" class="difflineplus">+    return '&quot;' + aNameAndAddress[0] + '&quot; &lt;' + aNameAndAddress[1] + &quot;&gt;&quot;;</span>
<a href="#l20.410"></a><span id="l20.410">   },</span>
<a href="#l20.411"></a><span id="l20.411"> </span>
<a href="#l20.412"></a><span id="l20.412">   /**</span>
<a href="#l20.413"></a><span id="l20.413">    * Given a mailbox, parse out name and email. The mailbox</span>
<a href="#l20.414"></a><span id="l20.414">    * can (per rfc 2822) be of two forms:</span>
<a href="#l20.415"></a><span id="l20.415">    *  1) Name &lt;me@example.org&gt;</span>
<a href="#l20.416"></a><span id="l20.416">    *  2) me@example.org</span>
<a href="#l20.417"></a><span id="l20.417">    * @return a tuple of name, email</span>
<a href="#l20.418"></a><span id="l20.418">    **/</span>
<a href="#l20.419"></a><span id="l20.419" class="difflineminus">-  _parseMailbox: function(mailbox) {</span>
<a href="#l20.420"></a><span id="l20.420" class="difflineplus">+  _parseMailbox(mailbox) {</span>
<a href="#l20.421"></a><span id="l20.421">     let matcher = mailbox.match(/(.*)&lt;(.+@.+)&gt;/);</span>
<a href="#l20.422"></a><span id="l20.422">     if (!matcher) // no match -&gt; second form</span>
<a href="#l20.423"></a><span id="l20.423">       return [&quot;&quot;, mailbox];</span>
<a href="#l20.424"></a><span id="l20.424"> </span>
<a href="#l20.425"></a><span id="l20.425">     let name = matcher[1].trim();</span>
<a href="#l20.426"></a><span id="l20.426">     let email = matcher[2].trim();</span>
<a href="#l20.427"></a><span id="l20.427">     return [name, email];</span>
<a href="#l20.428"></a><span id="l20.428">   },</span>
<a href="#l20.429"></a><span id="l20.429" class="difflineat">@@ -465,36 +465,36 @@ SyntheticMessage.prototype = {</span>
<a href="#l20.430"></a><span id="l20.430">    * @param aNameAndAddress A list with two elements.  The first should be the</span>
<a href="#l20.431"></a><span id="l20.431">    *     display name (sans wrapping quotes).  The second element should be the</span>
<a href="#l20.432"></a><span id="l20.432">    *     e-mail address (sans wrapping greater-than/less-than).</span>
<a href="#l20.433"></a><span id="l20.433">    *     Can also be a string, should then be a valid raw From: header value.</span>
<a href="#l20.434"></a><span id="l20.434">    */</span>
<a href="#l20.435"></a><span id="l20.435">   set from(aNameAndAddress) {</span>
<a href="#l20.436"></a><span id="l20.436">     if (typeof aNameAndAddress === &quot;string&quot;) {</span>
<a href="#l20.437"></a><span id="l20.437">       this._from = this._parseMailbox(aNameAndAddress);</span>
<a href="#l20.438"></a><span id="l20.438" class="difflineminus">-      this.headers[&quot;From&quot;] = aNameAndAddress;</span>
<a href="#l20.439"></a><span id="l20.439" class="difflineplus">+      this.headers.From = aNameAndAddress;</span>
<a href="#l20.440"></a><span id="l20.440">       return;</span>
<a href="#l20.441"></a><span id="l20.441">     }</span>
<a href="#l20.442"></a><span id="l20.442">     this._from = aNameAndAddress;</span>
<a href="#l20.443"></a><span id="l20.443" class="difflineminus">-    this.headers[&quot;From&quot;] = this._formatMailFromNameAndAddress(aNameAndAddress);</span>
<a href="#l20.444"></a><span id="l20.444" class="difflineplus">+    this.headers.From = this._formatMailFromNameAndAddress(aNameAndAddress);</span>
<a href="#l20.445"></a><span id="l20.445">   },</span>
<a href="#l20.446"></a><span id="l20.446"> </span>
<a href="#l20.447"></a><span id="l20.447">   /** @returns The display name part of the From header. */</span>
<a href="#l20.448"></a><span id="l20.448">   get fromName() { return this._from[0]; },</span>
<a href="#l20.449"></a><span id="l20.449">   /** @returns The e-mail address part of the From header (no display name). */</span>
<a href="#l20.450"></a><span id="l20.450">   get fromAddress() { return this._from[1]; },</span>
<a href="#l20.451"></a><span id="l20.451"> </span>
<a href="#l20.452"></a><span id="l20.452">   /**</span>
<a href="#l20.453"></a><span id="l20.453">    * For our header storage, we may need to pre-add commas, this does it.</span>
<a href="#l20.454"></a><span id="l20.454">    *</span>
<a href="#l20.455"></a><span id="l20.455">    * @param aList A list of strings that is mutated so that every string in the</span>
<a href="#l20.456"></a><span id="l20.456">    *     list except the last one has a comma appended to it.</span>
<a href="#l20.457"></a><span id="l20.457">    */</span>
<a href="#l20.458"></a><span id="l20.458" class="difflineminus">-  _commaize: function(aList) {</span>
<a href="#l20.459"></a><span id="l20.459" class="difflineminus">-    for (let i=0; i &lt; aList.length - 1; i++)</span>
<a href="#l20.460"></a><span id="l20.460" class="difflineplus">+  _commaize(aList) {</span>
<a href="#l20.461"></a><span id="l20.461" class="difflineplus">+    for (let i = 0; i &lt; aList.length - 1; i++)</span>
<a href="#l20.462"></a><span id="l20.462">       aList[i] = aList[i] + &quot;,&quot;;</span>
<a href="#l20.463"></a><span id="l20.463">     return aList;</span>
<a href="#l20.464"></a><span id="l20.464">   },</span>
<a href="#l20.465"></a><span id="l20.465"> </span>
<a href="#l20.466"></a><span id="l20.466">   /**</span>
<a href="#l20.467"></a><span id="l20.467">    * @returns the comma-ized list of name-and-address tuples used to set the To</span>
<a href="#l20.468"></a><span id="l20.468">    *     header.</span>
<a href="#l20.469"></a><span id="l20.469">    */</span>
<a href="#l20.470"></a><span id="l20.470" class="difflineat">@@ -512,22 +512,23 @@ SyntheticMessage.prototype = {</span>
<a href="#l20.471"></a><span id="l20.471">   set to(aNameAndAddresses) {</span>
<a href="#l20.472"></a><span id="l20.472">     if (typeof aNameAndAddresses === &quot;string&quot;) {</span>
<a href="#l20.473"></a><span id="l20.473">       this._to = [];</span>
<a href="#l20.474"></a><span id="l20.474">       let people = aNameAndAddresses.split(&quot;,&quot;);</span>
<a href="#l20.475"></a><span id="l20.475">       for (let i = 0; i &lt; people.length; i++) {</span>
<a href="#l20.476"></a><span id="l20.476">         this._to.push(this._parseMailbox(people[i]));</span>
<a href="#l20.477"></a><span id="l20.477">       }</span>
<a href="#l20.478"></a><span id="l20.478"> </span>
<a href="#l20.479"></a><span id="l20.479" class="difflineminus">-      this.headers[&quot;To&quot;] = aNameAndAddresses;</span>
<a href="#l20.480"></a><span id="l20.480" class="difflineplus">+      this.headers.To = aNameAndAddresses;</span>
<a href="#l20.481"></a><span id="l20.481">       return;</span>
<a href="#l20.482"></a><span id="l20.482">     }</span>
<a href="#l20.483"></a><span id="l20.483">     this._to = aNameAndAddresses;</span>
<a href="#l20.484"></a><span id="l20.484" class="difflineminus">-    this.headers[&quot;To&quot;] = this._commaize(aNameAndAddresses.</span>
<a href="#l20.485"></a><span id="l20.485" class="difflineminus">-      map(nameAndAddr =&gt; this._formatMailFromNameAndAddress(nameAndAddr)));</span>
<a href="#l20.486"></a><span id="l20.486" class="difflineplus">+    this.headers.To = this._commaize(aNameAndAddresses.map(</span>
<a href="#l20.487"></a><span id="l20.487" class="difflineplus">+      nameAndAddr =&gt; this._formatMailFromNameAndAddress(nameAndAddr)</span>
<a href="#l20.488"></a><span id="l20.488" class="difflineplus">+    ));</span>
<a href="#l20.489"></a><span id="l20.489">   },</span>
<a href="#l20.490"></a><span id="l20.490">   /** @returns The display name of the first intended recipient. */</span>
<a href="#l20.491"></a><span id="l20.491">   get toName() { return this._to[0][0]; },</span>
<a href="#l20.492"></a><span id="l20.492">   /** @returns The email address (no display name) of the first recipient. */</span>
<a href="#l20.493"></a><span id="l20.493">   get toAddress() { return this._to[0][1]; },</span>
<a href="#l20.494"></a><span id="l20.494"> </span>
<a href="#l20.495"></a><span id="l20.495">   /**</span>
<a href="#l20.496"></a><span id="l20.496">    * @returns The comma-ized list of name-and-address tuples used to set the Cc</span>
<a href="#l20.497"></a><span id="l20.497" class="difflineat">@@ -546,22 +547,23 @@ SyntheticMessage.prototype = {</span>
<a href="#l20.498"></a><span id="l20.498">    */</span>
<a href="#l20.499"></a><span id="l20.499">   set cc(aNameAndAddresses) {</span>
<a href="#l20.500"></a><span id="l20.500">     if (typeof aNameAndAddresses === &quot;string&quot;) {</span>
<a href="#l20.501"></a><span id="l20.501">       this._cc = [];</span>
<a href="#l20.502"></a><span id="l20.502">       let people = aNameAndAddresses.split(&quot;,&quot;);</span>
<a href="#l20.503"></a><span id="l20.503">       for (let i = 0; i &lt; people.length; i++) {</span>
<a href="#l20.504"></a><span id="l20.504">         this._cc.push(this._parseMailbox(people[i]));</span>
<a href="#l20.505"></a><span id="l20.505">       }</span>
<a href="#l20.506"></a><span id="l20.506" class="difflineminus">-      this.headers[&quot;Cc&quot;] = aNameAndAddresses;</span>
<a href="#l20.507"></a><span id="l20.507" class="difflineplus">+      this.headers.Cc = aNameAndAddresses;</span>
<a href="#l20.508"></a><span id="l20.508">       return;</span>
<a href="#l20.509"></a><span id="l20.509">     }</span>
<a href="#l20.510"></a><span id="l20.510">     this._cc = aNameAndAddresses;</span>
<a href="#l20.511"></a><span id="l20.511" class="difflineminus">-    this.headers[&quot;Cc&quot;] = this._commaize(aNameAndAddresses.</span>
<a href="#l20.512"></a><span id="l20.512" class="difflineminus">-      map(nameAndAddr =&gt; this._formatMailFromNameAndAddress(nameAndAddr)));</span>
<a href="#l20.513"></a><span id="l20.513" class="difflineplus">+    this.headers.Cc = this._commaize(aNameAndAddresses.map(</span>
<a href="#l20.514"></a><span id="l20.514" class="difflineplus">+      nameAndAddr =&gt; this._formatMailFromNameAndAddress(nameAndAddr)</span>
<a href="#l20.515"></a><span id="l20.515" class="difflineplus">+    ));</span>
<a href="#l20.516"></a><span id="l20.516">   },</span>
<a href="#l20.517"></a><span id="l20.517"> </span>
<a href="#l20.518"></a><span id="l20.518">   get bodyPart() {</span>
<a href="#l20.519"></a><span id="l20.519">     return this._bodyPart;</span>
<a href="#l20.520"></a><span id="l20.520">   },</span>
<a href="#l20.521"></a><span id="l20.521">   set bodyPart(aBodyPart) {</span>
<a href="#l20.522"></a><span id="l20.522">     this._bodyPart = aBodyPart;</span>
<a href="#l20.523"></a><span id="l20.523">     this.headers[&quot;Content-Type&quot;] = this._bodyPart.contentTypeHeaderValue;</span>
<a href="#l20.524"></a><span id="l20.524" class="difflineat">@@ -569,98 +571,97 @@ SyntheticMessage.prototype = {</span>
<a href="#l20.525"></a><span id="l20.525"> </span>
<a href="#l20.526"></a><span id="l20.526">   /**</span>
<a href="#l20.527"></a><span id="l20.527">    * Normalizes header values, which may be strings or arrays of strings, into</span>
<a href="#l20.528"></a><span id="l20.528">    *  a suitable string suitable for appending to the header name/key.</span>
<a href="#l20.529"></a><span id="l20.529">    *</span>
<a href="#l20.530"></a><span id="l20.530">    * @returns a normalized string representation of the header value(s), which</span>
<a href="#l20.531"></a><span id="l20.531">    *     may include spanning multiple lines.</span>
<a href="#l20.532"></a><span id="l20.532">    */</span>
<a href="#l20.533"></a><span id="l20.533" class="difflineminus">-  _formatHeaderValues: function(aHeaderValues) {</span>
<a href="#l20.534"></a><span id="l20.534" class="difflineplus">+  _formatHeaderValues(aHeaderValues) {</span>
<a href="#l20.535"></a><span id="l20.535">     // may not be an array</span>
<a href="#l20.536"></a><span id="l20.536">     if (!(aHeaderValues instanceof Array))</span>
<a href="#l20.537"></a><span id="l20.537">       return aHeaderValues;</span>
<a href="#l20.538"></a><span id="l20.538">     // it's an array!</span>
<a href="#l20.539"></a><span id="l20.539">     if (aHeaderValues.length == 1)</span>
<a href="#l20.540"></a><span id="l20.540">       return aHeaderValues[0];</span>
<a href="#l20.541"></a><span id="l20.541">     return aHeaderValues.join(&quot;\r\n\t&quot;);</span>
<a href="#l20.542"></a><span id="l20.542">   },</span>
<a href="#l20.543"></a><span id="l20.543"> </span>
<a href="#l20.544"></a><span id="l20.544">   /**</span>
<a href="#l20.545"></a><span id="l20.545">    * @returns a string uniquely identifying this message, at least as long as</span>
<a href="#l20.546"></a><span id="l20.546">    *     the messageId is set and unique.</span>
<a href="#l20.547"></a><span id="l20.547">    */</span>
<a href="#l20.548"></a><span id="l20.548" class="difflineminus">-  toString: function() {</span>
<a href="#l20.549"></a><span id="l20.549" class="difflineplus">+  toString() {</span>
<a href="#l20.550"></a><span id="l20.550">     return &quot;msg:&quot; + this._messageId;</span>
<a href="#l20.551"></a><span id="l20.551">   },</span>
<a href="#l20.552"></a><span id="l20.552"> </span>
<a href="#l20.553"></a><span id="l20.553">   /**</span>
<a href="#l20.554"></a><span id="l20.554">    * Convert the message and its hierarchy into a &quot;pretty string&quot;.  The message</span>
<a href="#l20.555"></a><span id="l20.555">    *  and each MIME part get their own line.  The string never ends with a</span>
<a href="#l20.556"></a><span id="l20.556">    *  newline.  For a non-multi-part message, only a single line will be</span>
<a href="#l20.557"></a><span id="l20.557">    *  returned.</span>
<a href="#l20.558"></a><span id="l20.558">    * Messages have their subject displayed, everyone else just shows their</span>
<a href="#l20.559"></a><span id="l20.559">    *  content type.</span>
<a href="#l20.560"></a><span id="l20.560">    */</span>
<a href="#l20.561"></a><span id="l20.561" class="difflineminus">-  prettyString: function MimeMessage_prettyString(aIndent) {</span>
<a href="#l20.562"></a><span id="l20.562" class="difflineplus">+  prettyString(aIndent) {</span>
<a href="#l20.563"></a><span id="l20.563">     if (aIndent === undefined)</span>
<a href="#l20.564"></a><span id="l20.564">       aIndent = &quot;&quot;;</span>
<a href="#l20.565"></a><span id="l20.565">     let nextIndent = aIndent + &quot;  &quot;;</span>
<a href="#l20.566"></a><span id="l20.566"> </span>
<a href="#l20.567"></a><span id="l20.567">     let s = &quot;Message: &quot; + this.subject;</span>
<a href="#l20.568"></a><span id="l20.568">     s += &quot;\n&quot; + nextIndent + &quot;1 &quot; + this.bodyPart.prettyString(nextIndent);</span>
<a href="#l20.569"></a><span id="l20.569"> </span>
<a href="#l20.570"></a><span id="l20.570">     return s;</span>
<a href="#l20.571"></a><span id="l20.571">   },</span>
<a href="#l20.572"></a><span id="l20.572"> </span>
<a href="#l20.573"></a><span id="l20.573">   /**</span>
<a href="#l20.574"></a><span id="l20.574">    * @returns this messages in rfc822 format, or something close enough.</span>
<a href="#l20.575"></a><span id="l20.575">    */</span>
<a href="#l20.576"></a><span id="l20.576" class="difflineminus">-  toMessageString: function() {</span>
<a href="#l20.577"></a><span id="l20.577" class="difflineplus">+  toMessageString() {</span>
<a href="#l20.578"></a><span id="l20.578">     let lines = Object.keys(this.headers).</span>
<a href="#l20.579"></a><span id="l20.579">       map(headerKey =&gt;</span>
<a href="#l20.580"></a><span id="l20.580">           headerKey + &quot;: &quot; + this._formatHeaderValues(this.headers[headerKey]));</span>
<a href="#l20.581"></a><span id="l20.581"> </span>
<a href="#l20.582"></a><span id="l20.582">     return lines.join(&quot;\r\n&quot;) + &quot;\r\n\r\n&quot; + this.bodyPart.toMessageString() +</span>
<a href="#l20.583"></a><span id="l20.583">       &quot;\r\n&quot;;</span>
<a href="#l20.584"></a><span id="l20.584">   },</span>
<a href="#l20.585"></a><span id="l20.585"> </span>
<a href="#l20.586"></a><span id="l20.586" class="difflineminus">-  toMboxString: function() {</span>
<a href="#l20.587"></a><span id="l20.587" class="difflineplus">+  toMboxString() {</span>
<a href="#l20.588"></a><span id="l20.588">     return &quot;From &quot; + this._from[1] + &quot;\r\n&quot; + this.toMessageString() + &quot;\r\n&quot;;</span>
<a href="#l20.589"></a><span id="l20.589">   },</span>
<a href="#l20.590"></a><span id="l20.590"> </span>
<a href="#l20.591"></a><span id="l20.591">   /**</span>
<a href="#l20.592"></a><span id="l20.592">    * @returns this message in rfc822 format in a string stream.</span>
<a href="#l20.593"></a><span id="l20.593">    */</span>
<a href="#l20.594"></a><span id="l20.594" class="difflineminus">-  toStream: function () {</span>
<a href="#l20.595"></a><span id="l20.595" class="difflineplus">+  toStream() {</span>
<a href="#l20.596"></a><span id="l20.596">     let stream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;]</span>
<a href="#l20.597"></a><span id="l20.597">                    .createInstance(Ci.nsIStringInputStream);</span>
<a href="#l20.598"></a><span id="l20.598">     let str = this.toMessageString();</span>
<a href="#l20.599"></a><span id="l20.599">     stream.setData(str, str.length);</span>
<a href="#l20.600"></a><span id="l20.600">     return stream;</span>
<a href="#l20.601"></a><span id="l20.601">   },</span>
<a href="#l20.602"></a><span id="l20.602"> </span>
<a href="#l20.603"></a><span id="l20.603">   /**</span>
<a href="#l20.604"></a><span id="l20.604">    * Writes this message to an mbox stream.  This means adding a &quot;From &quot; line</span>
<a href="#l20.605"></a><span id="l20.605">    *  and making sure we've got a trailing newline.</span>
<a href="#l20.606"></a><span id="l20.606">    */</span>
<a href="#l20.607"></a><span id="l20.607" class="difflineminus">-  writeToMboxStream: function (aStream) {</span>
<a href="#l20.608"></a><span id="l20.608" class="difflineplus">+  writeToMboxStream(aStream) {</span>
<a href="#l20.609"></a><span id="l20.609">     let str = this.toMboxString();</span>
<a href="#l20.610"></a><span id="l20.610">     aStream.write(str, str.length);</span>
<a href="#l20.611"></a><span id="l20.611" class="difflineminus">-  }</span>
<a href="#l20.612"></a><span id="l20.612" class="difflineplus">+  },</span>
<a href="#l20.613"></a><span id="l20.613"> };</span>
<a href="#l20.614"></a><span id="l20.614"> </span>
<a href="#l20.615"></a><span id="l20.615"> /**</span>
<a href="#l20.616"></a><span id="l20.616">  * Write a list of messages to a folder</span>
<a href="#l20.617"></a><span id="l20.617">  *</span>
<a href="#l20.618"></a><span id="l20.618">  * @param aMessages The list of SyntheticMessages instances to write.</span>
<a href="#l20.619"></a><span id="l20.619">  * @param aFolder The folder to write to.</span>
<a href="#l20.620"></a><span id="l20.620">  */</span>
<a href="#l20.621"></a><span id="l20.621" class="difflineminus">-function addMessagesToFolder (aMessages, aFolder)</span>
<a href="#l20.622"></a><span id="l20.622" class="difflineminus">-{</span>
<a href="#l20.623"></a><span id="l20.623" class="difflineplus">+function addMessagesToFolder(aMessages, aFolder) {</span>
<a href="#l20.624"></a><span id="l20.624">   let localFolder = aFolder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l20.625"></a><span id="l20.625">   for (let message of aMessages)</span>
<a href="#l20.626"></a><span id="l20.626">     localFolder.addMessage(message.toMboxString());</span>
<a href="#l20.627"></a><span id="l20.627"> }</span>
<a href="#l20.628"></a><span id="l20.628"> </span>
<a href="#l20.629"></a><span id="l20.629"> /**</span>
<a href="#l20.630"></a><span id="l20.630">  * Provides mechanisms for creating vaguely interesting, but at least valid,</span>
<a href="#l20.631"></a><span id="l20.631">  *  SyntheticMessage instances.</span>
<a href="#l20.632"></a><span id="l20.632" class="difflineat">@@ -692,17 +693,17 @@ MessageGenerator.prototype = {</span>
<a href="#l20.633"></a><span id="l20.633">    *  value.  Currently up to 26*26 unique names can be generated, which</span>
<a href="#l20.634"></a><span id="l20.634">    *  should be sufficient for testing purposes, but if your code cares, check</span>
<a href="#l20.635"></a><span id="l20.635">    *  against MAX_VALID_NAMES.</span>
<a href="#l20.636"></a><span id="l20.636">    *</span>
<a href="#l20.637"></a><span id="l20.637">    * @param aNameNumber The 'number' of the name you want which must be less</span>
<a href="#l20.638"></a><span id="l20.638">    *     than MAX_VALID_NAMES.</span>
<a href="#l20.639"></a><span id="l20.639">    * @returns The unique name corresponding to the name number.</span>
<a href="#l20.640"></a><span id="l20.640">    */</span>
<a href="#l20.641"></a><span id="l20.641" class="difflineminus">-  makeName: function(aNameNumber) {</span>
<a href="#l20.642"></a><span id="l20.642" class="difflineplus">+  makeName(aNameNumber) {</span>
<a href="#l20.643"></a><span id="l20.643">     let iFirst = aNameNumber % FIRST_NAMES.length;</span>
<a href="#l20.644"></a><span id="l20.644">     let iLast = (iFirst + Math.floor(aNameNumber / FIRST_NAMES.length)) %</span>
<a href="#l20.645"></a><span id="l20.645">                 LAST_NAMES.length;</span>
<a href="#l20.646"></a><span id="l20.646"> </span>
<a href="#l20.647"></a><span id="l20.647">     return FIRST_NAMES[iFirst] + &quot; &quot; + LAST_NAMES[iLast];</span>
<a href="#l20.648"></a><span id="l20.648">   },</span>
<a href="#l20.649"></a><span id="l20.649"> </span>
<a href="#l20.650"></a><span id="l20.650">   /**</span>
<a href="#l20.651"></a><span id="l20.651" class="difflineat">@@ -710,17 +711,17 @@ MessageGenerator.prototype = {</span>
<a href="#l20.652"></a><span id="l20.652">    *  a unique value; intended to work in parallel with makeName.  Currently</span>
<a href="#l20.653"></a><span id="l20.653">    *  up to 26*26 unique addresses can be generated, but if your code cares,</span>
<a href="#l20.654"></a><span id="l20.654">    *  check against MAX_VALID_MAIL_ADDRESSES.</span>
<a href="#l20.655"></a><span id="l20.655">    *</span>
<a href="#l20.656"></a><span id="l20.656">    * @param aNameNumber The 'number' of the mail address you want which must be</span>
<a href="#l20.657"></a><span id="l20.657">    *     less than MAX_VALID_MAIL_ADDRESSES.</span>
<a href="#l20.658"></a><span id="l20.658">    * @returns The unique name corresponding to the name mail address.</span>
<a href="#l20.659"></a><span id="l20.659">    */</span>
<a href="#l20.660"></a><span id="l20.660" class="difflineminus">-  makeMailAddress: function(aNameNumber) {</span>
<a href="#l20.661"></a><span id="l20.661" class="difflineplus">+  makeMailAddress(aNameNumber) {</span>
<a href="#l20.662"></a><span id="l20.662">     let iFirst = aNameNumber % FIRST_NAMES.length;</span>
<a href="#l20.663"></a><span id="l20.663">     let iLast = (iFirst + Math.floor(aNameNumber / FIRST_NAMES.length)) %</span>
<a href="#l20.664"></a><span id="l20.664">                 LAST_NAMES.length;</span>
<a href="#l20.665"></a><span id="l20.665"> </span>
<a href="#l20.666"></a><span id="l20.666">     return FIRST_NAMES[iFirst].toLowerCase() + &quot;@&quot; +</span>
<a href="#l20.667"></a><span id="l20.667">            LAST_NAMES[iLast].toLowerCase() + &quot;.invalid&quot;;</span>
<a href="#l20.668"></a><span id="l20.668">   },</span>
<a href="#l20.669"></a><span id="l20.669"> </span>
<a href="#l20.670"></a><span id="l20.670" class="difflineat">@@ -734,47 +735,47 @@ MessageGenerator.prototype = {</span>
<a href="#l20.671"></a><span id="l20.671">    *     unless you don't mind or can ensure no collisions occur between our</span>
<a href="#l20.672"></a><span id="l20.672">    *     number allocation and your uses.  If provided, the number must be</span>
<a href="#l20.673"></a><span id="l20.673">    *     less than MAX_VALID_NAMES.</span>
<a href="#l20.674"></a><span id="l20.674">    * @return A list containing two elements.  The first is a name produced by</span>
<a href="#l20.675"></a><span id="l20.675">    *     a call to makeName, and the second an e-mail address produced by a</span>
<a href="#l20.676"></a><span id="l20.676">    *     call to makeMailAddress.  This representation is used by the</span>
<a href="#l20.677"></a><span id="l20.677">    *     SyntheticMessage class when dealing with names and addresses.</span>
<a href="#l20.678"></a><span id="l20.678">    */</span>
<a href="#l20.679"></a><span id="l20.679" class="difflineminus">-  makeNameAndAddress: function(aNameNumber) {</span>
<a href="#l20.680"></a><span id="l20.680" class="difflineplus">+  makeNameAndAddress(aNameNumber) {</span>
<a href="#l20.681"></a><span id="l20.681">     if (aNameNumber === undefined)</span>
<a href="#l20.682"></a><span id="l20.682">       aNameNumber = this._nextNameNumber++;</span>
<a href="#l20.683"></a><span id="l20.683">     return [this.makeName(aNameNumber), this.makeMailAddress(aNameNumber)];</span>
<a href="#l20.684"></a><span id="l20.684">   },</span>
<a href="#l20.685"></a><span id="l20.685"> </span>
<a href="#l20.686"></a><span id="l20.686">   /**</span>
<a href="#l20.687"></a><span id="l20.687">    * Generate and return multiple pairs of names and e-mail addresses.  The</span>
<a href="#l20.688"></a><span id="l20.688">    *  names are allocated using the automatic mechanism as documented on</span>
<a href="#l20.689"></a><span id="l20.689">    *  makeNameAndAddress.  You should accordingly not allocate / hard code name</span>
<a href="#l20.690"></a><span id="l20.690">    *  numbers on your own.</span>
<a href="#l20.691"></a><span id="l20.691">    *</span>
<a href="#l20.692"></a><span id="l20.692">    * @param aCount The number of people you want name and address tuples for.</span>
<a href="#l20.693"></a><span id="l20.693">    * @returns a list of aCount name-and-address tuples.</span>
<a href="#l20.694"></a><span id="l20.694">    */</span>
<a href="#l20.695"></a><span id="l20.695" class="difflineminus">-  makeNamesAndAddresses: function(aCount) {</span>
<a href="#l20.696"></a><span id="l20.696" class="difflineplus">+  makeNamesAndAddresses(aCount) {</span>
<a href="#l20.697"></a><span id="l20.697">     let namesAndAddresses = [];</span>
<a href="#l20.698"></a><span id="l20.698" class="difflineminus">-    for (let i=0; i &lt; aCount; i++)</span>
<a href="#l20.699"></a><span id="l20.699" class="difflineplus">+    for (let i = 0; i &lt; aCount; i++)</span>
<a href="#l20.700"></a><span id="l20.700">       namesAndAddresses.push(this.makeNameAndAddress());</span>
<a href="#l20.701"></a><span id="l20.701">     return namesAndAddresses;</span>
<a href="#l20.702"></a><span id="l20.702">   },</span>
<a href="#l20.703"></a><span id="l20.703"> </span>
<a href="#l20.704"></a><span id="l20.704">   /**</span>
<a href="#l20.705"></a><span id="l20.705">    * Generate a consistently determined (and reversible) subject from a unique</span>
<a href="#l20.706"></a><span id="l20.706">    *  value.  Up to MAX_VALID_SUBJECTS can be produced.</span>
<a href="#l20.707"></a><span id="l20.707">    *</span>
<a href="#l20.708"></a><span id="l20.708">    * @param aSubjectNumber The subject number you want generated, must be less</span>
<a href="#l20.709"></a><span id="l20.709">    *     than MAX_VALID_SUBJECTS.</span>
<a href="#l20.710"></a><span id="l20.710">    * @returns The subject corresponding to the given subject number.</span>
<a href="#l20.711"></a><span id="l20.711">    */</span>
<a href="#l20.712"></a><span id="l20.712" class="difflineminus">-  makeSubject: function(aSubjectNumber) {</span>
<a href="#l20.713"></a><span id="l20.713" class="difflineplus">+  makeSubject(aSubjectNumber) {</span>
<a href="#l20.714"></a><span id="l20.714">     if (aSubjectNumber === undefined)</span>
<a href="#l20.715"></a><span id="l20.715">       aSubjectNumber = this._nextSubjectNumber++;</span>
<a href="#l20.716"></a><span id="l20.716">     let iAdjective = aSubjectNumber % SUBJECT_ADJECTIVES.length;</span>
<a href="#l20.717"></a><span id="l20.717">     let iNoun = (iAdjective + Math.floor(aSubjectNumber /</span>
<a href="#l20.718"></a><span id="l20.718">                                          SUBJECT_ADJECTIVES.length)) %</span>
<a href="#l20.719"></a><span id="l20.719">                 SUBJECT_NOUNS.length;</span>
<a href="#l20.720"></a><span id="l20.720">     let iSuffix = (iNoun + Math.floor(aSubjectNumber /</span>
<a href="#l20.721"></a><span id="l20.721">                    (SUBJECT_ADJECTIVES.length * SUBJECT_NOUNS.length))) %</span>
<a href="#l20.722"></a><span id="l20.722" class="difflineat">@@ -789,32 +790,32 @@ MessageGenerator.prototype = {</span>
<a href="#l20.723"></a><span id="l20.723">    *  we don't use the message yet, in theory it would let us tailor the</span>
<a href="#l20.724"></a><span id="l20.724">    *  message id to the server that theoretically might be sending it.  Or some</span>
<a href="#l20.725"></a><span id="l20.725">    *  such.</span>
<a href="#l20.726"></a><span id="l20.726">    *</span>
<a href="#l20.727"></a><span id="l20.727">    * @param The synthetic message you would like us to make up a message-id for.</span>
<a href="#l20.728"></a><span id="l20.728">    *     We don't set the message-id on the message, that's up to you.</span>
<a href="#l20.729"></a><span id="l20.729">    * @returns a Message-id suitable for the given message.</span>
<a href="#l20.730"></a><span id="l20.730">    */</span>
<a href="#l20.731"></a><span id="l20.731" class="difflineminus">-  makeMessageId: function(aSynthMessage) {</span>
<a href="#l20.732"></a><span id="l20.732" class="difflineplus">+  makeMessageId(aSynthMessage) {</span>
<a href="#l20.733"></a><span id="l20.733">     let msgId = this._nextMessageIdNum + &quot;@made.up.invalid&quot;;</span>
<a href="#l20.734"></a><span id="l20.734">     this._nextMessageIdNum++;</span>
<a href="#l20.735"></a><span id="l20.735">     return msgId;</span>
<a href="#l20.736"></a><span id="l20.736">   },</span>
<a href="#l20.737"></a><span id="l20.737"> </span>
<a href="#l20.738"></a><span id="l20.738">   /**</span>
<a href="#l20.739"></a><span id="l20.739">    * Generates a valid date which is after all previously issued dates by this</span>
<a href="#l20.740"></a><span id="l20.740">    *  method, ensuring an apparent ordering of time consistent with the order</span>
<a href="#l20.741"></a><span id="l20.741">    *  in which code is executed / messages are generated.</span>
<a href="#l20.742"></a><span id="l20.742">    * If you need a precise time ordering or precise times, make them up</span>
<a href="#l20.743"></a><span id="l20.743">    *  yourself.</span>
<a href="#l20.744"></a><span id="l20.744">    *</span>
<a href="#l20.745"></a><span id="l20.745">    * @returns A made-up time in JavaScript Date object form.</span>
<a href="#l20.746"></a><span id="l20.746">    */</span>
<a href="#l20.747"></a><span id="l20.747" class="difflineminus">-  makeDate: function() {</span>
<a href="#l20.748"></a><span id="l20.748" class="difflineplus">+  makeDate() {</span>
<a href="#l20.749"></a><span id="l20.749">     let date = this._clock;</span>
<a href="#l20.750"></a><span id="l20.750">     // advance time by an hour</span>
<a href="#l20.751"></a><span id="l20.751">     this._clock = new Date(date.valueOf() + 60 * 60 * 1000);</span>
<a href="#l20.752"></a><span id="l20.752">     return date;</span>
<a href="#l20.753"></a><span id="l20.753">   },</span>
<a href="#l20.754"></a><span id="l20.754"> </span>
<a href="#l20.755"></a><span id="l20.755">   /**</span>
<a href="#l20.756"></a><span id="l20.756">    * Create a SyntheticMessage.  All arguments are optional, but allow</span>
<a href="#l20.757"></a><span id="l20.757" class="difflineat">@@ -863,17 +864,17 @@ MessageGenerator.prototype = {</span>
<a href="#l20.758"></a><span id="l20.758">    *     mechanism.</span>
<a href="#l20.759"></a><span id="l20.759">    * @param [aArgs.junk] Should this message be flagged as junk for the benefit</span>
<a href="#l20.760"></a><span id="l20.760">    *     of the messageInjection helper so that it can know to flag the message</span>
<a href="#l20.761"></a><span id="l20.761">    *     as junk?  We have no concept of marking a message as definitely not</span>
<a href="#l20.762"></a><span id="l20.762">    *     junk at this point.</span>
<a href="#l20.763"></a><span id="l20.763">    * @param [aArgs.read] Should this message be marked as already read?</span>
<a href="#l20.764"></a><span id="l20.764">    * @returns a SyntheticMessage fashioned just to your liking.</span>
<a href="#l20.765"></a><span id="l20.765">    */</span>
<a href="#l20.766"></a><span id="l20.766" class="difflineminus">-  makeMessage: function(aArgs) {</span>
<a href="#l20.767"></a><span id="l20.767" class="difflineplus">+  makeMessage(aArgs) {</span>
<a href="#l20.768"></a><span id="l20.768">     aArgs = aArgs || {};</span>
<a href="#l20.769"></a><span id="l20.769">     let msg = new SyntheticMessage();</span>
<a href="#l20.770"></a><span id="l20.770"> </span>
<a href="#l20.771"></a><span id="l20.771">     if (aArgs.inReplyTo) {</span>
<a href="#l20.772"></a><span id="l20.772">       // If inReplyTo is a SyntheticMessageSet, just use the first message in</span>
<a href="#l20.773"></a><span id="l20.773">       //  the set because the caller may be using them.</span>
<a href="#l20.774"></a><span id="l20.774">       let srcMsg = aArgs.inReplyTo.synMessages ?</span>
<a href="#l20.775"></a><span id="l20.775">                      aArgs.inReplyTo.synMessages[0] :</span>
<a href="#l20.776"></a><span id="l20.776" class="difflineat">@@ -887,20 +888,19 @@ MessageGenerator.prototype = {</span>
<a href="#l20.777"></a><span id="l20.777">       if (aArgs.replyAll)</span>
<a href="#l20.778"></a><span id="l20.778">         msg.to = [srcMsg.from].concat(srcMsg.to.slice(1));</span>
<a href="#l20.779"></a><span id="l20.779">       else</span>
<a href="#l20.780"></a><span id="l20.780">         msg.to = [srcMsg.from];</span>
<a href="#l20.781"></a><span id="l20.781">       msg.from = srcMsg.to[0];</span>
<a href="#l20.782"></a><span id="l20.782"> </span>
<a href="#l20.783"></a><span id="l20.783">       // we want the &lt;&gt;'s.</span>
<a href="#l20.784"></a><span id="l20.784">       msg.headers[&quot;In-Reply-To&quot;] = srcMsg.headers[&quot;Message-Id&quot;];</span>
<a href="#l20.785"></a><span id="l20.785" class="difflineminus">-      msg.headers[&quot;References&quot;] = (srcMsg.headers[&quot;References&quot;] || []).concat(</span>
<a href="#l20.786"></a><span id="l20.786" class="difflineminus">-                                   [srcMsg.headers[&quot;Message-Id&quot;]]);</span>
<a href="#l20.787"></a><span id="l20.787" class="difflineminus">-    }</span>
<a href="#l20.788"></a><span id="l20.788" class="difflineminus">-    else {</span>
<a href="#l20.789"></a><span id="l20.789" class="difflineplus">+      msg.headers.References = (srcMsg.headers.References || [])</span>
<a href="#l20.790"></a><span id="l20.790" class="difflineplus">+                               .concat([srcMsg.headers[&quot;Message-Id&quot;]]);</span>
<a href="#l20.791"></a><span id="l20.791" class="difflineplus">+    } else {</span>
<a href="#l20.792"></a><span id="l20.792">       msg.parent = null;</span>
<a href="#l20.793"></a><span id="l20.793"> </span>
<a href="#l20.794"></a><span id="l20.794">       msg.subject = aArgs.subject || this.makeSubject();</span>
<a href="#l20.795"></a><span id="l20.795">       msg.from = aArgs.from || this.makeNameAndAddress();</span>
<a href="#l20.796"></a><span id="l20.796">       msg.to = aArgs.to || this.makeNamesAndAddresses(aArgs.toCount || 1);</span>
<a href="#l20.797"></a><span id="l20.797">       if (aArgs.cc)</span>
<a href="#l20.798"></a><span id="l20.798">         msg.cc = aArgs.cc;</span>
<a href="#l20.799"></a><span id="l20.799">     }</span>
<a href="#l20.800"></a><span id="l20.800" class="difflineat">@@ -915,18 +915,17 @@ MessageGenerator.prototype = {</span>
<a href="#l20.801"></a><span id="l20.801">         ts -= age.minutes * 60 * 1000;</span>
<a href="#l20.802"></a><span id="l20.802">       if (age.hours)</span>
<a href="#l20.803"></a><span id="l20.803">         ts -= age.hours * 60 * 60 * 1000;</span>
<a href="#l20.804"></a><span id="l20.804">       if (age.days)</span>
<a href="#l20.805"></a><span id="l20.805">         ts -= age.days * 24 * 60 * 60 * 1000;</span>
<a href="#l20.806"></a><span id="l20.806">       if (age.weeks)</span>
<a href="#l20.807"></a><span id="l20.807">         ts -= age.weeks * 7 * 24 * 60 * 60 * 1000;</span>
<a href="#l20.808"></a><span id="l20.808">       msg.date = new Date(ts);</span>
<a href="#l20.809"></a><span id="l20.809" class="difflineminus">-    }</span>
<a href="#l20.810"></a><span id="l20.810" class="difflineminus">-    else {</span>
<a href="#l20.811"></a><span id="l20.811" class="difflineplus">+    } else {</span>
<a href="#l20.812"></a><span id="l20.812">       msg.date = this.makeDate();</span>
<a href="#l20.813"></a><span id="l20.813">     }</span>
<a href="#l20.814"></a><span id="l20.814"> </span>
<a href="#l20.815"></a><span id="l20.815">     if (&quot;clobberHeaders&quot; in aArgs) {</span>
<a href="#l20.816"></a><span id="l20.816">       for (let key in aArgs.clobberHeaders) {</span>
<a href="#l20.817"></a><span id="l20.817">         let value = aArgs.clobberHeaders[key];</span>
<a href="#l20.818"></a><span id="l20.818">         if (value === null)</span>
<a href="#l20.819"></a><span id="l20.819">           delete msg.headers[key];</span>
<a href="#l20.820"></a><span id="l20.820" class="difflineat">@@ -970,36 +969,35 @@ MessageGenerator.prototype = {</span>
<a href="#l20.821"></a><span id="l20.821"> </span>
<a href="#l20.822"></a><span id="l20.822">     return msg;</span>
<a href="#l20.823"></a><span id="l20.823">   },</span>
<a href="#l20.824"></a><span id="l20.824"> </span>
<a href="#l20.825"></a><span id="l20.825">   /**</span>
<a href="#l20.826"></a><span id="l20.826">    * Create an encrypted SMime message. It's just a wrapper around makeMessage,</span>
<a href="#l20.827"></a><span id="l20.827">    * that sets the right content-type. Use like makeMessage.</span>
<a href="#l20.828"></a><span id="l20.828">    */</span>
<a href="#l20.829"></a><span id="l20.829" class="difflineminus">-  makeEncryptedSMimeMessage:</span>
<a href="#l20.830"></a><span id="l20.830" class="difflineminus">-      function MessageGenerate_makeEncryptedSMimeMessage(aOptions) {</span>
<a href="#l20.831"></a><span id="l20.831" class="difflineplus">+  makeEncryptedSMimeMessage(aOptions) {</span>
<a href="#l20.832"></a><span id="l20.832">     if (!aOptions)</span>
<a href="#l20.833"></a><span id="l20.833">       aOptions = {};</span>
<a href="#l20.834"></a><span id="l20.834">     aOptions.clobberHeaders = {</span>
<a href="#l20.835"></a><span id="l20.835" class="difflineminus">-      'Content-Transfer-Encoding': 'base64',</span>
<a href="#l20.836"></a><span id="l20.836" class="difflineminus">-      'Content-Disposition': 'attachment; filename=&quot;smime.p7m&quot;',</span>
<a href="#l20.837"></a><span id="l20.837" class="difflineminus">-    }</span>
<a href="#l20.838"></a><span id="l20.838" class="difflineplus">+      &quot;Content-Transfer-Encoding&quot;: &quot;base64&quot;,</span>
<a href="#l20.839"></a><span id="l20.839" class="difflineplus">+      &quot;Content-Disposition&quot;: 'attachment; filename=&quot;smime.p7m&quot;',</span>
<a href="#l20.840"></a><span id="l20.840" class="difflineplus">+    };</span>
<a href="#l20.841"></a><span id="l20.841">     if (!aOptions.body)</span>
<a href="#l20.842"></a><span id="l20.842">       aOptions.body = {};</span>
<a href="#l20.843"></a><span id="l20.843">     aOptions.body.contentType = 'application/pkcs7-mime; name=&quot;smime.p7m&quot;';</span>
<a href="#l20.844"></a><span id="l20.844">     let msg = this.makeMessage(aOptions);</span>
<a href="#l20.845"></a><span id="l20.845">     return msg;</span>
<a href="#l20.846"></a><span id="l20.846">   },</span>
<a href="#l20.847"></a><span id="l20.847"> </span>
<a href="#l20.848"></a><span id="l20.848">   MAKE_MESSAGES_DEFAULTS: {</span>
<a href="#l20.849"></a><span id="l20.849">     count: 10,</span>
<a href="#l20.850"></a><span id="l20.850">   },</span>
<a href="#l20.851"></a><span id="l20.851" class="difflineminus">-  MAKE_MESSAGES_PROPAGATE: ['attachments', 'body', 'cc', 'from', 'inReplyTo',</span>
<a href="#l20.852"></a><span id="l20.852" class="difflineminus">-                            'subject', 'to', 'clobberHeaders', 'junk', 'read'],</span>
<a href="#l20.853"></a><span id="l20.853" class="difflineplus">+  MAKE_MESSAGES_PROPAGATE: [&quot;attachments&quot;, &quot;body&quot;, &quot;cc&quot;, &quot;from&quot;, &quot;inReplyTo&quot;,</span>
<a href="#l20.854"></a><span id="l20.854" class="difflineplus">+                            &quot;subject&quot;, &quot;to&quot;, &quot;clobberHeaders&quot;, &quot;junk&quot;, &quot;read&quot;],</span>
<a href="#l20.855"></a><span id="l20.855">   /**</span>
<a href="#l20.856"></a><span id="l20.856">    * Given a set definition, produce a list of synthetic messages.</span>
<a href="#l20.857"></a><span id="l20.857">    *</span>
<a href="#l20.858"></a><span id="l20.858">    * The set definition supports the following attributes:</span>
<a href="#l20.859"></a><span id="l20.859">    *  count: The number of messages to create.</span>
<a href="#l20.860"></a><span id="l20.860">    *  age: As used by makeMessage.</span>
<a href="#l20.861"></a><span id="l20.861">    *  age_incr: Similar to age, but used to increment the values in the age</span>
<a href="#l20.862"></a><span id="l20.862">    *      dictionary (assuming a value of zero if omitted).</span>
<a href="#l20.863"></a><span id="l20.863" class="difflineat">@@ -1010,24 +1008,24 @@ MessageGenerator.prototype = {</span>
<a href="#l20.864"></a><span id="l20.864">    *</span>
<a href="#l20.865"></a><span id="l20.865">    * Also supported are the following attributes as defined by makeMessage:</span>
<a href="#l20.866"></a><span id="l20.866">    *  attachments, body, from, inReplyTo, subject, to, clobberHeaders, junk</span>
<a href="#l20.867"></a><span id="l20.867">    *</span>
<a href="#l20.868"></a><span id="l20.868">    * If omitted, the following defaults are used, but don't depend on this as we</span>
<a href="#l20.869"></a><span id="l20.869">    *  can change these at any time:</span>
<a href="#l20.870"></a><span id="l20.870">    * - count: 10</span>
<a href="#l20.871"></a><span id="l20.871">    */</span>
<a href="#l20.872"></a><span id="l20.872" class="difflineminus">-  makeMessages: function MessageGenerator_makeMessages(aSetDef) {</span>
<a href="#l20.873"></a><span id="l20.873" class="difflineplus">+  makeMessages(aSetDef) {</span>
<a href="#l20.874"></a><span id="l20.874">     let messages = [];</span>
<a href="#l20.875"></a><span id="l20.875"> </span>
<a href="#l20.876"></a><span id="l20.876">     let args = {};</span>
<a href="#l20.877"></a><span id="l20.877">     // zero out all the age_incr fields in age (if present)</span>
<a href="#l20.878"></a><span id="l20.878">     if (aSetDef.age_incr) {</span>
<a href="#l20.879"></a><span id="l20.879">       args.age = {};</span>
<a href="#l20.880"></a><span id="l20.880" class="difflineminus">-      for (let [unit, delta] of Object.entries(aSetDef.age_incr))</span>
<a href="#l20.881"></a><span id="l20.881" class="difflineplus">+      for (let unit of Object.keys(aSetDef.age_incr))</span>
<a href="#l20.882"></a><span id="l20.882">         args.age[unit] = 0;</span>
<a href="#l20.883"></a><span id="l20.883">     }</span>
<a href="#l20.884"></a><span id="l20.884">     // copy over the initial values from age (if present)</span>
<a href="#l20.885"></a><span id="l20.885">     if (aSetDef.age) {</span>
<a href="#l20.886"></a><span id="l20.886">       args.age = args.age || {};</span>
<a href="#l20.887"></a><span id="l20.887">       for (let [unit, value] of Object.entries(aSetDef.age))</span>
<a href="#l20.888"></a><span id="l20.888">         args.age[unit] = value;</span>
<a href="#l20.889"></a><span id="l20.889">     }</span>
<a href="#l20.890"></a><span id="l20.890" class="difflineat">@@ -1070,69 +1068,69 @@ MessageGenerator.prototype = {</span>
<a href="#l20.891"></a><span id="l20.891">  *</span>
<a href="#l20.892"></a><span id="l20.892">  * @param aMessageGenerator The optional message generator we should use.</span>
<a href="#l20.893"></a><span id="l20.893">  *     If you don't pass one, we create our own.  You would want to pass one so</span>
<a href="#l20.894"></a><span id="l20.894">  *     that if you also create synthetic messages directly via the message</span>
<a href="#l20.895"></a><span id="l20.895">  *     generator then the two sources can avoid duplicate use of the same</span>
<a href="#l20.896"></a><span id="l20.896">  *     names/addresses/subjects/message-ids.</span>
<a href="#l20.897"></a><span id="l20.897">  */</span>
<a href="#l20.898"></a><span id="l20.898"> function MessageScenarioFactory(aMessageGenerator) {</span>
<a href="#l20.899"></a><span id="l20.899" class="difflineminus">-  if(!aMessageGenerator)</span>
<a href="#l20.900"></a><span id="l20.900" class="difflineplus">+  if (!aMessageGenerator)</span>
<a href="#l20.901"></a><span id="l20.901">     aMessageGenerator = new MessageGenerator();</span>
<a href="#l20.902"></a><span id="l20.902">   this._msgGen = aMessageGenerator;</span>
<a href="#l20.903"></a><span id="l20.903"> }</span>
<a href="#l20.904"></a><span id="l20.904"> </span>
<a href="#l20.905"></a><span id="l20.905"> MessageScenarioFactory.prototype = {</span>
<a href="#l20.906"></a><span id="l20.906">   /** Create a chain of direct-reply messages of the given length. */</span>
<a href="#l20.907"></a><span id="l20.907" class="difflineminus">-  directReply: function(aNumMessages) {</span>
<a href="#l20.908"></a><span id="l20.908" class="difflineplus">+  directReply(aNumMessages) {</span>
<a href="#l20.909"></a><span id="l20.909">     aNumMessages = aNumMessages || 2;</span>
<a href="#l20.910"></a><span id="l20.910">     let messages = [this._msgGen.makeMessage()];</span>
<a href="#l20.911"></a><span id="l20.911">     for (let i = 1; i &lt; aNumMessages; i++) {</span>
<a href="#l20.912"></a><span id="l20.912" class="difflineminus">-      messages.push(this._msgGen.makeMessage({inReplyTo: messages[i-1]}));</span>
<a href="#l20.913"></a><span id="l20.913" class="difflineplus">+      messages.push(this._msgGen.makeMessage({inReplyTo: messages[i - 1]}));</span>
<a href="#l20.914"></a><span id="l20.914">     }</span>
<a href="#l20.915"></a><span id="l20.915">     return messages;</span>
<a href="#l20.916"></a><span id="l20.916">   },</span>
<a href="#l20.917"></a><span id="l20.917"> </span>
<a href="#l20.918"></a><span id="l20.918">   /** Two siblings (present), one parent (missing). */</span>
<a href="#l20.919"></a><span id="l20.919" class="difflineminus">-  siblingsMissingParent: function() {</span>
<a href="#l20.920"></a><span id="l20.920" class="difflineplus">+  siblingsMissingParent() {</span>
<a href="#l20.921"></a><span id="l20.921">     let missingParent = this._msgGen.makeMessage();</span>
<a href="#l20.922"></a><span id="l20.922">     let msg1 = this._msgGen.makeMessage({inReplyTo: missingParent});</span>
<a href="#l20.923"></a><span id="l20.923">     let msg2 = this._msgGen.makeMessage({inReplyTo: missingParent});</span>
<a href="#l20.924"></a><span id="l20.924">     return [msg1, msg2];</span>
<a href="#l20.925"></a><span id="l20.925">   },</span>
<a href="#l20.926"></a><span id="l20.926"> </span>
<a href="#l20.927"></a><span id="l20.927">   /** Present parent, missing child, present grand-child. */</span>
<a href="#l20.928"></a><span id="l20.928" class="difflineminus">-  missingIntermediary: function() {</span>
<a href="#l20.929"></a><span id="l20.929" class="difflineplus">+  missingIntermediary() {</span>
<a href="#l20.930"></a><span id="l20.930">     let msg1 = this._msgGen.makeMessage();</span>
<a href="#l20.931"></a><span id="l20.931">     let msg2 = this._msgGen.makeMessage({inReplyTo: msg1});</span>
<a href="#l20.932"></a><span id="l20.932">     let msg3 = this._msgGen.makeMessage({inReplyTo: msg2});</span>
<a href="#l20.933"></a><span id="l20.933">     return [msg1, msg3];</span>
<a href="#l20.934"></a><span id="l20.934">   },</span>
<a href="#l20.935"></a><span id="l20.935"> </span>
<a href="#l20.936"></a><span id="l20.936">   /**</span>
<a href="#l20.937"></a><span id="l20.937">    * The root message and all non-leaf nodes have aChildrenPerParent children,</span>
<a href="#l20.938"></a><span id="l20.938">    *  for a total of aHeight layers.  (If aHeight is 1, we have just the root;</span>
<a href="#l20.939"></a><span id="l20.939">    *  if aHeight is 2, the root and his aChildrePerParent children.)</span>
<a href="#l20.940"></a><span id="l20.940">    */</span>
<a href="#l20.941"></a><span id="l20.941" class="difflineminus">-  fullPyramid: function(aChildrenPerParent, aHeight) {</span>
<a href="#l20.942"></a><span id="l20.942" class="difflineplus">+  fullPyramid(aChildrenPerParent, aHeight) {</span>
<a href="#l20.943"></a><span id="l20.943">     let msgGen = this._msgGen;</span>
<a href="#l20.944"></a><span id="l20.944">     let root = msgGen.makeMessage();</span>
<a href="#l20.945"></a><span id="l20.945">     let messages = [root];</span>
<a href="#l20.946"></a><span id="l20.946">     function helper(aParent, aRemDepth) {</span>
<a href="#l20.947"></a><span id="l20.947">       for (let iChild = 0; iChild &lt; aChildrenPerParent; iChild++) {</span>
<a href="#l20.948"></a><span id="l20.948">         let child = msgGen.makeMessage({inReplyTo: aParent});</span>
<a href="#l20.949"></a><span id="l20.949">         messages.push(child);</span>
<a href="#l20.950"></a><span id="l20.950">         if (aRemDepth)</span>
<a href="#l20.951"></a><span id="l20.951">           helper(child, aRemDepth - 1);</span>
<a href="#l20.952"></a><span id="l20.952">       }</span>
<a href="#l20.953"></a><span id="l20.953">     }</span>
<a href="#l20.954"></a><span id="l20.954">     if (aHeight &gt; 1)</span>
<a href="#l20.955"></a><span id="l20.955">       helper(root, aHeight - 2);</span>
<a href="#l20.956"></a><span id="l20.956">     return messages;</span>
<a href="#l20.957"></a><span id="l20.957" class="difflineminus">-  }</span>
<a href="#l20.958"></a><span id="l20.958" class="difflineplus">+  },</span>
<a href="#l20.959"></a><span id="l20.959"> };</span>
<a href="#l20.960"></a><span id="l20.960"> </span>
<a href="#l20.961"></a><span id="l20.961"> /**</span>
<a href="#l20.962"></a><span id="l20.962">  * Decorate the given object's methods will python-style method binding.  We</span>
<a href="#l20.963"></a><span id="l20.963">  *  create a getter that returns a method that wraps the call, providing the</span>
<a href="#l20.964"></a><span id="l20.964">  *  actual method with the 'this' of the object that was 'this' when the getter</span>
<a href="#l20.965"></a><span id="l20.965">  *  was called.</span>
<a href="#l20.966"></a><span id="l20.966">  * Note that we don't follow the prototype chain; we only process the object you</span>
<a href="#l20.967"></a><span id="l20.967" class="difflineat">@@ -1145,16 +1143,16 @@ MessageScenarioFactory.prototype = {</span>
<a href="#l20.968"></a><span id="l20.968">  *     probably be your prototype object.</span>
<a href="#l20.969"></a><span id="l20.969">  */</span>
<a href="#l20.970"></a><span id="l20.970"> function bindMethods(aObj) {</span>
<a href="#l20.971"></a><span id="l20.971">   for (let [name, ubfunc] of Object.entries(aObj)) {</span>
<a href="#l20.972"></a><span id="l20.972">     // the variable binding needs to get captured...</span>
<a href="#l20.973"></a><span id="l20.973">     let realFunc = ubfunc;</span>
<a href="#l20.974"></a><span id="l20.974">     delete aObj[name];</span>
<a href="#l20.975"></a><span id="l20.975">     Object.defineProperty(aObj, name, {</span>
<a href="#l20.976"></a><span id="l20.976" class="difflineminus">-      get: function getterFunc() {</span>
<a href="#l20.977"></a><span id="l20.977" class="difflineplus">+      get() {</span>
<a href="#l20.978"></a><span id="l20.978">         return realFunc.bind(this);</span>
<a href="#l20.979"></a><span id="l20.979" class="difflineminus">-      }</span>
<a href="#l20.980"></a><span id="l20.980" class="difflineplus">+      },</span>
<a href="#l20.981"></a><span id="l20.981">     });</span>
<a href="#l20.982"></a><span id="l20.982">   }</span>
<a href="#l20.983"></a><span id="l20.983"> }</span>
<a href="#l20.984"></a><span id="l20.984"> </span>
<a href="#l20.985"></a><span id="l20.985"> bindMethods(MessageScenarioFactory.prototype);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/test/resources/messageInjection.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/test/resources/messageInjection.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,14 +1,29 @@</span>
<a href="#l21.4"></a><span id="l21.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.5"></a><span id="l21.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineplus">+</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineplus">+/* import-globals-from asyncTestUtils.js */</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineplus">+/* import-globals-from logHelper.js */</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineplus">+/* import-globals-from messageModifier.js */</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+// This file is included from many different locations. Why the original authors decided they</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+// could just dump variables on the global scope and expect them to be there when this file</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+// wanted them, I have no idea.</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+/* globals createPop3ServerAndLocalFolders, gDEPTH, get_nsIMsgFolder, ims, POP3_PORT, setupServerDaemon */</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+// ChromeUtils.import should be used for this, but it breaks mozmill.</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+// Assume whatever test loaded this file already has mailTestUtils.</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+/* globals mailTestUtils */</span>
<a href="#l21.21"></a><span id="l21.21"> </span>
<a href="#l21.22"></a><span id="l21.22"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l21.23"></a><span id="l21.23"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+var {toXPCOMArray} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+</span>
<a href="#l21.26"></a><span id="l21.26"> var imapMessage;</span>
<a href="#l21.27"></a><span id="l21.27"> try {</span>
<a href="#l21.28"></a><span id="l21.28">   var temp = ChromeUtils.import(&quot;resource://testing-common/mailnews/imapd.js&quot;);</span>
<a href="#l21.29"></a><span id="l21.29">   imapMessage = temp.imapMessage;</span>
<a href="#l21.30"></a><span id="l21.30"> } catch (e) {</span>
<a href="#l21.31"></a><span id="l21.31">   // mozmill tests include this file, but they don't have testing-only modules</span>
<a href="#l21.32"></a><span id="l21.32">   // loaded. In this case, they don't get to use IMAP.</span>
<a href="#l21.33"></a><span id="l21.33"> }</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineat">@@ -59,24 +74,22 @@ function configure_message_injection(aIn</span>
<a href="#l21.35"></a><span id="l21.35">     mis.server._logTransactions = false;</span>
<a href="#l21.36"></a><span id="l21.36"> </span>
<a href="#l21.37"></a><span id="l21.37">     mis.rootFolder = mis.incomingServer.rootMsgFolder;</span>
<a href="#l21.38"></a><span id="l21.38">     mis.inboxFolder = mis.rootFolder.getChildNamed(&quot;Inbox&quot;);</span>
<a href="#l21.39"></a><span id="l21.39"> </span>
<a href="#l21.40"></a><span id="l21.40">     mis.pop3Service = MailServices.pop3;</span>
<a href="#l21.41"></a><span id="l21.41"> </span>
<a href="#l21.42"></a><span id="l21.42">     mis.server.start(POP3_PORT);</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-  }</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-  else if (mis.injectionConfig.mode == &quot;local&quot;) {</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+  } else if (mis.injectionConfig.mode == &quot;local&quot;) {</span>
<a href="#l21.46"></a><span id="l21.46">     // This does createIncomingServer() and createAccount(), sets the server as</span>
<a href="#l21.47"></a><span id="l21.47">     //  the account's server, then sets the server</span>
<a href="#l21.48"></a><span id="l21.48">     try {</span>
<a href="#l21.49"></a><span id="l21.49">       MailServices.accounts.createLocalMailAccount();</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-    }</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineminus">-    catch (ex) {</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+    } catch (ex) {</span>
<a href="#l21.53"></a><span id="l21.53">       // This will fail if someone already called this.  Like in the mozmill</span>
<a href="#l21.54"></a><span id="l21.54">       //  case.</span>
<a href="#l21.55"></a><span id="l21.55">     }</span>
<a href="#l21.56"></a><span id="l21.56"> </span>
<a href="#l21.57"></a><span id="l21.57">     let localAccount = MailServices.accounts.FindAccountForServer(MailServices.accounts.localFoldersServer);</span>
<a href="#l21.58"></a><span id="l21.58"> </span>
<a href="#l21.59"></a><span id="l21.59">     // We need an identity or we get angry warnings.</span>
<a href="#l21.60"></a><span id="l21.60">     let identity = MailServices.accounts.createIdentity();</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineat">@@ -94,44 +107,42 @@ function configure_message_injection(aIn</span>
<a href="#l21.62"></a><span id="l21.62">     mis.inboxFolder = mis.rootFolder.getChildNamed(&quot;Inbox&quot;);</span>
<a href="#l21.63"></a><span id="l21.63">     // a local inbox should have a Mail flag!</span>
<a href="#l21.64"></a><span id="l21.64">     mis.inboxFolder.setFlag(Ci.nsMsgFolderFlags.Mail);</span>
<a href="#l21.65"></a><span id="l21.65">     mis.inboxFolder.setFlag(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l21.66"></a><span id="l21.66">     _messageInjectionSetup.notifyListeners(&quot;onRealFolderCreated&quot;,</span>
<a href="#l21.67"></a><span id="l21.67">                                            [mis.inboxFolder]);</span>
<a href="#l21.68"></a><span id="l21.68"> </span>
<a href="#l21.69"></a><span id="l21.69">     // Force an initialization of the Inbox folder database.</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineminus">-    let unused = mis.inboxFolder.prettyName;</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineminus">-  }</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineminus">-  else if (mis.injectionConfig.mode == &quot;imap&quot;) {</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineplus">+    mis.inboxFolder.prettyName;</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineplus">+  } else if (mis.injectionConfig.mode == &quot;imap&quot;) {</span>
<a href="#l21.75"></a><span id="l21.75">     // Disable autosync in favor of our explicitly forcing downloads of all</span>
<a href="#l21.76"></a><span id="l21.76">     //  messages in a folder.  This is being done speculatively because when we</span>
<a href="#l21.77"></a><span id="l21.77">     //  didn't do this we got tripped up by the semaphore being in use and</span>
<a href="#l21.78"></a><span id="l21.78">     //  concern over inability to hang a listener off of the completion of the</span>
<a href="#l21.79"></a><span id="l21.79">     //  download.  (Although I'm sure there are various ways we could do it.)</span>
<a href="#l21.80"></a><span id="l21.80">     Services.prefs.setBoolPref(&quot;mail.server.default.autosync_offline_stores&quot;,</span>
<a href="#l21.81"></a><span id="l21.81">                                false);</span>
<a href="#l21.82"></a><span id="l21.82">     // Set the offline property based on the configured setting.  This will</span>
<a href="#l21.83"></a><span id="l21.83">     //  affect newly created folders.</span>
<a href="#l21.84"></a><span id="l21.84">     Services.prefs.setBoolPref(&quot;mail.server.default.offline_download&quot;,</span>
<a href="#l21.85"></a><span id="l21.85">                                mis.injectionConfig.offline);</span>
<a href="#l21.86"></a><span id="l21.86"> </span>
<a href="#l21.87"></a><span id="l21.87">     // Pull in the IMAP fake server code</span>
<a href="#l21.88"></a><span id="l21.88">     let {</span>
<a href="#l21.89"></a><span id="l21.89">       IMAPPump,</span>
<a href="#l21.90"></a><span id="l21.90">       setupIMAPPump,</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineminus">-      teardownIMAPPump,</span>
<a href="#l21.92"></a><span id="l21.92">     } = ChromeUtils.import(&quot;resource://testing-common/mailnews/IMAPpump.js&quot;);</span>
<a href="#l21.93"></a><span id="l21.93"> </span>
<a href="#l21.94"></a><span id="l21.94">     // set up IMAP fakeserver and incoming server</span>
<a href="#l21.95"></a><span id="l21.95">     setupIMAPPump(&quot;&quot;);</span>
<a href="#l21.96"></a><span id="l21.96">     mis.daemon = IMAPPump.daemon;</span>
<a href="#l21.97"></a><span id="l21.97">     mis.server = IMAPPump.server;</span>
<a href="#l21.98"></a><span id="l21.98">     mis.incomingServer = IMAPPump.incomingServer;</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineminus">-    //mis.server._debug = 3;</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineplus">+    // mis.server._debug = 3;</span>
<a href="#l21.101"></a><span id="l21.101"> </span>
<a href="#l21.102"></a><span id="l21.102">     // do not log transactions; it's just a memory leak to us</span>
<a href="#l21.103"></a><span id="l21.103">     mis.server._logTransactions = false;</span>
<a href="#l21.104"></a><span id="l21.104"> </span>
<a href="#l21.105"></a><span id="l21.105">     // We need an identity so that updateFolder doesn't fail</span>
<a href="#l21.106"></a><span id="l21.106">     let localAccount = MailServices.accounts.defaultAccount;</span>
<a href="#l21.107"></a><span id="l21.107">     // We need an email to protect against random code assuming it exists and</span>
<a href="#l21.108"></a><span id="l21.108">     // throwing exceptions.</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineat">@@ -157,18 +168,17 @@ function configure_message_injection(aIn</span>
<a href="#l21.110"></a><span id="l21.110"> </span>
<a href="#l21.111"></a><span id="l21.111">     mis.imapService = MailServices.imap;</span>
<a href="#l21.112"></a><span id="l21.112"> </span>
<a href="#l21.113"></a><span id="l21.113">     mis.handleUriToRealFolder = {};</span>
<a href="#l21.114"></a><span id="l21.114">     mis.handleUriToFakeFolder = {};</span>
<a href="#l21.115"></a><span id="l21.115">     mis.realUriToFakeFolder = {};</span>
<a href="#l21.116"></a><span id="l21.116">     mis.realUriToFakeFolder[mis.inboxFolder.URI] =</span>
<a href="#l21.117"></a><span id="l21.117">       mis.daemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineminus">-  }</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineminus">-  else {</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineplus">+  } else {</span>
<a href="#l21.121"></a><span id="l21.121">     do_throw(&quot;Illegal injection config option: &quot; + mis.injectionConfig.mode);</span>
<a href="#l21.122"></a><span id="l21.122">   }</span>
<a href="#l21.123"></a><span id="l21.123"> </span>
<a href="#l21.124"></a><span id="l21.124">   mis.junkHandle = null;</span>
<a href="#l21.125"></a><span id="l21.125">   mis.junkFolder = null;</span>
<a href="#l21.126"></a><span id="l21.126"> </span>
<a href="#l21.127"></a><span id="l21.127">   mis.trashHandle = null;</span>
<a href="#l21.128"></a><span id="l21.128">   mis.trashFolder = null;</span>
<a href="#l21.129"></a><span id="l21.129" class="difflineat">@@ -202,17 +212,17 @@ function _cleanup_message_injection() {</span>
<a href="#l21.130"></a><span id="l21.130"> </span>
<a href="#l21.131"></a><span id="l21.131"> var _messageInjectionSetup = {</span>
<a href="#l21.132"></a><span id="l21.132">   _nextUniqueFolderId: 0,</span>
<a href="#l21.133"></a><span id="l21.133"> </span>
<a href="#l21.134"></a><span id="l21.134">   injectionConfig: {</span>
<a href="#l21.135"></a><span id="l21.135">     mode: &quot;none&quot;,</span>
<a href="#l21.136"></a><span id="l21.136">   },</span>
<a href="#l21.137"></a><span id="l21.137">   listeners: [],</span>
<a href="#l21.138"></a><span id="l21.138" class="difflineminus">-  notifyListeners: function(aHandlerName, aArgs) {</span>
<a href="#l21.139"></a><span id="l21.139" class="difflineplus">+  notifyListeners(aHandlerName, aArgs) {</span>
<a href="#l21.140"></a><span id="l21.140">     for (let listener of this.listeners) {</span>
<a href="#l21.141"></a><span id="l21.141">       if (aHandlerName in listener)</span>
<a href="#l21.142"></a><span id="l21.142">         listener[aHandlerName].apply(listener, aArgs);</span>
<a href="#l21.143"></a><span id="l21.143">     }</span>
<a href="#l21.144"></a><span id="l21.144">   },</span>
<a href="#l21.145"></a><span id="l21.145"> </span>
<a href="#l21.146"></a><span id="l21.146">   /**</span>
<a href="#l21.147"></a><span id="l21.147">    * The nsIMsgIncomingServer</span>
<a href="#l21.148"></a><span id="l21.148" class="difflineat">@@ -302,18 +312,17 @@ function make_empty_folder(aFolderName, </span>
<a href="#l21.149"></a><span id="l21.149">     testFolder.setFlag(Ci.nsMsgFolderFlags.Mail);</span>
<a href="#l21.150"></a><span id="l21.150">     if (aSpecialFlags) {</span>
<a href="#l21.151"></a><span id="l21.151">       for (let flag of aSpecialFlags) {</span>
<a href="#l21.152"></a><span id="l21.152">         testFolder.setFlag(flag);</span>
<a href="#l21.153"></a><span id="l21.153">       }</span>
<a href="#l21.154"></a><span id="l21.154">     }</span>
<a href="#l21.155"></a><span id="l21.155">     _messageInjectionSetup.notifyListeners(&quot;onRealFolderCreated&quot;,</span>
<a href="#l21.156"></a><span id="l21.156">                                            [testFolder]);</span>
<a href="#l21.157"></a><span id="l21.157" class="difflineminus">-  }</span>
<a href="#l21.158"></a><span id="l21.158" class="difflineminus">-  else if (mis.injectionConfig.mode == &quot;imap&quot;) {</span>
<a href="#l21.159"></a><span id="l21.159" class="difflineplus">+  } else if (mis.injectionConfig.mode == &quot;imap&quot;) {</span>
<a href="#l21.160"></a><span id="l21.160">     let promise_completed = async_create_promise();</span>
<a href="#l21.161"></a><span id="l21.161"> </span>
<a href="#l21.162"></a><span id="l21.162">     testFolder = mis.rootFolder.URI + &quot;/&quot; + aFolderName;</span>
<a href="#l21.163"></a><span id="l21.163"> </span>
<a href="#l21.164"></a><span id="l21.164">     // Tell the IMAP service to create the folder, adding a listener that</span>
<a href="#l21.165"></a><span id="l21.165">     //  hooks up the 'handle' URI -&gt; actual folder mapping.</span>
<a href="#l21.166"></a><span id="l21.166">     mis.imapService.createFolder(</span>
<a href="#l21.167"></a><span id="l21.167">       mis.rootFolder,</span>
<a href="#l21.168"></a><span id="l21.168" class="difflineat">@@ -340,37 +349,36 @@ function make_empty_folder(aFolderName, </span>
<a href="#l21.169"></a><span id="l21.169">         mis.handleUriToRealFolder[testFolder] = msgFolder;</span>
<a href="#l21.170"></a><span id="l21.170">         mis.handleUriToFakeFolder[testFolder] = fakeFolder;</span>
<a href="#l21.171"></a><span id="l21.171">         mis.realUriToFakeFolder[msgFolder.URI] = fakeFolder;</span>
<a href="#l21.172"></a><span id="l21.172"> </span>
<a href="#l21.173"></a><span id="l21.173">         // notify listeners</span>
<a href="#l21.174"></a><span id="l21.174">         _messageInjectionSetup.notifyListeners(&quot;onRealFolderCreated&quot;,</span>
<a href="#l21.175"></a><span id="l21.175">                                                [msgFolder]);</span>
<a href="#l21.176"></a><span id="l21.176">       }, promise_completed));</span>
<a href="#l21.177"></a><span id="l21.177" class="difflineminus">-   }</span>
<a href="#l21.178"></a><span id="l21.178" class="difflineminus">-  else if (_messageInjectionSetup.injectionConfig.mode == &quot;pop&quot;) {</span>
<a href="#l21.179"></a><span id="l21.179" class="difflineplus">+  } else if (_messageInjectionSetup.injectionConfig.mode == &quot;pop&quot;) {</span>
<a href="#l21.180"></a><span id="l21.180">     throw new Error(&quot;You cannot create new folders for POP, I assume.\n&quot;);</span>
<a href="#l21.181"></a><span id="l21.181">   }</span>
<a href="#l21.182"></a><span id="l21.182"> </span>
<a href="#l21.183"></a><span id="l21.183">   return testFolder;</span>
<a href="#l21.184"></a><span id="l21.184"> }</span>
<a href="#l21.185"></a><span id="l21.185"> </span>
<a href="#l21.186"></a><span id="l21.186"> // Small helper for moving folder. You have to yield move_folder(f1, f2);</span>
<a href="#l21.187"></a><span id="l21.187"> function move_folder(aSource, aTarget) {</span>
<a href="#l21.188"></a><span id="l21.188">   let array = toXPCOMArray([get_nsIMsgFolder(aSource)], Ci.nsIMutableArray);</span>
<a href="#l21.189"></a><span id="l21.189">   // we're doing a true move</span>
<a href="#l21.190"></a><span id="l21.190">   MailServices.copy.CopyFolders(array, get_nsIMsgFolder(aTarget), true, {</span>
<a href="#l21.191"></a><span id="l21.191">     /* nsIMsgCopyServiceListener implementation */</span>
<a href="#l21.192"></a><span id="l21.192" class="difflineminus">-    OnStartCopy: function() {},</span>
<a href="#l21.193"></a><span id="l21.193" class="difflineminus">-    OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l21.194"></a><span id="l21.194" class="difflineminus">-    SetMessageKey: function(aKey) {},</span>
<a href="#l21.195"></a><span id="l21.195" class="difflineminus">-    SetMessageId: function(aMessageId) {},</span>
<a href="#l21.196"></a><span id="l21.196" class="difflineminus">-    OnStopCopy: function(aStatus) {</span>
<a href="#l21.197"></a><span id="l21.197" class="difflineplus">+    OnStartCopy() {},</span>
<a href="#l21.198"></a><span id="l21.198" class="difflineplus">+    OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l21.199"></a><span id="l21.199" class="difflineplus">+    SetMessageKey(aKey) {},</span>
<a href="#l21.200"></a><span id="l21.200" class="difflineplus">+    SetMessageId(aMessageId) {},</span>
<a href="#l21.201"></a><span id="l21.201" class="difflineplus">+    OnStopCopy(aStatus) {</span>
<a href="#l21.202"></a><span id="l21.202">       async_driver();</span>
<a href="#l21.203"></a><span id="l21.203" class="difflineminus">-    }</span>
<a href="#l21.204"></a><span id="l21.204" class="difflineplus">+    },</span>
<a href="#l21.205"></a><span id="l21.205">   }, null);</span>
<a href="#l21.206"></a><span id="l21.206"> </span>
<a href="#l21.207"></a><span id="l21.207">   // Wait for the call above to async_driver to be issued</span>
<a href="#l21.208"></a><span id="l21.208">   return false;</span>
<a href="#l21.209"></a><span id="l21.209"> }</span>
<a href="#l21.210"></a><span id="l21.210"> </span>
<a href="#l21.211"></a><span id="l21.211"> /**</span>
<a href="#l21.212"></a><span id="l21.212">  * Get/create the junk folder handle.  Use get_real_injection_folder if you</span>
<a href="#l21.213"></a><span id="l21.213" class="difflineat">@@ -397,18 +405,17 @@ function get_trash_folder() {</span>
<a href="#l21.214"></a><span id="l21.214">     mis.trashFolder = mis.rootFolder.getFolderWithFlags(</span>
<a href="#l21.215"></a><span id="l21.215">                         Ci.nsMsgFolderFlags.Trash);</span>
<a href="#l21.216"></a><span id="l21.216">     if (mis.trashFolder) {</span>
<a href="#l21.217"></a><span id="l21.217">       mis.trashHandle = mis.rootFolder.URI + &quot;/Trash&quot;;</span>
<a href="#l21.218"></a><span id="l21.218">       let fakeFolder = mis.daemon.getMailbox(&quot;Trash&quot;);</span>
<a href="#l21.219"></a><span id="l21.219">       mis.handleUriToRealFolder[mis.trashHandle] = mis.trashFolder;</span>
<a href="#l21.220"></a><span id="l21.220">       mis.handleUriToFakeFolder[mis.trashHandle] = fakeFolder;</span>
<a href="#l21.221"></a><span id="l21.221">       mis.realUriToFakeFolder[mis.trashFolder.URI] = fakeFolder;</span>
<a href="#l21.222"></a><span id="l21.222" class="difflineminus">-    }</span>
<a href="#l21.223"></a><span id="l21.223" class="difflineminus">-    else {</span>
<a href="#l21.224"></a><span id="l21.224" class="difflineplus">+    } else {</span>
<a href="#l21.225"></a><span id="l21.225">       mis.trashHandle = make_empty_folder(&quot;Trash&quot;, [Ci.nsMsgFolderFlags.Trash]);</span>
<a href="#l21.226"></a><span id="l21.226">     }</span>
<a href="#l21.227"></a><span id="l21.227">   }</span>
<a href="#l21.228"></a><span id="l21.228"> </span>
<a href="#l21.229"></a><span id="l21.229">   return mis.trashHandle;</span>
<a href="#l21.230"></a><span id="l21.230"> }</span>
<a href="#l21.231"></a><span id="l21.231"> </span>
<a href="#l21.232"></a><span id="l21.232"> /**</span>
<a href="#l21.233"></a><span id="l21.233" class="difflineat">@@ -449,16 +456,17 @@ function make_virtual_folder(aFolders, a</span>
<a href="#l21.234"></a><span id="l21.234">   }</span>
<a href="#l21.235"></a><span id="l21.235">   // create an ALL case if we didn't add any terms</span>
<a href="#l21.236"></a><span id="l21.236">   if (terms.length == 0) {</span>
<a href="#l21.237"></a><span id="l21.237">     let term = termCreator.createTerm();</span>
<a href="#l21.238"></a><span id="l21.238">     term.matchAll = true;</span>
<a href="#l21.239"></a><span id="l21.239">     terms.push(term);</span>
<a href="#l21.240"></a><span id="l21.240">   }</span>
<a href="#l21.241"></a><span id="l21.241"> </span>
<a href="#l21.242"></a><span id="l21.242" class="difflineplus">+  let {VirtualFolderHelper} = ChromeUtils.import(&quot;resource:///modules/virtualFolderWrapper.js&quot;);</span>
<a href="#l21.243"></a><span id="l21.243">   let wrapped = VirtualFolderHelper.createNewVirtualFolder(</span>
<a href="#l21.244"></a><span id="l21.244">     name, mis.rootFolder, aFolders, terms,</span>
<a href="#l21.245"></a><span id="l21.245">     /* online */ false);</span>
<a href="#l21.246"></a><span id="l21.246">   _messageInjectionSetup.notifyListeners(&quot;onVirtualFolderCreated&quot;,</span>
<a href="#l21.247"></a><span id="l21.247">                                          [wrapped.virtualFolder]);</span>
<a href="#l21.248"></a><span id="l21.248">   return wrapped.virtualFolder;</span>
<a href="#l21.249"></a><span id="l21.249"> }</span>
<a href="#l21.250"></a><span id="l21.250"> </span>
<a href="#l21.251"></a><span id="l21.251" class="difflineat">@@ -572,17 +580,17 @@ var make_new_sets_in_folder = make_new_s</span>
<a href="#l21.252"></a><span id="l21.252"> </span>
<a href="#l21.253"></a><span id="l21.253"> /**</span>
<a href="#l21.254"></a><span id="l21.254">  * An iterator that generates an infinite sequence of its argument.  So</span>
<a href="#l21.255"></a><span id="l21.255">  *  _looperator(1, 2, 3) will generate the iteration stream: [1, 2, 3, 1, 2, 3,</span>
<a href="#l21.256"></a><span id="l21.256">  *  1, 2, 3, ...].  For use by add_sets_across_folders.</span>
<a href="#l21.257"></a><span id="l21.257">  */</span>
<a href="#l21.258"></a><span id="l21.258"> function* _looperator(aList) {</span>
<a href="#l21.259"></a><span id="l21.259">   if (aList.length == 0)</span>
<a href="#l21.260"></a><span id="l21.260" class="difflineminus">-    throw new Exception(&quot;aList must have at least one item!&quot;);</span>
<a href="#l21.261"></a><span id="l21.261" class="difflineplus">+    throw new Error(&quot;aList must have at least one item!&quot;);</span>
<a href="#l21.262"></a><span id="l21.262"> </span>
<a href="#l21.263"></a><span id="l21.263">   let i = 0, length = aList.length;</span>
<a href="#l21.264"></a><span id="l21.264">   while (true) {</span>
<a href="#l21.265"></a><span id="l21.265">     yield aList[i];</span>
<a href="#l21.266"></a><span id="l21.266">     i = (i + 1) % length;</span>
<a href="#l21.267"></a><span id="l21.267">   }</span>
<a href="#l21.268"></a><span id="l21.268"> }</span>
<a href="#l21.269"></a><span id="l21.269"> </span>
<a href="#l21.270"></a><span id="l21.270" class="difflineat">@@ -616,76 +624,68 @@ function* _looperator(aList) {</span>
<a href="#l21.271"></a><span id="l21.271">  *     not want this and so will want to pass true for this argument.</span>
<a href="#l21.272"></a><span id="l21.272">  *</span>
<a href="#l21.273"></a><span id="l21.273">  * @return true if we were able to do the injection synchronously (e.g. for</span>
<a href="#l21.274"></a><span id="l21.274">  *     a localstore account), false if we kicked off an asynchronous process</span>
<a href="#l21.275"></a><span id="l21.275">  *     (e.g. for an imap account) and we will call |async_driver| when</span>
<a href="#l21.276"></a><span id="l21.276">  *     we are done.  This is consistent with asyncTestUtils support.</span>
<a href="#l21.277"></a><span id="l21.277">  */</span>
<a href="#l21.278"></a><span id="l21.278"> function add_sets_to_folders(aMsgFolders, aMessageSets, aDoNotForceUpdate) {</span>
<a href="#l21.279"></a><span id="l21.279" class="difflineminus">-  if ((typeof(aMsgFolders) == &quot;string&quot;) || !('length' in aMsgFolders))</span>
<a href="#l21.280"></a><span id="l21.280" class="difflineplus">+  if ((typeof(aMsgFolders) == &quot;string&quot;) || !(&quot;length&quot; in aMsgFolders))</span>
<a href="#l21.281"></a><span id="l21.281">     aMsgFolders = [aMsgFolders];</span>
<a href="#l21.282"></a><span id="l21.282"> </span>
<a href="#l21.283"></a><span id="l21.283">   let mis = _messageInjectionSetup;</span>
<a href="#l21.284"></a><span id="l21.284"> </span>
<a href="#l21.285"></a><span id="l21.285" class="difflineminus">-  let iterFolders, folderList;</span>
<a href="#l21.286"></a><span id="l21.286" class="difflineminus">-  let popMessages, msgHdrs;</span>
<a href="#l21.287"></a><span id="l21.287" class="difflineplus">+  let iterFolders;</span>
<a href="#l21.288"></a><span id="l21.288" class="difflineplus">+  let popMessages;</span>
<a href="#l21.289"></a><span id="l21.289"> </span>
<a href="#l21.290"></a><span id="l21.290">   _messageInjectionSetup.notifyListeners(&quot;onInjectingMessages&quot;, []);</span>
<a href="#l21.291"></a><span id="l21.291"> </span>
<a href="#l21.292"></a><span id="l21.292">   // -- Pre-loop</span>
<a href="#l21.293"></a><span id="l21.293">   if (mis.injectionConfig.mode == &quot;local&quot;) {</span>
<a href="#l21.294"></a><span id="l21.294">     for (let folder of aMsgFolders) {</span>
<a href="#l21.295"></a><span id="l21.295">       if (!(folder instanceof Ci.nsIMsgLocalMailFolder))</span>
<a href="#l21.296"></a><span id="l21.296" class="difflineminus">-        throw new Exception(&quot;All folders in aMsgFolders must be local folders!&quot;);</span>
<a href="#l21.297"></a><span id="l21.297" class="difflineplus">+        throw new Error(&quot;All folders in aMsgFolders must be local folders!&quot;);</span>
<a href="#l21.298"></a><span id="l21.298">     }</span>
<a href="#l21.299"></a><span id="l21.299" class="difflineminus">-    folderList = aMsgFolders;</span>
<a href="#l21.300"></a><span id="l21.300" class="difflineminus">-  }</span>
<a href="#l21.301"></a><span id="l21.301" class="difflineminus">-  else if (mis.injectionConfig.mode == &quot;imap&quot;) {</span>
<a href="#l21.302"></a><span id="l21.302" class="difflineplus">+  } else if (mis.injectionConfig.mode == &quot;imap&quot;) {</span>
<a href="#l21.303"></a><span id="l21.303">     // no protection is possible because of our dependency on promises,</span>
<a href="#l21.304"></a><span id="l21.304">     //  although we could check that the fake URL is one we handed out.</span>
<a href="#l21.305"></a><span id="l21.305" class="difflineminus">-    folderList = aMsgFolders;</span>
<a href="#l21.306"></a><span id="l21.306" class="difflineminus">-  }</span>
<a href="#l21.307"></a><span id="l21.307" class="difflineminus">-  else if (mis.injectionConfig.mode == &quot;pop&quot;) {</span>
<a href="#l21.308"></a><span id="l21.308" class="difflineplus">+  } else if (mis.injectionConfig.mode == &quot;pop&quot;) {</span>
<a href="#l21.309"></a><span id="l21.309">     for (let folder of aMsgFolders) {</span>
<a href="#l21.310"></a><span id="l21.310">       if (folder.URI != mis.inboxFolder.URI)</span>
<a href="#l21.311"></a><span id="l21.311" class="difflineminus">-        throw new Exception(&quot;We only support the Inbox for POP injection&quot;);</span>
<a href="#l21.312"></a><span id="l21.312" class="difflineplus">+        throw new Error(&quot;We only support the Inbox for POP injection&quot;);</span>
<a href="#l21.313"></a><span id="l21.313">     }</span>
<a href="#l21.314"></a><span id="l21.314" class="difflineminus">-    folderList = aMsgFolders;</span>
<a href="#l21.315"></a><span id="l21.315"> </span>
<a href="#l21.316"></a><span id="l21.316">     // ugh, so this is really a degenerate case where everything we do is</span>
<a href="#l21.317"></a><span id="l21.317">     //  overkill, but let's try this at least.</span>
<a href="#l21.318"></a><span id="l21.318">     popMessages = [];</span>
<a href="#l21.319"></a><span id="l21.319" class="difflineminus">-  }</span>
<a href="#l21.320"></a><span id="l21.320" class="difflineminus">-  else {</span>
<a href="#l21.321"></a><span id="l21.321" class="difflineplus">+  } else {</span>
<a href="#l21.322"></a><span id="l21.322">     do_throw(&quot;Message injection is not configured!&quot;);</span>
<a href="#l21.323"></a><span id="l21.323">   }</span>
<a href="#l21.324"></a><span id="l21.324"> </span>
<a href="#l21.325"></a><span id="l21.325">   if (mis.injectionConfig.mode == &quot;local&quot;) {</span>
<a href="#l21.326"></a><span id="l21.326">     // Note: in order to cut down on excessive fsync()s, we do a two-pass</span>
<a href="#l21.327"></a><span id="l21.327">     //  approach.  In the first pass we just allocate messages to the folder</span>
<a href="#l21.328"></a><span id="l21.328">     //  we are going to insert them into.  In the second pass we insert the</span>
<a href="#l21.329"></a><span id="l21.329">     //  messages into folders in batches and perform any mutations.</span>
<a href="#l21.330"></a><span id="l21.330" class="difflineminus">-    let folderBatches = aMsgFolders.map(folder =&gt;</span>
<a href="#l21.331"></a><span id="l21.331" class="difflineminus">-                                        new Object({folder: folder, messages: []}));</span>
<a href="#l21.332"></a><span id="l21.332" class="difflineplus">+    let folderBatches = aMsgFolders.map(folder =&gt; { return {folder, messages: []}; });</span>
<a href="#l21.333"></a><span id="l21.333">     iterFolders = _looperator([...folderBatches.keys()]);</span>
<a href="#l21.334"></a><span id="l21.334">     let iPerSet = 0, folderNext = iterFolders.next();</span>
<a href="#l21.335"></a><span id="l21.335"> </span>
<a href="#l21.336"></a><span id="l21.336">     // - allocate messages to folders</span>
<a href="#l21.337"></a><span id="l21.337">     // loop, incrementing our subscript until all message sets are out of messages</span>
<a href="#l21.338"></a><span id="l21.338">     let didSomething;</span>
<a href="#l21.339"></a><span id="l21.339">     do {</span>
<a href="#l21.340"></a><span id="l21.340">       didSomething = false;</span>
<a href="#l21.341"></a><span id="l21.341">       // for each message set, if it is not out of messages, add the message</span>
<a href="#l21.342"></a><span id="l21.342">       for (let messageSet of aMessageSets) {</span>
<a href="#l21.343"></a><span id="l21.343">         if (iPerSet &lt; messageSet.synMessages.length) {</span>
<a href="#l21.344"></a><span id="l21.344">           let synMsg = messageSet._trackMessageAddition(folderBatches[folderNext.value].folder,</span>
<a href="#l21.345"></a><span id="l21.345">                                                         iPerSet);</span>
<a href="#l21.346"></a><span id="l21.346" class="difflineminus">-          folderBatches[folderNext.value].messages.push({ messageSet: messageSet, synMsg: synMsg,</span>
<a href="#l21.347"></a><span id="l21.347" class="difflineminus">-                                    index: iPerSet });</span>
<a href="#l21.348"></a><span id="l21.348" class="difflineplus">+          folderBatches[folderNext.value].messages.push({ messageSet, synMsg, index: iPerSet });</span>
<a href="#l21.349"></a><span id="l21.349">           didSomething = true;</span>
<a href="#l21.350"></a><span id="l21.350">         }</span>
<a href="#l21.351"></a><span id="l21.351">       }</span>
<a href="#l21.352"></a><span id="l21.352">       iPerSet++;</span>
<a href="#l21.353"></a><span id="l21.353">       folderNext = iterFolders.next();</span>
<a href="#l21.354"></a><span id="l21.354">     } while (didSomething);</span>
<a href="#l21.355"></a><span id="l21.355"> </span>
<a href="#l21.356"></a><span id="l21.356">     // - inject messages</span>
<a href="#l21.357"></a><span id="l21.357" class="difflineat">@@ -710,42 +710,39 @@ function add_sets_to_folders(aMsgFolders</span>
<a href="#l21.358"></a><span id="l21.358">         if (synMsgState.read) {</span>
<a href="#l21.359"></a><span id="l21.359">           // XXX this will generate an event; I'm not sure if we should be</span>
<a href="#l21.360"></a><span id="l21.360">           //  trying to avoid that or not.  This case is really only added</span>
<a href="#l21.361"></a><span id="l21.361">           //  for IMAP where this makes more sense.</span>
<a href="#l21.362"></a><span id="l21.362">           message.messageSet.setRead(true,</span>
<a href="#l21.363"></a><span id="l21.363">             message.messageSet.getMsgHdr(message.index));</span>
<a href="#l21.364"></a><span id="l21.364">         }</span>
<a href="#l21.365"></a><span id="l21.365">       }</span>
<a href="#l21.366"></a><span id="l21.366" class="difflineminus">-      if (folderBatch.messages.length)</span>
<a href="#l21.367"></a><span id="l21.367" class="difflineminus">-      {</span>
<a href="#l21.368"></a><span id="l21.368" class="difflineminus">-        let lastMRUTime = Math.floor(Number(folderBatch.messages[0].synMsg.date)</span>
<a href="#l21.369"></a><span id="l21.369" class="difflineminus">-                                     / 1000);</span>
<a href="#l21.370"></a><span id="l21.370" class="difflineplus">+      if (folderBatch.messages.length) {</span>
<a href="#l21.371"></a><span id="l21.371" class="difflineplus">+        let lastMRUTime = Math.floor(Number(folderBatch.messages[0].synMsg.date) / 1000);</span>
<a href="#l21.372"></a><span id="l21.372">         folder.setStringProperty(&quot;MRUTime&quot;, lastMRUTime);</span>
<a href="#l21.373"></a><span id="l21.373">       }</span>
<a href="#l21.374"></a><span id="l21.374">       folder.gettingNewMessages = false;</span>
<a href="#l21.375"></a><span id="l21.375">       folder.hasNewMessages = true;</span>
<a href="#l21.376"></a><span id="l21.376">       folder.setNumNewMessages(folder.getNumNewMessages(false)</span>
<a href="#l21.377"></a><span id="l21.377">                                + messageStrings.length);</span>
<a href="#l21.378"></a><span id="l21.378">       folder.biffState = Ci.nsIMsgFolder.nsMsgBiffState_NewMail;</span>
<a href="#l21.379"></a><span id="l21.379">     }</span>
<a href="#l21.380"></a><span id="l21.380"> </span>
<a href="#l21.381"></a><span id="l21.381">     // make sure that junk filtering gets a turn</span>
<a href="#l21.382"></a><span id="l21.382">     // XXX we probably need to be doing more in terms of filters here,</span>
<a href="#l21.383"></a><span id="l21.383">     //  although since filters really want to be run on the inbox, there</span>
<a href="#l21.384"></a><span id="l21.384">     //  are separate potential semantic issues involved.</span>
<a href="#l21.385"></a><span id="l21.385">     for (let folder of aMsgFolders) {</span>
<a href="#l21.386"></a><span id="l21.386">       folder.callFilterPlugins(null);</span>
<a href="#l21.387"></a><span id="l21.387">     }</span>
<a href="#l21.388"></a><span id="l21.388" class="difflineminus">-  }</span>
<a href="#l21.389"></a><span id="l21.389" class="difflineminus">-  else if (mis.injectionConfig.mode == &quot;imap&quot;) {</span>
<a href="#l21.390"></a><span id="l21.390" class="difflineplus">+  } else if (mis.injectionConfig.mode == &quot;imap&quot;) {</span>
<a href="#l21.391"></a><span id="l21.391">     iterFolders = _looperator(aMsgFolders);</span>
<a href="#l21.392"></a><span id="l21.392">     // we need to call updateFolder on all the folders, not just the first</span>
<a href="#l21.393"></a><span id="l21.393">     //  one...</span>
<a href="#l21.394"></a><span id="l21.394" class="difflineminus">-    return async_run({func: function*() {</span>
<a href="#l21.395"></a><span id="l21.395" class="difflineplus">+    return async_run({* func() {</span>
<a href="#l21.396"></a><span id="l21.396">       yield wait_for_async_promises();</span>
<a href="#l21.397"></a><span id="l21.397"> </span>
<a href="#l21.398"></a><span id="l21.398">       let iPerSet = 0, folder = iterFolders.next();</span>
<a href="#l21.399"></a><span id="l21.399">       let didSomething;</span>
<a href="#l21.400"></a><span id="l21.400">       do {</span>
<a href="#l21.401"></a><span id="l21.401">         didSomething = false;</span>
<a href="#l21.402"></a><span id="l21.402">         for (let messageSet of aMessageSets) {</span>
<a href="#l21.403"></a><span id="l21.403">           if (iPerSet &lt; messageSet.synMessages.length) {</span>
<a href="#l21.404"></a><span id="l21.404" class="difflineat">@@ -788,18 +785,17 @@ function add_sets_to_folders(aMsgFolders</span>
<a href="#l21.405"></a><span id="l21.405">         // compel download of the messages if appropriate</span>
<a href="#l21.406"></a><span id="l21.406">         if (realFolder.flags &amp; Ci.nsMsgFolderFlags.Offline) {</span>
<a href="#l21.407"></a><span id="l21.407">           mark_action(&quot;messageInjection&quot;, &quot;offlining messages&quot;, [realFolder]);</span>
<a href="#l21.408"></a><span id="l21.408">           realFolder.downloadAllForOffline(asyncUrlListener, null);</span>
<a href="#l21.409"></a><span id="l21.409">           yield false;</span>
<a href="#l21.410"></a><span id="l21.410">         }</span>
<a href="#l21.411"></a><span id="l21.411">       }</span>
<a href="#l21.412"></a><span id="l21.412">     }});</span>
<a href="#l21.413"></a><span id="l21.413" class="difflineminus">-  }</span>
<a href="#l21.414"></a><span id="l21.414" class="difflineminus">-  else if (mis.injectionConfig.mode == &quot;pop&quot;) {</span>
<a href="#l21.415"></a><span id="l21.415" class="difflineplus">+  } else if (mis.injectionConfig.mode == &quot;pop&quot;) {</span>
<a href="#l21.416"></a><span id="l21.416">     iterFolders = _looperator(aMsgFolders);</span>
<a href="#l21.417"></a><span id="l21.417"> </span>
<a href="#l21.418"></a><span id="l21.418">     let iPerSet = 0, folder = iterFolders.next();</span>
<a href="#l21.419"></a><span id="l21.419">     // loop, incrementing our subscript until all message sets are out of messages</span>
<a href="#l21.420"></a><span id="l21.420">     let didSomething;</span>
<a href="#l21.421"></a><span id="l21.421">     do {</span>
<a href="#l21.422"></a><span id="l21.422">       didSomething = false;</span>
<a href="#l21.423"></a><span id="l21.423">       // for each message set, if it is not out of messages, add the message</span>
<a href="#l21.424"></a><span id="l21.424" class="difflineat">@@ -817,17 +813,17 @@ function add_sets_to_folders(aMsgFolders</span>
<a href="#l21.425"></a><span id="l21.425">     if (aDoNotForceUpdate)</span>
<a href="#l21.426"></a><span id="l21.426">       return true;</span>
<a href="#l21.427"></a><span id="l21.427">     ims.pop3Service.GetNewMail(null, asyncUrlListener, mis.inboxFolder,</span>
<a href="#l21.428"></a><span id="l21.428">                                mis.incomingServer);</span>
<a href="#l21.429"></a><span id="l21.429">     return false; // wait for the url listener to be notified</span>
<a href="#l21.430"></a><span id="l21.430">   }</span>
<a href="#l21.431"></a><span id="l21.431"> </span>
<a href="#l21.432"></a><span id="l21.432">   return true;</span>
<a href="#l21.433"></a><span id="l21.433" class="difflineminus">-};</span>
<a href="#l21.434"></a><span id="l21.434" class="difflineplus">+}</span>
<a href="#l21.435"></a><span id="l21.435"> /** singular function name for understandability of single-folder users */</span>
<a href="#l21.436"></a><span id="l21.436"> var add_sets_to_folder = add_sets_to_folders;</span>
<a href="#l21.437"></a><span id="l21.437"> </span>
<a href="#l21.438"></a><span id="l21.438"> /**</span>
<a href="#l21.439"></a><span id="l21.439">  * Return the nsIMsgFolder associated with a folder handle.  If the folder has</span>
<a href="#l21.440"></a><span id="l21.440">  *  been created since the last injection and you are using IMAP, you may need</span>
<a href="#l21.441"></a><span id="l21.441">  *  to first &quot;yield wait_for_async_promises();&quot; for us to be able to provide</span>
<a href="#l21.442"></a><span id="l21.442">  *  you with a result.</span>
<a href="#l21.443"></a><span id="l21.443" class="difflineat">@@ -844,18 +840,17 @@ function get_real_injection_folder(aFold</span>
<a href="#l21.444"></a><span id="l21.444">  * Helper function for any of the convenience functions that integrate</span>
<a href="#l21.445"></a><span id="l21.445">  *  message injection.</span>
<a href="#l21.446"></a><span id="l21.446">  */</span>
<a href="#l21.447"></a><span id="l21.447"> function wait_for_message_injection() {</span>
<a href="#l21.448"></a><span id="l21.448">   let mis = _messageInjectionSetup;</span>
<a href="#l21.449"></a><span id="l21.449">   if (mis.injectionConfig.mode == &quot;imap&quot; ||</span>
<a href="#l21.450"></a><span id="l21.450">       mis.injectionConfig.mode == &quot;pop&quot;)</span>
<a href="#l21.451"></a><span id="l21.451">     return false;</span>
<a href="#l21.452"></a><span id="l21.452" class="difflineminus">-  else</span>
<a href="#l21.453"></a><span id="l21.453" class="difflineminus">-    return true;</span>
<a href="#l21.454"></a><span id="l21.454" class="difflineplus">+  return true;</span>
<a href="#l21.455"></a><span id="l21.455"> }</span>
<a href="#l21.456"></a><span id="l21.456"> </span>
<a href="#l21.457"></a><span id="l21.457"> /**</span>
<a href="#l21.458"></a><span id="l21.458">  * Asynchronously move messages in the given set to the destination folder.</span>
<a href="#l21.459"></a><span id="l21.459">  *</span>
<a href="#l21.460"></a><span id="l21.460">  * For IMAP moves we force an update of the source folder and then the</span>
<a href="#l21.461"></a><span id="l21.461">  *  destination folder.  This ensures that any (pseudo-)offline operations in</span>
<a href="#l21.462"></a><span id="l21.462">  *  the source folder have had a chance to run and that we have seen the changes</span>
<a href="#l21.463"></a><span id="l21.463" class="difflineat">@@ -867,17 +862,17 @@ function wait_for_message_injection() {</span>
<a href="#l21.464"></a><span id="l21.464">  * @param aDestFolder The target folder.</span>
<a href="#l21.465"></a><span id="l21.465">  * @param [aAllowUndo=false] Should we generate undo operations and, as a</span>
<a href="#l21.466"></a><span id="l21.466">  *     side-effect, offline operations?  (The code uses undo operations as</span>
<a href="#l21.467"></a><span id="l21.467">  *     a proxy-indicator for it coming from the UI and therefore performing</span>
<a href="#l21.468"></a><span id="l21.468">  *     pseudo-offline operations instead of trying to do things online.)</span>
<a href="#l21.469"></a><span id="l21.469">  */</span>
<a href="#l21.470"></a><span id="l21.470"> function async_move_messages(aSynMessageSet, aDestFolder, aAllowUndo) {</span>
<a href="#l21.471"></a><span id="l21.471">   mark_action(&quot;messageInjection&quot;, &quot;moving messages&quot;, aSynMessageSet.msgHdrList);</span>
<a href="#l21.472"></a><span id="l21.472" class="difflineminus">-  return async_run({func: function*() {</span>
<a href="#l21.473"></a><span id="l21.473" class="difflineplus">+  return async_run({* func() {</span>
<a href="#l21.474"></a><span id="l21.474">       // we need to make sure all folder promises are fulfilled</span>
<a href="#l21.475"></a><span id="l21.475">       yield wait_for_async_promises();</span>
<a href="#l21.476"></a><span id="l21.476">       // and then we can make sure we have the actual folder</span>
<a href="#l21.477"></a><span id="l21.477">       let realDestFolder = get_real_injection_folder(aDestFolder);</span>
<a href="#l21.478"></a><span id="l21.478"> </span>
<a href="#l21.479"></a><span id="l21.479">       for (let [folder, xpcomHdrArray] of</span>
<a href="#l21.480"></a><span id="l21.480">            aSynMessageSet.foldersWithXpcomHdrArrays()) {</span>
<a href="#l21.481"></a><span id="l21.481">         mark_action(&quot;messageInjection&quot;,</span>
<a href="#l21.482"></a><span id="l21.482" class="difflineat">@@ -933,17 +928,17 @@ function async_move_messages(aSynMessage</span>
<a href="#l21.483"></a><span id="l21.483">  *</span>
<a href="#l21.484"></a><span id="l21.484">  * @param aSynMessageSet The set of messages to trash.  The messages do not all</span>
<a href="#l21.485"></a><span id="l21.485">  *     have to be in the same folder, but we have to trash them folder by</span>
<a href="#l21.486"></a><span id="l21.486">  *     folder if they are not.</span>
<a href="#l21.487"></a><span id="l21.487">  */</span>
<a href="#l21.488"></a><span id="l21.488"> function async_trash_messages(aSynMessageSet) {</span>
<a href="#l21.489"></a><span id="l21.489">   mark_action(&quot;messageInjection&quot;, &quot;trashing messages&quot;,</span>
<a href="#l21.490"></a><span id="l21.490">               aSynMessageSet.msgHdrList);</span>
<a href="#l21.491"></a><span id="l21.491" class="difflineminus">-  return async_run({func: function*() {</span>
<a href="#l21.492"></a><span id="l21.492" class="difflineplus">+  return async_run({* func() {</span>
<a href="#l21.493"></a><span id="l21.493">       for (let [folder, xpcomHdrArray] of</span>
<a href="#l21.494"></a><span id="l21.494">            aSynMessageSet.foldersWithXpcomHdrArrays()) {</span>
<a href="#l21.495"></a><span id="l21.495">         mark_action(&quot;messageInjection&quot;, &quot;trashing messages in folder&quot;,</span>
<a href="#l21.496"></a><span id="l21.496">                     [folder]);</span>
<a href="#l21.497"></a><span id="l21.497">         // In the IMAP case tell listeners we are moving messages without</span>
<a href="#l21.498"></a><span id="l21.498">         //  destination headers, since that's what trashing amounts to.</span>
<a href="#l21.499"></a><span id="l21.499">         if (!message_injection_is_local())</span>
<a href="#l21.500"></a><span id="l21.500">           _messageInjectionSetup.notifyListeners(</span>
<a href="#l21.501"></a><span id="l21.501" class="difflineat">@@ -1011,17 +1006,17 @@ function async_delete_messages(aSynMessa</span>
<a href="#l21.502"></a><span id="l21.502">   }</span>
<a href="#l21.503"></a><span id="l21.503">   return true;</span>
<a href="#l21.504"></a><span id="l21.504"> }</span>
<a href="#l21.505"></a><span id="l21.505"> </span>
<a href="#l21.506"></a><span id="l21.506"> /**</span>
<a href="#l21.507"></a><span id="l21.507">  * Empty the trash.</span>
<a href="#l21.508"></a><span id="l21.508">  */</span>
<a href="#l21.509"></a><span id="l21.509"> function async_empty_trash() {</span>
<a href="#l21.510"></a><span id="l21.510" class="difflineminus">-  return async_run({func: function*() {</span>
<a href="#l21.511"></a><span id="l21.511" class="difflineplus">+  return async_run({* func() {</span>
<a href="#l21.512"></a><span id="l21.512">     let trashHandle = get_trash_folder();</span>
<a href="#l21.513"></a><span id="l21.513">     yield wait_for_async_promises();</span>
<a href="#l21.514"></a><span id="l21.514">     let trashFolder = get_real_injection_folder(trashHandle);</span>
<a href="#l21.515"></a><span id="l21.515">     trashFolder.emptyTrash(null, asyncUrlListener);</span>
<a href="#l21.516"></a><span id="l21.516">     yield false;</span>
<a href="#l21.517"></a><span id="l21.517">   }});</span>
<a href="#l21.518"></a><span id="l21.518"> }</span>
<a href="#l21.519"></a><span id="l21.519"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/test/resources/messageModifier.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/test/resources/messageModifier.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -1,11 +1,11 @@</span>
<a href="#l22.4"></a><span id="l22.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.5"></a><span id="l22.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9"> /*</span>
<a href="#l22.10"></a><span id="l22.10">  * This file provides a number of methods for modifying (synthetic) messages</span>
<a href="#l22.11"></a><span id="l22.11">  *  for testing purposes.</span>
<a href="#l22.12"></a><span id="l22.12">  */</span>
<a href="#l22.13"></a><span id="l22.13"> </span>
<a href="#l22.14"></a><span id="l22.14"> var {toXPCOMArray} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l22.15"></a><span id="l22.15"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineat">@@ -26,110 +26,109 @@ var {MailServices} = ChromeUtils.import(</span>
<a href="#l22.17"></a><span id="l22.17">  * @param aFolderIndices Optional list where each value is an index into the</span>
<a href="#l22.18"></a><span id="l22.18">  *     msgFolders attribute, specifying what folder the message can be found</span>
<a href="#l22.19"></a><span id="l22.19">  *     in.  The value may also be null if the message has not yet been</span>
<a href="#l22.20"></a><span id="l22.20">  *     inserted into a folder.</span>
<a href="#l22.21"></a><span id="l22.21">  */</span>
<a href="#l22.22"></a><span id="l22.22"> function SyntheticMessageSet(aSynMessages, aMsgFolders, aFolderIndices) {</span>
<a href="#l22.23"></a><span id="l22.23">   this.synMessages = aSynMessages;</span>
<a href="#l22.24"></a><span id="l22.24"> </span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-  if (aMsgFolders == null)</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">-    this.msgFolders = [];</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-  else if (!('length' in aMsgFolders))</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+  if (Array.isArray(aMsgFolders))</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+    this.msgFolders = aMsgFolders;</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+  else if (aMsgFolders)</span>
<a href="#l22.31"></a><span id="l22.31">     this.msgFolders = [aMsgFolders];</span>
<a href="#l22.32"></a><span id="l22.32">   else</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-    this.msgFolders = aMsgFolders;</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+    this.msgFolders = [];</span>
<a href="#l22.35"></a><span id="l22.35"> </span>
<a href="#l22.36"></a><span id="l22.36">   if (aFolderIndices == null)</span>
<a href="#l22.37"></a><span id="l22.37">     this.folderIndices = aSynMessages.map(_ =&gt; null);</span>
<a href="#l22.38"></a><span id="l22.38">   else</span>
<a href="#l22.39"></a><span id="l22.39">     this.folderIndices = aFolderIndices;</span>
<a href="#l22.40"></a><span id="l22.40"> }</span>
<a href="#l22.41"></a><span id="l22.41"> SyntheticMessageSet.prototype = {</span>
<a href="#l22.42"></a><span id="l22.42">   /**</span>
<a href="#l22.43"></a><span id="l22.43">    * Helper method for messageInjection to use to tell us it is injecting a</span>
<a href="#l22.44"></a><span id="l22.44">    *  message in a given folder.  As a convenience, we also return the</span>
<a href="#l22.45"></a><span id="l22.45">    *  synthetic message.</span>
<a href="#l22.46"></a><span id="l22.46">    *</span>
<a href="#l22.47"></a><span id="l22.47">    * @protected</span>
<a href="#l22.48"></a><span id="l22.48">    */</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineminus">-  _trackMessageAddition: function(aFolder, aMessageIndex) {</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+  _trackMessageAddition(aFolder, aMessageIndex) {</span>
<a href="#l22.51"></a><span id="l22.51">     let aFolderIndex = this.msgFolders.indexOf(aFolder);</span>
<a href="#l22.52"></a><span id="l22.52">     if (aFolderIndex == -1)</span>
<a href="#l22.53"></a><span id="l22.53">       aFolderIndex = this.msgFolders.push(aFolder) - 1;</span>
<a href="#l22.54"></a><span id="l22.54">     this.folderIndices[aMessageIndex] = aFolderIndex;</span>
<a href="#l22.55"></a><span id="l22.55">     return this.synMessages[aMessageIndex];</span>
<a href="#l22.56"></a><span id="l22.56">   },</span>
<a href="#l22.57"></a><span id="l22.57">   /**</span>
<a href="#l22.58"></a><span id="l22.58">    * Helper method for use by |async_move_messages| to tell us that it moved</span>
<a href="#l22.59"></a><span id="l22.59">    *  all the messages from aOldFolder to aNewFolder.</span>
<a href="#l22.60"></a><span id="l22.60">    */</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineminus">-  _folderSwap: function(aOldFolder, aNewFolder) {</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineplus">+  _folderSwap(aOldFolder, aNewFolder) {</span>
<a href="#l22.63"></a><span id="l22.63">     let folderIndex = this.msgFolders.indexOf(aOldFolder);</span>
<a href="#l22.64"></a><span id="l22.64">     this.msgFolders[folderIndex] = aNewFolder;</span>
<a href="#l22.65"></a><span id="l22.65">   },</span>
<a href="#l22.66"></a><span id="l22.66"> </span>
<a href="#l22.67"></a><span id="l22.67">   /**</span>
<a href="#l22.68"></a><span id="l22.68">    * Union this set with another set and return the (new) result.</span>
<a href="#l22.69"></a><span id="l22.69">    *</span>
<a href="#l22.70"></a><span id="l22.70">    * @param aOtherSet The other synthetic message set.</span>
<a href="#l22.71"></a><span id="l22.71">    * @returns a new SyntheticMessageSet containing the union of this set and</span>
<a href="#l22.72"></a><span id="l22.72">    *     the other set.</span>
<a href="#l22.73"></a><span id="l22.73">    */</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineminus">-  union: function(aOtherSet) {</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineplus">+  union(aOtherSet) {</span>
<a href="#l22.76"></a><span id="l22.76">     let messages = this.synMessages.concat(aOtherSet.synMessages);</span>
<a href="#l22.77"></a><span id="l22.77">     let folders = this.msgFolders.concat();</span>
<a href="#l22.78"></a><span id="l22.78">     let indices = this.folderIndices.concat();</span>
<a href="#l22.79"></a><span id="l22.79"> </span>
<a href="#l22.80"></a><span id="l22.80">     let folderUrisToIndices = {};</span>
<a href="#l22.81"></a><span id="l22.81">     for (let [iFolder, folder] of this.msgFolders.entries()) {</span>
<a href="#l22.82"></a><span id="l22.82">       folderUrisToIndices[folder.URI] = iFolder;</span>
<a href="#l22.83"></a><span id="l22.83">     }</span>
<a href="#l22.84"></a><span id="l22.84"> </span>
<a href="#l22.85"></a><span id="l22.85">     for (let iOther = 0; iOther &lt; aOtherSet.synMessages.length; iOther++) {</span>
<a href="#l22.86"></a><span id="l22.86">       let folderIndex = aOtherSet.folderIndices[iOther];</span>
<a href="#l22.87"></a><span id="l22.87">       if (folderIndex == null) {</span>
<a href="#l22.88"></a><span id="l22.88">         indices.push(folderIndex);</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineminus">-      }</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineminus">-      else {</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineplus">+      } else {</span>
<a href="#l22.92"></a><span id="l22.92">         let folder = aOtherSet.msgFolders[folderIndex];</span>
<a href="#l22.93"></a><span id="l22.93">         if (!(folder.URI in folderUrisToIndices)) {</span>
<a href="#l22.94"></a><span id="l22.94">           folderUrisToIndices[folder.URI] = folders.length;</span>
<a href="#l22.95"></a><span id="l22.95">           folders.push(folder);</span>
<a href="#l22.96"></a><span id="l22.96">         }</span>
<a href="#l22.97"></a><span id="l22.97">         indices.push(folderUrisToIndices[folder.URI]);</span>
<a href="#l22.98"></a><span id="l22.98">       }</span>
<a href="#l22.99"></a><span id="l22.99">     }</span>
<a href="#l22.100"></a><span id="l22.100"> </span>
<a href="#l22.101"></a><span id="l22.101">     return new SyntheticMessageSet(messages, folders, indices);</span>
<a href="#l22.102"></a><span id="l22.102">   },</span>
<a href="#l22.103"></a><span id="l22.103"> </span>
<a href="#l22.104"></a><span id="l22.104">   /**</span>
<a href="#l22.105"></a><span id="l22.105">    * Get the single message header of the message at the given index; use</span>
<a href="#l22.106"></a><span id="l22.106">    *  |msgHdrs| or |xpcomHdrArray| if you want to get all the headers at once.</span>
<a href="#l22.107"></a><span id="l22.107">    */</span>
<a href="#l22.108"></a><span id="l22.108" class="difflineminus">-  getMsgHdr: function(aIndex) {</span>
<a href="#l22.109"></a><span id="l22.109" class="difflineplus">+  getMsgHdr(aIndex) {</span>
<a href="#l22.110"></a><span id="l22.110">     let folder = this.msgFolders[this.folderIndices[aIndex]];</span>
<a href="#l22.111"></a><span id="l22.111">     let synMsg = this.synMessages[aIndex];</span>
<a href="#l22.112"></a><span id="l22.112">     return folder.msgDatabase.getMsgHdrForMessageID(synMsg.messageId);</span>
<a href="#l22.113"></a><span id="l22.113">   },</span>
<a href="#l22.114"></a><span id="l22.114"> </span>
<a href="#l22.115"></a><span id="l22.115">   /**</span>
<a href="#l22.116"></a><span id="l22.116">    * Get the URI for the message at the given index.</span>
<a href="#l22.117"></a><span id="l22.117">    */</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineminus">-  getMsgURI: function(aIndex) {</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineplus">+  getMsgURI(aIndex) {</span>
<a href="#l22.120"></a><span id="l22.120">     let msgHdr = this.getMsgHdr(aIndex);</span>
<a href="#l22.121"></a><span id="l22.121">     return msgHdr.folder.getUriForMsg(msgHdr);</span>
<a href="#l22.122"></a><span id="l22.122">   },</span>
<a href="#l22.123"></a><span id="l22.123"> </span>
<a href="#l22.124"></a><span id="l22.124">   /**</span>
<a href="#l22.125"></a><span id="l22.125">    * @return a JS iterator of the message headers for all messages inserted into</span>
<a href="#l22.126"></a><span id="l22.126">    *     a folder.</span>
<a href="#l22.127"></a><span id="l22.127">    */</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineminus">-  msgHdrs: function*() {</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineplus">+  * msgHdrs() {</span>
<a href="#l22.130"></a><span id="l22.130">     // get the databases</span>
<a href="#l22.131"></a><span id="l22.131">     let msgDatabases = this.msgFolders.map(folder =&gt; folder.msgDatabase);</span>
<a href="#l22.132"></a><span id="l22.132">     for (let [iMsg, synMsg] of this.synMessages.entries()) {</span>
<a href="#l22.133"></a><span id="l22.133">       let folderIndex = this.folderIndices[iMsg];</span>
<a href="#l22.134"></a><span id="l22.134">       if (folderIndex != null)</span>
<a href="#l22.135"></a><span id="l22.135">         yield msgDatabases[folderIndex].getMsgHdrForMessageID(synMsg.messageId);</span>
<a href="#l22.136"></a><span id="l22.136">     }</span>
<a href="#l22.137"></a><span id="l22.137">   },</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineat">@@ -163,82 +162,82 @@ SyntheticMessageSet.prototype = {</span>
<a href="#l22.139"></a><span id="l22.139">       }</span>
<a href="#l22.140"></a><span id="l22.140">     }</span>
<a href="#l22.141"></a><span id="l22.141">     return results;</span>
<a href="#l22.142"></a><span id="l22.142">   },</span>
<a href="#l22.143"></a><span id="l22.143">   /**</span>
<a href="#l22.144"></a><span id="l22.144">    * @return a generator that yields [nsIMsgFolder, nsIMutableArray of the</span>
<a href="#l22.145"></a><span id="l22.145">    *     messages from the set in that folder].</span>
<a href="#l22.146"></a><span id="l22.146">    */</span>
<a href="#l22.147"></a><span id="l22.147" class="difflineminus">-  foldersWithXpcomHdrArrays: function*() {</span>
<a href="#l22.148"></a><span id="l22.148" class="difflineplus">+  * foldersWithXpcomHdrArrays() {</span>
<a href="#l22.149"></a><span id="l22.149">     for (let [folder, msgHdrs] of this.foldersWithMsgHdrs) {</span>
<a href="#l22.150"></a><span id="l22.150">       yield [folder, toXPCOMArray(msgHdrs,</span>
<a href="#l22.151"></a><span id="l22.151">                                   Ci.nsIMutableArray)];</span>
<a href="#l22.152"></a><span id="l22.152">     }</span>
<a href="#l22.153"></a><span id="l22.153">   },</span>
<a href="#l22.154"></a><span id="l22.154">   /**</span>
<a href="#l22.155"></a><span id="l22.155">    * Sets the status of the messages to read/unread.</span>
<a href="#l22.156"></a><span id="l22.156">    *</span>
<a href="#l22.157"></a><span id="l22.157">    * @param aRead    true/false to set messages as read/unread</span>
<a href="#l22.158"></a><span id="l22.158">    * @param aMsgHdr  A message header to work on. If not specified,</span>
<a href="#l22.159"></a><span id="l22.159">    *                 mark all messages in the current set.</span>
<a href="#l22.160"></a><span id="l22.160">    */</span>
<a href="#l22.161"></a><span id="l22.161" class="difflineminus">-  setRead: function(aRead, aMsgHdr) {</span>
<a href="#l22.162"></a><span id="l22.162" class="difflineplus">+  setRead(aRead, aMsgHdr) {</span>
<a href="#l22.163"></a><span id="l22.163">     let msgHdrs = aMsgHdr ? [aMsgHdr] : this.msgHdrList;</span>
<a href="#l22.164"></a><span id="l22.164">     for (let msgHdr of msgHdrs) {</span>
<a href="#l22.165"></a><span id="l22.165">       msgHdr.markRead(aRead);</span>
<a href="#l22.166"></a><span id="l22.166">     }</span>
<a href="#l22.167"></a><span id="l22.167">   },</span>
<a href="#l22.168"></a><span id="l22.168" class="difflineminus">-  setStarred: function(aStarred) {</span>
<a href="#l22.169"></a><span id="l22.169" class="difflineplus">+  setStarred(aStarred) {</span>
<a href="#l22.170"></a><span id="l22.170">     for (let msgHdr of this.msgHdrs()) {</span>
<a href="#l22.171"></a><span id="l22.171">       msgHdr.markFlagged(aStarred);</span>
<a href="#l22.172"></a><span id="l22.172">     }</span>
<a href="#l22.173"></a><span id="l22.173">   },</span>
<a href="#l22.174"></a><span id="l22.174" class="difflineminus">-  addTag: function(aTagName) {</span>
<a href="#l22.175"></a><span id="l22.175" class="difflineplus">+  addTag(aTagName) {</span>
<a href="#l22.176"></a><span id="l22.176">     for (let [folder, xpcomHdrArray] of this.foldersWithXpcomHdrArrays()) {</span>
<a href="#l22.177"></a><span id="l22.177">       folder.addKeywordsToMessages(xpcomHdrArray, aTagName);</span>
<a href="#l22.178"></a><span id="l22.178">     }</span>
<a href="#l22.179"></a><span id="l22.179">   },</span>
<a href="#l22.180"></a><span id="l22.180" class="difflineminus">-  removeTag: function(aTagName) {</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineplus">+  removeTag(aTagName) {</span>
<a href="#l22.182"></a><span id="l22.182">     for (let [folder, xpcomHdrArray] of this.foldersWithXpcomHdrArrays()) {</span>
<a href="#l22.183"></a><span id="l22.183">       folder.removeKeywordsFromMessages(xpcomHdrArray, aTagName);</span>
<a href="#l22.184"></a><span id="l22.184">     }</span>
<a href="#l22.185"></a><span id="l22.185">   },</span>
<a href="#l22.186"></a><span id="l22.186">   /**</span>
<a href="#l22.187"></a><span id="l22.187">    * Sets the junk score for the messages to junk/non-junk.  It does not</span>
<a href="#l22.188"></a><span id="l22.188">    *  involve the bayesian classifier because we really don't want it</span>
<a href="#l22.189"></a><span id="l22.189">    *  affecting our unit tests!  (Unless we were testing the bayesian</span>
<a href="#l22.190"></a><span id="l22.190">    *  classifier.  Which I'm conveniently not.  Feel free to add a</span>
<a href="#l22.191"></a><span id="l22.191">    *  &quot;setJunkForRealsies&quot; method if you are.)</span>
<a href="#l22.192"></a><span id="l22.192">    *</span>
<a href="#l22.193"></a><span id="l22.193">    * @param aIsJunk  true/false to set messages to junk/non-junk</span>
<a href="#l22.194"></a><span id="l22.194">    * @param aMsgHdr  A message header to work on. If not specified,</span>
<a href="#l22.195"></a><span id="l22.195">    *                 mark all messages in the current set.</span>
<a href="#l22.196"></a><span id="l22.196">    * Generates a JunkStatusChanged nsIMsgFolderListener itemEvent notification.</span>
<a href="#l22.197"></a><span id="l22.197">    */</span>
<a href="#l22.198"></a><span id="l22.198" class="difflineminus">-  setJunk: function(aIsJunk, aMsgHdr) {</span>
<a href="#l22.199"></a><span id="l22.199" class="difflineplus">+  setJunk(aIsJunk, aMsgHdr) {</span>
<a href="#l22.200"></a><span id="l22.200">     let junkscore = aIsJunk ? &quot;100&quot; : &quot;0&quot;;</span>
<a href="#l22.201"></a><span id="l22.201">     let msgHdrs = aMsgHdr ? [aMsgHdr] : this.msgHdrList;</span>
<a href="#l22.202"></a><span id="l22.202">     for (let msgHdr of msgHdrs) {</span>
<a href="#l22.203"></a><span id="l22.203">       msgHdr.setStringProperty(&quot;junkscore&quot;, junkscore);</span>
<a href="#l22.204"></a><span id="l22.204" class="difflineminus">-    };</span>
<a href="#l22.205"></a><span id="l22.205" class="difflineplus">+    }</span>
<a href="#l22.206"></a><span id="l22.206"> </span>
<a href="#l22.207"></a><span id="l22.207">     let str = aIsJunk ? &quot;junk&quot; : &quot;notjunk&quot;;</span>
<a href="#l22.208"></a><span id="l22.208">     let xpcomHdrArray = toXPCOMArray(msgHdrs, Ci.nsIMutableArray);</span>
<a href="#l22.209"></a><span id="l22.209">     MailServices.mfn.notifyItemEvent(xpcomHdrArray,</span>
<a href="#l22.210"></a><span id="l22.210">                                      &quot;JunkStatusChanged&quot;,</span>
<a href="#l22.211"></a><span id="l22.211">                                      null, str);</span>
<a href="#l22.212"></a><span id="l22.212">   },</span>
<a href="#l22.213"></a><span id="l22.213"> </span>
<a href="#l22.214"></a><span id="l22.214">   /**</span>
<a href="#l22.215"></a><span id="l22.215">    * Slice the message set using the exact Array.prototype.slice semantics</span>
<a href="#l22.216"></a><span id="l22.216">    * (because we call Array.prototype.slice).</span>
<a href="#l22.217"></a><span id="l22.217">    */</span>
<a href="#l22.218"></a><span id="l22.218" class="difflineminus">-  slice: function(...aArgs) {</span>
<a href="#l22.219"></a><span id="l22.219" class="difflineplus">+  slice(...aArgs) {</span>
<a href="#l22.220"></a><span id="l22.220">     let slicedMessages = this.synMessages.slice(...aArgs);</span>
<a href="#l22.221"></a><span id="l22.221">     let slicedIndices = this.folderIndices.slice(...aArgs);</span>
<a href="#l22.222"></a><span id="l22.222">     let sliced = new SyntheticMessageSet(slicedMessages, this.msgFolders,</span>
<a href="#l22.223"></a><span id="l22.223">                                          slicedIndices);</span>
<a href="#l22.224"></a><span id="l22.224">     if ((&quot;glodaMessages&quot; in this) &amp;&amp; this.glodaMessages)</span>
<a href="#l22.225"></a><span id="l22.225">       sliced.glodaMessages = this.glodaMessages.slice(...aArgs);</span>
<a href="#l22.226"></a><span id="l22.226">     return sliced;</span>
<a href="#l22.227"></a><span id="l22.227" class="difflineminus">-  }</span>
<a href="#l22.228"></a><span id="l22.228" class="difflineplus">+  },</span>
<a href="#l22.229"></a><span id="l22.229"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/test/resources/msgFolderListenerSetup.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/test/resources/msgFolderListenerSetup.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -1,279 +1,247 @@</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.6"></a><span id="l23.6" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.7"></a><span id="l23.7" class="difflineplus">+</span>
<a href="#l23.8"></a><span id="l23.8" class="difflineplus">+// ChromeUtils.import should be used for this, but it breaks mozmill.</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineplus">+// Assume whatever test loaded this file already has mailTestUtils.</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineplus">+/* globals mailTestUtils */</span>
<a href="#l23.11"></a><span id="l23.11" class="difflineplus">+</span>
<a href="#l23.12"></a><span id="l23.12"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l23.13"></a><span id="l23.13"> </span>
<a href="#l23.14"></a><span id="l23.14"> var allTestedEvents =</span>
<a href="#l23.15"></a><span id="l23.15">   MailServices.mfn.msgAdded |</span>
<a href="#l23.16"></a><span id="l23.16">   MailServices.mfn.msgsClassified |</span>
<a href="#l23.17"></a><span id="l23.17">   MailServices.mfn.msgsDeleted |</span>
<a href="#l23.18"></a><span id="l23.18">   MailServices.mfn.msgsMoveCopyCompleted |</span>
<a href="#l23.19"></a><span id="l23.19">   MailServices.mfn.msgKeyChanged |</span>
<a href="#l23.20"></a><span id="l23.20">   MailServices.mfn.folderAdded |</span>
<a href="#l23.21"></a><span id="l23.21">   MailServices.mfn.folderDeleted |</span>
<a href="#l23.22"></a><span id="l23.22">   MailServices.mfn.folderMoveCopyCompleted |</span>
<a href="#l23.23"></a><span id="l23.23">   MailServices.mfn.folderRenamed |</span>
<a href="#l23.24"></a><span id="l23.24">   MailServices.mfn.itemEvent;</span>
<a href="#l23.25"></a><span id="l23.25"> </span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-var gCopyService = MailServices.copy;</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-</span>
<a href="#l23.28"></a><span id="l23.28"> // Current test being executed</span>
<a href="#l23.29"></a><span id="l23.29"> var gTest = 1;</span>
<a href="#l23.30"></a><span id="l23.30"> </span>
<a href="#l23.31"></a><span id="l23.31"> // Which events are expected</span>
<a href="#l23.32"></a><span id="l23.32"> var gExpectedEvents = [];</span>
<a href="#l23.33"></a><span id="l23.33"> </span>
<a href="#l23.34"></a><span id="l23.34"> // The current status (what all has been done)</span>
<a href="#l23.35"></a><span id="l23.35"> var gCurrStatus = 0;</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineminus">-var kStatus =</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-{</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineplus">+var kStatus = {</span>
<a href="#l23.39"></a><span id="l23.39">   notificationsDone: 0x1,</span>
<a href="#l23.40"></a><span id="l23.40">   onStopCopyDone: 0x2,</span>
<a href="#l23.41"></a><span id="l23.41">   functionCallDone: 0x4,</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-  everythingDone: 0</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineplus">+  everythingDone: 0,</span>
<a href="#l23.44"></a><span id="l23.44"> };</span>
<a href="#l23.45"></a><span id="l23.45"> kStatus.everythingDone = kStatus.notificationsDone | kStatus.onStopCopyDone | kStatus.functionCallDone;</span>
<a href="#l23.46"></a><span id="l23.46"> </span>
<a href="#l23.47"></a><span id="l23.47"> // For CopyFileMessage: this stores the header that was received</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineminus">-var gHdrsReceived = new Array();</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineplus">+var gHdrsReceived = [];</span>
<a href="#l23.50"></a><span id="l23.50"> </span>
<a href="#l23.51"></a><span id="l23.51" class="difflineminus">-var gMsgHdrs = new Array();</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineplus">+var gMsgHdrs = [];</span>
<a href="#l23.53"></a><span id="l23.53"> </span>
<a href="#l23.54"></a><span id="l23.54"> // Our listener, which captures events and verifies them as they are received.</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineminus">-var gMFListener =</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineminus">-{</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineminus">-  msgAdded: function(aMsg)</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineminus">-  {</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineplus">+var gMFListener = {</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineplus">+  msgAdded(aMsg) {</span>
<a href="#l23.61"></a><span id="l23.61">     verify([MailServices.mfn.msgAdded, aMsg]);</span>
<a href="#l23.62"></a><span id="l23.62">     // We might not actually have a header in gHdrsReceived in the IMAP case,</span>
<a href="#l23.63"></a><span id="l23.63">     // so use the aMsg we got instead</span>
<a href="#l23.64"></a><span id="l23.64">     gMsgHdrs.push({hdr: aMsg, ID: aMsg.messageId});</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineminus">-    if (gExpectedEvents.length == 0)</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineminus">-    {</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineplus">+    if (gExpectedEvents.length == 0) {</span>
<a href="#l23.68"></a><span id="l23.68">       gCurrStatus |= kStatus.notificationsDone;</span>
<a href="#l23.69"></a><span id="l23.69">       if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l23.70"></a><span id="l23.70">         resetStatusAndProceed();</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineminus">-    }</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineminus">-    else if (gExpectedEvents[0][0] == MailServices.mfn.msgsClassified)</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineminus">-    {</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineplus">+    } else if (gExpectedEvents[0][0] == MailServices.mfn.msgsClassified) {</span>
<a href="#l23.75"></a><span id="l23.75">       // XXX this is a hack to deal with limitations of the classification logic</span>
<a href="#l23.76"></a><span id="l23.76">       //  and the new list.  We want to issue a call to clear the list once all</span>
<a href="#l23.77"></a><span id="l23.77">       //  the messages have been added, which would be when the next expected</span>
<a href="#l23.78"></a><span id="l23.78">       //  event is msgsClassified.  (The limitation is that if we don't do this,</span>
<a href="#l23.79"></a><span id="l23.79">       //  we can end up getting told about this message again later.)</span>
<a href="#l23.80"></a><span id="l23.80">       aMsg.folder.clearNewMessages();</span>
<a href="#l23.81"></a><span id="l23.81">     }</span>
<a href="#l23.82"></a><span id="l23.82">   },</span>
<a href="#l23.83"></a><span id="l23.83"> </span>
<a href="#l23.84"></a><span id="l23.84" class="difflineminus">-  msgsClassified: function(aMsgs, aJunkProcessed, aTraitProcessed)</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineminus">-  {</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineplus">+  msgsClassified(aMsgs, aJunkProcessed, aTraitProcessed) {</span>
<a href="#l23.87"></a><span id="l23.87">     dump(&quot;classified id: &quot; + aMsgs.queryElementAt(0, Ci.nsIMsgDBHdr).messageId + &quot;\n&quot;);</span>
<a href="#l23.88"></a><span id="l23.88">     verify([MailServices.mfn.msgsClassified, aMsgs, aJunkProcessed,</span>
<a href="#l23.89"></a><span id="l23.89">               aTraitProcessed]);</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineminus">-    if (gExpectedEvents.length == 0)</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineminus">-    {</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineplus">+    if (gExpectedEvents.length == 0) {</span>
<a href="#l23.93"></a><span id="l23.93">       gCurrStatus |= kStatus.notificationsDone;</span>
<a href="#l23.94"></a><span id="l23.94">       if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l23.95"></a><span id="l23.95">         resetStatusAndProceed();</span>
<a href="#l23.96"></a><span id="l23.96">     }</span>
<a href="#l23.97"></a><span id="l23.97">   },</span>
<a href="#l23.98"></a><span id="l23.98"> </span>
<a href="#l23.99"></a><span id="l23.99" class="difflineminus">-  msgsDeleted: function(aMsgs)</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineminus">-  {</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineplus">+  msgsDeleted(aMsgs) {</span>
<a href="#l23.102"></a><span id="l23.102">     verify([MailServices.mfn.msgsDeleted, aMsgs]);</span>
<a href="#l23.103"></a><span id="l23.103" class="difflineminus">-    if (gExpectedEvents.length == 0)</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineminus">-    {</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineplus">+    if (gExpectedEvents.length == 0) {</span>
<a href="#l23.106"></a><span id="l23.106">       gCurrStatus |= kStatus.notificationsDone;</span>
<a href="#l23.107"></a><span id="l23.107">       if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l23.108"></a><span id="l23.108">         resetStatusAndProceed();</span>
<a href="#l23.109"></a><span id="l23.109">     }</span>
<a href="#l23.110"></a><span id="l23.110">   },</span>
<a href="#l23.111"></a><span id="l23.111"> </span>
<a href="#l23.112"></a><span id="l23.112" class="difflineminus">-  msgsMoveCopyCompleted: function(aMove, aSrcMsgs, aDestFolder, aDestMsgs)</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineminus">-  {</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineplus">+  msgsMoveCopyCompleted(aMove, aSrcMsgs, aDestFolder, aDestMsgs) {</span>
<a href="#l23.115"></a><span id="l23.115">     verify([MailServices.mfn.msgsMoveCopyCompleted, aMove, aSrcMsgs, aDestFolder,</span>
<a href="#l23.116"></a><span id="l23.116">             aDestMsgs]);</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineminus">-    if (gExpectedEvents.length == 0)</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineminus">-    {</span>
<a href="#l23.119"></a><span id="l23.119" class="difflineplus">+    if (gExpectedEvents.length == 0) {</span>
<a href="#l23.120"></a><span id="l23.120">       gCurrStatus |= kStatus.notificationsDone;</span>
<a href="#l23.121"></a><span id="l23.121">       if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l23.122"></a><span id="l23.122">         resetStatusAndProceed();</span>
<a href="#l23.123"></a><span id="l23.123">     }</span>
<a href="#l23.124"></a><span id="l23.124">   },</span>
<a href="#l23.125"></a><span id="l23.125"> </span>
<a href="#l23.126"></a><span id="l23.126" class="difflineminus">-  msgKeyChanged: function(aOldKey, aNewMsgHdr)</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineminus">-  {</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineplus">+  msgKeyChanged(aOldKey, aNewMsgHdr) {</span>
<a href="#l23.129"></a><span id="l23.129">     verify([MailServices.mfn.msgKeyChanged, aOldKey, aNewMsgHdr]);</span>
<a href="#l23.130"></a><span id="l23.130" class="difflineminus">-    if (gExpectedEvents.length == 0)</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineminus">-    {</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineplus">+    if (gExpectedEvents.length == 0) {</span>
<a href="#l23.133"></a><span id="l23.133">       gCurrStatus |= kStatus.notificationsDone;</span>
<a href="#l23.134"></a><span id="l23.134">       if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l23.135"></a><span id="l23.135">         resetStatusAndProceed();</span>
<a href="#l23.136"></a><span id="l23.136">     }</span>
<a href="#l23.137"></a><span id="l23.137">   },</span>
<a href="#l23.138"></a><span id="l23.138"> </span>
<a href="#l23.139"></a><span id="l23.139" class="difflineminus">-  folderAdded: function(aFolder)</span>
<a href="#l23.140"></a><span id="l23.140" class="difflineminus">-  {</span>
<a href="#l23.141"></a><span id="l23.141" class="difflineplus">+  folderAdded(aFolder) {</span>
<a href="#l23.142"></a><span id="l23.142">     verify([MailServices.mfn.folderAdded, aFolder]);</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineminus">-    if (gExpectedEvents.length == 0)</span>
<a href="#l23.144"></a><span id="l23.144" class="difflineminus">-    {</span>
<a href="#l23.145"></a><span id="l23.145" class="difflineplus">+    if (gExpectedEvents.length == 0) {</span>
<a href="#l23.146"></a><span id="l23.146">       gCurrStatus |= kStatus.notificationsDone;</span>
<a href="#l23.147"></a><span id="l23.147">       if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l23.148"></a><span id="l23.148">         resetStatusAndProceed();</span>
<a href="#l23.149"></a><span id="l23.149">     }</span>
<a href="#l23.150"></a><span id="l23.150">   },</span>
<a href="#l23.151"></a><span id="l23.151"> </span>
<a href="#l23.152"></a><span id="l23.152" class="difflineminus">-  folderDeleted: function(aFolder)</span>
<a href="#l23.153"></a><span id="l23.153" class="difflineminus">-  {</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineplus">+  folderDeleted(aFolder) {</span>
<a href="#l23.155"></a><span id="l23.155">     verify([MailServices.mfn.folderDeleted, aFolder]);</span>
<a href="#l23.156"></a><span id="l23.156" class="difflineminus">-    if (gExpectedEvents.length == 0)</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineminus">-    {</span>
<a href="#l23.158"></a><span id="l23.158" class="difflineplus">+    if (gExpectedEvents.length == 0) {</span>
<a href="#l23.159"></a><span id="l23.159">       gCurrStatus |= kStatus.notificationsDone;</span>
<a href="#l23.160"></a><span id="l23.160">       if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l23.161"></a><span id="l23.161">         resetStatusAndProceed();</span>
<a href="#l23.162"></a><span id="l23.162">     }</span>
<a href="#l23.163"></a><span id="l23.163">   },</span>
<a href="#l23.164"></a><span id="l23.164"> </span>
<a href="#l23.165"></a><span id="l23.165" class="difflineminus">-  folderMoveCopyCompleted: function(aMove, aSrcFolder, aDestFolder)</span>
<a href="#l23.166"></a><span id="l23.166" class="difflineminus">-  {</span>
<a href="#l23.167"></a><span id="l23.167" class="difflineplus">+  folderMoveCopyCompleted(aMove, aSrcFolder, aDestFolder) {</span>
<a href="#l23.168"></a><span id="l23.168">     verify([MailServices.mfn.folderMoveCopyCompleted, aMove, aSrcFolder, aDestFolder]);</span>
<a href="#l23.169"></a><span id="l23.169" class="difflineminus">-    if (gExpectedEvents.length == 0)</span>
<a href="#l23.170"></a><span id="l23.170" class="difflineminus">-    {</span>
<a href="#l23.171"></a><span id="l23.171" class="difflineplus">+    if (gExpectedEvents.length == 0) {</span>
<a href="#l23.172"></a><span id="l23.172">       gCurrStatus |= kStatus.notificationsDone;</span>
<a href="#l23.173"></a><span id="l23.173">       if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l23.174"></a><span id="l23.174">         resetStatusAndProceed();</span>
<a href="#l23.175"></a><span id="l23.175">     }</span>
<a href="#l23.176"></a><span id="l23.176">   },</span>
<a href="#l23.177"></a><span id="l23.177"> </span>
<a href="#l23.178"></a><span id="l23.178" class="difflineminus">-  folderRenamed: function(aOrigFolder, aNewFolder)</span>
<a href="#l23.179"></a><span id="l23.179" class="difflineminus">-  {</span>
<a href="#l23.180"></a><span id="l23.180" class="difflineplus">+  folderRenamed(aOrigFolder, aNewFolder) {</span>
<a href="#l23.181"></a><span id="l23.181">     verify([MailServices.mfn.folderRenamed, aOrigFolder, aNewFolder]);</span>
<a href="#l23.182"></a><span id="l23.182" class="difflineminus">-    if (gExpectedEvents.length == 0)</span>
<a href="#l23.183"></a><span id="l23.183" class="difflineminus">-    {</span>
<a href="#l23.184"></a><span id="l23.184" class="difflineplus">+    if (gExpectedEvents.length == 0) {</span>
<a href="#l23.185"></a><span id="l23.185">       gCurrStatus |= kStatus.notificationsDone;</span>
<a href="#l23.186"></a><span id="l23.186">       if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l23.187"></a><span id="l23.187">         resetStatusAndProceed();</span>
<a href="#l23.188"></a><span id="l23.188">     }</span>
<a href="#l23.189"></a><span id="l23.189">   },</span>
<a href="#l23.190"></a><span id="l23.190"> </span>
<a href="#l23.191"></a><span id="l23.191" class="difflineminus">-  itemEvent: function(aFolder, aEvent, aBetterBeNull, aBetterBeEmpty)</span>
<a href="#l23.192"></a><span id="l23.192" class="difflineminus">-  {</span>
<a href="#l23.193"></a><span id="l23.193" class="difflineplus">+  itemEvent(aFolder, aEvent, aBetterBeNull, aBetterBeEmpty) {</span>
<a href="#l23.194"></a><span id="l23.194">     // we currently require the third argument to be null, and the fourth to be</span>
<a href="#l23.195"></a><span id="l23.195">     // empty...</span>
<a href="#l23.196"></a><span id="l23.196">     Assert.equal(aBetterBeNull, null);</span>
<a href="#l23.197"></a><span id="l23.197">     Assert.equal(aBetterBeEmpty, &quot;&quot;);</span>
<a href="#l23.198"></a><span id="l23.198">     verify([MailServices.mfn.itemEvent, aFolder, aEvent]);</span>
<a href="#l23.199"></a><span id="l23.199" class="difflineminus">-    if (gExpectedEvents.length == 0)</span>
<a href="#l23.200"></a><span id="l23.200" class="difflineminus">-    {</span>
<a href="#l23.201"></a><span id="l23.201" class="difflineplus">+    if (gExpectedEvents.length == 0) {</span>
<a href="#l23.202"></a><span id="l23.202">       gCurrStatus |= kStatus.notificationsDone;</span>
<a href="#l23.203"></a><span id="l23.203">       if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l23.204"></a><span id="l23.204">         resetStatusAndProceed();</span>
<a href="#l23.205"></a><span id="l23.205">     }</span>
<a href="#l23.206"></a><span id="l23.206" class="difflineminus">-  }</span>
<a href="#l23.207"></a><span id="l23.207" class="difflineplus">+  },</span>
<a href="#l23.208"></a><span id="l23.208"> };</span>
<a href="#l23.209"></a><span id="l23.209"> </span>
<a href="#l23.210"></a><span id="l23.210"> // Copy listener, for proceeding after each operation.</span>
<a href="#l23.211"></a><span id="l23.211" class="difflineminus">-var copyListener =</span>
<a href="#l23.212"></a><span id="l23.212" class="difflineminus">-{</span>
<a href="#l23.213"></a><span id="l23.213" class="difflineplus">+var copyListener = {</span>
<a href="#l23.214"></a><span id="l23.214">   // For CopyFileMessage: this should be the folder the message is being stored to</span>
<a href="#l23.215"></a><span id="l23.215">   mFolderStoredIn: null,</span>
<a href="#l23.216"></a><span id="l23.216">   mMessageId: &quot;&quot;,</span>
<a href="#l23.217"></a><span id="l23.217" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l23.218"></a><span id="l23.218" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l23.219"></a><span id="l23.219" class="difflineminus">-  SetMessageKey: function(aKey)</span>
<a href="#l23.220"></a><span id="l23.220" class="difflineminus">-  {</span>
<a href="#l23.221"></a><span id="l23.221" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l23.222"></a><span id="l23.222" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l23.223"></a><span id="l23.223" class="difflineplus">+  SetMessageKey(aKey) {</span>
<a href="#l23.224"></a><span id="l23.224">     gHdrsReceived.push(this.mFolderStoredIn.GetMessageHeader(aKey));</span>
<a href="#l23.225"></a><span id="l23.225">   },</span>
<a href="#l23.226"></a><span id="l23.226" class="difflineminus">-  GetMessageId: function(aMessageId) {</span>
<a href="#l23.227"></a><span id="l23.227" class="difflineplus">+  GetMessageId(aMessageId) {</span>
<a href="#l23.228"></a><span id="l23.228">     aMessageId = {value: this.mMessageId};</span>
<a href="#l23.229"></a><span id="l23.229">   },</span>
<a href="#l23.230"></a><span id="l23.230" class="difflineminus">-  OnStopCopy: function(aStatus)</span>
<a href="#l23.231"></a><span id="l23.231" class="difflineminus">-  {</span>
<a href="#l23.232"></a><span id="l23.232" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l23.233"></a><span id="l23.233">     // Check: message successfully copied.</span>
<a href="#l23.234"></a><span id="l23.234">     Assert.equal(aStatus, 0);</span>
<a href="#l23.235"></a><span id="l23.235">     gCurrStatus |= kStatus.onStopCopyDone;</span>
<a href="#l23.236"></a><span id="l23.236">     if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l23.237"></a><span id="l23.237">       resetStatusAndProceed();</span>
<a href="#l23.238"></a><span id="l23.238" class="difflineminus">-  }</span>
<a href="#l23.239"></a><span id="l23.239" class="difflineplus">+  },</span>
<a href="#l23.240"></a><span id="l23.240"> };</span>
<a href="#l23.241"></a><span id="l23.241"> </span>
<a href="#l23.242"></a><span id="l23.242" class="difflineminus">-function resetStatusAndProceed()</span>
<a href="#l23.243"></a><span id="l23.243" class="difflineminus">-{</span>
<a href="#l23.244"></a><span id="l23.244" class="difflineplus">+function resetStatusAndProceed() {</span>
<a href="#l23.245"></a><span id="l23.245">   gHdrsReceived.length = 0;</span>
<a href="#l23.246"></a><span id="l23.246">   gCurrStatus = 0;</span>
<a href="#l23.247"></a><span id="l23.247">   // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l23.248"></a><span id="l23.248">   // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l23.249"></a><span id="l23.249">   // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l23.250"></a><span id="l23.250">   // to return</span>
<a href="#l23.251"></a><span id="l23.251" class="difflineminus">-  do_timeout(0, function(){doTest(++gTest);});</span>
<a href="#l23.252"></a><span id="l23.252" class="difflineplus">+  do_timeout(0, () =&gt; { this.doTest(++gTest); });</span>
<a href="#l23.253"></a><span id="l23.253"> }</span>
<a href="#l23.254"></a><span id="l23.254"> </span>
<a href="#l23.255"></a><span id="l23.255"> // Checks whether the array returned from a function has exactly these elements.</span>
<a href="#l23.256"></a><span id="l23.256" class="difflineminus">-function hasExactlyElements(array, elements)</span>
<a href="#l23.257"></a><span id="l23.257" class="difflineminus">-{</span>
<a href="#l23.258"></a><span id="l23.258" class="difflineplus">+function hasExactlyElements(array, elements) {</span>
<a href="#l23.259"></a><span id="l23.259">   // If an nsIArray (it could also be a single header or a folder)</span>
<a href="#l23.260"></a><span id="l23.260" class="difflineminus">-  if (elements instanceof Ci.nsIArray)</span>
<a href="#l23.261"></a><span id="l23.261" class="difflineminus">-  {</span>
<a href="#l23.262"></a><span id="l23.262" class="difflineplus">+  if (elements instanceof Ci.nsIArray) {</span>
<a href="#l23.263"></a><span id="l23.263">     var count = elements.length;</span>
<a href="#l23.264"></a><span id="l23.264"> </span>
<a href="#l23.265"></a><span id="l23.265">     // Check: array sizes should be equal.</span>
<a href="#l23.266"></a><span id="l23.266">     Assert.equal(count, array.length);</span>
<a href="#l23.267"></a><span id="l23.267"> </span>
<a href="#l23.268"></a><span id="l23.268" class="difflineminus">-    for (var i = 0; i &lt; count; i++)</span>
<a href="#l23.269"></a><span id="l23.269" class="difflineminus">-    {</span>
<a href="#l23.270"></a><span id="l23.270" class="difflineplus">+    for (let i = 0; i &lt; count; i++) {</span>
<a href="#l23.271"></a><span id="l23.271">       // Check: query element, must be a header or folder and present in the array</span>
<a href="#l23.272"></a><span id="l23.272">       var currElement;</span>
<a href="#l23.273"></a><span id="l23.273">       try {</span>
<a href="#l23.274"></a><span id="l23.274">         currElement = elements.queryElementAt(i, Ci.nsIMsgDBHdr);</span>
<a href="#l23.275"></a><span id="l23.275" class="difflineminus">-      }</span>
<a href="#l23.276"></a><span id="l23.276" class="difflineminus">-      catch (e) {}</span>
<a href="#l23.277"></a><span id="l23.277" class="difflineminus">-      if (!currElement)</span>
<a href="#l23.278"></a><span id="l23.278" class="difflineminus">-      {</span>
<a href="#l23.279"></a><span id="l23.279" class="difflineplus">+      } catch (e) {}</span>
<a href="#l23.280"></a><span id="l23.280" class="difflineplus">+      if (!currElement) {</span>
<a href="#l23.281"></a><span id="l23.281">         try {</span>
<a href="#l23.282"></a><span id="l23.282">           currElement = elements.queryElementAt(i, Ci.nsIMsgFolder);</span>
<a href="#l23.283"></a><span id="l23.283" class="difflineminus">-        }</span>
<a href="#l23.284"></a><span id="l23.284" class="difflineminus">-        catch (e) {}</span>
<a href="#l23.285"></a><span id="l23.285" class="difflineplus">+        } catch (e) {}</span>
<a href="#l23.286"></a><span id="l23.286">       }</span>
<a href="#l23.287"></a><span id="l23.287">       Assert.equal(typeof currElement, &quot;object&quot;);</span>
<a href="#l23.288"></a><span id="l23.288">       Assert.notEqual(mailTestUtils.non_strict_index_of(array, currElement), -1);</span>
<a href="#l23.289"></a><span id="l23.289">     }</span>
<a href="#l23.290"></a><span id="l23.290" class="difflineminus">-  }</span>
<a href="#l23.291"></a><span id="l23.291" class="difflineminus">-  // If a single header or a folder</span>
<a href="#l23.292"></a><span id="l23.292" class="difflineminus">-  else if (elements instanceof Ci.nsIMsgDBHdr || elements instanceof Ci.nsIMsgFolder)</span>
<a href="#l23.293"></a><span id="l23.293" class="difflineminus">-  {</span>
<a href="#l23.294"></a><span id="l23.294" class="difflineplus">+  } else if (elements instanceof Ci.nsIMsgDBHdr || elements instanceof Ci.nsIMsgFolder) {</span>
<a href="#l23.295"></a><span id="l23.295" class="difflineplus">+    // If a single header or a folder</span>
<a href="#l23.296"></a><span id="l23.296" class="difflineplus">+</span>
<a href="#l23.297"></a><span id="l23.297">     // Check: there should be only one element in the array.</span>
<a href="#l23.298"></a><span id="l23.298">     Assert.equal(array.length, 1);</span>
<a href="#l23.299"></a><span id="l23.299"> </span>
<a href="#l23.300"></a><span id="l23.300">     // Check: the element should be present</span>
<a href="#l23.301"></a><span id="l23.301">     Assert.notEqual(mailTestUtils.non_strict_index_of(array, elements), -1);</span>
<a href="#l23.302"></a><span id="l23.302" class="difflineplus">+  } else {</span>
<a href="#l23.303"></a><span id="l23.303" class="difflineplus">+    // This shouldn't happen</span>
<a href="#l23.304"></a><span id="l23.304" class="difflineplus">+    do_throw(&quot;Unrecognized item returned from listener&quot;);</span>
<a href="#l23.305"></a><span id="l23.305">   }</span>
<a href="#l23.306"></a><span id="l23.306" class="difflineminus">-  // This shouldn't happen</span>
<a href="#l23.307"></a><span id="l23.307" class="difflineminus">-  else</span>
<a href="#l23.308"></a><span id="l23.308" class="difflineminus">-    do_throw(&quot;Unrecognized item returned from listener&quot;);</span>
<a href="#l23.309"></a><span id="l23.309" class="difflineminus">-};</span>
<a href="#l23.310"></a><span id="l23.310" class="difflineplus">+}</span>
<a href="#l23.311"></a><span id="l23.311"> </span>
<a href="#l23.312"></a><span id="l23.312"> // Verifies an event</span>
<a href="#l23.313"></a><span id="l23.313" class="difflineminus">-function verify(event)</span>
<a href="#l23.314"></a><span id="l23.314" class="difflineminus">-{</span>
<a href="#l23.315"></a><span id="l23.315" class="difflineplus">+function verify(event) {</span>
<a href="#l23.316"></a><span id="l23.316">   // Check: make sure we actually have an item to process</span>
<a href="#l23.317"></a><span id="l23.317">   Assert.ok(gExpectedEvents.length &gt;= 1);</span>
<a href="#l23.318"></a><span id="l23.318">   var expected = gExpectedEvents.shift();</span>
<a href="#l23.319"></a><span id="l23.319"> </span>
<a href="#l23.320"></a><span id="l23.320">   // Check: events match.</span>
<a href="#l23.321"></a><span id="l23.321">   var eventType = expected[0];</span>
<a href="#l23.322"></a><span id="l23.322">   Assert.equal(event[0], eventType);</span>
<a href="#l23.323"></a><span id="l23.323"> </span>
<a href="#l23.324"></a><span id="l23.324">   dump(&quot;..... Verifying event type &quot; + eventType + &quot;\n&quot;);</span>
<a href="#l23.325"></a><span id="l23.325"> </span>
<a href="#l23.326"></a><span id="l23.326" class="difflineminus">-  switch (eventType)</span>
<a href="#l23.327"></a><span id="l23.327" class="difflineminus">-  {</span>
<a href="#l23.328"></a><span id="l23.328" class="difflineplus">+  switch (eventType) {</span>
<a href="#l23.329"></a><span id="l23.329">   case MailServices.mfn.msgAdded:</span>
<a href="#l23.330"></a><span id="l23.330">     // So for IMAP right now, we aren't able to get the actual nsIMsgDBHdr.</span>
<a href="#l23.331"></a><span id="l23.331">     // Instead, we'll match up message ids as a (poor?) substitute.</span>
<a href="#l23.332"></a><span id="l23.332" class="difflineminus">-    if (expected[1].expectedMessageId)</span>
<a href="#l23.333"></a><span id="l23.333" class="difflineminus">-    {</span>
<a href="#l23.334"></a><span id="l23.334" class="difflineplus">+    if (expected[1].expectedMessageId) {</span>
<a href="#l23.335"></a><span id="l23.335">       Assert.equal(expected[1].expectedMessageId, event[1].messageId);</span>
<a href="#l23.336"></a><span id="l23.336">       break;</span>
<a href="#l23.337"></a><span id="l23.337">     }</span>
<a href="#l23.338"></a><span id="l23.338">     // If we do have a header, fall through to the case below</span>
<a href="#l23.339"></a><span id="l23.339">   case MailServices.mfn.msgsDeleted:</span>
<a href="#l23.340"></a><span id="l23.340">   case MailServices.mfn.folderDeleted:</span>
<a href="#l23.341"></a><span id="l23.341">     // Check: headers match/folder matches.</span>
<a href="#l23.342"></a><span id="l23.342">     hasExactlyElements(expected[1], event[1]);</span>
<a href="#l23.343"></a><span id="l23.343" class="difflineat">@@ -291,18 +259,17 @@ function verify(event)</span>
<a href="#l23.344"></a><span id="l23.344">       if (event[1].length &lt; expected[1].length)</span>
<a href="#l23.345"></a><span id="l23.345">         do_throw(&quot;Not enough reported classified messages.&quot;);</span>
<a href="#l23.346"></a><span id="l23.346">       let ignoreCount = event[1].length - expected[1].length;</span>
<a href="#l23.347"></a><span id="l23.347">       for (let i = 0; i &lt; expected[1].length; i++) {</span>
<a href="#l23.348"></a><span id="l23.348">         let eventHeader = event[1].queryElementAt(i + ignoreCount,</span>
<a href="#l23.349"></a><span id="l23.349">                                                   Ci.nsIMsgDBHdr);</span>
<a href="#l23.350"></a><span id="l23.350">         Assert.equal(expected[1][i], eventHeader.messageId);</span>
<a href="#l23.351"></a><span id="l23.351">       }</span>
<a href="#l23.352"></a><span id="l23.352" class="difflineminus">-    }</span>
<a href="#l23.353"></a><span id="l23.353" class="difflineminus">-    else { // actual headers</span>
<a href="#l23.354"></a><span id="l23.354" class="difflineplus">+    } else { // actual headers</span>
<a href="#l23.355"></a><span id="l23.355">       hasExactlyElements(expected[1], event[1]);</span>
<a href="#l23.356"></a><span id="l23.356">     }</span>
<a href="#l23.357"></a><span id="l23.357">     // aJunkProcessed: was the message processed for junk?</span>
<a href="#l23.358"></a><span id="l23.358">     Assert.equal(expected[2], event[2]);</span>
<a href="#l23.359"></a><span id="l23.359">     // aTraitProcessed: was the message processed for traits?</span>
<a href="#l23.360"></a><span id="l23.360">     Assert.equal(expected[3], event[3]);</span>
<a href="#l23.361"></a><span id="l23.361">     break;</span>
<a href="#l23.362"></a><span id="l23.362">   case MailServices.mfn.msgKeyChanged:</span>
<a href="#l23.363"></a><span id="l23.363" class="difflineat">@@ -321,18 +288,17 @@ function verify(event)</span>
<a href="#l23.364"></a><span id="l23.364"> </span>
<a href="#l23.365"></a><span id="l23.365">     if (eventType == MailServices.mfn.folderMoveCopyCompleted)</span>
<a href="#l23.366"></a><span id="l23.366">       break;</span>
<a href="#l23.367"></a><span id="l23.367"> </span>
<a href="#l23.368"></a><span id="l23.368">     // Check: destination headers.  We expect these for local and imap folders,</span>
<a href="#l23.369"></a><span id="l23.369">     //  but we will not have heard about the headers ahead of time,</span>
<a href="#l23.370"></a><span id="l23.370">     //  so the best we can do is make sure they match up.  To this end,</span>
<a href="#l23.371"></a><span id="l23.371">     //  we check that the message-id header values match up.</span>
<a href="#l23.372"></a><span id="l23.372" class="difflineminus">-    for (let iMsg = 0; iMsg &lt; event[2].length; iMsg++)</span>
<a href="#l23.373"></a><span id="l23.373" class="difflineminus">-    {</span>
<a href="#l23.374"></a><span id="l23.374" class="difflineplus">+    for (let iMsg = 0; iMsg &lt; event[2].length; iMsg++) {</span>
<a href="#l23.375"></a><span id="l23.375">       let srcHdr = event[2].queryElementAt(iMsg, Ci.nsIMsgDBHdr);</span>
<a href="#l23.376"></a><span id="l23.376">       let destHdr = event[4].queryElementAt(iMsg, Ci.nsIMsgDBHdr);</span>
<a href="#l23.377"></a><span id="l23.377">       Assert.equal(srcHdr.messageId, destHdr.messageId);</span>
<a href="#l23.378"></a><span id="l23.378">     }</span>
<a href="#l23.379"></a><span id="l23.379">     break;</span>
<a href="#l23.380"></a><span id="l23.380">   case MailServices.mfn.folderAdded:</span>
<a href="#l23.381"></a><span id="l23.381">     // Check: parent folder matches</span>
<a href="#l23.382"></a><span id="l23.382">     Assert.equal(expected[1].URI, event[1].parent.URI);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/test/resources/passwordStorage.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/test/resources/passwordStorage.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -1,8 +1,14 @@</span>
<a href="#l24.4"></a><span id="l24.4" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l24.5"></a><span id="l24.5" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l24.6"></a><span id="l24.6" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l24.7"></a><span id="l24.7" class="difflineplus">+</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineplus">+/* globals gDEPTH */</span>
<a href="#l24.9"></a><span id="l24.9" class="difflineplus">+</span>
<a href="#l24.10"></a><span id="l24.10"> if (typeof gDEPTH == &quot;undefined&quot;)</span>
<a href="#l24.11"></a><span id="l24.11">   do_throw(&quot;gDEPTH must be defined when using passwordStorage.js&quot;);</span>
<a href="#l24.12"></a><span id="l24.12"> </span>
<a href="#l24.13"></a><span id="l24.13"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l24.14"></a><span id="l24.14"> </span>
<a href="#l24.15"></a><span id="l24.15"> /**</span>
<a href="#l24.16"></a><span id="l24.16">  * Use the given storage database as the current signon database.</span>
<a href="#l24.17"></a><span id="l24.17">  * @returns Promise When the storage database is usable.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/test/resources/searchTestUtils.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/test/resources/searchTestUtils.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -1,13 +1,13 @@</span>
<a href="#l25.4"></a><span id="l25.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.5"></a><span id="l25.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.8"></a><span id="l25.8"> </span>
<a href="#l25.9"></a><span id="l25.9" class="difflineminus">- // Contains various functions commonly used in testing mailnews search</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineplus">+// Contains various functions commonly used in testing mailnews search.</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12"> /**</span>
<a href="#l25.13"></a><span id="l25.13">  * TestSearch: Class to test number of search hits</span>
<a href="#l25.14"></a><span id="l25.14">  *</span>
<a href="#l25.15"></a><span id="l25.15">  * @param aFolder:   the folder to search</span>
<a href="#l25.16"></a><span id="l25.16">  * @param aValue:    value used for the search</span>
<a href="#l25.17"></a><span id="l25.17">  *                   The interpretation of aValue depends on aAttrib. It</span>
<a href="#l25.18"></a><span id="l25.18">  *                   defaults to string, but for certain attributes other</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineat">@@ -20,30 +20,27 @@</span>
<a href="#l25.20"></a><span id="l25.20">  * @param onDone:    function to call on completion of search</span>
<a href="#l25.21"></a><span id="l25.21">  * @param aCustomId: id string for the custom action, if aAttrib is Custom</span>
<a href="#l25.22"></a><span id="l25.22">  * @param aArbitraryHeader  for OtherHeader case, header.</span>
<a href="#l25.23"></a><span id="l25.23">  * @param aHdrProperty      for HdrProperty and Uint32HdrProperty case</span>
<a href="#l25.24"></a><span id="l25.24">  *</span>
<a href="#l25.25"></a><span id="l25.25">  */</span>
<a href="#l25.26"></a><span id="l25.26"> </span>
<a href="#l25.27"></a><span id="l25.27"> function TestSearch(aFolder, aValue, aAttrib, aOp, aHitCount, onDone, aCustomId,</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-                    aArbitraryHeader, aHdrProperty)</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-{</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-  var searchListener =</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-  {</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-    onSearchHit: function(dbHdr, folder) { hitCount++; },</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-    onSearchDone: function(status)</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineminus">-    {</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineplus">+                    aArbitraryHeader, aHdrProperty) {</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineplus">+  var searchListener = {</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineplus">+    onSearchHit(dbHdr, folder) { hitCount++; },</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineplus">+    onSearchDone(status) {</span>
<a href="#l25.39"></a><span id="l25.39">       print(&quot;Finished search does &quot; + aHitCount + &quot; equal &quot; + hitCount + &quot;?&quot;);</span>
<a href="#l25.40"></a><span id="l25.40">       searchSession = null;</span>
<a href="#l25.41"></a><span id="l25.41">       Assert.equal(aHitCount, hitCount);</span>
<a href="#l25.42"></a><span id="l25.42">       if (onDone)</span>
<a href="#l25.43"></a><span id="l25.43">         onDone();</span>
<a href="#l25.44"></a><span id="l25.44">     },</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineminus">-    onNewSearch: function() {hitCount = 0;}</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineplus">+    onNewSearch() { hitCount = 0; },</span>
<a href="#l25.47"></a><span id="l25.47">   };</span>
<a href="#l25.48"></a><span id="l25.48"> </span>
<a href="#l25.49"></a><span id="l25.49">   // define and initiate the search session</span>
<a href="#l25.50"></a><span id="l25.50"> </span>
<a href="#l25.51"></a><span id="l25.51">   var hitCount;</span>
<a href="#l25.52"></a><span id="l25.52">   var searchSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l25.53"></a><span id="l25.53">                         .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l25.54"></a><span id="l25.54">   searchSession.addScopeTerm(Ci.nsMsgSearchScope.offlineMail, aFolder);</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineat">@@ -98,27 +95,23 @@ function TestSearch(aFolder, aValue, aAt</span>
<a href="#l25.56"></a><span id="l25.56"> /*</span>
<a href="#l25.57"></a><span id="l25.57">  * Test search validity table Available and Enabled settings</span>
<a href="#l25.58"></a><span id="l25.58">  *</span>
<a href="#l25.59"></a><span id="l25.59">  * @param aScope:  search scope (Ci.nsMsgSearchScope.offlineMail, etc.)</span>
<a href="#l25.60"></a><span id="l25.60">  * @param aOp:     search operation (Ci.nsMsgSearchOp.Contains, etc.)</span>
<a href="#l25.61"></a><span id="l25.61">  * @param aAttrib: search attribute (Ci.nsMsgSearchAttrib.Size, etc.)</span>
<a href="#l25.62"></a><span id="l25.62">  * @param aValue:  expected value (true/false) for Available and Enabled</span>
<a href="#l25.63"></a><span id="l25.63">  */</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineminus">- const gValidityManager = Cc['@mozilla.org/mail/search/validityManager;1']</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineminus">-                          .getService(Ci.nsIMsgSearchValidityManager);</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineplus">+ const gValidityManager = Cc[&quot;@mozilla.org/mail/search/validityManager;1&quot;]</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineplus">+                            .getService(Ci.nsIMsgSearchValidityManager);</span>
<a href="#l25.68"></a><span id="l25.68"> </span>
<a href="#l25.69"></a><span id="l25.69" class="difflineminus">-function testValidityTable(aScope, aOp, aAttrib, aValue)</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineminus">-{</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineplus">+function testValidityTable(aScope, aOp, aAttrib, aValue) {</span>
<a href="#l25.72"></a><span id="l25.72">   var validityTable = gValidityManager.getTable(aScope);</span>
<a href="#l25.73"></a><span id="l25.73">   var isAvailable = validityTable.getAvailable(aAttrib, aOp);</span>
<a href="#l25.74"></a><span id="l25.74">   var isEnabled = validityTable.getEnabled(aAttrib, aOp);</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineminus">-  if (aValue)</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineminus">-  {</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineplus">+  if (aValue) {</span>
<a href="#l25.78"></a><span id="l25.78">     Assert.ok(isAvailable);</span>
<a href="#l25.79"></a><span id="l25.79">     Assert.ok(isEnabled);</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineminus">-  }</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineminus">-  else</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineminus">-  {</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineplus">+  } else {</span>
<a href="#l25.84"></a><span id="l25.84">     Assert.ok(!isAvailable);</span>
<a href="#l25.85"></a><span id="l25.85">     Assert.ok(!isEnabled);</span>
<a href="#l25.86"></a><span id="l25.86">   }</span>
<a href="#l25.87"></a><span id="l25.87"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

