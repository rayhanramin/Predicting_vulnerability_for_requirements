<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26228:d167921e42eba41654952c307cec2f0fcaa022d2</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ d167921e42eba41654952c307cec2f0fcaa022d2" />
<meta property="og:url" content="/comm-central/rev/d167921e42eba41654952c307cec2f0fcaa022d2" />
<meta property="og:description" content="Bug 1345167 - Enhance UI display/feedback for external (deleted, detached to file, and http link) attachments. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / d167921e42eba41654952c307cec2f0fcaa022d2 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/d167921e42eba41654952c307cec2f0fcaa022d2">shortlog</a> |
<a href="/comm-central/log/d167921e42eba41654952c307cec2f0fcaa022d2">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/d167921e42eba41654952c307cec2f0fcaa022d2">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/d167921e42eba41654952c307cec2f0fcaa022d2">files</a> |
changeset |
<a href="/comm-central/raw-rev/d167921e42eba41654952c307cec2f0fcaa022d2">raw</a>  | <a href="/comm-central/archive/d167921e42eba41654952c307cec2f0fcaa022d2.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1345167">Bug 1345167</a> - Enhance UI display/feedback for external (deleted, detached to file, and http link) attachments. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#108;&#116;&#97;&#56;&#56;&#64;&#102;&#105;&#120;&#97;&#108;&#108;&#46;&#99;&#111;&#109;</td></tr>
<tr><td></td><td class="date age">Sun, 31 Mar 2019 10:02:26 -0600</td></tr>

<tr>
 <td>changeset 26228</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/d167921e42eba41654952c307cec2f0fcaa022d2">d167921e42eba41654952c307cec2f0fcaa022d2</a></td>
</tr>



<tr>
<td>parent 26227</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ae892d0e67b279d9fc385e464fad39da37408315">ae892d0e67b279d9fc385e464fad39da37408315</a>
</td>
</tr>

<tr>
<td>child 26229</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a240e0e27ce5c54a13857b4046f797eff255a4c4">a240e0e27ce5c54a13857b4046f797eff255a4c4</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=d167921e42eba41654952c307cec2f0fcaa022d2">15740</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 03 Apr 2019 21:15:31 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a240e0e27ce5 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a240e0e27ce5c54a13857b4046f797eff255a4c4">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a240e0e27ce5c54a13857b4046f797eff255a4c4&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a240e0e27ce5c54a13857b4046f797eff255a4c4&newProject=comm-central&newRevision=d167921e42eba41654952c307cec2f0fcaa022d2&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a240e0e27ce5c54a13857b4046f797eff255a4c4&newProject=comm-central&newRevision=d167921e42eba41654952c307cec2f0fcaa022d2&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a240e0e27ce5c54a13857b4046f797eff255a4c4&newProject=comm-central&newRevision=d167921e42eba41654952c307cec2f0fcaa022d2&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1345167">1345167</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1345167">Bug 1345167</a> - Enhance UI display/feedback for external (deleted, detached to file, and http link) attachments. r=mkmelin

Also: replace nsIBinaryInputStream with fetch() to test for attachment sizes; adjust UI for async; add Open Containing Folder menuitem.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/attachmentList.css">mail/base/content/attachmentList.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/attachmentList.css">file</a> |
<a href="/comm-central/annotate/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/attachmentList.css">annotate</a> |
<a href="/comm-central/diff/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/attachmentList.css">diff</a> |
<a href="/comm-central/comparison/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/attachmentList.css">comparison</a> |
<a href="/comm-central/log/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/attachmentList.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/mailWidgets.xml">mail/base/content/mailWidgets.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/mailWidgets.xml">file</a> |
<a href="/comm-central/annotate/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/mailWidgets.xml">annotate</a> |
<a href="/comm-central/diff/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/mailWidgets.xml">diff</a> |
<a href="/comm-central/comparison/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/mailWidgets.xml">comparison</a> |
<a href="/comm-central/log/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/mailWidgets.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/mailWindow.js">mail/base/content/mailWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/mailWindow.js">file</a> |
<a href="/comm-central/annotate/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/mailWindow.js">annotate</a> |
<a href="/comm-central/diff/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/mailWindow.js">diff</a> |
<a href="/comm-central/comparison/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/mailWindow.js">comparison</a> |
<a href="/comm-central/log/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/mailWindow.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/msgAttachmentView.inc.xul">mail/base/content/msgAttachmentView.inc.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/msgAttachmentView.inc.xul">file</a> |
<a href="/comm-central/annotate/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/msgAttachmentView.inc.xul">annotate</a> |
<a href="/comm-central/diff/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/msgAttachmentView.inc.xul">diff</a> |
<a href="/comm-central/comparison/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/msgAttachmentView.inc.xul">comparison</a> |
<a href="/comm-central/log/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/msgAttachmentView.inc.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/msgHdrPopup.inc.xul">mail/base/content/msgHdrPopup.inc.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/msgHdrPopup.inc.xul">file</a> |
<a href="/comm-central/annotate/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/msgHdrPopup.inc.xul">annotate</a> |
<a href="/comm-central/diff/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/msgHdrPopup.inc.xul">diff</a> |
<a href="/comm-central/comparison/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/msgHdrPopup.inc.xul">comparison</a> |
<a href="/comm-central/log/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/msgHdrPopup.inc.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/msgHdrView.js">mail/base/content/msgHdrView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/msgHdrView.js">file</a> |
<a href="/comm-central/annotate/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/msgHdrView.js">annotate</a> |
<a href="/comm-central/diff/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/msgHdrView.js">diff</a> |
<a href="/comm-central/comparison/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/msgHdrView.js">comparison</a> |
<a href="/comm-central/log/d167921e42eba41654952c307cec2f0fcaa022d2/mail/base/content/msgHdrView.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d167921e42eba41654952c307cec2f0fcaa022d2/mail/locales/en-US/chrome/messenger/messenger.properties">mail/locales/en-US/chrome/messenger/messenger.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d167921e42eba41654952c307cec2f0fcaa022d2/mail/locales/en-US/chrome/messenger/messenger.properties">file</a> |
<a href="/comm-central/annotate/d167921e42eba41654952c307cec2f0fcaa022d2/mail/locales/en-US/chrome/messenger/messenger.properties">annotate</a> |
<a href="/comm-central/diff/d167921e42eba41654952c307cec2f0fcaa022d2/mail/locales/en-US/chrome/messenger/messenger.properties">diff</a> |
<a href="/comm-central/comparison/d167921e42eba41654952c307cec2f0fcaa022d2/mail/locales/en-US/chrome/messenger/messenger.properties">comparison</a> |
<a href="/comm-central/log/d167921e42eba41654952c307cec2f0fcaa022d2/mail/locales/en-US/chrome/messenger/messenger.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d167921e42eba41654952c307cec2f0fcaa022d2/mail/locales/en-US/chrome/messenger/msgHdrViewOverlay.dtd">mail/locales/en-US/chrome/messenger/msgHdrViewOverlay.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d167921e42eba41654952c307cec2f0fcaa022d2/mail/locales/en-US/chrome/messenger/msgHdrViewOverlay.dtd">file</a> |
<a href="/comm-central/annotate/d167921e42eba41654952c307cec2f0fcaa022d2/mail/locales/en-US/chrome/messenger/msgHdrViewOverlay.dtd">annotate</a> |
<a href="/comm-central/diff/d167921e42eba41654952c307cec2f0fcaa022d2/mail/locales/en-US/chrome/messenger/msgHdrViewOverlay.dtd">diff</a> |
<a href="/comm-central/comparison/d167921e42eba41654952c307cec2f0fcaa022d2/mail/locales/en-US/chrome/messenger/msgHdrViewOverlay.dtd">comparison</a> |
<a href="/comm-central/log/d167921e42eba41654952c307cec2f0fcaa022d2/mail/locales/en-US/chrome/messenger/msgHdrViewOverlay.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d167921e42eba41654952c307cec2f0fcaa022d2/mail/themes/linux/mail/attachmentList.css">mail/themes/linux/mail/attachmentList.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d167921e42eba41654952c307cec2f0fcaa022d2/mail/themes/linux/mail/attachmentList.css">file</a> |
<a href="/comm-central/annotate/d167921e42eba41654952c307cec2f0fcaa022d2/mail/themes/linux/mail/attachmentList.css">annotate</a> |
<a href="/comm-central/diff/d167921e42eba41654952c307cec2f0fcaa022d2/mail/themes/linux/mail/attachmentList.css">diff</a> |
<a href="/comm-central/comparison/d167921e42eba41654952c307cec2f0fcaa022d2/mail/themes/linux/mail/attachmentList.css">comparison</a> |
<a href="/comm-central/log/d167921e42eba41654952c307cec2f0fcaa022d2/mail/themes/linux/mail/attachmentList.css">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/attachmentList.css</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/attachmentList.css</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -57,8 +57,19 @@</span>
<a href="#l1.4"></a><span id="l1.4"> .attachmentList[orient=&quot;horizontal&quot;] &gt; .attachmentItem {</span>
<a href="#l1.5"></a><span id="l1.5">   min-width: 10em;</span>
<a href="#l1.6"></a><span id="l1.6"> }</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> .attachmentList[orient=&quot;horizontal&quot;][view=&quot;tile&quot;] &gt; .attachmentItem {</span>
<a href="#l1.9"></a><span id="l1.9">   min-width: 5em;</span>
<a href="#l1.10"></a><span id="l1.10">   max-width: 10em;</span>
<a href="#l1.11"></a><span id="l1.11"> }</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+#attachmentMenuList &gt; menu:hover &gt; .text-link {</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  text-decoration-line: underline;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+}</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+#attachmentName.notfound,</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+.attachmentItem.notfound,</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+#attachmentMenuList &gt; menu.notfound,</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+#appmenu_attachmentMenuList &gt; menu.notfound {</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+  text-decoration-line: line-through;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/mailWidgets.xml</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/mailWidgets.xml</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -323,18 +323,24 @@</span>
<a href="#l2.4"></a><span id="l2.4">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.5"></a><span id="l2.5">           if (this._childNodes.length == 0)</span>
<a href="#l2.6"></a><span id="l2.6">             return;</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">           let width = 0;</span>
<a href="#l2.9"></a><span id="l2.9">           let border = this._childNodes[0].boxObject.width -</span>
<a href="#l2.10"></a><span id="l2.10">                        this._childNodes[0].clientWidth;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-          for (let child of this._childNodes)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+          // If widths have changed after the initial calculation (updated</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+          // size string), clear each item's prior hardcoded width so</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+          // scrollwidth is natural, then get the width for the widest item</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+          // and set it on all the items again.</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+          for (let child of this._childNodes) {</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+            child.width = &quot;&quot;;</span>
<a href="#l2.19"></a><span id="l2.19">             width = Math.max(width, child.scrollWidth);</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+          }</span>
<a href="#l2.21"></a><span id="l2.21">           for (let child of this._childNodes)</span>
<a href="#l2.22"></a><span id="l2.22">             child.width = width + border;</span>
<a href="#l2.23"></a><span id="l2.23">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.24"></a><span id="l2.24">       &lt;/method&gt;</span>
<a href="#l2.25"></a><span id="l2.25">     &lt;/implementation&gt;</span>
<a href="#l2.26"></a><span id="l2.26">     &lt;handlers&gt;</span>
<a href="#l2.27"></a><span id="l2.27">       &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_LEFT&quot; modifiers=&quot;control shift any&quot;</span>
<a href="#l2.28"></a><span id="l2.28">                action=&quot;this.moveByOffset(-1, !event.ctrlKey, event.shiftKey);&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/mailWindow.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/mailWindow.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -255,22 +255,38 @@ nsMsgStatusFeedback.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4">   },</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6">   // nsIXULBrowserWindow implementation.</span>
<a href="#l3.7"></a><span id="l3.7">   setJSStatus(status) {</span>
<a href="#l3.8"></a><span id="l3.8">     if (status.length &gt; 0)</span>
<a href="#l3.9"></a><span id="l3.9">       this.showStatusString(status);</span>
<a href="#l3.10"></a><span id="l3.10">   },</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  setOverLink(link, context) {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  /*</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+   * Set the statusbar display for hovered links, from browser.js.</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+   *</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+   * @param {String} url        - The href to display.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+   * @param {Element} anchorElt - Element.</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+   */</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+  setOverLink(url, anchorElt) {</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+    if (url) {</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+      url = Services.textToSubURI.unEscapeURIForUI(&quot;UTF-8&quot;, url);</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+      // Encode bidirectional formatting characters.</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+      // (RFC 3987 sections 3.2 and 4.1 paragraph 6)</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+      url = url.replace(/[\u200e\u200f\u202a\u202b\u202c\u202d\u202e]/g,</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+                        encodeURIComponent);</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+    }</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+</span>
<a href="#l3.29"></a><span id="l3.29">     if (!document.getElementById(&quot;status-bar&quot;).hidden) {</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-      this._statusText.label = link;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+      this._statusText.label = url;</span>
<a href="#l3.32"></a><span id="l3.32">     } else {</span>
<a href="#l3.33"></a><span id="l3.33">       // Statusbar invisible: Show link in statuspanel instead.</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-      this._statusPanel.label = link;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+      // TODO: consider porting the Firefox implementation of LinkTargetDisplay.</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+      this._statusPanel.label = url;</span>
<a href="#l3.37"></a><span id="l3.37">     }</span>
<a href="#l3.38"></a><span id="l3.38">   },</span>
<a href="#l3.39"></a><span id="l3.39"> </span>
<a href="#l3.40"></a><span id="l3.40">   // Called before links are navigated to to allow us to retarget them if needed.</span>
<a href="#l3.41"></a><span id="l3.41">   onBeforeLinkTraversal(originalTarget, linkURI, linkNode, isAppTab) {</span>
<a href="#l3.42"></a><span id="l3.42">     return originalTarget;</span>
<a href="#l3.43"></a><span id="l3.43">   },</span>
<a href="#l3.44"></a><span id="l3.44"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/msgAttachmentView.inc.xul</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/msgAttachmentView.inc.xul</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -12,16 +12,17 @@</span>
<a href="#l4.4"></a><span id="l4.4">                                   onclick=&quot;event.stopPropagation();&quot;</span>
<a href="#l4.5"></a><span id="l4.5">                                   oncommand=&quot;toggleAttachmentList(this.checked, true);&quot;/&gt;</span>
<a href="#l4.6"></a><span id="l4.6">                           &lt;hbox align=&quot;center&quot; id=&quot;attachmentInfo&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l4.7"></a><span id="l4.7">                             &lt;image id=&quot;attachmentIcon&quot;/&gt;</span>
<a href="#l4.8"></a><span id="l4.8">                             &lt;label id=&quot;attachmentCount&quot;/&gt;</span>
<a href="#l4.9"></a><span id="l4.9">                             &lt;label id=&quot;attachmentName&quot; crop=&quot;center&quot; flex=&quot;1&quot;</span>
<a href="#l4.10"></a><span id="l4.10">                                    role=&quot;button&quot;</span>
<a href="#l4.11"></a><span id="l4.11">                                    tooltiptext=&quot;&amp;openAttachment.tooltip;&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+                                   tooltiptextopen=&quot;&amp;openAttachment.tooltip;&quot;</span>
<a href="#l4.13"></a><span id="l4.13">                                    onclick=&quot;OpenAttachmentFromBar(event);&quot;</span>
<a href="#l4.14"></a><span id="l4.14">                                    ondragstart=&quot;nsDragAndDrop.startDrag(event,attachmentNameDNDObserver);&quot;/&gt;</span>
<a href="#l4.15"></a><span id="l4.15">                             &lt;label id=&quot;attachmentSize&quot;/&gt;</span>
<a href="#l4.16"></a><span id="l4.16">                           &lt;/hbox&gt;</span>
<a href="#l4.17"></a><span id="l4.17">                           &lt;!-- Use a very large flex value here so that attachmentCount doesn't take</span>
<a href="#l4.18"></a><span id="l4.18">                                up more space than necessary, but still crops itself if there's not</span>
<a href="#l4.19"></a><span id="l4.19">                                enough space. --&gt;</span>
<a href="#l4.20"></a><span id="l4.20">                           &lt;spacer flex=&quot;9999&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/content/msgHdrPopup.inc.xul</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/content/msgHdrPopup.inc.xul</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -44,16 +44,25 @@</span>
<a href="#l5.4"></a><span id="l5.4">               label=&quot;&amp;deleteAttachmentCmd.label;&quot;</span>
<a href="#l5.5"></a><span id="l5.5">               accesskey=&quot;&amp;deleteAttachmentCmd.accesskey;&quot;</span>
<a href="#l5.6"></a><span id="l5.6">               oncommand=&quot;HandleMultipleAttachments(this.parentNode.attachments, 'delete');&quot;/&gt;</span>
<a href="#l5.7"></a><span id="l5.7">     &lt;menuseparator id=&quot;context-menu-copyurl-separator&quot;/&gt;</span>
<a href="#l5.8"></a><span id="l5.8">     &lt;menuitem id=&quot;context-copyAttachmentUrl&quot;</span>
<a href="#l5.9"></a><span id="l5.9">               label=&quot;&amp;copyLinkCmd.label;&quot;</span>
<a href="#l5.10"></a><span id="l5.10">               accesskey=&quot;&amp;copyLinkCmd.accesskey;&quot;</span>
<a href="#l5.11"></a><span id="l5.11">               oncommand=&quot;HandleMultipleAttachments(this.parentNode.attachments, 'copyUrl');&quot;/&gt;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+    &lt;menuitem id=&quot;context-openFolder&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+#ifdef XP_MACOSX</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+              label=&quot;&amp;detachedAttachmentFolder.showMac.label;&quot;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+              accesskey=&quot;&amp;detachedAttachmentFolder.showMac.accesskey;&quot;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+#else</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+              label=&quot;&amp;detachedAttachmentFolder.show.label;&quot;</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+              accesskey=&quot;&amp;detachedAttachmentFolder.show.accesskey;&quot;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+#endif</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+              oncommand=&quot;HandleMultipleAttachments(this.parentNode.attachments, 'openFolder');&quot;/&gt;</span>
<a href="#l5.21"></a><span id="l5.21">   &lt;/menupopup&gt;</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23">   &lt;menupopup id=&quot;attachmentListContext&quot;</span>
<a href="#l5.24"></a><span id="l5.24">              onpopupshowing=&quot;goUpdateAttachmentCommands();&quot;&gt;</span>
<a href="#l5.25"></a><span id="l5.25">     &lt;menuitem id=&quot;context-openAllAttachments&quot;</span>
<a href="#l5.26"></a><span id="l5.26">               label=&quot;&amp;openAllAttachmentsCmd.label;&quot;</span>
<a href="#l5.27"></a><span id="l5.27">               accesskey=&quot;&amp;openAllAttachmentsCmd.accesskey;&quot;</span>
<a href="#l5.28"></a><span id="l5.28">               command=&quot;cmd_openAllAttachments&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/content/msgHdrView.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/content/msgHdrView.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -573,35 +573,18 @@ var messageHeaderSink = {</span>
<a href="#l6.4"></a><span id="l6.4">                                .messageURIToMsgHdr(uri);</span>
<a href="#l6.5"></a><span id="l6.5">     if (contentType == &quot;text/x-vcard&quot;) {</span>
<a href="#l6.6"></a><span id="l6.6">       var inlineAttachments = Services.prefs.getBoolPref(&quot;mail.inline_attachments&quot;);</span>
<a href="#l6.7"></a><span id="l6.7">       var displayHtmlAs = Services.prefs.getIntPref(&quot;mailnews.display.html_as&quot;);</span>
<a href="#l6.8"></a><span id="l6.8">       if (inlineAttachments &amp;&amp; !displayHtmlAs)</span>
<a href="#l6.9"></a><span id="l6.9">         return;</span>
<a href="#l6.10"></a><span id="l6.10">     }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    var size = null;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-    if (isExternalAttachment &amp;&amp; url.startsWith(&quot;file:&quot;)) {</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-      let fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-        .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-      try {</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-        let file = fileHandler.getFileFromURLSpec(url);</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-        // Can't get size for detached attachments which are no longer</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-        // available on the specified location.</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-        if (file.exists())</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-          size = file.fileSize;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-      } catch (e) {</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-        Cu.reportError(&quot;Couldn't open external attachment; &quot; +</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-                       &quot;url=&quot; + url + &quot;; &quot; + e);</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-      }</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-    }</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-</span>
<a href="#l6.28"></a><span id="l6.28">     currentAttachments.push(new AttachmentInfo(contentType, url, displayName,</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-                                               uri, isExternalAttachment,</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-                                               size));</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+                                               uri, isExternalAttachment));</span>
<a href="#l6.32"></a><span id="l6.32">     this.skipAttachment = false;</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34">     // If we have an attachment, set the nsMsgMessageFlags.Attachment flag</span>
<a href="#l6.35"></a><span id="l6.35">     // on the hdr to cause the &quot;message with attachment&quot; icon to show up</span>
<a href="#l6.36"></a><span id="l6.36">     // in the thread pane.</span>
<a href="#l6.37"></a><span id="l6.37">     // We only need to do this on the first attachment.</span>
<a href="#l6.38"></a><span id="l6.38">     var numAttachments = currentAttachments.length;</span>
<a href="#l6.39"></a><span id="l6.39">     if (numAttachments == 1) {</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineat">@@ -622,39 +605,51 @@ var messageHeaderSink = {</span>
<a href="#l6.41"></a><span id="l6.41">     }</span>
<a href="#l6.42"></a><span id="l6.42">   },</span>
<a href="#l6.43"></a><span id="l6.43"> </span>
<a href="#l6.44"></a><span id="l6.44">   addAttachmentField(field, value) {</span>
<a href="#l6.45"></a><span id="l6.45">     if (this.skipAttachment)</span>
<a href="#l6.46"></a><span id="l6.46">       return;</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48">     let last = currentAttachments[currentAttachments.length - 1];</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-    if (field == &quot;X-Mozilla-PartSize&quot; &amp;&amp; !last.url.startsWith(&quot;file&quot;) &amp;&amp;</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+    if (field == &quot;X-Mozilla-PartSize&quot; &amp;&amp; !last.isFileAttachment &amp;&amp;</span>
<a href="#l6.51"></a><span id="l6.51">         !last.isDeleted) {</span>
<a href="#l6.52"></a><span id="l6.52">       let size = parseInt(value);</span>
<a href="#l6.53"></a><span id="l6.53"> </span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-      if (last.isExternalAttachment &amp;&amp; last.url.startsWith(&quot;http&quot;)) {</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+      if (last.isLinkAttachment) {</span>
<a href="#l6.56"></a><span id="l6.56">         // Check if an external link attachment's reported size is sane.</span>
<a href="#l6.57"></a><span id="l6.57">         // A size of &lt; 2 isn't sensical so ignore such placeholder values.</span>
<a href="#l6.58"></a><span id="l6.58">         // Don't accept a size with any non numerics. Also cap the number.</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-        if (isNaN(size) || size.toString().length != value.length || size &lt; 2)</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-          size = -1;</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-        if (size &gt; Number.MAX_SAFE_INTEGER)</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-          size = Number.MAX_SAFE_INTEGER;</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+        // We want the size to be checked again, upon user action, to make</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+        // sure size is updated with an accurate value, so |sizeResolved|</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+        // remains false.</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+        if (isNaN(size) || size.toString().length != value.length || size &lt; 2) {</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+          last.size = -1;</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+        } else if (size &gt; Number.MAX_SAFE_INTEGER) {</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+          last.size = Number.MAX_SAFE_INTEGER;</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+        } else {</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+          last.size = size;</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+        }</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+      } else if (size == -1) {</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+        // libmime returns -1 if it never managed to figure out the size. We</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+        // want fetch() to check again for internal attachments in this case,</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+        // otherwise we accept libmime's value and set |sizeResolved|.</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+        // A fetch() for a resolved size can still be requested if</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+        // |ALWAYSFETCHSIZE| is true.</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+        last.size = -1;</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+      } else {</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+        last.size = size;</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+        last.sizeResolved = true;</span>
<a href="#l6.83"></a><span id="l6.83">       }</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-      // libmime returns -1 if it never managed to figure out the size.</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-      if (size != -1)</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-        last.size = size;</span>
<a href="#l6.88"></a><span id="l6.88">     } else if (field == &quot;X-Mozilla-PartDownloaded&quot; &amp;&amp; value == &quot;0&quot;) {</span>
<a href="#l6.89"></a><span id="l6.89">       // We haven't downloaded the attachment, so any size we get from</span>
<a href="#l6.90"></a><span id="l6.90">       // libmime is almost certainly inaccurate. Just get rid of it. (Note:</span>
<a href="#l6.91"></a><span id="l6.91">       // this relies on the fact that PartDownloaded comes after PartSize from</span>
<a href="#l6.92"></a><span id="l6.92">       // the MIME emitter.)</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-      last.size = null;</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+      last.size = -1;</span>
<a href="#l6.95"></a><span id="l6.95">     }</span>
<a href="#l6.96"></a><span id="l6.96">   },</span>
<a href="#l6.97"></a><span id="l6.97"> </span>
<a href="#l6.98"></a><span id="l6.98">   onEndAllAttachments() {</span>
<a href="#l6.99"></a><span id="l6.99">     displayAttachmentsForExpandedView();</span>
<a href="#l6.100"></a><span id="l6.100"> </span>
<a href="#l6.101"></a><span id="l6.101">     for (let listener of gMessageListeners) {</span>
<a href="#l6.102"></a><span id="l6.102">       if (&quot;onEndAttachments&quot; in listener)</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineat">@@ -666,22 +661,16 @@ var messageHeaderSink = {</span>
<a href="#l6.104"></a><span id="l6.104">    * This event is generated by nsMsgStatusFeedback when it gets an</span>
<a href="#l6.105"></a><span id="l6.105">    * OnStateChange event for STATE_STOP.  This is the same event that</span>
<a href="#l6.106"></a><span id="l6.106">    * generates the &quot;msgLoaded&quot; property flag change event.  This best</span>
<a href="#l6.107"></a><span id="l6.107">    * corresponds to the end of the streaming process.</span>
<a href="#l6.108"></a><span id="l6.108">    */</span>
<a href="#l6.109"></a><span id="l6.109">   onEndMsgDownload(url) {</span>
<a href="#l6.110"></a><span id="l6.110">     gMessageDisplay.onLoadCompleted();</span>
<a href="#l6.111"></a><span id="l6.111"> </span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-    let expanded = Services.prefs.getBoolPref(</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-      &quot;mailnews.attachments.display.start_expanded&quot;);</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-    if (expanded)</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-      toggleAttachmentList(true);</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-</span>
<a href="#l6.118"></a><span id="l6.118">     // if we don't have any attachments, turn off the attachments flag</span>
<a href="#l6.119"></a><span id="l6.119">     if (!this.mSaveHdr) {</span>
<a href="#l6.120"></a><span id="l6.120">       var messageUrl = url.QueryInterface(Ci.nsIMsgMessageUrl);</span>
<a href="#l6.121"></a><span id="l6.121">       this.mSaveHdr = messenger.msgHdrFromURI(messageUrl.uri);</span>
<a href="#l6.122"></a><span id="l6.122">     }</span>
<a href="#l6.123"></a><span id="l6.123">     if (!currentAttachments.length &amp;&amp; this.mSaveHdr)</span>
<a href="#l6.124"></a><span id="l6.124">       this.mSaveHdr.markHasAttachments(false);</span>
<a href="#l6.125"></a><span id="l6.125"> </span>
<a href="#l6.126"></a><span id="l6.126" class="difflineat">@@ -1703,187 +1692,294 @@ function CopyNewsgroupURL(newsgroupNode)</span>
<a href="#l6.127"></a><span id="l6.127">      Cu.reportError(&quot;Invalid URL: &quot; + url);</span>
<a href="#l6.128"></a><span id="l6.128">   }</span>
<a href="#l6.129"></a><span id="l6.129"> }</span>
<a href="#l6.130"></a><span id="l6.130"> </span>
<a href="#l6.131"></a><span id="l6.131"> /**</span>
<a href="#l6.132"></a><span id="l6.132">  * Create a new attachment object which goes into the data attachment array.</span>
<a href="#l6.133"></a><span id="l6.133">  * This method checks whether the passed attachment is empty or not.</span>
<a href="#l6.134"></a><span id="l6.134">  *</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">- * @param contentType  The attachment's mimetype</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">- * @param url  The URL for the attachment</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">- * @param name  The name to be displayed for this attachment (usually the</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">- *              filename)</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">- * @param uri  The URI for the message containing the attachment</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">- * @param isExternalAttachment  True if the attachment has been detached</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">- * @param size  The size in bytes of the attachment</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+ * @param {String} contentType - The attachment's mimetype.</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+ * @param {String} url         - The URL for the attachment.</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+ * @param {String} name        - The name to be displayed for this attachment</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+ *                               (usually the filename).</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+ * @param {String} uri         - The URI for the message containing the attachment.</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+ * @param {Boolean} isExternalAttachment - True if the attachment has been</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+ *                                         detached to file or is a link</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+ *                                         attachment.</span>
<a href="#l6.150"></a><span id="l6.150">  */</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-function AttachmentInfo(contentType, url, name, uri,</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-                        isExternalAttachment, size) {</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+function AttachmentInfo(contentType, url, name, uri, isExternalAttachment) {</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+  this.message = gFolderDisplay.selectedMessage;</span>
<a href="#l6.155"></a><span id="l6.155">   this.contentType = contentType;</span>
<a href="#l6.156"></a><span id="l6.156">   this.name = name;</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+  this.url = url;</span>
<a href="#l6.158"></a><span id="l6.158">   this.uri = uri;</span>
<a href="#l6.159"></a><span id="l6.159">   this.isExternalAttachment = isExternalAttachment;</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-  this.size = size;</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-  let match;</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+  // A |size| value of -1 means we don't have a valid size. Check again if</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+  // |sizeResolved| is false or ALWAYSFETCHSIZE is true. For internal attachments</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+  // and link attachments with a reported size, libmime streams values to</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+  // addAttachmentField() which updates this object. For external file</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+  // attachments and unresolved -1 size internal attachments, |size| is updated</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+  // in the isEmpty() function when the list is built. Deleted attachments</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+  // are resolved to -1.</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+  this.size = -1;</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+  this.sizeResolved = this.isDeleted;</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+  // Fetch the size for internal attachments even though libmime gave a size.</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineplus">+  this.ALWAYSFETCHSIZE = false;</span>
<a href="#l6.173"></a><span id="l6.173"> </span>
<a href="#l6.174"></a><span id="l6.174">   // Remove [?&amp;]part= from remote urls, after getting the partID.</span>
<a href="#l6.175"></a><span id="l6.175">   // Remote urls, unlike non external mail part urls, may also contain query</span>
<a href="#l6.176"></a><span id="l6.176">   // strings starting with ?; PART_RE does not handle this.</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-  if (url.startsWith(&quot;http&quot;) || url.startsWith(&quot;file&quot;)) {</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-    match = url.match(/[?&amp;]part=[^&amp;]+$/);</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+  if (this.isLinkAttachment || this.isFileAttachment) {</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+    let match = url.match(/[?&amp;]part=[^&amp;]+$/);</span>
<a href="#l6.181"></a><span id="l6.181">     match = match &amp;&amp; match[0];</span>
<a href="#l6.182"></a><span id="l6.182">     this.partID = match &amp;&amp; match.split(&quot;part=&quot;)[1];</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-    url = url.replace(match, &quot;&quot;);</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineplus">+    this.url = url.replace(match, &quot;&quot;);</span>
<a href="#l6.185"></a><span id="l6.185">   } else {</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-    match = GlodaUtils.PART_RE.exec(url);</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+    let match = GlodaUtils.PART_RE.exec(url);</span>
<a href="#l6.188"></a><span id="l6.188">     this.partID = match &amp;&amp; match[1];</span>
<a href="#l6.189"></a><span id="l6.189">   }</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-  // Make sure to communicate it if it's an external http attachment and not a</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-  // local attachment. For feeds attachments (enclosures) are always remote,</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-  // so there is nothing to communicate.</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-  if (isExternalAttachment &amp;&amp; url.startsWith(&quot;http&quot;) &amp;&amp;</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-      !gFolderDisplay.selectedMessageIsFeed) {</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-    if (this.name) {</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-      this.name = url + &quot; - &quot; + this.name;</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-    } else {</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-      this.name = url;</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-    }</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-  }</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-  this.url = url;</span>
<a href="#l6.204"></a><span id="l6.204"> }</span>
<a href="#l6.205"></a><span id="l6.205"> </span>
<a href="#l6.206"></a><span id="l6.206"> AttachmentInfo.prototype = {</span>
<a href="#l6.207"></a><span id="l6.207">   /**</span>
<a href="#l6.208"></a><span id="l6.208">    * Save this attachment to a file.</span>
<a href="#l6.209"></a><span id="l6.209">    */</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-  save() {</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+  async save() {</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+    if (!this.hasFile || this.message != gFolderDisplay.selectedMessage) {</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+      return;</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+    }</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+    let empty = await this.isEmpty();</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+    if (empty) {</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+      return;</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+    }</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+</span>
<a href="#l6.221"></a><span id="l6.221">     messenger.saveAttachment(this.contentType, this.url,</span>
<a href="#l6.222"></a><span id="l6.222">                              encodeURIComponent(this.name),</span>
<a href="#l6.223"></a><span id="l6.223">                              this.uri, this.isExternalAttachment);</span>
<a href="#l6.224"></a><span id="l6.224">   },</span>
<a href="#l6.225"></a><span id="l6.225"> </span>
<a href="#l6.226"></a><span id="l6.226">   /**</span>
<a href="#l6.227"></a><span id="l6.227">    * Open this attachment.</span>
<a href="#l6.228"></a><span id="l6.228">    */</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-  open() {</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-    if (!this.hasFile)</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineplus">+  async open() {</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineplus">+    if (!this.hasFile || this.message != gFolderDisplay.selectedMessage) {</span>
<a href="#l6.233"></a><span id="l6.233">       return;</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-    if (this.isEmpty) {</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-      var prompt = document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-                           .getString(&quot;emptyAttachment&quot;);</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+    }</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+    let empty = await this.isEmpty();</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+    if (empty) {</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+      let bundleMessenger = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+      let prompt = bundleMessenger.getString(this.isExternalAttachment ?</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineplus">+                                             &quot;externalAttachmentNotFound&quot; :</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+                                             &quot;emptyAttachment&quot;);</span>
<a href="#l6.246"></a><span id="l6.246">       msgWindow.promptDialog.alert(null, prompt);</span>
<a href="#l6.247"></a><span id="l6.247">     } else {</span>
<a href="#l6.248"></a><span id="l6.248">       messenger.openAttachment(this.contentType, this.url,</span>
<a href="#l6.249"></a><span id="l6.249">                                encodeURIComponent(this.name),</span>
<a href="#l6.250"></a><span id="l6.250">                                this.uri, this.isExternalAttachment);</span>
<a href="#l6.251"></a><span id="l6.251">     }</span>
<a href="#l6.252"></a><span id="l6.252">   },</span>
<a href="#l6.253"></a><span id="l6.253"> </span>
<a href="#l6.254"></a><span id="l6.254">   /**</span>
<a href="#l6.255"></a><span id="l6.255">    * Detach this attachment from the message.</span>
<a href="#l6.256"></a><span id="l6.256">    *</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-   * @param aSaveFirst  true if the attachment should be saved before detaching,</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-   *                    false otherwise</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+   * @param {Boolean} aSaveFirst - true if the attachment should be saved</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineplus">+   *                               before detaching, false otherwise.</span>
<a href="#l6.261"></a><span id="l6.261">    */</span>
<a href="#l6.262"></a><span id="l6.262">   detach(aSaveFirst) {</span>
<a href="#l6.263"></a><span id="l6.263">     messenger.detachAttachment(this.contentType, this.url,</span>
<a href="#l6.264"></a><span id="l6.264">                                encodeURIComponent(this.name),</span>
<a href="#l6.265"></a><span id="l6.265">                                this.uri, aSaveFirst);</span>
<a href="#l6.266"></a><span id="l6.266">   },</span>
<a href="#l6.267"></a><span id="l6.267"> </span>
<a href="#l6.268"></a><span id="l6.268">   /**</span>
<a href="#l6.269"></a><span id="l6.269">    * This method checks whether the attachment has been deleted or not.</span>
<a href="#l6.270"></a><span id="l6.270">    *</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineminus">-   * @return true if the attachment has been deleted, false otherwise</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineplus">+   * @returns true if the attachment has been deleted, false otherwise.</span>
<a href="#l6.273"></a><span id="l6.273">    */</span>
<a href="#l6.274"></a><span id="l6.274">   get isDeleted() {</span>
<a href="#l6.275"></a><span id="l6.275">     return this.contentType == &quot;text/x-moz-deleted&quot;;</span>
<a href="#l6.276"></a><span id="l6.276">   },</span>
<a href="#l6.277"></a><span id="l6.277"> </span>
<a href="#l6.278"></a><span id="l6.278">   /**</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+   * This method checks whether the attachment is a detached file.</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineplus">+   *</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineplus">+   * @returns true if the attachment is a detached file, false otherwise.</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineplus">+   */</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineplus">+  get isFileAttachment() {</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineplus">+    return this.isExternalAttachment &amp;&amp; this.url.startsWith(&quot;file:&quot;);</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineplus">+  },</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineplus">+</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineplus">+  /**</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineplus">+   * This method checks whether the attachment is an http link.</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineplus">+   *</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineplus">+   * @returns true if the attachment is an http link, false otherwise.</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineplus">+   */</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineplus">+  get isLinkAttachment() {</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineplus">+    return this.isExternalAttachment &amp;&amp; /^https?:/.test(this.url);</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineplus">+  },</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineplus">+</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineplus">+  /**</span>
<a href="#l6.297"></a><span id="l6.297">    * This method checks whether the attachment has an associated file or not.</span>
<a href="#l6.298"></a><span id="l6.298">    * Deleted attachments or detached attachments with missing external files</span>
<a href="#l6.299"></a><span id="l6.299">    * do *not* have a file.</span>
<a href="#l6.300"></a><span id="l6.300">    *</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineminus">-   * @return true if the attachment has an associated file, false otherwise</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineplus">+   * @returns true if the attachment has an associated file, false otherwise.</span>
<a href="#l6.303"></a><span id="l6.303">    */</span>
<a href="#l6.304"></a><span id="l6.304">   get hasFile() {</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-    if (this.isDeleted)</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineplus">+    if (this.sizeResolved &amp;&amp; this.size == -1) {</span>
<a href="#l6.307"></a><span id="l6.307">       return false;</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineminus">-    if (this.isExternalAttachment &amp;&amp; this.url.startsWith(&quot;file:&quot;) &amp;&amp;</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineminus">-        this.size === null)</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineminus">-      return false;</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineplus">+    }</span>
<a href="#l6.312"></a><span id="l6.312"> </span>
<a href="#l6.313"></a><span id="l6.313">     return true;</span>
<a href="#l6.314"></a><span id="l6.314">   },</span>
<a href="#l6.315"></a><span id="l6.315"> </span>
<a href="#l6.316"></a><span id="l6.316">   /**</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-   * This method checks whether the attachment is empty or not.</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineplus">+   * Return display url, decoded and converted to utf8 from IDN punycode ascii,</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineplus">+   * if the attachment is external (http or file schemes).</span>
<a href="#l6.320"></a><span id="l6.320">    *</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-   * @return  true if the attachment is empty, false otherwise</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineplus">+   * @returns {String} url.</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineplus">+   */</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineplus">+  get displayUrl() {</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineplus">+    if (this.isExternalAttachment) {</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineplus">+      // For status bar url display purposes, we want the displaySpec.</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineplus">+      // The ?part= has already been removed.</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineplus">+      return decodeURI(makeURI(this.url).displaySpec);</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineplus">+    }</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineplus">+</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineplus">+    return this.url;</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineplus">+  },</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineplus">+</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineplus">+  /**</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineplus">+   * This method checks whether the attachment url location exists and</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineplus">+   * is accessible. For http and file urls, fetch() will have the size</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineplus">+   * in the content-length header.</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineplus">+   *</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineplus">+   * @returns true if the attachment is empty or error, false otherwise.</span>
<a href="#l6.340"></a><span id="l6.340">    */</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineminus">-  get isEmpty() {</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineminus">-    // Create an input stream on the attachment url.</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineminus">-    let url = Services.io.newURI(this.url);</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineminus">-    let channel = Services.io.newChannelFromURI(url,</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineminus">-                                                null,</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineminus">-                                                Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineminus">-                                                null,</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineminus">-                                                Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineminus">-                                                Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineminus">-    let stream = channel.open();</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineminus">-    let inputStream = Cc[&quot;@mozilla.org/binaryinputstream;1&quot;]</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineminus">-                        .createInstance(Ci.nsIBinaryInputStream);</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineminus">-    inputStream.setInputStream(stream);</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineminus">-</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineminus">-    let bytesAvailable = 0;</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineminus">-</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineminus">-    if (inputStream.isNonBlocking()) {</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineminus">-      // If the stream does not block, test on two conditions:</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineminus">-      //   - attachment is empty     -&gt; 0 bytes will be returned on readBytes()</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineminus">-      //   - attachment is not empty -&gt; NS_BASE_STREAM_WOULD_BLOCK exception is</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineminus">-      //                                thrown</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineminus">-      let chunk = null;</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineminus">-</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineminus">-      try {</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineminus">-        chunk = inputStream.readBytes(1);</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineminus">-      } catch (ex) {</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineminus">-        if (ex.result == Cr.NS_BASE_STREAM_WOULD_BLOCK) {</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineminus">-          bytesAvailable = 1;</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineplus">+  async isEmpty() {</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineplus">+    if (this.isDeleted)</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineplus">+      return true;</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineplus">+</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineplus">+    // If the size is already checked and failed, return.</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineplus">+    if (this.sizeResolved &amp;&amp; this.size == -1 &amp;&amp; !this.ALWAYSFETCHSIZE)</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineplus">+      return true;</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineplus">+</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineplus">+    // We already have the size; we don't trust link attachment sizes reported</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineplus">+    // in the mime part or don't have them.</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineplus">+    if (!this.isLinkAttachment &amp;&amp; this.size &gt; 0 &amp;&amp; !this.ALWAYSFETCHSIZE)</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineplus">+      return false;</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineplus">+</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineplus">+    let url = this.url;</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineplus">+    let empty = true;</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineplus">+    let size = 0;</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineplus">+    let options = { method: &quot;HEAD&quot; };</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineplus">+</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineplus">+   // NOTE: For internal mailbox, imap, news urls the response body must get</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineplus">+   // the content length with getReader().read() but we don't need to do this</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineplus">+   // here as libmime streams it already in addAttachmentField(). For imap or</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineplus">+   // news urls with credentials (username, userPass), we must remove them</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineplus">+   // as Request fails such urls with a MSG_URL_HAS_CREDENTIALS error.</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineplus">+    if (url.startsWith(&quot;imap://&quot;) || url.startsWith(&quot;news://&quot;)) {</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineplus">+      let uri = makeURI(url);</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineplus">+      if (uri.username)</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineplus">+        url = url.replace(uri.username + &quot;@&quot;, &quot;&quot;);</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineplus">+      if (uri.userPass)</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineplus">+        url = url.replace(uri.userPass + &quot;@&quot;, &quot;&quot;);</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineplus">+    }</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineplus">+</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineplus">+    let request = new Request(url, options);</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineplus">+</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineplus">+    if (this.isExternalAttachment || !this.sizeResolved || this.ALWAYSFETCHSIZE) {</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineplus">+      updateAttachmentsDisplay(this, true);</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineplus">+    }</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineplus">+</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineplus">+    await fetch(request)</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineplus">+      .then((response) =&gt; {</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineplus">+        if (!response.ok) {</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineplus">+          console.warn(&quot;AttachmentInfo.isEmpty: fetch response error - &quot; + response.statusText);</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineplus">+          return null;</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineplus">+        }</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineplus">+</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineplus">+        if (this.isLinkAttachment) {</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineplus">+          if (response.status &lt; 200 || response.status &gt; 304) {</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineplus">+            console.warn(&quot;AttachmentInfo.isEmpty: link fetch response status - &quot; + response.status);</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineplus">+            return null;</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineplus">+          }</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineplus">+        }</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineplus">+</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineplus">+        return response;</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineplus">+      })</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineplus">+      .then(async (response) =&gt; {</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineplus">+        if (this.isExternalAttachment) {</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineplus">+          size = response ? response.headers.get(&quot;content-length&quot;) : 0;</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineplus">+        } else if (!this.sizeResolved || this.ALWAYSFETCHSIZE) {</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineplus">+          // Check the attachment again if addAttachmentField() sets a</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineplus">+          // libmime -1 return value for size to null in this object.</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineplus">+          let data = await response.body.getReader().read();</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineplus">+          size = data.value.length;</span>
<a href="#l6.431"></a><span id="l6.431">         } else {</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineminus">-          throw ex;</span>
<a href="#l6.433"></a><span id="l6.433" class="difflineplus">+          // Accept the libmime streamed size for internal attachments.</span>
<a href="#l6.434"></a><span id="l6.434" class="difflineplus">+          size = this.size;</span>
<a href="#l6.435"></a><span id="l6.435">         }</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineminus">-      }</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineminus">-      if (chunk)</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineminus">-        bytesAvailable = chunk.length;</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineminus">-    } else {</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineminus">-      // If the stream blocks, we can rely on available() to return the correct</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineminus">-      // number.</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineminus">-      bytesAvailable = inputStream.available();</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineplus">+</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineplus">+        if (size &gt; 0)</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineplus">+          empty = false;</span>
<a href="#l6.446"></a><span id="l6.446" class="difflineplus">+      })</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineplus">+      .catch((error) =&gt; {</span>
<a href="#l6.448"></a><span id="l6.448" class="difflineplus">+        console.warn(&quot;AttachmentInfo.isEmpty: error - &quot; + error.message);</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineplus">+      });</span>
<a href="#l6.450"></a><span id="l6.450" class="difflineplus">+</span>
<a href="#l6.451"></a><span id="l6.451" class="difflineplus">+    if (this.isExternalAttachment || !this.sizeResolved || this.ALWAYSFETCHSIZE) {</span>
<a href="#l6.452"></a><span id="l6.452" class="difflineplus">+      // For link attachments, we may have had a published value or null</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineplus">+      // indicating unknown value. We now know the real size, so set it and</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineplus">+      // update the ui. For detached file attachments, get the size here</span>
<a href="#l6.455"></a><span id="l6.455" class="difflineplus">+      // instead of the old xpcom way. Finally, also update libmime unknown</span>
<a href="#l6.456"></a><span id="l6.456" class="difflineplus">+      // internal attachment size.</span>
<a href="#l6.457"></a><span id="l6.457" class="difflineplus">+      this.size = empty ? -1 : size;</span>
<a href="#l6.458"></a><span id="l6.458" class="difflineplus">+      this.sizeResolved = true;</span>
<a href="#l6.459"></a><span id="l6.459" class="difflineplus">+      updateAttachmentsDisplay(this, false);</span>
<a href="#l6.460"></a><span id="l6.460">     }</span>
<a href="#l6.461"></a><span id="l6.461"> </span>
<a href="#l6.462"></a><span id="l6.462" class="difflineminus">-    return (bytesAvailable == 0);</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineplus">+    return empty;</span>
<a href="#l6.464"></a><span id="l6.464" class="difflineplus">+  },</span>
<a href="#l6.465"></a><span id="l6.465" class="difflineplus">+</span>
<a href="#l6.466"></a><span id="l6.466" class="difflineplus">+  /**</span>
<a href="#l6.467"></a><span id="l6.467" class="difflineplus">+   * Open a file attachment's containing folder.</span>
<a href="#l6.468"></a><span id="l6.468" class="difflineplus">+   */</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineplus">+  openFolder() {</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineplus">+    if (!this.isFileAttachment || !this.hasFile) {</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineplus">+      return;</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineplus">+    }</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineplus">+</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineplus">+    // The file url is stored in the attachment info part with unix path and</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineplus">+    // needs to be converted to os path for nsIFile.</span>
<a href="#l6.476"></a><span id="l6.476" class="difflineplus">+    let fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l6.477"></a><span id="l6.477" class="difflineplus">+                                 .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l6.478"></a><span id="l6.478" class="difflineplus">+    try {</span>
<a href="#l6.479"></a><span id="l6.479" class="difflineplus">+      fileHandler.getFileFromURLSpec(this.displayUrl).reveal();</span>
<a href="#l6.480"></a><span id="l6.480" class="difflineplus">+    } catch (ex) {</span>
<a href="#l6.481"></a><span id="l6.481" class="difflineplus">+      console.error(&quot;AttachmentInfo.openFolder: file - &quot; + this.displayUrl + &quot;, &quot; + ex);</span>
<a href="#l6.482"></a><span id="l6.482" class="difflineplus">+    }</span>
<a href="#l6.483"></a><span id="l6.483">   },</span>
<a href="#l6.484"></a><span id="l6.484"> };</span>
<a href="#l6.485"></a><span id="l6.485"> </span>
<a href="#l6.486"></a><span id="l6.486"> /**</span>
<a href="#l6.487"></a><span id="l6.487">  * Return true if possible attachments in the currently loaded message can be</span>
<a href="#l6.488"></a><span id="l6.488">  * deleted/detached.</span>
<a href="#l6.489"></a><span id="l6.489">  */</span>
<a href="#l6.490"></a><span id="l6.490"> function CanDetachAttachments() {</span>
<a href="#l6.491"></a><span id="l6.491">   var canDetach = !gFolderDisplay.selectedMessageIsNews &amp;&amp;</span>
<a href="#l6.492"></a><span id="l6.492">                   (!gFolderDisplay.selectedMessageIsImap ||</span>
<a href="#l6.493"></a><span id="l6.493">                    MailOfflineMgr.isOnline());</span>
<a href="#l6.494"></a><span id="l6.494">   if (canDetach &amp;&amp; (&quot;content-type&quot; in currentHeaderData))</span>
<a href="#l6.495"></a><span id="l6.495">     canDetach = !ContentTypeIsSMIME(currentHeaderData[&quot;content-type&quot;].headerValue);</span>
<a href="#l6.496"></a><span id="l6.496" class="difflineplus">+</span>
<a href="#l6.497"></a><span id="l6.497">   return canDetach;</span>
<a href="#l6.498"></a><span id="l6.498"> }</span>
<a href="#l6.499"></a><span id="l6.499"> </span>
<a href="#l6.500"></a><span id="l6.500"> /**</span>
<a href="#l6.501"></a><span id="l6.501">  * Return true if the content type is an S/MIME one.</span>
<a href="#l6.502"></a><span id="l6.502">  */</span>
<a href="#l6.503"></a><span id="l6.503"> function ContentTypeIsSMIME(contentType) {</span>
<a href="#l6.504"></a><span id="l6.504">   // S/MIME is application/pkcs7-mime and application/pkcs7-signature</span>
<a href="#l6.505"></a><span id="l6.505" class="difflineat">@@ -1908,16 +2004,17 @@ function onShowAttachmentItemContextMenu</span>
<a href="#l6.506"></a><span id="l6.506">   let attachmentName = document.getElementById(&quot;attachmentName&quot;);</span>
<a href="#l6.507"></a><span id="l6.507">   let contextMenu    = document.getElementById(&quot;attachmentItemContext&quot;);</span>
<a href="#l6.508"></a><span id="l6.508">   let openMenu       = document.getElementById(&quot;context-openAttachment&quot;);</span>
<a href="#l6.509"></a><span id="l6.509">   let saveMenu       = document.getElementById(&quot;context-saveAttachment&quot;);</span>
<a href="#l6.510"></a><span id="l6.510">   let detachMenu     = document.getElementById(&quot;context-detachAttachment&quot;);</span>
<a href="#l6.511"></a><span id="l6.511">   let deleteMenu     = document.getElementById(&quot;context-deleteAttachment&quot;);</span>
<a href="#l6.512"></a><span id="l6.512">   let copyUrlMenuSep = document.getElementById(&quot;context-menu-copyurl-separator&quot;);</span>
<a href="#l6.513"></a><span id="l6.513">   let copyUrlMenu    = document.getElementById(&quot;context-copyAttachmentUrl&quot;);</span>
<a href="#l6.514"></a><span id="l6.514" class="difflineplus">+  let openFolderMenu = document.getElementById(&quot;context-openFolder&quot;);</span>
<a href="#l6.515"></a><span id="l6.515"> </span>
<a href="#l6.516"></a><span id="l6.516">   // If we opened the context menu from the attachment info area (the paperclip,</span>
<a href="#l6.517"></a><span id="l6.517">   // &quot;1 attachment&quot; label, filename, or file size, just grab the first (and</span>
<a href="#l6.518"></a><span id="l6.518">   // only) attachment as our &quot;selected&quot; attachments.</span>
<a href="#l6.519"></a><span id="l6.519">   var selectedAttachments;</span>
<a href="#l6.520"></a><span id="l6.520">   if (contextMenu.triggerNode == attachmentInfo ||</span>
<a href="#l6.521"></a><span id="l6.521">       contextMenu.triggerNode.parentNode == attachmentInfo) {</span>
<a href="#l6.522"></a><span id="l6.522">     selectedAttachments = [attachmentList.getItemAtIndex(0).attachment];</span>
<a href="#l6.523"></a><span id="l6.523" class="difflineat">@@ -1933,24 +2030,29 @@ function onShowAttachmentItemContextMenu</span>
<a href="#l6.524"></a><span id="l6.524">     return attachment.isExternalAttachment;</span>
<a href="#l6.525"></a><span id="l6.525">   });</span>
<a href="#l6.526"></a><span id="l6.526">   var allSelectedDeleted = selectedAttachments.every(function(attachment) {</span>
<a href="#l6.527"></a><span id="l6.527">     return !attachment.hasFile;</span>
<a href="#l6.528"></a><span id="l6.528">   });</span>
<a href="#l6.529"></a><span id="l6.529">   var canDetachSelected = CanDetachAttachments() &amp;&amp; !allSelectedDetached &amp;&amp;</span>
<a href="#l6.530"></a><span id="l6.530">                           !allSelectedDeleted;</span>
<a href="#l6.531"></a><span id="l6.531">   let allSelectedHttp = selectedAttachments.every(function(attachment) {</span>
<a href="#l6.532"></a><span id="l6.532" class="difflineminus">-    return attachment.url.startsWith(&quot;http&quot;);</span>
<a href="#l6.533"></a><span id="l6.533" class="difflineplus">+    return attachment.isLinkAttachment;</span>
<a href="#l6.534"></a><span id="l6.534" class="difflineplus">+  });</span>
<a href="#l6.535"></a><span id="l6.535" class="difflineplus">+  let allSelectedFile = selectedAttachments.every(function(attachment) {</span>
<a href="#l6.536"></a><span id="l6.536" class="difflineplus">+    return attachment.isFileAttachment;</span>
<a href="#l6.537"></a><span id="l6.537">   });</span>
<a href="#l6.538"></a><span id="l6.538"> </span>
<a href="#l6.539"></a><span id="l6.539">   openMenu.disabled = allSelectedDeleted;</span>
<a href="#l6.540"></a><span id="l6.540">   saveMenu.disabled = allSelectedDeleted;</span>
<a href="#l6.541"></a><span id="l6.541">   detachMenu.disabled = !canDetachSelected;</span>
<a href="#l6.542"></a><span id="l6.542">   deleteMenu.disabled = !canDetachSelected;</span>
<a href="#l6.543"></a><span id="l6.543" class="difflineminus">-  copyUrlMenuSep.hidden = copyUrlMenu.hidden = !allSelectedHttp;</span>
<a href="#l6.544"></a><span id="l6.544" class="difflineplus">+  copyUrlMenuSep.hidden = copyUrlMenu.hidden = !(allSelectedHttp || allSelectedFile);</span>
<a href="#l6.545"></a><span id="l6.545" class="difflineplus">+  openFolderMenu.hidden = !allSelectedFile;</span>
<a href="#l6.546"></a><span id="l6.546" class="difflineplus">+  openFolderMenu.disabled = allSelectedDeleted;</span>
<a href="#l6.547"></a><span id="l6.547"> }</span>
<a href="#l6.548"></a><span id="l6.548"> </span>
<a href="#l6.549"></a><span id="l6.549"> /**</span>
<a href="#l6.550"></a><span id="l6.550">  * Close the attachment item context menu, performing any cleanup as necessary.</span>
<a href="#l6.551"></a><span id="l6.551">  */</span>
<a href="#l6.552"></a><span id="l6.552"> function onHideAttachmentItemContextMenu() {</span>
<a href="#l6.553"></a><span id="l6.553">   let attachmentName = document.getElementById(&quot;attachmentName&quot;);</span>
<a href="#l6.554"></a><span id="l6.554">   let contextMenu = document.getElementById(&quot;attachmentItemContext&quot;);</span>
<a href="#l6.555"></a><span id="l6.555" class="difflineat">@@ -2156,62 +2258,57 @@ var AttachmentMenuController = {</span>
<a href="#l6.556"></a><span id="l6.556"> </span>
<a href="#l6.557"></a><span id="l6.557"> function goUpdateAttachmentCommands() {</span>
<a href="#l6.558"></a><span id="l6.558">   goUpdateCommand(&quot;cmd_openAllAttachments&quot;);</span>
<a href="#l6.559"></a><span id="l6.559">   goUpdateCommand(&quot;cmd_saveAllAttachments&quot;);</span>
<a href="#l6.560"></a><span id="l6.560">   goUpdateCommand(&quot;cmd_detachAllAttachments&quot;);</span>
<a href="#l6.561"></a><span id="l6.561">   goUpdateCommand(&quot;cmd_deleteAllAttachments&quot;);</span>
<a href="#l6.562"></a><span id="l6.562"> }</span>
<a href="#l6.563"></a><span id="l6.563"> </span>
<a href="#l6.564"></a><span id="l6.564" class="difflineminus">-function displayAttachmentsForExpandedView() {</span>
<a href="#l6.565"></a><span id="l6.565" class="difflineplus">+async function displayAttachmentsForExpandedView() {</span>
<a href="#l6.566"></a><span id="l6.566">   var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l6.567"></a><span id="l6.567">   var numAttachments = currentAttachments.length;</span>
<a href="#l6.568"></a><span id="l6.568" class="difflineminus">-  var totalSize = 0;</span>
<a href="#l6.569"></a><span id="l6.569">   var attachmentView = document.getElementById(&quot;attachmentView&quot;);</span>
<a href="#l6.570"></a><span id="l6.570">   var attachmentSplitter = document.getElementById(&quot;attachment-splitter&quot;);</span>
<a href="#l6.571"></a><span id="l6.571" class="difflineplus">+  document.getElementById(&quot;attachmentIcon&quot;).removeAttribute(&quot;src&quot;);</span>
<a href="#l6.572"></a><span id="l6.572"> </span>
<a href="#l6.573"></a><span id="l6.573">   if (numAttachments &lt;= 0) {</span>
<a href="#l6.574"></a><span id="l6.574">     attachmentView.collapsed = true;</span>
<a href="#l6.575"></a><span id="l6.575">     attachmentSplitter.collapsed = true;</span>
<a href="#l6.576"></a><span id="l6.576">   } else if (!gBuildAttachmentsForCurrentMsg) {</span>
<a href="#l6.577"></a><span id="l6.577">     attachmentView.collapsed = false;</span>
<a href="#l6.578"></a><span id="l6.578"> </span>
<a href="#l6.579"></a><span id="l6.579">     var attachmentList = document.getElementById(&quot;attachmentList&quot;);</span>
<a href="#l6.580"></a><span id="l6.580"> </span>
<a href="#l6.581"></a><span id="l6.581">     var viewMode = Services.prefs.getIntPref(&quot;mailnews.attachments.display.view&quot;);</span>
<a href="#l6.582"></a><span id="l6.582">     var views = [&quot;small&quot;, &quot;large&quot;, &quot;tile&quot;];</span>
<a href="#l6.583"></a><span id="l6.583">     attachmentList.view = views[viewMode];</span>
<a href="#l6.584"></a><span id="l6.584">     attachmentList.controllers.appendController(AttachmentListController);</span>
<a href="#l6.585"></a><span id="l6.585"> </span>
<a href="#l6.586"></a><span id="l6.586">     toggleAttachmentList(false);</span>
<a href="#l6.587"></a><span id="l6.587"> </span>
<a href="#l6.588"></a><span id="l6.588" class="difflineminus">-    var lastPartID;</span>
<a href="#l6.589"></a><span id="l6.589" class="difflineminus">-    var unknownSize = false;</span>
<a href="#l6.590"></a><span id="l6.590">     for (let attachment of currentAttachments) {</span>
<a href="#l6.591"></a><span id="l6.591">       // Create a new attachment widget</span>
<a href="#l6.592"></a><span id="l6.592">       var displayName = SanitizeAttachmentDisplayName(attachment);</span>
<a href="#l6.593"></a><span id="l6.593">       var item = attachmentList.appendItem(attachment, displayName);</span>
<a href="#l6.594"></a><span id="l6.594">       item.setAttribute(&quot;tooltiptext&quot;, attachment.name);</span>
<a href="#l6.595"></a><span id="l6.595">       item.addEventListener(&quot;command&quot;, attachmentItemCommand);</span>
<a href="#l6.596"></a><span id="l6.596"> </span>
<a href="#l6.597"></a><span id="l6.597" class="difflineminus">-      // Check if this attachment's part ID is a child of the last attachment</span>
<a href="#l6.598"></a><span id="l6.598" class="difflineminus">-      // we counted. If so, skip it, since we already accounted for its size</span>
<a href="#l6.599"></a><span id="l6.599" class="difflineminus">-      // from its parent.</span>
<a href="#l6.600"></a><span id="l6.600" class="difflineminus">-      if (!lastPartID || attachment.partID.indexOf(lastPartID) != 0) {</span>
<a href="#l6.601"></a><span id="l6.601" class="difflineminus">-        lastPartID = attachment.partID;</span>
<a href="#l6.602"></a><span id="l6.602" class="difflineminus">-        if (attachment.size !== null)</span>
<a href="#l6.603"></a><span id="l6.603" class="difflineminus">-          totalSize += attachment.size;</span>
<a href="#l6.604"></a><span id="l6.604" class="difflineminus">-        else if (!attachment.isDeleted)</span>
<a href="#l6.605"></a><span id="l6.605" class="difflineminus">-          unknownSize = true;</span>
<a href="#l6.606"></a><span id="l6.606" class="difflineplus">+      // Get a detached file's size or an internal attachment size that is not</span>
<a href="#l6.607"></a><span id="l6.607" class="difflineplus">+      // yet resolved, or if |ALWAYSFETCHSIZE| is true. For link attachments,</span>
<a href="#l6.608"></a><span id="l6.608" class="difflineplus">+      // the user must always initiate the fetch for privacy reasons.</span>
<a href="#l6.609"></a><span id="l6.609" class="difflineplus">+      if (!attachment.isLinkAttachment &amp;&amp;</span>
<a href="#l6.610"></a><span id="l6.610" class="difflineplus">+          (!attachment.sizeResolved || attachment.ALWAYSFETCHSIZE)) {</span>
<a href="#l6.611"></a><span id="l6.611" class="difflineplus">+        await attachment.isEmpty();</span>
<a href="#l6.612"></a><span id="l6.612">       }</span>
<a href="#l6.613"></a><span id="l6.613">     }</span>
<a href="#l6.614"></a><span id="l6.614"> </span>
<a href="#l6.615"></a><span id="l6.615" class="difflineminus">-    // Show the appropriate toolbar button and label based on the number of</span>
<a href="#l6.616"></a><span id="l6.616" class="difflineminus">-    // attachments.</span>
<a href="#l6.617"></a><span id="l6.617" class="difflineminus">-    updateSaveAllAttachmentsButton();</span>
<a href="#l6.618"></a><span id="l6.618" class="difflineplus">+    if (Services.prefs.getBoolPref(&quot;mailnews.attachments.display.start_expanded&quot;)) {</span>
<a href="#l6.619"></a><span id="l6.619" class="difflineplus">+      toggleAttachmentList(true);</span>
<a href="#l6.620"></a><span id="l6.620" class="difflineplus">+    }</span>
<a href="#l6.621"></a><span id="l6.621"> </span>
<a href="#l6.622"></a><span id="l6.622">     let attachmentInfo = document.getElementById(&quot;attachmentInfo&quot;);</span>
<a href="#l6.623"></a><span id="l6.623">     let attachmentCount = document.getElementById(&quot;attachmentCount&quot;);</span>
<a href="#l6.624"></a><span id="l6.624">     let attachmentName = document.getElementById(&quot;attachmentName&quot;);</span>
<a href="#l6.625"></a><span id="l6.625">     let attachmentSize = document.getElementById(&quot;attachmentSize&quot;);</span>
<a href="#l6.626"></a><span id="l6.626"> </span>
<a href="#l6.627"></a><span id="l6.627">     if (numAttachments == 1) {</span>
<a href="#l6.628"></a><span id="l6.628">       let count = bundle.getString(&quot;attachmentCountSingle&quot;);</span>
<a href="#l6.629"></a><span id="l6.629" class="difflineat">@@ -2226,29 +2323,110 @@ function displayAttachmentsForExpandedVi</span>
<a href="#l6.630"></a><span id="l6.630">       let count = PluralForm.get(currentAttachments.length, words)</span>
<a href="#l6.631"></a><span id="l6.631">                             .replace(&quot;#1&quot;, currentAttachments.length);</span>
<a href="#l6.632"></a><span id="l6.632"> </span>
<a href="#l6.633"></a><span id="l6.633">       attachmentInfo.setAttribute(&quot;contextmenu&quot;, &quot;attachmentListContext&quot;);</span>
<a href="#l6.634"></a><span id="l6.634">       attachmentCount.setAttribute(&quot;value&quot;, count);</span>
<a href="#l6.635"></a><span id="l6.635">       attachmentName.hidden = true;</span>
<a href="#l6.636"></a><span id="l6.636">     }</span>
<a href="#l6.637"></a><span id="l6.637"> </span>
<a href="#l6.638"></a><span id="l6.638" class="difflineminus">-    let sizeStr = messenger.formatFileSize(totalSize);</span>
<a href="#l6.639"></a><span id="l6.639" class="difflineminus">-    if (unknownSize) {</span>
<a href="#l6.640"></a><span id="l6.640" class="difflineminus">-      if (totalSize == 0)</span>
<a href="#l6.641"></a><span id="l6.641" class="difflineminus">-        sizeStr = bundle.getString(&quot;attachmentSizeUnknown&quot;);</span>
<a href="#l6.642"></a><span id="l6.642" class="difflineminus">-      else</span>
<a href="#l6.643"></a><span id="l6.643" class="difflineminus">-        sizeStr = bundle.getFormattedString(&quot;attachmentSizeAtLeast&quot;, [sizeStr]);</span>
<a href="#l6.644"></a><span id="l6.644" class="difflineminus">-    }</span>
<a href="#l6.645"></a><span id="l6.645" class="difflineminus">-    attachmentSize.setAttribute(&quot;value&quot;, sizeStr);</span>
<a href="#l6.646"></a><span id="l6.646" class="difflineplus">+    attachmentSize.value = getAttachmentsTotalSizeStr();</span>
<a href="#l6.647"></a><span id="l6.647" class="difflineplus">+</span>
<a href="#l6.648"></a><span id="l6.648" class="difflineplus">+    // Extra candy for external attachments.</span>
<a href="#l6.649"></a><span id="l6.649" class="difflineplus">+    displayAttachmentsForExpandedViewExternal();</span>
<a href="#l6.650"></a><span id="l6.650" class="difflineplus">+</span>
<a href="#l6.651"></a><span id="l6.651" class="difflineplus">+    // Show the appropriate toolbar button and label based on the number of</span>
<a href="#l6.652"></a><span id="l6.652" class="difflineplus">+    // attachments.</span>
<a href="#l6.653"></a><span id="l6.653" class="difflineplus">+    updateSaveAllAttachmentsButton();</span>
<a href="#l6.654"></a><span id="l6.654"> </span>
<a href="#l6.655"></a><span id="l6.655">     gBuildAttachmentsForCurrentMsg = true;</span>
<a href="#l6.656"></a><span id="l6.656">   }</span>
<a href="#l6.657"></a><span id="l6.657"> }</span>
<a href="#l6.658"></a><span id="l6.658"> </span>
<a href="#l6.659"></a><span id="l6.659" class="difflineplus">+function displayAttachmentsForExpandedViewExternal() {</span>
<a href="#l6.660"></a><span id="l6.660" class="difflineplus">+  let bundleMessenger = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l6.661"></a><span id="l6.661" class="difflineplus">+  let attachmentName = document.getElementById(&quot;attachmentName&quot;);</span>
<a href="#l6.662"></a><span id="l6.662" class="difflineplus">+  let attachmentList = document.getElementById(&quot;attachmentList&quot;);</span>
<a href="#l6.663"></a><span id="l6.663" class="difflineplus">+</span>
<a href="#l6.664"></a><span id="l6.664" class="difflineplus">+  // Attachment bar single.</span>
<a href="#l6.665"></a><span id="l6.665" class="difflineplus">+  let firstAttachment = attachmentList.firstElementChild.attachment;</span>
<a href="#l6.666"></a><span id="l6.666" class="difflineplus">+  let isExternalAttachment = firstAttachment.isExternalAttachment;</span>
<a href="#l6.667"></a><span id="l6.667" class="difflineplus">+  let displayUrl = isExternalAttachment ? firstAttachment.displayUrl : &quot;&quot;;</span>
<a href="#l6.668"></a><span id="l6.668" class="difflineplus">+  let tooltiptext = isExternalAttachment || firstAttachment.isDeleted ?</span>
<a href="#l6.669"></a><span id="l6.669" class="difflineplus">+    &quot;&quot; : attachmentName.getAttribute(&quot;tooltiptextopen&quot;);</span>
<a href="#l6.670"></a><span id="l6.670" class="difflineplus">+  let externalAttachmentNotFound = bundleMessenger.getString(&quot;externalAttachmentNotFound&quot;);</span>
<a href="#l6.671"></a><span id="l6.671" class="difflineplus">+</span>
<a href="#l6.672"></a><span id="l6.672" class="difflineplus">+  attachmentName.textContent = displayUrl;</span>
<a href="#l6.673"></a><span id="l6.673" class="difflineplus">+  attachmentName.tooltipText = tooltiptext;</span>
<a href="#l6.674"></a><span id="l6.674" class="difflineplus">+  attachmentName.setAttribute(&quot;tooltiptextexternalnotfound&quot;, externalAttachmentNotFound);</span>
<a href="#l6.675"></a><span id="l6.675" class="difflineplus">+  attachmentName.setAttribute(&quot;onmouseover&quot;,</span>
<a href="#l6.676"></a><span id="l6.676" class="difflineplus">+                              `MsgStatusFeedback.setOverLink(&quot;${displayUrl}&quot;)`);</span>
<a href="#l6.677"></a><span id="l6.677" class="difflineplus">+  attachmentName.setAttribute(&quot;onmouseout&quot;,</span>
<a href="#l6.678"></a><span id="l6.678" class="difflineplus">+                              &quot;MsgStatusFeedback.setOverLink('')&quot;);</span>
<a href="#l6.679"></a><span id="l6.679" class="difflineplus">+  attachmentName.setAttribute(&quot;onfocus&quot;,</span>
<a href="#l6.680"></a><span id="l6.680" class="difflineplus">+                              `MsgStatusFeedback.setOverLink(&quot;${displayUrl}&quot;)`);</span>
<a href="#l6.681"></a><span id="l6.681" class="difflineplus">+  attachmentName.setAttribute(&quot;onblur&quot;,</span>
<a href="#l6.682"></a><span id="l6.682" class="difflineplus">+                              &quot;MsgStatusFeedback.setOverLink('')&quot;);</span>
<a href="#l6.683"></a><span id="l6.683" class="difflineplus">+  attachmentName.classList.remove(&quot;text-link&quot;);</span>
<a href="#l6.684"></a><span id="l6.684" class="difflineplus">+  attachmentName.classList.remove(&quot;notfound&quot;);</span>
<a href="#l6.685"></a><span id="l6.685" class="difflineplus">+</span>
<a href="#l6.686"></a><span id="l6.686" class="difflineplus">+  if (firstAttachment.isDeleted) {</span>
<a href="#l6.687"></a><span id="l6.687" class="difflineplus">+    attachmentName.classList.add(&quot;notfound&quot;);</span>
<a href="#l6.688"></a><span id="l6.688" class="difflineplus">+  }</span>
<a href="#l6.689"></a><span id="l6.689" class="difflineplus">+</span>
<a href="#l6.690"></a><span id="l6.690" class="difflineplus">+  if (isExternalAttachment) {</span>
<a href="#l6.691"></a><span id="l6.691" class="difflineplus">+    attachmentName.classList.add(&quot;text-link&quot;);</span>
<a href="#l6.692"></a><span id="l6.692" class="difflineplus">+</span>
<a href="#l6.693"></a><span id="l6.693" class="difflineplus">+    if (!firstAttachment.hasFile) {</span>
<a href="#l6.694"></a><span id="l6.694" class="difflineplus">+      attachmentName.setAttribute(&quot;tooltiptext&quot;, externalAttachmentNotFound);</span>
<a href="#l6.695"></a><span id="l6.695" class="difflineplus">+      attachmentName.classList.add(&quot;notfound&quot;);</span>
<a href="#l6.696"></a><span id="l6.696" class="difflineplus">+    }</span>
<a href="#l6.697"></a><span id="l6.697" class="difflineplus">+  }</span>
<a href="#l6.698"></a><span id="l6.698" class="difflineplus">+</span>
<a href="#l6.699"></a><span id="l6.699" class="difflineplus">+  // Expanded attachment list.</span>
<a href="#l6.700"></a><span id="l6.700" class="difflineplus">+  let index = 0;</span>
<a href="#l6.701"></a><span id="l6.701" class="difflineplus">+  for (let attachmentitem of attachmentList.children) {</span>
<a href="#l6.702"></a><span id="l6.702" class="difflineplus">+    let attachment = attachmentitem.attachment;</span>
<a href="#l6.703"></a><span id="l6.703" class="difflineplus">+    if (attachment.isDeleted) {</span>
<a href="#l6.704"></a><span id="l6.704" class="difflineplus">+      attachmentitem.classList.add(&quot;notfound&quot;);</span>
<a href="#l6.705"></a><span id="l6.705" class="difflineplus">+    }</span>
<a href="#l6.706"></a><span id="l6.706" class="difflineplus">+</span>
<a href="#l6.707"></a><span id="l6.707" class="difflineplus">+    if (attachment.isExternalAttachment) {</span>
<a href="#l6.708"></a><span id="l6.708" class="difflineplus">+      displayUrl = attachment.displayUrl;</span>
<a href="#l6.709"></a><span id="l6.709" class="difflineplus">+      attachmentitem.textContent = displayUrl;</span>
<a href="#l6.710"></a><span id="l6.710" class="difflineplus">+      attachmentitem.setAttribute(&quot;tooltiptext&quot;, &quot;&quot;);</span>
<a href="#l6.711"></a><span id="l6.711" class="difflineplus">+      attachmentitem.setAttribute(&quot;onmouseover&quot;,</span>
<a href="#l6.712"></a><span id="l6.712" class="difflineplus">+                                  `MsgStatusFeedback.setOverLink(&quot;${displayUrl}&quot;)`);</span>
<a href="#l6.713"></a><span id="l6.713" class="difflineplus">+      attachmentitem.setAttribute(&quot;onmouseout&quot;,</span>
<a href="#l6.714"></a><span id="l6.714" class="difflineplus">+                                  &quot;MsgStatusFeedback.setOverLink('')&quot;);</span>
<a href="#l6.715"></a><span id="l6.715" class="difflineplus">+      attachmentitem.setAttribute(&quot;onfocus&quot;,</span>
<a href="#l6.716"></a><span id="l6.716" class="difflineplus">+                                  `MsgStatusFeedback.setOverLink(&quot;${displayUrl}&quot;)`);</span>
<a href="#l6.717"></a><span id="l6.717" class="difflineplus">+      attachmentitem.setAttribute(&quot;onblur&quot;,</span>
<a href="#l6.718"></a><span id="l6.718" class="difflineplus">+                                  &quot;MsgStatusFeedback.setOverLink('')&quot;);</span>
<a href="#l6.719"></a><span id="l6.719" class="difflineplus">+</span>
<a href="#l6.720"></a><span id="l6.720" class="difflineplus">+      let name = attachmentitem.boxObject.firstChild</span>
<a href="#l6.721"></a><span id="l6.721" class="difflineplus">+                               .getElementsByClassName(&quot;attachmentcell-name&quot;);</span>
<a href="#l6.722"></a><span id="l6.722" class="difflineplus">+      name[0].classList.add(&quot;text-link&quot;);</span>
<a href="#l6.723"></a><span id="l6.723" class="difflineplus">+</span>
<a href="#l6.724"></a><span id="l6.724" class="difflineplus">+      if (attachment.isLinkAttachment) {</span>
<a href="#l6.725"></a><span id="l6.725" class="difflineplus">+        if (index == 0) {</span>
<a href="#l6.726"></a><span id="l6.726" class="difflineplus">+          attachment.size = currentAttachments[index].size;</span>
<a href="#l6.727"></a><span id="l6.727" class="difflineplus">+        }</span>
<a href="#l6.728"></a><span id="l6.728" class="difflineplus">+      }</span>
<a href="#l6.729"></a><span id="l6.729" class="difflineplus">+</span>
<a href="#l6.730"></a><span id="l6.730" class="difflineplus">+      if (!attachment.hasFile) {</span>
<a href="#l6.731"></a><span id="l6.731" class="difflineplus">+        attachmentitem.setAttribute(&quot;tooltiptext&quot;, externalAttachmentNotFound);</span>
<a href="#l6.732"></a><span id="l6.732" class="difflineplus">+        attachmentitem.classList.add(&quot;notfound&quot;);</span>
<a href="#l6.733"></a><span id="l6.733" class="difflineplus">+      }</span>
<a href="#l6.734"></a><span id="l6.734" class="difflineplus">+    }</span>
<a href="#l6.735"></a><span id="l6.735" class="difflineplus">+</span>
<a href="#l6.736"></a><span id="l6.736" class="difflineplus">+    index++;</span>
<a href="#l6.737"></a><span id="l6.737" class="difflineplus">+  }</span>
<a href="#l6.738"></a><span id="l6.738" class="difflineplus">+}</span>
<a href="#l6.739"></a><span id="l6.739" class="difflineplus">+</span>
<a href="#l6.740"></a><span id="l6.740"> /**</span>
<a href="#l6.741"></a><span id="l6.741">  * Update the &quot;save all attachments&quot; button in the attachment pane, showing</span>
<a href="#l6.742"></a><span id="l6.742">  * the proper button and enabling/disabling it as appropriate.</span>
<a href="#l6.743"></a><span id="l6.743">  */</span>
<a href="#l6.744"></a><span id="l6.744"> function updateSaveAllAttachmentsButton() {</span>
<a href="#l6.745"></a><span id="l6.745">   let saveAllSingle   = document.getElementById(&quot;attachmentSaveAllSingle&quot;);</span>
<a href="#l6.746"></a><span id="l6.746">   let saveAllMultiple = document.getElementById(&quot;attachmentSaveAllMultiple&quot;);</span>
<a href="#l6.747"></a><span id="l6.747"> </span>
<a href="#l6.748"></a><span id="l6.748" class="difflineat">@@ -2262,16 +2440,139 @@ function updateSaveAllAttachmentsButton(</span>
<a href="#l6.749"></a><span id="l6.749">   let single = (currentAttachments.length == 1);</span>
<a href="#l6.750"></a><span id="l6.750"> </span>
<a href="#l6.751"></a><span id="l6.751">   saveAllSingle.hidden = !single;</span>
<a href="#l6.752"></a><span id="l6.752">   saveAllMultiple.hidden = single;</span>
<a href="#l6.753"></a><span id="l6.753">   saveAllSingle.disabled = saveAllMultiple.disabled = allDeleted;</span>
<a href="#l6.754"></a><span id="l6.754"> }</span>
<a href="#l6.755"></a><span id="l6.755"> </span>
<a href="#l6.756"></a><span id="l6.756"> /**</span>
<a href="#l6.757"></a><span id="l6.757" class="difflineplus">+ * Update the attachments display info after a particular attachment's</span>
<a href="#l6.758"></a><span id="l6.758" class="difflineplus">+ * existence has been verified.</span>
<a href="#l6.759"></a><span id="l6.759" class="difflineplus">+ *</span>
<a href="#l6.760"></a><span id="l6.760" class="difflineplus">+ * @param {AttachmentInfo} attachmentInfo</span>
<a href="#l6.761"></a><span id="l6.761" class="difflineplus">+ * @param {Boolean} isFetching</span>
<a href="#l6.762"></a><span id="l6.762" class="difflineplus">+ */</span>
<a href="#l6.763"></a><span id="l6.763" class="difflineplus">+function updateAttachmentsDisplay(attachmentInfo, isFetching) {</span>
<a href="#l6.764"></a><span id="l6.764" class="difflineplus">+  if (attachmentInfo.isExternalAttachment || attachmentInfo.ALWAYSFETCHSIZE) {</span>
<a href="#l6.765"></a><span id="l6.765" class="difflineplus">+    let attachmentList = document.getElementById(&quot;attachmentList&quot;);</span>
<a href="#l6.766"></a><span id="l6.766" class="difflineplus">+    let attachmentIcon = document.getElementById(&quot;attachmentIcon&quot;);</span>
<a href="#l6.767"></a><span id="l6.767" class="difflineplus">+    let attachmentName = document.getElementById(&quot;attachmentName&quot;);</span>
<a href="#l6.768"></a><span id="l6.768" class="difflineplus">+    let attachmentSize = document.getElementById(&quot;attachmentSize&quot;);</span>
<a href="#l6.769"></a><span id="l6.769" class="difflineplus">+    let attachmentItem = attachmentList.findItemForAttachment(attachmentInfo);</span>
<a href="#l6.770"></a><span id="l6.770" class="difflineplus">+    let index = attachmentList.getIndexOfItem(attachmentItem);</span>
<a href="#l6.771"></a><span id="l6.771" class="difflineplus">+</span>
<a href="#l6.772"></a><span id="l6.772" class="difflineplus">+    if (isFetching) {</span>
<a href="#l6.773"></a><span id="l6.773" class="difflineplus">+      // Set elements busy to show the user this is potentially a long network</span>
<a href="#l6.774"></a><span id="l6.774" class="difflineplus">+      // fetch for the link attachment.</span>
<a href="#l6.775"></a><span id="l6.775" class="difflineplus">+      attachmentIcon.setAttribute(&quot;src&quot;, &quot;chrome://global/skin/icons/loading.png&quot;);</span>
<a href="#l6.776"></a><span id="l6.776" class="difflineplus">+      attachmentItem.classList.add(&quot;busy&quot;);</span>
<a href="#l6.777"></a><span id="l6.777" class="difflineplus">+      attachmentItem.setAttribute(&quot;image&quot;, &quot;chrome://global/skin/icons/loading.png&quot;);</span>
<a href="#l6.778"></a><span id="l6.778" class="difflineplus">+      return;</span>
<a href="#l6.779"></a><span id="l6.779" class="difflineplus">+    }</span>
<a href="#l6.780"></a><span id="l6.780" class="difflineplus">+</span>
<a href="#l6.781"></a><span id="l6.781" class="difflineplus">+    if (attachmentInfo.message != gFolderDisplay.selectedMessage) {</span>
<a href="#l6.782"></a><span id="l6.782" class="difflineplus">+      // The user changed messages while fetching, reset the bar and exit;</span>
<a href="#l6.783"></a><span id="l6.783" class="difflineplus">+      // the listitems are torn down/rebuilt on each message load.</span>
<a href="#l6.784"></a><span id="l6.784" class="difflineplus">+      attachmentIcon.removeAttribute(&quot;src&quot;);</span>
<a href="#l6.785"></a><span id="l6.785" class="difflineplus">+      return;</span>
<a href="#l6.786"></a><span id="l6.786" class="difflineplus">+    }</span>
<a href="#l6.787"></a><span id="l6.787" class="difflineplus">+</span>
<a href="#l6.788"></a><span id="l6.788" class="difflineplus">+    if (index == -1) {</span>
<a href="#l6.789"></a><span id="l6.789" class="difflineplus">+      // The user changed messages while fetching, then came back to the same</span>
<a href="#l6.790"></a><span id="l6.790" class="difflineplus">+      // message. The reset of busy state has already happened and anyway the</span>
<a href="#l6.791"></a><span id="l6.791" class="difflineplus">+      // item has already been torn down so the index will be invalid; exit.</span>
<a href="#l6.792"></a><span id="l6.792" class="difflineplus">+      return;</span>
<a href="#l6.793"></a><span id="l6.793" class="difflineplus">+    }</span>
<a href="#l6.794"></a><span id="l6.794" class="difflineplus">+</span>
<a href="#l6.795"></a><span id="l6.795" class="difflineplus">+    currentAttachments[index].size = attachmentInfo.size;</span>
<a href="#l6.796"></a><span id="l6.796" class="difflineplus">+    let tooltiptextExternalNotFound = attachmentName.getAttribute(&quot;tooltiptextexternalnotfound&quot;);</span>
<a href="#l6.797"></a><span id="l6.797" class="difflineplus">+</span>
<a href="#l6.798"></a><span id="l6.798" class="difflineplus">+    let sizeStr;</span>
<a href="#l6.799"></a><span id="l6.799" class="difflineplus">+    let bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l6.800"></a><span id="l6.800" class="difflineplus">+    if (attachmentInfo.size &lt; 1) {</span>
<a href="#l6.801"></a><span id="l6.801" class="difflineplus">+      sizeStr = bundle.getString(&quot;attachmentSizeUnknown&quot;);</span>
<a href="#l6.802"></a><span id="l6.802" class="difflineplus">+    } else {</span>
<a href="#l6.803"></a><span id="l6.803" class="difflineplus">+      sizeStr = messenger.formatFileSize(attachmentInfo.size);</span>
<a href="#l6.804"></a><span id="l6.804" class="difflineplus">+    }</span>
<a href="#l6.805"></a><span id="l6.805" class="difflineplus">+</span>
<a href="#l6.806"></a><span id="l6.806" class="difflineplus">+    // The attachment listitem.</span>
<a href="#l6.807"></a><span id="l6.807" class="difflineplus">+    attachmentItem.classList.remove(&quot;busy&quot;);</span>
<a href="#l6.808"></a><span id="l6.808" class="difflineplus">+    attachmentItem.removeAttribute(&quot;image&quot;);</span>
<a href="#l6.809"></a><span id="l6.809" class="difflineplus">+    attachmentItem._updateImage();</span>
<a href="#l6.810"></a><span id="l6.810" class="difflineplus">+    if (attachmentInfo.hasFile) {</span>
<a href="#l6.811"></a><span id="l6.811" class="difflineplus">+      attachmentItem.setAttribute(&quot;size&quot;, sizeStr);</span>
<a href="#l6.812"></a><span id="l6.812" class="difflineplus">+      attachmentItem.removeAttribute(&quot;tooltiptext&quot;);</span>
<a href="#l6.813"></a><span id="l6.813" class="difflineplus">+      attachmentItem.classList.remove(&quot;notfound&quot;);</span>
<a href="#l6.814"></a><span id="l6.814" class="difflineplus">+    } else {</span>
<a href="#l6.815"></a><span id="l6.815" class="difflineplus">+      attachmentItem.removeAttribute(&quot;size&quot;);</span>
<a href="#l6.816"></a><span id="l6.816" class="difflineplus">+      attachmentItem.setAttribute(&quot;tooltiptext&quot;, tooltiptextExternalNotFound);</span>
<a href="#l6.817"></a><span id="l6.817" class="difflineplus">+      attachmentItem.classList.add(&quot;notfound&quot;);</span>
<a href="#l6.818"></a><span id="l6.818" class="difflineplus">+    }</span>
<a href="#l6.819"></a><span id="l6.819" class="difflineplus">+</span>
<a href="#l6.820"></a><span id="l6.820" class="difflineplus">+    // The attachmentbar.</span>
<a href="#l6.821"></a><span id="l6.821" class="difflineplus">+    updateSaveAllAttachmentsButton();</span>
<a href="#l6.822"></a><span id="l6.822" class="difflineplus">+    attachmentSize.value = getAttachmentsTotalSizeStr();</span>
<a href="#l6.823"></a><span id="l6.823" class="difflineplus">+    let attachemtsBusy = attachmentList.querySelectorAll(&quot;.attachmentItem.busy&quot;);</span>
<a href="#l6.824"></a><span id="l6.824" class="difflineplus">+    if (attachemtsBusy.length == 0)</span>
<a href="#l6.825"></a><span id="l6.825" class="difflineplus">+      attachmentIcon.removeAttribute(&quot;src&quot;);</span>
<a href="#l6.826"></a><span id="l6.826" class="difflineplus">+</span>
<a href="#l6.827"></a><span id="l6.827" class="difflineplus">+    // If it's the first one (and there's only one).</span>
<a href="#l6.828"></a><span id="l6.828" class="difflineplus">+    if (index == 0) {</span>
<a href="#l6.829"></a><span id="l6.829" class="difflineplus">+      if (attachmentInfo.hasFile) {</span>
<a href="#l6.830"></a><span id="l6.830" class="difflineplus">+        attachmentName.removeAttribute(&quot;tooltiptext&quot;);</span>
<a href="#l6.831"></a><span id="l6.831" class="difflineplus">+        attachmentName.classList.remove(&quot;notfound&quot;);</span>
<a href="#l6.832"></a><span id="l6.832" class="difflineplus">+      } else {</span>
<a href="#l6.833"></a><span id="l6.833" class="difflineplus">+        attachmentName.setAttribute(&quot;tooltiptext&quot;, tooltiptextExternalNotFound);</span>
<a href="#l6.834"></a><span id="l6.834" class="difflineplus">+        attachmentName.classList.add(&quot;notfound&quot;);</span>
<a href="#l6.835"></a><span id="l6.835" class="difflineplus">+      }</span>
<a href="#l6.836"></a><span id="l6.836" class="difflineplus">+    }</span>
<a href="#l6.837"></a><span id="l6.837" class="difflineplus">+</span>
<a href="#l6.838"></a><span id="l6.838" class="difflineplus">+    // Reset widths since size may have changed; ensure no false cropping of</span>
<a href="#l6.839"></a><span id="l6.839" class="difflineplus">+    // the attachment item name.</span>
<a href="#l6.840"></a><span id="l6.840" class="difflineplus">+    attachmentList.setOptimumWidth();</span>
<a href="#l6.841"></a><span id="l6.841" class="difflineplus">+  }</span>
<a href="#l6.842"></a><span id="l6.842" class="difflineplus">+}</span>
<a href="#l6.843"></a><span id="l6.843" class="difflineplus">+</span>
<a href="#l6.844"></a><span id="l6.844" class="difflineplus">+/**</span>
<a href="#l6.845"></a><span id="l6.845" class="difflineplus">+ * Calculate the total size of all attachments in the message as emitted to</span>
<a href="#l6.846"></a><span id="l6.846" class="difflineplus">+ * |currentAttachments| and return a pretty string.</span>
<a href="#l6.847"></a><span id="l6.847" class="difflineplus">+ *</span>
<a href="#l6.848"></a><span id="l6.848" class="difflineplus">+ * @returns {String} - Description of the attachment size (e.g. 123 KB or 3.1MB)</span>
<a href="#l6.849"></a><span id="l6.849" class="difflineplus">+ */</span>
<a href="#l6.850"></a><span id="l6.850" class="difflineplus">+function getAttachmentsTotalSizeStr() {</span>
<a href="#l6.851"></a><span id="l6.851" class="difflineplus">+  let bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l6.852"></a><span id="l6.852" class="difflineplus">+  let totalSize = 0;</span>
<a href="#l6.853"></a><span id="l6.853" class="difflineplus">+  let lastPartID;</span>
<a href="#l6.854"></a><span id="l6.854" class="difflineplus">+  let unknownSize = false;</span>
<a href="#l6.855"></a><span id="l6.855" class="difflineplus">+  for (let attachment of currentAttachments) {</span>
<a href="#l6.856"></a><span id="l6.856" class="difflineplus">+    // Check if this attachment's part ID is a child of the last attachment</span>
<a href="#l6.857"></a><span id="l6.857" class="difflineplus">+    // we counted. If so, skip it, since we already accounted for its size</span>
<a href="#l6.858"></a><span id="l6.858" class="difflineplus">+    // from its parent.</span>
<a href="#l6.859"></a><span id="l6.859" class="difflineplus">+    if (!lastPartID || attachment.partID.indexOf(lastPartID) != 0) {</span>
<a href="#l6.860"></a><span id="l6.860" class="difflineplus">+      lastPartID = attachment.partID;</span>
<a href="#l6.861"></a><span id="l6.861" class="difflineplus">+      if (attachment.size != -1)</span>
<a href="#l6.862"></a><span id="l6.862" class="difflineplus">+        totalSize += Number(attachment.size);</span>
<a href="#l6.863"></a><span id="l6.863" class="difflineplus">+      else if (!attachment.isDeleted)</span>
<a href="#l6.864"></a><span id="l6.864" class="difflineplus">+        unknownSize = true;</span>
<a href="#l6.865"></a><span id="l6.865" class="difflineplus">+    }</span>
<a href="#l6.866"></a><span id="l6.866" class="difflineplus">+  }</span>
<a href="#l6.867"></a><span id="l6.867" class="difflineplus">+</span>
<a href="#l6.868"></a><span id="l6.868" class="difflineplus">+  let sizeStr = messenger.formatFileSize(totalSize);</span>
<a href="#l6.869"></a><span id="l6.869" class="difflineplus">+  if (unknownSize) {</span>
<a href="#l6.870"></a><span id="l6.870" class="difflineplus">+    if (totalSize == 0)</span>
<a href="#l6.871"></a><span id="l6.871" class="difflineplus">+      sizeStr = bundle.getString(&quot;attachmentSizeUnknown&quot;);</span>
<a href="#l6.872"></a><span id="l6.872" class="difflineplus">+    else</span>
<a href="#l6.873"></a><span id="l6.873" class="difflineplus">+      sizeStr = bundle.getFormattedString(&quot;attachmentSizeAtLeast&quot;, [sizeStr]);</span>
<a href="#l6.874"></a><span id="l6.874" class="difflineplus">+  }</span>
<a href="#l6.875"></a><span id="l6.875" class="difflineplus">+</span>
<a href="#l6.876"></a><span id="l6.876" class="difflineplus">+  return sizeStr;</span>
<a href="#l6.877"></a><span id="l6.877" class="difflineplus">+}</span>
<a href="#l6.878"></a><span id="l6.878" class="difflineplus">+</span>
<a href="#l6.879"></a><span id="l6.879" class="difflineplus">+/**</span>
<a href="#l6.880"></a><span id="l6.880">  * Expand/collapse the attachment list. When expanding it, automatically resize</span>
<a href="#l6.881"></a><span id="l6.881">  * it to an appropriate height (1/4 the message pane or smaller).</span>
<a href="#l6.882"></a><span id="l6.882">  *</span>
<a href="#l6.883"></a><span id="l6.883">  * @param expanded  True if the attachment list should be expanded, false</span>
<a href="#l6.884"></a><span id="l6.884">  *                  otherwise. If |expanded| is not specified, toggle the state.</span>
<a href="#l6.885"></a><span id="l6.885">  * @param updateFocus  (optional) True if the focus should be updated, focusing</span>
<a href="#l6.886"></a><span id="l6.886">  *                     on the attachmentList when expanding, or the messagepane</span>
<a href="#l6.887"></a><span id="l6.887">  *                     when collapsing (but only when the attachmentList was</span>
<a href="#l6.888"></a><span id="l6.888" class="difflineat">@@ -2326,17 +2627,17 @@ function toggleAttachmentList(expanded, </span>
<a href="#l6.889"></a><span id="l6.889"> }</span>
<a href="#l6.890"></a><span id="l6.890"> </span>
<a href="#l6.891"></a><span id="l6.891"> /**</span>
<a href="#l6.892"></a><span id="l6.892">  * Pick out a nice icon for the attachment.</span>
<a href="#l6.893"></a><span id="l6.893">  * @param attachment  the nsIMsgAttachment object to show icon for</span>
<a href="#l6.894"></a><span id="l6.894">  */</span>
<a href="#l6.895"></a><span id="l6.895"> function getIconForAttachment(attachment) {</span>
<a href="#l6.896"></a><span id="l6.896">   if (attachment.isDeleted) {</span>
<a href="#l6.897"></a><span id="l6.897" class="difflineminus">-    return &quot;chrome://messenger/skin/icon/attachment-deleted.png&quot;;</span>
<a href="#l6.898"></a><span id="l6.898" class="difflineplus">+    return &quot;chrome://messenger/skin/icons/attachment-deleted.png&quot;;</span>
<a href="#l6.899"></a><span id="l6.899">   }</span>
<a href="#l6.900"></a><span id="l6.900">   return `moz-icon://${attachment.name}?size=16&amp;amp;contentType=${attachment.contentType}`;</span>
<a href="#l6.901"></a><span id="l6.901"> }</span>
<a href="#l6.902"></a><span id="l6.902"> </span>
<a href="#l6.903"></a><span id="l6.903"> /**</span>
<a href="#l6.904"></a><span id="l6.904">  * Public method called when we create the attachments file menu</span>
<a href="#l6.905"></a><span id="l6.905">  */</span>
<a href="#l6.906"></a><span id="l6.906"> function FillAttachmentListPopup(aEvent, aPopup) {</span>
<a href="#l6.907"></a><span id="l6.907" class="difflineat">@@ -2405,16 +2706,32 @@ function addAttachmentToPopup(popup, att</span>
<a href="#l6.908"></a><span id="l6.908">     aEvent.stopPropagation();</span>
<a href="#l6.909"></a><span id="l6.909">   });</span>
<a href="#l6.910"></a><span id="l6.910"> </span>
<a href="#l6.911"></a><span id="l6.911">   // Due to Bug #314228, we must append our menupopup to the new attachment</span>
<a href="#l6.912"></a><span id="l6.912">   // menu item before we inserting the attachment menu into the popup. If we</span>
<a href="#l6.913"></a><span id="l6.913">   // don't, our attachment menu items will not show up.</span>
<a href="#l6.914"></a><span id="l6.914">   item = popup.insertBefore(item, popup.childNodes[indexOfSeparator]);</span>
<a href="#l6.915"></a><span id="l6.915"> </span>
<a href="#l6.916"></a><span id="l6.916" class="difflineplus">+  if (attachment.isExternalAttachment) {</span>
<a href="#l6.917"></a><span id="l6.917" class="difflineplus">+    if (!attachment.hasFile) {</span>
<a href="#l6.918"></a><span id="l6.918" class="difflineplus">+      item.classList.add(&quot;notfound&quot;);</span>
<a href="#l6.919"></a><span id="l6.919" class="difflineplus">+    } else {</span>
<a href="#l6.920"></a><span id="l6.920" class="difflineplus">+      // The text-link class must be added to the &lt;label&gt; and have a &lt;menu&gt;</span>
<a href="#l6.921"></a><span id="l6.921" class="difflineplus">+      // hover rule. Adding to &lt;menu&gt; makes hover overflow the underline to</span>
<a href="#l6.922"></a><span id="l6.922" class="difflineplus">+      // the popup items.</span>
<a href="#l6.923"></a><span id="l6.923" class="difflineplus">+      let label = item.boxObject.firstChild.nextSibling;</span>
<a href="#l6.924"></a><span id="l6.924" class="difflineplus">+      label.classList.add(&quot;text-link&quot;);</span>
<a href="#l6.925"></a><span id="l6.925" class="difflineplus">+    }</span>
<a href="#l6.926"></a><span id="l6.926" class="difflineplus">+  }</span>
<a href="#l6.927"></a><span id="l6.927" class="difflineplus">+</span>
<a href="#l6.928"></a><span id="l6.928" class="difflineplus">+  if (attachment.isDeleted) {</span>
<a href="#l6.929"></a><span id="l6.929" class="difflineplus">+    item.classList.add(&quot;notfound&quot;);</span>
<a href="#l6.930"></a><span id="l6.930" class="difflineplus">+  }</span>
<a href="#l6.931"></a><span id="l6.931" class="difflineplus">+</span>
<a href="#l6.932"></a><span id="l6.932">   var detached = attachment.isExternalAttachment;</span>
<a href="#l6.933"></a><span id="l6.933">   var deleted  = !attachment.hasFile;</span>
<a href="#l6.934"></a><span id="l6.934">   var canDetach = CanDetachAttachments() &amp;&amp; !deleted &amp;&amp; !detached;</span>
<a href="#l6.935"></a><span id="l6.935"> </span>
<a href="#l6.936"></a><span id="l6.936">   if (deleted) {</span>
<a href="#l6.937"></a><span id="l6.937">     // We can't do anything with a deleted attachment, so just return.</span>
<a href="#l6.938"></a><span id="l6.938">     item.disabled = true;</span>
<a href="#l6.939"></a><span id="l6.939">     return;</span>
<a href="#l6.940"></a><span id="l6.940" class="difflineat">@@ -2454,16 +2771,29 @@ function addAttachmentToPopup(popup, att</span>
<a href="#l6.941"></a><span id="l6.941">   // Create the &quot;delete&quot; menu item</span>
<a href="#l6.942"></a><span id="l6.942">   menuitementry = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l6.943"></a><span id="l6.943">   menuitementry.attachment = attachment;</span>
<a href="#l6.944"></a><span id="l6.944">   menuitementry.setAttribute(&quot;oncommand&quot;, &quot;this.attachment.detach(false);&quot;);</span>
<a href="#l6.945"></a><span id="l6.945">   menuitementry.setAttribute(&quot;label&quot;, getString(&quot;deleteLabel&quot;));</span>
<a href="#l6.946"></a><span id="l6.946">   menuitementry.setAttribute(&quot;accesskey&quot;, getString(&quot;deleteLabelAccesskey&quot;));</span>
<a href="#l6.947"></a><span id="l6.947">   menuitementry.setAttribute(&quot;disabled&quot;, !canDetach);</span>
<a href="#l6.948"></a><span id="l6.948">   menuitementry = openpopup.appendChild(menuitementry);</span>
<a href="#l6.949"></a><span id="l6.949" class="difflineplus">+</span>
<a href="#l6.950"></a><span id="l6.950" class="difflineplus">+  // Create the &quot;open containing folder&quot; menu item, for existing detached only.</span>
<a href="#l6.951"></a><span id="l6.951" class="difflineplus">+  if (attachment.isFileAttachment) {</span>
<a href="#l6.952"></a><span id="l6.952" class="difflineplus">+    let menuseparator = document.createElement(&quot;menuseparator&quot;);</span>
<a href="#l6.953"></a><span id="l6.953" class="difflineplus">+    openpopup.appendChild(menuseparator);</span>
<a href="#l6.954"></a><span id="l6.954" class="difflineplus">+    menuitementry = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l6.955"></a><span id="l6.955" class="difflineplus">+    menuitementry.attachment = attachment;</span>
<a href="#l6.956"></a><span id="l6.956" class="difflineplus">+    menuitementry.setAttribute(&quot;oncommand&quot;, &quot;this.attachment.openFolder();&quot;);</span>
<a href="#l6.957"></a><span id="l6.957" class="difflineplus">+    menuitementry.setAttribute(&quot;label&quot;, getString(&quot;openFolderLabel&quot;));</span>
<a href="#l6.958"></a><span id="l6.958" class="difflineplus">+    menuitementry.setAttribute(&quot;accesskey&quot;, getString(&quot;openFolderLabelAccesskey&quot;));</span>
<a href="#l6.959"></a><span id="l6.959" class="difflineplus">+    menuitementry.setAttribute(&quot;disabled&quot;, !attachment.hasFile);</span>
<a href="#l6.960"></a><span id="l6.960" class="difflineplus">+    menuitementry = openpopup.appendChild(menuitementry);</span>
<a href="#l6.961"></a><span id="l6.961" class="difflineplus">+  }</span>
<a href="#l6.962"></a><span id="l6.962"> }</span>
<a href="#l6.963"></a><span id="l6.963"> </span>
<a href="#l6.964"></a><span id="l6.964"> /**</span>
<a href="#l6.965"></a><span id="l6.965">  * Open an attachment from the attachment bar.</span>
<a href="#l6.966"></a><span id="l6.966">  *</span>
<a href="#l6.967"></a><span id="l6.967">  * @param event the event that triggered this action</span>
<a href="#l6.968"></a><span id="l6.968">  */</span>
<a href="#l6.969"></a><span id="l6.969"> function OpenAttachmentFromBar(event) {</span>
<a href="#l6.970"></a><span id="l6.970" class="difflineat">@@ -2518,32 +2848,42 @@ function HandleSelectedAttachments(actio</span>
<a href="#l6.971"></a><span id="l6.971"> </span>
<a href="#l6.972"></a><span id="l6.972"> /**</span>
<a href="#l6.973"></a><span id="l6.973">  * Perform an action on multiple attachments (e.g. open or save)</span>
<a href="#l6.974"></a><span id="l6.974">  *</span>
<a href="#l6.975"></a><span id="l6.975">  * @param attachments  an array of AttachmentInfo objects to work with</span>
<a href="#l6.976"></a><span id="l6.976">  * @param action  one of &quot;open&quot;, &quot;save&quot;, &quot;saveAs&quot;, &quot;detach&quot;, or &quot;delete&quot;</span>
<a href="#l6.977"></a><span id="l6.977">  */</span>
<a href="#l6.978"></a><span id="l6.978"> function HandleMultipleAttachments(attachments, action) {</span>
<a href="#l6.979"></a><span id="l6.979" class="difflineplus">+  // Feed message link attachments save handling.</span>
<a href="#l6.980"></a><span id="l6.980" class="difflineplus">+  if (gFolderDisplay.selectedMessageIsFeed &amp;&amp;</span>
<a href="#l6.981"></a><span id="l6.981" class="difflineplus">+      (action == &quot;save&quot; || action == &quot;saveAs&quot;)) {</span>
<a href="#l6.982"></a><span id="l6.982" class="difflineplus">+    saveLinkAttachmentsToFile(attachments);</span>
<a href="#l6.983"></a><span id="l6.983" class="difflineplus">+    return;</span>
<a href="#l6.984"></a><span id="l6.984" class="difflineplus">+  }</span>
<a href="#l6.985"></a><span id="l6.985" class="difflineplus">+</span>
<a href="#l6.986"></a><span id="l6.986">   // convert our attachment data into some c++ friendly structs</span>
<a href="#l6.987"></a><span id="l6.987">   var attachmentContentTypeArray = [];</span>
<a href="#l6.988"></a><span id="l6.988">   var attachmentUrlArray = [];</span>
<a href="#l6.989"></a><span id="l6.989" class="difflineplus">+  var attachmentDisplayUrlArray = [];</span>
<a href="#l6.990"></a><span id="l6.990">   var attachmentDisplayNameArray = [];</span>
<a href="#l6.991"></a><span id="l6.991">   var attachmentMessageUriArray = [];</span>
<a href="#l6.992"></a><span id="l6.992"> </span>
<a href="#l6.993"></a><span id="l6.993">   // populate these arrays..</span>
<a href="#l6.994"></a><span id="l6.994">   var actionIndex = 0;</span>
<a href="#l6.995"></a><span id="l6.995">   for (let attachment of attachments) {</span>
<a href="#l6.996"></a><span id="l6.996">     // Exclude attachment which are 1) deleted, or 2) detached with missing</span>
<a href="#l6.997"></a><span id="l6.997" class="difflineminus">-    // external files.</span>
<a href="#l6.998"></a><span id="l6.998" class="difflineminus">-    if (!attachment.hasFile)</span>
<a href="#l6.999"></a><span id="l6.999" class="difflineplus">+    // external files, unless copying urls.</span>
<a href="#l6.1000"></a><span id="l6.1000" class="difflineplus">+    if (!attachment.hasFile &amp;&amp; action != &quot;copyUrl&quot;) {</span>
<a href="#l6.1001"></a><span id="l6.1001">       continue;</span>
<a href="#l6.1002"></a><span id="l6.1002" class="difflineplus">+    }</span>
<a href="#l6.1003"></a><span id="l6.1003"> </span>
<a href="#l6.1004"></a><span id="l6.1004">     attachmentContentTypeArray[actionIndex] = attachment.contentType;</span>
<a href="#l6.1005"></a><span id="l6.1005">     attachmentUrlArray[actionIndex] = attachment.url;</span>
<a href="#l6.1006"></a><span id="l6.1006" class="difflineplus">+    attachmentDisplayUrlArray[actionIndex] = attachment.displayUrl;</span>
<a href="#l6.1007"></a><span id="l6.1007">     attachmentDisplayNameArray[actionIndex] = encodeURI(attachment.name);</span>
<a href="#l6.1008"></a><span id="l6.1008">     attachmentMessageUriArray[actionIndex] = attachment.uri;</span>
<a href="#l6.1009"></a><span id="l6.1009">     ++actionIndex;</span>
<a href="#l6.1010"></a><span id="l6.1010">   }</span>
<a href="#l6.1011"></a><span id="l6.1011"> </span>
<a href="#l6.1012"></a><span id="l6.1012">   // The list has been built. Now call our action code...</span>
<a href="#l6.1013"></a><span id="l6.1013">   switch (action) {</span>
<a href="#l6.1014"></a><span id="l6.1014">     case &quot;save&quot;:</span>
<a href="#l6.1015"></a><span id="l6.1015" class="difflineat">@@ -2599,23 +2939,60 @@ function HandleMultipleAttachments(attac</span>
<a href="#l6.1016"></a><span id="l6.1016">           setTimeout(actionFunction, 100, attachments[i]);</span>
<a href="#l6.1017"></a><span id="l6.1017">       }</span>
<a href="#l6.1018"></a><span id="l6.1018">       return;</span>
<a href="#l6.1019"></a><span id="l6.1019">     case &quot;copyUrl&quot;:</span>
<a href="#l6.1020"></a><span id="l6.1020">       // Copy external http url(s) to clipboard. The menuitem is hidden unless</span>
<a href="#l6.1021"></a><span id="l6.1021">       // all selected attachment urls are http.</span>
<a href="#l6.1022"></a><span id="l6.1022">       let clipboard = Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l6.1023"></a><span id="l6.1023">                         .getService(Ci.nsIClipboardHelper);</span>
<a href="#l6.1024"></a><span id="l6.1024" class="difflineminus">-      clipboard.copyString(attachmentUrlArray.join(&quot;\n&quot;));</span>
<a href="#l6.1025"></a><span id="l6.1025" class="difflineplus">+      clipboard.copyString(attachmentDisplayUrlArray.join(&quot;\n&quot;));</span>
<a href="#l6.1026"></a><span id="l6.1026" class="difflineplus">+      return;</span>
<a href="#l6.1027"></a><span id="l6.1027" class="difflineplus">+    case &quot;openFolder&quot;:</span>
<a href="#l6.1028"></a><span id="l6.1028" class="difflineplus">+      for (let attachment of attachments) {</span>
<a href="#l6.1029"></a><span id="l6.1029" class="difflineplus">+        setTimeout(() =&gt; attachment.openFolder());</span>
<a href="#l6.1030"></a><span id="l6.1030" class="difflineplus">+      }</span>
<a href="#l6.1031"></a><span id="l6.1031">       return;</span>
<a href="#l6.1032"></a><span id="l6.1032">     default:</span>
<a href="#l6.1033"></a><span id="l6.1033">       throw new Error(&quot;unknown HandleMultipleAttachments action: &quot; + action);</span>
<a href="#l6.1034"></a><span id="l6.1034">   }</span>
<a href="#l6.1035"></a><span id="l6.1035"> }</span>
<a href="#l6.1036"></a><span id="l6.1036"> </span>
<a href="#l6.1037"></a><span id="l6.1037" class="difflineplus">+/**</span>
<a href="#l6.1038"></a><span id="l6.1038" class="difflineplus">+ * Link attachments are passed as an array of AttachmentInfo objects. This</span>
<a href="#l6.1039"></a><span id="l6.1039" class="difflineplus">+ * is meant to download http link content using the browser method.</span>
<a href="#l6.1040"></a><span id="l6.1040" class="difflineplus">+ *</span>
<a href="#l6.1041"></a><span id="l6.1041" class="difflineplus">+ * @param {AttachmentInfo[]} aAttachmentInfoArray - Array of attachmentInfo.</span>
<a href="#l6.1042"></a><span id="l6.1042" class="difflineplus">+ */</span>
<a href="#l6.1043"></a><span id="l6.1043" class="difflineplus">+async function saveLinkAttachmentsToFile(aAttachmentInfoArray) {</span>
<a href="#l6.1044"></a><span id="l6.1044" class="difflineplus">+  let aURL, aDocument, aDefaultFileName, aContentDisposition,</span>
<a href="#l6.1045"></a><span id="l6.1045" class="difflineplus">+      aContentType, aShouldBypassCache, aFilePickerTitleKey,</span>
<a href="#l6.1046"></a><span id="l6.1046" class="difflineplus">+      aChosenData, aReferrer, aInitiatingDocument, aSkipPrompt,</span>
<a href="#l6.1047"></a><span id="l6.1047" class="difflineplus">+      aCacheKey, aIsContentWindowPrivate;</span>
<a href="#l6.1048"></a><span id="l6.1048" class="difflineplus">+  // Required for privacy context.</span>
<a href="#l6.1049"></a><span id="l6.1049" class="difflineplus">+  aInitiatingDocument = document;</span>
<a href="#l6.1050"></a><span id="l6.1050" class="difflineplus">+  for (let attachment of aAttachmentInfoArray) {</span>
<a href="#l6.1051"></a><span id="l6.1051" class="difflineplus">+    if (!attachment.hasFile || attachment.message != gFolderDisplay.selectedMessage) {</span>
<a href="#l6.1052"></a><span id="l6.1052" class="difflineplus">+      continue;</span>
<a href="#l6.1053"></a><span id="l6.1053" class="difflineplus">+    }</span>
<a href="#l6.1054"></a><span id="l6.1054" class="difflineplus">+</span>
<a href="#l6.1055"></a><span id="l6.1055" class="difflineplus">+    let empty = await attachment.isEmpty();</span>
<a href="#l6.1056"></a><span id="l6.1056" class="difflineplus">+    if (empty) {</span>
<a href="#l6.1057"></a><span id="l6.1057" class="difflineplus">+      continue;</span>
<a href="#l6.1058"></a><span id="l6.1058" class="difflineplus">+    }</span>
<a href="#l6.1059"></a><span id="l6.1059" class="difflineplus">+</span>
<a href="#l6.1060"></a><span id="l6.1060" class="difflineplus">+    aURL = attachment.url;</span>
<a href="#l6.1061"></a><span id="l6.1061" class="difflineplus">+    aDefaultFileName = attachment.name;</span>
<a href="#l6.1062"></a><span id="l6.1062" class="difflineplus">+    internalSave(aURL, aDocument, aDefaultFileName, aContentDisposition,</span>
<a href="#l6.1063"></a><span id="l6.1063" class="difflineplus">+                 aContentType, aShouldBypassCache, aFilePickerTitleKey,</span>
<a href="#l6.1064"></a><span id="l6.1064" class="difflineplus">+                 aChosenData, aReferrer, aInitiatingDocument, aSkipPrompt,</span>
<a href="#l6.1065"></a><span id="l6.1065" class="difflineplus">+                 aCacheKey, aIsContentWindowPrivate);</span>
<a href="#l6.1066"></a><span id="l6.1066" class="difflineplus">+  }</span>
<a href="#l6.1067"></a><span id="l6.1067" class="difflineplus">+}</span>
<a href="#l6.1068"></a><span id="l6.1068" class="difflineplus">+</span>
<a href="#l6.1069"></a><span id="l6.1069"> function ClearAttachmentList() {</span>
<a href="#l6.1070"></a><span id="l6.1070">   // We also have to disable the Message/Attachments menuitem.</span>
<a href="#l6.1071"></a><span id="l6.1071">   var node = document.getElementById(&quot;msgAttachmentMenu&quot;);</span>
<a href="#l6.1072"></a><span id="l6.1072">   if (node)</span>
<a href="#l6.1073"></a><span id="l6.1073">     node.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l6.1074"></a><span id="l6.1074">   // Do the same on appmenu.</span>
<a href="#l6.1075"></a><span id="l6.1075">   let appmenunode = document.getElementById(&quot;appmenu_msgAttachmentMenu&quot;);</span>
<a href="#l6.1076"></a><span id="l6.1076">   if (appmenunode)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -371,20 +371,23 @@ draftMessageButtonKey=E</span>
<a href="#l7.4"></a><span id="l7.4"> openLabel=Open</span>
<a href="#l7.5"></a><span id="l7.5"> openLabelAccesskey=O</span>
<a href="#l7.6"></a><span id="l7.6"> saveLabel=Save As</span>
<a href="#l7.7"></a><span id="l7.7"> saveLabelAccesskey=A</span>
<a href="#l7.8"></a><span id="l7.8"> detachLabel=Detach</span>
<a href="#l7.9"></a><span id="l7.9"> detachLabelAccesskey=D</span>
<a href="#l7.10"></a><span id="l7.10"> deleteLabel=Delete</span>
<a href="#l7.11"></a><span id="l7.11"> deleteLabelAccesskey=E</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+openFolderLabel=Open Containing Folder</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+openFolderLabelAccesskey=F</span>
<a href="#l7.14"></a><span id="l7.14"> deleteAttachments=The following attachments will be permanently deleted from this message:\n%S\nThis action cannot be undone. Do you wish to continue?</span>
<a href="#l7.15"></a><span id="l7.15"> detachAttachments=The following attachments have been successfully saved and will now be permanently deleted from this message:\n%S\nThis action cannot be undone. Do you wish to continue?</span>
<a href="#l7.16"></a><span id="l7.16"> deleteAttachmentFailure=Failed to delete the selected attachments.</span>
<a href="#l7.17"></a><span id="l7.17"> emptyAttachment=This attachment appears to be empty.\nPlease check with the person who sent this.\nOften company firewalls or antivirus programs will destroy attachments.</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+externalAttachmentNotFound=This detached file or link attachment is not found or is not accessible at this location anymore.</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20"> # LOCALIZATION NOTE (attachmentCount): Semi-colon list of plural forms.</span>
<a href="#l7.21"></a><span id="l7.21"> # See: https://developer.mozilla.org/en/Localization_and_Plurals</span>
<a href="#l7.22"></a><span id="l7.22"> # #1 number of attachments</span>
<a href="#l7.23"></a><span id="l7.23"> attachmentCount=#1 attachment;#1 attachments</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25"> # LOCALIZATION NOTE (attachmentCountSingle): This is the format for the</span>
<a href="#l7.26"></a><span id="l7.26"> # attachment header when a message has only one attachment. This is separate</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/msgHdrViewOverlay.dtd</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/msgHdrViewOverlay.dtd</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -90,16 +90,21 @@</span>
<a href="#l8.4"></a><span id="l8.4"> &lt;!ENTITY saveAllAttachmentsCmd.accesskey    &quot;S&quot;&gt;</span>
<a href="#l8.5"></a><span id="l8.5"> &lt;!ENTITY detachAllAttachmentsCmd.label    &quot;Detach All&quot;&gt;</span>
<a href="#l8.6"></a><span id="l8.6"> &lt;!ENTITY detachAllAttachmentsCmd.accesskey    &quot;D&quot;&gt;</span>
<a href="#l8.7"></a><span id="l8.7"> &lt;!ENTITY deleteAllAttachmentsCmd.label    &quot;Delete All&quot;&gt;</span>
<a href="#l8.8"></a><span id="l8.8"> &lt;!ENTITY deleteAllAttachmentsCmd.accesskey    &quot;e&quot;&gt;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> &lt;!ENTITY openAttachment.tooltip &quot;Open the attached file&quot;&gt;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+&lt;!ENTITY detachedAttachmentFolder.show.label        &quot;Open Containing Folder&quot;&gt;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+&lt;!ENTITY detachedAttachmentFolder.show.accesskey    &quot;F&quot;&gt;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+&lt;!ENTITY detachedAttachmentFolder.showMac.label     &quot;Show In Finder&quot;&gt;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+&lt;!ENTITY detachedAttachmentFolder.showMac.accesskey &quot;F&quot;&gt;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+</span>
<a href="#l8.17"></a><span id="l8.17"> &lt;!-- Attachment toolbar items --&gt;</span>
<a href="#l8.18"></a><span id="l8.18"> &lt;!ENTITY saveAttachmentButton1.label       &quot;Save&quot;&gt;</span>
<a href="#l8.19"></a><span id="l8.19"> &lt;!ENTITY saveAttachmentButton1.tooltip     &quot;Save the attached file&quot;&gt;</span>
<a href="#l8.20"></a><span id="l8.20"> &lt;!ENTITY saveAllAttachmentsButton1.label   &quot;Save All&quot;&gt;</span>
<a href="#l8.21"></a><span id="l8.21"> &lt;!ENTITY saveAllAttachmentsButton1.tooltip &quot;Save all the attached files&quot;&gt;</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23"> &lt;!ENTITY copyLinkCmd.label        &quot;Copy Link Location&quot;&gt;</span>
<a href="#l8.24"></a><span id="l8.24"> &lt;!ENTITY copyLinkCmd.accesskey    &quot;C&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/themes/linux/mail/attachmentList.css</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/themes/linux/mail/attachmentList.css</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -15,16 +15,8 @@</span>
<a href="#l9.4"></a><span id="l9.4"> .attachmentcell-name,</span>
<a href="#l9.5"></a><span id="l9.5"> .attachmentcell-size {</span>
<a href="#l9.6"></a><span id="l9.6">   padding-top: 1px;</span>
<a href="#l9.7"></a><span id="l9.7"> }</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> .attachmentcell-size {</span>
<a href="#l9.10"></a><span id="l9.10">   color: GrayText;</span>
<a href="#l9.11"></a><span id="l9.11"> }</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-.attachmentItem[selected=&quot;true&quot;] .attachmentcell-icon {</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-  filter: url(&quot;chrome://messenger/skin/imageFilters.svg#selected&quot;);</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-}</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-.attachmentList:focus &gt; .attachmentItem[selected=&quot;true&quot;] .attachmentcell-icon {</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-  filter: url(&quot;chrome://messenger/skin/imageFilters.svg#selected-focus&quot;);</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

