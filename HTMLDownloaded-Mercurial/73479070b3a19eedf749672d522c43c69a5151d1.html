<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 6807:73479070b3a19eedf749672d522c43c69a5151d1</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 73479070b3a19eedf749672d522c43c69a5151d1" />
<meta property="og:url" content="/comm-central/rev/73479070b3a19eedf749672d522c43c69a5151d1" />
<meta property="og:description" content="Bug 614220 - Port Deferred Session restore - Bug 588482. r+=Neil" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 73479070b3a19eedf749672d522c43c69a5151d1 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/73479070b3a19eedf749672d522c43c69a5151d1">shortlog</a> |
<a href="/comm-central/log/73479070b3a19eedf749672d522c43c69a5151d1">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/73479070b3a19eedf749672d522c43c69a5151d1">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/73479070b3a19eedf749672d522c43c69a5151d1">files</a> |
changeset |
<a href="/comm-central/raw-rev/73479070b3a19eedf749672d522c43c69a5151d1">raw</a>  | <a href="/comm-central/archive/73479070b3a19eedf749672d522c43c69a5151d1.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=614220">Bug 614220</a> - Port Deferred Session restore - <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=588482">Bug 588482</a>. r+=Neil
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#105;&#115;&#97;&#107;&#32;&#75;&#104;&#97;&#99;&#104;&#97;&#116;&#114;&#121;&#97;&#110;&#32;&#60;&#109;&#105;&#115;&#97;&#107;&#46;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 09 Dec 2010 20:38:33 +0400</td></tr>

<tr>
 <td>changeset 6807</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/73479070b3a19eedf749672d522c43c69a5151d1">73479070b3a19eedf749672d522c43c69a5151d1</a></td>
</tr>



<tr>
<td>parent 6806</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f0c903a93fc665e5c62d68737bc6d34f64706ed9">f0c903a93fc665e5c62d68737bc6d34f64706ed9</a>
</td>
</tr>

<tr>
<td>child 6808</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/61c697891f6c6ca8ccb02a4b2f2e09b260843659">61c697891f6c6ca8ccb02a4b2f2e09b260843659</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=73479070b3a19eedf749672d522c43c69a5151d1">5220</a></td></tr>
<tr><td>push user</td><td>misak.bugzilla@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 09 Dec 2010 16:47:55 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@73479070b3a1 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=73479070b3a19eedf749672d522c43c69a5151d1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=73479070b3a19eedf749672d522c43c69a5151d1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=73479070b3a19eedf749672d522c43c69a5151d1&newProject=comm-central&newRevision=73479070b3a19eedf749672d522c43c69a5151d1&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=73479070b3a19eedf749672d522c43c69a5151d1&newProject=comm-central&newRevision=73479070b3a19eedf749672d522c43c69a5151d1&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=73479070b3a19eedf749672d522c43c69a5151d1&newProject=comm-central&newRevision=73479070b3a19eedf749672d522c43c69a5151d1&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=614220">614220</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=588482">588482</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=614220">Bug 614220</a> - Port Deferred Session restore - <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=588482">Bug 588482</a>. r+=Neil</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/73479070b3a19eedf749672d522c43c69a5151d1/suite/browser/browser-prefs.js">suite/browser/browser-prefs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/73479070b3a19eedf749672d522c43c69a5151d1/suite/browser/browser-prefs.js">file</a> |
<a href="/comm-central/annotate/73479070b3a19eedf749672d522c43c69a5151d1/suite/browser/browser-prefs.js">annotate</a> |
<a href="/comm-central/diff/73479070b3a19eedf749672d522c43c69a5151d1/suite/browser/browser-prefs.js">diff</a> |
<a href="/comm-central/comparison/73479070b3a19eedf749672d522c43c69a5151d1/suite/browser/browser-prefs.js">comparison</a> |
<a href="/comm-central/log/73479070b3a19eedf749672d522c43c69a5151d1/suite/browser/browser-prefs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/73479070b3a19eedf749672d522c43c69a5151d1/suite/browser/navigator.js">suite/browser/navigator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/73479070b3a19eedf749672d522c43c69a5151d1/suite/browser/navigator.js">file</a> |
<a href="/comm-central/annotate/73479070b3a19eedf749672d522c43c69a5151d1/suite/browser/navigator.js">annotate</a> |
<a href="/comm-central/diff/73479070b3a19eedf749672d522c43c69a5151d1/suite/browser/navigator.js">diff</a> |
<a href="/comm-central/comparison/73479070b3a19eedf749672d522c43c69a5151d1/suite/browser/navigator.js">comparison</a> |
<a href="/comm-central/log/73479070b3a19eedf749672d522c43c69a5151d1/suite/browser/navigator.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/73479070b3a19eedf749672d522c43c69a5151d1/suite/browser/navigatorOverlay.xul">suite/browser/navigatorOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/73479070b3a19eedf749672d522c43c69a5151d1/suite/browser/navigatorOverlay.xul">file</a> |
<a href="/comm-central/annotate/73479070b3a19eedf749672d522c43c69a5151d1/suite/browser/navigatorOverlay.xul">annotate</a> |
<a href="/comm-central/diff/73479070b3a19eedf749672d522c43c69a5151d1/suite/browser/navigatorOverlay.xul">diff</a> |
<a href="/comm-central/comparison/73479070b3a19eedf749672d522c43c69a5151d1/suite/browser/navigatorOverlay.xul">comparison</a> |
<a href="/comm-central/log/73479070b3a19eedf749672d522c43c69a5151d1/suite/browser/navigatorOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/public/nsISessionStartup.idl">suite/common/public/nsISessionStartup.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/public/nsISessionStartup.idl">file</a> |
<a href="/comm-central/annotate/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/public/nsISessionStartup.idl">annotate</a> |
<a href="/comm-central/diff/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/public/nsISessionStartup.idl">diff</a> |
<a href="/comm-central/comparison/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/public/nsISessionStartup.idl">comparison</a> |
<a href="/comm-central/log/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/public/nsISessionStartup.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/public/nsISessionStore.idl">suite/common/public/nsISessionStore.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/public/nsISessionStore.idl">file</a> |
<a href="/comm-central/annotate/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/public/nsISessionStore.idl">annotate</a> |
<a href="/comm-central/diff/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/public/nsISessionStore.idl">diff</a> |
<a href="/comm-central/comparison/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/public/nsISessionStore.idl">comparison</a> |
<a href="/comm-central/log/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/public/nsISessionStore.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/src/nsSessionStartup.js">suite/common/src/nsSessionStartup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/src/nsSessionStartup.js">file</a> |
<a href="/comm-central/annotate/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/src/nsSessionStartup.js">annotate</a> |
<a href="/comm-central/diff/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/src/nsSessionStartup.js">diff</a> |
<a href="/comm-central/comparison/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/src/nsSessionStartup.js">comparison</a> |
<a href="/comm-central/log/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/src/nsSessionStartup.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/src/nsSessionStore.js">suite/common/src/nsSessionStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/src/nsSessionStore.js">file</a> |
<a href="/comm-central/annotate/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/src/nsSessionStore.js">annotate</a> |
<a href="/comm-central/diff/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/src/nsSessionStore.js">diff</a> |
<a href="/comm-central/comparison/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/src/nsSessionStore.js">comparison</a> |
<a href="/comm-central/log/73479070b3a19eedf749672d522c43c69a5151d1/suite/common/src/nsSessionStore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/73479070b3a19eedf749672d522c43c69a5151d1/suite/locales/en-US/chrome/browser/navigator.dtd">suite/locales/en-US/chrome/browser/navigator.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/73479070b3a19eedf749672d522c43c69a5151d1/suite/locales/en-US/chrome/browser/navigator.dtd">file</a> |
<a href="/comm-central/annotate/73479070b3a19eedf749672d522c43c69a5151d1/suite/locales/en-US/chrome/browser/navigator.dtd">annotate</a> |
<a href="/comm-central/diff/73479070b3a19eedf749672d522c43c69a5151d1/suite/locales/en-US/chrome/browser/navigator.dtd">diff</a> |
<a href="/comm-central/comparison/73479070b3a19eedf749672d522c43c69a5151d1/suite/locales/en-US/chrome/browser/navigator.dtd">comparison</a> |
<a href="/comm-central/log/73479070b3a19eedf749672d522c43c69a5151d1/suite/locales/en-US/chrome/browser/navigator.dtd">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/browser/browser-prefs.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/browser/browser-prefs.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -393,16 +393,18 @@ pref(&quot;browser.sessionstore.resume_sessio</span>
<a href="#l1.4"></a><span id="l1.4"> // minimal interval between two save operations in milliseconds</span>
<a href="#l1.5"></a><span id="l1.5"> pref(&quot;browser.sessionstore.interval&quot;, 15000);</span>
<a href="#l1.6"></a><span id="l1.6"> // maximum amount of POSTDATA to be saved in bytes per history entry (-1 = all of it)</span>
<a href="#l1.7"></a><span id="l1.7"> // (NB: POSTDATA will be saved either entirely or not at all)</span>
<a href="#l1.8"></a><span id="l1.8"> pref(&quot;browser.sessionstore.postdata&quot;, 0);</span>
<a href="#l1.9"></a><span id="l1.9"> // on which sites to save text data, POSTDATA and cookies</span>
<a href="#l1.10"></a><span id="l1.10"> // 0 = everywhere, 1 = unencrypted sites, 2 = nowhere</span>
<a href="#l1.11"></a><span id="l1.11"> pref(&quot;browser.sessionstore.privacy_level&quot;, 0);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+// the same as browser.sessionstore.privacy_level, but for saving deferred session data</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+pref(&quot;browser.sessionstore.privacy_level_deferred&quot;, 2);</span>
<a href="#l1.14"></a><span id="l1.14"> // number of crashes that can occur before the about:sessionrestore page is displayed</span>
<a href="#l1.15"></a><span id="l1.15"> // (this pref has no effect if more than 6 hours have passed since the last crash)</span>
<a href="#l1.16"></a><span id="l1.16"> pref(&quot;browser.sessionstore.max_resumed_crashes&quot;, 1);</span>
<a href="#l1.17"></a><span id="l1.17"> // how many tabs can be reopened (per window)</span>
<a href="#l1.18"></a><span id="l1.18"> pref(&quot;browser.sessionstore.max_tabs_undo&quot;, 10);</span>
<a href="#l1.19"></a><span id="l1.19"> // how many windows can be reopened (per session) - on non-OS X platforms this</span>
<a href="#l1.20"></a><span id="l1.20"> // pref may be ignored when dealing with pop-up windows to ensure proper startup</span>
<a href="#l1.21"></a><span id="l1.21"> pref(&quot;browser.sessionstore.max_windows_undo&quot;, 3);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/suite/browser/navigator.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/suite/browser/navigator.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -729,16 +729,22 @@ function UpdateNavBar()</span>
<a href="#l2.4"></a><span id="l2.4"> }</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> function InitSessionStoreCallback()</span>
<a href="#l2.7"></a><span id="l2.7"> {</span>
<a href="#l2.8"></a><span id="l2.8">   try {</span>
<a href="#l2.9"></a><span id="l2.9">     var ss = Components.classes[&quot;@mozilla.org/suite/sessionstore;1&quot;]</span>
<a href="#l2.10"></a><span id="l2.10">                        .getService(Components.interfaces.nsISessionStore);</span>
<a href="#l2.11"></a><span id="l2.11">     ss.init(window);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    //Check if we have &quot;Deferred Session Restore&quot;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    let restoreItem = document.getElementById(&quot;historyRestoreLastSession&quot;);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    if (ss.canRestoreLastSession)</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+      restoreItem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l2.18"></a><span id="l2.18">   } catch(ex) {</span>
<a href="#l2.19"></a><span id="l2.19">     dump(&quot;nsSessionStore could not be initialized: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l2.20"></a><span id="l2.20">   }</span>
<a href="#l2.21"></a><span id="l2.21"> }</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23"> function WindowFocusTimerCallback(element)</span>
<a href="#l2.24"></a><span id="l2.24"> {</span>
<a href="#l2.25"></a><span id="l2.25">   // This function is a redo of the fix for jag bug 91884.</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineat">@@ -1430,16 +1436,22 @@ function updateRecentWindows(menupopup)</span>
<a href="#l2.27"></a><span id="l2.27"> function undoCloseWindow(aIndex)</span>
<a href="#l2.28"></a><span id="l2.28"> {</span>
<a href="#l2.29"></a><span id="l2.29">   var ss = Components.classes[&quot;@mozilla.org/suite/sessionstore;1&quot;]</span>
<a href="#l2.30"></a><span id="l2.30">                      .getService(Components.interfaces.nsISessionStore);</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32">   return ss.undoCloseWindow(aIndex);</span>
<a href="#l2.33"></a><span id="l2.33"> }</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+function restoreLastSession() {</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+  let ss = Components.classes[&quot;@mozilla.org/suite/sessionstore;1&quot;]</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+                     .getService(Components.interfaces.nsISessionStore);</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+  ss.restoreLastSession();</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+}</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+</span>
<a href="#l2.41"></a><span id="l2.41"> /*</span>
<a href="#l2.42"></a><span id="l2.42">  * Determines if a tab is &quot;empty&quot; using isBrowserEmpty from utilityOverlay.js</span>
<a href="#l2.43"></a><span id="l2.43">  */</span>
<a href="#l2.44"></a><span id="l2.44"> function isTabEmpty(aTab)</span>
<a href="#l2.45"></a><span id="l2.45"> {</span>
<a href="#l2.46"></a><span id="l2.46">   return isBrowserEmpty(aTab.linkedBrowser);</span>
<a href="#l2.47"></a><span id="l2.47"> }</span>
<a href="#l2.48"></a><span id="l2.48"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/suite/browser/navigatorOverlay.xul</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/suite/browser/navigatorOverlay.xul</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -412,16 +412,21 @@</span>
<a href="#l3.4"></a><span id="l3.4">         &lt;menuseparator/&gt;</span>
<a href="#l3.5"></a><span id="l3.5">         &lt;menuitem id=&quot;menu_showAllHistory&quot;</span>
<a href="#l3.6"></a><span id="l3.6">                   label=&quot;&amp;historyCmd.label;&quot;</span>
<a href="#l3.7"></a><span id="l3.7">                   accesskey=&quot;&amp;historyCmd.accesskey;&quot;</span>
<a href="#l3.8"></a><span id="l3.8">                   oncommand=&quot;toHistory()&quot;</span>
<a href="#l3.9"></a><span id="l3.9">                   key=&quot;key_gotoHistory&quot;/&gt;</span>
<a href="#l3.10"></a><span id="l3.10">         &lt;menuseparator id=&quot;startHistorySeparator&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l3.11"></a><span id="l3.11">         &lt;menuseparator id=&quot;endHistorySeparator&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+        &lt;menuitem id=&quot;historyRestoreLastSession&quot;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+                  label=&quot;&amp;historyRestoreLastSession.label;&quot;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+                  accesskey=&quot;&amp;historyRestoreLastSessionCmd.accesskey;&quot;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+                  oncommand=&quot;restoreLastSession();&quot;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+                  disabled=&quot;true&quot;/&gt;</span>
<a href="#l3.17"></a><span id="l3.17">       &lt;/menupopup&gt;</span>
<a href="#l3.18"></a><span id="l3.18">     &lt;/menu&gt;</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20">     &lt;menu id=&quot;bookmarksMenu&quot;</span>
<a href="#l3.21"></a><span id="l3.21">           label=&quot;&amp;bookmarksMenu.label;&quot;</span>
<a href="#l3.22"></a><span id="l3.22">           accesskey=&quot;&amp;bookmarksMenu.accesskey;&quot;</span>
<a href="#l3.23"></a><span id="l3.23">           ondragenter=&quot;PlacesMenuDNDHandler.onDragEnter(event);&quot;</span>
<a href="#l3.24"></a><span id="l3.24">           ondragover=&quot;PlacesMenuDNDHandler.onDragOver(event);&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/suite/common/public/nsISessionStartup.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/suite/common/public/nsISessionStartup.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -38,30 +38,35 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> /**</span>
<a href="#l4.7"></a><span id="l4.7">  * nsISessionStore keeps track of the current browsing state - i.e.</span>
<a href="#l4.8"></a><span id="l4.8">  * tab history, cookies, scroll state, form data, POSTDATA and window features</span>
<a href="#l4.9"></a><span id="l4.9">  * - and allows to restore everything into one window.</span>
<a href="#l4.10"></a><span id="l4.10">  */</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-[scriptable, uuid(34b4eded-1b07-4424-9012-33eea529d6ab)]</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+[scriptable, uuid(f9d1763e-e4a6-4446-8fe1-5bc2cd3201c8)]</span>
<a href="#l4.14"></a><span id="l4.14"> interface nsISessionStartup: nsISupports</span>
<a href="#l4.15"></a><span id="l4.15"> {</span>
<a href="#l4.16"></a><span id="l4.16">   // Get session state as string</span>
<a href="#l4.17"></a><span id="l4.17">   readonly attribute AString state;</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19">   /**</span>
<a href="#l4.20"></a><span id="l4.20">    * Determine if session should be restored</span>
<a href="#l4.21"></a><span id="l4.21">    */</span>
<a href="#l4.22"></a><span id="l4.22">   boolean doRestore();</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24">   /**</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-   * What type of session we're restoring. If we have a session, we're</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-   * either restoring state from a crash or restoring state that the user</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-   * requested we save on shutdown.</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+   * What type of session we're restoring.</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+   * NO_SESSION       There is no data available from the previous session</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+   * RECOVER_SESSION  The last session crashed. It will either be restored or</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+   *                  about:sessionrestore will be shown.</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+   * RESUME_SESSION   The previous session should be restored at startup</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+   * DEFER_SESSION    The previous session is fine, but it shouldn't be restored</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+   *                  without explicit action (with the exception of pinned tabs)</span>
<a href="#l4.35"></a><span id="l4.35">    */</span>
<a href="#l4.36"></a><span id="l4.36">   const unsigned long NO_SESSION = 0;</span>
<a href="#l4.37"></a><span id="l4.37">   const unsigned long RECOVER_SESSION = 1;</span>
<a href="#l4.38"></a><span id="l4.38">   const unsigned long RESUME_SESSION = 2;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  const unsigned long DEFER_SESSION = 3;</span>
<a href="#l4.40"></a><span id="l4.40"> </span>
<a href="#l4.41"></a><span id="l4.41">   readonly attribute unsigned long sessionType;</span>
<a href="#l4.42"></a><span id="l4.42"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/suite/common/public/nsISessionStore.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/suite/common/public/nsISessionStore.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -42,25 +42,43 @@ interface nsIDOMWindow;</span>
<a href="#l5.4"></a><span id="l5.4"> interface nsIDOMNode;</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> /**</span>
<a href="#l5.7"></a><span id="l5.7">  * nsISessionStore keeps track of the current browsing state - i.e.</span>
<a href="#l5.8"></a><span id="l5.8">  * tab history, cookies, scroll state, form data, POSTDATA and window features</span>
<a href="#l5.9"></a><span id="l5.9">  * - and allows to restore everything into one window.</span>
<a href="#l5.10"></a><span id="l5.10">  */</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-[scriptable, uuid(e63e4931-ff9f-4840-a203-b787223e057d)]</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+[scriptable, uuid(a2f14785-c4d4-4bac-b048-a849d2e74513)]</span>
<a href="#l5.14"></a><span id="l5.14"> interface nsISessionStore : nsISupports</span>
<a href="#l5.15"></a><span id="l5.15"> {</span>
<a href="#l5.16"></a><span id="l5.16">   /**</span>
<a href="#l5.17"></a><span id="l5.17">    * Initialize the service</span>
<a href="#l5.18"></a><span id="l5.18">    */</span>
<a href="#l5.19"></a><span id="l5.19">   void init(in nsIDOMWindow aWindow);</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21">   /**</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+   * Is it possible to restore the previous session. Will always be false when</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+   * in Private Browsing mode.</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+   */</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+  attribute boolean canRestoreLastSession;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+  /**</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+   * Restore the previous session if possible. This will not overwrite the</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+   * current session. Instead the previous session will be merged into the</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+   * current session. Current windows will be reused if they were windows that</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+   * pinned tabs were previously restored into. New windows will be opened as</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+   * needed.</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+   *</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+   * Note: This will throw if there is no previous state to restore. Check with</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+   * canRestoreLastSession first to avoid thrown errors.</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+   */</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+  void restoreLastSession();</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+  /**</span>
<a href="#l5.40"></a><span id="l5.40">    * Get the current browsing state.</span>
<a href="#l5.41"></a><span id="l5.41">    * @return a JSON string representing the session state.</span>
<a href="#l5.42"></a><span id="l5.42">    */</span>
<a href="#l5.43"></a><span id="l5.43">   AString getBrowserState();</span>
<a href="#l5.44"></a><span id="l5.44"> </span>
<a href="#l5.45"></a><span id="l5.45">   /**</span>
<a href="#l5.46"></a><span id="l5.46">    * Set the browsing state.</span>
<a href="#l5.47"></a><span id="l5.47">    * This will immediately restore the state of the whole application to the state</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/suite/common/src/nsSessionStartup.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/suite/common/src/nsSessionStartup.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -127,20 +127,22 @@ SessionStartup.prototype = {</span>
<a href="#l6.4"></a><span id="l6.4">       initialState &amp;&amp; initialState.session &amp;&amp; initialState.session.state &amp;&amp;</span>
<a href="#l6.5"></a><span id="l6.5">       initialState.session.state == STATE_RUNNING_STR;</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7">     // set the startup type</span>
<a href="#l6.8"></a><span id="l6.8">     if (lastSessionCrashed &amp;&amp; resumeFromCrash)</span>
<a href="#l6.9"></a><span id="l6.9">       this._sessionType = Components.interfaces.nsISessionStartup.RECOVER_SESSION;</span>
<a href="#l6.10"></a><span id="l6.10">     else if (!lastSessionCrashed &amp;&amp; doResumeSession)</span>
<a href="#l6.11"></a><span id="l6.11">       this._sessionType = Components.interfaces.nsISessionStartup.RESUME_SESSION;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+    else if (initialState)</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+      this._sessionType = Components.interfaces.nsISessionStartup.DEFER_SESSION;</span>
<a href="#l6.14"></a><span id="l6.14">     else</span>
<a href="#l6.15"></a><span id="l6.15">       this._iniString = null; // reset the state string</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-    if (this._sessionType != Components.interfaces.nsISessionStartup.NO_SESSION) {</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+    if (this.doRestore()) {</span>
<a href="#l6.19"></a><span id="l6.19">       // wait for the first browser window to open</span>
<a href="#l6.20"></a><span id="l6.20">       Services.obs.addObserver(this, &quot;browser:purge-session-history&quot;, true);</span>
<a href="#l6.21"></a><span id="l6.21">     }</span>
<a href="#l6.22"></a><span id="l6.22">   },</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24">   /**</span>
<a href="#l6.25"></a><span id="l6.25">    * Handle notifications</span>
<a href="#l6.26"></a><span id="l6.26">    */</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineat">@@ -179,17 +181,18 @@ SessionStartup.prototype = {</span>
<a href="#l6.28"></a><span id="l6.28">     return this._iniString;</span>
<a href="#l6.29"></a><span id="l6.29">   },</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31">   /**</span>
<a href="#l6.32"></a><span id="l6.32">    * Determine whether there is a pending session restore.</span>
<a href="#l6.33"></a><span id="l6.33">    * @returns bool</span>
<a href="#l6.34"></a><span id="l6.34">    */</span>
<a href="#l6.35"></a><span id="l6.35">   doRestore: function sss_doRestore() {</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-    return this._sessionType != Components.interfaces.nsISessionStartup.NO_SESSION;</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+    return this._sessionType == Components.interfaces.nsISessionStartup.RECOVER_SESSION ||</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+           this._sessionType == Components.interfaces.nsISessionStartup.RESUME_SESSION;</span>
<a href="#l6.39"></a><span id="l6.39">   },</span>
<a href="#l6.40"></a><span id="l6.40"> </span>
<a href="#l6.41"></a><span id="l6.41">   /**</span>
<a href="#l6.42"></a><span id="l6.42">    * Get the type of pending session store, if any.</span>
<a href="#l6.43"></a><span id="l6.43">    */</span>
<a href="#l6.44"></a><span id="l6.44">   get sessionType() {</span>
<a href="#l6.45"></a><span id="l6.45">     return this._sessionType;</span>
<a href="#l6.46"></a><span id="l6.46">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/suite/common/src/nsSessionStore.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/suite/common/src/nsSessionStore.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -185,16 +185,32 @@ SessionStoreService.prototype = {</span>
<a href="#l7.4"></a><span id="l7.4">   _statesToRestore: {},</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6">   // counts the number of crashes since the last clean start</span>
<a href="#l7.7"></a><span id="l7.7">   _recentCrashes: 0,</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9">   // whether the last window was closed and should be restored</span>
<a href="#l7.10"></a><span id="l7.10">   _restoreLastWindow: false,</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+  // The state from the previous session (after restoring pinned tabs)</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  _lastSessionState: null,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+/* ........ Public Getters .............. */</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+  get canRestoreLastSession() {</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+    // Always disallow restoring the previous session when in private browsing</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+    return this._lastSessionState;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+  },</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+  set canRestoreLastSession(val) {</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+    // Cheat a bit; only allow false.</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+    if (!val)</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+      this._lastSessionState = null;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+  },</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+</span>
<a href="#l7.28"></a><span id="l7.28"> /* ........ Global Event Handlers .............. */</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30">   /**</span>
<a href="#l7.31"></a><span id="l7.31">    * Initialize the component</span>
<a href="#l7.32"></a><span id="l7.32">    */</span>
<a href="#l7.33"></a><span id="l7.33">   init: function sss_init(aWindow) {</span>
<a href="#l7.34"></a><span id="l7.34">     if (!aWindow || this._loadState == STATE_RUNNING) {</span>
<a href="#l7.35"></a><span id="l7.35">       // make sure that all browser windows which try to initialize</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineat">@@ -229,54 +245,65 @@ SessionStoreService.prototype = {</span>
<a href="#l7.37"></a><span id="l7.37">     // get file references</span>
<a href="#l7.38"></a><span id="l7.38">     this._sessionFile = Services.dirsvc.get(&quot;ProfD&quot;, Components.interfaces.nsILocalFile);</span>
<a href="#l7.39"></a><span id="l7.39">     this._sessionFileBackup = this._sessionFile.clone();</span>
<a href="#l7.40"></a><span id="l7.40">     this._sessionFile.append(&quot;sessionstore.json&quot;);</span>
<a href="#l7.41"></a><span id="l7.41">     this._sessionFileBackup.append(&quot;sessionstore.bak&quot;);</span>
<a href="#l7.42"></a><span id="l7.42"> </span>
<a href="#l7.43"></a><span id="l7.43">     // get string containing session state</span>
<a href="#l7.44"></a><span id="l7.44">     var iniString;</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+    var ss = Components.classes[&quot;@mozilla.org/suite/sessionstartup;1&quot;]</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+                       .getService(Components.interfaces.nsISessionStartup);</span>
<a href="#l7.47"></a><span id="l7.47">     try {</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-      var ss = Components.classes[&quot;@mozilla.org/suite/sessionstartup;1&quot;]</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-                         .getService(Components.interfaces.nsISessionStartup);</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-      if (ss.doRestore())</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+      if (ss._sessionType != Components.interfaces.nsISessionStartup.NO_SESSION)</span>
<a href="#l7.52"></a><span id="l7.52">         iniString = ss.state;</span>
<a href="#l7.53"></a><span id="l7.53">     }</span>
<a href="#l7.54"></a><span id="l7.54">     catch(ex) { dump(ex + &quot;\n&quot;); } // no state to restore, which is ok</span>
<a href="#l7.55"></a><span id="l7.55"> </span>
<a href="#l7.56"></a><span id="l7.56">     if (iniString) {</span>
<a href="#l7.57"></a><span id="l7.57">       try {</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-        // parse the session state into JS objects</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-        this._initialState = JSON.parse(iniString);</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+        // If we're doing a DEFERRED session, then we want to pull pinned tabs</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+        // out so they can be restored.</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+        if (ss.sessionType == Components.interfaces.nsISessionStartup.DEFER_SESSION) {</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+          let [iniState, remainingState] = this._prepDataForDeferredRestore(iniString);</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+          // If we have a iniState with windows, that means that we have windows</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+          // with app tabs to restore.</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+          if (iniState.windows.length)</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+            this._initialState = iniState;</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+          if (remainingState.windows.length)</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+            this._lastSessionState = remainingState;</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+        }</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+        else {</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+          // parse the session state into JS objects</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+          this._initialState = JSON.parse(iniString);</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+          let lastSessionCrashed =</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+            this._initialState.session &amp;&amp; this._initialState.session.state &amp;&amp;</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+            this._initialState.session.state == STATE_RUNNING_STR;</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+          if (lastSessionCrashed) {</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+            this._recentCrashes = (this._initialState.session &amp;&amp;</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+                                   this._initialState.session.recentCrashes || 0) + 1;</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+            </span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+            if (this._needsRestorePage(this._initialState, this._recentCrashes)) {</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+              // replace the crashed session with a restore-page-only session</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+              let pageData = {</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+                url: &quot;about:sessionrestore&quot;,</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+                formdata: { &quot;#sessionData&quot;: iniString }</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+              };</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+              this._initialState = { windows: [{ tabs: [{ entries: [pageData] }] }] };</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+            }</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+          }</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+          // make sure that at least the first window doesn't have anything hidden</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+          delete this._initialState.windows[0].hidden;</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+          // Since nothing is hidden in the first window, it cannot be a popup</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+          delete this._initialState.windows[0].isPopup;</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+        }</span>
<a href="#l7.97"></a><span id="l7.97">       }</span>
<a href="#l7.98"></a><span id="l7.98">       catch (ex) { debug(&quot;The session file is invalid: &quot; + ex); }</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-      let lastSessionCrashed =</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-        this._initialState &amp;&amp; this._initialState.session &amp;&amp; this._initialState.session.state &amp;&amp;</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-        this._initialState.session.state == STATE_RUNNING_STR;</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-       // if last session crashed, backup the session</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-       if (lastSessionCrashed) {</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-        this._recentCrashes = (this._initialState.session &amp;&amp;</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-                               this._initialState.session.recentCrashes || 0) + 1;</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-        if (this._needsRestorePage(this._initialState, this._recentCrashes)) {</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-          // replace the crashed session with a restore-page-only session</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-          let pageData = {</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-            url: &quot;about:sessionrestore&quot;,</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-            formdata: { &quot;#sessionData&quot;: iniString }</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-          };</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-          this._initialState = { windows: [{ tabs: [{ entries: [pageData] }] }] };</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-        }</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-       }</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-      // make sure that at least the first window doesn't have anything hidden</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-      if (this._initialState.windows[0]) {</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-        delete this._initialState.windows[0].hidden;</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-        // Since nothing is hidden in the first window, it cannot be a popup</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-        delete this._initialState.windows[0].isPopup;</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-      }</span>
<a href="#l7.123"></a><span id="l7.123">     }</span>
<a href="#l7.124"></a><span id="l7.124"> </span>
<a href="#l7.125"></a><span id="l7.125">     // remove the session data files if crash recovery is disabled</span>
<a href="#l7.126"></a><span id="l7.126">     if (!this._resume_from_crash)</span>
<a href="#l7.127"></a><span id="l7.127">       this._clearDisk();</span>
<a href="#l7.128"></a><span id="l7.128">     else { // create a backup if the session data file exists</span>
<a href="#l7.129"></a><span id="l7.129">       try {</span>
<a href="#l7.130"></a><span id="l7.130">         if (this._sessionFileBackup.exists())</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineat">@@ -297,22 +324,19 @@ SessionStoreService.prototype = {</span>
<a href="#l7.132"></a><span id="l7.132">     this.onLoad(aWindow);</span>
<a href="#l7.133"></a><span id="l7.133">   },</span>
<a href="#l7.134"></a><span id="l7.134"> </span>
<a href="#l7.135"></a><span id="l7.135">   /**</span>
<a href="#l7.136"></a><span id="l7.136">    * Called on application shutdown, after notifications:</span>
<a href="#l7.137"></a><span id="l7.137">    * quit-application-granted, quit-application</span>
<a href="#l7.138"></a><span id="l7.138">    */</span>
<a href="#l7.139"></a><span id="l7.139">   _uninit: function sss_uninit() {</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-    if (this._doResumeSession()) { // save all data for session resuming</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-      this.saveState(true);</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-    }</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-    else { // discard all session related data</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-      this._clearDisk();</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-    }</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+    // save all data for session resuming</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+    this.saveState(true);</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+</span>
<a href="#l7.149"></a><span id="l7.149">     // Make sure to break our cycle with the save timer</span>
<a href="#l7.150"></a><span id="l7.150">     if (this._saveTimer) {</span>
<a href="#l7.151"></a><span id="l7.151">       this._saveTimer.cancel();</span>
<a href="#l7.152"></a><span id="l7.152">       this._saveTimer = null;</span>
<a href="#l7.153"></a><span id="l7.153">     }</span>
<a href="#l7.154"></a><span id="l7.154">   },</span>
<a href="#l7.155"></a><span id="l7.155"> </span>
<a href="#l7.156"></a><span id="l7.156">   /**</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineat">@@ -1021,16 +1045,88 @@ SessionStoreService.prototype = {</span>
<a href="#l7.158"></a><span id="l7.158">       if (!state &amp;&amp; !aWinState.isPopup) {</span>
<a href="#l7.159"></a><span id="l7.159">         state = aWinState;</span>
<a href="#l7.160"></a><span id="l7.160">       }</span>
<a href="#l7.161"></a><span id="l7.161">     });</span>
<a href="#l7.162"></a><span id="l7.162">     return (this._restoreLastWindow &amp;&amp; state &amp;&amp;</span>
<a href="#l7.163"></a><span id="l7.163">             this._doResumeSession());</span>
<a href="#l7.164"></a><span id="l7.164">   },</span>
<a href="#l7.165"></a><span id="l7.165"> </span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+  /**</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+   * Restores the session state stored in _lastSessionState. This will attempt</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+   * to merge data into the current session. If a window was opened at startup</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+   * with pinned tab(s), then the remaining data from the previous session for</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+   * that window will be opened into that winddow. Otherwise new windows will</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+   * be opened.</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+   */</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+  restoreLastSession: function sss_restoreLastSession() {</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+    // Use the public getter since it also checks PB mode</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+    if (!this.canRestoreLastSession)</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+      throw (Components.returnCode = Components.results.NS_ERROR_FAILURE);</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+    // First collect each window with its id...</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+    let windows = {};</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+    this._forEachBrowserWindow(function(aWindow) {</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+      if (aWindow.__SS_lastSessionWindowID)</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+        windows[aWindow.__SS_lastSessionWindowID] = aWindow;</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+    });</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+    let lastSessionState = this._lastSessionState;</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+    // This shouldn't ever be the case...</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+    if (!lastSessionState.windows.length)</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+      throw (Components.returnCode = Components.results.NS_ERROR_UNEXPECTED);</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+    // We're technically doing a restore, so set things up so we send the</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+    // notification when we're done. We want to send &quot;sessionstore-browser-state-restored&quot;.</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+    this._restoreCount = lastSessionState.windows.length;</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+    this._browserSetState = true;</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+    // Restore into windows or open new ones as needed.</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+    for (let i = 0; i &lt; lastSessionState.windows.length; i++) {</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+      let winState = lastSessionState.windows[i];</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+      let lastSessionWindowID = winState.__lastSessionWindowID;</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+      // delete lastSessionWindowID so we don't add that to the window again</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+      delete winState.__lastSessionWindowID;</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+      // Look to see if this window is already open...</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+      if (windows[lastSessionWindowID]) {</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+        // Since we're not overwriting existing tabs, we want to merge _closedTabs,</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+        // putting existing ones first. Then make sure we're respecting the max pref.</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+        if (winState._closedTabs &amp;&amp; winState._closedTabs.length) {</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+          let curWinState = this._windows[windows[lastSessionWindowID].__SSi];</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+          curWinState._closedTabs = curWinState._closedTabs.concat(winState._closedTabs);</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+          curWinState._closedTabs.splice(this._prefBranch.getIntPref(&quot;sessionstore.max_tabs_undo&quot;));</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+        }</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+        // Restore into that window - pretend it's a followup since we'll already</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+        // have a focused window.</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+        //XXXzpao This is going to merge extData together (taking what was in</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+        //        winState over what is in the window already), so this is going</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+        //        to have an effect on Tab Candy.</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+        //        Bug 588217 should make this go away by merging the group data.</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+        this.restoreWindow(windows[lastSessionWindowID], { windows: [winState] },</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+                           false, true);</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+      }</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+      else {</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+        this._openWindowWithState({ windows: [winState] });</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+      }</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+    }</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+    // Merge closed windows from this session with ones from last session</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+    if (lastSessionState._closedWindows) {</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+      this._closedWindows = this._closedWindows.concat(lastSessionState._closedWindows);</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+      this._capClosedWindows();</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+    }</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+    // Set recent crashes</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+    this._recentCrashes = lastSessionState.session &amp;&amp;</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+                          lastSessionState.session.recentCrashes || 0;</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+    this._lastSessionState = null;</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+  },</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+</span>
<a href="#l7.238"></a><span id="l7.238"> /* ........ Saving Functionality .............. */</span>
<a href="#l7.239"></a><span id="l7.239"> </span>
<a href="#l7.240"></a><span id="l7.240">   /**</span>
<a href="#l7.241"></a><span id="l7.241">    * Store all session data for a window</span>
<a href="#l7.242"></a><span id="l7.242">    * @param aWindow</span>
<a href="#l7.243"></a><span id="l7.243">    *        Window reference</span>
<a href="#l7.244"></a><span id="l7.244">    */</span>
<a href="#l7.245"></a><span id="l7.245">   _saveWindowHistory: function sss_saveWindowHistory(aWindow) {</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineat">@@ -1073,19 +1169,21 @@ SessionStoreService.prototype = {</span>
<a href="#l7.247"></a><span id="l7.247">     //           data even when we shouldn't (e.g. Back, different anchor)</span>
<a href="#l7.248"></a><span id="l7.248">     if (history &amp;&amp; browser.__SS_data &amp;&amp;</span>
<a href="#l7.249"></a><span id="l7.249">         browser.__SS_data.entries[history.index] &amp;&amp;</span>
<a href="#l7.250"></a><span id="l7.250">         history.index &lt; this._sessionhistory_max_entries - 1 &amp;&amp; !aFullData) {</span>
<a href="#l7.251"></a><span id="l7.251">       tabData = browser.__SS_data;</span>
<a href="#l7.252"></a><span id="l7.252">       tabData.index = history.index + 1;</span>
<a href="#l7.253"></a><span id="l7.253">     }</span>
<a href="#l7.254"></a><span id="l7.254">     else if (history &amp;&amp; history.count &gt; 0) {</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineminus">-      for (var j = 0; j &lt; history.count; j++)</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineminus">-        tabData.entries.push(this._serializeHistoryEntry(history.getEntryAtIndex(j, false),</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-                                                         aFullData));</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+      for (var j = 0; j &lt; history.count; j++) {</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+        let entry = this._serializeHistoryEntry(history.getEntryAtIndex(j, false),</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+                                                aFullData, false);</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineplus">+        tabData.entries.push(entry);</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineplus">+      }</span>
<a href="#l7.263"></a><span id="l7.263">       tabData.index = history.index + 1;</span>
<a href="#l7.264"></a><span id="l7.264"> </span>
<a href="#l7.265"></a><span id="l7.265">       // make sure not to cache privacy sensitive data which shouldn't get out</span>
<a href="#l7.266"></a><span id="l7.266">       if (!aFullData)</span>
<a href="#l7.267"></a><span id="l7.267">         browser.__SS_data = tabData;</span>
<a href="#l7.268"></a><span id="l7.268">     }</span>
<a href="#l7.269"></a><span id="l7.269">     else if (browser.currentURI.spec != &quot;about:blank&quot; ||</span>
<a href="#l7.270"></a><span id="l7.270">              browser.contentDocument.body.hasChildNodes()) {</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineat">@@ -1120,31 +1218,35 @@ SessionStoreService.prototype = {</span>
<a href="#l7.272"></a><span id="l7.272">     }</span>
<a href="#l7.273"></a><span id="l7.273"> </span>
<a href="#l7.274"></a><span id="l7.274">     if (aTab.__SS_extdata)</span>
<a href="#l7.275"></a><span id="l7.275">       tabData.extData = aTab.__SS_extdata;</span>
<a href="#l7.276"></a><span id="l7.276">     else if (tabData.extData)</span>
<a href="#l7.277"></a><span id="l7.277">       delete tabData.extData;</span>
<a href="#l7.278"></a><span id="l7.278"> </span>
<a href="#l7.279"></a><span id="l7.279">     if (history &amp;&amp; browser.docShell instanceof Components.interfaces.nsIDocShell)</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineminus">-      this._serializeSessionStorage(tabData, history, browser.docShell, aFullData);</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+      this._serializeSessionStorage(tabData, history, browser.docShell, aFullData,</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+                                    false);</span>
<a href="#l7.283"></a><span id="l7.283"> </span>
<a href="#l7.284"></a><span id="l7.284">     return tabData;</span>
<a href="#l7.285"></a><span id="l7.285">   },</span>
<a href="#l7.286"></a><span id="l7.286"> </span>
<a href="#l7.287"></a><span id="l7.287">   /**</span>
<a href="#l7.288"></a><span id="l7.288">    * Get an object that is a serialized representation of a History entry</span>
<a href="#l7.289"></a><span id="l7.289">    * Used for data storage</span>
<a href="#l7.290"></a><span id="l7.290">    * @param aEntry</span>
<a href="#l7.291"></a><span id="l7.291">    *        nsISHEntry instance</span>
<a href="#l7.292"></a><span id="l7.292">    * @param aFullData</span>
<a href="#l7.293"></a><span id="l7.293">    *        always return privacy sensitive data (use with care)</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineplus">+   * @param aIsPinned</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineplus">+   *        the tab is pinned and should be treated differently for privacy</span>
<a href="#l7.296"></a><span id="l7.296">    * @returns object</span>
<a href="#l7.297"></a><span id="l7.297">    */</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineminus">-  _serializeHistoryEntry: function sss_serializeHistoryEntry(aEntry, aFullData) {</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+  _serializeHistoryEntry:</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+    function sss_serializeHistoryEntry(aEntry, aFullData, aIsPinned) {</span>
<a href="#l7.301"></a><span id="l7.301">     var entry = { url: aEntry.URI.spec };</span>
<a href="#l7.302"></a><span id="l7.302"> </span>
<a href="#l7.303"></a><span id="l7.303">     if (aEntry.title &amp;&amp; aEntry.title != entry.url) {</span>
<a href="#l7.304"></a><span id="l7.304">       entry.title = aEntry.title;</span>
<a href="#l7.305"></a><span id="l7.305">     }</span>
<a href="#l7.306"></a><span id="l7.306">     if (aEntry.isSubFrame) {</span>
<a href="#l7.307"></a><span id="l7.307">       entry.subframe = true;</span>
<a href="#l7.308"></a><span id="l7.308">     }</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineat">@@ -1169,18 +1271,18 @@ SessionStoreService.prototype = {</span>
<a href="#l7.310"></a><span id="l7.310"> </span>
<a href="#l7.311"></a><span id="l7.311">     var x = {}, y = {};</span>
<a href="#l7.312"></a><span id="l7.312">     aEntry.getScrollPosition(x, y);</span>
<a href="#l7.313"></a><span id="l7.313">     if (x.value != 0 || y.value != 0)</span>
<a href="#l7.314"></a><span id="l7.314">       entry.scroll = x.value + &quot;,&quot; + y.value;</span>
<a href="#l7.315"></a><span id="l7.315"> </span>
<a href="#l7.316"></a><span id="l7.316">     try {</span>
<a href="#l7.317"></a><span id="l7.317">       var prefPostdata = this._prefBranch.getIntPref(&quot;sessionstore.postdata&quot;);</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineminus">-      if (aEntry.postData &amp;&amp; (aFullData ||</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineminus">-            prefPostdata &amp;&amp; this._checkPrivacyLevel(aEntry.URI.schemeIs(&quot;https&quot;)))) {</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+      if (aEntry.postData &amp;&amp; (aFullData || prefPostdata &amp;&amp;</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineplus">+            this._checkPrivacyLevel(aEntry.URI.schemeIs(&quot;https&quot;), aIsPinned))) {</span>
<a href="#l7.322"></a><span id="l7.322">         aEntry.postData.QueryInterface(Components.interfaces.nsISeekableStream)</span>
<a href="#l7.323"></a><span id="l7.323">                        .seek(Components.interfaces.nsISeekableStream.NS_SEEK_SET, 0);</span>
<a href="#l7.324"></a><span id="l7.324">         var stream = Components.classes[&quot;@mozilla.org/binaryinputstream;1&quot;]</span>
<a href="#l7.325"></a><span id="l7.325">                                .createInstance(Components.interfaces.nsIBinaryInputStream);</span>
<a href="#l7.326"></a><span id="l7.326">         stream.setInputStream(aEntry.postData);</span>
<a href="#l7.327"></a><span id="l7.327">         var postBytes = stream.readByteArray(stream.available());</span>
<a href="#l7.328"></a><span id="l7.328">         var postdata = String.fromCharCode.apply(null, postBytes);</span>
<a href="#l7.329"></a><span id="l7.329">         if (aFullData || prefPostdata == -1 ||</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineat">@@ -1233,17 +1335,18 @@ SessionStoreService.prototype = {</span>
<a href="#l7.331"></a><span id="l7.331">       return entry;</span>
<a href="#l7.332"></a><span id="l7.332">     }</span>
<a href="#l7.333"></a><span id="l7.333"> </span>
<a href="#l7.334"></a><span id="l7.334">     if (aEntry.childCount &gt; 0) {</span>
<a href="#l7.335"></a><span id="l7.335">       entry.children = [];</span>
<a href="#l7.336"></a><span id="l7.336">       for (var i = 0; i &lt; aEntry.childCount; i++) {</span>
<a href="#l7.337"></a><span id="l7.337">         var child = aEntry.GetChildAt(i);</span>
<a href="#l7.338"></a><span id="l7.338">         if (child) {</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineminus">-          entry.children.push(this._serializeHistoryEntry(child, aFullData));</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+          entry.children.push(this._serializeHistoryEntry(child, aFullData,</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+                                                          aIsPinned));</span>
<a href="#l7.342"></a><span id="l7.342">         }</span>
<a href="#l7.343"></a><span id="l7.343">         else { // to maintain the correct frame order, insert a dummy entry</span>
<a href="#l7.344"></a><span id="l7.344">           entry.children.push({ url: &quot;about:blank&quot; });</span>
<a href="#l7.345"></a><span id="l7.345">         }</span>
<a href="#l7.346"></a><span id="l7.346">         // don't try to restore framesets containing wyciwyg URLs (cf. bug 424689 and bug 450595)</span>
<a href="#l7.347"></a><span id="l7.347">         if (/^wyciwyg:\/\//.test(entry.children[i].url)) {</span>
<a href="#l7.348"></a><span id="l7.348">           delete entry.children;</span>
<a href="#l7.349"></a><span id="l7.349">           break;</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineat">@@ -1259,32 +1362,35 @@ SessionStoreService.prototype = {</span>
<a href="#l7.351"></a><span id="l7.351">    * @param aTabData</span>
<a href="#l7.352"></a><span id="l7.352">    *        The data object for a specific tab</span>
<a href="#l7.353"></a><span id="l7.353">    * @param aHistory</span>
<a href="#l7.354"></a><span id="l7.354">    *        That tab's session history</span>
<a href="#l7.355"></a><span id="l7.355">    * @param aDocShell</span>
<a href="#l7.356"></a><span id="l7.356">    *        That tab's docshell (containing the sessionStorage)</span>
<a href="#l7.357"></a><span id="l7.357">    * @param aFullData</span>
<a href="#l7.358"></a><span id="l7.358">    *        always return privacy sensitive data (use with care)</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineplus">+   * @param aIsPinned</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineplus">+   *        the tab is pinned and should be treated differently for privacy</span>
<a href="#l7.361"></a><span id="l7.361">    */</span>
<a href="#l7.362"></a><span id="l7.362">   _serializeSessionStorage:</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineminus">-    function sss_serializeSessionStorage(aTabData, aHistory, aDocShell, aFullData) {</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineplus">+    function sss_serializeSessionStorage(aTabData, aHistory, aDocShell, aFullData, aIsPinned) {</span>
<a href="#l7.365"></a><span id="l7.365">     let storageData = {};</span>
<a href="#l7.366"></a><span id="l7.366">     let hasContent = false;</span>
<a href="#l7.367"></a><span id="l7.367"> </span>
<a href="#l7.368"></a><span id="l7.368">     for (let i = 0; i &lt; aHistory.count; i++) {</span>
<a href="#l7.369"></a><span id="l7.369">       let uri = aHistory.getEntryAtIndex(i, false).URI;</span>
<a href="#l7.370"></a><span id="l7.370">       // sessionStorage is saved per origin (cf. nsDocShell::GetSessionStorageForURI)</span>
<a href="#l7.371"></a><span id="l7.371">       let domain = uri.spec;</span>
<a href="#l7.372"></a><span id="l7.372">       try {</span>
<a href="#l7.373"></a><span id="l7.373">         if (uri.host)</span>
<a href="#l7.374"></a><span id="l7.374">           domain = uri.prePath;</span>
<a href="#l7.375"></a><span id="l7.375">       }</span>
<a href="#l7.376"></a><span id="l7.376">       catch (ex) { /* this throws for host-less URIs (such as about: or jar:) */ }</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineminus">-      if (storageData[domain] || !(aFullData || this._checkPrivacyLevel(uri.schemeIs(&quot;https&quot;))))</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineplus">+      if (storageData[domain] ||</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineplus">+          !(aFullData || this._checkPrivacyLevel(uri.schemeIs(&quot;https&quot;), aIsPinned)))</span>
<a href="#l7.380"></a><span id="l7.380">         continue;</span>
<a href="#l7.381"></a><span id="l7.381"> </span>
<a href="#l7.382"></a><span id="l7.382">       let storage, storageItemCount = 0;</span>
<a href="#l7.383"></a><span id="l7.383">       try {</span>
<a href="#l7.384"></a><span id="l7.384">         var principal = SecMan.getCodebasePrincipal(uri);</span>
<a href="#l7.385"></a><span id="l7.385"> </span>
<a href="#l7.386"></a><span id="l7.386">         // Using getSessionStorageForPrincipal instead of getSessionStorageForURI</span>
<a href="#l7.387"></a><span id="l7.387">         // just to be able to pass aCreate = false, that avoids creation of the</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineat">@@ -1358,17 +1464,18 @@ SessionStoreService.prototype = {</span>
<a href="#l7.389"></a><span id="l7.389">                             this._getSelectedPageStyle(aBrowser.contentWindow);</span>
<a href="#l7.390"></a><span id="l7.390">     if (selectedPageStyle)</span>
<a href="#l7.391"></a><span id="l7.391">       aTabData.pageStyle = selectedPageStyle;</span>
<a href="#l7.392"></a><span id="l7.392">     else if (aTabData.pageStyle)</span>
<a href="#l7.393"></a><span id="l7.393">       delete aTabData.pageStyle;</span>
<a href="#l7.394"></a><span id="l7.394"> </span>
<a href="#l7.395"></a><span id="l7.395">     this._updateTextAndScrollDataForFrame(aWindow, aBrowser.contentWindow,</span>
<a href="#l7.396"></a><span id="l7.396">                                           aTabData.entries[tabIndex],</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineminus">-                                          !aTabData._formDataSaved, aFullData);</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineplus">+                                          !aTabData._formDataSaved, aFullData,</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineplus">+                                          !!aTabData.pinned);</span>
<a href="#l7.400"></a><span id="l7.400">     aTabData._formDataSaved = true;</span>
<a href="#l7.401"></a><span id="l7.401">     if (aBrowser.currentURI.spec == &quot;about:config&quot;)</span>
<a href="#l7.402"></a><span id="l7.402">       aTabData.entries[tabIndex].formdata = {</span>
<a href="#l7.403"></a><span id="l7.403">         &quot;#textbox&quot;: aBrowser.contentDocument.getElementById(&quot;textbox&quot;).value</span>
<a href="#l7.404"></a><span id="l7.404">       };</span>
<a href="#l7.405"></a><span id="l7.405">   },</span>
<a href="#l7.406"></a><span id="l7.406"> </span>
<a href="#l7.407"></a><span id="l7.407">   /**</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineat">@@ -1379,28 +1486,31 @@ SessionStoreService.prototype = {</span>
<a href="#l7.409"></a><span id="l7.409">    * @param aContent</span>
<a href="#l7.410"></a><span id="l7.410">    *        frame reference</span>
<a href="#l7.411"></a><span id="l7.411">    * @param aData</span>
<a href="#l7.412"></a><span id="l7.412">    *        part of a tabData object to add the information to</span>
<a href="#l7.413"></a><span id="l7.413">    * @param aUpdateFormData</span>
<a href="#l7.414"></a><span id="l7.414">    *        update all form data for this tab</span>
<a href="#l7.415"></a><span id="l7.415">    * @param aFullData</span>
<a href="#l7.416"></a><span id="l7.416">    *        always return privacy sensitive data (use with care)</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineplus">+   * @param aIsPinned</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineplus">+   *        the tab is pinned and should be treated differently for privacy</span>
<a href="#l7.419"></a><span id="l7.419">    */</span>
<a href="#l7.420"></a><span id="l7.420">   _updateTextAndScrollDataForFrame:</span>
<a href="#l7.421"></a><span id="l7.421">     function sss_updateTextAndScrollDataForFrame(aWindow, aContent, aData,</span>
<a href="#l7.422"></a><span id="l7.422" class="difflineminus">-                                                 aUpdateFormData, aFullData) {</span>
<a href="#l7.423"></a><span id="l7.423" class="difflineplus">+                                                 aUpdateFormData, aFullData, aIsPinned) {</span>
<a href="#l7.424"></a><span id="l7.424">     for (var i = 0; i &lt; aContent.frames.length; i++) {</span>
<a href="#l7.425"></a><span id="l7.425">       if (aData.children &amp;&amp; aData.children[i])</span>
<a href="#l7.426"></a><span id="l7.426">         this._updateTextAndScrollDataForFrame(aWindow, aContent.frames[i],</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineminus">-                                              aData.children[i], aUpdateFormData, aFullData);</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineplus">+                                              aData.children[i], aUpdateFormData,</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineplus">+                                              aFullData, aIsPinned);</span>
<a href="#l7.430"></a><span id="l7.430">     }</span>
<a href="#l7.431"></a><span id="l7.431">     var isHTTPS = this._getURIFromString((aContent.parent || aContent).</span>
<a href="#l7.432"></a><span id="l7.432">                                          document.location.href).schemeIs(&quot;https&quot;);</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineminus">-    if (aFullData || this._checkPrivacyLevel(isHTTPS) ||</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineplus">+    if (aFullData || this._checkPrivacyLevel(isHTTPS, aIsPinned) ||</span>
<a href="#l7.435"></a><span id="l7.435">         aContent.top.document.location.href == &quot;about:sessionrestore&quot;) {</span>
<a href="#l7.436"></a><span id="l7.436">       if (aFullData || aUpdateFormData) {</span>
<a href="#l7.437"></a><span id="l7.437">         let formData = this._collectFormDataForFrame(aContent.document);</span>
<a href="#l7.438"></a><span id="l7.438">         if (formData)</span>
<a href="#l7.439"></a><span id="l7.439">           aData.formdata = formData;</span>
<a href="#l7.440"></a><span id="l7.440">         else if (aData.formdata)</span>
<a href="#l7.441"></a><span id="l7.441">           delete aData.formdata;</span>
<a href="#l7.442"></a><span id="l7.442">       }</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineat">@@ -1522,41 +1632,64 @@ SessionStoreService.prototype = {</span>
<a href="#l7.444"></a><span id="l7.444">       }</span>
<a href="#l7.445"></a><span id="l7.445"> </span>
<a href="#l7.446"></a><span id="l7.446">     } while ((node = formNodes.iterateNext()));</span>
<a href="#l7.447"></a><span id="l7.447"> </span>
<a href="#l7.448"></a><span id="l7.448">     return data;</span>
<a href="#l7.449"></a><span id="l7.449">   },</span>
<a href="#l7.450"></a><span id="l7.450"> </span>
<a href="#l7.451"></a><span id="l7.451">   /**</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineplus">+   * extract the base domain from a history entry and its children</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineplus">+   * @param aEntry</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineplus">+   *        the history entry, serialized</span>
<a href="#l7.455"></a><span id="l7.455" class="difflineplus">+   * @param aHosts</span>
<a href="#l7.456"></a><span id="l7.456" class="difflineplus">+   *        the hash that will be used to store hosts eg, { hostname: true }</span>
<a href="#l7.457"></a><span id="l7.457" class="difflineplus">+   * @param aCheckPrivacy</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineplus">+   *        should we check the privacy level for https</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineplus">+   * @param aIsPinned</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineplus">+   *        is the entry we're evaluating for a pinned tab; used only if</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineplus">+   *        aCheckPrivacy</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineplus">+   */</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineplus">+  _extractHostsForCookies:</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineplus">+    function sss_extractHostsForCookies(aEntry, aHosts, aCheckPrivacy, aIsPinned) {</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineplus">+    let match;</span>
<a href="#l7.466"></a><span id="l7.466" class="difflineplus">+</span>
<a href="#l7.467"></a><span id="l7.467" class="difflineplus">+    if ((match = /^https?:\/\/(?:[^@\/\s]+@)?([\w.-]+)/.exec(aEntry.url)) != null) {</span>
<a href="#l7.468"></a><span id="l7.468" class="difflineplus">+      if (!aHosts[match[1]] &amp;&amp;</span>
<a href="#l7.469"></a><span id="l7.469" class="difflineplus">+          (!aCheckPrivacy ||</span>
<a href="#l7.470"></a><span id="l7.470" class="difflineplus">+           this._checkPrivacyLevel(this._getURIFromString(aEntry.url).schemeIs(&quot;https&quot;),</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineplus">+                                   aIsPinned))) {</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineplus">+        // By setting this to true or false, we can determine when looking at</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineplus">+        // the host in _updateCookies if we should check for privacy.</span>
<a href="#l7.474"></a><span id="l7.474" class="difflineplus">+        aHosts[match[1]] = aIsPinned;</span>
<a href="#l7.475"></a><span id="l7.475" class="difflineplus">+      }</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineplus">+    }</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineplus">+    else if ((match = /^file:\/\/([^\/]*)/.exec(aEntry.url)) != null) {</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineplus">+      aHosts[match[1]] = true;</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineplus">+    }</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineplus">+    if (aEntry.children) {</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineplus">+      aEntry.children.forEach(function(entry) {</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineplus">+        this._extractHostsForCookies(entry, aHosts, aCheckPrivacy, aIsPinned);</span>
<a href="#l7.483"></a><span id="l7.483" class="difflineplus">+      }, this);</span>
<a href="#l7.484"></a><span id="l7.484" class="difflineplus">+    }</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineplus">+  },</span>
<a href="#l7.486"></a><span id="l7.486" class="difflineplus">+</span>
<a href="#l7.487"></a><span id="l7.487" class="difflineplus">+  /**</span>
<a href="#l7.488"></a><span id="l7.488">    * store all hosts for a URL</span>
<a href="#l7.489"></a><span id="l7.489">    * @param aWindow</span>
<a href="#l7.490"></a><span id="l7.490">    *        Window reference</span>
<a href="#l7.491"></a><span id="l7.491">    */</span>
<a href="#l7.492"></a><span id="l7.492">   _updateCookieHosts: function sss_updateCookieHosts(aWindow) {</span>
<a href="#l7.493"></a><span id="l7.493">     var hosts = this._windows[aWindow.__SSi]._hosts = {};</span>
<a href="#l7.494"></a><span id="l7.494"> </span>
<a href="#l7.495"></a><span id="l7.495" class="difflineminus">-    // get the host for each URL</span>
<a href="#l7.496"></a><span id="l7.496" class="difflineminus">-    var _this = this;</span>
<a href="#l7.497"></a><span id="l7.497" class="difflineminus">-    function extractHosts(aEntry) {</span>
<a href="#l7.498"></a><span id="l7.498" class="difflineminus">-      var match = /^https?:\/\/(?:[^@\/\s]+@)?([\w.-]+)/.exec(aEntry.url);</span>
<a href="#l7.499"></a><span id="l7.499" class="difflineminus">-      if (match) {</span>
<a href="#l7.500"></a><span id="l7.500" class="difflineminus">-        if (!hosts[match[1]] &amp;&amp; _this._checkPrivacyLevel(_this._getURIFromString(aEntry.url).schemeIs(&quot;https&quot;))) {</span>
<a href="#l7.501"></a><span id="l7.501" class="difflineminus">-          hosts[match[1]] = true;</span>
<a href="#l7.502"></a><span id="l7.502" class="difflineminus">-        }</span>
<a href="#l7.503"></a><span id="l7.503" class="difflineminus">-      }</span>
<a href="#l7.504"></a><span id="l7.504" class="difflineminus">-      else if ((match = /^file:\/\/([^\/]*)/.exec(aEntry.url)) != null) {</span>
<a href="#l7.505"></a><span id="l7.505" class="difflineminus">-        hosts[match[1]] = true;</span>
<a href="#l7.506"></a><span id="l7.506" class="difflineminus">-      }</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineminus">-      if (aEntry.children) {</span>
<a href="#l7.508"></a><span id="l7.508" class="difflineminus">-        aEntry.children.forEach(extractHosts);</span>
<a href="#l7.509"></a><span id="l7.509" class="difflineminus">-      }</span>
<a href="#l7.510"></a><span id="l7.510" class="difflineminus">-    }</span>
<a href="#l7.511"></a><span id="l7.511" class="difflineminus">-</span>
<a href="#l7.512"></a><span id="l7.512" class="difflineminus">-    this._windows[aWindow.__SSi].tabs.forEach(function(aTabData) { aTabData.entries.forEach(extractHosts); });</span>
<a href="#l7.513"></a><span id="l7.513" class="difflineplus">+    this._windows[aWindow.__SSi].tabs.forEach(function(aTabData) {</span>
<a href="#l7.514"></a><span id="l7.514" class="difflineplus">+      aTabData.entries.forEach(function(entry) {</span>
<a href="#l7.515"></a><span id="l7.515" class="difflineplus">+        this._extractHostsForCookies(entry, hosts, true, !!aTabData.pinned);</span>
<a href="#l7.516"></a><span id="l7.516" class="difflineplus">+      }, this);</span>
<a href="#l7.517"></a><span id="l7.517" class="difflineplus">+    }, this);</span>
<a href="#l7.518"></a><span id="l7.518">   },</span>
<a href="#l7.519"></a><span id="l7.519"> </span>
<a href="#l7.520"></a><span id="l7.520">   /**</span>
<a href="#l7.521"></a><span id="l7.521">    * Serialize cookie data</span>
<a href="#l7.522"></a><span id="l7.522">    * @param aWindows</span>
<a href="#l7.523"></a><span id="l7.523">    *        array of Window references</span>
<a href="#l7.524"></a><span id="l7.524">    */</span>
<a href="#l7.525"></a><span id="l7.525">   _updateCookies: function sss_updateCookies(aWindows) {</span>
<a href="#l7.526"></a><span id="l7.526" class="difflineat">@@ -1564,21 +1697,26 @@ SessionStoreService.prototype = {</span>
<a href="#l7.527"></a><span id="l7.527">     for (var i = 0; i &lt; aWindows.length; i++)</span>
<a href="#l7.528"></a><span id="l7.528">       aWindows[i].cookies = [];</span>
<a href="#l7.529"></a><span id="l7.529"> </span>
<a href="#l7.530"></a><span id="l7.530">     var jscookies = {};</span>
<a href="#l7.531"></a><span id="l7.531">     var _this = this;</span>
<a href="#l7.532"></a><span id="l7.532">     // MAX_EXPIRY should be 2^63-1, but JavaScript can't handle that precision</span>
<a href="#l7.533"></a><span id="l7.533">     var MAX_EXPIRY = Math.pow(2, 62);</span>
<a href="#l7.534"></a><span id="l7.534">     aWindows.forEach(function(aWindow) {</span>
<a href="#l7.535"></a><span id="l7.535" class="difflineminus">-      for (var host in aWindow._hosts) {</span>
<a href="#l7.536"></a><span id="l7.536" class="difflineplus">+      if (!aWindow._hosts)</span>
<a href="#l7.537"></a><span id="l7.537" class="difflineplus">+        return;</span>
<a href="#l7.538"></a><span id="l7.538" class="difflineplus">+      for (var [host, isPinned] in Iterator(aWindow._hosts)) {</span>
<a href="#l7.539"></a><span id="l7.539">         var list = cm.getCookiesFromHost(host);</span>
<a href="#l7.540"></a><span id="l7.540">         while (list.hasMoreElements()) {</span>
<a href="#l7.541"></a><span id="l7.541">           var cookie = list.getNext().QueryInterface(Components.interfaces.nsICookie2);</span>
<a href="#l7.542"></a><span id="l7.542" class="difflineminus">-          if (cookie.isSession &amp;&amp; _this._checkPrivacyLevel(cookie.isSecure)) {</span>
<a href="#l7.543"></a><span id="l7.543" class="difflineplus">+          // aWindow._hosts will only have hosts with the right privacy rules,</span>
<a href="#l7.544"></a><span id="l7.544" class="difflineplus">+          // so there is no need to do anything special with this call to</span>
<a href="#l7.545"></a><span id="l7.545" class="difflineplus">+          // _checkPrivacyLevel.</span>
<a href="#l7.546"></a><span id="l7.546" class="difflineplus">+          if (cookie.isSession &amp;&amp; _this._checkPrivacyLevel(cookie.isSecure, isPinned)) {</span>
<a href="#l7.547"></a><span id="l7.547">             // use the cookie's host, path, and name as keys into a hash,</span>
<a href="#l7.548"></a><span id="l7.548">             // to make sure we serialize each cookie only once</span>
<a href="#l7.549"></a><span id="l7.549"> </span>
<a href="#l7.550"></a><span id="l7.550">             // lazily build up a 3-dimensional hash, with</span>
<a href="#l7.551"></a><span id="l7.551">             // host, path, and name as keys</span>
<a href="#l7.552"></a><span id="l7.552">             if (!jscookies[cookie.host])</span>
<a href="#l7.553"></a><span id="l7.553">               jscookies[cookie.host] = {};</span>
<a href="#l7.554"></a><span id="l7.554">             if (!jscookies[cookie.host][cookie.path])</span>
<a href="#l7.555"></a><span id="l7.555" class="difflineat">@@ -1732,16 +1870,22 @@ SessionStoreService.prototype = {</span>
<a href="#l7.556"></a><span id="l7.556">       return;</span>
<a href="#l7.557"></a><span id="l7.557"> </span>
<a href="#l7.558"></a><span id="l7.558">     // update the internal state data for this window</span>
<a href="#l7.559"></a><span id="l7.559">     this._saveWindowHistory(aWindow);</span>
<a href="#l7.560"></a><span id="l7.560">     this._updateTextAndScrollData(aWindow);</span>
<a href="#l7.561"></a><span id="l7.561">     this._updateCookieHosts(aWindow);</span>
<a href="#l7.562"></a><span id="l7.562">     this._updateWindowFeatures(aWindow);</span>
<a href="#l7.563"></a><span id="l7.563"> </span>
<a href="#l7.564"></a><span id="l7.564" class="difflineplus">+    // Make sure we keep __SS_lastSessionWindowID around for cases like entering</span>
<a href="#l7.565"></a><span id="l7.565" class="difflineplus">+    // or leaving PB mode.</span>
<a href="#l7.566"></a><span id="l7.566" class="difflineplus">+    if (aWindow.__SS_lastSessionWindowID)</span>
<a href="#l7.567"></a><span id="l7.567" class="difflineplus">+      this._windows[aWindow.__SSi].__lastSessionWindowID =</span>
<a href="#l7.568"></a><span id="l7.568" class="difflineplus">+        aWindow.__SS_lastSessionWindowID;</span>
<a href="#l7.569"></a><span id="l7.569" class="difflineplus">+</span>
<a href="#l7.570"></a><span id="l7.570">     this._dirtyWindows[aWindow.__SSi] = false;</span>
<a href="#l7.571"></a><span id="l7.571">   },</span>
<a href="#l7.572"></a><span id="l7.572"> </span>
<a href="#l7.573"></a><span id="l7.573"> /* ........ Restoring Functionality .............. */</span>
<a href="#l7.574"></a><span id="l7.574"> </span>
<a href="#l7.575"></a><span id="l7.575">   /**</span>
<a href="#l7.576"></a><span id="l7.576">    * restore features to a single window</span>
<a href="#l7.577"></a><span id="l7.577">    * @param aWindow</span>
<a href="#l7.578"></a><span id="l7.578" class="difflineat">@@ -1811,16 +1955,23 @@ SessionStoreService.prototype = {</span>
<a href="#l7.579"></a><span id="l7.579">     for (var t = 0; t &lt; newTabCount; t++) {</span>
<a href="#l7.580"></a><span id="l7.580">       tabs.push(t &lt; openTabCount ? tabbrowser.tabs[t] : tabbrowser.addTab());</span>
<a href="#l7.581"></a><span id="l7.581">       // when resuming at startup: add additionally requested pages to the end</span>
<a href="#l7.582"></a><span id="l7.582">       if (!aOverwriteTabs &amp;&amp; root._firstTabs) {</span>
<a href="#l7.583"></a><span id="l7.583">         tabbrowser.moveTabTo(tabs[t], t);</span>
<a href="#l7.584"></a><span id="l7.584">       }</span>
<a href="#l7.585"></a><span id="l7.585">     }</span>
<a href="#l7.586"></a><span id="l7.586"> </span>
<a href="#l7.587"></a><span id="l7.587" class="difflineplus">+    // We want to correlate the window with data from the last session, so</span>
<a href="#l7.588"></a><span id="l7.588" class="difflineplus">+    // assign another id if we have one. Otherwise clear so we don't do</span>
<a href="#l7.589"></a><span id="l7.589" class="difflineplus">+    // anything with it.</span>
<a href="#l7.590"></a><span id="l7.590" class="difflineplus">+    delete aWindow.__SS_lastSessionWindowID;</span>
<a href="#l7.591"></a><span id="l7.591" class="difflineplus">+    if (winData.__lastSessionWindowID)</span>
<a href="#l7.592"></a><span id="l7.592" class="difflineplus">+      aWindow.__SS_lastSessionWindowID = winData.__lastSessionWindowID;</span>
<a href="#l7.593"></a><span id="l7.593" class="difflineplus">+</span>
<a href="#l7.594"></a><span id="l7.594">     // when overwriting tabs, remove all superflous ones</span>
<a href="#l7.595"></a><span id="l7.595">     for (t = openTabCount - 1; t &gt;= newTabCount; t--) {</span>
<a href="#l7.596"></a><span id="l7.596">       tabbrowser.removeTab(tabbrowser.tabs[t]);</span>
<a href="#l7.597"></a><span id="l7.597">     }</span>
<a href="#l7.598"></a><span id="l7.598"> </span>
<a href="#l7.599"></a><span id="l7.599">     if (aOverwriteTabs) {</span>
<a href="#l7.600"></a><span id="l7.600">       this.restoreWindowFeatures(aWindow, winData);</span>
<a href="#l7.601"></a><span id="l7.601">       delete this._windows[aWindow.__SSi].extData;</span>
<a href="#l7.602"></a><span id="l7.602" class="difflineat">@@ -2399,16 +2550,20 @@ SessionStoreService.prototype = {</span>
<a href="#l7.603"></a><span id="l7.603">    * @param aUpdateAll</span>
<a href="#l7.604"></a><span id="l7.604">    *        Bool update all windows</span>
<a href="#l7.605"></a><span id="l7.605">    */</span>
<a href="#l7.606"></a><span id="l7.606">   saveState: function sss_saveState(aUpdateAll) {</span>
<a href="#l7.607"></a><span id="l7.607">     // if crash recovery is disabled, only save session resuming information</span>
<a href="#l7.608"></a><span id="l7.608">     if (!this._resume_from_crash &amp;&amp; this._loadState == STATE_RUNNING)</span>
<a href="#l7.609"></a><span id="l7.609">       return;</span>
<a href="#l7.610"></a><span id="l7.610"> </span>
<a href="#l7.611"></a><span id="l7.611" class="difflineplus">+    // If crash recovery is disabled, we only want to resume with pinned tabs</span>
<a href="#l7.612"></a><span id="l7.612" class="difflineplus">+    // if we crash.</span>
<a href="#l7.613"></a><span id="l7.613" class="difflineplus">+    let pinnedOnly = this._loadState == STATE_RUNNING &amp;&amp; !this._resume_from_crash;</span>
<a href="#l7.614"></a><span id="l7.614" class="difflineplus">+</span>
<a href="#l7.615"></a><span id="l7.615">     var oState = this._getCurrentState(aUpdateAll);</span>
<a href="#l7.616"></a><span id="l7.616">     oState.session = {</span>
<a href="#l7.617"></a><span id="l7.617">       state: this._loadState == STATE_RUNNING ? STATE_RUNNING_STR : STATE_STOPPED_STR,</span>
<a href="#l7.618"></a><span id="l7.618">       lastUpdate: Date.now()</span>
<a href="#l7.619"></a><span id="l7.619">     };</span>
<a href="#l7.620"></a><span id="l7.620">     if (this._recentCrashes)</span>
<a href="#l7.621"></a><span id="l7.621">       oState.session.recentCrashes = this._recentCrashes;</span>
<a href="#l7.622"></a><span id="l7.622"> </span>
<a href="#l7.623"></a><span id="l7.623" class="difflineat">@@ -2578,20 +2733,28 @@ SessionStoreService.prototype = {</span>
<a href="#l7.624"></a><span id="l7.624">       aWindow.arguments[0] == &quot;about:blank&quot;;</span>
<a href="#l7.625"></a><span id="l7.625">   },</span>
<a href="#l7.626"></a><span id="l7.626"> </span>
<a href="#l7.627"></a><span id="l7.627">   /**</span>
<a href="#l7.628"></a><span id="l7.628">    * don't save sensitive data if the user doesn't want to</span>
<a href="#l7.629"></a><span id="l7.629">    * (distinguishes between encrypted and non-encrypted sites)</span>
<a href="#l7.630"></a><span id="l7.630">    * @param aIsHTTPS</span>
<a href="#l7.631"></a><span id="l7.631">    *        Bool is encrypted</span>
<a href="#l7.632"></a><span id="l7.632" class="difflineplus">+   * @param aUseDefaultPref</span>
<a href="#l7.633"></a><span id="l7.633" class="difflineplus">+   *        don't do normal check for deferred</span>
<a href="#l7.634"></a><span id="l7.634">    * @returns bool</span>
<a href="#l7.635"></a><span id="l7.635">    */</span>
<a href="#l7.636"></a><span id="l7.636" class="difflineminus">-  _checkPrivacyLevel: function sss_checkPrivacyLevel(aIsHTTPS) {</span>
<a href="#l7.637"></a><span id="l7.637" class="difflineminus">-    return this._prefBranch.getIntPref(&quot;sessionstore.privacy_level&quot;) &lt; (aIsHTTPS ? PRIVACY_ENCRYPTED : PRIVACY_FULL);</span>
<a href="#l7.638"></a><span id="l7.638" class="difflineplus">+  _checkPrivacyLevel: function sss_checkPrivacyLevel(aIsHTTPS, aUseDefaultPref) {</span>
<a href="#l7.639"></a><span id="l7.639" class="difflineplus">+    let pref = &quot;sessionstore.privacy_level&quot;;</span>
<a href="#l7.640"></a><span id="l7.640" class="difflineplus">+    // If we're in the process of quitting and we're not autoresuming the session</span>
<a href="#l7.641"></a><span id="l7.641" class="difflineplus">+    // then we should treat it as a deferred session. We have a different privacy</span>
<a href="#l7.642"></a><span id="l7.642" class="difflineplus">+    // pref for that case.</span>
<a href="#l7.643"></a><span id="l7.643" class="difflineplus">+    if (!aUseDefaultPref &amp;&amp; this._loadState == STATE_QUITTING &amp;&amp; !this._doResumeSession())</span>
<a href="#l7.644"></a><span id="l7.644" class="difflineplus">+      pref = &quot;sessionstore.privacy_level_deferred&quot;;</span>
<a href="#l7.645"></a><span id="l7.645" class="difflineplus">+    return this._prefBranch.getIntPref(pref) &lt; (aIsHTTPS ? PRIVACY_ENCRYPTED : PRIVACY_FULL);</span>
<a href="#l7.646"></a><span id="l7.646">   },</span>
<a href="#l7.647"></a><span id="l7.647"> </span>
<a href="#l7.648"></a><span id="l7.648">   /**</span>
<a href="#l7.649"></a><span id="l7.649">    * on popup windows, the XULWindow's attributes seem not to be set correctly</span>
<a href="#l7.650"></a><span id="l7.650">    * we use thus JSDOMWindow attributes for sizemode and normal window attributes</span>
<a href="#l7.651"></a><span id="l7.651">    * (and hope for reasonable values when maximized/minimized - since then</span>
<a href="#l7.652"></a><span id="l7.652">    * outerWidth/outerHeight aren't the dimensions of the restored window)</span>
<a href="#l7.653"></a><span id="l7.653">    * @param aWindow</span>
<a href="#l7.654"></a><span id="l7.654" class="difflineat">@@ -2681,25 +2844,159 @@ SessionStoreService.prototype = {</span>
<a href="#l7.655"></a><span id="l7.655">                      (Date.now() - aState.session.lastUpdate);</span>
<a href="#l7.656"></a><span id="l7.656"> </span>
<a href="#l7.657"></a><span id="l7.657">     return max_resumed_crashes != -1 &amp;&amp;</span>
<a href="#l7.658"></a><span id="l7.658">            (aRecentCrashes &gt; max_resumed_crashes ||</span>
<a href="#l7.659"></a><span id="l7.659">             sessionAge &amp;&amp; sessionAge &gt;= SIX_HOURS_IN_MS);</span>
<a href="#l7.660"></a><span id="l7.660">   },</span>
<a href="#l7.661"></a><span id="l7.661"> </span>
<a href="#l7.662"></a><span id="l7.662">   /**</span>
<a href="#l7.663"></a><span id="l7.663" class="difflineplus">+   * This is going to take a state as provided at startup (via</span>
<a href="#l7.664"></a><span id="l7.664" class="difflineplus">+   * nsISessionStartup.state) and split it into 2 parts. The first part</span>
<a href="#l7.665"></a><span id="l7.665" class="difflineplus">+   * (defaultState) will be a state that should still be restored at startup,</span>
<a href="#l7.666"></a><span id="l7.666" class="difflineplus">+   * while the second part (state) is a state that should be saved for later.</span>
<a href="#l7.667"></a><span id="l7.667" class="difflineplus">+   * defaultState will be comprised of windows with only pinned tabs, extracted</span>
<a href="#l7.668"></a><span id="l7.668" class="difflineplus">+   * from state. It will contain the cookies that go along with the history</span>
<a href="#l7.669"></a><span id="l7.669" class="difflineplus">+   * entries in those tabs. It will also contain window position information.</span>
<a href="#l7.670"></a><span id="l7.670" class="difflineplus">+   *</span>
<a href="#l7.671"></a><span id="l7.671" class="difflineplus">+   * defaultState will be restored at startup. state will be placed into</span>
<a href="#l7.672"></a><span id="l7.672" class="difflineplus">+   * this._lastSessionState and will be kept in case the user explicitly wants</span>
<a href="#l7.673"></a><span id="l7.673" class="difflineplus">+   * to restore the previous session (publicly exposed as restoreLastSession).</span>
<a href="#l7.674"></a><span id="l7.674" class="difflineplus">+   *</span>
<a href="#l7.675"></a><span id="l7.675" class="difflineplus">+   * @param stateString</span>
<a href="#l7.676"></a><span id="l7.676" class="difflineplus">+   *        The state string, presumably from nsISessionStartup.state</span>
<a href="#l7.677"></a><span id="l7.677" class="difflineplus">+   * @returns [defaultState, state]</span>
<a href="#l7.678"></a><span id="l7.678" class="difflineplus">+   */</span>
<a href="#l7.679"></a><span id="l7.679" class="difflineplus">+  _prepDataForDeferredRestore: function sss_prepDataForDeferredRestore(stateString) {</span>
<a href="#l7.680"></a><span id="l7.680" class="difflineplus">+    let state = JSON.parse(stateString);</span>
<a href="#l7.681"></a><span id="l7.681" class="difflineplus">+    let defaultState = { windows: [], selectedWindow: 1 };</span>
<a href="#l7.682"></a><span id="l7.682" class="difflineplus">+</span>
<a href="#l7.683"></a><span id="l7.683" class="difflineplus">+    state.selectedWindow = state.selectedWindow || 1;</span>
<a href="#l7.684"></a><span id="l7.684" class="difflineplus">+</span>
<a href="#l7.685"></a><span id="l7.685" class="difflineplus">+    // Look at each window, remove pinned tabs, adjust selectedindex,</span>
<a href="#l7.686"></a><span id="l7.686" class="difflineplus">+    // remove window if necessary.</span>
<a href="#l7.687"></a><span id="l7.687" class="difflineplus">+    for (let wIndex = 0; wIndex &lt; state.windows.length;) {</span>
<a href="#l7.688"></a><span id="l7.688" class="difflineplus">+      let window = state.windows[wIndex];</span>
<a href="#l7.689"></a><span id="l7.689" class="difflineplus">+      window.selected = window.selected || 1;</span>
<a href="#l7.690"></a><span id="l7.690" class="difflineplus">+      // We're going to put the state of the window into this object</span>
<a href="#l7.691"></a><span id="l7.691" class="difflineplus">+      let pinnedWindowState = { tabs: [], cookies: []};</span>
<a href="#l7.692"></a><span id="l7.692" class="difflineplus">+      for (let tIndex = 0; tIndex &lt; window.tabs.length;) {</span>
<a href="#l7.693"></a><span id="l7.693" class="difflineplus">+        if (window.tabs[tIndex].pinned) {</span>
<a href="#l7.694"></a><span id="l7.694" class="difflineplus">+          // Adjust window.selected</span>
<a href="#l7.695"></a><span id="l7.695" class="difflineplus">+          if (tIndex + 1 &lt; window.selected)</span>
<a href="#l7.696"></a><span id="l7.696" class="difflineplus">+            window.selected -= 1;</span>
<a href="#l7.697"></a><span id="l7.697" class="difflineplus">+          else if (tIndex + 1 == window.selected)</span>
<a href="#l7.698"></a><span id="l7.698" class="difflineplus">+            pinnedWindowState.selected = pinnedWindowState.tabs.length + 2;</span>
<a href="#l7.699"></a><span id="l7.699" class="difflineplus">+            // + 2 because the tab isn't actually in the array yet</span>
<a href="#l7.700"></a><span id="l7.700" class="difflineplus">+</span>
<a href="#l7.701"></a><span id="l7.701" class="difflineplus">+          // Now add the pinned tab to our window</span>
<a href="#l7.702"></a><span id="l7.702" class="difflineplus">+          pinnedWindowState.tabs =</span>
<a href="#l7.703"></a><span id="l7.703" class="difflineplus">+            pinnedWindowState.tabs.concat(window.tabs.splice(tIndex, 1));</span>
<a href="#l7.704"></a><span id="l7.704" class="difflineplus">+          // We don't want to increment tIndex here.</span>
<a href="#l7.705"></a><span id="l7.705" class="difflineplus">+          continue;</span>
<a href="#l7.706"></a><span id="l7.706" class="difflineplus">+        }</span>
<a href="#l7.707"></a><span id="l7.707" class="difflineplus">+        tIndex++;</span>
<a href="#l7.708"></a><span id="l7.708" class="difflineplus">+      }</span>
<a href="#l7.709"></a><span id="l7.709" class="difflineplus">+</span>
<a href="#l7.710"></a><span id="l7.710" class="difflineplus">+      // At this point the window in the state object has been modified (or not)</span>
<a href="#l7.711"></a><span id="l7.711" class="difflineplus">+      // We want to build the rest of this new window object if we have pinnedTabs.</span>
<a href="#l7.712"></a><span id="l7.712" class="difflineplus">+      if (pinnedWindowState.tabs.length) {</span>
<a href="#l7.713"></a><span id="l7.713" class="difflineplus">+        // First get the other attributes off the window</span>
<a href="#l7.714"></a><span id="l7.714" class="difflineplus">+        WINDOW_ATTRIBUTES.forEach(function(attr) {</span>
<a href="#l7.715"></a><span id="l7.715" class="difflineplus">+          if (attr in window) {</span>
<a href="#l7.716"></a><span id="l7.716" class="difflineplus">+            pinnedWindowState[attr] = window[attr];</span>
<a href="#l7.717"></a><span id="l7.717" class="difflineplus">+            delete window[attr];</span>
<a href="#l7.718"></a><span id="l7.718" class="difflineplus">+          }</span>
<a href="#l7.719"></a><span id="l7.719" class="difflineplus">+        });</span>
<a href="#l7.720"></a><span id="l7.720" class="difflineplus">+        // We're just copying position data into the pinned window.</span>
<a href="#l7.721"></a><span id="l7.721" class="difflineplus">+        // Not copying over:</span>
<a href="#l7.722"></a><span id="l7.722" class="difflineplus">+        // - _closedTabs</span>
<a href="#l7.723"></a><span id="l7.723" class="difflineplus">+        // - extData</span>
<a href="#l7.724"></a><span id="l7.724" class="difflineplus">+        // - isPopup</span>
<a href="#l7.725"></a><span id="l7.725" class="difflineplus">+        // - hidden</span>
<a href="#l7.726"></a><span id="l7.726" class="difflineplus">+</span>
<a href="#l7.727"></a><span id="l7.727" class="difflineplus">+        // Assign a unique ID to correlate the window to be opened with the</span>
<a href="#l7.728"></a><span id="l7.728" class="difflineplus">+        // remaining data</span>
<a href="#l7.729"></a><span id="l7.729" class="difflineplus">+        window.__lastSessionWindowID = pinnedWindowState.__lastSessionWindowID</span>
<a href="#l7.730"></a><span id="l7.730" class="difflineplus">+                                     = &quot;&quot; + Date.now() + Math.random();</span>
<a href="#l7.731"></a><span id="l7.731" class="difflineplus">+</span>
<a href="#l7.732"></a><span id="l7.732" class="difflineplus">+        // Extract the cookies that belong with each pinned tab</span>
<a href="#l7.733"></a><span id="l7.733" class="difflineplus">+        this._splitCookiesFromWindow(window, pinnedWindowState);</span>
<a href="#l7.734"></a><span id="l7.734" class="difflineplus">+</span>
<a href="#l7.735"></a><span id="l7.735" class="difflineplus">+        // Actually add this window to our defaultState</span>
<a href="#l7.736"></a><span id="l7.736" class="difflineplus">+        defaultState.windows.push(pinnedWindowState);</span>
<a href="#l7.737"></a><span id="l7.737" class="difflineplus">+        // Remove the window from the state if it doesn't have any tabs</span>
<a href="#l7.738"></a><span id="l7.738" class="difflineplus">+        if (!window.tabs.length) {</span>
<a href="#l7.739"></a><span id="l7.739" class="difflineplus">+         if (wIndex + 1 &lt;= state.selectedWindow)</span>
<a href="#l7.740"></a><span id="l7.740" class="difflineplus">+            state.selectedWindow -= 1;</span>
<a href="#l7.741"></a><span id="l7.741" class="difflineplus">+          else if (wIndex + 1 == state.selectedWindow)</span>
<a href="#l7.742"></a><span id="l7.742" class="difflineplus">+            defaultState.selectedIndex = defaultState.windows.length + 1;</span>
<a href="#l7.743"></a><span id="l7.743" class="difflineplus">+</span>
<a href="#l7.744"></a><span id="l7.744" class="difflineplus">+          state.windows.splice(wIndex, 1);</span>
<a href="#l7.745"></a><span id="l7.745" class="difflineplus">+          // We don't want to increment wIndex here.</span>
<a href="#l7.746"></a><span id="l7.746" class="difflineplus">+          continue;</span>
<a href="#l7.747"></a><span id="l7.747" class="difflineplus">+        }</span>
<a href="#l7.748"></a><span id="l7.748" class="difflineplus">+</span>
<a href="#l7.749"></a><span id="l7.749" class="difflineplus">+</span>
<a href="#l7.750"></a><span id="l7.750" class="difflineplus">+      }</span>
<a href="#l7.751"></a><span id="l7.751" class="difflineplus">+      wIndex++;</span>
<a href="#l7.752"></a><span id="l7.752" class="difflineplus">+    }</span>
<a href="#l7.753"></a><span id="l7.753" class="difflineplus">+</span>
<a href="#l7.754"></a><span id="l7.754" class="difflineplus">+    return [defaultState, state];</span>
<a href="#l7.755"></a><span id="l7.755" class="difflineplus">+  },</span>
<a href="#l7.756"></a><span id="l7.756" class="difflineplus">+</span>
<a href="#l7.757"></a><span id="l7.757" class="difflineplus">+  /**</span>
<a href="#l7.758"></a><span id="l7.758" class="difflineplus">+   * Splits out the cookies from aWinState into aTargetWinState based on the</span>
<a href="#l7.759"></a><span id="l7.759" class="difflineplus">+   * tabs that are in aTargetWinState.</span>
<a href="#l7.760"></a><span id="l7.760" class="difflineplus">+   * This alters the state of aWinState and aTargetWinState.</span>
<a href="#l7.761"></a><span id="l7.761" class="difflineplus">+   */</span>
<a href="#l7.762"></a><span id="l7.762" class="difflineplus">+  _splitCookiesFromWindow:</span>
<a href="#l7.763"></a><span id="l7.763" class="difflineplus">+    function sss_splitCookiesFromWindow(aWinState, aTargetWinState) {</span>
<a href="#l7.764"></a><span id="l7.764" class="difflineplus">+    if (!aWinState.cookies || !aWinState.cookies.length)</span>
<a href="#l7.765"></a><span id="l7.765" class="difflineplus">+      return;</span>
<a href="#l7.766"></a><span id="l7.766" class="difflineplus">+</span>
<a href="#l7.767"></a><span id="l7.767" class="difflineplus">+    // Get the hosts for history entries in aTargetWinState</span>
<a href="#l7.768"></a><span id="l7.768" class="difflineplus">+    let cookieHosts = {};</span>
<a href="#l7.769"></a><span id="l7.769" class="difflineplus">+    aTargetWinState.tabs.forEach(function(tab) {</span>
<a href="#l7.770"></a><span id="l7.770" class="difflineplus">+      tab.entries.forEach(function(entry) {</span>
<a href="#l7.771"></a><span id="l7.771" class="difflineplus">+        this._extractHostsForCookies(entry, cookieHosts, false)</span>
<a href="#l7.772"></a><span id="l7.772" class="difflineplus">+      }, this);</span>
<a href="#l7.773"></a><span id="l7.773" class="difflineplus">+    }, this);</span>
<a href="#l7.774"></a><span id="l7.774" class="difflineplus">+</span>
<a href="#l7.775"></a><span id="l7.775" class="difflineplus">+    // By creating a regex we reduce overhead and there is only one loop pass</span>
<a href="#l7.776"></a><span id="l7.776" class="difflineplus">+    // through either array (cookieHosts and aWinState.cookies).</span>
<a href="#l7.777"></a><span id="l7.777" class="difflineplus">+    let hosts = Object.keys(cookieHosts).join(&quot;|&quot;).replace(&quot;\\.&quot;, &quot;\\.&quot;, &quot;g&quot;);</span>
<a href="#l7.778"></a><span id="l7.778" class="difflineplus">+    let cookieRegex = new RegExp(&quot;.*(&quot; + hosts + &quot;)&quot;);</span>
<a href="#l7.779"></a><span id="l7.779" class="difflineplus">+    for (let cIndex = 0; cIndex &lt; aWinState.cookies.length;) {</span>
<a href="#l7.780"></a><span id="l7.780" class="difflineplus">+      if (cookieRegex.test(aWinState.cookies[cIndex].host)) {</span>
<a href="#l7.781"></a><span id="l7.781" class="difflineplus">+        aTargetWinState.cookies =</span>
<a href="#l7.782"></a><span id="l7.782" class="difflineplus">+          aTargetWinState.cookies.concat(aWinState.cookies.splice(cIndex, 1));</span>
<a href="#l7.783"></a><span id="l7.783" class="difflineplus">+        continue;</span>
<a href="#l7.784"></a><span id="l7.784" class="difflineplus">+      }</span>
<a href="#l7.785"></a><span id="l7.785" class="difflineplus">+      cIndex++;</span>
<a href="#l7.786"></a><span id="l7.786" class="difflineplus">+    }</span>
<a href="#l7.787"></a><span id="l7.787" class="difflineplus">+  },</span>
<a href="#l7.788"></a><span id="l7.788" class="difflineplus">+</span>
<a href="#l7.789"></a><span id="l7.789" class="difflineplus">+  /**</span>
<a href="#l7.790"></a><span id="l7.790">    * Converts a JavaScript object into a JSON string</span>
<a href="#l7.791"></a><span id="l7.791">    * (see http://www.json.org/ for more information).</span>
<a href="#l7.792"></a><span id="l7.792">    *</span>
<a href="#l7.793"></a><span id="l7.793">    * The inverse operation consists of JSON.parse(JSON_string).</span>
<a href="#l7.794"></a><span id="l7.794">    *</span>
<a href="#l7.795"></a><span id="l7.795">    * @param aJSObject is the object to be converted</span>
<a href="#l7.796"></a><span id="l7.796">    * @returns the object's JSON representation</span>
<a href="#l7.797"></a><span id="l7.797">    */</span>
<a href="#l7.798"></a><span id="l7.798">   _toJSONString: function sss_toJSONString(aJSObject) {</span>
<a href="#l7.799"></a><span id="l7.799" class="difflineplus">+    // We never want to save __lastSessionWindowID across sessions, but we do</span>
<a href="#l7.800"></a><span id="l7.800" class="difflineplus">+    // want it exported to consumers when running (eg. Private Browsing).</span>
<a href="#l7.801"></a><span id="l7.801" class="difflineplus">+    let internalKeys = INTERNAL_KEYS;</span>
<a href="#l7.802"></a><span id="l7.802" class="difflineplus">+    if (this._loadState == STATE_QUITTING) {</span>
<a href="#l7.803"></a><span id="l7.803" class="difflineplus">+      internalKeys = internalKeys.slice();</span>
<a href="#l7.804"></a><span id="l7.804" class="difflineplus">+      internalKeys.push(&quot;__lastSessionWindowID&quot;);</span>
<a href="#l7.805"></a><span id="l7.805" class="difflineplus">+    }</span>
<a href="#l7.806"></a><span id="l7.806">     function exclude(key, value) {</span>
<a href="#l7.807"></a><span id="l7.807">       // returning undefined results in the exclusion of that key</span>
<a href="#l7.808"></a><span id="l7.808">       return (INTERNAL_KEYS.indexOf(key) != -1) ? undefined : value;</span>
<a href="#l7.809"></a><span id="l7.809">     }</span>
<a href="#l7.810"></a><span id="l7.810">     return JSON.stringify(aJSObject, exclude);</span>
<a href="#l7.811"></a><span id="l7.811">   },</span>
<a href="#l7.812"></a><span id="l7.812"> </span>
<a href="#l7.813"></a><span id="l7.813">   _sendRestoreCompletedNotifications: function sss_sendRestoreCompletedNotifications() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/suite/locales/en-US/chrome/browser/navigator.dtd</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/browser/navigator.dtd</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -103,16 +103,18 @@</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> &lt;!ENTITY clearPrivateDataCmd.label &quot;Clear Private Data&quot;&gt;</span>
<a href="#l8.6"></a><span id="l8.6"> &lt;!ENTITY clearPrivateDataCmd.accesskey &quot;e&quot;&gt;</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> &lt;!ENTITY goMenu.label &quot;Go&quot;&gt;</span>
<a href="#l8.9"></a><span id="l8.9"> &lt;!ENTITY goMenu.accesskey &quot;g&quot;&gt;</span>
<a href="#l8.10"></a><span id="l8.10"> &lt;!ENTITY goHomeCmd.label &quot;Home&quot;&gt;</span>
<a href="#l8.11"></a><span id="l8.11"> &lt;!ENTITY goHomeCmd.accesskey &quot;h&quot;&gt;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+&lt;!ENTITY historyRestoreLastSession.label &quot;Restore Previous Session&quot;&gt;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+&lt;!ENTITY historyRestoreLastSessionCmd.accesskey &quot;R&quot;&gt;</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15"> &lt;!ENTITY bookmarksMenu.label &quot;Bookmarks&quot;&gt;</span>
<a href="#l8.16"></a><span id="l8.16"> &lt;!ENTITY bookmarksMenu.accesskey &quot;B&quot;&gt;</span>
<a href="#l8.17"></a><span id="l8.17"> &lt;!ENTITY addCurPageCmd.label &quot;Bookmark This Page&quot;&gt;</span>
<a href="#l8.18"></a><span id="l8.18"> &lt;!ENTITY addCurPageCmd.accesskey &quot;B&quot;&gt;</span>
<a href="#l8.19"></a><span id="l8.19"> &lt;!ENTITY addCurPageAsCmd.label &quot;File Bookmark&quot;&gt;</span>
<a href="#l8.20"></a><span id="l8.20"> &lt;!ENTITY addCurPageAsCmd.accesskey &quot;F&quot;&gt;</span>
<a href="#l8.21"></a><span id="l8.21"> &lt;!ENTITY addCurPageAsCmd.commandkey &quot;d&quot;&gt;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

