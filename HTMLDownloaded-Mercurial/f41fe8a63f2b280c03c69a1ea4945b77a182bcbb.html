<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24091:f41fe8a63f2b280c03c69a1ea4945b77a182bcbb</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f41fe8a63f2b280c03c69a1ea4945b77a182bcbb" />
<meta property="og:url" content="/comm-central/rev/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb" />
<meta property="og:description" content="Bug 1466705 - Backed out changeset ec2cc16327fe which was pushed accidentally. a=backout DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f41fe8a63f2b280c03c69a1ea4945b77a182bcbb 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb">shortlog</a> |
<a href="/comm-central/log/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb">files</a> |
changeset |
<a href="/comm-central/raw-rev/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb">raw</a>  | <a href="/comm-central/archive/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1466705">Bug 1466705</a> - Backed out changeset ec2cc16327fe which was pushed accidentally. a=backout DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 15 Jun 2018 19:50:15 +0200</td></tr>

<tr>
 <td>changeset 24091</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb">f41fe8a63f2b280c03c69a1ea4945b77a182bcbb</a></td>
</tr>



<tr>
<td>parent 24090</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d4e700bab1b134447fdb27f9676e43e3f15931a8">d4e700bab1b134447fdb27f9676e43e3f15931a8</a>
</td>
</tr>

<tr>
<td>child 24092</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5ebc1943af38cbb9e33bb9fa19de2441be7bff9f">5ebc1943af38cbb9e33bb9fa19de2441be7bff9f</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f41fe8a63f2b280c03c69a1ea4945b77a182bcbb">14525</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 15 Jun 2018 17:50:47 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f41fe8a63f2b [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f41fe8a63f2b280c03c69a1ea4945b77a182bcbb">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f41fe8a63f2b280c03c69a1ea4945b77a182bcbb&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f41fe8a63f2b280c03c69a1ea4945b77a182bcbb&newProject=comm-central&newRevision=f41fe8a63f2b280c03c69a1ea4945b77a182bcbb&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f41fe8a63f2b280c03c69a1ea4945b77a182bcbb&newProject=comm-central&newRevision=f41fe8a63f2b280c03c69a1ea4945b77a182bcbb&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f41fe8a63f2b280c03c69a1ea4945b77a182bcbb&newProject=comm-central&newRevision=f41fe8a63f2b280c03c69a1ea4945b77a182bcbb&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28backout%29&revcount=50">backout</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1466705">1466705</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1466705">Bug 1466705</a> - Backed out changeset ec2cc16327fe which was pushed accidentally. a=backout DONTBUILD</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/content/subscribe.js">mailnews/base/content/subscribe.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/content/subscribe.js">file</a> |
<a href="/comm-central/annotate/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/content/subscribe.js">annotate</a> |
<a href="/comm-central/diff/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/content/subscribe.js">diff</a> |
<a href="/comm-central/comparison/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/content/subscribe.js">comparison</a> |
<a href="/comm-central/log/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/content/subscribe.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/public/nsISubscribableServer.idl">mailnews/base/public/nsISubscribableServer.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/public/nsISubscribableServer.idl">file</a> |
<a href="/comm-central/annotate/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/public/nsISubscribableServer.idl">annotate</a> |
<a href="/comm-central/diff/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/public/nsISubscribableServer.idl">diff</a> |
<a href="/comm-central/comparison/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/public/nsISubscribableServer.idl">comparison</a> |
<a href="/comm-central/log/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/public/nsISubscribableServer.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/src/nsSubscribableServer.cpp">mailnews/base/src/nsSubscribableServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/src/nsSubscribableServer.cpp">file</a> |
<a href="/comm-central/annotate/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/src/nsSubscribableServer.cpp">annotate</a> |
<a href="/comm-central/diff/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/src/nsSubscribableServer.cpp">diff</a> |
<a href="/comm-central/comparison/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/src/nsSubscribableServer.cpp">comparison</a> |
<a href="/comm-central/log/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/src/nsSubscribableServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/src/nsSubscribableServer.h">mailnews/base/src/nsSubscribableServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/src/nsSubscribableServer.h">file</a> |
<a href="/comm-central/annotate/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/src/nsSubscribableServer.h">annotate</a> |
<a href="/comm-central/diff/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/src/nsSubscribableServer.h">diff</a> |
<a href="/comm-central/comparison/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/src/nsSubscribableServer.h">comparison</a> |
<a href="/comm-central/log/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/base/src/nsSubscribableServer.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/imap/src/nsImapIncomingServer.cpp">mailnews/imap/src/nsImapIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/imap/src/nsImapIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/imap/src/nsImapIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/imap/src/nsImapIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/imap/src/nsImapIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/imap/src/nsImapIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/news/src/nsNntpIncomingServer.cpp">mailnews/news/src/nsNntpIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/news/src/nsNntpIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/news/src/nsNntpIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/news/src/nsNntpIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/news/src/nsNntpIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/f41fe8a63f2b280c03c69a1ea4945b77a182bcbb/mailnews/news/src/nsNntpIncomingServer.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/content/subscribe.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/content/subscribe.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -13,20 +13,22 @@ var gChangeTable = {};</span>
<a href="#l1.4"></a><span id="l1.4"> var gServerURI = null;</span>
<a href="#l1.5"></a><span id="l1.5"> var gSubscribableServer = null;</span>
<a href="#l1.6"></a><span id="l1.6"> var gNameField = null;</span>
<a href="#l1.7"></a><span id="l1.7"> var gNameFieldLabel = null;</span>
<a href="#l1.8"></a><span id="l1.8"> var gStatusFeedback;</span>
<a href="#l1.9"></a><span id="l1.9"> var gSubscribeDeck = null;</span>
<a href="#l1.10"></a><span id="l1.10"> var gSearchView = null;</span>
<a href="#l1.11"></a><span id="l1.11"> var gSearchTreeBoxObject = null;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+var gItemsFound = new Map();</span>
<a href="#l1.13"></a><span id="l1.13"> var gSubscribeBundle;</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15"> function Stop()</span>
<a href="#l1.16"></a><span id="l1.16"> {</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+  //dump(&quot;Stop()\n&quot;)</span>
<a href="#l1.18"></a><span id="l1.18">   if (gSubscribableServer) {</span>
<a href="#l1.19"></a><span id="l1.19">     gSubscribableServer.stopPopulating(msgWindow);</span>
<a href="#l1.20"></a><span id="l1.20">   }</span>
<a href="#l1.21"></a><span id="l1.21"> }</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23"> function SetServerTypeSpecificTextValues()</span>
<a href="#l1.24"></a><span id="l1.24"> {</span>
<a href="#l1.25"></a><span id="l1.25">   if (!gServerURI)</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineat">@@ -52,62 +54,115 @@ function onServerClick(aFolder)</span>
<a href="#l1.27"></a><span id="l1.27">   let serverMenu = document.getElementById(&quot;serverMenu&quot;);</span>
<a href="#l1.28"></a><span id="l1.28">   serverMenu.menupopup.selectFolder(aFolder);</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30">   SetServerTypeSpecificTextValues();</span>
<a href="#l1.31"></a><span id="l1.31">   ShowCurrentList();</span>
<a href="#l1.32"></a><span id="l1.32"> }</span>
<a href="#l1.33"></a><span id="l1.33"> </span>
<a href="#l1.34"></a><span id="l1.34"> var MySubscribeListener = {</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+  OnItemDiscovered: function(aPath, aSubscribable) {</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+    if (!gItemsFound.has(aPath))</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+      gItemsFound.set(aPath, gSubscribableServer.getLeafName(aPath));</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+  },</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+</span>
<a href="#l1.40"></a><span id="l1.40">   OnDonePopulating: function() {</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+    createSubscribeTree();</span>
<a href="#l1.42"></a><span id="l1.42">     gStatusFeedback._stopMeteors();</span>
<a href="#l1.43"></a><span id="l1.43">     document.getElementById(&quot;stopButton&quot;).disabled = true;</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+// XXX what does this do? Is this needed without RDF/template?</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+    // Only re-root the tree, if it is null.</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+    // Otherwise, we are in here because we are populating a part of the tree.</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+/*    let refValue = gSubscribeTree.getAttribute('ref');</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+    if (!refValue) {</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+      //dump(&quot;root subscribe tree at: &quot;+ gServerURI +&quot;\n&quot;);</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+      gSubscribeTree.database.AddDataSource(subscribeDS);</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+      gSubscribeTree.setAttribute('ref',gServerURI);</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+    }</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+*/</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+</span>
<a href="#l1.56"></a><span id="l1.56">     document.getElementById(&quot;refreshButton&quot;).disabled = false;</span>
<a href="#l1.57"></a><span id="l1.57">     document.getElementById(&quot;currentListTab&quot;).disabled = false;</span>
<a href="#l1.58"></a><span id="l1.58">     document.getElementById(&quot;newGroupsTab&quot;).disabled = false;</span>
<a href="#l1.59"></a><span id="l1.59">   }</span>
<a href="#l1.60"></a><span id="l1.60"> };</span>
<a href="#l1.61"></a><span id="l1.61"> </span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+function setSubscribableCellState(aSubscribeCell, aSubscribed, aSubscribable) {</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+  aSubscribeCell.setAttribute(&quot;properties&quot;, &quot;subscribed-&quot; + aSubscribed +</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+                                            &quot; subscribable-&quot; + aSubscribable);</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+  aSubscribeCell.setAttribute(&quot;value&quot;, aSubscribed);</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+}</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+/**</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+ * Populate the subscribe tree with the items found on the server.</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+ */</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+function createSubscribeTree() {</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+  let items = toArray(gItemsFound.entries());</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+  items.sort((a,b) =&gt; a[0].localeCompare(b[0]));</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+  for (let [path, name] of items) {</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+    let subscribed = gSubscribableServer.isSubscribed(path);</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+    let subscribable = gSubscribableServer.isSubscribable(path);</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+    let itemEl = document.createElement(&quot;treeitem&quot;);</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+    let rowEl = document.createElement(&quot;treerow&quot;);</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+    let nameEl = document.createElement(&quot;treecell&quot;);</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+    let subscribeEl = document.createElement(&quot;treecell&quot;);</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+    nameEl.setAttribute(&quot;label&quot;, name);</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+    nameEl.setAttribute(&quot;value&quot;, path);</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+    nameEl.setAttribute(&quot;properties&quot;, &quot;serverType-&quot; + gSubscribableServer.type +</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+                                      &quot; subscribable-&quot; + subscribable);</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+    setSubscribableCellState(subscribeEl, subscribed, subscribable);</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+    rowEl.appendChild(nameEl);</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+    rowEl.appendChild(subscribeEl);</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+    itemEl.appendChild(rowEl);</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+    gSubscribeBody.appendChild(itemEl);</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+ }</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+}</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+</span>
<a href="#l1.94"></a><span id="l1.94"> function SetUpTree(forceToServer, getOnlyNew)</span>
<a href="#l1.95"></a><span id="l1.95"> {</span>
<a href="#l1.96"></a><span id="l1.96">   if (!gServerURI)</span>
<a href="#l1.97"></a><span id="l1.97">     return;</span>
<a href="#l1.98"></a><span id="l1.98"> </span>
<a href="#l1.99"></a><span id="l1.99">   var server = MailUtils.getFolderForURI(gServerURI, true).server;</span>
<a href="#l1.100"></a><span id="l1.100">   try</span>
<a href="#l1.101"></a><span id="l1.101">   {</span>
<a href="#l1.102"></a><span id="l1.102">     CleanUpSearchView();</span>
<a href="#l1.103"></a><span id="l1.103">     gSubscribableServer = server.QueryInterface(Ci.nsISubscribableServer);</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+    gSubscribeTree.setAttribute('ref', ''); // XXX: what is this?</span>
<a href="#l1.105"></a><span id="l1.105"> </span>
<a href="#l1.106"></a><span id="l1.106">     // enable (or disable) the search related UI</span>
<a href="#l1.107"></a><span id="l1.107">     EnableSearchUI();</span>
<a href="#l1.108"></a><span id="l1.108"> </span>
<a href="#l1.109"></a><span id="l1.109">     // clear out the text field when switching server</span>
<a href="#l1.110"></a><span id="l1.110">     gNameField.value = &quot;&quot;;</span>
<a href="#l1.111"></a><span id="l1.111"> </span>
<a href="#l1.112"></a><span id="l1.112">     // since there is no text, switch to the non-search view...</span>
<a href="#l1.113"></a><span id="l1.113">     SwitchToNormalView();</span>
<a href="#l1.114"></a><span id="l1.114"> </span>
<a href="#l1.115"></a><span id="l1.115" class="difflineminus">-    if (!gSubscribableServer.subscribeListener) {</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">-      gSubscribeTree.view = gSubscribableServer.folderView;</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-      gSubscribableServer.subscribeListener = MySubscribeListener;</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-    }</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+    // Clear the subscribe tree.</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+    while (gSubscribeBody.hasChildNodes())</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+      gSubscribeBody.lastChild.remove();</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+    gSubscribableServer.subscribeListener = MySubscribeListener;</span>
<a href="#l1.124"></a><span id="l1.124"> </span>
<a href="#l1.125"></a><span id="l1.125">     var currentListTab = document.getElementById(&quot;currentListTab&quot;);</span>
<a href="#l1.126"></a><span id="l1.126">     if (currentListTab.selected)</span>
<a href="#l1.127"></a><span id="l1.127">       document.getElementById(&quot;newGroupsTab&quot;).disabled = true;</span>
<a href="#l1.128"></a><span id="l1.128">     else</span>
<a href="#l1.129"></a><span id="l1.129">       currentListTab.disabled = true;</span>
<a href="#l1.130"></a><span id="l1.130"> </span>
<a href="#l1.131"></a><span id="l1.131">     document.getElementById(&quot;refreshButton&quot;).disabled = true;</span>
<a href="#l1.132"></a><span id="l1.132"> </span>
<a href="#l1.133"></a><span id="l1.133">     gStatusFeedback._startMeteors();</span>
<a href="#l1.134"></a><span id="l1.134">     gStatusFeedback.showStatusString(gSubscribeBundle.getString(&quot;pleaseWaitString&quot;));</span>
<a href="#l1.135"></a><span id="l1.135">     document.getElementById(&quot;stopButton&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l1.136"></a><span id="l1.136"> </span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+    gItemsFound.clear();</span>
<a href="#l1.138"></a><span id="l1.138">     gSubscribableServer.startPopulating(msgWindow, forceToServer, getOnlyNew);</span>
<a href="#l1.139"></a><span id="l1.139">   }</span>
<a href="#l1.140"></a><span id="l1.140">   catch (ex)</span>
<a href="#l1.141"></a><span id="l1.141">   {</span>
<a href="#l1.142"></a><span id="l1.142">     dump(&quot;failed to populate subscribe ds: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l1.143"></a><span id="l1.143">   }</span>
<a href="#l1.144"></a><span id="l1.144"> }</span>
<a href="#l1.145"></a><span id="l1.145"> </span>
<a href="#l1.146"></a><span id="l1.146" class="difflineat">@@ -131,16 +186,17 @@ function EnableSearchUI()</span>
<a href="#l1.147"></a><span id="l1.147">   else {</span>
<a href="#l1.148"></a><span id="l1.148">     gNameField.setAttribute('disabled',true);</span>
<a href="#l1.149"></a><span id="l1.149">     gNameFieldLabel.setAttribute('disabled',true);</span>
<a href="#l1.150"></a><span id="l1.150">   }</span>
<a href="#l1.151"></a><span id="l1.151"> }</span>
<a href="#l1.152"></a><span id="l1.152"> </span>
<a href="#l1.153"></a><span id="l1.153"> function SubscribeOnLoad()</span>
<a href="#l1.154"></a><span id="l1.154"> {</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+  //dump(&quot;SubscribeOnLoad()\n&quot;);</span>
<a href="#l1.156"></a><span id="l1.156">   gSubscribeBundle = document.getElementById(&quot;bundle_subscribe&quot;);</span>
<a href="#l1.157"></a><span id="l1.157"> </span>
<a href="#l1.158"></a><span id="l1.158">   gSubscribeTree = document.getElementById(&quot;subscribeTree&quot;);</span>
<a href="#l1.159"></a><span id="l1.159">   gSubscribeBody = document.getElementById(&quot;subscribeTreeBody&quot;);</span>
<a href="#l1.160"></a><span id="l1.160">   gSearchTree = document.getElementById(&quot;searchTree&quot;);</span>
<a href="#l1.161"></a><span id="l1.161">   gSearchTreeBoxObject = document.getElementById(&quot;searchTree&quot;).treeBoxObject;</span>
<a href="#l1.162"></a><span id="l1.162">   gNameField = document.getElementById(&quot;namefield&quot;);</span>
<a href="#l1.163"></a><span id="l1.163">   gNameFieldLabel = document.getElementById(&quot;namefieldlabel&quot;);</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineat">@@ -203,16 +259,17 @@ function SubscribeOnLoad()</span>
<a href="#l1.165"></a><span id="l1.165"> </span>
<a href="#l1.166"></a><span id="l1.166">   ShowCurrentList();</span>
<a href="#l1.167"></a><span id="l1.167"> </span>
<a href="#l1.168"></a><span id="l1.168">   gNameField.focus();</span>
<a href="#l1.169"></a><span id="l1.169"> }</span>
<a href="#l1.170"></a><span id="l1.170"> </span>
<a href="#l1.171"></a><span id="l1.171"> function subscribeOK()</span>
<a href="#l1.172"></a><span id="l1.172"> {</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+  //dump(&quot;in subscribeOK()\n&quot;)</span>
<a href="#l1.174"></a><span id="l1.174">   if (top.okCallback) {</span>
<a href="#l1.175"></a><span id="l1.175">     top.okCallback(top.gChangeTable);</span>
<a href="#l1.176"></a><span id="l1.176">   }</span>
<a href="#l1.177"></a><span id="l1.177">   Stop();</span>
<a href="#l1.178"></a><span id="l1.178">   if (gSubscribableServer) {</span>
<a href="#l1.179"></a><span id="l1.179">     gSubscribableServer.subscribeCleanup();</span>
<a href="#l1.180"></a><span id="l1.180">   }</span>
<a href="#l1.181"></a><span id="l1.181">   return true;</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineat">@@ -222,21 +279,42 @@ function subscribeCancel()</span>
<a href="#l1.183"></a><span id="l1.183"> {</span>
<a href="#l1.184"></a><span id="l1.184">   Stop();</span>
<a href="#l1.185"></a><span id="l1.185">   if (gSubscribableServer) {</span>
<a href="#l1.186"></a><span id="l1.186">     gSubscribableServer.subscribeCleanup();</span>
<a href="#l1.187"></a><span id="l1.187">   }</span>
<a href="#l1.188"></a><span id="l1.188">   return true;</span>
<a href="#l1.189"></a><span id="l1.189"> }</span>
<a href="#l1.190"></a><span id="l1.190"> </span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-function SetState(name, state)</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+function SetState(name, state, aRow)</span>
<a href="#l1.193"></a><span id="l1.193"> {</span>
<a href="#l1.194"></a><span id="l1.194">   var changed = gSubscribableServer.setState(name, state);</span>
<a href="#l1.195"></a><span id="l1.195">   if (changed)</span>
<a href="#l1.196"></a><span id="l1.196">     StateChanged(name, state);</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+  let subscribeCell;</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+  if (aRow === undefined) {</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+    // XXX This won't work when multiple levels of children are implemented</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+    for (let row of gSubscribeBody.children) {</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineplus">+      if (row.children[0].children[0].getAttribute(&quot;value&quot;) == name) {</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+        subscribeCell = row;</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+        break;</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+      }</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+    }</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+  } else {</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+    subscribeCell = gSubscribeBody.children[aRow];</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+  }</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+  setSubscribableCellState(subscribeCell.children[0].children[1], state, true);</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+}</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+function changeTableRecord(server, name, state)</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+{</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+  this.server = server;</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+  this.name = name;</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineplus">+  this.state = state;</span>
<a href="#l1.218"></a><span id="l1.218"> }</span>
<a href="#l1.219"></a><span id="l1.219"> </span>
<a href="#l1.220"></a><span id="l1.220"> function StateChanged(name,state)</span>
<a href="#l1.221"></a><span id="l1.221"> {</span>
<a href="#l1.222"></a><span id="l1.222">   if (gServerURI in gChangeTable) {</span>
<a href="#l1.223"></a><span id="l1.223">     if (name in gChangeTable[gServerURI]) {</span>
<a href="#l1.224"></a><span id="l1.224">       var oldValue = gChangeTable[gServerURI][name];</span>
<a href="#l1.225"></a><span id="l1.225">       if (oldValue != state)</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineat">@@ -335,16 +413,17 @@ function SetSubscribeState(state)</span>
<a href="#l1.227"></a><span id="l1.227">   catch (ex) {</span>
<a href="#l1.228"></a><span id="l1.228">     dump(&quot;SetSubscribedState failed:  &quot; + ex + &quot;\n&quot;);</span>
<a href="#l1.229"></a><span id="l1.229">   }</span>
<a href="#l1.230"></a><span id="l1.230"> }</span>
<a href="#l1.231"></a><span id="l1.231"> </span>
<a href="#l1.232"></a><span id="l1.232"> function ReverseStateFromNode(row)</span>
<a href="#l1.233"></a><span id="l1.233"> {</span>
<a href="#l1.234"></a><span id="l1.234">   let name = gSubscribeTree.view.getCellValue(row, gSubscribeTree.columns[&quot;nameColumn&quot;]);</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+</span>
<a href="#l1.236"></a><span id="l1.236">   SetState(name, !gSubscribableServer.isSubscribed(name), row);</span>
<a href="#l1.237"></a><span id="l1.237"> }</span>
<a href="#l1.238"></a><span id="l1.238"> </span>
<a href="#l1.239"></a><span id="l1.239"> function SubscribeOnClick(event)</span>
<a href="#l1.240"></a><span id="l1.240"> {</span>
<a href="#l1.241"></a><span id="l1.241">   // we only care about button 0 (left click) events</span>
<a href="#l1.242"></a><span id="l1.242">   if (event.button != 0 || event.originalTarget.localName != &quot;treechildren&quot;)</span>
<a href="#l1.243"></a><span id="l1.243">    return;</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineat">@@ -359,19 +438,31 @@ function SubscribeOnClick(event)</span>
<a href="#l1.245"></a><span id="l1.245">     // that isn't a container</span>
<a href="#l1.246"></a><span id="l1.246">     if (!gSubscribeTree.view.isContainer(row.value)) {</span>
<a href="#l1.247"></a><span id="l1.247">       ReverseStateFromNode(row.value);</span>
<a href="#l1.248"></a><span id="l1.248">       return;</span>
<a href="#l1.249"></a><span id="l1.249">     }</span>
<a href="#l1.250"></a><span id="l1.250">   }</span>
<a href="#l1.251"></a><span id="l1.251">   else if (event.detail == 1)</span>
<a href="#l1.252"></a><span id="l1.252">   {</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineminus">-    // if the user single clicks on the subscribe check box, we handle it here</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineminus">-    if (col.value.id == &quot;subscribedColumn&quot;)</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineminus">-      ReverseStateFromNode(row.value);</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+    if (obj.value == &quot;twisty&quot;) {</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+        if (gSubscribeTree.view.isContainerOpen(row.value)) {</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+          var uri = gSubscribeTree.builderView.getResourceAtIndex(row.value).Value;</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+          gStatusFeedback._startMeteors();</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineplus">+          gStatusFeedback.showStatusString(gSubscribeBundle.getString(&quot;pleaseWaitString&quot;));</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineplus">+</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineplus">+          gSubscribableServer.startPopulatingWithUri(msgWindow, true /* force to server */, uri);</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineplus">+        }</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineplus">+    }</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineplus">+    else {</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineplus">+      // if the user single clicks on the subscribe check box, we handle it here</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineplus">+      if (col.value.id == &quot;subscribedColumn&quot;)</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineplus">+        ReverseStateFromNode(row.value);</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineplus">+    }</span>
<a href="#l1.271"></a><span id="l1.271">   }</span>
<a href="#l1.272"></a><span id="l1.272"> }</span>
<a href="#l1.273"></a><span id="l1.273"> </span>
<a href="#l1.274"></a><span id="l1.274"> function Refresh()</span>
<a href="#l1.275"></a><span id="l1.275"> {</span>
<a href="#l1.276"></a><span id="l1.276">   // clear out the textfield's entry</span>
<a href="#l1.277"></a><span id="l1.277">   gNameField.value = &quot;&quot;;</span>
<a href="#l1.278"></a><span id="l1.278"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/public/nsISubscribableServer.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/public/nsISubscribableServer.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -5,32 +5,28 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> interface nsIMsgWindow;</span>
<a href="#l2.8"></a><span id="l2.8"> interface nsIMsgIncomingServer;</span>
<a href="#l2.9"></a><span id="l2.9"> interface nsIRDFResource;</span>
<a href="#l2.10"></a><span id="l2.10"> interface nsIRDFNode;</span>
<a href="#l2.11"></a><span id="l2.11"> interface nsISimpleEnumerator;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-interface nsITreeView;</span>
<a href="#l2.13"></a><span id="l2.13"> </span>
<a href="#l2.14"></a><span id="l2.14"> [scriptable, uuid(61a08c3a-1dd2-11b2-b64f-c4b2de1cf129)]</span>
<a href="#l2.15"></a><span id="l2.15"> interface nsISubscribeDataSource : nsISupports {</span>
<a href="#l2.16"></a><span id="l2.16">     readonly attribute boolean hasObservers;</span>
<a href="#l2.17"></a><span id="l2.17">     void NotifyObservers(in nsIRDFResource subject, in nsIRDFResource property, in nsIRDFNode object, in boolean isAssert, in boolean isChange);</span>
<a href="#l2.18"></a><span id="l2.18"> };</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-/**</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">- * A listener to receive notification of the subscribable folders of a server.</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">- */</span>
<a href="#l2.23"></a><span id="l2.23"> [scriptable, uuid(f337b84a-1dd1-11b2-97c7-fb8b2e3f2280)]</span>
<a href="#l2.24"></a><span id="l2.24"> interface nsISubscribeListener : nsISupports {</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-  /**</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-   * The server has finished finding all folders to subscribe to.</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-   */</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+  // Announce a new item found on the server.</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+  void OnItemDiscovered(in AUTF8String aPath, in boolean aSubscribable);</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+  // Announce finish of discovering server items.</span>
<a href="#l2.31"></a><span id="l2.31">   void OnDonePopulating();</span>
<a href="#l2.32"></a><span id="l2.32"> };</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34"> [scriptable, uuid(14b8597a-755b-4e93-b364-e0903801e6ea)]</span>
<a href="#l2.35"></a><span id="l2.35"> interface nsISubscribableServer : nsISupports {</span>
<a href="#l2.36"></a><span id="l2.36">   attribute nsISubscribeListener subscribeListener;</span>
<a href="#l2.37"></a><span id="l2.37">   attribute char delimiter;</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39" class="difflineat">@@ -74,11 +70,10 @@ interface nsISubscribableServer : nsISup</span>
<a href="#l2.40"></a><span id="l2.40">    */</span>
<a href="#l2.41"></a><span id="l2.41">   nsISimpleEnumerator getChildren(in AUTF8String aPath);</span>
<a href="#l2.42"></a><span id="l2.42">   // if path is null, use the root</span>
<a href="#l2.43"></a><span id="l2.43">   AUTF8String getFirstChildURI(in AUTF8String path);</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45">   // for searching</span>
<a href="#l2.46"></a><span id="l2.46">   void setSearchValue(in AString searchValue);</span>
<a href="#l2.47"></a><span id="l2.47">   readonly attribute boolean supportsSubscribeSearch;</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-  readonly attribute nsITreeView folderView;</span>
<a href="#l2.49"></a><span id="l2.49"> };</span>
<a href="#l2.50"></a><span id="l2.50"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/src/nsSubscribableServer.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/src/nsSubscribableServer.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -9,27 +9,25 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;rdf.h&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;nsRDFCID.h&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-#include &quot;nsTreeColumns.h&quot;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-#include &quot;mozilla/dom/DataTransfer.h&quot;</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> nsSubscribableServer::nsSubscribableServer(void)</span>
<a href="#l3.18"></a><span id="l3.18"> {</span>
<a href="#l3.19"></a><span id="l3.19">     mDelimiter = '.';</span>
<a href="#l3.20"></a><span id="l3.20">     mShowFullName = true;</span>
<a href="#l3.21"></a><span id="l3.21">     mTreeRoot = nullptr;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-    mStopped = true;</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+    mStopped = false;</span>
<a href="#l3.24"></a><span id="l3.24"> }</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26"> nsresult</span>
<a href="#l3.27"></a><span id="l3.27"> nsSubscribableServer::Init()</span>
<a href="#l3.28"></a><span id="l3.28"> {</span>
<a href="#l3.29"></a><span id="l3.29">     nsresult rv;</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31">     rv = EnsureRDFService();</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineat">@@ -48,46 +46,42 @@ nsSubscribableServer::Init()</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34">     rv = mRDFService-&gt;GetLiteral(u&quot;false&quot;, getter_AddRefs(kFalseLiteral));</span>
<a href="#l3.35"></a><span id="l3.35">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.36"></a><span id="l3.36">     return NS_OK;</span>
<a href="#l3.37"></a><span id="l3.37"> }</span>
<a href="#l3.38"></a><span id="l3.38"> </span>
<a href="#l3.39"></a><span id="l3.39"> nsSubscribableServer::~nsSubscribableServer(void)</span>
<a href="#l3.40"></a><span id="l3.40"> {</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-  mozilla::DebugOnly&lt;nsresult&gt; rv = FreeRows();</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to free tree rows&quot;);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-  rv = FreeSubtree(mTreeRoot);</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+  mozilla::DebugOnly&lt;nsresult&gt; rv = FreeSubtree(mTreeRoot);</span>
<a href="#l3.45"></a><span id="l3.45">   NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to free tree&quot;);</span>
<a href="#l3.46"></a><span id="l3.46"> }</span>
<a href="#l3.47"></a><span id="l3.47"> </span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-NS_IMPL_ISUPPORTS(nsSubscribableServer, nsISubscribableServer, nsITreeView)</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+NS_IMPL_ISUPPORTS(nsSubscribableServer, nsISubscribableServer)</span>
<a href="#l3.50"></a><span id="l3.50"> </span>
<a href="#l3.51"></a><span id="l3.51"> NS_IMETHODIMP</span>
<a href="#l3.52"></a><span id="l3.52"> nsSubscribableServer::SetIncomingServer(nsIMsgIncomingServer *aServer)</span>
<a href="#l3.53"></a><span id="l3.53"> {</span>
<a href="#l3.54"></a><span id="l3.54">   if (!aServer) {</span>
<a href="#l3.55"></a><span id="l3.55">     mIncomingServerUri.AssignLiteral(&quot;&quot;);</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-    mServerType.Truncate();</span>
<a href="#l3.57"></a><span id="l3.57">     return NS_OK;</span>
<a href="#l3.58"></a><span id="l3.58">   }</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-  aServer-&gt;GetType(mServerType);</span>
<a href="#l3.60"></a><span id="l3.60"> </span>
<a href="#l3.61"></a><span id="l3.61">   // We intentionally do not store a pointer to the aServer here</span>
<a href="#l3.62"></a><span id="l3.62">   // as it would create reference loops, because nsIImapIncomingServer</span>
<a href="#l3.63"></a><span id="l3.63">   // and nsINntpIncomingServer keep a reference to an internal</span>
<a href="#l3.64"></a><span id="l3.64">   // nsISubscribableServer object.</span>
<a href="#l3.65"></a><span id="l3.65">   // We only need the URI of the server anyway.</span>
<a href="#l3.66"></a><span id="l3.66">   return aServer-&gt;GetServerURI(mIncomingServerUri);</span>
<a href="#l3.67"></a><span id="l3.67"> }</span>
<a href="#l3.68"></a><span id="l3.68"> </span>
<a href="#l3.69"></a><span id="l3.69"> NS_IMETHODIMP</span>
<a href="#l3.70"></a><span id="l3.70"> nsSubscribableServer::GetDelimiter(char *aDelimiter)</span>
<a href="#l3.71"></a><span id="l3.71"> {</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aDelimiter);</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+  if (!aDelimiter) return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.74"></a><span id="l3.74">   *aDelimiter = mDelimiter;</span>
<a href="#l3.75"></a><span id="l3.75">   return NS_OK;</span>
<a href="#l3.76"></a><span id="l3.76"> }</span>
<a href="#l3.77"></a><span id="l3.77"> </span>
<a href="#l3.78"></a><span id="l3.78"> NS_IMETHODIMP</span>
<a href="#l3.79"></a><span id="l3.79"> nsSubscribableServer::SetDelimiter(char aDelimiter)</span>
<a href="#l3.80"></a><span id="l3.80"> {</span>
<a href="#l3.81"></a><span id="l3.81">   mDelimiter = aDelimiter;</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineat">@@ -100,53 +94,61 @@ nsSubscribableServer::SetAsSubscribed(co</span>
<a href="#l3.83"></a><span id="l3.83">     nsresult rv = NS_OK;</span>
<a href="#l3.84"></a><span id="l3.84"> </span>
<a href="#l3.85"></a><span id="l3.85">     SubscribeTreeNode *node = nullptr;</span>
<a href="#l3.86"></a><span id="l3.86">     rv = FindAndCreateNode(path, &amp;node);</span>
<a href="#l3.87"></a><span id="l3.87">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.88"></a><span id="l3.88"> </span>
<a href="#l3.89"></a><span id="l3.89">     NS_ASSERTION(node,&quot;didn't find the node&quot;);</span>
<a href="#l3.90"></a><span id="l3.90">     if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+</span>
<a href="#l3.92"></a><span id="l3.92">     node-&gt;isSubscribable = true;</span>
<a href="#l3.93"></a><span id="l3.93">     node-&gt;isSubscribed = true;</span>
<a href="#l3.94"></a><span id="l3.94"> </span>
<a href="#l3.95"></a><span id="l3.95">     rv = NotifyChange(node, kNC_Subscribed, node-&gt;isSubscribed);</span>
<a href="#l3.96"></a><span id="l3.96">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.97"></a><span id="l3.97"> </span>
<a href="#l3.98"></a><span id="l3.98">     return rv;</span>
<a href="#l3.99"></a><span id="l3.99"> }</span>
<a href="#l3.100"></a><span id="l3.100"> </span>
<a href="#l3.101"></a><span id="l3.101"> NS_IMETHODIMP</span>
<a href="#l3.102"></a><span id="l3.102"> nsSubscribableServer::AddTo(const nsACString&amp; aName, bool aAddAsSubscribed,</span>
<a href="#l3.103"></a><span id="l3.103">                             bool aSubscribable, bool aChangeIfExists)</span>
<a href="#l3.104"></a><span id="l3.104"> {</span>
<a href="#l3.105"></a><span id="l3.105">     nsresult rv = NS_OK;</span>
<a href="#l3.106"></a><span id="l3.106"> </span>
<a href="#l3.107"></a><span id="l3.107">     if (mStopped) {</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+#ifdef DEBUG_seth</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+        printf(&quot;stopped!\n&quot;);</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+#endif</span>
<a href="#l3.111"></a><span id="l3.111">         return NS_ERROR_FAILURE;</span>
<a href="#l3.112"></a><span id="l3.112">     }</span>
<a href="#l3.113"></a><span id="l3.113"> </span>
<a href="#l3.114"></a><span id="l3.114">     SubscribeTreeNode *node = nullptr;</span>
<a href="#l3.115"></a><span id="l3.115"> </span>
<a href="#l3.116"></a><span id="l3.116">     // todo, shouldn't we pass in aAddAsSubscribed, for the</span>
<a href="#l3.117"></a><span id="l3.117">     // default value if we create it?</span>
<a href="#l3.118"></a><span id="l3.118">     rv = FindAndCreateNode(aName, &amp;node);</span>
<a href="#l3.119"></a><span id="l3.119">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+</span>
<a href="#l3.121"></a><span id="l3.121">     NS_ASSERTION(node,&quot;didn't find the node&quot;);</span>
<a href="#l3.122"></a><span id="l3.122">     if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l3.123"></a><span id="l3.123"> </span>
<a href="#l3.124"></a><span id="l3.124">     if (aChangeIfExists) {</span>
<a href="#l3.125"></a><span id="l3.125">         node-&gt;isSubscribed = aAddAsSubscribed;</span>
<a href="#l3.126"></a><span id="l3.126">         rv = NotifyChange(node, kNC_Subscribed, node-&gt;isSubscribed);</span>
<a href="#l3.127"></a><span id="l3.127">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.128"></a><span id="l3.128">     }</span>
<a href="#l3.129"></a><span id="l3.129"> </span>
<a href="#l3.130"></a><span id="l3.130">     node-&gt;isSubscribable = aSubscribable;</span>
<a href="#l3.131"></a><span id="l3.131"> </span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+    if (mSubscribeListener)</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+        mSubscribeListener-&gt;OnItemDiscovered(aName, aSubscribable);</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+    return rv;</span>
<a href="#l3.137"></a><span id="l3.137"> }</span>
<a href="#l3.138"></a><span id="l3.138"> </span>
<a href="#l3.139"></a><span id="l3.139"> NS_IMETHODIMP</span>
<a href="#l3.140"></a><span id="l3.140"> nsSubscribableServer::SetState(const nsACString &amp;aPath, bool aState,</span>
<a href="#l3.141"></a><span id="l3.141">                                bool *aStateChanged)</span>
<a href="#l3.142"></a><span id="l3.142"> {</span>
<a href="#l3.143"></a><span id="l3.143">     nsresult rv = NS_OK;</span>
<a href="#l3.144"></a><span id="l3.144">     NS_ASSERTION(!aPath.IsEmpty() &amp;&amp; aStateChanged, &quot;no path or stateChanged&quot;);</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineat">@@ -172,17 +174,18 @@ nsSubscribableServer::SetState(const nsA</span>
<a href="#l3.146"></a><span id="l3.146">         return NS_OK;</span>
<a href="#l3.147"></a><span id="l3.147">     }</span>
<a href="#l3.148"></a><span id="l3.148">     else {</span>
<a href="#l3.149"></a><span id="l3.149">         node-&gt;isSubscribed = aState;</span>
<a href="#l3.150"></a><span id="l3.150">         *aStateChanged = true;</span>
<a href="#l3.151"></a><span id="l3.151">         rv = NotifyChange(node, kNC_Subscribed, node-&gt;isSubscribed);</span>
<a href="#l3.152"></a><span id="l3.152">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.153"></a><span id="l3.153">     }</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+    return rv;</span>
<a href="#l3.157"></a><span id="l3.157"> }</span>
<a href="#l3.158"></a><span id="l3.158"> </span>
<a href="#l3.159"></a><span id="l3.159"> void</span>
<a href="#l3.160"></a><span id="l3.160"> nsSubscribableServer::BuildURIFromNode(SubscribeTreeNode *node, nsACString &amp;uri)</span>
<a href="#l3.161"></a><span id="l3.161"> {</span>
<a href="#l3.162"></a><span id="l3.162">     if (node-&gt;parent) {</span>
<a href="#l3.163"></a><span id="l3.163">         BuildURIFromNode(node-&gt;parent, uri);</span>
<a href="#l3.164"></a><span id="l3.164">         if (node-&gt;parent == mTreeRoot) {</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineat">@@ -326,17 +329,17 @@ nsSubscribableServer::SetSubscribeListen</span>
<a href="#l3.166"></a><span id="l3.166"> {</span>
<a href="#l3.167"></a><span id="l3.167">   mSubscribeListener = aListener;</span>
<a href="#l3.168"></a><span id="l3.168">   return NS_OK;</span>
<a href="#l3.169"></a><span id="l3.169"> }</span>
<a href="#l3.170"></a><span id="l3.170"> </span>
<a href="#l3.171"></a><span id="l3.171"> NS_IMETHODIMP</span>
<a href="#l3.172"></a><span id="l3.172"> nsSubscribableServer::GetSubscribeListener(nsISubscribeListener **aListener)</span>
<a href="#l3.173"></a><span id="l3.173"> {</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+  if (!aListener) return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.176"></a><span id="l3.176">   NS_IF_ADDREF(*aListener = mSubscribeListener);</span>
<a href="#l3.177"></a><span id="l3.177">   return NS_OK;</span>
<a href="#l3.178"></a><span id="l3.178"> }</span>
<a href="#l3.179"></a><span id="l3.179"> </span>
<a href="#l3.180"></a><span id="l3.180"> NS_IMETHODIMP</span>
<a href="#l3.181"></a><span id="l3.181"> nsSubscribableServer::SubscribeCleanup()</span>
<a href="#l3.182"></a><span id="l3.182"> {</span>
<a href="#l3.183"></a><span id="l3.183">   NS_ASSERTION(false,&quot;override this.&quot;);</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineat">@@ -348,62 +351,31 @@ nsSubscribableServer::StartPopulatingWit</span>
<a href="#l3.185"></a><span id="l3.185"> {</span>
<a href="#l3.186"></a><span id="l3.186">     mStopped = false;</span>
<a href="#l3.187"></a><span id="l3.187">     return NS_OK;</span>
<a href="#l3.188"></a><span id="l3.188"> }</span>
<a href="#l3.189"></a><span id="l3.189"> </span>
<a href="#l3.190"></a><span id="l3.190"> NS_IMETHODIMP</span>
<a href="#l3.191"></a><span id="l3.191"> nsSubscribableServer::StartPopulating(nsIMsgWindow *aMsgWindow, bool aForceToServer, bool aGetOnlyNew /*ignored*/)</span>
<a href="#l3.192"></a><span id="l3.192"> {</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-    mStopped = false;</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+    nsresult rv = NS_OK;</span>
<a href="#l3.195"></a><span id="l3.195"> </span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-    nsresult rv = FreeRows();</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+    mStopped = false;</span>
<a href="#l3.199"></a><span id="l3.199"> </span>
<a href="#l3.200"></a><span id="l3.200">     rv = FreeSubtree(mTreeRoot);</span>
<a href="#l3.201"></a><span id="l3.201">     mTreeRoot = nullptr;</span>
<a href="#l3.202"></a><span id="l3.202">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.203"></a><span id="l3.203">     return NS_OK;</span>
<a href="#l3.204"></a><span id="l3.204"> }</span>
<a href="#l3.205"></a><span id="l3.205"> </span>
<a href="#l3.206"></a><span id="l3.206"> NS_IMETHODIMP</span>
<a href="#l3.207"></a><span id="l3.207"> nsSubscribableServer::StopPopulating(nsIMsgWindow *aMsgWindow)</span>
<a href="#l3.208"></a><span id="l3.208"> {</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-  if (mStopped)</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-  mStopped = true;</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-  NS_ASSERTION(mRowMap.Length() == 0, &quot;mRowMap should be empty&quot;);</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-  if (!mTreeRoot)</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+    mStopped = true;</span>
<a href="#l3.217"></a><span id="l3.217">     return NS_OK;</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-  SubscribeTreeNode *node = mTreeRoot-&gt;lastChild;</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-  // Add top level items as closed.</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-  while (node)</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-  {</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-    node-&gt;isOpen = false;</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-    mRowMap.AppendElement(node);</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineminus">-    node = node-&gt;prevSibling;</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-  }</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-  // Invalidate the whole thing.</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineminus">-  if (mTree)</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-    mTree-&gt;RowCountChanged(0, mRowMap.Length());</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-  // Open all the top level items if they are containers.</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-  uint32_t topRows = mRowMap.Length();</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-  for (int32_t i = topRows - 1; i &gt;= 0; i--) {</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-    bool isContainer = false;</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-    IsContainer(i, &amp;isContainer);</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-    if (isContainer)</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-      ToggleOpenState(i);</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-  }</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.242"></a><span id="l3.242"> }</span>
<a href="#l3.243"></a><span id="l3.243"> </span>
<a href="#l3.244"></a><span id="l3.244"> </span>
<a href="#l3.245"></a><span id="l3.245"> NS_IMETHODIMP</span>
<a href="#l3.246"></a><span id="l3.246"> nsSubscribableServer::UpdateSubscribed()</span>
<a href="#l3.247"></a><span id="l3.247"> {</span>
<a href="#l3.248"></a><span id="l3.248">   NS_ASSERTION(false,&quot;override this.&quot;);</span>
<a href="#l3.249"></a><span id="l3.249">   return NS_ERROR_FAILURE;</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineat">@@ -458,48 +430,34 @@ nsSubscribableServer::FreeSubtree(Subscr</span>
<a href="#l3.251"></a><span id="l3.251">         free(node-&gt;name);</span>
<a href="#l3.252"></a><span id="l3.252"> #if 0</span>
<a href="#l3.253"></a><span id="l3.253">         node-&gt;name = nullptr;</span>
<a href="#l3.254"></a><span id="l3.254">         node-&gt;parent = nullptr;</span>
<a href="#l3.255"></a><span id="l3.255">         node-&gt;lastChild = nullptr;</span>
<a href="#l3.256"></a><span id="l3.256">         node-&gt;cachedChild = nullptr;</span>
<a href="#l3.257"></a><span id="l3.257"> #endif</span>
<a href="#l3.258"></a><span id="l3.258"> </span>
<a href="#l3.259"></a><span id="l3.259" class="difflineminus">-        delete node;</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+        PR_Free(node);</span>
<a href="#l3.261"></a><span id="l3.261">     }</span>
<a href="#l3.262"></a><span id="l3.262"> </span>
<a href="#l3.263"></a><span id="l3.263">     return NS_OK;</span>
<a href="#l3.264"></a><span id="l3.264"> }</span>
<a href="#l3.265"></a><span id="l3.265"> </span>
<a href="#l3.266"></a><span id="l3.266"> nsresult</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-nsSubscribableServer::FreeRows()</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-{</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-  int32_t rowCount = mRowMap.Length();</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">-  mRowMap.Clear();</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineminus">-  if (mTree)</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-    mTree-&gt;RowCountChanged(0, -rowCount);</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineminus">-</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-}</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-nsresult</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-nsSubscribableServer::CreateNode(SubscribeTreeNode *parent, const char *name, const nsACString &amp;aPath, SubscribeTreeNode **result)</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+nsSubscribableServer::CreateNode(SubscribeTreeNode *parent, const char *name, SubscribeTreeNode **result)</span>
<a href="#l3.280"></a><span id="l3.280"> {</span>
<a href="#l3.281"></a><span id="l3.281">     NS_ASSERTION(result &amp;&amp; name, &quot;result or name is null&quot;);</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-    NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-    NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+    if (!result || !name) return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.285"></a><span id="l3.285"> </span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-    *result = new SubscribeTreeNode();</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+    *result = (SubscribeTreeNode *) PR_Malloc(sizeof(SubscribeTreeNode));</span>
<a href="#l3.288"></a><span id="l3.288">     if (!*result) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l3.289"></a><span id="l3.289"> </span>
<a href="#l3.290"></a><span id="l3.290">     (*result)-&gt;name = strdup(name);</span>
<a href="#l3.291"></a><span id="l3.291">     if (!(*result)-&gt;name) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l3.292"></a><span id="l3.292"> </span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-    (*result)-&gt;path.Assign(aPath);</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineminus">-</span>
<a href="#l3.295"></a><span id="l3.295">     (*result)-&gt;parent = parent;</span>
<a href="#l3.296"></a><span id="l3.296">     (*result)-&gt;prevSibling = nullptr;</span>
<a href="#l3.297"></a><span id="l3.297">     (*result)-&gt;nextSibling = nullptr;</span>
<a href="#l3.298"></a><span id="l3.298">     (*result)-&gt;firstChild = nullptr;</span>
<a href="#l3.299"></a><span id="l3.299">     (*result)-&gt;lastChild = nullptr;</span>
<a href="#l3.300"></a><span id="l3.300">     (*result)-&gt;isSubscribed = false;</span>
<a href="#l3.301"></a><span id="l3.301">     (*result)-&gt;isSubscribable = false;</span>
<a href="#l3.302"></a><span id="l3.302"> #ifdef HAVE_SUBSCRIBE_DESCRIPTION</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineat">@@ -509,31 +467,29 @@ nsSubscribableServer::CreateNode(Subscri</span>
<a href="#l3.304"></a><span id="l3.304">     (*result)-&gt;messages = 0;</span>
<a href="#l3.305"></a><span id="l3.305"> #endif</span>
<a href="#l3.306"></a><span id="l3.306">     (*result)-&gt;cachedChild = nullptr;</span>
<a href="#l3.307"></a><span id="l3.307"> </span>
<a href="#l3.308"></a><span id="l3.308">     if (parent) {</span>
<a href="#l3.309"></a><span id="l3.309">         parent-&gt;cachedChild = *result;</span>
<a href="#l3.310"></a><span id="l3.310">     }</span>
<a href="#l3.311"></a><span id="l3.311"> </span>
<a href="#l3.312"></a><span id="l3.312" class="difflineminus">-    (*result)-&gt;isOpen = true;</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-</span>
<a href="#l3.314"></a><span id="l3.314">     return NS_OK;</span>
<a href="#l3.315"></a><span id="l3.315"> }</span>
<a href="#l3.316"></a><span id="l3.316"> </span>
<a href="#l3.317"></a><span id="l3.317"> nsresult</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineminus">-nsSubscribableServer::AddChildNode(SubscribeTreeNode *parent, const char *name, const nsACString &amp;aPath, SubscribeTreeNode **child)</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+nsSubscribableServer::AddChildNode(SubscribeTreeNode *parent, const char *name, SubscribeTreeNode **child)</span>
<a href="#l3.320"></a><span id="l3.320"> {</span>
<a href="#l3.321"></a><span id="l3.321">     nsresult rv = NS_OK;</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineminus">-    NS_ASSERTION(parent &amp;&amp; child &amp;&amp; name &amp;&amp; !aPath.IsEmpty(), &quot;parent, child or name is null&quot;);</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-    if (!parent || !child || !name || aPath.IsEmpty()) return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineplus">+    NS_ASSERTION(parent &amp;&amp; child &amp;&amp; name, &quot;parent, child or name is null&quot;);</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineplus">+    if (!parent || !child || !name) return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.326"></a><span id="l3.326"> </span>
<a href="#l3.327"></a><span id="l3.327">     if (!parent-&gt;firstChild) {</span>
<a href="#l3.328"></a><span id="l3.328">         // CreateNode will set the parent-&gt;cachedChild</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineminus">-        rv = CreateNode(parent, name, aPath, child);</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+        rv = CreateNode(parent, name, child);</span>
<a href="#l3.331"></a><span id="l3.331">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.332"></a><span id="l3.332"> </span>
<a href="#l3.333"></a><span id="l3.333">         parent-&gt;firstChild = *child;</span>
<a href="#l3.334"></a><span id="l3.334">         parent-&gt;lastChild = *child;</span>
<a href="#l3.335"></a><span id="l3.335"> </span>
<a href="#l3.336"></a><span id="l3.336">         rv = NotifyAssert(parent, kNC_Child, *child);</span>
<a href="#l3.337"></a><span id="l3.337">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.338"></a><span id="l3.338"> </span>
<a href="#l3.339"></a><span id="l3.339" class="difflineat">@@ -562,17 +518,17 @@ nsSubscribableServer::AddChildNode(Subsc</span>
<a href="#l3.340"></a><span id="l3.340">      * we can efficiently reverse the order when dumping to hostinfo.dat</span>
<a href="#l3.341"></a><span id="l3.341">      * or to GetTargets()</span>
<a href="#l3.342"></a><span id="l3.342">      */</span>
<a href="#l3.343"></a><span id="l3.343">     int32_t compare = strcmp(current-&gt;name, name);</span>
<a href="#l3.344"></a><span id="l3.344"> </span>
<a href="#l3.345"></a><span id="l3.345">     while (current &amp;&amp; (compare != 0)) {</span>
<a href="#l3.346"></a><span id="l3.346">         if (compare &lt; 0) {</span>
<a href="#l3.347"></a><span id="l3.347">             // CreateNode will set the parent-&gt;cachedChild</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineminus">-            rv = CreateNode(parent, name, aPath, child);</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineplus">+            rv = CreateNode(parent, name, child);</span>
<a href="#l3.350"></a><span id="l3.350">             NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.351"></a><span id="l3.351"> </span>
<a href="#l3.352"></a><span id="l3.352">             (*child)-&gt;nextSibling = current;</span>
<a href="#l3.353"></a><span id="l3.353">             (*child)-&gt;prevSibling = current-&gt;prevSibling;</span>
<a href="#l3.354"></a><span id="l3.354">             current-&gt;prevSibling = (*child);</span>
<a href="#l3.355"></a><span id="l3.355">             if (!(*child)-&gt;prevSibling) {</span>
<a href="#l3.356"></a><span id="l3.356">                 parent-&gt;firstChild = (*child);</span>
<a href="#l3.357"></a><span id="l3.357">             }</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineat">@@ -599,17 +555,17 @@ nsSubscribableServer::AddChildNode(Subsc</span>
<a href="#l3.359"></a><span id="l3.359">         *child = current;</span>
<a href="#l3.360"></a><span id="l3.360"> </span>
<a href="#l3.361"></a><span id="l3.361">         // set the cachedChild</span>
<a href="#l3.362"></a><span id="l3.362">         parent-&gt;cachedChild = *child;</span>
<a href="#l3.363"></a><span id="l3.363">         return NS_OK;</span>
<a href="#l3.364"></a><span id="l3.364">     }</span>
<a href="#l3.365"></a><span id="l3.365"> </span>
<a href="#l3.366"></a><span id="l3.366">     // CreateNode will set the parent-&gt;cachedChild</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-    rv = CreateNode(parent, name, aPath, child);</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineplus">+    rv = CreateNode(parent, name, child);</span>
<a href="#l3.369"></a><span id="l3.369">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.370"></a><span id="l3.370"> </span>
<a href="#l3.371"></a><span id="l3.371">     (*child)-&gt;prevSibling = parent-&gt;lastChild;</span>
<a href="#l3.372"></a><span id="l3.372">     (*child)-&gt;nextSibling = nullptr;</span>
<a href="#l3.373"></a><span id="l3.373">     parent-&gt;lastChild-&gt;nextSibling = *child;</span>
<a href="#l3.374"></a><span id="l3.374">     parent-&gt;lastChild = *child;</span>
<a href="#l3.375"></a><span id="l3.375"> </span>
<a href="#l3.376"></a><span id="l3.376">     rv = NotifyAssert(parent, kNC_Child, *child);</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineat">@@ -618,81 +574,85 @@ nsSubscribableServer::AddChildNode(Subsc</span>
<a href="#l3.378"></a><span id="l3.378"> }</span>
<a href="#l3.379"></a><span id="l3.379"> </span>
<a href="#l3.380"></a><span id="l3.380"> nsresult</span>
<a href="#l3.381"></a><span id="l3.381"> nsSubscribableServer::FindAndCreateNode(const nsACString &amp;aPath,</span>
<a href="#l3.382"></a><span id="l3.382">                                         SubscribeTreeNode **aResult)</span>
<a href="#l3.383"></a><span id="l3.383"> {</span>
<a href="#l3.384"></a><span id="l3.384">   nsresult rv = NS_OK;</span>
<a href="#l3.385"></a><span id="l3.385">   NS_ASSERTION(aResult, &quot;no result&quot;);</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineplus">+  if (!aResult) return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.388"></a><span id="l3.388"> </span>
<a href="#l3.389"></a><span id="l3.389">   if (!mTreeRoot) {</span>
<a href="#l3.390"></a><span id="l3.390">       // the root has no parent, and its name is server uri</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineminus">-      rv = CreateNode(nullptr, mIncomingServerUri.get(), EmptyCString(), &amp;mTreeRoot);</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineplus">+      rv = CreateNode(nullptr, mIncomingServerUri.get(), &amp;mTreeRoot);</span>
<a href="#l3.393"></a><span id="l3.393">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.394"></a><span id="l3.394">   }</span>
<a href="#l3.395"></a><span id="l3.395"> </span>
<a href="#l3.396"></a><span id="l3.396">   if (aPath.IsEmpty()) {</span>
<a href="#l3.397"></a><span id="l3.397">       *aResult = mTreeRoot;</span>
<a href="#l3.398"></a><span id="l3.398">       return NS_OK;</span>
<a href="#l3.399"></a><span id="l3.399">   }</span>
<a href="#l3.400"></a><span id="l3.400"> </span>
<a href="#l3.401"></a><span id="l3.401" class="difflineplus">+  char *token = nullptr;</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineplus">+  nsCString pathStr(aPath);</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineplus">+  char *rest = pathStr.BeginWriting();</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineplus">+</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineplus">+  // todo do this only once</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineplus">+  char delimstr[2];</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineplus">+  delimstr[0] = mDelimiter;</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineplus">+  delimstr[1] = '\0';</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+</span>
<a href="#l3.410"></a><span id="l3.410">   *aResult = nullptr;</span>
<a href="#l3.411"></a><span id="l3.411"> </span>
<a href="#l3.412"></a><span id="l3.412">   SubscribeTreeNode *parent = mTreeRoot;</span>
<a href="#l3.413"></a><span id="l3.413">   SubscribeTreeNode *child = nullptr;</span>
<a href="#l3.414"></a><span id="l3.414"> </span>
<a href="#l3.415"></a><span id="l3.415" class="difflineminus">-  uint32_t tokenStart = 0;</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-  // Special case paths that start with the hierarchy delimiter.</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineplus">+  token = NS_strtok(delimstr, &amp;rest);</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineplus">+  // special case paths that start with the hierarchy delimiter.</span>
<a href="#l3.419"></a><span id="l3.419">   // We want to include that delimiter in the first token name.</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineminus">-  // So start from position 1.</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineminus">-  int32_t tokenEnd = aPath.FindChar(mDelimiter, tokenStart + 1);</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineminus">-  while (true) {</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineminus">-    if (tokenEnd == kNotFound) {</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineminus">-      if (tokenStart &gt;= aPath.Length())</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineminus">-        break;</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineminus">-      tokenEnd = aPath.Length();</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineminus">-    }</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineminus">-    nsCString token(Substring(aPath, tokenStart, tokenEnd - tokenStart));</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineminus">-    rv = AddChildNode(parent, token.BeginReading(), Substring(aPath, 0, tokenEnd), &amp;child);</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineplus">+  if (token &amp;&amp; pathStr[0] == mDelimiter)</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineplus">+    --token;</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineplus">+  while (token &amp;&amp; *token) {</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineplus">+    rv = AddChildNode(parent, token, &amp;child);</span>
<a href="#l3.434"></a><span id="l3.434">     if (NS_FAILED(rv))</span>
<a href="#l3.435"></a><span id="l3.435">       return rv;</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineminus">-    tokenStart = tokenEnd + 1;</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineminus">-    tokenEnd = aPath.FindChar(mDelimiter, tokenStart);</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineplus">+    token = NS_strtok(delimstr, &amp;rest);</span>
<a href="#l3.439"></a><span id="l3.439">     parent = child;</span>
<a href="#l3.440"></a><span id="l3.440">   }</span>
<a href="#l3.441"></a><span id="l3.441"> </span>
<a href="#l3.442"></a><span id="l3.442">   // the last child we add is the result</span>
<a href="#l3.443"></a><span id="l3.443">   *aResult = child;</span>
<a href="#l3.444"></a><span id="l3.444">   return rv;</span>
<a href="#l3.445"></a><span id="l3.445"> }</span>
<a href="#l3.446"></a><span id="l3.446"> </span>
<a href="#l3.447"></a><span id="l3.447"> NS_IMETHODIMP</span>
<a href="#l3.448"></a><span id="l3.448"> nsSubscribableServer::HasChildren(const nsACString &amp;aPath, bool *aHasChildren)</span>
<a href="#l3.449"></a><span id="l3.449"> {</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineplus">+    nsresult rv = NS_OK;</span>
<a href="#l3.451"></a><span id="l3.451">     NS_ASSERTION(aHasChildren, &quot;no hasChildren&quot;);</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aHasChildren);</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineplus">+    if (!aHasChildren) return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.454"></a><span id="l3.454"> </span>
<a href="#l3.455"></a><span id="l3.455">     *aHasChildren = false;</span>
<a href="#l3.456"></a><span id="l3.456"> </span>
<a href="#l3.457"></a><span id="l3.457">     SubscribeTreeNode *node = nullptr;</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineminus">-    nsresult rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineplus">+    rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l3.460"></a><span id="l3.460">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.461"></a><span id="l3.461"> </span>
<a href="#l3.462"></a><span id="l3.462">     NS_ASSERTION(node,&quot;didn't find the node&quot;);</span>
<a href="#l3.463"></a><span id="l3.463">     if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l3.464"></a><span id="l3.464"> </span>
<a href="#l3.465"></a><span id="l3.465">     *aHasChildren = (node-&gt;firstChild != nullptr);</span>
<a href="#l3.466"></a><span id="l3.466">     return NS_OK;</span>
<a href="#l3.467"></a><span id="l3.467"> }</span>
<a href="#l3.468"></a><span id="l3.468"> </span>
<a href="#l3.469"></a><span id="l3.469"> </span>
<a href="#l3.470"></a><span id="l3.470"> NS_IMETHODIMP</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineminus">-nsSubscribableServer::IsSubscribed(const nsACString &amp;aPath, bool *aIsSubscribed)</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineplus">+nsSubscribableServer::IsSubscribed(const nsACString &amp;aPath,</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineplus">+                                   bool *aIsSubscribed)</span>
<a href="#l3.474"></a><span id="l3.474"> {</span>
<a href="#l3.475"></a><span id="l3.475">     NS_ENSURE_ARG_POINTER(aIsSubscribed);</span>
<a href="#l3.476"></a><span id="l3.476"> </span>
<a href="#l3.477"></a><span id="l3.477">     *aIsSubscribed = false;</span>
<a href="#l3.478"></a><span id="l3.478"> </span>
<a href="#l3.479"></a><span id="l3.479">     SubscribeTreeNode *node = nullptr;</span>
<a href="#l3.480"></a><span id="l3.480">     nsresult rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l3.481"></a><span id="l3.481">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineat">@@ -837,372 +797,8 @@ nsSubscribableServer::SetSearchValue(con</span>
<a href="#l3.483"></a><span id="l3.483">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l3.484"></a><span id="l3.484"> }</span>
<a href="#l3.485"></a><span id="l3.485"> </span>
<a href="#l3.486"></a><span id="l3.486"> NS_IMETHODIMP</span>
<a href="#l3.487"></a><span id="l3.487"> nsSubscribableServer::GetSupportsSubscribeSearch(bool *retVal)</span>
<a href="#l3.488"></a><span id="l3.488"> {</span>
<a href="#l3.489"></a><span id="l3.489">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l3.490"></a><span id="l3.490"> }</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineminus">-</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineminus">-nsSubscribableServer::GetFolderView(nsITreeView **aView)</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineminus">-{</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aView);</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineminus">-  return this-&gt;QueryInterface(NS_GET_IID(nsITreeView), (void**)aView);</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineminus">-}</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineminus">-</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineminus">-int32_t</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineminus">-nsSubscribableServer::GetRow(SubscribeTreeNode *node, bool *open)</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineminus">-{</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineminus">-  int32_t parentRow = -1;</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineminus">-  if (node-&gt;parent)</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineminus">-    parentRow = GetRow(node-&gt;parent, open);</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineminus">-</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineminus">-  // If the parent wasn't opened, we're not in the row map</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineminus">-  if (open &amp;&amp; *open == false)</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineminus">-    return -1;</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineminus">-</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineminus">-  if (open)</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineminus">-    *open = node-&gt;isOpen;</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineminus">-</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineminus">-  for (uint32_t row = parentRow + 1; row &lt; mRowMap.Length(); row++)</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineminus">-  {</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineminus">-    if (mRowMap[row] == node)</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineminus">-      return row;</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineminus">-  }</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineminus">-</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineminus">-  // Apparently, we're not in the map</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineminus">-  return -1;</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineminus">-}</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineminus">-</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineminus">-nsSubscribableServer::GetSelection(nsITreeSelection **selection)</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineminus">-{</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineminus">-  NS_IF_ADDREF(*selection = mSelection);</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineminus">-}</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineminus">-</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineminus">-nsSubscribableServer::SetSelection(nsITreeSelection *selection)</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineminus">-{</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineminus">-  mSelection = selection;</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineminus">-}</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineminus">-</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineminus">-nsSubscribableServer::GetRowCount(int32_t *rowCount)</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineminus">-{</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineminus">-  *rowCount = mRowMap.Length();</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineminus">-}</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineminus">-</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineminus">-nsSubscribableServer::SetTree(nsITreeBoxObject *aTree)</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineminus">-{</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineminus">-  mTree = aTree;</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineminus">-}</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineminus">-</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineminus">-nsSubscribableServer::IsContainer(int32_t aIndex, bool *retval)</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineminus">-{</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineminus">-  *retval = !!mRowMap[aIndex]-&gt;firstChild;</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineminus">-}</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineminus">-</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineminus">-nsSubscribableServer::IsContainerEmpty(int32_t aIndex, bool *retval)</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineminus">-{</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineminus">-  *retval = false;</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineminus">-}</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineminus">-</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineminus">-nsSubscribableServer::IsContainerOpen(int32_t aIndex, bool *retval)</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineminus">-{</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineminus">-  *retval = mRowMap[aIndex]-&gt;isOpen;</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineminus">-}</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineminus">-</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineminus">-nsSubscribableServer::GetParentIndex(int32_t aIndex, int32_t *retval)</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineminus">-{</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineminus">-  SubscribeTreeNode *parent = mRowMap[aIndex]-&gt;parent;</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineminus">-  if (!parent)</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineminus">-  {</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineminus">-    *retval = -1;</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineminus">-  }</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineminus">-</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineminus">-  int32_t index;</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineminus">-  for (index = aIndex - 1; index &gt;= 0; index--)</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineminus">-  {</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineminus">-    if (mRowMap[index] == parent)</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineminus">-    {</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineminus">-      *retval = index;</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineminus">-      return NS_OK;</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineminus">-    }</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineminus">-  }</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineminus">-  *retval = -1;</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineminus">-}</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineminus">-</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineminus">-nsSubscribableServer::HasNextSibling(int32_t aRowIndex, int32_t aAfterIndex,</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineminus">-                                     bool *retval)</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineminus">-{</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineminus">-  // This looks odd, but is correct. Using -&gt;nextSibling gives a bad tree.</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineminus">-  *retval = !!mRowMap[aRowIndex]-&gt;prevSibling;</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineminus">-}</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineminus">-</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineminus">-nsSubscribableServer::GetLevel(int32_t aIndex, int32_t *retval)</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-{</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineminus">-  // When starting with -2, we increase twice and return 0 for a top level node.</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineminus">-  int32_t level = -2;</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineminus">-  SubscribeTreeNode *node = mRowMap[aIndex];</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineminus">-  while (node)</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineminus">-  {</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineminus">-    node = node-&gt;parent;</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineminus">-    level++;</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineminus">-  }</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineminus">-</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineminus">-  *retval = level;</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineminus">-}</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineminus">-</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineminus">-nsSubscribableServer::ToggleOpenState(int32_t aIndex)</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineminus">-{</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineminus">-  SubscribeTreeNode *node = mRowMap[aIndex];</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineminus">-  if (node-&gt;isOpen)</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineminus">-  {</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineminus">-    // Close the node by finding the next sibling</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineminus">-    node-&gt;isOpen = false;</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineminus">-    int32_t count = node-&gt;prevSibling</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineminus">-      ? (mRowMap.IndexOf(node-&gt;prevSibling, aIndex) - aIndex - 1)</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineminus">-      : (mRowMap.Length() - aIndex - 1);</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineminus">-    mRowMap.RemoveElementsAt(aIndex + 1, count);</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineminus">-    if (mTree)</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineminus">-    {</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineminus">-      mTree-&gt;RowCountChanged(aIndex + 1, -count);</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineminus">-      mTree-&gt;InvalidateRow(aIndex);</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineminus">-    }</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineminus">-  }</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineminus">-  else</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineminus">-  {</span>
<a href="#l3.640"></a><span id="l3.640" class="difflineminus">-    // Recursively add the children nodes (i.e., remember open)</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineminus">-    node-&gt;isOpen = true;</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineminus">-    int32_t total = 0;</span>
<a href="#l3.643"></a><span id="l3.643" class="difflineminus">-    node = node-&gt;lastChild;</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineminus">-    while (node)</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineminus">-    {</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineminus">-      total += AddSubtree(node, aIndex + 1 + total);</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineminus">-      node = node-&gt;prevSibling;</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineminus">-    }</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineminus">-    if (mTree)</span>
<a href="#l3.650"></a><span id="l3.650" class="difflineminus">-    {</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineminus">-      mTree-&gt;RowCountChanged(aIndex + 1, total);</span>
<a href="#l3.652"></a><span id="l3.652" class="difflineminus">-      mTree-&gt;InvalidateRow(aIndex);</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineminus">-    }</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineminus">-  }</span>
<a href="#l3.655"></a><span id="l3.655" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.656"></a><span id="l3.656" class="difflineminus">-}</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineminus">-</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineminus">-int32_t</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineminus">-nsSubscribableServer::AddSubtree(SubscribeTreeNode *node, int32_t index)</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineminus">-{</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineminus">-  mRowMap.InsertElementAt(index, node);</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineminus">-  int32_t total = 1;</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineminus">-  if (node-&gt;isOpen)</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineminus">-  {</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineminus">-    node = node-&gt;lastChild;</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineminus">-    while (node)</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineminus">-    {</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineminus">-      total += AddSubtree(node, index + total);</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineminus">-      node = node-&gt;prevSibling;</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineminus">-    }</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineminus">-  }</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineminus">-  return total;</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineminus">-}</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineminus">-</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineminus">-nsSubscribableServer::GetCellText(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineminus">-                                  nsAString &amp;retval)</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineminus">-{</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineminus">-  nsString colId;</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineminus">-  aCol-&gt;GetId(colId);</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineminus">-  if (colId.EqualsLiteral(&quot;nameColumn&quot;)) {</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineminus">-    nsCString path(mRowMap[aRow]-&gt;path);</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineminus">-    GetLeafName(path, retval);</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineminus">-  }</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineminus">-}</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineminus">-</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineminus">-nsSubscribableServer::GetCellValue(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineminus">-                                   nsAString &amp;retval)</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineminus">-{</span>
<a href="#l3.692"></a><span id="l3.692" class="difflineminus">-  nsString colId;</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineminus">-  aCol-&gt;GetId(colId);</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineminus">-  if (colId.EqualsLiteral(&quot;nameColumn&quot;))</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineminus">-    retval = NS_ConvertUTF8toUTF16(mRowMap[aRow]-&gt;path);</span>
<a href="#l3.696"></a><span id="l3.696" class="difflineminus">-  if (colId.EqualsLiteral(&quot;subscribedColumn&quot;))</span>
<a href="#l3.697"></a><span id="l3.697" class="difflineminus">-  {</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineminus">-    retval = mRowMap[aRow]-&gt;isSubscribed ? NS_LITERAL_STRING(&quot;true&quot;)</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineminus">-                                         : NS_LITERAL_STRING(&quot;false&quot;);</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineminus">-  }</span>
<a href="#l3.701"></a><span id="l3.701" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineminus">-}</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineminus">-</span>
<a href="#l3.704"></a><span id="l3.704" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineminus">-nsSubscribableServer::SetCellText(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l3.706"></a><span id="l3.706" class="difflineminus">-                                  const nsAString &amp;aText)</span>
<a href="#l3.707"></a><span id="l3.707" class="difflineminus">-{</span>
<a href="#l3.708"></a><span id="l3.708" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.709"></a><span id="l3.709" class="difflineminus">-}</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineminus">-</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineminus">-nsSubscribableServer::SetCellValue(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineminus">-                                   const nsAString &amp;aText)</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineminus">-{</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineminus">-}</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineminus">-</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.719"></a><span id="l3.719" class="difflineminus">-nsSubscribableServer::GetCellProperties(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l3.720"></a><span id="l3.720" class="difflineminus">-                                        nsAString&amp; aProps)</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineminus">-{</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineminus">-  SubscribeTreeNode *node = mRowMap[aRow];</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineminus">-  if (node-&gt;isSubscribable)</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineminus">-    aProps.AssignLiteral(&quot;subscribable-true&quot;);</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineminus">-  else</span>
<a href="#l3.726"></a><span id="l3.726" class="difflineminus">-    aProps.AssignLiteral(&quot;subscribable-false&quot;);</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineminus">-</span>
<a href="#l3.728"></a><span id="l3.728" class="difflineminus">-  nsString colId;</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineminus">-  aCol-&gt;GetId(colId);</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineminus">-  if (colId.EqualsLiteral(&quot;subscribedColumn&quot;)) {</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineminus">-    if (node-&gt;isSubscribed)</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineminus">-      aProps.AppendLiteral(&quot; subscribed-true&quot;);</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineminus">-    else</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineminus">-      aProps.AppendLiteral(&quot; subscribed-false&quot;);</span>
<a href="#l3.735"></a><span id="l3.735" class="difflineminus">-  } else if (colId.EqualsLiteral(&quot;nameColumn&quot;)) {</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineminus">-    aProps.AppendLiteral(&quot; serverType-&quot;);</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineminus">-    aProps.Append(NS_ConvertUTF8toUTF16(mServerType));</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineminus">-  }</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.740"></a><span id="l3.740" class="difflineminus">-}</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineminus">-</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineminus">-nsSubscribableServer::GetRowProperties(int32_t aRow, nsAString&amp; aProps)</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineminus">-{</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineminus">-}</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineminus">-</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineminus">-nsSubscribableServer::GetColumnProperties(nsTreeColumn *aCol,</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineminus">-                                          nsAString&amp; aProps)</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineminus">-{</span>
<a href="#l3.752"></a><span id="l3.752" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineminus">-}</span>
<a href="#l3.754"></a><span id="l3.754" class="difflineminus">-</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.756"></a><span id="l3.756" class="difflineminus">-nsSubscribableServer::IsEditable(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l3.757"></a><span id="l3.757" class="difflineminus">-                                 bool *retval)</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineminus">-{</span>
<a href="#l3.759"></a><span id="l3.759" class="difflineminus">-  *retval = false;</span>
<a href="#l3.760"></a><span id="l3.760" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.761"></a><span id="l3.761" class="difflineminus">-}</span>
<a href="#l3.762"></a><span id="l3.762" class="difflineminus">-</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineminus">-nsSubscribableServer::IsSelectable(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineminus">-                                   bool *retval)</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineminus">-{</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineminus">-  *retval = false;</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.769"></a><span id="l3.769" class="difflineminus">-}</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineminus">-</span>
<a href="#l3.771"></a><span id="l3.771" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineminus">-nsSubscribableServer::IsSeparator(int32_t aRowIndex, bool *retval)</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineminus">-{</span>
<a href="#l3.774"></a><span id="l3.774" class="difflineminus">-  *retval = false;</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineminus">-}</span>
<a href="#l3.777"></a><span id="l3.777" class="difflineminus">-</span>
<a href="#l3.778"></a><span id="l3.778" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineminus">-nsSubscribableServer::IsSorted(bool *retval)</span>
<a href="#l3.780"></a><span id="l3.780" class="difflineminus">-{</span>
<a href="#l3.781"></a><span id="l3.781" class="difflineminus">-  *retval = false;</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineminus">-}</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineminus">-</span>
<a href="#l3.785"></a><span id="l3.785" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineminus">-nsSubscribableServer::CanDrop(int32_t aIndex, int32_t aOrientation,</span>
<a href="#l3.787"></a><span id="l3.787" class="difflineminus">-                              mozilla::dom::DataTransfer *aData, bool *retval)</span>
<a href="#l3.788"></a><span id="l3.788" class="difflineminus">-{</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineminus">-  *retval = false;</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.791"></a><span id="l3.791" class="difflineminus">-}</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineminus">-</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.794"></a><span id="l3.794" class="difflineminus">-nsSubscribableServer::Drop(int32_t aRow, int32_t aOrientation,</span>
<a href="#l3.795"></a><span id="l3.795" class="difflineminus">-                           mozilla::dom::DataTransfer *aData)</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineminus">-{</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineminus">-}</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineminus">-</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineminus">-nsSubscribableServer::GetImageSrc(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l3.802"></a><span id="l3.802" class="difflineminus">-                                  nsAString &amp;retval)</span>
<a href="#l3.803"></a><span id="l3.803" class="difflineminus">-{</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineminus">-}</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineminus">-</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.808"></a><span id="l3.808" class="difflineminus">-nsSubscribableServer::CycleHeader(nsTreeColumn *aCol)</span>
<a href="#l3.809"></a><span id="l3.809" class="difflineminus">-{</span>
<a href="#l3.810"></a><span id="l3.810" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineminus">-}</span>
<a href="#l3.812"></a><span id="l3.812" class="difflineminus">-</span>
<a href="#l3.813"></a><span id="l3.813" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.814"></a><span id="l3.814" class="difflineminus">-nsSubscribableServer::SelectionChanged()</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineminus">-{</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineminus">-}</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineminus">-</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineminus">-nsSubscribableServer::CycleCell(int32_t aRow, nsTreeColumn *aCol)</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineminus">-{</span>
<a href="#l3.822"></a><span id="l3.822" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineminus">-}</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineminus">-</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineminus">-nsSubscribableServer::PerformAction(const char16_t *aAction)</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineminus">-{</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineminus">-}</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineminus">-</span>
<a href="#l3.831"></a><span id="l3.831" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineminus">-nsSubscribableServer::PerformActionOnRow(const char16_t *aAction, int32_t aRow)</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineminus">-{</span>
<a href="#l3.834"></a><span id="l3.834" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineminus">-}</span>
<a href="#l3.836"></a><span id="l3.836" class="difflineminus">-</span>
<a href="#l3.837"></a><span id="l3.837" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.838"></a><span id="l3.838" class="difflineminus">-nsSubscribableServer::PerformActionOnCell(const char16_t *aAction,</span>
<a href="#l3.839"></a><span id="l3.839" class="difflineminus">-                                          int32_t aRow, nsTreeColumn *aCol)</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineminus">-{</span>
<a href="#l3.841"></a><span id="l3.841" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.842"></a><span id="l3.842" class="difflineminus">-}</span>
<a href="#l3.843"></a><span id="l3.843" class="difflineminus">-</span>
<a href="#l3.844"></a><span id="l3.844" class="difflineminus">-NS_IMPL_ISUPPORTS(nsSubscribeListener, nsISubscribeListener)</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineminus">-</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineminus">-nsSubscribeListener::~nsSubscribeListener(void)</span>
<a href="#l3.847"></a><span id="l3.847" class="difflineminus">-{</span>
<a href="#l3.848"></a><span id="l3.848" class="difflineminus">-}</span>
<a href="#l3.849"></a><span id="l3.849" class="difflineminus">-</span>
<a href="#l3.850"></a><span id="l3.850" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.851"></a><span id="l3.851" class="difflineminus">-nsSubscribeListener::OnDonePopulating()</span>
<a href="#l3.852"></a><span id="l3.852" class="difflineminus">-{</span>
<a href="#l3.853"></a><span id="l3.853" class="difflineminus">-  return NS_OK;</span>
<a href="#l3.854"></a><span id="l3.854" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/src/nsSubscribableServer.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/src/nsSubscribableServer.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -3,105 +3,78 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.5"></a><span id="l4.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> #ifndef nsSubscribableServer_h__</span>
<a href="#l4.8"></a><span id="l4.8"> #define nsSubscribableServer_h__</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> #include &quot;nsString.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-#include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-#include &quot;nsITreeBoxObject.h&quot;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-#include &quot;nsITreeSelection.h&quot;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-#include &quot;nsITreeView.h&quot;</span>
<a href="#l4.16"></a><span id="l4.16"> #include &quot;nsISubscribableServer.h&quot;</span>
<a href="#l4.17"></a><span id="l4.17"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l4.18"></a><span id="l4.18"> #include &quot;nsSubscribeDataSource.h&quot;</span>
<a href="#l4.19"></a><span id="l4.19"> #include &quot;nsIRDFResource.h&quot;</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-#include &quot;nsTArray.h&quot;</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-/**</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">- * The basic structure for the tree of the implementation.</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">- *</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">- * These elements are stored in reverse alphabetical order.</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">- */</span>
<a href="#l4.27"></a><span id="l4.27"> typedef struct _subscribeTreeNode {</span>
<a href="#l4.28"></a><span id="l4.28">   char *name;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-  nsCString path;</span>
<a href="#l4.30"></a><span id="l4.30">   bool isSubscribed;</span>
<a href="#l4.31"></a><span id="l4.31">   struct _subscribeTreeNode *prevSibling;</span>
<a href="#l4.32"></a><span id="l4.32">   struct _subscribeTreeNode *nextSibling;</span>
<a href="#l4.33"></a><span id="l4.33">   struct _subscribeTreeNode *firstChild;</span>
<a href="#l4.34"></a><span id="l4.34">   struct _subscribeTreeNode *lastChild;</span>
<a href="#l4.35"></a><span id="l4.35">   struct _subscribeTreeNode *parent;</span>
<a href="#l4.36"></a><span id="l4.36">   struct _subscribeTreeNode *cachedChild;</span>
<a href="#l4.37"></a><span id="l4.37"> #ifdef HAVE_SUBSCRIBE_DESCRIPTION</span>
<a href="#l4.38"></a><span id="l4.38">   char16_t *description;</span>
<a href="#l4.39"></a><span id="l4.39"> #endif</span>
<a href="#l4.40"></a><span id="l4.40"> #ifdef HAVE_SUBSCRIBE_MESSAGES</span>
<a href="#l4.41"></a><span id="l4.41">   uint32_t messages;</span>
<a href="#l4.42"></a><span id="l4.42"> #endif</span>
<a href="#l4.43"></a><span id="l4.43">   bool isSubscribable;</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-  bool isOpen;</span>
<a href="#l4.45"></a><span id="l4.45"> } SubscribeTreeNode;</span>
<a href="#l4.46"></a><span id="l4.46"> </span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+#if defined(DEBUG_sspitzer) || defined(DEBUG_seth)</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+#define DEBUG_SUBSCRIBE 1</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+#endif</span>
<a href="#l4.50"></a><span id="l4.50"> </span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-class nsSubscribableServer : public nsISubscribableServer,</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-                             public nsITreeView</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+class nsSubscribableServer : public nsISubscribableServer</span>
<a href="#l4.54"></a><span id="l4.54"> {</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-public:</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+ public:</span>
<a href="#l4.57"></a><span id="l4.57">   nsSubscribableServer();</span>
<a href="#l4.58"></a><span id="l4.58"> </span>
<a href="#l4.59"></a><span id="l4.59">   nsresult Init();</span>
<a href="#l4.60"></a><span id="l4.60"> </span>
<a href="#l4.61"></a><span id="l4.61">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l4.62"></a><span id="l4.62">   NS_DECL_NSISUBSCRIBABLESERVER</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-  NS_DECL_NSITREEVIEW</span>
<a href="#l4.64"></a><span id="l4.64"> </span>
<a href="#l4.65"></a><span id="l4.65"> private:</span>
<a href="#l4.66"></a><span id="l4.66">   virtual ~nsSubscribableServer();</span>
<a href="#l4.67"></a><span id="l4.67"> </span>
<a href="#l4.68"></a><span id="l4.68">   nsresult ConvertNameToUnichar(const char *inStr, char16_t **outStr);</span>
<a href="#l4.69"></a><span id="l4.69">   nsCOMPtr &lt;nsISubscribeListener&gt; mSubscribeListener;</span>
<a href="#l4.70"></a><span id="l4.70">   nsCString mIncomingServerUri;</span>
<a href="#l4.71"></a><span id="l4.71">   nsCOMPtr &lt;nsISubscribeDataSource&gt; mSubscribeDS;</span>
<a href="#l4.72"></a><span id="l4.72">   char mDelimiter;</span>
<a href="#l4.73"></a><span id="l4.73">   bool mShowFullName;</span>
<a href="#l4.74"></a><span id="l4.74">   bool mStopped;</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-  nsCString mServerType;</span>
<a href="#l4.76"></a><span id="l4.76"> </span>
<a href="#l4.77"></a><span id="l4.77">   nsCOMPtr &lt;nsIRDFResource&gt;      kNC_Child;</span>
<a href="#l4.78"></a><span id="l4.78">   nsCOMPtr &lt;nsIRDFResource&gt;      kNC_Subscribed;</span>
<a href="#l4.79"></a><span id="l4.79">   nsCOMPtr &lt;nsIRDFLiteral&gt;       kTrueLiteral;</span>
<a href="#l4.80"></a><span id="l4.80">   nsCOMPtr &lt;nsIRDFLiteral&gt;       kFalseLiteral;</span>
<a href="#l4.81"></a><span id="l4.81"> </span>
<a href="#l4.82"></a><span id="l4.82">   nsCOMPtr &lt;nsIRDFService&gt;       mRDFService;</span>
<a href="#l4.83"></a><span id="l4.83"> </span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-  SubscribeTreeNode *mTreeRoot;          // root of the folder tree while items are discovered on the server</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-  nsTArray&lt;SubscribeTreeNode*&gt; mRowMap;  // array of nodes representing the rows for the tree element</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-  nsCOMPtr&lt;nsITreeSelection&gt; mSelection;</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-  nsCOMPtr&lt;nsITreeBoxObject&gt; mTree;</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+  SubscribeTreeNode *mTreeRoot;</span>
<a href="#l4.89"></a><span id="l4.89">   nsresult FreeSubtree(SubscribeTreeNode *node);</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-  nsresult FreeRows();</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-  nsresult CreateNode(SubscribeTreeNode *parent, const char *name, const nsACString &amp;aPath, SubscribeTreeNode **result);</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-  nsresult AddChildNode(SubscribeTreeNode *parent, const char *name, const nsACString &amp;aPath, SubscribeTreeNode **child);</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-  nsresult FindAndCreateNode(const nsACString &amp;aPath, SubscribeTreeNode **aResult);</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+  nsresult CreateNode(SubscribeTreeNode *parent, const char *name, SubscribeTreeNode **result);</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+  nsresult AddChildNode(SubscribeTreeNode *parent, const char *name, SubscribeTreeNode **child);</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+  nsresult FindAndCreateNode(const nsACString &amp;aPath,</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+                             SubscribeTreeNode **aResult);</span>
<a href="#l4.98"></a><span id="l4.98">   nsresult NotifyAssert(SubscribeTreeNode *subjectNode, nsIRDFResource *property, SubscribeTreeNode *objectNode);</span>
<a href="#l4.99"></a><span id="l4.99">   nsresult NotifyChange(SubscribeTreeNode *subjectNode, nsIRDFResource *property, bool value);</span>
<a href="#l4.100"></a><span id="l4.100">   nsresult Notify(nsIRDFResource *subject, nsIRDFResource *property, nsIRDFNode *object, bool isAssert, bool isChange);</span>
<a href="#l4.101"></a><span id="l4.101">   void BuildURIFromNode(SubscribeTreeNode *node, nsACString &amp;uri);</span>
<a href="#l4.102"></a><span id="l4.102">   nsresult EnsureSubscribeDS();</span>
<a href="#l4.103"></a><span id="l4.103">   nsresult EnsureRDFService();</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-  int32_t GetRow(SubscribeTreeNode *node, bool *open);</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-  int32_t AddSubtree(SubscribeTreeNode *node, int32_t index);</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-};</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineminus">-class nsSubscribeListener : public nsISubscribeListener</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-{</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-public:</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-  NS_DECL_NSISUBSCRIBELISTENER</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-private:</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-  virtual ~nsSubscribeListener();</span>
<a href="#l4.116"></a><span id="l4.116"> };</span>
<a href="#l4.117"></a><span id="l4.117"> </span>
<a href="#l4.118"></a><span id="l4.118"> #endif // nsSubscribableServer_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -2987,24 +2987,16 @@ NS_IMETHODIMP</span>
<a href="#l5.4"></a><span id="l5.4"> nsImapIncomingServer::GetSupportsSubscribeSearch(bool *retVal)</span>
<a href="#l5.5"></a><span id="l5.5"> {</span>
<a href="#l5.6"></a><span id="l5.6">   NS_ENSURE_ARG_POINTER(retVal);</span>
<a href="#l5.7"></a><span id="l5.7">   *retVal = false;</span>
<a href="#l5.8"></a><span id="l5.8">   return NS_OK;</span>
<a href="#l5.9"></a><span id="l5.9"> }</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> NS_IMETHODIMP</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-nsImapIncomingServer::GetFolderView(nsITreeView **aView)</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-{</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-  nsresult rv = EnsureInner();</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-  return mInner-&gt;GetFolderView(aView);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-}</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l5.20"></a><span id="l5.20"> nsImapIncomingServer::GetFilterScope(nsMsgSearchScopeValue *filterScope)</span>
<a href="#l5.21"></a><span id="l5.21"> {</span>
<a href="#l5.22"></a><span id="l5.22">   NS_ENSURE_ARG_POINTER(filterScope);</span>
<a href="#l5.23"></a><span id="l5.23">   // If the inbox is enabled for offline use, then use the offline filter</span>
<a href="#l5.24"></a><span id="l5.24">   // scope, else use the online filter scope.</span>
<a href="#l5.25"></a><span id="l5.25">   //</span>
<a href="#l5.26"></a><span id="l5.26">   // XXX We use the same scope for all folders with the same incoming server,</span>
<a href="#l5.27"></a><span id="l5.27">   // yet it is possible to set the offline flag separately for each folder.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1691,24 +1691,16 @@ nsNntpIncomingServer::SetSearchValue(con</span>
<a href="#l6.4"></a><span id="l6.4"> NS_IMETHODIMP</span>
<a href="#l6.5"></a><span id="l6.5"> nsNntpIncomingServer::GetSupportsSubscribeSearch(bool *retVal)</span>
<a href="#l6.6"></a><span id="l6.6"> {</span>
<a href="#l6.7"></a><span id="l6.7">   *retVal = true;</span>
<a href="#l6.8"></a><span id="l6.8">   return NS_OK;</span>
<a href="#l6.9"></a><span id="l6.9"> }</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> NS_IMETHODIMP</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-nsNntpIncomingServer::GetFolderView(nsITreeView **aView)</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-{</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  nsresult rv = EnsureInner();</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-  return mInner-&gt;GetFolderView(aView);</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-}</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l6.20"></a><span id="l6.20"> nsNntpIncomingServer::GetRowCount(int32_t *aRowCount)</span>
<a href="#l6.21"></a><span id="l6.21"> {</span>
<a href="#l6.22"></a><span id="l6.22">   *aRowCount = mSubscribeSearchResult.Length();</span>
<a href="#l6.23"></a><span id="l6.23">   return NS_OK;</span>
<a href="#l6.24"></a><span id="l6.24"> }</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26"> NS_IMETHODIMP</span>
<a href="#l6.27"></a><span id="l6.27"> nsNntpIncomingServer::GetSelection(nsITreeSelection * *aSelection)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

