<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 12332:d1605239dd10fc460a0e6eb7fbef20111e1a66c8</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ d1605239dd10fc460a0e6eb7fbef20111e1a66c8" />
<meta property="og:url" content="/comm-central/rev/d1605239dd10fc460a0e6eb7fbef20111e1a66c8" />
<meta property="og:description" content="Fix bug 861620 - Improve test coverage in backend components. r=mmecca" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / d1605239dd10fc460a0e6eb7fbef20111e1a66c8 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/d1605239dd10fc460a0e6eb7fbef20111e1a66c8">shortlog</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/d1605239dd10fc460a0e6eb7fbef20111e1a66c8">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8">files</a> |
changeset |
<a href="/comm-central/raw-rev/d1605239dd10fc460a0e6eb7fbef20111e1a66c8">raw</a>  | <a href="/comm-central/archive/d1605239dd10fc460a0e6eb7fbef20111e1a66c8.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=861620">bug 861620</a> - Improve test coverage in backend components. r=mmecca
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 23 Apr 2013 19:58:24 +0200</td></tr>

<tr>
 <td>changeset 12332</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/d1605239dd10fc460a0e6eb7fbef20111e1a66c8">d1605239dd10fc460a0e6eb7fbef20111e1a66c8</a></td>
</tr>



<tr>
<td>parent 12331</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c2c419ac7ebe09508e3e124eded71883c3e45630">c2c419ac7ebe09508e3e124eded71883c3e45630</a>
</td>
</tr>

<tr>
<td>child 12333</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d45b873dc078298bdbbc3319a7b48c073611768b">d45b873dc078298bdbbc3319a7b48c073611768b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=d1605239dd10fc460a0e6eb7fbef20111e1a66c8">9120</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Sat, 27 Apr 2013 21:31:13 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0d7306fe5d6f [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0d7306fe5d6f904fb6f9e7f217b4ccda16167ee6">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0d7306fe5d6f904fb6f9e7f217b4ccda16167ee6&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0d7306fe5d6f904fb6f9e7f217b4ccda16167ee6&newProject=comm-central&newRevision=d1605239dd10fc460a0e6eb7fbef20111e1a66c8&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0d7306fe5d6f904fb6f9e7f217b4ccda16167ee6&newProject=comm-central&newRevision=d1605239dd10fc460a0e6eb7fbef20111e1a66c8&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0d7306fe5d6f904fb6f9e7f217b4ccda16167ee6&newProject=comm-central&newRevision=d1605239dd10fc460a0e6eb7fbef20111e1a66c8&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mmecca%29&revcount=50">mmecca</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=861620">861620</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=861620">bug 861620</a> - Improve test coverage in backend components. r=mmecca</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/head_consts.js">calendar/test/unit/head_consts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/head_consts.js">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/head_consts.js">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/head_consts.js">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/head_consts.js">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/head_consts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_alarm.js">calendar/test/unit/test_alarm.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_alarm.js">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_alarm.js">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_alarm.js">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_alarm.js">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_alarm.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_attachment.js">calendar/test/unit/test_attachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_attachment.js">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_attachment.js">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_attachment.js">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_attachment.js">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_attachment.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_attendee.js">calendar/test/unit/test_attendee.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_attendee.js">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_attendee.js">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_attendee.js">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_attendee.js">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_attendee.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_bug494140.js">calendar/test/unit/test_bug494140.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_bug494140.js">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_bug494140.js">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_bug494140.js">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_bug494140.js">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_bug494140.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_datetime.js">calendar/test/unit/test_datetime.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_datetime.js">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_datetime.js">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_datetime.js">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_datetime.js">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_datetime.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_deleted_items.js">calendar/test/unit/test_deleted_items.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_deleted_items.js">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_deleted_items.js">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_deleted_items.js">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_deleted_items.js">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_deleted_items.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_duration.js">calendar/test/unit/test_duration.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_duration.js">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_duration.js">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_duration.js">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_duration.js">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_duration.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_freebusy.js">calendar/test/unit/test_freebusy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_freebusy.js">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_freebusy.js">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_freebusy.js">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_freebusy.js">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_freebusy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_freebusy_service.js">calendar/test/unit/test_freebusy_service.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_freebusy_service.js">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_freebusy_service.js">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_freebusy_service.js">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_freebusy_service.js">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_freebusy_service.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_ics.js">calendar/test/unit/test_ics.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_ics.js">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_ics.js">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_ics.js">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_ics.js">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_ics.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_ics_parser.js">calendar/test/unit/test_ics_parser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_ics_parser.js">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_ics_parser.js">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_ics_parser.js">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_ics_parser.js">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_ics_parser.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_ics_service.js">calendar/test/unit/test_ics_service.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_ics_service.js">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_ics_service.js">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_ics_service.js">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_ics_service.js">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_ics_service.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_items.js">calendar/test/unit/test_items.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_items.js">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_items.js">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_items.js">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_items.js">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_items.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_recur.js">calendar/test/unit/test_recur.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_recur.js">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_recur.js">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_recur.js">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_recur.js">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_recur.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_relation.js">calendar/test/unit/test_relation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_relation.js">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_relation.js">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_relation.js">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_relation.js">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_relation.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_search_service.js">calendar/test/unit/test_search_service.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_search_service.js">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_search_service.js">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_search_service.js">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_search_service.js">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_search_service.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_startup_service.js">calendar/test/unit/test_startup_service.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_startup_service.js">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_startup_service.js">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_startup_service.js">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_startup_service.js">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_startup_service.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_utils.js">calendar/test/unit/test_utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_utils.js">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_utils.js">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_utils.js">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_utils.js">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/test_utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/xpcshell.ini">calendar/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/d1605239dd10fc460a0e6eb7fbef20111e1a66c8/calendar/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/test/unit/head_consts.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/test/unit/head_consts.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,22 +1,26 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.5"></a><span id="l1.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.6"></a><span id="l1.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+Components.utils.import(&quot;resource://testing-common/AppInfo.jsm&quot;);</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+updateAppInfo();</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12"> const Cc = Components.classes;</span>
<a href="#l1.13"></a><span id="l1.13"> const Ci = Components.interfaces;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> (function load_lightning_manifest() {</span>
<a href="#l1.17"></a><span id="l1.17">   let bindir = Services.dirsvc.get(&quot;CurProcD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l1.18"></a><span id="l1.18">   bindir.append(&quot;extensions&quot;);</span>
<a href="#l1.19"></a><span id="l1.19">   bindir.append(&quot;{e2fda1a4-762b-4020-b5ad-a41df1933103}&quot;);</span>
<a href="#l1.20"></a><span id="l1.20">   bindir.append(&quot;chrome.manifest&quot;);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+  dump(&quot;Loading&quot; + bindir.path + &quot;\n&quot;);</span>
<a href="#l1.22"></a><span id="l1.22">   Components.manager.autoRegister(bindir);</span>
<a href="#l1.23"></a><span id="l1.23"> })();</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27"> // we might want to use calUtils.jsm only in the future throughout all tests,</span>
<a href="#l1.28"></a><span id="l1.28"> // but for now source in good old calUtils.js:</span>
<a href="#l1.29"></a><span id="l1.29"> cal.loadScripts([&quot;calUtils.js&quot;], Components.utils.getGlobalForObject(Cc));</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineat">@@ -199,19 +203,23 @@ function compareItemsSpecific(aLeftItem,</span>
<a href="#l1.31"></a><span id="l1.31"> function do_check_throws(func, result, stack)</span>
<a href="#l1.32"></a><span id="l1.32"> {</span>
<a href="#l1.33"></a><span id="l1.33">   if (!stack)</span>
<a href="#l1.34"></a><span id="l1.34">     stack = Components.stack.caller;</span>
<a href="#l1.35"></a><span id="l1.35"> </span>
<a href="#l1.36"></a><span id="l1.36">   try {</span>
<a href="#l1.37"></a><span id="l1.37">     func();</span>
<a href="#l1.38"></a><span id="l1.38">   } catch (exc) {</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-    if (exc.result == result)</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+    if (exc.result == result || exc == result) {</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+      ++_passedChecks;</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+      dump(&quot;TEST-PASS | &quot; + stack.filename + &quot; | [&quot; + stack.name + &quot; : &quot; +</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+           stack.lineNumber + &quot;] &quot; + exc.result + &quot; == &quot; + result + &quot;\n&quot;);</span>
<a href="#l1.44"></a><span id="l1.44">       return;</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-    do_throw(&quot;expected result &quot; + result + &quot;, caught &quot; + exc, stack);</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+    }</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+    do_throw(&quot;expected result &quot; + result + &quot;, caught &quot; + (exc.result || exc), stack);</span>
<a href="#l1.48"></a><span id="l1.48">   }</span>
<a href="#l1.49"></a><span id="l1.49"> </span>
<a href="#l1.50"></a><span id="l1.50">   if (result) {</span>
<a href="#l1.51"></a><span id="l1.51">     do_throw(&quot;expected result &quot; + result + &quot;, none thrown&quot;, stack);</span>
<a href="#l1.52"></a><span id="l1.52">   }</span>
<a href="#l1.53"></a><span id="l1.53"> }</span>
<a href="#l1.54"></a><span id="l1.54"> </span>
<a href="#l1.55"></a><span id="l1.55"> function ics_foldline(aLine) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/test/unit/test_alarm.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/test/unit/test_alarm.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -11,21 +11,23 @@ function run_test() {</span>
<a href="#l2.4"></a><span id="l2.4">     test_custom_alarm();</span>
<a href="#l2.5"></a><span id="l2.5">     test_repeat();</span>
<a href="#l2.6"></a><span id="l2.6">     test_xprop();</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">     test_dates();</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10">     test_clone();</span>
<a href="#l2.11"></a><span id="l2.11">     test_immutable();</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    test_serialize();</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    test_strings();</span>
<a href="#l2.14"></a><span id="l2.14"> }</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16"> function test_initial_creation() {</span>
<a href="#l2.17"></a><span id="l2.17">     dump(&quot;Testing initial creation...&quot;);</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-    alarm = cal.createAlarm();</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+    let alarm = cal.createAlarm();</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21">     let passed;</span>
<a href="#l2.22"></a><span id="l2.22">     try {</span>
<a href="#l2.23"></a><span id="l2.23">         alarm.icalString;</span>
<a href="#l2.24"></a><span id="l2.24">         passed = false;</span>
<a href="#l2.25"></a><span id="l2.25">     } catch (e) {</span>
<a href="#l2.26"></a><span id="l2.26">         passed = true;</span>
<a href="#l2.27"></a><span id="l2.27">     }</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineat">@@ -49,20 +51,25 @@ function test_display_alarm() {</span>
<a href="#l2.29"></a><span id="l2.29">     // SUMMARY is not valid for ACTION:DISPLAY</span>
<a href="#l2.30"></a><span id="l2.30">     alarm.summary = &quot;test&quot;;</span>
<a href="#l2.31"></a><span id="l2.31">     do_check_eq(alarm.summary, null);</span>
<a href="#l2.32"></a><span id="l2.32"> </span>
<a href="#l2.33"></a><span id="l2.33">     // No attendees allowed</span>
<a href="#l2.34"></a><span id="l2.34">     let attendee = cal.createAttendee();</span>
<a href="#l2.35"></a><span id="l2.35">     attendee.id = &quot;mailto:horst&quot;;</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-    try {</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+        // DISPLAY alarm should not be able to save attendees</span>
<a href="#l2.40"></a><span id="l2.40">         alarm.addAttendee(attendee);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-        do_throw(&quot;DISPLAY alarm should not be able to save attendees&quot;);</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-    } catch (e) {}</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+    }, Components.results.NS_ERROR_XPC_JS_THREW_JS_OBJECT);</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+        // DISPLAY alarm should not be able to save attachment</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+        alarm.addAttachment(cal.createAttachment());</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+    }, Components.results.NS_ERROR_XPC_JS_THREW_JS_OBJECT);</span>
<a href="#l2.49"></a><span id="l2.49"> </span>
<a href="#l2.50"></a><span id="l2.50">     dump(&quot;Done\n&quot;);</span>
<a href="#l2.51"></a><span id="l2.51"> }</span>
<a href="#l2.52"></a><span id="l2.52"> </span>
<a href="#l2.53"></a><span id="l2.53"> function test_email_alarm() {</span>
<a href="#l2.54"></a><span id="l2.54">     dump(&quot;Testing EMAIL alarms...&quot;);</span>
<a href="#l2.55"></a><span id="l2.55">     let alarm = cal.createAlarm();</span>
<a href="#l2.56"></a><span id="l2.56">     // Set ACTION to DISPLAY, make sure this was not rejected</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineat">@@ -72,16 +79,20 @@ function test_email_alarm() {</span>
<a href="#l2.58"></a><span id="l2.58">     // Set a Description, REQUIRED for ACTION:EMAIL</span>
<a href="#l2.59"></a><span id="l2.59">     alarm.description = &quot;description&quot;;</span>
<a href="#l2.60"></a><span id="l2.60">     do_check_eq(alarm.description, &quot;description&quot;);</span>
<a href="#l2.61"></a><span id="l2.61"> </span>
<a href="#l2.62"></a><span id="l2.62">     // Set a Summary, REQUIRED for ACTION:EMAIL</span>
<a href="#l2.63"></a><span id="l2.63">     alarm.summary = &quot;summary&quot;;</span>
<a href="#l2.64"></a><span id="l2.64">     do_check_eq(alarm.summary, &quot;summary&quot;);</span>
<a href="#l2.65"></a><span id="l2.65"> </span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+    // Set an offset of some sort</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+    alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+    alarm.offset = cal.createDuration();</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+</span>
<a href="#l2.70"></a><span id="l2.70">     // Check for at least one attendee</span>
<a href="#l2.71"></a><span id="l2.71">     let attendee1 = cal.createAttendee();</span>
<a href="#l2.72"></a><span id="l2.72">     attendee1.id = &quot;mailto:horst&quot;;</span>
<a href="#l2.73"></a><span id="l2.73">     let attendee2 = cal.createAttendee();</span>
<a href="#l2.74"></a><span id="l2.74">     attendee2.id = &quot;mailto:gustav&quot;;</span>
<a href="#l2.75"></a><span id="l2.75"> </span>
<a href="#l2.76"></a><span id="l2.76">     do_check_eq(alarm.getAttendees({}).length, 0);</span>
<a href="#l2.77"></a><span id="l2.77">     alarm.addAttendee(attendee1);</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineat">@@ -89,16 +100,19 @@ function test_email_alarm() {</span>
<a href="#l2.79"></a><span id="l2.79">     alarm.addAttendee(attendee2);</span>
<a href="#l2.80"></a><span id="l2.80">     do_check_eq(alarm.getAttendees({}).length, 2);</span>
<a href="#l2.81"></a><span id="l2.81">     alarm.addAttendee(attendee1);</span>
<a href="#l2.82"></a><span id="l2.82">     let addedAttendees = alarm.getAttendees({});</span>
<a href="#l2.83"></a><span id="l2.83">     do_check_eq(addedAttendees.length, 2);</span>
<a href="#l2.84"></a><span id="l2.84">     do_check_eq(addedAttendees[0], attendee2);</span>
<a href="#l2.85"></a><span id="l2.85">     do_check_eq(addedAttendees[1], attendee1);</span>
<a href="#l2.86"></a><span id="l2.86"> </span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+    do_check_true(!!alarm.icalComponent.serializeToICS().match(/mailto:horst/));</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+    do_check_true(!!alarm.icalComponent.serializeToICS().match(/mailto:gustav/));</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+</span>
<a href="#l2.90"></a><span id="l2.90">     alarm.deleteAttendee(attendee1);</span>
<a href="#l2.91"></a><span id="l2.91">     do_check_eq(alarm.getAttendees({}).length, 1);</span>
<a href="#l2.92"></a><span id="l2.92"> </span>
<a href="#l2.93"></a><span id="l2.93">     alarm.clearAttendees();</span>
<a href="#l2.94"></a><span id="l2.94">     do_check_eq(alarm.getAttendees({}).length, 0);</span>
<a href="#l2.95"></a><span id="l2.95"> </span>
<a href="#l2.96"></a><span id="l2.96">     // TODO test attachments</span>
<a href="#l2.97"></a><span id="l2.97">     dump(&quot;Done\n&quot;);</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineat">@@ -125,16 +139,21 @@ function test_audio_alarm() {</span>
<a href="#l2.99"></a><span id="l2.99">     let attendee = cal.createAttendee();</span>
<a href="#l2.100"></a><span id="l2.100">     attendee.id = &quot;mailto:horst&quot;;</span>
<a href="#l2.101"></a><span id="l2.101"> </span>
<a href="#l2.102"></a><span id="l2.102">     try {</span>
<a href="#l2.103"></a><span id="l2.103">         alarm.addAttendee(attendee);</span>
<a href="#l2.104"></a><span id="l2.104">         do_throw(&quot;AUDIO alarm should not be able to save attendees&quot;);</span>
<a href="#l2.105"></a><span id="l2.105">     } catch (e) {}</span>
<a href="#l2.106"></a><span id="l2.106"> </span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+    // No attendee yet, should not be initialized</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+        alarm.icalComponent;</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+    }, Components.results.NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+</span>
<a href="#l2.112"></a><span id="l2.112">     // Test attachments</span>
<a href="#l2.113"></a><span id="l2.113">     let sound = cal.createAttachment();</span>
<a href="#l2.114"></a><span id="l2.114">     sound.uri = makeURL(&quot;file:///sound.wav&quot;);</span>
<a href="#l2.115"></a><span id="l2.115">     let sound2 = cal.createAttachment();</span>
<a href="#l2.116"></a><span id="l2.116">     sound2.uri = makeURL(&quot;file:///sound2.wav&quot;);</span>
<a href="#l2.117"></a><span id="l2.117"> </span>
<a href="#l2.118"></a><span id="l2.118">     // Adding an attachment should work</span>
<a href="#l2.119"></a><span id="l2.119">     alarm.addAttachment(sound);</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineat">@@ -252,31 +271,56 @@ function test_repeat() {</span>
<a href="#l2.121"></a><span id="l2.121"> </span>
<a href="#l2.122"></a><span id="l2.122">     // Should be able to unset alarm DURATION attribute. (REPEAT already tested above)</span>
<a href="#l2.123"></a><span id="l2.123">     try {</span>
<a href="#l2.124"></a><span id="l2.124">         alarm.repeatOffset = null;</span>
<a href="#l2.125"></a><span id="l2.125">     } catch (e) {</span>
<a href="#l2.126"></a><span id="l2.126">         do_throw(&quot;Could not set repeatOffset attribute to null&quot; + e);</span>
<a href="#l2.127"></a><span id="l2.127">     }</span>
<a href="#l2.128"></a><span id="l2.128"> </span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-    // Check final value</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+    // Check unset value</span>
<a href="#l2.131"></a><span id="l2.131">     do_check_eq(alarm.repeat, 0);</span>
<a href="#l2.132"></a><span id="l2.132">     do_check_eq(alarm.repeatOffset, null);</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+    // Check repeatDate</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+    alarm = cal.createAlarm();</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+    alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+    alarm.alarmDate = cal.createDateTime();</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+    alarm.repeat = 1;</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+    alarm.repeatOffset = cal.createDuration();</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+    alarm.repeatOffset.inSeconds = 3600;</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+    let dt = alarm.alarmDate.clone();</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+    dt.second += 3600;</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+    do_check_eq(alarm.repeatDate.icalString, dt.icalString);</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+</span>
<a href="#l2.146"></a><span id="l2.146">     dump(&quot;Done\n&quot;);</span>
<a href="#l2.147"></a><span id="l2.147"> }</span>
<a href="#l2.148"></a><span id="l2.148"> </span>
<a href="#l2.149"></a><span id="l2.149"> function test_xprop() {</span>
<a href="#l2.150"></a><span id="l2.150">     dump(&quot;Testing X-Props...&quot;);</span>
<a href="#l2.151"></a><span id="l2.151">     let alarm = cal.createAlarm();</span>
<a href="#l2.152"></a><span id="l2.152">     alarm.setProperty(&quot;X-PROP&quot;, &quot;X-VALUE&quot;);</span>
<a href="#l2.153"></a><span id="l2.153">     do_check_true(alarm.hasProperty(&quot;X-PROP&quot;));</span>
<a href="#l2.154"></a><span id="l2.154">     do_check_eq(alarm.getProperty(&quot;X-PROP&quot;), &quot;X-VALUE&quot;);</span>
<a href="#l2.155"></a><span id="l2.155">     alarm.deleteProperty(&quot;X-PROP&quot;);</span>
<a href="#l2.156"></a><span id="l2.156">     do_check_false(alarm.hasProperty(&quot;X-PROP&quot;));</span>
<a href="#l2.157"></a><span id="l2.157">     do_check_eq(alarm.getProperty(&quot;X-PROP&quot;), null);</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+    // also check X-MOZ-LASTACK prop</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+    let dt = cal.createDateTime();</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+    alarm.setProperty(&quot;X-MOZ-LASTACK&quot;, dt.icalString);</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+    alarm.action = &quot;DISPLAY&quot;;</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+    alarm.description = &quot;test&quot;;</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+    alarm.related = Ci.calIAlarm.ALARM_RELATED_START</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+    alarm.offset = createDuration(&quot;-PT5M&quot;);</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+    do_check_true(alarm.icalComponent.serializeToICS().indexOf(dt.icalString) &gt; -1);</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+    alarm.deleteProperty(&quot;X-MOZ-LASTACK&quot;);</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+    do_check_false(alarm.icalComponent.serializeToICS().indexOf(dt.icalString) &gt; -1);</span>
<a href="#l2.170"></a><span id="l2.170">     dump(&quot;Done\n&quot;);</span>
<a href="#l2.171"></a><span id="l2.171"> }</span>
<a href="#l2.172"></a><span id="l2.172"> </span>
<a href="#l2.173"></a><span id="l2.173"> function test_dates() {</span>
<a href="#l2.174"></a><span id="l2.174">     dump(&quot;Testing alarm dates...&quot;);</span>
<a href="#l2.175"></a><span id="l2.175">     let passed;</span>
<a href="#l2.176"></a><span id="l2.176">     // Initial value</span>
<a href="#l2.177"></a><span id="l2.177">     let alarm = cal.createAlarm();</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineat">@@ -309,16 +353,17 @@ function test_dates() {</span>
<a href="#l2.179"></a><span id="l2.179">         alarm.offset = createDuration();</span>
<a href="#l2.180"></a><span id="l2.180">         passed = false;</span>
<a href="#l2.181"></a><span id="l2.181">     } catch (e) {</span>
<a href="#l2.182"></a><span id="l2.182">         passed = true;</span>
<a href="#l2.183"></a><span id="l2.183">     }</span>
<a href="#l2.184"></a><span id="l2.184">     if (!passed) {</span>
<a href="#l2.185"></a><span id="l2.185">         do_throw(&quot;Setting offset when alarm is absolute should not succeed&quot;);</span>
<a href="#l2.186"></a><span id="l2.186">     }</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+</span>
<a href="#l2.188"></a><span id="l2.188">     dump(&quot;Done\n&quot;);</span>
<a href="#l2.189"></a><span id="l2.189"> }</span>
<a href="#l2.190"></a><span id="l2.190"> </span>
<a href="#l2.191"></a><span id="l2.191"> let propMap = { &quot;related&quot;: Ci.calIAlarm.ALARM_RELATED_START,</span>
<a href="#l2.192"></a><span id="l2.192">                 &quot;repeat&quot;: 1,</span>
<a href="#l2.193"></a><span id="l2.193">                 &quot;action&quot;: &quot;X-TEST&quot;,</span>
<a href="#l2.194"></a><span id="l2.194">                 &quot;description&quot;: &quot;description&quot;,</span>
<a href="#l2.195"></a><span id="l2.195">                 &quot;summary&quot;: &quot;summary&quot;,</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineat">@@ -331,66 +376,73 @@ let clonePropMap = { &quot;related&quot;: Ci.calIA</span>
<a href="#l2.197"></a><span id="l2.197">                      &quot;description&quot;: &quot;description-changed&quot;,</span>
<a href="#l2.198"></a><span id="l2.198">                      &quot;summary&quot;: &quot;summary-changed&quot;,</span>
<a href="#l2.199"></a><span id="l2.199">                      &quot;offset&quot;: createDuration(&quot;PT5M&quot;),</span>
<a href="#l2.200"></a><span id="l2.200">                      &quot;repeatOffset&quot;: createDuration(&quot;PT2M&quot;)</span>
<a href="#l2.201"></a><span id="l2.201"> };</span>
<a href="#l2.202"></a><span id="l2.202"> function test_immutable() {</span>
<a href="#l2.203"></a><span id="l2.203"> </span>
<a href="#l2.204"></a><span id="l2.204">     dump(&quot;Testing immutable alarms...&quot;);</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+    let alarm = cal.createAlarm();</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+    // Set up each attribute</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+    for (let prop in propMap) {</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+        alarm[prop] = propMap[prop];</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+    }</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineplus">+    // Set up some extra props</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineplus">+    alarm.setProperty(&quot;X-FOO&quot;, &quot;X-VAL&quot;);</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+    alarm.setProperty(&quot;X-DATEPROP&quot;, cal.createDateTime());</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+    alarm.addAttendee(cal.createAttendee());</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineplus">+</span>
<a href="#l2.216"></a><span id="l2.216">     let passed = false;</span>
<a href="#l2.217"></a><span id="l2.217">     // Initial checks</span>
<a href="#l2.218"></a><span id="l2.218">     do_check_true(alarm.isMutable);</span>
<a href="#l2.219"></a><span id="l2.219">     alarm.makeImmutable();</span>
<a href="#l2.220"></a><span id="l2.220">     do_check_false(alarm.isMutable);</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+    alarm.makeImmutable();</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+    do_check_false(alarm.isMutable);</span>
<a href="#l2.223"></a><span id="l2.223"> </span>
<a href="#l2.224"></a><span id="l2.224">     // Check each attribute</span>
<a href="#l2.225"></a><span id="l2.225">     for (let prop in propMap) {</span>
<a href="#l2.226"></a><span id="l2.226">         try {</span>
<a href="#l2.227"></a><span id="l2.227">             alarm[prop] = propMap[prop];</span>
<a href="#l2.228"></a><span id="l2.228">         } catch (e) {</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineminus">-            // XXX do_check_eq(e.result, Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+            do_check_eq(e.result, Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l2.231"></a><span id="l2.231">             continue;</span>
<a href="#l2.232"></a><span id="l2.232">         }</span>
<a href="#l2.233"></a><span id="l2.233">         do_throw(&quot;Attribute &quot; + prop + &quot; was writable while item was immutable&quot;);</span>
<a href="#l2.234"></a><span id="l2.234">     }</span>
<a href="#l2.235"></a><span id="l2.235"> </span>
<a href="#l2.236"></a><span id="l2.236">     // Functions</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">-    try {</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-        alarm.setProperty(&quot;X-FOO&quot;, &quot;BAR&quot;);</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-        passed = false;</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">-    } catch (e) {</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-        passed = true</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineminus">-    }</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineminus">-</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineminus">-    if (!passed) {</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineminus">-        do_throw(&quot;setProperty succeeded while item was immutable&quot;);</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineminus">-    }</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+        alarm.setProperty(&quot;X-FOO&quot;, &quot;changed&quot;);</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+    }, Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l2.250"></a><span id="l2.250"> </span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-    try {</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l2.253"></a><span id="l2.253">         alarm.deleteProperty(&quot;X-FOO&quot;);</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-        passed = false;</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-    } catch (e) {</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-        passed = true;</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineminus">-        do_check_eq(e.result, Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineminus">-    }</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineplus">+    }, Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l2.260"></a><span id="l2.260"> </span>
<a href="#l2.261"></a><span id="l2.261" class="difflineminus">-    if (!passed) {</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineminus">-        do_throw(&quot;setProperty succeeded while item was immutable&quot;);</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-    }</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineplus">+    do_check_false(alarm.getProperty(&quot;X-DATEPROP&quot;).isMutable);</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineplus">+</span>
<a href="#l2.266"></a><span id="l2.266">     dump(&quot;Done\n&quot;);</span>
<a href="#l2.267"></a><span id="l2.267"> }</span>
<a href="#l2.268"></a><span id="l2.268"> </span>
<a href="#l2.269"></a><span id="l2.269"> function test_clone() {</span>
<a href="#l2.270"></a><span id="l2.270">     dump(&quot;Testing cloning alarms...&quot;);</span>
<a href="#l2.271"></a><span id="l2.271">     let alarm = cal.createAlarm();</span>
<a href="#l2.272"></a><span id="l2.272">     // Set up each attribute</span>
<a href="#l2.273"></a><span id="l2.273">     for (let prop in propMap) {</span>
<a href="#l2.274"></a><span id="l2.274">         alarm[prop] = propMap[prop];</span>
<a href="#l2.275"></a><span id="l2.275">     }</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineplus">+</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineplus">+    // Set up some extra props</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineplus">+    alarm.setProperty(&quot;X-FOO&quot;, &quot;X-VAL&quot;);</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineplus">+    alarm.setProperty(&quot;X-DATEPROP&quot;, cal.createDateTime());</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+    alarm.addAttendee(cal.createAttendee());</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+</span>
<a href="#l2.282"></a><span id="l2.282">     // Make a copy</span>
<a href="#l2.283"></a><span id="l2.283">     let newAlarm = alarm.clone();</span>
<a href="#l2.284"></a><span id="l2.284">     newAlarm.makeImmutable();</span>
<a href="#l2.285"></a><span id="l2.285">     newAlarm = newAlarm.clone();</span>
<a href="#l2.286"></a><span id="l2.286">     do_check_true(newAlarm.isMutable);</span>
<a href="#l2.287"></a><span id="l2.287"> </span>
<a href="#l2.288"></a><span id="l2.288">     // Check if item is still the same</span>
<a href="#l2.289"></a><span id="l2.289">     // TODO This is not quite optimal, maybe someone can find a better way to do</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineat">@@ -411,10 +463,122 @@ function test_clone() {</span>
<a href="#l2.291"></a><span id="l2.291">     // Check if changes on the cloned object do not affect the original object.</span>
<a href="#l2.292"></a><span id="l2.292">     for (let prop in clonePropMap) {</span>
<a href="#l2.293"></a><span id="l2.293">         newAlarm[prop] = clonePropMap[prop];</span>
<a href="#l2.294"></a><span id="l2.294">         dump(&quot;Checking &quot; + prop + &quot;...&quot;);</span>
<a href="#l2.295"></a><span id="l2.295">         do_check_neq(alarm[prop], newAlarm[prop]);</span>
<a href="#l2.296"></a><span id="l2.296">         dump(&quot;OK!\n&quot;);</span>
<a href="#l2.297"></a><span id="l2.297">         break;</span>
<a href="#l2.298"></a><span id="l2.298">     }</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+    // Check x props</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+    alarm.setProperty(&quot;X-FOO&quot;, &quot;BAR&quot;);</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+    do_check_eq(alarm.getProperty(&quot;X-FOO&quot;), &quot;BAR&quot;);</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineplus">+    let dt = alarm.getProperty(&quot;X-DATEPROP&quot;);</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineplus">+    do_check_eq(dt.isMutable, true);</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineplus">+</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineplus">+    // Test xprop params</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineplus">+    alarm.icalString =</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineplus">+        &quot;BEGIN:VALARM\n&quot; +</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+        &quot;ACTION:DISPLAY\n&quot; +</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+        &quot;TRIGGER:-PT15M\n&quot; +</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+        &quot;X-FOO;X-PARAM=PARAMVAL:BAR\n&quot; +</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+        &quot;DESCRIPTION:TEST\n&quot; +</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+        &quot;END:VALARM&quot;;</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineplus">+</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineplus">+    newAlarm = alarm.clone();</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineplus">+    do_check_eq(alarm.icalString, newAlarm.icalString);</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+</span>
<a href="#l2.318"></a><span id="l2.318">     dump(&quot;Done\n&quot;);</span>
<a href="#l2.319"></a><span id="l2.319"> }</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineplus">+</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineplus">+function test_serialize() {</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineplus">+    // most checks done by other tests, these don't fit into categories</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineplus">+    let alarm = cal.createAlarm();</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineplus">+    let srv = cal.getIcsService();</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineplus">+        alarm.icalComponent = srv.createIcalComponent(&quot;BARF&quot;);</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineplus">+    }, Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineplus">+</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineplus">+    function addProp(k,v) { let p = srv.createIcalProperty(k); p.value = v; comp.addProperty(p) }</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineplus">+    function addActionDisplay() addProp(&quot;ACTION&quot;, &quot;DISPLAY&quot;);</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+    function addActionEmail() addProp(&quot;ACTION&quot;, &quot;EMAIL&quot;);</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+    function addTrigger() addProp(&quot;TRIGGER&quot;, &quot;-PT15M&quot;);</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineplus">+    function addDescr() addProp(&quot;DESCRIPTION&quot;, &quot;TEST&quot;);</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineplus">+    function addDuration() addProp(&quot;DURATION&quot;, &quot;-PT15M&quot;);</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineplus">+    function addRepeat() addProp(&quot;REPEAT&quot;, &quot;1&quot;);</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+    function addAttendee() addProp(&quot;ATTENDEE&quot;, &quot;mailto:horst&quot;);</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+    function addAttachment() addProp(&quot;ATTACH&quot;, &quot;data:yeah&quot;);</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineplus">+</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineplus">+    // All is there, should not throw</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineplus">+    let comp = srv.createIcalComponent(&quot;VALARM&quot;);</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineplus">+    addActionDisplay(); addTrigger(); addDescr(); addDuration(); addRepeat();</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+    alarm.icalComponent = comp;</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineplus">+    alarm.toString();</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineplus">+</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+    // Attachments and attendees</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+    let comp = srv.createIcalComponent(&quot;VALARM&quot;);</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+    addActionEmail(); addTrigger(); addDescr();</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineplus">+    addAttendee(); addAttachment();</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+    alarm.icalComponent = comp;</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+    alarm.toString();</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineplus">+</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineplus">+    // Missing action</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineplus">+        comp = srv.createIcalComponent(&quot;VALARM&quot;);</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineplus">+        addTrigger(); addDescr();</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineplus">+        alarm.icalComponent = comp;</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineplus">+    }, Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineplus">+</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineplus">+    // Missing trigger</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineplus">+        comp = srv.createIcalComponent(&quot;VALARM&quot;);</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineplus">+        addActionDisplay(); addDescr();</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineplus">+        alarm.icalComponent = comp;</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineplus">+    }, Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineplus">+</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineplus">+    // Missing duration with repeat</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineplus">+        comp = srv.createIcalComponent(&quot;VALARM&quot;);</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineplus">+        addActionDisplay(); addTrigger(); addDescr();</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineplus">+        addRepeat();</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+        alarm.icalComponent = comp;</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineplus">+    }, Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineplus">+</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+    // Missing repeat with duration</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineplus">+        comp = srv.createIcalComponent(&quot;VALARM&quot;);</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineplus">+        addActionDisplay(); addTrigger(); addDescr();</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+        addDuration();</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineplus">+        alarm.icalComponent = comp;</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineplus">+    }, Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineplus">+</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineplus">+}</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineplus">+</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineplus">+function test_strings() {</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineplus">+    // Serializing the string shouldn't throw, but we don't really care about</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineplus">+    // the string itself.</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineplus">+    let alarm = cal.createAlarm();</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineplus">+    alarm.action = &quot;DISPLAY&quot;;</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+    alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineplus">+    alarm.alarmDate = cal.createDateTime();</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineplus">+    alarm.toString();</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineplus">+    alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineplus">+    alarm.offset = cal.createDuration();</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineplus">+    alarm.toString();</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineplus">+    alarm.toString(cal.createTodo());</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineplus">+</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineplus">+    alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_END;</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineplus">+    alarm.offset = cal.createDuration();</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineplus">+    alarm.toString();</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineplus">+    alarm.toString(cal.createTodo());</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineplus">+</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineplus">+    alarm.offset = cal.createDuration(&quot;P1D&quot;);</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineplus">+    alarm.toString();</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineplus">+</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineplus">+    alarm.offset = cal.createDuration(&quot;PT1H&quot;);</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineplus">+    alarm.toString();</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineplus">+</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineplus">+    alarm.offset = cal.createDuration(&quot;-PT1H&quot;);</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineplus">+    alarm.toString();</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/test/unit/test_attachment.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/test/unit/test_attachment.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,15 +1,16 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> function run_test() {</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+    test_serialize();</span>
<a href="#l3.12"></a><span id="l3.12">     test_hashes();</span>
<a href="#l3.13"></a><span id="l3.13">     test_uriattach();</span>
<a href="#l3.14"></a><span id="l3.14">     test_binaryattach();</span>
<a href="#l3.15"></a><span id="l3.15"> }</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> function test_hashes() {</span>
<a href="#l3.18"></a><span id="l3.18">     let attach = cal.createAttachment();</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20" class="difflineat">@@ -49,29 +50,63 @@ function test_uriattach() {</span>
<a href="#l3.21"></a><span id="l3.21">     do_check_eq(attach.rawData, &quot;http://hello&quot;);</span>
<a href="#l3.22"></a><span id="l3.22"> }</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24"> function test_binaryattach() {</span>
<a href="#l3.25"></a><span id="l3.25">     let attach = cal.createAttachment();</span>
<a href="#l3.26"></a><span id="l3.26">     let e = cal.createEvent();</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28">     let attachString =</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-        &quot;ATTACH;VALUE=BINARY;ENCODING=BASE64;FMTTYPE=x-moz/test2:aHR0cDovL2hlbGxvMg\r\n&quot; +</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-        &quot; ==\r\n&quot;;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+        &quot;ATTACH;ENCODING=BASE64;FMTTYPE=x-moz/test2;VALUE=BINARY:aHR0cDovL2hlbGxvMg==\r\n&quot;;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+    let foldedAttachString = ics_foldline(attachString);</span>
<a href="#l3.33"></a><span id="l3.33">     let icalString =</span>
<a href="#l3.34"></a><span id="l3.34">         &quot;BEGIN:VEVENT\r\n&quot; +</span>
<a href="#l3.35"></a><span id="l3.35">         attachString +</span>
<a href="#l3.36"></a><span id="l3.36">         &quot;END:VEVENT&quot;;</span>
<a href="#l3.37"></a><span id="l3.37">     e.icalString = icalString;</span>
<a href="#l3.38"></a><span id="l3.38">     let prop = e.icalComponent.getFirstProperty(&quot;ATTACH&quot;);</span>
<a href="#l3.39"></a><span id="l3.39">     attach.icalProperty = prop;</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41">     do_check_eq(attach.formatType, &quot;x-moz/test2&quot;);</span>
<a href="#l3.42"></a><span id="l3.42">     do_check_eq(attach.getParameter(&quot;FMTTYPE&quot;), &quot;x-moz/test2&quot;);</span>
<a href="#l3.43"></a><span id="l3.43">     do_check_eq(attach.encoding, &quot;BASE64&quot;);</span>
<a href="#l3.44"></a><span id="l3.44">     do_check_eq(attach.getParameter(&quot;ENCODING&quot;), &quot;BASE64&quot;);</span>
<a href="#l3.45"></a><span id="l3.45">     do_check_eq(attach.uri, null);</span>
<a href="#l3.46"></a><span id="l3.46">     do_check_eq(attach.rawData, &quot;aHR0cDovL2hlbGxvMg==&quot;);</span>
<a href="#l3.47"></a><span id="l3.47">     do_check_eq(attach.getParameter(&quot;VALUE&quot;), &quot;BINARY&quot;);</span>
<a href="#l3.48"></a><span id="l3.48"> </span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-    do_check_eq(attach.icalProperty.icalString, attachString);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-    do_check_eq(attach.clone().icalProperty.icalString, attachString);</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+    let propIcalString = attach.icalProperty.icalString;</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+    do_check_true(!!propIcalString.match(/ENCODING=BASE64/));</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+    do_check_true(!!propIcalString.match(/FMTTYPE=x-moz\/test2/));</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+    do_check_true(!!propIcalString.match(/VALUE=BINARY/));</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+    do_check_true(!!propIcalString.match(/:aHR0cDovL2hlbGxvMg\r\n ==/));</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+    propIcalString = attach.clone().icalProperty.icalString;</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+    do_check_true(!!propIcalString.match(/ENCODING=BASE64/));</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+    do_check_true(!!propIcalString.match(/FMTTYPE=x-moz\/test2/));</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+    do_check_true(!!propIcalString.match(/VALUE=BINARY/));</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+    do_check_true(!!propIcalString.match(/:aHR0cDovL2hlbGxvMg\r\n ==/));</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+</span>
<a href="#l3.64"></a><span id="l3.64"> }</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+function test_serialize() {</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+    let attach = cal.createAttachment();</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+    attach.formatType = &quot;x-moz/test2&quot;;</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+    attach.uri = Services.io.newURI(&quot;data:text/plain,&quot;, null, null);</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+    do_check_eq(attach.icalString, &quot;ATTACH;FMTTYPE=x-moz/test2:data:text/plain,\r\n&quot;);</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+    attach = cal.createAttachment();</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+    attach.encoding = &quot;BASE64&quot;;</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+    attach.uri = Services.io.newURI(&quot;data:text/plain,&quot;, null, null);</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+    do_check_eq(attach.icalString, &quot;ATTACH;ENCODING=BASE64:data:text/plain,\r\n&quot;);</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+        attach.icalString = &quot;X-STICKER:smiley&quot;;</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+    }, Components.results.NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+    attach = cal.createAttachment();</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+    attach.uri = Services.io.newURI(&quot;data:text/plain,&quot;, null, null);</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+    attach.setParameter(&quot;X-PROP&quot;, &quot;VAL&quot;);</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+    do_check_eq(attach.icalString, &quot;ATTACH;X-PROP=VAL:data:text/plain,\r\n&quot;);</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+    attach.setParameter(&quot;X-PROP&quot;, null);</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+    do_check_eq(attach.icalString, &quot;ATTACH:data:text/plain,\r\n&quot;);</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/test/unit/test_attendee.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/test/unit/test_attendee.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,46 +1,80 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.5"></a><span id="l4.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.6"></a><span id="l4.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+ Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+</span>
<a href="#l4.10"></a><span id="l4.10"> function run_test() {</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-    const Cc = Components.classes;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    const Ci = Components.interfaces;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    test_values();</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+    test_serialize();</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+    test_properties();</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+}</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+function test_values() {</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+    function findAttendeesInResults(event, expectedAttendees) {</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+        let countObj = {};</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+        // Getting all attendees</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+        let allAttendees = event.getAttendees(countObj);</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+        do_check_eq(countObj.value, allAttendees.length);</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+        do_check_eq(allAttendees.length, expectedAttendees.length);</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+        // Check if all expected attendees are found</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+        for (let i = 0; i &lt; expectedAttendees.length; i++) {</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+            do_check_neq(allAttendees.indexOf(expectedAttendees[i]), -1);</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+        }</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-    var eventClass = Cc[&quot;@mozilla.org/calendar/event;1&quot;];</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-    var eventIID = Ci.calIEvent;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+        // Check if all found attendees are expected</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+        for (let i = 0; i &lt; allAttendees.length; i++) {</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+            do_check_neq(expectedAttendees.indexOf(allAttendees[i]), -1);</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+        }</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+    }</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+    function findById(event, id, a) {</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+        let foundAttendee = event.getAttendeeById(id);</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+        do_check_eq(foundAttendee, a);</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+    }</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+    function testImmutability(a, properties) {</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+        do_check_false(a.isMutable);</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+        // Check if setting a property throws. It should.</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+        for (let i = 0; i &lt; properties.length; i++) {</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+            let old = a[properties[i]];</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+            do_check_throws(function() {</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+                a[properties[i]] = old + 1;</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+            }, Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l4.51"></a><span id="l4.51"> </span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-    var attendeeClass = Cc[&quot;@mozilla.org/calendar/attendee;1&quot;];</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-    var attendeeIID = Ci.calIAttendee;</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+            do_check_eq(a[properties[i]], old);</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+        }</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+    }</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+    const cIA = Components.interfaces.calIAttendee;</span>
<a href="#l4.59"></a><span id="l4.59"> </span>
<a href="#l4.60"></a><span id="l4.60">     // Create Attendee</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-    var a1 = attendeeClass.createInstance(attendeeIID);</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+    var a1 = cal.createAttendee();</span>
<a href="#l4.63"></a><span id="l4.63">     // Testing attendee set/get.</span>
<a href="#l4.64"></a><span id="l4.64">     var properties = [&quot;id&quot;, &quot;commonName&quot;, &quot;rsvp&quot;, &quot;role&quot;, &quot;participationStatus&quot;,</span>
<a href="#l4.65"></a><span id="l4.65">                       &quot;userType&quot;];</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-    var values = [&quot;myid&quot;, &quot;mycn&quot;, &quot;TRUE&quot;, attendeeIID.ROLE_CHAIR,</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-                  attendeeIID.PARTSTAT_DECLINED,</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-                  attendeeIID.CUTYPE_RESOURCE];</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+    var values = [&quot;myid&quot;, &quot;mycn&quot;, &quot;TRUE&quot;, &quot;CHAIR&quot;, &quot;DECLINED&quot;, &quot;RESOURCE&quot;];</span>
<a href="#l4.70"></a><span id="l4.70">     // Make sure test is valid</span>
<a href="#l4.71"></a><span id="l4.71">     do_check_eq(properties.length, values.length);</span>
<a href="#l4.72"></a><span id="l4.72"> </span>
<a href="#l4.73"></a><span id="l4.73">     for (var i = 0; i &lt; properties.length; i++) {</span>
<a href="#l4.74"></a><span id="l4.74">         a1[properties[i]] = values[i];</span>
<a href="#l4.75"></a><span id="l4.75">         do_check_eq(a1[properties[i]], values[i]);</span>
<a href="#l4.76"></a><span id="l4.76">     }</span>
<a href="#l4.77"></a><span id="l4.77"> </span>
<a href="#l4.78"></a><span id="l4.78">     // Create event</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-    var event = eventClass.createInstance(eventIID);</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+    var event = cal.createEvent();</span>
<a href="#l4.81"></a><span id="l4.81"> </span>
<a href="#l4.82"></a><span id="l4.82">     // Add attendee to event</span>
<a href="#l4.83"></a><span id="l4.83">     event.addAttendee(a1);</span>
<a href="#l4.84"></a><span id="l4.84"> </span>
<a href="#l4.85"></a><span id="l4.85">     // Add 2nd attendee to event.</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-    var a2 = attendeeClass.createInstance(attendeeIID);</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+    let a2 = cal.createAttendee();</span>
<a href="#l4.88"></a><span id="l4.88">     a2.id = &quot;myid2&quot;;</span>
<a href="#l4.89"></a><span id="l4.89">     event.addAttendee(a2);</span>
<a href="#l4.90"></a><span id="l4.90"> </span>
<a href="#l4.91"></a><span id="l4.91">     // Finding by ID</span>
<a href="#l4.92"></a><span id="l4.92">     findById(event, &quot;myid&quot;, a1);</span>
<a href="#l4.93"></a><span id="l4.93">     findById(event, &quot;myid2&quot;, a2);</span>
<a href="#l4.94"></a><span id="l4.94"> </span>
<a href="#l4.95"></a><span id="l4.95">     findAttendeesInResults(event, [a1, a2]);</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineat">@@ -59,50 +93,99 @@ function run_test() {</span>
<a href="#l4.97"></a><span id="l4.97">     do_check_eq(atts.length, clonedatts.length)</span>
<a href="#l4.98"></a><span id="l4.98"> </span>
<a href="#l4.99"></a><span id="l4.99">     for (i = 0; i &lt; clonedatts.length; i++) {</span>
<a href="#l4.100"></a><span id="l4.100">         // The attributes should not be equal</span>
<a href="#l4.101"></a><span id="l4.101">         do_check_neq(atts[i], clonedatts[i]);</span>
<a href="#l4.102"></a><span id="l4.102">         // But the ids should</span>
<a href="#l4.103"></a><span id="l4.103">         do_check_eq(atts[i].id, clonedatts[i].id)</span>
<a href="#l4.104"></a><span id="l4.104">     }</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-}</span>
<a href="#l4.106"></a><span id="l4.106"> </span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-function findById(event, id, a) {</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-    var foundAttendee = event.getAttendeeById(id);</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineminus">-    do_check_eq(foundAttendee, a);</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+    // Make sure organizers are also cloned correctly</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+    let a3 = cal.createAttendee();</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+    a3.id = &quot;horst&quot;;</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+    a3.isOrganizer = true;</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+    let a4 = a3.clone();</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+    do_check_true(a4.isOrganizer)</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+    a3.isOrganizer = false;</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+    do_check_true(a4.isOrganizer)</span>
<a href="#l4.119"></a><span id="l4.119"> }</span>
<a href="#l4.120"></a><span id="l4.120"> </span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-function findAttendeesInResults(event, expectedAttendees) {</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-    var countObj = {};</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineminus">-    // Getting all attendees</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-    var allAttendees = event.getAttendees(countObj);</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineminus">-    do_check_eq(countObj.value, allAttendees.length);</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+function test_serialize() {</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+    let a = cal.createAttendee();</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+        a.icalProperty;</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+    }, Components.results.NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+    a.id = &quot;horst&quot;;</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+    a.commonName = &quot;Horst&quot;;</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+    a.rsvp = &quot;TRUE&quot;;</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+    a.isOrganizer = false;</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+    a.role = &quot;CHAIR&quot;;</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+    a.participationStatus = &quot;DECLINED&quot;;</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+    a.userType = &quot;RESOURCE&quot;;</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+    a.setProperty(&quot;X-NAME&quot;, &quot;X-VALUE&quot;);</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+    let prop = a.icalProperty;</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+    dump(prop.icalString);</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+    do_check_eq(prop.value, &quot;horst&quot;);</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+    do_check_eq(prop.propertyName, &quot;ATTENDEE&quot;);</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+    do_check_eq(prop.getParameter(&quot;CN&quot;), &quot;Horst&quot;);</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+    do_check_eq(prop.getParameter(&quot;RSVP&quot;), &quot;TRUE&quot;);</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+    do_check_eq(prop.getParameter(&quot;ROLE&quot;), &quot;CHAIR&quot;);</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+    do_check_eq(prop.getParameter(&quot;PARTSTAT&quot;), &quot;DECLINED&quot;);</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+    do_check_eq(prop.getParameter(&quot;CUTYPE&quot;), &quot;RESOURCE&quot;);</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+    do_check_eq(prop.getParameter(&quot;X-NAME&quot;), &quot;X-VALUE&quot;);</span>
<a href="#l4.155"></a><span id="l4.155"> </span>
<a href="#l4.156"></a><span id="l4.156" class="difflineminus">-    do_check_eq(allAttendees.length, expectedAttendees.length);</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+    a.isOrganizer = true;</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+    prop = a.icalProperty;</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+    do_check_eq(prop.value, &quot;horst&quot;);</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+    do_check_eq(prop.propertyName, &quot;ORGANIZER&quot;);</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+    do_check_eq(prop.getParameter(&quot;CN&quot;), &quot;Horst&quot;);</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+    do_check_eq(prop.getParameter(&quot;RSVP&quot;), &quot;TRUE&quot;);</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+    do_check_eq(prop.getParameter(&quot;ROLE&quot;), &quot;CHAIR&quot;);</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+    do_check_eq(prop.getParameter(&quot;PARTSTAT&quot;), &quot;DECLINED&quot;);</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+    do_check_eq(prop.getParameter(&quot;CUTYPE&quot;), &quot;RESOURCE&quot;);</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+    do_check_eq(prop.getParameter(&quot;X-NAME&quot;), &quot;X-VALUE&quot;);</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+}</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+function test_properties() {</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+    let a = cal.createAttendee();</span>
<a href="#l4.172"></a><span id="l4.172"> </span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-    // Check if all expected attendees are found</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-    for (var i = 0; i &lt; expectedAttendees.length; i++) {</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-        do_check_neq(allAttendees.indexOf(expectedAttendees[i]), -1);</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+        a.icalProperty;</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+    }, Components.results.NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+    a.id = &quot;horst&quot;;</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+    a.commonName = &quot;Horst&quot;;</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+    a.rsvp = &quot;TRUE&quot;;</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+    a.isOrganizer = false;</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+    a.role = &quot;CHAIR&quot;;</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+    a.participationStatus = &quot;DECLINED&quot;;</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+    a.userType = &quot;RESOURCE&quot;;</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+    // Only X-Props should show up in the enumerator</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+    a.setProperty(&quot;X-NAME&quot;, &quot;X-VALUE&quot;);</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+    for each (let x in fixIterator(a.propertyEnumerator, Components.interfaces.nsIProperty)) {</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+        do_check_eq(x.name, &quot;X-NAME&quot;);</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+        do_check_eq(x.value, &quot;X-VALUE&quot;);</span>
<a href="#l4.195"></a><span id="l4.195">     }</span>
<a href="#l4.196"></a><span id="l4.196"> </span>
<a href="#l4.197"></a><span id="l4.197" class="difflineminus">-    // Check if all found attendees are expected</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineminus">-    for (var i = 0; i &lt; allAttendees.length; i++) {</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-        do_check_neq(expectedAttendees.indexOf(allAttendees[i]), -1);</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+    a.deleteProperty(&quot;X-NAME&quot;);</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+    for each (let x in fixIterator(a.propertyEnumerator, Components.interfaces.nsIProperty)) {</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+        do_throw(&quot;Unexpected property &quot; + x.name + &quot; = &quot; + x.value);</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+    }</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+    a.setProperty(&quot;X-NAME&quot;, &quot;X-VALUE&quot;);</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+    a.setProperty(&quot;X-NAME&quot;, null);</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+    for each (let x in fixIterator(a.propertyEnumerator, Components.interfaces.nsIProperty)) {</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+        do_throw(&quot;Unexpected property after setting null &quot; + x.name + &quot; = &quot; + x.value);</span>
<a href="#l4.210"></a><span id="l4.210">     }</span>
<a href="#l4.211"></a><span id="l4.211"> }</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-function testImmutability(a, properties) {</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-    do_check_false(a.isMutable);</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineminus">-    // Check if setting a property throws. It should.</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-    for (var i = 0; i &lt; properties.length; i++) {</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-        var old = a[properties[i]];</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-        var threw;</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-        try {</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-            a[properties[i]] = old + 1;</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-            threw = false;</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineminus">-        } catch (ex) {</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineminus">-            threw = true;</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-        }</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-        do_check_true(threw);</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-        do_check_eq(a[properties[i]], old);</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-    }</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/test/unit/test_bug494140.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/test/unit/test_bug494140.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -22,18 +22,21 @@ function run_test() {</span>
<a href="#l5.4"></a><span id="l5.4">                                          &quot;RELATED-TO:RELTYPE=SIBLING:&lt;foo@example.org&gt;\r\n&quot; +</span>
<a href="#l5.5"></a><span id="l5.5">                                          &quot;ATTACH:http://www.example.org/\r\n&quot; +</span>
<a href="#l5.6"></a><span id="l5.6">                                          &quot;BEGIN:VALARM\r\n&quot; +</span>
<a href="#l5.7"></a><span id="l5.7">                                          &quot;ACTION:DISPLAY\r\n&quot; +</span>
<a href="#l5.8"></a><span id="l5.8">                                          &quot;TRIGGER;VALUE=DURATION:-PT10M\r\n&quot; +</span>
<a href="#l5.9"></a><span id="l5.9">                                          &quot;DESCRIPTION:Mozilla Alarm: Test\r\n&quot; +</span>
<a href="#l5.10"></a><span id="l5.10">                                          &quot;END:VALARM\r\n&quot; +</span>
<a href="#l5.11"></a><span id="l5.11">                                          &quot;END:VEVENT&quot;);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+</span>
<a href="#l5.13"></a><span id="l5.13">     // There should be one alarm, one relation and one attachment</span>
<a href="#l5.14"></a><span id="l5.14">     do_check_eq(item.getAlarms({}).length, 1);</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+    do_check_eq(item.getRelations({}).length, 1);</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+    do_check_eq(item.getAttachments({}).length, 1);</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18">     // Change the occurrence to another day</span>
<a href="#l5.19"></a><span id="l5.19">     let occ = item.recurrenceInfo.getOccurrenceFor(cal.createDateTime(&quot;20090604T073000Z&quot;));</span>
<a href="#l5.20"></a><span id="l5.20">     occ.startDate = cal.createDateTime(&quot;20090618T073000Z&quot;);</span>
<a href="#l5.21"></a><span id="l5.21">     item.recurrenceInfo.modifyException(occ, true);</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23">     // There should still be one alarm, one relation and one attachment</span>
<a href="#l5.24"></a><span id="l5.24">     do_check_eq(item.getAlarms({}).length, 1);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/test/unit/test_datetime.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/test/unit/test_datetime.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -10,20 +10,21 @@ function run_test() {</span>
<a href="#l6.4"></a><span id="l6.4">     let cd = cal.createDateTime();</span>
<a href="#l6.5"></a><span id="l6.5">     cd.resetTo(2005, 10, 13,</span>
<a href="#l6.6"></a><span id="l6.6">                10, 0, 0,</span>
<a href="#l6.7"></a><span id="l6.7">                getMozTimezone(&quot;/mozilla.org/20050126_1/America/Bogota&quot;));</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9">     do_check_eq(cd.hour, 10);</span>
<a href="#l6.10"></a><span id="l6.10">     do_check_eq(cd.icalString, &quot;20051113T100000&quot;);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    let cd_floating = cd.getInTimezone(floating());</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+    let cd_floating = cd.getInTimezone(cal.floating());</span>
<a href="#l6.14"></a><span id="l6.14">     do_check_eq(cd_floating.hour, 10);</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-    let cd_utc = cd.getInTimezone(UTC());</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+    let cd_utc = cd.getInTimezone(cal.UTC());</span>
<a href="#l6.19"></a><span id="l6.19">     do_check_eq(cd_utc.hour, 15);</span>
<a href="#l6.20"></a><span id="l6.20">     do_check_eq(cd_utc.icalString, &quot;20051113T150000Z&quot;);</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22">     cd.hour = 25;</span>
<a href="#l6.23"></a><span id="l6.23">     do_check_eq(cd.hour, 1);</span>
<a href="#l6.24"></a><span id="l6.24">     do_check_eq(cd.day, 14);</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27" class="difflineat">@@ -84,9 +85,14 @@ function run_test() {</span>
<a href="#l6.28"></a><span id="l6.28">     do_check_eq(utc.clone().timezone.tzid, &quot;UTC&quot;);</span>
<a href="#l6.29"></a><span id="l6.29">     do_check_eq(utc.timezoneOffset, 0);</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31">     // Bug 794477 - setting jsdate across compartments needs to work</span>
<a href="#l6.32"></a><span id="l6.32">     let someDate = new Date();</span>
<a href="#l6.33"></a><span id="l6.33">     let createdDate = cal.jsDateToDateTime(someDate).getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l6.34"></a><span id="l6.34">     do_check_eq(Math.floor(someDate.getTime() / 1000),</span>
<a href="#l6.35"></a><span id="l6.35">                 Math.floor(createdDate.jsDate.getTime() / 1000));</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+    // Comparing a date-time with a date of the same day should be 0</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+    do_check_eq(cal.createDateTime(&quot;20120101T120000&quot;).compare(cal.createDateTime(&quot;20120101&quot;)), 0);</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+    do_check_eq(cal.createDateTime(&quot;20120101&quot;).compare(cal.createDateTime(&quot;20120101T120000&quot;)), 0);</span>
<a href="#l6.40"></a><span id="l6.40"> }</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/test/unit/test_deleted_items.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/test/unit/test_deleted_items.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -63,21 +63,38 @@ function test_deleted_items() {</span>
<a href="#l7.4"></a><span id="l7.4">     do_check_null(delmgr.getDeletedDate(item.id, &quot;random&quot;));</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6">     // Check if flushing works, we need to travel time for that</span>
<a href="#l7.7"></a><span id="l7.7">     useFutureDate = true;</span>
<a href="#l7.8"></a><span id="l7.8">     delmgr.flush();</span>
<a href="#l7.9"></a><span id="l7.9">     do_check_null(delmgr.getDeletedDate(item.id));</span>
<a href="#l7.10"></a><span id="l7.10">     do_check_null(delmgr.getDeletedDate(item.id, memory.id));</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    // Deleting an item and adding it again should consider it not deleted</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    // Deleting an item and adding it again should consider it not deleted. The</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+    // deleted items manager runs the statements asynchronously. Timeouts are</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+    // usually a bad way to test, but since the deleted items manager is only</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+    // used as a hint, the sql calls in the observers are async.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+    // *** If this test is failing, the timeouts might not be enough ***</span>
<a href="#l7.18"></a><span id="l7.18">     useFutureDate = false;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-    memory.addItem(item, null);</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-    memory.deleteItem(item, null);</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-    memory.addItem(item, null);</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-    do_check_null(delmgr.getDeletedDate(item.id));</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-    // Revert now function, in case more tests are written</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-    cal.now = oldNowFunction;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+    function doFirstAdd() {</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+        memory.addItem(item, null);</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+        do_timeout(100, doRemove);</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+    }</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+    function doRemove() {</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+        memory.deleteItem(item, null);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+        do_timeout(100, doSecondAdd);</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+    }</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+    function doSecondAdd() {</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+        memory.addItem(item, null);</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+        do_timeout(100, doCleanup);</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+    }</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+    function doCleanup() {</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+        do_check_null(delmgr.getDeletedDate(item.id));</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+        // Revert now function, in case more tests are written</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+        cal.now = oldNowFunction;</span>
<a href="#l7.42"></a><span id="l7.42"> </span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-    run_next_test();</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+        run_next_test();</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+    }</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+    doFirstAdd();</span>
<a href="#l7.48"></a><span id="l7.48"> }</span>
<a href="#l7.49"></a><span id="l7.49"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/calendar/test/unit/test_duration.js</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,10 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+function run_test() {</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+    let a = cal.createDuration(&quot;PT1S&quot;);</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+    let b = cal.createDuration(&quot;PT3S&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+    a.addDuration(b);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+    do_check_eq(a.icalString, &quot;PT4S&quot;);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/test/unit/test_freebusy.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/test/unit/test_freebusy.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,13 +1,18 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.5"></a><span id="l9.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.6"></a><span id="l9.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> function run_test() {</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+    test_freebusy();</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+    test_period();</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+}</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+function test_freebusy() {</span>
<a href="#l9.14"></a><span id="l9.14">     var icsService = Components.classes[&quot;@mozilla.org/calendar/ics-service;1&quot;]</span>
<a href="#l9.15"></a><span id="l9.15">                                .getService(Components.interfaces.calIICSService);</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17">     // Bug 415987 - FREEBUSY decoding does not support comma-separated entries</span>
<a href="#l9.18"></a><span id="l9.18">     // (https://bugzilla.mozilla.org/show_bug.cgi?id=415987)</span>
<a href="#l9.19"></a><span id="l9.19">     var fbVal1 = &quot;20080206T160000Z/PT1H&quot;;</span>
<a href="#l9.20"></a><span id="l9.20">     var fbVal2 = &quot;20080206T180000Z/PT1H&quot;;</span>
<a href="#l9.21"></a><span id="l9.21">     var fbVal3 = &quot;20080206T220000Z/PT1H&quot;;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -17,8 +22,50 @@ function run_test() {</span>
<a href="#l9.23"></a><span id="l9.23">         &quot;FREEBUSY;FBTYPE=BUSY:&quot; + fbVal1 + &quot;,&quot; + fbVal2 + &quot;,&quot; + fbVal3 + &quot;\n&quot; +</span>
<a href="#l9.24"></a><span id="l9.24">         &quot;END:VFREEBUSY\n&quot; +</span>
<a href="#l9.25"></a><span id="l9.25">         &quot;END:VCALENDAR\n&quot;;</span>
<a href="#l9.26"></a><span id="l9.26">     var fbComp = icsService.parseICS(data, null).getFirstSubcomponent(&quot;VFREEBUSY&quot;);</span>
<a href="#l9.27"></a><span id="l9.27">     do_check_eq(fbComp.getFirstProperty(&quot;FREEBUSY&quot;).value, fbVal1);</span>
<a href="#l9.28"></a><span id="l9.28">     do_check_eq(fbComp.getNextProperty(&quot;FREEBUSY&quot;).value, fbVal2);</span>
<a href="#l9.29"></a><span id="l9.29">     do_check_eq(fbComp.getNextProperty(&quot;FREEBUSY&quot;).value, fbVal3);</span>
<a href="#l9.30"></a><span id="l9.30"> }</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+function test_period() {</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+    let period = Components.classes[&quot;@mozilla.org/calendar/period;1&quot;]</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+                           .createInstance(Components.interfaces.calIPeriod);</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+    period.start = cal.createDateTime(&quot;20120101T010101&quot;);</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+    period.end = cal.createDateTime(&quot;20120101T010102&quot;);</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+    do_check_eq(period.icalString, &quot;20120101T010101/20120101T010102&quot;);</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+    do_check_eq(period.duration.icalString, &quot;PT1S&quot;);</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+    period.icalString = &quot;20120101T010103/20120101T010104&quot;;</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+    do_check_eq(period.start.icalString, &quot;20120101T010103&quot;);</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+    do_check_eq(period.end.icalString, &quot;20120101T010104&quot;);</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+    do_check_eq(period.duration.icalString, &quot;PT1S&quot;);</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+    period.icalString = &quot;20120101T010105/PT1S&quot;;</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+    do_check_eq(period.start.icalString, &quot;20120101T010105&quot;);</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+    do_check_eq(period.end.icalString, &quot;20120101T010106&quot;);</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+    do_check_eq(period.duration.icalString, &quot;PT1S&quot;);</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+    period.makeImmutable();</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+        period.start = cal.createDateTime(&quot;20120202T020202&quot;);</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+    }, Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+        period.end = cal.createDateTime(&quot;20120202T020202&quot;);</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+    }, Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+    let copy = period.clone();</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+    do_check_eq(copy.start.icalString, &quot;20120101T010105&quot;);</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+    do_check_eq(copy.end.icalString, &quot;20120101T010106&quot;);</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+    do_check_eq(copy.duration.icalString, &quot;PT1S&quot;);</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+    copy.start.icalString = &quot;20120101T010106&quot;;</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+    copy.end = cal.createDateTime(&quot;20120101T010107&quot;);</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+    do_check_eq(period.start.icalString, &quot;20120101T010105&quot;);</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+    do_check_eq(period.end.icalString, &quot;20120101T010106&quot;);</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+    do_check_eq(period.duration.icalString, &quot;PT1S&quot;);</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/calendar/test/unit/test_freebusy_service.js</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,160 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+Components.utils.import(&quot;resource:///modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+const cIFI = Components.interfaces.calIFreeBusyInterval;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+let freebusy = Components.classes[&quot;@mozilla.org/calendar/freebusy-service;1&quot;]</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+                         .getService(Components.interfaces.calIFreeBusyService);</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+function run_test() {</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+    test_found();</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+    test_failure();</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+    test_cancel();</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+}</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+function test_found() {</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+    _clearProviders();</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+    do_check_eq(_countProviders(), 0);</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+    let provider1 = {</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+        id: 1,</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+        getFreeBusyIntervals: function() {}</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+    };</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+    let provider2 = {</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+        id: 2,</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+        called: false,</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+        getFreeBusyIntervals: function(aCalId, aStart, aEnd, aTypes, aListener) {</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+            do_check_false(this.called)</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+            this.called = true;</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+            let interval = cal.FreeBusyInterval(aCalId, cIFI.BUSY, aStart, aEnd);</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+            aListener.onResult(null, [interval]);</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+        }</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+    };</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+    provider2.wrappedJSObject = provider2;</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+    freebusy.addProvider(provider1);</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+    do_check_eq(_countProviders(), 1);</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+    freebusy.addProvider(provider2);</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+    do_check_eq(_countProviders(), 2);</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+    freebusy.removeProvider(provider1);</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+    do_check_eq(_countProviders(), 1);</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+    do_check_eq(_getFirstProvider().id, 2);</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+    let listener = {</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+        called: false,</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+        onResult: function(request, result) {</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+            do_check_false(this.called);</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+            this.called = true;</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+            do_check_eq(result[0].start.icalString, &quot;20120101T010101&quot;);</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+            do_check_eq(result[0].end.icalString, &quot;20120102T010101&quot;);</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+            do_check_eq(result[0].freeBusyType, cIFI.BUSY);</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+            do_check_eq(result.length, 1);</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+        }</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+    };</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+    let op = freebusy.getFreeBusyIntervals(&quot;email&quot;,</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+                                           cal.createDateTime(&quot;20120101T010101&quot;),</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+                                           cal.createDateTime(&quot;20120102T010101&quot;),</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+                                           cIFI.BUSY_ALL,</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+                                           listener);</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+    do_check_true(listener.called);</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+    do_check_true(provider2.called);</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+}</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+function test_failure() {</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+    _clearProviders();</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+    let provider = {</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+        getFreeBusyIntervals: function(aCalId, aStart, aEnd, aTypes, aListener) {</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+            throw &quot;error&quot;;</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+        }</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+    };</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+    let listener = {</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+        called: false,</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+        onResult: function(request, result) {</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+            do_check_false(this.called);</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+            this.called = true;</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+            do_check_eq(result.length, 0);</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+        }</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+    };</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+    freebusy.addProvider(provider);</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+    let op = freebusy.getFreeBusyIntervals(&quot;email&quot;,</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+                                           cal.createDateTime(&quot;20120101T010101&quot;),</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+                                           cal.createDateTime(&quot;20120102T010101&quot;),</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+                                           cIFI.BUSY_ALL,</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+                                           listener);</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+    do_check_true(listener.called);</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+}</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+function test_cancel() {</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+    _clearProviders();</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+    let provider = {</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+        QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIFreeBusyProvider, Components.interfaces.calIOperation]),</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+        getFreeBusyIntervals: function(aCalId, aStart, aEnd, aTypes, aListener) {</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+            Services.tm.currentThread.dispatch({run: function() {</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+                dump(&quot;Cancelling freebusy query...&quot;);</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+                op.cancel();</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+            }}, Components.interfaces.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+            // No listener call, we emulate a long running search</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+            // Do return the operation though</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+            return this;</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+        },</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+        isPending: true,</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+        cancelCalled: false,</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+        status: Components.results.NS_OK,</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+        cancel: function() {</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+            this.cancelCalled = true;</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+        },</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+    };</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+    let listener = {</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+        called: false,</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+        onResult: function(request, result) {</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+            do_check_eq(result, null);</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+            // If an exception occurs, the operation is not added to the opgroup</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+            do_check_false(provider.cancelCalled);</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+            do_test_finished();</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+        }</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+    };</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+    freebusy.addProvider(provider);</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+    do_test_pending();</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+    let op = freebusy.getFreeBusyIntervals(&quot;email&quot;,</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+                                           cal.createDateTime(&quot;20120101T010101&quot;),</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+                                           cal.createDateTime(&quot;20120102T010101&quot;),</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+                                           cIFI.BUSY_ALL,</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+                                           listener);</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+}</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+// The following functions are not in the interface description and probably</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+// don't need to be. Make assumptions about the implementation instead.</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+function _clearProviders() {</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+    freebusy.wrappedJSObject.mProviders = new calInterfaceBag(Components.interfaces.calIFreeBusyProvider);</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+}</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+function _countProviders() {</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+    return freebusy.wrappedJSObject.mProviders.interfaceArray.length;</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+}</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+function _getFirstProvider() {</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+    return freebusy.wrappedJSObject.mProviders.interfaceArray[0].wrappedJSObject;</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/test/unit/test_ics.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/test/unit/test_ics.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,27 +1,41 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.5"></a><span id="l11.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.6"></a><span id="l11.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> function run_test() {</span>
<a href="#l11.9"></a><span id="l11.9">     test_folding();</span>
<a href="#l11.10"></a><span id="l11.10">     test_icalProps();</span>
<a href="#l11.11"></a><span id="l11.11">     test_roundtrip();</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+    test_duration();</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+    test_serialize();</span>
<a href="#l11.14"></a><span id="l11.14"> }</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-function test_roundtrip() {</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-    let ics_xmas =</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-        &quot;BEGIN:VCALENDAR\n&quot; +</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+const test_data = [</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+    {</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+      expectedDateProps: {</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+          month: 10,</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+          day: 25,</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+          year: 2004,</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+          isDate: true</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+      },</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+      expectedProps: {</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+          title: &quot;Christmas&quot;,</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+          id: &quot;20041119T052239Z-1000472-1-5c0746bb-Oracle&quot;,</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+          priority: 0,</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+          status: &quot;CONFIRMED&quot;</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+      },</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+      ics: &quot;BEGIN:VCALENDAR\n&quot; +</span>
<a href="#l11.34"></a><span id="l11.34">         &quot;PRODID:-//ORACLE//NONSGML CSDK 9.0.5 - CalDAVServlet 9.0.5//EN\n&quot; +</span>
<a href="#l11.35"></a><span id="l11.35">         &quot;VERSION:2.0\n&quot; +</span>
<a href="#l11.36"></a><span id="l11.36">         &quot;BEGIN:VEVENT\n&quot; +</span>
<a href="#l11.37"></a><span id="l11.37">         &quot;UID:20041119T052239Z-1000472-1-5c0746bb-Oracle\n&quot; +</span>
<a href="#l11.38"></a><span id="l11.38">         &quot;ORGANIZER;X-ORACLE-GUID=E9359406791C763EE0305794071A39A4;CN=Simon Vaillan\n&quot; +</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-        &quot;court:mailto:simon.vaillancourt@oracle.com\n&quot; +</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+        &quot; court:mailto:simon.vaillancourt@oracle.com\n&quot; +</span>
<a href="#l11.41"></a><span id="l11.41">         &quot;SEQUENCE:0\n&quot; +</span>
<a href="#l11.42"></a><span id="l11.42">         &quot;DTSTAMP:20041124T010028Z\n&quot; +</span>
<a href="#l11.43"></a><span id="l11.43">         &quot;CREATED:20041119T052239Z\n&quot; +</span>
<a href="#l11.44"></a><span id="l11.44">         &quot;X-ORACLE-EVENTINSTANCE-GUID:I1+16778354+1+1+438153759\n&quot; +</span>
<a href="#l11.45"></a><span id="l11.45">         &quot;X-ORACLE-EVENT-GUID:E1+16778354+1+438153759\n&quot; +</span>
<a href="#l11.46"></a><span id="l11.46">         &quot;X-ORACLE-EVENTTYPE:DAY EVENT\n&quot; +</span>
<a href="#l11.47"></a><span id="l11.47">         &quot;TRANSP:TRANSPARENT\n&quot; +</span>
<a href="#l11.48"></a><span id="l11.48">         &quot;SUMMARY:Christmas\n&quot; +</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineat">@@ -70,67 +84,81 @@ function test_roundtrip() {</span>
<a href="#l11.50"></a><span id="l11.50">         &quot; tion.org\n&quot; +</span>
<a href="#l11.51"></a><span id="l11.51">         &quot;ATTENDEE;X-ORACLE-GUID=E93594067928763EE0305794071A39A4;CUTYPE=INDIVIDUAL\n&quot; +</span>
<a href="#l11.52"></a><span id="l11.52">         &quot; ;RSVP=TRUE;CN=Dan Mosedale;PARTSTAT=NEEDS-ACTION:mailto:dan.mosedale@ora\n&quot; +</span>
<a href="#l11.53"></a><span id="l11.53">         &quot; cle.com\n&quot; +</span>
<a href="#l11.54"></a><span id="l11.54">         &quot;ATTENDEE;X-ORACLE-GUID=E93594067929763EE0305794071A39A4;CUTYPE=INDIVIDUAL\n&quot; +</span>
<a href="#l11.55"></a><span id="l11.55">         &quot; ;RSVP=TRUE;CN=Stuart Parmenter;PARTSTAT=NEEDS-ACTION:mailto:stuart.parme\n&quot; +</span>
<a href="#l11.56"></a><span id="l11.56">         &quot; nter@oracle.com\n&quot; +</span>
<a href="#l11.57"></a><span id="l11.57">         &quot;END:VEVENT\n&quot; +</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-        &quot;END:VCALENDAR\n\n&quot;;</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+        &quot;END:VCALENDAR\n&quot;</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+    },</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+    {</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+        expectedProps: {</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+            &quot;x-magic&quot;: &quot;mymagicstring&quot;</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+        },</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+        ics: &quot;BEGIN:VEVENT\n&quot; +</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+             &quot;UID:1\n&quot; +</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+             &quot;DTSTART:20070521T100000Z\n&quot; +</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+             &quot;X-MAGIC:mymagicstring\n&quot; +</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+             &quot;END:VEVENT&quot;</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+    }</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+];</span>
<a href="#l11.72"></a><span id="l11.72"> </span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-    let event = createEventFromIcalString(ics_xmas);</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-    let expectedProps = {</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-        title: &quot;Christmas&quot;,</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-        id: &quot;20041119T052239Z-1000472-1-5c0746bb-Oracle&quot;,</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-        priority: 0,</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-        status: &quot;CONFIRMED&quot;</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-    };</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-    checkProps(expectedProps, event);</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-    checkRoundtrip(expectedProps, event);</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+function test_roundtrip() {</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+    function checkEvent(data, event) {</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+        checkRoundtrip(data.expectedProps, event);</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+        // Checking dates</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+        if (&quot;expectedDateProps&quot; in data) {</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+            checkProps(data.expectedDateProps, event.startDate);</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+            checkProps(data.expectedDateProps, event.endDate);</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+        }</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+    }</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+    let icssrv = cal.getIcsService();</span>
<a href="#l11.94"></a><span id="l11.94"> </span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-    // Checking start date</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-    expectedProps = {</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-        month: 10,</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-        day: 25,</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-        year: 2004,</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-        isDate: true</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-    };</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-    checkProps(expectedProps, event.startDate);</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-    checkProps(expectedProps, event.endDate);</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+    for each (var data in test_data) {</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+        // First round, use the icalString setter which uses synchronous parsing</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+        dump(&quot;Checking&quot; + data.ics + &quot;\n&quot;);</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+        let event = createEventFromIcalString(data.ics);</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+        checkEvent(data, event);</span>
<a href="#l11.110"></a><span id="l11.110"> </span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-    // Test for roundtrip of x-properties</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-    let ics_xprop = &quot;BEGIN:VEVENT\n&quot; +</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-                    &quot;UID:1\n&quot; +</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-                    &quot;DTSTART:20070521T100000Z\n&quot; +</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-                    &quot;X-MAGIC:mymagicstring\n&quot; +</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-                    &quot;END:VEVENT&quot;;</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-    event = createEventFromIcalString(ics_xprop);</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-    expectedProps = {</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-        &quot;x-magic&quot;: &quot;mymagicstring&quot;</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-    };</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-    checkRoundtrip(expectedProps, event);</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+        // Now, try the same thing with asynchronous parsing. We need a copy of</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+        // the data variable, otherwise javascript will mix the data between</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+        // foreach loop iterations.</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+        do_test_pending();</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+        let thisdata = data;</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+        icssrv.parseICSAsync(data.ics, null, {</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+            onParsingComplete: function onParsingComplete(rc, rootComp) {</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+                try {</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+                    do_check_true(Components.isSuccessCode(rc));</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+                    let event2 = cal.createEvent();</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+                    event2.icalComponent = rootComp;</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+                    checkEvent(thisdata, event2);</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+                    do_test_finished();</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+                } catch (e) {</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+                    do_throw(e + &quot;\n&quot;);</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+                    do_test_finished();</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+                }</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+            }</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+         });</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+    }</span>
<a href="#l11.146"></a><span id="l11.146"> }</span>
<a href="#l11.147"></a><span id="l11.147"> </span>
<a href="#l11.148"></a><span id="l11.148"> function test_folding() {</span>
<a href="#l11.149"></a><span id="l11.149">     // check folding</span>
<a href="#l11.150"></a><span id="l11.150">     const id = &quot;loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooong-id-provoking-folding&quot;;</span>
<a href="#l11.151"></a><span id="l11.151">     let todo = cal.createTodo(), todo_ = cal.createTodo();</span>
<a href="#l11.152"></a><span id="l11.152">     todo.id = id;</span>
<a href="#l11.153"></a><span id="l11.153">     todo_.icalString = todo.icalString;</span>
<a href="#l11.154"></a><span id="l11.154">     do_check_eq(todo.id, todo_.id);</span>
<a href="#l11.155"></a><span id="l11.155">     do_check_eq(todo_.icalComponent.getFirstProperty(&quot;UID&quot;).value, id);</span>
<a href="#l11.156"></a><span id="l11.156"> }</span>
<a href="#l11.157"></a><span id="l11.157"> </span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-</span>
<a href="#l11.159"></a><span id="l11.159"> function test_icalProps() {</span>
<a href="#l11.160"></a><span id="l11.160">     checkIcalProp(&quot;ATTACH&quot;, cal.createAttachment());</span>
<a href="#l11.161"></a><span id="l11.161">     checkIcalProp(&quot;ATTENDEE&quot;, cal.createAttendee());</span>
<a href="#l11.162"></a><span id="l11.162">     checkIcalProp(&quot;RELATED-TO&quot;, cal.createRelation());</span>
<a href="#l11.163"></a><span id="l11.163"> }</span>
<a href="#l11.164"></a><span id="l11.164"> </span>
<a href="#l11.165"></a><span id="l11.165"> /*</span>
<a href="#l11.166"></a><span id="l11.166">  * Helper functions</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineat">@@ -159,23 +187,40 @@ function checkIcalProp(aPropName, aObj) </span>
<a href="#l11.168"></a><span id="l11.168"> </span>
<a href="#l11.169"></a><span id="l11.169"> function checkProps(expectedProps, obj) {</span>
<a href="#l11.170"></a><span id="l11.170">     for (let key in expectedProps) {</span>
<a href="#l11.171"></a><span id="l11.171">         do_check_eq(obj[key], expectedProps[key]);</span>
<a href="#l11.172"></a><span id="l11.172">     }</span>
<a href="#l11.173"></a><span id="l11.173"> }</span>
<a href="#l11.174"></a><span id="l11.174"> </span>
<a href="#l11.175"></a><span id="l11.175"> function checkRoundtrip(expectedProps, obj) {</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+    let icsdata = obj.icalString;</span>
<a href="#l11.177"></a><span id="l11.177">     for (let key in expectedProps) {</span>
<a href="#l11.178"></a><span id="l11.178">         // Need translation</span>
<a href="#l11.179"></a><span id="l11.179">         let icskey = key;</span>
<a href="#l11.180"></a><span id="l11.180">         switch (key) {</span>
<a href="#l11.181"></a><span id="l11.181">             case &quot;id&quot;:</span>
<a href="#l11.182"></a><span id="l11.182">                 icskey = &quot;uid&quot;;</span>
<a href="#l11.183"></a><span id="l11.183">                 break;</span>
<a href="#l11.184"></a><span id="l11.184">             case &quot;title&quot;:</span>
<a href="#l11.185"></a><span id="l11.185">                 icskey = &quot;summary&quot;;</span>
<a href="#l11.186"></a><span id="l11.186">                 break;</span>
<a href="#l11.187"></a><span id="l11.187">         }</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineminus">-        do_check_true(obj.icalString.indexOf(icskey.toUpperCase()) &gt; 0);</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineminus">-        do_check_true(obj.icalString.indexOf(expectedProps[key]) &gt; 0);</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineplus">+        do_check_true(icsdata.indexOf(icskey.toUpperCase()) &gt; 0);</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineplus">+        do_check_true(icsdata.indexOf(expectedProps[key]) &gt; 0);</span>
<a href="#l11.192"></a><span id="l11.192">     }</span>
<a href="#l11.193"></a><span id="l11.193"> }</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+function test_duration() {</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+    let e = cal.createEvent();</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+    e.startDate = cal.createDateTime();</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineplus">+    e.endDate = null;</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+    do_check_eq(e.duration.icalString, &quot;PT0S&quot;);</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineplus">+}</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineplus">+function test_serialize() {</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+    let e = cal.createEvent();</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+    let prop = cal.getIcsService().createIcalComponent(&quot;VTODO&quot;);</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+        e.icalComponent = prop;</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+    }, Components.results.NS_ERROR_INVALID_ARG);</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/calendar/test/unit/test_ics_parser.js</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,192 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+function run_test() {</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+    test_roundtrip();</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+    test_async();</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+    test_fake_parent();</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+    test_props_comps();</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+    test_timezone();</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+}</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+function test_props_comps() {</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+    let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+                           .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+    let str = [</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+        &quot;BEGIN:VCALENDAR&quot;,</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+        &quot;X-WR-CALNAME:CALNAME&quot;,</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+        &quot;BEGIN:VJOURNAL&quot;,</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+        &quot;LOCATION:BEFORE TIME&quot;,</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+        &quot;END:VJOURNAL&quot;,</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+        &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+        &quot;UID:123&quot;,</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+        &quot;END:VEVENT&quot;,</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+        &quot;END:VCALENDAR&quot;].join(&quot;\r\n&quot;);</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+    parser.parseString(str);</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+    let props = parser.getProperties({});</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+    do_check_eq(props.length, 1);</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+    do_check_eq(props[0].propertyName, &quot;X-WR-CALNAME&quot;);</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+    do_check_eq(props[0].value, &quot;CALNAME&quot;);</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+    let comps = parser.getComponents({});</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+    do_check_eq(comps.length, 1);</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+    do_check_eq(comps[0].componentType, &quot;VJOURNAL&quot;);</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+    do_check_eq(comps[0].location, &quot;BEFORE TIME&quot;);</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+}</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+function test_fake_parent() {</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+    let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+                           .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+    let str = [</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+        &quot;BEGIN:VCALENDAR&quot;,</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+        &quot;BEGIN:VEVENT&quot;,</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+        &quot;UID:123&quot;,</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+        &quot;RECURRENCE-ID:20120101T010101&quot;,</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+        &quot;DTSTART:20120101T010102&quot;,</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+        &quot;LOCATION:HELL&quot;,</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+        &quot;END:VEVENT&quot;,</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+        &quot;END:VCALENDAR&quot;].join(&quot;\r\n&quot;);</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+    parser.parseString(str);</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+    let items = parser.getItems({});</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+    do_check_eq(items.length, 1);</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+    let item = items[0];</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+    do_check_eq(item.id, &quot;123&quot;);</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+    do_check_true(!!item.recurrenceInfo);</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+    do_check_eq(item.startDate.icalString, &quot;20120101T010101&quot;);</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+    do_check_eq(item.getProperty(&quot;X-MOZ-FAKED-MASTER&quot;), &quot;1&quot;);</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+    let rinfo = item.recurrenceInfo;</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+    do_check_eq(rinfo.countRecurrenceItems(), 1);</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+    let excs = rinfo.getOccurrences(cal.createDateTime(&quot;20120101T010101&quot;), null, 0, {});</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+    do_check_eq(excs.length, 1);</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+    let exc = excs[0];</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+    do_check_eq(exc.startDate.icalString, &quot;20120101T010102&quot;);</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+    do_check_eq(parser.getParentlessItems({})[0], exc);</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+}</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+function test_async() {</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+    let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+                           .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+    let str = [</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+        &quot;BEGIN:VCALENDAR&quot;,</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+        &quot;BEGIN:VTODO&quot;,</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+        &quot;UID:1&quot;,</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+        &quot;DTSTART:20120101T010101&quot;,</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+        &quot;DUE:20120101T010102&quot;,</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+        &quot;END:VTODO&quot;,</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+        &quot;BEGIN:VTODO&quot;,</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+        &quot;UID:2&quot;,</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+        &quot;DTSTART:20120101T010103&quot;,</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+        &quot;DUE:20120101T010104&quot;,</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+        &quot;END:VTODO&quot;,</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+        &quot;END:VCALENDAR&quot;].join(&quot;\r\n&quot;);</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+    do_test_pending();</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+    parser.parseString(str, null, {</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+        onParsingComplete: function(rc, parser) {</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+            let items = parser.getItems({});</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+            do_check_eq(items.length, 2);</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+            let item = items[0];</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+            do_check_true(cal.isToDo(item));</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+            do_check_eq(item.entryDate.icalString, &quot;20120101T010101&quot;);</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+            do_check_eq(item.dueDate.icalString, &quot;20120101T010102&quot;);</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+            item = items[1];</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+            do_check_true(cal.isToDo(item));</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+            do_check_eq(item.entryDate.icalString, &quot;20120101T010103&quot;);</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+            do_check_eq(item.dueDate.icalString, &quot;20120101T010104&quot;);</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+            do_test_finished();</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+        }</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+    });</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+}</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+function test_timezone() {</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+    // TODO</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+}</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+function test_roundtrip() {</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+    let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+                           .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+    let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+                               .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+    let str = [</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+        &quot;BEGIN:VCALENDAR&quot;,</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+        &quot;PRODID:-//Mozilla.org/NONSGML Mozilla Calendar V1.1//EN&quot;,</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+        &quot;VERSION:2.0&quot;,</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+        &quot;X-PROP:VAL&quot;,</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+        &quot;BEGIN:VTODO&quot;,</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+        &quot;UID:1&quot;,</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+        &quot;DTSTART:20120101T010101&quot;,</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+        &quot;DUE:20120101T010102&quot;,</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+        &quot;END:VTODO&quot;,</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+        &quot;BEGIN:VJOURNAL&quot;,</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+        &quot;LOCATION:BEFORE TIME&quot;,</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+        &quot;END:VJOURNAL&quot;,</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+        &quot;END:VCALENDAR&quot;,</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+        &quot;&quot;].join(&quot;\r\n&quot;);</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineplus">+</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+    parser.parseString(str);</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+    let items = parser.getItems({});</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+    serializer.addItems(items, items.length);</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+    parser.getProperties({}).forEach(serializer.addProperty, serializer);</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+    parser.getComponents({}).forEach(serializer.addComponent, serializer);</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+    do_check_eq(serializer.serializeToString().split(&quot;\r\n&quot;).sort().join(&quot;\r\n&quot;),</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+                str.split(&quot;\r\n&quot;).sort().join(&quot;\r\n&quot;));</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+    // Test parseFromStream</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+    parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+                       .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+    let stream = serializer.serializeToInputStream();</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+    parser.parseFromStream(stream);</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+    let items = parser.getItems({});</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+    let comps = parser.getComponents({});</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+    let props = parser.getProperties({});</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+    do_check_eq(items.length, 1);</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+    do_check_eq(comps.length, 1);</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+    do_check_eq(props.length, 1);</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+    let everything = items[0].icalString.split(&quot;\r\n&quot;).concat(comps[0].serializeToICS().split(&quot;\r\n&quot;))</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+    everything.push((props[0].icalString.split(&quot;\r\n&quot;))[0]);</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineplus">+    everything.sort();</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+    do_check_eq(everything.join(&quot;\r\n&quot;), str.split(&quot;\r\n&quot;).concat([&quot;&quot;]).sort().join(&quot;\r\n&quot;));</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+    // Test serializeToStream/parseFromStream</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+    parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+                       .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+    let pipe = Components.classes[&quot;@mozilla.org/pipe;1&quot;]</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+                         .createInstance(Components.interfaces.nsIPipe);</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+    pipe.init(true, true, 0, 0, null);</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+    serializer.serializeToStream(pipe.outputStream);</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+    parser.parseFromStream(pipe.inputStream);</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+    items = parser.getItems({});</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+    comps = parser.getComponents({});</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+    props = parser.getProperties({});</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+    do_check_eq(items.length, 1);</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+    do_check_eq(comps.length, 1);</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+    do_check_eq(props.length, 1);</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+    everything = items[0].icalString.split(&quot;\r\n&quot;).concat(comps[0].serializeToICS().split(&quot;\r\n&quot;));</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+    everything.push((props[0].icalString.split(&quot;\r\n&quot;))[0]);</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+    everything.sort();</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineplus">+</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+    do_check_eq(everything.join(&quot;\r\n&quot;), str.split(&quot;\r\n&quot;).concat([&quot;&quot;]).sort().join(&quot;\r\n&quot;));</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/test/unit/test_ics_service.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/test/unit/test_ics_service.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,15 +1,18 @@</span>
<a href="#l13.4"></a><span id="l13.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.5"></a><span id="l13.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.6"></a><span id="l13.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8"> function run_test() {</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+    test_iterator();</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+    test_icalcomponent();</span>
<a href="#l13.11"></a><span id="l13.11">     test_icsservice();</span>
<a href="#l13.12"></a><span id="l13.12">     test_icalstring();</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+    test_param();</span>
<a href="#l13.14"></a><span id="l13.14"> }</span>
<a href="#l13.15"></a><span id="l13.15"> </span>
<a href="#l13.16"></a><span id="l13.16"> function test_icalstring() {</span>
<a href="#l13.17"></a><span id="l13.17">     function checkComp(createFunc, icalString, members, properties) {</span>
<a href="#l13.18"></a><span id="l13.18">         let thing = createFunc(icalString);</span>
<a href="#l13.19"></a><span id="l13.19">         do_check_eq(thing.icalString, ics_foldline(icalString) + &quot;\r\n&quot;);</span>
<a href="#l13.20"></a><span id="l13.20"> </span>
<a href="#l13.21"></a><span id="l13.21">         if (members) {</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -91,12 +94,116 @@ function test_icsservice() {</span>
<a href="#l13.23"></a><span id="l13.23">     checkProp(svc.createIcalPropertyFromString.bind(svc),</span>
<a href="#l13.24"></a><span id="l13.24">               &quot;ATTACH;ENCODING=BASE64;FMTTYPE=text/calendar;FILENAME=test.ics:http://example.com/test.ics&quot;,</span>
<a href="#l13.25"></a><span id="l13.25">               { value: &quot;http://example.com/test.ics&quot;, propertyName: &quot;ATTACH&quot; },</span>
<a href="#l13.26"></a><span id="l13.26">               { ENCODING: &quot;BASE64&quot;, FMTTYPE: &quot;text/calendar&quot;, FILENAME: &quot;test.ics&quot; });</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28">     // Test ::createIcalProperty</span>
<a href="#l13.29"></a><span id="l13.29">     let attach2 = svc.createIcalProperty(&quot;ATTACH&quot;);</span>
<a href="#l13.30"></a><span id="l13.30">     do_check_eq(attach2.propertyName, &quot;ATTACH&quot;);</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-    do_check_throws(function() {</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-        attach2.value;</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-    }, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+    attach2.value = &quot;http://example.com/&quot;;</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+    do_check_eq(attach2.icalString, &quot;ATTACH:http://example.com/\r\n&quot;);</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+}</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+function test_icalcomponent() {</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+    let svc = cal.getIcsService();</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+    let event = svc.createIcalComponent(&quot;VEVENT&quot;);</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+    function check_getset(k, v) {</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+        dump(&quot;Checking &quot; + k + &quot; = &quot; + v + &quot;\n&quot;);</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+        event[k] = v;</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+        vstring = v.icalString || v;</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+        do_check_eq(event[k].icalString || event[k], vstring);</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+        do_check_eq(event.serializeToICS().match(new RegExp(vstring, &quot;g&quot;)).length, 1);</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+        event[k] = v;</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+        do_check_eq(event.serializeToICS().match(new RegExp(vstring, &quot;g&quot;)).length, 1);</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+    }</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+    let props = [</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+       [&quot;uid&quot;, &quot;123&quot;],</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+       [&quot;prodid&quot;, &quot;//abc/123&quot;],</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+       [&quot;version&quot;, &quot;2.0&quot;],</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+       [&quot;method&quot;, &quot;REQUEST&quot;],</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+       [&quot;status&quot;, &quot;TENTATIVE&quot;],</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+       [&quot;summary&quot;, &quot;sum&quot;],</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+       [&quot;description&quot;, &quot;descr&quot;],</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+       [&quot;location&quot;, &quot;here&quot;],</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+       [&quot;categories&quot;, &quot;cat&quot;],</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+       [&quot;URL&quot;, &quot;url&quot;],</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+       [&quot;priority&quot;, 5],</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+       [&quot;startTime&quot;, cal.createDateTime(&quot;20120101T010101&quot;)],</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+       [&quot;endTime&quot;, cal.createDateTime(&quot;20120101T010102&quot;)],</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+       /* TODO readonly, how to set... [&quot;duration&quot;, cal.createDuration(&quot;PT2S&quot;)], */</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+       [&quot;dueTime&quot;, cal.createDateTime(&quot;20120101T010103&quot;)],</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+       [&quot;stampTime&quot;, cal.createDateTime(&quot;20120101T010104&quot;)],</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+       [&quot;createdTime&quot;, cal.createDateTime(&quot;20120101T010105&quot;)],</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+       [&quot;completedTime&quot;, cal.createDateTime(&quot;20120101T010106&quot;)],</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+       [&quot;lastModified&quot;, cal.createDateTime(&quot;20120101T010107&quot;)],</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+       [&quot;recurrenceId&quot;, cal.createDateTime(&quot;20120101T010108&quot;)]</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+    ];</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+    for each (let prop in props) {</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+        check_getset.apply(null, prop);</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+    }</span>
<a href="#l13.78"></a><span id="l13.78"> }</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+function test_param() {</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+    let svc = cal.getIcsService();</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+    let prop = svc.createIcalProperty(&quot;DTSTART&quot;);</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+    prop.value = &quot;20120101T010101&quot;;</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+    do_check_eq(prop.icalString, &quot;DTSTART:20120101T010101\r\n&quot;);</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+    prop.setParameter(&quot;VALUE&quot;, &quot;TEXT&quot;);</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+    do_check_eq(prop.icalString, &quot;DTSTART;VALUE=TEXT:20120101T010101\r\n&quot;);</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+    prop.removeParameter(&quot;VALUE&quot;);</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+    do_check_eq(prop.icalString, &quot;DTSTART:20120101T010101\r\n&quot;);</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+    prop.setParameter(&quot;X-FOO&quot;, &quot;BAR&quot;);</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+    do_check_eq(prop.icalString, &quot;DTSTART;X-FOO=BAR:20120101T010101\r\n&quot;);</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+    prop.removeParameter(&quot;X-FOO&quot;, &quot;BAR&quot;);</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+    do_check_eq(prop.icalString, &quot;DTSTART:20120101T010101\r\n&quot;);</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+}</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+function test_iterator() {</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+    let svc = cal.getIcsService();</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+    // Property iterator</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+    let comp = svc.createIcalComponent(&quot;VEVENT&quot;);</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+    let propNames = [&quot;X-ONE&quot;, &quot;X-TWO&quot;];</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+    for (let i = 0; i &lt; propNames.length; i++) {</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+        let prop = svc.createIcalProperty(propNames[i]);</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+        prop.value = &quot;&quot; + (i+1);</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+        comp.addProperty(prop);</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+    }</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+    for (let p = comp.getFirstProperty(&quot;ANY&quot;);</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+         p;</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+         p = comp.getNextProperty(&quot;ANY&quot;)) {</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+        do_check_eq(p.propertyName, propNames.shift());</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+    }</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+    propNames = [&quot;X-ONE&quot;, &quot;X-TWO&quot;];</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+    for (let p = comp.getNextProperty(&quot;ANY&quot;);</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+         p;</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+         p = comp.getNextProperty(&quot;ANY&quot;)) {</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+        do_check_eq(p.propertyName, propNames.shift());</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+    }</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+    // Param iterator</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+    let prop = svc.createIcalProperty(&quot;DTSTART&quot;);</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+    let params = [&quot;X-ONE&quot;, &quot;X-TWO&quot;];</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+    for (let i = 0; i &lt; params.length; i++) {</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineplus">+        prop.setParameter(params[i], &quot;&quot; + (i+1));</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+    }</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+    for (let p = prop.getFirstParameterName();</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+         p;</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+         p = prop.getNextParameterName()) {</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+        do_check_eq(p, params.shift());</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+    }</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+    // Now try again, but start with next. Should act like first</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+    params = [&quot;ONE&quot;, &quot;TWO&quot;];</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+    for (let p = prop.getNextParameterName();</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+         p;</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+         p = prop.getNextParameterName()) {</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+        do_check_eq(p, params.shift());</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+    }</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/calendar/test/unit/test_items.js</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,265 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+function run_test() {</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+    test_aclmanager();</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+    test_calendar();</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+    test_immutable();</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+    test_attendee();</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+    test_attachment();</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+    test_lastack();</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+    test_categories();</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+    test_alarm();</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+}</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+function test_aclmanager() {</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+    let mockCalendar = {</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+        get superCalendar() this,</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+        get aclManager() this,</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+        getItemEntry: function(item) {</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+            if (item.id == &quot;withentry&quot;) {</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+                return itemEntry;</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+            }</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+            return null;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+        },</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+    };</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+    let itemEntry = {</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+        userCanModify: true,</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+        userCanRespond: false,</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+        userCanViewAll: true,</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+        userCanViewDateAndTime: false,</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+    };</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+    let e = cal.createEvent();</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+    e.id = &quot;withentry&quot;;</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+    e.calendar = mockCalendar;</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+    do_check_eq(e.aclEntry.userCanModify, itemEntry.userCanModify);</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+    do_check_eq(e.aclEntry.userCanRespond, itemEntry.userCanRespond);</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+    do_check_eq(e.aclEntry.userCanViewAll, itemEntry.userCanViewAll);</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+    do_check_eq(e.aclEntry.userCanViewDateAndTime, itemEntry.userCanViewDateAndTime);</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+    let pe = cal.createEvent();</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+    pe.id = &quot;parententry&quot;;</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+    pe.calendar = mockCalendar;</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+    pe.parentItem = e;</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+    do_check_eq(pe.aclEntry.userCanModify, itemEntry.userCanModify);</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+    do_check_eq(pe.aclEntry.userCanRespond, itemEntry.userCanRespond);</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+    do_check_eq(pe.aclEntry.userCanViewAll, itemEntry.userCanViewAll);</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+    do_check_eq(pe.aclEntry.userCanViewDateAndTime, itemEntry.userCanViewDateAndTime);</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+    e = cal.createEvent();</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+    e.id = &quot;noentry&quot;;</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+    e.calendar = mockCalendar;</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+    do_check_eq(e.aclEntry, null);</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+}</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+function test_calendar() {</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+    let e = cal.createEvent();</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+    let pe = cal.createEvent();</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+    let mockCalendar = {</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+        id: &quot;one&quot;</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+    };</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+    pe.calendar = mockCalendar;</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+    e.parentItem = pe;</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+    do_check_neq(e.calendar, null);</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+    do_check_eq(e.calendar.id, &quot;one&quot;);</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+}</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+function test_attachment() {</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+    let e = cal.createEvent();</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+    let a = cal.createAttachment();</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+    a.rawData = &quot;horst&quot;;</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+    let b = cal.createAttachment();</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+    b.rawData = &quot;bruno&quot;;</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+    e.addAttachment(a);</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+    do_check_eq(e.getAttachments({}).length, 1);</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+    e.addAttachment(b);</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+    do_check_eq(e.getAttachments({}).length, 2);</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+    e.removeAttachment(a);</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+    do_check_eq(e.getAttachments({}).length, 1);</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+    e.removeAllAttachments();</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+    do_check_eq(e.getAttachments({}).length, 0);</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+}</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+function test_attendee() {</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+    let e = cal.createEvent();</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+    do_check_eq(e.getAttendeeById(&quot;unknown&quot;), null);</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+    do_check_eq(e.getAttendees({}).length, 0);</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+    let a = cal.createAttendee();</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+    a.id = &quot;mailto:horst&quot;;</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+    let b = cal.createAttendee();</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+    b.id = &quot;mailto:bruno&quot;;</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+    e.addAttendee(a);</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+    do_check_eq(e.getAttendees({}).length, 1);</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+    do_check_eq(e.getAttendeeById(&quot;mailto:horst&quot;), a);</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+    e.addAttendee(b);</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+    do_check_eq(e.getAttendees({}).length, 2);</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+    let comp = e.icalComponent;</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+    let aprop = comp.getFirstProperty(&quot;ATTENDEE&quot;);</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+    do_check_eq(aprop.value, &quot;mailto:horst&quot;);</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+    aprop = comp.getNextProperty(&quot;ATTENDEE&quot;);</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+    do_check_eq(aprop.value, &quot;mailto:bruno&quot;);</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+    do_check_eq(comp.getNextProperty(&quot;ATTENDEE&quot;), null);</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+    e.removeAttendee(a);</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+    do_check_eq(e.getAttendees({}).length, 1);</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+    do_check_eq(e.getAttendeeById(&quot;mailto:horst&quot;), null);</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+    e.removeAllAttendees();</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+    do_check_eq(e.getAttendees({}).length, 0);</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+}</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+function test_categories() {</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+    let e = cal.createEvent();</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+    do_check_eq(e.getCategories({}).length, 0);</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+    let cat = [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;];</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+    e.setCategories(3, cat);</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+    cat[0] = &quot;err&quot;;</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineplus">+    do_check_eq(e.getCategories({}).join(&quot;,&quot;), &quot;a,b,c&quot;);</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineplus">+</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineplus">+    let comp = e.icalComponent;</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineplus">+    let getter = comp.getFirstProperty.bind(comp);</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+    cat[0] = &quot;a&quot;;</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+    while (cat.length) {</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+        do_check_eq(cat.shift(), getter(&quot;CATEGORIES&quot;).value);</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+        getter = comp.getNextProperty.bind(comp);</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+    }</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineplus">+}</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+function test_alarm() {</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+    let e = cal.createEvent();</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+    let alarm = cal.createAlarm();</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+    alarm.action = &quot;DISPLAY&quot;;</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+    alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+    alarm.alarmDate = cal.createDateTime();</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+    e.addAlarm(alarm);</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineplus">+    let ecomp = e.icalComponent;</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineplus">+    let vcomp = ecomp.getFirstSubcomponent(&quot;VALARM&quot;);</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+    do_check_eq(vcomp.serializeToICS(), alarm.icalString);</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineplus">+</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+    let alarm2 = alarm.clone();</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineplus">+</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineplus">+    e.addAlarm(alarm2);</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineplus">+    do_check_eq(e.getAlarms({}).length, 2);</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineplus">+    e.deleteAlarm(alarm);</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+    do_check_eq(e.getAlarms({}).length, 1);</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineplus">+    do_check_eq(e.getAlarms({})[0], alarm2);</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineplus">+</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineplus">+    e.clearAlarms();</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+    do_check_eq(e.getAlarms({}).length, 0);</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineplus">+}</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineplus">+</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineplus">+function test_immutable() {</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineplus">+</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineplus">+    let e = cal.createEvent();</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineplus">+</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+    let dt = cal.createDateTime();</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineplus">+    dt.timezone = cal.getTimezoneService().getTimezone(&quot;Europe/Berlin&quot;);</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineplus">+    e.alarmLastAck = dt;</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineplus">+</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineplus">+    let org = cal.createAttendee();</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineplus">+    org.id = &quot;one&quot;;</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineplus">+    e.organizer = org;</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineplus">+</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineplus">+    let alarm = cal.createAlarm();</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineplus">+    alarm.action = &quot;DISPLAY&quot;;</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineplus">+    alarm.description = &quot;foo&quot;;</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+    alarm.related = alarm.ALARM_RELATED_START;</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineplus">+    alarm.offset = cal.createDuration(&quot;PT1S&quot;);</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineplus">+    e.addAlarm(alarm);</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineplus">+</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineplus">+    e.setProperty(&quot;X-NAME&quot;, &quot;X-VALUE&quot;);</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineplus">+    e.setPropertyParameter(&quot;X-NAME&quot;, &quot;X-PARAM&quot;, &quot;X-PARAMVAL&quot;);</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineplus">+</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+    e.setCategories(3, [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]);</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineplus">+    do_check_eq(e.alarmLastAck.timezone.tzid, cal.UTC().tzid);</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineplus">+</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineplus">+    e.makeImmutable();</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineplus">+</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineplus">+    // call again, should not throw</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineplus">+    e.makeImmutable();</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineplus">+</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineplus">+    do_check_false(e.alarmLastAck.isMutable);</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineplus">+    do_check_false(org.isMutable);</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineplus">+    do_check_false(alarm.isMutable);</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineplus">+</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineplus">+        e.alarmLastAck = cal.createDateTime();</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineplus">+    }, Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineplus">+        e.calendar = null;</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineplus">+    }, Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineplus">+        e.parentItem = null;</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineplus">+    }, Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineplus">+        e.setCategories(3, [&quot;d&quot;, &quot;e&quot;, &quot;f&quot;]);</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineplus">+    }, Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineplus">+</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineplus">+    let e2 = e.clone();</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineplus">+    e2.organizer.id = &quot;two&quot;;</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineplus">+</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineplus">+    do_check_eq(org.id, &quot;one&quot;);</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineplus">+    do_check_eq(e2.organizer.id, &quot;two&quot;);</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineplus">+</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineplus">+    do_check_eq(e2.getProperty(&quot;X-NAME&quot;), &quot;X-VALUE&quot;);</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineplus">+    do_check_eq(e2.getPropertyParameter(&quot;X-NAME&quot;, &quot;X-PARAM&quot;), &quot;X-PARAMVAL&quot;);</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineplus">+</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineplus">+    e2.setPropertyParameter(&quot;X-NAME&quot;, &quot;X-PARAM&quot;, null);</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineplus">+    do_check_eq(e2.getPropertyParameter(&quot;X-NAME&quot;, &quot;X-PARAM&quot;), null);</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineplus">+</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineplus">+    // TODO more clone checks</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineplus">+}</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineplus">+</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineplus">+function test_lastack() {</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineplus">+</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineplus">+    let e = cal.createEvent();</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineplus">+</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineplus">+    e.alarmLastAck = cal.createDateTime(&quot;20120101T010101&quot;);</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineplus">+</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineplus">+    // Our items don't support this yet</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineplus">+    //do_check_eq(e.getProperty(&quot;X-MOZ-LASTACK&quot;), &quot;20120101T010101&quot;);</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineplus">+</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineplus">+    let comp = e.icalComponent;</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineplus">+    let prop = comp.getFirstProperty(&quot;X-MOZ-LASTACK&quot;);</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineplus">+</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineplus">+    do_check_eq(prop.value, &quot;20120101T010101Z&quot;);</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineplus">+</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineplus">+    prop.value = &quot;20120101T010102Z&quot;;</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineplus">+</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineplus">+    e.icalComponent = comp;</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineplus">+</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineplus">+    do_check_eq(e.alarmLastAck.icalString, &quot;20120101T010102Z&quot;);</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/test/unit/test_recur.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/test/unit/test_recur.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,218 +1,280 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.5"></a><span id="l15.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.6"></a><span id="l15.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8"> function makeEvent(str) {</span>
<a href="#l15.9"></a><span id="l15.9">     return createEventFromIcalString(&quot;BEGIN:VEVENT\n&quot; + str + &quot;END:VEVENT&quot;);</span>
<a href="#l15.10"></a><span id="l15.10"> }</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+</span>
<a href="#l15.12"></a><span id="l15.12"> function run_test() {</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-    // Test general calIRecurrenceInfo functions</span>
<a href="#l15.14"></a><span id="l15.14">     test_interface();</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+    test_rrule_interface();</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+    test_rules();</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+    test_failures();</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+    test_limit();</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+    test_startdate_change();</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+    test_idchange();</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+}</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+function test_rules() {</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+    function check_recur(event, expected, ignoreNextOccCheck) {</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+        dump(&quot;Checking '&quot; + event.getProperty(&quot;DESCRIPTION&quot;) + &quot;'\n&quot;);</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+        // Get recurrence dates</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+        let start = createDate(1990, 0, 1);</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+        let end = createDate(2020, 0, 1);</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+        let recdates = event.recurrenceInfo.getOccurrenceDates(start, end, 0, {});</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+        let occurrences = event.recurrenceInfo.getOccurrences(start, end, 0, {});</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+        // Check number of items</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+        dump(&quot;Expected &quot; + expected.length + &quot; occurrences\n&quot;);</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+        dump(&quot;Got: &quot; + recdates.map(function(x) x.toString()) + &quot;\n&quot;);</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+        //do_check_eq(recdates.length, expected.length);</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+        let fmt = cal.getDateFormatter();</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+        for (let i = 0; i &lt; expected.length; i++) {</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+            // Check each date</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+            let ed = cal.createDateTime(expected[i]);</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+            dump(&quot;Expecting instance at &quot; + ed + &quot;(&quot; + fmt.dayName(ed.weekday) + &quot;)\n&quot;);</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+            dump(&quot;Recdate:&quot;);</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+            do_check_eq(recdates[i].icalString, expected[i]);</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+            // Make sure occurrences are correct</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+            dump(&quot;Occurrence:&quot;);</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+            do_check_eq(occurrences[i].startDate.icalString, expected[i]);</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+            if (ignoreNextOccCheck) {</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+                continue;</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+            }</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+            // Make sure getNextOccurrence works correctly</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+            let nextOcc = event.recurrenceInfo.getNextOccurrence(recdates[i]);</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+            if (expected.length &gt; i + 1) {</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+                do_check_neq(nextOcc, null);</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+                dump(&quot;Checking next occurrence: &quot; + expected[i+1]+&quot;\n&quot;);</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+                do_check_eq(nextOcc.startDate.icalString, expected[i + 1]);</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+            } else {</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+                dump(&quot;Expecting no more occurrences, found &quot; +</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+                        (nextOcc ? nextOcc.startDate : null) + &quot;\n&quot;);</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+                do_check_eq(nextOcc, null);</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+            }</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+            // Make sure getPreviousOccurrence works correctly</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+            let prevOcc = event.recurrenceInfo.getPreviousOccurrence(recdates[i]);</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+            if (i &gt; 0) {</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+                dump(&quot;Checking previous occurrence: &quot; + expected[i-1]+&quot;, found &quot; + (prevOcc ? prevOcc.startDate : prevOcc) + &quot;\n&quot;);</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+                do_check_neq(prevOcc, null);</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+                do_check_eq(prevOcc.startDate.icalString, expected[i - 1]);</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+            } else {</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+                dump(&quot;Expecting no previous occurrences, found &quot; +</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+                        (prevOcc ? prevOcc.startDate : prevOcc) + &quot;\n&quot;);</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+                do_check_eq(prevOcc, null);</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+            }</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+        }</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+        //  Make sure recurrenceInfo.clone works correctly</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+        test_clone(event);</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+    }</span>
<a href="#l15.81"></a><span id="l15.81"> </span>
<a href="#l15.82"></a><span id="l15.82">     // Test specific items/rules</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineminus">-    test_recur(makeEvent(&quot;DESCRIPTION:Repeat every tuesday and wednesday starting &quot; +</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+    check_recur(makeEvent(&quot;DESCRIPTION:Repeat every tuesday and wednesday starting &quot; +</span>
<a href="#l15.85"></a><span id="l15.85">                                      &quot;Tue 2nd April 2002\n&quot; +</span>
<a href="#l15.86"></a><span id="l15.86">                          &quot;RRULE:FREQ=WEEKLY;INTERVAL=1;COUNT=6;BYDAY=TU,WE\n&quot; +</span>
<a href="#l15.87"></a><span id="l15.87">                          &quot;DTSTART:20020402T114500\n&quot; +</span>
<a href="#l15.88"></a><span id="l15.88">                          &quot;DTEND:20020402T124500\n&quot;),</span>
<a href="#l15.89"></a><span id="l15.89">                          [&quot;20020402T114500&quot;, &quot;20020403T114500&quot;, &quot;20020409T114500&quot;,</span>
<a href="#l15.90"></a><span id="l15.90">                           &quot;20020410T114500&quot;, &quot;20020416T114500&quot;, &quot;20020417T114500&quot;]);</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-    test_recur(makeEvent(&quot;DESCRIPTION:Repeat every thursday starting Tue 2nd April 2002\n&quot; +</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+    check_recur(makeEvent(&quot;DESCRIPTION:Repeat every thursday starting Tue 2nd April 2002\n&quot; +</span>
<a href="#l15.94"></a><span id="l15.94">                          &quot;RRULE:FREQ=WEEKLY;INTERVAL=1;COUNT=6;BYDAY=TH\n&quot; +</span>
<a href="#l15.95"></a><span id="l15.95">                          &quot;DTSTART:20020402T114500\n&quot; +</span>
<a href="#l15.96"></a><span id="l15.96">                          &quot;DTEND:20020402T124500\n&quot;),</span>
<a href="#l15.97"></a><span id="l15.97">                          [&quot;20020402T114500&quot;, // DTSTART part of the resulting set</span>
<a href="#l15.98"></a><span id="l15.98">                           &quot;20020404T114500&quot;, &quot;20020411T114500&quot;, &quot;20020418T114500&quot;,</span>
<a href="#l15.99"></a><span id="l15.99">                           &quot;20020425T114500&quot;, &quot;20020502T114500&quot;, &quot;20020509T114500&quot;]);</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineminus">-</span>
<a href="#l15.101"></a><span id="l15.101">     // Bug 469840 -  Recurring Sundays incorrect</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineminus">-    test_recur(makeEvent(&quot;DESCRIPTION:RRULE:FREQ=WEEKLY;INTERVAL=2;COUNT=6;BYDAY=WE,SA,SU with DTSTART:20081217T133000\n&quot; +</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+    check_recur(makeEvent(&quot;DESCRIPTION:RRULE:FREQ=WEEKLY;INTERVAL=2;COUNT=6;BYDAY=WE,SA,SU with DTSTART:20081217T133000\n&quot; +</span>
<a href="#l15.104"></a><span id="l15.104">                          &quot;RRULE:FREQ=WEEKLY;INTERVAL=2;COUNT=6;BYDAY=WE,SA,SU\n&quot; +</span>
<a href="#l15.105"></a><span id="l15.105">                          &quot;DTSTART:20081217T133000\n&quot; +</span>
<a href="#l15.106"></a><span id="l15.106">                          &quot;DTEND:20081217T143000\n&quot;),</span>
<a href="#l15.107"></a><span id="l15.107">                [&quot;20081217T133000&quot;, &quot;20081220T133000&quot;, &quot;20081221T133000&quot;,</span>
<a href="#l15.108"></a><span id="l15.108">                 &quot;20081231T133000&quot;, &quot;20090103T133000&quot;, &quot;20090104T133000&quot;]);</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-    test_recur(makeEvent(&quot;DESCRIPTION:RRULE:FREQ=WEEKLY;INTERVAL=2;COUNT=6;WKST=SU;BYDAY=WE,SA,SU with DTSTART:20081217T133000\n&quot; +</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineplus">+    check_recur(makeEvent(&quot;DESCRIPTION:RRULE:FREQ=WEEKLY;INTERVAL=2;COUNT=6;WKST=SU;BYDAY=WE,SA,SU with DTSTART:20081217T133000\n&quot; +</span>
<a href="#l15.111"></a><span id="l15.111">                          &quot;RRULE:FREQ=WEEKLY;INTERVAL=2;COUNT=6;WKST=SU;BYDAY=WE,SA,SU\n&quot; +</span>
<a href="#l15.112"></a><span id="l15.112">                          &quot;DTSTART:20081217T133000\n&quot; +</span>
<a href="#l15.113"></a><span id="l15.113">                          &quot;DTEND:20081217T143000\n&quot;),</span>
<a href="#l15.114"></a><span id="l15.114">                [&quot;20081217T133000&quot;, &quot;20081220T133000&quot;, &quot;20081228T133000&quot;,</span>
<a href="#l15.115"></a><span id="l15.115">                 &quot;20081231T133000&quot;, &quot;20090103T133000&quot;, &quot;20090111T133000&quot;]);</span>
<a href="#l15.116"></a><span id="l15.116"> </span>
<a href="#l15.117"></a><span id="l15.117">     // bug 353797: occurrences for repeating all day events should stay &quot;all-day&quot;</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-    test_recur(makeEvent(&quot;DESCRIPTION:Allday repeat every thursday starting Tue 2nd April 2002\n&quot; +</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+    check_recur(makeEvent(&quot;DESCRIPTION:Allday repeat every thursday starting Tue 2nd April 2002\n&quot; +</span>
<a href="#l15.120"></a><span id="l15.120">                          &quot;RRULE:FREQ=WEEKLY;INTERVAL=1;COUNT=3;BYDAY=TH\n&quot; +</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-                         &quot;DTSTART:20020404\n&quot; +</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-                         &quot;DTEND:20020405\n&quot;),</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineplus">+                         &quot;DTSTART;VALUE=DATE:20020404\n&quot; +</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineplus">+                         &quot;DTEND;VALUE=DATE:20020405\n&quot;),</span>
<a href="#l15.125"></a><span id="l15.125">                          [&quot;20020404&quot;, &quot;20020411&quot;, &quot;20020418&quot;]);</span>
<a href="#l15.126"></a><span id="l15.126"> </span>
<a href="#l15.127"></a><span id="l15.127">     /* Test disabled, because BYWEEKNO is known to be broken</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineminus">-    test_recur(makeEvent(&quot;DESCRIPTION:Monday of week number 20 (where the default start of the week is Monday)\n&quot; +</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineplus">+    check_recur(makeEvent(&quot;DESCRIPTION:Monday of week number 20 (where the default start of the week is Monday)\n&quot; +</span>
<a href="#l15.130"></a><span id="l15.130">                          &quot;RRULE:FREQ=YEARLY;INTERVAL=1;COUNT=6;BYDAY=MO;BYWEEKNO=20\n&quot; +</span>
<a href="#l15.131"></a><span id="l15.131">                          &quot;DTSTART:19970512T090000&quot;,</span>
<a href="#l15.132"></a><span id="l15.132">                          [&quot;19970512T090000&quot;, &quot;19980511T090000&quot;, &quot;19990517T090000&quot; +</span>
<a href="#l15.133"></a><span id="l15.133">                           &quot;20000515T090000&quot;, &quot;20010514T090000&quot;, &quot;20020513T090000&quot;]);</span>
<a href="#l15.134"></a><span id="l15.134"> </span>
<a href="#l15.135"></a><span id="l15.135">     */</span>
<a href="#l15.136"></a><span id="l15.136"> </span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-    test_recur(makeEvent(&quot;DESCRIPTION:Every day, use exdate to exclude the second day\n&quot; +</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineplus">+    check_recur(makeEvent(&quot;DESCRIPTION:Every day, use exdate to exclude the second day\n&quot; +</span>
<a href="#l15.139"></a><span id="l15.139">                          &quot;RRULE:FREQ=DAILY;COUNT=3\n&quot; +</span>
<a href="#l15.140"></a><span id="l15.140">                          &quot;DTSTART:20020402T114500Z\n&quot; +</span>
<a href="#l15.141"></a><span id="l15.141">                          &quot;EXDATE:20020403T114500Z\n&quot;),</span>
<a href="#l15.142"></a><span id="l15.142">                          [&quot;20020402T114500Z&quot;, &quot;20020404T114500Z&quot;]);</span>
<a href="#l15.143"></a><span id="l15.143"> </span>
<a href="#l15.144"></a><span id="l15.144">     // test for issue 734245</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-    test_recur(makeEvent(&quot;DESCRIPTION:Every day, use exdate of type DATE to exclude the second day\n&quot; +</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineplus">+    check_recur(makeEvent(&quot;DESCRIPTION:Every day, use exdate of type DATE to exclude the second day\n&quot; +</span>
<a href="#l15.147"></a><span id="l15.147">                          &quot;RRULE:FREQ=DAILY;COUNT=3\n&quot; +</span>
<a href="#l15.148"></a><span id="l15.148">                          &quot;DTSTART:20020402T114500Z\n&quot; +</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineminus">-                         &quot;EXDATE:20020403\n&quot;),</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineplus">+                         &quot;EXDATE;VALUE=DATE:20020403\n&quot;),</span>
<a href="#l15.151"></a><span id="l15.151">                          [&quot;20020402T114500Z&quot;, &quot;20020404T114500Z&quot;]);</span>
<a href="#l15.152"></a><span id="l15.152"> </span>
<a href="#l15.153"></a><span id="l15.153" class="difflineminus">-    test_recur(makeEvent(&quot;DESCRIPTION:Use EXDATE to eliminate the base event\n&quot; +</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineplus">+    check_recur(makeEvent(&quot;DESCRIPTION:Use EXDATE to eliminate the base event\n&quot; +</span>
<a href="#l15.155"></a><span id="l15.155">                          &quot;RRULE:FREQ=DAILY;COUNT=1\n&quot; +</span>
<a href="#l15.156"></a><span id="l15.156">                          &quot;DTSTART:20020402T114500Z\n&quot; +</span>
<a href="#l15.157"></a><span id="l15.157">                          &quot;EXDATE:20020402T114500Z\n&quot;),</span>
<a href="#l15.158"></a><span id="l15.158">                          []);</span>
<a href="#l15.159"></a><span id="l15.159"> </span>
<a href="#l15.160"></a><span id="l15.160" class="difflineminus">-    test_recur(createEventFromIcalString(&quot;BEGIN:VCALENDAR\nBEGIN:VEVENT\n&quot; +</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineplus">+    check_recur(createEventFromIcalString(&quot;BEGIN:VCALENDAR\nBEGIN:VEVENT\n&quot; +</span>
<a href="#l15.162"></a><span id="l15.162">                                          &quot;UID:123\n&quot; +</span>
<a href="#l15.163"></a><span id="l15.163">                                          &quot;DESCRIPTION:Every day, exception put on exdated day\n&quot; +</span>
<a href="#l15.164"></a><span id="l15.164">                                          &quot;RRULE:FREQ=DAILY;COUNT=3\n&quot; +</span>
<a href="#l15.165"></a><span id="l15.165">                                          &quot;DTSTART:20020402T114500Z\n&quot; +</span>
<a href="#l15.166"></a><span id="l15.166">                                          &quot;EXDATE:20020403T114500Z\n&quot; +</span>
<a href="#l15.167"></a><span id="l15.167">                                          &quot;END:VEVENT\n&quot; +</span>
<a href="#l15.168"></a><span id="l15.168">                                          &quot;BEGIN:VEVENT\n&quot; +</span>
<a href="#l15.169"></a><span id="l15.169">                                          &quot;DTSTART:20020403T114500Z\n&quot; +</span>
<a href="#l15.170"></a><span id="l15.170">                                          &quot;UID:123\n&quot; +</span>
<a href="#l15.171"></a><span id="l15.171">                                          &quot;RECURRENCE-ID:20020404T114500Z\n&quot; +</span>
<a href="#l15.172"></a><span id="l15.172">                                          &quot;END:VEVENT\nEND:VCALENDAR\n&quot;),</span>
<a href="#l15.173"></a><span id="l15.173">                [&quot;20020402T114500Z&quot;, &quot;20020403T114500Z&quot;],</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineminus">-               true /* ignore next occ check, bug 455490 */);</span>
<a href="#l15.175"></a><span id="l15.175" class="difflineplus">+               true); // ignore next occ check, bug 455490</span>
<a href="#l15.176"></a><span id="l15.176"> </span>
<a href="#l15.177"></a><span id="l15.177" class="difflineminus">-    test_recur(createEventFromIcalString(&quot;BEGIN:VCALENDAR\nBEGIN:VEVENT\n&quot; +</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineplus">+    check_recur(createEventFromIcalString(&quot;BEGIN:VCALENDAR\nBEGIN:VEVENT\n&quot; +</span>
<a href="#l15.179"></a><span id="l15.179">                                          &quot;UID:123\n&quot; +</span>
<a href="#l15.180"></a><span id="l15.180">                                          &quot;DESCRIPTION:Every day, exception put on exdated start day\n&quot; +</span>
<a href="#l15.181"></a><span id="l15.181">                                          &quot;RRULE:FREQ=DAILY;COUNT=3\n&quot; +</span>
<a href="#l15.182"></a><span id="l15.182">                                          &quot;DTSTART:20020402T114500Z\n&quot; +</span>
<a href="#l15.183"></a><span id="l15.183">                                          &quot;EXDATE:20020402T114500Z\n&quot; +</span>
<a href="#l15.184"></a><span id="l15.184">                                          &quot;END:VEVENT\n&quot; +</span>
<a href="#l15.185"></a><span id="l15.185">                                          &quot;BEGIN:VEVENT\n&quot; +</span>
<a href="#l15.186"></a><span id="l15.186">                                          &quot;DTSTART:20020402T114500Z\n&quot; +</span>
<a href="#l15.187"></a><span id="l15.187">                                          &quot;UID:123\n&quot; +</span>
<a href="#l15.188"></a><span id="l15.188">                                          &quot;RECURRENCE-ID:20020404T114500Z\n&quot; +</span>
<a href="#l15.189"></a><span id="l15.189">                                          &quot;END:VEVENT\nEND:VCALENDAR\n&quot;),</span>
<a href="#l15.190"></a><span id="l15.190">                [&quot;20020402T114500Z&quot;, &quot;20020403T114500Z&quot;],</span>
<a href="#l15.191"></a><span id="l15.191">                true /* ignore next occ check, bug 455490 */);</span>
<a href="#l15.192"></a><span id="l15.192"> </span>
<a href="#l15.193"></a><span id="l15.193" class="difflineminus">-    test_recur(createEventFromIcalString(&quot;BEGIN:VCALENDAR\nBEGIN:VEVENT\n&quot; +</span>
<a href="#l15.194"></a><span id="l15.194" class="difflineplus">+    check_recur(createEventFromIcalString(&quot;BEGIN:VCALENDAR\nBEGIN:VEVENT\n&quot; +</span>
<a href="#l15.195"></a><span id="l15.195">                                          &quot;DESCRIPTION:Repeat Daily on weekdays with UNTIL\n&quot; +</span>
<a href="#l15.196"></a><span id="l15.196">                                          &quot;RRULE:FREQ=DAILY;UNTIL=20111217T220000Z;BYDAY=MO,TU,WE,TH,FR\n&quot; +</span>
<a href="#l15.197"></a><span id="l15.197">                                          &quot;DTSTART:20111212T220000Z\n&quot; +</span>
<a href="#l15.198"></a><span id="l15.198">                                          &quot;DTEND:20111212T230000Z\n&quot; +</span>
<a href="#l15.199"></a><span id="l15.199">                                          &quot;END:VEVENT\nEND:VCALENDAR\n&quot;),</span>
<a href="#l15.200"></a><span id="l15.200">                [&quot;20111212T220000Z&quot;, &quot;20111213T220000Z&quot;, &quot;20111214T220000Z&quot;, &quot;20111215T220000Z&quot;,</span>
<a href="#l15.201"></a><span id="l15.201">                 &quot;20111216T220000Z&quot;],</span>
<a href="#l15.202"></a><span id="l15.202">                false);</span>
<a href="#l15.203"></a><span id="l15.203"> </span>
<a href="#l15.204"></a><span id="l15.204" class="difflineminus">-    test_recur(createEventFromIcalString(&quot;BEGIN:VCALENDAR\nBEGIN:VEVENT\n&quot; +</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineplus">+    check_recur(createEventFromIcalString(&quot;BEGIN:VCALENDAR\nBEGIN:VEVENT\n&quot; +</span>
<a href="#l15.206"></a><span id="l15.206">                                          &quot;DESCRIPTION:Repeat Daily on weekdays with UNTIL and exception\n&quot; +</span>
<a href="#l15.207"></a><span id="l15.207">                                          &quot;RRULE:FREQ=DAILY;UNTIL=20111217T220000Z;BYDAY=MO,TU,WE,TH,FR\n&quot; +</span>
<a href="#l15.208"></a><span id="l15.208">                                          &quot;EXDATE:20111214T220000Z\n&quot; +</span>
<a href="#l15.209"></a><span id="l15.209">                                          &quot;DTSTART:20111212T220000Z\n&quot; +</span>
<a href="#l15.210"></a><span id="l15.210">                                          &quot;DTEND:20111212T230000Z\n&quot; +</span>
<a href="#l15.211"></a><span id="l15.211">                                          &quot;END:VEVENT\nEND:VCALENDAR\n&quot;),</span>
<a href="#l15.212"></a><span id="l15.212">                [&quot;20111212T220000Z&quot;, &quot;20111213T220000Z&quot;, &quot;20111215T220000Z&quot;, &quot;20111216T220000Z&quot;],</span>
<a href="#l15.213"></a><span id="l15.213">                false);</span>
<a href="#l15.214"></a><span id="l15.214"> </span>
<a href="#l15.215"></a><span id="l15.215" class="difflineminus">-    var item = makeEvent(&quot;DESCRIPTION:occurrence on day 1 moved between the occurrences &quot; +</span>
<a href="#l15.216"></a><span id="l15.216" class="difflineplus">+    let item, occ1;</span>
<a href="#l15.217"></a><span id="l15.217" class="difflineplus">+    item = makeEvent(&quot;DESCRIPTION:occurrence on day 1 moved between the occurrences &quot; +</span>
<a href="#l15.218"></a><span id="l15.218">                                      &quot;on days 2 and 3\n&quot; +</span>
<a href="#l15.219"></a><span id="l15.219">                          &quot;RRULE:FREQ=DAILY;COUNT=3\n&quot; +</span>
<a href="#l15.220"></a><span id="l15.220">                          &quot;DTSTART:20020402T114500Z\n&quot;);</span>
<a href="#l15.221"></a><span id="l15.221" class="difflineminus">-    var occ1 = item.recurrenceInfo.getOccurrenceFor(createDate(2002,3,2,true,11,45,0));</span>
<a href="#l15.222"></a><span id="l15.222" class="difflineplus">+    occ1 = item.recurrenceInfo.getOccurrenceFor(createDate(2002,3,2,true,11,45,0));</span>
<a href="#l15.223"></a><span id="l15.223">     occ1.startDate = createDate(2002,3,3,true,12,0,0);</span>
<a href="#l15.224"></a><span id="l15.224">     item.recurrenceInfo.modifyException(occ1, true);</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineminus">-    test_recur(item, [&quot;20020403T114500Z&quot;, &quot;20020403T120000Z&quot;, &quot;20020404T114500Z&quot;]);</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineplus">+    check_recur(item, [&quot;20020403T114500Z&quot;, &quot;20020403T120000Z&quot;, &quot;20020404T114500Z&quot;]);</span>
<a href="#l15.227"></a><span id="l15.227"> </span>
<a href="#l15.228"></a><span id="l15.228">     item = makeEvent(&quot;DESCRIPTION:occurrence on day 1 moved between the occurrences &quot; +</span>
<a href="#l15.229"></a><span id="l15.229">                                  &quot;on days 2 and 3, EXDATE on day 2\n&quot; +</span>
<a href="#l15.230"></a><span id="l15.230">                      &quot;RRULE:FREQ=DAILY;COUNT=3\n&quot; +</span>
<a href="#l15.231"></a><span id="l15.231">                      &quot;DTSTART:20020402T114500Z\n&quot; +</span>
<a href="#l15.232"></a><span id="l15.232">                      &quot;EXDATE:20020403T114500Z\n&quot;);</span>
<a href="#l15.233"></a><span id="l15.233">     occ1 = item.recurrenceInfo.getOccurrenceFor(createDate(2002,3,2,true,11,45,0));</span>
<a href="#l15.234"></a><span id="l15.234">     occ1.startDate = createDate(2002,3,3,true,12,0,0);</span>
<a href="#l15.235"></a><span id="l15.235">     item.recurrenceInfo.modifyException(occ1, true);</span>
<a href="#l15.236"></a><span id="l15.236" class="difflineminus">-    test_recur(item, [&quot;20020403T120000Z&quot;, &quot;20020404T114500Z&quot;]);</span>
<a href="#l15.237"></a><span id="l15.237" class="difflineplus">+    check_recur(item, [&quot;20020403T120000Z&quot;, &quot;20020404T114500Z&quot;]);</span>
<a href="#l15.238"></a><span id="l15.238"> </span>
<a href="#l15.239"></a><span id="l15.239">     item = makeEvent(&quot;DESCRIPTION:all occurrences have exceptions\n&quot; +</span>
<a href="#l15.240"></a><span id="l15.240">                      &quot;RRULE:FREQ=DAILY;COUNT=2\n&quot; +</span>
<a href="#l15.241"></a><span id="l15.241">                      &quot;DTSTART:20020402T114500Z\n&quot;);</span>
<a href="#l15.242"></a><span id="l15.242">     occ1 = item.recurrenceInfo.getOccurrenceFor(createDate(2002,3,2,true,11,45,0));</span>
<a href="#l15.243"></a><span id="l15.243">     occ1.startDate = createDate(2002,3,2,true,12,0,0);</span>
<a href="#l15.244"></a><span id="l15.244">     item.recurrenceInfo.modifyException(occ1, true);</span>
<a href="#l15.245"></a><span id="l15.245" class="difflineminus">-    var occ2 = item.recurrenceInfo.getOccurrenceFor(createDate(2002,3,3,true,11,45,0));</span>
<a href="#l15.246"></a><span id="l15.246" class="difflineplus">+    let occ2 = item.recurrenceInfo.getOccurrenceFor(createDate(2002,3,3,true,11,45,0));</span>
<a href="#l15.247"></a><span id="l15.247">     occ2.startDate = createDate(2002,3,3,true,12,0,0);</span>
<a href="#l15.248"></a><span id="l15.248">     item.recurrenceInfo.modifyException(occ2, true);</span>
<a href="#l15.249"></a><span id="l15.249" class="difflineminus">-    test_recur(item, [&quot;20020402T120000Z&quot;, &quot;20020403T120000Z&quot;]);</span>
<a href="#l15.250"></a><span id="l15.250" class="difflineplus">+    check_recur(item, [&quot;20020402T120000Z&quot;, &quot;20020403T120000Z&quot;]);</span>
<a href="#l15.251"></a><span id="l15.251"> </span>
<a href="#l15.252"></a><span id="l15.252">     item = makeEvent(&quot;DESCRIPTION:rdate and exception before the recurrence start date\n&quot; +</span>
<a href="#l15.253"></a><span id="l15.253">                      &quot;RRULE:FREQ=DAILY;COUNT=2\n&quot; +</span>
<a href="#l15.254"></a><span id="l15.254">                      &quot;DTSTART:20020402T114500Z\n&quot; +</span>
<a href="#l15.255"></a><span id="l15.255">                      &quot;RDATE:20020401T114500Z\n&quot;);</span>
<a href="#l15.256"></a><span id="l15.256">     occ1 = item.recurrenceInfo.getOccurrenceFor(createDate(2002,3,2,true,11,45,0));</span>
<a href="#l15.257"></a><span id="l15.257">     occ1.startDate = createDate(2002,2,30,true,11,45,0);</span>
<a href="#l15.258"></a><span id="l15.258">     item.recurrenceInfo.modifyException(occ1, true);</span>
<a href="#l15.259"></a><span id="l15.259" class="difflineminus">-    test_recur(item, [&quot;20020330T114500Z&quot;, &quot;20020401T114500Z&quot;, &quot;20020403T114500Z&quot;]);</span>
<a href="#l15.260"></a><span id="l15.260" class="difflineplus">+    check_recur(item, [&quot;20020330T114500Z&quot;, &quot;20020401T114500Z&quot;, &quot;20020403T114500Z&quot;]);</span>
<a href="#l15.261"></a><span id="l15.261" class="difflineplus">+</span>
<a href="#l15.262"></a><span id="l15.262" class="difflineplus">+    item = makeEvent(&quot;DESCRIPTION:bug 734245, an EXDATE of type DATE shall also match a DTSTART of type DATE-TIME\n&quot; +</span>
<a href="#l15.263"></a><span id="l15.263" class="difflineplus">+                     &quot;RRULE:FREQ=DAILY;COUNT=3\n&quot; +</span>
<a href="#l15.264"></a><span id="l15.264" class="difflineplus">+                     &quot;DTSTART:20020401T114500Z\n&quot; +</span>
<a href="#l15.265"></a><span id="l15.265" class="difflineplus">+                     &quot;EXDATE;VALUE=DATE:20020402\n&quot;);</span>
<a href="#l15.266"></a><span id="l15.266" class="difflineplus">+</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineplus">+    check_recur(item, [&quot;20020401T114500Z&quot;, &quot;20020403T114500Z&quot;]);</span>
<a href="#l15.268"></a><span id="l15.268" class="difflineplus">+</span>
<a href="#l15.269"></a><span id="l15.269" class="difflineplus">+    item = makeEvent(&quot;DESCRIPTION:EXDATE with a timezone\n&quot; +</span>
<a href="#l15.270"></a><span id="l15.270" class="difflineplus">+                     &quot;RRULE:FREQ=DAILY;COUNT=3\n&quot; +</span>
<a href="#l15.271"></a><span id="l15.271" class="difflineplus">+                     &quot;DTSTART;TZID=Europe/Berlin:20020401T114500\n&quot; +</span>
<a href="#l15.272"></a><span id="l15.272" class="difflineplus">+                     &quot;EXDATE;TZID=Europe/Berlin:20020402T114500\n&quot;);</span>
<a href="#l15.273"></a><span id="l15.273" class="difflineplus">+</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineplus">+    check_recur(item, [&quot;20020401T114500&quot;, &quot;20020403T114500&quot;]);</span>
<a href="#l15.275"></a><span id="l15.275"> }</span>
<a href="#l15.276"></a><span id="l15.276"> </span>
<a href="#l15.277"></a><span id="l15.277" class="difflineminus">-function test_recur(event, expected, ignoreNextOccCheck) {</span>
<a href="#l15.278"></a><span id="l15.278" class="difflineminus">-    dump(&quot;Checking '&quot; + event.getProperty(&quot;DESCRIPTION&quot;) + &quot;'\n&quot;);</span>
<a href="#l15.279"></a><span id="l15.279" class="difflineminus">-    // Get recurrence dates</span>
<a href="#l15.280"></a><span id="l15.280" class="difflineplus">+function test_limit() {</span>
<a href="#l15.281"></a><span id="l15.281" class="difflineplus">+    let item = makeEvent(&quot;RRULE:FREQ=DAILY;COUNT=3\n&quot; +</span>
<a href="#l15.282"></a><span id="l15.282" class="difflineplus">+                         &quot;UID:1\n&quot; +</span>
<a href="#l15.283"></a><span id="l15.283" class="difflineplus">+                         &quot;DTSTART:20020401T114500\n&quot; +</span>
<a href="#l15.284"></a><span id="l15.284" class="difflineplus">+                         &quot;DTEND:20020401T124500\n&quot;);</span>
<a href="#l15.285"></a><span id="l15.285" class="difflineplus">+    dump(&quot;ics: &quot; + item.icalString + &quot;\n&quot;);</span>
<a href="#l15.286"></a><span id="l15.286" class="difflineplus">+</span>
<a href="#l15.287"></a><span id="l15.287">     let start = createDate(1990, 0, 1);</span>
<a href="#l15.288"></a><span id="l15.288">     let end = createDate(2020, 0, 1);</span>
<a href="#l15.289"></a><span id="l15.289" class="difflineminus">-    let recdates = event.recurrenceInfo.getOccurrenceDates(start, end, 0, {});</span>
<a href="#l15.290"></a><span id="l15.290" class="difflineminus">-    let occurrences = event.recurrenceInfo.getOccurrences(start, end, 0, {});</span>
<a href="#l15.291"></a><span id="l15.291" class="difflineminus">-</span>
<a href="#l15.292"></a><span id="l15.292" class="difflineminus">-    // Check number of items</span>
<a href="#l15.293"></a><span id="l15.293" class="difflineminus">-    do_check_eq(recdates.length, expected.length);</span>
<a href="#l15.294"></a><span id="l15.294" class="difflineplus">+    let recdates = item.recurrenceInfo.getOccurrenceDates(start, end, 0, {});</span>
<a href="#l15.295"></a><span id="l15.295" class="difflineplus">+    let occurrences = item.recurrenceInfo.getOccurrences(start, end, 0, {});</span>
<a href="#l15.296"></a><span id="l15.296"> </span>
<a href="#l15.297"></a><span id="l15.297" class="difflineminus">-    for (let i = 0; i &lt; expected.length; i++) {</span>
<a href="#l15.298"></a><span id="l15.298" class="difflineminus">-        // Check each date</span>
<a href="#l15.299"></a><span id="l15.299" class="difflineminus">-        do_check_eq(recdates[i].icalString, expected[i]);</span>
<a href="#l15.300"></a><span id="l15.300" class="difflineplus">+    do_check_eq(recdates.length, 3);</span>
<a href="#l15.301"></a><span id="l15.301" class="difflineplus">+    do_check_eq(occurrences.length, 3);</span>
<a href="#l15.302"></a><span id="l15.302"> </span>
<a href="#l15.303"></a><span id="l15.303" class="difflineminus">-        // Make sure occurrences are correct</span>
<a href="#l15.304"></a><span id="l15.304" class="difflineminus">-        do_check_eq(occurrences[i].startDate.icalString, expected[i]);</span>
<a href="#l15.305"></a><span id="l15.305" class="difflineminus">-</span>
<a href="#l15.306"></a><span id="l15.306" class="difflineminus">-        if (ignoreNextOccCheck) {</span>
<a href="#l15.307"></a><span id="l15.307" class="difflineminus">-            continue;</span>
<a href="#l15.308"></a><span id="l15.308" class="difflineminus">-        }</span>
<a href="#l15.309"></a><span id="l15.309" class="difflineplus">+    recdates = item.recurrenceInfo.getOccurrenceDates(start, end, 2, {});</span>
<a href="#l15.310"></a><span id="l15.310" class="difflineplus">+    occurrences = item.recurrenceInfo.getOccurrences(start, end, 2, {});</span>
<a href="#l15.311"></a><span id="l15.311"> </span>
<a href="#l15.312"></a><span id="l15.312" class="difflineminus">-        // Make sure getNextOccurrence works correctly</span>
<a href="#l15.313"></a><span id="l15.313" class="difflineminus">-        let nextOcc = event.recurrenceInfo.getNextOccurrence(recdates[i]);</span>
<a href="#l15.314"></a><span id="l15.314" class="difflineminus">-        if (expected.length &gt; i + 1) {</span>
<a href="#l15.315"></a><span id="l15.315" class="difflineminus">-            do_check_neq(nextOcc, null);</span>
<a href="#l15.316"></a><span id="l15.316" class="difflineminus">-            do_check_eq(nextOcc.startDate.icalString, expected[i + 1]);</span>
<a href="#l15.317"></a><span id="l15.317" class="difflineminus">-        } else {</span>
<a href="#l15.318"></a><span id="l15.318" class="difflineminus">-            do_check_eq(nextOcc, null);</span>
<a href="#l15.319"></a><span id="l15.319" class="difflineminus">-        }</span>
<a href="#l15.320"></a><span id="l15.320" class="difflineplus">+    do_check_eq(recdates.length, 2);</span>
<a href="#l15.321"></a><span id="l15.321" class="difflineplus">+    do_check_eq(occurrences.length, 2);</span>
<a href="#l15.322"></a><span id="l15.322"> </span>
<a href="#l15.323"></a><span id="l15.323" class="difflineminus">-        // Make sure getPreviousOccurrence works correctly</span>
<a href="#l15.324"></a><span id="l15.324" class="difflineminus">-        let prevOcc = event.recurrenceInfo.getPreviousOccurrence(recdates[i]);</span>
<a href="#l15.325"></a><span id="l15.325" class="difflineminus">-        if (i &gt; 0) {</span>
<a href="#l15.326"></a><span id="l15.326" class="difflineminus">-            do_check_neq(prevOcc, null);</span>
<a href="#l15.327"></a><span id="l15.327" class="difflineminus">-            do_check_eq(prevOcc.startDate.icalString, expected[i - 1]);</span>
<a href="#l15.328"></a><span id="l15.328" class="difflineminus">-        } else {</span>
<a href="#l15.329"></a><span id="l15.329" class="difflineminus">-            do_check_eq(prevOcc, null);</span>
<a href="#l15.330"></a><span id="l15.330" class="difflineminus">-        }</span>
<a href="#l15.331"></a><span id="l15.331" class="difflineminus">-    }</span>
<a href="#l15.332"></a><span id="l15.332" class="difflineplus">+    recdates = item.recurrenceInfo.getOccurrenceDates(start, end, 9, {});</span>
<a href="#l15.333"></a><span id="l15.333" class="difflineplus">+    occurrences = item.recurrenceInfo.getOccurrences(start, end, 9, {});</span>
<a href="#l15.334"></a><span id="l15.334"> </span>
<a href="#l15.335"></a><span id="l15.335" class="difflineminus">-    //  Make sure recurrenceInfo.clone works correctly</span>
<a href="#l15.336"></a><span id="l15.336" class="difflineminus">-    test_clone(event);</span>
<a href="#l15.337"></a><span id="l15.337" class="difflineplus">+    do_check_eq(recdates.length, 3);</span>
<a href="#l15.338"></a><span id="l15.338" class="difflineplus">+    do_check_eq(occurrences.length, 3);</span>
<a href="#l15.339"></a><span id="l15.339"> }</span>
<a href="#l15.340"></a><span id="l15.340"> </span>
<a href="#l15.341"></a><span id="l15.341"> function test_clone(event) {</span>
<a href="#l15.342"></a><span id="l15.342">     let oldRecurItems = event.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l15.343"></a><span id="l15.343">     let cloned = event.recurrenceInfo.clone();</span>
<a href="#l15.344"></a><span id="l15.344">     let newRecurItems = cloned.getRecurrenceItems({});</span>
<a href="#l15.345"></a><span id="l15.345"> </span>
<a href="#l15.346"></a><span id="l15.346">     // Check number of recurrence items</span>
<a href="#l15.347"></a><span id="l15.347" class="difflineat">@@ -221,101 +283,300 @@ function test_clone(event) {</span>
<a href="#l15.348"></a><span id="l15.348">     for (let i = 0; i &lt; oldRecurItems.length; i++) {</span>
<a href="#l15.349"></a><span id="l15.349">         // Check if recurrence item cloned correctly</span>
<a href="#l15.350"></a><span id="l15.350">         do_check_eq(oldRecurItems[i].icalProperty.icalString,</span>
<a href="#l15.351"></a><span id="l15.351">                     newRecurItems[i].icalProperty.icalString);</span>
<a href="#l15.352"></a><span id="l15.352">     }</span>
<a href="#l15.353"></a><span id="l15.353"> }</span>
<a href="#l15.354"></a><span id="l15.354"> </span>
<a href="#l15.355"></a><span id="l15.355"> function test_interface() {</span>
<a href="#l15.356"></a><span id="l15.356" class="difflineminus">-    var RRULE = &quot;RRULE:FREQ=WEEKLY;COUNT=6;BYDAY=TU,WE\r\n&quot;;</span>
<a href="#l15.357"></a><span id="l15.357" class="difflineminus">-    var EXDATE = &quot;EXDATE:20020403T114500Z\r\n&quot;</span>
<a href="#l15.358"></a><span id="l15.358" class="difflineminus">-    var RDATE = &quot;RDATE;VALUE=DATE-TIME:20020401T114500Z\r\n&quot;;</span>
<a href="#l15.359"></a><span id="l15.359" class="difflineplus">+    let RRULE = &quot;RRULE:FREQ=WEEKLY;COUNT=6;BYDAY=TU,WE\r\n&quot;;</span>
<a href="#l15.360"></a><span id="l15.360" class="difflineplus">+    let EXDATE = &quot;EXDATE:20020403T114500Z\r\n&quot;</span>
<a href="#l15.361"></a><span id="l15.361" class="difflineplus">+    let RDATE = &quot;RDATE;VALUE=DATE-TIME:20020401T114500Z\r\n&quot;;</span>
<a href="#l15.362"></a><span id="l15.362"> </span>
<a href="#l15.363"></a><span id="l15.363" class="difflineminus">-    var item = makeEvent(&quot;DTSTART:20020402T114500Z\n&quot; +</span>
<a href="#l15.364"></a><span id="l15.364" class="difflineplus">+    let item = makeEvent(&quot;DTSTART:20020402T114500Z\n&quot; +</span>
<a href="#l15.365"></a><span id="l15.365">                          &quot;DTEND:20020402T124500Z\n&quot; +</span>
<a href="#l15.366"></a><span id="l15.366">                          RRULE + EXDATE + RDATE);</span>
<a href="#l15.367"></a><span id="l15.367"> </span>
<a href="#l15.368"></a><span id="l15.368" class="difflineminus">-    var rinfo = item.recurrenceInfo;</span>
<a href="#l15.369"></a><span id="l15.369" class="difflineplus">+    let rinfo = item.recurrenceInfo;</span>
<a href="#l15.370"></a><span id="l15.370"> </span>
<a href="#l15.371"></a><span id="l15.371">     do_check_true(compareObjects(rinfo.item, item, Components.interfaces.calIEvent));</span>
<a href="#l15.372"></a><span id="l15.372"> </span>
<a href="#l15.373"></a><span id="l15.373">     // getRecurrenceItems</span>
<a href="#l15.374"></a><span id="l15.374" class="difflineminus">-    var ritems = rinfo.getRecurrenceItems({});</span>
<a href="#l15.375"></a><span id="l15.375" class="difflineplus">+    let ritems = rinfo.getRecurrenceItems({});</span>
<a href="#l15.376"></a><span id="l15.376">     do_check_eq(ritems.length, 3);</span>
<a href="#l15.377"></a><span id="l15.377">     do_check_eq(ritems[0].icalProperty.icalString, RRULE);</span>
<a href="#l15.378"></a><span id="l15.378">     do_check_eq(ritems[1].icalProperty.icalString, EXDATE);</span>
<a href="#l15.379"></a><span id="l15.379">     do_check_eq(ritems[2].icalProperty.icalString, RDATE);</span>
<a href="#l15.380"></a><span id="l15.380"> </span>
<a href="#l15.381"></a><span id="l15.381">     // setRecurrenceItems</span>
<a href="#l15.382"></a><span id="l15.382" class="difflineminus">-    var newRItems = [Cc[&quot;@mozilla.org/calendar/recurrence-rule;1&quot;].createInstance(Components.interfaces.calIRecurrenceRule)];</span>
<a href="#l15.383"></a><span id="l15.383" class="difflineplus">+    let newRItems = [cal.createRecurrenceRule(), cal.createRecurrenceDate()];</span>
<a href="#l15.384"></a><span id="l15.384"> </span>
<a href="#l15.385"></a><span id="l15.385">     newRItems[0].type = &quot;DAILY&quot;;</span>
<a href="#l15.386"></a><span id="l15.386">     newRItems[0].interval = 1;</span>
<a href="#l15.387"></a><span id="l15.387">     newRItems[0].count = 1;</span>
<a href="#l15.388"></a><span id="l15.388" class="difflineplus">+    newRItems[1].isNegative = true;</span>
<a href="#l15.389"></a><span id="l15.389" class="difflineplus">+    newRItems[1].date = cal.createDateTime(&quot;20020404T114500Z&quot;);</span>
<a href="#l15.390"></a><span id="l15.390"> </span>
<a href="#l15.391"></a><span id="l15.391" class="difflineminus">-    rinfo.setRecurrenceItems(1, newRItems);</span>
<a href="#l15.392"></a><span id="l15.392" class="difflineminus">-    var itemString = item.icalString;</span>
<a href="#l15.393"></a><span id="l15.393" class="difflineplus">+    rinfo.setRecurrenceItems(2, newRItems);</span>
<a href="#l15.394"></a><span id="l15.394" class="difflineplus">+    let itemString = item.icalString;</span>
<a href="#l15.395"></a><span id="l15.395"> </span>
<a href="#l15.396"></a><span id="l15.396">     do_check_true(itemString.indexOf(RRULE) &lt; 0);</span>
<a href="#l15.397"></a><span id="l15.397">     do_check_true(itemString.indexOf(EXDATE) &lt; 0);</span>
<a href="#l15.398"></a><span id="l15.398">     do_check_true(itemString.indexOf(RDATE) &lt; 0);</span>
<a href="#l15.399"></a><span id="l15.399">     do_check_false(itemString.indexOf(newRItems[0].icalProperty.icalString) &lt; 0);</span>
<a href="#l15.400"></a><span id="l15.400" class="difflineplus">+    do_check_false(itemString.indexOf(newRItems[1].icalProperty.icalString) &lt; 0);</span>
<a href="#l15.401"></a><span id="l15.401" class="difflineplus">+</span>
<a href="#l15.402"></a><span id="l15.402" class="difflineplus">+    // This may be an implementation detail, but we don't want this breaking</span>
<a href="#l15.403"></a><span id="l15.403" class="difflineplus">+    rinfo.wrappedJSObject.ensureSortedRecurrenceRules();</span>
<a href="#l15.404"></a><span id="l15.404" class="difflineplus">+    do_check_eq(rinfo.wrappedJSObject.mNegativeRules[0].icalProperty.icalString, newRItems[1].icalProperty.icalString);</span>
<a href="#l15.405"></a><span id="l15.405" class="difflineplus">+    do_check_eq(rinfo.wrappedJSObject.mPositiveRules[0].icalProperty.icalString, newRItems[0].icalProperty.icalString);</span>
<a href="#l15.406"></a><span id="l15.406"> </span>
<a href="#l15.407"></a><span id="l15.407">     // countRecurrenceItems</span>
<a href="#l15.408"></a><span id="l15.408" class="difflineminus">-    do_check_eq(1, rinfo.countRecurrenceItems());</span>
<a href="#l15.409"></a><span id="l15.409" class="difflineplus">+    do_check_eq(2, rinfo.countRecurrenceItems());</span>
<a href="#l15.410"></a><span id="l15.410"> </span>
<a href="#l15.411"></a><span id="l15.411">     // clearRecurrenceItems</span>
<a href="#l15.412"></a><span id="l15.412">     rinfo.clearRecurrenceItems();</span>
<a href="#l15.413"></a><span id="l15.413">     do_check_eq(0, rinfo.countRecurrenceItems());</span>
<a href="#l15.414"></a><span id="l15.414"> </span>
<a href="#l15.415"></a><span id="l15.415" class="difflineminus">-    // appendRecurrenceItems / getRecurrenceItemAt</span>
<a href="#l15.416"></a><span id="l15.416" class="difflineminus">-    rinfo.appendRecurrenceItem(ritems[2]);</span>
<a href="#l15.417"></a><span id="l15.417" class="difflineplus">+    // appendRecurrenceItems / getRecurrenceItemAt / insertRecurrenceItemAt</span>
<a href="#l15.418"></a><span id="l15.418">     rinfo.appendRecurrenceItem(ritems[0]);</span>
<a href="#l15.419"></a><span id="l15.419">     rinfo.appendRecurrenceItem(ritems[1]);</span>
<a href="#l15.420"></a><span id="l15.420" class="difflineplus">+    rinfo.insertRecurrenceItemAt(ritems[2], 0);</span>
<a href="#l15.421"></a><span id="l15.421"> </span>
<a href="#l15.422"></a><span id="l15.422">     do_check_true(compareObjects(ritems[2],</span>
<a href="#l15.423"></a><span id="l15.423">                                  rinfo.getRecurrenceItemAt(0),</span>
<a href="#l15.424"></a><span id="l15.424">                                  Components.interfaces.calIRecurrenceItem));</span>
<a href="#l15.425"></a><span id="l15.425">     do_check_true(compareObjects(ritems[0],</span>
<a href="#l15.426"></a><span id="l15.426">                                  rinfo.getRecurrenceItemAt(1),</span>
<a href="#l15.427"></a><span id="l15.427">                                  Components.interfaces.calIRecurrenceItem));</span>
<a href="#l15.428"></a><span id="l15.428">     do_check_true(compareObjects(ritems[1],</span>
<a href="#l15.429"></a><span id="l15.429">                                  rinfo.getRecurrenceItemAt(2),</span>
<a href="#l15.430"></a><span id="l15.430">                                  Components.interfaces.calIRecurrenceItem));</span>
<a href="#l15.431"></a><span id="l15.431"> </span>
<a href="#l15.432"></a><span id="l15.432" class="difflineplus">+</span>
<a href="#l15.433"></a><span id="l15.433">     // deleteRecurrenceItem</span>
<a href="#l15.434"></a><span id="l15.434">     rinfo.deleteRecurrenceItem(ritems[0]);</span>
<a href="#l15.435"></a><span id="l15.435">     do_check_true(item.icalString.indexOf(RRULE) &lt; 0);</span>
<a href="#l15.436"></a><span id="l15.436"> </span>
<a href="#l15.437"></a><span id="l15.437">     // deleteRecurrenceItemAt</span>
<a href="#l15.438"></a><span id="l15.438">     rinfo.deleteRecurrenceItemAt(1);</span>
<a href="#l15.439"></a><span id="l15.439">     itemString = item.icalString;</span>
<a href="#l15.440"></a><span id="l15.440">     do_check_true(itemString.indexOf(EXDATE) &lt; 0);</span>
<a href="#l15.441"></a><span id="l15.441">     do_check_false(itemString.indexOf(RDATE) &lt; 0);</span>
<a href="#l15.442"></a><span id="l15.442"> </span>
<a href="#l15.443"></a><span id="l15.443" class="difflineminus">-    // isFinite</span>
<a href="#l15.444"></a><span id="l15.444" class="difflineplus">+    // insertRecurrenceItemAt with exdate</span>
<a href="#l15.445"></a><span id="l15.445" class="difflineplus">+    rinfo.insertRecurrenceItemAt(ritems[1], 1);</span>
<a href="#l15.446"></a><span id="l15.446" class="difflineplus">+    do_check_true(compareObjects(ritems[1],</span>
<a href="#l15.447"></a><span id="l15.447" class="difflineplus">+                                 rinfo.getRecurrenceItemAt(1),</span>
<a href="#l15.448"></a><span id="l15.448" class="difflineplus">+                                 Components.interfaces.calIRecurrenceItem));</span>
<a href="#l15.449"></a><span id="l15.449" class="difflineplus">+    rinfo.deleteRecurrenceItem(ritems[1]);</span>
<a href="#l15.450"></a><span id="l15.450" class="difflineplus">+</span>
<a href="#l15.451"></a><span id="l15.451" class="difflineplus">+    // isFinite = true</span>
<a href="#l15.452"></a><span id="l15.452">     do_check_true(rinfo.isFinite);</span>
<a href="#l15.453"></a><span id="l15.453">     rinfo.appendRecurrenceItem(ritems[0]);</span>
<a href="#l15.454"></a><span id="l15.454">     do_check_true(rinfo.isFinite);</span>
<a href="#l15.455"></a><span id="l15.455"> </span>
<a href="#l15.456"></a><span id="l15.456" class="difflineplus">+    // isFinite = false</span>
<a href="#l15.457"></a><span id="l15.457" class="difflineplus">+    let item2 = makeEvent(&quot;DTSTART:20020402T114500Z\n&quot; +</span>
<a href="#l15.458"></a><span id="l15.458" class="difflineplus">+                          &quot;DTEND:20020402T124500Z\n&quot; +</span>
<a href="#l15.459"></a><span id="l15.459" class="difflineplus">+                          &quot;RRULE:FREQ=WEEKLY;BYDAY=TU,WE\n&quot;);</span>
<a href="#l15.460"></a><span id="l15.460" class="difflineplus">+    do_check_false(item2.recurrenceInfo.isFinite);</span>
<a href="#l15.461"></a><span id="l15.461" class="difflineplus">+</span>
<a href="#l15.462"></a><span id="l15.462">     // removeOccurrenceAt/restoreOccurreceAt</span>
<a href="#l15.463"></a><span id="l15.463" class="difflineminus">-    var occDate = createDate(2002,3,3,true,11,45,0)</span>
<a href="#l15.464"></a><span id="l15.464" class="difflineminus">-    rinfo.removeOccurrenceAt(occDate);</span>
<a href="#l15.465"></a><span id="l15.465" class="difflineplus">+    let occDate1 = cal.createDateTime(&quot;20020403T114500Z&quot;);</span>
<a href="#l15.466"></a><span id="l15.466" class="difflineplus">+    let occDate2 = cal.createDateTime(&quot;20020404T114500Z&quot;);</span>
<a href="#l15.467"></a><span id="l15.467" class="difflineplus">+    rinfo.removeOccurrenceAt(occDate1);</span>
<a href="#l15.468"></a><span id="l15.468">     do_check_false(item.icalString.indexOf(EXDATE) &lt; 0);</span>
<a href="#l15.469"></a><span id="l15.469" class="difflineminus">-    rinfo.restoreOccurrenceAt(occDate)</span>
<a href="#l15.470"></a><span id="l15.470" class="difflineplus">+    rinfo.restoreOccurrenceAt(occDate1)</span>
<a href="#l15.471"></a><span id="l15.471">     do_check_true(item.icalString.indexOf(EXDATE) &lt; 0);</span>
<a href="#l15.472"></a><span id="l15.472"> </span>
<a href="#l15.473"></a><span id="l15.473">     // modifyException / getExceptionFor</span>
<a href="#l15.474"></a><span id="l15.474" class="difflineminus">-    var occ =  rinfo.getOccurrenceFor(occDate);</span>
<a href="#l15.475"></a><span id="l15.475" class="difflineminus">-    occ.startDate = createDate(2002,3,1,true,11,45,0);</span>
<a href="#l15.476"></a><span id="l15.476" class="difflineplus">+    let occ = rinfo.getOccurrenceFor(occDate1);</span>
<a href="#l15.477"></a><span id="l15.477" class="difflineplus">+    occ.startDate = cal.createDateTime(&quot;20020401T114500&quot;);</span>
<a href="#l15.478"></a><span id="l15.478">     rinfo.modifyException(occ, true);</span>
<a href="#l15.479"></a><span id="l15.479" class="difflineminus">-    do_check_true(rinfo.getExceptionFor(occDate) != null);</span>
<a href="#l15.480"></a><span id="l15.480" class="difflineplus">+    do_check_true(rinfo.getExceptionFor(occDate1) != null);</span>
<a href="#l15.481"></a><span id="l15.481" class="difflineplus">+</span>
<a href="#l15.482"></a><span id="l15.482" class="difflineplus">+    // modifyException immutable</span>
<a href="#l15.483"></a><span id="l15.483" class="difflineplus">+    let occ = rinfo.getOccurrenceFor(occDate2);</span>
<a href="#l15.484"></a><span id="l15.484" class="difflineplus">+    occ.makeImmutable();</span>
<a href="#l15.485"></a><span id="l15.485" class="difflineplus">+    rinfo.modifyException(occ, true);</span>
<a href="#l15.486"></a><span id="l15.486" class="difflineplus">+    do_check_true(rinfo.getExceptionFor(occDate2) != null);</span>
<a href="#l15.487"></a><span id="l15.487"> </span>
<a href="#l15.488"></a><span id="l15.488">     // getExceptionIds</span>
<a href="#l15.489"></a><span id="l15.489" class="difflineminus">-    var ids = rinfo.getExceptionIds({});</span>
<a href="#l15.490"></a><span id="l15.490" class="difflineminus">-    do_check_eq(ids.length, 1);</span>
<a href="#l15.491"></a><span id="l15.491" class="difflineminus">-    do_check_true(ids[0].compare(occDate) == 0);</span>
<a href="#l15.492"></a><span id="l15.492" class="difflineplus">+    let ids = rinfo.getExceptionIds({});</span>
<a href="#l15.493"></a><span id="l15.493" class="difflineplus">+    do_check_eq(ids.length, 2);</span>
<a href="#l15.494"></a><span id="l15.494" class="difflineplus">+    do_check_true(ids[0].compare(occDate1) == 0);</span>
<a href="#l15.495"></a><span id="l15.495" class="difflineplus">+    do_check_true(ids[1].compare(occDate2) == 0);</span>
<a href="#l15.496"></a><span id="l15.496"> </span>
<a href="#l15.497"></a><span id="l15.497">     // removeExceptionFor</span>
<a href="#l15.498"></a><span id="l15.498" class="difflineminus">-    rinfo.removeExceptionFor(occDate);</span>
<a href="#l15.499"></a><span id="l15.499" class="difflineminus">-    do_check_true(rinfo.getExceptionFor(occDate) == null);</span>
<a href="#l15.500"></a><span id="l15.500" class="difflineplus">+    rinfo.removeExceptionFor(occDate1);</span>
<a href="#l15.501"></a><span id="l15.501" class="difflineplus">+    do_check_true(rinfo.getExceptionFor(occDate1) == null);</span>
<a href="#l15.502"></a><span id="l15.502" class="difflineplus">+    do_check_eq(rinfo.getExceptionIds({}).length, 1);</span>
<a href="#l15.503"></a><span id="l15.503" class="difflineplus">+}</span>
<a href="#l15.504"></a><span id="l15.504" class="difflineplus">+</span>
<a href="#l15.505"></a><span id="l15.505" class="difflineplus">+function test_rrule_interface() {</span>
<a href="#l15.506"></a><span id="l15.506" class="difflineplus">+    let item = makeEvent(&quot;DTSTART:20020402T114500Z\r\n&quot; +</span>
<a href="#l15.507"></a><span id="l15.507" class="difflineplus">+                         &quot;DTEND:20020402T124500Z\r\n&quot; +</span>
<a href="#l15.508"></a><span id="l15.508" class="difflineplus">+                         &quot;RRULE:INTERVAL=2;FREQ=WEEKLY;COUNT=6;BYDAY=TU,WE\r\n&quot;);</span>
<a href="#l15.509"></a><span id="l15.509" class="difflineplus">+</span>
<a href="#l15.510"></a><span id="l15.510" class="difflineplus">+    let rrule = item.recurrenceInfo.getRecurrenceItemAt(0);</span>
<a href="#l15.511"></a><span id="l15.511" class="difflineplus">+    do_check_eq(rrule.type, &quot;WEEKLY&quot;);</span>
<a href="#l15.512"></a><span id="l15.512" class="difflineplus">+    do_check_eq(rrule.interval, 2);</span>
<a href="#l15.513"></a><span id="l15.513" class="difflineplus">+    do_check_eq(rrule.count, 6);</span>
<a href="#l15.514"></a><span id="l15.514" class="difflineplus">+    do_check_true(rrule.isByCount);</span>
<a href="#l15.515"></a><span id="l15.515" class="difflineplus">+    do_check_false(rrule.isNegative);</span>
<a href="#l15.516"></a><span id="l15.516" class="difflineplus">+    do_check_true(rrule.isFinite);</span>
<a href="#l15.517"></a><span id="l15.517" class="difflineplus">+    do_check_eq(rrule.getComponent(&quot;BYDAY&quot;, {}).toString(), [3,4].toString());</span>
<a href="#l15.518"></a><span id="l15.518" class="difflineplus">+</span>
<a href="#l15.519"></a><span id="l15.519" class="difflineplus">+    // Now start changing things</span>
<a href="#l15.520"></a><span id="l15.520" class="difflineplus">+    rrule.setComponent(&quot;BYDAY&quot;, 2, [4,5]);</span>
<a href="#l15.521"></a><span id="l15.521" class="difflineplus">+    do_check_eq(rrule.icalString.match(/BYDAY=WE,TH/), &quot;BYDAY=WE,TH&quot;);</span>
<a href="#l15.522"></a><span id="l15.522" class="difflineplus">+</span>
<a href="#l15.523"></a><span id="l15.523" class="difflineplus">+    rrule.count = -1;</span>
<a href="#l15.524"></a><span id="l15.524" class="difflineplus">+    do_check_false(rrule.isByCount);</span>
<a href="#l15.525"></a><span id="l15.525" class="difflineplus">+    do_check_false(rrule.isFinite);</span>
<a href="#l15.526"></a><span id="l15.526" class="difflineplus">+    do_check_eq(rrule.icalString.match(/COUNT=/), null);</span>
<a href="#l15.527"></a><span id="l15.527" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l15.528"></a><span id="l15.528" class="difflineplus">+        rrule.count;</span>
<a href="#l15.529"></a><span id="l15.529" class="difflineplus">+    }, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l15.530"></a><span id="l15.530" class="difflineplus">+</span>
<a href="#l15.531"></a><span id="l15.531" class="difflineplus">+    rrule.interval = 1;</span>
<a href="#l15.532"></a><span id="l15.532" class="difflineplus">+    do_check_eq(rrule.interval, 1);</span>
<a href="#l15.533"></a><span id="l15.533" class="difflineplus">+    do_check_eq(rrule.icalString.match(/INTERVAL=/), null);</span>
<a href="#l15.534"></a><span id="l15.534" class="difflineplus">+</span>
<a href="#l15.535"></a><span id="l15.535" class="difflineplus">+    rrule.interval = 3;</span>
<a href="#l15.536"></a><span id="l15.536" class="difflineplus">+    do_check_eq(rrule.interval, 3);</span>
<a href="#l15.537"></a><span id="l15.537" class="difflineplus">+    do_check_eq(rrule.icalString.match(/INTERVAL=3/), &quot;INTERVAL=3&quot;);</span>
<a href="#l15.538"></a><span id="l15.538" class="difflineplus">+</span>
<a href="#l15.539"></a><span id="l15.539" class="difflineplus">+    rrule.type = &quot;MONTHLY&quot;;</span>
<a href="#l15.540"></a><span id="l15.540" class="difflineplus">+    do_check_eq(rrule.type, &quot;MONTHLY&quot;);</span>
<a href="#l15.541"></a><span id="l15.541" class="difflineplus">+    do_check_eq(rrule.icalString.match(/FREQ=MONTHLY/), &quot;FREQ=MONTHLY&quot;);</span>
<a href="#l15.542"></a><span id="l15.542"> }</span>
<a href="#l15.543"></a><span id="l15.543" class="difflineplus">+</span>
<a href="#l15.544"></a><span id="l15.544" class="difflineplus">+function test_startdate_change() {</span>
<a href="#l15.545"></a><span id="l15.545" class="difflineplus">+</span>
<a href="#l15.546"></a><span id="l15.546" class="difflineplus">+    // Setting a start date if its missing shouldn't throw</span>
<a href="#l15.547"></a><span id="l15.547" class="difflineplus">+    let item = makeEvent(&quot;DTEND:20020402T124500Z\r\n&quot; +</span>
<a href="#l15.548"></a><span id="l15.548" class="difflineplus">+                         &quot;RRULE:FREQ=DAILY\r\n&quot;);</span>
<a href="#l15.549"></a><span id="l15.549" class="difflineplus">+    item.startDate = cal.createDateTime(&quot;20020502T114500Z&quot;);</span>
<a href="#l15.550"></a><span id="l15.550" class="difflineplus">+</span>
<a href="#l15.551"></a><span id="l15.551" class="difflineplus">+    function makeRecEvent(str) {</span>
<a href="#l15.552"></a><span id="l15.552" class="difflineplus">+        return makeEvent(&quot;DTSTART:20020402T114500Z\r\n&quot; +</span>
<a href="#l15.553"></a><span id="l15.553" class="difflineplus">+                         &quot;DTEND:20020402T134500Z\r\n&quot; +</span>
<a href="#l15.554"></a><span id="l15.554" class="difflineplus">+                         str);</span>
<a href="#l15.555"></a><span id="l15.555" class="difflineplus">+    }</span>
<a href="#l15.556"></a><span id="l15.556" class="difflineplus">+</span>
<a href="#l15.557"></a><span id="l15.557" class="difflineplus">+    function changeBy(item, dur) {</span>
<a href="#l15.558"></a><span id="l15.558" class="difflineplus">+        let newDate = item.startDate.clone();</span>
<a href="#l15.559"></a><span id="l15.559" class="difflineplus">+        newDate.addDuration(cal.createDuration(dur));</span>
<a href="#l15.560"></a><span id="l15.560" class="difflineplus">+        item.startDate = newDate;</span>
<a href="#l15.561"></a><span id="l15.561" class="difflineplus">+    }</span>
<a href="#l15.562"></a><span id="l15.562" class="difflineplus">+</span>
<a href="#l15.563"></a><span id="l15.563" class="difflineplus">+    let item, dur, ritem;</span>
<a href="#l15.564"></a><span id="l15.564" class="difflineplus">+</span>
<a href="#l15.565"></a><span id="l15.565" class="difflineplus">+    // Changing an existing start date for a recurring item shouldn't either</span>
<a href="#l15.566"></a><span id="l15.566" class="difflineplus">+    item = makeRecEvent(&quot;RRULE:FREQ=DAILY\r\n&quot;);</span>
<a href="#l15.567"></a><span id="l15.567" class="difflineplus">+    changeBy(item, &quot;PT1H&quot;);</span>
<a href="#l15.568"></a><span id="l15.568" class="difflineplus">+</span>
<a href="#l15.569"></a><span id="l15.569" class="difflineplus">+    // Event with an rdate</span>
<a href="#l15.570"></a><span id="l15.570" class="difflineplus">+    item = makeRecEvent(&quot;RDATE:20020403T114500Z\r\n&quot;);</span>
<a href="#l15.571"></a><span id="l15.571" class="difflineplus">+    changeBy(item, &quot;PT1H&quot;);</span>
<a href="#l15.572"></a><span id="l15.572" class="difflineplus">+    ritem = item.recurrenceInfo.getRecurrenceItemAt(0);</span>
<a href="#l15.573"></a><span id="l15.573" class="difflineplus">+    do_check_eq(ritem.date.icalString, &quot;20020403T124500Z&quot;);</span>
<a href="#l15.574"></a><span id="l15.574" class="difflineplus">+</span>
<a href="#l15.575"></a><span id="l15.575" class="difflineplus">+    // Event with an exdate</span>
<a href="#l15.576"></a><span id="l15.576" class="difflineplus">+    item = makeRecEvent(&quot;EXDATE:20020403T114500Z\r\n&quot;);</span>
<a href="#l15.577"></a><span id="l15.577" class="difflineplus">+    changeBy(item, &quot;PT1H&quot;);</span>
<a href="#l15.578"></a><span id="l15.578" class="difflineplus">+    ritem = item.recurrenceInfo.getRecurrenceItemAt(0);</span>
<a href="#l15.579"></a><span id="l15.579" class="difflineplus">+    do_check_eq(ritem.date.icalString, &quot;20020403T124500Z&quot;);</span>
<a href="#l15.580"></a><span id="l15.580" class="difflineplus">+</span>
<a href="#l15.581"></a><span id="l15.581" class="difflineplus">+    // Event with an rrule with until date</span>
<a href="#l15.582"></a><span id="l15.582" class="difflineplus">+    item = makeRecEvent(&quot;RRULE:FREQ=WEEKLY;UNTIL=20020406T114500Z\r\n&quot;);</span>
<a href="#l15.583"></a><span id="l15.583" class="difflineplus">+    changeBy(item, &quot;PT1H&quot;);</span>
<a href="#l15.584"></a><span id="l15.584" class="difflineplus">+    ritem = item.recurrenceInfo.getRecurrenceItemAt(0);</span>
<a href="#l15.585"></a><span id="l15.585" class="difflineplus">+    do_check_eq(ritem.untilDate.icalString, &quot;20020406T124500Z&quot;);</span>
<a href="#l15.586"></a><span id="l15.586" class="difflineplus">+</span>
<a href="#l15.587"></a><span id="l15.587" class="difflineplus">+    // Event with an exception item</span>
<a href="#l15.588"></a><span id="l15.588" class="difflineplus">+    item = makeRecEvent(&quot;RRULE:FREQ=DAILY\r\n&quot;);</span>
<a href="#l15.589"></a><span id="l15.589" class="difflineplus">+    let occ = item.recurrenceInfo.getOccurrenceFor(cal.createDateTime(&quot;20020406T114500Z&quot;));</span>
<a href="#l15.590"></a><span id="l15.590" class="difflineplus">+    occ.startDate = cal.createDateTime(&quot;20020406T124500Z&quot;);</span>
<a href="#l15.591"></a><span id="l15.591" class="difflineplus">+    item.recurrenceInfo.modifyException(occ, true);</span>
<a href="#l15.592"></a><span id="l15.592" class="difflineplus">+    changeBy(item, &quot;PT1H&quot;);</span>
<a href="#l15.593"></a><span id="l15.593" class="difflineplus">+    do_check_eq(item.startDate.icalString, &quot;20020402T124500Z&quot;);</span>
<a href="#l15.594"></a><span id="l15.594" class="difflineplus">+    occ = item.recurrenceInfo.getExceptionFor(cal.createDateTime(&quot;20020406T124500Z&quot;));</span>
<a href="#l15.595"></a><span id="l15.595" class="difflineplus">+    do_check_eq(occ.startDate.icalString, &quot;20020406T134500Z&quot;);</span>
<a href="#l15.596"></a><span id="l15.596" class="difflineplus">+}</span>
<a href="#l15.597"></a><span id="l15.597" class="difflineplus">+</span>
<a href="#l15.598"></a><span id="l15.598" class="difflineplus">+function test_idchange() {</span>
<a href="#l15.599"></a><span id="l15.599" class="difflineplus">+    let item = makeEvent(&quot;UID:unchanged\r\n&quot; +</span>
<a href="#l15.600"></a><span id="l15.600" class="difflineplus">+                         &quot;DTSTART:20020402T114500Z\r\n&quot; +</span>
<a href="#l15.601"></a><span id="l15.601" class="difflineplus">+                         &quot;DTEND:20020402T124500Z\r\n&quot; +</span>
<a href="#l15.602"></a><span id="l15.602" class="difflineplus">+                         &quot;RRULE:FREQ=DAILY\r\n&quot;);</span>
<a href="#l15.603"></a><span id="l15.603" class="difflineplus">+    let occ = item.recurrenceInfo.getOccurrenceFor(cal.createDateTime(&quot;20020406T114500Z&quot;));</span>
<a href="#l15.604"></a><span id="l15.604" class="difflineplus">+    occ.startDate = cal.createDateTime(&quot;20020406T124500Z&quot;);</span>
<a href="#l15.605"></a><span id="l15.605" class="difflineplus">+    item.recurrenceInfo.modifyException(occ, true);</span>
<a href="#l15.606"></a><span id="l15.606" class="difflineplus">+    do_check_eq(occ.id, &quot;unchanged&quot;);</span>
<a href="#l15.607"></a><span id="l15.607" class="difflineplus">+</span>
<a href="#l15.608"></a><span id="l15.608" class="difflineplus">+    item.id = &quot;changed&quot;;</span>
<a href="#l15.609"></a><span id="l15.609" class="difflineplus">+</span>
<a href="#l15.610"></a><span id="l15.610" class="difflineplus">+    occ = item.recurrenceInfo.getExceptionFor(cal.createDateTime(&quot;20020406T114500Z&quot;));</span>
<a href="#l15.611"></a><span id="l15.611" class="difflineplus">+    do_check_eq(occ.id , &quot;changed&quot;);</span>
<a href="#l15.612"></a><span id="l15.612" class="difflineplus">+}</span>
<a href="#l15.613"></a><span id="l15.613" class="difflineplus">+</span>
<a href="#l15.614"></a><span id="l15.614" class="difflineplus">+function test_failures() {</span>
<a href="#l15.615"></a><span id="l15.615" class="difflineplus">+    let item = makeEvent(&quot;DTSTART:20020402T114500Z\r\n&quot; +</span>
<a href="#l15.616"></a><span id="l15.616" class="difflineplus">+                         &quot;DTEND:20020402T124500Z\r\n&quot; +</span>
<a href="#l15.617"></a><span id="l15.617" class="difflineplus">+                         &quot;RRULE:INTERVAL=2;FREQ=WEEKLY;COUNT=6;BYDAY=TU,WE\r\n&quot;);</span>
<a href="#l15.618"></a><span id="l15.618" class="difflineplus">+    let rinfo = item.recurrenceInfo;</span>
<a href="#l15.619"></a><span id="l15.619" class="difflineplus">+    let ritem = cal.createRecurrenceDate();</span>
<a href="#l15.620"></a><span id="l15.620" class="difflineplus">+</span>
<a href="#l15.621"></a><span id="l15.621" class="difflineplus">+    do_check_throws(function() rinfo.getRecurrenceItemAt(-1), Cr.NS_ERROR_INVALID_ARG);</span>
<a href="#l15.622"></a><span id="l15.622" class="difflineplus">+    do_check_throws(function() rinfo.getRecurrenceItemAt(1), Cr.NS_ERROR_INVALID_ARG);</span>
<a href="#l15.623"></a><span id="l15.623" class="difflineplus">+    do_check_throws(function() rinfo.deleteRecurrenceItemAt(-1), Cr.NS_ERROR_INVALID_ARG);</span>
<a href="#l15.624"></a><span id="l15.624" class="difflineplus">+    do_check_throws(function() rinfo.deleteRecurrenceItemAt(1), Cr.NS_ERROR_INVALID_ARG);</span>
<a href="#l15.625"></a><span id="l15.625" class="difflineplus">+    do_check_throws(function() rinfo.deleteRecurrenceItem(ritem), Cr.NS_ERROR_INVALID_ARG);</span>
<a href="#l15.626"></a><span id="l15.626" class="difflineplus">+    do_check_throws(function() rinfo.insertRecurrenceItemAt(ritem, -1), Cr.NS_ERROR_INVALID_ARG);</span>
<a href="#l15.627"></a><span id="l15.627" class="difflineplus">+    do_check_throws(function() rinfo.insertRecurrenceItemAt(ritem, 2), Cr.NS_ERROR_INVALID_ARG);</span>
<a href="#l15.628"></a><span id="l15.628" class="difflineplus">+    do_check_throws(function() rinfo.restoreOccurrenceAt(cal.createDateTime(&quot;20080101T010101&quot;)), Cr.NS_ERROR_INVALID_ARG);</span>
<a href="#l15.629"></a><span id="l15.629" class="difflineplus">+    do_check_throws(function() cal.createRecurrenceInfo().isFinite, Cr.NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l15.630"></a><span id="l15.630" class="difflineplus">+</span>
<a href="#l15.631"></a><span id="l15.631" class="difflineplus">+    // modifyException with a different parent item</span>
<a href="#l15.632"></a><span id="l15.632" class="difflineplus">+    let occ = rinfo.getOccurrenceFor(cal.createDateTime(&quot;20120102T114500Z&quot;));</span>
<a href="#l15.633"></a><span id="l15.633" class="difflineplus">+    occ.calendar = {}</span>
<a href="#l15.634"></a><span id="l15.634" class="difflineplus">+    occ.id = &quot;1234&quot;;</span>
<a href="#l15.635"></a><span id="l15.635" class="difflineplus">+    occ.parentItem = occ;</span>
<a href="#l15.636"></a><span id="l15.636" class="difflineplus">+    do_check_throws(function() rinfo.modifyException(occ, true), Cr.NS_ERROR_INVALID_ARG);</span>
<a href="#l15.637"></a><span id="l15.637" class="difflineplus">+</span>
<a href="#l15.638"></a><span id="l15.638" class="difflineplus">+    occ = rinfo.getOccurrenceFor(cal.createDateTime(&quot;20120102T114500Z&quot;));</span>
<a href="#l15.639"></a><span id="l15.639" class="difflineplus">+    occ.recurrenceId = null;</span>
<a href="#l15.640"></a><span id="l15.640" class="difflineplus">+    do_check_throws(function() rinfo.modifyException(occ, true), Cr.NS_ERROR_INVALID_ARG);</span>
<a href="#l15.641"></a><span id="l15.641" class="difflineplus">+</span>
<a href="#l15.642"></a><span id="l15.642" class="difflineplus">+    // Missing DTSTART/DUE but RRULE</span>
<a href="#l15.643"></a><span id="l15.643" class="difflineplus">+    item = createEventFromIcalString(&quot;BEGIN:VCALENDAR\r\n&quot; +</span>
<a href="#l15.644"></a><span id="l15.644" class="difflineplus">+        &quot;BEGIN:VTODO\r\n&quot; +</span>
<a href="#l15.645"></a><span id="l15.645" class="difflineplus">+        &quot;RRULE:FREQ=DAILY\r\n&quot; +</span>
<a href="#l15.646"></a><span id="l15.646" class="difflineplus">+        &quot;END:VTODO\r\n&quot; +</span>
<a href="#l15.647"></a><span id="l15.647" class="difflineplus">+        &quot;END:VCALENDAR\r\n&quot;</span>
<a href="#l15.648"></a><span id="l15.648" class="difflineplus">+    );</span>
<a href="#l15.649"></a><span id="l15.649" class="difflineplus">+    rinfo = item.recurrenceInfo;</span>
<a href="#l15.650"></a><span id="l15.650" class="difflineplus">+    do_check_eq(rinfo.getOccurrenceDates(cal.createDateTime(&quot;20120101T010101&quot;),</span>
<a href="#l15.651"></a><span id="l15.651" class="difflineplus">+                                         cal.createDateTime(&quot;20120203T010101&quot;),</span>
<a href="#l15.652"></a><span id="l15.652" class="difflineplus">+                                         0, {}).length, 0);</span>
<a href="#l15.653"></a><span id="l15.653" class="difflineplus">+}</span>
<a href="#l15.654"></a><span id="l15.654" class="difflineplus">+</span>
<a href="#l15.655"></a><span id="l15.655" class="difflineplus">+function test_immutable() {</span>
<a href="#l15.656"></a><span id="l15.656" class="difflineplus">+    item = createEventFromIcalString(&quot;BEGIN:VCALENDAR\r\n&quot; +</span>
<a href="#l15.657"></a><span id="l15.657" class="difflineplus">+        &quot;BEGIN:VTODO\r\n&quot; +</span>
<a href="#l15.658"></a><span id="l15.658" class="difflineplus">+        &quot;RRULE:FREQ=DAILY\r\n&quot; +</span>
<a href="#l15.659"></a><span id="l15.659" class="difflineplus">+        &quot;END:VTODO\r\n&quot; +</span>
<a href="#l15.660"></a><span id="l15.660" class="difflineplus">+        &quot;END:VCALENDAR\r\n&quot;</span>
<a href="#l15.661"></a><span id="l15.661" class="difflineplus">+    );</span>
<a href="#l15.662"></a><span id="l15.662" class="difflineplus">+    do_check_true(item.recurrenceInfo.isMutable);</span>
<a href="#l15.663"></a><span id="l15.663" class="difflineplus">+    let rinfo2 = item.recurrenceInfo.clone();</span>
<a href="#l15.664"></a><span id="l15.664" class="difflineplus">+    rinfo2.makeImmutable();</span>
<a href="#l15.665"></a><span id="l15.665" class="difflineplus">+    rinfo2.makeImmutable(); // Doing so twice shouldn't throw</span>
<a href="#l15.666"></a><span id="l15.666" class="difflineplus">+    do_check_throws(function() rinfo2.appendRecurrenceItem(ritem), Cr.NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l15.667"></a><span id="l15.667" class="difflineplus">+    do_check_false(rinfo2.isMutable);</span>
<a href="#l15.668"></a><span id="l15.668" class="difflineplus">+</span>
<a href="#l15.669"></a><span id="l15.669" class="difflineplus">+    let ritem = cal.createRecurrenceDate();</span>
<a href="#l15.670"></a><span id="l15.670" class="difflineplus">+    rinfo.appenRecurrenceItem(ritem);</span>
<a href="#l15.671"></a><span id="l15.671" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/test/unit/test_relation.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/test/unit/test_relation.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -32,16 +32,18 @@ function run_test() {</span>
<a href="#l16.4"></a><span id="l16.4">     // Check the item functions</span>
<a href="#l16.5"></a><span id="l16.5">     checkRelations(e1, [r1, r2]);</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7">     // modify the Relations</span>
<a href="#l16.8"></a><span id="l16.8">     modifyRelations(e1, [r1, r2]);</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10">     // test icalproperty</span>
<a href="#l16.11"></a><span id="l16.11">     r2.icalProperty;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+    test_icalprop();</span>
<a href="#l16.14"></a><span id="l16.14"> }</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16"> function checkRelations(event, expRel) {</span>
<a href="#l16.17"></a><span id="l16.17">     let countObj = {};</span>
<a href="#l16.18"></a><span id="l16.18">     let allRel = event.getRelations(countObj);</span>
<a href="#l16.19"></a><span id="l16.19">     do_check_eq(countObj.value, allRel.length);</span>
<a href="#l16.20"></a><span id="l16.20">     do_check_eq(allRel.length, expRel.length);</span>
<a href="#l16.21"></a><span id="l16.21"> </span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -69,8 +71,57 @@ function modifyRelations(event, oldRel) </span>
<a href="#l16.23"></a><span id="l16.23">     event.removeRelation(rel);</span>
<a href="#l16.24"></a><span id="l16.24">     do_check_eq(event.getRelations({}).length, oldRel.length - 1);</span>
<a href="#l16.25"></a><span id="l16.25"> </span>
<a href="#l16.26"></a><span id="l16.26">     // add one relation and remove all relations</span>
<a href="#l16.27"></a><span id="l16.27">     event.addRelation(oldRel[0]);</span>
<a href="#l16.28"></a><span id="l16.28">     event.removeAllRelations();</span>
<a href="#l16.29"></a><span id="l16.29">     do_check_eq(event.getRelations({}), 0);</span>
<a href="#l16.30"></a><span id="l16.30"> }</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+function test_icalprop() {</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+    let rel = cal.createRelation();</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+    rel.relType = &quot;SIBLING&quot;;</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+    rel.setParameter(&quot;X-PROP&quot;, &quot;VAL&quot;);</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+    rel.relId = &quot;value&quot;;</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+    let prop = rel.icalProperty;</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+    let propOrig = rel.icalProperty;</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+    do_check_eq(rel.icalString, prop.icalString);</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+    do_check_eq(prop.value, &quot;value&quot;);</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+    do_check_eq(prop.getParameter(&quot;X-PROP&quot;), &quot;VAL&quot;);</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+    do_check_eq(prop.getParameter(&quot;RELTYPE&quot;), &quot;SIBLING&quot;);</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+    prop.value = &quot;changed&quot;;</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+    prop.setParameter(&quot;RELTYPE&quot;, &quot;changedtype&quot;);</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+    prop.setParameter(&quot;X-PROP&quot;, &quot;changedxprop&quot;);</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+    do_check_eq(rel.relId, &quot;value&quot;);</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+    do_check_eq(rel.getParameter(&quot;X-PROP&quot;), &quot;VAL&quot;);</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+    do_check_eq(rel.relType, &quot;SIBLING&quot;);</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+    rel.icalProperty = prop;</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+    do_check_eq(rel.relId, &quot;changed&quot;);</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+    do_check_eq(rel.getParameter(&quot;X-PROP&quot;), &quot;changedxprop&quot;);</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+    do_check_eq(rel.relType, &quot;changedtype&quot;);</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+    rel.icalString = propOrig.icalString;</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+    do_check_eq(rel.relId, &quot;value&quot;);</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+    do_check_eq(rel.getParameter(&quot;X-PROP&quot;), &quot;VAL&quot;);</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+    do_check_eq(rel.relType, &quot;SIBLING&quot;);</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+    let rel2 = rel.clone();</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+    rel.icalProperty = prop;</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+    do_check_neq(rel.icalString, rel2.icalString);</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+    rel.deleteParameter(&quot;X-PROP&quot;);</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+    do_check_eq(rel.icalProperty.getParameter(&quot;X-PROP&quot;), null);</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+    do_check_throws(function() {</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+        rel.icalString = &quot;X-UNKNOWN:value&quot;;</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+    }, Components.results.NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">new file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- /dev/null</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ b/calendar/test/unit/test_search_service.js</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -0,0 +1,136 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineplus">+</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+Components.utils.import(&quot;resource:///modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+const HINT_EXACT_MATCH = Components.interfaces.calICalendarSearchProvider.HINT_EXACT_MATCH;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+let search = Components.classes[&quot;@mozilla.org/calendar/calendarsearch-service;1&quot;]</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+                       .getService(Components.interfaces.calICalendarSearchService);</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+function run_test() {</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+    test_found();</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+    test_failure();</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+    test_cancel();</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+}</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+function test_found() {</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+    search.getProviders({}).forEach(search.removeProvider, search);</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+    do_check_eq(search.getProviders({}).length, 0);</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+    let provider1 = {</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+        id: 1,</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+        searchForCalendars: function() {}</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+    };</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+    let provider2 = {</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+        id: 2,</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+        called: false,</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+        searchForCalendars: function(aStr, aHint, aMax, aListener) {</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+            do_check_false(this.called)</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+            this.called = true;</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+            do_check_eq(aStr, &quot;str&quot;);</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+            do_check_eq(aHint, HINT_EXACT_MATCH);</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+            do_check_eq(aMax, 0);</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+            let mockCalendar = {</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+                id: &quot;test&quot;</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+            };</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+            aListener.onResult(null, [mockCalendar]);</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+        }</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+    };</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+    provider2.wrappedJSObject = provider2;</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+    search.addProvider(provider1);</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+    do_check_eq(search.getProviders({}).length, 1);</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+    search.addProvider(provider2);</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+    do_check_eq(search.getProviders({}).length, 2);</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+    search.removeProvider(provider1);</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+    do_check_eq(search.getProviders({}).length, 1);</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+    do_check_eq(search.getProviders({})[0].wrappedJSObject.id, 2);</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+    let listener = {</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+        called: false,</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+        onResult: function(request, result) {</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineplus">+            do_check_false(this.called);</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+            this.called = true;</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+            do_check_eq(result.length, 1);</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+            do_check_eq(result[0].id, &quot;test&quot;);</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+        }</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+    };</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+    let op = search.searchForCalendars(&quot;str&quot;, HINT_EXACT_MATCH, 0, listener);</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+    do_check_true(listener.called);</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+    do_check_true(provider2.called);</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+}</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+function test_failure() {</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+    search.getProviders({}).forEach(search.removeProvider, search);</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+    let provider = {</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+        searchForCalendars: function(aStr, aHint, aMax, aListener) {</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineplus">+            throw &quot;error&quot;;</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+        }</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+    };</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+    let listener = {</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+        called: false,</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+        onResult: function(request, result) {</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+            do_check_false(this.called);</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+            this.called = true;</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+            do_check_eq(result.length, 0);</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+        }</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+    };</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+    search.addProvider(provider);</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+    let op = search.searchForCalendars(&quot;str&quot;, HINT_EXACT_MATCH, 0, listener);</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+    do_check_true(listener.called);</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineplus">+}</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineplus">+</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineplus">+function test_cancel() {</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineplus">+    search.getProviders({}).forEach(search.removeProvider, search);</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineplus">+</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineplus">+    let provider = {</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineplus">+        QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calICalendarSearchProvider, Components.interfaces.calIOperation]),</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineplus">+        searchForCalendars: function(aStr, aHint, aMax, aListener) {</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineplus">+</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+            Services.tm.currentThread.dispatch({run: function() {</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+                dump(&quot;Cancelling search...&quot;);</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+                op.cancel();</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+            }}, Components.interfaces.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineplus">+</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineplus">+            // No listener call, we emulate a long running search</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineplus">+            // Do return the operation though</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineplus">+            return this;</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineplus">+        },</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineplus">+        isPending: true,</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineplus">+        cancelCalled: false,</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+        status: Components.results.NS_OK,</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineplus">+        cancel: function() {</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+            this.cancelCalled = true;</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineplus">+        },</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineplus">+    };</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineplus">+</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineplus">+    let listener = {</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineplus">+        called: false,</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineplus">+        onResult: function(request, result) {</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineplus">+            do_check_eq(result, null);</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineplus">+</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineplus">+            // If an exception occurs, the operation is not added to the opgroup</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineplus">+            do_check_false(provider.cancelCalled);</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineplus">+            do_test_finished();</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineplus">+        }</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineplus">+    };</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineplus">+</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+    search.addProvider(provider);</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineplus">+    do_test_pending();</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+    let op = search.searchForCalendars(&quot;str&quot;, HINT_EXACT_MATCH, 0, listener);</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- /dev/null</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ b/calendar/test/unit/test_startup_service.js</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -0,0 +1,47 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+function run_test() {</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+    let ssvc = Components.classes[&quot;@mozilla.org/calendar/startup-service;1&quot;]</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+                         .getService(Components.interfaces.nsIObserver);</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+    let first = {</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+        startup: function(aListener) {</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+            second.canStart = true;</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+            aListener.onResult(null, Cr.NS_OK);</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+        },</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+        shutdown: function(aListener) {</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+            do_check_true(this.canStop);</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+            aListener.onResult(null, Cr.NS_OK);</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+        }</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+    };</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+    let second = {</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+        startup: function(aListener) {</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+            do_check_true(this.canStart);</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+            aListener.onResult(null, Cr.NS_OK);</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+        },</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+        shutdown: function(aListener) {</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+            first.canStop = true;</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+            aListener.onResult(null, Cr.NS_OK);</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+        }</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+    };</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+    // Change the startup order so we can test our services</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+    let oldStartupOrder = ssvc.wrappedJSObject.getStartupOrder;</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+    ssvc.wrappedJSObject.getStartupOrder = function() {</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+        let origOrder = oldStartupOrder.call(this);</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+        let notify = origOrder[origOrder.length - 1];</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+        return [first, second, notify];</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+    };</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+    // Pretend a startup run</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+    ssvc.observe(null, &quot;profile-after-change&quot;, null);</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+    do_check_true(second.canStart);</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+    // Pretend a stop run</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+    ssvc.observe(null, &quot;profile-before-change&quot;, null);</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+    do_check_true(first.canStop);</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">new file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- /dev/null</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ b/calendar/test/unit/test_utils.js</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -0,0 +1,186 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineplus">+</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineplus">+function run_test() {</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineplus">+    test_recentzones();</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineplus">+    test_formatcss();</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+    test_attendeeMatchesAddresses();</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+    test_getDefaultStartDate();</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+    test_getStartEndProps();</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+    test_calOperationGroup();</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+    test_sameDay();</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+    test_binarySearch();</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+}</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+function test_recentzones() {</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+    let oldDefaultTz = cal.getPrefSafe(&quot;calendar.timezone.local&quot;, &quot;&quot;);</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+    cal.setPref(&quot;calendar.timezone.local&quot;, &quot;floating&quot;);</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+    do_check_eq(cal.getRecentTimezones().length, 0);</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+    do_check_eq(cal.getRecentTimezones(true).length, 0);</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+    cal.saveRecentTimezone(&quot;Europe/Berlin&quot;);</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+    let zones = cal.getRecentTimezones();</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+    do_check_eq(zones.length, 1);</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+    do_check_eq(zones[0], &quot;Europe/Berlin&quot;);</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+    zones = cal.getRecentTimezones(true);</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+    do_check_eq(zones.length, 1);</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+    do_check_eq(zones[0].tzid, &quot;Europe/Berlin&quot;);</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+    cal.saveRecentTimezone(cal.calendarDefaultTimezone().tzid);</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+    do_check_eq(cal.getRecentTimezones().length, 1);</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+    do_check_eq(cal.getRecentTimezones(true).length, 1);</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+    cal.saveRecentTimezone(&quot;Europe/Berlin&quot;);</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+    do_check_eq(cal.getRecentTimezones().length, 1);</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+    do_check_eq(cal.getRecentTimezones(true).length, 1);</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+    cal.saveRecentTimezone(&quot;America/New_York&quot;);</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+    do_check_eq(cal.getRecentTimezones().length, 2);</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+    do_check_eq(cal.getRecentTimezones(true).length, 2);</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+    cal.saveRecentTimezone(&quot;Unknown&quot;);</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+    do_check_eq(cal.getRecentTimezones().length, 3);</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+    do_check_eq(cal.getRecentTimezones(true).length, 2);</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+    cal.setPref(&quot;calendar.timezone.local&quot;, oldDefaultTz);</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+}</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+function test_formatcss() {</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+    do_check_eq(cal.formatStringForCSSRule(&quot; &quot;), &quot;_&quot;);</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+    do_check_eq(cal.formatStringForCSSRule(&quot;&quot;), &quot;-uxfc-&quot;);</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+    do_check_eq(cal.formatStringForCSSRule(&quot;a&quot;), &quot;a&quot;);</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+}</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+function test_attendeeMatchesAddresses() {</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+    let a = cal.createAttendee(&quot;ATTENDEE:mailto:horst&quot;);</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+    do_check_true(cal.attendeeMatchesAddresses(a, [&quot;HORST&quot;, &quot;peter&quot;]));</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+    do_check_false(cal.attendeeMatchesAddresses(a, [&quot;HORSTpeter&quot;, &quot;peter&quot;]));</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+    do_check_false(cal.attendeeMatchesAddresses(a, [&quot;peter&quot;]));</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+    let a = cal.createAttendee(&quot;ATTENDEE;EMAIL=\&quot;horst\&quot;:urn:uuid:horst&quot;);</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+    do_check_true(cal.attendeeMatchesAddresses(a, [&quot;HORST&quot;, &quot;peter&quot;]));</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+    do_check_false(cal.attendeeMatchesAddresses(a, [&quot;HORSTpeter&quot;, &quot;peter&quot;]));</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+    do_check_false(cal.attendeeMatchesAddresses(a, [&quot;peter&quot;]));</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+}</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+function test_getDefaultStartDate() {</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+    function tt(n, t) {</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+        now = cal.createDateTime(n);</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+        return cal.getDefaultStartDate(t ? cal.createDateTime(t) : null);</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineplus">+    }</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineplus">+</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+    let oldNow = cal.now;</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+    let now = cal.createDateTime(&quot;20120101T000000&quot;);</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineplus">+    cal.now = function() {</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineplus">+        return now;</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+    };</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineplus">+</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+    dump(&quot;TT: &quot; + cal.createDateTime(&quot;20120101T000000&quot;) + &quot;\n&quot;);</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+    dump(&quot;TT: &quot; + cal.getDefaultStartDate(cal.createDateTime(&quot;20120101T000000&quot;)) + &quot;\n&quot;);</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+    do_check_eq(tt(&quot;20120101T000000&quot;).icalString, &quot;20120101T010000&quot;);</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineplus">+    do_check_eq(tt(&quot;20120101T015959&quot;).icalString, &quot;20120101T020000&quot;);</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+    do_check_eq(tt(&quot;20120101T230000&quot;).icalString, &quot;20120101T230000&quot;);</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineplus">+    do_check_eq(tt(&quot;20120101T235959&quot;).icalString, &quot;20120101T230000&quot;);</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineplus">+</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineplus">+    do_check_eq(tt(&quot;20120101T000000&quot;, &quot;20120202&quot;).icalString, &quot;20120202T010000&quot;);</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+    do_check_eq(tt(&quot;20120101T015959&quot;, &quot;20120202&quot;).icalString, &quot;20120202T020000&quot;);</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+    do_check_eq(tt(&quot;20120101T230000&quot;, &quot;20120202&quot;).icalString, &quot;20120202T230000&quot;);</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+    do_check_eq(tt(&quot;20120101T235959&quot;, &quot;20120202&quot;).icalString, &quot;20120202T230000&quot;);</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+    let event = cal.createEvent();</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineplus">+    now = cal.createDateTime(&quot;20120101T015959&quot;);</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+    cal.setDefaultStartEndHour(event, cal.createDateTime(&quot;20120202&quot;));</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+    do_check_eq(event.startDate.icalString, &quot;20120202T020000&quot;);</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+    do_check_eq(event.endDate.icalString, &quot;20120202T030000&quot;);</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineplus">+</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineplus">+    let todo = cal.createTodo();</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineplus">+    now = cal.createDateTime(&quot;20120101T000000&quot;);</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineplus">+    cal.setDefaultStartEndHour(todo, cal.createDateTime(&quot;20120202&quot;));</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineplus">+    do_check_eq(todo.entryDate.icalString, &quot;20120202T010000&quot;);</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineplus">+</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineplus">+    cal.now = oldNow;</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+}</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineplus">+</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineplus">+function test_getStartEndProps() {</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineplus">+    do_check_eq(cal.calGetStartDateProp(cal.createEvent()), &quot;startDate&quot;);</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineplus">+    do_check_eq(cal.calGetEndDateProp(cal.createEvent()), &quot;endDate&quot;);</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineplus">+    do_check_eq(cal.calGetStartDateProp(cal.createTodo()), &quot;entryDate&quot;);</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineplus">+    do_check_eq(cal.calGetEndDateProp(cal.createTodo()), &quot;dueDate&quot;);</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineplus">+</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineplus">+    do_check_throws(function() cal.calGetStartDateProp(null),</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineplus">+                    Components.results.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineplus">+    do_check_throws(function() cal.calGetEndDateProp(null),</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineplus">+                    Components.results.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineplus">+}</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineplus">+</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineplus">+function test_calOperationGroup() {</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineplus">+    let cancelCalled = false;</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineplus">+    function cancelFunc() cancelCalled = true;</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineplus">+</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineplus">+    let group = new cal.calOperationGroup(cancelFunc);</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineplus">+</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineplus">+    do_check_true(group.isEmpty);</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineplus">+    do_check_eq(group.id, cal.calOperationGroup.mOpGroupPrefix + &quot;0&quot;);</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineplus">+    do_check_eq(group.status, Components.results.NS_OK);</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineplus">+    do_check_eq(group.isPending, true);</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineplus">+</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineplus">+    let completedOp = {</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineplus">+        isPending: false</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineplus">+    };</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineplus">+</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineplus">+    group.add(completedOp);</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineplus">+    do_check_true(group.isEmpty);</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineplus">+    do_check_eq(group.isPending, true);</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineplus">+</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineplus">+    let pendingOp1 = {</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineplus">+        id: 1,</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineplus">+        isPending: true,</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineplus">+        cancel: function() this.cancelCalled = true</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineplus">+    };</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineplus">+</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineplus">+    group.add(pendingOp1);</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineplus">+    do_check_false(group.isEmpty);</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineplus">+    do_check_eq(group.isPending, true);</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineplus">+</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineplus">+    let pendingOp2 = {</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineplus">+        id: 2,</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineplus">+        isPending: true,</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineplus">+        cancel: function() this.cancelCalled = true</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineplus">+    };</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineplus">+</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineplus">+    group.add(pendingOp2);</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineplus">+    group.remove(pendingOp1);</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineplus">+    do_check_false(group.isEmpty);</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineplus">+    do_check_eq(group.isPending, true);</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineplus">+</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineplus">+    group.cancel();</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineplus">+</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineplus">+    do_check_eq(group.status, Components.interfaces.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineplus">+    do_check_false(group.isPending);</span>
<a href="#l19.168"></a><span id="l19.168" class="difflineplus">+    do_check_true(cancelCalled);</span>
<a href="#l19.169"></a><span id="l19.169" class="difflineplus">+    do_check_true(pendingOp2.cancelCalled);</span>
<a href="#l19.170"></a><span id="l19.170" class="difflineplus">+}</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineplus">+</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineplus">+function test_sameDay() {</span>
<a href="#l19.173"></a><span id="l19.173" class="difflineplus">+    let dt = cal.createDateTime;</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineplus">+</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineplus">+    do_check_true(cal.sameDay(dt(&quot;20120101&quot;), dt(&quot;20120101T120000&quot;)));</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineplus">+    do_check_true(cal.sameDay(dt(&quot;20120101&quot;), dt(&quot;20120101&quot;)));</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineplus">+    do_check_false(cal.sameDay(dt(&quot;20120101&quot;), dt(&quot;20120102&quot;)));</span>
<a href="#l19.178"></a><span id="l19.178" class="difflineplus">+    do_check_false(cal.sameDay(dt(&quot;20120101T120000&quot;), dt(&quot;20120102T120000&quot;)));</span>
<a href="#l19.179"></a><span id="l19.179" class="difflineplus">+}</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineplus">+</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineplus">+function test_binarySearch() {</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineplus">+    let arr = [2, 5, 7, 9, 20, 27, 34, 39, 41, 53, 62];</span>
<a href="#l19.183"></a><span id="l19.183" class="difflineplus">+    do_check_eq(binarySearch(arr, 27), 5); // Center</span>
<a href="#l19.184"></a><span id="l19.184" class="difflineplus">+    do_check_eq(binarySearch(arr, 2), 0); // Left most</span>
<a href="#l19.185"></a><span id="l19.185" class="difflineplus">+    do_check_eq(binarySearch(arr, 62), 11); // Right most</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineplus">+</span>
<a href="#l19.187"></a><span id="l19.187" class="difflineplus">+    do_check_eq(binarySearch([5], 5), 1) // One element found</span>
<a href="#l19.188"></a><span id="l19.188" class="difflineplus">+    do_check_eq(binarySearch([1], 0), 0) // One element insert left</span>
<a href="#l19.189"></a><span id="l19.189" class="difflineplus">+    do_check_eq(binarySearch([1], 2), 1) // One element insert right</span>
<a href="#l19.190"></a><span id="l19.190" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/test/unit/xpcshell.ini</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/test/unit/xpcshell.ini</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -14,22 +14,29 @@ tail =</span>
<a href="#l20.4"></a><span id="l20.4"> [test_bug486186.js]</span>
<a href="#l20.5"></a><span id="l20.5"> [test_bug494140.js]</span>
<a href="#l20.6"></a><span id="l20.6"> [test_bug523860.js]</span>
<a href="#l20.7"></a><span id="l20.7"> [test_bug653924.js]</span>
<a href="#l20.8"></a><span id="l20.8"> [test_bug668222.js]</span>
<a href="#l20.9"></a><span id="l20.9"> [test_bug759324.js]</span>
<a href="#l20.10"></a><span id="l20.10"> [test_datetime.js]</span>
<a href="#l20.11"></a><span id="l20.11"> [test_datetime_before_1970.js]</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+[test_duration.js]</span>
<a href="#l20.13"></a><span id="l20.13"> [test_freebusy.js]</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+[test_freebusy_service.js]</span>
<a href="#l20.15"></a><span id="l20.15"> [test_hashedarray.js]</span>
<a href="#l20.16"></a><span id="l20.16"> [test_ics.js]</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+[test_ics_parser.js]</span>
<a href="#l20.18"></a><span id="l20.18"> [test_ics_service.js]</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+[test_items.js]</span>
<a href="#l20.20"></a><span id="l20.20"> [test_providers.js]</span>
<a href="#l20.21"></a><span id="l20.21"> [test_recur.js]</span>
<a href="#l20.22"></a><span id="l20.22"> [test_relation.js]</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+[test_search_service.js]</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+[test_startup_service.js]</span>
<a href="#l20.25"></a><span id="l20.25"> [test_storage.js]</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+[test_utils.js]</span>
<a href="#l20.27"></a><span id="l20.27"> [test_calmgr.js]</span>
<a href="#l20.28"></a><span id="l20.28"> [test_deleted_items.js]</span>
<a href="#l20.29"></a><span id="l20.29"> </span>
<a href="#l20.30"></a><span id="l20.30"> # Bug 680201 Skip this test because it doesn't work properly yet.</span>
<a href="#l20.31"></a><span id="l20.31"> [test_webcal.js]</span>
<a href="#l20.32"></a><span id="l20.32"> skip-if = true</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

