<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 23314:f8afcb3f18de1d71de1c52386587995a517033bc</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f8afcb3f18de1d71de1c52386587995a517033bc" />
<meta property="og:url" content="/comm-central/rev/f8afcb3f18de1d71de1c52386587995a517033bc" />
<meta property="og:description" content="Bug 1436199 - Include the gdata provider in eslint. r=MakeMyDay" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f8afcb3f18de1d71de1c52386587995a517033bc 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f8afcb3f18de1d71de1c52386587995a517033bc">shortlog</a> |
<a href="/comm-central/log/f8afcb3f18de1d71de1c52386587995a517033bc">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f8afcb3f18de1d71de1c52386587995a517033bc">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f8afcb3f18de1d71de1c52386587995a517033bc">files</a> |
changeset |
<a href="/comm-central/raw-rev/f8afcb3f18de1d71de1c52386587995a517033bc">raw</a>  | <a href="/comm-central/archive/f8afcb3f18de1d71de1c52386587995a517033bc.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1436199">Bug 1436199</a> - Include the gdata provider in eslint. r=MakeMyDay
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 06 Feb 2018 23:30:53 +0100</td></tr>

<tr>
 <td>changeset 23314</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f8afcb3f18de1d71de1c52386587995a517033bc">f8afcb3f18de1d71de1c52386587995a517033bc</a></td>
</tr>



<tr>
<td>parent 23313</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/752150efa9fb1b1fcf385b06b0a464bb49a9e006">752150efa9fb1b1fcf385b06b0a464bb49a9e006</a>
</td>
</tr>

<tr>
<td>child 23315</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/87cad73c874af0a169ba3ecf9118b318b62af1a5">87cad73c874af0a169ba3ecf9118b318b62af1a5</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f8afcb3f18de1d71de1c52386587995a517033bc">14088</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 14 Feb 2018 23:34:31 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@87cad73c874a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=87cad73c874af0a169ba3ecf9118b318b62af1a5">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=87cad73c874af0a169ba3ecf9118b318b62af1a5&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=87cad73c874af0a169ba3ecf9118b318b62af1a5&newProject=comm-central&newRevision=752150efa9fb1b1fcf385b06b0a464bb49a9e006&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=87cad73c874af0a169ba3ecf9118b318b62af1a5&newProject=comm-central&newRevision=752150efa9fb1b1fcf385b06b0a464bb49a9e006&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=87cad73c874af0a169ba3ecf9118b318b62af1a5&newProject=comm-central&newRevision=752150efa9fb1b1fcf385b06b0a464bb49a9e006&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28MakeMyDay%29&revcount=50">MakeMyDay</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1436199">1436199</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1436199">Bug 1436199</a> - Include the gdata provider in eslint. r=MakeMyDay

MozReview-Commit-ID: 6LYTd7BIZTB</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f8afcb3f18de1d71de1c52386587995a517033bc/.eslintignore">file</a> |
<a href="/comm-central/annotate/f8afcb3f18de1d71de1c52386587995a517033bc/.eslintignore">annotate</a> |
<a href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/.eslintignore">diff</a> |
<a href="/comm-central/comparison/f8afcb3f18de1d71de1c52386587995a517033bc/.eslintignore">comparison</a> |
<a href="/comm-central/log/f8afcb3f18de1d71de1c52386587995a517033bc/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/components/calGoogleCalendar.js">calendar/providers/gdata/components/calGoogleCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/components/calGoogleCalendar.js">file</a> |
<a href="/comm-central/annotate/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/components/calGoogleCalendar.js">annotate</a> |
<a href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/components/calGoogleCalendar.js">diff</a> |
<a href="/comm-central/comparison/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/components/calGoogleCalendar.js">comparison</a> |
<a href="/comm-central/log/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/components/calGoogleCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/browserRequest.js">calendar/providers/gdata/content/browserRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/browserRequest.js">file</a> |
<a href="/comm-central/annotate/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/browserRequest.js">annotate</a> |
<a href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/browserRequest.js">diff</a> |
<a href="/comm-central/comparison/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/browserRequest.js">comparison</a> |
<a href="/comm-central/log/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/browserRequest.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-calendar-creation.js">calendar/providers/gdata/content/gdata-calendar-creation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-calendar-creation.js">file</a> |
<a href="/comm-central/annotate/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-calendar-creation.js">annotate</a> |
<a href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-calendar-creation.js">diff</a> |
<a href="/comm-central/comparison/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-calendar-creation.js">comparison</a> |
<a href="/comm-central/log/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-calendar-creation.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">calendar/providers/gdata/content/gdata-calendar-event-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">file</a> |
<a href="/comm-central/annotate/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">annotate</a> |
<a href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">diff</a> |
<a href="/comm-central/comparison/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">comparison</a> |
<a href="/comm-central/log/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-calendar-properties.js">calendar/providers/gdata/content/gdata-calendar-properties.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-calendar-properties.js">file</a> |
<a href="/comm-central/annotate/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-calendar-properties.js">annotate</a> |
<a href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-calendar-properties.js">diff</a> |
<a href="/comm-central/comparison/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-calendar-properties.js">comparison</a> |
<a href="/comm-central/log/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-calendar-properties.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-event-dialog-reminder.js">calendar/providers/gdata/content/gdata-event-dialog-reminder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-event-dialog-reminder.js">file</a> |
<a href="/comm-central/annotate/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-event-dialog-reminder.js">annotate</a> |
<a href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-event-dialog-reminder.js">diff</a> |
<a href="/comm-central/comparison/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-event-dialog-reminder.js">comparison</a> |
<a href="/comm-central/log/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-event-dialog-reminder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-list-tree.xml">calendar/providers/gdata/content/gdata-list-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-list-tree.xml">file</a> |
<a href="/comm-central/annotate/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-list-tree.xml">annotate</a> |
<a href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-list-tree.xml">diff</a> |
<a href="/comm-central/comparison/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-list-tree.xml">comparison</a> |
<a href="/comm-central/log/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-list-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-migration.js">calendar/providers/gdata/content/gdata-migration.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-migration.js">file</a> |
<a href="/comm-central/annotate/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-migration.js">annotate</a> |
<a href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-migration.js">diff</a> |
<a href="/comm-central/comparison/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-migration.js">comparison</a> |
<a href="/comm-central/log/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/content/gdata-migration.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/OAuth2.jsm">calendar/providers/gdata/modules/OAuth2.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/OAuth2.jsm">file</a> |
<a href="/comm-central/annotate/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/OAuth2.jsm">annotate</a> |
<a href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/OAuth2.jsm">diff</a> |
<a href="/comm-central/comparison/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/OAuth2.jsm">comparison</a> |
<a href="/comm-central/log/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/OAuth2.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataLogging.jsm">calendar/providers/gdata/modules/gdataLogging.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataLogging.jsm">file</a> |
<a href="/comm-central/annotate/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataLogging.jsm">annotate</a> |
<a href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataLogging.jsm">diff</a> |
<a href="/comm-central/comparison/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataLogging.jsm">comparison</a> |
<a href="/comm-central/log/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataLogging.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataRequest.jsm">calendar/providers/gdata/modules/gdataRequest.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataRequest.jsm">file</a> |
<a href="/comm-central/annotate/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataRequest.jsm">annotate</a> |
<a href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataRequest.jsm">diff</a> |
<a href="/comm-central/comparison/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataRequest.jsm">comparison</a> |
<a href="/comm-central/log/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataRequest.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataSession.jsm">calendar/providers/gdata/modules/gdataSession.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataSession.jsm">file</a> |
<a href="/comm-central/annotate/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataSession.jsm">annotate</a> |
<a href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataSession.jsm">diff</a> |
<a href="/comm-central/comparison/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataSession.jsm">comparison</a> |
<a href="/comm-central/log/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataSession.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataUtils.jsm">calendar/providers/gdata/modules/gdataUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataUtils.jsm">file</a> |
<a href="/comm-central/annotate/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataUtils.jsm">comparison</a> |
<a href="/comm-central/log/f8afcb3f18de1d71de1c52386587995a517033bc/calendar/providers/gdata/modules/gdataUtils.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -29,17 +29,14 @@ mailnews/**</span>
<a href="#l1.4"></a><span id="l1.4"> suite/**</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> # calendar/ exclusions</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> # prefs files</span>
<a href="#l1.9"></a><span id="l1.9"> calendar/lightning/content/lightning.js</span>
<a href="#l1.10"></a><span id="l1.10"> calendar/locales/en-US/lightning-l10n.js</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-# gdata-provider uses non-standard javascript for Postbox compatibility</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-calendar/providers/gdata/**</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-</span>
<a href="#l1.15"></a><span id="l1.15"> # third party library</span>
<a href="#l1.16"></a><span id="l1.16"> calendar/base/modules/ical.js</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18"> # preprocessed files</span>
<a href="#l1.19"></a><span id="l1.19"> calendar/base/content/dialogs/calendar-migration-dialog.js</span>
<a href="#l1.20"></a><span id="l1.20"> calendar/base/content/calendar-dnd-listener.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -12,17 +12,16 @@ ChromeUtils.import(&quot;resource://calendar/</span>
<a href="#l2.4"></a><span id="l2.4"> ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> ChromeUtils.import(&quot;resource://gdata-provider/modules/calUtilsShim.jsm&quot;);</span>
<a href="#l2.7"></a><span id="l2.7"> ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataLogging.jsm&quot;);</span>
<a href="#l2.8"></a><span id="l2.8"> ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataRequest.jsm&quot;);</span>
<a href="#l2.9"></a><span id="l2.9"> ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataSession.jsm&quot;);</span>
<a href="#l2.10"></a><span id="l2.10"> ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-var cICL = Components.interfaces.calIChangeLog;</span>
<a href="#l2.13"></a><span id="l2.13"> var cIOL = Components.interfaces.calIOperationListener;</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> var MIN_REFRESH_INTERVAL = 30;</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> /**</span>
<a href="#l2.18"></a><span id="l2.18">  * calGoogleCalendar</span>
<a href="#l2.19"></a><span id="l2.19">  * This Implements a calICalendar Object adapted to the Google Calendar</span>
<a href="#l2.20"></a><span id="l2.20">  * Provider.</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -55,19 +54,19 @@ calGoogleCalendar.prototype = {</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23">     /* Used to reset the local cache between releases */</span>
<a href="#l2.24"></a><span id="l2.24">     CACHE_DB_VERSION: 3,</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26">     /* Member Variables */</span>
<a href="#l2.27"></a><span id="l2.27">     mCalendarName: null,</span>
<a href="#l2.28"></a><span id="l2.28">     mThrottle: null,</span>
<a href="#l2.29"></a><span id="l2.29">     mThrottleLimits: {</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-      &quot;calendarList&quot;: 3600 * 1000,</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-      &quot;events&quot;: 30 * 1000,</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-      &quot;tasks&quot;: 30 * 1000</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+        calendarList: 3600 * 1000,</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+        events: 30 * 1000,</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+        tasks: 30 * 1000</span>
<a href="#l2.36"></a><span id="l2.36">     },</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38">     /* Public Members */</span>
<a href="#l2.39"></a><span id="l2.39">     session: null,</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41">     /**</span>
<a href="#l2.42"></a><span id="l2.42">      * Make sure a session is available.</span>
<a href="#l2.43"></a><span id="l2.43">      */</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineat">@@ -118,18 +117,19 @@ calGoogleCalendar.prototype = {</span>
<a href="#l2.45"></a><span id="l2.45"> </span>
<a href="#l2.46"></a><span id="l2.46">     get uri() { return this.mUri; },</span>
<a href="#l2.47"></a><span id="l2.47">     set uri(aUri) {</span>
<a href="#l2.48"></a><span id="l2.48">         const protocols = [&quot;http&quot;, &quot;https&quot;, &quot;webcal&quot;, &quot;webcals&quot;];</span>
<a href="#l2.49"></a><span id="l2.49">         this.mUri = aUri;</span>
<a href="#l2.50"></a><span id="l2.50">         if (aUri &amp;&amp; aUri.schemeIs(&quot;googleapi&quot;)) {</span>
<a href="#l2.51"></a><span id="l2.51">             // new format:  googleapi://session-id/?calendar=calhash@group.calendar.google.com&amp;tasks=taskhash</span>
<a href="#l2.52"></a><span id="l2.52">             let [fullUser, path] = aUri.pathQueryRef.substr(2).split(&quot;/&quot;, 2);</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-            let parameters = new Map(path.substr(1).split(&quot;&amp;&quot;).filter(Boolean)</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-                             .map(function(x) { return x.split(&quot;=&quot;, 2).map(decodeURIComponent); }));</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+            let keyvalues = path.substr(1).split(&quot;&amp;&quot;).filter(Boolean);</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+            let pairs = keyvalues.map(keyvalue =&gt; keyvalue.split(&quot;=&quot;, 2).map(decodeURIComponent));</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+            let parameters = new Map(pairs);</span>
<a href="#l2.58"></a><span id="l2.58"> </span>
<a href="#l2.59"></a><span id="l2.59">             if (parameters.size == 0) {</span>
<a href="#l2.60"></a><span id="l2.60">                 this.mCalendarName = fullUser;</span>
<a href="#l2.61"></a><span id="l2.61">                 this.mTasklistName = this.isDefaultCalendar ? &quot;@default&quot; : null;</span>
<a href="#l2.62"></a><span id="l2.62">             } else {</span>
<a href="#l2.63"></a><span id="l2.63">                 this.mCalendarName = parameters.get(&quot;calendar&quot;);</span>
<a href="#l2.64"></a><span id="l2.64">                 this.mTasklistName = parameters.get(&quot;tasks&quot;);</span>
<a href="#l2.65"></a><span id="l2.65">             }</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineat">@@ -147,17 +147,17 @@ calGoogleCalendar.prototype = {</span>
<a href="#l2.67"></a><span id="l2.67"> </span>
<a href="#l2.68"></a><span id="l2.68">             // Unit tests will use a local uri, if the magic parameter is passed.</span>
<a href="#l2.69"></a><span id="l2.69">             let port = parameters.get(&quot;testport&quot;);</span>
<a href="#l2.70"></a><span id="l2.70">             if (port) {</span>
<a href="#l2.71"></a><span id="l2.71">                 cal.LOG(&quot;[calGoogleCalendar] Redirecting request to test port &quot; + port);</span>
<a href="#l2.72"></a><span id="l2.72">                 API_BASE.EVENTS = &quot;http://localhost:&quot; + port + &quot;/calendar/v3/&quot;;</span>
<a href="#l2.73"></a><span id="l2.73">                 API_BASE.TASKS = &quot;http://localhost:&quot; + port + &quot;/tasks/v1/&quot;;</span>
<a href="#l2.74"></a><span id="l2.74">             }</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-        } else if (aUri &amp;&amp; protocols.some(function(scheme) { return aUri.schemeIs(scheme); })) {</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+        } else if (aUri &amp;&amp; protocols.some(scheme =&gt; aUri.schemeIs(scheme))) {</span>
<a href="#l2.77"></a><span id="l2.77">             // Parse google url, catch private cookies, public calendars,</span>
<a href="#l2.78"></a><span id="l2.78">             // basic and full types, bogus ics file extensions, invalid hostnames</span>
<a href="#l2.79"></a><span id="l2.79">             let re = new RegExp(&quot;/calendar/(feeds|ical)/&quot; +</span>
<a href="#l2.80"></a><span id="l2.80">                                 &quot;([^/]+)/(public|private|free-busy)-?([^/]+)?/&quot; +</span>
<a href="#l2.81"></a><span id="l2.81">                                 &quot;(full|basic)(.ics)?$&quot;);</span>
<a href="#l2.82"></a><span id="l2.82"> </span>
<a href="#l2.83"></a><span id="l2.83">             let matches = aUri.pathQueryRef.match(re);</span>
<a href="#l2.84"></a><span id="l2.84">             if (matches) {</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineat">@@ -181,17 +181,17 @@ calGoogleCalendar.prototype = {</span>
<a href="#l2.86"></a><span id="l2.86"> </span>
<a href="#l2.87"></a><span id="l2.87">         if (this.id &amp;&amp; this.uri) {</span>
<a href="#l2.88"></a><span id="l2.88">             this.ensureSession();</span>
<a href="#l2.89"></a><span id="l2.89">         }</span>
<a href="#l2.90"></a><span id="l2.90"> </span>
<a href="#l2.91"></a><span id="l2.91">         return this.mUri;</span>
<a href="#l2.92"></a><span id="l2.92">     },</span>
<a href="#l2.93"></a><span id="l2.93"> </span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-    createEventsURI: function (...extraParts) {</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+    createEventsURI: function(...extraParts) {</span>
<a href="#l2.96"></a><span id="l2.96">         let eventsURI = null;</span>
<a href="#l2.97"></a><span id="l2.97">         if (this.mCalendarName) {</span>
<a href="#l2.98"></a><span id="l2.98">             let encodedName = encodeURIComponent(this.mCalendarName);</span>
<a href="#l2.99"></a><span id="l2.99">             let parts = [&quot;calendars&quot;, encodedName].concat(extraParts.filter(Boolean));</span>
<a href="#l2.100"></a><span id="l2.100">             eventsURI = API_BASE.EVENTS + parts.join(&quot;/&quot;);</span>
<a href="#l2.101"></a><span id="l2.101">         }</span>
<a href="#l2.102"></a><span id="l2.102">         return eventsURI;</span>
<a href="#l2.103"></a><span id="l2.103">     },</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineat">@@ -206,17 +206,17 @@ calGoogleCalendar.prototype = {</span>
<a href="#l2.105"></a><span id="l2.105">         if (this.mTasklistName) {</span>
<a href="#l2.106"></a><span id="l2.106">             let encodedName = encodeURIComponent(this.mTasklistName);</span>
<a href="#l2.107"></a><span id="l2.107">             let parts = [&quot;lists&quot;, encodedName].concat(extraParts.filter(Boolean));</span>
<a href="#l2.108"></a><span id="l2.108">             tasksURI = API_BASE.TASKS + parts.join(&quot;/&quot;);</span>
<a href="#l2.109"></a><span id="l2.109">         }</span>
<a href="#l2.110"></a><span id="l2.110">         return tasksURI;</span>
<a href="#l2.111"></a><span id="l2.111">     },</span>
<a href="#l2.112"></a><span id="l2.112"> </span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-    getUpdatedMin: function getUpdatedMin(aWhich) {</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+    getUpdatedMin: function(aWhich) {</span>
<a href="#l2.115"></a><span id="l2.115">         let updatedMin = null;</span>
<a href="#l2.116"></a><span id="l2.116">         let lastUpdated = this.getProperty(&quot;lastUpdated.&quot; + aWhich);</span>
<a href="#l2.117"></a><span id="l2.117">         if (lastUpdated) {</span>
<a href="#l2.118"></a><span id="l2.118">             updatedMin = cal.createDateTime(lastUpdated);</span>
<a href="#l2.119"></a><span id="l2.119">             let lastWeek = cal.dtz.now();</span>
<a href="#l2.120"></a><span id="l2.120">             lastWeek.day -= 7;</span>
<a href="#l2.121"></a><span id="l2.121">             if (updatedMin.compare(lastWeek) &lt;= 0) {</span>
<a href="#l2.122"></a><span id="l2.122">                 cal.LOG(&quot;[calGoogleCalendar] Last updated time for &quot; + aWhich +</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineat">@@ -263,36 +263,38 @@ calGoogleCalendar.prototype = {</span>
<a href="#l2.124"></a><span id="l2.124">             case &quot;capabilities.timezones.floating.supported&quot;:</span>
<a href="#l2.125"></a><span id="l2.125">             case &quot;capabilities.attachments.supported&quot;:</span>
<a href="#l2.126"></a><span id="l2.126">             case &quot;capabilities.priority.supported&quot;:</span>
<a href="#l2.127"></a><span id="l2.127">                 return false;</span>
<a href="#l2.128"></a><span id="l2.128">             case &quot;capabilities.privacy.values&quot;:</span>
<a href="#l2.129"></a><span id="l2.129">                 return [&quot;DEFAULT&quot;, &quot;PUBLIC&quot;, &quot;PRIVATE&quot;];</span>
<a href="#l2.130"></a><span id="l2.130">             case &quot;capabilities.alarms.maxCount&quot;:</span>
<a href="#l2.131"></a><span id="l2.131">                 return 5;</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-            case &quot;capabilities.alarms.actionValues&quot;:</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+            case &quot;capabilities.alarms.actionValues&quot;: {</span>
<a href="#l2.134"></a><span id="l2.134">                 let actionValues = [&quot;DISPLAY&quot;, &quot;EMAIL&quot;];</span>
<a href="#l2.135"></a><span id="l2.135">                 if (Preferences.get(&quot;calendar.google.enableSMSReminders&quot;, false)) {</span>
<a href="#l2.136"></a><span id="l2.136">                     actionValues.push(&quot;SMS&quot;);</span>
<a href="#l2.137"></a><span id="l2.137">                 }</span>
<a href="#l2.138"></a><span id="l2.138">                 return actionValues;</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+            }</span>
<a href="#l2.140"></a><span id="l2.140">             case &quot;capabilities.tasks.supported&quot;:</span>
<a href="#l2.141"></a><span id="l2.141">                 return !!this.mTasklistName;</span>
<a href="#l2.142"></a><span id="l2.142">             case &quot;capabilities.events.supported&quot;:</span>
<a href="#l2.143"></a><span id="l2.143">                 return !!this.mCalendarName;</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-            case &quot;readOnly&quot;:</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+            case &quot;readOnly&quot;: {</span>
<a href="#l2.146"></a><span id="l2.146">                 // If this calendar displays events, make it readonly if we are</span>
<a href="#l2.147"></a><span id="l2.147">                 // not the owner or have write access.</span>
<a href="#l2.148"></a><span id="l2.148">                 let accessRole = this.getProperty(&quot;settings.accessRole&quot;);</span>
<a href="#l2.149"></a><span id="l2.149">                 let isReader = (accessRole == &quot;freeBusyReader&quot; || accessRole == &quot;reader&quot;);</span>
<a href="#l2.150"></a><span id="l2.150">                 if (this.mCalendarName &amp;&amp; isReader) {</span>
<a href="#l2.151"></a><span id="l2.151">                     return true;</span>
<a href="#l2.152"></a><span id="l2.152">                 }</span>
<a href="#l2.153"></a><span id="l2.153">                 // Otherwise fall through</span>
<a href="#l2.154"></a><span id="l2.154">                 break;</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+            }</span>
<a href="#l2.156"></a><span id="l2.156">             case &quot;organizerId&quot;:</span>
<a href="#l2.157"></a><span id="l2.157">                 return &quot;mailto:&quot; + this.mCalendarName;</span>
<a href="#l2.158"></a><span id="l2.158">             case &quot;itip.transport&quot;:</span>
<a href="#l2.159"></a><span id="l2.159">                 if (!this.isDefaultCalendar ||</span>
<a href="#l2.160"></a><span id="l2.160">                     !Preferences.get(&quot;calendar.google.enableEmailInvitations&quot;, false)) {</span>
<a href="#l2.161"></a><span id="l2.161">                     // If we explicitly return null here, then these calendars</span>
<a href="#l2.162"></a><span id="l2.162">                     // will not be included in the list of calendars to accept</span>
<a href="#l2.163"></a><span id="l2.163">                     // invitations to and imip will effectively be disabled.</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineat">@@ -317,28 +319,27 @@ calGoogleCalendar.prototype = {</span>
<a href="#l2.165"></a><span id="l2.165">     setProperty: function(aName, aValue) {</span>
<a href="#l2.166"></a><span id="l2.166">         switch (aName) {</span>
<a href="#l2.167"></a><span id="l2.167">             case &quot;refreshInterval&quot;:</span>
<a href="#l2.168"></a><span id="l2.168">                 if (aValue &lt; MIN_REFRESH_INTERVAL &amp;&amp; aValue != 0) {</span>
<a href="#l2.169"></a><span id="l2.169">                     cal.LOG(&quot;[calGoogleCalendar] Sorry, auto-refresh intervals under &quot; +</span>
<a href="#l2.170"></a><span id="l2.170">                             MIN_REFRESH_INTERVAL + &quot; minutes would cause the quota &quot; +</span>
<a href="#l2.171"></a><span id="l2.171">                             &quot;to be reached too fast.&quot;);</span>
<a href="#l2.172"></a><span id="l2.172">                     this.superCalendar.setProperty(&quot;refreshInterval&quot;, 2 * MIN_REFRESH_INTERVAL);</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-                    return;</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+                    return undefined;</span>
<a href="#l2.175"></a><span id="l2.175">                 }</span>
<a href="#l2.176"></a><span id="l2.176">                 break;</span>
<a href="#l2.177"></a><span id="l2.177">         }</span>
<a href="#l2.178"></a><span id="l2.178"> </span>
<a href="#l2.179"></a><span id="l2.179">         return this.__proto__.__proto__.setProperty.apply(this, arguments);</span>
<a href="#l2.180"></a><span id="l2.180">     },</span>
<a href="#l2.181"></a><span id="l2.181"> </span>
<a href="#l2.182"></a><span id="l2.182">     addItem: function(aItem, aListener) { return this.adoptItem(aItem.clone(), aListener); },</span>
<a href="#l2.183"></a><span id="l2.183">     adoptItem: function(aItem, aListener) {</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-        function stackContains(part, max) {</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineminus">-            if (max === undefined) max = 8;</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+        function stackContains(part, max=8) {</span>
<a href="#l2.187"></a><span id="l2.187">             let stack = Components.stack.caller;</span>
<a href="#l2.188"></a><span id="l2.188">             while (stack &amp;&amp; --max) {</span>
<a href="#l2.189"></a><span id="l2.189">                 if (stack.filename &amp;&amp; stack.filename.endsWith(part)) {</span>
<a href="#l2.190"></a><span id="l2.190">                     return true;</span>
<a href="#l2.191"></a><span id="l2.191">                 }</span>
<a href="#l2.192"></a><span id="l2.192">                 stack = stack.caller;</span>
<a href="#l2.193"></a><span id="l2.193">             }</span>
<a href="#l2.194"></a><span id="l2.194">             return false;</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineat">@@ -402,34 +403,34 @@ calGoogleCalendar.prototype = {</span>
<a href="#l2.196"></a><span id="l2.196">                 // item. This really sucks for us now, because the cache will</span>
<a href="#l2.197"></a><span id="l2.197">                 // reset the wrong item. As a hack, delete the item with its</span>
<a href="#l2.198"></a><span id="l2.198">                 // original id and complete the adoptItem call with the new</span>
<a href="#l2.199"></a><span id="l2.199">                 // item. This will add the new item to the calendar.</span>
<a href="#l2.200"></a><span id="l2.200">                 let pcal = cal.async.promisifyCalendar(this.offlineStorage);</span>
<a href="#l2.201"></a><span id="l2.201">                 await pcal.deleteItem(aItem);</span>
<a href="#l2.202"></a><span id="l2.202">             }</span>
<a href="#l2.203"></a><span id="l2.203">             return item;</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-        })().then(function(item) {</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+        })().then((item) =&gt; {</span>
<a href="#l2.206"></a><span id="l2.206">             cal.LOG(&quot;[calGoogleCalendar] Adding &quot; + item.title + &quot; succeeded&quot;);</span>
<a href="#l2.207"></a><span id="l2.207">             this.observers.notify(&quot;onAddItem&quot;, [item]);</span>
<a href="#l2.208"></a><span id="l2.208">             this.notifyOperationComplete(aListener, Components.results.NS_OK,</span>
<a href="#l2.209"></a><span id="l2.209">                                          cIOL.ADD, item.id, item);</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-        }.bind(this), function(e) {</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineplus">+        }, (e) =&gt; {</span>
<a href="#l2.212"></a><span id="l2.212">             let code = e.result || Components.results.NS_ERROR_FAILURE;</span>
<a href="#l2.213"></a><span id="l2.213">             cal.ERROR(&quot;[calGoogleCalendar] Adding Item &quot; + aItem.title +</span>
<a href="#l2.214"></a><span id="l2.214">                       &quot; failed:&quot; + code + &quot;: &quot; + e.message);</span>
<a href="#l2.215"></a><span id="l2.215">             this.notifyPureOperationComplete(aListener, code, cIOL.ADD, aItem.id, e.message);</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-        }.bind(this));</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+        });</span>
<a href="#l2.218"></a><span id="l2.218">         return request;</span>
<a href="#l2.219"></a><span id="l2.219">     },</span>
<a href="#l2.220"></a><span id="l2.220"> </span>
<a href="#l2.221"></a><span id="l2.221">     modifyItem: function(aNewItem, aOldItem, aListener) {</span>
<a href="#l2.222"></a><span id="l2.222">         cal.LOG(&quot;[calGoogleCalendar] Modifying item &quot; + aNewItem.title + &quot; (&quot; +</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineminus">-                (aNewItem.recurrenceId ? aNewItem.recurrenceId.icalString :</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineminus">-                &quot;master item&quot;) + &quot;)&quot;);</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+                (aNewItem.recurrenceId ? aNewItem.recurrenceId.icalString</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+                                       : &quot;master item&quot;) + &quot;)&quot;);</span>
<a href="#l2.227"></a><span id="l2.227"> </span>
<a href="#l2.228"></a><span id="l2.228">         // Set up the request</span>
<a href="#l2.229"></a><span id="l2.229">         let request = new calGoogleRequest();</span>
<a href="#l2.230"></a><span id="l2.230">         (async () =&gt; {</span>
<a href="#l2.231"></a><span id="l2.231">             request.type = request.MODIFY;</span>
<a href="#l2.232"></a><span id="l2.232">             request.calendar = this;</span>
<a href="#l2.233"></a><span id="l2.233">             if (cal.item.isEvent(aNewItem)) {</span>
<a href="#l2.234"></a><span id="l2.234">                 let googleId = getGoogleId(aNewItem, this.offlineStorage);</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineat">@@ -502,30 +503,29 @@ calGoogleCalendar.prototype = {</span>
<a href="#l2.236"></a><span id="l2.236">                 } else {</span>
<a href="#l2.237"></a><span id="l2.237">                     // Not canceled means the occurrence was modified.</span>
<a href="#l2.238"></a><span id="l2.238">                     modifiedItem.recurrenceInfo.modifyException(item, true);</span>
<a href="#l2.239"></a><span id="l2.239">                 }</span>
<a href="#l2.240"></a><span id="l2.240">                 item = modifiedItem;</span>
<a href="#l2.241"></a><span id="l2.241">             }</span>
<a href="#l2.242"></a><span id="l2.242"> </span>
<a href="#l2.243"></a><span id="l2.243">             return item;</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineminus">-        })().then(function (item) {</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+        })().then((item) =&gt; {</span>
<a href="#l2.246"></a><span id="l2.246">             cal.LOG(&quot;[calGoogleCalendar] Modifying &quot; + aNewItem.title + &quot; succeeded&quot;);</span>
<a href="#l2.247"></a><span id="l2.247">             this.observers.notify(&quot;onModifyItem&quot;, [item, aOldItem]);</span>
<a href="#l2.248"></a><span id="l2.248">             this.notifyOperationComplete(aListener, Components.results.NS_OK,</span>
<a href="#l2.249"></a><span id="l2.249">                                          cIOL.MODIFY, item.id, item);</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-        }.bind(this), function(e) {</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineplus">+        }, (e) =&gt; {</span>
<a href="#l2.253"></a><span id="l2.253">             let code = e.result || Components.results.NS_ERROR_FAILURE;</span>
<a href="#l2.254"></a><span id="l2.254">             if (code != Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l2.255"></a><span id="l2.255">                 cal.ERROR(&quot;[calGoogleCalendar] Modifying item &quot; + aNewItem.title +</span>
<a href="#l2.256"></a><span id="l2.256">                           &quot; failed:&quot; + code + &quot;: &quot; + e.message);</span>
<a href="#l2.257"></a><span id="l2.257">             }</span>
<a href="#l2.258"></a><span id="l2.258">             this.notifyPureOperationComplete(aListener, code, cIOL.MODIFY, aNewItem.id, e.message);</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-        }.bind(this));</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineplus">+        });</span>
<a href="#l2.261"></a><span id="l2.261">         return request;</span>
<a href="#l2.262"></a><span id="l2.262">     },</span>
<a href="#l2.263"></a><span id="l2.263"> </span>
<a href="#l2.264"></a><span id="l2.264">     deleteItem: function(aItem, aListener) {</span>
<a href="#l2.265"></a><span id="l2.265">         cal.LOG(&quot;[calGoogleCalendar] Deleting item &quot; + aItem.title + &quot;(&quot; + aItem.id + &quot;)&quot;);</span>
<a href="#l2.266"></a><span id="l2.266"> </span>
<a href="#l2.267"></a><span id="l2.267">         let request = new calGoogleRequest();</span>
<a href="#l2.268"></a><span id="l2.268">         (async () =&gt; {</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineat">@@ -555,46 +555,46 @@ calGoogleCalendar.prototype = {</span>
<a href="#l2.270"></a><span id="l2.270">             }</span>
<a href="#l2.271"></a><span id="l2.271"> </span>
<a href="#l2.272"></a><span id="l2.272">             try {</span>
<a href="#l2.273"></a><span id="l2.273">                 await this.session.asyncItemRequest(request);</span>
<a href="#l2.274"></a><span id="l2.274">             } catch (e) {</span>
<a href="#l2.275"></a><span id="l2.275">                 if (e.result == calGoogleRequest.CONFLICT_MODIFY ||</span>
<a href="#l2.276"></a><span id="l2.276">                     e.result == calGoogleRequest.CONFLICT_DELETED) {</span>
<a href="#l2.277"></a><span id="l2.277">                     await checkResolveConflict(request, this, aItem);</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-                 } else {</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineplus">+                } else {</span>
<a href="#l2.280"></a><span id="l2.280">                     throw e;</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-                 }</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+                }</span>
<a href="#l2.283"></a><span id="l2.283">             }</span>
<a href="#l2.284"></a><span id="l2.284"> </span>
<a href="#l2.285"></a><span id="l2.285">             deleteItemMetadata(this.offlineStorage, aItem);</span>
<a href="#l2.286"></a><span id="l2.286"> </span>
<a href="#l2.287"></a><span id="l2.287">             return aItem;</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineminus">-        })().then(function (item) {</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineplus">+        })().then((item) =&gt; {</span>
<a href="#l2.290"></a><span id="l2.290">             cal.LOG(&quot;[calGoogleCalendar] Deleting &quot; + aItem.title + &quot; succeeded&quot;);</span>
<a href="#l2.291"></a><span id="l2.291">             this.observers.notify(&quot;onDeleteItem&quot;, [item]);</span>
<a href="#l2.292"></a><span id="l2.292">             this.notifyOperationComplete(aListener, Components.results.NS_OK,</span>
<a href="#l2.293"></a><span id="l2.293">                                          cIOL.DELETE, item.id, item);</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineminus">-        }.bind(this), function(e) {</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+        }, (e) =&gt; {</span>
<a href="#l2.296"></a><span id="l2.296">             let code = e.result || Components.results.NS_ERROR_FAILURE;</span>
<a href="#l2.297"></a><span id="l2.297">             if (code != Components.interfaces.calIErrors.OPERATION_CANCELLED) {</span>
<a href="#l2.298"></a><span id="l2.298">                 cal.ERROR(&quot;[calGoogleCalendar] Deleting item &quot; + aItem.title +</span>
<a href="#l2.299"></a><span id="l2.299">                           &quot; failed:&quot; + code + &quot;: &quot; + e.message);</span>
<a href="#l2.300"></a><span id="l2.300">             }</span>
<a href="#l2.301"></a><span id="l2.301">             this.notifyPureOperationComplete(aListener, code, cIOL.DELETE, aItem.id, e.message);</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineminus">-        }.bind(this));</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineplus">+        });</span>
<a href="#l2.304"></a><span id="l2.304">         return request;</span>
<a href="#l2.305"></a><span id="l2.305">     },</span>
<a href="#l2.306"></a><span id="l2.306"> </span>
<a href="#l2.307"></a><span id="l2.307">     getItem: function(aId, aListener) {</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineminus">-        this.mOfflineStorage.getItem.apply(this.mOfflineStorage, arguments);</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+        this.mOfflineStorage.getItem(...arguments);</span>
<a href="#l2.310"></a><span id="l2.310">     },</span>
<a href="#l2.311"></a><span id="l2.311"> </span>
<a href="#l2.312"></a><span id="l2.312">     getItems: function(aFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineminus">-        this.mOfflineStorage.getItems.apply(this.mOfflineStorage, arguments);</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineplus">+        this.mOfflineStorage.getItems(...arguments);</span>
<a href="#l2.315"></a><span id="l2.315">     },</span>
<a href="#l2.316"></a><span id="l2.316"> </span>
<a href="#l2.317"></a><span id="l2.317">     refresh: function() {</span>
<a href="#l2.318"></a><span id="l2.318">         this.mObservers.notify(&quot;onLoad&quot;, [this]);</span>
<a href="#l2.319"></a><span id="l2.319">     },</span>
<a href="#l2.320"></a><span id="l2.320"> </span>
<a href="#l2.321"></a><span id="l2.321">     migrateStorageCache: function() {</span>
<a href="#l2.322"></a><span id="l2.322">         let cacheVersion = this.getProperty(&quot;cache.version&quot;);</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineat">@@ -620,20 +620,20 @@ calGoogleCalendar.prototype = {</span>
<a href="#l2.324"></a><span id="l2.324">             let birthdayCalendar = &quot;#contacts@group.v.calendar.google.com&quot;;</span>
<a href="#l2.325"></a><span id="l2.325">             if (this.mCalendarName &amp;&amp; this.mCalendarName == birthdayCalendar) {</span>
<a href="#l2.326"></a><span id="l2.326">                 needsReset = true;</span>
<a href="#l2.327"></a><span id="l2.327">             }</span>
<a href="#l2.328"></a><span id="l2.328">         }</span>
<a href="#l2.329"></a><span id="l2.329"> </span>
<a href="#l2.330"></a><span id="l2.330">         // Migration all done. Reset if requested.</span>
<a href="#l2.331"></a><span id="l2.331">         if (needsReset) {</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineminus">-            return this.resetSync().then(function() {</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+            return this.resetSync().then(() =&gt; {</span>
<a href="#l2.334"></a><span id="l2.334">                 this.setProperty(&quot;cache.version&quot;, this.CACHE_DB_VERSION);</span>
<a href="#l2.335"></a><span id="l2.335">                 return needsReset;</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineminus">-            }.bind(this));</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+            });</span>
<a href="#l2.338"></a><span id="l2.338">         } else {</span>
<a href="#l2.339"></a><span id="l2.339">             this.setProperty(&quot;cache.version&quot;, this.CACHE_DB_VERSION);</span>
<a href="#l2.340"></a><span id="l2.340">             return Promise.resolve(needsReset);</span>
<a href="#l2.341"></a><span id="l2.341">         }</span>
<a href="#l2.342"></a><span id="l2.342">     },</span>
<a href="#l2.343"></a><span id="l2.343"> </span>
<a href="#l2.344"></a><span id="l2.344">     /**</span>
<a href="#l2.345"></a><span id="l2.345">      * Implement calIChangeLog</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineat">@@ -641,38 +641,39 @@ calGoogleCalendar.prototype = {</span>
<a href="#l2.347"></a><span id="l2.347">     get offlineStorage() { return this.mOfflineStorage; },</span>
<a href="#l2.348"></a><span id="l2.348">     set offlineStorage(val) {</span>
<a href="#l2.349"></a><span id="l2.349">         this.mOfflineStorage = val;</span>
<a href="#l2.350"></a><span id="l2.350">         this.migrateStorageCache();</span>
<a href="#l2.351"></a><span id="l2.351">         return val;</span>
<a href="#l2.352"></a><span id="l2.352">     },</span>
<a href="#l2.353"></a><span id="l2.353"> </span>
<a href="#l2.354"></a><span id="l2.354">     resetLog: function() {</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineminus">-        this.resetSync().then(function() {</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineplus">+        this.resetSync().then(() =&gt; {</span>
<a href="#l2.357"></a><span id="l2.357">             this.mObservers.notify(&quot;onLoad&quot;, [this]);</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineminus">-        }.bind(this));</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineplus">+        });</span>
<a href="#l2.360"></a><span id="l2.360">     },</span>
<a href="#l2.361"></a><span id="l2.361"> </span>
<a href="#l2.362"></a><span id="l2.362">     resetSync: function() {</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineminus">-        let deferred = PromiseUtils.defer();</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineminus">-        cal.LOG(&quot;[calGoogleCalendar] Resetting last updated counter for &quot; + this.name);</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineminus">-        this.setProperty(&quot;syncToken.events&quot;, &quot;&quot;);</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineminus">-        this.setProperty(&quot;lastUpdated.tasks&quot;, &quot;&quot;);</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineminus">-        this.mThrottle = Object.create(null);</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineminus">-        this.mOfflineStorage.QueryInterface(Components.interfaces.calICalendarProvider)</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-                            .deleteCalendar(this.mOfflineStorage, {</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineminus">-            onDeleteCalendar: function(aCalendar, aStatus, aDetail) {</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineminus">-                if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineminus">-                    deferred.resolve();</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineminus">-                } else {</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineminus">-                    deferred.reject(aDetail);</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+        return new Promise((resolve, reject) =&gt; {</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Resetting last updated counter for &quot; + this.name);</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineplus">+            this.setProperty(&quot;syncToken.events&quot;, &quot;&quot;);</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineplus">+            this.setProperty(&quot;lastUpdated.tasks&quot;, &quot;&quot;);</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+            this.mThrottle = Object.create(null);</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineplus">+            let listener = {</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineplus">+                onDeleteCalendar: function(aCalendar, aStatus, aDetail) {</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineplus">+                    if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineplus">+                        resolve();</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineplus">+                    } else {</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineplus">+                        reject(aDetail);</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineplus">+                    }</span>
<a href="#l2.387"></a><span id="l2.387">                 }</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineminus">-            }</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineminus">-       });</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineminus">-       return deferred.promise;</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineplus">+            };</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineplus">+            this.mOfflineStorage.QueryInterface(Components.interfaces.calICalendarProvider)</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+                                .deleteCalendar(this.mOfflineStorage, listener);</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineplus">+        });</span>
<a href="#l2.395"></a><span id="l2.395">     },</span>
<a href="#l2.396"></a><span id="l2.396"> </span>
<a href="#l2.397"></a><span id="l2.397">     replayChangesOn: function(aListener) {</span>
<a href="#l2.398"></a><span id="l2.398">         // Figure out if the user is idle, no need to synchronize if so.</span>
<a href="#l2.399"></a><span id="l2.399">         let idleTime = Components.classes[&quot;@mozilla.org/widget/idleservice;1&quot;]</span>
<a href="#l2.400"></a><span id="l2.400">                                  .getService(Components.interfaces.nsIIdleService)</span>
<a href="#l2.401"></a><span id="l2.401">                                  .idleTime;</span>
<a href="#l2.402"></a><span id="l2.402">         let maxIdleTime = Preferences.get(&quot;calendar.google.idleTime&quot;, 300) * 1000;</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineat">@@ -691,119 +692,123 @@ calGoogleCalendar.prototype = {</span>
<a href="#l2.404"></a><span id="l2.404">         this.mOfflineStorage.startBatch();</span>
<a href="#l2.405"></a><span id="l2.405"> </span>
<a href="#l2.406"></a><span id="l2.406">         // Update the calendar settings</span>
<a href="#l2.407"></a><span id="l2.407">         let calendarPromise = Promise.resolve();</span>
<a href="#l2.408"></a><span id="l2.408">         if (this.mCalendarName &amp;&amp; this.checkThrottle(&quot;calendarList&quot;)) {</span>
<a href="#l2.409"></a><span id="l2.409">             let calendarRequest = new calGoogleRequest();</span>
<a href="#l2.410"></a><span id="l2.410">             calendarRequest.calendar = this;</span>
<a href="#l2.411"></a><span id="l2.411">             calendarRequest.type = calendarRequest.GET;</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineminus">-            calendarRequest.uri = this.createUsersURI(&quot;calendarList&quot;, this.mCalendarName)</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineminus">-            calendarPromise = this.session.asyncItemRequest(calendarRequest).then(function(aData) {</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineplus">+            calendarRequest.uri = this.createUsersURI(&quot;calendarList&quot;, this.mCalendarName);</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineplus">+            calendarPromise = this.session.asyncItemRequest(calendarRequest).then((aData) =&gt; {</span>
<a href="#l2.416"></a><span id="l2.416">                 if (aData.defaultReminders) {</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineminus">-                    this.defaultReminders = aData.defaultReminders.map(function(x) { return JSONToAlarm(x, true); });</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineplus">+                    this.defaultReminders = aData.defaultReminders.map(reminder =&gt; JSONToAlarm(reminder, true));</span>
<a href="#l2.419"></a><span id="l2.419">                 } else {</span>
<a href="#l2.420"></a><span id="l2.420">                     this.defaultReminders = [];</span>
<a href="#l2.421"></a><span id="l2.421">                 }</span>
<a href="#l2.422"></a><span id="l2.422"> </span>
<a href="#l2.423"></a><span id="l2.423" class="difflineminus">-                for (let k of [&quot;accessRole&quot;, &quot;backgroundColor&quot;, &quot;description&quot;,</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineminus">-                               &quot;foregroundColor&quot;, &quot;location&quot;, &quot;primary&quot;,</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineminus">-                               &quot;summary&quot;, &quot;summaryOverride&quot;, &quot;timeZone&quot;]) {</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineplus">+                let settings = [</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineplus">+                    &quot;accessRole&quot;, &quot;backgroundColor&quot;, &quot;description&quot;,</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineplus">+                    &quot;foregroundColor&quot;, &quot;location&quot;, &quot;primary&quot;, &quot;summary&quot;,</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineplus">+                    &quot;summaryOverride&quot;, &quot;timeZone&quot;</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineplus">+                ];</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineplus">+</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineplus">+                for (let k of settings) {</span>
<a href="#l2.433"></a><span id="l2.433">                     this.setProperty(&quot;settings.&quot; + k, aData[k]);</span>
<a href="#l2.434"></a><span id="l2.434">                 }</span>
<a href="#l2.435"></a><span id="l2.435">                 this.setProperty(&quot;settings.defaultReminders&quot;, JSON.stringify(aData.defaultReminders));</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineminus">-            }.bind(this));</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineplus">+            });</span>
<a href="#l2.438"></a><span id="l2.438">         }</span>
<a href="#l2.439"></a><span id="l2.439"> </span>
<a href="#l2.440"></a><span id="l2.440">         // Set up a request for the events</span>
<a href="#l2.441"></a><span id="l2.441">         let eventsRequest = new calGoogleRequest();</span>
<a href="#l2.442"></a><span id="l2.442">         let eventsPromise = Promise.resolve();</span>
<a href="#l2.443"></a><span id="l2.443">         eventsRequest.calendar = this;</span>
<a href="#l2.444"></a><span id="l2.444">         eventsRequest.type = eventsRequest.GET;</span>
<a href="#l2.445"></a><span id="l2.445">         eventsRequest.uri = this.createEventsURI(&quot;events&quot;);</span>
<a href="#l2.446"></a><span id="l2.446">         eventsRequest.addQueryParameter(&quot;maxResults&quot;, maxResults);</span>
<a href="#l2.447"></a><span id="l2.447">         let syncToken = this.getProperty(&quot;syncToken.events&quot;);</span>
<a href="#l2.448"></a><span id="l2.448">         if (syncToken) {</span>
<a href="#l2.449"></a><span id="l2.449">             eventsRequest.addQueryParameter(&quot;showDeleted&quot;, &quot;true&quot;);</span>
<a href="#l2.450"></a><span id="l2.450">             eventsRequest.addQueryParameter(&quot;syncToken&quot;, syncToken);</span>
<a href="#l2.451"></a><span id="l2.451">         }</span>
<a href="#l2.452"></a><span id="l2.452">         if (eventsRequest.uri &amp;&amp; this.checkThrottle(&quot;events&quot;)) {</span>
<a href="#l2.453"></a><span id="l2.453">             let saver = new ItemSaver(this);</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineminus">-            eventsPromise = this.session.asyncPaginatedRequest(eventsRequest, null, function(aData) {</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineplus">+            eventsPromise = this.session.asyncPaginatedRequest(eventsRequest, null, (aData) =&gt; {</span>
<a href="#l2.456"></a><span id="l2.456">                 // On each request...</span>
<a href="#l2.457"></a><span id="l2.457">                 return saver.parseItemStream(aData);</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineminus">-            }.bind(this), function(aData) {</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineplus">+            }, (aData) =&gt; {</span>
<a href="#l2.460"></a><span id="l2.460">                 // On last request...</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineminus">-                return saver.complete().then(function() {</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineplus">+                return saver.complete().then(() =&gt; {</span>
<a href="#l2.463"></a><span id="l2.463">                     if (aData.nextSyncToken) {</span>
<a href="#l2.464"></a><span id="l2.464">                         cal.LOG(&quot;[calGoogleCalendar] New sync token for &quot; +</span>
<a href="#l2.465"></a><span id="l2.465">                                 this.name + &quot;(events) is now: &quot; + aData.nextSyncToken);</span>
<a href="#l2.466"></a><span id="l2.466">                         this.setProperty(&quot;syncToken.events&quot;, aData.nextSyncToken);</span>
<a href="#l2.467"></a><span id="l2.467">                     }</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineminus">-                }.bind(this));</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineminus">-            }.bind(this));</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineplus">+                });</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineplus">+            });</span>
<a href="#l2.472"></a><span id="l2.472">         }</span>
<a href="#l2.473"></a><span id="l2.473"> </span>
<a href="#l2.474"></a><span id="l2.474">         // Set up a request for tasks</span>
<a href="#l2.475"></a><span id="l2.475">         let tasksRequest = new calGoogleRequest();</span>
<a href="#l2.476"></a><span id="l2.476">         let tasksPromise = Promise.resolve();</span>
<a href="#l2.477"></a><span id="l2.477">         tasksRequest.calendar = this;</span>
<a href="#l2.478"></a><span id="l2.478">         tasksRequest.type = tasksRequest.GET;</span>
<a href="#l2.479"></a><span id="l2.479">         tasksRequest.uri = this.createTasksURI(&quot;tasks&quot;);</span>
<a href="#l2.480"></a><span id="l2.480">         tasksRequest.addQueryParameter(&quot;maxResults&quot;, maxResults);</span>
<a href="#l2.481"></a><span id="l2.481">         let lastUpdated = this.getUpdatedMin(&quot;tasks&quot;);</span>
<a href="#l2.482"></a><span id="l2.482">         if (lastUpdated) {</span>
<a href="#l2.483"></a><span id="l2.483">             tasksRequest.addQueryParameter(&quot;updatedMin&quot;, cal.toRFC3339(lastUpdated));</span>
<a href="#l2.484"></a><span id="l2.484">             tasksRequest.addQueryParameter(&quot;showDeleted&quot;, &quot;true&quot;);</span>
<a href="#l2.485"></a><span id="l2.485">         }</span>
<a href="#l2.486"></a><span id="l2.486">         if (tasksRequest.uri &amp;&amp; this.checkThrottle(&quot;tasks&quot;)) {</span>
<a href="#l2.487"></a><span id="l2.487">             let saver = new ItemSaver(this);</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineminus">-            let lastUpdated = null;</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineminus">-            tasksPromise = this.session.asyncPaginatedRequest(tasksRequest, function(aData) {</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineplus">+            let newLastUpdated = null;</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineplus">+            tasksPromise = this.session.asyncPaginatedRequest(tasksRequest, (aData) =&gt; {</span>
<a href="#l2.492"></a><span id="l2.492">                 // On the first request...</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineminus">-                lastUpdated = tasksRequest.requestDate.icalString;</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineminus">-            }.bind(this), function(aData) {</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineplus">+                newLastUpdated = tasksRequest.requestDate.icalString;</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineplus">+            }, (aData) =&gt; {</span>
<a href="#l2.497"></a><span id="l2.497">                 // On each request...</span>
<a href="#l2.498"></a><span id="l2.498">                 return saver.parseItemStream(aData);</span>
<a href="#l2.499"></a><span id="l2.499" class="difflineminus">-            }.bind(this), function(aData) {</span>
<a href="#l2.500"></a><span id="l2.500" class="difflineplus">+            }, (aData) =&gt; {</span>
<a href="#l2.501"></a><span id="l2.501">                 // On last request...</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineminus">-                return saver.complete().then(function() {</span>
<a href="#l2.503"></a><span id="l2.503" class="difflineplus">+                return saver.complete().then(() =&gt; {</span>
<a href="#l2.504"></a><span id="l2.504">                     cal.LOG(&quot;[calGoogleCalendar] Last sync date for &quot; + this.name +</span>
<a href="#l2.505"></a><span id="l2.505">                             &quot;(tasks) is now: &quot; + tasksRequest.requestDate.toString());</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineminus">-                    this.setProperty(&quot;lastUpdated.tasks&quot;, lastUpdated);</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineminus">-                }.bind(this));</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineminus">-            }.bind(this));</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineplus">+                    this.setProperty(&quot;newLastUpdated.tasks&quot;, newLastUpdated);</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineplus">+                });</span>
<a href="#l2.511"></a><span id="l2.511" class="difflineplus">+            });</span>
<a href="#l2.512"></a><span id="l2.512">         }</span>
<a href="#l2.513"></a><span id="l2.513"> </span>
<a href="#l2.514"></a><span id="l2.514" class="difflineminus">-        return Promise.all([calendarPromise, eventsPromise, tasksPromise]).then(function() {</span>
<a href="#l2.515"></a><span id="l2.515" class="difflineplus">+        return Promise.all([calendarPromise, eventsPromise, tasksPromise]).then(() =&gt; {</span>
<a href="#l2.516"></a><span id="l2.516">             this.mOfflineStorage.endBatch();</span>
<a href="#l2.517"></a><span id="l2.517">             aListener.onResult({ status: Components.results.NS_OK }, null);</span>
<a href="#l2.518"></a><span id="l2.518" class="difflineminus">-        }.bind(this), function(e) {</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineplus">+        }, (e) =&gt; {</span>
<a href="#l2.520"></a><span id="l2.520">             this.mOfflineStorage.endBatch();</span>
<a href="#l2.521"></a><span id="l2.521">             let code = e.result || Components.results.NS_ERROR_FAILURE;</span>
<a href="#l2.522"></a><span id="l2.522">             if (code == calGoogleRequest.RESOURCE_GONE) {</span>
<a href="#l2.523"></a><span id="l2.523">                 cal.LOG(&quot;[calGoogleCalendar] Server did not accept &quot; +</span>
<a href="#l2.524"></a><span id="l2.524">                         &quot;incremental update, resetting calendar and &quot; +</span>
<a href="#l2.525"></a><span id="l2.525">                         &quot;starting over.&quot;);</span>
<a href="#l2.526"></a><span id="l2.526" class="difflineminus">-                this.resetSync().then(function() {</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineplus">+                this.resetSync().then(() =&gt; {</span>
<a href="#l2.528"></a><span id="l2.528">                     this.replayChangesOn(aListener);</span>
<a href="#l2.529"></a><span id="l2.529" class="difflineminus">-                }.bind(this), function(e) {</span>
<a href="#l2.530"></a><span id="l2.530" class="difflineplus">+                }, (err) =&gt; {</span>
<a href="#l2.531"></a><span id="l2.531">                     cal.ERROR(&quot;[calGoogleCalendar] Error resetting calendar:\n&quot; +</span>
<a href="#l2.532"></a><span id="l2.532" class="difflineminus">-                            stringException(e));</span>
<a href="#l2.533"></a><span id="l2.533" class="difflineminus">-                    aListener.onResult({ status: e.result }, e.message);</span>
<a href="#l2.534"></a><span id="l2.534" class="difflineminus">-                }.bind(this));</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineplus">+                              stringException(err));</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineplus">+                    aListener.onResult({ status: err.result }, err.message);</span>
<a href="#l2.537"></a><span id="l2.537" class="difflineplus">+                });</span>
<a href="#l2.538"></a><span id="l2.538">             } else {</span>
<a href="#l2.539"></a><span id="l2.539">                 cal.LOG(&quot;[calGoogleCalendar] Error syncing:\n&quot; + code + &quot;:&quot; +</span>
<a href="#l2.540"></a><span id="l2.540">                         stringException(e));</span>
<a href="#l2.541"></a><span id="l2.541">                 aListener.onResult({ status: code }, e.message);</span>
<a href="#l2.542"></a><span id="l2.542">             }</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineminus">-        }.bind(this));</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineplus">+        });</span>
<a href="#l2.545"></a><span id="l2.545">     },</span>
<a href="#l2.546"></a><span id="l2.546"> </span>
<a href="#l2.547"></a><span id="l2.547">     /**</span>
<a href="#l2.548"></a><span id="l2.548">      * Implement calISchedulingSupport. Most is taken care of by the base</span>
<a href="#l2.549"></a><span id="l2.549">      * provider, but we want to advertise that we will always take care of</span>
<a href="#l2.550"></a><span id="l2.550">      * notifications.</span>
<a href="#l2.551"></a><span id="l2.551">      */</span>
<a href="#l2.552"></a><span id="l2.552">     canNotify: function(aMethod, aItem) { return true; }</span>
<a href="#l2.553"></a><span id="l2.553"> };</span>
<a href="#l2.554"></a><span id="l2.554"> </span>
<a href="#l2.555"></a><span id="l2.555" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([calGoogleCalendar]);</span>
<a href="#l2.556"></a><span id="l2.556" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([calGoogleCalendar]); /* exported NSGetFactory */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/providers/gdata/content/browserRequest.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/providers/gdata/content/browserRequest.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,120 +1,103 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l3.6"></a><span id="l3.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+/* exported cancelRequest, loadRequestedUrl, reportUserClosed */</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+</span>
<a href="#l3.12"></a><span id="l3.12"> var wpl = Components.interfaces.nsIWebProgressListener;</span>
<a href="#l3.13"></a><span id="l3.13"> </span>
<a href="#l3.14"></a><span id="l3.14"> var reporterListener = {</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-  _isBusy: false,</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-  get securityButton() {</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-    delete this.securityButton;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-    return this.securityButton = document.getElementById(&quot;security-button&quot;);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-  },</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+    _isBusy: false,</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+    get securityButton() {</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+        delete this.securityButton;</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+        return (this.securityButton = document.getElementById(&quot;security-button&quot;));</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+    },</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-  QueryInterface: function(aIID) {</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-    if (aIID.equals(Components.interfaces.nsIWebProgressListener)   ||</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-        aIID.equals(Components.interfaces.nsISupportsWeakReference) ||</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-        aIID.equals(Components.interfaces.nsISupports))</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-      return this;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-    throw Components.results.NS_NOINTERFACE;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-  },</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+    QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+        Components.interfaces.nsIWebProgressListener,</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+        Components.interfaces.nsISupportsWeakReference,</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+    ]),</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-  onStateChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-                     /*in nsIRequest*/ aRequest,</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-                     /*in unsigned long*/ aStateFlags,</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-                     /*in nsresult*/ aStatus) {</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-  },</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+    onStateChange: function(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+    },</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+    onProgressChange: function(aWebProgress, aRequest, aCurSelfProgress,</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+                               aMaxSelfProgress, aCurTotalProgress, aMaxTotalProgress) {</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+    },</span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-  onProgressChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-                        /*in nsIRequest*/ aRequest,</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-                        /*in long*/ aCurSelfProgress,</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-                        /*in long */aMaxSelfProgress,</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-                        /*in long */aCurTotalProgress,</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-                        /*in long */aMaxTotalProgress) {</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-  },</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+    onLocationChange: function(aWebProgress, aRequest, aLocation) {</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+        document.getElementById(&quot;headerMessage&quot;).textContent = aLocation.spec;</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+    },</span>
<a href="#l3.60"></a><span id="l3.60"> </span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-  onLocationChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-                        /*in nsIRequest*/ aRequest,</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-                        /*in nsIURI*/ aLocation) {</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-    document.getElementById(&quot;headerMessage&quot;).textContent = aLocation.spec;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-  },</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+    onStatusChange: function(aWebProgress, aRequest, aStatus, aMessage) {</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+    },</span>
<a href="#l3.68"></a><span id="l3.68"> </span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-  onStatusChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-                      /*in nsIRequest*/ aRequest,</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-                      /*in nsresult*/ aStatus,</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-                      /*in wstring*/ aMessage) {</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-  },</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-  onSecurityChange: function(/*in nsIWebProgress*/ aWebProgress,</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-                        /*in nsIRequest*/ aRequest,</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-                        /*in unsigned long*/ aState) {</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-    const wpl_security_bits = wpl.STATE_IS_SECURE |</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-                              wpl.STATE_IS_BROKEN |</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-                              wpl.STATE_IS_INSECURE |</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-                              wpl.STATE_SECURE_HIGH |</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-                              wpl.STATE_SECURE_MED |</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-                              wpl.STATE_SECURE_LOW;</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-    var browser = document.getElementById(&quot;requestFrame&quot;);</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-    var level;</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+    onSecurityChange: function(aWebProgress, aRequest, aState) {</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+        const wpl_security_bits = wpl.STATE_IS_SECURE |</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+                                    wpl.STATE_IS_BROKEN |</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+                                    wpl.STATE_IS_INSECURE |</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+                                    wpl.STATE_SECURE_HIGH |</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+                                    wpl.STATE_SECURE_MED |</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+                                    wpl.STATE_SECURE_LOW;</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+        let browser = document.getElementById(&quot;requestFrame&quot;);</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+        let level;</span>
<a href="#l3.95"></a><span id="l3.95"> </span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-    switch (aState &amp; wpl_security_bits) {</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-      case wpl.STATE_IS_SECURE | wpl.STATE_SECURE_HIGH:</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-        level = &quot;high&quot;;</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-        break;</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-      case wpl.STATE_IS_SECURE | wpl.STATE_SECURE_MED:</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-      case wpl.STATE_IS_SECURE | wpl.STATE_SECURE_LOW:</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-        level = &quot;low&quot;;</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-        break;</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-      case wpl.STATE_IS_BROKEN:</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-        level = &quot;broken&quot;;</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-        break;</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+        switch (aState &amp; wpl_security_bits) {</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+            case wpl.STATE_IS_SECURE | wpl.STATE_SECURE_HIGH:</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+                level = &quot;high&quot;;</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+                break;</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+            case wpl.STATE_IS_SECURE | wpl.STATE_SECURE_MED:</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+            case wpl.STATE_IS_SECURE | wpl.STATE_SECURE_LOW:</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+                level = &quot;low&quot;;</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+                break;</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+            case wpl.STATE_IS_BROKEN:</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+                level = &quot;broken&quot;;</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+                break;</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+        }</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+        if (level) {</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+            this.securityButton.setAttribute(&quot;level&quot;, level);</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+            this.securityButton.hidden = false;</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+        } else {</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+            this.securityButton.hidden = true;</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+            this.securityButton.removeAttribute(&quot;level&quot;);</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+        }</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+        this.securityButton.setAttribute(&quot;tooltiptext&quot;, browser.securityUI.tooltipText);</span>
<a href="#l3.127"></a><span id="l3.127">     }</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-    if (level) {</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-      this.securityButton.setAttribute(&quot;level&quot;, level);</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-      this.securityButton.hidden = false;</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-    } else {</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-      this.securityButton.hidden = true;</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-      this.securityButton.removeAttribute(&quot;level&quot;);</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-    }</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-    this.securityButton.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-                                     browser.securityUI.tooltipText);</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-  }</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+};</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+function cancelRequest() {</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+    reportUserClosed();</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+    window.close();</span>
<a href="#l3.143"></a><span id="l3.143"> }</span>
<a href="#l3.144"></a><span id="l3.144"> </span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-function cancelRequest()</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-{</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-  reportUserClosed();</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-  window.close();</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-}</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-function reportUserClosed()</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-{</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-  let request = window.arguments[0].wrappedJSObject;</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-  request.cancelled();</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+function reportUserClosed() {</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+    let request = window.arguments[0].wrappedJSObject;</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+    request.cancelled();</span>
<a href="#l3.158"></a><span id="l3.158"> }</span>
<a href="#l3.159"></a><span id="l3.159"> </span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-function loadRequestedUrl()</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-{</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-  let request = window.arguments[0].wrappedJSObject;</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-  document.getElementById(&quot;headerMessage&quot;).textContent = request.promptText;</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-  let account = request.account;</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-  if (request.iconURI != &quot;&quot;)</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-    document.getElementById(&quot;headerImage&quot;).src = request.iconURI;</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+function loadRequestedUrl() {</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+    let request = window.arguments[0].wrappedJSObject;</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+    document.getElementById(&quot;headerMessage&quot;).textContent = request.promptText;</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+    if (request.iconURI != &quot;&quot;) {</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+        document.getElementById(&quot;headerImage&quot;).src = request.iconURI;</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+    }</span>
<a href="#l3.173"></a><span id="l3.173"> </span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-  var browser = document.getElementById(&quot;requestFrame&quot;);</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-  browser.addProgressListener(reporterListener,</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-                              Components.interfaces.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-  var url = request.url;</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-  if (url != &quot;&quot;) {</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-    browser.setAttribute(&quot;src&quot;, url);</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-    document.getElementById(&quot;headerMessage&quot;).textContent = url;</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-  }</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+    let browser = document.getElementById(&quot;requestFrame&quot;);</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+    browser.addProgressListener(reporterListener,</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+                                Components.interfaces.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+    let url = request.url;</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+    if (url != &quot;&quot;) {</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+        browser.setAttribute(&quot;src&quot;, url);</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+        document.getElementById(&quot;headerMessage&quot;).textContent = url;</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+    }</span>
<a href="#l3.190"></a><span id="l3.190"> </span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-  var dialogMessage =  document.getElementById(&quot;dialogMessage&quot;);</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-  if (request.description) {</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-    dialogMessage.textContent = request.description;</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-  } else {</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-    dialogMessage.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-  }</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-  request.loaded(window, browser.webProgress);</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+    let dialogMessage = document.getElementById(&quot;dialogMessage&quot;);</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+    if (request.description) {</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+        dialogMessage.textContent = request.description;</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+    } else {</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+        dialogMessage.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+    }</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+    request.loaded(window, browser.webProgress);</span>
<a href="#l3.205"></a><span id="l3.205"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-calendar-creation.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-calendar-creation.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -25,17 +25,16 @@ ChromeUtils.import(&quot;resource://gdata-pro</span>
<a href="#l4.4"></a><span id="l4.4">             }</span>
<a href="#l4.5"></a><span id="l4.5">         };</span>
<a href="#l4.6"></a><span id="l4.6">     }</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8">     let previousUriValue = null;</span>
<a href="#l4.9"></a><span id="l4.9">     function selectProvider(type) {</span>
<a href="#l4.10"></a><span id="l4.10">         let isGdata = (type == &quot;gdata&quot;);</span>
<a href="#l4.11"></a><span id="l4.11">         let curi = document.getElementById(&quot;calendar-uri&quot;);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-        let wizard = document.documentElement;</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14">         curi.parentNode.style.visibility = (isGdata ? &quot;hidden&quot; : &quot;visible&quot;);</span>
<a href="#l4.15"></a><span id="l4.15">         document.getElementById(&quot;cache&quot;).parentNode.style.visibility = (isGdata ? &quot;hidden&quot; : &quot;visible&quot;);</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17">         // Move the next step descrition to the right place</span>
<a href="#l4.18"></a><span id="l4.18">         let locationRows = document.querySelector(&quot;#calendar-wizard &gt; [pageid='locationPage'] &gt; grid &gt; rows&quot;);</span>
<a href="#l4.19"></a><span id="l4.19">         let nextStepDescr = document.getElementById(&quot;gdata-nextstep-description&quot;);</span>
<a href="#l4.20"></a><span id="l4.20">         locationRows.appendChild(nextStepDescr);</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -54,83 +53,84 @@ ChromeUtils.import(&quot;resource://gdata-pro</span>
<a href="#l4.22"></a><span id="l4.22">             }</span>
<a href="#l4.23"></a><span id="l4.23">         }</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">         checkRequired();</span>
<a href="#l4.26"></a><span id="l4.26">     }</span>
<a href="#l4.27"></a><span id="l4.27">     this.gdataSelectProvider = selectProvider;</span>
<a href="#l4.28"></a><span id="l4.28"> </span>
<a href="#l4.29"></a><span id="l4.29">     if (typeof tmpCalendarCreation == &quot;undefined&quot;) {</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-        monkeyPatch(window, &quot;onSelectProvider&quot;, function(protofunc, type) {</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+        monkeyPatch(window, &quot;onSelectProvider&quot;, (protofunc, type) =&gt; {</span>
<a href="#l4.32"></a><span id="l4.32">             selectProvider(type);</span>
<a href="#l4.33"></a><span id="l4.33">             return protofunc(type);</span>
<a href="#l4.34"></a><span id="l4.34">         });</span>
<a href="#l4.35"></a><span id="l4.35">     } else {</span>
<a href="#l4.36"></a><span id="l4.36">         // The exchange provider overwrites the select handler, which causes</span>
<a href="#l4.37"></a><span id="l4.37">         // our provider to fail. The exchange provider overwrites the select</span>
<a href="#l4.38"></a><span id="l4.38">         // handler, which causes our provider to fail. Given the exchange</span>
<a href="#l4.39"></a><span id="l4.39">         // provider is currently not maintained and we want them to work</span>
<a href="#l4.40"></a><span id="l4.40">         // together, here is a workaround.</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-        monkeyPatch(tmpCalendarCreation, &quot;doRadioExchangeCalendar&quot;, function(protofunc, target) {</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+        monkeyPatch(tmpCalendarCreation, &quot;doRadioExchangeCalendar&quot;, (protofunc, target) =&gt; {</span>
<a href="#l4.43"></a><span id="l4.43">             // We need to run our function first, otherwise resetting the</span>
<a href="#l4.44"></a><span id="l4.44">             // pageorder will overwrite what the exchange provider does.</span>
<a href="#l4.45"></a><span id="l4.45">             selectProvider(target.value);</span>
<a href="#l4.46"></a><span id="l4.46">             let rv = protofunc(target);</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48">             // But then again, when switching to the gdata provider, the</span>
<a href="#l4.49"></a><span id="l4.49">             // exchange provider overwrites the uri we set.</span>
<a href="#l4.50"></a><span id="l4.50">             if (target.value == &quot;gdata&quot;) {</span>
<a href="#l4.51"></a><span id="l4.51">                 let curi = document.getElementById(&quot;calendar-uri&quot;);</span>
<a href="#l4.52"></a><span id="l4.52">                 curi.value = &quot;googleapi://unknown&quot;;</span>
<a href="#l4.53"></a><span id="l4.53">                 checkRequired();</span>
<a href="#l4.54"></a><span id="l4.54">             }</span>
<a href="#l4.55"></a><span id="l4.55">             return rv;</span>
<a href="#l4.56"></a><span id="l4.56">         });</span>
<a href="#l4.57"></a><span id="l4.57">     }</span>
<a href="#l4.58"></a><span id="l4.58"> </span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-    monkeyPatch(window, &quot;prepareCreateCalendar&quot;, function(protofunc) {</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-        let type = document.getElementById('calendar-format').selectedItem.value;</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+    monkeyPatch(window, &quot;prepareCreateCalendar&quot;, (protofunc) =&gt; {</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+        let type = document.getElementById(&quot;calendar-format&quot;).selectedItem.value;</span>
<a href="#l4.63"></a><span id="l4.63">         return (type == &quot;gdata&quot; ? true : protofunc());</span>
<a href="#l4.64"></a><span id="l4.64">     });</span>
<a href="#l4.65"></a><span id="l4.65"> </span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-    monkeyPatch(window, &quot;checkRequired&quot;, function(protofunc) {</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+    monkeyPatch(window, &quot;checkRequired&quot;, (protofunc) =&gt; {</span>
<a href="#l4.68"></a><span id="l4.68">         let wizard = document.documentElement;</span>
<a href="#l4.69"></a><span id="l4.69">         let currentPageId = wizard.currentPage &amp;&amp; wizard.currentPage.pageid;</span>
<a href="#l4.70"></a><span id="l4.70"> </span>
<a href="#l4.71"></a><span id="l4.71">         if (currentPageId == &quot;gdata-session&quot;) {</span>
<a href="#l4.72"></a><span id="l4.72">             let sessionGroup = document.getElementById(&quot;gdata-session-group&quot;);</span>
<a href="#l4.73"></a><span id="l4.73">             let sessionName = document.getElementById(&quot;gdata-session-name&quot;);</span>
<a href="#l4.74"></a><span id="l4.74">             let sessionNameIsValid = document.getAnonymousElementByAttribute(sessionName, &quot;anonid&quot;, &quot;input&quot;).validity.valid;</span>
<a href="#l4.75"></a><span id="l4.75">             // TODO for some reason the validity doesn't work on windows. Here is a hack:</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+            // eslint-disable-next-line no-useless-escape</span>
<a href="#l4.77"></a><span id="l4.77">             sessionNameIsValid = !!sessionName.value.match(/^[^\/]+@[^\/]+\.[^\/]+$/);</span>
<a href="#l4.78"></a><span id="l4.78">             wizard.canAdvance = sessionGroup.value || (sessionName.value &amp;&amp; sessionNameIsValid);</span>
<a href="#l4.79"></a><span id="l4.79">         } else if (currentPageId == &quot;gdata-calendars&quot;) {</span>
<a href="#l4.80"></a><span id="l4.80">             let calendarList = document.getElementById(&quot;calendar-list&quot;);</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-            let calendars = calendarList.selectedCalendars.filter(function(x) { return !x.getProperty(&quot;disabled&quot;) &amp;&amp; !x.readOnly; });</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+            let calendars = calendarList.selectedCalendars.filter(calendar =&gt; !calendar.getProperty(&quot;disabled&quot;) &amp;&amp; !calendar.readOnly);</span>
<a href="#l4.83"></a><span id="l4.83">             wizard.canAdvance = !!calendars.length;</span>
<a href="#l4.84"></a><span id="l4.84">         } else {</span>
<a href="#l4.85"></a><span id="l4.85">             protofunc();</span>
<a href="#l4.86"></a><span id="l4.86">         }</span>
<a href="#l4.87"></a><span id="l4.87">     });</span>
<a href="#l4.88"></a><span id="l4.88"> </span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-    this.gdataSessionShow = trycatch(function() {</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+    this.gdataSessionShow = trycatch(() =&gt; {</span>
<a href="#l4.91"></a><span id="l4.91">         let sessionMgr = getGoogleSessionManager();</span>
<a href="#l4.92"></a><span id="l4.92">         let sessionContainer = document.getElementById(&quot;gdata-session-group&quot;);</span>
<a href="#l4.93"></a><span id="l4.93">         let newSessionItem = document.getElementById(&quot;session-new&quot;);</span>
<a href="#l4.94"></a><span id="l4.94">         let calendars = cal.getCalendarManager().getCalendars({});</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-        let sessions = new Set(calendars.map(function(calendar) {</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-          return sessionMgr.getSessionByCalendar(calendar, true);</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+        let sessions = new Set(calendars.map((calendar) =&gt; {</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+            return sessionMgr.getSessionByCalendar(calendar, true);</span>
<a href="#l4.99"></a><span id="l4.99">         }));</span>
<a href="#l4.100"></a><span id="l4.100"> </span>
<a href="#l4.101"></a><span id="l4.101">         while (sessionContainer.firstChild.id != &quot;session-new&quot;) {</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-            sessionContainer.removeChild(sessionContainer.firstChild);</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+            sessionContainer.firstChild.remove();</span>
<a href="#l4.104"></a><span id="l4.104">         }</span>
<a href="#l4.105"></a><span id="l4.105"> </span>
<a href="#l4.106"></a><span id="l4.106">         // forEach is needed for backwards compatibility.</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-        sessions.forEach(function(session) {</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+        sessions.forEach((session) =&gt; {</span>
<a href="#l4.109"></a><span id="l4.109">             if (!session) {</span>
<a href="#l4.110"></a><span id="l4.110">                 return;</span>
<a href="#l4.111"></a><span id="l4.111">             }</span>
<a href="#l4.112"></a><span id="l4.112"> </span>
<a href="#l4.113"></a><span id="l4.113">             let radio = document.createElement(&quot;radio&quot;);</span>
<a href="#l4.114"></a><span id="l4.114">             radio.setAttribute(&quot;value&quot;, session.id);</span>
<a href="#l4.115"></a><span id="l4.115">             radio.setAttribute(&quot;label&quot;, session.id);</span>
<a href="#l4.116"></a><span id="l4.116">             sessionContainer.insertBefore(radio, newSessionItem);</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineat">@@ -139,58 +139,57 @@ ChromeUtils.import(&quot;resource://gdata-pro</span>
<a href="#l4.118"></a><span id="l4.118"> </span>
<a href="#l4.119"></a><span id="l4.119">         sessionContainer.value = sessionContainer.firstChild.value;</span>
<a href="#l4.120"></a><span id="l4.120">         if (sessionContainer.value == &quot;&quot;) {</span>
<a href="#l4.121"></a><span id="l4.121">             let sessionName = document.getElementById(&quot;gdata-session-name&quot;);</span>
<a href="#l4.122"></a><span id="l4.122">             sessionName.focus();</span>
<a href="#l4.123"></a><span id="l4.123">         }</span>
<a href="#l4.124"></a><span id="l4.124">     });</span>
<a href="#l4.125"></a><span id="l4.125"> </span>
<a href="#l4.126"></a><span id="l4.126" class="difflineminus">-    this.gdataCalendarsShow = trycatch(function() {</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+    this.gdataCalendarsShow = trycatch(() =&gt; {</span>
<a href="#l4.128"></a><span id="l4.128">         let calMgr = cal.getCalendarManager();</span>
<a href="#l4.129"></a><span id="l4.129">         let sessionMgr = getGoogleSessionManager();</span>
<a href="#l4.130"></a><span id="l4.130">         let sessionContainer = document.getElementById(&quot;gdata-session-group&quot;);</span>
<a href="#l4.131"></a><span id="l4.131">         let calendarListWidget = document.getElementById(&quot;calendar-list&quot;);</span>
<a href="#l4.132"></a><span id="l4.132">         calendarListWidget.clear();</span>
<a href="#l4.133"></a><span id="l4.133"> </span>
<a href="#l4.134"></a><span id="l4.134">         let session = sessionContainer.selectedItem.gdataSession;</span>
<a href="#l4.135"></a><span id="l4.135">         if (!session) {</span>
<a href="#l4.136"></a><span id="l4.136">             let newSessionItem = document.getElementById(&quot;gdata-session-name&quot;);</span>
<a href="#l4.137"></a><span id="l4.137">             session = sessionMgr.getSessionById(newSessionItem.value, true);</span>
<a href="#l4.138"></a><span id="l4.138">         }</span>
<a href="#l4.139"></a><span id="l4.139"> </span>
<a href="#l4.140"></a><span id="l4.140" class="difflineminus">-        Promise.all([session.getTasksList(), session.getCalendarList()])</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineminus">-               .then(function([tasksLists, calendarList]) {</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+        Promise.all([session.getTasksList(), session.getCalendarList()]).then(([tasksLists, calendarList]) =&gt; {</span>
<a href="#l4.143"></a><span id="l4.143">             let existing = new Set();</span>
<a href="#l4.144"></a><span id="l4.144">             let sessionPrefix = &quot;googleapi://&quot; + session.id;</span>
<a href="#l4.145"></a><span id="l4.145">             for (let calendar of calMgr.getCalendars({})) {</span>
<a href="#l4.146"></a><span id="l4.146">                 let spec = calendar.uri.spec;</span>
<a href="#l4.147"></a><span id="l4.147">                 if (calendar.type == &quot;gdata&quot; &amp;&amp; spec.substr(0, sessionPrefix.length) == sessionPrefix) {</span>
<a href="#l4.148"></a><span id="l4.148">                     let match;</span>
<a href="#l4.149"></a><span id="l4.149">                     if ((match = spec.match(/calendar=([^&amp;]*)/))) {</span>
<a href="#l4.150"></a><span id="l4.150">                         existing.add(decodeURIComponent(match[0]));</span>
<a href="#l4.151"></a><span id="l4.151">                     }</span>
<a href="#l4.152"></a><span id="l4.152">                     if ((match = spec.match(/tasks=([^&amp;]*)/))) {</span>
<a href="#l4.153"></a><span id="l4.153">                         existing.add(decodeURIComponent(match[0]));</span>
<a href="#l4.154"></a><span id="l4.154">                     }</span>
<a href="#l4.155"></a><span id="l4.155">                 }</span>
<a href="#l4.156"></a><span id="l4.156">             }</span>
<a href="#l4.157"></a><span id="l4.157"> </span>
<a href="#l4.158"></a><span id="l4.158" class="difflineminus">-            let taskcals = tasksLists.map(function(tasklist) {</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+            let taskcals = tasksLists.map((tasklist) =&gt; {</span>
<a href="#l4.160"></a><span id="l4.160">                 let uri = &quot;googleapi://&quot; + session.id + &quot;/?tasks=&quot; + encodeURIComponent(tasklist.id);</span>
<a href="#l4.161"></a><span id="l4.161">                 let calendar = calMgr.createCalendar(&quot;gdata&quot;, Services.io.newURI(uri));</span>
<a href="#l4.162"></a><span id="l4.162">                 calendar.id = cal.getUUID();</span>
<a href="#l4.163"></a><span id="l4.163">                 calendar.setProperty(&quot;color&quot;, cal.view.hashColor(tasklist.title));</span>
<a href="#l4.164"></a><span id="l4.164">                 calendar.name = tasklist.title;</span>
<a href="#l4.165"></a><span id="l4.165">                 if (existing.has(&quot;tasks=&quot; + tasklist.id)) {</span>
<a href="#l4.166"></a><span id="l4.166">                     calendar.readOnly = true;</span>
<a href="#l4.167"></a><span id="l4.167">                 }</span>
<a href="#l4.168"></a><span id="l4.168">                 return calendar;</span>
<a href="#l4.169"></a><span id="l4.169">             });</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineminus">-            let calcals = calendarList.map(function(calendarEntry) {</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+            let calcals = calendarList.map((calendarEntry) =&gt; {</span>
<a href="#l4.172"></a><span id="l4.172">                 let uri = &quot;googleapi://&quot; + session.id + &quot;/?calendar=&quot; + encodeURIComponent(calendarEntry.id);</span>
<a href="#l4.173"></a><span id="l4.173">                 let calendar = calMgr.createCalendar(&quot;gdata&quot;, Services.io.newURI(uri));</span>
<a href="#l4.174"></a><span id="l4.174">                 calendar.name = calendarEntry.summary;</span>
<a href="#l4.175"></a><span id="l4.175">                 calendar.id = cal.getUUID();</span>
<a href="#l4.176"></a><span id="l4.176">                 calendar.setProperty(&quot;color&quot;, calendarEntry.backgroundColor);</span>
<a href="#l4.177"></a><span id="l4.177">                 if (existing.has(&quot;calendar=&quot; + calendarEntry.id)) {</span>
<a href="#l4.178"></a><span id="l4.178">                     calendar.readOnly = true;</span>
<a href="#l4.179"></a><span id="l4.179">                 }</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineat">@@ -198,35 +197,35 @@ ChromeUtils.import(&quot;resource://gdata-pro</span>
<a href="#l4.181"></a><span id="l4.181">             });</span>
<a href="#l4.182"></a><span id="l4.182"> </span>
<a href="#l4.183"></a><span id="l4.183">             let calendars = [calendarListWidget.mockCalendarHeader]</span>
<a href="#l4.184"></a><span id="l4.184">                             .concat(calcals)</span>
<a href="#l4.185"></a><span id="l4.185">                             .concat([calendarListWidget.mockTaskHeader])</span>
<a href="#l4.186"></a><span id="l4.186">                             .concat(taskcals);</span>
<a href="#l4.187"></a><span id="l4.187"> </span>
<a href="#l4.188"></a><span id="l4.188">             calendarListWidget.calendars = calendars;</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineminus">-        }.bind(this), function(e) {</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+        }, (e) =&gt; {</span>
<a href="#l4.191"></a><span id="l4.191">             Components.utils.reportError(e);</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineminus">-        }.bind(this));</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+        });</span>
<a href="#l4.194"></a><span id="l4.194">     });</span>
<a href="#l4.195"></a><span id="l4.195"> </span>
<a href="#l4.196"></a><span id="l4.196" class="difflineminus">-    this.gdataCalendarsAdvance = trycatch(function() {</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+    this.gdataCalendarsAdvance = trycatch(() =&gt; {</span>
<a href="#l4.198"></a><span id="l4.198">         let calendarList = document.getElementById(&quot;calendar-list&quot;);</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-        let calendars = calendarList.selectedCalendars.filter(function(x) { return !x.getProperty(&quot;disabled&quot;) &amp;&amp; !x.readOnly; });</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+        let calendars = calendarList.selectedCalendars.filter(calendar =&gt; !calendar.getProperty(&quot;disabled&quot;) &amp;&amp; !calendar.readOnly);</span>
<a href="#l4.201"></a><span id="l4.201">         let calMgr = cal.getCalendarManager();</span>
<a href="#l4.202"></a><span id="l4.202">         calendars.forEach(calMgr.registerCalendar, calMgr);</span>
<a href="#l4.203"></a><span id="l4.203">         return true;</span>
<a href="#l4.204"></a><span id="l4.204">     });</span>
<a href="#l4.205"></a><span id="l4.205"> </span>
<a href="#l4.206"></a><span id="l4.206" class="difflineminus">-    this.gdataFocusNewSession = trycatch(function() {</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+    this.gdataFocusNewSession = trycatch(() =&gt; {</span>
<a href="#l4.208"></a><span id="l4.208">         let sessionContainer = document.getElementById(&quot;gdata-session-group&quot;);</span>
<a href="#l4.209"></a><span id="l4.209">         sessionContainer.value = &quot;&quot;;</span>
<a href="#l4.210"></a><span id="l4.210">     });</span>
<a href="#l4.211"></a><span id="l4.211"> </span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-    document.addEventListener(&quot;DOMContentLoaded&quot;, function() {</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+    document.addEventListener(&quot;DOMContentLoaded&quot;, () =&gt; {</span>
<a href="#l4.214"></a><span id="l4.214">         // Older versions of Lightning don't set the onselect attribute at all.</span>
<a href="#l4.215"></a><span id="l4.215">         let calendarFormat = document.getElementById(&quot;calendar-format&quot;);</span>
<a href="#l4.216"></a><span id="l4.216">         if (!calendarFormat.hasAttribute(&quot;onselect&quot;)) {</span>
<a href="#l4.217"></a><span id="l4.217">             calendarFormat.setAttribute(&quot;onselect&quot;, &quot;gdataSelectProvider(this.value)&quot;);</span>
<a href="#l4.218"></a><span id="l4.218">         }</span>
<a href="#l4.219"></a><span id="l4.219"> </span>
<a href="#l4.220"></a><span id="l4.220">         if (!(&quot;updateStyleSheetForViews&quot; in window)) {</span>
<a href="#l4.221"></a><span id="l4.221">             window.updateStyleSheetForViews = function() {};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-calendar-event-dialog.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-calendar-event-dialog.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -3,17 +3,16 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> ChromeUtils.import(&quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;);</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l5.9"></a><span id="l5.9"> ChromeUtils.import(&quot;resource://gdata-provider/modules/calUtilsShim.jsm&quot;);</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> (function() {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-</span>
<a href="#l5.13"></a><span id="l5.13">     // Older versions of Lightning don't have this variable.</span>
<a href="#l5.14"></a><span id="l5.14">     if (!(&quot;gOldEndTimezone&quot; in window)) {</span>
<a href="#l5.15"></a><span id="l5.15">         window.gOldEndTimezone = null;</span>
<a href="#l5.16"></a><span id="l5.16">     }</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18">     monkeyPatch(window, &quot;updateCalendar&quot;, function(protofunc, ...args) {</span>
<a href="#l5.19"></a><span id="l5.19">         let rv = protofunc.apply(this, args);</span>
<a href="#l5.20"></a><span id="l5.20">         let calendar = getCurrentCalendar();</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -78,17 +77,17 @@ ChromeUtils.import(&quot;resource://gdata-pro</span>
<a href="#l5.22"></a><span id="l5.22">         let duedate = document.getElementById(&quot;todo-duedate&quot;);</span>
<a href="#l5.23"></a><span id="l5.23">         let duetime = document.getAnonymousElementByAttribute(duedate, &quot;anonid&quot;, &quot;time-picker&quot;);</span>
<a href="#l5.24"></a><span id="l5.24">         duetime.style.display = isGoogleTask ? &quot;none&quot; : &quot;&quot;;</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26">         if (gEndTime) {</span>
<a href="#l5.27"></a><span id="l5.27">             if (isGoogleTask) {</span>
<a href="#l5.28"></a><span id="l5.28">                 let floating = cal.dtz.floating;</span>
<a href="#l5.29"></a><span id="l5.29">                 if (gEndTimezone != floating) {</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-                  gOldEndTimezone = gEndTimezone;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+                    gOldEndTimezone = gEndTimezone;</span>
<a href="#l5.32"></a><span id="l5.32">                 }</span>
<a href="#l5.33"></a><span id="l5.33">                 gEndTimezone = cal.dtz.floating;</span>
<a href="#l5.34"></a><span id="l5.34">                 gEndTime = gEndTime.getInTimezone(gEndTimezone);</span>
<a href="#l5.35"></a><span id="l5.35">                 gEndTime.isDate = true;</span>
<a href="#l5.36"></a><span id="l5.36">             } else {</span>
<a href="#l5.37"></a><span id="l5.37">                 if (gOldEndTimezone) {</span>
<a href="#l5.38"></a><span id="l5.38">                     gEndTimezone = gOldEndTimezone;</span>
<a href="#l5.39"></a><span id="l5.39">                 }</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineat">@@ -110,17 +109,19 @@ ChromeUtils.import(&quot;resource://gdata-pro</span>
<a href="#l5.41"></a><span id="l5.41">         }</span>
<a href="#l5.42"></a><span id="l5.42"> </span>
<a href="#l5.43"></a><span id="l5.43">         document.getElementById(&quot;gdata-reminder-default-menuitem&quot;).style.display = hasDefaultReminders ? &quot;&quot; : &quot;none&quot;;</span>
<a href="#l5.44"></a><span id="l5.44"> </span>
<a href="#l5.45"></a><span id="l5.45">         // Older versions of Lightning don't update the category menulist.</span>
<a href="#l5.46"></a><span id="l5.46">         if (!document.getElementById(&quot;item-categories-panel&quot;)) {</span>
<a href="#l5.47"></a><span id="l5.47">             let categoriesLabel = document.getElementById(&quot;event-grid-category-color-row&quot;).firstChild;</span>
<a href="#l5.48"></a><span id="l5.48">             let calendarLabel = document.getElementById(&quot;item-categories&quot;).nextSibling;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-            if (!categoriesLabel.origLabel) categoriesLabel.origLabel = categoriesLabel.value;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+            if (!categoriesLabel.origLabel) {</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+                categoriesLabel.origLabel = categoriesLabel.value;</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+            }</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54">             setBooleanAttribute(&quot;item-categories&quot;, &quot;hidden&quot;, isGoogleTask);</span>
<a href="#l5.55"></a><span id="l5.55">             setBooleanAttribute(calendarLabel, &quot;hidden&quot;, isGoogleTask);</span>
<a href="#l5.56"></a><span id="l5.56"> </span>
<a href="#l5.57"></a><span id="l5.57">             if (isGoogleTask) {</span>
<a href="#l5.58"></a><span id="l5.58">                 categoriesLabel.value = calendarLabel.value;</span>
<a href="#l5.59"></a><span id="l5.59">             } else {</span>
<a href="#l5.60"></a><span id="l5.60">                 categoriesLabel.value = categoriesLabel.origLabel;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineat">@@ -129,19 +130,19 @@ ChromeUtils.import(&quot;resource://gdata-pro</span>
<a href="#l5.62"></a><span id="l5.62">         return rv;</span>
<a href="#l5.63"></a><span id="l5.63">     });</span>
<a href="#l5.64"></a><span id="l5.64"> </span>
<a href="#l5.65"></a><span id="l5.65">     monkeyPatch(window, &quot;updateCategoryMenulist&quot;, function(protofunc, ...args) {</span>
<a href="#l5.66"></a><span id="l5.66">         let rv;</span>
<a href="#l5.67"></a><span id="l5.67">         let calendar = getCurrentCalendar();</span>
<a href="#l5.68"></a><span id="l5.68">         if (calendar.type == &quot;gdata&quot; &amp;&amp; cal.item.isToDo(window.calendarItem)) {</span>
<a href="#l5.69"></a><span id="l5.69">             let unwrappedCal = calendar.getProperty(&quot;cache.uncachedCalendar&quot;).wrappedJSObject;</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-            unwrappedCal.mProperties['capabilities.categories.maxCount'] = 0;</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+            unwrappedCal.mProperties[&quot;capabilities.categories.maxCount&quot;] = 0;</span>
<a href="#l5.72"></a><span id="l5.72">             rv = protofunc.apply(this, args);</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-            delete unwrappedCal.mProperties['capabilities.categories.maxCount'];</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+            delete unwrappedCal.mProperties[&quot;capabilities.categories.maxCount&quot;];</span>
<a href="#l5.75"></a><span id="l5.75">         } else {</span>
<a href="#l5.76"></a><span id="l5.76">             rv = protofunc.apply(this, args);</span>
<a href="#l5.77"></a><span id="l5.77">         }</span>
<a href="#l5.78"></a><span id="l5.78">         return rv;</span>
<a href="#l5.79"></a><span id="l5.79">     });</span>
<a href="#l5.80"></a><span id="l5.80"> </span>
<a href="#l5.81"></a><span id="l5.81">     monkeyPatch(window, &quot;updateReminderDetails&quot;, function(protofunc, ...args) {</span>
<a href="#l5.82"></a><span id="l5.82">         let rv = protofunc.apply(this, args);</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineat">@@ -166,32 +167,32 @@ ChromeUtils.import(&quot;resource://gdata-pro</span>
<a href="#l5.84"></a><span id="l5.84">             if (!defaultReminders.length) {</span>
<a href="#l5.85"></a><span id="l5.85">                 item.setProperty(&quot;X-DEFAULT-ALARM&quot;, &quot;TRUE&quot;);</span>
<a href="#l5.86"></a><span id="l5.86">             }</span>
<a href="#l5.87"></a><span id="l5.87">             return null;</span>
<a href="#l5.88"></a><span id="l5.88">         } else {</span>
<a href="#l5.89"></a><span id="l5.89">             item.deleteProperty(&quot;X-DEFAULT-ALARM&quot;);</span>
<a href="#l5.90"></a><span id="l5.90">             return protofunc.apply(this, args);</span>
<a href="#l5.91"></a><span id="l5.91">         }</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-    })</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+    });</span>
<a href="#l5.94"></a><span id="l5.94"> </span>
<a href="#l5.95"></a><span id="l5.95">     monkeyPatch(window, &quot;loadReminders&quot;, function(protofunc, reminders, ...args) {</span>
<a href="#l5.96"></a><span id="l5.96">         let reminderList = document.getElementById(&quot;item-alarm&quot;);</span>
<a href="#l5.97"></a><span id="l5.97"> </span>
<a href="#l5.98"></a><span id="l5.98">         // Set up the default reminders item</span>
<a href="#l5.99"></a><span id="l5.99">         let defaultItem = document.getElementById(&quot;gdata-reminder-default-menuitem&quot;);</span>
<a href="#l5.100"></a><span id="l5.100">         let calendar = getCurrentCalendar().getProperty(&quot;cache.uncachedCalendar&quot;);</span>
<a href="#l5.101"></a><span id="l5.101">         let unwrappedCal = calendar &amp;&amp; calendar.wrappedJSObject;</span>
<a href="#l5.102"></a><span id="l5.102">         let defaultReminders = unwrappedCal.defaultReminders ? unwrappedCal.defaultReminders.concat([]) : [];</span>
<a href="#l5.103"></a><span id="l5.103">         defaultItem.reminders = defaultReminders;</span>
<a href="#l5.104"></a><span id="l5.104"> </span>
<a href="#l5.105"></a><span id="l5.105">         let rv = null;</span>
<a href="#l5.106"></a><span id="l5.106">         let usesDefault;</span>
<a href="#l5.107"></a><span id="l5.107">         if (reminders.length) {</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-            usesDefault = reminders.every(function(x) { return x.hasProperty(&quot;X-DEFAULT-ALARM&quot;); });</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+            usesDefault = reminders.every(reminder =&gt; reminder.hasProperty(&quot;X-DEFAULT-ALARM&quot;));</span>
<a href="#l5.110"></a><span id="l5.110">         } else {</span>
<a href="#l5.111"></a><span id="l5.111">             usesDefault = window.calendarItem.getProperty(&quot;X-DEFAULT-ALARM&quot;) == &quot;TRUE&quot;;</span>
<a href="#l5.112"></a><span id="l5.112">         }</span>
<a href="#l5.113"></a><span id="l5.113"> </span>
<a href="#l5.114"></a><span id="l5.114">         if (calendar.type == &quot;gdata&quot; &amp;&amp; (window.mode == &quot;new&quot; || usesDefault)) {</span>
<a href="#l5.115"></a><span id="l5.115">             // If all reminders are default reminders, then select the menuitem.</span>
<a href="#l5.116"></a><span id="l5.116">             reminderList.value = &quot;default&quot;;</span>
<a href="#l5.117"></a><span id="l5.117"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-calendar-properties.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-calendar-properties.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -12,20 +12,20 @@</span>
<a href="#l6.4"></a><span id="l6.4">             let isEventsCalendar = gCalendar.getProperty(&quot;capabilities.events.supported&quot;);</span>
<a href="#l6.5"></a><span id="l6.5">             let isDisabled = gCalendar.getProperty(&quot;disabled&quot;);</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7">             // Disable setting read-only if the calendar is readonly anyway</span>
<a href="#l6.8"></a><span id="l6.8">             document.getElementById(&quot;read-only&quot;).disabled = isDisabled || (isEventsCalendar &amp;&amp; isReader);</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10">             // Don't allow setting refresh interval to less than 30 minutes</span>
<a href="#l6.11"></a><span id="l6.11">             let refInterval = document.getElementById(&quot;calendar-refreshInterval-menupopup&quot;);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-            Array.from(refInterval.childNodes).filter(function(n) {</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-                let nv = parseInt(n.getAttribute(&quot;value&quot;), 10);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-                return nv &lt; 30 &amp;&amp; nv != 0;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-            }).forEach(function(n) { refInterval.removeChild(n); });</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+            Array.from(refInterval.childNodes).filter((node) =&gt; {</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+                let nodeval = parseInt(node.getAttribute(&quot;value&quot;), 10);</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+                return nodeval &lt; 30 &amp;&amp; nodeval != 0;</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+            }).forEach((node) =&gt; { refInterval.removeChild(node); });</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21">             // Old Lightning doesn't hide the cache label</span>
<a href="#l6.22"></a><span id="l6.22">             let oldCacheLabel = document.getElementById(&quot;cache&quot;);</span>
<a href="#l6.23"></a><span id="l6.23">             if (oldCacheLabel) {</span>
<a href="#l6.24"></a><span id="l6.24">                 oldCacheLabel.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l6.25"></a><span id="l6.25">             }</span>
<a href="#l6.26"></a><span id="l6.26">         }</span>
<a href="#l6.27"></a><span id="l6.27">         return rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-event-dialog-reminder.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-event-dialog-reminder.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -14,18 +14,18 @@</span>
<a href="#l7.4"></a><span id="l7.4">     }</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6">     let label = getProviderString(&quot;reminderOutOfRange&quot;);</span>
<a href="#l7.7"></a><span id="l7.7">     let notification = createXULElement(&quot;notification&quot;);</span>
<a href="#l7.8"></a><span id="l7.8">     notification.setAttribute(&quot;label&quot;, label);</span>
<a href="#l7.9"></a><span id="l7.9">     notification.setAttribute(&quot;type&quot;, &quot;critical&quot;);</span>
<a href="#l7.10"></a><span id="l7.10">     notification.setAttribute(&quot;hideclose&quot;, &quot;true&quot;);</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    function calculateAlarmOffset(item, reminder) {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-        let offset = cal.alarms.calculateAlarmOffset(item, reminder);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+    function calculateAlarmOffset(alarmitem, reminder) {</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+        let offset = cal.alarms.calculateAlarmOffset(alarmitem, reminder);</span>
<a href="#l7.16"></a><span id="l7.16">         // bug 1196455: The offset calcuated for absolute alarms is flipped</span>
<a href="#l7.17"></a><span id="l7.17">         if (Services.vc.compare(Services.appinfo.platformVersion, &quot;43.0&quot;) &lt; 0) {</span>
<a href="#l7.18"></a><span id="l7.18">             if (reminder.related == reminder.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l7.19"></a><span id="l7.19">                 offset.isNegative = !offset.isNegative;</span>
<a href="#l7.20"></a><span id="l7.20">             }</span>
<a href="#l7.21"></a><span id="l7.21">         }</span>
<a href="#l7.22"></a><span id="l7.22">         return offset;</span>
<a href="#l7.23"></a><span id="l7.23">     }</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineat">@@ -82,23 +82,23 @@</span>
<a href="#l7.25"></a><span id="l7.25">     }</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27">     monkeyPatch(window, &quot;updateReminder&quot;, function(protofunc, event) {</span>
<a href="#l7.28"></a><span id="l7.28">         let rv = protofunc.apply(this, Array.from(arguments).slice(1));</span>
<a href="#l7.29"></a><span id="l7.29">         if (event.explicitOriginalTarget.localName == &quot;listitem&quot; ||</span>
<a href="#l7.30"></a><span id="l7.30">             event.explicitOriginalTarget.id == &quot;reminder-remove-button&quot; ||</span>
<a href="#l7.31"></a><span id="l7.31">             !document.commandDispatcher.focusedElement) {</span>
<a href="#l7.32"></a><span id="l7.32">             // Same hack from the original dialog</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-            return;</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+            return undefined;</span>
<a href="#l7.35"></a><span id="l7.35">         }</span>
<a href="#l7.36"></a><span id="l7.36"> </span>
<a href="#l7.37"></a><span id="l7.37">         checkAllReminders();</span>
<a href="#l7.38"></a><span id="l7.38">         return rv;</span>
<a href="#l7.39"></a><span id="l7.39">     });</span>
<a href="#l7.40"></a><span id="l7.40"> </span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-    monkeyPatch(window, &quot;loadReminders&quot;, function(protofunc /*, ...args */) {</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-        let rv = protofunc.apply(this, Array.from(arguments).slice(1));</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+    monkeyPatch(window, &quot;loadReminders&quot;, function(protofunc, ...args) {</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+        let rv = protofunc.apply(this, args);</span>
<a href="#l7.45"></a><span id="l7.45">         checkAllReminders();</span>
<a href="#l7.46"></a><span id="l7.46">         hideReminderRelations();</span>
<a href="#l7.47"></a><span id="l7.47">         hideSMSReminders();</span>
<a href="#l7.48"></a><span id="l7.48">         return rv;</span>
<a href="#l7.49"></a><span id="l7.49">     });</span>
<a href="#l7.50"></a><span id="l7.50"> })();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-list-tree.xml</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-list-tree.xml</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -59,180 +59,180 @@</span>
<a href="#l8.4"></a><span id="l8.4">                           onunderflow=&quot;displayScrollbarSpacer(false)&quot;&gt;</span>
<a href="#l8.5"></a><span id="l8.5">           &lt;children includes=&quot;tooltip|menupopup&quot;/&gt;</span>
<a href="#l8.6"></a><span id="l8.6">         &lt;/xul:treechildren&gt;</span>
<a href="#l8.7"></a><span id="l8.7">       &lt;/xul:tree&gt;</span>
<a href="#l8.8"></a><span id="l8.8">     &lt;/content&gt;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10">     &lt;implementation&gt;</span>
<a href="#l8.11"></a><span id="l8.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-        this.tree.view = this;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+          this.tree.view = this;</span>
<a href="#l8.14"></a><span id="l8.14">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16">       &lt;property name=&quot;mockCalendarHeader&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l8.17"></a><span id="l8.17">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-          let calmgr = cal.getCalendarManager();</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-          let uri = &quot;dummy://calendar&quot;;</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-          let mem = calmgr.createCalendar(&quot;memory&quot;, Services.io.newURI(uri));</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-          mem.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-          mem.name = &quot;Calendars&quot;;</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-          mem.id = cal.getUUID();</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-          return mem;</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+            let calmgr = cal.getCalendarManager();</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+            let uri = &quot;dummy://calendar&quot;;</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+            let mem = calmgr.createCalendar(&quot;memory&quot;, Services.io.newURI(uri));</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+            mem.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+            mem.name = &quot;Calendars&quot;;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+            mem.id = cal.getUUID();</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+            return mem;</span>
<a href="#l8.32"></a><span id="l8.32">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l8.33"></a><span id="l8.33">       &lt;/property&gt;</span>
<a href="#l8.34"></a><span id="l8.34"> </span>
<a href="#l8.35"></a><span id="l8.35">       &lt;property name=&quot;mockTaskHeader&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l8.36"></a><span id="l8.36">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-          let calmgr = cal.getCalendarManager();</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-          let uri = &quot;dummy://tasks&quot;;</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-          let mem = calmgr.createCalendar(&quot;memory&quot;, Services.io.newURI(uri));</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-          mem.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-          mem.name = &quot;Task Lists&quot;;</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-          mem.id = cal.getUUID();</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-          return mem;</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+            let calmgr = cal.getCalendarManager();</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+            let uri = &quot;dummy://tasks&quot;;</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+            let mem = calmgr.createCalendar(&quot;memory&quot;, Services.io.newURI(uri));</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+            mem.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+            mem.name = &quot;Task Lists&quot;;</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+            mem.id = cal.getUUID();</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+            return mem;</span>
<a href="#l8.51"></a><span id="l8.51">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l8.52"></a><span id="l8.52">       &lt;/property&gt;</span>
<a href="#l8.53"></a><span id="l8.53"> </span>
<a href="#l8.54"></a><span id="l8.54">       &lt;field name=&quot;mCalendarHeaderIndex&quot;&gt;0&lt;/field&gt;</span>
<a href="#l8.55"></a><span id="l8.55">       &lt;field name=&quot;mTasksHeaderIndex&quot;&gt;0&lt;/field&gt;</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57">       &lt;field name=&quot;QueryInterface&quot;&gt;XPCOMUtils.generateQI([Components.interfaces.nsITreeView])&lt;/field&gt;</span>
<a href="#l8.58"></a><span id="l8.58"> </span>
<a href="#l8.59"></a><span id="l8.59">       &lt;property name=&quot;calendars&quot;&gt;</span>
<a href="#l8.60"></a><span id="l8.60">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-          return this.mCalendarList;</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+            return this.mCalendarList;</span>
<a href="#l8.63"></a><span id="l8.63">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l8.64"></a><span id="l8.64">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-          for (let i = 0; i &lt; val.length; i++) {</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-              let calendar = val[i];</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-              let spec = calendar.uri.spec;</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-              if (calendar.type == &quot;memory&quot;) {</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-                  if (spec == &quot;dummy://calendar&quot;) {</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-                      this.mCalendarHeaderIndex = i;</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-                  } else if (spec == &quot;dummy://tasks&quot;) {</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-                      this.mTasksHeaderIndex = i;</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-                  }</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-              }</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-              this.addCalendar(calendar);</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-          }</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-          return this.mCalendarList;</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+            for (let i = 0; i &lt; val.length; i++) {</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+                let calendar = val[i];</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+                let spec = calendar.uri.spec;</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+                if (calendar.type == &quot;memory&quot;) {</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+                    if (spec == &quot;dummy://calendar&quot;) {</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+                        this.mCalendarHeaderIndex = i;</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+                    } else if (spec == &quot;dummy://tasks&quot;) {</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+                        this.mTasksHeaderIndex = i;</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+                    }</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+                }</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+                this.addCalendar(calendar);</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+            }</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+            return this.mCalendarList;</span>
<a href="#l8.91"></a><span id="l8.91">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l8.92"></a><span id="l8.92">       &lt;/property&gt;</span>
<a href="#l8.93"></a><span id="l8.93"> </span>
<a href="#l8.94"></a><span id="l8.94">       &lt;method name=&quot;removeCalendar&quot;&gt;</span>
<a href="#l8.95"></a><span id="l8.95">         &lt;parameter name=&quot;aCalendar&quot;/&gt;</span>
<a href="#l8.96"></a><span id="l8.96">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-          let index = this.findIndexById(aCalendar.id);</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-          if (index &lt; this.mCalendarHeaderIndex) {</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-            this.mCalendarHeaderIndex--;</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-          }</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-          if (index &lt; this.mTasksHeaderIndex) {</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-            this.mTasksHeaderIndex--;</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-          }</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-          return this.__proto__.__proto__.removeCalendar.call(this, aCalendar);</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+            let index = this.findIndexById(aCalendar.id);</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+            if (index &lt; this.mCalendarHeaderIndex) {</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+                this.mCalendarHeaderIndex--;</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+            }</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+            if (index &lt; this.mTasksHeaderIndex) {</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+                this.mTasksHeaderIndex--;</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+            }</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+            return this.__proto__.__proto__.removeCalendar.call(this, aCalendar);</span>
<a href="#l8.113"></a><span id="l8.113">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.114"></a><span id="l8.114">       &lt;/method&gt;</span>
<a href="#l8.115"></a><span id="l8.115"> </span>
<a href="#l8.116"></a><span id="l8.116">       &lt;method name=&quot;clear&quot;&gt;</span>
<a href="#l8.117"></a><span id="l8.117">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-          let calendars = this.mCalendarList.concat([]);</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-          calendars.forEach(this.removeCalendar, this);</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+            let calendars = this.mCalendarList.concat([]);</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+            calendars.forEach(this.removeCalendar, this);</span>
<a href="#l8.122"></a><span id="l8.122">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.123"></a><span id="l8.123">       &lt;/method&gt;</span>
<a href="#l8.124"></a><span id="l8.124"> </span>
<a href="#l8.125"></a><span id="l8.125">       &lt;method name=&quot;getRowProperties&quot;&gt;</span>
<a href="#l8.126"></a><span id="l8.126">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l8.127"></a><span id="l8.127">         &lt;parameter name=&quot;aProps&quot;/&gt;</span>
<a href="#l8.128"></a><span id="l8.128">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-          let props = this.__proto__.__proto__.getRowProperties.call(this, aRow, aProps);</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-          let calendar = this.getCalendar(aRow);</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+            let props = this.__proto__.__proto__.getRowProperties.call(this, aRow, aProps);</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+            let calendar = this.getCalendar(aRow);</span>
<a href="#l8.133"></a><span id="l8.133"> </span>
<a href="#l8.134"></a><span id="l8.134" class="difflineminus">-          if (calendar.readOnly) {</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-              if (aProps) {</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">-                  // Compatibility with old tree props code</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-                  aProps.AppendElement(cal.getAtomFromService(&quot;checked&quot;));</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-              } else {</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-                  props += &quot; checked&quot;;</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">-              }</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineminus">-          }</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+            if (calendar.readOnly) {</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+                if (aProps) {</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+                    // Compatibility with old tree props code</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+                    aProps.AppendElement(cal.getAtomFromService(&quot;checked&quot;));</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+                } else {</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+                    props += &quot; checked&quot;;</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+                }</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+            }</span>
<a href="#l8.150"></a><span id="l8.150"> </span>
<a href="#l8.151"></a><span id="l8.151" class="difflineminus">-          return props;</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+            return props;</span>
<a href="#l8.153"></a><span id="l8.153">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.154"></a><span id="l8.154">       &lt;/method&gt;</span>
<a href="#l8.155"></a><span id="l8.155"> </span>
<a href="#l8.156"></a><span id="l8.156">       &lt;method name=&quot;isContainerEmpty&quot;&gt;</span>
<a href="#l8.157"></a><span id="l8.157">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l8.158"></a><span id="l8.158">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-          return (aRow == this.mCalendarHeaderIndex &amp;&amp;</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-                  aRow + 1 == this.mTasksHeaderIndex) ||</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-                 (aRow == this.mTasksHeaderIndex &amp;&amp;</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-                  aRow == this.mCalendarList.length);</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+            return (aRow == this.mCalendarHeaderIndex &amp;&amp;</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+                    aRow + 1 == this.mTasksHeaderIndex) ||</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+                   (aRow == this.mTasksHeaderIndex &amp;&amp;</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+                    aRow == this.mCalendarList.length);</span>
<a href="#l8.167"></a><span id="l8.167">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.168"></a><span id="l8.168">       &lt;/method&gt;</span>
<a href="#l8.169"></a><span id="l8.169"> </span>
<a href="#l8.170"></a><span id="l8.170">       &lt;method name=&quot;isContainer&quot;&gt;</span>
<a href="#l8.171"></a><span id="l8.171">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l8.172"></a><span id="l8.172">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-          let calendar = this.getCalendar(aRow);</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineminus">-          return (calendar.type == &quot;memory&quot; &amp;&amp; calendar.uri.schemeIs(&quot;dummy&quot;));</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+            let calendar = this.getCalendar(aRow);</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+            return (calendar.type == &quot;memory&quot; &amp;&amp; calendar.uri.schemeIs(&quot;dummy&quot;));</span>
<a href="#l8.177"></a><span id="l8.177">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.178"></a><span id="l8.178">       &lt;/method&gt;</span>
<a href="#l8.179"></a><span id="l8.179"> </span>
<a href="#l8.180"></a><span id="l8.180">       &lt;method name=&quot;isContainerOpen&quot;&gt;</span>
<a href="#l8.181"></a><span id="l8.181">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l8.182"></a><span id="l8.182">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineminus">-          return true;</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+            return true;</span>
<a href="#l8.185"></a><span id="l8.185">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.186"></a><span id="l8.186">       &lt;/method&gt;</span>
<a href="#l8.187"></a><span id="l8.187"> </span>
<a href="#l8.188"></a><span id="l8.188">       &lt;method name=&quot;getParentIndex&quot;&gt;</span>
<a href="#l8.189"></a><span id="l8.189">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l8.190"></a><span id="l8.190">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineminus">-          let calendar = this.getCalendar(aRow);</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineminus">-          if (calendar.uri.path.includes(&quot;?calendar&quot;)) {</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineminus">-              return this.mCalendarHeaderIndex;</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-          } else if (calendar.uri.path.includes(&quot;?tasks&quot;)) {</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-              return this.mTasksHeaderIndex;</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineminus">-          } else {</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineminus">-              return -1;</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineminus">-          }</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+            let calendar = this.getCalendar(aRow);</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+            if (calendar.uri.path.includes(&quot;?calendar&quot;)) {</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+                return this.mCalendarHeaderIndex;</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+            } else if (calendar.uri.path.includes(&quot;?tasks&quot;)) {</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+                return this.mTasksHeaderIndex;</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+            } else {</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+                return -1;</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+            }</span>
<a href="#l8.207"></a><span id="l8.207">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.208"></a><span id="l8.208">       &lt;/method&gt;</span>
<a href="#l8.209"></a><span id="l8.209"> </span>
<a href="#l8.210"></a><span id="l8.210">       &lt;method name=&quot;hasNextSibling&quot;&gt;</span>
<a href="#l8.211"></a><span id="l8.211">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l8.212"></a><span id="l8.212">         &lt;parameter name=&quot;aAfterIndex&quot;/&gt;</span>
<a href="#l8.213"></a><span id="l8.213">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineminus">-          if (aRow == this.mCalendarHeaderIndex) {</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineminus">-              return aAfterIndex &lt; this.mTasksHeaderIndex;</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineminus">-          } else if (aRow == this.mTasksHeaderIndex) {</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineminus">-              return false;</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineminus">-          } else {</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineminus">-              return aAfterIndex != this.mCalendarHeaderIndex - 1 &amp;&amp;</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-                     aAfterIndex != this.mTasksHeaderIndex - 1;</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineminus">-          }</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+            if (aRow == this.mCalendarHeaderIndex) {</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+                return aAfterIndex &lt; this.mTasksHeaderIndex;</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineplus">+            } else if (aRow == this.mTasksHeaderIndex) {</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+                return false;</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+            } else {</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+                return aAfterIndex != this.mCalendarHeaderIndex - 1 &amp;&amp;</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+                       aAfterIndex != this.mTasksHeaderIndex - 1;</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+            }</span>
<a href="#l8.230"></a><span id="l8.230">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.231"></a><span id="l8.231">       &lt;/method&gt;</span>
<a href="#l8.232"></a><span id="l8.232"> </span>
<a href="#l8.233"></a><span id="l8.233">       &lt;method name=&quot;cycleCell&quot;&gt;</span>
<a href="#l8.234"></a><span id="l8.234">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l8.235"></a><span id="l8.235">         &lt;parameter name=&quot;aCol&quot;/&gt;</span>
<a href="#l8.236"></a><span id="l8.236">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineminus">-          let calendar = this.getCalendar(aRow);</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineminus">-          let composite = this.compositeCalendar;</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineminus">-          if (composite.getCalendarById(calendar.id)) {</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineminus">-              composite.removeCalendar(calendar);</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineminus">-          } else {</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineminus">-              composite.addCalendar(calendar);</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineminus">-          }</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineminus">-          this.treebox.invalidateRow(aRow);</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+            let calendar = this.getCalendar(aRow);</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+            let composite = this.compositeCalendar;</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineplus">+            if (composite.getCalendarById(calendar.id)) {</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineplus">+                composite.removeCalendar(calendar);</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+            } else {</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+                composite.addCalendar(calendar);</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+            }</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+            this.treebox.invalidateRow(aRow);</span>
<a href="#l8.253"></a><span id="l8.253">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.254"></a><span id="l8.254">       &lt;/method&gt;</span>
<a href="#l8.255"></a><span id="l8.255"> </span>
<a href="#l8.256"></a><span id="l8.256">       &lt;method name=&quot;getLevel&quot;&gt;</span>
<a href="#l8.257"></a><span id="l8.257">         &lt;parameter name=&quot;aRow&quot;/&gt;</span>
<a href="#l8.258"></a><span id="l8.258">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineminus">-          return this.isContainer(aRow) ? 0 : 1;</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+            return this.isContainer(aRow) ? 0 : 1;</span>
<a href="#l8.261"></a><span id="l8.261">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.262"></a><span id="l8.262">       &lt;/method&gt;</span>
<a href="#l8.263"></a><span id="l8.263">     &lt;/implementation&gt;</span>
<a href="#l8.264"></a><span id="l8.264">   &lt;/binding&gt;</span>
<a href="#l8.265"></a><span id="l8.265"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-migration.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-migration.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,15 +1,17 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.5"></a><span id="l9.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.6"></a><span id="l9.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l9.9"></a><span id="l9.9"> ChromeUtils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+/* exported migrateSelectedCalendars */</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+</span>
<a href="#l9.13"></a><span id="l9.13"> /**</span>
<a href="#l9.14"></a><span id="l9.14">  * Migrate the calendar selected in the wizard from ics to gdata.</span>
<a href="#l9.15"></a><span id="l9.15">  */</span>
<a href="#l9.16"></a><span id="l9.16"> function migrateSelectedCalendars() {</span>
<a href="#l9.17"></a><span id="l9.17">     let listbox = document.getElementById(&quot;calendars-listbox&quot;);</span>
<a href="#l9.18"></a><span id="l9.18">     let calmgr = cal.getCalendarManager();</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20">     for (let i = 0; i &lt; listbox.childNodes.length; i++) {</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineat">@@ -50,22 +52,22 @@ function migrateSelectedCalendars() {</span>
<a href="#l9.22"></a><span id="l9.22"> }</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24"> /**</span>
<a href="#l9.25"></a><span id="l9.25">  * Get all calendars that are ics and point to a google calendar</span>
<a href="#l9.26"></a><span id="l9.26">  *</span>
<a href="#l9.27"></a><span id="l9.27">  * @return An array of calendars that are migratable</span>
<a href="#l9.28"></a><span id="l9.28">  */</span>
<a href="#l9.29"></a><span id="l9.29"> function getMigratableCalendars() {</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-    function isMigratable(c) {</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+    function isMigratable(calendar) {</span>
<a href="#l9.32"></a><span id="l9.32">         let re = new RegExp(&quot;^http[s]?://www\\.google\\.com/calendar/ical/&quot; +</span>
<a href="#l9.33"></a><span id="l9.33">                             &quot;[^/]+/(private(-[^/]+)?|public)/&quot; +</span>
<a href="#l9.34"></a><span id="l9.34">                             &quot;(full|full-noattendees|composite|&quot; +</span>
<a href="#l9.35"></a><span id="l9.35">                             &quot;attendees-only|free-busy|basic)(\\.ics)?$&quot;);</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-        return c.type == &quot;ics&quot; &amp;&amp; c.uri.spec.match(re);</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+        return calendar.type == &quot;ics&quot; &amp;&amp; calendar.uri.spec.match(re);</span>
<a href="#l9.38"></a><span id="l9.38">     }</span>
<a href="#l9.39"></a><span id="l9.39"> </span>
<a href="#l9.40"></a><span id="l9.40">     return cal.getCalendarManager().getCalendars({}).filter(isMigratable);</span>
<a href="#l9.41"></a><span id="l9.41"> }</span>
<a href="#l9.42"></a><span id="l9.42"> </span>
<a href="#l9.43"></a><span id="l9.43"> /**</span>
<a href="#l9.44"></a><span id="l9.44">  * Load Handler for both the wizard and the Thunderbird main window.</span>
<a href="#l9.45"></a><span id="l9.45">  */</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineat">@@ -78,33 +80,30 @@ function gdata_migration_loader() {</span>
<a href="#l9.47"></a><span id="l9.47">             let item = listbox.appendItem(calendar.name, calendar.id);</span>
<a href="#l9.48"></a><span id="l9.48">             item.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span>
<a href="#l9.49"></a><span id="l9.49">             item.calendar = calendar;</span>
<a href="#l9.50"></a><span id="l9.50">         }</span>
<a href="#l9.51"></a><span id="l9.51"> </span>
<a href="#l9.52"></a><span id="l9.52">         // Set up the &quot;always check&quot; field</span>
<a href="#l9.53"></a><span id="l9.53">         document.getElementById(&quot;showagain-checkbox&quot;).checked =</span>
<a href="#l9.54"></a><span id="l9.54">             Preferences.get(&quot;calendar.google.migrate&quot;, true);</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-    } else {</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+    } else if (Preferences.get(&quot;calendar.google.migrate&quot;, true) &amp;&amp;</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+               getMigratableCalendars().length &gt; 0) {</span>
<a href="#l9.58"></a><span id="l9.58">         // This is not the migration wizard, so it must be a main window. Check</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-        // if the migration wizard needs to be shown.</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-        if (Preferences.get(&quot;calendar.google.migrate&quot;, true)) {</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-            // Check if there are calendars that are worth migrating.</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-            if (getMigratableCalendars().length &gt; 0) {</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-                // Do this after load, so the calendar window appears before the</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-                // wizard is opened.</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+        // if the migration wizard needs to be shown and calendars are worth</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+        // migrating.</span>
<a href="#l9.67"></a><span id="l9.67"> </span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-                // XXX Waiting a second gives the views enough time to display</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-                // right, at least on my system. The viewloaded event is quite</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-                // view specific, so there is no good non-hacked way to do this.</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-                setTimeout(function() {</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-                    window.openDialog(&quot;chrome://gdata-provider/content/gdata-migration-wizard.xul&quot;,</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-                                      &quot;GdataMigrationWizard&quot;,</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-                                      &quot;chrome,titlebar,modal,alwaysRaised&quot;);</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-                }, 1000);</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-            }</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-        }</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+        // Do this after load, so the calendar window appears before the</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+        // wizard is opened.</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+        // XXX Waiting a second gives the views enough time to display</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+        // right, at least on my system. The viewloaded event is quite</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+        // view specific, so there is no good non-hacked way to do this.</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+        setTimeout(() =&gt; {</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+            window.openDialog(&quot;chrome://gdata-provider/content/gdata-migration-wizard.xul&quot;,</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+                              &quot;GdataMigrationWizard&quot;,</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+                              &quot;chrome,titlebar,modal,alwaysRaised&quot;);</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+        }, 1000);</span>
<a href="#l9.88"></a><span id="l9.88">     }</span>
<a href="#l9.89"></a><span id="l9.89"> }</span>
<a href="#l9.90"></a><span id="l9.90"> </span>
<a href="#l9.91"></a><span id="l9.91"> // Add a Load handler to check for migratable calendars in the main window, or</span>
<a href="#l9.92"></a><span id="l9.92"> // to load the migration wizard if this is the migration wizard</span>
<a href="#l9.93"></a><span id="l9.93"> window.addEventListener(&quot;load&quot;, gdata_migration_loader, { capture: false, once: true });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/providers/gdata/modules/OAuth2.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/OAuth2.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,31 +1,29 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.5"></a><span id="l10.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l10.6"></a><span id="l10.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> /**</span>
<a href="#l10.9"></a><span id="l10.9">  * Provides OAuth 2.0 authentication</span>
<a href="#l10.10"></a><span id="l10.10">  */</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;OAuth2&quot;];</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-var {classes: Cc, interfaces: Ci, results: Cr, utils: Cu} = Components;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;OAuth2&quot;]; /* exported OAuth2 */</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.17"></a><span id="l10.17"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l10.18"></a><span id="l10.18"> ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l10.19"></a><span id="l10.19"> ChromeUtils.import(&quot;resource://gre/modules/Http.jsm&quot;);</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21"> function parseURLData(aData) {</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-  let result = {};</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-  aData.split(/[?#]/, 2)[1].split(&quot;&amp;&quot;).forEach(function (aParam) {</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-    let [key, value] = aParam.split(&quot;=&quot;);</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-    result[key] = value;</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-  });</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-  return result;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+    let result = {};</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+    aData.split(/[?#]/, 2)[1].split(&quot;&amp;&quot;).forEach((aParam) =&gt; {</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+        let [key, value] = aParam.split(&quot;=&quot;);</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+        result[key] = value;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+    });</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+    return result;</span>
<a href="#l10.34"></a><span id="l10.34"> }</span>
<a href="#l10.35"></a><span id="l10.35"> </span>
<a href="#l10.36"></a><span id="l10.36"> function OAuth2(aBaseURI, aScope, aAppKey, aAppSecret) {</span>
<a href="#l10.37"></a><span id="l10.37">     this.authURI = aBaseURI + &quot;oauth2/auth&quot;;</span>
<a href="#l10.38"></a><span id="l10.38">     this.tokenURI = aBaseURI + &quot;oauth2/token&quot;;</span>
<a href="#l10.39"></a><span id="l10.39">     this.consumerKey = aAppKey;</span>
<a href="#l10.40"></a><span id="l10.40">     this.consumerSecret = aAppSecret;</span>
<a href="#l10.41"></a><span id="l10.41">     this.scope = aScope;</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineat">@@ -49,17 +47,17 @@ OAuth2.prototype = {</span>
<a href="#l10.43"></a><span id="l10.43">     requestWindowDescription: &quot;&quot;,</span>
<a href="#l10.44"></a><span id="l10.44">     scope: null,</span>
<a href="#l10.45"></a><span id="l10.45"> </span>
<a href="#l10.46"></a><span id="l10.46">     accessToken: null,</span>
<a href="#l10.47"></a><span id="l10.47">     refreshToken: null,</span>
<a href="#l10.48"></a><span id="l10.48">     tokenExpires: 0,</span>
<a href="#l10.49"></a><span id="l10.49">     connecting: false,</span>
<a href="#l10.50"></a><span id="l10.50"> </span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-    connect: function connect(aSuccess, aFailure, aWithUI, aRefresh) {</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+    connect: function(aSuccess, aFailure, aWithUI, aRefresh) {</span>
<a href="#l10.53"></a><span id="l10.53">         if (this.connecting) {</span>
<a href="#l10.54"></a><span id="l10.54">             return;</span>
<a href="#l10.55"></a><span id="l10.55">         }</span>
<a href="#l10.56"></a><span id="l10.56"> </span>
<a href="#l10.57"></a><span id="l10.57">         this.connectSuccessCallback = aSuccess;</span>
<a href="#l10.58"></a><span id="l10.58">         this.connectFailureCallback = aFailure;</span>
<a href="#l10.59"></a><span id="l10.59"> </span>
<a href="#l10.60"></a><span id="l10.60">         if (!aRefresh &amp;&amp; this.accessToken) {</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineat">@@ -72,108 +70,111 @@ OAuth2.prototype = {</span>
<a href="#l10.62"></a><span id="l10.62">                 aFailure('{ &quot;error&quot;: &quot;auth_noui&quot; }');</span>
<a href="#l10.63"></a><span id="l10.63">                 return;</span>
<a href="#l10.64"></a><span id="l10.64">             }</span>
<a href="#l10.65"></a><span id="l10.65">             this.connecting = true;</span>
<a href="#l10.66"></a><span id="l10.66">             this.requestAuthorization();</span>
<a href="#l10.67"></a><span id="l10.67">         }</span>
<a href="#l10.68"></a><span id="l10.68">     },</span>
<a href="#l10.69"></a><span id="l10.69"> </span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-    requestAuthorization: function requestAuthorization() {</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+    requestAuthorization: function() {</span>
<a href="#l10.72"></a><span id="l10.72">         let params = [</span>
<a href="#l10.73"></a><span id="l10.73">             [&quot;response_type&quot;, this.responseType],</span>
<a href="#l10.74"></a><span id="l10.74">             [&quot;client_id&quot;, this.consumerKey],</span>
<a href="#l10.75"></a><span id="l10.75">             [&quot;redirect_uri&quot;, this.completionURI],</span>
<a href="#l10.76"></a><span id="l10.76">         ];</span>
<a href="#l10.77"></a><span id="l10.77">         // The scope can be optional.</span>
<a href="#l10.78"></a><span id="l10.78">         if (this.scope) {</span>
<a href="#l10.79"></a><span id="l10.79">             params.push([&quot;scope&quot;, this.scope]);</span>
<a href="#l10.80"></a><span id="l10.80">         }</span>
<a href="#l10.81"></a><span id="l10.81"> </span>
<a href="#l10.82"></a><span id="l10.82">         // Add extra parameters, if they exist</span>
<a href="#l10.83"></a><span id="l10.83">         Array.prototype.push.apply(params, this.extraAuthParams);</span>
<a href="#l10.84"></a><span id="l10.84"> </span>
<a href="#l10.85"></a><span id="l10.85">         // Now map the parameters to a string</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-        params = params.map(function([k, v]) { return k + &quot;=&quot; + encodeURIComponent(v); }).join(&quot;&amp;&quot;);</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+        params = params.map(([k, v]) =&gt; k + &quot;=&quot; + encodeURIComponent(v)).join(&quot;&amp;&quot;);</span>
<a href="#l10.88"></a><span id="l10.88"> </span>
<a href="#l10.89"></a><span id="l10.89">         this._browserRequest = {</span>
<a href="#l10.90"></a><span id="l10.90">             account: this,</span>
<a href="#l10.91"></a><span id="l10.91">             url: this.authURI + &quot;?&quot; + params,</span>
<a href="#l10.92"></a><span id="l10.92">             description: this.requestWindowDescription,</span>
<a href="#l10.93"></a><span id="l10.93">             _active: true,</span>
<a href="#l10.94"></a><span id="l10.94">             iconURI: &quot;&quot;,</span>
<a href="#l10.95"></a><span id="l10.95">             cancelled: function() {</span>
<a href="#l10.96"></a><span id="l10.96">                 if (!this._active) {</span>
<a href="#l10.97"></a><span id="l10.97">                     return;</span>
<a href="#l10.98"></a><span id="l10.98">                 }</span>
<a href="#l10.99"></a><span id="l10.99"> </span>
<a href="#l10.100"></a><span id="l10.100">                 this.account.finishAuthorizationRequest();</span>
<a href="#l10.101"></a><span id="l10.101">                 this.account.onAuthorizationFailed(Components.results.NS_ERROR_ABORT, '{ &quot;error&quot;: &quot;cancelled&quot;}');</span>
<a href="#l10.102"></a><span id="l10.102">             },</span>
<a href="#l10.103"></a><span id="l10.103"> </span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-            loaded: function (aWindow, aWebProgress) {</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+            loaded: function(aWindow, aWebProgress) {</span>
<a href="#l10.106"></a><span id="l10.106">                 if (!this._active) {</span>
<a href="#l10.107"></a><span id="l10.107">                     return;</span>
<a href="#l10.108"></a><span id="l10.108">                 }</span>
<a href="#l10.109"></a><span id="l10.109"> </span>
<a href="#l10.110"></a><span id="l10.110">                 this._listener = {</span>
<a href="#l10.111"></a><span id="l10.111">                     window: aWindow,</span>
<a href="#l10.112"></a><span id="l10.112">                     webProgress: aWebProgress,</span>
<a href="#l10.113"></a><span id="l10.113">                     _parent: this.account,</span>
<a href="#l10.114"></a><span id="l10.114"> </span>
<a href="#l10.115"></a><span id="l10.115" class="difflineminus">-                    QueryInterface: XPCOMUtils.generateQI([Ci.nsIWebProgressListener,</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineminus">-                                                           Ci.nsISupportsWeakReference]),</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+                    QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+                        Components.interfaces.nsIWebProgressListener,</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+                        Components.interfaces.nsISupportsWeakReference</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+                    ]),</span>
<a href="#l10.121"></a><span id="l10.121"> </span>
<a href="#l10.122"></a><span id="l10.122">                     _cleanUp: function() {</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineminus">-                      this.webProgress.removeProgressListener(this);</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineminus">-                      this.window.close();</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineminus">-                      delete this.window;</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+                        this.webProgress.removeProgressListener(this);</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+                        this.window.close();</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+                        delete this.window;</span>
<a href="#l10.129"></a><span id="l10.129">                     },</span>
<a href="#l10.130"></a><span id="l10.130"> </span>
<a href="#l10.131"></a><span id="l10.131">                     _checkForRedirect: function(aURL) {</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineminus">-                      if (!aURL.startsWith(this._parent.completionURI)) {</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineminus">-                        return;</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-                      }</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+                        if (!aURL.startsWith(this._parent.completionURI)) {</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+                            return;</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+                        }</span>
<a href="#l10.138"></a><span id="l10.138"> </span>
<a href="#l10.139"></a><span id="l10.139" class="difflineminus">-                      this._parent.finishAuthorizationRequest();</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineminus">-                      this._parent.onAuthorizationReceived(aURL);</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+                        this._parent.finishAuthorizationRequest();</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+                        this._parent.onAuthorizationReceived(aURL);</span>
<a href="#l10.143"></a><span id="l10.143">                     },</span>
<a href="#l10.144"></a><span id="l10.144"> </span>
<a href="#l10.145"></a><span id="l10.145" class="difflineminus">-                    onStateChange: function(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineminus">-                      const wpl = Ci.nsIWebProgressListener;</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineminus">-                      if (aStateFlags &amp; (wpl.STATE_STOP)) {</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineminus">-                        try {</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineminus">-                            let httpchannel = aRequest.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+                    onStateChange: function(aChangedWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+                        const wpl = Components.interfaces.nsIWebProgressListener;</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+                        if (aStateFlags &amp; (wpl.STATE_STOP)) {</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+                            try {</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+                                let httpchannel = aRequest.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l10.155"></a><span id="l10.155"> </span>
<a href="#l10.156"></a><span id="l10.156" class="difflineminus">-                            let responseCategory = Math.floor(httpchannel.responseStatus / 100);</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+                                let responseCategory = Math.floor(httpchannel.responseStatus / 100);</span>
<a href="#l10.158"></a><span id="l10.158"> </span>
<a href="#l10.159"></a><span id="l10.159" class="difflineminus">-                            if (responseCategory != 2 &amp;&amp; responseCategory != 3) {</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineminus">-                                this._parent.finishAuthorizationRequest();</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineminus">-                                this._parent.onAuthorizationFailed(null, '{ &quot;error&quot;: &quot;http_' + httpchannel.responseStatus + '&quot; }');</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineminus">-                            }</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineminus">-                        } catch (e) {</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineminus">-                            // Throw the case where it's a http channel.</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineminus">-                            if (e.result != Components.results.NS_ERROR_NO_INTERFACE) {</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineminus">-                                throw e;</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+                                if (responseCategory != 2 &amp;&amp; responseCategory != 3) {</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+                                    this._parent.finishAuthorizationRequest();</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+                                    this._parent.onAuthorizationFailed(null, '{ &quot;error&quot;: &quot;http_' + httpchannel.responseStatus + '&quot; }');</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+                                }</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+                            } catch (e) {</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+                                // Throw the case where it's a http channel.</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+                                if (e.result != Components.results.NS_ERROR_NO_INTERFACE) {</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+                                    throw e;</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+                                }</span>
<a href="#l10.176"></a><span id="l10.176">                             }</span>
<a href="#l10.177"></a><span id="l10.177">                         }</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineminus">-                      }</span>
<a href="#l10.179"></a><span id="l10.179"> </span>
<a href="#l10.180"></a><span id="l10.180" class="difflineminus">-                      if (aStateFlags &amp; (wpl.STATE_START | wpl.STATE_IS_NETWORK))</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineminus">-                        this._checkForRedirect(aRequest.name);</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+                        if (aStateFlags &amp; (wpl.STATE_START | wpl.STATE_IS_NETWORK)) {</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+                            this._checkForRedirect(aRequest.name);</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+                        }</span>
<a href="#l10.185"></a><span id="l10.185">                     },</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineminus">-                    onLocationChange: function(aWebProgress, aRequest, aLocation) {</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineminus">-                      this._checkForRedirect(aLocation.spec);</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineplus">+                    onLocationChange: function(aChangedWebProgress, aRequest, aLocation) {</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineplus">+                        this._checkForRedirect(aLocation.spec);</span>
<a href="#l10.190"></a><span id="l10.190">                     },</span>
<a href="#l10.191"></a><span id="l10.191">                     onProgressChange: function() {},</span>
<a href="#l10.192"></a><span id="l10.192">                     onStatusChange: function() {},</span>
<a href="#l10.193"></a><span id="l10.193">                     onSecurityChange: function() {},</span>
<a href="#l10.194"></a><span id="l10.194">                 };</span>
<a href="#l10.195"></a><span id="l10.195">                 aWebProgress.addProgressListener(this._listener,</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineminus">-                                                 Ci.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineplus">+                                                 Components.interfaces.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l10.198"></a><span id="l10.198">                 aWindow.document.title = this.account.requestWindowTitle;</span>
<a href="#l10.199"></a><span id="l10.199">             }</span>
<a href="#l10.200"></a><span id="l10.200">         };</span>
<a href="#l10.201"></a><span id="l10.201"> </span>
<a href="#l10.202"></a><span id="l10.202">         this.wrappedJSObject = this._browserRequest;</span>
<a href="#l10.203"></a><span id="l10.203">         Services.ww.openWindow(null, this.requestWindowURI, null, this.requestWindowFeatures, this);</span>
<a href="#l10.204"></a><span id="l10.204">     },</span>
<a href="#l10.205"></a><span id="l10.205">     finishAuthorizationRequest: function() {</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineat">@@ -198,47 +199,47 @@ OAuth2.prototype = {</span>
<a href="#l10.207"></a><span id="l10.207">         }</span>
<a href="#l10.208"></a><span id="l10.208">     },</span>
<a href="#l10.209"></a><span id="l10.209"> </span>
<a href="#l10.210"></a><span id="l10.210">     onAuthorizationFailed: function(aError, aData) {</span>
<a href="#l10.211"></a><span id="l10.211">         this.connecting = false;</span>
<a href="#l10.212"></a><span id="l10.212">         this.connectFailureCallback(aData);</span>
<a href="#l10.213"></a><span id="l10.213">     },</span>
<a href="#l10.214"></a><span id="l10.214"> </span>
<a href="#l10.215"></a><span id="l10.215" class="difflineminus">-    requestAccessToken: function requestAccessToken(aCode, aType) {</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineplus">+    requestAccessToken: function(aCode, aType) {</span>
<a href="#l10.217"></a><span id="l10.217">         let params = [</span>
<a href="#l10.218"></a><span id="l10.218">             [&quot;client_id&quot;, this.consumerKey],</span>
<a href="#l10.219"></a><span id="l10.219">             [&quot;client_secret&quot;, this.consumerSecret],</span>
<a href="#l10.220"></a><span id="l10.220">             [&quot;grant_type&quot;, aType],</span>
<a href="#l10.221"></a><span id="l10.221">         ];</span>
<a href="#l10.222"></a><span id="l10.222"> </span>
<a href="#l10.223"></a><span id="l10.223">         if (aType == OAuth2.CODE_AUTHORIZATION) {</span>
<a href="#l10.224"></a><span id="l10.224">             params.push([&quot;code&quot;, aCode]);</span>
<a href="#l10.225"></a><span id="l10.225">             params.push([&quot;redirect_uri&quot;, this.completionURI]);</span>
<a href="#l10.226"></a><span id="l10.226">         } else if (aType == OAuth2.CODE_REFRESH) {</span>
<a href="#l10.227"></a><span id="l10.227">             params.push([&quot;refresh_token&quot;, aCode]);</span>
<a href="#l10.228"></a><span id="l10.228">         }</span>
<a href="#l10.229"></a><span id="l10.229"> </span>
<a href="#l10.230"></a><span id="l10.230">         let options = {</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineminus">-          postData: params,</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineminus">-          onLoad: this.onAccessTokenReceived.bind(this),</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineminus">-          onError: this.onAccessTokenFailed.bind(this)</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineminus">-        }</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineplus">+            postData: params,</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineplus">+            onLoad: this.onAccessTokenReceived.bind(this),</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineplus">+            onError: this.onAccessTokenFailed.bind(this)</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineplus">+        };</span>
<a href="#l10.239"></a><span id="l10.239">         httpRequest(this.tokenURI, options);</span>
<a href="#l10.240"></a><span id="l10.240">     },</span>
<a href="#l10.241"></a><span id="l10.241"> </span>
<a href="#l10.242"></a><span id="l10.242" class="difflineminus">-    onAccessTokenFailed: function onAccessTokenFailed(aError, aData) {</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineplus">+    onAccessTokenFailed: function(aError, aData) {</span>
<a href="#l10.244"></a><span id="l10.244">         if (aError != &quot;offline&quot;) {</span>
<a href="#l10.245"></a><span id="l10.245">             this.refreshToken = null;</span>
<a href="#l10.246"></a><span id="l10.246">         }</span>
<a href="#l10.247"></a><span id="l10.247">         this.connecting = false;</span>
<a href="#l10.248"></a><span id="l10.248">         this.connectFailureCallback(aData);</span>
<a href="#l10.249"></a><span id="l10.249">     },</span>
<a href="#l10.250"></a><span id="l10.250"> </span>
<a href="#l10.251"></a><span id="l10.251" class="difflineminus">-    onAccessTokenReceived: function onRequestTokenReceived(aData) {</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+    onAccessTokenReceived: function(aData) {</span>
<a href="#l10.253"></a><span id="l10.253">         let result = JSON.parse(aData);</span>
<a href="#l10.254"></a><span id="l10.254"> </span>
<a href="#l10.255"></a><span id="l10.255">         this.accessToken = result.access_token;</span>
<a href="#l10.256"></a><span id="l10.256">         if (&quot;refresh_token&quot; in result) {</span>
<a href="#l10.257"></a><span id="l10.257">             this.refreshToken = result.refresh_token;</span>
<a href="#l10.258"></a><span id="l10.258">         }</span>
<a href="#l10.259"></a><span id="l10.259">         if (&quot;expires_in&quot; in result) {</span>
<a href="#l10.260"></a><span id="l10.260">             this.tokenExpires = (new Date()).getTime() + (result.expires_in * 1000);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataLogging.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataLogging.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -90,19 +90,21 @@ function LOGattendee(aAttendee, asString</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5"> function LOGalarm(aAlarm) {</span>
<a href="#l11.6"></a><span id="l11.6">     if (!aAlarm) {</span>
<a href="#l11.7"></a><span id="l11.7">         return &quot;&quot;;</span>
<a href="#l11.8"></a><span id="l11.8">     }</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10">     let enumerator = aAlarm.propertyEnumerator;</span>
<a href="#l11.11"></a><span id="l11.11">     let xpropstr = &quot;&quot;;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    while (enumerator &amp;&amp; enumerator.hasMoreElements()) {</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-        let el = enumerator.getNext();</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-        xpropstr += &quot;\n\t\t\t&quot; + el.key + &quot;:&quot; + el.value;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+    if (enumerator) {</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+        while (enumerator.hasMoreElements()) {</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+            let elem = enumerator.getNext();</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+            xpropstr += &quot;\n\t\t\t&quot; + elem.key + &quot;:&quot; + elem.value;</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+        }</span>
<a href="#l11.20"></a><span id="l11.20">     }</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22">     return (&quot;\n\t\tAction: &quot; + aAlarm.action +</span>
<a href="#l11.23"></a><span id="l11.23">             &quot;\n\t\tOffset: &quot; + (aAlarm.offset &amp;&amp; aAlarm.offset.toString()) +</span>
<a href="#l11.24"></a><span id="l11.24">             &quot;\n\t\talarmDate: &quot; + (aAlarm.alarmDate &amp;&amp; aAlarm.alarmDate.toString()) +</span>
<a href="#l11.25"></a><span id="l11.25">             &quot;\n\t\trelated: &quot; + aAlarm.related +</span>
<a href="#l11.26"></a><span id="l11.26">             &quot;\n\t\trepeat: &quot; + aAlarm.repeat +</span>
<a href="#l11.27"></a><span id="l11.27">             &quot;\n\t\trepeatOffset: &quot; + (aAlarm.repeatOffset &amp;&amp; aAlarm.repeatOffset.toString()) +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataRequest.jsm</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataRequest.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -105,78 +105,78 @@ calGoogleRequest.prototype = {</span>
<a href="#l12.4"></a><span id="l12.4">     get status() {</span>
<a href="#l12.5"></a><span id="l12.5">         if (this.isPending) {</span>
<a href="#l12.6"></a><span id="l12.6">             return this.mLoader.request.status;</span>
<a href="#l12.7"></a><span id="l12.7">         } else {</span>
<a href="#l12.8"></a><span id="l12.8">             return this.mStatus;</span>
<a href="#l12.9"></a><span id="l12.9">         }</span>
<a href="#l12.10"></a><span id="l12.10">     },</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    cancel: function cGR_cancel(aStatus) {</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+    cancel: function(aStatus) {</span>
<a href="#l12.14"></a><span id="l12.14">         if (this.isPending) {</span>
<a href="#l12.15"></a><span id="l12.15">             if (this.mLoader) {</span>
<a href="#l12.16"></a><span id="l12.16">                 this.mLoader.request.cancel(aStatus);</span>
<a href="#l12.17"></a><span id="l12.17">             }</span>
<a href="#l12.18"></a><span id="l12.18">             this.mStatus = aStatus;</span>
<a href="#l12.19"></a><span id="l12.19">         }</span>
<a href="#l12.20"></a><span id="l12.20">     },</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22">     /**</span>
<a href="#l12.23"></a><span id="l12.23">      * attribute type</span>
<a href="#l12.24"></a><span id="l12.24">      * The type of this reqest. Must be one of</span>
<a href="#l12.25"></a><span id="l12.25">      * GET, ADD, MODIFY, DELETE</span>
<a href="#l12.26"></a><span id="l12.26">      */</span>
<a href="#l12.27"></a><span id="l12.27">     get type() { return this.method; },</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-    set type(v) {</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+    set type(val) {</span>
<a href="#l12.31"></a><span id="l12.31">         let valid = [this.GET, this.ADD, this.MODIFY, this.PATCH, this.DELETE];</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-        if (!valid.includes(v)) {</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-            throw new Components.Exception(&quot;Invalid request type: &quot; + v,</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+        if (!valid.includes(val)) {</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+            throw new Components.Exception(&quot;Invalid request type: &quot; + val,</span>
<a href="#l12.36"></a><span id="l12.36">                                             Components.results.NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l12.37"></a><span id="l12.37">         }</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-        return (this.method = v);</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+        return (this.method = val);</span>
<a href="#l12.40"></a><span id="l12.40">     },</span>
<a href="#l12.41"></a><span id="l12.41"> </span>
<a href="#l12.42"></a><span id="l12.42">     /**</span>
<a href="#l12.43"></a><span id="l12.43">      * setUploadData</span>
<a href="#l12.44"></a><span id="l12.44">      * The HTTP body data for a POST or PUT request.</span>
<a href="#l12.45"></a><span id="l12.45">      *</span>
<a href="#l12.46"></a><span id="l12.46">      * @param aContentType The Content type of the Data.</span>
<a href="#l12.47"></a><span id="l12.47">      * @param aData        The Data to upload.</span>
<a href="#l12.48"></a><span id="l12.48">      */</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-    setUploadData: function cGR_setUploadData(aContentType, aData) {</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+    setUploadData: function(aContentType, aData) {</span>
<a href="#l12.51"></a><span id="l12.51">         this.mUploadContent = aContentType;</span>
<a href="#l12.52"></a><span id="l12.52">         this.mUploadData = aData;</span>
<a href="#l12.53"></a><span id="l12.53">     },</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-    addQueryParameter: function cGR_addQueryParameter(aKey, aValue) {</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+    addQueryParameter: function(aKey, aValue) {</span>
<a href="#l12.57"></a><span id="l12.57">         if (aValue) {</span>
<a href="#l12.58"></a><span id="l12.58">             this.mQueryParameters.set(aKey, aValue);</span>
<a href="#l12.59"></a><span id="l12.59">         } else {</span>
<a href="#l12.60"></a><span id="l12.60">             this.mQueryParameters.delete(aKey);</span>
<a href="#l12.61"></a><span id="l12.61">         }</span>
<a href="#l12.62"></a><span id="l12.62">     },</span>
<a href="#l12.63"></a><span id="l12.63"> </span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-    addRequestHeader: function cGR_addRequestHeader(aKey, aValue) {</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+    addRequestHeader: function(aKey, aValue) {</span>
<a href="#l12.66"></a><span id="l12.66">         if (aValue) {</span>
<a href="#l12.67"></a><span id="l12.67">             this.mRequestHeaders.set(aKey, aValue);</span>
<a href="#l12.68"></a><span id="l12.68">         } else {</span>
<a href="#l12.69"></a><span id="l12.69">             this.mRequestHeaders.delete(aKey);</span>
<a href="#l12.70"></a><span id="l12.70">         }</span>
<a href="#l12.71"></a><span id="l12.71">     },</span>
<a href="#l12.72"></a><span id="l12.72"> </span>
<a href="#l12.73"></a><span id="l12.73">     /**</span>
<a href="#l12.74"></a><span id="l12.74">      * commit</span>
<a href="#l12.75"></a><span id="l12.75">      * Starts the request process. This can be called multiple times if the</span>
<a href="#l12.76"></a><span id="l12.76">      * request should be repeated</span>
<a href="#l12.77"></a><span id="l12.77">      *</span>
<a href="#l12.78"></a><span id="l12.78">      * @param aSession  The session object this request should be made with.</span>
<a href="#l12.79"></a><span id="l12.79">      *                  This parameter is optional.</span>
<a href="#l12.80"></a><span id="l12.80">      */</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineminus">-    commit: function cGR_commit(aSession) {</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+    commit: function(aSession) {</span>
<a href="#l12.83"></a><span id="l12.83">         if (!this.mDeferred) {</span>
<a href="#l12.84"></a><span id="l12.84">             this.mDeferred = PromiseUtils.defer();</span>
<a href="#l12.85"></a><span id="l12.85">         }</span>
<a href="#l12.86"></a><span id="l12.86">         let promise = this.mDeferred.promise;</span>
<a href="#l12.87"></a><span id="l12.87"> </span>
<a href="#l12.88"></a><span id="l12.88">         try {</span>
<a href="#l12.89"></a><span id="l12.89">             // Set the session to request with</span>
<a href="#l12.90"></a><span id="l12.90">             if (aSession) {</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineat">@@ -184,18 +184,18 @@ calGoogleRequest.prototype = {</span>
<a href="#l12.92"></a><span id="l12.92">             }</span>
<a href="#l12.93"></a><span id="l12.93"> </span>
<a href="#l12.94"></a><span id="l12.94">             // create the channel</span>
<a href="#l12.95"></a><span id="l12.95">             let uristring = this.uri;</span>
<a href="#l12.96"></a><span id="l12.96">             if (this.mQueryParameters.size &gt; 0) {</span>
<a href="#l12.97"></a><span id="l12.97">                 let params = [];</span>
<a href="#l12.98"></a><span id="l12.98"> </span>
<a href="#l12.99"></a><span id="l12.99">                 // Using forEach is needed for backwards compatibility</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-                this.mQueryParameters.forEach(function(v, k) {</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-                    params.push(k + &quot;=&quot; + encodeURIComponent(v));</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+                this.mQueryParameters.forEach((val, key) =&gt; {</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+                    params.push(key + &quot;=&quot; + encodeURIComponent(val));</span>
<a href="#l12.104"></a><span id="l12.104">                 });</span>
<a href="#l12.105"></a><span id="l12.105">                 uristring += &quot;?&quot; + params.join(&quot;&amp;&quot;);</span>
<a href="#l12.106"></a><span id="l12.106">             }</span>
<a href="#l12.107"></a><span id="l12.107">             let uri = Services.io.newURI(uristring);</span>
<a href="#l12.108"></a><span id="l12.108">             let channel;</span>
<a href="#l12.109"></a><span id="l12.109">             if (&quot;newChannelFromURI2&quot; in Services.io) {</span>
<a href="#l12.110"></a><span id="l12.110">                 // Lightning 4.3+</span>
<a href="#l12.111"></a><span id="l12.111">                 channel = Services.io.newChannelFromURI2(uri,</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineat">@@ -230,68 +230,67 @@ calGoogleRequest.prototype = {</span>
<a href="#l12.113"></a><span id="l12.113">     /**</span>
<a href="#l12.114"></a><span id="l12.114">      * fail</span>
<a href="#l12.115"></a><span id="l12.115">      * Call this request's listener with the given code and Message</span>
<a href="#l12.116"></a><span id="l12.116">      *</span>
<a href="#l12.117"></a><span id="l12.117">      * @param aCode     The Error code to fail with.</span>
<a href="#l12.118"></a><span id="l12.118">      * @param aMessage  The Error message. If this is null, an error Message</span>
<a href="#l12.119"></a><span id="l12.119">      *                  from calGoogleRequest will be used.</span>
<a href="#l12.120"></a><span id="l12.120">      */</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineminus">-    fail: function cGR_fail(aCode, aMessage) {</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+    fail: function(aCode, aMessage) {</span>
<a href="#l12.123"></a><span id="l12.123">         let ex = new Components.Exception(aMessage, aCode);</span>
<a href="#l12.124"></a><span id="l12.124">         this.mLoader = null;</span>
<a href="#l12.125"></a><span id="l12.125">         this.mStatus = aCode;</span>
<a href="#l12.126"></a><span id="l12.126">         this.mDeferred.reject(ex);</span>
<a href="#l12.127"></a><span id="l12.127">         this.mDeferred = null;</span>
<a href="#l12.128"></a><span id="l12.128">     },</span>
<a href="#l12.129"></a><span id="l12.129"> </span>
<a href="#l12.130"></a><span id="l12.130">     /**</span>
<a href="#l12.131"></a><span id="l12.131">      * succeed</span>
<a href="#l12.132"></a><span id="l12.132">      * Call this request's listener with a Success Code and the given Result.</span>
<a href="#l12.133"></a><span id="l12.133">      *</span>
<a href="#l12.134"></a><span id="l12.134">      * @param aResult   The result Text of this request.</span>
<a href="#l12.135"></a><span id="l12.135">      */</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineminus">-    succeed: function cGR_succeed(aResult) {</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+    succeed: function(aResult) {</span>
<a href="#l12.138"></a><span id="l12.138">         this.mLoader = null;</span>
<a href="#l12.139"></a><span id="l12.139">         this.mStatus = Components.results.NS_OK;</span>
<a href="#l12.140"></a><span id="l12.140">         this.mDeferred.resolve(aResult);</span>
<a href="#l12.141"></a><span id="l12.141">         this.mDeferred = null;</span>
<a href="#l12.142"></a><span id="l12.142">     },</span>
<a href="#l12.143"></a><span id="l12.143"> </span>
<a href="#l12.144"></a><span id="l12.144">     /**</span>
<a href="#l12.145"></a><span id="l12.145">      * prepareChannel</span>
<a href="#l12.146"></a><span id="l12.146">      * Prepares the passed channel to match this objects properties</span>
<a href="#l12.147"></a><span id="l12.147">      *</span>
<a href="#l12.148"></a><span id="l12.148">      * @param aChannel    The Channel to be prepared.</span>
<a href="#l12.149"></a><span id="l12.149">      */</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineminus">-    prepareChannel: function cGR_prepareChannel(aChannel) {</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+    prepareChannel: function(aChannel) {</span>
<a href="#l12.152"></a><span id="l12.152">         // No caching</span>
<a href="#l12.153"></a><span id="l12.153">         aChannel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l12.154"></a><span id="l12.154"> </span>
<a href="#l12.155"></a><span id="l12.155">         // Set upload Data</span>
<a href="#l12.156"></a><span id="l12.156">         if (this.mUploadData) {</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineminus">-            let converter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;].</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineminus">-                            createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+            let converter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+                                      .createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l12.161"></a><span id="l12.161">             converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l12.162"></a><span id="l12.162"> </span>
<a href="#l12.163"></a><span id="l12.163">             let stream = converter.convertToInputStream(this.mUploadData);</span>
<a href="#l12.164"></a><span id="l12.164">             aChannel = aChannel.QueryInterface(Components.interfaces.nsIUploadChannel);</span>
<a href="#l12.165"></a><span id="l12.165">             aChannel.setUploadStream(stream, this.mUploadContent, -1);</span>
<a href="#l12.166"></a><span id="l12.166"> </span>
<a href="#l12.167"></a><span id="l12.167">             cal.LOG(&quot;[calGoogleCalendar] Setting Upload Data (&quot; +</span>
<a href="#l12.168"></a><span id="l12.168">                     this.mUploadContent + &quot;):\n&quot; + this.mUploadData);</span>
<a href="#l12.169"></a><span id="l12.169">         }</span>
<a href="#l12.170"></a><span id="l12.170"> </span>
<a href="#l12.171"></a><span id="l12.171">         aChannel = aChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l12.172"></a><span id="l12.172"> </span>
<a href="#l12.173"></a><span id="l12.173">         // Depending on the preference, we will use X-HTTP-Method-Override to</span>
<a href="#l12.174"></a><span id="l12.174">         // get around some proxies. This will default to true.</span>
<a href="#l12.175"></a><span id="l12.175">         if (Preferences.get(&quot;calendar.google.useHTTPMethodOverride&quot;, true) &amp;&amp;</span>
<a href="#l12.176"></a><span id="l12.176">             (this.method == &quot;PUT&quot; || this.method == &quot;DELETE&quot;)) {</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineminus">-</span>
<a href="#l12.178"></a><span id="l12.178">             aChannel.requestMethod = &quot;POST&quot;;</span>
<a href="#l12.179"></a><span id="l12.179">             aChannel.setRequestHeader(&quot;X-HTTP-Method-Override&quot;,</span>
<a href="#l12.180"></a><span id="l12.180">                                       this.method,</span>
<a href="#l12.181"></a><span id="l12.181">                                       false);</span>
<a href="#l12.182"></a><span id="l12.182">             if (this.method == &quot;DELETE&quot;) {</span>
<a href="#l12.183"></a><span id="l12.183">                 // DELETE has no body, set an empty one so that Google accepts</span>
<a href="#l12.184"></a><span id="l12.184">                 // the request.</span>
<a href="#l12.185"></a><span id="l12.185">                 aChannel.setRequestHeader(&quot;Content-Type&quot;,</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineat">@@ -303,18 +302,18 @@ calGoogleRequest.prototype = {</span>
<a href="#l12.187"></a><span id="l12.187">             aChannel.requestMethod = this.method;</span>
<a href="#l12.188"></a><span id="l12.188">         }</span>
<a href="#l12.189"></a><span id="l12.189"> </span>
<a href="#l12.190"></a><span id="l12.190">         if (this.mRequestHeaders.size) {</span>
<a href="#l12.191"></a><span id="l12.191">             cal.LOG(&quot;[calGoogleCalendar] Sending request headers: &quot; + this.mRequestHeaders.toSource());</span>
<a href="#l12.192"></a><span id="l12.192">         }</span>
<a href="#l12.193"></a><span id="l12.193"> </span>
<a href="#l12.194"></a><span id="l12.194">         // Using forEach is needed for backwards compatibility</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineminus">-        this.mRequestHeaders.forEach(function(v, k) {</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineminus">-            aChannel.setRequestHeader(k, v, false);</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+        this.mRequestHeaders.forEach((val, key) =&gt; {</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineplus">+            aChannel.setRequestHeader(key, val, false);</span>
<a href="#l12.199"></a><span id="l12.199">         });</span>
<a href="#l12.200"></a><span id="l12.200"> </span>
<a href="#l12.201"></a><span id="l12.201">         // Add Authorization</span>
<a href="#l12.202"></a><span id="l12.202">         let token = this.mSession.accessToken;</span>
<a href="#l12.203"></a><span id="l12.203">         if (token) {</span>
<a href="#l12.204"></a><span id="l12.204">             aChannel.setRequestHeader(&quot;Authorization&quot;,</span>
<a href="#l12.205"></a><span id="l12.205">                                       &quot;Bearer &quot; + token,</span>
<a href="#l12.206"></a><span id="l12.206">                                       false);</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineat">@@ -328,33 +327,26 @@ calGoogleRequest.prototype = {</span>
<a href="#l12.208"></a><span id="l12.208">      * @see nsIInterfaceRequestor</span>
<a href="#l12.209"></a><span id="l12.209">      * @see calProviderUtils.jsm</span>
<a href="#l12.210"></a><span id="l12.210">      */</span>
<a href="#l12.211"></a><span id="l12.211">     getInterface: cal.InterfaceRequestor_getInterface,</span>
<a href="#l12.212"></a><span id="l12.212"> </span>
<a href="#l12.213"></a><span id="l12.213">     /**</span>
<a href="#l12.214"></a><span id="l12.214">      * @see nsIChannelEventSink</span>
<a href="#l12.215"></a><span id="l12.215">      */</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineminus">-    asyncOnChannelRedirect: function cGR_onChannelRedirect(aOldChannel,</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineminus">-                                                           aNewChannel,</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineminus">-                                                           aFlags,</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineminus">-                                                           aCallback) {</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+    asyncOnChannelRedirect: function(aOldChannel, aNewChannel, aFlags, aCallback) {</span>
<a href="#l12.221"></a><span id="l12.221">         // all we need to do to the new channel is the basic preparation</span>
<a href="#l12.222"></a><span id="l12.222">         this.prepareChannel(aNewChannel);</span>
<a href="#l12.223"></a><span id="l12.223">         aCallback.onRedirectVerifyCallback(Components.results.NS_OK);</span>
<a href="#l12.224"></a><span id="l12.224">     },</span>
<a href="#l12.225"></a><span id="l12.225"> </span>
<a href="#l12.226"></a><span id="l12.226">     /**</span>
<a href="#l12.227"></a><span id="l12.227">      * @see nsIStreamLoaderObserver</span>
<a href="#l12.228"></a><span id="l12.228">      */</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineminus">-    onStreamComplete: function cGR_onStreamComplete(aLoader,</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineminus">-                                                    aContext,</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineminus">-                                                    aStatus,</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineminus">-                                                    aResultLength,</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineminus">-                                                    aResult) {</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+    onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l12.235"></a><span id="l12.235">         if (!aResult || !Components.isSuccessCode(aStatus)) {</span>
<a href="#l12.236"></a><span id="l12.236">             this.fail(aStatus, aResult);</span>
<a href="#l12.237"></a><span id="l12.237">             return;</span>
<a href="#l12.238"></a><span id="l12.238">         }</span>
<a href="#l12.239"></a><span id="l12.239"> </span>
<a href="#l12.240"></a><span id="l12.240">         let httpChannel = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l12.241"></a><span id="l12.241"> </span>
<a href="#l12.242"></a><span id="l12.242">         // Convert the stream, falling back to utf-8 in case its not given.</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineat">@@ -392,18 +384,18 @@ calGoogleRequest.prototype = {</span>
<a href="#l12.244"></a><span id="l12.244">             cal.LOG(&quot;[calGoogleRequest] Clock skew is &quot; + getCorrectedDate.mClockSkew + &quot; seconds&quot;);</span>
<a href="#l12.245"></a><span id="l12.245">         }</span>
<a href="#l12.246"></a><span id="l12.246"> </span>
<a href="#l12.247"></a><span id="l12.247">         // Remember when this request happened</span>
<a href="#l12.248"></a><span id="l12.248">         this.requestDate = cal.createDateTime();</span>
<a href="#l12.249"></a><span id="l12.249">         this.requestDate.nativeTime = serverDate.getTime() * 1000;</span>
<a href="#l12.250"></a><span id="l12.250"> </span>
<a href="#l12.251"></a><span id="l12.251">         cal.LOG(&quot;[calGoogleCalendar] Request &quot; + this.method + &quot; &quot; +</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineminus">-                httpChannel.URI.spec + &quot; responded with HTTP &quot;</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineminus">-                + httpChannel.responseStatus);</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+                httpChannel.URI.spec + &quot; responded with HTTP &quot; +</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+                httpChannel.responseStatus);</span>
<a href="#l12.256"></a><span id="l12.256"> </span>
<a href="#l12.257"></a><span id="l12.257">         // Handle all (documented) error codes</span>
<a href="#l12.258"></a><span id="l12.258">         switch (httpChannel.responseStatus) {</span>
<a href="#l12.259"></a><span id="l12.259">             case 200: /* No error. */</span>
<a href="#l12.260"></a><span id="l12.260">             case 201: /* Creation of a resource was successful. */</span>
<a href="#l12.261"></a><span id="l12.261">             case 204: /* No content */</span>
<a href="#l12.262"></a><span id="l12.262">                 // Everything worked out, we are done</span>
<a href="#l12.263"></a><span id="l12.263">                 if (this.calendar) {</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineat">@@ -433,17 +425,17 @@ calGoogleRequest.prototype = {</span>
<a href="#l12.265"></a><span id="l12.265">                         this.fail(calGoogleRequest.TOKEN_FAILURE, reason);</span>
<a href="#l12.266"></a><span id="l12.266">                         break;</span>
<a href="#l12.267"></a><span id="l12.267">                     case &quot;unauthorized_client&quot;:</span>
<a href="#l12.268"></a><span id="l12.268">                         // This often happens when the client makes a request</span>
<a href="#l12.269"></a><span id="l12.269">                         // authorized with an old api token. Retry the request</span>
<a href="#l12.270"></a><span id="l12.270">                         // once.</span>
<a href="#l12.271"></a><span id="l12.271">                         this.mSession.invalidate();</span>
<a href="#l12.272"></a><span id="l12.272">                         if (this.reauthenticate) {</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineminus">-                            cal.LOG(&quot;[calGoogleRequest] The access token is not authorized, trying to refresh token.&quot;)</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineplus">+                            cal.LOG(&quot;[calGoogleRequest] The access token is not authorized, trying to refresh token.&quot;);</span>
<a href="#l12.275"></a><span id="l12.275">                             this.reauthenticate = false;</span>
<a href="#l12.276"></a><span id="l12.276">                             this.mSession.asyncItemRequest(this);</span>
<a href="#l12.277"></a><span id="l12.277">                         } else {</span>
<a href="#l12.278"></a><span id="l12.278">                             cal.LOG(&quot;[calGoogleRequest] Even refreshed token is not authorized, looks like the client is outdated&quot;);</span>
<a href="#l12.279"></a><span id="l12.279">                             this.mSession.notifyOutdated();</span>
<a href="#l12.280"></a><span id="l12.280">                             if (this.calendar) {</span>
<a href="#l12.281"></a><span id="l12.281">                                 this.calendar.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l12.282"></a><span id="l12.282">                                 this.calendar.setProperty(&quot;currentStatus&quot;, calGoogleRequest.TOKEN_FAILURE);</span>
<a href="#l12.283"></a><span id="l12.283" class="difflineat">@@ -510,27 +502,28 @@ calGoogleRequest.prototype = {</span>
<a href="#l12.284"></a><span id="l12.284">                             objData.error.errors &amp;&amp; objData.error.errors[0];</span>
<a href="#l12.285"></a><span id="l12.285"> </span>
<a href="#l12.286"></a><span id="l12.286">                 if (error.message == &quot;Invalid sync token value.&quot;) {</span>
<a href="#l12.287"></a><span id="l12.287">                     this.fail(calGoogleRequest.RESOURCE_GONE, objData);</span>
<a href="#l12.288"></a><span id="l12.288">                     return;</span>
<a href="#l12.289"></a><span id="l12.289">                 }</span>
<a href="#l12.290"></a><span id="l12.290">             }</span>
<a href="#l12.291"></a><span id="l12.291">             // Otherwise fall through</span>
<a href="#l12.292"></a><span id="l12.292" class="difflineminus">-            default:</span>
<a href="#l12.293"></a><span id="l12.293" class="difflineplus">+            default: {</span>
<a href="#l12.294"></a><span id="l12.294">                 // The following codes are caught here:</span>
<a href="#l12.295"></a><span id="l12.295">                 //  500 INTERNAL SERVER ERROR: Internal error. This is the</span>
<a href="#l12.296"></a><span id="l12.296">                 //                             default code that is used for</span>
<a href="#l12.297"></a><span id="l12.297">                 //                             all unrecognized errors.</span>
<a href="#l12.298"></a><span id="l12.298">                 //</span>
<a href="#l12.299"></a><span id="l12.299"> </span>
<a href="#l12.300"></a><span id="l12.300">                 // Something else went wrong</span>
<a href="#l12.301"></a><span id="l12.301">                 let msg = &quot;A request Error Occurred. Status Code: &quot; +</span>
<a href="#l12.302"></a><span id="l12.302">                           httpChannel.responseStatus + &quot; &quot; +</span>
<a href="#l12.303"></a><span id="l12.303">                           httpChannel.responseStatusText + &quot; Body: &quot; +</span>
<a href="#l12.304"></a><span id="l12.304">                           result;</span>
<a href="#l12.305"></a><span id="l12.305">                 cal.LOG(&quot;[calGoogleCalendar] &quot; + msg);</span>
<a href="#l12.306"></a><span id="l12.306"> </span>
<a href="#l12.307"></a><span id="l12.307">                 this.fail(Components.results.NS_ERROR_NOT_AVAILABLE, msg);</span>
<a href="#l12.308"></a><span id="l12.308">                 break;</span>
<a href="#l12.309"></a><span id="l12.309" class="difflineplus">+            }</span>
<a href="#l12.310"></a><span id="l12.310">         }</span>
<a href="#l12.311"></a><span id="l12.311">     }</span>
<a href="#l12.312"></a><span id="l12.312"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataSession.jsm</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataSession.jsm</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -36,29 +36,35 @@ var calGoogleSessionManager = {</span>
<a href="#l13.4"></a><span id="l13.4">      *</span>
<a href="#l13.5"></a><span id="l13.5">      * @param aCalendar  The calendar to get the session for.</span>
<a href="#l13.6"></a><span id="l13.6">      * @param aCreate    If true, the session will be created prior to returning.</span>
<a href="#l13.7"></a><span id="l13.7">      * @return           The initialized session object.</span>
<a href="#l13.8"></a><span id="l13.8">      */</span>
<a href="#l13.9"></a><span id="l13.9">     getSessionByCalendar: function(aCalendar, aCreate) {</span>
<a href="#l13.10"></a><span id="l13.10">         let id = null;</span>
<a href="#l13.11"></a><span id="l13.11">         let uri = aCalendar.uri;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-        let host = (function() { try { return uri.host; } catch (e) {} })();</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+        let host = (function() {</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+            try {</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+                return uri.host;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+            } catch (e) {</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+                return null;</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+            }</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+        })();</span>
<a href="#l13.20"></a><span id="l13.20">         const protocols = [&quot;http&quot;, &quot;https&quot;, &quot;webcal&quot;, &quot;webcals&quot;];</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22">         if (aCalendar.type != &quot;gdata&quot;) {</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-            return;</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+            return null;</span>
<a href="#l13.25"></a><span id="l13.25">         }</span>
<a href="#l13.26"></a><span id="l13.26"> </span>
<a href="#l13.27"></a><span id="l13.27">         if (uri.schemeIs(&quot;googleapi&quot;)) {</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-            let [fullUser, path] = uri.pathQueryRef.substr(2).split(&quot;/&quot;, 2);</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-            id = fullUser || cal.getUUID();</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-        } else if (host == &quot;www.google.com&quot; &amp;&amp; uri.pathQueryRef.startsWith(&quot;/calendar/feeds&quot;) &amp;&amp; protocols.some(function(s) { return uri.schemeIs(s); })) {</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+            let parts = uri.pathQueryRef.substr(2).split(&quot;/&quot;, 2);</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+            id = parts[0] || cal.getUUID();</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+        } else if (host == &quot;www.google.com&quot; &amp;&amp; uri.pathQueryRef.startsWith(&quot;/calendar/feeds&quot;) &amp;&amp; protocols.some(scheme =&gt; uri.schemeIs(scheme))) {</span>
<a href="#l13.34"></a><span id="l13.34">             let googleCalendarName = aCalendar.getProperty(&quot;googleCalendarName&quot;);</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-            let googleUser = Preferences.get(&quot;calendar.google.calPrefs.&quot; + googleCalendarName  + &quot;.googleUser&quot;);</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+            let googleUser = Preferences.get(&quot;calendar.google.calPrefs.&quot; + googleCalendarName + &quot;.googleUser&quot;);</span>
<a href="#l13.37"></a><span id="l13.37">             id = googleUser || googleCalendarName || cal.getUUID();</span>
<a href="#l13.38"></a><span id="l13.38">         }</span>
<a href="#l13.39"></a><span id="l13.39"> </span>
<a href="#l13.40"></a><span id="l13.40">         return id ? this.getSessionById(id, aCreate) : null;</span>
<a href="#l13.41"></a><span id="l13.41">     },</span>
<a href="#l13.42"></a><span id="l13.42"> </span>
<a href="#l13.43"></a><span id="l13.43">     getSessionById: function(aSessionId, aCreate) {</span>
<a href="#l13.44"></a><span id="l13.44">         // Check if the session exists</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineat">@@ -96,41 +102,39 @@ calGoogleSession.prototype = {</span>
<a href="#l13.46"></a><span id="l13.46">     mId: null,</span>
<a href="#l13.47"></a><span id="l13.47">     mSessionID: null,</span>
<a href="#l13.48"></a><span id="l13.48">     mLoginPromise: null,</span>
<a href="#l13.49"></a><span id="l13.49"> </span>
<a href="#l13.50"></a><span id="l13.50">     get id() { return this.mId; },</span>
<a href="#l13.51"></a><span id="l13.51"> </span>
<a href="#l13.52"></a><span id="l13.52">     notifyQuotaExceeded: function() {</span>
<a href="#l13.53"></a><span id="l13.53">         let now = new Date();</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-        let tt = (now - this.mLastNotified);</span>
<a href="#l13.55"></a><span id="l13.55">         if (!this.mLastNotified || (now - this.mLastNotified) &gt; NOTIFY_TIMEOUT) {</span>
<a href="#l13.56"></a><span id="l13.56">             this.mLastNotified = now;</span>
<a href="#l13.57"></a><span id="l13.57">             let title = getProviderString(&quot;extensions.{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}.name&quot;);</span>
<a href="#l13.58"></a><span id="l13.58">             let quotaString = getProviderString(&quot;quotaExceeded&quot;, this.id);</span>
<a href="#l13.59"></a><span id="l13.59">             Services.prompt.alert(cal.window.getCalendarWindow(), title, quotaString);</span>
<a href="#l13.60"></a><span id="l13.60">         } else {</span>
<a href="#l13.61"></a><span id="l13.61">             cal.LOG(&quot;[calGoogleCalendar] Throttling quota notification, last was &quot; + (now - this.mLastNotified) + &quot; ms ago&quot;);</span>
<a href="#l13.62"></a><span id="l13.62">         }</span>
<a href="#l13.63"></a><span id="l13.63">     },</span>
<a href="#l13.64"></a><span id="l13.64"> </span>
<a href="#l13.65"></a><span id="l13.65">     notifyOutdated: function() {</span>
<a href="#l13.66"></a><span id="l13.66">         let now = new Date();</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-        let tt = (now - this.mLastNotified);</span>
<a href="#l13.68"></a><span id="l13.68">         if (!this.mLastNotified || (now - this.mLastNotified) &gt; NOTIFY_TIMEOUT) {</span>
<a href="#l13.69"></a><span id="l13.69">             this.mLastNotified = now;</span>
<a href="#l13.70"></a><span id="l13.70">             let title = getProviderString(&quot;extensions.{a62ef8ec-5fdc-40c2-873c-223b8a6925cc}.name&quot;);</span>
<a href="#l13.71"></a><span id="l13.71">             let outdatedString = getProviderString(&quot;providerOutdated&quot;);</span>
<a href="#l13.72"></a><span id="l13.72">             Services.prompt.alert(cal.window.getCalendarWindow(), title, outdatedString);</span>
<a href="#l13.73"></a><span id="l13.73">         } else {</span>
<a href="#l13.74"></a><span id="l13.74">             cal.LOG(&quot;[calGoogleCalendar] Throttling outdated notification, last was &quot; + (now - this.mLastNotified) + &quot; ms ago&quot;);</span>
<a href="#l13.75"></a><span id="l13.75">         }</span>
<a href="#l13.76"></a><span id="l13.76">     },</span>
<a href="#l13.77"></a><span id="l13.77"> </span>
<a href="#l13.78"></a><span id="l13.78" class="difflineminus">-    setupOAuth: function setupOAuth() {</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+    setupOAuth: function() {</span>
<a href="#l13.80"></a><span id="l13.80">         let sessionId = this.mId;</span>
<a href="#l13.81"></a><span id="l13.81">         let authDescr = getProviderString(&quot;requestWindowDescription&quot;, sessionId);</span>
<a href="#l13.82"></a><span id="l13.82">         let authTitle = getProviderString(&quot;requestWindowTitle&quot;, sessionId);</span>
<a href="#l13.83"></a><span id="l13.83"> </span>
<a href="#l13.84"></a><span id="l13.84">         // Set up a new OAuth2 instance for logging in.</span>
<a href="#l13.85"></a><span id="l13.85">         this.oauth = new OAuth2(OAUTH_BASE_URI, OAUTH_SCOPE, OAUTH_CLIENT_ID, OAUTH_CLIENT_SECRET);</span>
<a href="#l13.86"></a><span id="l13.86">         this.oauth.extraAuthParams = [</span>
<a href="#l13.87"></a><span id="l13.87">           [&quot;login_hint&quot;, sessionId],</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineat">@@ -141,33 +145,33 @@ calGoogleSession.prototype = {</span>
<a href="#l13.89"></a><span id="l13.89">         this.oauth.requestWindowFeatures = &quot;chrome,private,centerscreen,width=430,height=600&quot;;</span>
<a href="#l13.90"></a><span id="l13.90">         this.oauth.requestWindowTitle = authTitle;</span>
<a href="#l13.91"></a><span id="l13.91">         this.oauth.requestWindowDescription = authDescr;</span>
<a href="#l13.92"></a><span id="l13.92"> </span>
<a href="#l13.93"></a><span id="l13.93">         // Overwrite the refreshToken attribute, since we want to save it in</span>
<a href="#l13.94"></a><span id="l13.94">         // the password manager</span>
<a href="#l13.95"></a><span id="l13.95">         let pwMgrId = &quot;Google Calendar OAuth Token&quot;;</span>
<a href="#l13.96"></a><span id="l13.96">         Object.defineProperty(this.oauth, &quot;refreshToken&quot;, {</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineminus">-            get: function getRefreshToken() {</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+            get: function() {</span>
<a href="#l13.99"></a><span id="l13.99">                 if (!this.mRefreshToken) {</span>
<a href="#l13.100"></a><span id="l13.100">                     let pass = { value: null };</span>
<a href="#l13.101"></a><span id="l13.101">                     try {</span>
<a href="#l13.102"></a><span id="l13.102">                         let origin = &quot;oauth:&quot; + sessionId;</span>
<a href="#l13.103"></a><span id="l13.103">                         cal.auth.passwordManagerGet(sessionId, pass, origin, pwMgrId);</span>
<a href="#l13.104"></a><span id="l13.104">                     } catch (e) {</span>
<a href="#l13.105"></a><span id="l13.105">                         // User might have cancelled the master password prompt, thats ok</span>
<a href="#l13.106"></a><span id="l13.106">                         if (e.result != Components.results.NS_ERROR_ABORT) {</span>
<a href="#l13.107"></a><span id="l13.107">                             throw e;</span>
<a href="#l13.108"></a><span id="l13.108">                         }</span>
<a href="#l13.109"></a><span id="l13.109">                     }</span>
<a href="#l13.110"></a><span id="l13.110">                     this.mRefreshToken = pass.value;</span>
<a href="#l13.111"></a><span id="l13.111">                 }</span>
<a href="#l13.112"></a><span id="l13.112">                 return this.mRefreshToken;</span>
<a href="#l13.113"></a><span id="l13.113">             },</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineminus">-            set: function setRefreshToken(val) {</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+            set: function(val) {</span>
<a href="#l13.116"></a><span id="l13.116">                 try {</span>
<a href="#l13.117"></a><span id="l13.117">                     let origin = &quot;oauth:&quot; + sessionId;</span>
<a href="#l13.118"></a><span id="l13.118">                     if (val) {</span>
<a href="#l13.119"></a><span id="l13.119">                         cal.auth.passwordManagerSave(sessionId, val, origin, pwMgrId);</span>
<a href="#l13.120"></a><span id="l13.120">                     } else {</span>
<a href="#l13.121"></a><span id="l13.121">                         cal.auth.passwordManagerRemove(sessionId, origin, pwMgrId);</span>
<a href="#l13.122"></a><span id="l13.122">                     }</span>
<a href="#l13.123"></a><span id="l13.123">                 } catch (e) {</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineat">@@ -208,17 +212,17 @@ calGoogleSession.prototype = {</span>
<a href="#l13.125"></a><span id="l13.125"> </span>
<a href="#l13.126"></a><span id="l13.126">     get accessToken() { return this.oauth.accessToken; },</span>
<a href="#l13.127"></a><span id="l13.127">     get refreshToken() { return this.oauth.refreshToken; },</span>
<a href="#l13.128"></a><span id="l13.128">     set refreshToken(val) { this.oauth.refreshToken = val; },</span>
<a href="#l13.129"></a><span id="l13.129"> </span>
<a href="#l13.130"></a><span id="l13.130">     /**</span>
<a href="#l13.131"></a><span id="l13.131">      * Resets the access token, it will be re-retrieved on the next request.</span>
<a href="#l13.132"></a><span id="l13.132">      */</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineminus">-    invalidate: function cGS_invalidate() {</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+    invalidate: function() {</span>
<a href="#l13.135"></a><span id="l13.135">         cal.LOG(&quot;[calGoogleSession] Invalidating session, will reauthenticate on next request&quot;);</span>
<a href="#l13.136"></a><span id="l13.136">         this.oauth.accessToken = null;</span>
<a href="#l13.137"></a><span id="l13.137">     },</span>
<a href="#l13.138"></a><span id="l13.138"> </span>
<a href="#l13.139"></a><span id="l13.139">     /**</span>
<a href="#l13.140"></a><span id="l13.140">      * Returns a promise resolved when the login is complete.</span>
<a href="#l13.141"></a><span id="l13.141">      */</span>
<a href="#l13.142"></a><span id="l13.142">     login: function() {</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineat">@@ -226,17 +230,16 @@ calGoogleSession.prototype = {</span>
<a href="#l13.144"></a><span id="l13.144">             return this.mLoginPromise;</span>
<a href="#l13.145"></a><span id="l13.145">         }</span>
<a href="#l13.146"></a><span id="l13.146">         let deferred = PromiseUtils.defer();</span>
<a href="#l13.147"></a><span id="l13.147"> </span>
<a href="#l13.148"></a><span id="l13.148">         try {</span>
<a href="#l13.149"></a><span id="l13.149">             // Start logging in</span>
<a href="#l13.150"></a><span id="l13.150">             cal.LOG(&quot;[calGoogleCalendar] Logging in session &quot; + this.mId);</span>
<a href="#l13.151"></a><span id="l13.151">             let accessToken = this.accessToken;</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineminus">-            let refreshToken = this.refreshToken;</span>
<a href="#l13.153"></a><span id="l13.153"> </span>
<a href="#l13.154"></a><span id="l13.154">             let authSuccess = function() {</span>
<a href="#l13.155"></a><span id="l13.155">                 cal.LOG(&quot;[calGoogleCalendar] Successfully acquired a new&quot; +</span>
<a href="#l13.156"></a><span id="l13.156">                         &quot; OAuth token for &quot; + this.mId);</span>
<a href="#l13.157"></a><span id="l13.157">                 deferred.resolve(this.accessToken);</span>
<a href="#l13.158"></a><span id="l13.158">             }.bind(this);</span>
<a href="#l13.159"></a><span id="l13.159"> </span>
<a href="#l13.160"></a><span id="l13.160">             let authFailed = function(aData) {</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineat">@@ -310,67 +313,67 @@ calGoogleSession.prototype = {</span>
<a href="#l13.162"></a><span id="l13.162">                     }</span>
<a href="#l13.163"></a><span id="l13.163">                 }, 0);</span>
<a href="#l13.164"></a><span id="l13.164">             }</span>
<a href="#l13.165"></a><span id="l13.165">         } catch (e) {</span>
<a href="#l13.166"></a><span id="l13.166">             // If something went wrong, reset the login state just in case</span>
<a href="#l13.167"></a><span id="l13.167">             cal.LOG(&quot;[calGoogleCalendar] Error Logging In: &quot; + e);</span>
<a href="#l13.168"></a><span id="l13.168">             deferred.reject(e);</span>
<a href="#l13.169"></a><span id="l13.169">         }</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineminus">-        return deferred.promise.then(function(accessToken) {</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+        return deferred.promise.then((accessToken) =&gt; {</span>
<a href="#l13.172"></a><span id="l13.172">             this.mLoginPromise = null;</span>
<a href="#l13.173"></a><span id="l13.173">             return accessToken;</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineminus">-        }.bind(this), function(e) {</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+        }, (e) =&gt; {</span>
<a href="#l13.176"></a><span id="l13.176">             this.mLoginPromise = null;</span>
<a href="#l13.177"></a><span id="l13.177">             throw e;</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineminus">-        }.bind(this));</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+        });</span>
<a href="#l13.180"></a><span id="l13.180">     },</span>
<a href="#l13.181"></a><span id="l13.181"> </span>
<a href="#l13.182"></a><span id="l13.182">     /**</span>
<a href="#l13.183"></a><span id="l13.183">      * asyncItemRequest</span>
<a href="#l13.184"></a><span id="l13.184">      * get or post an Item from or to Google using the Queue.</span>
<a href="#l13.185"></a><span id="l13.185">      *</span>
<a href="#l13.186"></a><span id="l13.186">      * @param aRequest          The Request Object. This is an instance of</span>
<a href="#l13.187"></a><span id="l13.187">      *                          calGoogleRequest.</span>
<a href="#l13.188"></a><span id="l13.188">      */</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineminus">-    asyncItemRequest: function cGS_asyncItemRequest(aRequest) {</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+    asyncItemRequest: function(aRequest) {</span>
<a href="#l13.191"></a><span id="l13.191">         let tokenExpiresIn = Math.floor((this.oauth.tokenExpires - (new Date()).getTime()) / 1000);</span>
<a href="#l13.192"></a><span id="l13.192">         if (tokenExpiresIn &lt; 0 &amp;&amp; !this.mLoginPromise) {</span>
<a href="#l13.193"></a><span id="l13.193">             cal.LOG(&quot;[calGoogleSession] Token expired &quot; + (-tokenExpiresIn) + &quot; seconds ago, resetting&quot;);</span>
<a href="#l13.194"></a><span id="l13.194">             this.oauth.accessToken = null;</span>
<a href="#l13.195"></a><span id="l13.195">         }</span>
<a href="#l13.196"></a><span id="l13.196"> </span>
<a href="#l13.197"></a><span id="l13.197">         if (this.accessToken) {</span>
<a href="#l13.198"></a><span id="l13.198">             // Already have a token, we can request directly. If the token is</span>
<a href="#l13.199"></a><span id="l13.199">             // about to expire use it, but refresh the token while we are here.</span>
<a href="#l13.200"></a><span id="l13.200">             if (tokenExpiresIn &lt; 30 &amp;&amp; !this.mLoginPromise) {</span>
<a href="#l13.201"></a><span id="l13.201">                 cal.LOG(&quot;[calGoogleSession] Token will expire in &quot; + tokenExpiresIn + &quot; seconds, refreshing&quot;);</span>
<a href="#l13.202"></a><span id="l13.202">                 this.mLoginPromise = this.login();</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineminus">-                this.mLoginPromise.then(function() {</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+                this.mLoginPromise.then(() =&gt; {</span>
<a href="#l13.205"></a><span id="l13.205">                     cal.LOG(&quot;[calGoogleSession] Premature token refresh completed&quot;);</span>
<a href="#l13.206"></a><span id="l13.206">                 });</span>
<a href="#l13.207"></a><span id="l13.207">             }</span>
<a href="#l13.208"></a><span id="l13.208">             return aRequest.commit(this);</span>
<a href="#l13.209"></a><span id="l13.209">         } else if (this.mLoginPromise) {</span>
<a href="#l13.210"></a><span id="l13.210">             // We are logging in and have no token, queue the request</span>
<a href="#l13.211"></a><span id="l13.211">             cal.LOG(&quot;[calGoogleSession] Adding item &quot; + aRequest.uri + &quot; to queue&quot;);</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineminus">-            return this.mLoginPromise.then(function() {</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+            return this.mLoginPromise.then(() =&gt; {</span>
<a href="#l13.214"></a><span id="l13.214">                 return aRequest.commit(this);</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineminus">-            }.bind(this), function(e) {</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+            }, (e) =&gt; {</span>
<a href="#l13.217"></a><span id="l13.217">                 // If the user cancelled the login dialog, then disable the</span>
<a href="#l13.218"></a><span id="l13.218">                 // calendar until the next startup or manual enable.</span>
<a href="#l13.219"></a><span id="l13.219">                 if (aRequest.calendar &amp;&amp; e.message == &quot;cancelled&quot;) {</span>
<a href="#l13.220"></a><span id="l13.220">                     aRequest.calendar.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l13.221"></a><span id="l13.221">                     aRequest.calendar.setProperty(&quot;auto-enabled&quot;, true);</span>
<a href="#l13.222"></a><span id="l13.222">                     aRequest.calendar.setProperty(&quot;currentStatus&quot;,</span>
<a href="#l13.223"></a><span id="l13.223">                                     Components.results.NS_ERROR_FAILURE);</span>
<a href="#l13.224"></a><span id="l13.224">                 }</span>
<a href="#l13.225"></a><span id="l13.225"> </span>
<a href="#l13.226"></a><span id="l13.226">                 throw e;</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineminus">-            }.bind(this));</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineplus">+            });</span>
<a href="#l13.229"></a><span id="l13.229">         } else {</span>
<a href="#l13.230"></a><span id="l13.230">             // Not logging in and no token, get the login promise and retry.</span>
<a href="#l13.231"></a><span id="l13.231">             this.mLoginPromise = this.login();</span>
<a href="#l13.232"></a><span id="l13.232">             return this.asyncItemRequest(aRequest);</span>
<a href="#l13.233"></a><span id="l13.233">         }</span>
<a href="#l13.234"></a><span id="l13.234">     },</span>
<a href="#l13.235"></a><span id="l13.235"> </span>
<a href="#l13.236"></a><span id="l13.236">     asyncPaginatedRequest: async function(aRequest, onFirst, onEach, onLast) {</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineat">@@ -379,46 +382,47 @@ calGoogleSession.prototype = {</span>
<a href="#l13.238"></a><span id="l13.238">         if (onFirst) {</span>
<a href="#l13.239"></a><span id="l13.239">             await onFirst(data);</span>
<a href="#l13.240"></a><span id="l13.240">         }</span>
<a href="#l13.241"></a><span id="l13.241"> </span>
<a href="#l13.242"></a><span id="l13.242">         if (onEach) {</span>
<a href="#l13.243"></a><span id="l13.243">             await onEach(data);</span>
<a href="#l13.244"></a><span id="l13.244">         }</span>
<a href="#l13.245"></a><span id="l13.245"> </span>
<a href="#l13.246"></a><span id="l13.246" class="difflineplus">+        // In bug 1410672 it turns out this doesn't work without return await</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+        /* eslint-disable no-return-await */</span>
<a href="#l13.248"></a><span id="l13.248">         if (data.nextPageToken) {</span>
<a href="#l13.249"></a><span id="l13.249">             aRequest.addQueryParameter(&quot;pageToken&quot;, data.nextPageToken);</span>
<a href="#l13.250"></a><span id="l13.250">             return await this.asyncPaginatedRequest(aRequest, null, onEach, onLast);</span>
<a href="#l13.251"></a><span id="l13.251">         } else if (onLast) {</span>
<a href="#l13.252"></a><span id="l13.252">             return await onLast(data);</span>
<a href="#l13.253"></a><span id="l13.253">         }</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineplus">+        /* eslint-enable no-return-await */</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineplus">+</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineplus">+        return null;</span>
<a href="#l13.257"></a><span id="l13.257">     },</span>
<a href="#l13.258"></a><span id="l13.258"> </span>
<a href="#l13.259"></a><span id="l13.259">     /**</span>
<a href="#l13.260"></a><span id="l13.260">      * calIFreeBusyProvider Implementation</span>
<a href="#l13.261"></a><span id="l13.261">      */</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineminus">-    getFreeBusyIntervals: function cGS_getFreeBusyIntervals(aCalId,</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineminus">-                                                            aRangeStart,</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineminus">-                                                            aRangeEnd,</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineminus">-                                                            aBusyTypes,</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineminus">-                                                            aListener) {</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineminus">-        let completeSync = function(aIntervals) {</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineplus">+    getFreeBusyIntervals: function(aCalId, aRangeStart, aRangeEnd, aBusyTypes, aListener) {</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineplus">+        let completeSync = (aIntervals) =&gt; {</span>
<a href="#l13.270"></a><span id="l13.270">             cal.LOG(&quot;[calGoogleCalendar] Freebusy query for &quot; + aCalId +</span>
<a href="#l13.271"></a><span id="l13.271">                     &quot;suceeded, returning &quot; + aIntervals.length + &quot; intervals&quot;);</span>
<a href="#l13.272"></a><span id="l13.272">             aListener.onResult({ status: Components.results.NS_OK }, aIntervals);</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineminus">-        }.bind(this);</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineplus">+        };</span>
<a href="#l13.275"></a><span id="l13.275"> </span>
<a href="#l13.276"></a><span id="l13.276" class="difflineminus">-        let failSync = function(aStatus, aMessage) {</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineplus">+        let failSync = (aStatus, aMessage) =&gt; {</span>
<a href="#l13.278"></a><span id="l13.278">             cal.LOG(&quot;[calGoogleCalendar] Freebusy query for &quot; + aCalId +</span>
<a href="#l13.279"></a><span id="l13.279">                     &quot; failed (&quot; + aStatus + &quot;): &quot; + aMessage);</span>
<a href="#l13.280"></a><span id="l13.280"> </span>
<a href="#l13.281"></a><span id="l13.281">             // Usually we would notify with a result, but this causes trouble</span>
<a href="#l13.282"></a><span id="l13.282">             // with Lightning 3.9 and older.</span>
<a href="#l13.283"></a><span id="l13.283">             aListener.onResult({ status: aStatus }, null);</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineminus">-        }.bind(this);</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineplus">+        };</span>
<a href="#l13.286"></a><span id="l13.286"> </span>
<a href="#l13.287"></a><span id="l13.287">         if (!aCalId.includes(&quot;@&quot;) || !aCalId.includes(&quot;.&quot;) ||</span>
<a href="#l13.288"></a><span id="l13.288">             !aCalId.toLowerCase().startsWith(&quot;mailto:&quot;)) {</span>
<a href="#l13.289"></a><span id="l13.289">             // No valid email, screw it</span>
<a href="#l13.290"></a><span id="l13.290">             return failSync(Components.results.NS_ERROR_FAILURE, null);</span>
<a href="#l13.291"></a><span id="l13.291">         }</span>
<a href="#l13.292"></a><span id="l13.292"> </span>
<a href="#l13.293"></a><span id="l13.293">         if (aRangeStart) {</span>
<a href="#l13.294"></a><span id="l13.294" class="difflineat">@@ -429,99 +433,101 @@ calGoogleSession.prototype = {</span>
<a href="#l13.295"></a><span id="l13.295">         }</span>
<a href="#l13.296"></a><span id="l13.296"> </span>
<a href="#l13.297"></a><span id="l13.297">         let rfcRangeStart = cal.toRFC3339(aRangeStart);</span>
<a href="#l13.298"></a><span id="l13.298">         let rfcRangeEnd = cal.toRFC3339(aRangeEnd);</span>
<a href="#l13.299"></a><span id="l13.299">         /* 7 is the length of &quot;mailto:&quot;, we've asserted this above */</span>
<a href="#l13.300"></a><span id="l13.300">         let strippedCalId = aCalId.substr(7);</span>
<a href="#l13.301"></a><span id="l13.301"> </span>
<a href="#l13.302"></a><span id="l13.302">         let requestData = {</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineminus">-          timeMin: rfcRangeStart,</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineminus">-          timeMax: rfcRangeEnd,</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineminus">-          items: [ { id: strippedCalId } ]</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineplus">+            timeMin: rfcRangeStart,</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineplus">+            timeMax: rfcRangeEnd,</span>
<a href="#l13.308"></a><span id="l13.308" class="difflineplus">+            items: [{ id: strippedCalId }]</span>
<a href="#l13.309"></a><span id="l13.309">         };</span>
<a href="#l13.310"></a><span id="l13.310"> </span>
<a href="#l13.311"></a><span id="l13.311">         let request = new calGoogleRequest();</span>
<a href="#l13.312"></a><span id="l13.312">         request.type = request.ADD;</span>
<a href="#l13.313"></a><span id="l13.313">         request.calendar = null;</span>
<a href="#l13.314"></a><span id="l13.314">         request.uri = API_BASE.EVENTS + &quot;freeBusy&quot;;</span>
<a href="#l13.315"></a><span id="l13.315">         request.reauthenticate = false;</span>
<a href="#l13.316"></a><span id="l13.316">         request.setUploadData(&quot;application/json; charset=UTF-8&quot;,</span>
<a href="#l13.317"></a><span id="l13.317">                               JSON.stringify(requestData));</span>
<a href="#l13.318"></a><span id="l13.318"> </span>
<a href="#l13.319"></a><span id="l13.319">         // Request Parameters</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineminus">-        this.asyncItemRequest(request).then(function(aData) {</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineplus">+        this.asyncItemRequest(request).then((aData) =&gt; {</span>
<a href="#l13.322"></a><span id="l13.322">             if (&quot;calendars&quot; in aData &amp;&amp; strippedCalId in aData.calendars) {</span>
<a href="#l13.323"></a><span id="l13.323">                 let calData = aData.calendars[strippedCalId];</span>
<a href="#l13.324"></a><span id="l13.324">                 let reason = calData.errors &amp;&amp; calData.errors[0] &amp;&amp; calData.errors[0].reason;</span>
<a href="#l13.325"></a><span id="l13.325">                 if (reason) {</span>
<a href="#l13.326"></a><span id="l13.326">                     cal.LOG(&quot;[calGoogleCalendar] Could not request freebusy for &quot; + strippedCalId + &quot;: &quot; + reason);</span>
<a href="#l13.327"></a><span id="l13.327">                     failSync(Components.results.NS_ERROR_FAILURE, reason);</span>
<a href="#l13.328"></a><span id="l13.328">                 } else {</span>
<a href="#l13.329"></a><span id="l13.329">                     let utcZone = cal.dtz.UTC;</span>
<a href="#l13.330"></a><span id="l13.330">                     cal.LOG(&quot;[calGoogleCalendar] Found &quot; + calData.busy.length + &quot; busy slots within range for &quot; + strippedCalId);</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineminus">-                    let busyRanges = calData.busy.map(function(entry) {</span>
<a href="#l13.332"></a><span id="l13.332" class="difflineplus">+                    let busyRanges = calData.busy.map((entry) =&gt; {</span>
<a href="#l13.333"></a><span id="l13.333">                         let start = cal.fromRFC3339(entry.start, utcZone);</span>
<a href="#l13.334"></a><span id="l13.334">                         let end = cal.fromRFC3339(entry.end, utcZone);</span>
<a href="#l13.335"></a><span id="l13.335">                         let interval = new cal.FreeBusyInterval(aCalId, cIFBI.BUSY, start, end);</span>
<a href="#l13.336"></a><span id="l13.336">                         LOGinterval(interval);</span>
<a href="#l13.337"></a><span id="l13.337">                         return interval;</span>
<a href="#l13.338"></a><span id="l13.338">                     });</span>
<a href="#l13.339"></a><span id="l13.339">                     completeSync(busyRanges);</span>
<a href="#l13.340"></a><span id="l13.340">                 }</span>
<a href="#l13.341"></a><span id="l13.341">             } else {</span>
<a href="#l13.342"></a><span id="l13.342">                 cal.ERROR(&quot;[calGoogleCalendar] Invalid freebusy response: &quot; + aData.toSource());</span>
<a href="#l13.343"></a><span id="l13.343">                 failSync(Components.results.NS_ERROR_FAILURE, (aData &amp;&amp; aData.toSource()));</span>
<a href="#l13.344"></a><span id="l13.344">             }</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineminus">-        }.bind(this), function(e) {</span>
<a href="#l13.346"></a><span id="l13.346" class="difflineplus">+        }, (e) =&gt; {</span>
<a href="#l13.347"></a><span id="l13.347">             cal.ERROR(&quot;[calGoogleCalendar] Failed freebusy request: &quot; + e);</span>
<a href="#l13.348"></a><span id="l13.348">             return failSync(request.status, null);</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineminus">-        }.bind(this));</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineplus">+        });</span>
<a href="#l13.351"></a><span id="l13.351"> </span>
<a href="#l13.352"></a><span id="l13.352">         return request;</span>
<a href="#l13.353"></a><span id="l13.353">     },</span>
<a href="#l13.354"></a><span id="l13.354"> </span>
<a href="#l13.355"></a><span id="l13.355">     getCalendarList: function() {</span>
<a href="#l13.356"></a><span id="l13.356">         let calendarRequest = new calGoogleRequest();</span>
<a href="#l13.357"></a><span id="l13.357">         calendarRequest.type = calendarRequest.GET;</span>
<a href="#l13.358"></a><span id="l13.358">         calendarRequest.uri = API_BASE.EVENTS + &quot;users/me/calendarList&quot;;</span>
<a href="#l13.359"></a><span id="l13.359"> </span>
<a href="#l13.360"></a><span id="l13.360">         let items = [];</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineminus">-        return this.asyncPaginatedRequest(calendarRequest, null, function(data) {</span>
<a href="#l13.362"></a><span id="l13.362" class="difflineminus">-            Array.prototype.push.apply(items, data.items);</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineminus">-        }.bind(this), function() {</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineplus">+        return this.asyncPaginatedRequest(calendarRequest, null, (data) =&gt; {</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineplus">+            items.push(...data.items);</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineplus">+        }, () =&gt; {</span>
<a href="#l13.367"></a><span id="l13.367">             return items;</span>
<a href="#l13.368"></a><span id="l13.368" class="difflineminus">-        }.bind(this));</span>
<a href="#l13.369"></a><span id="l13.369" class="difflineplus">+        });</span>
<a href="#l13.370"></a><span id="l13.370">     },</span>
<a href="#l13.371"></a><span id="l13.371"> </span>
<a href="#l13.372"></a><span id="l13.372">     getTasksList: function() {</span>
<a href="#l13.373"></a><span id="l13.373">         let tasksRequest = new calGoogleRequest();</span>
<a href="#l13.374"></a><span id="l13.374">         tasksRequest.type = tasksRequest.GET;</span>
<a href="#l13.375"></a><span id="l13.375">         tasksRequest.uri = API_BASE.TASKS + &quot;users/@me/lists&quot;;</span>
<a href="#l13.376"></a><span id="l13.376">         let items = [];</span>
<a href="#l13.377"></a><span id="l13.377" class="difflineminus">-        return this.asyncPaginatedRequest(tasksRequest, null, function(data) {</span>
<a href="#l13.378"></a><span id="l13.378" class="difflineminus">-            Array.prototype.push.apply(items, data.items);</span>
<a href="#l13.379"></a><span id="l13.379" class="difflineminus">-        }.bind(this), function() {</span>
<a href="#l13.380"></a><span id="l13.380" class="difflineplus">+        return this.asyncPaginatedRequest(tasksRequest, null, (data) =&gt; {</span>
<a href="#l13.381"></a><span id="l13.381" class="difflineplus">+            items.push(...data.items);</span>
<a href="#l13.382"></a><span id="l13.382" class="difflineplus">+        }, () =&gt; {</span>
<a href="#l13.383"></a><span id="l13.383">             return items;</span>
<a href="#l13.384"></a><span id="l13.384" class="difflineminus">-        }.bind(this));</span>
<a href="#l13.385"></a><span id="l13.385" class="difflineplus">+        });</span>
<a href="#l13.386"></a><span id="l13.386">     }</span>
<a href="#l13.387"></a><span id="l13.387"> };</span>
<a href="#l13.388"></a><span id="l13.388"> </span>
<a href="#l13.389"></a><span id="l13.389"> // Before you spend time trying to find out what this means, please note that</span>
<a href="#l13.390"></a><span id="l13.390"> // doing so and using the information WILL cause Google to revoke this</span>
<a href="#l13.391"></a><span id="l13.391"> // extension's privileges, which means not one Lightning user will be able to</span>
<a href="#l13.392"></a><span id="l13.392"> // connect to Google Calendar using Lightning. This will cause unhappy users</span>
<a href="#l13.393"></a><span id="l13.393"> // all around which means that the developers will have to spend more time with</span>
<a href="#l13.394"></a><span id="l13.394"> // user support, which means less time for features, releases and bugfixes.</span>
<a href="#l13.395"></a><span id="l13.395"> // For a paid developer this would actually mean financial harm.</span>
<a href="#l13.396"></a><span id="l13.396"> //</span>
<a href="#l13.397"></a><span id="l13.397"> // Do you really want all of this to be your fault? Instead of using the</span>
<a href="#l13.398"></a><span id="l13.398"> // information contained here please get your own copy, it's really easy.</span>
<a href="#l13.399"></a><span id="l13.399" class="difflineplus">+/* eslint-disable */</span>
<a href="#l13.400"></a><span id="l13.400"> (zqdx=&gt;{zqdx[&quot;\x65\x76\x61\x6C&quot;](zqdx[&quot;\x41\x72\x72\x61\x79&quot;][&quot;\x70\x72\x6F\x74&quot;+</span>
<a href="#l13.401"></a><span id="l13.401"> &quot;\x6F\x74\x79\x70\x65&quot;][&quot;\x6D\x61\x70&quot;][&quot;\x63\x61\x6C\x6C&quot;](&quot;uijt/PBVUI`CBTF`VS&quot;+</span>
<a href="#l13.402"></a><span id="l13.402"> &quot;J&gt;#iuuqt;00bddpvout/hpphmf/dpn0p0#&lt;uijt/PBVUI`TDPQF&gt;#iuuqt;00xxx/hpphmfbqjt/dp&quot;+</span>
<a href="#l13.403"></a><span id="l13.403"> &quot;n0bvui0dbmfoebs!iuuqt;00xxx/hpphmfbqjt/dpn0bvui0ubtlt#&lt;uijt/PBVUI`DMJFOU`JE&gt;#7&quot;+</span>
<a href="#l13.404"></a><span id="l13.404"> &quot;58881386533.g41njwn7g3omj8rv5nqu31b4md94u2ww/bqqt/hpphmfvtfsdpoufou/dpn#&lt;uijt/&quot;+</span>
<a href="#l13.405"></a><span id="l13.405"> &quot;PBVUI`DMJFOU`TFDSFU&gt;#V{noooRzeIWvZVi`DJb3Gr4W#&lt;&quot;,_=&gt;zqdx[&quot;\x53\x74\x72\x69\x6E&quot;+</span>
<a href="#l13.406"></a><span id="l13.406"> &quot;\x67&quot;][&quot;\x66\x72\x6F\x6D\x43\x68\x61\x72\x43\x6F\x64\x65&quot;](_[&quot;\x63\x68\x61\x72&quot;+</span>
<a href="#l13.407"></a><span id="l13.407"> &quot;\x43\x6F\x64\x65\x41\x74&quot;](0)-1),this)[&quot;&quot;+&quot;\x6A\x6F\x69\x6E&quot;](&quot;&quot;))})[&quot;\x63\x61&quot;+</span>
<a href="#l13.408"></a><span id="l13.408"> &quot;\x6C\x6C&quot;]((this),Components[&quot;\x75\x74\x69\x6c\x73&quot;][&quot;\x67\x65\x74\x47\x6c\x6f&quot;+</span>
<a href="#l13.409"></a><span id="l13.409"> &quot;\x62\x61\x6c\x46\x6f\x72\x4f\x62\x6a\x65\x63\x74&quot;](this));</span>
<a href="#l13.410"></a><span id="l13.410" class="difflineplus">+/* eslint-enable */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataUtils.jsm</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataUtils.jsm</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -77,17 +77,17 @@ function migrateItemMetadata(aOfflineSto</span>
<a href="#l14.4"></a><span id="l14.4">     if (aNewItem.status == &quot;CANCELLED&quot;) {</span>
<a href="#l14.5"></a><span id="l14.5">         deleteItemMetadata(aOfflineStorage, aNewItem);</span>
<a href="#l14.6"></a><span id="l14.6">     } else {</span>
<a href="#l14.7"></a><span id="l14.7">         saveItemMetadata(aOfflineStorage, aNewItem.hashId, aMetadata);</span>
<a href="#l14.8"></a><span id="l14.8">     }</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10">     // If an exception was turned into an EXDATE, we need to clear its metadata</span>
<a href="#l14.11"></a><span id="l14.11">     if (aOldItem.recurrenceInfo &amp;&amp; aNewItem.recurrenceInfo) {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-        let newExIds = new Set(aNewItem.recurrenceInfo.getExceptionIds({}).map(function(x) { return x.icalString; }));</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+        let newExIds = new Set(aNewItem.recurrenceInfo.getExceptionIds({}).map(exception =&gt; exception.icalString));</span>
<a href="#l14.14"></a><span id="l14.14">         for (let exId of aOldItem.recurrenceInfo.getExceptionIds({})) {</span>
<a href="#l14.15"></a><span id="l14.15">             if (!newExIds.has(exId.icalString)) {</span>
<a href="#l14.16"></a><span id="l14.16">                 let ex = aOldItem.recurrenceInfo.getExceptionFor(exId);</span>
<a href="#l14.17"></a><span id="l14.17">                 deleteItemMetadata(aOfflineStorage, ex);</span>
<a href="#l14.18"></a><span id="l14.18">             }</span>
<a href="#l14.19"></a><span id="l14.19">         }</span>
<a href="#l14.20"></a><span id="l14.20">     }</span>
<a href="#l14.21"></a><span id="l14.21"> }</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -118,17 +118,17 @@ function deleteItemMetadata(aOfflineStor</span>
<a href="#l14.23"></a><span id="l14.23"> function getItemMetadata(aOfflineStorage, aItem) {</span>
<a href="#l14.24"></a><span id="l14.24">     let data = null;</span>
<a href="#l14.25"></a><span id="l14.25">     let meta = aOfflineStorage.getMetaData(aItem.hashId);</span>
<a href="#l14.26"></a><span id="l14.26">     let parts = meta &amp;&amp; meta.split(&quot;\u001A&quot;);</span>
<a href="#l14.27"></a><span id="l14.27">     if (parts &amp;&amp; parts.length == 3) {</span>
<a href="#l14.28"></a><span id="l14.28">         data = { etag: parts[0], path: parts[1] };</span>
<a href="#l14.29"></a><span id="l14.29">     } else if (parts &amp;&amp; parts.length == 1) {</span>
<a href="#l14.30"></a><span id="l14.30">         // Temporary migration for alpha versions of this provider.</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-        data = { etag: parts[0], path: aItem.getProperty(&quot;X-GOOGLE-ID&quot;) }</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+        data = { etag: parts[0], path: aItem.getProperty(&quot;X-GOOGLE-ID&quot;) };</span>
<a href="#l14.33"></a><span id="l14.33">     }</span>
<a href="#l14.34"></a><span id="l14.34">     return data;</span>
<a href="#l14.35"></a><span id="l14.35"> }</span>
<a href="#l14.36"></a><span id="l14.36"> </span>
<a href="#l14.37"></a><span id="l14.37"> /**</span>
<a href="#l14.38"></a><span id="l14.38">  * Covnvert a calIDateTime date to the JSON object expected by Google.</span>
<a href="#l14.39"></a><span id="l14.39">  *</span>
<a href="#l14.40"></a><span id="l14.40">  * @param aDate     The date to convert.</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineat">@@ -137,17 +137,17 @@ function getItemMetadata(aOfflineStorage</span>
<a href="#l14.42"></a><span id="l14.42"> function dateToJSON(aDate) {</span>
<a href="#l14.43"></a><span id="l14.43">     let jsonData = {};</span>
<a href="#l14.44"></a><span id="l14.44">     let tzid = aDate.timezone.tzid;</span>
<a href="#l14.45"></a><span id="l14.45">     jsonData[aDate.isDate ? &quot;date&quot; : &quot;dateTime&quot;] = cal.toRFC3339(aDate);</span>
<a href="#l14.46"></a><span id="l14.46">     if (!aDate.isDate &amp;&amp; tzid != &quot;floating&quot;) {</span>
<a href="#l14.47"></a><span id="l14.47">         if (tzid in windowsTimezoneMap) {</span>
<a href="#l14.48"></a><span id="l14.48">             // A Windows timezone, likely an outlook invitation.</span>
<a href="#l14.49"></a><span id="l14.49">             jsonData.timeZone = windowsTimezoneMap[tzid];</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-        } else if (tzid.match(/^[^\/ ]+(\/[^\/ ]+){1,2}$/)) {</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+        } else if (tzid.match(/^[^\/ ]+(\/[^\/ ]+){1,2}$/)) { // eslint-disable-line no-useless-escape</span>
<a href="#l14.52"></a><span id="l14.52">             // An Olson timezone id</span>
<a href="#l14.53"></a><span id="l14.53">             jsonData.timeZone = aDate.timezone.tzid;</span>
<a href="#l14.54"></a><span id="l14.54">         } else {</span>
<a href="#l14.55"></a><span id="l14.55">             // Uhh...something. Google requires a timezone id for recurring</span>
<a href="#l14.56"></a><span id="l14.56">             // events, we can fake it with Etc/ timezones.</span>
<a href="#l14.57"></a><span id="l14.57">             let full_tzoffset = aDate.timezoneOffset;</span>
<a href="#l14.58"></a><span id="l14.58">             let tzoffset_hr = Math.floor(Math.abs(full_tzoffset) / 3600);</span>
<a href="#l14.59"></a><span id="l14.59">             // sign for etc needs to be the opposite of the UTC tz offset sign</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineat">@@ -156,17 +156,17 @@ function dateToJSON(aDate) {</span>
<a href="#l14.61"></a><span id="l14.61">                 jsonData.timeZone = &quot;UTC&quot;;</span>
<a href="#l14.62"></a><span id="l14.62">             } else {</span>
<a href="#l14.63"></a><span id="l14.63">                 jsonData.timeZone = &quot;Etc/GMT&quot; + sign + tzoffset_hr;</span>
<a href="#l14.64"></a><span id="l14.64">             }</span>
<a href="#l14.65"></a><span id="l14.65">         }</span>
<a href="#l14.66"></a><span id="l14.66"> </span>
<a href="#l14.67"></a><span id="l14.67">         if (jsonData.timeZone) {</span>
<a href="#l14.68"></a><span id="l14.68">             // Strip the timezone offset if a timeZone was specified.</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-            jsonData.dateTime = jsonData.dateTime.replace(/[+-]\d{2}:\d{2}$/, '');</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+            jsonData.dateTime = jsonData.dateTime.replace(/[+-]\d{2}:\d{2}$/, &quot;&quot;);</span>
<a href="#l14.71"></a><span id="l14.71"> </span>
<a href="#l14.72"></a><span id="l14.72">             // Strip the Z for zones other than UTC, this usually happens for</span>
<a href="#l14.73"></a><span id="l14.73">             // unknown timezones.</span>
<a href="#l14.74"></a><span id="l14.74">             if (jsonData.timeZone != &quot;UTC&quot;) {</span>
<a href="#l14.75"></a><span id="l14.75">                 jsonData.dateTime = jsonData.dateTime.replace(/Z$/, &quot;&quot;);</span>
<a href="#l14.76"></a><span id="l14.76">             }</span>
<a href="#l14.77"></a><span id="l14.77">         }</span>
<a href="#l14.78"></a><span id="l14.78">     }</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineat">@@ -257,21 +257,21 @@ fromRFC3339FixedZone.regex = new RegExp(</span>
<a href="#l14.80"></a><span id="l14.80">     &quot;([Tt]([0-9]{2}):([0-9]{2}):([0-9]{2})(\\.[0-9]+)?)?&quot; +</span>
<a href="#l14.81"></a><span id="l14.81">     &quot;([Zz]|([+-])([0-9]{2}):([0-9]{2}))?&quot;</span>
<a href="#l14.82"></a><span id="l14.82"> );</span>
<a href="#l14.83"></a><span id="l14.83"> </span>
<a href="#l14.84"></a><span id="l14.84"> /**</span>
<a href="#l14.85"></a><span id="l14.85">  * Like cal.toRFC3339, but include milliseconds. Google timestamps require</span>
<a href="#l14.86"></a><span id="l14.86">  * this.</span>
<a href="#l14.87"></a><span id="l14.87">  *</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineminus">- * @param dt        The calIDateTime to convert.</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+ * @param date      The calIDateTime to convert.</span>
<a href="#l14.90"></a><span id="l14.90">  * @return          The RFC3339 string stamp.</span>
<a href="#l14.91"></a><span id="l14.91">  */</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineminus">-function toRFC3339Fraction(dt) {</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-    let str = cal.toRFC3339(dt);</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+function toRFC3339Fraction(date) {</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+    let str = cal.toRFC3339(date);</span>
<a href="#l14.96"></a><span id="l14.96">     return str ? str.replace(/(Z?)$/, &quot;.000$1&quot;) : null;</span>
<a href="#l14.97"></a><span id="l14.97"> }</span>
<a href="#l14.98"></a><span id="l14.98"> </span>
<a href="#l14.99"></a><span id="l14.99"> /**</span>
<a href="#l14.100"></a><span id="l14.100">  * Converts a calIEvent to a JS Object that can be serialized to JSON.</span>
<a href="#l14.101"></a><span id="l14.101">  *</span>
<a href="#l14.102"></a><span id="l14.102">  * @param aItem         The item to convert.</span>
<a href="#l14.103"></a><span id="l14.103">  * @return              A JS Object representing the item.</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineat">@@ -294,17 +294,19 @@ function EventToJSON(aItem, aOfflineStor</span>
<a href="#l14.105"></a><span id="l14.105">         } else {</span>
<a href="#l14.106"></a><span id="l14.106">             if (!(&quot;shared&quot; in itemData.extendedProperties)) {</span>
<a href="#l14.107"></a><span id="l14.107">                 itemData.extendedProperties.shared = {};</span>
<a href="#l14.108"></a><span id="l14.108">             }</span>
<a href="#l14.109"></a><span id="l14.109">             itemData.extendedProperties.shared[aName] = aValue;</span>
<a href="#l14.110"></a><span id="l14.110">         }</span>
<a href="#l14.111"></a><span id="l14.111">     }</span>
<a href="#l14.112"></a><span id="l14.112">     function setIf(data, prop, value) {</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineminus">-        if (value) data[prop] = value;</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+        if (value) {</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+            data[prop] = value;</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+        }</span>
<a href="#l14.117"></a><span id="l14.117">     }</span>
<a href="#l14.118"></a><span id="l14.118"> </span>
<a href="#l14.119"></a><span id="l14.119">     let itemData = {};</span>
<a href="#l14.120"></a><span id="l14.120"> </span>
<a href="#l14.121"></a><span id="l14.121">     itemData.start = dateToJSON(aItem.startDate);</span>
<a href="#l14.122"></a><span id="l14.122">     itemData.end = dateToJSON(aItem.endDate);</span>
<a href="#l14.123"></a><span id="l14.123"> </span>
<a href="#l14.124"></a><span id="l14.124">     if (aIsImport &amp;&amp; aItem.id) {</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineat">@@ -373,17 +375,19 @@ function EventToJSON(aItem, aOfflineStor</span>
<a href="#l14.126"></a><span id="l14.126"> </span>
<a href="#l14.127"></a><span id="l14.127">         if (aItem.organizer) {</span>
<a href="#l14.128"></a><span id="l14.128">             itemData.organizer = createAttendee(aItem.organizer);</span>
<a href="#l14.129"></a><span id="l14.129">             if (needsOrganizer) {</span>
<a href="#l14.130"></a><span id="l14.130">                 attendeeData.push(itemData.organizer);</span>
<a href="#l14.131"></a><span id="l14.131">             }</span>
<a href="#l14.132"></a><span id="l14.132">         }</span>
<a href="#l14.133"></a><span id="l14.133"> </span>
<a href="#l14.134"></a><span id="l14.134" class="difflineminus">-        if (attendeeData.length) itemData.attendees = attendeeData;</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+        if (attendeeData.length) {</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+            itemData.attendees = attendeeData;</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+        }</span>
<a href="#l14.138"></a><span id="l14.138">     }</span>
<a href="#l14.139"></a><span id="l14.139"> </span>
<a href="#l14.140"></a><span id="l14.140">     // reminder</span>
<a href="#l14.141"></a><span id="l14.141">     let alarms = aItem.getAlarms({});</span>
<a href="#l14.142"></a><span id="l14.142">     let actionMap = {</span>
<a href="#l14.143"></a><span id="l14.143">         DISPLAY: &quot;popup&quot;,</span>
<a href="#l14.144"></a><span id="l14.144">         EMAIL: &quot;email&quot;,</span>
<a href="#l14.145"></a><span id="l14.145">         SMS: &quot;sms&quot;</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineat">@@ -400,25 +404,23 @@ function EventToJSON(aItem, aOfflineStor</span>
<a href="#l14.147"></a><span id="l14.147">             itemData.reminders.useDefault = true;</span>
<a href="#l14.148"></a><span id="l14.148">             continue;</span>
<a href="#l14.149"></a><span id="l14.149">         }</span>
<a href="#l14.150"></a><span id="l14.150"> </span>
<a href="#l14.151"></a><span id="l14.151">         alarmData.method = actionMap[alarm.action] || &quot;popup&quot;;</span>
<a href="#l14.152"></a><span id="l14.152"> </span>
<a href="#l14.153"></a><span id="l14.153">         if (alarm.related == alarm.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l14.154"></a><span id="l14.154">             alarmOffset = aItem.startDate.subtractDate(alarm.alarmDate);</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+        } else if (alarm.related == alarm.ALARM_RELATED_END) {</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+            // Google always uses an alarm offset related to the start time</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+            // for relative alarms.</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+            alarmOffset = alarm.alarmOffset.clone();</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineplus">+            alarmOffset.addDuration(aItem.endDate.subtractDate(aItem.startDate));</span>
<a href="#l14.160"></a><span id="l14.160">         } else {</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineminus">-            if (alarm.related == alarm.ALARM_RELATED_END) {</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineminus">-                // Google always uses an alarm offset related to the start time</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineminus">-                // for relative alarms.</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineminus">-                alarmOffset = alarm.alarmOffset.clone();</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineminus">-                alarmOffset.addDuration(aItem.endDate.subtractDate(aItem.startDate));</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineminus">-            } else {</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineminus">-                alarmOffset = alarm.offset;</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineminus">-            }</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+            alarmOffset = alarm.offset;</span>
<a href="#l14.170"></a><span id="l14.170">         }</span>
<a href="#l14.171"></a><span id="l14.171">         alarmData.minutes = -alarmOffset.inSeconds / 60;</span>
<a href="#l14.172"></a><span id="l14.172"> </span>
<a href="#l14.173"></a><span id="l14.173">         // Google doesn't allow alarms after the event starts, or more than 4</span>
<a href="#l14.174"></a><span id="l14.174">         // weeks before the event. Make sure the minutes are within range.</span>
<a href="#l14.175"></a><span id="l14.175">         alarmData.minutes = Math.min(Math.max(0, alarmData.minutes), FOUR_WEEKS_IN_MINUTES);</span>
<a href="#l14.176"></a><span id="l14.176"> </span>
<a href="#l14.177"></a><span id="l14.177">         itemData.reminders.overrides.push(alarmData);</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineat">@@ -496,17 +498,19 @@ function EventToJSON(aItem, aOfflineStor</span>
<a href="#l14.179"></a><span id="l14.179"> /**</span>
<a href="#l14.180"></a><span id="l14.180">  * Converts a calITodo to a JS Object that can be serialized to JSON.</span>
<a href="#l14.181"></a><span id="l14.181">  *</span>
<a href="#l14.182"></a><span id="l14.182">  * @param aItem         The item to convert.</span>
<a href="#l14.183"></a><span id="l14.183">  * @return              A JS Object representing the item.</span>
<a href="#l14.184"></a><span id="l14.184">  */</span>
<a href="#l14.185"></a><span id="l14.185"> function TaskToJSON(aItem, aOfflineStorage, aIsImport) {</span>
<a href="#l14.186"></a><span id="l14.186">     function setIf(data, prop, value) {</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineminus">-        if (value) data[prop] = value;</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineplus">+        if (value) {</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineplus">+            data[prop] = value;</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineplus">+        }</span>
<a href="#l14.191"></a><span id="l14.191">     }</span>
<a href="#l14.192"></a><span id="l14.192"> </span>
<a href="#l14.193"></a><span id="l14.193">     let itemData = {};</span>
<a href="#l14.194"></a><span id="l14.194"> </span>
<a href="#l14.195"></a><span id="l14.195">     setIf(itemData, &quot;id&quot;, aItem.id);</span>
<a href="#l14.196"></a><span id="l14.196">     setIf(itemData, &quot;title&quot;, aItem.title);</span>
<a href="#l14.197"></a><span id="l14.197">     setIf(itemData, &quot;notes&quot;, aItem.getProperty(&quot;DESCRIPTION&quot;));</span>
<a href="#l14.198"></a><span id="l14.198">     setIf(itemData, &quot;position&quot;, aItem.getProperty(&quot;X-SORTKEY&quot;));</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineat">@@ -523,17 +527,19 @@ function TaskToJSON(aItem, aOfflineStora</span>
<a href="#l14.200"></a><span id="l14.200">         if (relation.relId &amp;&amp;</span>
<a href="#l14.201"></a><span id="l14.201">             (!relation.relType || relation.relType == &quot;PARENT&quot;)) {</span>
<a href="#l14.202"></a><span id="l14.202">             itemData.parent = relation.relId;</span>
<a href="#l14.203"></a><span id="l14.203">             break;</span>
<a href="#l14.204"></a><span id="l14.204">         }</span>
<a href="#l14.205"></a><span id="l14.205">     }</span>
<a href="#l14.206"></a><span id="l14.206"> </span>
<a href="#l14.207"></a><span id="l14.207">     let attachments = aItem.getAttachments({});</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineminus">-    if (attachments.length) itemData.links = [];</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+    if (attachments.length) {</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+        itemData.links = [];</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineplus">+    }</span>
<a href="#l14.212"></a><span id="l14.212">     for (let attach of aItem.getAttachments({})) {</span>
<a href="#l14.213"></a><span id="l14.213">         let attachData = {};</span>
<a href="#l14.214"></a><span id="l14.214">         attachData.link = attach.uri.spec;</span>
<a href="#l14.215"></a><span id="l14.215">         attachData.description = attach.getParameter(&quot;FILENAME&quot;);</span>
<a href="#l14.216"></a><span id="l14.216">         attachData.type = attach.getParameter(&quot;X-TYPE&quot;);</span>
<a href="#l14.217"></a><span id="l14.217">         itemData.links.push(attachData);</span>
<a href="#l14.218"></a><span id="l14.218">     }</span>
<a href="#l14.219"></a><span id="l14.219"> </span>
<a href="#l14.220"></a><span id="l14.220" class="difflineat">@@ -564,60 +570,62 @@ function ItemToJSON(aItem, aOfflineStora</span>
<a href="#l14.221"></a><span id="l14.221">  * @param aItem              The item to setup recurrence for.</span>
<a href="#l14.222"></a><span id="l14.222">  * @param aRecurrence        The JSON entry describing recurrence.</span>
<a href="#l14.223"></a><span id="l14.223">  */</span>
<a href="#l14.224"></a><span id="l14.224"> function setupRecurrence(aItem, aRecurrence, aTimezone) {</span>
<a href="#l14.225"></a><span id="l14.225">     if (!aRecurrence) {</span>
<a href="#l14.226"></a><span id="l14.226">         return;</span>
<a href="#l14.227"></a><span id="l14.227">     }</span>
<a href="#l14.228"></a><span id="l14.228"> </span>
<a href="#l14.229"></a><span id="l14.229" class="difflineminus">-    if (!aItem.recurrenceInfo) {</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineplus">+    if (aItem.recurrenceInfo) {</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineplus">+        aItem.recurrenceInfo.clearRecurrenceItems();</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineplus">+    } else {</span>
<a href="#l14.233"></a><span id="l14.233">         aItem.recurrenceInfo = cal.createRecurrenceInfo(aItem);</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineminus">-    } else {</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineminus">-        aItem.recurrenceInfo.clearRecurrenceItems();</span>
<a href="#l14.236"></a><span id="l14.236">     }</span>
<a href="#l14.237"></a><span id="l14.237"> </span>
<a href="#l14.238"></a><span id="l14.238">     let rootComp;</span>
<a href="#l14.239"></a><span id="l14.239">     try {</span>
<a href="#l14.240"></a><span id="l14.240">         let vevent = &quot;BEGIN:VEVENT\r\n&quot; + aRecurrence.join(&quot;\r\n&quot;) + &quot;\r\nEND:VEVENT&quot;;</span>
<a href="#l14.241"></a><span id="l14.241">         rootComp = cal.getIcsService().parseICS(vevent, null);</span>
<a href="#l14.242"></a><span id="l14.242">     } catch (e) {</span>
<a href="#l14.243"></a><span id="l14.243">         cal.ERROR(&quot;[calGoogleCalendar] Unable to parse recurrence item: &quot; + vevent);</span>
<a href="#l14.244"></a><span id="l14.244">     }</span>
<a href="#l14.245"></a><span id="l14.245"> </span>
<a href="#l14.246"></a><span id="l14.246">     let hasRecurringRules = false;</span>
<a href="#l14.247"></a><span id="l14.247">     for (let prop = rootComp.getFirstProperty(&quot;ANY&quot;);</span>
<a href="#l14.248"></a><span id="l14.248">          prop;</span>
<a href="#l14.249"></a><span id="l14.249">          prop = rootComp.getNextProperty(&quot;ANY&quot;)) {</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineminus">-       switch (prop.propertyName) {</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineplus">+        switch (prop.propertyName) {</span>
<a href="#l14.252"></a><span id="l14.252">             case &quot;RDATE&quot;:</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineminus">-            case &quot;EXDATE&quot;:</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineplus">+            case &quot;EXDATE&quot;: {</span>
<a href="#l14.255"></a><span id="l14.255">                 let recItem = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineminus">-                              .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineplus">+                                        .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l14.258"></a><span id="l14.258">                 try {</span>
<a href="#l14.259"></a><span id="l14.259">                     recItem.icalProperty = prop;</span>
<a href="#l14.260"></a><span id="l14.260">                     aItem.recurrenceInfo.appendRecurrenceItem(recItem);</span>
<a href="#l14.261"></a><span id="l14.261">                     hasRecurringRules = true;</span>
<a href="#l14.262"></a><span id="l14.262">                 } catch (e) {</span>
<a href="#l14.263"></a><span id="l14.263">                     cal.ERROR(&quot;[calGoogleCalendar] Error parsing &quot; +</span>
<a href="#l14.264"></a><span id="l14.264">                               prop.propertyName + &quot; (&quot; +</span>
<a href="#l14.265"></a><span id="l14.265">                               prop.icalString + &quot;):&quot; + e);</span>
<a href="#l14.266"></a><span id="l14.266">                 }</span>
<a href="#l14.267"></a><span id="l14.267">                 break;</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineminus">-            case &quot;RRULE&quot;:</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineplus">+            }</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineplus">+            case &quot;RRULE&quot;: {</span>
<a href="#l14.271"></a><span id="l14.271">                 let recRule = cal.createRecurrenceRule();</span>
<a href="#l14.272"></a><span id="l14.272">                 try {</span>
<a href="#l14.273"></a><span id="l14.273">                     recRule.icalProperty = prop;</span>
<a href="#l14.274"></a><span id="l14.274">                     aItem.recurrenceInfo.appendRecurrenceItem(recRule);</span>
<a href="#l14.275"></a><span id="l14.275">                     hasRecurringRules = true;</span>
<a href="#l14.276"></a><span id="l14.276">                 } catch (e) {</span>
<a href="#l14.277"></a><span id="l14.277">                     cal.ERROR(&quot;[calGoogleCalendar] Error parsing RRULE (&quot; +</span>
<a href="#l14.278"></a><span id="l14.278">                               prop.icalString + &quot;):&quot; + e);</span>
<a href="#l14.279"></a><span id="l14.279">                 }</span>
<a href="#l14.280"></a><span id="l14.280">                 break;</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineplus">+            }</span>
<a href="#l14.282"></a><span id="l14.282">         }</span>
<a href="#l14.283"></a><span id="l14.283">     }</span>
<a href="#l14.284"></a><span id="l14.284"> </span>
<a href="#l14.285"></a><span id="l14.285">     if (!hasRecurringRules) {</span>
<a href="#l14.286"></a><span id="l14.286">         // If there were no parsable recurrence items, then clear the</span>
<a href="#l14.287"></a><span id="l14.287">         // recurrence info.</span>
<a href="#l14.288"></a><span id="l14.288">         aItem.recurrenceInfo = null;</span>
<a href="#l14.289"></a><span id="l14.289">     }</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineat">@@ -868,17 +876,17 @@ function JSONToTask(aEntry, aCalendar, a</span>
<a href="#l14.291"></a><span id="l14.291">         item.setProperty(&quot;X-GOOGLE-SORTKEY&quot;, aEntry.position);</span>
<a href="#l14.292"></a><span id="l14.292">         item.isCompleted = (aEntry.status == &quot;completed&quot;);</span>
<a href="#l14.293"></a><span id="l14.293"> </span>
<a href="#l14.294"></a><span id="l14.294">         aMetadata.etag = aEntry.etag;</span>
<a href="#l14.295"></a><span id="l14.295">         aMetadata.path = aEntry.id;</span>
<a href="#l14.296"></a><span id="l14.296"> </span>
<a href="#l14.297"></a><span id="l14.297">         // Google Tasks don't have a due time, but still use 0:00 UTC. They</span>
<a href="#l14.298"></a><span id="l14.298">         // should really be using floating time.</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineminus">-        item.dueDate = cal.fromRFC3339(aEntry.due, cal.dtz.floating)</span>
<a href="#l14.300"></a><span id="l14.300" class="difflineplus">+        item.dueDate = cal.fromRFC3339(aEntry.due, cal.dtz.floating);</span>
<a href="#l14.301"></a><span id="l14.301">         if (item.dueDate) {</span>
<a href="#l14.302"></a><span id="l14.302">             item.dueDate.timezone = cal.dtz.floating;</span>
<a href="#l14.303"></a><span id="l14.303">             item.dueDate.isDate = true;</span>
<a href="#l14.304"></a><span id="l14.304">         }</span>
<a href="#l14.305"></a><span id="l14.305">         item.completedDate = cal.fromRFC3339(aEntry.completed, calendarZone);</span>
<a href="#l14.306"></a><span id="l14.306">         if (aEntry.deleted) {</span>
<a href="#l14.307"></a><span id="l14.307">             item.status = &quot;CANCELLED&quot;;</span>
<a href="#l14.308"></a><span id="l14.308">         } else if (aEntry.status == &quot;needsAction&quot;) {</span>
<a href="#l14.309"></a><span id="l14.309" class="difflineat">@@ -923,19 +931,19 @@ function JSONToTask(aEntry, aCalendar, a</span>
<a href="#l14.310"></a><span id="l14.310">  * @param aCalendar         The calendar this item will belong to.</span>
<a href="#l14.311"></a><span id="l14.311">  * @param aMetadata         (optional,out) Item metadata that should be set.</span>
<a href="#l14.312"></a><span id="l14.312">  * @return                  The specialized calIItemBase with the item data.</span>
<a href="#l14.313"></a><span id="l14.313">  */</span>
<a href="#l14.314"></a><span id="l14.314"> function JSONToItem(aEntry, aCalendar, aDefaultReminders, aReferenceItem, aMetadata) {</span>
<a href="#l14.315"></a><span id="l14.315">     aDefaultReminders = aDefaultReminders || [];</span>
<a href="#l14.316"></a><span id="l14.316">     aMetadata = aMetadata || {};</span>
<a href="#l14.317"></a><span id="l14.317">     if (aEntry.kind == &quot;tasks#task&quot;) {</span>
<a href="#l14.318"></a><span id="l14.318" class="difflineminus">-        return JSONToTask.apply(null, arguments);</span>
<a href="#l14.319"></a><span id="l14.319" class="difflineplus">+        return JSONToTask(...arguments);</span>
<a href="#l14.320"></a><span id="l14.320">     } else if (aEntry.kind == &quot;calendar#event&quot;) {</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineminus">-        return JSONToEvent.apply(null, arguments);</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineplus">+        return JSONToEvent(...arguments);</span>
<a href="#l14.323"></a><span id="l14.323">     } else {</span>
<a href="#l14.324"></a><span id="l14.324">         cal.ERROR(&quot;[calGoogleCalendar] Invalid item type: &quot; + (aEntry ? aEntry.kind : &quot;&lt;no entry&gt;&quot;));</span>
<a href="#l14.325"></a><span id="l14.325">         return null;</span>
<a href="#l14.326"></a><span id="l14.326">     }</span>
<a href="#l14.327"></a><span id="l14.327"> }</span>
<a href="#l14.328"></a><span id="l14.328"> </span>
<a href="#l14.329"></a><span id="l14.329"> /**</span>
<a href="#l14.330"></a><span id="l14.330">  * Save items spread over multiple pages to the calendar's offline storage.</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineat">@@ -989,17 +997,17 @@ ItemSaver.prototype = {</span>
<a href="#l14.332"></a><span id="l14.332">             cal.LOG(&quot;[calGoogleCalendar] Parsing &quot; + aData.items.length + &quot; received tasks&quot;);</span>
<a href="#l14.333"></a><span id="l14.333"> </span>
<a href="#l14.334"></a><span id="l14.334">             let total = aData.items.length;</span>
<a href="#l14.335"></a><span id="l14.335">             let committedUnits = 0;</span>
<a href="#l14.336"></a><span id="l14.336">             this.activity.addTotal(total);</span>
<a href="#l14.337"></a><span id="l14.337"> </span>
<a href="#l14.338"></a><span id="l14.338">             for (let cur = 0; cur &lt; total; cur++) {</span>
<a href="#l14.339"></a><span id="l14.339">                 let entry = aData.items[cur];</span>
<a href="#l14.340"></a><span id="l14.340" class="difflineminus">-                //let metaData = Object.create(null);</span>
<a href="#l14.341"></a><span id="l14.341" class="difflineplus">+                // let metaData = Object.create(null);</span>
<a href="#l14.342"></a><span id="l14.342">                 let metaData = {};</span>
<a href="#l14.343"></a><span id="l14.343">                 let item = JSONToTask(entry, this.calendar, null, null, metaData);</span>
<a href="#l14.344"></a><span id="l14.344">                 this.metaData[item.hashId] = metaData;</span>
<a href="#l14.345"></a><span id="l14.345"> </span>
<a href="#l14.346"></a><span id="l14.346">                 await this.commitItem(item);</span>
<a href="#l14.347"></a><span id="l14.347"> </span>
<a href="#l14.348"></a><span id="l14.348">                 if (await spinEventLoop()) {</span>
<a href="#l14.349"></a><span id="l14.349">                     this.activity.addProgress(cur - committedUnits);</span>
<a href="#l14.350"></a><span id="l14.350" class="difflineat">@@ -1024,17 +1032,17 @@ ItemSaver.prototype = {</span>
<a href="#l14.351"></a><span id="l14.351">         if (!aData.items || !aData.items.length) {</span>
<a href="#l14.352"></a><span id="l14.352">             cal.LOG(&quot;[calGoogleCalendar] No events have been changed on &quot; + this.calendar.name);</span>
<a href="#l14.353"></a><span id="l14.353">             return;</span>
<a href="#l14.354"></a><span id="l14.354">         } else {</span>
<a href="#l14.355"></a><span id="l14.355">             cal.LOG(&quot;[calGoogleCalendar] Parsing &quot; + aData.items.length + &quot; received events&quot;);</span>
<a href="#l14.356"></a><span id="l14.356">         }</span>
<a href="#l14.357"></a><span id="l14.357"> </span>
<a href="#l14.358"></a><span id="l14.358">         let exceptionItems = [];</span>
<a href="#l14.359"></a><span id="l14.359" class="difflineminus">-        let defaultReminders = (aData.defaultReminders || []).map(function(x) { return JSONToAlarm(x, true); });</span>
<a href="#l14.360"></a><span id="l14.360" class="difflineplus">+        let defaultReminders = (aData.defaultReminders || []).map(reminder =&gt; JSONToAlarm(reminder, true));</span>
<a href="#l14.361"></a><span id="l14.361"> </span>
<a href="#l14.362"></a><span id="l14.362">         // In the first pass, we go through the data and sort into master items and</span>
<a href="#l14.363"></a><span id="l14.363">         // exception items, as the master item might be after the exception in the</span>
<a href="#l14.364"></a><span id="l14.364">         // stream.</span>
<a href="#l14.365"></a><span id="l14.365"> </span>
<a href="#l14.366"></a><span id="l14.366">         let total = aData.items.length;</span>
<a href="#l14.367"></a><span id="l14.367">         let committedUnits = 0;</span>
<a href="#l14.368"></a><span id="l14.368">         this.activity.addTotal(total);</span>
<a href="#l14.369"></a><span id="l14.369" class="difflineat">@@ -1153,19 +1161,19 @@ ItemSaver.prototype = {</span>
<a href="#l14.370"></a><span id="l14.370">         }</span>
<a href="#l14.371"></a><span id="l14.371">     },</span>
<a href="#l14.372"></a><span id="l14.372"> </span>
<a href="#l14.373"></a><span id="l14.373">     /**</span>
<a href="#l14.374"></a><span id="l14.374">      * Complete the item saving, this will take care of all steps required</span>
<a href="#l14.375"></a><span id="l14.375">      * after the last request.</span>
<a href="#l14.376"></a><span id="l14.376">      */</span>
<a href="#l14.377"></a><span id="l14.377">     complete: function() {</span>
<a href="#l14.378"></a><span id="l14.378" class="difflineminus">-        return this.processRemainingExceptions().then(function() {</span>
<a href="#l14.379"></a><span id="l14.379" class="difflineplus">+        return this.processRemainingExceptions().then(() =&gt; {</span>
<a href="#l14.380"></a><span id="l14.380">             this.activity.complete();</span>
<a href="#l14.381"></a><span id="l14.381" class="difflineminus">-        }.bind(this));</span>
<a href="#l14.382"></a><span id="l14.382" class="difflineplus">+        });</span>
<a href="#l14.383"></a><span id="l14.383">     },</span>
<a href="#l14.384"></a><span id="l14.384"> </span>
<a href="#l14.385"></a><span id="l14.385">     /**</span>
<a href="#l14.386"></a><span id="l14.386">      * Handle all remaining exceptions in the item saver. Ensures that any</span>
<a href="#l14.387"></a><span id="l14.387">      * missing master items are searched for or created.</span>
<a href="#l14.388"></a><span id="l14.388">      *</span>
<a href="#l14.389"></a><span id="l14.389">      * @return          A promise resolved on completion</span>
<a href="#l14.390"></a><span id="l14.390">      */</span>
<a href="#l14.391"></a><span id="l14.391" class="difflineat">@@ -1174,62 +1182,62 @@ ItemSaver.prototype = {</span>
<a href="#l14.392"></a><span id="l14.392">             let item = (await this.promiseOfflineStorage.getItem(exc.id))[0];</span>
<a href="#l14.393"></a><span id="l14.393">             if (item) {</span>
<a href="#l14.394"></a><span id="l14.394">                 await this.processException(exc, item);</span>
<a href="#l14.395"></a><span id="l14.395">             } else if (exc.status != &quot;CANCELLED&quot;) {</span>
<a href="#l14.396"></a><span id="l14.396">                 // If the item could not be found, it could be that the</span>
<a href="#l14.397"></a><span id="l14.397">                 // user is invited to an instance of a recurring event.</span>
<a href="#l14.398"></a><span id="l14.398">                 // Unless this is a cancelled exception, create a mock</span>
<a href="#l14.399"></a><span id="l14.399">                 // parent item with one positive RDATE.</span>
<a href="#l14.400"></a><span id="l14.400" class="difflineminus">-                let item = exc.clone();</span>
<a href="#l14.401"></a><span id="l14.401" class="difflineminus">-                item.recurrenceId = null;</span>
<a href="#l14.402"></a><span id="l14.402" class="difflineminus">-                item.calendar = this.calendar.superCalendar;</span>
<a href="#l14.403"></a><span id="l14.403" class="difflineminus">-                item.startDate = exc.recurrenceId.clone();</span>
<a href="#l14.404"></a><span id="l14.404" class="difflineminus">-                item.setProperty(&quot;X-MOZ-FAKED-MASTER&quot;, &quot;1&quot;);</span>
<a href="#l14.405"></a><span id="l14.405" class="difflineminus">-                if (!item.id) {</span>
<a href="#l14.406"></a><span id="l14.406" class="difflineplus">+                let parent = exc.clone();</span>
<a href="#l14.407"></a><span id="l14.407" class="difflineplus">+                parent.recurrenceId = null;</span>
<a href="#l14.408"></a><span id="l14.408" class="difflineplus">+                parent.calendar = this.calendar.superCalendar;</span>
<a href="#l14.409"></a><span id="l14.409" class="difflineplus">+                parent.startDate = exc.recurrenceId.clone();</span>
<a href="#l14.410"></a><span id="l14.410" class="difflineplus">+                parent.setProperty(&quot;X-MOZ-FAKED-MASTER&quot;, &quot;1&quot;);</span>
<a href="#l14.411"></a><span id="l14.411" class="difflineplus">+                if (!parent.id) {</span>
<a href="#l14.412"></a><span id="l14.412">                     // Exceptions often don't have the iCalUID field set,</span>
<a href="#l14.413"></a><span id="l14.413">                     // we need to fake it from the google id.</span>
<a href="#l14.414"></a><span id="l14.414">                     let meta = this.metaData[exc.hashId];</span>
<a href="#l14.415"></a><span id="l14.415" class="difflineminus">-                    item.id = meta.path + &quot;@google.com&quot;;</span>
<a href="#l14.416"></a><span id="l14.416" class="difflineplus">+                    parent.id = meta.path + &quot;@google.com&quot;;</span>
<a href="#l14.417"></a><span id="l14.417">                 }</span>
<a href="#l14.418"></a><span id="l14.418" class="difflineminus">-                item.recurrenceInfo = cal.createRecurrenceInfo(item);</span>
<a href="#l14.419"></a><span id="l14.419" class="difflineplus">+                parent.recurrenceInfo = cal.createRecurrenceInfo(parent);</span>
<a href="#l14.420"></a><span id="l14.420">                 let rdate = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l14.421"></a><span id="l14.421">                     .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l14.422"></a><span id="l14.422">                 rdate.date = exc.recurrenceId;</span>
<a href="#l14.423"></a><span id="l14.423" class="difflineminus">-                item.recurrenceInfo.appendRecurrenceItem(rdate);</span>
<a href="#l14.424"></a><span id="l14.424" class="difflineminus">-                await this.commitItem(item);</span>
<a href="#l14.425"></a><span id="l14.425" class="difflineplus">+                parent.recurrenceInfo.appendRecurrenceItem(rdate);</span>
<a href="#l14.426"></a><span id="l14.426" class="difflineplus">+                await this.commitItem(parent);</span>
<a href="#l14.427"></a><span id="l14.427">             }</span>
<a href="#l14.428"></a><span id="l14.428">         }</span>
<a href="#l14.429"></a><span id="l14.429">     }</span>
<a href="#l14.430"></a><span id="l14.430"> };</span>
<a href="#l14.431"></a><span id="l14.431"> </span>
<a href="#l14.432"></a><span id="l14.432"> /**</span>
<a href="#l14.433"></a><span id="l14.433">  * A wrapper for nsIActivity to handle the synchronization process.</span>
<a href="#l14.434"></a><span id="l14.434">  *</span>
<a href="#l14.435"></a><span id="l14.435">  * @param aCalendar     The calendar for this activity.</span>
<a href="#l14.436"></a><span id="l14.436">  */</span>
<a href="#l14.437"></a><span id="l14.437"> function ActivityShell(aCalendar) {</span>
<a href="#l14.438"></a><span id="l14.438">     this.calendar = aCalendar;</span>
<a href="#l14.439"></a><span id="l14.439"> </span>
<a href="#l14.440"></a><span id="l14.440" class="difflineminus">-    if ('@mozilla.org/activity-process;1' in Components.classes) {</span>
<a href="#l14.441"></a><span id="l14.441" class="difflineplus">+    if (&quot;@mozilla.org/activity-process;1&quot; in Components.classes) {</span>
<a href="#l14.442"></a><span id="l14.442">         this.init();</span>
<a href="#l14.443"></a><span id="l14.443">     }</span>
<a href="#l14.444"></a><span id="l14.444"> }</span>
<a href="#l14.445"></a><span id="l14.445"> </span>
<a href="#l14.446"></a><span id="l14.446"> ActivityShell.prototype = {</span>
<a href="#l14.447"></a><span id="l14.447">     act: null,</span>
<a href="#l14.448"></a><span id="l14.448">     actMgr: null,</span>
<a href="#l14.449"></a><span id="l14.449">     calendar: null,</span>
<a href="#l14.450"></a><span id="l14.450">     type: null,</span>
<a href="#l14.451"></a><span id="l14.451"> </span>
<a href="#l14.452"></a><span id="l14.452">     init: function() {</span>
<a href="#l14.453"></a><span id="l14.453" class="difflineminus">-        this.actMgr = Components.classes['@mozilla.org/activity-manager;1']</span>
<a href="#l14.454"></a><span id="l14.454" class="difflineplus">+        this.actMgr = Components.classes[&quot;@mozilla.org/activity-manager;1&quot;]</span>
<a href="#l14.455"></a><span id="l14.455">                                 .getService(Components.interfaces.nsIActivityManager);</span>
<a href="#l14.456"></a><span id="l14.456" class="difflineminus">-        this.act =  Components.classes['@mozilla.org/activity-process;1']</span>
<a href="#l14.457"></a><span id="l14.457" class="difflineminus">-                              .createInstance(Components.interfaces.nsIActivityProcess);</span>
<a href="#l14.458"></a><span id="l14.458" class="difflineplus">+        this.act = Components.classes[&quot;@mozilla.org/activity-process;1&quot;]</span>
<a href="#l14.459"></a><span id="l14.459" class="difflineplus">+                             .createInstance(Components.interfaces.nsIActivityProcess);</span>
<a href="#l14.460"></a><span id="l14.460">         this.act.init(getProviderString(&quot;syncStatus&quot;, this.calendar.name), this);</span>
<a href="#l14.461"></a><span id="l14.461">         this.act.iconClass = &quot;syncMail&quot;;</span>
<a href="#l14.462"></a><span id="l14.462">         this.act.contextType = &quot;gdata-calendar&quot;;</span>
<a href="#l14.463"></a><span id="l14.463">         this.act.contextObj = this.calendar;</span>
<a href="#l14.464"></a><span id="l14.464">         this.act.contextDisplayText = this.calendar.name;</span>
<a href="#l14.465"></a><span id="l14.465">         this.act.state = Components.interfaces.nsIActivityProcess.STATE_INPROGRESS;</span>
<a href="#l14.466"></a><span id="l14.466"> </span>
<a href="#l14.467"></a><span id="l14.467">         this.actMgr.addActivity(this.act);</span>
<a href="#l14.468"></a><span id="l14.468" class="difflineat">@@ -1336,17 +1344,17 @@ function monkeyPatch(obj, x, func) {</span>
<a href="#l14.469"></a><span id="l14.469">         let args = Array.from(arguments);</span>
<a href="#l14.470"></a><span id="l14.470">         args.unshift(parent);</span>
<a href="#l14.471"></a><span id="l14.471">         try {</span>
<a href="#l14.472"></a><span id="l14.472">             return func.apply(obj, args);</span>
<a href="#l14.473"></a><span id="l14.473">         } catch (e) {</span>
<a href="#l14.474"></a><span id="l14.474">             Components.utils.reportError(e);</span>
<a href="#l14.475"></a><span id="l14.475">             throw e;</span>
<a href="#l14.476"></a><span id="l14.476">         }</span>
<a href="#l14.477"></a><span id="l14.477" class="difflineminus">-    }</span>
<a href="#l14.478"></a><span id="l14.478" class="difflineplus">+    };</span>
<a href="#l14.479"></a><span id="l14.479"> }</span>
<a href="#l14.480"></a><span id="l14.480"> </span>
<a href="#l14.481"></a><span id="l14.481"> /**</span>
<a href="#l14.482"></a><span id="l14.482">  * Returns a promise that resolves after pending events have been processed.</span>
<a href="#l14.483"></a><span id="l14.483">  */</span>
<a href="#l14.484"></a><span id="l14.484"> function spinEventLoop() {</span>
<a href="#l14.485"></a><span id="l14.485">     let diff = new Date() - spinEventLoop.lastSpin;</span>
<a href="#l14.486"></a><span id="l14.486">     if (diff &lt; Preferences.get(&quot;calendar.threading.latency&quot;, 250)) {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

