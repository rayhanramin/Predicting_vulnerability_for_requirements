<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 10650:42fdd61be0bada487b16cc7a20b7dae530ec2a20</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 42fdd61be0bada487b16cc7a20b7dae530ec2a20" />
<meta property="og:url" content="/comm-central/rev/42fdd61be0bada487b16cc7a20b7dae530ec2a20" />
<meta property="og:description" content="Bug 765575 - Yousendit fails on some non-ASCII attachments. r=mconley" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 42fdd61be0bada487b16cc7a20b7dae530ec2a20 &#x2620;
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/42fdd61be0bada487b16cc7a20b7dae530ec2a20">shortlog</a> |
<a href="/comm-central/log/42fdd61be0bada487b16cc7a20b7dae530ec2a20">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/42fdd61be0bada487b16cc7a20b7dae530ec2a20">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/42fdd61be0bada487b16cc7a20b7dae530ec2a20">files</a> |
changeset |
<a href="/comm-central/raw-rev/42fdd61be0bada487b16cc7a20b7dae530ec2a20">raw</a>  | <a href="/comm-central/archive/42fdd61be0bada487b16cc7a20b7dae530ec2a20.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=765575">Bug 765575</a> - Yousendit fails on some non-ASCII attachments. r=mconley
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">
<tr><td colspan="2" style="background:#ff3333;"><strong>&#x2620;&#x2620; backed out by <a style="font-family: monospace" href="/comm-central/rev/85c33a9e9f46">85c33a9e9f46</a> &#x2620; &#x2620;</strong></td></tr>
<tr><td>author</td><td>&#77;&#97;&#120;&#105;&#109;&#32;&#66;&#97;&#122;&#32;&#60;&#109;&#98;&#97;&#122;&#64;&#99;&#111;&#100;&#101;&#109;&#105;&#110;&#100;&#101;&#114;&#115;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 13 Jul 2012 20:52:20 -0400</td></tr>

<tr>
 <td>changeset 10650</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/42fdd61be0bada487b16cc7a20b7dae530ec2a20">42fdd61be0bada487b16cc7a20b7dae530ec2a20</a></td>
</tr>



<tr>
<td>parent 10649</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/736f08622ee9a6f40963f96d380a50cb5bf30cc0">736f08622ee9a6f40963f96d380a50cb5bf30cc0</a>
</td>
</tr>

<tr>
<td>child 10651</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/85c33a9e9f4684f5ee72e5504223ed711b6cc7c5">85c33a9e9f4684f5ee72e5504223ed711b6cc7c5</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=42fdd61be0bada487b16cc7a20b7dae530ec2a20">8036</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 14 Jul 2012 00:54:01 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@42fdd61be0ba [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=42fdd61be0bada487b16cc7a20b7dae530ec2a20">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=42fdd61be0bada487b16cc7a20b7dae530ec2a20&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=42fdd61be0bada487b16cc7a20b7dae530ec2a20&newProject=comm-central&newRevision=42fdd61be0bada487b16cc7a20b7dae530ec2a20&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=42fdd61be0bada487b16cc7a20b7dae530ec2a20&newProject=comm-central&newRevision=42fdd61be0bada487b16cc7a20b7dae530ec2a20&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=42fdd61be0bada487b16cc7a20b7dae530ec2a20&newProject=comm-central&newRevision=42fdd61be0bada487b16cc7a20b7dae530ec2a20&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mconley%29&revcount=50">mconley</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=765575">765575</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=765575">Bug 765575</a> - Yousendit fails on some non-ASCII attachments. r=mconley</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/42fdd61be0bada487b16cc7a20b7dae530ec2a20/mail/components/cloudfile/nsYouSendIt.js">mail/components/cloudfile/nsYouSendIt.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/42fdd61be0bada487b16cc7a20b7dae530ec2a20/mail/components/cloudfile/nsYouSendIt.js">file</a> |
<a href="/comm-central/annotate/42fdd61be0bada487b16cc7a20b7dae530ec2a20/mail/components/cloudfile/nsYouSendIt.js">annotate</a> |
<a href="/comm-central/diff/42fdd61be0bada487b16cc7a20b7dae530ec2a20/mail/components/cloudfile/nsYouSendIt.js">diff</a> |
<a href="/comm-central/comparison/42fdd61be0bada487b16cc7a20b7dae530ec2a20/mail/components/cloudfile/nsYouSendIt.js">comparison</a> |
<a href="/comm-central/log/42fdd61be0bada487b16cc7a20b7dae530ec2a20/mail/components/cloudfile/nsYouSendIt.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/42fdd61be0bada487b16cc7a20b7dae530ec2a20/mail/test/mozmill/cloudfile/data/%E2%88%80.eml">mail/test/mozmill/cloudfile/data/âˆ€.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/42fdd61be0bada487b16cc7a20b7dae530ec2a20/mail/test/mozmill/cloudfile/data/%E2%88%80.eml">file</a> |
<a href="/comm-central/annotate/42fdd61be0bada487b16cc7a20b7dae530ec2a20/mail/test/mozmill/cloudfile/data/%E2%88%80.eml">annotate</a> |
<a href="/comm-central/diff/42fdd61be0bada487b16cc7a20b7dae530ec2a20/mail/test/mozmill/cloudfile/data/%E2%88%80.eml">diff</a> |
<a href="/comm-central/comparison/42fdd61be0bada487b16cc7a20b7dae530ec2a20/mail/test/mozmill/cloudfile/data/%E2%88%80.eml">comparison</a> |
<a href="/comm-central/log/42fdd61be0bada487b16cc7a20b7dae530ec2a20/mail/test/mozmill/cloudfile/data/%E2%88%80.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/42fdd61be0bada487b16cc7a20b7dae530ec2a20/mail/test/mozmill/cloudfile/test-cloudfile-backend-yousendit.js">mail/test/mozmill/cloudfile/test-cloudfile-backend-yousendit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/42fdd61be0bada487b16cc7a20b7dae530ec2a20/mail/test/mozmill/cloudfile/test-cloudfile-backend-yousendit.js">file</a> |
<a href="/comm-central/annotate/42fdd61be0bada487b16cc7a20b7dae530ec2a20/mail/test/mozmill/cloudfile/test-cloudfile-backend-yousendit.js">annotate</a> |
<a href="/comm-central/diff/42fdd61be0bada487b16cc7a20b7dae530ec2a20/mail/test/mozmill/cloudfile/test-cloudfile-backend-yousendit.js">diff</a> |
<a href="/comm-central/comparison/42fdd61be0bada487b16cc7a20b7dae530ec2a20/mail/test/mozmill/cloudfile/test-cloudfile-backend-yousendit.js">comparison</a> |
<a href="/comm-central/log/42fdd61be0bada487b16cc7a20b7dae530ec2a20/mail/test/mozmill/cloudfile/test-cloudfile-backend-yousendit.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/cloudfile/nsYouSendIt.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/cloudfile/nsYouSendIt.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1015,19 +1015,23 @@ nsYouSendItFileUploader.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">     let boundary = &quot;------&quot; + curDate;</span>
<a href="#l1.5"></a><span id="l1.5">     let contentType = &quot;multipart/form-data; boundary=&quot;+ boundary;</span>
<a href="#l1.6"></a><span id="l1.6">     req.setRequestHeader(&quot;Content-Type&quot;, contentType);</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">     let fileContents = &quot;--&quot; + boundary +</span>
<a href="#l1.9"></a><span id="l1.9">       &quot;\r\nContent-Disposition: form-data; name=\&quot;bid\&quot;\r\n\r\n&quot; +</span>
<a href="#l1.10"></a><span id="l1.10">        this._urlInfo.fileId;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+    let fileName = /^[\040-\176]+$/.test(this.file.leafName) </span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+        ? this.file.leafName </span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+        : encodeURIComponent(this.file.leafName);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+</span>
<a href="#l1.16"></a><span id="l1.16">     fileContents += &quot;\r\n--&quot; + boundary +</span>
<a href="#l1.17"></a><span id="l1.17">       &quot;\r\nContent-Disposition: form-data; name=\&quot;fname\&quot;; filename=\&quot;&quot; +</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-      this.file.leafName + &quot;\&quot;\r\nContent-Type: application/octet-stream&quot; +</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+      fileName + &quot;\&quot;\r\nContent-Type: application/octet-stream&quot; +</span>
<a href="#l1.20"></a><span id="l1.20">       &quot;\r\n\r\n&quot;;</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22">     // Since js doesn't like binary data in strings, we're going to create</span>
<a href="#l1.23"></a><span id="l1.23">     // a temp file consisting of the message preamble, the file contents, and</span>
<a href="#l1.24"></a><span id="l1.24">     // the post script, and pass a stream based on that file to</span>
<a href="#l1.25"></a><span id="l1.25">     // nsIXMLHttpRequest.send().</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27">     try {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/data/âˆ€.eml</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+Ullamco farm-to-table banh mi, echo park dolor lomo chillwave seitan cred ad mustache 3 wolf moon excepteur. Odd future placeat sint, cliche consequat portland banksy vinyl 3 wolf moon high life you probably haven't heard of them nisi jean shorts. Eu freegan skateboard, kogi etsy beard aliquip blog sapiente pour-over sunt. Cosby sweater jean shorts wayfarers keytar trust fund, four loko pitchfork pinterest forage semiotics lo-fi cray beard swag butcher. Odd future cred swag, pork belly keytar velit terry richardson locavore id brunch excepteur commodo occupy mollit pickled. Street art voluptate pickled fap, ad craft beer cupidatat messenger bag placeat helvetica. Enim raw denim occupy pork belly irure et.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-backend-yousendit.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-backend-yousendit.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -316,8 +316,37 @@ function test_bug771132_fix_no_scheme() </span>
<a href="#l3.4"></a><span id="l3.4">   gServer.planForGetFileURL(&quot;testFile1&quot;, {url: kExpectedUrl});</span>
<a href="#l3.5"></a><span id="l3.5">   requestObserver = gObsManager.create(&quot;test_simple_case - Upload 2&quot;);</span>
<a href="#l3.6"></a><span id="l3.6">   provider.uploadFile(file, requestObserver);</span>
<a href="#l3.7"></a><span id="l3.7">   mc.waitFor(function () requestObserver.success);</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9">   urlForFile = provider.urlForFile(file);</span>
<a href="#l3.10"></a><span id="l3.10">   assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l3.11"></a><span id="l3.11"> }</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+/**</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+ * Test for bug 765575 - if Yousendit fails on some non-ASCII attachments</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+ */</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+function test_bug765575_fix_non_ascii() {</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+  const kExpectedUrl = &quot;http://www.example.com/expectedUrl&quot;;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+  const kTopics = [kUploadFile, kGetFileURL];</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+  gServer.planForUploadFile(&quot;%E2%88%80.eml&quot;);</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+  gServer.planForGetFileURL(&quot;%E2%88%80.eml&quot;, {url: kExpectedUrl});</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+  let obs = new ObservationRecorder();</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+  for each (let [, topic] in Iterator(kTopics)) {</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+    obs.planFor(topic);</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+    Services.obs.addObserver(obs, topic, false);</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+  }</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  let requestObserver = gObsManager.create(&quot;test_simple_case - Upload 1&quot;);</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  let file = getFile(&quot;./data/âˆ€.eml&quot;, __file__);</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  provider.uploadFile(file, requestObserver);</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+  mc.waitFor(function () requestObserver.success);</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  let urlForFile = provider.urlForFile(file);</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  assert_equals(1, obs.numSightings(kUploadFile));</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  assert_equals(1, obs.numSightings(kGetFileURL));</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

