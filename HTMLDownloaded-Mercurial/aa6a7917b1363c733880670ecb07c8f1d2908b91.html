<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 12209:aa6a7917b1363c733880670ecb07c8f1d2908b91</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ aa6a7917b1363c733880670ecb07c8f1d2908b91" />
<meta property="og:url" content="/comm-central/rev/aa6a7917b1363c733880670ecb07c8f1d2908b91" />
<meta property="og:description" content="Bug 824150 - Code cleanup in /mail/ and /mailnews/: Use new String methods like startsWith, endsWith, contains, remaining Services.jsm switches and querySelector use instead of NodeList calls: message window. r=mconley" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / aa6a7917b1363c733880670ecb07c8f1d2908b91 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/aa6a7917b1363c733880670ecb07c8f1d2908b91">shortlog</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/aa6a7917b1363c733880670ecb07c8f1d2908b91">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91">files</a> |
changeset |
<a href="/comm-central/raw-rev/aa6a7917b1363c733880670ecb07c8f1d2908b91">raw</a>  | <a href="/comm-central/archive/aa6a7917b1363c733880670ecb07c8f1d2908b91.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=824150">Bug 824150</a> - Code cleanup in /mail/ and /mailnews/: Use new String methods like startsWith, endsWith, contains, remaining Services.jsm switches and querySelector use instead of NodeList calls: message window. r=mconley
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#101;&#98;&#97;&#115;&#116;&#105;&#97;&#110;&#32;&#72;&#101;&#110;&#103;&#115;&#116;&#32;&#60;&#97;&#114;&#99;&#104;&#97;&#101;&#111;&#112;&#116;&#101;&#114;&#121;&#120;&#64;&#99;&#111;&#111;&#108;&#101;&#45;&#102;&#105;&#108;&#101;&#115;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 26 Mar 2013 19:57:11 +0100</td></tr>

<tr>
 <td>changeset 12209</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/aa6a7917b1363c733880670ecb07c8f1d2908b91">aa6a7917b1363c733880670ecb07c8f1d2908b91</a></td>
</tr>



<tr>
<td>parent 12208</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f6096640502692ffa2cd70a41373d00084d4454d">f6096640502692ffa2cd70a41373d00084d4454d</a>
</td>
</tr>

<tr>
<td>child 12210</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ab8cfe8058f8811b276db2d90bae1132932c98bc">ab8cfe8058f8811b276db2d90bae1132932c98bc</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=aa6a7917b1363c733880670ecb07c8f1d2908b91">9041</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 27 Mar 2013 14:39:12 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@ab8cfe8058f8 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ab8cfe8058f8811b276db2d90bae1132932c98bc">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ab8cfe8058f8811b276db2d90bae1132932c98bc&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ab8cfe8058f8811b276db2d90bae1132932c98bc&newProject=comm-central&newRevision=2775bb72271a4008fa44a376d470a98df827e7c6&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ab8cfe8058f8811b276db2d90bae1132932c98bc&newProject=comm-central&newRevision=2775bb72271a4008fa44a376d470a98df827e7c6&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ab8cfe8058f8811b276db2d90bae1132932c98bc&newProject=comm-central&newRevision=2775bb72271a4008fa44a376d470a98df827e7c6&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mconley%29&revcount=50">mconley</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=824150">824150</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=824150">Bug 824150</a> - Code cleanup in /mail/ and /mailnews/: Use new String methods like startsWith, endsWith, contains, remaining Services.jsm switches and querySelector use instead of NodeList calls: message window. r=mconley</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/contentAreaClick.js">mail/base/content/contentAreaClick.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/contentAreaClick.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/contentAreaClick.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/contentAreaClick.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/contentAreaClick.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/contentAreaClick.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/folderPane.js">mail/base/content/folderPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/folderPane.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/folderPane.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/folderPane.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/folderPane.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/folderPane.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/mailCore.js">mail/base/content/mailCore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/mailCore.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/mailCore.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/mailCore.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/mailCore.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/mailCore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/mailWindow.js">mail/base/content/mailWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/mailWindow.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/mailWindow.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/mailWindow.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/mailWindow.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/mailWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/msgHdrViewOverlay.js">mail/base/content/msgHdrViewOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/msgHdrViewOverlay.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/msgHdrViewOverlay.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/msgHdrViewOverlay.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/msgHdrViewOverlay.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/msgHdrViewOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/msgMail3PaneWindow.js">mail/base/content/msgMail3PaneWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/msgMail3PaneWindow.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/msgMail3PaneWindow.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/msgMail3PaneWindow.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/msgMail3PaneWindow.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/msgMail3PaneWindow.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/nsContextMenu.js">mail/base/content/nsContextMenu.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/nsContextMenu.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/nsContextMenu.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/nsContextMenu.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/nsContextMenu.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/nsContextMenu.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/phishingDetector.js">mail/base/content/phishingDetector.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/phishingDetector.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/phishingDetector.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/phishingDetector.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/phishingDetector.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/phishingDetector.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/selectionsummaries.js">mail/base/content/selectionsummaries.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/selectionsummaries.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/selectionsummaries.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/selectionsummaries.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/selectionsummaries.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/selectionsummaries.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/specialTabs.js">mail/base/content/specialTabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/specialTabs.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/specialTabs.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/specialTabs.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/specialTabs.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/specialTabs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/webSearchTab.js">mail/base/content/webSearchTab.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/webSearchTab.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/webSearchTab.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/webSearchTab.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/webSearchTab.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/base/content/webSearchTab.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/extensions/mailviews/content/msgViewPickerOverlay.js">mail/extensions/mailviews/content/msgViewPickerOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/extensions/mailviews/content/msgViewPickerOverlay.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/extensions/mailviews/content/msgViewPickerOverlay.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/extensions/mailviews/content/msgViewPickerOverlay.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/extensions/mailviews/content/msgViewPickerOverlay.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/extensions/mailviews/content/msgViewPickerOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/content-policy/test-dns-prefetch.js">mail/test/mozmill/content-policy/test-dns-prefetch.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/content-policy/test-dns-prefetch.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/content-policy/test-dns-prefetch.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/content-policy/test-dns-prefetch.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/content-policy/test-dns-prefetch.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/content-policy/test-dns-prefetch.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/content-tabs/test-content-tab.js">mail/test/mozmill/content-tabs/test-content-tab.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/content-tabs/test-content-tab.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/content-tabs/test-content-tab.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/content-tabs/test-content-tab.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/content-tabs/test-content-tab.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/content-tabs/test-content-tab.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/folder-display/test-message-commands.js">mail/test/mozmill/folder-display/test-message-commands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/folder-display/test-message-commands.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/folder-display/test-message-commands.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/folder-display/test-message-commands.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/folder-display/test-message-commands.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/folder-display/test-message-commands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/folder-display/test-summarization.js">mail/test/mozmill/folder-display/test-summarization.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/folder-display/test-summarization.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/folder-display/test-summarization.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/folder-display/test-summarization.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/folder-display/test-summarization.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/folder-display/test-summarization.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/folder-display/test-tooltip-multimessage.js">mail/test/mozmill/folder-display/test-tooltip-multimessage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/folder-display/test-tooltip-multimessage.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/folder-display/test-tooltip-multimessage.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/folder-display/test-tooltip-multimessage.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/folder-display/test-tooltip-multimessage.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/folder-display/test-tooltip-multimessage.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-message-header.js">mail/test/mozmill/message-header/test-message-header.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-message-header.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-message-header.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-message-header.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-message-header.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-message-header.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-phishing-bar.js">mail/test/mozmill/message-header/test-phishing-bar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-phishing-bar.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-phishing-bar.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-phishing-bar.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-phishing-bar.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-phishing-bar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-reply-identity.js">mail/test/mozmill/message-header/test-reply-identity.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-reply-identity.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-reply-identity.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-reply-identity.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-reply-identity.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-reply-identity.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-return-receipt.js">mail/test/mozmill/message-header/test-return-receipt.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-return-receipt.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-return-receipt.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-return-receipt.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-return-receipt.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/message-header/test-return-receipt.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/session-store/test-session-store.js">mail/test/mozmill/session-store/test-session-store.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/session-store/test-session-store.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/session-store/test-session-store.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/session-store/test-session-store.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/session-store/test-session-store.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/session-store/test-session-store.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">mail/test/mozmill/shared-modules/test-content-tab-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">mail/test/mozmill/shared-modules/test-folder-display-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/shared-modules/test-window-helpers.js">mail/test/mozmill/shared-modules/test-window-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/shared-modules/test-window-helpers.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/shared-modules/test-window-helpers.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/shared-modules/test-window-helpers.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/shared-modules/test-window-helpers.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/shared-modules/test-window-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">mail/test/mozmill/tabmail/test-tabmail-dragndrop.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/content/folderProps.js">mailnews/base/content/folderProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/content/folderProps.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/content/folderProps.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/content/folderProps.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/content/folderProps.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/content/folderProps.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/content/folderWidgets.xml">mailnews/base/content/folderWidgets.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/content/folderWidgets.xml">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/content/folderWidgets.xml">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/content/folderWidgets.xml">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/content/folderWidgets.xml">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/content/folderWidgets.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/content/newFolderDialog.js">mailnews/base/content/newFolderDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/content/newFolderDialog.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/content/newFolderDialog.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/content/newFolderDialog.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/content/newFolderDialog.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/content/newFolderDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/test/unit/test_bccInDatabase.js">mailnews/base/test/unit/test_bccInDatabase.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/test/unit/test_bccInDatabase.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/test/unit/test_bccInDatabase.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/test/unit/test_bccInDatabase.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/test/unit/test_bccInDatabase.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/test/unit/test_bccInDatabase.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/test/unit/test_detachToFile.js">mailnews/base/test/unit/test_detachToFile.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/test/unit/test_detachToFile.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/test/unit/test_detachToFile.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/test/unit/test_detachToFile.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/test/unit/test_detachToFile.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/test/unit/test_detachToFile.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/test/unit/test_mimemaltdetach.js">mailnews/base/test/unit/test_mimemaltdetach.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/test/unit/test_mimemaltdetach.js">file</a> |
<a href="/comm-central/annotate/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/test/unit/test_mimemaltdetach.js">annotate</a> |
<a href="/comm-central/diff/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/test/unit/test_mimemaltdetach.js">diff</a> |
<a href="/comm-central/comparison/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/test/unit/test_mimemaltdetach.js">comparison</a> |
<a href="/comm-central/log/aa6a7917b1363c733880670ecb07c8f1d2908b91/mailnews/base/test/unit/test_mimemaltdetach.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/contentAreaClick.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/contentAreaClick.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -45,37 +45,34 @@</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">     return href;</span>
<a href="#l1.6"></a><span id="l1.6">   }</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">   function messagePaneOnResize(aEvent)</span>
<a href="#l1.9"></a><span id="l1.9">   {</span>
<a href="#l1.10"></a><span id="l1.10">     // scale any overflowing images</span>
<a href="#l1.11"></a><span id="l1.11">     let doc = document.getElementById(&quot;messagepane&quot;).contentDocument;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    let imgs = doc.images;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    let imgs = doc.querySelectorAll(&quot;img.moz-attached-image&quot;);</span>
<a href="#l1.14"></a><span id="l1.14">     for (let i = 0; i &lt; imgs.length; i++)</span>
<a href="#l1.15"></a><span id="l1.15">     {</span>
<a href="#l1.16"></a><span id="l1.16">       let img = imgs[i];</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-      if (img.className == &quot;moz-attached-image&quot;)</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+      if (img.naturalWidth &lt;= doc.body.clientWidth)</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+      {</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+        img.removeAttribute(&quot;isshrunk&quot;);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+        img.removeAttribute(&quot;overflowing&quot;);</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+      }</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+      else if (img.hasAttribute(&quot;shrinktofit&quot;))</span>
<a href="#l1.24"></a><span id="l1.24">       {</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-        if (img.naturalWidth &lt;= doc.body.clientWidth)</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-        {</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-          img.removeAttribute(&quot;isshrunk&quot;);</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-          img.removeAttribute(&quot;overflowing&quot;);</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-        }</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-        else if (img.hasAttribute(&quot;shrinktofit&quot;))</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-        {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-          img.setAttribute(&quot;isshrunk&quot;, &quot;true&quot;);</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-          img.removeAttribute(&quot;overflowing&quot;);</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-        }</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-        else</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-        {</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-          img.setAttribute(&quot;overflowing&quot;, &quot;true&quot;);</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-          img.removeAttribute(&quot;isshrunk&quot;);</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-        }</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+        img.setAttribute(&quot;isshrunk&quot;, &quot;true&quot;);</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+        img.removeAttribute(&quot;overflowing&quot;);</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+      }</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+      else</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+      {</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+        img.setAttribute(&quot;overflowing&quot;, &quot;true&quot;);</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+        img.removeAttribute(&quot;isshrunk&quot;);</span>
<a href="#l1.47"></a><span id="l1.47">       }</span>
<a href="#l1.48"></a><span id="l1.48">     }</span>
<a href="#l1.49"></a><span id="l1.49">   }</span>
<a href="#l1.50"></a><span id="l1.50"> </span>
<a href="#l1.51"></a><span id="l1.51"> // Called whenever the user clicks in the content area,</span>
<a href="#l1.52"></a><span id="l1.52"> // should always return true for click to go through</span>
<a href="#l1.53"></a><span id="l1.53"> function contentAreaClick(aEvent)</span>
<a href="#l1.54"></a><span id="l1.54"> {</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineat">@@ -88,17 +85,17 @@ function contentAreaClick(aEvent)</span>
<a href="#l1.56"></a><span id="l1.56"> </span>
<a href="#l1.57"></a><span id="l1.57">     if (target instanceof Ci.nsIImageLoadingContent) {</span>
<a href="#l1.58"></a><span id="l1.58">       // make sure it loaded successfully</span>
<a href="#l1.59"></a><span id="l1.59">       var req = target.getRequest(Ci.nsIImageLoadingContent.CURRENT_REQUEST);</span>
<a href="#l1.60"></a><span id="l1.60">       if (!req || req.imageStatus &amp; Ci.imgIRequest.STATUS_ERROR)</span>
<a href="#l1.61"></a><span id="l1.61">         return true;</span>
<a href="#l1.62"></a><span id="l1.62"> </span>
<a href="#l1.63"></a><span id="l1.63">       // is it an inline attachment?</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-      if (/^moz-attached-image/.test(target.className)) {</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+      if (target.classList.contains(&quot;moz-attached-image&quot;)) {</span>
<a href="#l1.66"></a><span id="l1.66">         if (target.hasAttribute(&quot;isshrunk&quot;)) {</span>
<a href="#l1.67"></a><span id="l1.67">           // currently shrunk to fit, so unshrink it</span>
<a href="#l1.68"></a><span id="l1.68">           target.removeAttribute(&quot;isshrunk&quot;);</span>
<a href="#l1.69"></a><span id="l1.69">           target.removeAttribute(&quot;shrinktofit&quot;);</span>
<a href="#l1.70"></a><span id="l1.70">           target.setAttribute(&quot;overflowing&quot;, &quot;true&quot;);</span>
<a href="#l1.71"></a><span id="l1.71">         }</span>
<a href="#l1.72"></a><span id="l1.72">         else if (target.hasAttribute(&quot;overflowing&quot;)) {</span>
<a href="#l1.73"></a><span id="l1.73">           // user wants to shrink now</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/folderPane.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/folderPane.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -663,17 +663,17 @@ let gFolderTreeView = {</span>
<a href="#l2.4"></a><span id="l2.4">                         msgWindow, true);</span>
<a href="#l2.5"></a><span id="l2.5">     }</span>
<a href="#l2.6"></a><span id="l2.6">     else if (Array.indexOf(types, &quot;application/x-moz-file&quot;) != -1) {</span>
<a href="#l2.7"></a><span id="l2.7">       for (let i = 0; i &lt; count; i++) {</span>
<a href="#l2.8"></a><span id="l2.8">         let extFile = dt.mozGetDataAt(&quot;application/x-moz-file&quot;, i)</span>
<a href="#l2.9"></a><span id="l2.9">                         .QueryInterface(Ci.nsILocalFile);</span>
<a href="#l2.10"></a><span id="l2.10">         if (extFile.isFile()) {</span>
<a href="#l2.11"></a><span id="l2.11">           let len = extFile.leafName.length;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-          if (len &gt; 4 &amp;&amp; extFile.leafName.substr(len - 4).toLowerCase() == &quot;.eml&quot;)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+          if (len &gt; 4 &amp;&amp; extFile.leafName.toLowerCase().endsWith(&quot;.eml&quot;))</span>
<a href="#l2.14"></a><span id="l2.14">             cs.CopyFileMessage(extFile, targetFolder, null, false, 1, &quot;&quot;, null, msgWindow);</span>
<a href="#l2.15"></a><span id="l2.15">         }</span>
<a href="#l2.16"></a><span id="l2.16">       }</span>
<a href="#l2.17"></a><span id="l2.17">     }</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19">     if (targetFolder.server.type == &quot;rss&quot; &amp;&amp; count == 1) {</span>
<a href="#l2.20"></a><span id="l2.20">       // This is a potential rss feed.  A link image as well as link text url</span>
<a href="#l2.21"></a><span id="l2.21">       // should be handled; try to extract a url from non moz apps as well.</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -1273,17 +1273,17 @@ let gFolderTreeView = {</span>
<a href="#l2.23"></a><span id="l2.23">           let name = item._folder.abbreviatedName.toLowerCase();</span>
<a href="#l2.24"></a><span id="l2.24">           item.__defineGetter__(&quot;children&quot;, function() []);</span>
<a href="#l2.25"></a><span id="l2.25">           if (!uniqueNames[name])</span>
<a href="#l2.26"></a><span id="l2.26">             uniqueNames[name] = 0;</span>
<a href="#l2.27"></a><span id="l2.27">           uniqueNames[name]++;</span>
<a href="#l2.28"></a><span id="l2.28">         }</span>
<a href="#l2.29"></a><span id="l2.29">         for each (let item in faves) {</span>
<a href="#l2.30"></a><span id="l2.30">           let name = item._folder.abbreviatedName.toLowerCase();</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-          item.addServerName = (uniqueNames[name] &gt; 1) ? true : false;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+          item.addServerName = (uniqueNames[name] &gt; 1);</span>
<a href="#l2.33"></a><span id="l2.33">         }</span>
<a href="#l2.34"></a><span id="l2.34">         sortFolderItems(faves);</span>
<a href="#l2.35"></a><span id="l2.35">         return faves;</span>
<a href="#l2.36"></a><span id="l2.36">       },</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38">       getParentOfFolder: function ftv_unread_getParentOfFolder(aFolder) {</span>
<a href="#l2.39"></a><span id="l2.39">         // This is a flat view, so no folders have parents.</span>
<a href="#l2.40"></a><span id="l2.40">         return null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/mailCore.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/mailCore.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -204,28 +204,28 @@ function MailToolboxCustomizeDone(aEvent</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5">   var customizePopup = document.getElementById(customizePopupId);</span>
<a href="#l3.6"></a><span id="l3.6">   customizePopup.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">   // make sure our toolbar buttons have the correct enabled state restored to them...</span>
<a href="#l3.9"></a><span id="l3.9">   if (this.UpdateMailToolbar != undefined)</span>
<a href="#l3.10"></a><span id="l3.10">     UpdateMailToolbar(focus);</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  var toolbox = document.getElementsByAttribute(&quot;doCustomization&quot;, &quot;true&quot;)[0];</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  let toolbox = document.querySelector('[doCustomization=&quot;true&quot;]');</span>
<a href="#l3.14"></a><span id="l3.14">   if (toolbox) {</span>
<a href="#l3.15"></a><span id="l3.15">     toolbox.removeAttribute(&quot;doCustomization&quot;);</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17">     // The GetMail button is stuck in a strange state right now, since the</span>
<a href="#l3.18"></a><span id="l3.18">     // customization wrapping preserves its children, but not its initialized</span>
<a href="#l3.19"></a><span id="l3.19">     // state. Fix that here.</span>
<a href="#l3.20"></a><span id="l3.20">     // Fix Bug 565045: Only treat &quot;Get Message Button&quot; if it is in our toolbox</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-    var popup = toolbox.getElementsByAttribute(&quot;id&quot;, &quot;button-getMsgPopup&quot;)[0];</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+    let popup = toolbox.getElementById(&quot;button-getMsgPopup&quot;);</span>
<a href="#l3.23"></a><span id="l3.23">     if (popup) {</span>
<a href="#l3.24"></a><span id="l3.24">       // We can't use _teardown here, because it'll remove the Get All menuitem</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-      let sep = toolbox.getElementsByAttribute(&quot;id&quot;, &quot;button-getAllNewMsgSeparator&quot;)[0];</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+      let sep = toolbox.getElementById(&quot;button-getAllNewMsgSeparator&quot;);</span>
<a href="#l3.27"></a><span id="l3.27">       while (popup.lastChild != sep)</span>
<a href="#l3.28"></a><span id="l3.28">         popup.removeChild(popup.lastChild);</span>
<a href="#l3.29"></a><span id="l3.29">     }</span>
<a href="#l3.30"></a><span id="l3.30">   }</span>
<a href="#l3.31"></a><span id="l3.31"> }</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33"> function onViewToolbarsPopupShowing(aEvent, toolboxIds, aInsertPoint)</span>
<a href="#l3.34"></a><span id="l3.34"> {</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineat">@@ -248,19 +248,17 @@ function onViewToolbarsPopupShowing(aEve</span>
<a href="#l3.36"></a><span id="l3.36">   // point is defined.</span>
<a href="#l3.37"></a><span id="l3.37">   let firstMenuItem = aInsertPoint || popup.firstChild;</span>
<a href="#l3.38"></a><span id="l3.38"> </span>
<a href="#l3.39"></a><span id="l3.39">   for (let [, toolboxId] in Iterator(toolboxIds)) {</span>
<a href="#l3.40"></a><span id="l3.40">     let toolbox = document.getElementById(toolboxId);</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42">     // We'll consider either childnodes that have a toolbarname attribute,</span>
<a href="#l3.43"></a><span id="l3.43">     // or externalToolbars.</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-    let childToolbars = Array.slice(toolbox</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-                                    .getElementsByAttribute(&quot;toolbarname&quot;,</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-                                                            &quot;*&quot;));</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+    let childToolbars = Array.slice(toolbox.querySelectorAll(&quot;[toolbarname]&quot;));</span>
<a href="#l3.48"></a><span id="l3.48">     let potentialToolbars = childToolbars.concat(toolbox.externalToolbars);</span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50">     for (let [, toolbarElement] in Iterator(potentialToolbars)) {</span>
<a href="#l3.51"></a><span id="l3.51"> </span>
<a href="#l3.52"></a><span id="l3.52">       // We have to bind to toolbar because Javascript doesn't do fresh</span>
<a href="#l3.53"></a><span id="l3.53">       // let-bindings per Iteration.</span>
<a href="#l3.54"></a><span id="l3.54">       let toolbar = toolbarElement;</span>
<a href="#l3.55"></a><span id="l3.55"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/mailWindow.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/mailWindow.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -435,20 +435,17 @@ function loadStartPage(aForce)</span>
<a href="#l4.4"></a><span id="l4.4">       !Application.prefs.getValue(&quot;mailnews.start_page.enabled&quot;, false))</span>
<a href="#l4.5"></a><span id="l4.5">     return;</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">   gMessageNotificationBar.clearMsgNotifications();</span>
<a href="#l4.8"></a><span id="l4.8">   let startpage = Services.urlFormatter.formatURLPref(&quot;mailnews.start_page.url&quot;);</span>
<a href="#l4.9"></a><span id="l4.9">   if (startpage)</span>
<a href="#l4.10"></a><span id="l4.10">   {</span>
<a href="#l4.11"></a><span id="l4.11">     try {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-      let urifixup = Components.classes[&quot;@mozilla.org/docshell/urifixup;1&quot;]</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-                               .getService(Components.interfaces.nsIURIFixup);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-      let uri = urifixup.createFixupURI(startpage, 0);</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+      let uri = Services.uriFixup.createFixupURI(startpage, 0);</span>
<a href="#l4.17"></a><span id="l4.17">       GetMessagePaneFrame().location.href = uri.spec;</span>
<a href="#l4.18"></a><span id="l4.18">     }</span>
<a href="#l4.19"></a><span id="l4.19">     catch (e) {</span>
<a href="#l4.20"></a><span id="l4.20">       Components.utils.reportError(e);</span>
<a href="#l4.21"></a><span id="l4.21">     }</span>
<a href="#l4.22"></a><span id="l4.22">   }</span>
<a href="#l4.23"></a><span id="l4.23">   else</span>
<a href="#l4.24"></a><span id="l4.24">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -931,17 +931,17 @@ function InitMessageTags(menuPopup)</span>
<a href="#l5.4"></a><span id="l5.4">   for (var i = 0; i &lt; tagCount; ++i)</span>
<a href="#l5.5"></a><span id="l5.5">   {</span>
<a href="#l5.6"></a><span id="l5.6">     var taginfo = tagArray[i];</span>
<a href="#l5.7"></a><span id="l5.7">     // TODO we want to either remove or &quot;check&quot; the tags that already exist</span>
<a href="#l5.8"></a><span id="l5.8">     var newMenuItem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l5.9"></a><span id="l5.9">     SetMessageTagLabel(newMenuItem, i + 1, taginfo.tag);</span>
<a href="#l5.10"></a><span id="l5.10">     newMenuItem.setAttribute(&quot;value&quot;, taginfo.key);</span>
<a href="#l5.11"></a><span id="l5.11">     newMenuItem.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    var removeKey = (&quot; &quot; + curKeys + &quot; &quot;).indexOf(&quot; &quot; + taginfo.key + &quot; &quot;) &gt; -1;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    let removeKey = (&quot; &quot; + curKeys + &quot; &quot;).contains(&quot; &quot; + taginfo.key + &quot; &quot;);</span>
<a href="#l5.14"></a><span id="l5.14">     newMenuItem.setAttribute('checked', removeKey);</span>
<a href="#l5.15"></a><span id="l5.15">     newMenuItem.setAttribute('oncommand', 'ToggleMessageTagMenu(event.target);');</span>
<a href="#l5.16"></a><span id="l5.16">     var color = taginfo.color;</span>
<a href="#l5.17"></a><span id="l5.17">     if (color)</span>
<a href="#l5.18"></a><span id="l5.18">       newMenuItem.setAttribute(&quot;class&quot;, &quot;lc-&quot; + color.substr(1));</span>
<a href="#l5.19"></a><span id="l5.19">     menuPopup.appendChild(newMenuItem);</span>
<a href="#l5.20"></a><span id="l5.20">   }</span>
<a href="#l5.21"></a><span id="l5.21"> }</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -1155,35 +1155,35 @@ function IsReplyAllEnabled()</span>
<a href="#l5.23"></a><span id="l5.23">   // If we've got any BCCed addresses (because we sent the message), add</span>
<a href="#l5.24"></a><span id="l5.24">   // them as well.</span>
<a href="#l5.25"></a><span id="l5.25">   if (&quot;bcc&quot; in currentHeaderData)</span>
<a href="#l5.26"></a><span id="l5.26">     addresses += currentHeaderData.bcc.headerValue;</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28">   // Check to see if my email address is in the list of addresses.</span>
<a href="#l5.29"></a><span id="l5.29">   let myEmail = getIdentityForHeader(msgHdr).email;</span>
<a href="#l5.30"></a><span id="l5.30">   // We aren't guaranteed to have an email address, so guard against that.</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-  let imInAddresses = myEmail &amp;&amp; (addresses.toLowerCase().indexOf(</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-                                    myEmail.toLowerCase()) != -1);</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+  let imInAddresses = myEmail &amp;&amp; (addresses.toLowerCase().contains(</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+                                    myEmail.toLowerCase()));</span>
<a href="#l5.35"></a><span id="l5.35"> </span>
<a href="#l5.36"></a><span id="l5.36">   // Now, let's get the number of unique addresses.</span>
<a href="#l5.37"></a><span id="l5.37">   let hdrParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l5.38"></a><span id="l5.38">                             .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l5.39"></a><span id="l5.39">   let uniqueAddresses = hdrParser.removeDuplicateAddresses(addresses, &quot;&quot;);</span>
<a href="#l5.40"></a><span id="l5.40">   let emailAddresses = {};</span>
<a href="#l5.41"></a><span id="l5.41">   let numAddresses = hdrParser.parseHeadersWithArray(uniqueAddresses,</span>
<a href="#l5.42"></a><span id="l5.42">                                                      emailAddresses, {}, {});</span>
<a href="#l5.43"></a><span id="l5.43"> </span>
<a href="#l5.44"></a><span id="l5.44">   // XXX: This should be handled by the nsIMsgHeaderParser.  See Bug 498480.</span>
<a href="#l5.45"></a><span id="l5.45">   // Remove addresses that look like email groups, because we don't support</span>
<a href="#l5.46"></a><span id="l5.46">   // those yet.  (Any address with a : in it will be an empty email group,</span>
<a href="#l5.47"></a><span id="l5.47">   // or the colon and the groupname would be set as the first name, and not</span>
<a href="#l5.48"></a><span id="l5.48">   // show up in the address at all.)</span>
<a href="#l5.49"></a><span id="l5.49">   for (var i in emailAddresses.value)</span>
<a href="#l5.50"></a><span id="l5.50">   {</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-    if (/:/.test(emailAddresses.value[i]))</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+    if (emailAddresses.value[i].contains(&quot;:&quot;))</span>
<a href="#l5.53"></a><span id="l5.53">       numAddresses--;</span>
<a href="#l5.54"></a><span id="l5.54">   }</span>
<a href="#l5.55"></a><span id="l5.55"> </span>
<a href="#l5.56"></a><span id="l5.56">   // I don't want to count my address in the number of addresses to reply</span>
<a href="#l5.57"></a><span id="l5.57">   // to, since I won't be emailing myself.</span>
<a href="#l5.58"></a><span id="l5.58">   if (imInAddresses)</span>
<a href="#l5.59"></a><span id="l5.59">     numAddresses--;</span>
<a href="#l5.60"></a><span id="l5.60"> </span>
<a href="#l5.61"></a><span id="l5.61" class="difflineat">@@ -3203,17 +3203,17 @@ function HandleMDNResponse(aUrl)</span>
<a href="#l5.62"></a><span id="l5.62">   } catch (ex) {</span>
<a href="#l5.63"></a><span id="l5.63">     return;</span>
<a href="#l5.64"></a><span id="l5.64">   }</span>
<a href="#l5.65"></a><span id="l5.65"> </span>
<a href="#l5.66"></a><span id="l5.66">   // If we didn't get the message id when we downloaded the message header,</span>
<a href="#l5.67"></a><span id="l5.67">   // we cons up an md5: message id. If we've done that, we'll try to extract</span>
<a href="#l5.68"></a><span id="l5.68">   // the message id out of the mime headers for the whole message.</span>
<a href="#l5.69"></a><span id="l5.69">   var msgId = msgHdr.messageId;</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-  if (msgId.split(&quot;:&quot;)[0] == &quot;md5&quot;)</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+  if (msgId.startsWith(&quot;md5:&quot;))</span>
<a href="#l5.72"></a><span id="l5.72">   {</span>
<a href="#l5.73"></a><span id="l5.73">     var mimeMsgId = mimeHdr.extractHeader(&quot;Message-Id&quot;, false);</span>
<a href="#l5.74"></a><span id="l5.74">     if (mimeMsgId)</span>
<a href="#l5.75"></a><span id="l5.75">       msgHdr.messageId = mimeMsgId;</span>
<a href="#l5.76"></a><span id="l5.76">   }</span>
<a href="#l5.77"></a><span id="l5.77"> </span>
<a href="#l5.78"></a><span id="l5.78">   // After a msg is downloaded it's already marked READ at this point so we must check if</span>
<a href="#l5.79"></a><span id="l5.79">   // the msg has a &quot;Disposition-Notification-To&quot; header and no MDN report has been sent yet.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -536,17 +536,17 @@ var messageHeaderSink = {</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">       if ((&quot;from&quot; in currentHeaderData) &amp;&amp; (&quot;sender&quot; in currentHeaderData)) {</span>
<a href="#l6.6"></a><span id="l6.6">         var senderMailbox = kMailboxSeparator +</span>
<a href="#l6.7"></a><span id="l6.7">           MailServices.headerParser.extractHeaderAddressMailboxes(</span>
<a href="#l6.8"></a><span id="l6.8">             currentHeaderData.sender.headerValue) + kMailboxSeparator;</span>
<a href="#l6.9"></a><span id="l6.9">         var fromMailboxes = kMailboxSeparator +</span>
<a href="#l6.10"></a><span id="l6.10">           MailServices.headerParser.extractHeaderAddressMailboxes(</span>
<a href="#l6.11"></a><span id="l6.11">             currentHeaderData.from.headerValue) + kMailboxSeparator;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-        if (fromMailboxes.indexOf(senderMailbox) &gt;= 0)</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+        if (fromMailboxes.contains(senderMailbox))</span>
<a href="#l6.14"></a><span id="l6.14">           delete currentHeaderData.sender;</span>
<a href="#l6.15"></a><span id="l6.15">       }</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17">       // We don't need to show the reply-to header if its value is either</span>
<a href="#l6.18"></a><span id="l6.18">       // the From field (totally pointless) or the To field (common for</span>
<a href="#l6.19"></a><span id="l6.19">       // mailing lists, but not that useful).</span>
<a href="#l6.20"></a><span id="l6.20">       if ((&quot;from&quot; in currentHeaderData) &amp;&amp;</span>
<a href="#l6.21"></a><span id="l6.21">           (&quot;to&quot; in currentHeaderData) &amp;&amp;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -578,17 +578,17 @@ var messageHeaderSink = {</span>
<a href="#l6.23"></a><span id="l6.23">       if (contentType == &quot;text/x-vcard&quot;) {</span>
<a href="#l6.24"></a><span id="l6.24">         var inlineAttachments = Services.prefs.getBoolPref(&quot;mail.inline_attachments&quot;);</span>
<a href="#l6.25"></a><span id="l6.25">         var displayHtmlAs = Services.prefs.getIntPref(&quot;mailnews.display.html_as&quot;);</span>
<a href="#l6.26"></a><span id="l6.26">         if (inlineAttachments &amp;&amp; !displayHtmlAs)</span>
<a href="#l6.27"></a><span id="l6.27">           return;</span>
<a href="#l6.28"></a><span id="l6.28">       }</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30">       var size = null;</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-      if (isExternalAttachment &amp;&amp; /^file:/.test(url)) {</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+      if (isExternalAttachment &amp;&amp; url.startsWith(&quot;file:&quot;)) {</span>
<a href="#l6.33"></a><span id="l6.33">         let fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l6.34"></a><span id="l6.34">           .QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l6.35"></a><span id="l6.35">         try {</span>
<a href="#l6.36"></a><span id="l6.36">           let file = fileHandler.getFileFromURLSpec(url);</span>
<a href="#l6.37"></a><span id="l6.37">           // Can't get size for detached attachments which are no longer</span>
<a href="#l6.38"></a><span id="l6.38">           // available on the specified location.</span>
<a href="#l6.39"></a><span id="l6.39">           if (file.exists())</span>
<a href="#l6.40"></a><span id="l6.40">             size = file.fileSize;</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineat">@@ -867,17 +867,17 @@ function EnsureMinimumNumberOfHeaders (h</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43">   if (numVisibleHeaders &lt; gMinNumberOfHeaders) {</span>
<a href="#l6.44"></a><span id="l6.44">     // How many empty headers do we need to add?</span>
<a href="#l6.45"></a><span id="l6.45">     var numEmptyHeaders = gMinNumberOfHeaders - numVisibleHeaders;</span>
<a href="#l6.46"></a><span id="l6.46"> </span>
<a href="#l6.47"></a><span id="l6.47">     // We may have already dynamically created our empty rows and we just need</span>
<a href="#l6.48"></a><span id="l6.48">     // to make them visible.</span>
<a href="#l6.49"></a><span id="l6.49">     for each (let [index, headerEntry] in Iterator(headerTable)) {</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-      if (index.indexOf(&quot;Dummy-Header&quot;) == 0 &amp;&amp; numEmptyHeaders) {</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+      if (index.startsWith(&quot;Dummy-Header&quot;) &amp;&amp; numEmptyHeaders) {</span>
<a href="#l6.52"></a><span id="l6.52">         headerEntry.valid = true;</span>
<a href="#l6.53"></a><span id="l6.53">         numEmptyHeaders--;</span>
<a href="#l6.54"></a><span id="l6.54">       }</span>
<a href="#l6.55"></a><span id="l6.55">     }</span>
<a href="#l6.56"></a><span id="l6.56"> </span>
<a href="#l6.57"></a><span id="l6.57">     // Ok, now if we have any extra dummy headers we need to add, create a new</span>
<a href="#l6.58"></a><span id="l6.58">     // header widget for them.</span>
<a href="#l6.59"></a><span id="l6.59">     while (numEmptyHeaders) {</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineat">@@ -1830,17 +1830,17 @@ AttachmentInfo.prototype = {</span>
<a href="#l6.61"></a><span id="l6.61">    * do *not* have a file.</span>
<a href="#l6.62"></a><span id="l6.62">    *</span>
<a href="#l6.63"></a><span id="l6.63">    * @return true if the attachment has an associated file, false otherwise</span>
<a href="#l6.64"></a><span id="l6.64">    */</span>
<a href="#l6.65"></a><span id="l6.65">   get hasFile()</span>
<a href="#l6.66"></a><span id="l6.66">   {</span>
<a href="#l6.67"></a><span id="l6.67">     if (this.isDeleted)</span>
<a href="#l6.68"></a><span id="l6.68">       return false;</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-    if (this.isExternalAttachment &amp;&amp; /^file:/.test(this.url) &amp;&amp;</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+    if (this.isExternalAttachment &amp;&amp; this.url.startsWith(&quot;file:&quot;) &amp;&amp;</span>
<a href="#l6.71"></a><span id="l6.71">         this.size === null)</span>
<a href="#l6.72"></a><span id="l6.72">       return false;</span>
<a href="#l6.73"></a><span id="l6.73"> </span>
<a href="#l6.74"></a><span id="l6.74">     return true;</span>
<a href="#l6.75"></a><span id="l6.75">   },</span>
<a href="#l6.76"></a><span id="l6.76"> </span>
<a href="#l6.77"></a><span id="l6.77">   /**</span>
<a href="#l6.78"></a><span id="l6.78">    * This method checks whether the attachment is empty or not.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -450,17 +450,17 @@ function LoadPostAccountWizard()</span>
<a href="#l7.4"></a><span id="l7.4">   let startFolderURI = null, startMsgHdr = null;</span>
<a href="#l7.5"></a><span id="l7.5">   if (&quot;arguments&quot; in window &amp;&amp; window.arguments.length &gt; 0)</span>
<a href="#l7.6"></a><span id="l7.6">   {</span>
<a href="#l7.7"></a><span id="l7.7">     let arg0 = window.arguments[0];</span>
<a href="#l7.8"></a><span id="l7.8">     // If the argument is a string, it is either a folder URI or a feed URI</span>
<a href="#l7.9"></a><span id="l7.9">     if (typeof arg0 == &quot;string&quot;)</span>
<a href="#l7.10"></a><span id="l7.10">     {</span>
<a href="#l7.11"></a><span id="l7.11">       // filter our any feed urls that came in as arguments to the new window...</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-      if (/^feed:/i.test(arg0))</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+      if (arg0.toLowerCase().startsWith(&quot;feed:&quot;))</span>
<a href="#l7.14"></a><span id="l7.14">       {</span>
<a href="#l7.15"></a><span id="l7.15">         let feedHandler = Components.classes[&quot;@mozilla.org/newsblog-feed-downloader;1&quot;]</span>
<a href="#l7.16"></a><span id="l7.16">           .getService(Components.interfaces.nsINewsBlogFeedDownloader);</span>
<a href="#l7.17"></a><span id="l7.17">         if (feedHandler)</span>
<a href="#l7.18"></a><span id="l7.18">           feedHandler.subscribeToFeed(arg0, null, msgWindow);</span>
<a href="#l7.19"></a><span id="l7.19">       }</span>
<a href="#l7.20"></a><span id="l7.20">       else</span>
<a href="#l7.21"></a><span id="l7.21">       {</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -1363,32 +1363,32 @@ function ThreadPaneOnDragOver(aEvent) {</span>
<a href="#l7.23"></a><span id="l7.23">     return;</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25">   let dt = aEvent.dataTransfer;</span>
<a href="#l7.26"></a><span id="l7.26">   if (Array.indexOf(dt.mozTypesAt(0), &quot;application/x-moz-file&quot;) != -1) {</span>
<a href="#l7.27"></a><span id="l7.27">     let extFile = dt.mozGetDataAt(&quot;application/x-moz-file&quot;, 0)</span>
<a href="#l7.28"></a><span id="l7.28">                     .QueryInterface(Components.interfaces.nsIFile);</span>
<a href="#l7.29"></a><span id="l7.29">     if (extFile.isFile()) {</span>
<a href="#l7.30"></a><span id="l7.30">       let len = extFile.leafName.length;</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-      if (len &gt; 4 &amp;&amp; extFile.leafName.substr(len - 4).toLowerCase() == &quot;.eml&quot;)</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+      if (len &gt; 4 &amp;&amp; extFile.leafName.toLowerCase().endsWith(&quot;.eml&quot;))</span>
<a href="#l7.33"></a><span id="l7.33">         ds.canDrop = true;</span>
<a href="#l7.34"></a><span id="l7.34">     }</span>
<a href="#l7.35"></a><span id="l7.35">   }</span>
<a href="#l7.36"></a><span id="l7.36"> }</span>
<a href="#l7.37"></a><span id="l7.37"> </span>
<a href="#l7.38"></a><span id="l7.38"> function ThreadPaneOnDrop(aEvent) {</span>
<a href="#l7.39"></a><span id="l7.39">   let dt = aEvent.dataTransfer;</span>
<a href="#l7.40"></a><span id="l7.40">   let cs = Components.classes[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l7.41"></a><span id="l7.41">                      .getService(Components.interfaces.nsIMsgCopyService);</span>
<a href="#l7.42"></a><span id="l7.42">   for (let i = 0; i &lt; dt.mozItemCount; i++) {</span>
<a href="#l7.43"></a><span id="l7.43">     let extFile = dt.mozGetDataAt(&quot;application/x-moz-file&quot;, i)</span>
<a href="#l7.44"></a><span id="l7.44">                     .QueryInterface(Components.interfaces.nsIFile);</span>
<a href="#l7.45"></a><span id="l7.45">     if (extFile.isFile()) {</span>
<a href="#l7.46"></a><span id="l7.46">       let len = extFile.leafName.length;</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-      if (len &gt; 4 &amp;&amp; extFile.leafName.substr(len - 4).toLowerCase() == &quot;.eml&quot;)</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+      if (len &gt; 4 &amp;&amp; extFile.leafName.toLowerCase().endsWith(&quot;.eml&quot;))</span>
<a href="#l7.49"></a><span id="l7.49">         cs.CopyFileMessage(extFile, gFolderDisplay.displayedFolder, null, false,</span>
<a href="#l7.50"></a><span id="l7.50">                            1, &quot;&quot;, null, msgWindow);</span>
<a href="#l7.51"></a><span id="l7.51">     }</span>
<a href="#l7.52"></a><span id="l7.52">   }</span>
<a href="#l7.53"></a><span id="l7.53"> }</span>
<a href="#l7.54"></a><span id="l7.54"> </span>
<a href="#l7.55"></a><span id="l7.55"> var LightWeightThemeWebInstaller = {</span>
<a href="#l7.56"></a><span id="l7.56">   handleEvent: function (event) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/base/content/nsContextMenu.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/base/content/nsContextMenu.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -718,17 +718,17 @@ nsContextMenu.prototype = {</span>
<a href="#l8.4"></a><span id="l8.4">    * resolving an XLink URL by hand.</span>
<a href="#l8.5"></a><span id="l8.5">    * @return the string absolute URL for the clicked-on link</span>
<a href="#l8.6"></a><span id="l8.6">    */</span>
<a href="#l8.7"></a><span id="l8.7">   getLinkURL : function CM_getLinkURL() {</span>
<a href="#l8.8"></a><span id="l8.8">     if (this.link.href) {</span>
<a href="#l8.9"></a><span id="l8.9">       return this.link.href;</span>
<a href="#l8.10"></a><span id="l8.10">     }</span>
<a href="#l8.11"></a><span id="l8.11">     var href = this.link.getAttributeNS(&quot;http://www.w3.org/1999/xlink&quot;,&quot;href&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    if (!href || !href.match(/\S/)) {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+    if (!href || (href.trim() == &quot;&quot;)) {</span>
<a href="#l8.14"></a><span id="l8.14">        // Without this we try to save as the current doc,</span>
<a href="#l8.15"></a><span id="l8.15">        // for example, HTML case also throws if empty.</span>
<a href="#l8.16"></a><span id="l8.16">       throw &quot;Empty href&quot;;</span>
<a href="#l8.17"></a><span id="l8.17">     }</span>
<a href="#l8.18"></a><span id="l8.18">     href = this.makeURLAbsolute(this.link.baseURI,href);</span>
<a href="#l8.19"></a><span id="l8.19">     return href;</span>
<a href="#l8.20"></a><span id="l8.20">   },</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -757,26 +757,26 @@ nsContextMenu.prototype = {</span>
<a href="#l8.23"></a><span id="l8.23">   },</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25">   /**</span>
<a href="#l8.26"></a><span id="l8.26">    * Get some text, any text, for the clicked-on link.</span>
<a href="#l8.27"></a><span id="l8.27">    * @return the link text, title, alt, href, or &quot;&quot; if everything fails</span>
<a href="#l8.28"></a><span id="l8.28">    */</span>
<a href="#l8.29"></a><span id="l8.29">   linkText : function CM_linkText() {</span>
<a href="#l8.30"></a><span id="l8.30">     var text = gatherTextUnder(this.link);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-    if (!text || !text.match(/\S/)) {</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+    if (!text || (text.trim() == &quot;&quot;)) {</span>
<a href="#l8.33"></a><span id="l8.33">       text = this.link.getAttribute(&quot;title&quot;);</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-      if (!text || !text.match(/\S/)) {</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+      if (!text || (text.trim() == &quot;&quot;)) {</span>
<a href="#l8.36"></a><span id="l8.36">         text = this.link.getAttribute(&quot;alt&quot;);</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-        if (!text || !text.match(/\S/)) {</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+        if (!text || (text.trim() == &quot;&quot;)) {</span>
<a href="#l8.39"></a><span id="l8.39">           if (this.link.href) {</span>
<a href="#l8.40"></a><span id="l8.40">             text = this.link.href;</span>
<a href="#l8.41"></a><span id="l8.41">           } else {</span>
<a href="#l8.42"></a><span id="l8.42">             text = getAttributeNS(&quot;http://www.w3.org/1999/xlink&quot;, &quot;href&quot;);</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-            if (text &amp;&amp; text.match(/\S/)) {</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+            if (text &amp;&amp; !(text.trim() == &quot;&quot;)) {</span>
<a href="#l8.45"></a><span id="l8.45">               text = this.makeURLAbsolute(this.link.baseURI, text);</span>
<a href="#l8.46"></a><span id="l8.46">             }</span>
<a href="#l8.47"></a><span id="l8.47">           }</span>
<a href="#l8.48"></a><span id="l8.48">         }</span>
<a href="#l8.49"></a><span id="l8.49">       }</span>
<a href="#l8.50"></a><span id="l8.50">     }</span>
<a href="#l8.51"></a><span id="l8.51"> </span>
<a href="#l8.52"></a><span id="l8.52">     return text;</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineat">@@ -883,20 +883,18 @@ nsContextMenu.prototype = {</span>
<a href="#l8.54"></a><span id="l8.54">         else</span>
<a href="#l8.55"></a><span id="l8.55">           return;</span>
<a href="#l8.56"></a><span id="l8.56">       }</span>
<a href="#l8.57"></a><span id="l8.57">       sibling = sibling.previousSibling;</span>
<a href="#l8.58"></a><span id="l8.58">     }</span>
<a href="#l8.59"></a><span id="l8.59">   },</span>
<a href="#l8.60"></a><span id="l8.60"> </span>
<a href="#l8.61"></a><span id="l8.61">   openInBrowser: function CM_openInBrowser() {</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-    let uri = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-                        .getService(Components.interfaces.nsIIOService)</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-                        .newURI(this.target.ownerDocument.defaultView.</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-                                top.location.href, null, null);</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+    let uri = Services.io.newURI(this.target.ownerDocument.defaultView.</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+                                 top.location.href, null, null);</span>
<a href="#l8.68"></a><span id="l8.68"> </span>
<a href="#l8.69"></a><span id="l8.69">     Components.classes[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l8.70"></a><span id="l8.70">               .getService(Components.interfaces.nsIExternalProtocolService)</span>
<a href="#l8.71"></a><span id="l8.71">               .loadURI(uri);</span>
<a href="#l8.72"></a><span id="l8.72">   },</span>
<a href="#l8.73"></a><span id="l8.73"> </span>
<a href="#l8.74"></a><span id="l8.74">   openLinkInBrowser: function CM_openLinkInBrowser() {</span>
<a href="#l8.75"></a><span id="l8.75">     Components.classes[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/base/content/phishingDetector.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/base/content/phishingDetector.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -90,21 +90,20 @@ var gPhishingDetector = {</span>
<a href="#l9.4"></a><span id="l9.4">     }</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6">     // extract the link nodes in the message and analyze them, looking for suspicious URLs...</span>
<a href="#l9.7"></a><span id="l9.7">     var linkNodes = document.getElementById('messagepane').contentDocument.links;</span>
<a href="#l9.8"></a><span id="l9.8">     for (var index = 0; index &lt; linkNodes.length; index++)</span>
<a href="#l9.9"></a><span id="l9.9">       this.analyzeUrl(linkNodes[index].href, gatherTextUnder(linkNodes[index]));</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11">     // extract the action urls associated with any form elements in the message and analyze them.</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    var formNodes = document.getElementById('messagepane').contentDocument.getElementsByTagName(&quot;form&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    let formNodes = document.getElementById('messagepane').contentDocument.querySelectorAll(&quot;form[action]&quot;);</span>
<a href="#l9.14"></a><span id="l9.14">     for (index = 0; index &lt; formNodes.length; index++)</span>
<a href="#l9.15"></a><span id="l9.15">     {</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-      if (formNodes[index].action)</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-        this.analyzeUrl(formNodes[index].action);</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+      this.analyzeUrl(formNodes[index].action);</span>
<a href="#l9.19"></a><span id="l9.19">     }</span>
<a href="#l9.20"></a><span id="l9.20">   },</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22">   /** </span>
<a href="#l9.23"></a><span id="l9.23">    * Analyze the url contained in aLinkNode for phishing attacks. If a phishing URL is found,</span>
<a href="#l9.24"></a><span id="l9.24">    * </span>
<a href="#l9.25"></a><span id="l9.25">    * @param aHref the url to be analyzed</span>
<a href="#l9.26"></a><span id="l9.26">    * @param aLinkText (optional) user visible link text associated with aHref in case</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/base/content/selectionsummaries.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/base/content/selectionsummaries.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -35,55 +35,43 @@ function loadSelectionSummaryStrings() {</span>
<a href="#l10.4"></a><span id="l10.4">   for (let [name, value] in Iterator(gSelectionSummaryStrings))</span>
<a href="#l10.5"></a><span id="l10.5">     gSelectionSummaryStrings[name] = typeof value == &quot;string&quot; ?</span>
<a href="#l10.6"></a><span id="l10.6">       getStr(value) : value.map(gSelectionSummaryStrings);</span>
<a href="#l10.7"></a><span id="l10.7"> }</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> // Ah, wouldn't it be nice if there was platform code to do the following...</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> /**</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">- * the equivalent of jQuery's addClass.  Avoids duplicates, nothing fancy.</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+ * Adds a classes to a node. Avoids duplicates, nothing fancy.</span>
<a href="#l10.14"></a><span id="l10.14">  *</span>
<a href="#l10.15"></a><span id="l10.15">  * @param node</span>
<a href="#l10.16"></a><span id="l10.16">  *        any old DOM node</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">- * @param classname</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">- *        a string, which will be added as a CSS class</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+ * @param classArray</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+ *        an array of strings, which will be added as CSS classes</span>
<a href="#l10.21"></a><span id="l10.21">  */</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-function _mm_addClass(node, classname) {</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-  let classes = [];</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-  if (node.hasAttribute('class'))</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-    classes = node.getAttribute('class').split(' ');</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-  for each (let [, klass] in Iterator(classes)) {</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-    if (klass == classname) // already have it</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-      return;</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+function _mm_addClass(node, classArray) {</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+  for (let i = 0; i &lt; classArray.length; i++)</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+  {</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+    if (!node.classList.contains(classArray[i]))</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+      node.classList.add(classArray[i]);</span>
<a href="#l10.35"></a><span id="l10.35">   }</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-  classes.push(classname);</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-  node.setAttribute('class', classes.join(' '));</span>
<a href="#l10.38"></a><span id="l10.38"> }</span>
<a href="#l10.39"></a><span id="l10.39"> </span>
<a href="#l10.40"></a><span id="l10.40"> /**</span>
<a href="#l10.41"></a><span id="l10.41">  * the equivalent of jQuery's removeClass.  Doesn't freak if the class name</span>
<a href="#l10.42"></a><span id="l10.42">  * isn't in the class attribute.</span>
<a href="#l10.43"></a><span id="l10.43">  *</span>
<a href="#l10.44"></a><span id="l10.44">  * @param node</span>
<a href="#l10.45"></a><span id="l10.45">  *        any old DOM node</span>
<a href="#l10.46"></a><span id="l10.46">  * @param classname</span>
<a href="#l10.47"></a><span id="l10.47">  *        a string, which will be removed from the class set.</span>
<a href="#l10.48"></a><span id="l10.48">  */</span>
<a href="#l10.49"></a><span id="l10.49"> function _mm_removeClass(node, classname) {</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-  if (! node.hasAttribute('class'))</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-    return;</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-  let classes = node.getAttribute('class').split(' ');</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-  let newclasses = [];</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-  for each (klass in classes) {</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-    if (klass != classname)</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-      newclasses.push(klass);</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-  }</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-  node.setAttribute('class', newclasses.join(' '));</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+  if (node.classList.contains(classname))</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+    node.classList.remove(classname);</span>
<a href="#l10.61"></a><span id="l10.61"> }</span>
<a href="#l10.62"></a><span id="l10.62"> </span>
<a href="#l10.63"></a><span id="l10.63"> /**</span>
<a href="#l10.64"></a><span id="l10.64">  * Format the display name for the multi-message/thread summaries. First, try</span>
<a href="#l10.65"></a><span id="l10.65">  * using FormatDisplayName, then fall back to the header's display name or the</span>
<a href="#l10.66"></a><span id="l10.66">  * address.</span>
<a href="#l10.67"></a><span id="l10.67">  *</span>
<a href="#l10.68"></a><span id="l10.68">  * @param aHeaderParser An instance of |nsIMsgHeaderParser|</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineat">@@ -187,18 +175,18 @@ MultiMessageSummary.prototype = {</span>
<a href="#l10.70"></a><span id="l10.70">    * leading/trailing quotes (both single and double).</span>
<a href="#l10.71"></a><span id="l10.71">    *</span>
<a href="#l10.72"></a><span id="l10.72">    * @param senderName</span>
<a href="#l10.73"></a><span id="l10.73">    *     name which might be quoted</span>
<a href="#l10.74"></a><span id="l10.74">    * @return</span>
<a href="#l10.75"></a><span id="l10.75">    *     name without quotes</span>
<a href="#l10.76"></a><span id="l10.76">    **/</span>
<a href="#l10.77"></a><span id="l10.77">   stripQuotes: function(senderName) {</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-    if ((senderName[0] == &quot;'&quot; &amp;&amp; senderName[senderName.length-1] == &quot;'&quot;) ||</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-        (senderName[0] == '&quot;' &amp;&amp; senderName[senderName.length-1] == '&quot;'))</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+    if ((senderName.startsWith(&quot;'&quot;) &amp;&amp; senderName.endsWith(&quot;'&quot;)) ||</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+        (senderName.startsWith('&quot;') &amp;&amp; senderName.endsWith('&quot;')))</span>
<a href="#l10.82"></a><span id="l10.82">       senderName = senderName.slice(1, -1);</span>
<a href="#l10.83"></a><span id="l10.83">     return senderName;</span>
<a href="#l10.84"></a><span id="l10.84">   },</span>
<a href="#l10.85"></a><span id="l10.85"> </span>
<a href="#l10.86"></a><span id="l10.86">   summarize: function() {</span>
<a href="#l10.87"></a><span id="l10.87">     const URL = &quot;chrome://messenger/content/multimessageview.xhtml&quot;;</span>
<a href="#l10.88"></a><span id="l10.88">     gSummaryFrameManager.loadAndCallback(URL, this._onLoad.bind(this));</span>
<a href="#l10.89"></a><span id="l10.89">   },</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineat">@@ -225,18 +213,18 @@ MultiMessageSummary.prototype = {</span>
<a href="#l10.91"></a><span id="l10.91">         numThreads += 1;</span>
<a href="#l10.92"></a><span id="l10.92">       } else {</span>
<a href="#l10.93"></a><span id="l10.93">         threads[viewThreadId(msgHdr)].push(msgHdr);</span>
<a href="#l10.94"></a><span id="l10.94">       }</span>
<a href="#l10.95"></a><span id="l10.95">     }</span>
<a href="#l10.96"></a><span id="l10.96"> </span>
<a href="#l10.97"></a><span id="l10.97">     // set the heading based on the number of messages &amp; threads</span>
<a href="#l10.98"></a><span id="l10.98">     let heading = htmlpane.contentDocument.getElementById('heading');</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-    _mm_addClass(heading, &quot;heading&quot;);</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-    _mm_addClass(heading, &quot;info&quot;);</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+    _mm_addClass(heading, [&quot;heading&quot;]);</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+    _mm_addClass(heading, [&quot;info&quot;]);</span>
<a href="#l10.103"></a><span id="l10.103"> </span>
<a href="#l10.104"></a><span id="l10.104">     let messagesTitle =</span>
<a href="#l10.105"></a><span id="l10.105">       PluralForm.get(numThreads, gSelectionSummaryStrings[&quot;NConversations&quot;])</span>
<a href="#l10.106"></a><span id="l10.106">                 .replace(&quot;#1&quot;, numThreads);</span>
<a href="#l10.107"></a><span id="l10.107"> </span>
<a href="#l10.108"></a><span id="l10.108">     heading.textContent = messagesTitle;</span>
<a href="#l10.109"></a><span id="l10.109"> </span>
<a href="#l10.110"></a><span id="l10.110">     // enable/disable the archive button as appropriate</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineat">@@ -268,23 +256,23 @@ MultiMessageSummary.prototype = {</span>
<a href="#l10.112"></a><span id="l10.112">       for (let [, msgHdr] in Iterator(msgs)) {</span>
<a href="#l10.113"></a><span id="l10.113">         if (! msgHdr.isRead)</span>
<a href="#l10.114"></a><span id="l10.114">           countUnread += 1;</span>
<a href="#l10.115"></a><span id="l10.115">         if (msgHdr.isFlagged)</span>
<a href="#l10.116"></a><span id="l10.116">           countStarred += 1;</span>
<a href="#l10.117"></a><span id="l10.117">       }</span>
<a href="#l10.118"></a><span id="l10.118"> </span>
<a href="#l10.119"></a><span id="l10.119">       let numMsgs = msgs.length;</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineminus">-      let msg_classes = &quot;message &quot;;</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+      let msg_classes = [&quot;message&quot;];</span>
<a href="#l10.122"></a><span id="l10.122">       if (numMsgs &gt; 1)</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineminus">-        msg_classes += &quot; thread&quot;;</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+        msg_classes.push(&quot;thread&quot;);</span>
<a href="#l10.125"></a><span id="l10.125">       if (countUnread)</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-        msg_classes += &quot; unread&quot;;</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+        msg_classes.push(&quot;unread&quot;);</span>
<a href="#l10.128"></a><span id="l10.128">       if (countStarred)</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-        msg_classes += &quot; starred&quot;;</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+        msg_classes.push(&quot;starred&quot;);</span>
<a href="#l10.131"></a><span id="l10.131"> </span>
<a href="#l10.132"></a><span id="l10.132">       let subject = msgs[0].mime2DecodedSubject || gSelectionSummaryStrings['noSubject'];</span>
<a href="#l10.133"></a><span id="l10.133">       let author = _mm_FormatDisplayName(headerParser, msgs[0].mime2DecodedAuthor, &quot;from&quot;);</span>
<a href="#l10.134"></a><span id="l10.134"> </span>
<a href="#l10.135"></a><span id="l10.135">       let countstring = &quot;&quot;;</span>
<a href="#l10.136"></a><span id="l10.136">       if (numMsgs &gt; 1) {</span>
<a href="#l10.137"></a><span id="l10.137">         countstring += &quot;(&quot;;</span>
<a href="#l10.138"></a><span id="l10.138">         countstring += PluralForm.get(numMsgs, gSelectionSummaryStrings[&quot;numMsgs&quot;]).replace('#1', numMsgs);</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineat">@@ -310,18 +298,18 @@ MultiMessageSummary.prototype = {</span>
<a href="#l10.140"></a><span id="l10.140"> </span>
<a href="#l10.141"></a><span id="l10.141">       let msgNode = htmlpane.contentDocument.createElement(&quot;div&quot;);</span>
<a href="#l10.142"></a><span id="l10.142">       // innerHTML is safe here because all of the data in msgContents is</span>
<a href="#l10.143"></a><span id="l10.143">       // either generated from integers or escaped to be safe.</span>
<a href="#l10.144"></a><span id="l10.144">       msgNode.innerHTML = msgContents;</span>
<a href="#l10.145"></a><span id="l10.145">       _mm_addClass(msgNode, msg_classes);</span>
<a href="#l10.146"></a><span id="l10.146">       messagesElt.appendChild(msgNode);</span>
<a href="#l10.147"></a><span id="l10.147"> </span>
<a href="#l10.148"></a><span id="l10.148" class="difflineminus">-      let snippetNode = msgNode.getElementsByClassName(&quot;snippet&quot;)[0];</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineminus">-      let authorNode = msgNode.getElementsByClassName(&quot;author&quot;)[0];</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+      let snippetNode = msgNode.querySelector(&quot;.snippet&quot;);</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+      let authorNode = msgNode.querySelector(&quot;.author&quot;);</span>
<a href="#l10.152"></a><span id="l10.152">       try {</span>
<a href="#l10.153"></a><span id="l10.153">         MsgHdrToMimeMessage(msgs[0], null, function(aMsgHdr, aMimeMsg) {</span>
<a href="#l10.154"></a><span id="l10.154">           if (aMimeMsg == null) /* shouldn't happen, but sometimes does? */</span>
<a href="#l10.155"></a><span id="l10.155">             return;</span>
<a href="#l10.156"></a><span id="l10.156"> </span>
<a href="#l10.157"></a><span id="l10.157">           let [text, meta] = mimeMsgToContentSnippetAndMeta(aMimeMsg,</span>
<a href="#l10.158"></a><span id="l10.158">                                                             aMsgHdr.folder,</span>
<a href="#l10.159"></a><span id="l10.159">                                                             SNIPPET_LENGTH);</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineat">@@ -331,23 +319,23 @@ MultiMessageSummary.prototype = {</span>
<a href="#l10.161"></a><span id="l10.161">         }, false, {saneBodySize: true});</span>
<a href="#l10.162"></a><span id="l10.162">       } catch (e if e.result == Components.results.NS_ERROR_FAILURE) {</span>
<a href="#l10.163"></a><span id="l10.163">         // Offline messages generate exceptions, which is unfortunate.  When</span>
<a href="#l10.164"></a><span id="l10.164">         // that's fixed, this code should adapt. XXX</span>
<a href="#l10.165"></a><span id="l10.165">         snippetNode.textContent = &quot;...&quot;;</span>
<a href="#l10.166"></a><span id="l10.166">       }</span>
<a href="#l10.167"></a><span id="l10.167"> </span>
<a href="#l10.168"></a><span id="l10.168">       // get the subject node.</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineminus">-      let subjectNode = msgNode.getElementsByClassName(&quot;subject&quot;)[0];</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+      let subjectNode = msgNode.querySelector(&quot;.subject&quot;);</span>
<a href="#l10.171"></a><span id="l10.171">       subjectNode.msgs = msgs;</span>
<a href="#l10.172"></a><span id="l10.172">       subjectNode.addEventListener(&quot;click&quot;, function() {</span>
<a href="#l10.173"></a><span id="l10.173">         gFolderDisplay.selectMessages(this.msgs);</span>
<a href="#l10.174"></a><span id="l10.174">       }, true);</span>
<a href="#l10.175"></a><span id="l10.175"> </span>
<a href="#l10.176"></a><span id="l10.176" class="difflineminus">-      let tagsNode = msgNode.getElementsByClassName(&quot;tags&quot;)[0];</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+      let tagsNode = msgNode.querySelector(&quot;.tags&quot;);</span>
<a href="#l10.178"></a><span id="l10.178">       while (tagsNode.firstChild)</span>
<a href="#l10.179"></a><span id="l10.179">         tagsNode.removeChild(tagsNode.firstChild);</span>
<a href="#l10.180"></a><span id="l10.180">       this._addTagNodes(msgs, tagsNode);</span>
<a href="#l10.181"></a><span id="l10.181">       for (let [, msgHdr] in Iterator(msgs)) {</span>
<a href="#l10.182"></a><span id="l10.182">         this._msgNodes[msgHdr.messageKey + msgHdr.folder.URI] = msgNode;</span>
<a href="#l10.183"></a><span id="l10.183">       }</span>
<a href="#l10.184"></a><span id="l10.184">       messagesElt.appendChild(msgNode);</span>
<a href="#l10.185"></a><span id="l10.185">     }</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineat">@@ -373,17 +361,17 @@ MultiMessageSummary.prototype = {</span>
<a href="#l10.187"></a><span id="l10.187">             tags[tag.key] = tag;</span>
<a href="#l10.188"></a><span id="l10.188">           }</span>
<a href="#l10.189"></a><span id="l10.189">         }</span>
<a href="#l10.190"></a><span id="l10.190">       }</span>
<a href="#l10.191"></a><span id="l10.191">       for each (let [, tag] in Iterator(tags)) {</span>
<a href="#l10.192"></a><span id="l10.192">         let tagNode = tagsNode.ownerDocument.createElement('span');</span>
<a href="#l10.193"></a><span id="l10.193">         // see tagColors.css</span>
<a href="#l10.194"></a><span id="l10.194">         let colorClass = &quot;blc-&quot; + this._msgTagService.getColorForKey(tag.key).substr(1);</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineminus">-        _mm_addClass(tagNode, &quot;tag &quot; + tag.tag + &quot; &quot; + colorClass);</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineplus">+        _mm_addClass(tagNode, [&quot;tag&quot;, tag.tag, colorClass]);</span>
<a href="#l10.197"></a><span id="l10.197">         tagNode.textContent = tag.tag;</span>
<a href="#l10.198"></a><span id="l10.198">         tagsNode.appendChild(tagNode);</span>
<a href="#l10.199"></a><span id="l10.199">       }</span>
<a href="#l10.200"></a><span id="l10.200">   },</span>
<a href="#l10.201"></a><span id="l10.201"> </span>
<a href="#l10.202"></a><span id="l10.202">   /**</span>
<a href="#l10.203"></a><span id="l10.203">    * compute the size of the messages in the selection and display it</span>
<a href="#l10.204"></a><span id="l10.204">    * in the element of id &quot;size&quot;</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineat">@@ -407,17 +395,17 @@ MultiMessageSummary.prototype = {</span>
<a href="#l10.206"></a><span id="l10.206">     let notice = aContentDocument.getElementById('notice');</span>
<a href="#l10.207"></a><span id="l10.207">     if (aNumMessages &gt; aMaxCount) {</span>
<a href="#l10.208"></a><span id="l10.208">       let noticeText = gSelectionSummaryStrings.noticeText;</span>
<a href="#l10.209"></a><span id="l10.209">       noticeText = replaceInsert(noticeText, 1, aNumMessages);</span>
<a href="#l10.210"></a><span id="l10.210">       noticeText = replaceInsert(noticeText, 2, aMaxCount);</span>
<a href="#l10.211"></a><span id="l10.211">       notice.textContent = noticeText;</span>
<a href="#l10.212"></a><span id="l10.212">       _mm_removeClass(notice, 'hidden');</span>
<a href="#l10.213"></a><span id="l10.213">     } else {</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineminus">-      _mm_addClass(notice, 'hidden');</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineplus">+      _mm_addClass(notice, ['hidden']);</span>
<a href="#l10.216"></a><span id="l10.216">     }</span>
<a href="#l10.217"></a><span id="l10.217">   },</span>
<a href="#l10.218"></a><span id="l10.218"> </span>
<a href="#l10.219"></a><span id="l10.219">   // these are listeners for the gloda collections.</span>
<a href="#l10.220"></a><span id="l10.220">   onItemsAdded: function(aItems) {</span>
<a href="#l10.221"></a><span id="l10.221">   },</span>
<a href="#l10.222"></a><span id="l10.222">   onItemsModified: function(aItems) {</span>
<a href="#l10.223"></a><span id="l10.223">     this.processItems(aItems);</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineat">@@ -454,30 +442,30 @@ MultiMessageSummary.prototype = {</span>
<a href="#l10.225"></a><span id="l10.225">       if (! glodaMsg.read)</span>
<a href="#l10.226"></a><span id="l10.226">         headerNode.flags['unread'] = true;</span>
<a href="#l10.227"></a><span id="l10.227">       if (glodaMsg.starred)</span>
<a href="#l10.228"></a><span id="l10.228">         headerNode.flags['starred'] = true;</span>
<a href="#l10.229"></a><span id="l10.229"> </span>
<a href="#l10.230"></a><span id="l10.230">       // for tags, there's a minor problem in that if _some_ of the items in a</span>
<a href="#l10.231"></a><span id="l10.231">       // thread got modified</span>
<a href="#l10.232"></a><span id="l10.232">       let key = messageKey + glodaMsg.folder.uri;</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineminus">-      let tagsNode = headerNode.getElementsByClassName('tags')[0];</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineplus">+      let tagsNode = headerNode.querySelector('.tags');</span>
<a href="#l10.235"></a><span id="l10.235">       while (tagsNode.firstChild)</span>
<a href="#l10.236"></a><span id="l10.236">         tagsNode.removeChild(tagsNode.firstChild);</span>
<a href="#l10.237"></a><span id="l10.237">       this._addTagNodes([msg.folderMessage for each ([i,msg] in Iterator(aItems))],</span>
<a href="#l10.238"></a><span id="l10.238">                         tagsNode);</span>
<a href="#l10.239"></a><span id="l10.239">     }</span>
<a href="#l10.240"></a><span id="l10.240"> </span>
<a href="#l10.241"></a><span id="l10.241">     for ([, headerNode] in Iterator(knownMessageNodes)) {</span>
<a href="#l10.242"></a><span id="l10.242">       if (headerNode.flags['unread'])</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineminus">-        _mm_addClass(headerNode, &quot;unread&quot;);</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineplus">+        _mm_addClass(headerNode, [&quot;unread&quot;]);</span>
<a href="#l10.245"></a><span id="l10.245">       else</span>
<a href="#l10.246"></a><span id="l10.246">         _mm_removeClass(headerNode, &quot;unread&quot;);</span>
<a href="#l10.247"></a><span id="l10.247">       if (headerNode.flags['starred'])</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineminus">-        _mm_addClass(headerNode, &quot;starred&quot;);</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineplus">+        _mm_addClass(headerNode, [&quot;starred&quot;]);</span>
<a href="#l10.250"></a><span id="l10.250">       else</span>
<a href="#l10.251"></a><span id="l10.251">         _mm_removeClass(headerNode, &quot;starred&quot;);</span>
<a href="#l10.252"></a><span id="l10.252">       headerNode.flags = null;</span>
<a href="#l10.253"></a><span id="l10.253">     }</span>
<a href="#l10.254"></a><span id="l10.254">   },</span>
<a href="#l10.255"></a><span id="l10.255"> </span>
<a href="#l10.256"></a><span id="l10.256">   onQueryCompleted: function(aCollection) {</span>
<a href="#l10.257"></a><span id="l10.257">     /* if we need something that's just available from GlodaMessages,</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineat">@@ -552,21 +540,21 @@ ThreadSummary.prototype = {</span>
<a href="#l10.259"></a><span id="l10.259">     for (let i = 0; i &lt; numMessages; ++i) {</span>
<a href="#l10.260"></a><span id="l10.260">       count += 1;</span>
<a href="#l10.261"></a><span id="l10.261">       if (count &gt; MAX_THREADS) {</span>
<a href="#l10.262"></a><span id="l10.262">         maxCountExceeded = true;</span>
<a href="#l10.263"></a><span id="l10.263">         break;</span>
<a href="#l10.264"></a><span id="l10.264">       }</span>
<a href="#l10.265"></a><span id="l10.265">       let msgHdr = this._msgHdrs[i];</span>
<a href="#l10.266"></a><span id="l10.266"> </span>
<a href="#l10.267"></a><span id="l10.267" class="difflineminus">-      let msg_classes = &quot;message &quot;;</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineplus">+      let msg_classes = [&quot;message&quot;];</span>
<a href="#l10.269"></a><span id="l10.269">       if (! msgHdr.isRead)</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineminus">-        msg_classes += &quot; unread&quot;;</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineplus">+        msg_classes.push(&quot;unread&quot;);</span>
<a href="#l10.272"></a><span id="l10.272">       if (msgHdr.isFlagged)</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineminus">-        msg_classes += &quot; starred&quot;;</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineplus">+        msg_classes.push(&quot;starred&quot;);</span>
<a href="#l10.275"></a><span id="l10.275"> </span>
<a href="#l10.276"></a><span id="l10.276">       let senderName = _mm_FormatDisplayName(headerParser, msgHdr.mime2DecodedAuthor, &quot;from&quot;);</span>
<a href="#l10.277"></a><span id="l10.277">       let date = makeFriendlyDateAgo(new Date(msgHdr.date/1000));</span>
<a href="#l10.278"></a><span id="l10.278"> </span>
<a href="#l10.279"></a><span id="l10.279">       let msgContents = '&lt;div class=&quot;row&quot;&gt;' +</span>
<a href="#l10.280"></a><span id="l10.280">                         '  &lt;div class=&quot;star&quot;/&gt;' +</span>
<a href="#l10.281"></a><span id="l10.281">                         '  &lt;div class=&quot;header&quot;&gt;' +</span>
<a href="#l10.282"></a><span id="l10.282">                         '    &lt;div class=&quot;wrappedsender&quot;&gt;' +</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineat">@@ -582,18 +570,18 @@ ThreadSummary.prototype = {</span>
<a href="#l10.284"></a><span id="l10.284">       let msgNode = htmlpane.contentDocument.createElement(&quot;div&quot;);</span>
<a href="#l10.285"></a><span id="l10.285">       // innerHTML is safe here because all of the data in msgContents is</span>
<a href="#l10.286"></a><span id="l10.286">       // either generated from integers or escaped to be safe.</span>
<a href="#l10.287"></a><span id="l10.287">       msgNode.innerHTML = msgContents;</span>
<a href="#l10.288"></a><span id="l10.288">       _mm_addClass(msgNode, msg_classes);</span>
<a href="#l10.289"></a><span id="l10.289">       messagesElt.appendChild(msgNode);</span>
<a href="#l10.290"></a><span id="l10.290"> </span>
<a href="#l10.291"></a><span id="l10.291">       let key = msgHdr.messageKey + msgHdr.folder.URI;</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineminus">-      let snippetNode = msgNode.getElementsByClassName(&quot;snippet&quot;)[0];</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineminus">-      let senderNode = msgNode.getElementsByClassName(&quot;sender&quot;)[0];</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineplus">+      let snippetNode = msgNode.querySelector(&quot;.snippet&quot;);</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineplus">+      let senderNode = msgNode.querySelector(&quot;.sender&quot;);</span>
<a href="#l10.296"></a><span id="l10.296">       try {</span>
<a href="#l10.297"></a><span id="l10.297">         MsgHdrToMimeMessage(msgHdr, null, function(aMsgHdr, aMimeMsg) {</span>
<a href="#l10.298"></a><span id="l10.298">           if (aMimeMsg == null) /* shouldn't happen, but sometimes does? */ {</span>
<a href="#l10.299"></a><span id="l10.299">             return;</span>
<a href="#l10.300"></a><span id="l10.300">           }</span>
<a href="#l10.301"></a><span id="l10.301">           let [text, meta] = mimeMsgToContentSnippetAndMeta(aMimeMsg,</span>
<a href="#l10.302"></a><span id="l10.302">                                                             aMsgHdr.folder,</span>
<a href="#l10.303"></a><span id="l10.303">                                                             SNIPPET_LENGTH);</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineat">@@ -601,28 +589,28 @@ ThreadSummary.prototype = {</span>
<a href="#l10.305"></a><span id="l10.305">           if (meta.author)</span>
<a href="#l10.306"></a><span id="l10.306">             senderNode.textContent = meta.author;</span>
<a href="#l10.307"></a><span id="l10.307">         }, false, {saneBodySize: true});</span>
<a href="#l10.308"></a><span id="l10.308">       } catch (e if e.result == Components.results.NS_ERROR_FAILURE) {</span>
<a href="#l10.309"></a><span id="l10.309">         // Offline messages generate exceptions, which is unfortunate.  When</span>
<a href="#l10.310"></a><span id="l10.310">         // that's fixed, this code should adapt. XXX</span>
<a href="#l10.311"></a><span id="l10.311">         snippetNode.textContent = &quot;...&quot;;</span>
<a href="#l10.312"></a><span id="l10.312">       }</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineminus">-      let tagsNode = msgNode.getElementsByClassName(&quot;tags&quot;)[0];</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineplus">+      let tagsNode = msgNode.querySelector(&quot;.tags&quot;);</span>
<a href="#l10.315"></a><span id="l10.315">       let tags = this.getTagsForMsg(msgHdr);</span>
<a href="#l10.316"></a><span id="l10.316">       for each (let [,tag] in Iterator(tags)) {</span>
<a href="#l10.317"></a><span id="l10.317">         let tagNode = tagsNode.ownerDocument.createElement('span');</span>
<a href="#l10.318"></a><span id="l10.318">         // see tagColors.css</span>
<a href="#l10.319"></a><span id="l10.319">         let colorClass = &quot;blc-&quot; + this._msgTagService.getColorForKey(tag.key).substr(1);</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineminus">-        _mm_addClass(tagNode, &quot;tag &quot; + tag.tag + &quot; &quot; + colorClass);</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineplus">+        _mm_addClass(tagNode, [&quot;tag&quot;, tag.tag, colorClass]);</span>
<a href="#l10.322"></a><span id="l10.322">         tagNode.textContent = tag.tag;</span>
<a href="#l10.323"></a><span id="l10.323">         tagsNode.appendChild(tagNode);</span>
<a href="#l10.324"></a><span id="l10.324">       }</span>
<a href="#l10.325"></a><span id="l10.325"> </span>
<a href="#l10.326"></a><span id="l10.326" class="difflineminus">-      let sender = msgNode.getElementsByClassName(&quot;sender&quot;)[0];</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineplus">+      let sender = msgNode.querySelector(&quot;.sender&quot;);</span>
<a href="#l10.328"></a><span id="l10.328">       sender.msgHdr = msgHdr;</span>
<a href="#l10.329"></a><span id="l10.329">       sender.addEventListener(&quot;click&quot;, function(e) {</span>
<a href="#l10.330"></a><span id="l10.330">         // if the msg is the first message in a collapsed thread, we need to</span>
<a href="#l10.331"></a><span id="l10.331">         // uncollapse it.</span>
<a href="#l10.332"></a><span id="l10.332">         let origRowCount = gDBView.rowCount;</span>
<a href="#l10.333"></a><span id="l10.333">         let viewIndex = gDBView.findIndexOfMsgHdr(e.target.msgHdr, true);</span>
<a href="#l10.334"></a><span id="l10.334">         gDBView.selectFolderMsgByKey(this.folder, this.msgKey);</span>
<a href="#l10.335"></a><span id="l10.335">         if (gDBView.rowCount != origRowCount)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/base/content/specialTabs.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/base/content/specialTabs.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -180,22 +180,21 @@ const DOMLinkHandler = {</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5">       // Is this a failed icon?</span>
<a href="#l11.6"></a><span id="l11.6">       if (specialTabs.mFaviconService.isFailedFavicon(uri))</span>
<a href="#l11.7"></a><span id="l11.7">         return;</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9">       // Verify that the load of this icon is legal.</span>
<a href="#l11.10"></a><span id="l11.10">       // Some error or special pages can load their favicon.</span>
<a href="#l11.11"></a><span id="l11.11">       // To be on the safe side, only allow chrome:// favicons.</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-      let isAllowedPage = [</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-        /^about:neterror\?/,</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-        /^about:blocked\?/,</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-        /^about:certerror\?/,</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-        /^about:home$/</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-      ].some(function (re) { re.test(targetDoc.documentURI); });</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+      let isAllowedPage = (targetDoc.documentURI == &quot;about:home&quot;) ||</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+        [&quot;about:neterror?&quot;,</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+         &quot;about:blocked?&quot;,</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+         &quot;about:certerror?&quot;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+        ].some(function (aStart) { targetDoc.documentURI.startsWith(aStart); });</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24">       if (!isAllowedPage || !uri.schemeIs(&quot;chrome&quot;)) {</span>
<a href="#l11.25"></a><span id="l11.25">         // Be extra paraniod and just make sure we're not going to load</span>
<a href="#l11.26"></a><span id="l11.26">         // something we shouldn't. Firefox does this, so we're doing the same.</span>
<a href="#l11.27"></a><span id="l11.27">           try {</span>
<a href="#l11.28"></a><span id="l11.28">             Services.scriptSecurityManager.checkLoadURIWithPrincipal(targetDoc.nodePrincipal, uri,</span>
<a href="#l11.29"></a><span id="l11.29">                                            Components.interfaces.nsIScriptSecurityManager.DISALLOW_SCRIPT);</span>
<a href="#l11.30"></a><span id="l11.30">           }</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineat">@@ -564,18 +563,18 @@ var specialTabs = {</span>
<a href="#l11.32"></a><span id="l11.32">       let toolbox = clone.firstChild;</span>
<a href="#l11.33"></a><span id="l11.33">       toolbox.setAttribute(&quot;id&quot;, &quot;contentTabToolbox&quot; + this.lastBrowserId);</span>
<a href="#l11.34"></a><span id="l11.34">       toolbox.firstChild.setAttribute(&quot;id&quot;, &quot;contentTabToolbar&quot; + this.lastBrowserId);</span>
<a href="#l11.35"></a><span id="l11.35"> </span>
<a href="#l11.36"></a><span id="l11.36">       aTab.panel.appendChild(clone);</span>
<a href="#l11.37"></a><span id="l11.37">       aTab.root = clone;</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39">       // Start setting up the browser.</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-      aTab.browser = aTab.panel.getElementsByTagName(&quot;browser&quot;)[0];</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-      aTab.toolbar = aTab.panel.getElementsByClassName(&quot;contentTabToolbar&quot;)[0];</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+      aTab.browser = aTab.panel.querySelector(&quot;browser&quot;);</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+      aTab.toolbar = aTab.panel.querySelector(&quot;.contentTabToolbar&quot;);</span>
<a href="#l11.44"></a><span id="l11.44"> </span>
<a href="#l11.45"></a><span id="l11.45">       // As we're opening this tab, showTab may not get called, so set</span>
<a href="#l11.46"></a><span id="l11.46">       // the type according to if we're opening in background or not.</span>
<a href="#l11.47"></a><span id="l11.47">       let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l11.48"></a><span id="l11.48">       aTab.browser.setAttribute(&quot;type&quot;, background ? &quot;content-targetable&quot; :</span>
<a href="#l11.49"></a><span id="l11.49">                                                      &quot;content-primary&quot;);</span>
<a href="#l11.50"></a><span id="l11.50"> </span>
<a href="#l11.51"></a><span id="l11.51">       aTab.browser.setAttribute(&quot;id&quot;, &quot;contentTabBrowser&quot; + this.lastBrowserId);</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineat">@@ -588,17 +587,17 @@ var specialTabs = {</span>
<a href="#l11.53"></a><span id="l11.53">       // Set this attribute so that when favicons fail to load, we remove the</span>
<a href="#l11.54"></a><span id="l11.54">       // image attribute and just show the default tab icon.</span>
<a href="#l11.55"></a><span id="l11.55">       aTab.tabNode.setAttribute(&quot;onerror&quot;, &quot;this.removeAttribute('image');&quot;);</span>
<a href="#l11.56"></a><span id="l11.56"> </span>
<a href="#l11.57"></a><span id="l11.57">       aTab.browser.addEventListener(&quot;DOMLinkAdded&quot;, DOMLinkHandler, false);</span>
<a href="#l11.58"></a><span id="l11.58">       gPluginHandler.addEventListeners(aTab.browser);</span>
<a href="#l11.59"></a><span id="l11.59"> </span>
<a href="#l11.60"></a><span id="l11.60">       // Now initialise the find bar.</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-      aTab.findbar = aTab.panel.getElementsByTagName(&quot;findbar&quot;)[0];</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+      aTab.findbar = aTab.panel.querySelector(&quot;findbar&quot;);</span>
<a href="#l11.63"></a><span id="l11.63">       aTab.findbar.setAttribute(&quot;browserid&quot;,</span>
<a href="#l11.64"></a><span id="l11.64">                                 &quot;contentTabBrowser&quot; + this.lastBrowserId);</span>
<a href="#l11.65"></a><span id="l11.65"> </span>
<a href="#l11.66"></a><span id="l11.66">       // Default to reload being disabled.</span>
<a href="#l11.67"></a><span id="l11.67">       aTab.reloadEnabled = false;</span>
<a href="#l11.68"></a><span id="l11.68"> </span>
<a href="#l11.69"></a><span id="l11.69">       // Now set up the listeners.</span>
<a href="#l11.70"></a><span id="l11.70">       this._setUpLoadListener(aTab);</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineat">@@ -1006,17 +1005,17 @@ var specialTabs = {</span>
<a href="#l11.72"></a><span id="l11.72"> </span>
<a href="#l11.73"></a><span id="l11.73">       let toolbox = clone.firstChild;</span>
<a href="#l11.74"></a><span id="l11.74">       toolbox.setAttribute(&quot;id&quot;, &quot;chromeTabToolbox&quot; + this.lastBrowserId);</span>
<a href="#l11.75"></a><span id="l11.75">       toolbox.firstChild.setAttribute(&quot;id&quot;, &quot;chromeTabToolbar&quot; + this.lastBrowserId);</span>
<a href="#l11.76"></a><span id="l11.76"> </span>
<a href="#l11.77"></a><span id="l11.77">       aTab.panel.appendChild(clone);</span>
<a href="#l11.78"></a><span id="l11.78"> </span>
<a href="#l11.79"></a><span id="l11.79">       // Start setting up the browser.</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-      aTab.browser = aTab.panel.getElementsByTagName(&quot;browser&quot;)[0];</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+      aTab.browser = aTab.panel.querySelector(&quot;browser&quot;);</span>
<a href="#l11.82"></a><span id="l11.82"> </span>
<a href="#l11.83"></a><span id="l11.83">       // As we're opening this tab, showTab may not get called, so set</span>
<a href="#l11.84"></a><span id="l11.84">       // the type according to if we're opening in background or not.</span>
<a href="#l11.85"></a><span id="l11.85">       let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l11.86"></a><span id="l11.86">       // XXX not setting type as it's chrome</span>
<a href="#l11.87"></a><span id="l11.87">       //aTab.browser.setAttribute(&quot;type&quot;, background ? &quot;content-targetable&quot; :</span>
<a href="#l11.88"></a><span id="l11.88">       //                                               &quot;content-primary&quot;);</span>
<a href="#l11.89"></a><span id="l11.89"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/base/content/webSearchTab.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/base/content/webSearchTab.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -80,21 +80,21 @@ let webSearchTabType = {</span>
<a href="#l12.4"></a><span id="l12.4">     let clone = document.getElementById(&quot;webSearchTab&quot;).firstChild</span>
<a href="#l12.5"></a><span id="l12.5">                         .cloneNode(true);</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7">     clone.setAttribute(&quot;id&quot;, &quot;webSearchTab&quot; + this.lastBrowserId);</span>
<a href="#l12.8"></a><span id="l12.8">     clone.setAttribute(&quot;collapsed&quot;, false);</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10">     aTab.panel.appendChild(clone);</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    aTab.engines = clone.getElementsByClassName(&quot;engines&quot;)[0];</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-    aTab.defaultButton = clone.getElementsByClassName(&quot;defaultButton&quot;)[0];</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+    aTab.engines = clone.querySelector(&quot;.engines&quot;);</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+    aTab.defaultButton = clone.querySelector(&quot;.defaultButton&quot;);</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17">     // Start setting up the browser.</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-    aTab.browser = aTab.panel.getElementsByTagName(&quot;browser&quot;)[0];</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+    aTab.browser = aTab.panel.querySelector(&quot;browser&quot;);</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21">     // As we're opening this tab, showTab may not get called, so set</span>
<a href="#l12.22"></a><span id="l12.22">     // the type according to if we're opening in background or not.</span>
<a href="#l12.23"></a><span id="l12.23">     let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l12.24"></a><span id="l12.24">     aTab.browser.setAttribute(&quot;type&quot;, background ? &quot;content-targetable&quot; :</span>
<a href="#l12.25"></a><span id="l12.25">                                                    &quot;content-primary&quot;);</span>
<a href="#l12.26"></a><span id="l12.26"> </span>
<a href="#l12.27"></a><span id="l12.27">     aTab.browser.setAttribute(&quot;id&quot;, &quot;webSearchTabBrowser&quot; + this.lastBrowserId);</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineat">@@ -103,17 +103,17 @@ let webSearchTabType = {</span>
<a href="#l12.29"></a><span id="l12.29">                         aArgs.clickHandler :</span>
<a href="#l12.30"></a><span id="l12.30">                         &quot;specialTabs.defaultClickHandler(event);&quot;;</span>
<a href="#l12.31"></a><span id="l12.31">     aTab.browser.setAttribute(&quot;onclick&quot;, aTab.clickHandler);</span>
<a href="#l12.32"></a><span id="l12.32"> </span>
<a href="#l12.33"></a><span id="l12.33">     aTab.browser.addEventListener(&quot;DOMLinkAdded&quot;, DOMLinkHandler, false);</span>
<a href="#l12.34"></a><span id="l12.34">     gPluginHandler.addEventListeners(aTab.browser);</span>
<a href="#l12.35"></a><span id="l12.35"> </span>
<a href="#l12.36"></a><span id="l12.36">     // Now initialise the find bar.</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-    aTab.findbar = aTab.panel.getElementsByTagName(&quot;findbar&quot;)[0];</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+    aTab.findbar = aTab.panel.querySelector(&quot;findbar&quot;);</span>
<a href="#l12.39"></a><span id="l12.39">     aTab.findbar.setAttribute(&quot;browserid&quot;,</span>
<a href="#l12.40"></a><span id="l12.40">                               &quot;webSearchTabBrowser&quot; + this.lastBrowserId);</span>
<a href="#l12.41"></a><span id="l12.41"> </span>
<a href="#l12.42"></a><span id="l12.42">     // Default to reload being disabled.</span>
<a href="#l12.43"></a><span id="l12.43">     aTab.reloadEnabled = false;</span>
<a href="#l12.44"></a><span id="l12.44"> </span>
<a href="#l12.45"></a><span id="l12.45">     aTab.currentEngine = aArgs.engine;</span>
<a href="#l12.46"></a><span id="l12.46">     aTab.query = aArgs.query;</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineat">@@ -297,20 +297,20 @@ let webSearchTabType = {</span>
<a href="#l12.48"></a><span id="l12.48">     aTab.browser.loadURIWithFlags(submission.uri.spec, null, null, null,</span>
<a href="#l12.49"></a><span id="l12.49">                                   submission.postData);</span>
<a href="#l12.50"></a><span id="l12.50">   },</span>
<a href="#l12.51"></a><span id="l12.51"> </span>
<a href="#l12.52"></a><span id="l12.52">   _isInEngine: function(aEngine, aPreUri, aPostUri) {</span>
<a href="#l12.53"></a><span id="l12.53">     switch (aEngine.name) {</span>
<a href="#l12.54"></a><span id="l12.54">       case &quot;Google&quot;:</span>
<a href="#l12.55"></a><span id="l12.55">         return aPreUri.host == aPostUri.host &amp;&amp;</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-               /^\/search\?/.test(aPostUri.path);</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+               aPostUri.path.startsWith(&quot;/search?&quot;);</span>
<a href="#l12.58"></a><span id="l12.58">       case &quot;Yahoo&quot;:</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-        return /search\.yahoo\.com$/.test(aPostUri.host) &amp;&amp;</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-               !/^\/r\//.test(aPostUri.path);</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+        return aPostUri.host.endsWith(&quot;search.yahoo.com&quot;) &amp;&amp;</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+               !aPostUri.path.startsWith(&quot;/r/&quot;);</span>
<a href="#l12.63"></a><span id="l12.63">     }</span>
<a href="#l12.64"></a><span id="l12.64"> </span>
<a href="#l12.65"></a><span id="l12.65">     return aPreUri.host == aPostUri.host;</span>
<a href="#l12.66"></a><span id="l12.66">   },</span>
<a href="#l12.67"></a><span id="l12.67"> </span>
<a href="#l12.68"></a><span id="l12.68">   _setDefaultButtonState: function setDefaultButtonState(aTab, isDefault) {</span>
<a href="#l12.69"></a><span id="l12.69">     aTab.defaultButton.checked = isDefault;</span>
<a href="#l12.70"></a><span id="l12.70">     let key = &quot;websearch.&quot; + (isDefault ? &quot;isDefault&quot; : &quot;setDefault&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/extensions/mailviews/content/msgViewPickerOverlay.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/extensions/mailviews/content/msgViewPickerOverlay.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -118,27 +118,26 @@ var ViewPickerBinding = {</span>
<a href="#l13.4"></a><span id="l13.4">    * The effective view has changed, update the widget.</span>
<a href="#l13.5"></a><span id="l13.5">    */</span>
<a href="#l13.6"></a><span id="l13.6">   updateDisplay: function ViewPickerBinding_updateDisplay(aEvent, aGiveUpIfNotFound) {</span>
<a href="#l13.7"></a><span id="l13.7">     let viewPicker = document.getElementById(&quot;viewPicker&quot;);</span>
<a href="#l13.8"></a><span id="l13.8">     if (viewPicker) {</span>
<a href="#l13.9"></a><span id="l13.9">       let value = this.currentViewValue;</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11">       let viewPickerPopup = document.getElementById(&quot;viewPickerPopup&quot;);</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-      let selectedItems =</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-        viewPickerPopup.getElementsByAttribute(&quot;value&quot;, value);</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-      if (!selectedItems || !selectedItems.length)</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+      let selectedItem =</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+        viewPickerPopup.querySelector('[value=&quot;' + value + '&quot;]');</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+      if (!selectedItem)</span>
<a href="#l13.18"></a><span id="l13.18">       {</span>
<a href="#l13.19"></a><span id="l13.19">         // we may have a new item, so refresh to make it show up</span>
<a href="#l13.20"></a><span id="l13.20">         RefreshAllViewPopups(viewPickerPopup, true);</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-        selectedItems = viewPickerPopup.getElementsByAttribute(&quot;value&quot;, value);</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+        selectedItem = viewPickerPopup.querySelector('[value=&quot;' + value + '&quot;]');</span>
<a href="#l13.23"></a><span id="l13.23">       }</span>
<a href="#l13.24"></a><span id="l13.24">       viewPicker.setAttribute(&quot;label&quot;,</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-                              selectedItems &amp;&amp; selectedItems.length &amp;&amp;</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-                              selectedItems.item(0).getAttribute(&quot;label&quot;));</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+                              selectedItem &amp;&amp; selectedItem.getAttribute(&quot;label&quot;));</span>
<a href="#l13.28"></a><span id="l13.28">     }</span>
<a href="#l13.29"></a><span id="l13.29">   },</span>
<a href="#l13.30"></a><span id="l13.30"> };</span>
<a href="#l13.31"></a><span id="l13.31"> ViewPickerBinding._init();</span>
<a href="#l13.32"></a><span id="l13.32"> </span>
<a href="#l13.33"></a><span id="l13.33"> function LaunchCustomizeDialog()</span>
<a href="#l13.34"></a><span id="l13.34"> {</span>
<a href="#l13.35"></a><span id="l13.35">   OpenOrFocusWindow({}, &quot;mailnews:mailviewlist&quot;, &quot;chrome://messenger/content/mailViewList.xul&quot;);</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineat">@@ -163,24 +162,24 @@ function RefreshAllViewPopups(aViewPopup</span>
<a href="#l13.37"></a><span id="l13.37"> }</span>
<a href="#l13.38"></a><span id="l13.38"> </span>
<a href="#l13.39"></a><span id="l13.39"> </span>
<a href="#l13.40"></a><span id="l13.40"> function RefreshViewPopup(aViewPopup)</span>
<a href="#l13.41"></a><span id="l13.41"> {</span>
<a href="#l13.42"></a><span id="l13.42">   // mark default views if selected</span>
<a href="#l13.43"></a><span id="l13.43">   let currentViewValue = ViewPickerBinding.currentViewValue;</span>
<a href="#l13.44"></a><span id="l13.44"> </span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-  var viewAll = aViewPopup.getElementsByAttribute(&quot;value&quot;, kViewItemAll)[0];</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+  let viewAll = aViewPopup.querySelector('[value=&quot;' + kViewItemAll + '&quot;]');</span>
<a href="#l13.47"></a><span id="l13.47">   viewAll.setAttribute(&quot;checked&quot;, currentViewValue == kViewItemAll);</span>
<a href="#l13.48"></a><span id="l13.48">   let viewUnread =</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-    aViewPopup.getElementsByAttribute(&quot;value&quot;, kViewItemUnread)[0];</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+    aViewPopup.querySelector('[value=&quot;' + kViewItemUnread + '&quot;]');</span>
<a href="#l13.51"></a><span id="l13.51">   viewUnread.setAttribute(&quot;checked&quot;, currentViewValue == kViewItemUnread);</span>
<a href="#l13.52"></a><span id="l13.52"> </span>
<a href="#l13.53"></a><span id="l13.53">   let viewNotDeleted =</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-    aViewPopup.getElementsByAttribute(&quot;value&quot;, kViewItemNotDeleted)[0];</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+    aViewPopup.querySelector('[value=&quot;' + kViewItemNotDeleted + '&quot;]');</span>
<a href="#l13.56"></a><span id="l13.56">   var folderArray = GetSelectedMsgFolders();</span>
<a href="#l13.57"></a><span id="l13.57">   if (folderArray.length == 0)</span>
<a href="#l13.58"></a><span id="l13.58">     return;</span>
<a href="#l13.59"></a><span id="l13.59"> </span>
<a href="#l13.60"></a><span id="l13.60">   // only show the &quot;Not Deleted&quot; item for IMAP servers that are using the IMAP</span>
<a href="#l13.61"></a><span id="l13.61">   // delete model</span>
<a href="#l13.62"></a><span id="l13.62">   viewNotDeleted.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l13.63"></a><span id="l13.63">   var msgFolder = folderArray[0];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-dns-prefetch.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/test/mozmill/content-policy/test-dns-prefetch.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -15,16 +15,18 @@ var MODULE_NAME = 'test-exposed-in-conte</span>
<a href="#l14.4"></a><span id="l14.4"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l14.5"></a><span id="l14.5"> var MODULE_REQUIRES = ['folder-display-helpers', 'compose-helpers',</span>
<a href="#l14.6"></a><span id="l14.6">                        'content-tab-helpers'];</span>
<a href="#l14.7"></a><span id="l14.7"> var jumlib = {};</span>
<a href="#l14.8"></a><span id="l14.8"> Components.utils.import(&quot;resource://mozmill/modules/jum.js&quot;, jumlib);</span>
<a href="#l14.9"></a><span id="l14.9"> var elib = {};</span>
<a href="#l14.10"></a><span id="l14.10"> Components.utils.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+</span>
<a href="#l14.14"></a><span id="l14.14"> var folder = null;</span>
<a href="#l14.15"></a><span id="l14.15"> var composeHelper = null;</span>
<a href="#l14.16"></a><span id="l14.16"> var gMsgNo = 0;</span>
<a href="#l14.17"></a><span id="l14.17"> var gMsgHdr = null;</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19"> // These two constants are used to build the message body.</span>
<a href="#l14.20"></a><span id="l14.20"> const msgBody = '&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;\n' +</span>
<a href="#l14.21"></a><span id="l14.21"> '&lt;html&gt;\n' +</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -163,28 +165,16 @@ function test_dnsPrefetch_contentTab() {</span>
<a href="#l14.23"></a><span id="l14.23">   // in the data of what we want.</span>
<a href="#l14.24"></a><span id="l14.24">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l14.25"></a><span id="l14.25"> </span>
<a href="#l14.26"></a><span id="l14.26">   let dataurl = 'data:text/html,&lt;html&gt;&lt;head&gt;&lt;title&gt;test dns prefetch&lt;/title&gt;' +</span>
<a href="#l14.27"></a><span id="l14.27">     '&lt;/head&gt;&lt;body&gt;test dns prefetch&lt;/body&gt;&lt;/html&gt;';</span>
<a href="#l14.28"></a><span id="l14.28"> </span>
<a href="#l14.29"></a><span id="l14.29">   let newTab = open_content_tab_with_url(dataurl);</span>
<a href="#l14.30"></a><span id="l14.30"> </span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-  // XXX this should be a check for DNS prefetch being enabled, but bug 545407</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-  // needs fixing for that to work.</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-  var versionChecker =</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-    Components.classes[&quot;@mozilla.org/xpcom/version-comparator;1&quot;]</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-              .getService(Components.interfaces.nsIVersionComparator);</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-  if (versionChecker.compare(mc.window.Application.version, &quot;3.2a1pre&quot;) &gt;= 0) {</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-    if (!mc.tabmail.getBrowserForSelectedTab().docShell.allowDNSPrefetch)</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-      throw new Error(&quot;DNS prefetch unexpectedly disabled in content tabs&quot;);</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-  }</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-  else {</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-    if (mc.tabmail.getBrowserForSelectedTab().docShell.allowDNSPrefetch)</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-      throw new Error(&quot;DNS prefetch unexpectedly enabled2, has bug 545407 been fixed?&quot; + mc.window.Application.version);</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-  }</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+  if (!mc.tabmail.getBrowserForSelectedTab().docShell.allowDNSPrefetch)</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+    throw new Error(&quot;DNS prefetch unexpectedly disabled in content tabs&quot;);</span>
<a href="#l14.47"></a><span id="l14.47"> </span>
<a href="#l14.48"></a><span id="l14.48">   mc.tabmail.closeTab(newTab);</span>
<a href="#l14.49"></a><span id="l14.49"> </span>
<a href="#l14.50"></a><span id="l14.50">   if (mc.tabmail.tabContainer.childNodes.length != preCount)</span>
<a href="#l14.51"></a><span id="l14.51">     throw new Error(&quot;The content tab didn't close&quot;);</span>
<a href="#l14.52"></a><span id="l14.52"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-content-tab.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-content-tab.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -53,17 +53,17 @@ function test_content_tab_open() {</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5"> /**</span>
<a href="#l15.6"></a><span id="l15.6">  * Just make sure that the context menu does what we expect in content tabs wrt.</span>
<a href="#l15.7"></a><span id="l15.7">  * spell checking options.</span>
<a href="#l15.8"></a><span id="l15.8">  */</span>
<a href="#l15.9"></a><span id="l15.9"> function test_spellcheck_in_content_tabs() {</span>
<a href="#l15.10"></a><span id="l15.10">   let tabmail = mc.tabmail;</span>
<a href="#l15.11"></a><span id="l15.11">   let w = tabmail.selectedTab.browser.contentWindow;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  let textarea = w.document.getElementsByTagName(&quot;textarea&quot;)[0];</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+  let textarea = w.document.querySelector(&quot;textarea&quot;);</span>
<a href="#l15.14"></a><span id="l15.14">   let eidMailContext = mc.eid(&quot;mailContext&quot;);</span>
<a href="#l15.15"></a><span id="l15.15"> </span>
<a href="#l15.16"></a><span id="l15.16">   // Test a few random items</span>
<a href="#l15.17"></a><span id="l15.17">   mc.click(new elementslib.Elem(textarea));</span>
<a href="#l15.18"></a><span id="l15.18">   // Bug 364914 causes textareas to not be spell checked until they have been</span>
<a href="#l15.19"></a><span id="l15.19">   // focused at last once, so give the event loop a chance to spin.</span>
<a href="#l15.20"></a><span id="l15.20">   mc.sleep(0);</span>
<a href="#l15.21"></a><span id="l15.21">   mc.rightClick(new elementslib.Elem(textarea));</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -94,17 +94,17 @@ function test_spellcheck_in_content_tabs</span>
<a href="#l15.23"></a><span id="l15.23">   close_popup(mc, eidMailContext);</span>
<a href="#l15.24"></a><span id="l15.24"> }</span>
<a href="#l15.25"></a><span id="l15.25"> // XXX Currently the spellcheck test has focus issues on non-Mac</span>
<a href="#l15.26"></a><span id="l15.26"> test_spellcheck_in_content_tabs.EXCLUDED_PLATFORMS = ['winnt', 'linux'];</span>
<a href="#l15.27"></a><span id="l15.27"> </span>
<a href="#l15.28"></a><span id="l15.28"> function test_content_tab_context_menu() {</span>
<a href="#l15.29"></a><span id="l15.29">   let tabmail = mc.tabmail;</span>
<a href="#l15.30"></a><span id="l15.30">   let w = tabmail.selectedTab.browser.contentWindow;</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-  let heading = w.document.getElementsByTagName(&quot;h1&quot;)[0];</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+  let heading = w.document.querySelector(&quot;h1&quot;);</span>
<a href="#l15.33"></a><span id="l15.33">   let mailContext = mc.e(&quot;mailContext&quot;);</span>
<a href="#l15.34"></a><span id="l15.34"> </span>
<a href="#l15.35"></a><span id="l15.35">   // Make sure the page's menu items are added on right-click.</span>
<a href="#l15.36"></a><span id="l15.36">   EventUtils.synthesizeMouse(heading, 5, 5, { type: &quot;contextmenu&quot;, button: 2 },</span>
<a href="#l15.37"></a><span id="l15.37">                              w);</span>
<a href="#l15.38"></a><span id="l15.38">   wait_for_popup_to_open(mailContext);</span>
<a href="#l15.39"></a><span id="l15.39">   assert_equals(mailContext.firstChild.label, &quot;Click me!&quot;);</span>
<a href="#l15.40"></a><span id="l15.40">   assert_element_visible(&quot;page-menu-separator&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-message-commands.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-message-commands.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -8,16 +8,17 @@</span>
<a href="#l16.4"></a><span id="l16.4">  * front end - which is why Archive is the only command currently tested.</span>
<a href="#l16.5"></a><span id="l16.5">  */</span>
<a href="#l16.6"></a><span id="l16.6"> var MODULE_NAME = 'test-message-commands';</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l16.9"></a><span id="l16.9"> var MODULE_REQUIRES = ['folder-display-helpers', 'content-tab-helpers'];</span>
<a href="#l16.10"></a><span id="l16.10"> </span>
<a href="#l16.11"></a><span id="l16.11"> Components.utils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l16.13"></a><span id="l16.13"> </span>
<a href="#l16.14"></a><span id="l16.14"> var unreadFolder;</span>
<a href="#l16.15"></a><span id="l16.15"> var archiveSrcFolder = null;</span>
<a href="#l16.16"></a><span id="l16.16"> var archiveURI;</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18"> var acctMgr;</span>
<a href="#l16.19"></a><span id="l16.19"> var tagArray;</span>
<a href="#l16.20"></a><span id="l16.20"> </span>
<a href="#l16.21"></a><span id="l16.21" class="difflineat">@@ -77,19 +78,17 @@ function check_read_menuitems(index, can</span>
<a href="#l16.22"></a><span id="l16.22">               &quot;abled when it shouldn't be!&quot;);</span>
<a href="#l16.23"></a><span id="l16.23"> </span>
<a href="#l16.24"></a><span id="l16.24">   assert_true(unreadEnabled == canMarkUnread,</span>
<a href="#l16.25"></a><span id="l16.25">               &quot;Mark unread menu item &quot; + (canMarkUnread ? &quot;dis&quot; : &quot;en&quot;) +</span>
<a href="#l16.26"></a><span id="l16.26">               &quot;abled when it shouldn't be!&quot;);</span>
<a href="#l16.27"></a><span id="l16.27"> }</span>
<a href="#l16.28"></a><span id="l16.28"> </span>
<a href="#l16.29"></a><span id="l16.29"> function enable_archiving(enabled) {</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-  Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-   .getService(Ci.nsIPrefService).getBranch(null)</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-   .setBoolPref(&quot;mail.identity.default.archive_enabled&quot;, enabled);</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.identity.default.archive_enabled&quot;, enabled);</span>
<a href="#l16.34"></a><span id="l16.34"> }</span>
<a href="#l16.35"></a><span id="l16.35"> </span>
<a href="#l16.36"></a><span id="l16.36"> /**</span>
<a href="#l16.37"></a><span id="l16.37">  * Mark a message read or unread via the context menu</span>
<a href="#l16.38"></a><span id="l16.38">  * @param index the row in the thread pane of the message to mark read/unread</span>
<a href="#l16.39"></a><span id="l16.39">  * @param read true the message should be marked read, false otherwise</span>
<a href="#l16.40"></a><span id="l16.40">  */</span>
<a href="#l16.41"></a><span id="l16.41"> function mark_read_via_menu(index, read) {</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineat">@@ -355,19 +354,17 @@ function monthly_archive(keep_structure)</span>
<a href="#l16.43"></a><span id="l16.43">   be_in_folder(lastArchiveFolder);</span>
<a href="#l16.44"></a><span id="l16.44">   assert_true(mc.dbView.getMsgHdrAt(0).messageId == lastMsgHdrMsgId,</span>
<a href="#l16.45"></a><span id="l16.45">               &quot;Message should have been archived to Local Folders/&quot; +</span>
<a href="#l16.46"></a><span id="l16.46">               lastMsgYear + &quot;/&quot; + lastMonthFolderName + &quot;/Archives, but it isn't present there&quot;);</span>
<a href="#l16.47"></a><span id="l16.47"> }</span>
<a href="#l16.48"></a><span id="l16.48"> </span>
<a href="#l16.49"></a><span id="l16.49"> function test_folder_structure_archiving() {</span>
<a href="#l16.50"></a><span id="l16.50">   enable_archiving(true);</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-  Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-   .getService(Ci.nsIPrefService).getBranch(null)</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-   .setBoolPref(&quot;mail.identity.default.archive_keep_folder_structure&quot;, true);</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.identity.default.archive_keep_folder_structure&quot;, true);</span>
<a href="#l16.55"></a><span id="l16.55">   monthly_archive(true);</span>
<a href="#l16.56"></a><span id="l16.56">   yearly_archive(true);</span>
<a href="#l16.57"></a><span id="l16.57"> }</span>
<a href="#l16.58"></a><span id="l16.58"> </span>
<a href="#l16.59"></a><span id="l16.59"> function test_selection_after_archive() {</span>
<a href="#l16.60"></a><span id="l16.60">   enable_archiving(true);</span>
<a href="#l16.61"></a><span id="l16.61">   be_in_folder(archiveSrcFolder);</span>
<a href="#l16.62"></a><span id="l16.62">   let identity = acctMgr.getFirstIdentityForServer(mc.folderDisplay.view.dbView</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-summarization.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-summarization.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -317,20 +317,20 @@ function extract_first_address(thread)</span>
<a href="#l17.4"></a><span id="l17.4">     thread1.getMsgHdr(0).mime2DecodedAuthor,</span>
<a href="#l17.5"></a><span id="l17.5">     addresses, names, fullNames);</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7">   return {email: addresses.value[0], name: names.value[0]};</span>
<a href="#l17.8"></a><span id="l17.8"> }</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10"> function check_address_name(name) {</span>
<a href="#l17.11"></a><span id="l17.11">   let htmlframe = mc.e('multimessage');</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  let matches = htmlframe.contentDocument.getElementsByClassName('sender');</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-  if (matches[0].textContent != name)</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+  let match = htmlframe.contentDocument.querySelector('.sender');</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+  if (match.textContent != name)</span>
<a href="#l17.16"></a><span id="l17.16">     throw new Error(&quot;Expected to find sender named '&quot; + name + &quot;', found '&quot; +</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-                    matches[0].textContent + &quot;'&quot;);</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+                    match.textContent + &quot;'&quot;);</span>
<a href="#l17.19"></a><span id="l17.19"> }</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21"> function test_display_name_no_abook()</span>
<a href="#l17.22"></a><span id="l17.22"> {</span>
<a href="#l17.23"></a><span id="l17.23">   be_in_folder(folder);</span>
<a href="#l17.24"></a><span id="l17.24"> </span>
<a href="#l17.25"></a><span id="l17.25">   let address = extract_first_address(thread1);</span>
<a href="#l17.26"></a><span id="l17.26">   ensure_no_card_exists(address.email);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-tooltip-multimessage.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-tooltip-multimessage.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -32,17 +32,17 @@ function test_tooltips() {</span>
<a href="#l18.4"></a><span id="l18.4">   toggle_thread_row(0);</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6">   /* Get the needed elements */</span>
<a href="#l18.7"></a><span id="l18.7">   let mm = mc.eid(&quot;multimessage&quot;).node;</span>
<a href="#l18.8"></a><span id="l18.8">   let mmDoc = mm.contentDocument;</span>
<a href="#l18.9"></a><span id="l18.9">   let tooltip = mc.eid(&quot;aHTMLTooltip&quot;).node;</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11">   /* Test a XUL element */</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  let trashButton = mmDoc.getElementsByClassName(&quot;hdrTrashButton&quot;)[0];</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+  let trashButton = mmDoc.querySelector(&quot;.hdrTrashButton&quot;);</span>
<a href="#l18.14"></a><span id="l18.14">   trashButton.setAttribute(&quot;title&quot;, &quot;Title1&quot;);</span>
<a href="#l18.15"></a><span id="l18.15">   trashButton.setAttribute(&quot;tooltiptext&quot;, &quot;TTT1&quot;);</span>
<a href="#l18.16"></a><span id="l18.16">   mc.window.FillInHTMLTooltip(trashButton);</span>
<a href="#l18.17"></a><span id="l18.17">   assert_equals(tooltip.getAttribute(&quot;label&quot;), &quot;TTT1&quot;, &quot;This XUL element had its title taken as the tooltip instead of the tooltiptext attribute.&quot;);</span>
<a href="#l18.18"></a><span id="l18.18">   </span>
<a href="#l18.19"></a><span id="l18.19">   /* Test an HTML element */</span>
<a href="#l18.20"></a><span id="l18.20">   let a = mmDoc.createElement(&quot;a&quot;);</span>
<a href="#l18.21"></a><span id="l18.21">   a.setAttribute(&quot;href&quot;, &quot;#&quot;);</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineat">@@ -51,12 +51,12 @@ function test_tooltips() {</span>
<a href="#l18.23"></a><span id="l18.23">   mc.window.FillInHTMLTooltip(a);</span>
<a href="#l18.24"></a><span id="l18.24">   assert_equals(tooltip.getAttribute(&quot;label&quot;), &quot;Title2&quot;, &quot;This HTML element had its tooltiptext taken as the tooltip instead of the title attribute.&quot;);</span>
<a href="#l18.25"></a><span id="l18.25"> </span>
<a href="#l18.26"></a><span id="l18.26">   /* Create an element with xlink */</span>
<a href="#l18.27"></a><span id="l18.27">   let div = mmDoc.createElement(&quot;div&quot;);</span>
<a href="#l18.28"></a><span id="l18.28">   div.innerHTML = '&lt;span xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; version=&quot;1.0&quot;&gt;'+</span>
<a href="#l18.29"></a><span id="l18.29">     '&lt;a href=&quot;#&quot; title=&quot;Title3&quot; xlink:title=&quot;XTitle3&quot; tooltiptext=&quot;TTT3&quot;&gt;Hi there&lt;/a&gt;'+</span>
<a href="#l18.30"></a><span id="l18.30">     '&lt;/span&gt;';</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-  let xlink = div.getElementsByTagName(&quot;a&quot;)[0];</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+  let xlink = div.querySelector(&quot;a&quot;);</span>
<a href="#l18.33"></a><span id="l18.33">   mc.window.FillInHTMLTooltip(xlink);</span>
<a href="#l18.34"></a><span id="l18.34">   assert_equals(tooltip.getAttribute(&quot;label&quot;), &quot;XTitle3&quot;, &quot;This HTML element had its something else taken as the tooltip instead of the xlink:title attribute.&quot;);</span>
<a href="#l18.35"></a><span id="l18.35"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/test/mozmill/message-header/test-message-header.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-message-header.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -9,16 +9,17 @@ var MODULE_NAME = 'test-message-header';</span>
<a href="#l19.4"></a><span id="l19.4"> </span>
<a href="#l19.5"></a><span id="l19.5"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l19.6"></a><span id="l19.6"> var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l19.7"></a><span id="l19.7">                        'address-book-helpers', 'dom-helpers'];</span>
<a href="#l19.8"></a><span id="l19.8"> </span>
<a href="#l19.9"></a><span id="l19.9"> var elib = {};</span>
<a href="#l19.10"></a><span id="l19.10"> Cu.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l19.11"></a><span id="l19.11"> Cu.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.13"></a><span id="l19.13"> </span>
<a href="#l19.14"></a><span id="l19.14"> var folder, folderMore;</span>
<a href="#l19.15"></a><span id="l19.15"> var gInterestingMessage;</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17"> function setupModule(module) {</span>
<a href="#l19.18"></a><span id="l19.18">   let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l19.19"></a><span id="l19.19">   fdh.installInto(module);</span>
<a href="#l19.20"></a><span id="l19.20">   let wh = collector.getModule('window-helpers');</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineat">@@ -215,19 +216,17 @@ function assert_shown(id, visible) {</span>
<a href="#l19.22"></a><span id="l19.22">     throw new Error('&quot;' + id + '&quot; should be ' +</span>
<a href="#l19.23"></a><span id="l19.23">                     (visible ? &quot;visible&quot; : &quot;hidden&quot;));</span>
<a href="#l19.24"></a><span id="l19.24"> }</span>
<a href="#l19.25"></a><span id="l19.25"> </span>
<a href="#l19.26"></a><span id="l19.26"> /**</span>
<a href="#l19.27"></a><span id="l19.27">  * Test that clicking references context menu works properly.</span>
<a href="#l19.28"></a><span id="l19.28">  */</span>
<a href="#l19.29"></a><span id="l19.29"> function test_msg_id_context_menu() {</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-    .getService(Ci.nsIPrefService).getBranch(null);</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-  prefBranch.setBoolPref(&quot;mailnews.headers.showReferences&quot;, true);</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mailnews.headers.showReferences&quot;, true);</span>
<a href="#l19.34"></a><span id="l19.34"> </span>
<a href="#l19.35"></a><span id="l19.35">   // Add a new message</span>
<a href="#l19.36"></a><span id="l19.36">   let msg = create_message({</span>
<a href="#l19.37"></a><span id="l19.37">     clobberHeaders: {</span>
<a href="#l19.38"></a><span id="l19.38">       &quot;References&quot;: &quot;&lt;4880C986@example.com&gt; &lt;4880CAB2@example.com&gt; &lt;4880CC76@example.com&gt;&quot;</span>
<a href="#l19.39"></a><span id="l19.39">     }});</span>
<a href="#l19.40"></a><span id="l19.40">   add_message_to_folder(folder, msg);</span>
<a href="#l19.41"></a><span id="l19.41">   be_in_folder(folder);</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineat">@@ -241,17 +240,17 @@ function test_msg_id_context_menu() {</span>
<a href="#l19.43"></a><span id="l19.43"> </span>
<a href="#l19.44"></a><span id="l19.44">   // Ensure Open Message For ID is shown... and that Open Browser With Message-ID</span>
<a href="#l19.45"></a><span id="l19.45">   // isn't shown.</span>
<a href="#l19.46"></a><span id="l19.46">   assert_shown(&quot;messageIdContext-openMessageForMsgId&quot;, true);</span>
<a href="#l19.47"></a><span id="l19.47">   assert_shown(&quot;messageIdContext-openBrowserWithMsgId&quot;, false);</span>
<a href="#l19.48"></a><span id="l19.48"> </span>
<a href="#l19.49"></a><span id="l19.49">   close_popup(mc, mc.eid(&quot;messageIdContext&quot;));</span>
<a href="#l19.50"></a><span id="l19.50"> </span>
<a href="#l19.51"></a><span id="l19.51" class="difflineminus">-  prefBranch.setBoolPref(&quot;mailnews.headers.showReferences&quot;, false);</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mailnews.headers.showReferences&quot;, false);</span>
<a href="#l19.53"></a><span id="l19.53"> }</span>
<a href="#l19.54"></a><span id="l19.54"> </span>
<a href="#l19.55"></a><span id="l19.55"> /**</span>
<a href="#l19.56"></a><span id="l19.56">  * Test that if a contact belongs to a mailing list within their</span>
<a href="#l19.57"></a><span id="l19.57">  * address book, then the inline contact editor will not allow</span>
<a href="#l19.58"></a><span id="l19.58">  * the user to change what address book the contact belongs to.</span>
<a href="#l19.59"></a><span id="l19.59">  * The editor should also show a message to explain why the</span>
<a href="#l19.60"></a><span id="l19.60">  * contact cannot be moved.</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineat">@@ -535,19 +534,17 @@ function help_get_num_lines(node) {</span>
<a href="#l19.62"></a><span id="l19.62">  * Test that the &quot;more&quot; widget displays when it should.</span>
<a href="#l19.63"></a><span id="l19.63">  * @param toDescription the description node for the &quot;to&quot; field</span>
<a href="#l19.64"></a><span id="l19.64">  */</span>
<a href="#l19.65"></a><span id="l19.65"> function subtest_more_widget_display(toDescription) {</span>
<a href="#l19.66"></a><span id="l19.66">   // test that the to element doesn't have more than max lines</span>
<a href="#l19.67"></a><span id="l19.67">   let numLines = help_get_num_lines(toDescription);</span>
<a href="#l19.68"></a><span id="l19.68"> </span>
<a href="#l19.69"></a><span id="l19.69">   // get maxline pref</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineminus">-    .getService(Ci.nsIPrefService).getBranch(null);</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineminus">-  let maxLines = prefBranch.getIntPref(</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+  let maxLines = Services.prefs.getIntPref(</span>
<a href="#l19.74"></a><span id="l19.74">     &quot;mailnews.headers.show_n_lines_before_more&quot;);</span>
<a href="#l19.75"></a><span id="l19.75"> </span>
<a href="#l19.76"></a><span id="l19.76">   // allow for a 15% tolerance for any padding that may be applied</span>
<a href="#l19.77"></a><span id="l19.77">   if (numLines &lt; 0.85*maxLines || numLines &gt; 1.15*maxLines) {</span>
<a href="#l19.78"></a><span id="l19.78">     throw new Error(&quot;expected == &quot; + maxLines + &quot;lines; found &quot; + numLines);</span>
<a href="#l19.79"></a><span id="l19.79">   }</span>
<a href="#l19.80"></a><span id="l19.80"> </span>
<a href="#l19.81"></a><span id="l19.81">   // test that we've got a (more) node and that it's expanded</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineat">@@ -628,36 +625,32 @@ function subtest_more_widget_star_click(</span>
<a href="#l19.83"></a><span id="l19.83"> </span>
<a href="#l19.84"></a><span id="l19.84"> /**</span>
<a href="#l19.85"></a><span id="l19.85">  * Make sure the (more) widget hidden pref actually works with a</span>
<a href="#l19.86"></a><span id="l19.86">  * non-default value.</span>
<a href="#l19.87"></a><span id="l19.87">  */</span>
<a href="#l19.88"></a><span id="l19.88"> function test_more_widget_with_maxlines_of_3(){</span>
<a href="#l19.89"></a><span id="l19.89"> </span>
<a href="#l19.90"></a><span id="l19.90">   // set maxLines to 3</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineminus">-    .getService(Ci.nsIPrefService).getBranch(null);</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineminus">-  let maxLines = prefBranch.setIntPref(</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+  let maxLines = Services.prefs.setIntPref(</span>
<a href="#l19.95"></a><span id="l19.95">     &quot;mailnews.headers.show_n_lines_before_more&quot;, 3);</span>
<a href="#l19.96"></a><span id="l19.96"> </span>
<a href="#l19.97"></a><span id="l19.97">   // call test_more_widget again</span>
<a href="#l19.98"></a><span id="l19.98">   // We need to look at the second last article in the display list.</span>
<a href="#l19.99"></a><span id="l19.99">   test_more_widget();</span>
<a href="#l19.100"></a><span id="l19.100"> }</span>
<a href="#l19.101"></a><span id="l19.101"> </span>
<a href="#l19.102"></a><span id="l19.102"> /**</span>
<a href="#l19.103"></a><span id="l19.103">  * Make sure the (more) widget hidden pref also works with an</span>
<a href="#l19.104"></a><span id="l19.104">  * &quot;all&quot; (0) non-default value.</span>
<a href="#l19.105"></a><span id="l19.105">  */</span>
<a href="#l19.106"></a><span id="l19.106"> function test_more_widget_with_disabled_more(){</span>
<a href="#l19.107"></a><span id="l19.107"> </span>
<a href="#l19.108"></a><span id="l19.108">   // set maxLines to 0</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineminus">-    .getService(Ci.nsIPrefService).getBranch(null);</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineminus">-  let maxLines = prefBranch.setIntPref(</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineplus">+  let maxLines = Services.prefs.setIntPref(</span>
<a href="#l19.113"></a><span id="l19.113">     &quot;mailnews.headers.show_n_lines_before_more&quot;, 0);</span>
<a href="#l19.114"></a><span id="l19.114"> </span>
<a href="#l19.115"></a><span id="l19.115">   // generate message with 35 recips (effectively guarantees overflow for n=3)</span>
<a href="#l19.116"></a><span id="l19.116">   be_in_folder(folder);</span>
<a href="#l19.117"></a><span id="l19.117">   let msg = create_message({toCount: 35});</span>
<a href="#l19.118"></a><span id="l19.118"> </span>
<a href="#l19.119"></a><span id="l19.119">   // add the message to the end of the folder</span>
<a href="#l19.120"></a><span id="l19.120">   add_message_to_folder(folder, msg);</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineat">@@ -853,17 +846,17 @@ function subtest_addresses_in_tooltip_te</span>
<a href="#l19.122"></a><span id="l19.122">   let headerBoxElement = mc.e(aHeaderBox);</span>
<a href="#l19.123"></a><span id="l19.123">   let moreIndicator = headerBoxElement.more;</span>
<a href="#l19.124"></a><span id="l19.124">   let tooltipText = moreIndicator.getAttribute(&quot;tooltiptext&quot;);</span>
<a href="#l19.125"></a><span id="l19.125">   let maxTooltipAddrsNum = headerBoxElement.maxAddressesInMoreTooltipValue;</span>
<a href="#l19.126"></a><span id="l19.126">   let addrsNumInTooltip = 0;</span>
<a href="#l19.127"></a><span id="l19.127"> </span>
<a href="#l19.128"></a><span id="l19.128">   for (let i = aShownAddrsNum; (i &lt; numAddresses) &amp;&amp;</span>
<a href="#l19.129"></a><span id="l19.129">                                (i &lt; maxTooltipAddrsNum + aShownAddrsNum); i++) {</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineminus">-    assert_true(tooltipText.indexOf(fullNames.value[i]) != -1, fullNames.value[i]);</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineplus">+    assert_true(tooltipText.contains(fullNames.value[i]), fullNames.value[i]);</span>
<a href="#l19.132"></a><span id="l19.132">     addrsNumInTooltip += 1;</span>
<a href="#l19.133"></a><span id="l19.133">   }</span>
<a href="#l19.134"></a><span id="l19.134"> </span>
<a href="#l19.135"></a><span id="l19.135">   if (aHiddenAddrsNum &lt; maxTooltipAddrsNum) {</span>
<a href="#l19.136"></a><span id="l19.136">     assert_equals(aHiddenAddrsNum, addrsNumInTooltip);</span>
<a href="#l19.137"></a><span id="l19.137">   }</span>
<a href="#l19.138"></a><span id="l19.138">   else {</span>
<a href="#l19.139"></a><span id="l19.139">     assert_equals(maxTooltipAddrsNum, addrsNumInTooltip);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/test/mozmill/message-header/test-phishing-bar.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-phishing-bar.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -47,17 +47,17 @@ function assert_phishing_bar_visible(msg</span>
<a href="#l20.4"></a><span id="l20.4"> </span>
<a href="#l20.5"></a><span id="l20.5"> /**</span>
<a href="#l20.6"></a><span id="l20.6">  * Make sure that the phishing bar gets hidden when the ignore button is</span>
<a href="#l20.7"></a><span id="l20.7">  * clicked.</span>
<a href="#l20.8"></a><span id="l20.8">  *</span>
<a href="#l20.9"></a><span id="l20.9">  * @param msgc the Mozmill controller for the message window</span>
<a href="#l20.10"></a><span id="l20.10">  */</span>
<a href="#l20.11"></a><span id="l20.11"> function help_test_hide_phishing_bar(msgc) {</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-  let phishingButton = msgc.e(&quot;phishingBar&quot;).getElementsByTagName(&quot;button&quot;)[0];</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+  let phishingButton = msgc.e(&quot;phishingBar&quot;).querySelector(&quot;button&quot;);</span>
<a href="#l20.14"></a><span id="l20.14">   assert_phishing_bar_visible(msgc);</span>
<a href="#l20.15"></a><span id="l20.15"> </span>
<a href="#l20.16"></a><span id="l20.16">   msgc.click(new elib.Elem(phishingButton));</span>
<a href="#l20.17"></a><span id="l20.17">   wait_for_message_display_completion(msgc, true);</span>
<a href="#l20.18"></a><span id="l20.18">   assert_true(msgc.e(&quot;msgNotificationBar&quot;).collapsed);</span>
<a href="#l20.19"></a><span id="l20.19"> }</span>
<a href="#l20.20"></a><span id="l20.20"> </span>
<a href="#l20.21"></a><span id="l20.21"> function test_hide_phishing_bar_from_message() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/test/mozmill/message-header/test-reply-identity.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-reply-identity.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -90,17 +90,17 @@ var addIdentitiesAndFolder = function() </span>
<a href="#l21.4"></a><span id="l21.4">   let account = MailServices.accounts.createAccount();</span>
<a href="#l21.5"></a><span id="l21.5">   account.incomingServer = server;</span>
<a href="#l21.6"></a><span id="l21.6">   account.addIdentity(identity);</span>
<a href="#l21.7"></a><span id="l21.7">   account.addIdentity(identity2);</span>
<a href="#l21.8"></a><span id="l21.8"> }</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10"> var checkReply = function (replyWin, expectedFromEmail) {</span>
<a href="#l21.11"></a><span id="l21.11">   let identityList = replyWin.e(&quot;msgIdentity&quot;);</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-  if (identityList.selectedItem.label.indexOf(expectedFromEmail) == -1)</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+  if (!identityList.selectedItem.label.contains(expectedFromEmail))</span>
<a href="#l21.14"></a><span id="l21.14">     throw new Error(&quot;The From address is not correctly selected! Expected: &quot; +</span>
<a href="#l21.15"></a><span id="l21.15">                     expectedFromEmail + &quot;; Actual: &quot;  +</span>
<a href="#l21.16"></a><span id="l21.16">                     identityList.selectedItem.label);</span>
<a href="#l21.17"></a><span id="l21.17"> }</span>
<a href="#l21.18"></a><span id="l21.18"> </span>
<a href="#l21.19"></a><span id="l21.19"> function test_reply_no_matching_identity() {</span>
<a href="#l21.20"></a><span id="l21.20">   be_in_folder(testFolder);</span>
<a href="#l21.21"></a><span id="l21.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -94,14 +94,14 @@ function test_Reply_To_List_From_Address</span>
<a href="#l22.4"></a><span id="l22.4">   let curMessage = select_click_row(0);</span>
<a href="#l22.5"></a><span id="l22.5">   assert_selected_and_displayed(mc, curMessage);</span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7">   replyToListWindow = composeHelper.open_compose_with_reply_to_list();</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9">   var identityList = replyToListWindow.e(&quot;msgIdentity&quot;);</span>
<a href="#l22.10"></a><span id="l22.10"> </span>
<a href="#l22.11"></a><span id="l22.11">   // see if it's the correct identity selected</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-  if (identityList.selectedItem.label.indexOf(identityString1) == -1)</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+  if (!identityList.selectedItem.label.contains(identityString1))</span>
<a href="#l22.14"></a><span id="l22.14">     throw new Error(&quot;The From address is not correctly selected! Expected: &quot;+</span>
<a href="#l22.15"></a><span id="l22.15">                     identityString1 + &quot;; Actual: &quot;  +</span>
<a href="#l22.16"></a><span id="l22.16">                     identityList.selectedItem.label);</span>
<a href="#l22.17"></a><span id="l22.17"> }</span>
<a href="#l22.18"></a><span id="l22.18"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/test/mozmill/message-header/test-return-receipt.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-return-receipt.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -98,20 +98,20 @@ function assert_mdn_shown(shouldShow) {</span>
<a href="#l23.4"></a><span id="l23.4"> }</span>
<a href="#l23.5"></a><span id="l23.5"> </span>
<a href="#l23.6"></a><span id="l23.6"> /**</span>
<a href="#l23.7"></a><span id="l23.7">  * Utility function to make sure the notification contains a certain text.</span>
<a href="#l23.8"></a><span id="l23.8">  */</span>
<a href="#l23.9"></a><span id="l23.9"> function assert_mdn_text_contains(text, shouldContain) {</span>
<a href="#l23.10"></a><span id="l23.10">   let mdnBar = mc.e(&quot;mdnBar&quot;);</span>
<a href="#l23.11"></a><span id="l23.11">   let notificationText = mdnBar.textContent;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-  if (shouldContain &amp;&amp; notificationText.indexOf(text) == -1)</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+  if (shouldContain &amp;&amp; !notificationText.contains(text))</span>
<a href="#l23.14"></a><span id="l23.14">     throw new Error(&quot;mdnBar should contain text=&quot; + text +</span>
<a href="#l23.15"></a><span id="l23.15">                     &quot;; notificationText=&quot; + notificationText);</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">-  if (!shouldContain &amp;&amp; notificationText.indexOf(text) != -1)</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineplus">+  if (!shouldContain &amp;&amp; notificationText.contains(text))</span>
<a href="#l23.18"></a><span id="l23.18">     throw new Error(&quot;mdnBar shouldn't contain text=&quot; + text +</span>
<a href="#l23.19"></a><span id="l23.19">                     &quot;; notificationText=&quot; + notificationText);</span>
<a href="#l23.20"></a><span id="l23.20"> }</span>
<a href="#l23.21"></a><span id="l23.21"> </span>
<a href="#l23.22"></a><span id="l23.22"> /**</span>
<a href="#l23.23"></a><span id="l23.23">  * Test that return receipts are not shown when Disposition-Notification-To</span>
<a href="#l23.24"></a><span id="l23.24">  * and Return-Receipt-To isn't set.</span>
<a href="#l23.25"></a><span id="l23.25">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mail/test/mozmill/session-store/test-session-store.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mail/test/mozmill/session-store/test-session-store.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -18,16 +18,17 @@ var Cu = Components.utils;</span>
<a href="#l24.4"></a><span id="l24.4"> </span>
<a href="#l24.5"></a><span id="l24.5"> var controller = {};</span>
<a href="#l24.6"></a><span id="l24.6"> Cu.import(&quot;resource://mozmill/modules/controller.js&quot;, controller);</span>
<a href="#l24.7"></a><span id="l24.7"> var jumlib = {};</span>
<a href="#l24.8"></a><span id="l24.8"> Cu.import(&quot;resource://mozmill/modules/jum.js&quot;, jumlib);</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> Cu.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l24.11"></a><span id="l24.11"> Cu.import(&quot;resource:///modules/sessionStoreManager.js&quot;);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l24.13"></a><span id="l24.13"> </span>
<a href="#l24.14"></a><span id="l24.14"> // the windowHelper module</span>
<a href="#l24.15"></a><span id="l24.15"> var windowHelper;</span>
<a href="#l24.16"></a><span id="l24.16"> </span>
<a href="#l24.17"></a><span id="l24.17"> var folderA, folderB;</span>
<a href="#l24.18"></a><span id="l24.18"> </span>
<a href="#l24.19"></a><span id="l24.19"> /* ........ Helper Functions ................*/</span>
<a href="#l24.20"></a><span id="l24.20"> </span>
<a href="#l24.21"></a><span id="l24.21" class="difflineat">@@ -49,32 +50,31 @@ function readFile() {</span>
<a href="#l24.22"></a><span id="l24.22"> }</span>
<a href="#l24.23"></a><span id="l24.23"> </span>
<a href="#l24.24"></a><span id="l24.24"> function waitForFileRefresh() {</span>
<a href="#l24.25"></a><span id="l24.25">   controller.sleep(sessionStoreManager._sessionAutoSaveTimerIntervalMS);</span>
<a href="#l24.26"></a><span id="l24.26">   jumlib.assert(sessionStoreManager.sessionFile.exists(),</span>
<a href="#l24.27"></a><span id="l24.27">                 &quot;file should exist&quot;);</span>
<a href="#l24.28"></a><span id="l24.28"> }</span>
<a href="#l24.29"></a><span id="l24.29"> </span>
<a href="#l24.30"></a><span id="l24.30" class="difflineminus">-function open3PaneWindow(windowWatcher) {</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+function open3PaneWindow() {</span>
<a href="#l24.32"></a><span id="l24.32">   windowHelper.plan_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-  windowWatcher.openWindow(null,</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-                           &quot;chrome://messenger/content/messenger.xul&quot;, &quot;&quot;,</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">-                           &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineminus">-                           null);</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineplus">+  Services.ww.openWindow(null,</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+                         &quot;chrome://messenger/content/messenger.xul&quot;, &quot;&quot;,</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+                         &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineplus">+                         null);</span>
<a href="#l24.41"></a><span id="l24.41">   return windowHelper.wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l24.42"></a><span id="l24.42"> }</span>
<a href="#l24.43"></a><span id="l24.43"> </span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-function openAddressBook(windowWatcher) {</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+function openAddressBook() {</span>
<a href="#l24.46"></a><span id="l24.46">   windowHelper.plan_for_new_window(&quot;mail:addressbook&quot;);</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">-  windowWatcher.openWindow(</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineminus">-                      null,</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineminus">-                      &quot;chrome://messenger/content/addressbook/addressbook.xul&quot;, &quot;&quot;,</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineminus">-                      &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineminus">-                      null);</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+  Services.ww.openWindow(null,</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineplus">+                         &quot;chrome://messenger/content/addressbook/addressbook.xul&quot;, &quot;&quot;,</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineplus">+                         &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineplus">+                         null);</span>
<a href="#l24.56"></a><span id="l24.56">   return windowHelper.wait_for_new_window(&quot;mail:addressbook&quot;);</span>
<a href="#l24.57"></a><span id="l24.57"> }</span>
<a href="#l24.58"></a><span id="l24.58"> </span>
<a href="#l24.59"></a><span id="l24.59"> /* :::::::: The Tests ::::::::::::::: */</span>
<a href="#l24.60"></a><span id="l24.60"> </span>
<a href="#l24.61"></a><span id="l24.61"> function setupModule(module) {</span>
<a href="#l24.62"></a><span id="l24.62">   let folderDisplayHelper = collector.getModule('folder-display-helpers');</span>
<a href="#l24.63"></a><span id="l24.63">   folderDisplayHelper.installInto(module);</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineat">@@ -139,19 +139,17 @@ function test_periodic_nondirty_session_</span>
<a href="#l24.65"></a><span id="l24.65">   jumlib.assert(!sessionFile.exists(), &quot;file should not exist&quot;);</span>
<a href="#l24.66"></a><span id="l24.66"> }</span>
<a href="#l24.67"></a><span id="l24.67"> </span>
<a href="#l24.68"></a><span id="l24.68"> function test_single_3pane_periodic_session_persistence() {</span>
<a href="#l24.69"></a><span id="l24.69">   be_in_folder(folderA);</span>
<a href="#l24.70"></a><span id="l24.70"> </span>
<a href="#l24.71"></a><span id="l24.71">   // get the state object. this assumes there is one and only one</span>
<a href="#l24.72"></a><span id="l24.72">   // 3pane window.</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineminus">-  let windowMediator = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;].</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineminus">-                       getService(Ci.nsIWindowMediator);</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineminus">-  let mail3PaneWindow = windowMediator.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineplus">+  let mail3PaneWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l24.77"></a><span id="l24.77">   let state = mail3PaneWindow.getWindowStateForSessionPersistence();</span>
<a href="#l24.78"></a><span id="l24.78"> </span>
<a href="#l24.79"></a><span id="l24.79">   sessionStoreManager.startPeriodicSave();</span>
<a href="#l24.80"></a><span id="l24.80">   waitForFileRefresh();</span>
<a href="#l24.81"></a><span id="l24.81"> </span>
<a href="#l24.82"></a><span id="l24.82">   // load the saved state from disk</span>
<a href="#l24.83"></a><span id="l24.83">   let loadedState = readFile();</span>
<a href="#l24.84"></a><span id="l24.84">   jumlib.assert(loadedState, &quot;previously saved state should be non-null&quot;);</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineat">@@ -164,30 +162,26 @@ function test_single_3pane_periodic_sess</span>
<a href="#l24.86"></a><span id="l24.86"> </span>
<a href="#l24.87"></a><span id="l24.87"> function test_restore_single_3pane_persistence() {</span>
<a href="#l24.88"></a><span id="l24.88">   be_in_folder(folderA);</span>
<a href="#l24.89"></a><span id="l24.89">   toggle_message_pane();</span>
<a href="#l24.90"></a><span id="l24.90">   assert_message_pane_hidden();</span>
<a href="#l24.91"></a><span id="l24.91"> </span>
<a href="#l24.92"></a><span id="l24.92">   // get the state object. this assumes there is one and only one</span>
<a href="#l24.93"></a><span id="l24.93">   // 3pane window.</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineminus">-  let windowWatcher = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;].</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineminus">-                      getService(Ci.nsIWindowWatcher);</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineminus">-  let windowMediator = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;].</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineminus">-                       getService(Ci.nsIWindowMediator);</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineminus">-  let mail3PaneWindow = windowMediator.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineplus">+  let mail3PaneWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l24.100"></a><span id="l24.100"> </span>
<a href="#l24.101"></a><span id="l24.101">   // make sure we have a different window open, so that we don't start shutting</span>
<a href="#l24.102"></a><span id="l24.102">   // down just because the last window was closed</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineminus">-  let abwc = openAddressBook(windowWatcher);</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineplus">+  let abwc = openAddressBook();</span>
<a href="#l24.105"></a><span id="l24.105"> </span>
<a href="#l24.106"></a><span id="l24.106">   // close the 3pane window</span>
<a href="#l24.107"></a><span id="l24.107">   mail3PaneWindow.close();</span>
<a href="#l24.108"></a><span id="l24.108"> </span>
<a href="#l24.109"></a><span id="l24.109" class="difflineminus">-  mc = open3PaneWindow(windowWatcher);</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineplus">+  mc = open3PaneWindow();</span>
<a href="#l24.111"></a><span id="l24.111">   be_in_folder(folderA);</span>
<a href="#l24.112"></a><span id="l24.112">   assert_message_pane_hidden();</span>
<a href="#l24.113"></a><span id="l24.113">   // restore message pane.</span>
<a href="#l24.114"></a><span id="l24.114">   toggle_message_pane();</span>
<a href="#l24.115"></a><span id="l24.115"> </span>
<a href="#l24.116"></a><span id="l24.116">   // We don't need the address book window any more.</span>
<a href="#l24.117"></a><span id="l24.117">   plan_for_window_close(abwc);</span>
<a href="#l24.118"></a><span id="l24.118">   abwc.window.close();</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineat">@@ -202,21 +196,17 @@ function test_restore_single_3pane_persi</span>
<a href="#l24.120"></a><span id="l24.120"> </span>
<a href="#l24.121"></a><span id="l24.121"> function test_message_pane_height_persistence() {</span>
<a href="#l24.122"></a><span id="l24.122">   be_in_folder(folderA);</span>
<a href="#l24.123"></a><span id="l24.123">   assert_message_pane_visible();</span>
<a href="#l24.124"></a><span id="l24.124">   assert_pane_layout(kClassicMailLayout);</span>
<a href="#l24.125"></a><span id="l24.125"> </span>
<a href="#l24.126"></a><span id="l24.126">   // Get the state object. This assumes there is one and only one</span>
<a href="#l24.127"></a><span id="l24.127">   // 3pane window.</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineminus">-  let windowWatcher = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;].</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineminus">-                      getService(Ci.nsIWindowWatcher);</span>
<a href="#l24.130"></a><span id="l24.130" class="difflineminus">-  let windowMediator = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;].</span>
<a href="#l24.131"></a><span id="l24.131" class="difflineminus">-                       getService(Ci.nsIWindowMediator);</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineminus">-  let mail3PaneWindow = windowMediator.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineplus">+  let mail3PaneWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l24.134"></a><span id="l24.134"> </span>
<a href="#l24.135"></a><span id="l24.135">   let oldHeight = mc.e(&quot;messagepaneboxwrapper&quot;).boxObject.height;</span>
<a href="#l24.136"></a><span id="l24.136">   let minHeight = Math.floor(mc.e(&quot;messagepaneboxwrapper&quot;).getAttribute(&quot;minheight&quot;));</span>
<a href="#l24.137"></a><span id="l24.137">   let newHeight = Math.floor((minHeight + oldHeight) / 2);</span>
<a href="#l24.138"></a><span id="l24.138">   let diffHeight = oldHeight - newHeight;</span>
<a href="#l24.139"></a><span id="l24.139"> </span>
<a href="#l24.140"></a><span id="l24.140">   assert_not_equals(oldHeight, newHeight,</span>
<a href="#l24.141"></a><span id="l24.141">     &quot;To really perform a test the new message pane height should be &quot; +</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineat">@@ -229,38 +219,38 @@ function test_message_pane_height_persis</span>
<a href="#l24.143"></a><span id="l24.143">   let actualHeight = mc.e(&quot;messagepaneboxwrapper&quot;).boxObject.height;</span>
<a href="#l24.144"></a><span id="l24.144"> </span>
<a href="#l24.145"></a><span id="l24.145">   assert_equals(newHeight, actualHeight,</span>
<a href="#l24.146"></a><span id="l24.146">     &quot;The message pane height should be &quot; + newHeight + &quot;, but is actually &quot; +</span>
<a href="#l24.147"></a><span id="l24.147">     actualHeight + &quot;. The oldHeight was: &quot; + oldHeight);</span>
<a href="#l24.148"></a><span id="l24.148"> </span>
<a href="#l24.149"></a><span id="l24.149">   // Make sure we have a different window open, so that we don't start shutting</span>
<a href="#l24.150"></a><span id="l24.150">   // down just because the last window was closed.</span>
<a href="#l24.151"></a><span id="l24.151" class="difflineminus">-  let abwc = openAddressBook(windowWatcher);</span>
<a href="#l24.152"></a><span id="l24.152" class="difflineplus">+  let abwc = openAddressBook();</span>
<a href="#l24.153"></a><span id="l24.153"> </span>
<a href="#l24.154"></a><span id="l24.154">   // The 3pane window is closed.</span>
<a href="#l24.155"></a><span id="l24.155">   mail3PaneWindow.close();</span>
<a href="#l24.156"></a><span id="l24.156"> </span>
<a href="#l24.157"></a><span id="l24.157" class="difflineminus">-  mc = open3PaneWindow(windowWatcher);</span>
<a href="#l24.158"></a><span id="l24.158" class="difflineplus">+  mc = open3PaneWindow();</span>
<a href="#l24.159"></a><span id="l24.159">   be_in_folder(folderA);</span>
<a href="#l24.160"></a><span id="l24.160">   assert_message_pane_visible();</span>
<a href="#l24.161"></a><span id="l24.161"> </span>
<a href="#l24.162"></a><span id="l24.162">   let actualHeight = mc.e(&quot;messagepaneboxwrapper&quot;).boxObject.height;</span>
<a href="#l24.163"></a><span id="l24.163"> </span>
<a href="#l24.164"></a><span id="l24.164">   assert_equals(newHeight, actualHeight,</span>
<a href="#l24.165"></a><span id="l24.165">     &quot;The message pane height should be &quot; + newHeight + &quot;, but is actually &quot; +</span>
<a href="#l24.166"></a><span id="l24.166">     actualHeight + &quot;. The oldHeight was: &quot; + oldHeight);</span>
<a href="#l24.167"></a><span id="l24.167"> </span>
<a href="#l24.168"></a><span id="l24.168">   // The old height is restored.</span>
<a href="#l24.169"></a><span id="l24.169">   _move_splitter(mc.e(&quot;threadpane-splitter&quot;), 0, -diffHeight);</span>
<a href="#l24.170"></a><span id="l24.170"> </span>
<a href="#l24.171"></a><span id="l24.171">   // The 3pane window is closed.</span>
<a href="#l24.172"></a><span id="l24.172">   mail3PaneWindow.close();</span>
<a href="#l24.173"></a><span id="l24.173"> </span>
<a href="#l24.174"></a><span id="l24.174" class="difflineminus">-  mc = open3PaneWindow(windowWatcher);</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineplus">+  mc = open3PaneWindow();</span>
<a href="#l24.176"></a><span id="l24.176">   be_in_folder(folderA);</span>
<a href="#l24.177"></a><span id="l24.177">   assert_message_pane_visible();</span>
<a href="#l24.178"></a><span id="l24.178"> </span>
<a href="#l24.179"></a><span id="l24.179">   let actualHeight = mc.e(&quot;messagepaneboxwrapper&quot;).boxObject.height;</span>
<a href="#l24.180"></a><span id="l24.180">   assert_equals(oldHeight, actualHeight,</span>
<a href="#l24.181"></a><span id="l24.181">     &quot;The message pane height should be &quot; + oldHeight + &quot;, but is actually &quot; +</span>
<a href="#l24.182"></a><span id="l24.182">     actualHeight);</span>
<a href="#l24.183"></a><span id="l24.183"> </span>
<a href="#l24.184"></a><span id="l24.184" class="difflineat">@@ -277,21 +267,17 @@ function test_message_pane_width_persist</span>
<a href="#l24.185"></a><span id="l24.185">   // At the beginning we are in classic layout.  We will switch to</span>
<a href="#l24.186"></a><span id="l24.186">   // vertical layout to test the width, and then back to classic layout.</span>
<a href="#l24.187"></a><span id="l24.187">   assert_pane_layout(kClassicMailLayout);</span>
<a href="#l24.188"></a><span id="l24.188">   set_pane_layout(kVerticalMailLayout);</span>
<a href="#l24.189"></a><span id="l24.189">   assert_pane_layout(kVerticalMailLayout);</span>
<a href="#l24.190"></a><span id="l24.190"> </span>
<a href="#l24.191"></a><span id="l24.191">   // Get the state object. This assumes there is one and only one</span>
<a href="#l24.192"></a><span id="l24.192">   // 3pane window.</span>
<a href="#l24.193"></a><span id="l24.193" class="difflineminus">-  let windowWatcher = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;].</span>
<a href="#l24.194"></a><span id="l24.194" class="difflineminus">-                      getService(Ci.nsIWindowWatcher);</span>
<a href="#l24.195"></a><span id="l24.195" class="difflineminus">-  let windowMediator = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;].</span>
<a href="#l24.196"></a><span id="l24.196" class="difflineminus">-                       getService(Ci.nsIWindowMediator);</span>
<a href="#l24.197"></a><span id="l24.197" class="difflineminus">-  let mail3PaneWindow = windowMediator.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l24.198"></a><span id="l24.198" class="difflineplus">+  let mail3PaneWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l24.199"></a><span id="l24.199"> </span>
<a href="#l24.200"></a><span id="l24.200">   let oldWidth = mc.e(&quot;messagepaneboxwrapper&quot;).boxObject.width;</span>
<a href="#l24.201"></a><span id="l24.201">   let minWidth = Math.floor(mc.e(&quot;messagepaneboxwrapper&quot;).getAttribute(&quot;minwidth&quot;));</span>
<a href="#l24.202"></a><span id="l24.202">   let newWidth = Math.floor((minWidth + oldWidth) / 2);</span>
<a href="#l24.203"></a><span id="l24.203">   let diffWidth = oldWidth - newWidth;</span>
<a href="#l24.204"></a><span id="l24.204"> </span>
<a href="#l24.205"></a><span id="l24.205">   assert_not_equals(newWidth, oldWidth,</span>
<a href="#l24.206"></a><span id="l24.206">     &quot;To really perform a test the new message pane width should be &quot; +</span>
<a href="#l24.207"></a><span id="l24.207" class="difflineat">@@ -307,22 +293,22 @@ function test_message_pane_width_persist</span>
<a href="#l24.208"></a><span id="l24.208">   // the requested width plus/minus one pixel.</span>
<a href="#l24.209"></a><span id="l24.209">   assert_equals_fuzzy(newWidth, actualWidth, 1,</span>
<a href="#l24.210"></a><span id="l24.210">     &quot;The message pane width should be &quot; + newWidth + &quot;, but is actually &quot; +</span>
<a href="#l24.211"></a><span id="l24.211">     actualWidth + &quot;. The oldWidth was: &quot; + oldWidth);</span>
<a href="#l24.212"></a><span id="l24.212">   newWidth = actualWidth;</span>
<a href="#l24.213"></a><span id="l24.213"> </span>
<a href="#l24.214"></a><span id="l24.214">   // Make sure we have a different window open, so that we don't start shutting</span>
<a href="#l24.215"></a><span id="l24.215">   // down just because the last window was closed</span>
<a href="#l24.216"></a><span id="l24.216" class="difflineminus">-  let abwc = openAddressBook(windowWatcher);</span>
<a href="#l24.217"></a><span id="l24.217" class="difflineplus">+  let abwc = openAddressBook();</span>
<a href="#l24.218"></a><span id="l24.218"> </span>
<a href="#l24.219"></a><span id="l24.219">   // The 3pane window is closed.</span>
<a href="#l24.220"></a><span id="l24.220">   mail3PaneWindow.close();</span>
<a href="#l24.221"></a><span id="l24.221"> </span>
<a href="#l24.222"></a><span id="l24.222" class="difflineminus">-  mc = open3PaneWindow(windowWatcher);</span>
<a href="#l24.223"></a><span id="l24.223" class="difflineplus">+  mc = open3PaneWindow();</span>
<a href="#l24.224"></a><span id="l24.224">   be_in_folder(folderA);</span>
<a href="#l24.225"></a><span id="l24.225">   assert_message_pane_visible();</span>
<a href="#l24.226"></a><span id="l24.226">   assert_pane_layout(kVerticalMailLayout);</span>
<a href="#l24.227"></a><span id="l24.227"> </span>
<a href="#l24.228"></a><span id="l24.228">   let actualWidth = mc.e(&quot;messagepaneboxwrapper&quot;).boxObject.width;</span>
<a href="#l24.229"></a><span id="l24.229">   assert_equals(newWidth, actualWidth, &quot;The message pane width should be &quot; +</span>
<a href="#l24.230"></a><span id="l24.230">     newWidth + &quot;, but is actually &quot; + actualWidth);</span>
<a href="#l24.231"></a><span id="l24.231"> </span>
<a href="#l24.232"></a><span id="l24.232" class="difflineat">@@ -337,17 +323,17 @@ function test_message_pane_width_persist</span>
<a href="#l24.233"></a><span id="l24.233">   assert_equals_fuzzy(oldWidth, actualWidth, 2,</span>
<a href="#l24.234"></a><span id="l24.234">     &quot;The message pane width should be &quot; + oldWidth + &quot;, but is actually &quot; +</span>
<a href="#l24.235"></a><span id="l24.235">     actualWidth);</span>
<a href="#l24.236"></a><span id="l24.236">   oldWidth = actualWidth;</span>
<a href="#l24.237"></a><span id="l24.237"> </span>
<a href="#l24.238"></a><span id="l24.238">   // The 3pane window is closed.</span>
<a href="#l24.239"></a><span id="l24.239">   mail3PaneWindow.close();</span>
<a href="#l24.240"></a><span id="l24.240"> </span>
<a href="#l24.241"></a><span id="l24.241" class="difflineminus">-  mc = open3PaneWindow(windowWatcher);</span>
<a href="#l24.242"></a><span id="l24.242" class="difflineplus">+  mc = open3PaneWindow();</span>
<a href="#l24.243"></a><span id="l24.243">   be_in_folder(folderA);</span>
<a href="#l24.244"></a><span id="l24.244">   assert_message_pane_visible();</span>
<a href="#l24.245"></a><span id="l24.245">   assert_pane_layout(kVerticalMailLayout);</span>
<a href="#l24.246"></a><span id="l24.246"> </span>
<a href="#l24.247"></a><span id="l24.247">   let actualWidth = mc.e(&quot;messagepaneboxwrapper&quot;).boxObject.width;</span>
<a href="#l24.248"></a><span id="l24.248">   assert_equals(oldWidth, actualWidth, &quot;The message pane width should be &quot; +</span>
<a href="#l24.249"></a><span id="l24.249">     oldWidth + &quot;, but is actually &quot; + actualWidth);</span>
<a href="#l24.250"></a><span id="l24.250"> </span>
<a href="#l24.251"></a><span id="l24.251" class="difflineat">@@ -358,26 +344,22 @@ function test_message_pane_width_persist</span>
<a href="#l24.252"></a><span id="l24.252">   // We don't need the address book window any more.</span>
<a href="#l24.253"></a><span id="l24.253">   plan_for_window_close(abwc);</span>
<a href="#l24.254"></a><span id="l24.254">   abwc.window.close();</span>
<a href="#l24.255"></a><span id="l24.255">   wait_for_window_close();</span>
<a href="#l24.256"></a><span id="l24.256"> }</span>
<a href="#l24.257"></a><span id="l24.257"> </span>
<a href="#l24.258"></a><span id="l24.258"> function test_multiple_3pane_periodic_session_persistence() {</span>
<a href="#l24.259"></a><span id="l24.259">   // open a few more 3pane windows</span>
<a href="#l24.260"></a><span id="l24.260" class="difflineminus">-  let windowWatcher = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;].</span>
<a href="#l24.261"></a><span id="l24.261" class="difflineminus">-                      getService(Ci.nsIWindowWatcher);</span>
<a href="#l24.262"></a><span id="l24.262">   for (var i = 0; i &lt; 3; ++i)</span>
<a href="#l24.263"></a><span id="l24.263" class="difflineminus">-    open3PaneWindow(windowWatcher);</span>
<a href="#l24.264"></a><span id="l24.264" class="difflineplus">+    open3PaneWindow();</span>
<a href="#l24.265"></a><span id="l24.265"> </span>
<a href="#l24.266"></a><span id="l24.266">   // then get the state objects for each window</span>
<a href="#l24.267"></a><span id="l24.267">   let state = [];</span>
<a href="#l24.268"></a><span id="l24.268" class="difflineminus">-  let windowMediator = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;].</span>
<a href="#l24.269"></a><span id="l24.269" class="difflineminus">-                       getService(Ci.nsIWindowMediator);</span>
<a href="#l24.270"></a><span id="l24.270" class="difflineminus">-  let enumerator = windowMediator.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l24.271"></a><span id="l24.271" class="difflineplus">+  let enumerator = Services.wm.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l24.272"></a><span id="l24.272">   while (enumerator.hasMoreElements())</span>
<a href="#l24.273"></a><span id="l24.273">     state.push(enumerator.getNext().getWindowStateForSessionPersistence());</span>
<a href="#l24.274"></a><span id="l24.274"> </span>
<a href="#l24.275"></a><span id="l24.275">   sessionStoreManager.startPeriodicSave();</span>
<a href="#l24.276"></a><span id="l24.276">   waitForFileRefresh();</span>
<a href="#l24.277"></a><span id="l24.277">   sessionStoreManager.stopPeriodicSave();</span>
<a href="#l24.278"></a><span id="l24.278"> </span>
<a href="#l24.279"></a><span id="l24.279">   // load the saved state from disk</span>
<a href="#l24.280"></a><span id="l24.280" class="difflineat">@@ -388,17 +370,17 @@ function test_multiple_3pane_periodic_se</span>
<a href="#l24.281"></a><span id="l24.281">           &quot;number of windows in saved state and loaded state should be equal&quot;);</span>
<a href="#l24.282"></a><span id="l24.282"> </span>
<a href="#l24.283"></a><span id="l24.283">   for (var i = 0; i &lt; state.length; ++i)</span>
<a href="#l24.284"></a><span id="l24.284">     jumlib.assert(</span>
<a href="#l24.285"></a><span id="l24.285">             JSON.stringify(loadedState.windows[i]) == JSON.stringify(state[i]),</span>
<a href="#l24.286"></a><span id="l24.286">             &quot;saved state and loaded state should be equal&quot;);</span>
<a href="#l24.287"></a><span id="l24.287"> </span>
<a href="#l24.288"></a><span id="l24.288">   // close all but one 3pane window</span>
<a href="#l24.289"></a><span id="l24.289" class="difflineminus">-  enumerator = windowMediator.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l24.290"></a><span id="l24.290" class="difflineplus">+  enumerator = Services.wm.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l24.291"></a><span id="l24.291">   while (enumerator.hasMoreElements()) {</span>
<a href="#l24.292"></a><span id="l24.292">     let window = enumerator.getNext();</span>
<a href="#l24.293"></a><span id="l24.293">     if (enumerator.hasMoreElements())</span>
<a href="#l24.294"></a><span id="l24.294">       window.close();</span>
<a href="#l24.295"></a><span id="l24.295">   }</span>
<a href="#l24.296"></a><span id="l24.296"> }</span>
<a href="#l24.297"></a><span id="l24.297"> </span>
<a href="#l24.298"></a><span id="l24.298"> function test_bad_session_file_simple() {</span>
<a href="#l24.299"></a><span id="l24.299" class="difflineat">@@ -422,31 +404,27 @@ function test_bad_session_file_simple() </span>
<a href="#l24.300"></a><span id="l24.300">   // the bad session file should have also been deleted</span>
<a href="#l24.301"></a><span id="l24.301">   jumlib.assert(!sessionStoreManager.sessionFile.exists(),</span>
<a href="#l24.302"></a><span id="l24.302">                 &quot;file should not exist&quot;);</span>
<a href="#l24.303"></a><span id="l24.303"> }</span>
<a href="#l24.304"></a><span id="l24.304"> </span>
<a href="#l24.305"></a><span id="l24.305"> function test_clean_shutdown_session_persistence_simple() {</span>
<a href="#l24.306"></a><span id="l24.306"> </span>
<a href="#l24.307"></a><span id="l24.307">   // open a few more 3pane windows</span>
<a href="#l24.308"></a><span id="l24.308" class="difflineminus">-  let windowWatcher = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;].</span>
<a href="#l24.309"></a><span id="l24.309" class="difflineminus">-                      getService(Ci.nsIWindowWatcher);</span>
<a href="#l24.310"></a><span id="l24.310">   for (var i = 0; i &lt; 3; ++i) {</span>
<a href="#l24.311"></a><span id="l24.311" class="difflineminus">-    open3PaneWindow(windowWatcher);</span>
<a href="#l24.312"></a><span id="l24.312" class="difflineplus">+    open3PaneWindow();</span>
<a href="#l24.313"></a><span id="l24.313">   }</span>
<a href="#l24.314"></a><span id="l24.314"> </span>
<a href="#l24.315"></a><span id="l24.315">   // make sure we have a different window open, so that we don't start shutting</span>
<a href="#l24.316"></a><span id="l24.316">   // down just because the last window was closed</span>
<a href="#l24.317"></a><span id="l24.317" class="difflineminus">-  let abwc = openAddressBook(windowWatcher);</span>
<a href="#l24.318"></a><span id="l24.318" class="difflineplus">+  let abwc = openAddressBook();</span>
<a href="#l24.319"></a><span id="l24.319"> </span>
<a href="#l24.320"></a><span id="l24.320">   // close all the 3pane windows</span>
<a href="#l24.321"></a><span id="l24.321">   let lastWindowState = null;</span>
<a href="#l24.322"></a><span id="l24.322" class="difflineminus">-  let windowMediator = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;].</span>
<a href="#l24.323"></a><span id="l24.323" class="difflineminus">-                       getService(Ci.nsIWindowMediator);</span>
<a href="#l24.324"></a><span id="l24.324" class="difflineminus">-  enumerator = windowMediator.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l24.325"></a><span id="l24.325" class="difflineplus">+  enumerator = Services.wm.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l24.326"></a><span id="l24.326">   while (enumerator.hasMoreElements()) {</span>
<a href="#l24.327"></a><span id="l24.327">     let window = enumerator.getNext();</span>
<a href="#l24.328"></a><span id="l24.328">     if (!enumerator.hasMoreElements())</span>
<a href="#l24.329"></a><span id="l24.329">       lastWindowState = window.getWindowStateForSessionPersistence();</span>
<a href="#l24.330"></a><span id="l24.330"> </span>
<a href="#l24.331"></a><span id="l24.331">     window.close();</span>
<a href="#l24.332"></a><span id="l24.332">   }</span>
<a href="#l24.333"></a><span id="l24.333"> </span>
<a href="#l24.334"></a><span id="l24.334" class="difflineat">@@ -458,17 +436,17 @@ function test_clean_shutdown_session_per</span>
<a href="#l24.335"></a><span id="l24.335">           &quot;only the state of the last 3pane window should have been saved&quot;);</span>
<a href="#l24.336"></a><span id="l24.336"> </span>
<a href="#l24.337"></a><span id="l24.337">   // get the state object for the one and only one 3pane window</span>
<a href="#l24.338"></a><span id="l24.338">   let windowState = loadedState.windows[0];</span>
<a href="#l24.339"></a><span id="l24.339">   jumlib.assert(JSON.stringify(windowState) == JSON.stringify(lastWindowState),</span>
<a href="#l24.340"></a><span id="l24.340">                 &quot;saved state and loaded state should be equal&quot;);</span>
<a href="#l24.341"></a><span id="l24.341"> </span>
<a href="#l24.342"></a><span id="l24.342"> </span>
<a href="#l24.343"></a><span id="l24.343" class="difflineminus">-  open3PaneWindow(windowWatcher);</span>
<a href="#l24.344"></a><span id="l24.344" class="difflineplus">+  open3PaneWindow();</span>
<a href="#l24.345"></a><span id="l24.345"> </span>
<a href="#l24.346"></a><span id="l24.346">   // We don't need the address book window any more.</span>
<a href="#l24.347"></a><span id="l24.347">   plan_for_window_close(abwc);</span>
<a href="#l24.348"></a><span id="l24.348">   abwc.window.close();</span>
<a href="#l24.349"></a><span id="l24.349">   wait_for_window_close();</span>
<a href="#l24.350"></a><span id="l24.350"> }</span>
<a href="#l24.351"></a><span id="l24.351"> </span>
<a href="#l24.352"></a><span id="l24.352"> /*</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-content-tab-helpers.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-content-tab-helpers.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -131,17 +131,17 @@ let NotificationWatcher = {</span>
<a href="#l25.4"></a><span id="l25.4">   },</span>
<a href="#l25.5"></a><span id="l25.5">   waitForNotification: function(aController) {</span>
<a href="#l25.6"></a><span id="l25.6">     if (!this.alerted) {</span>
<a href="#l25.7"></a><span id="l25.7">       aController.waitFor(function () this.alerted, &quot;Timeout waiting for alert&quot;,</span>
<a href="#l25.8"></a><span id="l25.8">                           ALERT_TIMEOUT, 100, this);</span>
<a href="#l25.9"></a><span id="l25.9">     }</span>
<a href="#l25.10"></a><span id="l25.10">     // Double check the notification box has finished animating.</span>
<a href="#l25.11"></a><span id="l25.11">     let notificationBox =</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-      mc.tabmail.selectedTab.panel.getElementsByTagName(&quot;notificationbox&quot;)[0];</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+      mc.tabmail.selectedTab.panel.querySelector(&quot;notificationbox&quot;);</span>
<a href="#l25.14"></a><span id="l25.14">     if (notificationBox &amp;&amp; notificationBox._animating)</span>
<a href="#l25.15"></a><span id="l25.15">       aController.waitFor(function () !notificationBox._animating,</span>
<a href="#l25.16"></a><span id="l25.16">                           &quot;Timeout waiting for notification box animation to finish&quot;,</span>
<a href="#l25.17"></a><span id="l25.17">                           ALERT_TIMEOUT, 100);</span>
<a href="#l25.18"></a><span id="l25.18"> </span>
<a href="#l25.19"></a><span id="l25.19">     aController.window.document.removeEventListener(&quot;AlertActive&quot;,</span>
<a href="#l25.20"></a><span id="l25.20">                                                     this.alertActive, false);</span>
<a href="#l25.21"></a><span id="l25.21">   },</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineat">@@ -339,41 +339,41 @@ function wait_for_content_tab_element_di</span>
<a href="#l25.23"></a><span id="l25.23">   }</span>
<a href="#l25.24"></a><span id="l25.24"> }</span>
<a href="#l25.25"></a><span id="l25.25"> </span>
<a href="#l25.26"></a><span id="l25.26"> /**</span>
<a href="#l25.27"></a><span id="l25.27">  * Asserts that the given text is present on the content tab's page.</span>
<a href="#l25.28"></a><span id="l25.28">  */</span>
<a href="#l25.29"></a><span id="l25.29"> function assert_content_tab_text_present(aTab, aText) {</span>
<a href="#l25.30"></a><span id="l25.30">   let html = aTab.browser.contentDocument.documentElement.innerHTML;</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-  if (html.indexOf(aText) == -1) {</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+  if (!html.contains(aText)) {</span>
<a href="#l25.33"></a><span id="l25.33">     mark_failure([&quot;Unable to find string \&quot;&quot; + aText + &quot;\&quot; on the content tab's page&quot;]);</span>
<a href="#l25.34"></a><span id="l25.34">   }</span>
<a href="#l25.35"></a><span id="l25.35"> }</span>
<a href="#l25.36"></a><span id="l25.36"> </span>
<a href="#l25.37"></a><span id="l25.37"> /**</span>
<a href="#l25.38"></a><span id="l25.38">  * Asserts that the given text is absent on the content tab's page.</span>
<a href="#l25.39"></a><span id="l25.39">  */</span>
<a href="#l25.40"></a><span id="l25.40"> function assert_content_tab_text_absent(aTab, aText) {</span>
<a href="#l25.41"></a><span id="l25.41">   let html = aTab.browser.contentDocument.documentElement.innerHTML;</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-  if (html.indexOf(aText) != -1) {</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineplus">+  if (html.contains(aText)) {</span>
<a href="#l25.44"></a><span id="l25.44">     mark_failure([&quot;Found string \&quot;&quot; + aText + &quot;\&quot; on the content tab's page&quot;]);</span>
<a href="#l25.45"></a><span id="l25.45">   }</span>
<a href="#l25.46"></a><span id="l25.46"> }</span>
<a href="#l25.47"></a><span id="l25.47"> </span>
<a href="#l25.48"></a><span id="l25.48"> /**</span>
<a href="#l25.49"></a><span id="l25.49">  * Returns the notification bar for a tab if one is currently visible,</span>
<a href="#l25.50"></a><span id="l25.50">  * null if otherwise.</span>
<a href="#l25.51"></a><span id="l25.51">  */</span>
<a href="#l25.52"></a><span id="l25.52"> function get_notification_bar_for_tab(aTab) {</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-  let notificationBoxEls = mc.tabmail.selectedTab.panel.getElementsByTagName(&quot;notificationbox&quot;);</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-  if (notificationBoxEls.length == 0)</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineplus">+  let notificationBoxEls = mc.tabmail.selectedTab.panel.querySelector(&quot;notificationbox&quot;);</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineplus">+  if (!notificationBoxEls)</span>
<a href="#l25.57"></a><span id="l25.57">     return null;</span>
<a href="#l25.58"></a><span id="l25.58"> </span>
<a href="#l25.59"></a><span id="l25.59" class="difflineminus">-  return notificationBoxEls[0];</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineplus">+  return notificationBoxEls;</span>
<a href="#l25.61"></a><span id="l25.61"> }</span>
<a href="#l25.62"></a><span id="l25.62"> </span>
<a href="#l25.63"></a><span id="l25.63"> /**</span>
<a href="#l25.64"></a><span id="l25.64">  * Returns the nsIPluginTag for the test plug-in, if it is available.</span>
<a href="#l25.65"></a><span id="l25.65">  * Returns null otherwise.</span>
<a href="#l25.66"></a><span id="l25.66">  */</span>
<a href="#l25.67"></a><span id="l25.67"> function get_test_plugin() {</span>
<a href="#l25.68"></a><span id="l25.68">   var ph = Components.classes[&quot;@mozilla.org/plugin/host;1&quot;]</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineat">@@ -390,24 +390,24 @@ function get_test_plugin() {</span>
<a href="#l25.70"></a><span id="l25.70"> </span>
<a href="#l25.71"></a><span id="l25.71"> /* Returns true if we're currently set up to run plugins in seperate</span>
<a href="#l25.72"></a><span id="l25.72">  * processes, false otherwise.</span>
<a href="#l25.73"></a><span id="l25.73">  */</span>
<a href="#l25.74"></a><span id="l25.74"> function plugins_run_in_separate_processes(aController) {</span>
<a href="#l25.75"></a><span id="l25.75">   let supportsOOPP = false;</span>
<a href="#l25.76"></a><span id="l25.76"> </span>
<a href="#l25.77"></a><span id="l25.77">   if (aController.mozmillModule.isMac) {</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineminus">-    if (Services.appinfo.XPCOMABI.match(/x86-/)) {</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineplus">+    if (Services.appinfo.XPCOMABI.contains(&quot;x86-&quot;)) {</span>
<a href="#l25.80"></a><span id="l25.80">       try {</span>
<a href="#l25.81"></a><span id="l25.81">         supportsOOPP = Services.prefs.getBoolPref(&quot;dom.ipc.plugins.enabled.i386.test.plugin&quot;);</span>
<a href="#l25.82"></a><span id="l25.82">       } catch(e) {</span>
<a href="#l25.83"></a><span id="l25.83">         supportsOOPP = Services.prefs.getBoolPref(&quot;dom.ipc.plugins.enabled.i386&quot;);</span>
<a href="#l25.84"></a><span id="l25.84">       }</span>
<a href="#l25.85"></a><span id="l25.85">     }</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineminus">-    else if (Services.appinfo.XPCOMABI.match(/x86_64-/)) {</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineplus">+    else if (Services.appinfo.XPCOMABI.contains(&quot;x86_64-&quot;)) {</span>
<a href="#l25.88"></a><span id="l25.88">       try {</span>
<a href="#l25.89"></a><span id="l25.89">         supportsOOPP = Services.prefs.getBoolPref(&quot;dom.ipc.plugins.enabled.x86_64.test.plugin&quot;);</span>
<a href="#l25.90"></a><span id="l25.90">       } catch(e) {</span>
<a href="#l25.91"></a><span id="l25.91">         supportsOOPP = Services.prefs.getBoolPref(&quot;dom.ipc.plugins.enabled.x86_64&quot;);</span>
<a href="#l25.92"></a><span id="l25.92">       }</span>
<a href="#l25.93"></a><span id="l25.93">     }</span>
<a href="#l25.94"></a><span id="l25.94">   }</span>
<a href="#l25.95"></a><span id="l25.95">   else {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -28,16 +28,17 @@ const MODULE_NAME = 'folder-display-help</span>
<a href="#l26.4"></a><span id="l26.4"> const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l26.5"></a><span id="l26.5"> // we need window-helpers for augment_controller</span>
<a href="#l26.6"></a><span id="l26.6"> const MODULE_REQUIRES = ['window-helpers'];</span>
<a href="#l26.7"></a><span id="l26.7"> </span>
<a href="#l26.8"></a><span id="l26.8"> const nsMsgViewIndex_None = 0xffffffff;</span>
<a href="#l26.9"></a><span id="l26.9"> Cu.import('resource:///modules/MailUtils.js');</span>
<a href="#l26.10"></a><span id="l26.10"> Cu.import('resource:///modules/MailConsts.js');</span>
<a href="#l26.11"></a><span id="l26.11"> Cu.import('resource:///modules/mailViewManager.js');</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l26.13"></a><span id="l26.13"> </span>
<a href="#l26.14"></a><span id="l26.14"> const FILE_LOAD_PATHS = [</span>
<a href="#l26.15"></a><span id="l26.15">   &quot;../resources&quot;,</span>
<a href="#l26.16"></a><span id="l26.16">   &quot;../../../../mailnews/test/resources&quot;,</span>
<a href="#l26.17"></a><span id="l26.17">   &quot;../../../../mail/base/test/unit/resources&quot;,</span>
<a href="#l26.18"></a><span id="l26.18">   &quot;../../../../mailnews/test/fakeserver&quot;</span>
<a href="#l26.19"></a><span id="l26.19"> ];</span>
<a href="#l26.20"></a><span id="l26.20"> </span>
<a href="#l26.21"></a><span id="l26.21" class="difflineat">@@ -319,37 +320,33 @@ function setupAccountStuff() {</span>
<a href="#l26.22"></a><span id="l26.22">  *     cleanup we perform.</span>
<a href="#l26.23"></a><span id="l26.23">  */</span>
<a href="#l26.24"></a><span id="l26.24"> function teardownImporter(customTeardown) {</span>
<a href="#l26.25"></a><span id="l26.25">   let teardownModule = function teardownModule() {</span>
<a href="#l26.26"></a><span id="l26.26">     if (customTeardown)</span>
<a href="#l26.27"></a><span id="l26.27">       customTeardown();</span>
<a href="#l26.28"></a><span id="l26.28"> </span>
<a href="#l26.29"></a><span id="l26.29">     // - If there are no 3-pane windows open, open one.</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineminus">-    let windowMediator = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-                           .getService(Ci.nsIWindowMediator);</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-    let mail3PaneWindow = windowMediator.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+    let mail3PaneWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l26.34"></a><span id="l26.34">     if (!mail3PaneWindow) {</span>
<a href="#l26.35"></a><span id="l26.35">       windowHelper.plan_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineminus">-      let windowWatcher = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineminus">-                            .getService(Ci.nsIWindowWatcher);</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineminus">-      windowWatcher.openWindow(null,</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineplus">+      Services.ww.openWindow(null,</span>
<a href="#l26.40"></a><span id="l26.40">           &quot;chrome://messenger/content/&quot;, &quot;&quot;,</span>
<a href="#l26.41"></a><span id="l26.41">           &quot;all,chrome,dialog=no,status,toolbar&quot;, args);</span>
<a href="#l26.42"></a><span id="l26.42">       mc = windowHelper.wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l26.43"></a><span id="l26.43">     }</span>
<a href="#l26.44"></a><span id="l26.44">     else {</span>
<a href="#l26.45"></a><span id="l26.45">       // - We might have a window open, but not be assigned to mc -- so if</span>
<a href="#l26.46"></a><span id="l26.46">       //   mc.window.closed is true, look for a window to assign to mc.</span>
<a href="#l26.47"></a><span id="l26.47">       if (!mc || mc.window.closed)</span>
<a href="#l26.48"></a><span id="l26.48">         mc = windowHelper.wait_for_existing_window(&quot;mail:3pane&quot;);</span>
<a href="#l26.49"></a><span id="l26.49">     }</span>
<a href="#l26.50"></a><span id="l26.50"> </span>
<a href="#l26.51"></a><span id="l26.51">     // Run through all open windows, closing any that aren't assigned to mc.</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineminus">-    let enumerator = windowMediator.getEnumerator(null);</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineplus">+    let enumerator = Services.wm.getEnumerator(null);</span>
<a href="#l26.54"></a><span id="l26.54">     while (enumerator.hasMoreElements()) {</span>
<a href="#l26.55"></a><span id="l26.55">       let win = enumerator.getNext();</span>
<a href="#l26.56"></a><span id="l26.56">       if (win != mc.window) {</span>
<a href="#l26.57"></a><span id="l26.57">         mark_action(&quot;fdh&quot;, &quot;teardown&quot;,</span>
<a href="#l26.58"></a><span id="l26.58">                     [&quot;cleanup closing non-mc window&quot;, win.toString(),</span>
<a href="#l26.59"></a><span id="l26.59">                      &quot;window type&quot;,</span>
<a href="#l26.60"></a><span id="l26.60">                      windowHelper.getWindowTypeForXulWindow(win)]);</span>
<a href="#l26.61"></a><span id="l26.61">         win.close();</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineat">@@ -644,20 +641,18 @@ function display_message_in_folder_tab(a</span>
<a href="#l26.63"></a><span id="l26.63">  * return until the message has finished loading.</span>
<a href="#l26.64"></a><span id="l26.64">  *</span>
<a href="#l26.65"></a><span id="l26.65">  * @param file an nsIFile for the message</span>
<a href="#l26.66"></a><span id="l26.66">  * @return The MozmillController-wrapped new window.</span>
<a href="#l26.67"></a><span id="l26.67">  */</span>
<a href="#l26.68"></a><span id="l26.68"> function open_message_from_file(file) {</span>
<a href="#l26.69"></a><span id="l26.69">   mark_action(&quot;fdh&quot;, &quot;open_message_from_file&quot;, [&quot;file&quot;, file.nativePath]);</span>
<a href="#l26.70"></a><span id="l26.70"> </span>
<a href="#l26.71"></a><span id="l26.71" class="difflineminus">-  let ios = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineminus">-                      .getService(Components.interfaces.nsIIOService);</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineminus">-  let fileURL = ios.newFileURI(file)</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineminus">-                   .QueryInterface(Components.interfaces.nsIFileURL);</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineplus">+  let fileURL = Services.io.newFileURI(file)</span>
<a href="#l26.76"></a><span id="l26.76" class="difflineplus">+                        .QueryInterface(Components.interfaces.nsIFileURL);</span>
<a href="#l26.77"></a><span id="l26.77">   fileURL.query = &quot;type=application/x-message-display&quot;;</span>
<a href="#l26.78"></a><span id="l26.78"> </span>
<a href="#l26.79"></a><span id="l26.79">   windowHelper.plan_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l26.80"></a><span id="l26.80">   mc.window.openDialog(&quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l26.81"></a><span id="l26.81">                        &quot;all,chrome,dialog=no,status,toolbar&quot;, fileURL);</span>
<a href="#l26.82"></a><span id="l26.82">   let msgc = windowHelper.wait_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l26.83"></a><span id="l26.83">   wait_for_message_display_completion(msgc, true);</span>
<a href="#l26.84"></a><span id="l26.84">   return msgc;</span>
<a href="#l26.85"></a><span id="l26.85" class="difflineat">@@ -781,17 +776,17 @@ function assert_number_of_tabs_open(aNum</span>
<a href="#l26.86"></a><span id="l26.86">  */</span>
<a href="#l26.87"></a><span id="l26.87"> function assert_tab_titled_from(aTab, aWhat) {</span>
<a href="#l26.88"></a><span id="l26.88">   let text;</span>
<a href="#l26.89"></a><span id="l26.89">   if (aWhat instanceof Ci.nsIMsgFolder)</span>
<a href="#l26.90"></a><span id="l26.90">     text = aWhat.prettiestName;</span>
<a href="#l26.91"></a><span id="l26.91">   else if (aWhat instanceof Ci.nsIMsgDBHdr)</span>
<a href="#l26.92"></a><span id="l26.92">     text = aWhat.mime2DecodedSubject;</span>
<a href="#l26.93"></a><span id="l26.93"> </span>
<a href="#l26.94"></a><span id="l26.94" class="difflineminus">-  if (aTab.title.indexOf(text) == -1)</span>
<a href="#l26.95"></a><span id="l26.95" class="difflineplus">+  if (!aTab.title.contains(text))</span>
<a href="#l26.96"></a><span id="l26.96">     mark_failure([&quot;Tab title of tab&quot;, aTab,</span>
<a href="#l26.97"></a><span id="l26.97">                   &quot;should include '&quot; + text + &quot;' but does not.&quot; +</span>
<a href="#l26.98"></a><span id="l26.98">                   &quot; (Current title: '&quot; + aTab.title + &quot;')&quot;]);</span>
<a href="#l26.99"></a><span id="l26.99"> }</span>
<a href="#l26.100"></a><span id="l26.100"> </span>
<a href="#l26.101"></a><span id="l26.101"> /**</span>
<a href="#l26.102"></a><span id="l26.102">  * Assert that the given tab's title is what is given.</span>
<a href="#l26.103"></a><span id="l26.103">  *</span>
<a href="#l26.104"></a><span id="l26.104" class="difflineat">@@ -2641,72 +2636,60 @@ function expand_all_threads() {</span>
<a href="#l26.105"></a><span id="l26.105"> }</span>
<a href="#l26.106"></a><span id="l26.106"> </span>
<a href="#l26.107"></a><span id="l26.107"> /**</span>
<a href="#l26.108"></a><span id="l26.108">  * Set the mail.openMessageBehavior pref.</span>
<a href="#l26.109"></a><span id="l26.109">  *</span>
<a href="#l26.110"></a><span id="l26.110">  * @param aPref One of &quot;NEW_WINDOW&quot;, &quot;EXISTING_WINDOW&quot; or &quot;NEW_TAB&quot;</span>
<a href="#l26.111"></a><span id="l26.111">  */</span>
<a href="#l26.112"></a><span id="l26.112"> function set_open_message_behavior(aPref) {</span>
<a href="#l26.113"></a><span id="l26.113" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l26.114"></a><span id="l26.114" class="difflineminus">-                     .getService(Ci.nsIPrefService).getBranch(null);</span>
<a href="#l26.115"></a><span id="l26.115" class="difflineminus">-  prefBranch.setIntPref(&quot;mail.openMessageBehavior&quot;,</span>
<a href="#l26.116"></a><span id="l26.116" class="difflineminus">-                        MailConsts.OpenMessageBehavior[aPref]);</span>
<a href="#l26.117"></a><span id="l26.117" class="difflineplus">+  Services.prefs.setIntPref(&quot;mail.openMessageBehavior&quot;,</span>
<a href="#l26.118"></a><span id="l26.118" class="difflineplus">+                            MailConsts.OpenMessageBehavior[aPref]);</span>
<a href="#l26.119"></a><span id="l26.119"> }</span>
<a href="#l26.120"></a><span id="l26.120"> </span>
<a href="#l26.121"></a><span id="l26.121"> /**</span>
<a href="#l26.122"></a><span id="l26.122">  * Reset the mail.openMessageBehavior pref.</span>
<a href="#l26.123"></a><span id="l26.123">  */</span>
<a href="#l26.124"></a><span id="l26.124"> function reset_open_message_behavior() {</span>
<a href="#l26.125"></a><span id="l26.125" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l26.126"></a><span id="l26.126" class="difflineminus">-                     .getService(Ci.nsIPrefService).getBranch(null);</span>
<a href="#l26.127"></a><span id="l26.127" class="difflineminus">-  if (prefBranch.prefHasUserValue(&quot;mail.openMessageBehavior&quot;))</span>
<a href="#l26.128"></a><span id="l26.128" class="difflineminus">-    prefBranch.clearUserPref(&quot;mail.openMessageBehavior&quot;);</span>
<a href="#l26.129"></a><span id="l26.129" class="difflineplus">+  if (Services.prefs.prefHasUserValue(&quot;mail.openMessageBehavior&quot;))</span>
<a href="#l26.130"></a><span id="l26.130" class="difflineplus">+    Services.prefs.clearUserPref(&quot;mail.openMessageBehavior&quot;);</span>
<a href="#l26.131"></a><span id="l26.131"> }</span>
<a href="#l26.132"></a><span id="l26.132"> </span>
<a href="#l26.133"></a><span id="l26.133"> /**</span>
<a href="#l26.134"></a><span id="l26.134">  * Set the mail.tabs.loadInBackground pref.</span>
<a href="#l26.135"></a><span id="l26.135">  *</span>
<a href="#l26.136"></a><span id="l26.136">  * @param aPref true/false.</span>
<a href="#l26.137"></a><span id="l26.137">  */</span>
<a href="#l26.138"></a><span id="l26.138"> function set_context_menu_background_tabs(aPref) {</span>
<a href="#l26.139"></a><span id="l26.139" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l26.140"></a><span id="l26.140" class="difflineminus">-                     .getService(Ci.nsIPrefService).getBranch(null);</span>
<a href="#l26.141"></a><span id="l26.141" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.tabs.loadInBackground&quot;, aPref);</span>
<a href="#l26.142"></a><span id="l26.142" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.tabs.loadInBackground&quot;, aPref);</span>
<a href="#l26.143"></a><span id="l26.143"> }</span>
<a href="#l26.144"></a><span id="l26.144"> </span>
<a href="#l26.145"></a><span id="l26.145"> /**</span>
<a href="#l26.146"></a><span id="l26.146">  * Reset the mail.tabs.loadInBackground pref.</span>
<a href="#l26.147"></a><span id="l26.147">  */</span>
<a href="#l26.148"></a><span id="l26.148"> function reset_context_menu_background_tabs() {</span>
<a href="#l26.149"></a><span id="l26.149" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l26.150"></a><span id="l26.150" class="difflineminus">-                     .getService(Ci.nsIPrefService).getBranch(null);</span>
<a href="#l26.151"></a><span id="l26.151" class="difflineminus">-  if (prefBranch.prefHasUserValue(&quot;mail.tabs.loadInBackground&quot;))</span>
<a href="#l26.152"></a><span id="l26.152" class="difflineminus">-    prefBranch.clearUserPref(&quot;mail.tabs.loadInBackground&quot;);</span>
<a href="#l26.153"></a><span id="l26.153" class="difflineplus">+  if (Services.prefs.prefHasUserValue(&quot;mail.tabs.loadInBackground&quot;))</span>
<a href="#l26.154"></a><span id="l26.154" class="difflineplus">+    Services.prefs.clearUserPref(&quot;mail.tabs.loadInBackground&quot;);</span>
<a href="#l26.155"></a><span id="l26.155"> }</span>
<a href="#l26.156"></a><span id="l26.156"> </span>
<a href="#l26.157"></a><span id="l26.157"> /**</span>
<a href="#l26.158"></a><span id="l26.158">  * Set the mail.close_message_window.on_delete pref.</span>
<a href="#l26.159"></a><span id="l26.159">  *</span>
<a href="#l26.160"></a><span id="l26.160">  * @param aPref true/false.</span>
<a href="#l26.161"></a><span id="l26.161">  */</span>
<a href="#l26.162"></a><span id="l26.162"> function set_close_message_on_delete(aPref) {</span>
<a href="#l26.163"></a><span id="l26.163" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l26.164"></a><span id="l26.164" class="difflineminus">-                     .getService(Ci.nsIPrefService).getBranch(null);</span>
<a href="#l26.165"></a><span id="l26.165" class="difflineminus">-  prefBranch.setBoolPref(&quot;mail.close_message_window.on_delete&quot;, aPref);</span>
<a href="#l26.166"></a><span id="l26.166" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.close_message_window.on_delete&quot;, aPref);</span>
<a href="#l26.167"></a><span id="l26.167"> }</span>
<a href="#l26.168"></a><span id="l26.168"> </span>
<a href="#l26.169"></a><span id="l26.169"> /**</span>
<a href="#l26.170"></a><span id="l26.170">  * Reset the mail.close_message_window.on_delete pref.</span>
<a href="#l26.171"></a><span id="l26.171">  */</span>
<a href="#l26.172"></a><span id="l26.172"> function reset_close_message_on_delete() {</span>
<a href="#l26.173"></a><span id="l26.173" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l26.174"></a><span id="l26.174" class="difflineminus">-                     .getService(Ci.nsIPrefService).getBranch(null);</span>
<a href="#l26.175"></a><span id="l26.175" class="difflineminus">-  if (prefBranch.prefHasUserValue(&quot;mail.close_message_window.on_delete&quot;))</span>
<a href="#l26.176"></a><span id="l26.176" class="difflineminus">-    prefBranch.clearUserPref(&quot;mail.close_message_window.on_delete&quot;);</span>
<a href="#l26.177"></a><span id="l26.177" class="difflineplus">+  if (Services.prefs.prefHasUserValue(&quot;mail.close_message_window.on_delete&quot;))</span>
<a href="#l26.178"></a><span id="l26.178" class="difflineplus">+    Services.prefs.clearUserPref(&quot;mail.close_message_window.on_delete&quot;);</span>
<a href="#l26.179"></a><span id="l26.179"> }</span>
<a href="#l26.180"></a><span id="l26.180"> </span>
<a href="#l26.181"></a><span id="l26.181"> /**</span>
<a href="#l26.182"></a><span id="l26.182">  * assert that the multimessage/thread summary view contains</span>
<a href="#l26.183"></a><span id="l26.183">  * the specified number of elements of the specified class.</span>
<a href="#l26.184"></a><span id="l26.184">  *</span>
<a href="#l26.185"></a><span id="l26.185">  * @param aClassName: the class to use to select</span>
<a href="#l26.186"></a><span id="l26.186">  * @param aNumElts: the number of expected elements that have that class</span>
<a href="#l26.187"></a><span id="l26.187" class="difflineat">@@ -2738,32 +2721,28 @@ const kClassicMailLayout = 0;</span>
<a href="#l26.188"></a><span id="l26.188"> const kWideMailLayout = 1;</span>
<a href="#l26.189"></a><span id="l26.189"> const kVerticalMailLayout = 2;</span>
<a href="#l26.190"></a><span id="l26.190"> </span>
<a href="#l26.191"></a><span id="l26.191"> /**</span>
<a href="#l26.192"></a><span id="l26.192">  * Assert that the current mail pane layout is shown</span>
<a href="#l26.193"></a><span id="l26.193">  */</span>
<a href="#l26.194"></a><span id="l26.194"> </span>
<a href="#l26.195"></a><span id="l26.195"> function assert_pane_layout(aLayout) {</span>
<a href="#l26.196"></a><span id="l26.196" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l26.197"></a><span id="l26.197" class="difflineminus">-                      .getService(Ci.nsIPrefService).getBranch(null);</span>
<a href="#l26.198"></a><span id="l26.198" class="difflineminus">-  let actualPaneLayout = prefBranch.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l26.199"></a><span id="l26.199" class="difflineplus">+  let actualPaneLayout = Services.prefs.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l26.200"></a><span id="l26.200">   if (actualPaneLayout != aLayout)</span>
<a href="#l26.201"></a><span id="l26.201">     throw new Error(&quot;The mail pane layout should be &quot; + aLayout +</span>
<a href="#l26.202"></a><span id="l26.202">                     &quot;, but is actually &quot; + actualPaneLayout);</span>
<a href="#l26.203"></a><span id="l26.203"> }</span>
<a href="#l26.204"></a><span id="l26.204"> </span>
<a href="#l26.205"></a><span id="l26.205"> /**</span>
<a href="#l26.206"></a><span id="l26.206">  * Change that the current mail pane layout</span>
<a href="#l26.207"></a><span id="l26.207">  */</span>
<a href="#l26.208"></a><span id="l26.208"> </span>
<a href="#l26.209"></a><span id="l26.209"> function set_pane_layout(aLayout) {</span>
<a href="#l26.210"></a><span id="l26.210" class="difflineminus">-  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l26.211"></a><span id="l26.211" class="difflineminus">-                      .getService(Ci.nsIPrefService).getBranch(null);</span>
<a href="#l26.212"></a><span id="l26.212" class="difflineminus">-  prefBranch.setIntPref(&quot;mail.pane_config.dynamic&quot;, aLayout);</span>
<a href="#l26.213"></a><span id="l26.213" class="difflineplus">+  Services.prefs.setIntPref(&quot;mail.pane_config.dynamic&quot;, aLayout);</span>
<a href="#l26.214"></a><span id="l26.214"> }</span>
<a href="#l26.215"></a><span id="l26.215"> </span>
<a href="#l26.216"></a><span id="l26.216"> /** exported from messageInjection */</span>
<a href="#l26.217"></a><span id="l26.217"> var make_new_sets_in_folders;</span>
<a href="#l26.218"></a><span id="l26.218"> var make_new_sets_in_folder;</span>
<a href="#l26.219"></a><span id="l26.219"> var add_sets_to_folders;</span>
<a href="#l26.220"></a><span id="l26.220"> var delete_message_set;</span>
<a href="#l26.221"></a><span id="l26.221"> var make_folder_with_sets;</span>
<a href="#l26.222"></a><span id="l26.222" class="difflineat">@@ -2775,35 +2754,30 @@ var SyntheticPartMultiRelated;</span>
<a href="#l26.223"></a><span id="l26.223"> /**</span>
<a href="#l26.224"></a><span id="l26.224">  * Load a file in its own 'module'.</span>
<a href="#l26.225"></a><span id="l26.225">  *</span>
<a href="#l26.226"></a><span id="l26.226">  * @param aPath A path relative to the comm-central source path.</span>
<a href="#l26.227"></a><span id="l26.227">  *</span>
<a href="#l26.228"></a><span id="l26.228">  * @return An object that serves as the global scope for the loaded file.</span>
<a href="#l26.229"></a><span id="l26.229">  */</span>
<a href="#l26.230"></a><span id="l26.230"> function load_via_src_path(aPath, aModule) {</span>
<a href="#l26.231"></a><span id="l26.231" class="difflineminus">-  let loader = Cc[&quot;@mozilla.org/moz/jssubscript-loader;1&quot;]</span>
<a href="#l26.232"></a><span id="l26.232" class="difflineminus">-                 .getService(Ci.mozIJSSubScriptLoader);</span>
<a href="#l26.233"></a><span id="l26.233" class="difflineminus">-  let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l26.234"></a><span id="l26.234" class="difflineminus">-                    .getService(Ci.nsIIOService);</span>
<a href="#l26.235"></a><span id="l26.235" class="difflineminus">-</span>
<a href="#l26.236"></a><span id="l26.236">   let thisFilePath = os.getFileForPath(__file__);</span>
<a href="#l26.237"></a><span id="l26.237"> </span>
<a href="#l26.238"></a><span id="l26.238">   for (let i = 0; i &lt; FILE_LOAD_PATHS.length; ++i) {</span>
<a href="#l26.239"></a><span id="l26.239">     let srcPath = os.abspath(FILE_LOAD_PATHS[i], thisFilePath);</span>
<a href="#l26.240"></a><span id="l26.240">     let fullPath = os.abspath(aPath, os.getFileForPath(srcPath));</span>
<a href="#l26.241"></a><span id="l26.241"> </span>
<a href="#l26.242"></a><span id="l26.242">     let file = Cc[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l26.243"></a><span id="l26.243">                  .createInstance(Ci.nsILocalFile);</span>
<a href="#l26.244"></a><span id="l26.244">     file.initWithPath(fullPath);</span>
<a href="#l26.245"></a><span id="l26.245"> </span>
<a href="#l26.246"></a><span id="l26.246">     if (file.exists()) {</span>
<a href="#l26.247"></a><span id="l26.247">       try {</span>
<a href="#l26.248"></a><span id="l26.248" class="difflineminus">-        let uri = ioService.newFileURI(file).spec;</span>
<a href="#l26.249"></a><span id="l26.249" class="difflineminus">-        loader.loadSubScript(uri, aModule);</span>
<a href="#l26.250"></a><span id="l26.250" class="difflineplus">+        let uri = Services.io.newFileURI(file).spec;</span>
<a href="#l26.251"></a><span id="l26.251" class="difflineplus">+        Services.scriptloader.loadSubScript(uri, aModule);</span>
<a href="#l26.252"></a><span id="l26.252">         return;</span>
<a href="#l26.253"></a><span id="l26.253">       }</span>
<a href="#l26.254"></a><span id="l26.254">       catch (ex) {</span>
<a href="#l26.255"></a><span id="l26.255">         throw new Error(&quot;Unable to load file: &quot; + fullPath + &quot; exception: &quot; + ex);</span>
<a href="#l26.256"></a><span id="l26.256">       }</span>
<a href="#l26.257"></a><span id="l26.257">     }</span>
<a href="#l26.258"></a><span id="l26.258">   }</span>
<a href="#l26.259"></a><span id="l26.259"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -14,16 +14,17 @@ var elib = {};</span>
<a href="#l27.4"></a><span id="l27.4"> Cu.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l27.5"></a><span id="l27.5"> var frame = {};</span>
<a href="#l27.6"></a><span id="l27.6"> Cu.import('resource://mozmill/modules/frame.js', frame);</span>
<a href="#l27.7"></a><span id="l27.7"> var utils = {};</span>
<a href="#l27.8"></a><span id="l27.8"> Cu.import('resource://mozmill/modules/utils.js', utils);</span>
<a href="#l27.9"></a><span id="l27.9"> </span>
<a href="#l27.10"></a><span id="l27.10"> Cu.import('resource:///modules/iteratorUtils.jsm');</span>
<a href="#l27.11"></a><span id="l27.11"> Cu.import('resource://gre/modules/NetUtil.jsm');</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l27.13"></a><span id="l27.13"> </span>
<a href="#l27.14"></a><span id="l27.14"> const MODULE_NAME = 'window-helpers';</span>
<a href="#l27.15"></a><span id="l27.15"> </span>
<a href="#l27.16"></a><span id="l27.16"> /**</span>
<a href="#l27.17"></a><span id="l27.17">  * Timeout to use when waiting for the first window ever to load.  This is</span>
<a href="#l27.18"></a><span id="l27.18">  *  long because we are basically waiting for the entire app startup process.</span>
<a href="#l27.19"></a><span id="l27.19">  */</span>
<a href="#l27.20"></a><span id="l27.20"> const FIRST_WINDOW_EVER_TIMEOUT_MS = 30000;</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineat">@@ -52,23 +53,17 @@ const WINDOW_CLOSE_TIMEOUT_MS = 10000;</span>
<a href="#l27.22"></a><span id="l27.22">  */</span>
<a href="#l27.23"></a><span id="l27.23"> const WINDOW_CLOSE_CHECK_INTERVAL_MS = 100;</span>
<a href="#l27.24"></a><span id="l27.24"> </span>
<a href="#l27.25"></a><span id="l27.25"> /**</span>
<a href="#l27.26"></a><span id="l27.26">  * Timeout for focusing a window.  Only really an issue on linux.</span>
<a href="#l27.27"></a><span id="l27.27">  */</span>
<a href="#l27.28"></a><span id="l27.28"> const WINDOW_FOCUS_TIMEOUT_MS = 10000;</span>
<a href="#l27.29"></a><span id="l27.29"> </span>
<a href="#l27.30"></a><span id="l27.30" class="difflineminus">-const focusManager = Cc[&quot;@mozilla.org/focus-manager;1&quot;].</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-                       getService(Ci.nsIFocusManager);</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineminus">-const threadManager = Cc[&quot;@mozilla.org/thread-manager;1&quot;]</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineminus">-                        .getService(Ci.nsIThreadManager);</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineminus">-const hiddenWindow = Cc[&quot;@mozilla.org/appshell/appShellService;1&quot;]</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineminus">-                       .getService(Ci.nsIAppShellService)</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineminus">-                       .hiddenDOMWindow;</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineplus">+const hiddenWindow = Services.appShell.hiddenDOMWindow;</span>
<a href="#l27.38"></a><span id="l27.38"> </span>
<a href="#l27.39"></a><span id="l27.39"> // Have a dummy mark_action function in case test-folder-display-helpers does</span>
<a href="#l27.40"></a><span id="l27.40"> // not provide us with one.</span>
<a href="#l27.41"></a><span id="l27.41"> var mark_action = function dummy_mark_action() {};</span>
<a href="#l27.42"></a><span id="l27.42"> var mark_failure = function dummy_mark_failure() {};</span>
<a href="#l27.43"></a><span id="l27.43"> var normalize_for_json = function dummy_normalize_for_json() {};</span>
<a href="#l27.44"></a><span id="l27.44"> /**</span>
<a href="#l27.45"></a><span id="l27.45">  * This is used by test-folder-display-helpers to provide us with a reference</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineat">@@ -456,17 +451,17 @@ var WindowWatcher = {</span>
<a href="#l27.47"></a><span id="l27.47">     // There may be nuances about outer window/inner window that make it</span>
<a href="#l27.48"></a><span id="l27.48">     //  feasible, but I have forgotten any such nuances I once knew.</span>
<a href="#l27.49"></a><span id="l27.49"> </span>
<a href="#l27.50"></a><span id="l27.50">     // It would be great to be able to indicate if the window is modal or not,</span>
<a href="#l27.51"></a><span id="l27.51">     //  but nothing is really jumping out at me to enable that...</span>
<a href="#l27.52"></a><span id="l27.52">     mark_action(&quot;winhelp&quot;, &quot;onOpenWindow&quot;,</span>
<a href="#l27.53"></a><span id="l27.53">                 [getWindowTypeForXulWindow(aXULWindow, true) +</span>
<a href="#l27.54"></a><span id="l27.54">                    &quot; (&quot; + getUniqueIdForXulWindow(aXULWindow) + &quot;)&quot;,</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineminus">-                   &quot;active?&quot;, focusManager.focusedWindow == aXULWindow]);</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineplus">+                   &quot;active?&quot;, Services.focus.focusedWindow == aXULWindow]);</span>
<a href="#l27.57"></a><span id="l27.57">     if (!this.consider(aXULWindow))</span>
<a href="#l27.58"></a><span id="l27.58">       this.monitorWindowLoad(aXULWindow);</span>
<a href="#l27.59"></a><span id="l27.59">   },</span>
<a href="#l27.60"></a><span id="l27.60"> </span>
<a href="#l27.61"></a><span id="l27.61">   /**</span>
<a href="#l27.62"></a><span id="l27.62">    * Consider if the given window is something in our |waitingList|.</span>
<a href="#l27.63"></a><span id="l27.63">    *</span>
<a href="#l27.64"></a><span id="l27.64">    * @return true if we were able to fully consider the object, false if we were</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineat">@@ -707,35 +702,33 @@ function _wait_for_generic_load(aDetails</span>
<a href="#l27.66"></a><span id="l27.66">                               .getInterface(Ci.nsIDOMWindowUtils)</span>
<a href="#l27.67"></a><span id="l27.67">                               .outerWindowID;</span>
<a href="#l27.68"></a><span id="l27.68">   controller.windowMap.update(windowId, &quot;loaded&quot;, true);</span>
<a href="#l27.69"></a><span id="l27.69">   let cwc = new controller.MozMillController(contentWindow);</span>
<a href="#l27.70"></a><span id="l27.70">   return augment_controller(cwc);</span>
<a href="#l27.71"></a><span id="l27.71"> }</span>
<a href="#l27.72"></a><span id="l27.72"> </span>
<a href="#l27.73"></a><span id="l27.73"> </span>
<a href="#l27.74"></a><span id="l27.74" class="difflineminus">-let obsService = Cc[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineminus">-                   .getService(Ci.nsIObserverService);</span>
<a href="#l27.76"></a><span id="l27.76"> let observationWaitFuncs = {};</span>
<a href="#l27.77"></a><span id="l27.77"> let observationSaw = {};</span>
<a href="#l27.78"></a><span id="l27.78"> /**</span>
<a href="#l27.79"></a><span id="l27.79">  * Plan for a notification to be sent via the observer service.</span>
<a href="#l27.80"></a><span id="l27.80">  *</span>
<a href="#l27.81"></a><span id="l27.81">  * @param aTopic The topic that will be sent via the observer service.</span>
<a href="#l27.82"></a><span id="l27.82">  */</span>
<a href="#l27.83"></a><span id="l27.83"> function plan_for_observable_event(aTopic) {</span>
<a href="#l27.84"></a><span id="l27.84">   mark_action(&quot;fdh&quot;, &quot;plan_for_observable_event&quot;, [aTopic]);</span>
<a href="#l27.85"></a><span id="l27.85">   observationSaw[aTopic] = false;</span>
<a href="#l27.86"></a><span id="l27.86">   let waiter = observationWaitFuncs[aTopic] = {</span>
<a href="#l27.87"></a><span id="l27.87">     observe: function() {</span>
<a href="#l27.88"></a><span id="l27.88">       mark_action(&quot;winhelp&quot;, &quot;observed event&quot;, [aTopic]);</span>
<a href="#l27.89"></a><span id="l27.89">       observationSaw[aTopic] = true;</span>
<a href="#l27.90"></a><span id="l27.90">     }</span>
<a href="#l27.91"></a><span id="l27.91">   };</span>
<a href="#l27.92"></a><span id="l27.92" class="difflineminus">-  obsService.addObserver(waiter, aTopic, false);</span>
<a href="#l27.93"></a><span id="l27.93" class="difflineplus">+  Services.obs.addObserver(waiter, aTopic, false);</span>
<a href="#l27.94"></a><span id="l27.94"> }</span>
<a href="#l27.95"></a><span id="l27.95"> </span>
<a href="#l27.96"></a><span id="l27.96"> /**</span>
<a href="#l27.97"></a><span id="l27.97">  * Wait for a notification (previously planned for via</span>
<a href="#l27.98"></a><span id="l27.98">  *  |plan_for_observable_event|) to fire.</span>
<a href="#l27.99"></a><span id="l27.99">  *</span>
<a href="#l27.100"></a><span id="l27.100">  * @param aTopic The topic sent via the observer service.</span>
<a href="#l27.101"></a><span id="l27.101">  */</span>
<a href="#l27.102"></a><span id="l27.102" class="difflineat">@@ -744,17 +737,17 @@ function wait_for_observable_event(aTopi</span>
<a href="#l27.103"></a><span id="l27.103">   try {</span>
<a href="#l27.104"></a><span id="l27.104">     function areWeThereYet() {</span>
<a href="#l27.105"></a><span id="l27.105">       return observationSaw[aTopic];</span>
<a href="#l27.106"></a><span id="l27.106">     }</span>
<a href="#l27.107"></a><span id="l27.107">     utils.waitFor(areWeThereYet,</span>
<a href="#l27.108"></a><span id="l27.108">                   &quot;Timed out waiting for notification: &quot; + aTopic);</span>
<a href="#l27.109"></a><span id="l27.109">   }</span>
<a href="#l27.110"></a><span id="l27.110">   finally {</span>
<a href="#l27.111"></a><span id="l27.111" class="difflineminus">-    obsService.removeObserver(observationWaitFuncs[aTopic], aTopic);</span>
<a href="#l27.112"></a><span id="l27.112" class="difflineplus">+    Services.obs.removeObserver(observationWaitFuncs[aTopic], aTopic);</span>
<a href="#l27.113"></a><span id="l27.113">     delete observationWaitFuncs[aTopic];</span>
<a href="#l27.114"></a><span id="l27.114">     delete observationSaw[aTopic];</span>
<a href="#l27.115"></a><span id="l27.115">   }</span>
<a href="#l27.116"></a><span id="l27.116"> }</span>
<a href="#l27.117"></a><span id="l27.117"> </span>
<a href="#l27.118"></a><span id="l27.118"> </span>
<a href="#l27.119"></a><span id="l27.119"> /**</span>
<a href="#l27.120"></a><span id="l27.120">  * Methods to augment every controller that passes through augment_controller.</span>
<a href="#l27.121"></a><span id="l27.121" class="difflineat">@@ -844,19 +837,19 @@ var AugmentEverybodyWith = {</span>
<a href="#l27.122"></a><span id="l27.122">         let elem = anonNodes[index];</span>
<a href="#l27.123"></a><span id="l27.123">         return elem;</span>
<a href="#l27.124"></a><span id="l27.124">       }</span>
<a href="#l27.125"></a><span id="l27.125">       else if(aQuery.tagName) {</span>
<a href="#l27.126"></a><span id="l27.126">         let anonNodes = this.window.document.getAnonymousNodes(realElem);</span>
<a href="#l27.127"></a><span id="l27.127">         let index;</span>
<a href="#l27.128"></a><span id="l27.128">         for (let iNode = 0; iNode &lt; anonNodes.length; iNode++) {</span>
<a href="#l27.129"></a><span id="l27.129">           let node = anonNodes[iNode];</span>
<a href="#l27.130"></a><span id="l27.130" class="difflineminus">-          let named = node.getElementsByTagName(aQuery.tagName);</span>
<a href="#l27.131"></a><span id="l27.131" class="difflineminus">-          if (named.length)</span>
<a href="#l27.132"></a><span id="l27.132" class="difflineminus">-            return named[0];</span>
<a href="#l27.133"></a><span id="l27.133" class="difflineplus">+          let named = node.querySelector(aQuery.tagName);</span>
<a href="#l27.134"></a><span id="l27.134" class="difflineplus">+          if (named)</span>
<a href="#l27.135"></a><span id="l27.135" class="difflineplus">+            return named;</span>
<a href="#l27.136"></a><span id="l27.136">         }</span>
<a href="#l27.137"></a><span id="l27.137">       }</span>
<a href="#l27.138"></a><span id="l27.138">       else {</span>
<a href="#l27.139"></a><span id="l27.139">         let msg = &quot;Query constraint not implemented, query contained:&quot;;</span>
<a href="#l27.140"></a><span id="l27.140">         for (let [key, val] in Iterator(aQuery)) {</span>
<a href="#l27.141"></a><span id="l27.141">           msg += &quot; '&quot; + key + &quot;': &quot; + val;</span>
<a href="#l27.142"></a><span id="l27.142">         }</span>
<a href="#l27.143"></a><span id="l27.143">         throw new Error(msg);</span>
<a href="#l27.144"></a><span id="l27.144" class="difflineat">@@ -969,37 +962,37 @@ var AugmentEverybodyWith = {</span>
<a href="#l27.145"></a><span id="l27.145">         &quot;in window:&quot;,</span>
<a href="#l27.146"></a><span id="l27.146">         getWindowTypeForXulWindow(this.window) + &quot; (&quot; +</span>
<a href="#l27.147"></a><span id="l27.147">           getUniqueIdForXulWindow(this.window) + &quot;)&quot;];</span>
<a href="#l27.148"></a><span id="l27.148">       let focusedWinOut = {}, focusedElement, curWindow = this.window;</span>
<a href="#l27.149"></a><span id="l27.149">       // Use the focus manager to walk down through focused sub-frames so</span>
<a href="#l27.150"></a><span id="l27.150">       //  in the event that there is no focused element but there is a focused</span>
<a href="#l27.151"></a><span id="l27.151">       //  sub-frame, we can know that.</span>
<a href="#l27.152"></a><span id="l27.152">       for (;;) {</span>
<a href="#l27.153"></a><span id="l27.153" class="difflineminus">-        focusedElement = focusManager.getFocusedElementForWindow(curWindow,</span>
<a href="#l27.154"></a><span id="l27.154" class="difflineminus">-                                                                 false,</span>
<a href="#l27.155"></a><span id="l27.155" class="difflineminus">-                                                                 focusedWinOut);</span>
<a href="#l27.156"></a><span id="l27.156" class="difflineplus">+        focusedElement = Services.focus.getFocusedElementForWindow(curWindow,</span>
<a href="#l27.157"></a><span id="l27.157" class="difflineplus">+                                                                   false,</span>
<a href="#l27.158"></a><span id="l27.158" class="difflineplus">+                                                                   focusedWinOut);</span>
<a href="#l27.159"></a><span id="l27.159">         arr.push(&quot;focused kid:&quot;);</span>
<a href="#l27.160"></a><span id="l27.160">         arr.push(focusedElement);</span>
<a href="#l27.161"></a><span id="l27.161"> </span>
<a href="#l27.162"></a><span id="l27.162">         if (focusedElement &amp;&amp; (&quot;contentWindow&quot; in focusedElement)) {</span>
<a href="#l27.163"></a><span id="l27.163">           curWindow = focusedElement.contentWindow;</span>
<a href="#l27.164"></a><span id="l27.164">           continue;</span>
<a href="#l27.165"></a><span id="l27.165">         }</span>
<a href="#l27.166"></a><span id="l27.166">         break;</span>
<a href="#l27.167"></a><span id="l27.167">       }</span>
<a href="#l27.168"></a><span id="l27.168"> </span>
<a href="#l27.169"></a><span id="l27.169">       return arr;</span>
<a href="#l27.170"></a><span id="l27.170">     },</span>
<a href="#l27.171"></a><span id="l27.171">   },</span>
<a href="#l27.172"></a><span id="l27.172">   getters: {</span>
<a href="#l27.173"></a><span id="l27.173">     focusedElement: function() {</span>
<a href="#l27.174"></a><span id="l27.174">       let ignoredFocusedWindow = {};</span>
<a href="#l27.175"></a><span id="l27.175" class="difflineminus">-      return focusManager.getFocusedElementForWindow(this.window, true,</span>
<a href="#l27.176"></a><span id="l27.176" class="difflineminus">-                                                     ignoredFocusedWindow);</span>
<a href="#l27.177"></a><span id="l27.177" class="difflineplus">+      return Services.focus.getFocusedElementForWindow(this.window, true,</span>
<a href="#l27.178"></a><span id="l27.178" class="difflineplus">+                                                       ignoredFocusedWindow);</span>
<a href="#l27.179"></a><span id="l27.179">     },</span>
<a href="#l27.180"></a><span id="l27.180">   },</span>
<a href="#l27.181"></a><span id="l27.181"> };</span>
<a href="#l27.182"></a><span id="l27.182"> </span>
<a href="#l27.183"></a><span id="l27.183"> /**</span>
<a href="#l27.184"></a><span id="l27.184">  * Clicks and other mouse operations used to be recognized just outside a curved</span>
<a href="#l27.185"></a><span id="l27.185">  * border but are no longer so (bug 595652), so we need these wrappers to</span>
<a href="#l27.186"></a><span id="l27.186">  * perform the operations at the center when aLeft or aTop aren't passed in.</span>
<a href="#l27.187"></a><span id="l27.187" class="difflineat">@@ -1321,21 +1314,20 @@ function _augment_helper(aController, aA</span>
<a href="#l27.188"></a><span id="l27.188"> </span>
<a href="#l27.189"></a><span id="l27.189"> var INPUT_PEEK_EVENTS = [&quot;click&quot;, &quot;keypress&quot;];</span>
<a href="#l27.190"></a><span id="l27.190"> </span>
<a href="#l27.191"></a><span id="l27.191"> var UNIQUE_WINDOW_ID_ATTR = &quot;__winHelper_uniqueId&quot;;</span>
<a href="#l27.192"></a><span id="l27.192"> </span>
<a href="#l27.193"></a><span id="l27.193"> var DOM_KEYCODE_TO_NAME = {};</span>
<a href="#l27.194"></a><span id="l27.194"> function populateDomKeycodeMap() {</span>
<a href="#l27.195"></a><span id="l27.195">   let nsIDOMKeyEvent = Ci.nsIDOMKeyEvent;</span>
<a href="#l27.196"></a><span id="l27.196" class="difflineminus">-  let re_dom_vk = /^DOM_VK_/;</span>
<a href="#l27.197"></a><span id="l27.197"> </span>
<a href="#l27.198"></a><span id="l27.198">   for (let key in nsIDOMKeyEvent) {</span>
<a href="#l27.199"></a><span id="l27.199" class="difflineminus">-    </span>
<a href="#l27.200"></a><span id="l27.200" class="difflineminus">-    if (re_dom_vk.test(key)) {</span>
<a href="#l27.201"></a><span id="l27.201" class="difflineplus">+</span>
<a href="#l27.202"></a><span id="l27.202" class="difflineplus">+    if (key.startsWith(&quot;DOM_VK_&quot;)) {</span>
<a href="#l27.203"></a><span id="l27.203">       let val = nsIDOMKeyEvent[key];</span>
<a href="#l27.204"></a><span id="l27.204">       DOM_KEYCODE_TO_NAME[val] = key;</span>
<a href="#l27.205"></a><span id="l27.205">     }</span>
<a href="#l27.206"></a><span id="l27.206">   }</span>
<a href="#l27.207"></a><span id="l27.207"> }</span>
<a href="#l27.208"></a><span id="l27.208"> populateDomKeycodeMap();</span>
<a href="#l27.209"></a><span id="l27.209"> </span>
<a href="#l27.210"></a><span id="l27.210"> /**</span>
<a href="#l27.211"></a><span id="l27.211" class="difflineat">@@ -1738,20 +1730,17 @@ function screenshotToBase64(aWindow) {</span>
<a href="#l27.212"></a><span id="l27.212">  * - Is the window active/focused?</span>
<a href="#l27.213"></a><span id="l27.213">  * - The focused element in the window; we leave this up to logHelper to</span>
<a href="#l27.214"></a><span id="l27.214">  *    describe.</span>
<a href="#l27.215"></a><span id="l27.215">  */</span>
<a href="#l27.216"></a><span id="l27.216"> function captureWindowStatesForErrorReporting(normalizeForJsonFunc) {</span>
<a href="#l27.217"></a><span id="l27.217">   let info = {};</span>
<a href="#l27.218"></a><span id="l27.218">   let windows = info.windows = [];</span>
<a href="#l27.219"></a><span id="l27.219"> </span>
<a href="#l27.220"></a><span id="l27.220" class="difflineminus">-  let windowMediator = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l27.221"></a><span id="l27.221" class="difflineminus">-                         .getService(Ci.nsIWindowMediator);</span>
<a href="#l27.222"></a><span id="l27.222" class="difflineminus">-</span>
<a href="#l27.223"></a><span id="l27.223" class="difflineminus">-  let enumerator = windowMediator.getEnumerator(null);</span>
<a href="#l27.224"></a><span id="l27.224" class="difflineplus">+  let enumerator = Services.wm.getEnumerator(null);</span>
<a href="#l27.225"></a><span id="l27.225">   let iWin=0;</span>
<a href="#l27.226"></a><span id="l27.226">   while (enumerator.hasMoreElements()) {</span>
<a href="#l27.227"></a><span id="l27.227">     let win = enumerator.getNext().QueryInterface(Ci.nsIDOMWindow);</span>
<a href="#l27.228"></a><span id="l27.228"> </span>
<a href="#l27.229"></a><span id="l27.229">     let winId = win.document.documentElement.getAttribute(&quot;windowtype&quot;) ||</span>
<a href="#l27.230"></a><span id="l27.230">                 win.document.documentElement.getAttribute(&quot;id&quot;) ||</span>
<a href="#l27.231"></a><span id="l27.231">                 (&quot;unnamed:&quot; + iWin);</span>
<a href="#l27.232"></a><span id="l27.232"> </span>
<a href="#l27.233"></a><span id="l27.233" class="difflineat">@@ -1764,20 +1753,20 @@ function captureWindowStatesForErrorRepo</span>
<a href="#l27.234"></a><span id="l27.234">     let ignoredFocusedWindow = {};</span>
<a href="#l27.235"></a><span id="l27.235">     let winfo = {</span>
<a href="#l27.236"></a><span id="l27.236">       id: winId,</span>
<a href="#l27.237"></a><span id="l27.237">       title: win.document.title,</span>
<a href="#l27.238"></a><span id="l27.238">       coords: {x: win.screenX, y: win.screenY},</span>
<a href="#l27.239"></a><span id="l27.239">       dims: {width: win.outerWidth, height: win.outerHeight},</span>
<a href="#l27.240"></a><span id="l27.240">       pageOffsets: {x: win.pageXOffset, y: win.pageYOffset},</span>
<a href="#l27.241"></a><span id="l27.241">       screenshotDataUrl: screenshotToDataURL(win),</span>
<a href="#l27.242"></a><span id="l27.242" class="difflineminus">-      isActive: focusManager.activeWindow == win,</span>
<a href="#l27.243"></a><span id="l27.243" class="difflineplus">+      isActive: Services.focus.activeWindow == win,</span>
<a href="#l27.244"></a><span id="l27.244">       focusedElem: normalizeForJsonFunc(</span>
<a href="#l27.245"></a><span id="l27.245" class="difflineminus">-        focusManager.getFocusedElementForWindow(win, true,</span>
<a href="#l27.246"></a><span id="l27.246" class="difflineminus">-                                                ignoredFocusedWindow)),</span>
<a href="#l27.247"></a><span id="l27.247" class="difflineplus">+        Services.focus.getFocusedElementForWindow(win, true,</span>
<a href="#l27.248"></a><span id="l27.248" class="difflineplus">+                                                  ignoredFocusedWindow)),</span>
<a href="#l27.249"></a><span id="l27.249">       openPopups: openPopups,</span>
<a href="#l27.250"></a><span id="l27.250">     };</span>
<a href="#l27.251"></a><span id="l27.251"> </span>
<a href="#l27.252"></a><span id="l27.252">     windows.push(winfo);</span>
<a href="#l27.253"></a><span id="l27.253">   }</span>
<a href="#l27.254"></a><span id="l27.254"> </span>
<a href="#l27.255"></a><span id="l27.255">   return info;</span>
<a href="#l27.256"></a><span id="l27.256"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l28.4"></a><span id="l28.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.5"></a><span id="l28.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.6"></a><span id="l28.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.7"></a><span id="l28.7"> </span>
<a href="#l28.8"></a><span id="l28.8"> var elib = {};</span>
<a href="#l28.9"></a><span id="l28.9"> Cu.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineplus">+Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12"> /*</span>
<a href="#l28.13"></a><span id="l28.13">  * Test rearanging tabs via drag'n'drop.</span>
<a href="#l28.14"></a><span id="l28.14">  */</span>
<a href="#l28.15"></a><span id="l28.15"> </span>
<a href="#l28.16"></a><span id="l28.16"> var MODULE_NAME = &quot;test-tabmail-dragndrop&quot;;</span>
<a href="#l28.17"></a><span id="l28.17"> </span>
<a href="#l28.18"></a><span id="l28.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineat">@@ -158,23 +159,20 @@ function test_tab_reorder_window(){</span>
<a href="#l28.20"></a><span id="l28.20">   assert_number_of_tabs_open(2);</span>
<a href="#l28.21"></a><span id="l28.21"> </span>
<a href="#l28.22"></a><span id="l28.22">   switch_tab(1);</span>
<a href="#l28.23"></a><span id="l28.23">   assert_selected_and_displayed(msgHdrsInFolder[1]);</span>
<a href="#l28.24"></a><span id="l28.24"> </span>
<a href="#l28.25"></a><span id="l28.25">   // ...and then a new 3 pane as our drop target.</span>
<a href="#l28.26"></a><span id="l28.26">   plan_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l28.27"></a><span id="l28.27"> </span>
<a href="#l28.28"></a><span id="l28.28" class="difflineminus">-  let ww = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineminus">-                        .getService(Ci.nsIWindowWatcher);</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineminus">-</span>
<a href="#l28.31"></a><span id="l28.31">   let args = {msgHdr: msgHdrsInFolder[3]};</span>
<a href="#l28.32"></a><span id="l28.32">   args.wrappedJSObject = args;</span>
<a href="#l28.33"></a><span id="l28.33"> </span>
<a href="#l28.34"></a><span id="l28.34" class="difflineminus">-  let aWnd2 = ww.openWindow(null,</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineplus">+  let aWnd2 = Services.ww.openWindow(null,</span>
<a href="#l28.36"></a><span id="l28.36">         &quot;chrome://messenger/content/&quot;, &quot;&quot;,</span>
<a href="#l28.37"></a><span id="l28.37">         &quot;all,chrome,dialog=no,status,toolbar&quot;, args);</span>
<a href="#l28.38"></a><span id="l28.38"> </span>
<a href="#l28.39"></a><span id="l28.39">   mc2 = wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l28.40"></a><span id="l28.40">   wait_for_message_display_completion(mc2,true);</span>
<a href="#l28.41"></a><span id="l28.41"> </span>
<a href="#l28.42"></a><span id="l28.42">   // Double check if we are listening to the right window.</span>
<a href="#l28.43"></a><span id="l28.43">   assert_true(aWnd2 == mc2.window, &quot;Opening Window failed&quot; );</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineat">@@ -412,19 +410,17 @@ function teardownTest(test)</span>
<a href="#l28.45"></a><span id="l28.45"> </span>
<a href="#l28.46"></a><span id="l28.46">   switch(test)</span>
<a href="#l28.47"></a><span id="l28.47">   {</span>
<a href="#l28.48"></a><span id="l28.48">     case test_tab_reorder_detach :</span>
<a href="#l28.49"></a><span id="l28.49">     case test_tab_reorder_window :</span>
<a href="#l28.50"></a><span id="l28.50">       // Some test cases open new windows, thus we need to ensure all</span>
<a href="#l28.51"></a><span id="l28.51">       // opened windows get closed.</span>
<a href="#l28.52"></a><span id="l28.52"> </span>
<a href="#l28.53"></a><span id="l28.53" class="difflineminus">-      let en = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineminus">-                 .getService(Ci.nsIWindowMediator)</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineminus">-                 .getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineplus">+      let en = Services.wm.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l28.57"></a><span id="l28.57"> </span>
<a href="#l28.58"></a><span id="l28.58">        while(en.hasMoreElements()) {</span>
<a href="#l28.59"></a><span id="l28.59"> </span>
<a href="#l28.60"></a><span id="l28.60">          var win = en.getNext();</span>
<a href="#l28.61"></a><span id="l28.61"> </span>
<a href="#l28.62"></a><span id="l28.62">          if(win != mc.window)</span>
<a href="#l28.63"></a><span id="l28.63">            close_window(new mozmill.controller.MozMillController(win));</span>
<a href="#l28.64"></a><span id="l28.64">        }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/base/content/folderProps.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/base/content/folderProps.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -224,18 +224,17 @@ function folderPropsOnLoad()</span>
<a href="#l29.4"></a><span id="l29.4">         document.getElementById(&quot;offline.selectForOfflineFolder&quot;).checked = false;</span>
<a href="#l29.5"></a><span id="l29.5"> </span>
<a href="#l29.6"></a><span id="l29.6">       if(serverType == &quot;nntp&quot;)</span>
<a href="#l29.7"></a><span id="l29.7">         document.getElementById(&quot;offline.selectForOfflineNewsgroup&quot;).checked = false;</span>
<a href="#l29.8"></a><span id="l29.8">     }</span>
<a href="#l29.9"></a><span id="l29.9"> </span>
<a href="#l29.10"></a><span id="l29.10">     // select the menu item</span>
<a href="#l29.11"></a><span id="l29.11">     var folderCharsetList = document.getElementById(&quot;folderCharsetList&quot;);</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-    var elements = folderCharsetList.getElementsByAttribute(&quot;value&quot;, gMsgFolder.charset);</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-    folderCharsetList.selectedItem = elements[0];</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+    folderCharsetList.selectedItem = folderCharsetList.querySelector('[value=&quot;' + gMsgFolder.charset + '&quot;]');</span>
<a href="#l29.15"></a><span id="l29.15"> </span>
<a href="#l29.16"></a><span id="l29.16">     // set override checkbox</span>
<a href="#l29.17"></a><span id="l29.17">     document.getElementById(&quot;folderCharsetOverride&quot;).checked = gMsgFolder.charsetOverride;</span>
<a href="#l29.18"></a><span id="l29.18"> </span>
<a href="#l29.19"></a><span id="l29.19">     // set check for new mail checkbox</span>
<a href="#l29.20"></a><span id="l29.20">     document.getElementById(&quot;folderCheckForNewMessages&quot;).checked = gMsgFolder.flags &amp; nsMsgFolderFlags.CheckNew;</span>
<a href="#l29.21"></a><span id="l29.21"> </span>
<a href="#l29.22"></a><span id="l29.22">     // if gloda indexing is off, hide the related checkbox</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineat">@@ -285,17 +284,17 @@ function folderPropsOnLoad()</span>
<a href="#l29.24"></a><span id="l29.24">     catch (ex) {}</span>
<a href="#l29.25"></a><span id="l29.25">   }</span>
<a href="#l29.26"></a><span id="l29.26">   onCheckKeepMsg();</span>
<a href="#l29.27"></a><span id="l29.27">   onUseDefaultRetentionSettings();</span>
<a href="#l29.28"></a><span id="l29.28"> }</span>
<a href="#l29.29"></a><span id="l29.29"> </span>
<a href="#l29.30"></a><span id="l29.30"> function hideShowControls(serverType)</span>
<a href="#l29.31"></a><span id="l29.31"> {</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineminus">-  var controls = document.getElementsByAttribute(&quot;hidefor&quot;, &quot;*&quot;);</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineplus">+  let controls = document.querySelectorAll(&quot;[hidefor]&quot;);</span>
<a href="#l29.34"></a><span id="l29.34">   var len = controls.length;</span>
<a href="#l29.35"></a><span id="l29.35">   for (var i=0; i&lt;len; i++) {</span>
<a href="#l29.36"></a><span id="l29.36">     var control = controls[i];</span>
<a href="#l29.37"></a><span id="l29.37">     var hideFor = control.getAttribute(&quot;hidefor&quot;);</span>
<a href="#l29.38"></a><span id="l29.38">     if (!hideFor)</span>
<a href="#l29.39"></a><span id="l29.39">       throw &quot;hidefor empty&quot;;</span>
<a href="#l29.40"></a><span id="l29.40"> </span>
<a href="#l29.41"></a><span id="l29.41">     // hide unsupported server type</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/base/content/folderWidgets.xml</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/base/content/folderWidgets.xml</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -20,17 +20,17 @@</span>
<a href="#l30.4"></a><span id="l30.4">         Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, this);</span>
<a href="#l30.5"></a><span id="l30.5"> </span>
<a href="#l30.6"></a><span id="l30.6">         // If we are a child of a menulist, and we aren't in a wrapper, we</span>
<a href="#l30.7"></a><span id="l30.7">         // need to build our content right away, otherwise the menulist</span>
<a href="#l30.8"></a><span id="l30.8">         // won't have proper sizing.</span>
<a href="#l30.9"></a><span id="l30.9">         let inWrapper = false;</span>
<a href="#l30.10"></a><span id="l30.10">         let node = this;</span>
<a href="#l30.11"></a><span id="l30.11">         while (node instanceof XULElement) {</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-          if (/wrapper-.*/.test(node.id)) {</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+          if (node.id.startsWith(&quot;wrapper-&quot;)) {</span>
<a href="#l30.14"></a><span id="l30.14">             inWrapper = true;</span>
<a href="#l30.15"></a><span id="l30.15">             break;</span>
<a href="#l30.16"></a><span id="l30.16">           }</span>
<a href="#l30.17"></a><span id="l30.17">           node = node.parentNode;</span>
<a href="#l30.18"></a><span id="l30.18">         }</span>
<a href="#l30.19"></a><span id="l30.19">         if (this.parentNode &amp;&amp; this.parentNode.localName == &quot;menulist&quot; &amp;&amp;</span>
<a href="#l30.20"></a><span id="l30.20">             !inWrapper) {</span>
<a href="#l30.21"></a><span id="l30.21">           // If we were in a wrapper before and have a width stored, restore it now.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/base/content/newFolderDialog.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/base/content/newFolderDialog.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -55,17 +55,17 @@ function onFolderSelect(event) {</span>
<a href="#l31.4"></a><span id="l31.4"> function onOK()</span>
<a href="#l31.5"></a><span id="l31.5"> {</span>
<a href="#l31.6"></a><span id="l31.6">   var name = dialog.nameField.value;</span>
<a href="#l31.7"></a><span id="l31.7">   var uri = dialog.folder;</span>
<a href="#l31.8"></a><span id="l31.8"> </span>
<a href="#l31.9"></a><span id="l31.9">   // do name validity check?</span>
<a href="#l31.10"></a><span id="l31.10"> </span>
<a href="#l31.11"></a><span id="l31.11">   // make sure name ends in  &quot;/&quot; if folder to create can only contain folders</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-  if ((dialog.folderType == FOLDERS) &amp;&amp; name.charAt(name.length-1) != &quot;/&quot;)</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+  if ((dialog.folderType == FOLDERS) &amp;&amp; !name.endsWith(&quot;/&quot;))</span>
<a href="#l31.14"></a><span id="l31.14">     dialog.okCallback(name + &quot;/&quot;, dialog.folder);</span>
<a href="#l31.15"></a><span id="l31.15">   else</span>
<a href="#l31.16"></a><span id="l31.16">     dialog.okCallback(name, dialog.folder);</span>
<a href="#l31.17"></a><span id="l31.17"> </span>
<a href="#l31.18"></a><span id="l31.18">   return true;</span>
<a href="#l31.19"></a><span id="l31.19"> }</span>
<a href="#l31.20"></a><span id="l31.20"> </span>
<a href="#l31.21"></a><span id="l31.21"> function onFoldersOnly()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/base/test/unit/test_bccInDatabase.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_bccInDatabase.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -31,15 +31,15 @@ function run_test()</span>
<a href="#l32.4"></a><span id="l32.4">                               &quot;&quot;, copyListener, null);</span>
<a href="#l32.5"></a><span id="l32.5"> }</span>
<a href="#l32.6"></a><span id="l32.6"> </span>
<a href="#l32.7"></a><span id="l32.7"> function continueTest()</span>
<a href="#l32.8"></a><span id="l32.8"> {</span>
<a href="#l32.9"></a><span id="l32.9">   //dump(&quot;\nbccList &gt;&quot; + hdr.bccList);</span>
<a href="#l32.10"></a><span id="l32.10">   //dump(&quot;\nccList &gt;&quot; + hdr.ccList);</span>
<a href="#l32.11"></a><span id="l32.11">   //dump(&quot;\n&quot;);</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-  do_check_true(hdr.bccList.indexOf(&quot;Another Person&quot;) &gt;= 0);</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-  do_check_true(hdr.bccList.indexOf(&quot;&lt;u1@example.com&gt;&quot;) &gt;= 0);</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">-  do_check_false(hdr.bccList.indexOf(&quot;IDoNotExist&quot;) &gt;=0);</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+  do_check_true(hdr.bccList.contains(&quot;Another Person&quot;));</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+  do_check_true(hdr.bccList.contains(&quot;&lt;u1@example.com&gt;&quot;));</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+  do_check_false(hdr.bccList.contains(&quot;IDoNotExist&quot;));</span>
<a href="#l32.18"></a><span id="l32.18">   hdr = null;</span>
<a href="#l32.19"></a><span id="l32.19">   do_test_finished();</span>
<a href="#l32.20"></a><span id="l32.20"> }</span>
<a href="#l32.21"></a><span id="l32.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/base/test/unit/test_detachToFile.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_detachToFile.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -72,17 +72,17 @@ function testDetach()</span>
<a href="#l33.4"></a><span id="l33.4"> </span>
<a href="#l33.5"></a><span id="l33.5">   // The message should now have a detached attachment. Read the message,</span>
<a href="#l33.6"></a><span id="l33.6">   //  and search for &quot;AttachmentDetached&quot; which is added on detachment.</span>
<a href="#l33.7"></a><span id="l33.7"> </span>
<a href="#l33.8"></a><span id="l33.8">   // Get the message header</span>
<a href="#l33.9"></a><span id="l33.9">   let msgHdr = firstMsgHdr(gLocalInboxFolder);</span>
<a href="#l33.10"></a><span id="l33.10"> </span>
<a href="#l33.11"></a><span id="l33.11">   let messageContent = getContentFromMessage(msgHdr);</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-  do_check_true(messageContent.indexOf(&quot;AttachmentDetached&quot;) != -1);</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+  do_check_true(messageContent.contains(&quot;AttachmentDetached&quot;));</span>
<a href="#l33.14"></a><span id="l33.14"> }</span>
<a href="#l33.15"></a><span id="l33.15"> </span>
<a href="#l33.16"></a><span id="l33.16"> function SaveAttachmentCallback() {</span>
<a href="#l33.17"></a><span id="l33.17">   this.attachments = null;</span>
<a href="#l33.18"></a><span id="l33.18"> }</span>
<a href="#l33.19"></a><span id="l33.19"> </span>
<a href="#l33.20"></a><span id="l33.20"> SaveAttachmentCallback.prototype = {</span>
<a href="#l33.21"></a><span id="l33.21">   callback: function saveAttachmentCallback_callback(aMsgHdr, aMimeMessage) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/base/test/unit/test_mimemaltdetach.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_mimemaltdetach.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -74,19 +74,19 @@ function testDetach()</span>
<a href="#l34.4"></a><span id="l34.4"> </span>
<a href="#l34.5"></a><span id="l34.5">   // The message should now have a detached attachment. Read the message,</span>
<a href="#l34.6"></a><span id="l34.6">   //  and search for &quot;AttachmentDetached&quot; which is added on detachment.</span>
<a href="#l34.7"></a><span id="l34.7"> </span>
<a href="#l34.8"></a><span id="l34.8">   // Get the message header</span>
<a href="#l34.9"></a><span id="l34.9">   let msgHdr = firstMsgHdr(gLocalInboxFolder);</span>
<a href="#l34.10"></a><span id="l34.10"> </span>
<a href="#l34.11"></a><span id="l34.11">   let messageContent = getContentFromMessage(msgHdr);</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-  do_check_true(messageContent.indexOf(&quot;AttachmentDetached&quot;) != -1);</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+  do_check_true(messageContent.contains(&quot;AttachmentDetached&quot;));</span>
<a href="#l34.14"></a><span id="l34.14">   // Make sure the body survived the detach.</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineminus">-  do_check_true(messageContent.indexOf(&quot;body hello&quot;) != -1);</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineplus">+  do_check_true(messageContent.contains(&quot;body hello&quot;));</span>
<a href="#l34.17"></a><span id="l34.17"> }</span>
<a href="#l34.18"></a><span id="l34.18"> </span>
<a href="#l34.19"></a><span id="l34.19"> function SaveAttachmentCallback() {</span>
<a href="#l34.20"></a><span id="l34.20">   this.attachments = null;</span>
<a href="#l34.21"></a><span id="l34.21"> }</span>
<a href="#l34.22"></a><span id="l34.22"> </span>
<a href="#l34.23"></a><span id="l34.23"> SaveAttachmentCallback.prototype = {</span>
<a href="#l34.24"></a><span id="l34.24">   callback: function saveAttachmentCallback_callback(aMsgHdr, aMimeMessage) {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

