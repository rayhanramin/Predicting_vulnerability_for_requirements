<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29609:1f1357f245c172afa95cc491fb3b2f14d8fb067c</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1f1357f245c172afa95cc491fb3b2f14d8fb067c" />
<meta property="og:url" content="/comm-central/rev/1f1357f245c172afa95cc491fb3b2f14d8fb067c" />
<meta property="og:description" content="Bug 1612239 - Remove nsIArray usage for msgsMoveCopyCompleted notification. r=mkmelin DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1f1357f245c172afa95cc491fb3b2f14d8fb067c 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1f1357f245c172afa95cc491fb3b2f14d8fb067c">shortlog</a> |
<a href="/comm-central/log/1f1357f245c172afa95cc491fb3b2f14d8fb067c">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1f1357f245c172afa95cc491fb3b2f14d8fb067c">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1f1357f245c172afa95cc491fb3b2f14d8fb067c">files</a> |
changeset |
<a href="/comm-central/raw-rev/1f1357f245c172afa95cc491fb3b2f14d8fb067c">raw</a>  | <a href="/comm-central/archive/1f1357f245c172afa95cc491fb3b2f14d8fb067c.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1612239">Bug 1612239</a> - Remove nsIArray usage for msgsMoveCopyCompleted notification. r=mkmelin DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#67;&#97;&#109;&#112;&#98;&#101;&#108;&#108;&#32;&#60;&#98;&#101;&#110;&#99;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 19 May 2020 12:58:38 +0300</td></tr>

<tr>
 <td>changeset 29609</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1f1357f245c172afa95cc491fb3b2f14d8fb067c">1f1357f245c172afa95cc491fb3b2f14d8fb067c</a></td>
</tr>



<tr>
<td>parent 29608</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bc7e17995e196b439e49de01b3774726b912b960">bc7e17995e196b439e49de01b3774726b912b960</a>
</td>
</tr>

<tr>
<td>child 29610</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2b7fabf7b6f77714915e41c0c967e7677fa261b8">2b7fabf7b6f77714915e41c0c967e7677fa261b8</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1f1357f245c172afa95cc491fb3b2f14d8fb067c">17455</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Tue, 19 May 2020 10:00:03 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1f1357f245c1 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1f1357f245c172afa95cc491fb3b2f14d8fb067c">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1f1357f245c172afa95cc491fb3b2f14d8fb067c&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1f1357f245c172afa95cc491fb3b2f14d8fb067c&newProject=comm-central&newRevision=a440d58f09f80951264aeddebc40a804de4a3e51&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1f1357f245c172afa95cc491fb3b2f14d8fb067c&newProject=comm-central&newRevision=a440d58f09f80951264aeddebc40a804de4a3e51&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1f1357f245c172afa95cc491fb3b2f14d8fb067c&newProject=comm-central&newRevision=a440d58f09f80951264aeddebc40a804de4a3e51&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1612239">1612239</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1612239">Bug 1612239</a> - Remove nsIArray usage for msgsMoveCopyCompleted notification. r=mkmelin DONTBUILD</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mail/components/activity/modules/moveCopy.jsm">mail/components/activity/modules/moveCopy.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mail/components/activity/modules/moveCopy.jsm">file</a> |
<a href="/comm-central/annotate/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mail/components/activity/modules/moveCopy.jsm">annotate</a> |
<a href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mail/components/activity/modules/moveCopy.jsm">diff</a> |
<a href="/comm-central/comparison/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mail/components/activity/modules/moveCopy.jsm">comparison</a> |
<a href="/comm-central/log/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mail/components/activity/modules/moveCopy.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mail/components/search/SearchIntegration.jsm">mail/components/search/SearchIntegration.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mail/components/search/SearchIntegration.jsm">file</a> |
<a href="/comm-central/annotate/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mail/components/search/SearchIntegration.jsm">annotate</a> |
<a href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mail/components/search/SearchIntegration.jsm">diff</a> |
<a href="/comm-central/comparison/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mail/components/search/SearchIntegration.jsm">comparison</a> |
<a href="/comm-central/log/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mail/components/search/SearchIntegration.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/public/nsIMsgFolderListener.idl">mailnews/base/public/nsIMsgFolderListener.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/public/nsIMsgFolderListener.idl">file</a> |
<a href="/comm-central/annotate/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/public/nsIMsgFolderListener.idl">annotate</a> |
<a href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/public/nsIMsgFolderListener.idl">diff</a> |
<a href="/comm-central/comparison/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/public/nsIMsgFolderListener.idl">comparison</a> |
<a href="/comm-central/log/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/public/nsIMsgFolderListener.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/public/nsIMsgFolderNotificationService.idl">mailnews/base/public/nsIMsgFolderNotificationService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/public/nsIMsgFolderNotificationService.idl">file</a> |
<a href="/comm-central/annotate/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/public/nsIMsgFolderNotificationService.idl">annotate</a> |
<a href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/public/nsIMsgFolderNotificationService.idl">diff</a> |
<a href="/comm-central/comparison/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/public/nsIMsgFolderNotificationService.idl">comparison</a> |
<a href="/comm-central/log/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/public/nsIMsgFolderNotificationService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/src/nsMsgFolderNotificationService.cpp">mailnews/base/src/nsMsgFolderNotificationService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/src/nsMsgFolderNotificationService.cpp">file</a> |
<a href="/comm-central/annotate/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/src/nsMsgFolderNotificationService.cpp">annotate</a> |
<a href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/src/nsMsgFolderNotificationService.cpp">diff</a> |
<a href="/comm-central/comparison/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/src/nsMsgFolderNotificationService.cpp">comparison</a> |
<a href="/comm-central/log/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/src/nsMsgFolderNotificationService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/test/unit/test_nsIMsgFolderListener.js">mailnews/base/test/unit/test_nsIMsgFolderListener.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/test/unit/test_nsIMsgFolderListener.js">file</a> |
<a href="/comm-central/annotate/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/test/unit/test_nsIMsgFolderListener.js">annotate</a> |
<a href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/test/unit/test_nsIMsgFolderListener.js">diff</a> |
<a href="/comm-central/comparison/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/test/unit/test_nsIMsgFolderListener.js">comparison</a> |
<a href="/comm-central/log/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/base/test/unit/test_nsIMsgFolderListener.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/db/gloda/modules/IndexMsg.jsm">mailnews/db/gloda/modules/IndexMsg.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/db/gloda/modules/IndexMsg.jsm">file</a> |
<a href="/comm-central/annotate/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/db/gloda/modules/IndexMsg.jsm">annotate</a> |
<a href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/db/gloda/modules/IndexMsg.jsm">diff</a> |
<a href="/comm-central/comparison/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/db/gloda/modules/IndexMsg.jsm">comparison</a> |
<a href="/comm-central/log/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/db/gloda/modules/IndexMsg.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsLocalUndoTxn.cpp">mailnews/local/src/nsLocalUndoTxn.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsLocalUndoTxn.cpp">file</a> |
<a href="/comm-central/annotate/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsLocalUndoTxn.cpp">annotate</a> |
<a href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsLocalUndoTxn.cpp">diff</a> |
<a href="/comm-central/comparison/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsLocalUndoTxn.cpp">comparison</a> |
<a href="/comm-central/log/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsLocalUndoTxn.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsMsgMaildirStore.cpp">mailnews/local/src/nsMsgMaildirStore.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsMsgMaildirStore.cpp">file</a> |
<a href="/comm-central/annotate/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsMsgMaildirStore.cpp">annotate</a> |
<a href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsMsgMaildirStore.cpp">diff</a> |
<a href="/comm-central/comparison/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsMsgMaildirStore.cpp">comparison</a> |
<a href="/comm-central/log/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsMsgMaildirStore.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsRssIncomingServer.cpp">mailnews/local/src/nsRssIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsRssIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsRssIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsRssIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsRssIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/local/src/nsRssIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/test/resources/folderEventLogHelper.js">mailnews/test/resources/folderEventLogHelper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/test/resources/folderEventLogHelper.js">file</a> |
<a href="/comm-central/annotate/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/test/resources/folderEventLogHelper.js">annotate</a> |
<a href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/test/resources/folderEventLogHelper.js">diff</a> |
<a href="/comm-central/comparison/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/test/resources/folderEventLogHelper.js">comparison</a> |
<a href="/comm-central/log/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/test/resources/folderEventLogHelper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/test/resources/msgFolderListenerSetup.js">mailnews/test/resources/msgFolderListenerSetup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/test/resources/msgFolderListenerSetup.js">file</a> |
<a href="/comm-central/annotate/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/test/resources/msgFolderListenerSetup.js">annotate</a> |
<a href="/comm-central/diff/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/test/resources/msgFolderListenerSetup.js">diff</a> |
<a href="/comm-central/comparison/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/test/resources/msgFolderListenerSetup.js">comparison</a> |
<a href="/comm-central/log/1f1357f245c172afa95cc491fb3b2f14d8fb067c/mailnews/test/resources/msgFolderListenerSetup.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/activity/modules/moveCopy.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/activity/modules/moveCopy.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -114,17 +114,17 @@ var moveCopyModule = {</span>
<a href="#l1.4"></a><span id="l1.4">       this.log.info(&quot;in msgsMoveCopyCompleted&quot;);</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">       let count = aSrcMsgList.length;</span>
<a href="#l1.7"></a><span id="l1.7">       if (count &lt;= 0) {</span>
<a href="#l1.8"></a><span id="l1.8">         return;</span>
<a href="#l1.9"></a><span id="l1.9">       }</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">       // get the folder of the moved/copied messages</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-      let folder = aSrcMsgList.queryElementAt(0, Ci.nsIMsgDBHdr).folder;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+      let folder = aSrcMsgList[0].folder;</span>
<a href="#l1.14"></a><span id="l1.14">       this.log.info(&quot;got folder&quot;);</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">       let displayCount = count;</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18">       let activities = this.activityMgr.getActivities();</span>
<a href="#l1.19"></a><span id="l1.19">       if (</span>
<a href="#l1.20"></a><span id="l1.20">         activities.length &gt; 0 &amp;&amp;</span>
<a href="#l1.21"></a><span id="l1.21">         activities[activities.length - 1].id == this.lastMessage.id &amp;&amp;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -172,18 +172,17 @@ var moveCopyModule = {</span>
<a href="#l1.23"></a><span id="l1.23">         folder,</span>
<a href="#l1.24"></a><span id="l1.24">         statusText,</span>
<a href="#l1.25"></a><span id="l1.25">         Date.now(), // start time</span>
<a href="#l1.26"></a><span id="l1.26">         Date.now()</span>
<a href="#l1.27"></a><span id="l1.27">       ); // completion time</span>
<a href="#l1.28"></a><span id="l1.28">       event.iconClass = aMove ? &quot;moveMail&quot; : &quot;copyMail&quot;;</span>
<a href="#l1.29"></a><span id="l1.29">       this.lastMessage.type = event.iconClass;</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-      for (let i = 0; i &lt; count; i++) {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-        let msgHdr = aSrcMsgList.queryElementAt(i, Ci.nsIMsgDBHdr);</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+      for (let msgHdr of aSrcMsgList) {</span>
<a href="#l1.34"></a><span id="l1.34">         event.addSubject(msgHdr.messageId);</span>
<a href="#l1.35"></a><span id="l1.35">       }</span>
<a href="#l1.36"></a><span id="l1.36">       this.lastMessage.id = this.activityMgr.addActivity(event);</span>
<a href="#l1.37"></a><span id="l1.37">     } catch (e) {</span>
<a href="#l1.38"></a><span id="l1.38">       this.log.error(&quot;Exception: &quot; + e);</span>
<a href="#l1.39"></a><span id="l1.39">     }</span>
<a href="#l1.40"></a><span id="l1.40">   },</span>
<a href="#l1.41"></a><span id="l1.41"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/search/SearchIntegration.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/search/SearchIntegration.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -617,19 +617,17 @@ var SearchSupport = {</span>
<a href="#l2.4"></a><span id="l2.4">       SearchIntegration._log.info(&quot;in msgsMoveCopyCompleted, aMove = &quot; + aMove);</span>
<a href="#l2.5"></a><span id="l2.5">       // Forget about copies if disabled</span>
<a href="#l2.6"></a><span id="l2.6">       if (!aMove &amp;&amp; !this.enabled) {</span>
<a href="#l2.7"></a><span id="l2.7">         return;</span>
<a href="#l2.8"></a><span id="l2.8">       }</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10">       let count = aSrcMsgs.length;</span>
<a href="#l2.11"></a><span id="l2.11">       for (let i = 0; i &lt; count; i++) {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-        let srcFile = SearchIntegration._getSupportFile(</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-          aSrcMsgs.queryElementAt(i, Ci.nsIMsgDBHdr)</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-        );</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+        let srcFile = SearchIntegration._getSupportFile(aSrcMsgs[i]);</span>
<a href="#l2.16"></a><span id="l2.16">         if (srcFile &amp;&amp; srcFile.exists()) {</span>
<a href="#l2.17"></a><span id="l2.17">           let destFile = SearchIntegration._getSearchPathForFolder(aDestFolder);</span>
<a href="#l2.18"></a><span id="l2.18">           destFile.leafName = destFile.leafName + &quot;.mozmsgs&quot;;</span>
<a href="#l2.19"></a><span id="l2.19">           if (!destFile.exists()) {</span>
<a href="#l2.20"></a><span id="l2.20">             try {</span>
<a href="#l2.21"></a><span id="l2.21">               // create the directory, if it doesn't exist</span>
<a href="#l2.22"></a><span id="l2.22">               destFile.create(Ci.nsIFile.DIRECTORY_TYPE, PERM_DIRECTORY);</span>
<a href="#l2.23"></a><span id="l2.23">             } catch (ex) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolderListener.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolderListener.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -100,19 +100,19 @@ interface nsIMsgFolderListener : nsISupp</span>
<a href="#l3.4"></a><span id="l3.4">                       not user-initiated), then aDestMsgs will be null.</span>
<a href="#l3.5"></a><span id="l3.5">    *</span>
<a href="#l3.6"></a><span id="l3.6">    * @note</span>
<a href="#l3.7"></a><span id="l3.7">    * If messages are moved from a server which uses the IMAP delete model,</span>
<a href="#l3.8"></a><span id="l3.8">    * you'll get aMove = false. That's because the messages are not deleted from</span>
<a href="#l3.9"></a><span id="l3.9">    * the source database, but instead simply marked deleted.</span>
<a href="#l3.10"></a><span id="l3.10">    */</span>
<a href="#l3.11"></a><span id="l3.11">   void msgsMoveCopyCompleted(in boolean aMove,</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-                             in nsIArray aSrcMsgs,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+                             in Array&lt;nsIMsgDBHdr&gt; aSrcMsgs,</span>
<a href="#l3.14"></a><span id="l3.14">                              in nsIMsgFolder aDestFolder,</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-                             in nsIArray aDestMsgs);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+                             in Array&lt;nsIMsgDBHdr&gt; aDestMsgs);</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18">   /**</span>
<a href="#l3.19"></a><span id="l3.19">    * Notification sent when the msg key for a header may have changed.</span>
<a href="#l3.20"></a><span id="l3.20">    * This is used when we create a header for an offline imap move result,</span>
<a href="#l3.21"></a><span id="l3.21">    * without knowing what the ultimate UID will be. When we download the</span>
<a href="#l3.22"></a><span id="l3.22">    * headers for the new message, we replace the old &quot;pseudo&quot; header with</span>
<a href="#l3.23"></a><span id="l3.23">    * a new header that has the correct UID/message key. The uid of the new hdr</span>
<a href="#l3.24"></a><span id="l3.24">    * may turn out to be the same as aOldKey if we've guessed correctly but</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolderNotificationService.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolderNotificationService.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -3,17 +3,16 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.5"></a><span id="l4.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;MailNewsTypes2.idl&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> interface nsIMsgDBHdr;</span>
<a href="#l4.10"></a><span id="l4.10"> interface nsIMsgFolder;</span>
<a href="#l4.11"></a><span id="l4.11"> interface nsIMsgFolderListener;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-interface nsIArray;</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14"> typedef unsigned long msgFolderListenerFlag;</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16"> [scriptable, uuid(e54a592c-2f23-4771-9670-bdb9d4f5dbbd)]</span>
<a href="#l4.17"></a><span id="l4.17"> interface nsIMsgFolderNotificationService : nsISupports {</span>
<a href="#l4.18"></a><span id="l4.18">   /**</span>
<a href="#l4.19"></a><span id="l4.19">    * @name Notification flags</span>
<a href="#l4.20"></a><span id="l4.20">    * These flags determine which notifications will be sent.</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -59,19 +58,19 @@ interface nsIMsgFolderNotificationServic</span>
<a href="#l4.22"></a><span id="l4.22">   // message-specific functions</span>
<a href="#l4.23"></a><span id="l4.23">   // single message for added, array for delete/move/copy</span>
<a href="#l4.24"></a><span id="l4.24">   void notifyMsgAdded(in nsIMsgDBHdr aMsg);</span>
<a href="#l4.25"></a><span id="l4.25">   void notifyMsgsClassified(in Array&lt;nsIMsgDBHdr&gt; aMsgs,</span>
<a href="#l4.26"></a><span id="l4.26">                             in boolean aJunkProcessed,</span>
<a href="#l4.27"></a><span id="l4.27">                             in boolean aTraitProcessed);</span>
<a href="#l4.28"></a><span id="l4.28">   void notifyMsgsDeleted(in Array&lt;nsIMsgDBHdr&gt; aMsgs);</span>
<a href="#l4.29"></a><span id="l4.29">   void notifyMsgsMoveCopyCompleted(in boolean aMove,</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-                                   in nsIArray aSrcMsgs,</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+                                   in Array&lt;nsIMsgDBHdr&gt; aSrcMsgs,</span>
<a href="#l4.32"></a><span id="l4.32">                                    in nsIMsgFolder aDestFolder,</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-                                   in nsIArray aDestMsgs);</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+                                   in Array&lt;nsIMsgDBHdr&gt; aDestMsgs);</span>
<a href="#l4.35"></a><span id="l4.35"> </span>
<a href="#l4.36"></a><span id="l4.36">   /**</span>
<a href="#l4.37"></a><span id="l4.37">    * Notify listeners that the msg key for a header has changed. Currently,</span>
<a href="#l4.38"></a><span id="l4.38">    * this is used when we create a header for an offline imap move result,</span>
<a href="#l4.39"></a><span id="l4.39">    * without knowing what the ultimate UID will be. When we download the</span>
<a href="#l4.40"></a><span id="l4.40">    * headers for the new message, we replace the old &quot;pseudo&quot; header with</span>
<a href="#l4.41"></a><span id="l4.41">    * a new header that has the correct UID/message key, by cloning the pseudo</span>
<a href="#l4.42"></a><span id="l4.42">    * header, which maintains all the existing header attributes.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderNotificationService.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderNotificationService.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -73,31 +73,28 @@ NS_IMETHODIMP nsMsgFolderNotificationSer</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> NS_IMETHODIMP nsMsgFolderNotificationService::NotifyMsgsDeleted(</span>
<a href="#l5.6"></a><span id="l5.6">     const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aMsgs) {</span>
<a href="#l5.7"></a><span id="l5.7">   NOTIFY_MSGFOLDER_LISTENERS(msgsDeleted, MsgsDeleted, (aMsgs));</span>
<a href="#l5.8"></a><span id="l5.8">   return NS_OK;</span>
<a href="#l5.9"></a><span id="l5.9"> }</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> NS_IMETHODIMP nsMsgFolderNotificationService::NotifyMsgsMoveCopyCompleted(</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    bool aMove, nsIArray *aSrcMsgs, nsIMsgFolder *aDestFolder,</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-    nsIArray *aDestMsgs) {</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+    bool aMove, const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aSrcMsgs,</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+    nsIMsgFolder *aDestFolder, const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aDestMsgs) {</span>
<a href="#l5.16"></a><span id="l5.16">   uint32_t count = mListeners.Length();</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18">   // IMAP delete model means that a &quot;move&quot; isn't really a move, it is a copy,</span>
<a href="#l5.19"></a><span id="l5.19">   // followed by storing the IMAP deleted flag on the message.</span>
<a href="#l5.20"></a><span id="l5.20">   bool isReallyMove = aMove;</span>
<a href="#l5.21"></a><span id="l5.21">   if (count &gt; 0 &amp;&amp; aMove) {</span>
<a href="#l5.22"></a><span id="l5.22">     nsresult rv;</span>
<a href="#l5.23"></a><span id="l5.23">     // Assume that all the source messages are from the same server.</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBHdr&gt; message(do_QueryElementAt(aSrcMsgs, 0, &amp;rv));</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-</span>
<a href="#l5.27"></a><span id="l5.27">     nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-    rv = message-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+    rv = aSrcMsgs[0]-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l5.30"></a><span id="l5.30">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.31"></a><span id="l5.31"> </span>
<a href="#l5.32"></a><span id="l5.32">     nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder(do_QueryInterface(msgFolder));</span>
<a href="#l5.33"></a><span id="l5.33">     if (imapFolder) {</span>
<a href="#l5.34"></a><span id="l5.34">       nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer;</span>
<a href="#l5.35"></a><span id="l5.35">       imapFolder-&gt;GetImapIncomingServer(getter_AddRefs(imapServer));</span>
<a href="#l5.36"></a><span id="l5.36">       if (imapServer) {</span>
<a href="#l5.37"></a><span id="l5.37">         nsMsgImapDeleteModel deleteModel;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsIMsgFolderListener.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsIMsgFolderListener.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -114,17 +114,17 @@ gMFListener.prototype = {</span>
<a href="#l6.4"></a><span id="l6.4">     }</span>
<a href="#l6.5"></a><span id="l6.5">   },</span>
<a href="#l6.6"></a><span id="l6.6"> };</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> function NotifyMsgFolderListeners() {</span>
<a href="#l6.9"></a><span id="l6.9">   MailServices.mfn.notifyMsgAdded(null);</span>
<a href="#l6.10"></a><span id="l6.10">   MailServices.mfn.notifyMsgsClassified([], null, null);</span>
<a href="#l6.11"></a><span id="l6.11">   MailServices.mfn.notifyMsgsDeleted([]);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  MailServices.mfn.notifyMsgsMoveCopyCompleted(null, null, null, null);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  MailServices.mfn.notifyMsgsMoveCopyCompleted(null, [], null, []);</span>
<a href="#l6.14"></a><span id="l6.14">   MailServices.mfn.notifyMsgKeyChanged(null, null);</span>
<a href="#l6.15"></a><span id="l6.15">   MailServices.mfn.notifyFolderAdded(null);</span>
<a href="#l6.16"></a><span id="l6.16">   MailServices.mfn.notifyFolderDeleted(null);</span>
<a href="#l6.17"></a><span id="l6.17">   MailServices.mfn.notifyFolderMoveCopyCompleted(null, null, null);</span>
<a href="#l6.18"></a><span id="l6.18">   MailServices.mfn.notifyFolderRenamed(null, null);</span>
<a href="#l6.19"></a><span id="l6.19">   MailServices.mfn.notifyItemEvent(null, null, null, null);</span>
<a href="#l6.20"></a><span id="l6.20"> }</span>
<a href="#l6.21"></a><span id="l6.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/db/gloda/modules/IndexMsg.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/IndexMsg.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -2420,56 +2420,50 @@ var GlodaMsgIndexer = {</span>
<a href="#l7.4"></a><span id="l7.4">       this.indexer._log.debug(&quot;MoveCopy notification.  Move: &quot; + aMove);</span>
<a href="#l7.5"></a><span id="l7.5">       try {</span>
<a href="#l7.6"></a><span id="l7.6">         // ---- Move</span>
<a href="#l7.7"></a><span id="l7.7">         if (aMove) {</span>
<a href="#l7.8"></a><span id="l7.8">           // -- Effectively a deletion?</span>
<a href="#l7.9"></a><span id="l7.9">           // If the destination folder is not indexed, it's like these messages</span>
<a href="#l7.10"></a><span id="l7.10">           //  are being deleted.</span>
<a href="#l7.11"></a><span id="l7.11">           if (!GlodaMsgIndexer.shouldIndexFolder(aDestFolder)) {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-            this.msgsDeleted([...fixIterator(aSrcMsgHdrs, Ci.nsIMsgDBHdr)]);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+            this.msgsDeleted(aSrcMsgHdrs);</span>
<a href="#l7.14"></a><span id="l7.14">             return;</span>
<a href="#l7.15"></a><span id="l7.15">           }</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17">           // -- Avoid propagation of filthy gloda-id's.</span>
<a href="#l7.18"></a><span id="l7.18">           // If the source folder is filthy or should not be indexed (and so</span>
<a href="#l7.19"></a><span id="l7.19">           //  any gloda-id's found in there are gibberish), our only job is to</span>
<a href="#l7.20"></a><span id="l7.20">           //  strip the gloda-id's off of all the destination headers because</span>
<a href="#l7.21"></a><span id="l7.21">           //  none of the gloda-id's are valid (and so we certainly don't want</span>
<a href="#l7.22"></a><span id="l7.22">           //  to try and use them as a basis for updating message keys.)</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-          let srcMsgFolder = aSrcMsgHdrs.queryElementAt(0, Ci.nsIMsgDBHdr)</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-            .folder;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+          let srcMsgFolder = aSrcMsgHdrs[0].folder;</span>
<a href="#l7.26"></a><span id="l7.26">           if (</span>
<a href="#l7.27"></a><span id="l7.27">             !this.indexer.shouldIndexFolder(srcMsgFolder) ||</span>
<a href="#l7.28"></a><span id="l7.28">             GlodaDatastore._mapFolder(srcMsgFolder).dirtyStatus ==</span>
<a href="#l7.29"></a><span id="l7.29">               GlodaFolder.prototype.kFolderFilthy</span>
<a href="#l7.30"></a><span id="l7.30">           ) {</span>
<a href="#l7.31"></a><span id="l7.31">             // Local case, just modify the destination headers directly.</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-            if (aDestMsgHdrs) {</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-              for (let destMsgHdr of fixIterator(</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-                aDestMsgHdrs,</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-                Ci.nsIMsgDBHdr</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-              )) {</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+            if (aDestMsgHdrs.length &gt; 0) {</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+              for (let destMsgHdr of aDestMsgHdrs) {</span>
<a href="#l7.39"></a><span id="l7.39">                 // zero it out if it exists</span>
<a href="#l7.40"></a><span id="l7.40">                 // (no need to deal with pending commit issues here; a filthy</span>
<a href="#l7.41"></a><span id="l7.41">                 //  folder by definition has nothing indexed in it.)</span>
<a href="#l7.42"></a><span id="l7.42">                 let glodaId = destMsgHdr.getUint32Property(</span>
<a href="#l7.43"></a><span id="l7.43">                   GLODA_MESSAGE_ID_PROPERTY</span>
<a href="#l7.44"></a><span id="l7.44">                 );</span>
<a href="#l7.45"></a><span id="l7.45">                 if (glodaId) {</span>
<a href="#l7.46"></a><span id="l7.46">                   destMsgHdr.setUint32Property(GLODA_MESSAGE_ID_PROPERTY, 0);</span>
<a href="#l7.47"></a><span id="l7.47">                 }</span>
<a href="#l7.48"></a><span id="l7.48">               }</span>
<a href="#l7.49"></a><span id="l7.49"> </span>
<a href="#l7.50"></a><span id="l7.50">               // Since we are moving messages from a folder where they were</span>
<a href="#l7.51"></a><span id="l7.51">               //  effectively not indexed, it is up to us to make sure the</span>
<a href="#l7.52"></a><span id="l7.52">               //  messages now get indexed.</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-              this.indexer._reindexChangedMessages(</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-                fixIterator(aDestMsgHdrs, Ci.nsIMsgDBHdr)</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-              );</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+              this.indexer._reindexChangedMessages(aDestMsgHdrs);</span>
<a href="#l7.57"></a><span id="l7.57">               return;</span>
<a href="#l7.58"></a><span id="l7.58">             }</span>
<a href="#l7.59"></a><span id="l7.59"> </span>
<a href="#l7.60"></a><span id="l7.60">             // IMAP move case, we need to operate on the pending headers using</span>
<a href="#l7.61"></a><span id="l7.61">             //  the source header to get the pending header and as the</span>
<a href="#l7.62"></a><span id="l7.62">             //  indication of what has been already set on the pending header.</span>
<a href="#l7.63"></a><span id="l7.63">             let destDb;</span>
<a href="#l7.64"></a><span id="l7.64">             // so, this can fail, and there's not much we can do about it.</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineat">@@ -2479,17 +2473,17 @@ var GlodaMsgIndexer = {</span>
<a href="#l7.66"></a><span id="l7.66">               this.indexer._log.warn(</span>
<a href="#l7.67"></a><span id="l7.67">                 &quot;Destination database for &quot; +</span>
<a href="#l7.68"></a><span id="l7.68">                   aDestFolder.prettyName +</span>
<a href="#l7.69"></a><span id="l7.69">                   &quot; not ready on IMAP move.&quot; +</span>
<a href="#l7.70"></a><span id="l7.70">                   &quot; Gloda corruption possible.&quot;</span>
<a href="#l7.71"></a><span id="l7.71">               );</span>
<a href="#l7.72"></a><span id="l7.72">               return;</span>
<a href="#l7.73"></a><span id="l7.73">             }</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-            for (let srcMsgHdr of fixIterator(aSrcMsgHdrs, Ci.nsIMsgDBHdr)) {</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+            for (let srcMsgHdr of aSrcMsgHdrs) {</span>
<a href="#l7.76"></a><span id="l7.76">               // zero it out if it exists</span>
<a href="#l7.77"></a><span id="l7.77">               // (no need to deal with pending commit issues here; a filthy</span>
<a href="#l7.78"></a><span id="l7.78">               //  folder by definition has nothing indexed in it.)</span>
<a href="#l7.79"></a><span id="l7.79">               let glodaId = srcMsgHdr.getUint32Property(</span>
<a href="#l7.80"></a><span id="l7.80">                 GLODA_MESSAGE_ID_PROPERTY</span>
<a href="#l7.81"></a><span id="l7.81">               );</span>
<a href="#l7.82"></a><span id="l7.82">               if (glodaId) {</span>
<a href="#l7.83"></a><span id="l7.83">                 destDb.setUint32AttributeOnPendingHdr(</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineat">@@ -2501,32 +2495,27 @@ var GlodaMsgIndexer = {</span>
<a href="#l7.85"></a><span id="l7.85">             }</span>
<a href="#l7.86"></a><span id="l7.86"> </span>
<a href="#l7.87"></a><span id="l7.87">             // Nothing remains to be done.  The msgClassified event will take</span>
<a href="#l7.88"></a><span id="l7.88">             //  care of making sure the message gets indexed.</span>
<a href="#l7.89"></a><span id="l7.89">             return;</span>
<a href="#l7.90"></a><span id="l7.90">           }</span>
<a href="#l7.91"></a><span id="l7.91"> </span>
<a href="#l7.92"></a><span id="l7.92">           // --- Have destination headers (local case):</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-          if (aDestMsgHdrs) {</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+          if (aDestMsgHdrs.length &gt; 0) {</span>
<a href="#l7.95"></a><span id="l7.95">             // -- Update message keys for valid gloda-id's.</span>
<a href="#l7.96"></a><span id="l7.96">             // (Which means ignore filthy gloda-id's.)</span>
<a href="#l7.97"></a><span id="l7.97">             let glodaIds = [];</span>
<a href="#l7.98"></a><span id="l7.98">             let newMessageKeys = [];</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-            aSrcMsgHdrs.QueryInterface(Ci.nsIArray);</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-            aDestMsgHdrs.QueryInterface(Ci.nsIArray);</span>
<a href="#l7.101"></a><span id="l7.101">             // Track whether we see any messages that are not gloda indexed so</span>
<a href="#l7.102"></a><span id="l7.102">             //  we know if we have to mark the destination folder dirty.</span>
<a href="#l7.103"></a><span id="l7.103">             let sawNonGlodaMessage = false;</span>
<a href="#l7.104"></a><span id="l7.104">             for (let iMsg = 0; iMsg &lt; aSrcMsgHdrs.length; iMsg++) {</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-              let srcMsgHdr = aSrcMsgHdrs.queryElementAt(iMsg, Ci.nsIMsgDBHdr);</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-              let destMsgHdr = aDestMsgHdrs.queryElementAt(</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-                iMsg,</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-                Ci.nsIMsgDBHdr</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-              );</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+              let srcMsgHdr = aSrcMsgHdrs[iMsg];</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+              let destMsgHdr = aDestMsgHdrs[iMsg];</span>
<a href="#l7.112"></a><span id="l7.112"> </span>
<a href="#l7.113"></a><span id="l7.113">               let [glodaId, dirtyStatus] = PendingCommitTracker.getGlodaState(</span>
<a href="#l7.114"></a><span id="l7.114">                 srcMsgHdr</span>
<a href="#l7.115"></a><span id="l7.115">               );</span>
<a href="#l7.116"></a><span id="l7.116">               if (</span>
<a href="#l7.117"></a><span id="l7.117">                 glodaId &gt;= GLODA_FIRST_VALID_MESSAGE_ID &amp;&amp;</span>
<a href="#l7.118"></a><span id="l7.118">                 dirtyStatus != GlodaMsgIndexer.kMessageFilthy</span>
<a href="#l7.119"></a><span id="l7.119">               ) {</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineat">@@ -2561,19 +2550,17 @@ var GlodaMsgIndexer = {</span>
<a href="#l7.121"></a><span id="l7.121">             // --- No dest headers (IMAP case):</span>
<a href="#l7.122"></a><span id="l7.122">             // Update any valid gloda indexed messages into their new folder to</span>
<a href="#l7.123"></a><span id="l7.123">             //  make the indexer's life easier when it sees the messages in their</span>
<a href="#l7.124"></a><span id="l7.124">             //  new folder.</span>
<a href="#l7.125"></a><span id="l7.125">             let glodaIds = [];</span>
<a href="#l7.126"></a><span id="l7.126"> </span>
<a href="#l7.127"></a><span id="l7.127">             let srcFolderIsLocal =</span>
<a href="#l7.128"></a><span id="l7.128">               srcMsgFolder instanceof Ci.nsIMsgLocalMailFolder;</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-            for (let iMsgHdr = 0; iMsgHdr &lt; aSrcMsgHdrs.length; iMsgHdr++) {</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-              let msgHdr = aSrcMsgHdrs.queryElementAt(iMsgHdr, Ci.nsIMsgDBHdr);</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+            for (let msgHdr of aSrcMsgHdrs) {</span>
<a href="#l7.133"></a><span id="l7.133">               let [glodaId, dirtyStatus] = PendingCommitTracker.getGlodaState(</span>
<a href="#l7.134"></a><span id="l7.134">                 msgHdr</span>
<a href="#l7.135"></a><span id="l7.135">               );</span>
<a href="#l7.136"></a><span id="l7.136">               if (</span>
<a href="#l7.137"></a><span id="l7.137">                 glodaId &gt;= GLODA_FIRST_VALID_MESSAGE_ID &amp;&amp;</span>
<a href="#l7.138"></a><span id="l7.138">                 dirtyStatus != GlodaMsgIndexer.kMessageFilthy</span>
<a href="#l7.139"></a><span id="l7.139">               ) {</span>
<a href="#l7.140"></a><span id="l7.140">                 // we may need to update the pending commit map (it checks)</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineat">@@ -2610,24 +2597,22 @@ var GlodaMsgIndexer = {</span>
<a href="#l7.142"></a><span id="l7.142">             );</span>
<a href="#l7.143"></a><span id="l7.143">             // we _do not_ need to mark the folder as dirty, because the</span>
<a href="#l7.144"></a><span id="l7.144">             //  message added events will cause that to happen.</span>
<a href="#l7.145"></a><span id="l7.145">           }</span>
<a href="#l7.146"></a><span id="l7.146">         } else {</span>
<a href="#l7.147"></a><span id="l7.147">           // ---- Copy case</span>
<a href="#l7.148"></a><span id="l7.148">           // -- Do not propagate gloda-id's for copies</span>
<a href="#l7.149"></a><span id="l7.149">           // (Only applies if we have the destination header, which means local)</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-          if (aDestMsgHdrs) {</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-            for (let destMsgHdr of fixIterator(aDestMsgHdrs, Ci.nsIMsgDBHdr)) {</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-              let glodaId = destMsgHdr.getUint32Property(</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-                GLODA_MESSAGE_ID_PROPERTY</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-              );</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-              if (glodaId) {</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-                destMsgHdr.setUint32Property(GLODA_MESSAGE_ID_PROPERTY, 0);</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-              }</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+          for (let destMsgHdr of aDestMsgHdrs) {</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+            let glodaId = destMsgHdr.getUint32Property(</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+              GLODA_MESSAGE_ID_PROPERTY</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+            );</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+            if (glodaId) {</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+              destMsgHdr.setUint32Property(GLODA_MESSAGE_ID_PROPERTY, 0);</span>
<a href="#l7.164"></a><span id="l7.164">             }</span>
<a href="#l7.165"></a><span id="l7.165">           }</span>
<a href="#l7.166"></a><span id="l7.166"> </span>
<a href="#l7.167"></a><span id="l7.167">           // mark the folder as dirty; we'll get to it later.</span>
<a href="#l7.168"></a><span id="l7.168">           let destGlodaFolder = GlodaDatastore._mapFolder(aDestFolder);</span>
<a href="#l7.169"></a><span id="l7.169">           destGlodaFolder._ensureFolderDirty();</span>
<a href="#l7.170"></a><span id="l7.170">           this.indexer.indexingSweepNeeded = true;</span>
<a href="#l7.171"></a><span id="l7.171">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -4933,23 +4933,25 @@ nsImapMailFolder::OnStopRunningUrl(nsIUR</span>
<a href="#l8.4"></a><span id="l8.4">       }</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6">       // Notify move, copy or delete (online operations)</span>
<a href="#l8.7"></a><span id="l8.7">       // Not sure whether nsImapDeleteMsg is even used, deletes in all three</span>
<a href="#l8.8"></a><span id="l8.8">       // models use nsImapAddMsgFlags.</span>
<a href="#l8.9"></a><span id="l8.9">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l8.10"></a><span id="l8.10">           do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l8.11"></a><span id="l8.11">       if (notifier &amp;&amp; m_copyState) {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-        if (imapAction == nsIImapUrl::nsImapOnlineMove)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-          notifier-&gt;NotifyMsgsMoveCopyCompleted(true, m_copyState-&gt;m_messages,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-                                                this, nullptr);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-        else if (imapAction == nsIImapUrl::nsImapOnlineCopy)</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-          notifier-&gt;NotifyMsgsMoveCopyCompleted(false, m_copyState-&gt;m_messages,</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-                                                this, nullptr);</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-        else if (imapAction == nsIImapUrl::nsImapDeleteMsg) {</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+        if (imapAction == nsIImapUrl::nsImapOnlineMove) {</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+          nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; hdrs;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+          MsgHdrsToTArray(m_copyState-&gt;m_messages, hdrs);</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+          notifier-&gt;NotifyMsgsMoveCopyCompleted(true, hdrs, this, {});</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+        } else if (imapAction == nsIImapUrl::nsImapOnlineCopy) {</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+          nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; hdrs;</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+          MsgHdrsToTArray(m_copyState-&gt;m_messages, hdrs);</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+          notifier-&gt;NotifyMsgsMoveCopyCompleted(false, hdrs, this, {});</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+        } else if (imapAction == nsIImapUrl::nsImapDeleteMsg) {</span>
<a href="#l8.28"></a><span id="l8.28">           // Stopgap. Build a parallel array of message headers while we</span>
<a href="#l8.29"></a><span id="l8.29">           // complete removal of nsIArray usage (Bug 1583030).</span>
<a href="#l8.30"></a><span id="l8.30">           uint32_t messageCount;</span>
<a href="#l8.31"></a><span id="l8.31">           m_copyState-&gt;m_messages-&gt;GetLength(&amp;messageCount);</span>
<a href="#l8.32"></a><span id="l8.32">           nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; msgHeaders;</span>
<a href="#l8.33"></a><span id="l8.33">           msgHeaders.SetCapacity(messageCount);</span>
<a href="#l8.34"></a><span id="l8.34">           for (uint32_t i = 0; i &lt; messageCount; ++i) {</span>
<a href="#l8.35"></a><span id="l8.35">             msgHeaders.AppendElement(</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineat">@@ -6270,19 +6272,22 @@ nsImapMailFolder::CopyNextStreamMessage(</span>
<a href="#l8.37"></a><span id="l8.37">     }</span>
<a href="#l8.38"></a><span id="l8.38">   } else {</span>
<a href="#l8.39"></a><span id="l8.39">     // Notify of move/copy completion in case we have some source headers</span>
<a href="#l8.40"></a><span id="l8.40">     nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l8.41"></a><span id="l8.41">         do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l8.42"></a><span id="l8.42">     if (notifier) {</span>
<a href="#l8.43"></a><span id="l8.43">       uint32_t numHdrs;</span>
<a href="#l8.44"></a><span id="l8.44">       mailCopyState-&gt;m_messages-&gt;GetLength(&amp;numHdrs);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-      if (numHdrs)</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-        notifier-&gt;NotifyMsgsMoveCopyCompleted(</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-            mailCopyState-&gt;m_isMove, mailCopyState-&gt;m_messages, this, nullptr);</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+      if (numHdrs) {</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+        nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; hdrs;</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+        MsgHdrsToTArray(mailCopyState-&gt;m_messages, hdrs);</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+        notifier-&gt;NotifyMsgsMoveCopyCompleted(mailCopyState-&gt;m_isMove, hdrs,</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+                                              this, {});</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+      }</span>
<a href="#l8.54"></a><span id="l8.54">     }</span>
<a href="#l8.55"></a><span id="l8.55">     if (mailCopyState-&gt;m_isMove) {</span>
<a href="#l8.56"></a><span id="l8.56">       nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder(</span>
<a href="#l8.57"></a><span id="l8.57">           do_QueryInterface(mailCopyState-&gt;m_srcSupport, &amp;rv));</span>
<a href="#l8.58"></a><span id="l8.58">       if (NS_SUCCEEDED(rv) &amp;&amp; srcFolder) {</span>
<a href="#l8.59"></a><span id="l8.59">         srcFolder-&gt;DeleteMessages(mailCopyState-&gt;m_messages, nullptr, true,</span>
<a href="#l8.60"></a><span id="l8.60">                                   true, nullptr, false);</span>
<a href="#l8.61"></a><span id="l8.61">         // we want to send this notification after the source messages have</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineat">@@ -6541,21 +6546,19 @@ nsresult nsImapMailFolder::CopyMessagesO</span>
<a href="#l8.63"></a><span id="l8.63">   srcFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(srcDbFolderInfo),</span>
<a href="#l8.64"></a><span id="l8.64">                                   getter_AddRefs(sourceMailDB));</span>
<a href="#l8.65"></a><span id="l8.65">   bool deleteToTrash = false;</span>
<a href="#l8.66"></a><span id="l8.66">   bool deleteImmediately = false;</span>
<a href="#l8.67"></a><span id="l8.67">   uint32_t srcCount;</span>
<a href="#l8.68"></a><span id="l8.68">   messages-&gt;GetLength(&amp;srcCount);</span>
<a href="#l8.69"></a><span id="l8.69">   nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer;</span>
<a href="#l8.70"></a><span id="l8.70">   rv = GetImapIncomingServer(getter_AddRefs(imapServer));</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; msgHdrsCopied(</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-      do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; destMsgHdrs(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-  if (!msgHdrsCopied || !destMsgHdrs) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+  nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; msgHdrsCopied;</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+  nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; destMsgHdrs;</span>
<a href="#l8.79"></a><span id="l8.79"> </span>
<a href="#l8.80"></a><span id="l8.80">   if (NS_SUCCEEDED(rv) &amp;&amp; imapServer) {</span>
<a href="#l8.81"></a><span id="l8.81">     nsMsgImapDeleteModel deleteModel;</span>
<a href="#l8.82"></a><span id="l8.82">     imapServer-&gt;GetDeleteModel(&amp;deleteModel);</span>
<a href="#l8.83"></a><span id="l8.83">     deleteToTrash = (deleteModel == nsMsgImapDeleteModels::MoveToTrash);</span>
<a href="#l8.84"></a><span id="l8.84">     deleteImmediately = (deleteModel == nsMsgImapDeleteModels::DeleteNoTrash);</span>
<a href="#l8.85"></a><span id="l8.85">   }</span>
<a href="#l8.86"></a><span id="l8.86"> </span>
<a href="#l8.87"></a><span id="l8.87" class="difflineat">@@ -6702,17 +6705,17 @@ nsresult nsImapMailFolder::CopyMessagesO</span>
<a href="#l8.88"></a><span id="l8.88">           if (!newMailHdr || NS_FAILED(rv)) {</span>
<a href="#l8.89"></a><span id="l8.89">             NS_ASSERTION(false, &quot;failed to copy hdr&quot;);</span>
<a href="#l8.90"></a><span id="l8.90">             stopit = rv;</span>
<a href="#l8.91"></a><span id="l8.91">           }</span>
<a href="#l8.92"></a><span id="l8.92"> </span>
<a href="#l8.93"></a><span id="l8.93">           if (NS_SUCCEEDED(stopit)) {</span>
<a href="#l8.94"></a><span id="l8.94">             bool hasMsgOffline = false;</span>
<a href="#l8.95"></a><span id="l8.95"> </span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-            destMsgHdrs-&gt;AppendElement(newMailHdr);</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+            destMsgHdrs.AppendElement(newMailHdr);</span>
<a href="#l8.98"></a><span id="l8.98">             srcFolder-&gt;HasMsgOffline(originalKey, &amp;hasMsgOffline);</span>
<a href="#l8.99"></a><span id="l8.99">             newMailHdr-&gt;SetUint32Property(&quot;pseudoHdr&quot;, 1);</span>
<a href="#l8.100"></a><span id="l8.100">             if (!reusable)</span>
<a href="#l8.101"></a><span id="l8.101">               (void)srcFolder-&gt;GetMsgInputStream(newMailHdr, &amp;reusable,</span>
<a href="#l8.102"></a><span id="l8.102">                                                  getter_AddRefs(inputStream));</span>
<a href="#l8.103"></a><span id="l8.103"> </span>
<a href="#l8.104"></a><span id="l8.104">             if (inputStream &amp;&amp; hasMsgOffline &amp;&amp; !isLocked) {</span>
<a href="#l8.105"></a><span id="l8.105">               rv = GetOfflineStoreOutputStream(newMailHdr,</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineat">@@ -6753,17 +6756,17 @@ nsresult nsImapMailFolder::CopyMessagesO</span>
<a href="#l8.107"></a><span id="l8.107">             if (deleteToTrash || deleteImmediately)</span>
<a href="#l8.108"></a><span id="l8.108">               keysToDelete.AppendElement(msgKey);</span>
<a href="#l8.109"></a><span id="l8.109">             else</span>
<a href="#l8.110"></a><span id="l8.110">               sourceMailDB-&gt;MarkImapDeleted(msgKey, true,</span>
<a href="#l8.111"></a><span id="l8.111">                                             nullptr);  // offline delete</span>
<a href="#l8.112"></a><span id="l8.112">           }</span>
<a href="#l8.113"></a><span id="l8.113">           if (successfulCopy)</span>
<a href="#l8.114"></a><span id="l8.114">             // This is for both moves and copies</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineminus">-            msgHdrsCopied-&gt;AppendElement(mailHdr);</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+            msgHdrsCopied.AppendElement(mailHdr);</span>
<a href="#l8.117"></a><span id="l8.117">         }</span>
<a href="#l8.118"></a><span id="l8.118">       }</span>
<a href="#l8.119"></a><span id="l8.119">       EnableNotifications(nsIMsgFolder::allMessageCountNotifications, true);</span>
<a href="#l8.120"></a><span id="l8.120">       RefPtr&lt;nsImapOfflineTxn&gt; addHdrMsgTxn = new nsImapOfflineTxn(</span>
<a href="#l8.121"></a><span id="l8.121">           this, &amp;addedKeys, nullptr, this, isMove,</span>
<a href="#l8.122"></a><span id="l8.122">           nsIMsgOfflineImapOperation::kAddedHeader, addedHdrs);</span>
<a href="#l8.123"></a><span id="l8.123">       if (addHdrMsgTxn &amp;&amp; txnMgr) txnMgr-&gt;DoTransaction(addHdrMsgTxn);</span>
<a href="#l8.124"></a><span id="l8.124">       RefPtr&lt;nsImapOfflineTxn&gt; undoMsgTxn =</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineat">@@ -6806,24 +6809,23 @@ nsresult nsImapMailFolder::CopyMessagesO</span>
<a href="#l8.126"></a><span id="l8.126">       database-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l8.127"></a><span id="l8.127">       SummaryChanged();</span>
<a href="#l8.128"></a><span id="l8.128">       srcFolder-&gt;SummaryChanged();</span>
<a href="#l8.129"></a><span id="l8.129">     }</span>
<a href="#l8.130"></a><span id="l8.130">     if (txnMgr) txnMgr-&gt;EndBatch(false);</span>
<a href="#l8.131"></a><span id="l8.131">   }</span>
<a href="#l8.132"></a><span id="l8.132"> </span>
<a href="#l8.133"></a><span id="l8.133">   // Do this before delete, as it destroys the messages</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineminus">-  uint32_t numHdrs;</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-  msgHdrsCopied-&gt;GetLength(&amp;numHdrs);</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">-  if (numHdrs) {</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+  if (!msgHdrsCopied.IsEmpty()) {</span>
<a href="#l8.138"></a><span id="l8.138">     nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l8.139"></a><span id="l8.139">         do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">-    if (notifier)</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+    if (notifier) {</span>
<a href="#l8.142"></a><span id="l8.142">       notifier-&gt;NotifyMsgsMoveCopyCompleted(isMove, msgHdrsCopied, this,</span>
<a href="#l8.143"></a><span id="l8.143">                                             destMsgHdrs);</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+    }</span>
<a href="#l8.145"></a><span id="l8.145">   }</span>
<a href="#l8.146"></a><span id="l8.146"> </span>
<a href="#l8.147"></a><span id="l8.147">   if (isMove &amp;&amp; NS_SUCCEEDED(rv) &amp;&amp; (deleteToTrash || deleteImmediately)) {</span>
<a href="#l8.148"></a><span id="l8.148">     DeleteStoreMessages(keysToDelete, srcFolder);</span>
<a href="#l8.149"></a><span id="l8.149">     srcFolder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications,</span>
<a href="#l8.150"></a><span id="l8.150">                                    false);</span>
<a href="#l8.151"></a><span id="l8.151">     sourceMailDB-&gt;DeleteMessages(keysToDelete, nullptr);</span>
<a href="#l8.152"></a><span id="l8.152">     srcFolder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -2289,20 +2289,24 @@ nsMsgLocalMailFolder::EndCopy(bool aCopy</span>
<a href="#l9.4"></a><span id="l9.4">     uint32_t numHdrs;</span>
<a href="#l9.5"></a><span id="l9.5">     mCopyState-&gt;m_messages-&gt;GetLength(&amp;numHdrs);</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7">     if (multipleCopiesFinished &amp;&amp; numHdrs &amp;&amp; !mCopyState-&gt;m_isFolder) {</span>
<a href="#l9.8"></a><span id="l9.8">       // we need to send this notification before we delete the source messages,</span>
<a href="#l9.9"></a><span id="l9.9">       // because deleting the source messages clears out the src msg db hdr.</span>
<a href="#l9.10"></a><span id="l9.10">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l9.11"></a><span id="l9.11">           do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-      if (notifier)</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-        notifier-&gt;NotifyMsgsMoveCopyCompleted(mCopyState-&gt;m_isMove,</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-                                              mCopyState-&gt;m_messages, this,</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-                                              mCopyState-&gt;m_destMessages);</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+      if (notifier) {</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+        nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; srcHdrs;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+        nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; destHdrs;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+        MsgHdrsToTArray(mCopyState-&gt;m_messages, srcHdrs);</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+        MsgHdrsToTArray(mCopyState-&gt;m_destMessages, destHdrs);</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+        notifier-&gt;NotifyMsgsMoveCopyCompleted(mCopyState-&gt;m_isMove, srcHdrs,</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+                                              this, destHdrs);</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+      }</span>
<a href="#l9.24"></a><span id="l9.24">     }</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26">     if (!mCopyState-&gt;m_isMove) {</span>
<a href="#l9.27"></a><span id="l9.27">       if (multipleCopiesFinished) {</span>
<a href="#l9.28"></a><span id="l9.28">         nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder;</span>
<a href="#l9.29"></a><span id="l9.29">         srcFolder = do_QueryInterface(mCopyState-&gt;m_srcSupport);</span>
<a href="#l9.30"></a><span id="l9.30">         if (mCopyState-&gt;m_isFolder)</span>
<a href="#l9.31"></a><span id="l9.31">           CopyAllSubFolders(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/local/src/nsLocalUndoTxn.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalUndoTxn.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -175,69 +175,66 @@ nsresult nsLocalMoveCopyMsgTxn::UndoTran</span>
<a href="#l10.4"></a><span id="l10.4">   rv = srcFolder-&gt;GetMsgDatabase(getter_AddRefs(srcDB));</span>
<a href="#l10.5"></a><span id="l10.5">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7">   rv = dstFolder-&gt;GetMsgDatabase(getter_AddRefs(dstDB));</span>
<a href="#l10.8"></a><span id="l10.8">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10">   uint32_t count = m_srcKeyArray.Length();</span>
<a href="#l10.11"></a><span id="l10.11">   uint32_t i;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBHdr&gt; oldHdr;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15">   // protect against a bogus undo txn without any source keys</span>
<a href="#l10.16"></a><span id="l10.16">   // see bug #179856 for details</span>
<a href="#l10.17"></a><span id="l10.17">   NS_ASSERTION(count, &quot;no source keys&quot;);</span>
<a href="#l10.18"></a><span id="l10.18">   if (!count) return NS_ERROR_UNEXPECTED;</span>
<a href="#l10.19"></a><span id="l10.19"> </span>
<a href="#l10.20"></a><span id="l10.20">   if (m_isMove) {</span>
<a href="#l10.21"></a><span id="l10.21">     if (m_srcIsImap4) {</span>
<a href="#l10.22"></a><span id="l10.22">       bool deleteFlag =</span>
<a href="#l10.23"></a><span id="l10.23">           true;  // message has been deleted -we are trying to undo it</span>
<a href="#l10.24"></a><span id="l10.24">       CheckForToggleDelete(srcFolder, m_srcKeyArray[0],</span>
<a href="#l10.25"></a><span id="l10.25">                            &amp;deleteFlag);  // there could have been a toggle.</span>
<a href="#l10.26"></a><span id="l10.26">       rv = UndoImapDeleteFlag(srcFolder, m_srcKeyArray, deleteFlag);</span>
<a href="#l10.27"></a><span id="l10.27">     } else if (m_canUndelete) {</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-      nsCOMPtr&lt;nsIMutableArray&gt; srcMessages =</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-          do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-      nsCOMPtr&lt;nsIMutableArray&gt; dstMessages =</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-          do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+      nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; srcMessages(count);</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+      nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; destMessages(count);</span>
<a href="#l10.34"></a><span id="l10.34"> </span>
<a href="#l10.35"></a><span id="l10.35">       for (i = 0; i &lt; count; i++) {</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+        nsCOMPtr&lt;nsIMsgDBHdr&gt; oldHdr;</span>
<a href="#l10.37"></a><span id="l10.37">         rv = dstDB-&gt;GetMsgHdrForKey(m_dstKeyArray[i], getter_AddRefs(oldHdr));</span>
<a href="#l10.38"></a><span id="l10.38">         NS_ASSERTION(oldHdr, &quot;fatal ... cannot get old msg header&quot;);</span>
<a href="#l10.39"></a><span id="l10.39">         if (NS_SUCCEEDED(rv) &amp;&amp; oldHdr) {</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+          nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l10.41"></a><span id="l10.41">           rv = srcDB-&gt;CopyHdrFromExistingHdr(m_srcKeyArray[i], oldHdr, true,</span>
<a href="#l10.42"></a><span id="l10.42">                                              getter_AddRefs(newHdr));</span>
<a href="#l10.43"></a><span id="l10.43">           NS_ASSERTION(newHdr, &quot;fatal ... cannot create new msg header&quot;);</span>
<a href="#l10.44"></a><span id="l10.44">           if (NS_SUCCEEDED(rv) &amp;&amp; newHdr) {</span>
<a href="#l10.45"></a><span id="l10.45">             newHdr-&gt;SetStatusOffset(m_srcStatusOffsetArray[i]);</span>
<a href="#l10.46"></a><span id="l10.46">             srcDB-&gt;UndoDelete(newHdr);</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-            srcMessages-&gt;AppendElement(newHdr);</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+            srcMessages.AppendElement(newHdr);</span>
<a href="#l10.49"></a><span id="l10.49">             // (we want to keep these two lists in sync)</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-            dstMessages-&gt;AppendElement(oldHdr);</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+            destMessages.AppendElement(oldHdr);</span>
<a href="#l10.52"></a><span id="l10.52">           }</span>
<a href="#l10.53"></a><span id="l10.53">         }</span>
<a href="#l10.54"></a><span id="l10.54">       }</span>
<a href="#l10.55"></a><span id="l10.55"> </span>
<a href="#l10.56"></a><span id="l10.56">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l10.57"></a><span id="l10.57">           do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l10.58"></a><span id="l10.58">       if (notifier) {</span>
<a href="#l10.59"></a><span id="l10.59">         // Remember that we're actually moving things back from the destination</span>
<a href="#l10.60"></a><span id="l10.60">         //  to the source!</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-        notifier-&gt;NotifyMsgsMoveCopyCompleted(true, dstMessages, srcFolder,</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+        notifier-&gt;NotifyMsgsMoveCopyCompleted(true, destMessages, srcFolder,</span>
<a href="#l10.63"></a><span id="l10.63">                                               srcMessages);</span>
<a href="#l10.64"></a><span id="l10.64">       }</span>
<a href="#l10.65"></a><span id="l10.65"> </span>
<a href="#l10.66"></a><span id="l10.66">       nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l10.67"></a><span id="l10.67">           do_QueryInterface(srcFolder);</span>
<a href="#l10.68"></a><span id="l10.68">       if (localFolder) {</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-        nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; hdrs;</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-        MsgHdrsToTArray(srcMessages, hdrs);</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-        localFolder-&gt;MarkMsgsOnPop3Server(hdrs, POP3_NONE /*deleteMsgs*/);</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+        localFolder-&gt;MarkMsgsOnPop3Server(srcMessages,</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+                                          POP3_NONE /*deleteMsgs*/);</span>
<a href="#l10.74"></a><span id="l10.74">       }</span>
<a href="#l10.75"></a><span id="l10.75">     } else  // undoing a move means moving the messages back.</span>
<a href="#l10.76"></a><span id="l10.76">     {</span>
<a href="#l10.77"></a><span id="l10.77">       nsCOMPtr&lt;nsIMutableArray&gt; dstMessages =</span>
<a href="#l10.78"></a><span id="l10.78">           do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l10.79"></a><span id="l10.79">       m_numHdrsCopied = 0;</span>
<a href="#l10.80"></a><span id="l10.80">       m_srcKeyArray.Clear();</span>
<a href="#l10.81"></a><span id="l10.81">       for (i = 0; i &lt; count; i++) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/local/src/nsMsgMaildirStore.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/local/src/nsMsgMaildirStore.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1092,19 +1092,23 @@ nsMsgMaildirStore::CopyMessages(bool aIs</span>
<a href="#l11.4"></a><span id="l11.4">       nsMsgKey dstKey;</span>
<a href="#l11.5"></a><span id="l11.5">       destHdr-&gt;GetMessageKey(&amp;dstKey);</span>
<a href="#l11.6"></a><span id="l11.6">       msgTxn-&gt;AddDstKey(dstKey);</span>
<a href="#l11.7"></a><span id="l11.7">       if (aListener) aListener-&gt;SetMessageKey(dstKey);</span>
<a href="#l11.8"></a><span id="l11.8">     }</span>
<a href="#l11.9"></a><span id="l11.9">   }</span>
<a href="#l11.10"></a><span id="l11.10">   nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l11.11"></a><span id="l11.11">       do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  if (notifier)</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-    notifier-&gt;NotifyMsgsMoveCopyCompleted(aIsMove, aHdrArray, aDstFolder,</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-                                          dstHdrs);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+  if (notifier) {</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+    nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; srcTmp;</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+    nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; destTmp;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+    MsgHdrsToTArray(aHdrArray, srcTmp);</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+    MsgHdrsToTArray(dstHdrs, destTmp);</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+    notifier-&gt;NotifyMsgsMoveCopyCompleted(aIsMove, srcTmp, aDstFolder, destTmp);</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+  }</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23">   // For now, we only support local dest folders, and for those we are done and</span>
<a href="#l11.24"></a><span id="l11.24">   // can delete the messages. Perhaps this should be moved into the folder</span>
<a href="#l11.25"></a><span id="l11.25">   // when we try to support other folder types.</span>
<a href="#l11.26"></a><span id="l11.26">   if (aIsMove) {</span>
<a href="#l11.27"></a><span id="l11.27">     for (uint32_t i = 0; i &lt; messageCount; ++i) {</span>
<a href="#l11.28"></a><span id="l11.28">       nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr(do_QueryElementAt(aHdrArray, i, &amp;rv));</span>
<a href="#l11.29"></a><span id="l11.29">       rv = srcDB-&gt;DeleteHeader(msgDBHdr, nullptr, false, true);</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineat">@@ -1315,19 +1319,19 @@ nsresult nsMsgMaildirStore::GetOutputStr</span>
<a href="#l11.31"></a><span id="l11.31">   nsCOMPtr&lt;nsIFile&gt; maildirFile;</span>
<a href="#l11.32"></a><span id="l11.32">   folderPath-&gt;Clone(getter_AddRefs(maildirFile));</span>
<a href="#l11.33"></a><span id="l11.33">   maildirFile-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l11.34"></a><span id="l11.34">   maildirFile-&gt;AppendNative(fileName);</span>
<a href="#l11.35"></a><span id="l11.35"> </span>
<a href="#l11.36"></a><span id="l11.36">   return MsgGetFileStream(maildirFile, getter_AddRefs(aOutputStream));</span>
<a href="#l11.37"></a><span id="l11.37"> }</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-NS_IMETHODIMP nsMsgMaildirStore::ChangeKeywords(const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aHdrArray,</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-                                                const nsACString &amp;aKeywords,</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-                                                bool aAdd) {</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+NS_IMETHODIMP nsMsgMaildirStore::ChangeKeywords(</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+    const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aHdrArray, const nsACString &amp;aKeywords,</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+    bool aAdd) {</span>
<a href="#l11.45"></a><span id="l11.45">   if (aHdrArray.IsEmpty()) return NS_ERROR_INVALID_ARG;</span>
<a href="#l11.46"></a><span id="l11.46"> </span>
<a href="#l11.47"></a><span id="l11.47">   nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l11.48"></a><span id="l11.48">   nsCOMPtr&lt;nsISeekableStream&gt; seekableStream;</span>
<a href="#l11.49"></a><span id="l11.49"> </span>
<a href="#l11.50"></a><span id="l11.50">   mozilla::UniquePtr&lt;nsLineBuffer&lt;char&gt;&gt; lineBuffer(new nsLineBuffer&lt;char&gt;);</span>
<a href="#l11.51"></a><span id="l11.51"> </span>
<a href="#l11.52"></a><span id="l11.52">   nsTArray&lt;nsCString&gt; keywordArray;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/local/src/nsRssIncomingServer.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/local/src/nsRssIncomingServer.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -165,18 +165,18 @@ NS_IMETHODIMP nsRssIncomingServer::MsgsC</span>
<a href="#l12.4"></a><span id="l12.4"> }</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> NS_IMETHODIMP nsRssIncomingServer::MsgsDeleted(</span>
<a href="#l12.7"></a><span id="l12.7">     const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aMsgs) {</span>
<a href="#l12.8"></a><span id="l12.8">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.9"></a><span id="l12.9"> }</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11"> NS_IMETHODIMP nsRssIncomingServer::MsgsMoveCopyCompleted(</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    bool aMove, nsIArray *aSrcMsgs, nsIMsgFolder *aDestFolder,</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-    nsIArray *aDestMsgs) {</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+    bool aMove, const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aSrcMsgs,</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+    nsIMsgFolder *aDestFolder, const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aDestMsgs) {</span>
<a href="#l12.16"></a><span id="l12.16">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.17"></a><span id="l12.17"> }</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19"> NS_IMETHODIMP nsRssIncomingServer::MsgKeyChanged(nsMsgKey aOldKey,</span>
<a href="#l12.20"></a><span id="l12.20">                                                  nsIMsgDBHdr *aNewHdr) {</span>
<a href="#l12.21"></a><span id="l12.21">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.22"></a><span id="l12.22"> }</span>
<a href="#l12.23"></a><span id="l12.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/test/resources/folderEventLogHelper.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/test/resources/folderEventLogHelper.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -77,26 +77,22 @@ var _folderEventLogHelper_msgFolderListe</span>
<a href="#l13.4"></a><span id="l13.4">   /**</span>
<a href="#l13.5"></a><span id="l13.5">    * @param {boolean} aMove</span>
<a href="#l13.6"></a><span id="l13.6">    * @param {nsIArray} aSrcMsgs</span>
<a href="#l13.7"></a><span id="l13.7">    * @param {nsIMsgFolder} aDestFolder</span>
<a href="#l13.8"></a><span id="l13.8">    * @param {nsIArray} aDestMsgs</span>
<a href="#l13.9"></a><span id="l13.9">    */</span>
<a href="#l13.10"></a><span id="l13.10">   msgsMoveCopyCompleted(aMove, aSrcMsgs, aDestFolder, aDestMsgs) {</span>
<a href="#l13.11"></a><span id="l13.11">     let args = [aMove ? &quot;moved&quot; : &quot;copied&quot;];</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-    for (let msgHdr of fixIterator(aSrcMsgs, Ci.nsIMsgDBHdr)) {</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-      args.push(msgHdr);</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-    }</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+    args.push(...aSrcMsgs);</span>
<a href="#l13.16"></a><span id="l13.16">     args.push(&quot;to&quot;);</span>
<a href="#l13.17"></a><span id="l13.17">     args.push(aDestFolder);</span>
<a href="#l13.18"></a><span id="l13.18">     if (aDestMsgs) {</span>
<a href="#l13.19"></a><span id="l13.19">       args.push(&quot;dest headers:&quot;);</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-      for (let msgHdr of fixIterator(aDestMsgs, Ci.nsIMsgDBHdr)) {</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-        args.push(msgHdr);</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-      }</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+      args.push(...aDestMsgs);</span>
<a href="#l13.24"></a><span id="l13.24">     }</span>
<a href="#l13.25"></a><span id="l13.25">     mark_action(&quot;msgEvent&quot;, &quot;msgsMoveCopyCompleted&quot;, args);</span>
<a href="#l13.26"></a><span id="l13.26">   },</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28">   msgKeyChanged(aOldMsgKey, aNewMsgHdr) {</span>
<a href="#l13.29"></a><span id="l13.29">     let args = [&quot;old key&quot;, aOldMsgKey, &quot;new header&quot;, aNewMsgHdr];</span>
<a href="#l13.30"></a><span id="l13.30">     mark_action(&quot;msgEvent&quot;, &quot;msgKeyChanged&quot;, args);</span>
<a href="#l13.31"></a><span id="l13.31">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/test/resources/msgFolderListenerSetup.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/test/resources/msgFolderListenerSetup.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -338,18 +338,18 @@ function verify(event) {</span>
<a href="#l14.4"></a><span id="l14.4">         break;</span>
<a href="#l14.5"></a><span id="l14.5">       }</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7">       // Check: destination headers.  We expect these for local and imap folders,</span>
<a href="#l14.8"></a><span id="l14.8">       //  but we will not have heard about the headers ahead of time,</span>
<a href="#l14.9"></a><span id="l14.9">       //  so the best we can do is make sure they match up.  To this end,</span>
<a href="#l14.10"></a><span id="l14.10">       //  we check that the message-id header values match up.</span>
<a href="#l14.11"></a><span id="l14.11">       for (let iMsg = 0; iMsg &lt; event[2].length; iMsg++) {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-        let srcHdr = event[2].queryElementAt(iMsg, Ci.nsIMsgDBHdr);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-        let destHdr = event[4].queryElementAt(iMsg, Ci.nsIMsgDBHdr);</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+        let srcHdr = event[2][iMsg];</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+        let destHdr = event[4][iMsg];</span>
<a href="#l14.16"></a><span id="l14.16">         Assert.equal(srcHdr.messageId, destHdr.messageId);</span>
<a href="#l14.17"></a><span id="l14.17">       }</span>
<a href="#l14.18"></a><span id="l14.18">       break;</span>
<a href="#l14.19"></a><span id="l14.19">     case MailServices.mfn.folderAdded:</span>
<a href="#l14.20"></a><span id="l14.20">       // Check: parent folder matches</span>
<a href="#l14.21"></a><span id="l14.21">       Assert.equal(expected[1].URI, event[1].parent.URI);</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23">       // Check: folder name matches</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

