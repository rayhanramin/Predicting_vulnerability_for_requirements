<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 10299:539dc131baf1e4b9e057f021428eea38da2d25de</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 539dc131baf1e4b9e057f021428eea38da2d25de" />
<meta property="og:url" content="/comm-central/rev/539dc131baf1e4b9e057f021428eea38da2d25de" />
<meta property="og:description" content="Bug 758237 - Account Provisioner tab should close and respawn AP dialog if provider XML is corrupt or returns error. r+ui-r=bwinton." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 539dc131baf1e4b9e057f021428eea38da2d25de 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/539dc131baf1e4b9e057f021428eea38da2d25de">shortlog</a> |
<a href="/comm-central/log/539dc131baf1e4b9e057f021428eea38da2d25de">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/539dc131baf1e4b9e057f021428eea38da2d25de">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/539dc131baf1e4b9e057f021428eea38da2d25de">files</a> |
changeset |
<a href="/comm-central/raw-rev/539dc131baf1e4b9e057f021428eea38da2d25de">raw</a>  | <a href="/comm-central/archive/539dc131baf1e4b9e057f021428eea38da2d25de.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=758237">Bug 758237</a> - Account Provisioner tab should close and respawn AP dialog if provider XML is corrupt or returns error. r+ui-r=bwinton.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#105;&#107;&#101;&#32;&#67;&#111;&#110;&#108;&#101;&#121;&#32;&#60;&#109;&#99;&#111;&#110;&#108;&#101;&#121;&#64;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 28 May 2012 12:45:48 -0400</td></tr>

<tr>
 <td>changeset 10299</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/539dc131baf1e4b9e057f021428eea38da2d25de">539dc131baf1e4b9e057f021428eea38da2d25de</a></td>
</tr>



<tr>
<td>parent 10298</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/dae4853973c368f63714248bddf0acd918d3641d">dae4853973c368f63714248bddf0acd918d3641d</a>
</td>
</tr>

<tr>
<td>child 10300</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/96cb37390f45caf2be23a73c3b3c86c38f18d64b">96cb37390f45caf2be23a73c3b3c86c38f18d64b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=539dc131baf1e4b9e057f021428eea38da2d25de">7801</a></td></tr>
<tr><td>push user</td><td>mconley@mozilla.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 28 May 2012 16:48:24 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@d8e6f2b61e01 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d8e6f2b61e01a07a676141a359abe2a4bdc8a40f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d8e6f2b61e01a07a676141a359abe2a4bdc8a40f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d8e6f2b61e01a07a676141a359abe2a4bdc8a40f&newProject=comm-central&newRevision=dae4853973c368f63714248bddf0acd918d3641d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d8e6f2b61e01a07a676141a359abe2a4bdc8a40f&newProject=comm-central&newRevision=dae4853973c368f63714248bddf0acd918d3641d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d8e6f2b61e01a07a676141a359abe2a4bdc8a40f&newProject=comm-central&newRevision=dae4853973c368f63714248bddf0acd918d3641d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=758237">758237</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=758237">Bug 758237</a> - Account Provisioner tab should close and respawn AP dialog if provider XML is corrupt or returns error. r+ui-r=bwinton.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/539dc131baf1e4b9e057f021428eea38da2d25de/mail/components/newmailaccount/content/accountProvisioner.js">mail/components/newmailaccount/content/accountProvisioner.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/539dc131baf1e4b9e057f021428eea38da2d25de/mail/components/newmailaccount/content/accountProvisioner.js">file</a> |
<a href="/comm-central/annotate/539dc131baf1e4b9e057f021428eea38da2d25de/mail/components/newmailaccount/content/accountProvisioner.js">annotate</a> |
<a href="/comm-central/diff/539dc131baf1e4b9e057f021428eea38da2d25de/mail/components/newmailaccount/content/accountProvisioner.js">diff</a> |
<a href="/comm-central/comparison/539dc131baf1e4b9e057f021428eea38da2d25de/mail/components/newmailaccount/content/accountProvisioner.js">comparison</a> |
<a href="/comm-central/log/539dc131baf1e4b9e057f021428eea38da2d25de/mail/components/newmailaccount/content/accountProvisioner.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/539dc131baf1e4b9e057f021428eea38da2d25de/mail/components/newmailaccount/content/uriListener.js">mail/components/newmailaccount/content/uriListener.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/539dc131baf1e4b9e057f021428eea38da2d25de/mail/components/newmailaccount/content/uriListener.js">file</a> |
<a href="/comm-central/annotate/539dc131baf1e4b9e057f021428eea38da2d25de/mail/components/newmailaccount/content/uriListener.js">annotate</a> |
<a href="/comm-central/diff/539dc131baf1e4b9e057f021428eea38da2d25de/mail/components/newmailaccount/content/uriListener.js">diff</a> |
<a href="/comm-central/comparison/539dc131baf1e4b9e057f021428eea38da2d25de/mail/components/newmailaccount/content/uriListener.js">comparison</a> |
<a href="/comm-central/log/539dc131baf1e4b9e057f021428eea38da2d25de/mail/components/newmailaccount/content/uriListener.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/configError.xml">mail/test/mozmill/newmailaccount/html/configError.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/configError.xml">file</a> |
<a href="/comm-central/annotate/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/configError.xml">annotate</a> |
<a href="/comm-central/diff/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/configError.xml">diff</a> |
<a href="/comm-central/comparison/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/configError.xml">comparison</a> |
<a href="/comm-central/log/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/configError.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/providerList">mail/test/mozmill/newmailaccount/html/providerList</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/providerList">file</a> |
<a href="/comm-central/annotate/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/providerList">annotate</a> |
<a href="/comm-central/diff/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/providerList">diff</a> |
<a href="/comm-central/comparison/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/providerList">comparison</a> |
<a href="/comm-central/log/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/providerList">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/registrationError.html">mail/test/mozmill/newmailaccount/html/registrationError.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/registrationError.html">file</a> |
<a href="/comm-central/annotate/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/registrationError.html">annotate</a> |
<a href="/comm-central/diff/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/registrationError.html">diff</a> |
<a href="/comm-central/comparison/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/registrationError.html">comparison</a> |
<a href="/comm-central/log/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/registrationError.html">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/suggestFromName">mail/test/mozmill/newmailaccount/html/suggestFromName</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/suggestFromName">file</a> |
<a href="/comm-central/annotate/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/suggestFromName">annotate</a> |
<a href="/comm-central/diff/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/suggestFromName">diff</a> |
<a href="/comm-central/comparison/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/suggestFromName">comparison</a> |
<a href="/comm-central/log/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/html/suggestFromName">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/test-newmailaccount.js">mail/test/mozmill/newmailaccount/test-newmailaccount.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/test-newmailaccount.js">file</a> |
<a href="/comm-central/annotate/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/test-newmailaccount.js">annotate</a> |
<a href="/comm-central/diff/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/test-newmailaccount.js">diff</a> |
<a href="/comm-central/comparison/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/test-newmailaccount.js">comparison</a> |
<a href="/comm-central/log/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/newmailaccount/test-newmailaccount.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">file</a> |
<a href="/comm-central/annotate/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">annotate</a> |
<a href="/comm-central/diff/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">diff</a> |
<a href="/comm-central/comparison/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">comparison</a> |
<a href="/comm-central/log/539dc131baf1e4b9e057f021428eea38da2d25de/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/newmailaccount/content/accountProvisioner.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/newmailaccount/content/accountProvisioner.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -365,17 +365,17 @@ var EmailAccountProvisioner = {</span>
<a href="#l1.4"></a><span id="l1.4">     $(window).unload(function() {</span>
<a href="#l1.5"></a><span id="l1.5">       if (window.arguments[0].search_engine</span>
<a href="#l1.6"></a><span id="l1.6">           &amp;&amp; $(&quot;#search_engine_check&quot;).prop(&quot;checked&quot;)) {</span>
<a href="#l1.7"></a><span id="l1.7">         let engine = Services.search.getEngineByName(window.arguments[0].search_engine);</span>
<a href="#l1.8"></a><span id="l1.8">         Services.search.currentEngine = engine;</span>
<a href="#l1.9"></a><span id="l1.9">       }</span>
<a href="#l1.10"></a><span id="l1.10">     });</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    if (window.arguments[0].search_engine || window.arguments[0].success) {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    if (window.arguments[0].success) {</span>
<a href="#l1.14"></a><span id="l1.14">       // Show the success page which lets a user compose mail, find add-ons,</span>
<a href="#l1.15"></a><span id="l1.15">       // set a signature, etc.</span>
<a href="#l1.16"></a><span id="l1.16">       gLog.info(&quot;Looks like we just finished ordering an address - showing the success page...&quot;);</span>
<a href="#l1.17"></a><span id="l1.17">       EmailAccountProvisioner.showSuccessPage();</span>
<a href="#l1.18"></a><span id="l1.18">     } else {</span>
<a href="#l1.19"></a><span id="l1.19">       // The default mode, where we display the search input, providers, etc</span>
<a href="#l1.20"></a><span id="l1.20">       $(&quot;#window&quot;).show();</span>
<a href="#l1.21"></a><span id="l1.21">       $(&quot;#successful_account&quot;).hide();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/newmailaccount/content/uriListener.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/newmailaccount/content/uriListener.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -196,53 +196,55 @@ TracingListener.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">       accountCreationFuncs);</span>
<a href="#l2.5"></a><span id="l2.5">     Services.scriptloader.loadSubScript(</span>
<a href="#l2.6"></a><span id="l2.6">       &quot;chrome://messenger/content/accountcreation/createInBackend.js&quot;,</span>
<a href="#l2.7"></a><span id="l2.7">       accountCreationFuncs);</span>
<a href="#l2.8"></a><span id="l2.8">     Services.scriptloader.loadSubScript(</span>
<a href="#l2.9"></a><span id="l2.9">       &quot;chrome://messenger/content/accountcreation/MyBadCertHandler.js&quot;,</span>
<a href="#l2.10"></a><span id="l2.10">       accountCreationFuncs);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    let tabmail = document.getElementById('tabmail');</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    let success = false;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    let account;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+</span>
<a href="#l2.16"></a><span id="l2.16">     try {</span>
<a href="#l2.17"></a><span id="l2.17">       // Attempt to construct the downloaded data into XML</span>
<a href="#l2.18"></a><span id="l2.18">       let data = this.chunks.join(&quot;&quot;);</span>
<a href="#l2.19"></a><span id="l2.19">       let xml = new XML(data);</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21">       // Attempt to derive email account information</span>
<a href="#l2.22"></a><span id="l2.22">       let accountConfig = accountCreationFuncs.readFromXML(xml);</span>
<a href="#l2.23"></a><span id="l2.23">       accountCreationFuncs.replaceVariables(accountConfig,</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-        this.params.realName,</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-        this.params.email);</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-      let account = accountCreationFuncs.createAccountInBackend(accountConfig);</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-      // Switch to the mail tab</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-      let tabmail = document.getElementById('tabmail');</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-      tabmail.switchToTab(0);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-      // Find the tab associated with this browser, and close it.</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-      let myTabInfo = tabmail.tabInfo</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-        .filter((function (x) {</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-              return &quot;browser&quot; in x &amp;&amp; x.browser == this.browser;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-              }).bind(this))[0];</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-      tabmail.closeTab(myTabInfo);</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-      // Respawn the account provisioner to announce our success</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-      NewMailAccountProvisioner(null, {</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-        success: true,</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-        search_engine: this.params.searchEngine,</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-        account: account,</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-      });</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+                                            this.params.realName,</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+                                            this.params.email);</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+      account = accountCreationFuncs.createAccountInBackend(accountConfig);</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+      success = true;</span>
<a href="#l2.49"></a><span id="l2.49">     } catch (e) {</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-      // Something went wrong.  Right now, we just dump the problem out</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-      // to the Error Console.  We should really do something smarter and</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-      // more user-facing, because if - for example - a provider passes</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-      // some bogus XML, this routine silently fails.</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+      // Something went wrong with account set up. Dump the error out to the</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+      // error console. The tab will be closed, and the Account Provisioner</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+      // tab will be reopened.</span>
<a href="#l2.57"></a><span id="l2.57">       Components.utils.reportError(&quot;Problem interpreting provider XML:&quot; + e);</span>
<a href="#l2.58"></a><span id="l2.58">     }</span>
<a href="#l2.59"></a><span id="l2.59"> </span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+    tabmail.switchToTab(0);</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+    // Find the tab associated with this browser, and close it.</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+    let myTabInfo = tabmail.tabInfo</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+      .filter((function (x) {</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+            return &quot;browser&quot; in x &amp;&amp; x.browser == this.browser;</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+            }).bind(this))[0];</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+    tabmail.closeTab(myTabInfo);</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+    // Respawn the account provisioner to announce our success</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+    NewMailAccountProvisioner(null, {</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+      success: success,</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+      search_engine: this.params.searchEngine,</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+      account: account,</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+    });</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+</span>
<a href="#l2.76"></a><span id="l2.76">     this.oldListener.onStopRequest(aRequest, aContext, aStatusCode);</span>
<a href="#l2.77"></a><span id="l2.77">   },</span>
<a href="#l2.78"></a><span id="l2.78"> </span>
<a href="#l2.79"></a><span id="l2.79">   onDataAvailable: function (/* nsIRequest */ aRequest,</span>
<a href="#l2.80"></a><span id="l2.80">                              /* nsISupports */ aContext,</span>
<a href="#l2.81"></a><span id="l2.81">                              /* nsIInputStream */ aStream,</span>
<a href="#l2.82"></a><span id="l2.82">                              /* int */ aOffset,</span>
<a href="#l2.83"></a><span id="l2.83">                              /* int */ aCount) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/mail/test/mozmill/newmailaccount/html/configError.xml</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,6 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+&lt;clientConfig version=&quot;1.1&quot;&gt;</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+  &lt;emailProvider id=&quot;%DOMAIN%&quot;/&gt;</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+  &lt;error code=&quot;USER_CANCEL&quot;&gt;</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+    You have cancelled your order.</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+  &lt;/error&gt;</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+&lt;/clientConfig&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/test/mozmill/newmailaccount/html/providerList</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/test/mozmill/newmailaccount/html/providerList</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -35,11 +35,16 @@</span>
<a href="#l4.4"></a><span id="l4.4">   &quot;search_engine&quot;: &quot;German&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> },{&quot;id&quot;: &quot;corrupt&quot;,</span>
<a href="#l4.6"></a><span id="l4.6">   &quot;label&quot;: &quot;Corrupt Provider&quot;,</span>
<a href="#l4.7"></a><span id="l4.7">   &quot;paid&quot;: false,</span>
<a href="#l4.8"></a><span id="l4.8">   &quot;languages&quot; : [&quot;en-US&quot;],</span>
<a href="#l4.9"></a><span id="l4.9">   &quot;api&quot;: &quot;http://localhost:43336/registrationCorrupt.html&quot;,</span>
<a href="#l4.10"></a><span id="l4.10">   &quot;tos_url&quot;: &quot;http://www.example.com/corrupt-tos&quot;,</span>
<a href="#l4.11"></a><span id="l4.11">   &quot;privacy_url&quot;: &quot;http://www.example.com/corrupt-privacy&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-}</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-]</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+},{&quot;id&quot;: &quot;err&quot;,</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  &quot;label&quot;: &quot;Error Provider&quot;,</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+  &quot;paid&quot;: false,</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  &quot;languages&quot; : [&quot;en-US&quot;],</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+  &quot;api&quot;: &quot;http://localhost:43336/registrationError.html&quot;,</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+  &quot;tos_url&quot;: &quot;http://www.example.com/err-tos&quot;,</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+  &quot;privacy_url&quot;: &quot;http://www.example.com/err-privacy&quot;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+}]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mail/test/mozmill/newmailaccount/html/registrationError.html</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,21 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;&gt;</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xml:lang=&quot;en&quot;&gt;</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+  &lt;head&gt;</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+    &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt;</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+    &lt;title&gt;Fake registration page to Error XML&lt;/title&gt;</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+  &lt;/head&gt;</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+  &lt;body&gt;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    &lt;div class=&quot;title&quot;&gt;Local version&lt;/div&gt;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+    &lt;div class=&quot;content&quot;&gt;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+      &lt;form action=&quot;configError.xml&quot; method=&quot;GET&quot;&gt;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+         &lt;p&gt;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+         First name: &lt;input value=&quot;Green&quot; id=&quot;first&quot; name=&quot;firstname&quot; type=&quot;text&quot;&gt;&lt;br&gt;</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+         Last name: &lt;input value=&quot;Llama&quot; id=&quot;last&quot; name=&quot;lastname&quot; type=&quot;text&quot;&gt;&lt;br&gt;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+         Email: &lt;input value=&quot;da.green.llama@example.com&quot; id=&quot;email&quot; name=&quot;email&quot; type=&quot;text&quot;&gt;&lt;br&gt;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+         &lt;input value=&quot;Send&quot; type=&quot;submit&quot;&gt;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+         &lt;/p&gt;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+      &lt;/form&gt;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+    &lt;/div&gt;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+  &lt;/body&gt;</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/test/mozmill/newmailaccount/html/suggestFromName</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/test/mozmill/newmailaccount/html/suggestFromName</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,10 +1,11 @@</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineminus">-</span>
<a href="#l6.5"></a><span id="l6.5"> [{&quot;product&quot;: &quot;personalized_email&quot;, &quot;addresses&quot;: [&quot;green@example.com&quot;,</span>
<a href="#l6.6"></a><span id="l6.6"> &quot;green_llama@example.com&quot;, &quot;gllama@example.com&quot;], &quot;succeeded&quot;: true, &quot;quote&quot;:</span>
<a href="#l6.7"></a><span id="l6.7"> &quot;b28acb3c0a464d33af22&quot;, &quot;price&quot;: 0, &quot;provider&quot;: &quot;bar&quot;}, {&quot;product&quot;:</span>
<a href="#l6.8"></a><span id="l6.8"> &quot;personalized_email&quot;, &quot;addresses&quot;: [&quot;green-bar@example.com&quot;, &quot;me-bar@example.com&quot;,</span>
<a href="#l6.9"></a><span id="l6.9"> &quot;green-bar@madeup.nul&quot;, &quot;green@bar.nul&quot;, &quot;green@barexample.nul&quot;,</span>
<a href="#l6.10"></a><span id="l6.10"> &quot;greenbar@greenllama.nul&quot;, &quot;mebar@greenllama.nul&quot;], &quot;succeeded&quot;: true, &quot;quote&quot;:</span>
<a href="#l6.11"></a><span id="l6.11"> &quot;3f93e48679ab46a49475&quot;, &quot;price&quot;: &quot;20.00&quot;, &quot;provider&quot;: &quot;foo&quot;},</span>
<a href="#l6.12"></a><span id="l6.12"> {&quot;product&quot;: &quot;personalized_email&quot;, &quot;addresses&quot;: [&quot;corrupt@corrupt.nul&quot;],</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-&quot;succeeded&quot;: true, &quot;quote&quot;: &quot;abcdefg&quot;, &quot;price&quot;: 0, &quot;provider&quot;: &quot;corrupt&quot;}]</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+&quot;succeeded&quot;: true, &quot;quote&quot;: &quot;abcdefg&quot;, &quot;price&quot;: 0, &quot;provider&quot;: &quot;corrupt&quot;},</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+{&quot;product&quot;: &quot;personalized_email&quot;, &quot;addresses&quot;: [&quot;error@error.nul&quot;],</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+&quot;succeeded&quot;: true, &quot;quote&quot;: &quot;abcdefg&quot;, &quot;price&quot;: 0, &quot;provider&quot;: &quot;err&quot;}]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/test/mozmill/newmailaccount/test-newmailaccount.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/test/mozmill/newmailaccount/test-newmailaccount.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -210,17 +210,17 @@ function subtest_get_an_account(w) {</span>
<a href="#l7.4"></a><span id="l7.4"> }</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> /**</span>
<a href="#l7.7"></a><span id="l7.7">  * This is a subtest for test_get_an_account, and runs the second time the</span>
<a href="#l7.8"></a><span id="l7.8">  * account provisioner window is opened.</span>
<a href="#l7.9"></a><span id="l7.9">  */</span>
<a href="#l7.10"></a><span id="l7.10"> function subtest_get_an_account_part_2(w) {</span>
<a href="#l7.11"></a><span id="l7.11">   // Re-get the new window</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  $ = w.window.$;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  let $ = w.window.$;</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15">   // An account should have been added.</span>
<a href="#l7.16"></a><span id="l7.16">   assert_equals(nAccounts(), gNumAccounts + 1);</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18">   // We want this provider to be our default search engine.</span>
<a href="#l7.19"></a><span id="l7.19">   wait_for_element_invisible(w, &quot;window&quot;);</span>
<a href="#l7.20"></a><span id="l7.20">   wait_for_element_visible(w, &quot;successful_account&quot;);</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -619,24 +619,25 @@ function test_throws_console_error_on_co</span>
<a href="#l7.23"></a><span id="l7.23">   gNumAccounts = nAccounts();</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25">   gConsoleListener.reset();</span>
<a href="#l7.26"></a><span id="l7.26">   gConsoleListener.listenFor(&quot;Problem interpreting provider XML:&quot;);</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28">   Services.console.registerListener(gConsoleListener);</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30">   // Click the OK button to order the account.</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+  plan_for_modal_dialog(&quot;AccountCreation&quot;, close_dialog_immediately);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+</span>
<a href="#l7.33"></a><span id="l7.33">   let btn = tab.browser.contentWindow.document.querySelector(&quot;input[value=Send]&quot;);</span>
<a href="#l7.34"></a><span id="l7.34">   mc.click(new elib.Elem(btn));</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+  wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l7.36"></a><span id="l7.36"> </span>
<a href="#l7.37"></a><span id="l7.37">   gConsoleListener.wait();</span>
<a href="#l7.38"></a><span id="l7.38"> </span>
<a href="#l7.39"></a><span id="l7.39">   Services.console.unregisterListener(gConsoleListener);</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-  mc.tabmail.closeTab(tab);</span>
<a href="#l7.42"></a><span id="l7.42"> }</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44"> /**</span>
<a href="#l7.45"></a><span id="l7.45">  * Test that if the providerList is invalid or broken JSON, that</span>
<a href="#l7.46"></a><span id="l7.46">  * we &quot;go offline&quot; and display an error message.</span>
<a href="#l7.47"></a><span id="l7.47">  */</span>
<a href="#l7.48"></a><span id="l7.48"> function test_broken_provider_list_goes_offline() {</span>
<a href="#l7.49"></a><span id="l7.49">   let original = Services.prefs.getCharPref(kProviderListPref);</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineat">@@ -912,16 +913,26 @@ function sub_get_to_order_form(aControll</span>
<a href="#l7.51"></a><span id="l7.51">   // Pick the email address green@example.com</span>
<a href="#l7.52"></a><span id="l7.52">   plan_for_content_tab_load();</span>
<a href="#l7.53"></a><span id="l7.53"> </span>
<a href="#l7.54"></a><span id="l7.54">   // Clicking this button should close the modal dialog.</span>
<a href="#l7.55"></a><span id="l7.55">   $('button.create[address=&quot;' + aAddress + '&quot;]').click();</span>
<a href="#l7.56"></a><span id="l7.56"> }</span>
<a href="#l7.57"></a><span id="l7.57"> </span>
<a href="#l7.58"></a><span id="l7.58"> /**</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+ * Helper function to be passed to plan_for_modal_dialog that closes the</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+ * Account Provisioner dialog immediately.</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+ */</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+function close_dialog_immediately(aController) {</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+  plan_for_window_close(aController);</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+  mc.click(new elib.Elem(aController.window.document.querySelector(&quot;.close&quot;)));</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+  wait_for_window_close();</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+}</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+/**</span>
<a href="#l7.69"></a><span id="l7.69">  * Test that clicking on links in the order form open in the same account</span>
<a href="#l7.70"></a><span id="l7.70">  * provisioner tab.</span>
<a href="#l7.71"></a><span id="l7.71">  */</span>
<a href="#l7.72"></a><span id="l7.72"> function test_internal_link_opening_behaviour() {</span>
<a href="#l7.73"></a><span id="l7.73">   get_to_order_form();</span>
<a href="#l7.74"></a><span id="l7.74"> </span>
<a href="#l7.75"></a><span id="l7.75">   // Open the provisioner - once opened, let subtest_get_an_account run...</span>
<a href="#l7.76"></a><span id="l7.76">   let tab = mc.tabmail.currentTabInfo;</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineat">@@ -977,8 +988,35 @@ function test_external_link_opening_beha</span>
<a href="#l7.78"></a><span id="l7.78">   mc.click(new elib.Elem(external));</span>
<a href="#l7.79"></a><span id="l7.79"> </span>
<a href="#l7.80"></a><span id="l7.80">   mc.waitFor(function () gMockExtProtSvc.urlLoaded(targetHref),</span>
<a href="#l7.81"></a><span id="l7.81">              &quot;Timed out waiting for the link &quot; + targetHref + &quot;to be &quot; +</span>
<a href="#l7.82"></a><span id="l7.82">              &quot;opened in the default browser.&quot;);</span>
<a href="#l7.83"></a><span id="l7.83">   gMockExtProtSvcReg.unregister();</span>
<a href="#l7.84"></a><span id="l7.84">   mc.tabmail.closeTab(tab);</span>
<a href="#l7.85"></a><span id="l7.85"> }</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+/**</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+ * Test that if the provider returns XML that we can't turn into an account,</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+ * then we error out and go back to the Account Provisioner dialog.</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+ */</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+function test_return_to_provisioner_on_error_XML() {</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+  const kOriginalTabNum = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+  get_to_order_form(&quot;error@error.nul&quot;);</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+  let tab = mc.tabmail.currentTabInfo;</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+  let doc = tab.browser.contentWindow.document;</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+  plan_for_modal_dialog(&quot;AccountCreation&quot;, close_dialog_immediately);</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+  // Click the OK button to order the account.</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+  let btn = tab.browser.contentWindow.document.querySelector(&quot;input[value=Send]&quot;);</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+  mc.click(new elib.Elem(btn));</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+  wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+  // We should be done executing the function defined in plan_for_modal_dialog</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+  // now, so the Account Provisioner dialog should be closed, and the order</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+  // form tab should have been closed.</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+  assert_equals(kOriginalTabNum, mc.tabmail.tabContainer.childNodes.length,</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+                &quot;Timed out waiting for the order form tab to close.&quot;);</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -194,17 +194,17 @@ var gConsoleListener = {</span>
<a href="#l8.4"></a><span id="l8.4">   QueryInterface: XPCOMUtils.generateQI([Ci.nsIConsoleListener]),</span>
<a href="#l8.5"></a><span id="l8.5">   _msg: null,</span>
<a href="#l8.6"></a><span id="l8.6">   _sawMsg: false,</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8">   observe: function(aMsg) {</span>
<a href="#l8.9"></a><span id="l8.9">     if (!this._msg)</span>
<a href="#l8.10"></a><span id="l8.10">       return;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    this._sawMsg = (aMsg.message.indexOf(this._msg) != -1);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+    this._sawMsg |= (aMsg.message.indexOf(this._msg) != -1);</span>
<a href="#l8.14"></a><span id="l8.14">   },</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16">   listenFor: function(aMsg) {</span>
<a href="#l8.17"></a><span id="l8.17">     this._msg = aMsg;</span>
<a href="#l8.18"></a><span id="l8.18">   },</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20">   reset: function() {</span>
<a href="#l8.21"></a><span id="l8.21">     this._msg = null;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

