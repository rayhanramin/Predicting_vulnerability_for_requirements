<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11590:6996e05c74ee20a045e320d826345883f379af86</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 6996e05c74ee20a045e320d826345883f379af86" />
<meta property="og:url" content="/comm-central/rev/6996e05c74ee20a045e320d826345883f379af86" />
<meta property="og:description" content="Bug 495318 - Implement LIST-EXTENDED (RFC 5258) in impad.js. r=irving" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 6996e05c74ee20a045e320d826345883f379af86 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/6996e05c74ee20a045e320d826345883f379af86">shortlog</a> |
<a href="/comm-central/log/6996e05c74ee20a045e320d826345883f379af86">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/6996e05c74ee20a045e320d826345883f379af86">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/6996e05c74ee20a045e320d826345883f379af86">files</a> |
changeset |
<a href="/comm-central/raw-rev/6996e05c74ee20a045e320d826345883f379af86">raw</a>  | <a href="/comm-central/archive/6996e05c74ee20a045e320d826345883f379af86.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=495318">Bug 495318</a> - Implement LIST-EXTENDED (RFC 5258) in impad.js. r=irving
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#76;&#101;&#99;&#104;&#110;&#101;&#114;&#32;&#60;&#100;&#97;&#118;&#105;&#100;&#64;&#108;&#101;&#99;&#104;&#110;&#111;&#108;&#111;&#103;&#121;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 09 Oct 2012 10:37:11 -0500</td></tr>

<tr>
 <td>changeset 11590</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/6996e05c74ee20a045e320d826345883f379af86">6996e05c74ee20a045e320d826345883f379af86</a></td>
</tr>



<tr>
<td>parent 11589</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d4e979a1d11d3e7f9d6a93ae3fadc260b60c96af">d4e979a1d11d3e7f9d6a93ae3fadc260b60c96af</a>
</td>
</tr>

<tr>
<td>child 11591</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8ae4f568bdddf250932e6b64886ca58a6a7e0944">8ae4f568bdddf250932e6b64886ca58a6a7e0944</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=6996e05c74ee20a045e320d826345883f379af86">8637</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 20 Nov 2012 01:53:47 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@6996e05c74ee [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6996e05c74ee20a045e320d826345883f379af86">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6996e05c74ee20a045e320d826345883f379af86&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6996e05c74ee20a045e320d826345883f379af86&newProject=comm-central&newRevision=6996e05c74ee20a045e320d826345883f379af86&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6996e05c74ee20a045e320d826345883f379af86&newProject=comm-central&newRevision=6996e05c74ee20a045e320d826345883f379af86&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6996e05c74ee20a045e320d826345883f379af86&newProject=comm-central&newRevision=6996e05c74ee20a045e320d826345883f379af86&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28irving%29&revcount=50">irving</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=495318">495318</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=495318">Bug 495318</a> - Implement LIST-EXTENDED (RFC 5258) in impad.js. r=irving</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/public/nsMsgFolderFlags.idl">mailnews/base/public/nsMsgFolderFlags.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/public/nsMsgFolderFlags.idl">file</a> |
<a href="/comm-central/annotate/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/public/nsMsgFolderFlags.idl">annotate</a> |
<a href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/public/nsMsgFolderFlags.idl">diff</a> |
<a href="/comm-central/comparison/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/public/nsMsgFolderFlags.idl">comparison</a> |
<a href="/comm-central/log/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/public/nsMsgFolderFlags.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js">mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js">file</a> |
<a href="/comm-central/annotate/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js">annotate</a> |
<a href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js">diff</a> |
<a href="/comm-central/comparison/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js">comparison</a> |
<a href="/comm-central/log/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js">mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js">file</a> |
<a href="/comm-central/annotate/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js">annotate</a> |
<a href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js">diff</a> |
<a href="/comm-central/comparison/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js">comparison</a> |
<a href="/comm-central/log/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/test/unit/xpcshell.ini">mailnews/base/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/6996e05c74ee20a045e320d826345883f379af86/mailnews/base/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/test_gmailAttributes.js">mailnews/imap/test/unit/test_gmailAttributes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/test_gmailAttributes.js">file</a> |
<a href="/comm-central/annotate/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/test_gmailAttributes.js">annotate</a> |
<a href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/test_gmailAttributes.js">diff</a> |
<a href="/comm-central/comparison/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/test_gmailAttributes.js">comparison</a> |
<a href="/comm-central/log/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/test_gmailAttributes.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">mailnews/imap/test/unit/test_gmailOfflineMsgStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">file</a> |
<a href="/comm-central/annotate/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">annotate</a> |
<a href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">diff</a> |
<a href="/comm-central/comparison/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">comparison</a> |
<a href="/comm-central/log/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/test_listSubscribed.js">mailnews/imap/test/unit/test_listSubscribed.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/test_listSubscribed.js">file</a> |
<a href="/comm-central/annotate/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/test_listSubscribed.js">annotate</a> |
<a href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/test_listSubscribed.js">diff</a> |
<a href="/comm-central/comparison/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/test_listSubscribed.js">comparison</a> |
<a href="/comm-central/log/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/test_listSubscribed.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/xpcshell.ini">mailnews/imap/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/6996e05c74ee20a045e320d826345883f379af86/mailnews/imap/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/test/fakeserver/imapd.js">mailnews/test/fakeserver/imapd.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6996e05c74ee20a045e320d826345883f379af86/mailnews/test/fakeserver/imapd.js">file</a> |
<a href="/comm-central/annotate/6996e05c74ee20a045e320d826345883f379af86/mailnews/test/fakeserver/imapd.js">annotate</a> |
<a href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/test/fakeserver/imapd.js">diff</a> |
<a href="/comm-central/comparison/6996e05c74ee20a045e320d826345883f379af86/mailnews/test/fakeserver/imapd.js">comparison</a> |
<a href="/comm-central/log/6996e05c74ee20a045e320d826345883f379af86/mailnews/test/fakeserver/imapd.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/test/resources/IMAPpump.js">mailnews/test/resources/IMAPpump.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6996e05c74ee20a045e320d826345883f379af86/mailnews/test/resources/IMAPpump.js">file</a> |
<a href="/comm-central/annotate/6996e05c74ee20a045e320d826345883f379af86/mailnews/test/resources/IMAPpump.js">annotate</a> |
<a href="/comm-central/diff/6996e05c74ee20a045e320d826345883f379af86/mailnews/test/resources/IMAPpump.js">diff</a> |
<a href="/comm-central/comparison/6996e05c74ee20a045e320d826345883f379af86/mailnews/test/resources/IMAPpump.js">comparison</a> |
<a href="/comm-central/log/6996e05c74ee20a045e320d826345883f379af86/mailnews/test/resources/IMAPpump.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/nsMsgFolderFlags.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/nsMsgFolderFlags.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -53,17 +53,17 @@ interface nsMsgFolderFlags {</span>
<a href="#l1.4"></a><span id="l1.4">    *  not have the nsMsgFolderFlags::Directory or</span>
<a href="#l1.5"></a><span id="l1.5">    *  nsMsgFolderFlags::Elided bits set.</span>
<a href="#l1.6"></a><span id="l1.6">    *  @{</span>
<a href="#l1.7"></a><span id="l1.7">    */</span>
<a href="#l1.8"></a><span id="l1.8">   /// Whether this is the trash folder.</span>
<a href="#l1.9"></a><span id="l1.9">   const nsMsgFolderFlagType Trash           = 0x00000100;</span>
<a href="#l1.10"></a><span id="l1.10">   /// Whether this is a folder that sent mail gets delivered to.</span>
<a href="#l1.11"></a><span id="l1.11">   const nsMsgFolderFlagType SentMail        = 0x00000200;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  /// Whether this is the folder in which unfinised, unsent messages are saved for later editing.</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  /// Whether this is the folder in which unfinished, unsent messages are saved for later editing.</span>
<a href="#l1.14"></a><span id="l1.14">   const nsMsgFolderFlagType Drafts          = 0x00000400;</span>
<a href="#l1.15"></a><span id="l1.15">   /// Whether this is the folder in which messages are queued for later delivery.</span>
<a href="#l1.16"></a><span id="l1.16">   const nsMsgFolderFlagType Queue           = 0x00000800;</span>
<a href="#l1.17"></a><span id="l1.17">   /// Whether this is the primary inbox folder.</span>
<a href="#l1.18"></a><span id="l1.18">   const nsMsgFolderFlagType Inbox           = 0x00001000;</span>
<a href="#l1.19"></a><span id="l1.19">   /// Whether this folder on online IMAP</span>
<a href="#l1.20"></a><span id="l1.20">   const nsMsgFolderFlagType ImapBox         = 0x00002000;</span>
<a href="#l1.21"></a><span id="l1.21">   /// Whether this is an archive folder</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,94 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+// Test that imapd.js fakeserver correctly emulates GMail server</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+// That means X-GM-EXT-1 capability and GMail flavor XLIST</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+// per https://developers.google.com/google-apps/gmail/imap_extensions</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+// async support</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+// IMAP pump</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+setupIMAPPump(&quot;GMail&quot;);</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+// create our own hander so that we can call imapd functions directly</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+var handler;</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+// Definition of tests</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+var tests = [</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  setupMailboxes,</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  testXlist,</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+  endTest</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+]</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+// mbox mailboxes cannot contain both child mailboxes and messages, so this will</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+// be one test case.</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+function setupMailboxes()</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+{</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+  gIMAPMailbox.specialUseFlag = &quot;\\Inbox&quot;;</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;[Gmail]&quot;, {flags : [&quot;\\Noselect&quot;]});</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {specialUseFlag : &quot;\\AllMail&quot;});</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;[Gmail]/Drafts&quot;, {specialUseFlag : &quot;\\Drafts&quot;});</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;[Gmail]/Sent&quot;, {specialUseFlag : &quot;\\Sent&quot;});</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;[Gmail]/Spam&quot;, {specialUseFlag : &quot;\\Spam&quot;});</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;[Gmail]/Starred&quot;, {specialUseFlag : &quot;\\Starred&quot;});</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;[Gmail]/Trash&quot;, {specialUseFlag : &quot;\\Trash&quot;});</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;test&quot;, {});</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+  handler = gIMAPServer._handlerCreator(gIMAPDaemon);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+  let response = handler.onError('1', 'LOGIN user password');</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  do_check_true(response.indexOf('OK') &gt;= 0);</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+  // wait for imap pump to do its thing or else we get memory leaks</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+  yield false;</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+}</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+// test that 'XLIST &quot;&quot; &quot;*&quot;' returns the proper responses</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+function testXlist()</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+{</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+  let response = handler.onError('2', 'XLIST &quot;&quot; &quot;*&quot;');</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\HasNoChildren \\Inbox) &quot;/&quot; &quot;INBOX&quot;') &gt;= 0);</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\Noselect \\HasChildren) &quot;/&quot; &quot;[Gmail]&quot;') &gt;= 0);</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\HasNoChildren \\AllMail) &quot;/&quot; &quot;[Gmail]/All Mail&quot;') &gt;= 0);</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\HasNoChildren \\Drafts) &quot;/&quot; &quot;[Gmail]/Drafts&quot;') &gt;= 0);</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\HasNoChildren \\Sent) &quot;/&quot; &quot;[Gmail]/Sent&quot;') &gt;= 0);</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\HasNoChildren \\Spam) &quot;/&quot; &quot;[Gmail]/Spam&quot;') &gt;= 0);</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\HasNoChildren \\Starred) &quot;/&quot; &quot;[Gmail]/Starred&quot;') &gt;= 0);</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\HasNoChildren \\Trash) &quot;/&quot; &quot;[Gmail]/Trash&quot;') &gt;= 0);</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\HasNoChildren) &quot;/&quot; &quot;test&quot;') &gt;= 0);</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+  yield true;</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+}</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+// Cleanup at end</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+function endTest()</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+{</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+}</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+function run_test()</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+{</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+}</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+/*</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+ * helper functions</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+ */</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+function recursiveDeleteMailboxes(aMailbox)</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+{</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+  for each (var child in aMailbox.allChildren) {</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+    recursiveDeleteMailboxes(child);</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+  }</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+  gIMAPDaemon.deleteMailbox(aMailbox);</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,173 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+// Test that imapd.js fakeserver correctly implements LIST-EXTENDED imap</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+// extension (RFC 5258 - http://tools.ietf.org/html/rfc5258)</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+// async support</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+// IMAP pump</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+// Globals</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+// Dovecot is one of the servers that supports LIST-EXTENDED</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+setupIMAPPump(&quot;Dovecot&quot;);</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+// create our own hander so that we can call imapd functions directly</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+var handler;</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+// Definition of tests</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+var tests = [</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  setupMailboxes,</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+  testList,</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+  testListSelectSubscribed,</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  testListReturnChilderen,</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  testListReturnSubscribed,</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  testListSelectMultiple,</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  endTest</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+]</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+// mbox mailboxes cannot contain both child mailboxes and messages, so this will</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+// be one test case.</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+function setupMailboxes()</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+{</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+  gIMAPMailbox.flags = [&quot;\\Marked&quot;, &quot;\\NoInferiors&quot;];</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+  gIMAPMailbox.subscribed = true;</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;Fruit&quot;, {});</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;Fruit/Apple&quot;, {});</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;Fruit/Banana&quot;, {subscribed : true});</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;Fruit/Peach&quot;, {nonExistent : true,</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+                                            subscribed : true});</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;Tofu&quot;, {});</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;Vegetable&quot;, {subscribed : true});</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;Vegetable/Broccoli&quot;, {subscribed : true});</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;Vegetable/Corn&quot;, {});</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+  handler = gIMAPServer._handlerCreator(gIMAPDaemon);</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+  let response = handler.onError('1', 'LOGIN user password');</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+  do_check_true(response.indexOf('OK') &gt;= 0);</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+  // wait for imap pump to do it's thing or else we get memory leaks</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+  yield false;</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+}</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+// test that 'LIST &quot;&quot; &quot;*&quot;' returns the proper responses (standard LIST usage)</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+function testList()</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+{</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+  let response = handler.onError('2', 'LIST &quot;&quot; &quot;*&quot;');</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\Marked \\NoInferiors) &quot;/&quot; &quot;INBOX&quot;') &gt;= 0);</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+  do_check_true(response.indexOf('* LIST () &quot;/&quot; &quot;Fruit&quot;') &gt;= 0);</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+  do_check_true(response.indexOf('* LIST () &quot;/&quot; &quot;Fruit/Apple&quot;') &gt;= 0);</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+  do_check_true(response.indexOf('* LIST () &quot;/&quot; &quot;Fruit/Banana&quot;') &gt;= 0);</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+  do_check_true(response.indexOf('* LIST () &quot;/&quot; &quot;Tofu&quot;') &gt;= 0);</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+  do_check_true(response.indexOf('* LIST () &quot;/&quot; &quot;Vegetable&quot;') &gt;= 0);</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+  do_check_true(response.indexOf('* LIST () &quot;/&quot; &quot;Vegetable/Broccoli&quot;') &gt;= 0);</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+  do_check_true(response.indexOf('* LIST () &quot;/&quot; &quot;Vegetable/Corn&quot;') &gt;= 0);</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+  do_check_true(response.indexOf('Peach') == -1);</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+  yield true;</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+}</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+// test that 'LIST (SUBSCRIBED) &quot;&quot; &quot;*&quot;' returns the proper responses</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+function testListSelectSubscribed()</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+{</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+  let response = handler.onError('3', 'LIST (SUBSCRIBED) &quot;&quot; &quot;*&quot;');</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\Marked \\NoInferiors \\Subscribed) &quot;/&quot; &quot;INBOX&quot;') &gt;= 0);</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\Subscribed) &quot;/&quot; &quot;Fruit/Banana&quot;') &gt;= 0);</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\Subscribed \\NonExistent) &quot;/&quot; &quot;Fruit/Peach&quot;') &gt;= 0);</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\Subscribed) &quot;/&quot; &quot;Vegetable&quot;') &gt;= 0);</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\Subscribed) &quot;/&quot; &quot;Vegetable/Broccoli&quot;') &gt;= 0);</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+  do_check_true(response.indexOf('&quot;Fruit&quot;') == -1);</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+  do_check_true(response.indexOf('Apple') == -1);</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+  do_check_true(response.indexOf('Tofu') == -1);</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+  do_check_true(response.indexOf('Corn') == -1);</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+  yield true;</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+}</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+// test that 'LIST &quot;&quot; &quot;%&quot; RETURN (CHILDEREN)' returns the proper responses</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+function testListReturnChilderen()</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+{</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+  let response = handler.onError('4', 'LIST &quot;&quot; &quot;%&quot; RETURN (CHILDREN)');</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\Marked \\NoInferiors) &quot;/&quot; &quot;INBOX&quot;') &gt;= 0);</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\HasChildren) &quot;/&quot; &quot;Fruit&quot;') &gt;= 0);</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\HasNoChildren) &quot;/&quot; &quot;Tofu&quot;') &gt;= 0);</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\HasChildren) &quot;/&quot; &quot;Vegetable&quot;') &gt;= 0);</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+  do_check_true(response.indexOf('Apple') == -1);</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+  do_check_true(response.indexOf('Banana') == -1);</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+  do_check_true(response.indexOf('Peach') == -1);</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+  do_check_true(response.indexOf('Broccoli') == -1);</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+  do_check_true(response.indexOf('Corn') == -1);</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+  yield true;</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+}</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+// test that 'LIST &quot;&quot; &quot;*&quot; RETURN (SUBSCRIBED)' returns the proper responses</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+function testListReturnSubscribed()</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+{</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+  let response = handler.onError('5', 'LIST &quot;&quot; &quot;*&quot; RETURN (SUBSCRIBED)');</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\Marked \\NoInferiors \\Subscribed) &quot;/&quot; &quot;INBOX&quot;') &gt;= 0);</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+  do_check_true(response.indexOf('* LIST () &quot;/&quot; &quot;Fruit&quot;') &gt;= 0);</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+  do_check_true(response.indexOf('* LIST () &quot;/&quot; &quot;Fruit/Apple&quot;') &gt;= 0);</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\Subscribed) &quot;/&quot; &quot;Fruit/Banana&quot;') &gt;= 0);</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+  do_check_true(response.indexOf('* LIST () &quot;/&quot; &quot;Tofu&quot;') &gt;= 0);</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\Subscribed) &quot;/&quot; &quot;Vegetable&quot;') &gt;= 0);</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\Subscribed) &quot;/&quot; &quot;Vegetable/Broccoli&quot;') &gt;= 0);</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+  do_check_true(response.indexOf('* LIST () &quot;/&quot; &quot;Vegetable/Corn&quot;') &gt;= 0);</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+  do_check_true(response.indexOf('Peach') == -1);</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+  yield true;</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+}</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+// test that 'LIST &quot;&quot; (&quot;INBOX&quot; &quot;Tofu&quot; &quot;Vegetable/%&quot;)' returns the proper responses</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+function testListSelectMultiple()</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+{</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+  let response = handler._dispatchCommand('LIST', ['', '(&quot;INBOX&quot; &quot;Tofu&quot; &quot;Vegetable/%&quot;)']);</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+  do_check_true(response.indexOf('* LIST (\\Marked \\NoInferiors) &quot;/&quot; &quot;INBOX&quot;') &gt;= 0);</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+  do_check_true(response.indexOf('* LIST () &quot;/&quot; &quot;Tofu&quot;') &gt;= 0);</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+  do_check_true(response.indexOf('* LIST () &quot;/&quot; &quot;Vegetable/Broccoli&quot;') &gt;= 0);</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+  do_check_true(response.indexOf('* LIST () &quot;/&quot; &quot;Vegetable/Corn&quot;') &gt;= 0);</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+  do_check_true(response.indexOf('&quot;Vegetable&quot;') == -1);</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+  do_check_true(response.indexOf('Fruit') == -1);</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+  do_check_true(response.indexOf('Peach') == -1);</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+  yield true;</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+}</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+// Cleanup at end</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+function endTest()</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+{</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+  handler = null;</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+}</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+function run_test()</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+{</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+}</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+/*</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+ * helper functions</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+ */</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+function recursiveDeleteMailboxes(aMailbox)</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+{</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+  for each (var child in aMailbox.allChildren) {</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+    recursiveDeleteMailboxes(child);</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+  }</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+  gIMAPDaemon.deleteMailbox(aMailbox);</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/test/unit/xpcshell.ini</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/test/unit/xpcshell.ini</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -57,11 +57,13 @@ skip-if = os != 'mac'</span>
<a href="#l4.4"></a><span id="l4.4"> [test_searchBoolean.js]</span>
<a href="#l4.5"></a><span id="l4.5"> [test_searchChaining.js]</span>
<a href="#l4.6"></a><span id="l4.6"> [test_searchCustomTerm.js]</span>
<a href="#l4.7"></a><span id="l4.7"> [test_searchJunk.js]</span>
<a href="#l4.8"></a><span id="l4.8"> [test_searchLocalizationStrings.js]</span>
<a href="#l4.9"></a><span id="l4.9"> [test_searchTag.js]</span>
<a href="#l4.10"></a><span id="l4.10"> [test_searchUint32HdrProperty.js]</span>
<a href="#l4.11"></a><span id="l4.11"> [test_testsuite_base64.js]</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+[test_testsuite_fakeserver_imapd_gmail.js]</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+[test_testsuite_fakeserver_imapd_list-extended.js]</span>
<a href="#l4.14"></a><span id="l4.14"> [test_testsuite_fakeserverAuth.js]</span>
<a href="#l4.15"></a><span id="l4.15"> [test_viewSortByAddresses.js]</span>
<a href="#l4.16"></a><span id="l4.16"> [test_formatFileSize.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_gmailAttributes.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_gmailAttributes.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -26,35 +26,40 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> // Messages to load must have CRLF line endings, that is Windows style</span>
<a href="#l5.6"></a><span id="l5.6"> const gMessage = &quot;bugmail10&quot;; // message file used as the test message</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> const gXGmMsgid = &quot;1278455344230334865&quot;;</span>
<a href="#l5.9"></a><span id="l5.9"> const gXGmThrid = &quot;1266894439832287888&quot;;</span>
<a href="#l5.10"></a><span id="l5.10"> const gXGmLabels = '(\\Inbox \\Sent Important &quot;Muy Importante&quot; foo)';</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-var gMsgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-  .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+setupIMAPPump(&quot;GMail&quot;);</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+gIMAPMailbox.specialUseFlag = &quot;\\Inbox&quot;;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+gIMAPMailbox.subscribed = true;</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-setupIMAPPump(&quot;GMail&quot;);</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+// need all mail folder to identify this as gmail server.</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+gIMAPDaemon.createMailbox(&quot;[Gmail]&quot;, {flags : [&quot;\\NoSelect&quot;] });</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+gIMAPDaemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {subscribed : true,</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+                                               specialUseFlag : &quot;\\AllMail&quot;});</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25"> // Definition of tests</span>
<a href="#l5.26"></a><span id="l5.26"> var tests = [</span>
<a href="#l5.27"></a><span id="l5.27">   loadImapMessage,</span>
<a href="#l5.28"></a><span id="l5.28">   testFetchXGmMsgid,</span>
<a href="#l5.29"></a><span id="l5.29">   testFetchXGmThrid,</span>
<a href="#l5.30"></a><span id="l5.30">   testFetchXGmLabels,</span>
<a href="#l5.31"></a><span id="l5.31">   endTest</span>
<a href="#l5.32"></a><span id="l5.32"> ]</span>
<a href="#l5.33"></a><span id="l5.33"> </span>
<a href="#l5.34"></a><span id="l5.34"> // load and update a message in the imap fake server</span>
<a href="#l5.35"></a><span id="l5.35"> function loadImapMessage()</span>
<a href="#l5.36"></a><span id="l5.36"> {</span>
<a href="#l5.37"></a><span id="l5.37">   let message = new imapMessage(specForFileName(gMessage),</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-                          gIMAPMailbox.uidnext++, []);</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+                                gIMAPMailbox.uidnext++, []);</span>
<a href="#l5.40"></a><span id="l5.40">   message.xGmMsgid = gXGmMsgid;</span>
<a href="#l5.41"></a><span id="l5.41">   message.xGmThrid = gXGmThrid;</span>
<a href="#l5.42"></a><span id="l5.42">   message.xGmLabels = gXGmLabels;</span>
<a href="#l5.43"></a><span id="l5.43">   gIMAPMailbox.addMessage(message);</span>
<a href="#l5.44"></a><span id="l5.44">   gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l5.45"></a><span id="l5.45">   yield false;</span>
<a href="#l5.46"></a><span id="l5.46"> }</span>
<a href="#l5.47"></a><span id="l5.47"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_gmailOfflineMsgStore.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,39 +1,34 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.5"></a><span id="l6.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.6"></a><span id="l6.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> /*</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">- * Test to ensure that, in case of GMail server, fetching of a message,</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">- * which is already present in offline store of some folder, from a folder</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">- * doesn't make us add it to the offline store twice(in this case, in general it can</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">- * be any number of times).</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+ * Test to ensure that, in case of GMail server, fetching of a message, which is</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+ * already present in offline store of some folder, from a folder doesn't make</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+ * us add it to the offline store twice(in this case, in general it can be any</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ * number of times).</span>
<a href="#l6.17"></a><span id="l6.17">  *</span>
<a href="#l6.18"></a><span id="l6.18">  * Bug 721316</span>
<a href="#l6.19"></a><span id="l6.19">  *</span>
<a href="#l6.20"></a><span id="l6.20">  * See https://bugzilla.mozilla.org/show_bug.cgi?id=721316</span>
<a href="#l6.21"></a><span id="l6.21">  * for more info.</span>
<a href="#l6.22"></a><span id="l6.22">  *</span>
<a href="#l6.23"></a><span id="l6.23">  * Original Author: Atul Jangra&lt;atuljangra66@gmail.com&gt;</span>
<a href="#l6.24"></a><span id="l6.24">  */</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l6.29"></a><span id="l6.29"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l6.30"></a><span id="l6.30"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l6.35"></a><span id="l6.35"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l6.36"></a><span id="l6.36"> </span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-var gMessageGenerator = new MessageGenerator();</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-var gScenarioFactory = new MessageScenarioFactory(gMessageGenerator);</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40"> // Messages to load must have CRLF line endings, that is Windows style</span>
<a href="#l6.41"></a><span id="l6.41"> </span>
<a href="#l6.42"></a><span id="l6.42"> const gMessage1 = &quot;bugmail10&quot;; // message file used as the test message for Inbox and fooFolder</span>
<a href="#l6.43"></a><span id="l6.43"> const gXGmMsgid1 = &quot;1278455344230334865&quot;;</span>
<a href="#l6.44"></a><span id="l6.44"> const gXGmThrid1 = &quot;1266894439832287888&quot;;</span>
<a href="#l6.45"></a><span id="l6.45"> // We need to have different X-GM-LABELS for different folders. I am doing it here manually, but this issue will be tackled in Bug 781443.</span>
<a href="#l6.46"></a><span id="l6.46"> const gXGmLabels11 = '( \&quot;\\\\Sent\&quot; foo bar)'; // for message in Inbox</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineat">@@ -44,26 +39,188 @@ const gMessage2 = &quot;bugmail11&quot; // message</span>
<a href="#l6.48"></a><span id="l6.48"> const gMsgId2 = &quot;200804111417.m3BEHTk4030129@mrapp51.mozilla.org&quot;;</span>
<a href="#l6.49"></a><span id="l6.49"> const gXGmMsgid2 = &quot;1278455345230334555&quot;;</span>
<a href="#l6.50"></a><span id="l6.50"> const gXGmThrid2 = &quot;1266894639832287111&quot;;</span>
<a href="#l6.51"></a><span id="l6.51"> const gXGmLabels2 = '(\&quot;\\\\Sent\&quot;)';</span>
<a href="#l6.52"></a><span id="l6.52"> </span>
<a href="#l6.53"></a><span id="l6.53"> const nsMsgMessageFlags = Ci.nsMsgMessageFlags;</span>
<a href="#l6.54"></a><span id="l6.54"> </span>
<a href="#l6.55"></a><span id="l6.55"> var fooBox;</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-var imapInbox;</span>
<a href="#l6.57"></a><span id="l6.57"> var fooFolder;</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-var rootFolder;</span>
<a href="#l6.59"></a><span id="l6.59"> </span>
<a href="#l6.60"></a><span id="l6.60"> var gImapInboxOfflineStoreSizeInitial;</span>
<a href="#l6.61"></a><span id="l6.61"> var gImapInboxOfflineStoreSizeFinal;</span>
<a href="#l6.62"></a><span id="l6.62"> </span>
<a href="#l6.63"></a><span id="l6.63"> var gFooOfflineStoreSizeInitial;</span>
<a href="#l6.64"></a><span id="l6.64"> var gFooOfflineStoreSizeFinal;</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-// We use this as a display consumer</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+var tests = [</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+  setup,</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+  updateFolder,</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+  selectInboxMsg,</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+  StreamMessageInbox,</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+  createAndUpdate,</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+  addFoo,</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+  updateFoo,</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+  selectFooMsg,</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+  StreamMessageFoo,</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+  crossStreaming,</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+  teardown</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+]</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+function setup() {</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+  // We aren't interested in downloading messages automatically</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.server1.offline_download&quot;, true);</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, false);</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+  setupIMAPPump(&quot;GMail&quot;);</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+  gIMAPMailbox.specialUseFlag = &quot;\\Inbox&quot;;</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+  gIMAPMailbox.subscribed = true;</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+  // need all mail folder to identify this as gmail server.</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;[Gmail]&quot;, {flags : [&quot;\\NoSelect&quot;] });</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {subscribed : true,</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+                                                 specialUseFlag : &quot;\\AllMail&quot;});</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+  // Creating the mailbox &quot;foo&quot;</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;foo&quot;, {subscribed : true});</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+  fooBox = gIMAPDaemon.getMailbox(&quot;foo&quot;);</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+  // Add message1 to inbox.</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+  message = new imapMessage(specForFileName(gMessage1),</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+                            gIMAPMailbox.uidnext++, []);</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+  message.messageId = gMsgId1;</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+  message.xGmMsgid = gXGmMsgid1;</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+  message.xGmThrid = gXGmThrid1;</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+  message.xGmLabels = gXGmLabels11; // With labels excluding &quot;//INBOX&quot;</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+  gIMAPMailbox.addMessage(message);</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+}</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+function updateFolder() {</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+  yield false;</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+}</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+function selectInboxMsg() {</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+  // Select mesasage1 from inbox which makes message1 available in offline store.</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+  let imapService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+                        .getService(Ci.nsIMsgMessageService);</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+  let db = gIMAPInbox.msgDatabase;</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+  let msg1 = db.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+  let url = new Object;</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+  imapService.DisplayMessage(gIMAPInbox.getUriForMsg(msg1), streamListener,</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+                             null, asyncUrlListener, null, url);</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+  yield false;</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+}</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+function StreamMessageInbox() {</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+  // Stream message1 from inbox</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+  let newMsgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+  let msgURI = newMsgHdr.folder.getUriForMsg(newMsgHdr);</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+  let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+  let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+  msgServ.streamMessage(msgURI, gStreamListener, null, null, false, &quot;&quot;, false);</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+  gImapInboxOfflineStoreSizeInitial = gIMAPInbox.filePath.fileSize; // Initial Size of Inbox</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+  yield false;</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+}</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+function createAndUpdate() {</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+  let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+  fooFolder =  rootFolder.getChildNamed(&quot;foo&quot;).QueryInterface(Ci.nsIMsgImapMailFolder); // We have created the mailbox earlier.</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+  fooFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+  yield false;</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+}</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+function addFoo() {</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+  // Adding our test message</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+  let message = new imapMessage(specForFileName(gMessage1),</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+                                fooBox.uidnext++, []);</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+  message.messageId = gMsgId1;</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+  message.xGmMsgid = gXGmMsgid1;</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+  message.xGmThrid = gXGmThrid1;</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+  message.xGmLabels = gXGmLabels12; // With labels excluding &quot;foo&quot;</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+  fooBox.addMessage(message);</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+  // Adding another message so that fooFolder behaves as LocalFolder while calculating it's size.</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+  let message1 = new imapMessage(specForFileName(gMessage2),</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+                                 fooBox.uidnext++, []);</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+  message1.messageId = gMsgId2;</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineplus">+  message1.xGmMsgid = gXGmMsgid2;</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+  message1.xGmThrid = gXGmThrid2;</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+  message1.xGmLabels = gXGmLabels2;</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+  fooBox.addMessage(message1);</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+}</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+function updateFoo() {</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+  fooFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+  yield false;</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+}</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+function selectFooMsg() {</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+  // Select message2 from fooFolder, which makes fooFolder a local folder.</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineplus">+  let imapService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+                       .getService(Ci.nsIMsgMessageService);</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+  let msg1 = fooFolder.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+  let url = new Object;</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+  imapService.DisplayMessage(fooFolder.getUriForMsg(msg1), streamListener,</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+                             null, asyncUrlListener, null, url);</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+  yield false;</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+}</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+function StreamMessageFoo() {</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+  // Stream message2 from fooFolder</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+  let newMsgHdr = fooFolder.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineplus">+  let msgURI = newMsgHdr.folder.getUriForMsg(newMsgHdr);</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+  let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+  let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+  msgServ.streamMessage(msgURI, gStreamListener, null, null, false, &quot;&quot;, false);</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+  gFooOfflineStoreSizeInitial = fooFolder.filePath.fileSize;</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+  yield false;</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineplus">+}</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineplus">+function crossStreaming() {</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineplus">+  /**</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+   * Streaming message1 from fooFolder. message1 is present in</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+   * offline store of inbox. We now test that streaming the message1</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+   * from fooFolder does not make us add message1 to offline store of</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+   * fooFolder. We check this by comparing the sizes of inbox and fooFolder</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+   * before and after streaming.</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+   */</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineplus">+  let msg2 = fooFolder.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineplus">+  do_check_neq(msg2, null);</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineplus">+  let msgURI = fooFolder.getUriForMsg(msg2);</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+  let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+  let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+  // pass true for aLocalOnly since message should be in offline store of Inbox.</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+  msgServ.streamMessage(msgURI, gStreamListener, null, null, false, &quot;&quot;, true);</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+  gFooOfflineStoreSizeFinal = fooFolder.filePath.fileSize;</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+  gImapInboxOfflineStoreSizeFinal = gIMAPInbox.filePath.fileSize;</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+  do_check_eq(gFooOfflineStoreSizeFinal, gFooOfflineStoreSizeInitial);</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+  do_check_eq(gImapInboxOfflineStoreSizeFinal,gImapInboxOfflineStoreSizeInitial);</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+  yield false;</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+}</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+function teardown() {</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+}</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+function run_test() {</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+}</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+/*</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+ * helper functions</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+ */</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineplus">+asyncUrlListener.callback = function(aUrl, aExitCode) {</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+  do_check_eq(aExitCode, 0);</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+};</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+ // We use this as a display consumer</span>
<a href="#l6.231"></a><span id="l6.231"> var streamListener =</span>
<a href="#l6.232"></a><span id="l6.232"> {</span>
<a href="#l6.233"></a><span id="l6.233">   _data: &quot;&quot;,</span>
<a href="#l6.234"></a><span id="l6.234"> </span>
<a href="#l6.235"></a><span id="l6.235">   QueryInterface:</span>
<a href="#l6.236"></a><span id="l6.236">     XPCOMUtils.generateQI([Ci.nsIStreamListener, Ci.nsIRequestObserver]),</span>
<a href="#l6.237"></a><span id="l6.237"> </span>
<a href="#l6.238"></a><span id="l6.238">   // nsIRequestObserver</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineat">@@ -71,191 +228,25 @@ var streamListener =</span>
<a href="#l6.240"></a><span id="l6.240">   },</span>
<a href="#l6.241"></a><span id="l6.241">   onStopRequest: function(aRequest, aContext, aStatusCode) {</span>
<a href="#l6.242"></a><span id="l6.242">     do_check_eq(aStatusCode, 0);</span>
<a href="#l6.243"></a><span id="l6.243">   },</span>
<a href="#l6.244"></a><span id="l6.244"> </span>
<a href="#l6.245"></a><span id="l6.245">   // nsIStreamListener</span>
<a href="#l6.246"></a><span id="l6.246">   onDataAvailable: function(aRequest, aContext, aInputStream, aOffset, aCount) {</span>
<a href="#l6.247"></a><span id="l6.247">     let scriptStream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-                         .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineplus">+                          .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l6.250"></a><span id="l6.250"> </span>
<a href="#l6.251"></a><span id="l6.251">     scriptStream.init(aInputStream);</span>
<a href="#l6.252"></a><span id="l6.252"> </span>
<a href="#l6.253"></a><span id="l6.253">     scriptStream.read(aCount);</span>
<a href="#l6.254"></a><span id="l6.254">   }</span>
<a href="#l6.255"></a><span id="l6.255"> };</span>
<a href="#l6.256"></a><span id="l6.256"> </span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-function setup()</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-{</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-  // We aren't interested in downloading messages automatically</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.server.server1.offline_download&quot;, true);</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, false);</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineminus">-  setupIMAPPump(&quot;GMail&quot;);</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineminus">-</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineminus">-  // these hacks are required because we've created the inbox before</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineminus">-  // running initial folder discovery, and adding the folder bails</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineminus">-  // out before we set it as verified online, so we bail out, and</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineminus">-  // then remove the INBOX folder since it's not verified.</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineminus">-  gIMAPInbox.hierarchyDelimiter = '/';</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineminus">-  gIMAPInbox.verifiedAsOnlineFolder = true;</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineminus">-</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineminus">-  let imapInbox =  gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineminus">-</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineminus">-  // Creating the mailbox &quot;foo&quot;</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineminus">-  gIMAPDaemon.createMailbox(&quot;foo&quot;, {subscribed : true}, {&quot;uidnext&quot;: 150});</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-  fooBox = gIMAPDaemon.getMailbox(&quot;foo&quot;);</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineminus">-  // Add message1 to inbox.</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineminus">-  message = new imapMessage(specForFileName(gMessage1),</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineminus">-                          imapInbox.uidnext++, []);</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineminus">-  message.messageId = gMsgId1;</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-  message.xGmMsgid = gXGmMsgid1;</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-  message.xGmThrid = gXGmThrid1;</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineminus">-  message.xGmLabels = gXGmLabels11; // With labels excluding &quot;//INBOX&quot;</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineminus">-  imapInbox.addMessage(message);</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineminus">-}</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineminus">-</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineminus">-function addFoo()</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineminus">-{</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineminus">-  // Adding our test message</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineminus">-  message = new imapMessage(specForFileName(gMessage1),</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineminus">-                          fooBox.uidnext++, []);</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineminus">-  message.messageId = gMsgId1;</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineminus">-  message.xGmMsgid = gXGmMsgid1;</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineminus">-  message.xGmThrid = gXGmThrid1;</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineminus">-  message.xGmLabels = gXGmLabels12; // With labels excluding &quot;foo&quot;</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineminus">-  fooBox.addMessage(message);</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineminus">-  // Adding another message so that fooFolder behaves as LocalFolder while calculating it's size.</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineminus">-  message1 = new imapMessage(specForFileName(gMessage2),</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineminus">-                          fooBox.uidnext++, []);</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineminus">-  message1.messageId = gMsgId2;</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineminus">-  message1.xGmMsgid = gXGmMsgid2;</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineminus">-  message1.xGmThrid = gXGmThrid2;</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-  message1.xGmLabels = gXGmLabels2;</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineminus">-  fooBox.addMessage(message1);</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineminus">-}</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineminus">-</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineminus">-var gIMAPService;</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineminus">-</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineminus">-var tests = [</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineminus">-  setup,</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineminus">-  function updateFolder()</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineminus">-  {</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineminus">-    gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineminus">-    yield false;</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-  },</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineminus">-  function selectInboxMsg()</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineminus">-  {</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineminus">-    // Select mesasage1 from inbox which makes message1 available in offline store.</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-    gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineminus">-                       .getService(Ci.nsIMsgMessageService);</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineminus">-    let db = gIMAPInbox.msgDatabase;</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineminus">-    let msg1 = db.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineminus">-    let url = new Object;</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineminus">-    gIMAPService.DisplayMessage(gIMAPInbox.getUriForMsg(msg1),</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineminus">-                                            streamListener,</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineminus">-                                            null,</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineminus">-                                            asyncUrlListener,</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineminus">-                                            null,</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineminus">-                                            url);</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineminus">-    yield false;</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-  },</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineminus">-  function StreamMessageInbox()</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineminus">-  {</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineminus">-    // Stream message1 from inbox</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineminus">-    let newMsgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineminus">-    let msgURI = newMsgHdr.folder.getUriForMsg(newMsgHdr);</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineminus">-    let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineminus">-    let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineminus">-    msgServ.streamMessage(msgURI, gStreamListener, null, null, false, &quot;&quot;, false);</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineminus">-    gImapInboxOfflineStoreSizeInitial = gIMAPInbox.filePath.fileSize; // Initial Size of Inbox</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineminus">-    yield false;</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineminus">-  },</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineminus">-  function createAndUpdate()</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineminus">-  {</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineminus">-    rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineminus">-    fooFolder =  rootFolder.getChildNamed(&quot;foo&quot;).QueryInterface(Ci.nsIMsgImapMailFolder); // We have created the mailbox earlier.</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineminus">-    fooFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineminus">-    yield false;</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-  },</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineminus">-  addFoo,</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineminus">-  function updateFoo() {</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineminus">-    fooFolder.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineminus">-    yield false;</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineminus">-  },</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineminus">-  function selectFooMsg()</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineminus">-  {</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineminus">-    // Select message2 from fooFolder, which makes fooFolder a local folder.</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineminus">-    gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineminus">-                       .getService(Ci.nsIMsgMessageService);</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineminus">-    let msg1 = fooFolder.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineminus">-    let url = new Object;</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineminus">-    gIMAPService.DisplayMessage(fooFolder.getUriForMsg(msg1),</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineminus">-                                            streamListener,</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineminus">-                                            null,</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineminus">-                                            asyncUrlListener,</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineminus">-                                            null,</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineminus">-                                            url);</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineminus">-    yield false;</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineminus">-  },</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineminus">-  function StreamMessageFoo()</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineminus">-  {</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineminus">-    // Stream message2 from fooFolder</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineminus">-    let newMsgHdr = fooFolder.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineminus">-    let msgURI = newMsgHdr.folder.getUriForMsg(newMsgHdr);</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineminus">-    let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineminus">-    let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineminus">-    msgServ.streamMessage(msgURI, gStreamListener, null, null, false, &quot;&quot;, false);</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineminus">-    gFooOfflineStoreSizeInitial = fooFolder.filePath.fileSize;</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineminus">-    yield false;</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineminus">-  },</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineminus">-  function crossStreaming()</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineminus">-  {</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineminus">-    /**</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineminus">-     * Streaming message1 from fooFolder. message1 is present in</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineminus">-     * offline store of inbox. We now test that streaming the message1</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineminus">-     * from fooFolder does not make us add message1 to offline store of</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineminus">-     * fooFolder. We check this by comparing the sizes of inbox and fooFolder</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineminus">-     * before and after streaming.</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineminus">-     */</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineminus">-    let msg2 = fooFolder.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineminus">-    do_check_neq(msg2, null);</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineminus">-    let msgURI = fooFolder.getUriForMsg(msg2);</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineminus">-    let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineminus">-    let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineminus">-    // pass true for aLocalOnly since message should be in offline store of Inbox.</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineminus">-    msgServ.streamMessage(msgURI, gStreamListener, null, null, false, &quot;&quot;, true);</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineminus">-    gFooOfflineStoreSizeFinal = fooFolder.filePath.fileSize;</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineminus">-    gImapInboxOfflineStoreSizeFinal = gIMAPInbox.filePath.fileSize;</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineminus">-    do_check_eq(gFooOfflineStoreSizeFinal, gFooOfflineStoreSizeInitial);</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineminus">-    do_check_eq(gImapInboxOfflineStoreSizeFinal,gImapInboxOfflineStoreSizeInitial);</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineminus">-    yield false;</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineminus">-  },</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineminus">-  teardown</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineminus">-]</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineminus">-</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineminus">-asyncUrlListener.callback = function(aUrl, aExitCode) {</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineminus">-  do_check_eq(aExitCode, 0);</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineminus">-};</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineminus">-</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineminus">-function teardown() {</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineminus">-  teardownIMAPPump();</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineminus">-}</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineminus">-</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineminus">-function run_test() {</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineminus">-  async_run_tests(tests);</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineminus">-}</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineminus">-</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineminus">-/*</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineminus">- * helper functions</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineminus">- */</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineminus">-gStreamListener = {</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineplus">+ gStreamListener = {</span>
<a href="#l6.425"></a><span id="l6.425">   QueryInterface : XPCOMUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l6.426"></a><span id="l6.426">   _stream : null,</span>
<a href="#l6.427"></a><span id="l6.427">   _data : null,</span>
<a href="#l6.428"></a><span id="l6.428">   onStartRequest : function (aRequest, aContext) {</span>
<a href="#l6.429"></a><span id="l6.429">     this._data = &quot;&quot;;</span>
<a href="#l6.430"></a><span id="l6.430">   },</span>
<a href="#l6.431"></a><span id="l6.431">   onStopRequest : function (aRequest, aContext, aStatusCode) {</span>
<a href="#l6.432"></a><span id="l6.432">     async_driver();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/mailnews/imap/test/unit/test_listSubscribed.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,110 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+// Test that listing subscribed mailboxes uses LIST (SUBSCRIBED) instead of LSUB</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+// for servers that have LIST-EXTENDED capability</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+// see: bug 495318</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+// see: RFC 5258 - http://tools.ietf.org/html/rfc5258</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+// async support</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+// IMAP pump</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+// Globals</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+// Dovecot is one of the servers that supports LIST-EXTENDED</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+setupIMAPPump(&quot;Dovecot&quot;);</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+// Definition of tests</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+var tests = [</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+  setupMailboxes,</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+  testListSubscribed,</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+  endTest</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+]</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+// setup the mailboxes that will be used for this test</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+function setupMailboxes()</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+{</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+  gIMAPMailbox.subscribed = true;</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;folder1&quot;, {subscribed : true, flags : [&quot;\\Noselect&quot;]});</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;folder1/folder11&quot;, {subscribed : true, flags : [&quot;\\Noinferiors&quot;]});</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;folder2&quot;, {subscribed : true, nonExistent : true});</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+  gIMAPDaemon.createMailbox(&quot;folder3&quot;, {});</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+  // select the inbox to force folder discovery, etc.</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+  yield false;</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+}</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+// tests that LIST (SUBSCRIBED) returns the proper response</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+function testListSubscribed()</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+{</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+  let nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+  // check that we have \Noselect and \Noinferiors flags - these would not have</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+  // been returned if we had used LSUB instead of LIST(SUBSCRIBED)</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+  let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+  let folder1 = rootFolder.getChildNamed(&quot;folder1&quot;);</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+  do_check_true(folder1.getFlag(nsMsgFolderFlags.ImapNoselect));</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+  do_check_false(folder1.getFlag(nsMsgFolderFlags.ImapNoinferiors));</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+  // make sure the above test was not a fluke</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+  let folder11 = folder1.getChildNamed(&quot;folder11&quot;);</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+  do_check_false(folder11.getFlag(nsMsgFolderFlags.ImapNoselect));</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+  do_check_true(folder11.getFlag(nsMsgFolderFlags.ImapNoinferiors));</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  // test that \NonExistent implies \Noselect</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+  let folder2 = rootFolder.getChildNamed(&quot;folder2&quot;);</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+  do_check_true(folder1.getFlag(nsMsgFolderFlags.ImapNoselect));</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+  // should not get a folder3 since it is not subscribed</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+  let folder3;</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+  try {</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+    folder3 = rootFolder.getChildNamed(&quot;folder3&quot;);</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+  } catch (ex) {}</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+  //do_check_false(folder1.getFlag(nsMsgFolderFlags.Subscribed));</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+  do_check_null(folder3);</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+  yield true;</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+}</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+// Cleanup at end</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+function endTest()</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+{</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+}</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+function run_test()</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+{</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+}</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+/*</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+ * helper functions</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+ */</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+// given a test file, return the file uri spec</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+function specForFileName(aFileName)</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+{</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+  let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+  let msgfileuri = Services.io.newFileURI(file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+  return msgfileuri.spec;</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+}</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+function recursiveDeleteMailboxes(aMailbox)</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+{</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+  for each (var child in aMailbox.allChildren) {</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+    recursiveDeleteMailboxes(child);</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+  }</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+  gIMAPDaemon.deleteMailbox(aMailbox);</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/test/unit/xpcshell.ini</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/test/unit/xpcshell.ini</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,31 +1,33 @@</span>
<a href="#l8.4"></a><span id="l8.4"> [DEFAULT]</span>
<a href="#l8.5"></a><span id="l8.5"> head = head_server.js</span>
<a href="#l8.6"></a><span id="l8.6"> tail = tail_imap.js</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> [test_autosync_date_constraints.js]</span>
<a href="#l8.9"></a><span id="l8.9"> [test_bccProperty.js]</span>
<a href="#l8.10"></a><span id="l8.10"> [test_bug460636.js]</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+[test_chunkLastLF.js]</span>
<a href="#l8.12"></a><span id="l8.12"> [test_compactOfflineStore.js]</span>
<a href="#l8.13"></a><span id="l8.13"> [test_copyThenMove.js]</span>
<a href="#l8.14"></a><span id="l8.14"> [test_customCommandReturnsFetchResponse.js]</span>
<a href="#l8.15"></a><span id="l8.15"> [test_dod.js]</span>
<a href="#l8.16"></a><span id="l8.16"> [test_dontStatNoSelect.js]</span>
<a href="#l8.17"></a><span id="l8.17"> [test_downloadOffline.js]</span>
<a href="#l8.18"></a><span id="l8.18"> [test_fetchCustomAttribute.js]</span>
<a href="#l8.19"></a><span id="l8.19"> [test_filterCustomHeaders.js]</span>
<a href="#l8.20"></a><span id="l8.20"> [test_filterNeedsBody.js]</span>
<a href="#l8.21"></a><span id="l8.21"> [test_gmailAttributes.js]</span>
<a href="#l8.22"></a><span id="l8.22"> [test_gmailOfflineMsgStore.js]</span>
<a href="#l8.23"></a><span id="l8.23"> [test_imapAttachmentSaves.js]</span>
<a href="#l8.24"></a><span id="l8.24"> [test_imapAuthMethods.js]</span>
<a href="#l8.25"></a><span id="l8.25"> # Disabled per bug 553764</span>
<a href="#l8.26"></a><span id="l8.26"> skip-if = true</span>
<a href="#l8.27"></a><span id="l8.27"> [test_imapAutoSync.js]</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+[test_imapChunks.js]</span>
<a href="#l8.29"></a><span id="l8.29"> [test_imapContentLength.js]</span>
<a href="#l8.30"></a><span id="l8.30"> [test_imapCopyTimeout.js]</span>
<a href="#l8.31"></a><span id="l8.31"> [test_imapFilterActions.js]</span>
<a href="#l8.32"></a><span id="l8.32"> [test_imapFlagChange.js]</span>
<a href="#l8.33"></a><span id="l8.33"> [test_imapFolderCopy.js]</span>
<a href="#l8.34"></a><span id="l8.34"> [test_imapHdrChunking.js]</span>
<a href="#l8.35"></a><span id="l8.35"> [test_imapHdrStreaming.js]</span>
<a href="#l8.36"></a><span id="l8.36"> [test_imapHighWater.js]</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineat">@@ -33,32 +35,31 @@ skip-if = true</span>
<a href="#l8.38"></a><span id="l8.38"> [test_imapMove.js]</span>
<a href="#l8.39"></a><span id="l8.39"> [test_imapPasswordFailure.js]</span>
<a href="#l8.40"></a><span id="l8.40"> [test_imapProtocols.js]</span>
<a href="#l8.41"></a><span id="l8.41"> [test_imapSearch.js]</span>
<a href="#l8.42"></a><span id="l8.42"> [test_imapStatusCloseDBs.js]</span>
<a href="#l8.43"></a><span id="l8.43"> [test_imapStoreMsgOffline.js]</span>
<a href="#l8.44"></a><span id="l8.44"> [test_imapUndo.js]</span>
<a href="#l8.45"></a><span id="l8.45"> [test_imapUrls.js]</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-[test_offlineCopy.js]</span>
<a href="#l8.47"></a><span id="l8.47"> [test_largeOfflineStore.js]</span>
<a href="#l8.48"></a><span id="l8.48"> skip-if = os == 'mac'</span>
<a href="#l8.49"></a><span id="l8.49"> [test_listClosesDB.js]</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+[test_listSubscribed.js]</span>
<a href="#l8.51"></a><span id="l8.51"> [test_localToImapFilter.js]</span>
<a href="#l8.52"></a><span id="l8.52"> # Disabled due to intermittent failures, bug 502928</span>
<a href="#l8.53"></a><span id="l8.53"> skip-if = true</span>
<a href="#l8.54"></a><span id="l8.54"> [test_localToImapFilterQuarantine.js]</span>
<a href="#l8.55"></a><span id="l8.55"> [test_mailboxes.js]</span>
<a href="#l8.56"></a><span id="l8.56"> [test_nsIMsgFolderListenerIMAP.js]</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+[test_offlineCopy.js]</span>
<a href="#l8.58"></a><span id="l8.58"> [test_offlinePlayback.js]</span>
<a href="#l8.59"></a><span id="l8.59"> [test_offlineStoreLocking.js]</span>
<a href="#l8.60"></a><span id="l8.60"> # Doesn't currently work on Windows, bug 782625</span>
<a href="#l8.61"></a><span id="l8.61"> skip-if = os == &quot;win&quot;</span>
<a href="#l8.62"></a><span id="l8.62"> [test_partsOnDemand.js]</span>
<a href="#l8.63"></a><span id="l8.63"> [test_preserveDataOnMove.js]</span>
<a href="#l8.64"></a><span id="l8.64"> [test_saveImapDraft.js]</span>
<a href="#l8.65"></a><span id="l8.65"> [test_saveTemplate.js]</span>
<a href="#l8.66"></a><span id="l8.66"> [test_starttlsFailure.js]</span>
<a href="#l8.67"></a><span id="l8.67"> [test_stopMovingToLocalFolder.js]</span>
<a href="#l8.68"></a><span id="l8.68"> [test_syncChanges.js]</span>
<a href="#l8.69"></a><span id="l8.69"> [test_trustSpamAssassin.js]</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-[test_imapChunks.js]</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-[test_chunkLastLF.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/test/fakeserver/imapd.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/test/fakeserver/imapd.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -13,17 +13,17 @@</span>
<a href="#l9.4"></a><span id="l9.4"> // see similar problems, so as to make the server widely unusable. In any     //</span>
<a href="#l9.5"></a><span id="l9.5"> // case, if someone complains about not working on bugzilla, it can be added  //</span>
<a href="#l9.6"></a><span id="l9.6"> // to the test suite.                                                         //</span>
<a href="#l9.7"></a><span id="l9.7"> // So, with that in mind, this is the basic layout of the daemon:             //</span>
<a href="#l9.8"></a><span id="l9.8"> // DAEMON                                                                     //</span>
<a href="#l9.9"></a><span id="l9.9"> // + Namespaces: parentless mailboxes whose names are the namespace name. The //</span>
<a href="#l9.10"></a><span id="l9.10"> //     type of the namespace is specified by the type attribute.              //</span>
<a href="#l9.11"></a><span id="l9.11"> // + Mailboxes: imapMailbox objects with several properties. If a mailbox     //</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-// | |   property begins with a '_', then it should not be seralized  because //</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+// | |   property begins with a '_', then it should not be serialized because //</span>
<a href="#l9.14"></a><span id="l9.14"> // | |   it can be discovered from other means; in particular, a '_' does not //</span>
<a href="#l9.15"></a><span id="l9.15"> // | |   necessarily mean that it is a private property that should not be    //</span>
<a href="#l9.16"></a><span id="l9.16"> // | |   accessed. The parent of a top-level mailbox is null, not &quot;&quot;.         //</span>
<a href="#l9.17"></a><span id="l9.17"> // | + I18N names: RFC 3501 specifies a modified UTF-7 form for names.        //</span>
<a href="#l9.18"></a><span id="l9.18"> // | |     However, a draft RFC makes the names UTF-8; it is expected to be   //</span>
<a href="#l9.19"></a><span id="l9.19"> // | |     completed and implemented &quot;soon&quot;. Therefore, the correct usage is  //</span>
<a href="#l9.20"></a><span id="l9.20"> // | |     to specify the mailbox names as one normally does in JS and the    //</span>
<a href="#l9.21"></a><span id="l9.21"> // | |     protocol will take care of conversion itself.                      //</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -100,28 +100,28 @@ imapDaemon.prototype = {</span>
<a href="#l9.23"></a><span id="l9.23">       if (!mailbox)</span>
<a href="#l9.24"></a><span id="l9.24">         return null;</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26">       // Now we continue like normal</span>
<a href="#l9.27"></a><span id="l9.27">       var names = name.split(mailbox.delimiter);</span>
<a href="#l9.28"></a><span id="l9.28">       names.splice(0, 1);</span>
<a href="#l9.29"></a><span id="l9.29">       for each (var part in names) {</span>
<a href="#l9.30"></a><span id="l9.30">         mailbox = mailbox.getChild(part);</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-        if (!mailbox)</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+        if (!mailbox || mailbox.nonExistent)</span>
<a href="#l9.33"></a><span id="l9.33">           return null;</span>
<a href="#l9.34"></a><span id="l9.34">       }</span>
<a href="#l9.35"></a><span id="l9.35">       return mailbox;</span>
<a href="#l9.36"></a><span id="l9.36">     } else {</span>
<a href="#l9.37"></a><span id="l9.37">       // This is easy, just split it up using the inbox's delimiter</span>
<a href="#l9.38"></a><span id="l9.38">       var names = name.split(this.inbox.delimiter);</span>
<a href="#l9.39"></a><span id="l9.39">       var mailbox = this.root;</span>
<a href="#l9.40"></a><span id="l9.40"> </span>
<a href="#l9.41"></a><span id="l9.41">       for each (var part in names) {</span>
<a href="#l9.42"></a><span id="l9.42">         mailbox = mailbox.getChild(part);</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-        if (!mailbox)</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+        if (!mailbox || mailbox.nonExistent)</span>
<a href="#l9.45"></a><span id="l9.45">           return null;</span>
<a href="#l9.46"></a><span id="l9.46">       }</span>
<a href="#l9.47"></a><span id="l9.47">       return mailbox;</span>
<a href="#l9.48"></a><span id="l9.48">     }</span>
<a href="#l9.49"></a><span id="l9.49">   },</span>
<a href="#l9.50"></a><span id="l9.50">   createMailbox : function (name, oldBox) {</span>
<a href="#l9.51"></a><span id="l9.51">     var namespace = this.getNamespace(name);</span>
<a href="#l9.52"></a><span id="l9.52">     if (namespace.name != &quot;&quot;)</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineat">@@ -130,17 +130,17 @@ imapDaemon.prototype = {</span>
<a href="#l9.54"></a><span id="l9.54">     if (prefixes[prefixes.length-1] == '')</span>
<a href="#l9.55"></a><span id="l9.55">       var subName = prefixes.splice(prefixes.length - 2, 2)[0];</span>
<a href="#l9.56"></a><span id="l9.56">     else</span>
<a href="#l9.57"></a><span id="l9.57">       var subName = prefixes.splice(prefixes.length - 1, 1)[0];</span>
<a href="#l9.58"></a><span id="l9.58">     var box = namespace;</span>
<a href="#l9.59"></a><span id="l9.59">     for each (var component in prefixes) {</span>
<a href="#l9.60"></a><span id="l9.60">       box = box.getChild(component);</span>
<a href="#l9.61"></a><span id="l9.61">       // Yes, we won't autocreate intermediary boxes</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-      if (box == null || box.flags.indexOf('\\Noinferiors') != -1)</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+      if (box == null || box.flags.indexOf('\\NoInferiors') != -1)</span>
<a href="#l9.64"></a><span id="l9.64">         return false;</span>
<a href="#l9.65"></a><span id="l9.65">     }</span>
<a href="#l9.66"></a><span id="l9.66">     // If this is an imapMailbox...</span>
<a href="#l9.67"></a><span id="l9.67">     if (oldBox &amp;&amp; oldBox._children) {</span>
<a href="#l9.68"></a><span id="l9.68">       // Only delete now so we don't screw ourselves up if creation fails</span>
<a href="#l9.69"></a><span id="l9.69">       this.deleteMailbox(oldBox);</span>
<a href="#l9.70"></a><span id="l9.70">       oldBox._parent = box == this.root ? null : box;</span>
<a href="#l9.71"></a><span id="l9.71">       let newBox = new imapMailbox(subName, box, this.uidvalidity++);</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineat">@@ -163,17 +163,17 @@ imapDaemon.prototype = {</span>
<a href="#l9.73"></a><span id="l9.73">       // And return the new mailbox, since this is being used by people setting</span>
<a href="#l9.74"></a><span id="l9.74">       // up the daemon.</span>
<a href="#l9.75"></a><span id="l9.75">       return childBox;</span>
<a href="#l9.76"></a><span id="l9.76">     } else {</span>
<a href="#l9.77"></a><span id="l9.77">       var creatable = hasFlag(this._flags, IMAP_FLAG_NEEDS_DELIMITER) ?</span>
<a href="#l9.78"></a><span id="l9.78">                       name[name.length - 1] == namespace.delimiter :</span>
<a href="#l9.79"></a><span id="l9.79">                       true;</span>
<a href="#l9.80"></a><span id="l9.80">       var childBox = new imapMailbox(subName, box == this.root ? null : box,</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-        { flags : creatable ? [] : ['\\Noinferiors'],</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+        { flags : creatable ? [] : ['\\NoInferiors'],</span>
<a href="#l9.83"></a><span id="l9.83">           uidvalidity : this.uidvalidity++ });</span>
<a href="#l9.84"></a><span id="l9.84">       box.addMailbox(childBox);</span>
<a href="#l9.85"></a><span id="l9.85">     }</span>
<a href="#l9.86"></a><span id="l9.86">     return true;</span>
<a href="#l9.87"></a><span id="l9.87">   },</span>
<a href="#l9.88"></a><span id="l9.88">   deleteMailbox : function (mailbox) {</span>
<a href="#l9.89"></a><span id="l9.89">     if (mailbox._children.length == 0) {</span>
<a href="#l9.90"></a><span id="l9.90">       // We don't preserve the subscribed state for deleted mailboxes</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineat">@@ -202,18 +202,20 @@ function imapMailbox(name, parent, state</span>
<a href="#l9.92"></a><span id="l9.92"> </span>
<a href="#l9.93"></a><span id="l9.93">   if (!state)</span>
<a href="#l9.94"></a><span id="l9.94">     state = {};</span>
<a href="#l9.95"></a><span id="l9.95"> </span>
<a href="#l9.96"></a><span id="l9.96">   for (var prop in state)</span>
<a href="#l9.97"></a><span id="l9.97">     this[prop] = state[prop];</span>
<a href="#l9.98"></a><span id="l9.98"> </span>
<a href="#l9.99"></a><span id="l9.99">   this.setDefault(&quot;subscribed&quot;, false);</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+  this.setDefault(&quot;nonExistent&quot;, false);</span>
<a href="#l9.101"></a><span id="l9.101">   this.setDefault(&quot;delimiter&quot;, &quot;/&quot;);</span>
<a href="#l9.102"></a><span id="l9.102">   this.setDefault(&quot;flags&quot;, []);</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+  this.setDefault(&quot;specialUseFlag&quot;, &quot;&quot;);</span>
<a href="#l9.104"></a><span id="l9.104">   this.setDefault(&quot;uidnext&quot;, 1);</span>
<a href="#l9.105"></a><span id="l9.105">   this.setDefault(&quot;msgflags&quot;, [&quot;\\Seen&quot;, &quot;\\Answered&quot;, &quot;\\Flagged&quot;,</span>
<a href="#l9.106"></a><span id="l9.106">                                &quot;\\Deleted&quot;, &quot;\\Draft&quot;]);</span>
<a href="#l9.107"></a><span id="l9.107">   this.setDefault(&quot;permflags&quot;, [&quot;\\Seen&quot;, &quot;\\Answered&quot;, &quot;\\Flagged&quot;,</span>
<a href="#l9.108"></a><span id="l9.108">                                 &quot;\\Deleted&quot;, &quot;\\Draft&quot;, &quot;\\*&quot;]);</span>
<a href="#l9.109"></a><span id="l9.109"> }</span>
<a href="#l9.110"></a><span id="l9.110"> imapMailbox.prototype = {</span>
<a href="#l9.111"></a><span id="l9.111">   setDefault : function(prop, def) {</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineat">@@ -604,66 +606,157 @@ function formatArg(argument, spec) {</span>
<a href="#l9.113"></a><span id="l9.113">     argument = new Date(Date.parse(argument.replace(/-(?!\d{4}$)/g, ' ')));</span>
<a href="#l9.114"></a><span id="l9.114">   } else {</span>
<a href="#l9.115"></a><span id="l9.115">     throw &quot;Unknown spec &quot; + spec;</span>
<a href="#l9.116"></a><span id="l9.116">   }</span>
<a href="#l9.117"></a><span id="l9.117"> </span>
<a href="#l9.118"></a><span id="l9.118">   return argument;</span>
<a href="#l9.119"></a><span id="l9.119"> }</span>
<a href="#l9.120"></a><span id="l9.120"> </span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+// used by RFC 5258 and GMail (labels)</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+function parseMailboxList(aList) {</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+  // strip enclosing parentheses</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+  if (aList[0] == '(') {</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+    aList = aList.substring(1, aList.length - 1);</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+  }</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+  let mailboxList = [];</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+  for (let i = 0; i &lt; aList.length; i++) {</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+    // first, check for literals</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineplus">+    if (aList[i] == '{') {</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+      let endBracketPos = aList.indexOf('}', i);</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+      let literalLen = parseInt(aList.substring(i + 1, endBracketPos));</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineplus">+      // skip CRLF after '}'</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+      mailboxList.push(aList.substr(endBracketPos + 3, literalLen));</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+      i = endBracketPos + 3 + literalLen;</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+    }</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+    if (aList[i] == '&quot;') {</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+      let endQuotePos = i + aList.substring(i).search(/[^\\]&quot;/);</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+      mailboxList.push(aList.substring(i + 1, endQuotePos + 1)</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+                       .replace(/\\&quot;/g, '&quot;').replace(/\\\\/g, '\\'));</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+      i = endQuotePos + 2;</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+    }</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+    if (aList[i] != ' ') {</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+      let nextSpace = aList.indexOf(' ', i);</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+      if (nextSpace == -1) {</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+        mailboxList.push(aList.substring(i));</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+        i = aList.length;</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+      } else {</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+        mailboxList.push(aList.substring(i, nextSpace));</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+        i = nextSpace;</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+      }</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineplus">+    }</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+  }</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineplus">+  return mailboxList;</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineplus">+}</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+</span>
<a href="#l9.158"></a><span id="l9.158"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.159"></a><span id="l9.159"> //                              IMAP TEST SERVERS                             //</span>
<a href="#l9.160"></a><span id="l9.160"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.161"></a><span id="l9.161"> // Because of IMAP and the LEMONADE RFCs, we have a myriad of different       //</span>
<a href="#l9.162"></a><span id="l9.162"> // server configurations that we should ideally be supporting. We handle them //</span>
<a href="#l9.163"></a><span id="l9.163"> // by defining a core RFC 3501 implementation and then have different server  //</span>
<a href="#l9.164"></a><span id="l9.164"> // extensions subclass the server through functions below. However, we also   //</span>
<a href="#l9.165"></a><span id="l9.165"> // provide standard configurations for best handling.                         //</span>
<a href="#l9.166"></a><span id="l9.166"> // Configurations:                                                            //</span>
<a href="#l9.167"></a><span id="l9.167"> // * Barebones RFC 3501                                                       //</span>
<a href="#l9.168"></a><span id="l9.168"> // * Cyrus                                                                    //</span>
<a href="#l9.169"></a><span id="l9.169"> // * UW IMAP                                                                  //</span>
<a href="#l9.170"></a><span id="l9.170"> // * Courier                                                                  //</span>
<a href="#l9.171"></a><span id="l9.171"> // * Exchange                                                                 //</span>
<a href="#l9.172"></a><span id="l9.172"> // * Dovecot                                                                  //</span>
<a href="#l9.173"></a><span id="l9.173"> // * Zimbra                                                                   //</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineplus">+// * GMail                                                                    //</span>
<a href="#l9.175"></a><span id="l9.175"> // KNOWN DEVIATIONS FROM RFC 3501:                                            //</span>
<a href="#l9.176"></a><span id="l9.176"> // + The autologout timer is 3 minutes, not 30 minutes. A test with a logout  //</span>
<a href="#l9.177"></a><span id="l9.177"> //   of 30 minutes would take a very long time if it failed.                  //</span>
<a href="#l9.178"></a><span id="l9.178"> // + SEARCH (except for UNDELETED) and STARTTLS are not supported,            //</span>
<a href="#l9.179"></a><span id="l9.179"> //   nor is all of FETCH.                                                     //</span>
<a href="#l9.180"></a><span id="l9.180"> // + Concurrent mailbox access is probably compliant with a rather liberal    //</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineminus">-//   implentation of RFC 3501, although probably not what one would expect,   //</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineplus">+//   implementation of RFC 3501, although probably not what one would expect, //</span>
<a href="#l9.183"></a><span id="l9.183"> //   and certainly not what the Dovecot IMAP server tests expect.             //</span>
<a href="#l9.184"></a><span id="l9.184"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.185"></a><span id="l9.185"> </span>
<a href="#l9.186"></a><span id="l9.186"> /* IMAP Fakeserver operates in a different manner than the rest of fakeserver</span>
<a href="#l9.187"></a><span id="l9.187">  * because of some differences in the protocol. Commands are dispatched through</span>
<a href="#l9.188"></a><span id="l9.188">  * onError, which parses the message into components. Like other fakeserver</span>
<a href="#l9.189"></a><span id="l9.189">  * implementations, the command property will be called, but this time with an</span>
<a href="#l9.190"></a><span id="l9.190">  * argument that is an array of data items instead of a string representing the</span>
<a href="#l9.191"></a><span id="l9.191">  * rest of the line.</span>
<a href="#l9.192"></a><span id="l9.192">  */</span>
<a href="#l9.193"></a><span id="l9.193"> function IMAP_RFC3501_handler(daemon) {</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineplus">+</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineplus">+  this.kUsername = &quot;user&quot;;</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineplus">+  this.kPassword = &quot;password&quot;;</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineplus">+  this.kAuthSchemes = []; // Added by RFC2195 extension. Test may modify as needed.</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+  this.kCapabilities = [/*&quot;LOGINDISABLED&quot;, &quot;STARTTLS&quot;,*/]; // Test may modify as needed.</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+  this.kUidCommands = [&quot;FETCH&quot;, &quot;STORE&quot;, &quot;SEARCH&quot;, &quot;COPY&quot;];</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineplus">+</span>
<a href="#l9.201"></a><span id="l9.201">   this._daemon = daemon;</span>
<a href="#l9.202"></a><span id="l9.202">   this.closing = false;</span>
<a href="#l9.203"></a><span id="l9.203">   this.dropOnStartTLS = false;</span>
<a href="#l9.204"></a><span id="l9.204">   // map: property = auth scheme {String}, value = start function on this obj</span>
<a href="#l9.205"></a><span id="l9.205">   this._kAuthSchemeStartFunction = {};</span>
<a href="#l9.206"></a><span id="l9.206"> </span>
<a href="#l9.207"></a><span id="l9.207" class="difflineplus">+  this._enabledCommands = {</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineplus">+    // IMAP_STATE_NOT_AUTHED</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineplus">+    0: ['CAPABILITY', 'NOOP', 'LOGOUT', 'STARTTLS', 'AUTHENTICATE', 'LOGIN'],</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineplus">+    // IMAP_STATE_AUTHED</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineplus">+    1: ['CAPABILITY', 'NOOP', 'LOGOUT', 'SELECT', 'EXAMINE', 'CREATE', 'DELETE',</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineplus">+        'RENAME', 'SUBSCRIBE', 'UNSUBSCRIBE', 'LIST', 'LSUB', 'STATUS',</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineplus">+        'APPEND'],</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineplus">+    // IMAP_STATE_SELECTED</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineplus">+    2: ['CAPABILITY', 'NOOP', 'LOGOUT', 'SELECT', 'EXAMINE', 'CREATE', 'DELETE',</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineplus">+        'RENAME', 'SUBSCRIBE', 'UNSUBSCRIBE', 'LIST', 'LSUB', 'STATUS',</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineplus">+        'APPEND', 'CHECK', 'CLOSE', 'EXPUNGE', 'SEARCH', 'FETCH', 'STORE',</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineplus">+        'COPY', 'UID']</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineplus">+  };</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineplus">+  // Format explanation:</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineplus">+  // atom -&gt; UPPERCASE</span>
<a href="#l9.222"></a><span id="l9.222" class="difflineplus">+  // string -&gt; don't touch!</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineplus">+  // mailbox -&gt; Apply -&gt;UTF16 transformation with case-insensitivity stuff</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineplus">+  // flag -&gt; Titlecase (or \Titlecase, $Titlecase, etc.)</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineplus">+  // date -&gt; Make it a JSDate object</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineplus">+  // number -&gt; Make it a number, if possible</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineplus">+  // ( ) -&gt; list, apply flags as specified</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineplus">+  // [ ] -&gt; optional argument.</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineplus">+  // x|y -&gt; either x or y format.</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineplus">+  // ... -&gt; variable args, don't parse</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineplus">+  this._argFormat = {</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineplus">+    CAPABILITY : [],</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineplus">+    NOOP : [],</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineplus">+    LOGOUT : [],</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineplus">+    STARTTLS : [],</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineplus">+    AUTHENTICATE : [&quot;atom&quot;, &quot;...&quot;],</span>
<a href="#l9.237"></a><span id="l9.237" class="difflineplus">+    LOGIN : [&quot;string&quot;, &quot;string&quot;],</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineplus">+    SELECT : [&quot;mailbox&quot;],</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineplus">+    EXAMINE : [&quot;mailbox&quot;],</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineplus">+    CREATE : [&quot;mailbox&quot;],</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineplus">+    DELETE : [&quot;mailbox&quot;],</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineplus">+    RENAME : [&quot;mailbox&quot;, &quot;mailbox&quot;],</span>
<a href="#l9.243"></a><span id="l9.243" class="difflineplus">+    SUBSCRIBE : [&quot;mailbox&quot;],</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineplus">+    UNSUBSCRIBE : [&quot;mailbox&quot;],</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineplus">+    LIST : [&quot;mailbox&quot;, &quot;mailbox&quot;],</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineplus">+    LSUB : [&quot;mailbox&quot;, &quot;mailbox&quot;],</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineplus">+    STATUS : [&quot;mailbox&quot;, &quot;(atom)&quot;],</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineplus">+    APPEND : [&quot;mailbox&quot;, &quot;[(flag)]&quot;, &quot;[date]&quot;, &quot;string&quot;],</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineplus">+    CHECK : [],</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineplus">+    CLOSE : [],</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineplus">+    EXPUNGE : [],</span>
<a href="#l9.252"></a><span id="l9.252" class="difflineplus">+    SEARCH : [&quot;atom&quot;, &quot;...&quot;],</span>
<a href="#l9.253"></a><span id="l9.253" class="difflineplus">+    FETCH : [&quot;number&quot;, &quot;atom|(atom|(atom))&quot;],</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineplus">+    STORE : [&quot;number&quot;, &quot;atom&quot;, &quot;flag|(flag)&quot;],</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineplus">+    COPY : [&quot;number&quot;, &quot;mailbox&quot;],</span>
<a href="#l9.256"></a><span id="l9.256" class="difflineplus">+    UID : [&quot;atom&quot;, &quot;...&quot;]</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineplus">+  };</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineplus">+</span>
<a href="#l9.259"></a><span id="l9.259">   this.resetTest();</span>
<a href="#l9.260"></a><span id="l9.260"> }</span>
<a href="#l9.261"></a><span id="l9.261"> IMAP_RFC3501_handler.prototype = {</span>
<a href="#l9.262"></a><span id="l9.262"> </span>
<a href="#l9.263"></a><span id="l9.263" class="difflineminus">-  kUsername : &quot;user&quot;,</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineminus">-  kPassword : &quot;password&quot;,</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineminus">-  kAuthSchemes : [], // Added by RFC2195 extension. Test may modify as needed.</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineminus">-  kCapabilities : [/*&quot;LOGINDISABLED&quot;, &quot;STARTTLS&quot;,*/], // Test may modify as needed.</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineminus">-  kUidCommands : [&quot;FETCH&quot;, &quot;STORE&quot;, &quot;SEARCH&quot;, &quot;COPY&quot;],</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineminus">-</span>
<a href="#l9.269"></a><span id="l9.269">   resetTest : function() {</span>
<a href="#l9.270"></a><span id="l9.270">     this._state = IMAP_STATE_NOT_AUTHED;</span>
<a href="#l9.271"></a><span id="l9.271">     this._multiline = false;</span>
<a href="#l9.272"></a><span id="l9.272">     this._nextAuthFunction = undefined; // should be in RFC2195_ext, but too lazy</span>
<a href="#l9.273"></a><span id="l9.273">   },</span>
<a href="#l9.274"></a><span id="l9.274">   onStartup : function () {</span>
<a href="#l9.275"></a><span id="l9.275">     this._state = IMAP_STATE_NOT_AUTHED;</span>
<a href="#l9.276"></a><span id="l9.276">     return &quot;* OK IMAP4rev1 Fakeserver started up&quot;;</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineat">@@ -808,17 +901,20 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l9.278"></a><span id="l9.278"> </span>
<a href="#l9.279"></a><span id="l9.279">       if (spec == &quot;...&quot;) {</span>
<a href="#l9.280"></a><span id="l9.280">         treatedArgs = treatedArgs.concat(args);</span>
<a href="#l9.281"></a><span id="l9.281">         args = [];</span>
<a href="#l9.282"></a><span id="l9.282">         break;</span>
<a href="#l9.283"></a><span id="l9.283">       }</span>
<a href="#l9.284"></a><span id="l9.284"> </span>
<a href="#l9.285"></a><span id="l9.285">       if (args.length == 0)</span>
<a href="#l9.286"></a><span id="l9.286" class="difflineminus">-        throw &quot;BAD not enough arguments&quot;;</span>
<a href="#l9.287"></a><span id="l9.287" class="difflineplus">+        if (spec[0] == '[') // == optional arg</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineplus">+          continue;</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineplus">+        else</span>
<a href="#l9.290"></a><span id="l9.290" class="difflineplus">+          throw &quot;BAD not enough arguments&quot;;</span>
<a href="#l9.291"></a><span id="l9.291"> </span>
<a href="#l9.292"></a><span id="l9.292">       if (spec[0] == '[') {</span>
<a href="#l9.293"></a><span id="l9.293">         // We have an optional argument. See if the format matches and move on</span>
<a href="#l9.294"></a><span id="l9.294">         // if it doesn't. Ideally, we'd rethink our decision if a later</span>
<a href="#l9.295"></a><span id="l9.295">         // application turns out to be wrong, but that's ugly to do</span>
<a href="#l9.296"></a><span id="l9.296">         // iteratively. Should any IMAP extension require it, we'll have to</span>
<a href="#l9.297"></a><span id="l9.297">         // come back and change this assumption, though.</span>
<a href="#l9.298"></a><span id="l9.298">         spec = spec.substr(1, spec.length - 2);</span>
<a href="#l9.299"></a><span id="l9.299" class="difflineat">@@ -836,67 +932,16 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l9.300"></a><span id="l9.300">       } catch (e) {</span>
<a href="#l9.301"></a><span id="l9.301">         throw &quot;BAD &quot; + e;</span>
<a href="#l9.302"></a><span id="l9.302">       }</span>
<a href="#l9.303"></a><span id="l9.303">     }</span>
<a href="#l9.304"></a><span id="l9.304">     if (args.length != 0)</span>
<a href="#l9.305"></a><span id="l9.305">       throw &quot;BAD Too many arguments&quot;;</span>
<a href="#l9.306"></a><span id="l9.306">     return treatedArgs;</span>
<a href="#l9.307"></a><span id="l9.307">   },</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineminus">-  _enabledCommands : {</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineminus">-    // IMAP_STATE_NOT_AUTHED</span>
<a href="#l9.310"></a><span id="l9.310" class="difflineminus">-    0: ['CAPABILITY', 'NOOP', 'LOGOUT', 'STARTTLS', 'AUTHENTICATE', 'LOGIN'],</span>
<a href="#l9.311"></a><span id="l9.311" class="difflineminus">-    // IMAP_STATE_AUTHED</span>
<a href="#l9.312"></a><span id="l9.312" class="difflineminus">-    1: ['CAPABILITY', 'NOOP', 'LOGOUT', 'SELECT', 'EXAMINE', 'CREATE', 'DELETE',</span>
<a href="#l9.313"></a><span id="l9.313" class="difflineminus">-        'RENAME', 'SUBSCRIBE', 'UNSUBSCRIBE', 'LIST', 'LSUB', 'STATUS',</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineminus">-        'APPEND'],</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineminus">-    // IMAP_STATE_SELECTED</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineminus">-    2: ['CAPABILITY', 'NOOP', 'LOGOUT', 'SELECT', 'EXAMINE', 'CREATE', 'DELETE',</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineminus">-        'RENAME', 'SUBSCRIBE', 'UNSUBSCRIBE', 'LIST', 'LSUB', 'STATUS',</span>
<a href="#l9.318"></a><span id="l9.318" class="difflineminus">-        'APPEND', 'CHECK', 'CLOSE', 'EXPUNGE', 'SEARCH', 'FETCH', 'STORE',</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineminus">-        'COPY', 'UID']</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineminus">-  },</span>
<a href="#l9.321"></a><span id="l9.321" class="difflineminus">-  // Format explanation:</span>
<a href="#l9.322"></a><span id="l9.322" class="difflineminus">-  // atom -&gt; UPPERCASE</span>
<a href="#l9.323"></a><span id="l9.323" class="difflineminus">-  // string -&gt; don't touch!</span>
<a href="#l9.324"></a><span id="l9.324" class="difflineminus">-  // mailbox -&gt; Apply -&gt;UTF16 transformation with case-insensitivity stuff</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineminus">-  // flag -&gt; Titlecase (or \Titlecase, $Titlecase, etc.)</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineminus">-  // date -&gt; Make it a JSDate object</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineminus">-  // number -&gt; Make it a number, if possible</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineminus">-  // ( ) -&gt; list, apply flags as specified</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineminus">-  // [ ] -&gt; optional argument.</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineminus">-  // x|y -&gt; either x or y format.</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineminus">-  // ... -&gt; variable args, don't parse</span>
<a href="#l9.332"></a><span id="l9.332" class="difflineminus">-  _argFormat : {</span>
<a href="#l9.333"></a><span id="l9.333" class="difflineminus">-    CAPABILITY : [],</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineminus">-    NOOP : [],</span>
<a href="#l9.335"></a><span id="l9.335" class="difflineminus">-    LOGOUT : [],</span>
<a href="#l9.336"></a><span id="l9.336" class="difflineminus">-    STARTTLS : [],</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineminus">-    AUTHENTICATE : [&quot;atom&quot;, &quot;...&quot;],</span>
<a href="#l9.338"></a><span id="l9.338" class="difflineminus">-    LOGIN : [&quot;string&quot;, &quot;string&quot;],</span>
<a href="#l9.339"></a><span id="l9.339" class="difflineminus">-    SELECT : [&quot;mailbox&quot;],</span>
<a href="#l9.340"></a><span id="l9.340" class="difflineminus">-    EXAMINE : [&quot;mailbox&quot;],</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineminus">-    CREATE : [&quot;mailbox&quot;],</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineminus">-    DELETE : [&quot;mailbox&quot;],</span>
<a href="#l9.343"></a><span id="l9.343" class="difflineminus">-    RENAME : [&quot;mailbox&quot;, &quot;mailbox&quot;],</span>
<a href="#l9.344"></a><span id="l9.344" class="difflineminus">-    SUBSCRIBE : [&quot;mailbox&quot;],</span>
<a href="#l9.345"></a><span id="l9.345" class="difflineminus">-    UNSUBSCRIBE : [&quot;mailbox&quot;],</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineminus">-    LIST : [&quot;mailbox&quot;, &quot;mailbox&quot;],</span>
<a href="#l9.347"></a><span id="l9.347" class="difflineminus">-    LSUB : [&quot;mailbox&quot;, &quot;mailbox&quot;],</span>
<a href="#l9.348"></a><span id="l9.348" class="difflineminus">-    STATUS : [&quot;mailbox&quot;, &quot;(atom)&quot;],</span>
<a href="#l9.349"></a><span id="l9.349" class="difflineminus">-    APPEND : [&quot;mailbox&quot;, &quot;[(flag)]&quot;, &quot;[date]&quot;, &quot;string&quot;],</span>
<a href="#l9.350"></a><span id="l9.350" class="difflineminus">-    CHECK : [],</span>
<a href="#l9.351"></a><span id="l9.351" class="difflineminus">-    CLOSE : [],</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineminus">-    EXPUNGE : [],</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineminus">-    SEARCH : [&quot;atom&quot;, &quot;...&quot;],</span>
<a href="#l9.354"></a><span id="l9.354" class="difflineminus">-    FETCH : [&quot;number&quot;, &quot;atom|(atom|(atom))&quot;],</span>
<a href="#l9.355"></a><span id="l9.355" class="difflineminus">-    STORE : [&quot;number&quot;, &quot;atom&quot;, &quot;flag|(flag)&quot;],</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineminus">-    COPY : [&quot;number&quot;, &quot;mailbox&quot;],</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineminus">-    UID : [&quot;atom&quot;, &quot;...&quot;]</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineminus">-  },</span>
<a href="#l9.359"></a><span id="l9.359"> </span>
<a href="#l9.360"></a><span id="l9.360">   //////////////////////////</span>
<a href="#l9.361"></a><span id="l9.361">   //  PROTOCOL COMMANDS   //</span>
<a href="#l9.362"></a><span id="l9.362">   // (ordered as in spec) //</span>
<a href="#l9.363"></a><span id="l9.363">   //////////////////////////</span>
<a href="#l9.364"></a><span id="l9.364">   CAPABILITY : function (args) {</span>
<a href="#l9.365"></a><span id="l9.365">     var capa = &quot;* CAPABILITY IMAP4rev1 &quot; + this.kCapabilities.join(&quot; &quot;);</span>
<a href="#l9.366"></a><span id="l9.366">     if (this.kAuthSchemes.length &gt; 0)</span>
<a href="#l9.367"></a><span id="l9.367" class="difflineat">@@ -941,17 +986,16 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l9.368"></a><span id="l9.368">     if (args[0] == this.kUsername &amp;&amp;</span>
<a href="#l9.369"></a><span id="l9.369">         args[1] == this.kPassword) {</span>
<a href="#l9.370"></a><span id="l9.370">       this._state = IMAP_STATE_AUTHED;</span>
<a href="#l9.371"></a><span id="l9.371">       return &quot;OK authenticated&quot;;</span>
<a href="#l9.372"></a><span id="l9.372">     }</span>
<a href="#l9.373"></a><span id="l9.373">     else</span>
<a href="#l9.374"></a><span id="l9.374">       return &quot;BAD invalid password, I won't authenticate you&quot;;</span>
<a href="#l9.375"></a><span id="l9.375">   },</span>
<a href="#l9.376"></a><span id="l9.376" class="difflineminus">-</span>
<a href="#l9.377"></a><span id="l9.377">   SELECT : function (args) {</span>
<a href="#l9.378"></a><span id="l9.378">     var box = this._daemon.getMailbox(args[0]);</span>
<a href="#l9.379"></a><span id="l9.379">     if (!box)</span>
<a href="#l9.380"></a><span id="l9.380">       return &quot;NO no such mailbox&quot;;</span>
<a href="#l9.381"></a><span id="l9.381"> </span>
<a href="#l9.382"></a><span id="l9.382">     if (this._selectedMailbox)</span>
<a href="#l9.383"></a><span id="l9.383">       this._daemon.synchronize(this._selectedMailbox, !this._readOnly);</span>
<a href="#l9.384"></a><span id="l9.384">     this._state = IMAP_STATE_SELECTED;</span>
<a href="#l9.385"></a><span id="l9.385" class="difflineat">@@ -1039,26 +1083,80 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l9.386"></a><span id="l9.386">   },</span>
<a href="#l9.387"></a><span id="l9.387">   UNSUBSCRIBE : function (args) {</span>
<a href="#l9.388"></a><span id="l9.388">     var mailbox = this._daemon.getMailbox(args[0]);</span>
<a href="#l9.389"></a><span id="l9.389">     if (mailbox)</span>
<a href="#l9.390"></a><span id="l9.390">       mailbox.subscribed = false;</span>
<a href="#l9.391"></a><span id="l9.391">     return &quot;OK UNSUBSCRIBE completed&quot;;</span>
<a href="#l9.392"></a><span id="l9.392">   },</span>
<a href="#l9.393"></a><span id="l9.393">   LIST : function (args) {</span>
<a href="#l9.394"></a><span id="l9.394" class="difflineminus">-    var base = this._daemon.getMailbox(args[0]);</span>
<a href="#l9.395"></a><span id="l9.395" class="difflineplus">+</span>
<a href="#l9.396"></a><span id="l9.396" class="difflineplus">+    // even though this is the LIST function for RFC 3501, code for</span>
<a href="#l9.397"></a><span id="l9.397" class="difflineplus">+    // LIST-EXTENDED (RFC 5258) is included here to keep things simple and</span>
<a href="#l9.398"></a><span id="l9.398" class="difflineplus">+    // avoid duplication. We can get away with this because the _treatArgs</span>
<a href="#l9.399"></a><span id="l9.399" class="difflineplus">+    // function filters out invalid args for servers that don't support</span>
<a href="#l9.400"></a><span id="l9.400" class="difflineplus">+    // LIST-EXTENDED before they even get here.</span>
<a href="#l9.401"></a><span id="l9.401" class="difflineplus">+</span>
<a href="#l9.402"></a><span id="l9.402" class="difflineplus">+    let listFunctionName = &quot;_LIST&quot;;</span>
<a href="#l9.403"></a><span id="l9.403" class="difflineplus">+    // check for optional list selection options argument used by LIST-EXTENDED</span>
<a href="#l9.404"></a><span id="l9.404" class="difflineplus">+    // and other related RFCs</span>
<a href="#l9.405"></a><span id="l9.405" class="difflineplus">+    if (args.length == 3 || (args.length &gt; 3 &amp;&amp; args[3] == &quot;RETURN&quot;)) {</span>
<a href="#l9.406"></a><span id="l9.406" class="difflineplus">+      let selectionOptions = args.shift();</span>
<a href="#l9.407"></a><span id="l9.407" class="difflineplus">+      selectionOptions = selectionOptions.toString().split(' ');</span>
<a href="#l9.408"></a><span id="l9.408" class="difflineplus">+      selectionOptions.sort();</span>
<a href="#l9.409"></a><span id="l9.409" class="difflineplus">+      for each (let option in selectionOptions) {</span>
<a href="#l9.410"></a><span id="l9.410" class="difflineplus">+        listFunctionName += &quot;_&quot; + option.replace(/-/g, &quot;_&quot;);</span>
<a href="#l9.411"></a><span id="l9.411" class="difflineplus">+      }</span>
<a href="#l9.412"></a><span id="l9.412" class="difflineplus">+    }</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineplus">+    // check for optional list return options argument used by LIST-EXTENDED</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineplus">+    // and other related RFCs</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineplus">+    if ((args[2] == &quot;RETURN&quot;) ||</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineplus">+        this.kCapabilities.indexOf(&quot;CHILDREN&quot;) &gt;= 0) {</span>
<a href="#l9.417"></a><span id="l9.417" class="difflineplus">+      listFunctionName += &quot;_RETURN&quot;;</span>
<a href="#l9.418"></a><span id="l9.418" class="difflineplus">+      let returnOptions = args[3] ? args[3].toString().split(' ') : [];</span>
<a href="#l9.419"></a><span id="l9.419" class="difflineplus">+      if ((this.kCapabilities.indexOf(&quot;CHILDREN&quot;) &gt;= 0) &amp;&amp;</span>
<a href="#l9.420"></a><span id="l9.420" class="difflineplus">+          (returnOptions.indexOf(&quot;CHILDREN&quot;) == -1)) {</span>
<a href="#l9.421"></a><span id="l9.421" class="difflineplus">+        returnOptions.push(&quot;CHILDREN&quot;);</span>
<a href="#l9.422"></a><span id="l9.422" class="difflineplus">+      }</span>
<a href="#l9.423"></a><span id="l9.423" class="difflineplus">+      returnOptions.sort();</span>
<a href="#l9.424"></a><span id="l9.424" class="difflineplus">+      for each (let option in returnOptions) {</span>
<a href="#l9.425"></a><span id="l9.425" class="difflineplus">+        listFunctionName += &quot;_&quot; + option.replace(/-/g, &quot;_&quot;);</span>
<a href="#l9.426"></a><span id="l9.426" class="difflineplus">+      }</span>
<a href="#l9.427"></a><span id="l9.427" class="difflineplus">+    }</span>
<a href="#l9.428"></a><span id="l9.428" class="difflineplus">+    if (!this[listFunctionName])</span>
<a href="#l9.429"></a><span id="l9.429" class="difflineplus">+      return 'BAD unknown LIST request options';</span>
<a href="#l9.430"></a><span id="l9.430" class="difflineplus">+</span>
<a href="#l9.431"></a><span id="l9.431" class="difflineplus">+    let base = this._daemon.getMailbox(args[0]);</span>
<a href="#l9.432"></a><span id="l9.432">     if (!base)</span>
<a href="#l9.433"></a><span id="l9.433">       return &quot;NO no such mailbox&quot;;</span>
<a href="#l9.434"></a><span id="l9.434" class="difflineminus">-    var people = base.matchKids(args[1]);</span>
<a href="#l9.435"></a><span id="l9.435" class="difflineminus">-    var response = &quot;&quot;;</span>
<a href="#l9.436"></a><span id="l9.436" class="difflineminus">-    for each (var box in people)</span>
<a href="#l9.437"></a><span id="l9.437" class="difflineminus">-      response += '* LIST (' + box.flags.join(&quot; &quot;) + ') &quot;' + box.delimiter +</span>
<a href="#l9.438"></a><span id="l9.438" class="difflineminus">-                  '&quot; &quot;' + box.displayName + '&quot;\0';</span>
<a href="#l9.439"></a><span id="l9.439" class="difflineplus">+    let requestedBoxes;</span>
<a href="#l9.440"></a><span id="l9.440" class="difflineplus">+    // check for multiple mailbox patterns used by LIST-EXTENDED</span>
<a href="#l9.441"></a><span id="l9.441" class="difflineplus">+    // and other related RFCs</span>
<a href="#l9.442"></a><span id="l9.442" class="difflineplus">+    if (args[1][0] == &quot;(&quot;) {</span>
<a href="#l9.443"></a><span id="l9.443" class="difflineplus">+      requestedBoxes = parseMailboxList(args[1]);</span>
<a href="#l9.444"></a><span id="l9.444" class="difflineplus">+    } else {</span>
<a href="#l9.445"></a><span id="l9.445" class="difflineplus">+      requestedBoxes = [ args[1] ];</span>
<a href="#l9.446"></a><span id="l9.446" class="difflineplus">+    }</span>
<a href="#l9.447"></a><span id="l9.447" class="difflineplus">+    let response = &quot;&quot;;</span>
<a href="#l9.448"></a><span id="l9.448" class="difflineplus">+    for each (let requestedBox in requestedBoxes) {</span>
<a href="#l9.449"></a><span id="l9.449" class="difflineplus">+      let people = base.matchKids(requestedBox);</span>
<a href="#l9.450"></a><span id="l9.450" class="difflineplus">+      for each (let box in people) {</span>
<a href="#l9.451"></a><span id="l9.451" class="difflineplus">+        response += this[listFunctionName](box);</span>
<a href="#l9.452"></a><span id="l9.452" class="difflineplus">+      }</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineplus">+    }</span>
<a href="#l9.454"></a><span id="l9.454">     return response + &quot;OK LIST completed&quot;;</span>
<a href="#l9.455"></a><span id="l9.455">   },</span>
<a href="#l9.456"></a><span id="l9.456" class="difflineplus">+  // _LIST is the standard LIST command response</span>
<a href="#l9.457"></a><span id="l9.457" class="difflineplus">+  _LIST : function (aBox) {</span>
<a href="#l9.458"></a><span id="l9.458" class="difflineplus">+    if (aBox.nonExistent) {</span>
<a href="#l9.459"></a><span id="l9.459" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l9.460"></a><span id="l9.460" class="difflineplus">+    }</span>
<a href="#l9.461"></a><span id="l9.461" class="difflineplus">+    return '* LIST (' + aBox.flags.join(&quot; &quot;) + ') &quot;' + aBox.delimiter +</span>
<a href="#l9.462"></a><span id="l9.462" class="difflineplus">+           '&quot; &quot;' + aBox.displayName + '&quot;\0';</span>
<a href="#l9.463"></a><span id="l9.463" class="difflineplus">+  },</span>
<a href="#l9.464"></a><span id="l9.464">   LSUB : function (args) {</span>
<a href="#l9.465"></a><span id="l9.465">     var base = this._daemon.getMailbox(args[0]);</span>
<a href="#l9.466"></a><span id="l9.466">     if (!base)</span>
<a href="#l9.467"></a><span id="l9.467">       return &quot;NO no such mailbox&quot;;</span>
<a href="#l9.468"></a><span id="l9.468">     var people = base.matchKids(args[1]);</span>
<a href="#l9.469"></a><span id="l9.469">     var response = &quot;&quot;;</span>
<a href="#l9.470"></a><span id="l9.470">     for each (var box in people) {</span>
<a href="#l9.471"></a><span id="l9.471">       if (box.subscribed)</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineat">@@ -1210,17 +1308,17 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l9.473"></a><span id="l9.473">       response += &quot;* &quot; + ids[i] + &quot; FETCH (&quot;;</span>
<a href="#l9.474"></a><span id="l9.474">       var parts = [];</span>
<a href="#l9.475"></a><span id="l9.475">       for each (var item in items) {</span>
<a href="#l9.476"></a><span id="l9.476"> </span>
<a href="#l9.477"></a><span id="l9.477">         // Brief explanation: an item like BODY[]&lt;&gt; can't be hardcoded easily,</span>
<a href="#l9.478"></a><span id="l9.478">         // so we go for the initial alphanumeric substring, passing in the</span>
<a href="#l9.479"></a><span id="l9.479">         // actual string as an optional second part.</span>
<a href="#l9.480"></a><span id="l9.480">         var front = item.split(/[^A-Z0-9-]/, 1)[0];</span>
<a href="#l9.481"></a><span id="l9.481" class="difflineminus">-        var functionName = &quot;_FETCH_&quot; + front.replace(/-/g, &quot;_&quot;); // '-' is not allowed in js identifiers;</span>
<a href="#l9.482"></a><span id="l9.482" class="difflineplus">+        var functionName = &quot;_FETCH_&quot; + front.replace(/-/g, &quot;_&quot;);</span>
<a href="#l9.483"></a><span id="l9.483"> </span>
<a href="#l9.484"></a><span id="l9.484">         if (!(functionName in this))</span>
<a href="#l9.485"></a><span id="l9.485">           return &quot;BAD can't fetch &quot; + front;</span>
<a href="#l9.486"></a><span id="l9.486">         try {</span>
<a href="#l9.487"></a><span id="l9.487">           parts.push(this[functionName](messages[i], item));</span>
<a href="#l9.488"></a><span id="l9.488">         } catch (ex) {</span>
<a href="#l9.489"></a><span id="l9.489"> </span>
<a href="#l9.490"></a><span id="l9.490">           return &quot;BAD error in fetching: &quot;+ex;</span>
<a href="#l9.491"></a><span id="l9.491" class="difflineat">@@ -1572,66 +1670,45 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l9.492"></a><span id="l9.492">       }</span>
<a href="#l9.493"></a><span id="l9.493">       return &quot;RFC822.SIZE &quot; + length;</span>
<a href="#l9.494"></a><span id="l9.494">     } else {</span>
<a href="#l9.495"></a><span id="l9.495">       throw &quot;Unknown item &quot;+query;</span>
<a href="#l9.496"></a><span id="l9.496">     }</span>
<a href="#l9.497"></a><span id="l9.497">   },</span>
<a href="#l9.498"></a><span id="l9.498">   _FETCH_UID : function (message) {</span>
<a href="#l9.499"></a><span id="l9.499">     return &quot;UID &quot; + message.uid;</span>
<a href="#l9.500"></a><span id="l9.500" class="difflineminus">-  },</span>
<a href="#l9.501"></a><span id="l9.501" class="difflineminus">-  _FETCH_X_GM_MSGID : function (message) {</span>
<a href="#l9.502"></a><span id="l9.502" class="difflineminus">-    if (message.xGmMsgid) {</span>
<a href="#l9.503"></a><span id="l9.503" class="difflineminus">-        return &quot;X-GM-MSGID &quot; + message.xGmMsgid;</span>
<a href="#l9.504"></a><span id="l9.504" class="difflineminus">-    } else {</span>
<a href="#l9.505"></a><span id="l9.505" class="difflineminus">-        return &quot;BAD can't fetch X-GM-MSGID&quot;;</span>
<a href="#l9.506"></a><span id="l9.506" class="difflineminus">-    }</span>
<a href="#l9.507"></a><span id="l9.507" class="difflineminus">-  },</span>
<a href="#l9.508"></a><span id="l9.508" class="difflineminus">-  _FETCH_X_GM_THRID : function (message) {</span>
<a href="#l9.509"></a><span id="l9.509" class="difflineminus">-    if (message.xGmThrid) {</span>
<a href="#l9.510"></a><span id="l9.510" class="difflineminus">-        return &quot;X-GM-THRID &quot; + message.xGmThrid;</span>
<a href="#l9.511"></a><span id="l9.511" class="difflineminus">-    } else {</span>
<a href="#l9.512"></a><span id="l9.512" class="difflineminus">-        return &quot;BAD can't fetch X-GM-THRID&quot;;</span>
<a href="#l9.513"></a><span id="l9.513" class="difflineminus">-    }</span>
<a href="#l9.514"></a><span id="l9.514" class="difflineminus">-  },</span>
<a href="#l9.515"></a><span id="l9.515" class="difflineminus">-  _FETCH_X_GM_LABELS : function (message) {</span>
<a href="#l9.516"></a><span id="l9.516" class="difflineminus">-    if (message.xGmLabels) {</span>
<a href="#l9.517"></a><span id="l9.517" class="difflineminus">-        return &quot;X-GM-LABELS &quot; + message.xGmLabels;</span>
<a href="#l9.518"></a><span id="l9.518" class="difflineminus">-    } else {</span>
<a href="#l9.519"></a><span id="l9.519" class="difflineminus">-        return &quot;BAD can't fetch X-GM-LABELS&quot;;</span>
<a href="#l9.520"></a><span id="l9.520" class="difflineminus">-    }</span>
<a href="#l9.521"></a><span id="l9.521" class="difflineminus">-   }</span>
<a href="#l9.522"></a><span id="l9.522" class="difflineplus">+  }</span>
<a href="#l9.523"></a><span id="l9.523"> }</span>
<a href="#l9.524"></a><span id="l9.524"> </span>
<a href="#l9.525"></a><span id="l9.525"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.526"></a><span id="l9.526"> //                            IMAP4 RFC extensions                            //</span>
<a href="#l9.527"></a><span id="l9.527"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.528"></a><span id="l9.528"> // Since there are so many extensions to IMAP, and since these extensions are //</span>
<a href="#l9.529"></a><span id="l9.529" class="difflineminus">-// not strictly hierarchial (e.g., an RFC 2342-compliant server can also be   //</span>
<a href="#l9.530"></a><span id="l9.530" class="difflineplus">+// not strictly hierarchical (e.g., an RFC 2342-compliant server can also be  //</span>
<a href="#l9.531"></a><span id="l9.531"> // RFC 3516-compliant, but a server might only implement one of them), they   //</span>
<a href="#l9.532"></a><span id="l9.532"> // must be handled differently from other fakeserver implementations.         //</span>
<a href="#l9.533"></a><span id="l9.533"> // An extension is defined as follows: it is an object (not a function and    //</span>
<a href="#l9.534"></a><span id="l9.534"> // prototype pair!). This object is &quot;mixed&quot; into the handler via the helper   //</span>
<a href="#l9.535"></a><span id="l9.535"> // function mixinExtension, which applies appropriate magic to make the       //</span>
<a href="#l9.536"></a><span id="l9.536"> // handler compliant to the extension. Functions are added untransformed, but //</span>
<a href="#l9.537"></a><span id="l9.537"> // both arrays and objects are handled by appending the values onto the       //</span>
<a href="#l9.538"></a><span id="l9.538"> // original state of the handler. Semantics apply as for the base itself.     //</span>
<a href="#l9.539"></a><span id="l9.539"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.540"></a><span id="l9.540"> </span>
<a href="#l9.541"></a><span id="l9.541"> // Note that UIDPLUS (RFC4315) should be mixed in last (or at least after the</span>
<a href="#l9.542"></a><span id="l9.542"> // MOVE extension) because it changes behavior of that extension.</span>
<a href="#l9.543"></a><span id="l9.543"> var configurations = {</span>
<a href="#l9.544"></a><span id="l9.544" class="difflineminus">-  Cyrus: [&quot;RFC2342&quot;, &quot;RFC2195&quot;],</span>
<a href="#l9.545"></a><span id="l9.545" class="difflineplus">+  Cyrus: [&quot;RFC2342&quot;, &quot;RFC2195&quot;, &quot;RFC5258&quot;],</span>
<a href="#l9.546"></a><span id="l9.546">   UW: [&quot;RFC2342&quot;, &quot;RFC2195&quot;],</span>
<a href="#l9.547"></a><span id="l9.547" class="difflineminus">-  Dovecot: [&quot;RFC2195&quot;],</span>
<a href="#l9.548"></a><span id="l9.548" class="difflineminus">-  Zimbra: [&quot;RFC2342&quot;, &quot;RFC2195&quot;],</span>
<a href="#l9.549"></a><span id="l9.549" class="difflineplus">+  Dovecot: [&quot;RFC2195&quot;, &quot;RFC5258&quot;],</span>
<a href="#l9.550"></a><span id="l9.550" class="difflineplus">+  Zimbra: [&quot;RFC2342&quot;, &quot;RFC2195&quot;, &quot;RFC5258&quot;],</span>
<a href="#l9.551"></a><span id="l9.551">   Exchange: [&quot;RFC2342&quot;, &quot;RFC2195&quot;],</span>
<a href="#l9.552"></a><span id="l9.552">   LEMONADE: [&quot;RFC2342&quot;, &quot;RFC2195&quot;],</span>
<a href="#l9.553"></a><span id="l9.553" class="difflineminus">-  CUSTOM1: [&quot;RFCMOVE&quot;, &quot;RFC4315&quot;, &quot;RFCCUSTOM&quot;],</span>
<a href="#l9.554"></a><span id="l9.554" class="difflineminus">-  GMail: [&quot;XLIST&quot;, &quot;RFCGMAIL&quot;, &quot;RFC2197&quot;, &quot;RFC4315&quot;]</span>
<a href="#l9.555"></a><span id="l9.555" class="difflineplus">+  CUSTOM1: [&quot;MOVE&quot;, &quot;RFC4315&quot;, &quot;CUSTOM&quot;],</span>
<a href="#l9.556"></a><span id="l9.556" class="difflineplus">+  GMail: [&quot;GMAIL&quot;, &quot;RFC2197&quot;, &quot;RFC2342&quot;, &quot;RFC3348&quot;, &quot;RFC4315&quot;]</span>
<a href="#l9.557"></a><span id="l9.557"> };</span>
<a href="#l9.558"></a><span id="l9.558"> </span>
<a href="#l9.559"></a><span id="l9.559"> function mixinExtension(handler, extension) {</span>
<a href="#l9.560"></a><span id="l9.560">   if (extension.preload)</span>
<a href="#l9.561"></a><span id="l9.561">     extension.preload(handler);</span>
<a href="#l9.562"></a><span id="l9.562"> </span>
<a href="#l9.563"></a><span id="l9.563">   for (var property in extension) {</span>
<a href="#l9.564"></a><span id="l9.564">     if (property == 'preload')</span>
<a href="#l9.565"></a><span id="l9.565" class="difflineat">@@ -1650,137 +1727,54 @@ function mixinExtension(handler, extensi</span>
<a href="#l9.566"></a><span id="l9.566">         // Hack to make arrays et al. work recursively</span>
<a href="#l9.567"></a><span id="l9.567">         mixinExtension(handler[property], extension[property]);</span>
<a href="#l9.568"></a><span id="l9.568">       else</span>
<a href="#l9.569"></a><span id="l9.569">         handler[property] = extension[property];</span>
<a href="#l9.570"></a><span id="l9.570">     }</span>
<a href="#l9.571"></a><span id="l9.571">   }</span>
<a href="#l9.572"></a><span id="l9.572"> }</span>
<a href="#l9.573"></a><span id="l9.573"> </span>
<a href="#l9.574"></a><span id="l9.574" class="difflineminus">-// RFC 2342: IMAP4 Namespace</span>
<a href="#l9.575"></a><span id="l9.575" class="difflineminus">-var IMAP_RFC2342_extension = {</span>
<a href="#l9.576"></a><span id="l9.576" class="difflineminus">-  NAMESPACE : function (args) {</span>
<a href="#l9.577"></a><span id="l9.577" class="difflineminus">-    var namespaces = [[], [], []];</span>
<a href="#l9.578"></a><span id="l9.578" class="difflineminus">-    for each (var namespace in this._daemon.namespaces)</span>
<a href="#l9.579"></a><span id="l9.579" class="difflineminus">-      namespaces[namespace.type].push(namespace);</span>
<a href="#l9.580"></a><span id="l9.580" class="difflineminus">-</span>
<a href="#l9.581"></a><span id="l9.581" class="difflineminus">-    var response = &quot;* NAMESPACE&quot;;</span>
<a href="#l9.582"></a><span id="l9.582" class="difflineminus">-    for each (var type in namespaces) {</span>
<a href="#l9.583"></a><span id="l9.583" class="difflineminus">-      if (type.length == 0) {</span>
<a href="#l9.584"></a><span id="l9.584" class="difflineminus">-        response += &quot; NIL&quot;;</span>
<a href="#l9.585"></a><span id="l9.585" class="difflineminus">-        continue;</span>
<a href="#l9.586"></a><span id="l9.586" class="difflineminus">-      }</span>
<a href="#l9.587"></a><span id="l9.587" class="difflineminus">-      response += &quot; (&quot;;</span>
<a href="#l9.588"></a><span id="l9.588" class="difflineminus">-      for each (var namespace in type) {</span>
<a href="#l9.589"></a><span id="l9.589" class="difflineminus">-        response += &quot;(\&quot;&quot;;</span>
<a href="#l9.590"></a><span id="l9.590" class="difflineminus">-        response += namespace.displayName;</span>
<a href="#l9.591"></a><span id="l9.591" class="difflineminus">-        response += &quot;\&quot; \&quot;&quot;;</span>
<a href="#l9.592"></a><span id="l9.592" class="difflineminus">-        response += namespace.delimiter;</span>
<a href="#l9.593"></a><span id="l9.593" class="difflineminus">-        response += &quot;\&quot;)&quot;;</span>
<a href="#l9.594"></a><span id="l9.594" class="difflineminus">-      }</span>
<a href="#l9.595"></a><span id="l9.595" class="difflineminus">-      response += &quot;)&quot;;</span>
<a href="#l9.596"></a><span id="l9.596" class="difflineminus">-    }</span>
<a href="#l9.597"></a><span id="l9.597" class="difflineminus">-    return response;</span>
<a href="#l9.598"></a><span id="l9.598" class="difflineplus">+// Support for Gmail extensions: XLIST and X-GM-EXT-1</span>
<a href="#l9.599"></a><span id="l9.599" class="difflineplus">+var IMAP_GMAIL_extension = {</span>
<a href="#l9.600"></a><span id="l9.600" class="difflineplus">+  preload: function (toBeThis) {</span>
<a href="#l9.601"></a><span id="l9.601" class="difflineplus">+    toBeThis._preGMAIL_STORE = toBeThis.STORE;</span>
<a href="#l9.602"></a><span id="l9.602" class="difflineplus">+    toBeThis._preGMAIL_STORE_argFormat = toBeThis._argFormat.STORE;</span>
<a href="#l9.603"></a><span id="l9.603" class="difflineplus">+    toBeThis._argFormat.STORE = [&quot;number&quot;, &quot;atom&quot;, &quot;...&quot;];</span>
<a href="#l9.604"></a><span id="l9.604">   },</span>
<a href="#l9.605"></a><span id="l9.605" class="difflineminus">-  kCapabilities : [&quot;NAMESPACE&quot;],</span>
<a href="#l9.606"></a><span id="l9.606" class="difflineminus">-  _argFormat : { NAMESPACE : [] },</span>
<a href="#l9.607"></a><span id="l9.607" class="difflineminus">-  // Enabled in AUTHED and SELECTED states</span>
<a href="#l9.608"></a><span id="l9.608" class="difflineminus">-  _enabledCommands : { 1 : [&quot;NAMESPACE&quot;], 2 : [&quot;NAMESPACE&quot;] }</span>
<a href="#l9.609"></a><span id="l9.609" class="difflineminus">-};</span>
<a href="#l9.610"></a><span id="l9.610" class="difflineminus">-</span>
<a href="#l9.611"></a><span id="l9.611" class="difflineminus">-var IMAP_XLIST_extension = {</span>
<a href="#l9.612"></a><span id="l9.612" class="difflineminus">-  XLIST : function(args) {</span>
<a href="#l9.613"></a><span id="l9.613" class="difflineminus">-    var base = this._daemon.getMailbox(args[0]);</span>
<a href="#l9.614"></a><span id="l9.614" class="difflineminus">-    if (!base)</span>
<a href="#l9.615"></a><span id="l9.615" class="difflineminus">-      return &quot;NO no such mailbox&quot;;</span>
<a href="#l9.616"></a><span id="l9.616" class="difflineminus">-    if(!this._daemon.getMailbox(&quot;[Gmail]/All Mail&quot;, {subscribed : true})) {</span>
<a href="#l9.617"></a><span id="l9.617" class="difflineminus">-      // No special mailbox exist, so we will create them.</span>
<a href="#l9.618"></a><span id="l9.618" class="difflineminus">-      // Creating parent first</span>
<a href="#l9.619"></a><span id="l9.619" class="difflineminus">-      this._daemon.createMailbox(&quot;[Gmail]&quot;);</span>
<a href="#l9.620"></a><span id="l9.620" class="difflineminus">-      // now other folders inside the parent</span>
<a href="#l9.621"></a><span id="l9.621" class="difflineminus">-      this._daemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {subscribed : true});</span>
<a href="#l9.622"></a><span id="l9.622" class="difflineminus">-      this._daemon.createMailbox(&quot;[Gmail]/Sent Mail&quot;, {subscribed : true});</span>
<a href="#l9.623"></a><span id="l9.623" class="difflineminus">-      this._daemon.createMailbox(&quot;[Gmail]/Drafts&quot;, {subscribed : true});</span>
<a href="#l9.624"></a><span id="l9.624" class="difflineminus">-      this._daemon.createMailbox(&quot;[Gmail]/Starred&quot;, {subscribed : true});</span>
<a href="#l9.625"></a><span id="l9.625" class="difflineminus">-      this._daemon.createMailbox(&quot;[Gmail]/Spam&quot;, {subscribed : true});</span>
<a href="#l9.626"></a><span id="l9.626" class="difflineplus">+  XLIST : function (args) {</span>
<a href="#l9.627"></a><span id="l9.627" class="difflineplus">+    // XLIST is really just SPECIAL-USE that does not conform to RFC 6154</span>
<a href="#l9.628"></a><span id="l9.628" class="difflineplus">+    args.push(&quot;RETURN&quot;);</span>
<a href="#l9.629"></a><span id="l9.629" class="difflineplus">+    args.push(&quot;SPECIAL-USE&quot;);</span>
<a href="#l9.630"></a><span id="l9.630" class="difflineplus">+    return this.LIST(args);</span>
<a href="#l9.631"></a><span id="l9.631" class="difflineplus">+  },</span>
<a href="#l9.632"></a><span id="l9.632" class="difflineplus">+  _LIST_RETURN_CHILDREN : function (aBox) {</span>
<a href="#l9.633"></a><span id="l9.633" class="difflineplus">+    return IMAP_RFC5258_extension._LIST_RETURN_CHILDREN(aBox);</span>
<a href="#l9.634"></a><span id="l9.634" class="difflineplus">+  },</span>
<a href="#l9.635"></a><span id="l9.635" class="difflineplus">+  _LIST_RETURN_CHILDREN_SPECIAL_USE : function (aBox) {</span>
<a href="#l9.636"></a><span id="l9.636" class="difflineplus">+    if (aBox.nonExistent) {</span>
<a href="#l9.637"></a><span id="l9.637" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l9.638"></a><span id="l9.638">     }</span>
<a href="#l9.639"></a><span id="l9.639" class="difflineminus">-    var people = base.matchKids(args[1]);</span>
<a href="#l9.640"></a><span id="l9.640" class="difflineminus">-    var response = &quot;&quot;;</span>
<a href="#l9.641"></a><span id="l9.641" class="difflineminus">-    var specialFolderFlagsLookupTable = {</span>
<a href="#l9.642"></a><span id="l9.642" class="difflineminus">-      &quot;[Gmail]/All Mail&quot;: &quot;AllMail&quot;,</span>
<a href="#l9.643"></a><span id="l9.643" class="difflineminus">-      &quot;[Gmail]/Drafts&quot;: &quot;Drafts&quot;,</span>
<a href="#l9.644"></a><span id="l9.644" class="difflineminus">-      &quot;[Gmail]/Sent Mail&quot;: &quot;Sent&quot;,</span>
<a href="#l9.645"></a><span id="l9.645" class="difflineminus">-      &quot;[Gmail]/Starred&quot;: &quot;Starred&quot;,</span>
<a href="#l9.646"></a><span id="l9.646" class="difflineminus">-      &quot;[Gmail]/Spam&quot;: &quot;Spam&quot;,</span>
<a href="#l9.647"></a><span id="l9.647" class="difflineminus">-      &quot;INBOX&quot;: &quot;Inbox&quot;</span>
<a href="#l9.648"></a><span id="l9.648" class="difflineminus">-</span>
<a href="#l9.649"></a><span id="l9.649" class="difflineminus">-    };</span>
<a href="#l9.650"></a><span id="l9.650" class="difflineminus">-    for each (var box in people) {</span>
<a href="#l9.651"></a><span id="l9.651" class="difflineminus">-      let specialFlag = box.displayName in specialFolderFlagsLookupTable ?</span>
<a href="#l9.652"></a><span id="l9.652" class="difflineminus">-        ' \\' +specialFolderFlagsLookupTable[box.displayName] : ' ';</span>
<a href="#l9.653"></a><span id="l9.653" class="difflineminus">-      response += '* XLIST (' + box.flags.join(&quot; &quot;) + specialFlag + ') &quot;' +</span>
<a href="#l9.654"></a><span id="l9.654" class="difflineminus">-              box.delimiter + '&quot; &quot;' + box.displayName + '&quot;\0';</span>
<a href="#l9.655"></a><span id="l9.655" class="difflineminus">-    }</span>
<a href="#l9.656"></a><span id="l9.656" class="difflineminus">-    return response + &quot;OK XLIST completed&quot;;</span>
<a href="#l9.657"></a><span id="l9.657" class="difflineminus">-  },</span>
<a href="#l9.658"></a><span id="l9.658" class="difflineminus">-  kCapabilities : [&quot;XLIST&quot;],</span>
<a href="#l9.659"></a><span id="l9.659" class="difflineminus">-  _argFormat : { XLIST : [&quot;mailbox&quot;, &quot;mailbox&quot;]},</span>
<a href="#l9.660"></a><span id="l9.660" class="difflineminus">-  // Enabled in AUTHED and SELECTED states</span>
<a href="#l9.661"></a><span id="l9.661" class="difflineminus">-  _enabledCommands : {1 : [&quot;XLIST&quot;], 2 : [&quot;XLIST&quot;]}</span>
<a href="#l9.662"></a><span id="l9.662" class="difflineminus">-};</span>
<a href="#l9.663"></a><span id="l9.663" class="difflineminus">-</span>
<a href="#l9.664"></a><span id="l9.664" class="difflineminus">-var IMAP_RFCMOVE_extension = {</span>
<a href="#l9.665"></a><span id="l9.665" class="difflineminus">-  MOVE: function (args, uid) {</span>
<a href="#l9.666"></a><span id="l9.666" class="difflineminus">-    let messages = this._parseSequenceSet(args[0], uid);</span>
<a href="#l9.667"></a><span id="l9.667" class="difflineminus">-</span>
<a href="#l9.668"></a><span id="l9.668" class="difflineminus">-    let dest = this._daemon.getMailbox(args[1]);</span>
<a href="#l9.669"></a><span id="l9.669" class="difflineminus">-    if (!dest)</span>
<a href="#l9.670"></a><span id="l9.670" class="difflineminus">-      return &quot;NO [TRYCREATE] what mailbox?&quot;;</span>
<a href="#l9.671"></a><span id="l9.671" class="difflineminus">-</span>
<a href="#l9.672"></a><span id="l9.672" class="difflineminus">-    for each (var message in messages) {</span>
<a href="#l9.673"></a><span id="l9.673" class="difflineminus">-      let newMessage = new imapMessage(message._URI, dest.uidnext++,</span>
<a href="#l9.674"></a><span id="l9.674" class="difflineminus">-                                       message.flags);</span>
<a href="#l9.675"></a><span id="l9.675" class="difflineminus">-      newMessage.recent = false;</span>
<a href="#l9.676"></a><span id="l9.676" class="difflineminus">-      dest.addMessage(newMessage);</span>
<a href="#l9.677"></a><span id="l9.677" class="difflineminus">-    }</span>
<a href="#l9.678"></a><span id="l9.678" class="difflineminus">-    let mailbox = this._selectedMailbox;</span>
<a href="#l9.679"></a><span id="l9.679" class="difflineminus">-    let response = &quot;&quot;;</span>
<a href="#l9.680"></a><span id="l9.680" class="difflineminus">-    for (let i = messages.length - 1; i &gt;= 0; i--) {</span>
<a href="#l9.681"></a><span id="l9.681" class="difflineminus">-      let msgIndex = mailbox._messages.indexOf(messages[i]);</span>
<a href="#l9.682"></a><span id="l9.682" class="difflineminus">-      if (msgIndex != -1) {</span>
<a href="#l9.683"></a><span id="l9.683" class="difflineminus">-        response += &quot;* &quot; + (msgIndex + 1) + &quot; EXPUNGE\0&quot;;</span>
<a href="#l9.684"></a><span id="l9.684" class="difflineminus">-        mailbox._messages.splice(msgIndex, 1);</span>
<a href="#l9.685"></a><span id="l9.685" class="difflineminus">-      }</span>
<a href="#l9.686"></a><span id="l9.686" class="difflineminus">-    }</span>
<a href="#l9.687"></a><span id="l9.687" class="difflineminus">-    if (response.length &gt; 0)</span>
<a href="#l9.688"></a><span id="l9.688" class="difflineminus">-      delete mailbox.__highestuid;</span>
<a href="#l9.689"></a><span id="l9.689" class="difflineminus">-</span>
<a href="#l9.690"></a><span id="l9.690" class="difflineminus">-    return response + &quot;OK MOVE completed&quot;;</span>
<a href="#l9.691"></a><span id="l9.691" class="difflineminus">-  },</span>
<a href="#l9.692"></a><span id="l9.692" class="difflineminus">-  kCapabilities: [&quot;MOVE&quot;],</span>
<a href="#l9.693"></a><span id="l9.693" class="difflineminus">-  kUidCommands: [&quot;MOVE&quot;],</span>
<a href="#l9.694"></a><span id="l9.694" class="difflineminus">-  _argFormat: { MOVE: [&quot;number&quot;, &quot;mailbox&quot;] },</span>
<a href="#l9.695"></a><span id="l9.695" class="difflineminus">-  // Enabled in SELECTED state</span>
<a href="#l9.696"></a><span id="l9.696" class="difflineminus">-  _enabledCommands: { 2: [&quot;MOVE&quot;] }</span>
<a href="#l9.697"></a><span id="l9.697" class="difflineminus">-};</span>
<a href="#l9.698"></a><span id="l9.698" class="difflineminus">-</span>
<a href="#l9.699"></a><span id="l9.699" class="difflineminus">-// Support for Gmail extensions.</span>
<a href="#l9.700"></a><span id="l9.700" class="difflineminus">-var IMAP_RFCGMAIL_extension = {</span>
<a href="#l9.701"></a><span id="l9.701" class="difflineminus">-  preload: function (toBeThis) {</span>
<a href="#l9.702"></a><span id="l9.702" class="difflineminus">-    toBeThis._preRFCGMAIL_STORE = toBeThis.STORE;</span>
<a href="#l9.703"></a><span id="l9.703" class="difflineminus">-    toBeThis._preRFCGMAIL_STORE_argFormat = toBeThis._argFormat.STORE;</span>
<a href="#l9.704"></a><span id="l9.704" class="difflineminus">-    toBeThis._argFormat.STORE = [&quot;number&quot;, &quot;atom&quot;, &quot;...&quot;];</span>
<a href="#l9.705"></a><span id="l9.705" class="difflineplus">+    return '* LIST (' + aBox.flags.join(&quot; &quot;) +</span>
<a href="#l9.706"></a><span id="l9.706" class="difflineplus">+           ((aBox._children.length &gt; 0) ?</span>
<a href="#l9.707"></a><span id="l9.707" class="difflineplus">+            (((aBox.flags.length &gt; 0) ? ' ' : '') + '\\HasChildren') :</span>
<a href="#l9.708"></a><span id="l9.708" class="difflineplus">+            ((aBox.flags.indexOf('\\NoInferiors') == -1) ?</span>
<a href="#l9.709"></a><span id="l9.709" class="difflineplus">+             (((aBox.flags.length &gt; 0) ? ' ' : '') + '\\HasNoChildren') :</span>
<a href="#l9.710"></a><span id="l9.710" class="difflineplus">+             '')) +</span>
<a href="#l9.711"></a><span id="l9.711" class="difflineplus">+           ((aBox.specialUseFlag &amp;&amp; aBox.specialUseFlag.length &gt; 0) ?</span>
<a href="#l9.712"></a><span id="l9.712" class="difflineplus">+            (' ' + aBox.specialUseFlag) : '') +</span>
<a href="#l9.713"></a><span id="l9.713" class="difflineplus">+           ') &quot;' + aBox.delimiter +</span>
<a href="#l9.714"></a><span id="l9.714" class="difflineplus">+           '&quot; &quot;' + aBox.displayName + '&quot;\0';</span>
<a href="#l9.715"></a><span id="l9.715">   },</span>
<a href="#l9.716"></a><span id="l9.716">   STORE : function (args, uid) {</span>
<a href="#l9.717"></a><span id="l9.717">     let regex = /[+-]?FLAGS.*/;</span>
<a href="#l9.718"></a><span id="l9.718">     if (regex.test(args[1])) {</span>
<a href="#l9.719"></a><span id="l9.719">       // if we are storing flags, use the method that was overridden</span>
<a href="#l9.720"></a><span id="l9.720" class="difflineminus">-      this._argFormat = this._preRFCGMAIL_STORE_argFormat;</span>
<a href="#l9.721"></a><span id="l9.721" class="difflineplus">+      this._argFormat = this._preGMAIL_STORE_argFormat;</span>
<a href="#l9.722"></a><span id="l9.722">       args = this._treatArgs(args, &quot;STORE&quot;);</span>
<a href="#l9.723"></a><span id="l9.723" class="difflineminus">-      return this._preRFCGMAIL_STORE(args, uid);</span>
<a href="#l9.724"></a><span id="l9.724" class="difflineplus">+      return this._preGMAIL_STORE(args, uid);</span>
<a href="#l9.725"></a><span id="l9.725">     }</span>
<a href="#l9.726"></a><span id="l9.726">     // otherwise, handle gmail specific cases</span>
<a href="#l9.727"></a><span id="l9.727">     let ids = [];</span>
<a href="#l9.728"></a><span id="l9.728">     let messages = this._parseSequenceSet(args[0], uid, ids);</span>
<a href="#l9.729"></a><span id="l9.729">     args[2] = formatArg(args[2], &quot;string|(string)&quot;);</span>
<a href="#l9.730"></a><span id="l9.730">     for (let i = 0; i &lt; args[2].length; i++) {</span>
<a href="#l9.731"></a><span id="l9.731">       if (args[2][i].indexOf(' ') &gt; -1) {</span>
<a href="#l9.732"></a><span id="l9.732">         args[2][i] = '&quot;' + args[2][i] + '&quot;';</span>
<a href="#l9.733"></a><span id="l9.733" class="difflineat">@@ -1820,33 +1814,92 @@ var IMAP_RFCGMAIL_extension = {</span>
<a href="#l9.734"></a><span id="l9.734">         return &quot;BAD change what now?&quot;;</span>
<a href="#l9.735"></a><span id="l9.735">       }</span>
<a href="#l9.736"></a><span id="l9.736">       response += &quot;* &quot; + ids[i] + &quot; FETCH (X-GM-LABELS (&quot;;</span>
<a href="#l9.737"></a><span id="l9.737">       response += message.xGmLabels.join(' ');</span>
<a href="#l9.738"></a><span id="l9.738">       response += '))\0';</span>
<a href="#l9.739"></a><span id="l9.739">     }</span>
<a href="#l9.740"></a><span id="l9.740">     return response + 'OK STORE completed';</span>
<a href="#l9.741"></a><span id="l9.741">   },</span>
<a href="#l9.742"></a><span id="l9.742" class="difflineminus">-  kCapabilities: [&quot;XLIST&quot;, &quot;X-GM-EXT-1&quot;]</span>
<a href="#l9.743"></a><span id="l9.743" class="difflineplus">+  _FETCH_X_GM_MSGID : function (message) {</span>
<a href="#l9.744"></a><span id="l9.744" class="difflineplus">+    if (message.xGmMsgid) {</span>
<a href="#l9.745"></a><span id="l9.745" class="difflineplus">+        return &quot;X-GM-MSGID &quot; + message.xGmMsgid;</span>
<a href="#l9.746"></a><span id="l9.746" class="difflineplus">+    } else {</span>
<a href="#l9.747"></a><span id="l9.747" class="difflineplus">+        return &quot;BAD can't fetch X-GM-MSGID&quot;;</span>
<a href="#l9.748"></a><span id="l9.748" class="difflineplus">+    }</span>
<a href="#l9.749"></a><span id="l9.749" class="difflineplus">+  },</span>
<a href="#l9.750"></a><span id="l9.750" class="difflineplus">+  _FETCH_X_GM_THRID : function (message) {</span>
<a href="#l9.751"></a><span id="l9.751" class="difflineplus">+    if (message.xGmThrid) {</span>
<a href="#l9.752"></a><span id="l9.752" class="difflineplus">+        return &quot;X-GM-THRID &quot; + message.xGmThrid;</span>
<a href="#l9.753"></a><span id="l9.753" class="difflineplus">+    } else {</span>
<a href="#l9.754"></a><span id="l9.754" class="difflineplus">+        return &quot;BAD can't fetch X-GM-THRID&quot;;</span>
<a href="#l9.755"></a><span id="l9.755" class="difflineplus">+    }</span>
<a href="#l9.756"></a><span id="l9.756" class="difflineplus">+  },</span>
<a href="#l9.757"></a><span id="l9.757" class="difflineplus">+  _FETCH_X_GM_LABELS : function (message) {</span>
<a href="#l9.758"></a><span id="l9.758" class="difflineplus">+    if (message.xGmLabels) {</span>
<a href="#l9.759"></a><span id="l9.759" class="difflineplus">+        return &quot;X-GM-LABELS &quot; + message.xGmLabels;</span>
<a href="#l9.760"></a><span id="l9.760" class="difflineplus">+    } else {</span>
<a href="#l9.761"></a><span id="l9.761" class="difflineplus">+        return &quot;BAD can't fetch X-GM-LABELS&quot;;</span>
<a href="#l9.762"></a><span id="l9.762" class="difflineplus">+    }</span>
<a href="#l9.763"></a><span id="l9.763" class="difflineplus">+  },</span>
<a href="#l9.764"></a><span id="l9.764" class="difflineplus">+  kCapabilities: [&quot;XLIST&quot;, &quot;X-GM-EXT-1&quot;],</span>
<a href="#l9.765"></a><span id="l9.765" class="difflineplus">+  _argFormat : { XLIST : [&quot;mailbox&quot;, &quot;mailbox&quot;] },</span>
<a href="#l9.766"></a><span id="l9.766" class="difflineplus">+  // Enabled in AUTHED and SELECTED states</span>
<a href="#l9.767"></a><span id="l9.767" class="difflineplus">+  _enabledCommands : { 1 : [&quot;XLIST&quot;], 2 : [&quot;XLIST&quot;] }</span>
<a href="#l9.768"></a><span id="l9.768" class="difflineplus">+};</span>
<a href="#l9.769"></a><span id="l9.769" class="difflineplus">+</span>
<a href="#l9.770"></a><span id="l9.770" class="difflineplus">+var IMAP_MOVE_extension = {</span>
<a href="#l9.771"></a><span id="l9.771" class="difflineplus">+  MOVE: function (args, uid) {</span>
<a href="#l9.772"></a><span id="l9.772" class="difflineplus">+    let messages = this._parseSequenceSet(args[0], uid);</span>
<a href="#l9.773"></a><span id="l9.773" class="difflineplus">+</span>
<a href="#l9.774"></a><span id="l9.774" class="difflineplus">+    let dest = this._daemon.getMailbox(args[1]);</span>
<a href="#l9.775"></a><span id="l9.775" class="difflineplus">+    if (!dest)</span>
<a href="#l9.776"></a><span id="l9.776" class="difflineplus">+      return &quot;NO [TRYCREATE] what mailbox?&quot;;</span>
<a href="#l9.777"></a><span id="l9.777" class="difflineplus">+</span>
<a href="#l9.778"></a><span id="l9.778" class="difflineplus">+    for each (var message in messages) {</span>
<a href="#l9.779"></a><span id="l9.779" class="difflineplus">+      let newMessage = new imapMessage(message._URI, dest.uidnext++,</span>
<a href="#l9.780"></a><span id="l9.780" class="difflineplus">+                                       message.flags);</span>
<a href="#l9.781"></a><span id="l9.781" class="difflineplus">+      newMessage.recent = false;</span>
<a href="#l9.782"></a><span id="l9.782" class="difflineplus">+      dest.addMessage(newMessage);</span>
<a href="#l9.783"></a><span id="l9.783" class="difflineplus">+    }</span>
<a href="#l9.784"></a><span id="l9.784" class="difflineplus">+    let mailbox = this._selectedMailbox;</span>
<a href="#l9.785"></a><span id="l9.785" class="difflineplus">+    let response = &quot;&quot;;</span>
<a href="#l9.786"></a><span id="l9.786" class="difflineplus">+    for (let i = messages.length - 1; i &gt;= 0; i--) {</span>
<a href="#l9.787"></a><span id="l9.787" class="difflineplus">+      let msgIndex = mailbox._messages.indexOf(messages[i]);</span>
<a href="#l9.788"></a><span id="l9.788" class="difflineplus">+      if (msgIndex != -1) {</span>
<a href="#l9.789"></a><span id="l9.789" class="difflineplus">+        response += &quot;* &quot; + (msgIndex + 1) + &quot; EXPUNGE\0&quot;;</span>
<a href="#l9.790"></a><span id="l9.790" class="difflineplus">+        mailbox._messages.splice(msgIndex, 1);</span>
<a href="#l9.791"></a><span id="l9.791" class="difflineplus">+      }</span>
<a href="#l9.792"></a><span id="l9.792" class="difflineplus">+    }</span>
<a href="#l9.793"></a><span id="l9.793" class="difflineplus">+    if (response.length &gt; 0)</span>
<a href="#l9.794"></a><span id="l9.794" class="difflineplus">+      delete mailbox.__highestuid;</span>
<a href="#l9.795"></a><span id="l9.795" class="difflineplus">+</span>
<a href="#l9.796"></a><span id="l9.796" class="difflineplus">+    return response + &quot;OK MOVE completed&quot;;</span>
<a href="#l9.797"></a><span id="l9.797" class="difflineplus">+  },</span>
<a href="#l9.798"></a><span id="l9.798" class="difflineplus">+  kCapabilities: [&quot;MOVE&quot;],</span>
<a href="#l9.799"></a><span id="l9.799" class="difflineplus">+  kUidCommands: [&quot;MOVE&quot;],</span>
<a href="#l9.800"></a><span id="l9.800" class="difflineplus">+  _argFormat: { MOVE: [&quot;number&quot;, &quot;mailbox&quot;] },</span>
<a href="#l9.801"></a><span id="l9.801" class="difflineplus">+  // Enabled in SELECTED state</span>
<a href="#l9.802"></a><span id="l9.802" class="difflineplus">+  _enabledCommands: { 2: [&quot;MOVE&quot;] }</span>
<a href="#l9.803"></a><span id="l9.803"> };</span>
<a href="#l9.804"></a><span id="l9.804"> </span>
<a href="#l9.805"></a><span id="l9.805"> // Provides methods for testing fetchCustomAttribute and issueCustomCommand</span>
<a href="#l9.806"></a><span id="l9.806" class="difflineminus">-var IMAP_RFCCUSTOM_extension = {</span>
<a href="#l9.807"></a><span id="l9.807" class="difflineplus">+var IMAP_CUSTOM_extension = {</span>
<a href="#l9.808"></a><span id="l9.808">   preload: function (toBeThis) {</span>
<a href="#l9.809"></a><span id="l9.809" class="difflineminus">-    toBeThis._preRFCCUSTOM_STORE = toBeThis.STORE;</span>
<a href="#l9.810"></a><span id="l9.810" class="difflineminus">-    toBeThis._preRFCCUSTOM_STORE_argFormat = toBeThis._argFormat.STORE;</span>
<a href="#l9.811"></a><span id="l9.811" class="difflineplus">+    toBeThis._preCUSTOM_STORE = toBeThis.STORE;</span>
<a href="#l9.812"></a><span id="l9.812" class="difflineplus">+    toBeThis._preCUSTOM_STORE_argFormat = toBeThis._argFormat.STORE;</span>
<a href="#l9.813"></a><span id="l9.813">     toBeThis._argFormat.STORE = [&quot;number&quot;, &quot;atom&quot;, &quot;...&quot;];</span>
<a href="#l9.814"></a><span id="l9.814">   },</span>
<a href="#l9.815"></a><span id="l9.815">   STORE : function (args, uid) {</span>
<a href="#l9.816"></a><span id="l9.816">     let regex = /[+-]?FLAGS.*/;</span>
<a href="#l9.817"></a><span id="l9.817">     if (regex.test(args[1])) {</span>
<a href="#l9.818"></a><span id="l9.818">       // if we are storing flags, use the method that was overridden</span>
<a href="#l9.819"></a><span id="l9.819" class="difflineminus">-      this._argFormat = this._preRFCCUSTOM_STORE_argFormat;</span>
<a href="#l9.820"></a><span id="l9.820" class="difflineplus">+      this._argFormat = this._preCUSTOM_STORE_argFormat;</span>
<a href="#l9.821"></a><span id="l9.821">       args = this._treatArgs(args, &quot;STORE&quot;);</span>
<a href="#l9.822"></a><span id="l9.822" class="difflineminus">-      return this._preRFCCUSTOM_STORE(args, uid);</span>
<a href="#l9.823"></a><span id="l9.823" class="difflineplus">+      return this._preCUSTOM_STORE(args, uid);</span>
<a href="#l9.824"></a><span id="l9.824">     }</span>
<a href="#l9.825"></a><span id="l9.825">     // otherwise, handle custom attribute</span>
<a href="#l9.826"></a><span id="l9.826">     let ids = [];</span>
<a href="#l9.827"></a><span id="l9.827">     let messages = this._parseSequenceSet(args[0], uid, ids);</span>
<a href="#l9.828"></a><span id="l9.828">     args[2] = formatArg(args[2], &quot;string|(string)&quot;);</span>
<a href="#l9.829"></a><span id="l9.829">     for (let i = 0; i &lt; args[2].length; i++) {</span>
<a href="#l9.830"></a><span id="l9.830">       if (args[2][i].indexOf(' ') &gt; -1) {</span>
<a href="#l9.831"></a><span id="l9.831">         args[2][i] = '&quot;' + args[2][i] + '&quot;';</span>
<a href="#l9.832"></a><span id="l9.832" class="difflineat">@@ -1909,16 +1962,17 @@ var IMAP_RFCCUSTOM_extension = {</span>
<a href="#l9.833"></a><span id="l9.833">     if (message.xCustomList) {</span>
<a href="#l9.834"></a><span id="l9.834">         return &quot;X-CUSTOM-LIST (&quot; + message.xCustomList.join(' ') + &quot;)&quot;;</span>
<a href="#l9.835"></a><span id="l9.835">     } else {</span>
<a href="#l9.836"></a><span id="l9.836">         return &quot;BAD can't fetch X-CUSTOM-LIST&quot;;</span>
<a href="#l9.837"></a><span id="l9.837">     }</span>
<a href="#l9.838"></a><span id="l9.838">   },</span>
<a href="#l9.839"></a><span id="l9.839">   kCapabilities: [&quot;X-CUSTOM1&quot;]</span>
<a href="#l9.840"></a><span id="l9.840"> };</span>
<a href="#l9.841"></a><span id="l9.841" class="difflineplus">+</span>
<a href="#l9.842"></a><span id="l9.842"> // RFC 2197: ID</span>
<a href="#l9.843"></a><span id="l9.843"> var IMAP_RFC2197_extension = {</span>
<a href="#l9.844"></a><span id="l9.844">   ID: function (args) {</span>
<a href="#l9.845"></a><span id="l9.845">     let clientID = &quot;(&quot;;</span>
<a href="#l9.846"></a><span id="l9.846">     for each (let i in args)</span>
<a href="#l9.847"></a><span id="l9.847">       clientID += &quot;\&quot;&quot; + i + &quot;\&quot;&quot;;</span>
<a href="#l9.848"></a><span id="l9.848"> </span>
<a href="#l9.849"></a><span id="l9.849">     clientID += &quot;)&quot;;</span>
<a href="#l9.850"></a><span id="l9.850" class="difflineat">@@ -1931,16 +1985,53 @@ var IMAP_RFC2197_extension = {</span>
<a href="#l9.851"></a><span id="l9.851">     this._daemon.clientID = clientID;</span>
<a href="#l9.852"></a><span id="l9.852">     return &quot;* ID &quot; + this._daemon.idResponse + &quot;\0OK Success&quot;;</span>
<a href="#l9.853"></a><span id="l9.853">   },</span>
<a href="#l9.854"></a><span id="l9.854">   kCapabilities: [&quot;ID&quot;],</span>
<a href="#l9.855"></a><span id="l9.855">   _argFormat: { ID: [&quot;(string)&quot;] },</span>
<a href="#l9.856"></a><span id="l9.856">   _enabledCommands : { 1 : [&quot;ID&quot;], 2 : [&quot;ID&quot;] }</span>
<a href="#l9.857"></a><span id="l9.857"> };</span>
<a href="#l9.858"></a><span id="l9.858"> </span>
<a href="#l9.859"></a><span id="l9.859" class="difflineplus">+// RFC 2342: IMAP4 Namespace (NAMESPACE)</span>
<a href="#l9.860"></a><span id="l9.860" class="difflineplus">+var IMAP_RFC2342_extension = {</span>
<a href="#l9.861"></a><span id="l9.861" class="difflineplus">+  NAMESPACE : function (args) {</span>
<a href="#l9.862"></a><span id="l9.862" class="difflineplus">+    var namespaces = [[], [], []];</span>
<a href="#l9.863"></a><span id="l9.863" class="difflineplus">+    for each (var namespace in this._daemon.namespaces)</span>
<a href="#l9.864"></a><span id="l9.864" class="difflineplus">+      namespaces[namespace.type].push(namespace);</span>
<a href="#l9.865"></a><span id="l9.865" class="difflineplus">+</span>
<a href="#l9.866"></a><span id="l9.866" class="difflineplus">+    var response = &quot;* NAMESPACE&quot;;</span>
<a href="#l9.867"></a><span id="l9.867" class="difflineplus">+    for each (var type in namespaces) {</span>
<a href="#l9.868"></a><span id="l9.868" class="difflineplus">+      if (type.length == 0) {</span>
<a href="#l9.869"></a><span id="l9.869" class="difflineplus">+        response += &quot; NIL&quot;;</span>
<a href="#l9.870"></a><span id="l9.870" class="difflineplus">+        continue;</span>
<a href="#l9.871"></a><span id="l9.871" class="difflineplus">+      }</span>
<a href="#l9.872"></a><span id="l9.872" class="difflineplus">+      response += &quot; (&quot;;</span>
<a href="#l9.873"></a><span id="l9.873" class="difflineplus">+      for each (var namespace in type) {</span>
<a href="#l9.874"></a><span id="l9.874" class="difflineplus">+        response += &quot;(\&quot;&quot;;</span>
<a href="#l9.875"></a><span id="l9.875" class="difflineplus">+        response += namespace.displayName;</span>
<a href="#l9.876"></a><span id="l9.876" class="difflineplus">+        response += &quot;\&quot; \&quot;&quot;;</span>
<a href="#l9.877"></a><span id="l9.877" class="difflineplus">+        response += namespace.delimiter;</span>
<a href="#l9.878"></a><span id="l9.878" class="difflineplus">+        response += &quot;\&quot;)&quot;;</span>
<a href="#l9.879"></a><span id="l9.879" class="difflineplus">+      }</span>
<a href="#l9.880"></a><span id="l9.880" class="difflineplus">+      response += &quot;)&quot;;</span>
<a href="#l9.881"></a><span id="l9.881" class="difflineplus">+    }</span>
<a href="#l9.882"></a><span id="l9.882" class="difflineplus">+    response += &quot;\0OK NAMESPACE command completed&quot;;</span>
<a href="#l9.883"></a><span id="l9.883" class="difflineplus">+    return response;</span>
<a href="#l9.884"></a><span id="l9.884" class="difflineplus">+  },</span>
<a href="#l9.885"></a><span id="l9.885" class="difflineplus">+  kCapabilities : [&quot;NAMESPACE&quot;],</span>
<a href="#l9.886"></a><span id="l9.886" class="difflineplus">+  _argFormat : { NAMESPACE : [] },</span>
<a href="#l9.887"></a><span id="l9.887" class="difflineplus">+  // Enabled in AUTHED and SELECTED states</span>
<a href="#l9.888"></a><span id="l9.888" class="difflineplus">+  _enabledCommands : { 1 : [&quot;NAMESPACE&quot;], 2 : [&quot;NAMESPACE&quot;] }</span>
<a href="#l9.889"></a><span id="l9.889" class="difflineplus">+};</span>
<a href="#l9.890"></a><span id="l9.890" class="difflineplus">+</span>
<a href="#l9.891"></a><span id="l9.891" class="difflineplus">+// RFC 3348 Child Mailbox (CHILDREN)</span>
<a href="#l9.892"></a><span id="l9.892" class="difflineplus">+var IMAP_RFC3348_extension = {</span>
<a href="#l9.893"></a><span id="l9.893" class="difflineplus">+  kCapabilities: [&quot;CHILDREN&quot;]</span>
<a href="#l9.894"></a><span id="l9.894" class="difflineplus">+}</span>
<a href="#l9.895"></a><span id="l9.895" class="difflineplus">+</span>
<a href="#l9.896"></a><span id="l9.896"> // RFC 4315: UIDPLUS</span>
<a href="#l9.897"></a><span id="l9.897"> var IMAP_RFC4315_extension = {</span>
<a href="#l9.898"></a><span id="l9.898">   preload: function (toBeThis) {</span>
<a href="#l9.899"></a><span id="l9.899">     toBeThis._preRFC4315UID = toBeThis.UID;</span>
<a href="#l9.900"></a><span id="l9.900">     toBeThis._preRFC4315APPEND = toBeThis.APPEND;</span>
<a href="#l9.901"></a><span id="l9.901">     toBeThis._preRFC4315COPY = toBeThis.COPY;</span>
<a href="#l9.902"></a><span id="l9.902">     toBeThis._preRFC4315MOVE = toBeThis.MOVE;</span>
<a href="#l9.903"></a><span id="l9.903">   },</span>
<a href="#l9.904"></a><span id="l9.904" class="difflineat">@@ -1984,16 +2075,57 @@ var IMAP_RFC4315_extension = {</span>
<a href="#l9.905"></a><span id="l9.905">                             &quot; &quot; + args[0] + &quot; &quot; + first + &quot;:&quot; + last + &quot;]&quot;,</span>
<a href="#l9.906"></a><span id="l9.906">                          &quot;&quot;);</span>
<a href="#l9.907"></a><span id="l9.907">     }</span>
<a href="#l9.908"></a><span id="l9.908">     return response;</span>
<a href="#l9.909"></a><span id="l9.909">   },</span>
<a href="#l9.910"></a><span id="l9.910">   kCapabilities: [&quot;UIDPLUS&quot;]</span>
<a href="#l9.911"></a><span id="l9.911"> };</span>
<a href="#l9.912"></a><span id="l9.912"> </span>
<a href="#l9.913"></a><span id="l9.913" class="difflineplus">+// RFC 5258: LIST-EXTENDED</span>
<a href="#l9.914"></a><span id="l9.914" class="difflineplus">+var IMAP_RFC5258_extension = {</span>
<a href="#l9.915"></a><span id="l9.915" class="difflineplus">+  preload: function (toBeThis) {</span>
<a href="#l9.916"></a><span id="l9.916" class="difflineplus">+    toBeThis._argFormat.LIST = [&quot;[(atom)]&quot;, &quot;mailbox&quot;, &quot;mailbox|(mailbox)&quot;,</span>
<a href="#l9.917"></a><span id="l9.917" class="difflineplus">+                                &quot;[atom]&quot;, &quot;[(atom)]&quot;];</span>
<a href="#l9.918"></a><span id="l9.918" class="difflineplus">+  },</span>
<a href="#l9.919"></a><span id="l9.919" class="difflineplus">+  _LIST_SUBSCRIBED : function (aBox) {</span>
<a href="#l9.920"></a><span id="l9.920" class="difflineplus">+    if (!aBox.subscribed) {</span>
<a href="#l9.921"></a><span id="l9.921" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l9.922"></a><span id="l9.922" class="difflineplus">+    }</span>
<a href="#l9.923"></a><span id="l9.923" class="difflineplus">+    return '* LIST (' + aBox.flags.join(&quot; &quot;) +</span>
<a href="#l9.924"></a><span id="l9.924" class="difflineplus">+           ((aBox.flags.length &gt; 0) ? ' ' : '') + '\\Subscribed' +</span>
<a href="#l9.925"></a><span id="l9.925" class="difflineplus">+           (aBox.nonExistent ? ' \\NonExistent' : '') + ') &quot;' +</span>
<a href="#l9.926"></a><span id="l9.926" class="difflineplus">+           aBox.delimiter + '&quot; &quot;' + aBox.displayName + '&quot;\0';</span>
<a href="#l9.927"></a><span id="l9.927" class="difflineplus">+  },</span>
<a href="#l9.928"></a><span id="l9.928" class="difflineplus">+  _LIST_RETURN_CHILDREN : function (aBox) {</span>
<a href="#l9.929"></a><span id="l9.929" class="difflineplus">+    if (aBox.nonExistent) {</span>
<a href="#l9.930"></a><span id="l9.930" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l9.931"></a><span id="l9.931" class="difflineplus">+    }</span>
<a href="#l9.932"></a><span id="l9.932" class="difflineplus">+    return '* LIST (' + aBox.flags.join(&quot; &quot;) +</span>
<a href="#l9.933"></a><span id="l9.933" class="difflineplus">+           ((aBox._children.length &gt; 0) ?</span>
<a href="#l9.934"></a><span id="l9.934" class="difflineplus">+            (((aBox.flags.length &gt; 0) ? ' ' : '') + '\\HasChildren') :</span>
<a href="#l9.935"></a><span id="l9.935" class="difflineplus">+            ((aBox.flags.indexOf('\\NoInferiors') == -1) ?</span>
<a href="#l9.936"></a><span id="l9.936" class="difflineplus">+             (((aBox.flags.length &gt; 0) ? ' ' : '') + '\\HasNoChildren') :</span>
<a href="#l9.937"></a><span id="l9.937" class="difflineplus">+             '')) + ') &quot;' + aBox.delimiter + '&quot; &quot;' + aBox.displayName + '&quot;\0';</span>
<a href="#l9.938"></a><span id="l9.938" class="difflineplus">+  },</span>
<a href="#l9.939"></a><span id="l9.939" class="difflineplus">+  _LIST_RETURN_SUBSCRIBED : function (aBox) {</span>
<a href="#l9.940"></a><span id="l9.940" class="difflineplus">+    if (aBox.nonExistent) {</span>
<a href="#l9.941"></a><span id="l9.941" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l9.942"></a><span id="l9.942" class="difflineplus">+    }</span>
<a href="#l9.943"></a><span id="l9.943" class="difflineplus">+    return '* LIST (' + aBox.flags.join(&quot; &quot;) +</span>
<a href="#l9.944"></a><span id="l9.944" class="difflineplus">+           (aBox.subscribed ? (((aBox.flags.length &gt; 0) ? ' ' : '') +</span>
<a href="#l9.945"></a><span id="l9.945" class="difflineplus">+                               '\\Subscribed') : '') +</span>
<a href="#l9.946"></a><span id="l9.946" class="difflineplus">+           ') &quot;' + aBox.delimiter + '&quot; &quot;' + aBox.displayName + '&quot;\0';</span>
<a href="#l9.947"></a><span id="l9.947" class="difflineplus">+  },</span>
<a href="#l9.948"></a><span id="l9.948" class="difflineplus">+  // TODO implement _LIST_REMOTE, _LIST_RECURSIVEMATCH, _LIST_RETURN_SUBSCRIBED</span>
<a href="#l9.949"></a><span id="l9.949" class="difflineplus">+  // and all valid combinations thereof. Currently, nsImapServerResponseParser</span>
<a href="#l9.950"></a><span id="l9.950" class="difflineplus">+  // does not support any of these responses anyway.</span>
<a href="#l9.951"></a><span id="l9.951" class="difflineplus">+</span>
<a href="#l9.952"></a><span id="l9.952" class="difflineplus">+  kCapabilities: [&quot;LIST-EXTENDED&quot;]</span>
<a href="#l9.953"></a><span id="l9.953" class="difflineplus">+};</span>
<a href="#l9.954"></a><span id="l9.954"> </span>
<a href="#l9.955"></a><span id="l9.955"> /**</span>
<a href="#l9.956"></a><span id="l9.956">  * This implements AUTH schemes. Could be moved into RFC3501 actually.</span>
<a href="#l9.957"></a><span id="l9.957">  * The test can en-/disable auth schemes by modifying kAuthSchemes.</span>
<a href="#l9.958"></a><span id="l9.958">  */</span>
<a href="#l9.959"></a><span id="l9.959"> var IMAP_RFC2195_extension = {</span>
<a href="#l9.960"></a><span id="l9.960">   kAuthSchemes : [ &quot;CRAM-MD5&quot; , &quot;PLAIN&quot;, &quot;LOGIN&quot; ],</span>
<a href="#l9.961"></a><span id="l9.961"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/test/resources/IMAPpump.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/test/resources/IMAPpump.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -95,21 +95,19 @@ function setupIMAPPump(extensions)</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5">   // Let's also have another account, using the same identity</span>
<a href="#l10.6"></a><span id="l10.6">   let imapAccount = acctMgr.createAccount();</span>
<a href="#l10.7"></a><span id="l10.7">   imapAccount.addIdentity(identity);</span>
<a href="#l10.8"></a><span id="l10.8">   imapAccount.defaultIdentity = identity;</span>
<a href="#l10.9"></a><span id="l10.9">   imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">   // The server doesn't support more than one connection</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  Services.prefs.setIntPref(&quot;mail.server.default.max_cached_connections&quot;,</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-                            1);</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  Services.prefs.setIntPref(&quot;mail.server.default.max_cached_connections&quot;, 1);</span>
<a href="#l10.15"></a><span id="l10.15">   // We aren't interested in downloading messages automatically</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-  Services.prefs.setBoolPref(&quot;mail.server.default.download_on_biff&quot;,</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-                             false);</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.default.download_on_biff&quot;, false);</span>
<a href="#l10.19"></a><span id="l10.19">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l10.20"></a><span id="l10.20">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l10.21"></a><span id="l10.21">   Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l10.22"></a><span id="l10.22">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l10.23"></a><span id="l10.23">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, false);</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25">   gIMAPIncomingServer.performExpand(null);</span>
<a href="#l10.26"></a><span id="l10.26"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

