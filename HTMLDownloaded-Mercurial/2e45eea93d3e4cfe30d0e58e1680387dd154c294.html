<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 12191:2e45eea93d3e4cfe30d0e58e1680387dd154c294</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 2e45eea93d3e4cfe30d0e58e1680387dd154c294" />
<meta property="og:url" content="/comm-central/rev/2e45eea93d3e4cfe30d0e58e1680387dd154c294" />
<meta property="og:description" content="Bug 852690 - Remaining conversion to mailServices.js: accounts. r=mconley" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 2e45eea93d3e4cfe30d0e58e1680387dd154c294 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/2e45eea93d3e4cfe30d0e58e1680387dd154c294">shortlog</a> |
<a href="/comm-central/log/2e45eea93d3e4cfe30d0e58e1680387dd154c294">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/2e45eea93d3e4cfe30d0e58e1680387dd154c294">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/2e45eea93d3e4cfe30d0e58e1680387dd154c294">files</a> |
changeset |
<a href="/comm-central/raw-rev/2e45eea93d3e4cfe30d0e58e1680387dd154c294">raw</a>  | <a href="/comm-central/archive/2e45eea93d3e4cfe30d0e58e1680387dd154c294.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=852690">Bug 852690</a> - Remaining conversion to mailServices.js: accounts. r=mconley
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#101;&#98;&#97;&#115;&#116;&#105;&#97;&#110;&#32;&#72;&#101;&#110;&#103;&#115;&#116;&#32;&#60;&#97;&#114;&#99;&#104;&#97;&#101;&#111;&#112;&#116;&#101;&#114;&#121;&#120;&#64;&#99;&#111;&#111;&#108;&#101;&#45;&#102;&#105;&#108;&#101;&#115;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 25 Mar 2013 19:45:19 +0100</td></tr>

<tr>
 <td>changeset 12191</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/2e45eea93d3e4cfe30d0e58e1680387dd154c294">2e45eea93d3e4cfe30d0e58e1680387dd154c294</a></td>
</tr>



<tr>
<td>parent 12190</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0c65c10dc3aa396dc287e49f662d1c457e847911">0c65c10dc3aa396dc287e49f662d1c457e847911</a>
</td>
</tr>

<tr>
<td>child 12192</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/45dc9315bd5864f0f36ba7c2806559a5e87b7340">45dc9315bd5864f0f36ba7c2806559a5e87b7340</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=2e45eea93d3e4cfe30d0e58e1680387dd154c294">9038</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 26 Mar 2013 16:20:50 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@fd78e7d7cda7 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=fd78e7d7cda7cab16f071b9e54b0972cc7200ee9">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=fd78e7d7cda7cab16f071b9e54b0972cc7200ee9&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=fd78e7d7cda7cab16f071b9e54b0972cc7200ee9&newProject=comm-central&newRevision=0c65c10dc3aa396dc287e49f662d1c457e847911&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=fd78e7d7cda7cab16f071b9e54b0972cc7200ee9&newProject=comm-central&newRevision=0c65c10dc3aa396dc287e49f662d1c457e847911&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=fd78e7d7cda7cab16f071b9e54b0972cc7200ee9&newProject=comm-central&newRevision=0c65c10dc3aa396dc287e49f662d1c457e847911&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mconley%29&revcount=50">mconley</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=852690">852690</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=852690">Bug 852690</a> - Remaining conversion to mailServices.js: accounts. r=mconley</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/AccountWizard.js">mailnews/base/prefs/content/AccountWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/AccountWizard.js">file</a> |
<a href="/comm-central/annotate/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/AccountWizard.js">annotate</a> |
<a href="/comm-central/diff/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/AccountWizard.js">diff</a> |
<a href="/comm-central/comparison/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/AccountWizard.js">comparison</a> |
<a href="/comm-central/log/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/AccountWizard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/createInBackend.js">mailnews/base/prefs/content/accountcreation/createInBackend.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/createInBackend.js">file</a> |
<a href="/comm-central/annotate/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/createInBackend.js">annotate</a> |
<a href="/comm-central/diff/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/createInBackend.js">diff</a> |
<a href="/comm-central/comparison/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/createInBackend.js">comparison</a> |
<a href="/comm-central/log/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/createInBackend.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/emailWizard.js">mailnews/base/prefs/content/accountcreation/emailWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/emailWizard.js">file</a> |
<a href="/comm-central/annotate/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/emailWizard.js">annotate</a> |
<a href="/comm-central/diff/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/emailWizard.js">diff</a> |
<a href="/comm-central/comparison/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/emailWizard.js">comparison</a> |
<a href="/comm-central/log/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/emailWizard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/fetchConfig.js">mailnews/base/prefs/content/accountcreation/fetchConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/fetchConfig.js">file</a> |
<a href="/comm-central/annotate/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/fetchConfig.js">annotate</a> |
<a href="/comm-central/diff/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/fetchConfig.js">diff</a> |
<a href="/comm-central/comparison/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/fetchConfig.js">comparison</a> |
<a href="/comm-central/log/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/fetchConfig.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/verifyConfig.js">mailnews/base/prefs/content/accountcreation/verifyConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/verifyConfig.js">file</a> |
<a href="/comm-central/annotate/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/verifyConfig.js">annotate</a> |
<a href="/comm-central/diff/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/verifyConfig.js">diff</a> |
<a href="/comm-central/comparison/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/verifyConfig.js">comparison</a> |
<a href="/comm-central/log/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/prefs/content/accountcreation/verifyConfig.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/test/unit/test_accountMgr.js">mailnews/base/test/unit/test_accountMgr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/test/unit/test_accountMgr.js">file</a> |
<a href="/comm-central/annotate/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/test/unit/test_accountMgr.js">annotate</a> |
<a href="/comm-central/diff/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/test/unit/test_accountMgr.js">diff</a> |
<a href="/comm-central/comparison/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/test/unit/test_accountMgr.js">comparison</a> |
<a href="/comm-central/log/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/test/unit/test_accountMgr.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/test/unit/test_acctRepair.js">mailnews/base/test/unit/test_acctRepair.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/test/unit/test_acctRepair.js">file</a> |
<a href="/comm-central/annotate/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/test/unit/test_acctRepair.js">annotate</a> |
<a href="/comm-central/diff/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/test/unit/test_acctRepair.js">diff</a> |
<a href="/comm-central/comparison/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/test/unit/test_acctRepair.js">comparison</a> |
<a href="/comm-central/log/2e45eea93d3e4cfe30d0e58e1680387dd154c294/mailnews/base/test/unit/test_acctRepair.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/prefs/content/AccountWizard.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/prefs/content/AccountWizard.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -35,26 +35,21 @@ var okCallback = null;</span>
<a href="#l1.4"></a><span id="l1.4">    </span>
<a href="#l1.5"></a><span id="l1.5">    accounttype -&gt; identity -&gt; server -&gt; login -&gt; accname -&gt; done</span>
<a href="#l1.6"></a><span id="l1.6">                              \-&gt; newsserver ----/</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">    where the accounttype determines which path to take</span>
<a href="#l1.9"></a><span id="l1.9">    (server vs. newsserver)</span>
<a href="#l1.10"></a><span id="l1.10"> */</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+</span>
<a href="#l1.14"></a><span id="l1.14"> var contentWindow;</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> var gPageData;</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-var smtpService = Components.classes[&quot;@mozilla.org/messengercompose/smtp;1&quot;].getService(Components.interfaces.nsISmtpService);</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-var am = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;].getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-var gMailSession = Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;].getService(Components.interfaces.nsIMsgMailSession);</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-var accounts = am.accounts;</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-//accountCount indicates presence or absense of accounts</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-var accountCount = accounts.length;</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25"> var nsIMsgIdentity = Components.interfaces.nsIMsgIdentity;</span>
<a href="#l1.26"></a><span id="l1.26"> var nsIMsgIncomingServer = Components.interfaces.nsIMsgIncomingServer;</span>
<a href="#l1.27"></a><span id="l1.27"> var gPrefsBundle, gMessengerBundle;</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29"> // the current nsIMsgAccount</span>
<a href="#l1.30"></a><span id="l1.30"> var gCurrentAccount;</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32" class="difflineat">@@ -86,17 +81,17 @@ function onAccountWizardLoad() {</span>
<a href="#l1.33"></a><span id="l1.33">       //dump(&quot;There is okCallback&quot;);</span>
<a href="#l1.34"></a><span id="l1.34">       top.okCallback = window.arguments[0].okCallback;</span>
<a href="#l1.35"></a><span id="l1.35">     }</span>
<a href="#l1.36"></a><span id="l1.36">   }</span>
<a href="#l1.37"></a><span id="l1.37"> </span>
<a href="#l1.38"></a><span id="l1.38">   checkForInvalidAccounts();</span>
<a href="#l1.39"></a><span id="l1.39"> </span>
<a href="#l1.40"></a><span id="l1.40">   try {</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-    gDefaultAccount = am.defaultAccount;</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+    gDefaultAccount = MailServices.accounts.defaultAccount;</span>
<a href="#l1.43"></a><span id="l1.43">   }</span>
<a href="#l1.44"></a><span id="l1.44">   catch (ex) {</span>
<a href="#l1.45"></a><span id="l1.45">     // no default account, this is expected the first time you launch mail</span>
<a href="#l1.46"></a><span id="l1.46">     // on a new profile</span>
<a href="#l1.47"></a><span id="l1.47">     gDefaultAccount = null;</span>
<a href="#l1.48"></a><span id="l1.48">   }</span>
<a href="#l1.49"></a><span id="l1.49"> </span>
<a href="#l1.50"></a><span id="l1.50">   // Set default value for global inbox checkbox</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineat">@@ -131,17 +126,18 @@ function onCancel()</span>
<a href="#l1.52"></a><span id="l1.52"> </span>
<a href="#l1.53"></a><span id="l1.53">     // call FinishAccount() and not onFinish(), since the &quot;finish&quot;</span>
<a href="#l1.54"></a><span id="l1.54">     // button may be disabled</span>
<a href="#l1.55"></a><span id="l1.55">     FinishAccount();</span>
<a href="#l1.56"></a><span id="l1.56">   }</span>
<a href="#l1.57"></a><span id="l1.57">   else {</span>
<a href="#l1.58"></a><span id="l1.58">     // since this is not an invalid account</span>
<a href="#l1.59"></a><span id="l1.59">     // really cancel if the user hits the &quot;cancel&quot; button</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-    if (accountCount &lt; 1) {</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+    // if the length of the account list is less than 1, there are no accounts</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+    if (MailServices.accounts.accounts.length &lt; 1) {</span>
<a href="#l1.63"></a><span id="l1.63">       let confirmMsg = gPrefsBundle.getString(&quot;cancelWizard&quot;);</span>
<a href="#l1.64"></a><span id="l1.64">       let confirmTitle = gPrefsBundle.getString(&quot;accountWizard&quot;);</span>
<a href="#l1.65"></a><span id="l1.65">       let result = Services.prompt.confirmEx(window, confirmTitle, confirmMsg,</span>
<a href="#l1.66"></a><span id="l1.66">         (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l1.67"></a><span id="l1.67">         (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_1),</span>
<a href="#l1.68"></a><span id="l1.68">         gPrefsBundle.getString('WizardExit'),</span>
<a href="#l1.69"></a><span id="l1.69">         gPrefsBundle.getString('WizardContinue'), </span>
<a href="#l1.70"></a><span id="l1.70">         null, null, {value:0});</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineat">@@ -198,17 +194,17 @@ function FinishAccount()</span>
<a href="#l1.72"></a><span id="l1.72">       window.opener.gLoadStartFolder = false;</span>
<a href="#l1.73"></a><span id="l1.73">       if (document.getElementById(&quot;downloadMsgs&quot;).checked) {</span>
<a href="#l1.74"></a><span id="l1.74">         window.opener.gNewAccountToLoad = gCurrentAccount; // load messages for new POP account</span>
<a href="#l1.75"></a><span id="l1.75">       }</span>
<a href="#l1.76"></a><span id="l1.76">     }</span>
<a href="#l1.77"></a><span id="l1.77"> </span>
<a href="#l1.78"></a><span id="l1.78">     // in case we crash, force us a save of the prefs file NOW</span>
<a href="#l1.79"></a><span id="l1.79">     try {</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-      am.saveAccountInfo();</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+      MailServices.accounts.saveAccountInfo();</span>
<a href="#l1.82"></a><span id="l1.82">     } </span>
<a href="#l1.83"></a><span id="l1.83">     catch (ex) {</span>
<a href="#l1.84"></a><span id="l1.84">       dump(&quot;Error saving account info: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l1.85"></a><span id="l1.85">     }</span>
<a href="#l1.86"></a><span id="l1.86">     window.close();</span>
<a href="#l1.87"></a><span id="l1.87">     if(top.okCallback)</span>
<a href="#l1.88"></a><span id="l1.88">     {</span>
<a href="#l1.89"></a><span id="l1.89">       var state = true;</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineat">@@ -322,19 +318,18 @@ function PageDataToAccountData(pageData,</span>
<a href="#l1.91"></a><span id="l1.91">     identity.fullName = pageData.identity.fullName.value;</span>
<a href="#l1.92"></a><span id="l1.92"> </span>
<a href="#l1.93"></a><span id="l1.93">   server.type = getCurrentServerType(pageData);</span>
<a href="#l1.94"></a><span id="l1.94">   server.hostName = getCurrentHostname(pageData);</span>
<a href="#l1.95"></a><span id="l1.95">   if (getCurrentServerIsDeferred(pageData))</span>
<a href="#l1.96"></a><span id="l1.96">   {</span>
<a href="#l1.97"></a><span id="l1.97">     try</span>
<a href="#l1.98"></a><span id="l1.98">     {</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-      var accountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;].getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-      var localFoldersServer = accountManager.localFoldersServer;</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-      var localFoldersAccount = accountManager.FindAccountForServer(localFoldersServer);</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+      let localFoldersServer = MailServices.accounts.localFoldersServer;</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+      let localFoldersAccount = MailServices.accounts.FindAccountForServer(localFoldersServer);</span>
<a href="#l1.104"></a><span id="l1.104">       pop3.deferredToAccount = localFoldersAccount.key;</span>
<a href="#l1.105"></a><span id="l1.105">       pop3.deferGetNewMail = true;</span>
<a href="#l1.106"></a><span id="l1.106">       server[&quot;ServerType-pop3&quot;] = pop3;</span>
<a href="#l1.107"></a><span id="l1.107">     }</span>
<a href="#l1.108"></a><span id="l1.108">     catch (ex) {dump (&quot;exception setting up deferred account&quot; + ex);}</span>
<a href="#l1.109"></a><span id="l1.109">   }</span>
<a href="#l1.110"></a><span id="l1.110">   if (serverIsNntp(pageData)) {</span>
<a href="#l1.111"></a><span id="l1.111">     // this stuff probably not relevant</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineat">@@ -394,32 +389,32 @@ function PageDataToAccountData(pageData,</span>
<a href="#l1.113"></a><span id="l1.113"> // (but don't fill in any fields, that's for finishAccount()</span>
<a href="#l1.114"></a><span id="l1.114"> function createAccount(accountData)</span>
<a href="#l1.115"></a><span id="l1.115"> {</span>
<a href="#l1.116"></a><span id="l1.116">   // Retrieve the server (data) from the account data.</span>
<a href="#l1.117"></a><span id="l1.117">   var server = accountData.incomingServer;</span>
<a href="#l1.118"></a><span id="l1.118">   </span>
<a href="#l1.119"></a><span id="l1.119">   // for news, username is always null</span>
<a href="#l1.120"></a><span id="l1.120">   var username = (server.type == &quot;nntp&quot;) ? null : server.username;</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-  dump(&quot;am.createIncomingServer(&quot; +</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+  dump(&quot;MailServices.accounts.createIncomingServer(&quot; +</span>
<a href="#l1.123"></a><span id="l1.123">        username + &quot;, &quot; + server.hostName + &quot;, &quot; + server.type + &quot;)\n&quot;);</span>
<a href="#l1.124"></a><span id="l1.124">   // Create a (actual) server.</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-  server = am.createIncomingServer(username, server.hostName, server.type);</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+  server = MailServices.accounts.createIncomingServer(username, server.hostName, server.type);</span>
<a href="#l1.127"></a><span id="l1.127"> </span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-  dump(&quot;am.createAccount()\n&quot;);</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+  dump(&quot;MailServices.accounts.createAccount()\n&quot;);</span>
<a href="#l1.130"></a><span id="l1.130">   // Create an account.</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-  var account = am.createAccount();</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+  let account = MailServices.accounts.createAccount();</span>
<a href="#l1.133"></a><span id="l1.133">   </span>
<a href="#l1.134"></a><span id="l1.134">   // only create an identity for this account if we really have one</span>
<a href="#l1.135"></a><span id="l1.135">   // (use the email address as a check)</span>
<a href="#l1.136"></a><span id="l1.136">   if (accountData.identity &amp;&amp; accountData.identity.email)</span>
<a href="#l1.137"></a><span id="l1.137">   {</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-    dump(&quot;am.createIdentity()\n&quot;);</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+    dump(&quot;MailServices.accounts.createIdentity()\n&quot;);</span>
<a href="#l1.140"></a><span id="l1.140">     // Create an identity.</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-    var identity = am.createIdentity();</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+    let identity = MailServices.accounts.createIdentity();</span>
<a href="#l1.143"></a><span id="l1.143"> </span>
<a href="#l1.144"></a><span id="l1.144">     // New nntp identities should use plain text by default;</span>
<a href="#l1.145"></a><span id="l1.145">     // we want that GNKSA (The Good Net-Keeping Seal of Approval).</span>
<a href="#l1.146"></a><span id="l1.146">     if (server.type == &quot;nntp&quot;)</span>
<a href="#l1.147"></a><span id="l1.147">       identity.composeHtml = false;</span>
<a href="#l1.148"></a><span id="l1.148"> </span>
<a href="#l1.149"></a><span id="l1.149">     account.addIdentity(identity);</span>
<a href="#l1.150"></a><span id="l1.150">   }</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineat">@@ -489,29 +484,29 @@ function finishAccount(account, accountD</span>
<a href="#l1.152"></a><span id="l1.152">        * Signature files, if exist, are placed under default location. Get</span>
<a href="#l1.153"></a><span id="l1.153">        * default files location for messenger using directory service. Signature </span>
<a href="#l1.154"></a><span id="l1.154">        * file name should be extracted from the account data to build the complete</span>
<a href="#l1.155"></a><span id="l1.155">        * path for signature file. Once the path is built, set the identity's signature pref.</span>
<a href="#l1.156"></a><span id="l1.156">        */</span>
<a href="#l1.157"></a><span id="l1.157">       if (destIdentity.attachSignature)</span>
<a href="#l1.158"></a><span id="l1.158">       {</span>
<a href="#l1.159"></a><span id="l1.159">           var sigFileName = accountData.signatureFileName;</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineminus">-          var sigFile = gMailSession.getDataFilesDir(&quot;messenger&quot;);</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+          let sigFile = MailServices.mailSession.getDataFilesDir(&quot;messenger&quot;);</span>
<a href="#l1.162"></a><span id="l1.162">           sigFile.append(sigFileName);</span>
<a href="#l1.163"></a><span id="l1.163">           destIdentity.signature = sigFile;</span>
<a href="#l1.164"></a><span id="l1.164">       }</span>
<a href="#l1.165"></a><span id="l1.165"> </span>
<a href="#l1.166"></a><span id="l1.166">       if (accountData.smtp.hostname &amp;&amp; !destIdentity.smtpServerKey)</span>
<a href="#l1.167"></a><span id="l1.167">       {</span>
<a href="#l1.168"></a><span id="l1.168">           // hostname + no key =&gt; create a new SMTP server.</span>
<a href="#l1.169"></a><span id="l1.169"> </span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-          var smtpServer = smtpService.createServer();</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+          let smtpServer = MailServices.smtp.createServer();</span>
<a href="#l1.172"></a><span id="l1.172">           var isDefaultSmtpServer;</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-          if (!smtpService.defaultServer.hostname) {</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-            smtpService.defaultServer = smtpServer;</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+          if (!MailServices.smtp.defaultServer.hostname) {</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+            MailServices.smtp.defaultServer = smtpServer;</span>
<a href="#l1.177"></a><span id="l1.177">             isDefaultSmtpServer = true;</span>
<a href="#l1.178"></a><span id="l1.178">           }</span>
<a href="#l1.179"></a><span id="l1.179"> </span>
<a href="#l1.180"></a><span id="l1.180">           copyObjectToInterface(smtpServer, accountData.smtp, false);</span>
<a href="#l1.181"></a><span id="l1.181"> </span>
<a href="#l1.182"></a><span id="l1.182">           // If it's the default server we created, make the identity use</span>
<a href="#l1.183"></a><span id="l1.183">           // &quot;Use Default&quot; by default.</span>
<a href="#l1.184"></a><span id="l1.184">           destIdentity.smtpServerKey =</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineat">@@ -573,31 +568,31 @@ function copyObjectToInterface(dest, src</span>
<a href="#l1.186"></a><span id="l1.186"> }</span>
<a href="#l1.187"></a><span id="l1.187"> </span>
<a href="#l1.188"></a><span id="l1.188"> // check if there already is a &quot;Local Folders&quot;</span>
<a href="#l1.189"></a><span id="l1.189"> // if not, create it.</span>
<a href="#l1.190"></a><span id="l1.190"> function verifyLocalFoldersAccount() </span>
<a href="#l1.191"></a><span id="l1.191"> {</span>
<a href="#l1.192"></a><span id="l1.192">   var localMailServer = null;</span>
<a href="#l1.193"></a><span id="l1.193">   try {</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-    localMailServer = am.localFoldersServer;</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+    localMailServer = MailServices.accounts.localFoldersServer;</span>
<a href="#l1.196"></a><span id="l1.196">   }</span>
<a href="#l1.197"></a><span id="l1.197">   catch (ex) {</span>
<a href="#l1.198"></a><span id="l1.198">          // dump(&quot;exception in findserver: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l1.199"></a><span id="l1.199">     localMailServer = null;</span>
<a href="#l1.200"></a><span id="l1.200">   }</span>
<a href="#l1.201"></a><span id="l1.201"> </span>
<a href="#l1.202"></a><span id="l1.202">   try {</span>
<a href="#l1.203"></a><span id="l1.203">     if (!localMailServer) </span>
<a href="#l1.204"></a><span id="l1.204">     {</span>
<a href="#l1.205"></a><span id="l1.205">       // dump(&quot;Creating local mail account\n&quot;);</span>
<a href="#l1.206"></a><span id="l1.206">       // creates a copy of the identity you pass in</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">-      am.createLocalMailAccount();</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+      MailServices.accounts.createLocalMailAccount();</span>
<a href="#l1.209"></a><span id="l1.209">       try {</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineminus">-        localMailServer = am.localFoldersServer;</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+        localMailServer = MailServices.accounts.localFoldersServer;</span>
<a href="#l1.212"></a><span id="l1.212">       }</span>
<a href="#l1.213"></a><span id="l1.213">       catch (ex) {</span>
<a href="#l1.214"></a><span id="l1.214">         dump(&quot;error!  we should have found the local mail server after we created it.\n&quot;);</span>
<a href="#l1.215"></a><span id="l1.215">         localMailServer = null;</span>
<a href="#l1.216"></a><span id="l1.216">       }</span>
<a href="#l1.217"></a><span id="l1.217">     }</span>
<a href="#l1.218"></a><span id="l1.218">   }</span>
<a href="#l1.219"></a><span id="l1.219">   catch (ex) {dump(&quot;Error in verifyLocalFoldersAccount&quot; + ex + &quot;\n&quot;);  }</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineat">@@ -620,22 +615,22 @@ function setupCopiesAndFoldersServer(acc</span>
<a href="#l1.221"></a><span id="l1.221"> </span>
<a href="#l1.222"></a><span id="l1.222">     var copiesAndFoldersServer = null;</span>
<a href="#l1.223"></a><span id="l1.223">     if (defaultCopiesAndFoldersPrefsToServer) </span>
<a href="#l1.224"></a><span id="l1.224">     {</span>
<a href="#l1.225"></a><span id="l1.225">       copiesAndFoldersServer = server;</span>
<a href="#l1.226"></a><span id="l1.226">     }</span>
<a href="#l1.227"></a><span id="l1.227">     else </span>
<a href="#l1.228"></a><span id="l1.228">     {</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineminus">-      if (!am.localFoldersServer) </span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+      if (!MailServices.accounts.localFoldersServer)</span>
<a href="#l1.231"></a><span id="l1.231">       {</span>
<a href="#l1.232"></a><span id="l1.232">         dump(&quot;error!  we should have a local mail server at this point\n&quot;);</span>
<a href="#l1.233"></a><span id="l1.233">         return false;</span>
<a href="#l1.234"></a><span id="l1.234">       }</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineminus">-      copiesAndFoldersServer = am.localFoldersServer;</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineplus">+      copiesAndFoldersServer = MailServices.accounts.localFoldersServer;</span>
<a href="#l1.237"></a><span id="l1.237">     }</span>
<a href="#l1.238"></a><span id="l1.238"> </span>
<a href="#l1.239"></a><span id="l1.239">     setDefaultCopiesAndFoldersPrefs(identity, copiesAndFoldersServer, accountData);</span>
<a href="#l1.240"></a><span id="l1.240"> </span>
<a href="#l1.241"></a><span id="l1.241">   } catch (ex) {</span>
<a href="#l1.242"></a><span id="l1.242">     // return false (meaning we did not setupCopiesAndFoldersServer)</span>
<a href="#l1.243"></a><span id="l1.243">     // on any error</span>
<a href="#l1.244"></a><span id="l1.244">     dump(&quot;Error in setupCopiesAndFoldersServer: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineat">@@ -697,31 +692,24 @@ function setDefaultCopiesAndFoldersPrefs</span>
<a href="#l1.246"></a><span id="l1.246">   identity.fccFolderPickerMode = (accountData.identity &amp;&amp;</span>
<a href="#l1.247"></a><span id="l1.247">     accountData.identity.FccFolder ? 1 : gDefaultSpecialFolderPickerMode);</span>
<a href="#l1.248"></a><span id="l1.248">   identity.draftsFolderPickerMode = (accountData.identity &amp;&amp;</span>
<a href="#l1.249"></a><span id="l1.249">     accountData.identity.DraftFolder ? 1 : gDefaultSpecialFolderPickerMode);</span>
<a href="#l1.250"></a><span id="l1.250">   identity.tmplFolderPickerMode = (accountData.identity &amp;&amp;</span>
<a href="#l1.251"></a><span id="l1.251">     accountData.identity.StationeryFolder ? 1 : gDefaultSpecialFolderPickerMode);</span>
<a href="#l1.252"></a><span id="l1.252"> }</span>
<a href="#l1.253"></a><span id="l1.253"> </span>
<a href="#l1.254"></a><span id="l1.254" class="difflineminus">-function AccountExists(userName,hostName,serverType)</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+function AccountExists(userName, hostName, serverType)</span>
<a href="#l1.256"></a><span id="l1.256"> {</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineminus">-  var accountExists = false;</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineminus">-  var accountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineminus">-                                 .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineminus">-</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineminus">-  return accountManager.findRealServer(userName, hostName, serverType, 0);</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineplus">+  return MailServices.accounts.findRealServer(userName, hostName, serverType, 0);</span>
<a href="#l1.263"></a><span id="l1.263"> }</span>
<a href="#l1.264"></a><span id="l1.264"> </span>
<a href="#l1.265"></a><span id="l1.265"> function getFirstInvalidAccount()</span>
<a href="#l1.266"></a><span id="l1.266"> {</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineminus">-  var am = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineminus">-                     .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineminus">-</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineminus">-  var invalidAccounts = getInvalidAccounts(am.accounts);</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineplus">+  let invalidAccounts = getInvalidAccounts(MailServices.accounts.accounts);</span>
<a href="#l1.272"></a><span id="l1.272"> </span>
<a href="#l1.273"></a><span id="l1.273">   if (invalidAccounts.length &gt; 0)</span>
<a href="#l1.274"></a><span id="l1.274">     return invalidAccounts[0];</span>
<a href="#l1.275"></a><span id="l1.275">   else</span>
<a href="#l1.276"></a><span id="l1.276">     return null;</span>
<a href="#l1.277"></a><span id="l1.277"> }</span>
<a href="#l1.278"></a><span id="l1.278"> </span>
<a href="#l1.279"></a><span id="l1.279"> function checkForInvalidAccounts()</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineat">@@ -783,17 +771,17 @@ function getPreConfigDataForAccount(acco</span>
<a href="#l1.281"></a><span id="l1.281"> </span>
<a href="#l1.282"></a><span id="l1.282">   let identity = account.identities.queryElementAt(0, nsIMsgIdentity);</span>
<a href="#l1.283"></a><span id="l1.283"> </span>
<a href="#l1.284"></a><span id="l1.284">   try {</span>
<a href="#l1.285"></a><span id="l1.285">     var skipPanelsPrefStr = &quot;mail.identity.&quot; + identity.key + &quot;.wizardSkipPanels&quot;;</span>
<a href="#l1.286"></a><span id="l1.286">     accountData.wizardSkipPanels = Services.prefs.getCharPref(skipPanelsPrefStr);</span>
<a href="#l1.287"></a><span id="l1.287"> </span>
<a href="#l1.288"></a><span id="l1.288">     if (identity.smtpServerKey) {</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineminus">-      var smtpServer = smtpService.getServerByKey(identity.smtpServerKey);</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineplus">+      let smtpServer = MailServices.smtp.getServerByKey(identity.smtpServerKey);</span>
<a href="#l1.291"></a><span id="l1.291">       accountData.smtp = smtpServer;</span>
<a href="#l1.292"></a><span id="l1.292"> </span>
<a href="#l1.293"></a><span id="l1.293">       var smtpRequiresUsername = false;</span>
<a href="#l1.294"></a><span id="l1.294">       var smtpRequiresPrefStr = &quot;mail.identity.&quot; + identity.key + &quot;.smtpRequiresUsername&quot;;</span>
<a href="#l1.295"></a><span id="l1.295">       smtpRequiresUsername = Services.prefs.getBoolPref(smtpRequiresPrefStr);</span>
<a href="#l1.296"></a><span id="l1.296">       accountData.smtpRequiresUsername = smtpRequiresUsername;</span>
<a href="#l1.297"></a><span id="l1.297">     }</span>
<a href="#l1.298"></a><span id="l1.298">   }</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineat">@@ -810,17 +798,17 @@ function AccountToAccountData(account, d</span>
<a href="#l1.300"></a><span id="l1.300">   dump(&quot;AccountToAccountData(&quot; + account + &quot;, &quot; +</span>
<a href="#l1.301"></a><span id="l1.301">        defaultAccountData + &quot;)\n&quot;);</span>
<a href="#l1.302"></a><span id="l1.302">   var accountData = defaultAccountData;</span>
<a href="#l1.303"></a><span id="l1.303">   if (!accountData)</span>
<a href="#l1.304"></a><span id="l1.304">     accountData = new Object;</span>
<a href="#l1.305"></a><span id="l1.305"> </span>
<a href="#l1.306"></a><span id="l1.306">   accountData.incomingServer = account.incomingServer;</span>
<a href="#l1.307"></a><span id="l1.307">   accountData.identity = account.identities.queryElementAt(0, nsIMsgIdentity);</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineminus">-  accountData.smtp = smtpService.defaultServer;</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineplus">+  accountData.smtp = MailServices.smtp.defaultServer;</span>
<a href="#l1.310"></a><span id="l1.310"> </span>
<a href="#l1.311"></a><span id="l1.311">   return accountData;</span>
<a href="#l1.312"></a><span id="l1.312"> }</span>
<a href="#l1.313"></a><span id="l1.313"> </span>
<a href="#l1.314"></a><span id="l1.314"> // sets the page data, automatically creating the arrays as necessary</span>
<a href="#l1.315"></a><span id="l1.315"> function setPageData(pageData, tag, slot, value) {</span>
<a href="#l1.316"></a><span id="l1.316">   if (!pageData[tag]) pageData[tag] = [];</span>
<a href="#l1.317"></a><span id="l1.317"> </span>
<a href="#l1.318"></a><span id="l1.318" class="difflineat">@@ -986,17 +974,17 @@ function onFlush() {</span>
<a href="#l1.319"></a><span id="l1.319">   * check for mail at startup</span>
<a href="#l1.320"></a><span id="l1.320">   */</span>
<a href="#l1.321"></a><span id="l1.321"> function EnableCheckMailAtStartUpIfNeeded(newAccount)</span>
<a href="#l1.322"></a><span id="l1.322"> {</span>
<a href="#l1.323"></a><span id="l1.323">   // Check if default account exists and if that account is alllowed to be</span>
<a href="#l1.324"></a><span id="l1.324">   // a default account. If no such account, make this one as the default account </span>
<a href="#l1.325"></a><span id="l1.325">   // and turn on the new mail check at startup for the current account   </span>
<a href="#l1.326"></a><span id="l1.326">   if (!(gDefaultAccount &amp;&amp; gDefaultAccount.incomingServer.canBeDefaultServer)) { </span>
<a href="#l1.327"></a><span id="l1.327" class="difflineminus">-    am.defaultAccount = newAccount;</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineplus">+    MailServices.accounts.defaultAccount = newAccount;</span>
<a href="#l1.329"></a><span id="l1.329">     newAccount.incomingServer.loginAtStartUp = true;</span>
<a href="#l1.330"></a><span id="l1.330">     newAccount.incomingServer.downloadOnBiff = true;</span>
<a href="#l1.331"></a><span id="l1.331">   }</span>
<a href="#l1.332"></a><span id="l1.332"> }</span>
<a href="#l1.333"></a><span id="l1.333"> </span>
<a href="#l1.334"></a><span id="l1.334"> function SetSmtpRequiresUsernameAttribute(accountData) </span>
<a href="#l1.335"></a><span id="l1.335"> {</span>
<a href="#l1.336"></a><span id="l1.336">   // If this is the default server, time to set the smtp user name</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/createInBackend.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/createInBackend.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -7,27 +7,23 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * Takes an |AccountConfig| JS object and creates that account in the</span>
<a href="#l2.5"></a><span id="l2.5">  * Thunderbird backend (which also writes it to prefs).</span>
<a href="#l2.6"></a><span id="l2.6">  *</span>
<a href="#l2.7"></a><span id="l2.7">  * @param config {AccountConfig} The account to create</span>
<a href="#l2.8"></a><span id="l2.8">  *</span>
<a href="#l2.9"></a><span id="l2.9">  * @return - the account created.</span>
<a href="#l2.10"></a><span id="l2.10">  */</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l2.13"></a><span id="l2.13"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> function createAccountInBackend(config)</span>
<a href="#l2.16"></a><span id="l2.16"> {</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-  var accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-                       .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-  var smtpManager = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-                    .getService(Ci.nsISmtpService);</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-</span>
<a href="#l2.22"></a><span id="l2.22">   // incoming server</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-  var inServer = accountManager.createIncomingServer(</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+  let inServer = MailServices.accounts.createIncomingServer(</span>
<a href="#l2.25"></a><span id="l2.25">       config.incoming.username,</span>
<a href="#l2.26"></a><span id="l2.26">       config.incoming.hostname,</span>
<a href="#l2.27"></a><span id="l2.27">       sanitize.enum(config.incoming.type, [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]));</span>
<a href="#l2.28"></a><span id="l2.28">   inServer.port = config.incoming.port;</span>
<a href="#l2.29"></a><span id="l2.29">   inServer.authMethod = config.incoming.auth;</span>
<a href="#l2.30"></a><span id="l2.30">   inServer.password = config.incoming.password;</span>
<a href="#l2.31"></a><span id="l2.31">   if (config.rememberPassword &amp;&amp; config.incoming.password.length)</span>
<a href="#l2.32"></a><span id="l2.32">     rememberPassword(inServer, config.incoming.password);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineat">@@ -81,25 +77,25 @@ function createAccountInBackend(config)</span>
<a href="#l2.34"></a><span id="l2.34">     Services.prefs.setBoolPref(ageFromServerPref,</span>
<a href="#l2.35"></a><span id="l2.35">                                config.incoming.deleteByAgeFromServer);</span>
<a href="#l2.36"></a><span id="l2.36">     Services.prefs.setBoolPref(downloadOnBiffPref,</span>
<a href="#l2.37"></a><span id="l2.37">                                config.incoming.downloadOnBiff);</span>
<a href="#l2.38"></a><span id="l2.38">   }</span>
<a href="#l2.39"></a><span id="l2.39">   inServer.valid = true;</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41">   let username = config.outgoing.auth &gt; 1 ? config.outgoing.username : null;</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-  let outServer = smtpManager.findServer(username, config.outgoing.hostname);</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+  let outServer = MailServices.smtp.findServer(username, config.outgoing.hostname);</span>
<a href="#l2.44"></a><span id="l2.44">   assert(config.outgoing.addThisServer ||</span>
<a href="#l2.45"></a><span id="l2.45">          config.outgoing.useGlobalPreferredServer ||</span>
<a href="#l2.46"></a><span id="l2.46">          config.outgoing.existingServerKey,</span>
<a href="#l2.47"></a><span id="l2.47">          &quot;No SMTP server: inconsistent flags&quot;);</span>
<a href="#l2.48"></a><span id="l2.48"> </span>
<a href="#l2.49"></a><span id="l2.49">   if (config.outgoing.addThisServer &amp;&amp; !outServer)</span>
<a href="#l2.50"></a><span id="l2.50">   {</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-    outServer = smtpManager.createServer();</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+    outServer = MailServices.smtp.createServer();</span>
<a href="#l2.53"></a><span id="l2.53">     outServer.hostname = config.outgoing.hostname;</span>
<a href="#l2.54"></a><span id="l2.54">     outServer.port = config.outgoing.port;</span>
<a href="#l2.55"></a><span id="l2.55">     outServer.authMethod = config.outgoing.auth;</span>
<a href="#l2.56"></a><span id="l2.56">     if (config.outgoing.auth &gt; 1)</span>
<a href="#l2.57"></a><span id="l2.57">     {</span>
<a href="#l2.58"></a><span id="l2.58">       outServer.username = username;</span>
<a href="#l2.59"></a><span id="l2.59">       outServer.password = config.incoming.password;</span>
<a href="#l2.60"></a><span id="l2.60">       if (config.rememberPassword &amp;&amp; config.incoming.password.length)</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineat">@@ -114,24 +110,24 @@ function createAccountInBackend(config)</span>
<a href="#l2.62"></a><span id="l2.62">       outServer.socketType = Ci.nsMsgSocketType.alwaysSTARTTLS;</span>
<a href="#l2.63"></a><span id="l2.63"> </span>
<a href="#l2.64"></a><span id="l2.64">     // API problem: &lt;http://mxr.mozilla.org/seamonkey/source/mailnews/compose/public/nsISmtpServer.idl#93&gt;</span>
<a href="#l2.65"></a><span id="l2.65">     outServer.description = config.displayName;</span>
<a href="#l2.66"></a><span id="l2.66">     if (config.password)</span>
<a href="#l2.67"></a><span id="l2.67">       outServer.password = config.outgoing.password;</span>
<a href="#l2.68"></a><span id="l2.68"> </span>
<a href="#l2.69"></a><span id="l2.69">     // If this is the first SMTP server, set it as default</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-    if (!smtpManager.defaultServer ||</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-        !smtpManager.defaultServer.hostname)</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-      smtpManager.defaultServer = outServer;</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+    if (!MailServices.smtp.defaultServer ||</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+        !MailServices.smtp.defaultServer.hostname)</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+      MailServices.smtp.defaultServer = outServer;</span>
<a href="#l2.76"></a><span id="l2.76">   }</span>
<a href="#l2.77"></a><span id="l2.77"> </span>
<a href="#l2.78"></a><span id="l2.78">   // identity</span>
<a href="#l2.79"></a><span id="l2.79">   // TODO accounts without identity?</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-  var identity = accountManager.createIdentity();</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+  let identity = MailServices.accounts.createIdentity();</span>
<a href="#l2.82"></a><span id="l2.82">   identity.fullName = config.identity.realname;</span>
<a href="#l2.83"></a><span id="l2.83">   identity.email = config.identity.emailAddress;</span>
<a href="#l2.84"></a><span id="l2.84">   if (config.incoming.type == &quot;nntp&quot;)</span>
<a href="#l2.85"></a><span id="l2.85">     identity.composeHtml = false;</span>
<a href="#l2.86"></a><span id="l2.86"> </span>
<a href="#l2.87"></a><span id="l2.87">   identity.valid = true;</span>
<a href="#l2.88"></a><span id="l2.88"> </span>
<a href="#l2.89"></a><span id="l2.89">   if (config.outgoing.existingServerKey)</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineat">@@ -139,27 +135,27 @@ function createAccountInBackend(config)</span>
<a href="#l2.91"></a><span id="l2.91">   else if (!config.outgoing.useGlobalPreferredServer)</span>
<a href="#l2.92"></a><span id="l2.92">     identity.smtpServerKey = outServer.key;</span>
<a href="#l2.93"></a><span id="l2.93"> </span>
<a href="#l2.94"></a><span id="l2.94">   // account and hook up</span>
<a href="#l2.95"></a><span id="l2.95">   // Note: Setting incomingServer will cause the AccountManager to refresh</span>
<a href="#l2.96"></a><span id="l2.96">   // itself, which could be a problem if we came from it and we haven't set</span>
<a href="#l2.97"></a><span id="l2.97">   // the identity (see bug 521955), so make sure everything else on the</span>
<a href="#l2.98"></a><span id="l2.98">   // account is set up before you set the incomingServer.</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-  var account = accountManager.createAccount();</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+  let account = MailServices.accounts.createAccount();</span>
<a href="#l2.101"></a><span id="l2.101">   account.addIdentity(identity);</span>
<a href="#l2.102"></a><span id="l2.102">   account.incomingServer = inServer;</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-  if (!accountManager.defaultAccount)</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-    accountManager.defaultAccount = account;</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+  if (!MailServices.accounts.defaultAccount)</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+    MailServices.accounts.defaultAccount = account;</span>
<a href="#l2.107"></a><span id="l2.107"> </span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-  verifyLocalFoldersAccount(accountManager);</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+  verifyLocalFoldersAccount(MailServices.accounts);</span>
<a href="#l2.110"></a><span id="l2.110">   setFolders(identity, inServer);</span>
<a href="#l2.111"></a><span id="l2.111"> </span>
<a href="#l2.112"></a><span id="l2.112">   // save</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-  accountManager.saveAccountInfo();</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+  MailServices.accounts.saveAccountInfo();</span>
<a href="#l2.115"></a><span id="l2.115">   try {</span>
<a href="#l2.116"></a><span id="l2.116">     Services.prefs.savePrefFile(null);</span>
<a href="#l2.117"></a><span id="l2.117">   } catch (ex) {</span>
<a href="#l2.118"></a><span id="l2.118">     ddump(&quot;Could not write out prefs: &quot; + ex);</span>
<a href="#l2.119"></a><span id="l2.119">   }</span>
<a href="#l2.120"></a><span id="l2.120">   return account;</span>
<a href="#l2.121"></a><span id="l2.121"> }</span>
<a href="#l2.122"></a><span id="l2.122"> </span>
<a href="#l2.123"></a><span id="l2.123" class="difflineat">@@ -215,28 +211,26 @@ function rememberPassword(server, passwo</span>
<a href="#l2.124"></a><span id="l2.124">  * @param config {AccountConfig} filled in (no placeholders)</span>
<a href="#l2.125"></a><span id="l2.125">  * @return {nsIMsgIncomingServer} If it already exists, the server</span>
<a href="#l2.126"></a><span id="l2.126">  *     object is returned.</span>
<a href="#l2.127"></a><span id="l2.127">  *     If it's a new server, |null| is returned.</span>
<a href="#l2.128"></a><span id="l2.128">  */</span>
<a href="#l2.129"></a><span id="l2.129"> function checkIncomingServerAlreadyExists(config)</span>
<a href="#l2.130"></a><span id="l2.130"> {</span>
<a href="#l2.131"></a><span id="l2.131">   assert(config instanceof AccountConfig);</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-  var accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-                       .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-  var incoming = config.incoming;</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-  var existing = accountManager.findRealServer(incoming.username,</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+  let incoming = config.incoming;</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+  let existing = MailServices.accounts.findRealServer(incoming.username,</span>
<a href="#l2.138"></a><span id="l2.138">         incoming.hostname,</span>
<a href="#l2.139"></a><span id="l2.139">         sanitize.enum(incoming.type, [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]),</span>
<a href="#l2.140"></a><span id="l2.140">         incoming.port);</span>
<a href="#l2.141"></a><span id="l2.141"> </span>
<a href="#l2.142"></a><span id="l2.142">   // if username does not have an '@', also check the e-mail</span>
<a href="#l2.143"></a><span id="l2.143">   // address form of the name.</span>
<a href="#l2.144"></a><span id="l2.144">   if (!existing &amp;&amp; !incoming.username.contains(&quot;@&quot;))</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-    existing = accountManager.findRealServer(config.identity.emailAddress,</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+    existing = MailServices.accounts.findRealServer(config.identity.emailAddress,</span>
<a href="#l2.147"></a><span id="l2.147">           incoming.hostname,</span>
<a href="#l2.148"></a><span id="l2.148">           sanitize.enum(incoming.type, [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]),</span>
<a href="#l2.149"></a><span id="l2.149">           incoming.port);</span>
<a href="#l2.150"></a><span id="l2.150">   return existing;</span>
<a href="#l2.151"></a><span id="l2.151"> };</span>
<a href="#l2.152"></a><span id="l2.152"> </span>
<a href="#l2.153"></a><span id="l2.153"> /**</span>
<a href="#l2.154"></a><span id="l2.154">  * Check whether the user's setup already has an outgoing server</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineat">@@ -246,19 +240,17 @@ function checkIncomingServerAlreadyExist</span>
<a href="#l2.156"></a><span id="l2.156">  * @param config {AccountConfig} filled in (no placeholders)</span>
<a href="#l2.157"></a><span id="l2.157">  * @return {nsISmtpServer} If it already exists, the server</span>
<a href="#l2.158"></a><span id="l2.158">  *     object is returned.</span>
<a href="#l2.159"></a><span id="l2.159">  *     If it's a new server, |null| is returned.</span>
<a href="#l2.160"></a><span id="l2.160">  */</span>
<a href="#l2.161"></a><span id="l2.161"> function checkOutgoingServerAlreadyExists(config)</span>
<a href="#l2.162"></a><span id="l2.162"> {</span>
<a href="#l2.163"></a><span id="l2.163">   assert(config instanceof AccountConfig);</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-  var smtpManager = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-                    .getService(Ci.nsISmtpService);</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-  var smtpServers = smtpManager.servers;</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+  let smtpServers = MailServices.smtp.servers;</span>
<a href="#l2.168"></a><span id="l2.168">   while (smtpServers.hasMoreElements())</span>
<a href="#l2.169"></a><span id="l2.169">   {</span>
<a href="#l2.170"></a><span id="l2.170">     let existingServer = smtpServers.getNext()</span>
<a href="#l2.171"></a><span id="l2.171">         .QueryInterface(Ci.nsISmtpServer);</span>
<a href="#l2.172"></a><span id="l2.172">     // TODO check username with full email address, too, like for incoming</span>
<a href="#l2.173"></a><span id="l2.173">     if (existingServer.hostname == config.outgoing.hostname &amp;&amp;</span>
<a href="#l2.174"></a><span id="l2.174">         existingServer.port == config.outgoing.port &amp;&amp;</span>
<a href="#l2.175"></a><span id="l2.175">         existingServer.username == config.outgoing.username)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/emailWizard.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/emailWizard.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l3.5"></a><span id="l3.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l3.10"></a><span id="l3.10"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12"> /**</span>
<a href="#l3.13"></a><span id="l3.13">  * This is the dialog opened by menu File | New account | Mail... .</span>
<a href="#l3.14"></a><span id="l3.14">  *</span>
<a href="#l3.15"></a><span id="l3.15">  * It gets the user's realname, email address and password,</span>
<a href="#l3.16"></a><span id="l3.16">  * and tries to automatically configure the account from that,</span>
<a href="#l3.17"></a><span id="l3.17">  * using various mechanisms. If all fails, the user can enter/edit</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineat">@@ -194,25 +195,23 @@ EmailConfigWizard.prototype =</span>
<a href="#l3.19"></a><span id="l3.19">     // If the account provisioner is preffed off, don't display</span>
<a href="#l3.20"></a><span id="l3.20">     // the account provisioner button.</span>
<a href="#l3.21"></a><span id="l3.21">     if (!Services.prefs.getBoolPref(&quot;mail.provider.enabled&quot;))</span>
<a href="#l3.22"></a><span id="l3.22">       _hide(&quot;provisioner_button&quot;);</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24">     // Populate SMTP server dropdown with already configured SMTP servers from</span>
<a href="#l3.25"></a><span id="l3.25">     // other accounts.</span>
<a href="#l3.26"></a><span id="l3.26">     var menulist = e(&quot;outgoing_hostname&quot;);</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-    var smtpManager = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-        .getService(Ci.nsISmtpService);</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-    var smtpServers = smtpManager.servers;</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+    let smtpServers = MailServices.smtp.servers;</span>
<a href="#l3.31"></a><span id="l3.31">     while (smtpServers.hasMoreElements()) {</span>
<a href="#l3.32"></a><span id="l3.32">       let server = smtpServers.getNext().QueryInterface(Ci.nsISmtpServer);</span>
<a href="#l3.33"></a><span id="l3.33">       let label = server.displayname;</span>
<a href="#l3.34"></a><span id="l3.34">       let key = server.key;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-      if (smtpManager.defaultServer &amp;&amp;</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-          smtpManager.defaultServer.key == key) {</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+      if (MailServices.smtp.defaultServer &amp;&amp;</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+          MailServices.smtp.defaultServer.key == key) {</span>
<a href="#l3.39"></a><span id="l3.39">         label += &quot; &quot; + gStringsBundle.getString(&quot;default_server_tag&quot;);</span>
<a href="#l3.40"></a><span id="l3.40">       }</span>
<a href="#l3.41"></a><span id="l3.41">       let menuitem = menulist.appendItem(label, key, &quot;&quot;); // label,value,descr</span>
<a href="#l3.42"></a><span id="l3.42">       menuitem.serverKey = key;</span>
<a href="#l3.43"></a><span id="l3.43">     }</span>
<a href="#l3.44"></a><span id="l3.44">     // Add the entry for the new host to the menulist</span>
<a href="#l3.45"></a><span id="l3.45">     let menuitem = menulist.insertItemAt(0, &quot;&quot;, &quot;-new-&quot;); // pos,label,value</span>
<a href="#l3.46"></a><span id="l3.46">     menuitem.serverKey = null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/fetchConfig.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/fetchConfig.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -4,16 +4,17 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> /**</span>
<a href="#l4.7"></a><span id="l4.7">  * Tries to find a configuration for this ISP on the local harddisk, in the</span>
<a href="#l4.8"></a><span id="l4.8">  * application install directory's &quot;isp&quot; subdirectory.</span>
<a href="#l4.9"></a><span id="l4.9">  * Params @see fetchConfigFromISP()</span>
<a href="#l4.10"></a><span id="l4.10">  */</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l4.13"></a><span id="l4.13"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.14"></a><span id="l4.14"> Components.utils.import(&quot;resource://gre/modules/JXON.js&quot;);</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17"> function fetchConfigFromDisk(domain, successCallback, errorCallback)</span>
<a href="#l4.18"></a><span id="l4.18"> {</span>
<a href="#l4.19"></a><span id="l4.19">   return new TimeoutAbortable(runAsync(function()</span>
<a href="#l4.20"></a><span id="l4.20">   {</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -113,19 +114,17 @@ function fetchConfigFromDB(domain, succe</span>
<a href="#l4.22"></a><span id="l4.22">   let url = Services.prefs.getCharPref(&quot;mailnews.auto_config_url&quot;);</span>
<a href="#l4.23"></a><span id="l4.23">   domain = sanitize.hostname(domain);</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">   // If we don't specify a place to put the domain, put it at the end.</span>
<a href="#l4.26"></a><span id="l4.26">   if (!url.contains(&quot;{{domain}}&quot;))</span>
<a href="#l4.27"></a><span id="l4.27">     url = url + domain;</span>
<a href="#l4.28"></a><span id="l4.28">   else</span>
<a href="#l4.29"></a><span id="l4.29">     url = url.replace(&quot;{{domain}}&quot;, domain);</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-  var accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-                       .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-  url = url.replace(&quot;{{accounts}}&quot;, accountManager.accounts.length);</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+  url = url.replace(&quot;{{accounts}}&quot;, MailServices.accounts.accounts.length);</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35">   if (!url.length)</span>
<a href="#l4.36"></a><span id="l4.36">     return errorCallback(&quot;no fetch url set&quot;);</span>
<a href="#l4.37"></a><span id="l4.37">   let fetch = new FetchHTTP(url, null, false,</span>
<a href="#l4.38"></a><span id="l4.38">                             function(result)</span>
<a href="#l4.39"></a><span id="l4.39">                             {</span>
<a href="#l4.40"></a><span id="l4.40">                               successCallback(readFromXML(result));</span>
<a href="#l4.41"></a><span id="l4.41">                             },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/verifyConfig.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/verifyConfig.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -23,60 +23,60 @@</span>
<a href="#l5.4"></a><span id="l5.4">  *   Called when we could guess the config.</span>
<a href="#l5.5"></a><span id="l5.5">  *   For accountConfig, see below.</span>
<a href="#l5.6"></a><span id="l5.6">  * @param errorCallback function(ex)</span>
<a href="#l5.7"></a><span id="l5.7">  *   Called when we could guess not the config, either</span>
<a href="#l5.8"></a><span id="l5.8">  *   because we have not found anything or</span>
<a href="#l5.9"></a><span id="l5.9">  *   because there was an error (e.g. no network connection).</span>
<a href="#l5.10"></a><span id="l5.10">  *   The ex.message will contain a user-presentable message.</span>
<a href="#l5.11"></a><span id="l5.11">  */</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+</span>
<a href="#l5.15"></a><span id="l5.15"> function verifyConfig(config, alter, msgWindow, successCallback, errorCallback)</span>
<a href="#l5.16"></a><span id="l5.16"> {</span>
<a href="#l5.17"></a><span id="l5.17">   ddump(debugObject(config, &quot;config&quot;, 3));</span>
<a href="#l5.18"></a><span id="l5.18">   assert(config instanceof AccountConfig,</span>
<a href="#l5.19"></a><span id="l5.19">          &quot;BUG: Arg 'config' needs to be an AccountConfig object&quot;);</span>
<a href="#l5.20"></a><span id="l5.20">   assert(typeof(alter) == &quot;boolean&quot;);</span>
<a href="#l5.21"></a><span id="l5.21">   assert(typeof(successCallback) == &quot;function&quot;);</span>
<a href="#l5.22"></a><span id="l5.22">   assert(typeof(errorCallback) == &quot;function&quot;);</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-  var accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-                       .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-  if (accountManager.findRealServer(config.incoming.username,</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-                                    config.incoming.hostname,</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-                                    sanitize.enum(config.incoming.type,</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-                                                  [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]),</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-                                    config.incoming.port)) {</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  if (MailServices.accounts.findRealServer(config.incoming.username,</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+                                           config.incoming.hostname,</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+                                           sanitize.enum(config.incoming.type,</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+                                                         [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]),</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+                                           config.incoming.port)) {</span>
<a href="#l5.37"></a><span id="l5.37">     errorCallback(&quot;Incoming server exists&quot;);</span>
<a href="#l5.38"></a><span id="l5.38">     return;</span>
<a href="#l5.39"></a><span id="l5.39">   }</span>
<a href="#l5.40"></a><span id="l5.40"> </span>
<a href="#l5.41"></a><span id="l5.41">   // incoming server</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-  var inServer =</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-    accountManager.createIncomingServer(config.incoming.username,</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-                                        config.incoming.hostname,</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-                                        sanitize.enum(config.incoming.type,</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-                                                    [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]));</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+  let inServer =</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+    MailServices.accounts.createIncomingServer(config.incoming.username,</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+                                               config.incoming.hostname,</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+                                               sanitize.enum(config.incoming.type,</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+                                                             [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]));</span>
<a href="#l5.52"></a><span id="l5.52">   inServer.port = config.incoming.port;</span>
<a href="#l5.53"></a><span id="l5.53">   inServer.password = config.incoming.password;</span>
<a href="#l5.54"></a><span id="l5.54">   if (config.incoming.socketType == 1) // plain</span>
<a href="#l5.55"></a><span id="l5.55">     inServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l5.56"></a><span id="l5.56">   else if (config.incoming.socketType == 2) // SSL</span>
<a href="#l5.57"></a><span id="l5.57">     inServer.socketType = Ci.nsMsgSocketType.SSL;</span>
<a href="#l5.58"></a><span id="l5.58">   else if (config.incoming.socketType == 3) // STARTTLS</span>
<a href="#l5.59"></a><span id="l5.59">     inServer.socketType = Ci.nsMsgSocketType.alwaysSTARTTLS;</span>
<a href="#l5.60"></a><span id="l5.60">   inServer.authMethod = config.incoming.auth;</span>
<a href="#l5.61"></a><span id="l5.61"> </span>
<a href="#l5.62"></a><span id="l5.62">   try {</span>
<a href="#l5.63"></a><span id="l5.63">     if (inServer.password)</span>
<a href="#l5.64"></a><span id="l5.64">       verifyLogon(config, inServer, alter, msgWindow,</span>
<a href="#l5.65"></a><span id="l5.65">                   successCallback, errorCallback);</span>
<a href="#l5.66"></a><span id="l5.66">     else {</span>
<a href="#l5.67"></a><span id="l5.67">       // Avoid pref pollution, clear out server prefs.</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-      accountManager.removeIncomingServer(inServer, true);</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+      MailServices.accounts.removeIncomingServer(inServer, true);</span>
<a href="#l5.70"></a><span id="l5.70">       successCallback(config);</span>
<a href="#l5.71"></a><span id="l5.71">     }</span>
<a href="#l5.72"></a><span id="l5.72">   } catch (e) {</span>
<a href="#l5.73"></a><span id="l5.73">     ddump(&quot;ERROR: verify logon shouldn't have failed&quot;);</span>
<a href="#l5.74"></a><span id="l5.74">     errorCallback(e);</span>
<a href="#l5.75"></a><span id="l5.75">     throw(e);</span>
<a href="#l5.76"></a><span id="l5.76">   }</span>
<a href="#l5.77"></a><span id="l5.77"> };</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineat">@@ -242,19 +242,17 @@ urlListener.prototype =</span>
<a href="#l5.79"></a><span id="l5.79">     return;</span>
<a href="#l5.80"></a><span id="l5.80">   },</span>
<a href="#l5.81"></a><span id="l5.81"> </span>
<a href="#l5.82"></a><span id="l5.82">   _cleanup : function()</span>
<a href="#l5.83"></a><span id="l5.83">   {</span>
<a href="#l5.84"></a><span id="l5.84">     try {</span>
<a href="#l5.85"></a><span id="l5.85">       // Avoid pref pollution, clear out server prefs.</span>
<a href="#l5.86"></a><span id="l5.86">       if (this.mServer) {</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-        Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-          .getService(Ci.nsIMsgAccountManager)</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-          .removeIncomingServer(this.mServer, true);</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+        MailServices.accounts.removeIncomingServer(this.mServer, true);</span>
<a href="#l5.91"></a><span id="l5.91">         this.mServer = null;</span>
<a href="#l5.92"></a><span id="l5.92">       }</span>
<a href="#l5.93"></a><span id="l5.93">     } catch (e) { this._log.error(e); }</span>
<a href="#l5.94"></a><span id="l5.94">   },</span>
<a href="#l5.95"></a><span id="l5.95"> </span>
<a href="#l5.96"></a><span id="l5.96">   // Suppress any certificate errors</span>
<a href="#l5.97"></a><span id="l5.97">   notifyCertProblem: function(socketInfo, status, targetSite) {</span>
<a href="#l5.98"></a><span id="l5.98">     if (!status)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/test/unit/test_accountMgr.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_accountMgr.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -3,18 +3,17 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> /**</span>
<a href="#l6.7"></a><span id="l6.7">  * This tests that we cleanup the account prefs when the account manager is</span>
<a href="#l6.8"></a><span id="l6.8">  * loaded. This entails removing duplicate accounts from</span>
<a href="#l6.9"></a><span id="l6.9">  * mail.accountmanager.accounts list, and removing duplicate accounts with</span>
<a href="#l6.10"></a><span id="l6.10">  * the same server.</span>
<a href="#l6.11"></a><span id="l6.11">  */</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-const am = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-                     .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16"> function run_test()</span>
<a href="#l6.17"></a><span id="l6.17"> {</span>
<a href="#l6.18"></a><span id="l6.18">   // Create account prefs with both kinds of duplication.</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20">   Services.prefs.setCharPref(&quot;mail.account.account1.identities&quot;, &quot;id1&quot;);</span>
<a href="#l6.21"></a><span id="l6.21">   Services.prefs.setCharPref(&quot;mail.account.account1.server&quot;, &quot;server1&quot;);</span>
<a href="#l6.22"></a><span id="l6.22">   Services.prefs.setCharPref(&quot;mail.account.account2.identities&quot;, &quot;id2&quot;);</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineat">@@ -49,39 +48,39 @@ function run_test()</span>
<a href="#l6.24"></a><span id="l6.24">   Services.prefs.setCharPref(&quot;mail.accountmanager.accounts&quot;,</span>
<a href="#l6.25"></a><span id="l6.25">                              &quot;account1,account2,account4,account5,account5,account6&quot;);</span>
<a href="#l6.26"></a><span id="l6.26">   // Set the default account to one we're going to get rid of. The account</span>
<a href="#l6.27"></a><span id="l6.27">   //  manager should recover relatively gracefully.</span>
<a href="#l6.28"></a><span id="l6.28">   Services.prefs.setCharPref(&quot;mail.accountmanager.defaultaccount&quot;,</span>
<a href="#l6.29"></a><span id="l6.29">                              &quot;account6&quot;);</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31">   // This will force the load of the accounts setup above.</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-  do_check_eq(am.accounts.length, 3);</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+  do_check_eq(MailServices.accounts.accounts.length, 3);</span>
<a href="#l6.34"></a><span id="l6.34">   do_check_eq(Services.prefs.getCharPref(&quot;mail.accountmanager.accounts&quot;),</span>
<a href="#l6.35"></a><span id="l6.35">               &quot;account1,account4,account5&quot;);</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-  let server5 = am.getIncomingServer(&quot;server5&quot;)</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+  let server5 = MailServices.accounts.getIncomingServer(&quot;server5&quot;)</span>
<a href="#l6.38"></a><span id="l6.38">                   .QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l6.39"></a><span id="l6.39">   do_check_eq(server5.deferredToAccount, &quot;account1&quot;);</span>
<a href="#l6.40"></a><span id="l6.40"> </span>
<a href="#l6.41"></a><span id="l6.41">   // Just make sure this doesn't throw an exception, because we did remove the</span>
<a href="#l6.42"></a><span id="l6.42">   // default account.</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-  let defaultAccount = am.defaultAccount;</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+  let defaultAccount = MailServices.accounts.defaultAccount;</span>
<a href="#l6.45"></a><span id="l6.45">   // GetDefaultAccount should have thrown an exception for null account.</span>
<a href="#l6.46"></a><span id="l6.46">   do_check_neq(defaultAccount, null);</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48">   // Remove an account, and verify that the account list pref looks OK:</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-  let server = am.getIncomingServer(&quot;server4&quot;);</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+  let server = MailServices.accounts.getIncomingServer(&quot;server4&quot;);</span>
<a href="#l6.51"></a><span id="l6.51"> </span>
<a href="#l6.52"></a><span id="l6.52">   // We need to get the root folder to read from the folder cache</span>
<a href="#l6.53"></a><span id="l6.53">   // before it gets removed or else we'll assert, because we're</span>
<a href="#l6.54"></a><span id="l6.54">   // not completely initialized...</span>
<a href="#l6.55"></a><span id="l6.55">   let flags = server.rootFolder.flags;</span>
<a href="#l6.56"></a><span id="l6.56"> </span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-  am.removeAccount(am.FindAccountForServer(server));</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-  do_check_eq(am.accounts.length, 2);</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+  MailServices.accounts.removeAccount(MailServices.accounts.FindAccountForServer(server));</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+  do_check_eq(MailServices.accounts.accounts.length, 2);</span>
<a href="#l6.61"></a><span id="l6.61">   do_check_eq(Services.prefs.getCharPref(&quot;mail.accountmanager.accounts&quot;),</span>
<a href="#l6.62"></a><span id="l6.62">               &quot;account1,account5&quot;);</span>
<a href="#l6.63"></a><span id="l6.63">   // make sure cleaning up duplicate accounts didn't hork accounts</span>
<a href="#l6.64"></a><span id="l6.64">   do_check_eq(Services.prefs.getCharPref(&quot;mail.account.account1.server&quot;),</span>
<a href="#l6.65"></a><span id="l6.65">               &quot;server1&quot;);</span>
<a href="#l6.66"></a><span id="l6.66">   do_check_eq(Services.prefs.getCharPref(&quot;mail.account.account5.server&quot;),</span>
<a href="#l6.67"></a><span id="l6.67">               &quot;server5&quot;);</span>
<a href="#l6.68"></a><span id="l6.68"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/test/unit/test_acctRepair.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_acctRepair.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,18 +1,18 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.5"></a><span id="l7.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.6"></a><span id="l7.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> /**</span>
<a href="#l7.9"></a><span id="l7.9">  * This tests that we recover from having a local folders server</span>
<a href="#l7.10"></a><span id="l7.10">  * without having an account that points at it.</span>
<a href="#l7.11"></a><span id="l7.11">  */</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-const am = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-                     .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17"> function run_test()</span>
<a href="#l7.18"></a><span id="l7.18"> {</span>
<a href="#l7.19"></a><span id="l7.19">   // Create account prefs with both kinds of duplication.</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21">   Services.prefs.setCharPref(&quot;mail.account.account2.identities&quot;, &quot;id2&quot;);</span>
<a href="#l7.22"></a><span id="l7.22">   Services.prefs.setCharPref(&quot;mail.account.account2.server&quot;, &quot;server1&quot;);</span>
<a href="#l7.23"></a><span id="l7.23">   Services.prefs.setCharPref(&quot;mail.account.account6.identities&quot;, &quot;id3&quot;);</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineat">@@ -31,16 +31,16 @@ function run_test()</span>
<a href="#l7.25"></a><span id="l7.25"> </span>
<a href="#l7.26"></a><span id="l7.26">   Services.prefs.setCharPref(&quot;mail.accountmanager.accounts&quot;, &quot;account6&quot;);</span>
<a href="#l7.27"></a><span id="l7.27">   Services.prefs.setCharPref(&quot;mail.accountmanager.defaultaccount&quot;,</span>
<a href="#l7.28"></a><span id="l7.28">                              &quot;account6&quot;);</span>
<a href="#l7.29"></a><span id="l7.29">   Services.prefs.setCharPref(&quot;mail.accountmanager.localfoldersserver&quot;,</span>
<a href="#l7.30"></a><span id="l7.30">                              &quot;server1&quot;);</span>
<a href="#l7.31"></a><span id="l7.31">   // This will force the load of the accounts setup above.</span>
<a href="#l7.32"></a><span id="l7.32">   // We should have created an account for the local folders.</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-  do_check_eq(am.accounts.length, 2);</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+  do_check_eq(MailServices.accounts.accounts.length, 2);</span>
<a href="#l7.35"></a><span id="l7.35">   do_check_eq(Services.prefs.getCharPref(&quot;mail.accountmanager.accounts&quot;),</span>
<a href="#l7.36"></a><span id="l7.36">               &quot;account6,account7&quot;);</span>
<a href="#l7.37"></a><span id="l7.37">   do_check_eq(Services.prefs.getCharPref(&quot;mail.account.account7.server&quot;),</span>
<a href="#l7.38"></a><span id="l7.38">               &quot;server1&quot;);</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-  let server5 = am.getIncomingServer(&quot;server5&quot;).QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+  let server5 = MailServices.accounts.getIncomingServer(&quot;server5&quot;).QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l7.41"></a><span id="l7.41">   do_check_eq(server5.deferredToAccount, &quot;account7&quot;);</span>
<a href="#l7.42"></a><span id="l7.42"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

