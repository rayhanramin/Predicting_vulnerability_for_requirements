<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 21633:f80e43c05f8892809d13e8a0fa2d5aa839657d4a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f80e43c05f8892809d13e8a0fa2d5aa839657d4a" />
<meta property="og:url" content="/comm-central/rev/f80e43c05f8892809d13e8a0fa2d5aa839657d4a" />
<meta property="og:description" content="Bug 888915 - Convert SeaMonkey Downloads Manager to Downloads.jsm. r=IanN" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f80e43c05f8892809d13e8a0fa2d5aa839657d4a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f80e43c05f8892809d13e8a0fa2d5aa839657d4a">shortlog</a> |
<a href="/comm-central/log/f80e43c05f8892809d13e8a0fa2d5aa839657d4a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f80e43c05f8892809d13e8a0fa2d5aa839657d4a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f80e43c05f8892809d13e8a0fa2d5aa839657d4a">files</a> |
changeset |
<a href="/comm-central/raw-rev/f80e43c05f8892809d13e8a0fa2d5aa839657d4a">raw</a>  | <a href="/comm-central/archive/f80e43c05f8892809d13e8a0fa2d5aa839657d4a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=888915">Bug 888915</a> - Convert SeaMonkey Downloads Manager to Downloads.jsm. r=IanN
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#78;&#101;&#105;&#108;&#32;&#82;&#97;&#115;&#104;&#98;&#114;&#111;&#111;&#107;&#32;&#60;&#110;&#101;&#105;&#108;&#64;&#112;&#97;&#114;&#107;&#119;&#97;&#121;&#99;&#99;&#46;&#99;&#111;&#46;&#117;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 04 Jun 2017 21:52:10 +0200</td></tr>

<tr>
 <td>changeset 21633</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f80e43c05f8892809d13e8a0fa2d5aa839657d4a">f80e43c05f8892809d13e8a0fa2d5aa839657d4a</a></td>
</tr>



<tr>
<td>parent 21632</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fe87ba2b4e5b4d64822ae23abfb64f9031819dc1">fe87ba2b4e5b4d64822ae23abfb64f9031819dc1</a>
</td>
</tr>

<tr>
<td>child 21634</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c823bbbed4285550ff7c86a8dc1b05f0a352fdc9">c823bbbed4285550ff7c86a8dc1b05f0a352fdc9</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f80e43c05f8892809d13e8a0fa2d5aa839657d4a">13185</a></td></tr>
<tr><td>push user</td><td>frgrahl@gmx.net</td></tr>
<tr><td>push date</td><td class="date age">Sun, 04 Jun 2017 19:53:15 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f80e43c05f88 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f80e43c05f8892809d13e8a0fa2d5aa839657d4a">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f80e43c05f8892809d13e8a0fa2d5aa839657d4a&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f80e43c05f8892809d13e8a0fa2d5aa839657d4a&newProject=comm-central&newRevision=fe87ba2b4e5b4d64822ae23abfb64f9031819dc1&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f80e43c05f8892809d13e8a0fa2d5aa839657d4a&newProject=comm-central&newRevision=fe87ba2b4e5b4d64822ae23abfb64f9031819dc1&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f80e43c05f8892809d13e8a0fa2d5aa839657d4a&newProject=comm-central&newRevision=fe87ba2b4e5b4d64822ae23abfb64f9031819dc1&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28IanN%29&revcount=50">IanN</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=888915">888915</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=888915">Bug 888915</a> - Convert SeaMonkey Downloads Manager to Downloads.jsm. r=IanN
Check bug for current limitations and problems.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/DownloadProgressListener.js">suite/common/downloads/DownloadProgressListener.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/DownloadProgressListener.js">file</a> |
<a href="/comm-central/annotate/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/DownloadProgressListener.js">annotate</a> |
<a href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/DownloadProgressListener.js">diff</a> |
<a href="/comm-central/comparison/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/DownloadProgressListener.js">comparison</a> |
<a href="/comm-central/log/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/DownloadProgressListener.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/downloadmanager.js">suite/common/downloads/downloadmanager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/downloadmanager.js">file</a> |
<a href="/comm-central/annotate/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/downloadmanager.js">annotate</a> |
<a href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/downloadmanager.js">diff</a> |
<a href="/comm-central/comparison/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/downloadmanager.js">comparison</a> |
<a href="/comm-central/log/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/downloadmanager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/progressDialog.js">suite/common/downloads/progressDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/progressDialog.js">file</a> |
<a href="/comm-central/annotate/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/progressDialog.js">annotate</a> |
<a href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/progressDialog.js">diff</a> |
<a href="/comm-central/comparison/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/progressDialog.js">comparison</a> |
<a href="/comm-central/log/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/progressDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/treeView.js">suite/common/downloads/treeView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/treeView.js">file</a> |
<a href="/comm-central/annotate/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/treeView.js">annotate</a> |
<a href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/treeView.js">diff</a> |
<a href="/comm-central/comparison/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/treeView.js">comparison</a> |
<a href="/comm-central/log/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/downloads/treeView.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/public/nsISuiteGlue.idl">suite/common/public/nsISuiteGlue.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/public/nsISuiteGlue.idl">file</a> |
<a href="/comm-central/annotate/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/public/nsISuiteGlue.idl">annotate</a> |
<a href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/public/nsISuiteGlue.idl">diff</a> |
<a href="/comm-central/comparison/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/public/nsISuiteGlue.idl">comparison</a> |
<a href="/comm-central/log/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/public/nsISuiteGlue.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/SuiteCommon.manifest">suite/common/src/SuiteCommon.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/SuiteCommon.manifest">file</a> |
<a href="/comm-central/annotate/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/SuiteCommon.manifest">annotate</a> |
<a href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/SuiteCommon.manifest">diff</a> |
<a href="/comm-central/comparison/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/SuiteCommon.manifest">comparison</a> |
<a href="/comm-central/log/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/SuiteCommon.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/moz.build">suite/common/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/moz.build">file</a> |
<a href="/comm-central/annotate/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/moz.build">annotate</a> |
<a href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/moz.build">diff</a> |
<a href="/comm-central/comparison/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/moz.build">comparison</a> |
<a href="/comm-central/log/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/nsDownloadsStartup.js">suite/common/src/nsDownloadsStartup.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/nsDownloadsStartup.js">diff</a> |
<a href="/comm-central/comparison/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/nsDownloadsStartup.js">comparison</a> |
<a href="/comm-central/log/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/nsDownloadsStartup.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/nsSuiteGlue.js">suite/common/src/nsSuiteGlue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/nsSuiteGlue.js">file</a> |
<a href="/comm-central/annotate/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/nsSuiteGlue.js">annotate</a> |
<a href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/nsSuiteGlue.js">diff</a> |
<a href="/comm-central/comparison/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/nsSuiteGlue.js">comparison</a> |
<a href="/comm-central/log/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/src/nsSuiteGlue.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/tasksOverlay.js">suite/common/tasksOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/tasksOverlay.js">file</a> |
<a href="/comm-central/annotate/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/tasksOverlay.js">annotate</a> |
<a href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/tasksOverlay.js">diff</a> |
<a href="/comm-central/comparison/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/tasksOverlay.js">comparison</a> |
<a href="/comm-central/log/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/common/tasksOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/installer/package-manifest.in">suite/installer/package-manifest.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/installer/package-manifest.in">file</a> |
<a href="/comm-central/annotate/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/installer/package-manifest.in">annotate</a> |
<a href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/installer/package-manifest.in">diff</a> |
<a href="/comm-central/comparison/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/installer/package-manifest.in">comparison</a> |
<a href="/comm-central/log/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/installer/package-manifest.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/modules/DownloadTaskbarProgress.jsm">suite/modules/DownloadTaskbarProgress.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/modules/DownloadTaskbarProgress.jsm">file</a> |
<a href="/comm-central/annotate/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/modules/DownloadTaskbarProgress.jsm">annotate</a> |
<a href="/comm-central/diff/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/modules/DownloadTaskbarProgress.jsm">diff</a> |
<a href="/comm-central/comparison/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/modules/DownloadTaskbarProgress.jsm">comparison</a> |
<a href="/comm-central/log/f80e43c05f8892809d13e8a0fa2d5aa839657d4a/suite/modules/DownloadTaskbarProgress.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/common/downloads/DownloadProgressListener.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/common/downloads/DownloadProgressListener.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -3,56 +3,30 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> /**</span>
<a href="#l1.9"></a><span id="l1.9">  * DownloadProgressListener &quot;class&quot; is used to help update download items shown</span>
<a href="#l1.10"></a><span id="l1.10">  * in the Download Manager UI such as displaying amount transferred, transfer</span>
<a href="#l1.11"></a><span id="l1.11">  * rate, and time left for each download.</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">- *</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">- * This class implements the nsIDownloadProgressListener interface.</span>
<a href="#l1.14"></a><span id="l1.14">  */</span>
<a href="#l1.15"></a><span id="l1.15"> function DownloadProgressListener() {}</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> DownloadProgressListener.prototype = {</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-  //// nsISupports</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-  QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsIDownloadProgressListener]),</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+  onDownloadAdded: function(aDownload) {</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+    gDownloadTreeView.addDownload(aDownload);</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-  //// nsIDownloadProgressListener</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-  onDownloadStateChange: function(aState, aDownload) {</span>
<a href="#l1.29"></a><span id="l1.29">     // Update window title in-case we don't get all progress notifications</span>
<a href="#l1.30"></a><span id="l1.30">     onUpdateProgress();</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-    switch (aDownload.state) {</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-      case nsIDownloadManager.DOWNLOAD_QUEUED:</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-        gDownloadTreeView.addDownload(aDownload);</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-        break;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-      case nsIDownloadManager.DOWNLOAD_BLOCKED_POLICY:</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-        gDownloadTreeView.addDownload(aDownload);</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-        // Should fall through, this is a final state but DOWNLOAD_QUEUED</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-        // is skipped. See nsDownloadManager::AddDownload.</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-      default:</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-        gDownloadTreeView.updateDownload(aDownload);</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-        break;</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-    }</span>
<a href="#l1.45"></a><span id="l1.45">   },</span>
<a href="#l1.46"></a><span id="l1.46"> </span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-  onProgressChange: function(aWebProgress, aRequest,</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-                             aCurSelfProgress, aMaxSelfProgress,</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-                             aCurTotalProgress, aMaxTotalProgress, aDownload) {</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+  onDownloadChanged: function(aDownload) {</span>
<a href="#l1.51"></a><span id="l1.51">     gDownloadTreeView.updateDownload(aDownload);</span>
<a href="#l1.52"></a><span id="l1.52"> </span>
<a href="#l1.53"></a><span id="l1.53">     // Update window title</span>
<a href="#l1.54"></a><span id="l1.54">     onUpdateProgress();</span>
<a href="#l1.55"></a><span id="l1.55">   },</span>
<a href="#l1.56"></a><span id="l1.56"> </span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-  onStateChange: function(aWebProgress, aRequest, aState, aStatus, aDownload) {</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-  },</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-  onSecurityChange: function(aWebProgress, aRequest, aState, aDownload) {</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+  onDownloadRemoved: function(aDownload) {</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+    gDownloadTreeView.removeDownload(aDownload);</span>
<a href="#l1.63"></a><span id="l1.63">   }</span>
<a href="#l1.64"></a><span id="l1.64"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/suite/common/downloads/downloadmanager.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/suite/common/downloads/downloadmanager.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,68 +1,70 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.5"></a><span id="l2.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.6"></a><span id="l2.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/DownloadTaskbarProgress.jsm&quot;);</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Downloads.jsm&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12"> const nsIDownloadManager = Components.interfaces.nsIDownloadManager;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+const nsLocalFile = Components.Constructor(&quot;@mozilla.org/file/local;1&quot;,</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+                                           Components.interfaces.nsILocalFile,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+                                           &quot;initWithPath&quot;);</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> var gDownloadTree;</span>
<a href="#l2.18"></a><span id="l2.18"> var gDownloadTreeView;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-var gDownloadManager = Components.classes[&quot;@mozilla.org/download-manager;1&quot;]</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-                                 .getService(nsIDownloadManager);</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+var gDownloadList;</span>
<a href="#l2.22"></a><span id="l2.22"> var gDownloadStatus;</span>
<a href="#l2.23"></a><span id="l2.23"> var gDownloadListener;</span>
<a href="#l2.24"></a><span id="l2.24"> var gSearchBox;</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-var gDMUI = Components.classes[&quot;@mozilla.org/download-manager-ui;1&quot;]</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-                      .getService(Components.interfaces.nsIDownloadManagerUI);</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28"> function dmStartup()</span>
<a href="#l2.29"></a><span id="l2.29"> {</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+  Downloads.getList(Downloads.PUBLIC).then(dmAsyncStartup);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+}</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+function dmAsyncStartup(aList)</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+{</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+  gDownloadList = aList;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+</span>
<a href="#l2.37"></a><span id="l2.37">   gDownloadTree = document.getElementById(&quot;downloadTree&quot;);</span>
<a href="#l2.38"></a><span id="l2.38">   gDownloadStatus = document.getElementById(&quot;statusbar-display&quot;);</span>
<a href="#l2.39"></a><span id="l2.39">   gSearchBox = document.getElementById(&quot;search-box&quot;);</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41">   // Insert as first controller on the whole window</span>
<a href="#l2.42"></a><span id="l2.42">   window.controllers.insertControllerAt(0, dlTreeController);</span>
<a href="#l2.43"></a><span id="l2.43"> </span>
<a href="#l2.44"></a><span id="l2.44">   // We need to keep the oview object around globally to access &quot;local&quot;</span>
<a href="#l2.45"></a><span id="l2.45">   // non-nsITreeView methods</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-  gDownloadTreeView = new DownloadTreeView(gDownloadManager);</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+  gDownloadTreeView = new DownloadTreeView();</span>
<a href="#l2.48"></a><span id="l2.48">   gDownloadTree.view = gDownloadTreeView;</span>
<a href="#l2.49"></a><span id="l2.49"> </span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-  Services.obs.addObserver(gDownloadObserver, &quot;download-manager-remove-download-guid&quot;, false);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-</span>
<a href="#l2.52"></a><span id="l2.52">   // The DownloadProgressListener (DownloadProgressListener.js) handles</span>
<a href="#l2.53"></a><span id="l2.53">   // progress notifications.</span>
<a href="#l2.54"></a><span id="l2.54">   gDownloadListener = new DownloadProgressListener();</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-  gDownloadManager.addListener(gDownloadListener);</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+  gDownloadList.addView(gDownloadListener);</span>
<a href="#l2.57"></a><span id="l2.57"> </span>
<a href="#l2.58"></a><span id="l2.58">   // correct keybinding command attributes which don't do our business yet</span>
<a href="#l2.59"></a><span id="l2.59">   var key = document.getElementById(&quot;key_delete&quot;);</span>
<a href="#l2.60"></a><span id="l2.60">   if (key.hasAttribute(&quot;command&quot;))</span>
<a href="#l2.61"></a><span id="l2.61">     key.setAttribute(&quot;command&quot;, &quot;cmd_stop&quot;);</span>
<a href="#l2.62"></a><span id="l2.62">   key = document.getElementById(&quot;key_delete2&quot;);</span>
<a href="#l2.63"></a><span id="l2.63">   if (key.hasAttribute(&quot;command&quot;))</span>
<a href="#l2.64"></a><span id="l2.64">     key.setAttribute(&quot;command&quot;, &quot;cmd_stop&quot;);</span>
<a href="#l2.65"></a><span id="l2.65"> </span>
<a href="#l2.66"></a><span id="l2.66">   gDownloadTree.focus();</span>
<a href="#l2.67"></a><span id="l2.67"> </span>
<a href="#l2.68"></a><span id="l2.68">   if (gDownloadTree.view.rowCount &gt; 0)</span>
<a href="#l2.69"></a><span id="l2.69">     gDownloadTree.view.selection.select(0);</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-  DownloadTaskbarProgress.onDownloadWindowLoad(window);</span>
<a href="#l2.72"></a><span id="l2.72"> }</span>
<a href="#l2.73"></a><span id="l2.73"> </span>
<a href="#l2.74"></a><span id="l2.74"> function dmShutdown()</span>
<a href="#l2.75"></a><span id="l2.75"> {</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-  gDownloadManager.removeListener(gDownloadListener);</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-  Services.obs.removeObserver(gDownloadObserver, &quot;download-manager-remove-download-guid&quot;);</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+  gDownloadList.removeView(gDownloadListener);</span>
<a href="#l2.79"></a><span id="l2.79">   window.controllers.removeController(dlTreeController);</span>
<a href="#l2.80"></a><span id="l2.80"> }</span>
<a href="#l2.81"></a><span id="l2.81"> </span>
<a href="#l2.82"></a><span id="l2.82"> function searchDownloads(aInput)</span>
<a href="#l2.83"></a><span id="l2.83"> {</span>
<a href="#l2.84"></a><span id="l2.84">   gDownloadTreeView.searchView(aInput);</span>
<a href="#l2.85"></a><span id="l2.85"> }</span>
<a href="#l2.86"></a><span id="l2.86"> </span>
<a href="#l2.87"></a><span id="l2.87" class="difflineat">@@ -122,36 +124,38 @@ function sortDownloads(aEventTarget)</span>
<a href="#l2.88"></a><span id="l2.88"> </span>
<a href="#l2.89"></a><span id="l2.89">   if (column) {</span>
<a href="#l2.90"></a><span id="l2.90">     // Set attributes to the sorting we did</span>
<a href="#l2.91"></a><span id="l2.91">     column.setAttribute(&quot;sortActive&quot;, &quot;true&quot;);</span>
<a href="#l2.92"></a><span id="l2.92">     column.setAttribute(&quot;sortDirection&quot;, sortDirection);</span>
<a href="#l2.93"></a><span id="l2.93">   }</span>
<a href="#l2.94"></a><span id="l2.94"> }</span>
<a href="#l2.95"></a><span id="l2.95"> </span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-function retryDownload(aDownload)</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+function removeDownload(aDownload)</span>
<a href="#l2.98"></a><span id="l2.98"> {</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-  aDownload.retry();</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-  if (gDownloadTreeView)</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-    gDownloadTreeView.removeDownload(aDownload.guid);</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+  aDownload.finalize(true);</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+  gDownloadList.remove(aDownload);</span>
<a href="#l2.104"></a><span id="l2.104"> }</span>
<a href="#l2.105"></a><span id="l2.105"> </span>
<a href="#l2.106"></a><span id="l2.106"> function cancelDownload(aDownload)</span>
<a href="#l2.107"></a><span id="l2.107"> {</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-  aDownload.cancel();</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-  // delete the file if it exists</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-  var file = aDownload.targetFile;</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-  if (file.exists())</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-    file.remove(false);</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+  aDownload.cancel().then(function() {</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+    var currentBytes = aDownload.currentBytes;</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+    if (aDownload.hasPartialData) {</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+      aDownload.removePartialData().then(function() {</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+        aDownload.currentBytes = currentBytes;</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+      });</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+    }</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+  });</span>
<a href="#l2.121"></a><span id="l2.121"> }</span>
<a href="#l2.122"></a><span id="l2.122"> </span>
<a href="#l2.123"></a><span id="l2.123"> function openDownload(aDownload)</span>
<a href="#l2.124"></a><span id="l2.124"> {</span>
<a href="#l2.125"></a><span id="l2.125">   var name = aDownload.displayName;</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-  var file = aDownload.targetFile;</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+  var file = new nsLocalFile(aDownload.target.path);</span>
<a href="#l2.128"></a><span id="l2.128"> </span>
<a href="#l2.129"></a><span id="l2.129">   if (file.isExecutable()) {</span>
<a href="#l2.130"></a><span id="l2.130">     var alertOnEXEOpen = GetBoolPref(&quot;browser.download.manager.alertOnEXEOpen&quot;,</span>
<a href="#l2.131"></a><span id="l2.131">                                      true);</span>
<a href="#l2.132"></a><span id="l2.132"> </span>
<a href="#l2.133"></a><span id="l2.133">     // On Windows 7 and above, we rely on native security prompting for</span>
<a href="#l2.134"></a><span id="l2.134">     // downloaded content unless it's disabled.</span>
<a href="#l2.135"></a><span id="l2.135">     try {</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineat">@@ -193,17 +197,17 @@ function openDownload(aDownload)</span>
<a href="#l2.137"></a><span id="l2.137">     var protocolSvc = Components.classes[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l2.138"></a><span id="l2.138">                                 .getService(Components.interfaces.nsIExternalProtocolService);</span>
<a href="#l2.139"></a><span id="l2.139">     protocolSvc.loadUrl(uri);</span>
<a href="#l2.140"></a><span id="l2.140">   }</span>
<a href="#l2.141"></a><span id="l2.141"> }</span>
<a href="#l2.142"></a><span id="l2.142"> </span>
<a href="#l2.143"></a><span id="l2.143"> function showDownload(aDownload)</span>
<a href="#l2.144"></a><span id="l2.144"> {</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-  var file = aDownload.targetFile;</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+  var file = new nsLocalFile(aDownload.target.path);</span>
<a href="#l2.147"></a><span id="l2.147"> </span>
<a href="#l2.148"></a><span id="l2.148">   try {</span>
<a href="#l2.149"></a><span id="l2.149">     // Show the directory containing the file and select the file</span>
<a href="#l2.150"></a><span id="l2.150">     file.reveal();</span>
<a href="#l2.151"></a><span id="l2.151">   } catch (e) {</span>
<a href="#l2.152"></a><span id="l2.152">     // If reveal fails for some reason (e.g., it's not implemented on unix or</span>
<a href="#l2.153"></a><span id="l2.153">     // the file doesn't exist), try using the parent if we have it.</span>
<a href="#l2.154"></a><span id="l2.154">     var parent = file.parent.QueryInterface(Components.interfaces.nsILocalFile);</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineat">@@ -219,27 +223,27 @@ function showDownload(aDownload)</span>
<a href="#l2.156"></a><span id="l2.156">                                   .getService(Components.interfaces.nsIExternalProtocolService);</span>
<a href="#l2.157"></a><span id="l2.157">       protocolSvc.loadUrl(uri);</span>
<a href="#l2.158"></a><span id="l2.158">     }</span>
<a href="#l2.159"></a><span id="l2.159">   }</span>
<a href="#l2.160"></a><span id="l2.160"> }</span>
<a href="#l2.161"></a><span id="l2.161"> </span>
<a href="#l2.162"></a><span id="l2.162"> function showProperties(aDownload)</span>
<a href="#l2.163"></a><span id="l2.163"> {</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-  var dmui = Components.classes[&quot;@mozilla.org/download-manager-ui;1&quot;]</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-                       .getService(Components.interfaces.nsISuiteDownloadManagerUI);</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-  dmui.showProgress(window, aDownload);</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+  openDialog(&quot;chrome://communicator/content/downloads/progressDialog.xul&quot;,</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+             null, &quot;chrome,titlebar,centerscreen,minimizable=yes,dialog=no&quot;,</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+             { wrappedJSObject: aDownload }, true);</span>
<a href="#l2.170"></a><span id="l2.170"> }</span>
<a href="#l2.171"></a><span id="l2.171"> </span>
<a href="#l2.172"></a><span id="l2.172"> function onTreeSelect(aEvent)</span>
<a href="#l2.173"></a><span id="l2.173"> {</span>
<a href="#l2.174"></a><span id="l2.174">   var selectionCount = gDownloadTreeView.selection.count;</span>
<a href="#l2.175"></a><span id="l2.175">   if (selectionCount == 1) {</span>
<a href="#l2.176"></a><span id="l2.176">     var selItemData = gDownloadTreeView.getRowData(gDownloadTree.currentIndex);</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-    gDownloadStatus.label = GetFileFromString(selItemData.file).path;</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+    gDownloadStatus.label = selItemData.target.path;</span>
<a href="#l2.179"></a><span id="l2.179">   } else {</span>
<a href="#l2.180"></a><span id="l2.180">     gDownloadStatus.label = &quot;&quot;;</span>
<a href="#l2.181"></a><span id="l2.181">   }</span>
<a href="#l2.182"></a><span id="l2.182"> </span>
<a href="#l2.183"></a><span id="l2.183">   window.updateCommands(&quot;tree-select&quot;);</span>
<a href="#l2.184"></a><span id="l2.184"> }</span>
<a href="#l2.185"></a><span id="l2.185"> </span>
<a href="#l2.186"></a><span id="l2.186"> function onUpdateViewColumns(aMenuItem)</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineat">@@ -297,36 +301,35 @@ function onUpdateViewSort(aMenuItem)</span>
<a href="#l2.188"></a><span id="l2.188">   }</span>
<a href="#l2.189"></a><span id="l2.189"> }</span>
<a href="#l2.190"></a><span id="l2.190"> </span>
<a href="#l2.191"></a><span id="l2.191"> // This is called by the progress listener.</span>
<a href="#l2.192"></a><span id="l2.192"> var gLastComputedMean = -1;</span>
<a href="#l2.193"></a><span id="l2.193"> var gLastActiveDownloads = 0;</span>
<a href="#l2.194"></a><span id="l2.194"> function onUpdateProgress()</span>
<a href="#l2.195"></a><span id="l2.195"> {</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-  var numActiveDownloads = gDownloadManager.activeDownloadCount;</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+  var dls = gDownloadTreeView.getActiveDownloads();</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+  var numActiveDownloads = dls.length;</span>
<a href="#l2.199"></a><span id="l2.199"> </span>
<a href="#l2.200"></a><span id="l2.200">   // Use the default title and reset &quot;last&quot; values if there's no downloads</span>
<a href="#l2.201"></a><span id="l2.201">   if (numActiveDownloads == 0) {</span>
<a href="#l2.202"></a><span id="l2.202">     document.title = document.documentElement.getAttribute(&quot;statictitle&quot;);</span>
<a href="#l2.203"></a><span id="l2.203">     gLastComputedMean = -1;</span>
<a href="#l2.204"></a><span id="l2.204">     gLastActiveDownloads = 0;</span>
<a href="#l2.205"></a><span id="l2.205"> </span>
<a href="#l2.206"></a><span id="l2.206">     return;</span>
<a href="#l2.207"></a><span id="l2.207">   }</span>
<a href="#l2.208"></a><span id="l2.208"> </span>
<a href="#l2.209"></a><span id="l2.209">   // Establish the mean transfer speed and amount downloaded.</span>
<a href="#l2.210"></a><span id="l2.210">   var mean = 0;</span>
<a href="#l2.211"></a><span id="l2.211">   var base = 0;</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-  var dls = gDownloadManager.activeDownloads;</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-  while (dls.hasMoreElements()) {</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-    var dl = dls.getNext();</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-    if (dl.percentComplete &lt; 100 &amp;&amp; dl.size &gt; 0) {</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-      mean += dl.amountTransferred;</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-      base += dl.size;</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+  for (var dl of dls) {</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+    if (dl.totalBytes &gt; 0) {</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+      mean += dl.currentBytes;</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+      base += dl.totalBytes;</span>
<a href="#l2.222"></a><span id="l2.222">     }</span>
<a href="#l2.223"></a><span id="l2.223">   }</span>
<a href="#l2.224"></a><span id="l2.224"> </span>
<a href="#l2.225"></a><span id="l2.225">   // Calculate the percent transferred, unless we don't have a total file size</span>
<a href="#l2.226"></a><span id="l2.226">   var dlbundle = document.getElementById(&quot;dmBundle&quot;);</span>
<a href="#l2.227"></a><span id="l2.227">   if (base != 0)</span>
<a href="#l2.228"></a><span id="l2.228">     mean = Math.floor((mean / base) * 100);</span>
<a href="#l2.229"></a><span id="l2.229"> </span>
<a href="#l2.230"></a><span id="l2.230" class="difflineat">@@ -365,37 +368,20 @@ function handlePaste() {</span>
<a href="#l2.231"></a><span id="l2.231">     let data = {};</span>
<a href="#l2.232"></a><span id="l2.232">     trans.getAnyTransferData({}, data, {});</span>
<a href="#l2.233"></a><span id="l2.233">     let [url, name] = data.value.QueryInterface(Components.interfaces</span>
<a href="#l2.234"></a><span id="l2.234">                                 .nsISupportsString).data.split(&quot;\n&quot;);</span>
<a href="#l2.235"></a><span id="l2.235"> </span>
<a href="#l2.236"></a><span id="l2.236">     if (!url)</span>
<a href="#l2.237"></a><span id="l2.237">       return;</span>
<a href="#l2.238"></a><span id="l2.238"> </span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-    let uri = Services.io.newURI(url);</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">-</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-    saveURL(uri.spec, name || uri.spec, null, true, true, null, document);</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+    DownloadURL(url, name || url, document);</span>
<a href="#l2.243"></a><span id="l2.243">   } catch (ex) {}</span>
<a href="#l2.244"></a><span id="l2.244"> }</span>
<a href="#l2.245"></a><span id="l2.245"> </span>
<a href="#l2.246"></a><span id="l2.246" class="difflineminus">-var gDownloadObserver = {</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineminus">-    switch (aTopic) {</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-      case &quot;download-manager-remove-download-guid&quot;:</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-        if (aSubject instanceof Components.interfaces.nsISupportsCString)</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-          // We have a single download.</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-          gDownloadTreeView.removeDownload(aSubject.data);</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-        else</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-          // A null subject here indicates &quot;remove multiple&quot;, so we just rebuild.</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-          gDownloadTreeView.initTree();</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-      break;</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineminus">-    }</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineminus">-  }</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-};</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-</span>
<a href="#l2.261"></a><span id="l2.261"> var dlTreeController = {</span>
<a href="#l2.262"></a><span id="l2.262">   supportsCommand: function(aCommand)</span>
<a href="#l2.263"></a><span id="l2.263">   {</span>
<a href="#l2.264"></a><span id="l2.264">     switch (aCommand) {</span>
<a href="#l2.265"></a><span id="l2.265">       case &quot;cmd_play&quot;:</span>
<a href="#l2.266"></a><span id="l2.266">       case &quot;cmd_pause&quot;:</span>
<a href="#l2.267"></a><span id="l2.267">       case &quot;cmd_resume&quot;:</span>
<a href="#l2.268"></a><span id="l2.268">       case &quot;cmd_retry&quot;:</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineat">@@ -434,86 +420,81 @@ var dlTreeController = {</span>
<a href="#l2.270"></a><span id="l2.270">       }</span>
<a href="#l2.271"></a><span id="l2.271">     }</span>
<a href="#l2.272"></a><span id="l2.272"> </span>
<a href="#l2.273"></a><span id="l2.273">     switch (aCommand) {</span>
<a href="#l2.274"></a><span id="l2.274">       case &quot;cmd_play&quot;:</span>
<a href="#l2.275"></a><span id="l2.275">         if (!selectionCount)</span>
<a href="#l2.276"></a><span id="l2.276">           return false;</span>
<a href="#l2.277"></a><span id="l2.277">         for (let dldata of selItemData) {</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-          if (dldata.state != nsIDownloadManager.DOWNLOAD_CANCELED &amp;&amp;</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-              dldata.state != nsIDownloadManager.DOWNLOAD_FAILED &amp;&amp;</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineminus">-              (!dldata.resumable ||</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-               (!dldata.isActive &amp;&amp;</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineminus">-                dldata.state != nsIDownloadManager.DOWNLOAD_PAUSED)))</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+          if (dldata.succeeded || (!dldata.stopped &amp;&amp; !dldata.hasPartialData))</span>
<a href="#l2.284"></a><span id="l2.284">             return false;</span>
<a href="#l2.285"></a><span id="l2.285">         }</span>
<a href="#l2.286"></a><span id="l2.286">         return true;</span>
<a href="#l2.287"></a><span id="l2.287">       case &quot;cmd_pause&quot;:</span>
<a href="#l2.288"></a><span id="l2.288">         if (!selectionCount)</span>
<a href="#l2.289"></a><span id="l2.289">           return false;</span>
<a href="#l2.290"></a><span id="l2.290">         for (let dldata of selItemData) {</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineminus">-          if (!dldata.isActive ||</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineminus">-              dldata.state == nsIDownloadManager.DOWNLOAD_PAUSED ||</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-              !dldata.resumable)</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+          if (dldata.stopped || !dldata.hasPartialData)</span>
<a href="#l2.295"></a><span id="l2.295">             return false;</span>
<a href="#l2.296"></a><span id="l2.296">         }</span>
<a href="#l2.297"></a><span id="l2.297">         return true;</span>
<a href="#l2.298"></a><span id="l2.298">       case &quot;cmd_resume&quot;:</span>
<a href="#l2.299"></a><span id="l2.299">         if (!selectionCount)</span>
<a href="#l2.300"></a><span id="l2.300">           return false;</span>
<a href="#l2.301"></a><span id="l2.301">         for (let dldata of selItemData) {</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineminus">-          if (dldata.state != nsIDownloadManager.DOWNLOAD_PAUSED ||</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineminus">-              !dldata.resumable)</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineplus">+          if (!dldata.stopped || !dldata.hasPartialData)</span>
<a href="#l2.305"></a><span id="l2.305">             return false;</span>
<a href="#l2.306"></a><span id="l2.306">         }</span>
<a href="#l2.307"></a><span id="l2.307">         return true;</span>
<a href="#l2.308"></a><span id="l2.308">       case &quot;cmd_open&quot;:</span>
<a href="#l2.309"></a><span id="l2.309">         return selectionCount == 1 &amp;&amp;</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineminus">-               selItemData[0].state == nsIDownloadManager.DOWNLOAD_FINISHED &amp;&amp;</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineminus">-               GetFileFromString(selItemData[0].file).exists();</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+               selItemData[0].succeeded &amp;&amp;</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+               selItemData[0].target.exists;</span>
<a href="#l2.314"></a><span id="l2.314">       case &quot;cmd_show&quot;:</span>
<a href="#l2.315"></a><span id="l2.315">         return selectionCount == 1 &amp;&amp;</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-               GetFileFromString(selItemData[0].file).exists();</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+               selItemData[0].target.exists;</span>
<a href="#l2.318"></a><span id="l2.318">       case &quot;cmd_cancel&quot;:</span>
<a href="#l2.319"></a><span id="l2.319">         if (!selectionCount)</span>
<a href="#l2.320"></a><span id="l2.320">           return false;</span>
<a href="#l2.321"></a><span id="l2.321">         for (let dldata of selItemData) {</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineminus">-          if (!dldata.isActive)</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineplus">+          if (dldata.stopped &amp;&amp; !dldata.hasPartialData)</span>
<a href="#l2.324"></a><span id="l2.324">             return false;</span>
<a href="#l2.325"></a><span id="l2.325">         }</span>
<a href="#l2.326"></a><span id="l2.326">         return true;</span>
<a href="#l2.327"></a><span id="l2.327">       case &quot;cmd_retry&quot;:</span>
<a href="#l2.328"></a><span id="l2.328">         if (!selectionCount)</span>
<a href="#l2.329"></a><span id="l2.329">           return false;</span>
<a href="#l2.330"></a><span id="l2.330">         for (let dldata of selItemData) {</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-          if (dldata.state != nsIDownloadManager.DOWNLOAD_CANCELED &amp;&amp;</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineminus">-              dldata.state != nsIDownloadManager.DOWNLOAD_FAILED)</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+          if (dldata.succeeded || !dldata.stopped || dldata.hasPartialData)</span>
<a href="#l2.334"></a><span id="l2.334">             return false;</span>
<a href="#l2.335"></a><span id="l2.335">         }</span>
<a href="#l2.336"></a><span id="l2.336">         return true;</span>
<a href="#l2.337"></a><span id="l2.337">       case &quot;cmd_remove&quot;:</span>
<a href="#l2.338"></a><span id="l2.338">         if (!selectionCount)</span>
<a href="#l2.339"></a><span id="l2.339">           return false;</span>
<a href="#l2.340"></a><span id="l2.340">         for (let dldata of selItemData) {</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineminus">-          if (dldata.isActive)</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineplus">+          if (!dldata.stopped)</span>
<a href="#l2.343"></a><span id="l2.343">             return false;</span>
<a href="#l2.344"></a><span id="l2.344">         }</span>
<a href="#l2.345"></a><span id="l2.345">         return true;</span>
<a href="#l2.346"></a><span id="l2.346">       case &quot;cmd_openReferrer&quot;:</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineminus">-        return selectionCount == 1 &amp;&amp; !!selItemData[0].referrer;</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+        return selectionCount == 1 &amp;&amp; !!selItemData[0].source.referrer;</span>
<a href="#l2.349"></a><span id="l2.349">       case &quot;cmd_stop&quot;:</span>
<a href="#l2.350"></a><span id="l2.350">       case &quot;cmd_copyLocation&quot;:</span>
<a href="#l2.351"></a><span id="l2.351">         return selectionCount &gt; 0;</span>
<a href="#l2.352"></a><span id="l2.352">       case &quot;cmd_properties&quot;:</span>
<a href="#l2.353"></a><span id="l2.353">         return selectionCount == 1;</span>
<a href="#l2.354"></a><span id="l2.354">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l2.355"></a><span id="l2.355">         return gDownloadTreeView.rowCount != selectionCount;</span>
<a href="#l2.356"></a><span id="l2.356">       case &quot;cmd_clearList&quot;:</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineminus">-        return gDownloadTreeView.rowCount &amp;&amp; gDownloadManager.canCleanUp;</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineplus">+        // Since active downloads always sort before removable downloads,</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineplus">+        // we only need to check that the last download has stopped.</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineplus">+        return gDownloadTreeView.rowCount &amp;&amp;</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineplus">+               gDownloadTreeView.getRowData(gDownloadTreeView.rowCount - 1).isActive;</span>
<a href="#l2.362"></a><span id="l2.362">       case &quot;cmd_paste&quot;:</span>
<a href="#l2.363"></a><span id="l2.363">         return true;</span>
<a href="#l2.364"></a><span id="l2.364">       default:</span>
<a href="#l2.365"></a><span id="l2.365">         return false;</span>
<a href="#l2.366"></a><span id="l2.366">     }</span>
<a href="#l2.367"></a><span id="l2.367">   },</span>
<a href="#l2.368"></a><span id="l2.368"> </span>
<a href="#l2.369"></a><span id="l2.369">   doCommand: function(aCommand) {</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineat">@@ -532,97 +513,83 @@ var dlTreeController = {</span>
<a href="#l2.371"></a><span id="l2.371">         for (let row = start.value; row &lt;= end.value; row++)</span>
<a href="#l2.372"></a><span id="l2.372">           selItemData.push(gDownloadTreeView.getRowData(row));</span>
<a href="#l2.373"></a><span id="l2.373">       }</span>
<a href="#l2.374"></a><span id="l2.374">     }</span>
<a href="#l2.375"></a><span id="l2.375"> </span>
<a href="#l2.376"></a><span id="l2.376">     switch (aCommand) {</span>
<a href="#l2.377"></a><span id="l2.377">       case &quot;cmd_play&quot;:</span>
<a href="#l2.378"></a><span id="l2.378">         for (let dldata of selItemData) {</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineminus">-          switch (dldata.state) {</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineminus">-            case nsIDownloadManager.DOWNLOAD_DOWNLOADING:</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineminus">-              dldata.dld.pause();</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineminus">-              break;</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineminus">-            case nsIDownloadManager.DOWNLOAD_PAUSED:</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineminus">-              dldata.dld.resume();</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineminus">-              break;</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineminus">-            case nsIDownloadManager.DOWNLOAD_FAILED:</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineminus">-            case nsIDownloadManager.DOWNLOAD_CANCELED:</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineminus">-              retryDownload(dldata.dld);</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineminus">-              break;</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineminus">-          }</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineplus">+          if (!dldata.stopped)</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineplus">+            dldata.cancel();</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+          else if (!dldata.succeeded)</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineplus">+            dldata.start();</span>
<a href="#l2.395"></a><span id="l2.395">         }</span>
<a href="#l2.396"></a><span id="l2.396">         break;</span>
<a href="#l2.397"></a><span id="l2.397">       case &quot;cmd_pause&quot;:</span>
<a href="#l2.398"></a><span id="l2.398">         for (let dldata of selItemData)</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineminus">-          dldata.dld.pause();</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineplus">+          dldata.cancel();</span>
<a href="#l2.401"></a><span id="l2.401">         break;</span>
<a href="#l2.402"></a><span id="l2.402">       case &quot;cmd_resume&quot;:</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineminus">-        for (let dldata of selItemData)</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineminus">-          dldata.dld.resume();</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineminus">-        break;</span>
<a href="#l2.406"></a><span id="l2.406">       case &quot;cmd_retry&quot;:</span>
<a href="#l2.407"></a><span id="l2.407">         for (let dldata of selItemData)</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineminus">-          retryDownload(dldata.dld);</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineplus">+          dldata.start();</span>
<a href="#l2.410"></a><span id="l2.410">         break;</span>
<a href="#l2.411"></a><span id="l2.411">       case &quot;cmd_cancel&quot;:</span>
<a href="#l2.412"></a><span id="l2.412">         for (let dldata of selItemData)</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineminus">-          cancelDownload(dldata.dld);</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineplus">+          cancelDownload(dldata);</span>
<a href="#l2.415"></a><span id="l2.415">         break;</span>
<a href="#l2.416"></a><span id="l2.416">       case &quot;cmd_remove&quot;:</span>
<a href="#l2.417"></a><span id="l2.417">         for (let dldata of selItemData)</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineminus">-          dldata.dld.remove();</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineplus">+          removeDownload(dldata);</span>
<a href="#l2.420"></a><span id="l2.420">         break;</span>
<a href="#l2.421"></a><span id="l2.421">       case &quot;cmd_stop&quot;:</span>
<a href="#l2.422"></a><span id="l2.422">         for (let dldata of selItemData) {</span>
<a href="#l2.423"></a><span id="l2.423">           if (dldata.isActive)</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineminus">-            cancelDownload(dldata.dld);</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineplus">+            cancelDownload(dldata);</span>
<a href="#l2.426"></a><span id="l2.426">           else</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineminus">-            dldata.dld.remove();</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineplus">+            gDownloadList.remove(dldata);</span>
<a href="#l2.429"></a><span id="l2.429">         }</span>
<a href="#l2.430"></a><span id="l2.430">         break;</span>
<a href="#l2.431"></a><span id="l2.431">       case &quot;cmd_open&quot;:</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineminus">-        openDownload(selItemData[0].dld);</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineplus">+        openDownload(selItemData[0]);</span>
<a href="#l2.434"></a><span id="l2.434">         break;</span>
<a href="#l2.435"></a><span id="l2.435">       case &quot;cmd_show&quot;:</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineminus">-        showDownload(selItemData[0].dld);</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineplus">+        showDownload(selItemData[0]);</span>
<a href="#l2.438"></a><span id="l2.438">         break;</span>
<a href="#l2.439"></a><span id="l2.439">       case &quot;cmd_openReferrer&quot;:</span>
<a href="#l2.440"></a><span id="l2.440">         openUILink(selItemData[0].referrer);</span>
<a href="#l2.441"></a><span id="l2.441">         break;</span>
<a href="#l2.442"></a><span id="l2.442">       case &quot;cmd_copyLocation&quot;:</span>
<a href="#l2.443"></a><span id="l2.443">         var clipboard = Components.classes[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l2.444"></a><span id="l2.444">                                   .getService(Components.interfaces.nsIClipboardHelper);</span>
<a href="#l2.445"></a><span id="l2.445">         var uris = [];</span>
<a href="#l2.446"></a><span id="l2.446">         for (let dldata of selItemData)</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineminus">-          uris.push(dldata.uri);</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineminus">-        clipboard.copyString(uris.join(&quot;\n&quot;));</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineplus">+          uris.push(dldata.source.url);</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineplus">+          clipboard.copyString(uris.join(&quot;\n&quot;), document);</span>
<a href="#l2.451"></a><span id="l2.451">         break;</span>
<a href="#l2.452"></a><span id="l2.452">       case &quot;cmd_properties&quot;:</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineminus">-        showProperties(selItemData[0].dld);</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineplus">+        showProperties(selItemData[0]);</span>
<a href="#l2.455"></a><span id="l2.455">         break;</span>
<a href="#l2.456"></a><span id="l2.456">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l2.457"></a><span id="l2.457">         gDownloadTreeView.selection.selectAll();</span>
<a href="#l2.458"></a><span id="l2.458">         break;</span>
<a href="#l2.459"></a><span id="l2.459">       case &quot;cmd_clearList&quot;:</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineminus">-        // Clear the whole list if there's no search</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineminus">-        if (gSearchBox.value == &quot;&quot;) {</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineminus">-          gDownloadManager.cleanUp();</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineminus">-          return;</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineminus">-        }</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineminus">-</span>
<a href="#l2.466"></a><span id="l2.466">         // Remove each download starting from the end until we hit a download</span>
<a href="#l2.467"></a><span id="l2.467">         // that is in progress</span>
<a href="#l2.468"></a><span id="l2.468">         for (let idx = gDownloadTreeView.rowCount - 1; idx &gt;= 0; idx--) {</span>
<a href="#l2.469"></a><span id="l2.469">           let dldata = gDownloadTreeView.getRowData(idx);</span>
<a href="#l2.470"></a><span id="l2.470">           if (!dldata.isActive) {</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineminus">-            dldata.dld.remove();</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineplus">+            gDownloadList.remove(dldata);</span>
<a href="#l2.473"></a><span id="l2.473">           }</span>
<a href="#l2.474"></a><span id="l2.474">         }</span>
<a href="#l2.475"></a><span id="l2.475"> </span>
<a href="#l2.476"></a><span id="l2.476" class="difflineplus">+        if (!gSearchBox.value)</span>
<a href="#l2.477"></a><span id="l2.477" class="difflineplus">+          break;</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineplus">+</span>
<a href="#l2.479"></a><span id="l2.479">         // Clear the input as if the user did it and move focus to the list</span>
<a href="#l2.480"></a><span id="l2.480">         gSearchBox.value = &quot;&quot;;</span>
<a href="#l2.481"></a><span id="l2.481">         searchDownloads(&quot;&quot;);</span>
<a href="#l2.482"></a><span id="l2.482">         gDownloadTree.focus();</span>
<a href="#l2.483"></a><span id="l2.483">         break;</span>
<a href="#l2.484"></a><span id="l2.484">       case &quot;cmd_paste&quot;:</span>
<a href="#l2.485"></a><span id="l2.485">         handlePaste();</span>
<a href="#l2.486"></a><span id="l2.486">         break;</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineat">@@ -650,17 +617,17 @@ var gDownloadDNDObserver = {</span>
<a href="#l2.488"></a><span id="l2.488">   onDragStart: function (aEvent)</span>
<a href="#l2.489"></a><span id="l2.489">   {</span>
<a href="#l2.490"></a><span id="l2.490">     if (!gDownloadTreeView ||</span>
<a href="#l2.491"></a><span id="l2.491">         !gDownloadTreeView.selection ||</span>
<a href="#l2.492"></a><span id="l2.492">         !gDownloadTreeView.selection.count)</span>
<a href="#l2.493"></a><span id="l2.493">       return;</span>
<a href="#l2.494"></a><span id="l2.494"> </span>
<a href="#l2.495"></a><span id="l2.495">     var selItemData = gDownloadTreeView.getRowData(gDownloadTree.currentIndex);</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineminus">-    var file = GetFileFromString(selItemData.file);</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineplus">+    var file = new nsLocalFile(selItemData.target.path);</span>
<a href="#l2.498"></a><span id="l2.498"> </span>
<a href="#l2.499"></a><span id="l2.499">     if (!file.exists())</span>
<a href="#l2.500"></a><span id="l2.500">       return;</span>
<a href="#l2.501"></a><span id="l2.501"> </span>
<a href="#l2.502"></a><span id="l2.502">     var url = Services.io.newFileURI(file).spec;</span>
<a href="#l2.503"></a><span id="l2.503">     var dt = aEvent.dataTransfer;</span>
<a href="#l2.504"></a><span id="l2.504">     dt.mozSetDataAt(&quot;application/x-moz-file&quot;, file, 0);</span>
<a href="#l2.505"></a><span id="l2.505">     dt.setData(&quot;text/uri-list&quot;, url + &quot;\r\n&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/suite/common/downloads/progressDialog.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/suite/common/downloads/progressDialog.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,43 +1,38 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l3.9"></a><span id="l3.9"> Components.utils.import(&quot;resource://gre/modules/DownloadUtils.jsm&quot;);</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-// nsIDownloadManager, gDownloadManager, gDownloadListener</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-// are defined in downloadmanager.js</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-</span>
<a href="#l3.14"></a><span id="l3.14"> var gDownload;</span>
<a href="#l3.15"></a><span id="l3.15"> var gDownloadBundle;</span>
<a href="#l3.16"></a><span id="l3.16"> var gTkDlBundle;</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+var gDlList;</span>
<a href="#l3.19"></a><span id="l3.19"> var gDlStatus;</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+var gDlListener;</span>
<a href="#l3.21"></a><span id="l3.21"> var gDlSize;</span>
<a href="#l3.22"></a><span id="l3.22"> var gTimeElapsed;</span>
<a href="#l3.23"></a><span id="l3.23"> var gProgressMeter;</span>
<a href="#l3.24"></a><span id="l3.24"> var gProgressText;</span>
<a href="#l3.25"></a><span id="l3.25"> var gCloseWhenDone;</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27"> var gLastSec = Infinity;</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-var gStartTime = 0;</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-var gEndTime = Date.now(); // gets corrected below for calls from dlmgr</span>
<a href="#l3.30"></a><span id="l3.30"> var gDlActive = false;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-var gRetrying = false;</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33"> function progressStartup() {</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-  gDownload = window.arguments[0];</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+  gDownload = window.arguments[0].wrappedJSObject;</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  Downloads.getList(gDownload.source.isPrivate ? Downloads.PRIVATE : Downloads.PUBLIC).then(progressAsyncStartup);</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+}</span>
<a href="#l3.38"></a><span id="l3.38"> </span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-  var recentDMWindow = Services.wm.getMostRecentWindow(&quot;Download:Manager&quot;);</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-  if (recentDMWindow &amp;&amp;</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-      gDownload.guid in recentDMWindow.gDownloadTreeView._dlMap)</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-    // we have been opened by a download manager, get the end time from there</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-    gEndTime = recentDMWindow.gDownloadTreeView._dlMap[gDownload.guid].endTime;</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+function progressAsyncStartup(aList) {</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+  gDlList = aList;</span>
<a href="#l3.46"></a><span id="l3.46"> </span>
<a href="#l3.47"></a><span id="l3.47">   // cache elements to save .getElementById() calls</span>
<a href="#l3.48"></a><span id="l3.48">   gDownloadBundle = document.getElementById(&quot;dmBundle&quot;);</span>
<a href="#l3.49"></a><span id="l3.49">   gTkDlBundle = document.getElementById(&quot;tkdlBundle&quot;);</span>
<a href="#l3.50"></a><span id="l3.50">   gDlStatus = document.getElementById(&quot;dlStatus&quot;);</span>
<a href="#l3.51"></a><span id="l3.51">   gDlSize = document.getElementById(&quot;dlSize&quot;);</span>
<a href="#l3.52"></a><span id="l3.52">   gTimeElapsed = document.getElementById(&quot;timeElapsed&quot;);</span>
<a href="#l3.53"></a><span id="l3.53">   gProgressMeter = document.getElementById(&quot;progressMeter&quot;);</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineat">@@ -47,96 +42,68 @@ function progressStartup() {</span>
<a href="#l3.55"></a><span id="l3.55">   // Insert as first controller on the whole window</span>
<a href="#l3.56"></a><span id="l3.56">   window.controllers.insertControllerAt(0, ProgressDlgController);</span>
<a href="#l3.57"></a><span id="l3.57"> </span>
<a href="#l3.58"></a><span id="l3.58">   if (gDownload.isPrivate)</span>
<a href="#l3.59"></a><span id="l3.59">     gCloseWhenDone.hidden = true;</span>
<a href="#l3.60"></a><span id="l3.60">   else</span>
<a href="#l3.61"></a><span id="l3.61">     gCloseWhenDone.checked = Services.prefs.getBoolPref(&quot;browser.download.progress.closeWhenDone&quot;);</span>
<a href="#l3.62"></a><span id="l3.62"> </span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-  switch (gDownload.state) {</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-    case nsIDownloadManager.DOWNLOAD_NOTSTARTED:</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-    case nsIDownloadManager.DOWNLOAD_DOWNLOADING:</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-    case nsIDownloadManager.DOWNLOAD_PAUSED:</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-    case nsIDownloadManager.DOWNLOAD_QUEUED:</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-    case nsIDownloadManager.DOWNLOAD_SCANNING:</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-      gDlActive = true;</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-      break;</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-    case nsIDownloadManager.DOWNLOAD_FINISHED:</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-      if (gCloseWhenDone.checked &amp;&amp; window.arguments[1])</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-        window.close();</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-    default:</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-      gDlActive = false;</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-      break;</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+  if (gDownload.succeeded) {</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+    if (gCloseWhenDone.checked &amp;&amp; !window.arguments[1])</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+      window.close();</span>
<a href="#l3.80"></a><span id="l3.80">   }</span>
<a href="#l3.81"></a><span id="l3.81"> </span>
<a href="#l3.82"></a><span id="l3.82">   var fName = document.getElementById(&quot;fileName&quot;);</span>
<a href="#l3.83"></a><span id="l3.83">   var fSource = document.getElementById(&quot;fileSource&quot;);</span>
<a href="#l3.84"></a><span id="l3.84">   fName.label = gDownload.displayName;</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-  fName.tooltipText = gDownload.target.spec;</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+  fName.tooltipText = gDownload.target.path;</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+  var uri = Services.io.newURI(gDownload.source.url, null, null);</span>
<a href="#l3.88"></a><span id="l3.88">   var fromString;</span>
<a href="#l3.89"></a><span id="l3.89">   try {</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-    fromString = gDownload.source.host;</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+    fromString = uri.host;</span>
<a href="#l3.92"></a><span id="l3.92">   }</span>
<a href="#l3.93"></a><span id="l3.93">   catch (e) { }</span>
<a href="#l3.94"></a><span id="l3.94">   if (!fromString)</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-    fromString = gDownload.source.prePath;</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+    fromString = uri.prePath;</span>
<a href="#l3.97"></a><span id="l3.97">   fSource.label = gDownloadBundle.getFormattedString(&quot;fromSource&quot;, [fromString]);</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-  fSource.tooltipText = gDownload.source.spec;</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+  fSource.tooltipText = gDownload.source.url;</span>
<a href="#l3.100"></a><span id="l3.100"> </span>
<a href="#l3.101"></a><span id="l3.101">   // The DlProgressListener handles progress notifications.</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-  gDownloadListener = new DlProgressListener();</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-  gDownloadManager.addPrivacyAwareListener(gDownloadListener);</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+  gDlListener = new DlProgressListener();</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+  gDlList.addView(gDlListener);</span>
<a href="#l3.106"></a><span id="l3.106"> </span>
<a href="#l3.107"></a><span id="l3.107">   updateDownload();</span>
<a href="#l3.108"></a><span id="l3.108">   updateButtons();</span>
<a href="#l3.109"></a><span id="l3.109">   window.updateCommands(&quot;dlstate-change&quot;);</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-  // Send a notification that we finished</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-  setTimeout(() =&gt;</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-    Services.obs.notifyObservers(window, &quot;download-manager-ui-done&quot;, null), 0);</span>
<a href="#l3.114"></a><span id="l3.114"> }</span>
<a href="#l3.115"></a><span id="l3.115"> </span>
<a href="#l3.116"></a><span id="l3.116"> function progressShutdown() {</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-  gDownloadManager.removeListener(gDownloadListener);</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+  gDlList.removeView(gDlListener);</span>
<a href="#l3.119"></a><span id="l3.119">   window.controllers.removeController(ProgressDlgController);</span>
<a href="#l3.120"></a><span id="l3.120">   if (!gCloseWhenDone.hidden)</span>
<a href="#l3.121"></a><span id="l3.121">     Services.prefs.setBoolPref(&quot;browser.download.progress.closeWhenDone&quot;,</span>
<a href="#l3.122"></a><span id="l3.122">                                gCloseWhenDone.checked);</span>
<a href="#l3.123"></a><span id="l3.123"> }</span>
<a href="#l3.124"></a><span id="l3.124"> </span>
<a href="#l3.125"></a><span id="l3.125"> function updateDownload() {</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-  switch (gDownload.state) {</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-    case nsIDownloadManager.DOWNLOAD_DOWNLOADING:</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-      // At this point, we know if we are an indeterminate download or not.</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-      if (gDownload.percentComplete == -1) {</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-        gProgressText.hidden = true;</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-        gProgressMeter.mode = &quot;undetermined&quot;;</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-      }</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-      else if (gProgressText.hidden) {</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-        // If it was undetermined before, unhide text and switch mode.</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-        gProgressText.hidden = false;</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-        gProgressMeter.mode = &quot;determined&quot;;</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-      }</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-    case nsIDownloadManager.DOWNLOAD_NOTSTARTED:</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-    case nsIDownloadManager.DOWNLOAD_PAUSED:</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-    case nsIDownloadManager.DOWNLOAD_QUEUED:</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-    case nsIDownloadManager.DOWNLOAD_SCANNING:</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-      gDlActive = true;</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-      gProgressMeter.style.opacity = 1;</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-      break;</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-    default:</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-      gDlActive = false;</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-      gProgressMeter.style.opacity = 0.5;</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-      break;</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+  if (gDownload.hasProgress) {</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+    gProgressText.value = gDownloadBundle.getFormattedString(&quot;percentFormat&quot;,</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+                                                             [gDownload.progress]);</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+    gProgressText.hidden = false;</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+    gProgressMeter.value = gDownload.progress;</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+    gProgressMeter.mode = &quot;determined&quot;;</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+  } else {</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+    gProgressText.hidden = true;</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+    gProgressMeter.mode = &quot;undetermined&quot;;</span>
<a href="#l3.158"></a><span id="l3.158">   }</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-  if (gDownload.size &gt;= 0) {</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-    gProgressMeter.value = gDownload.percentComplete;</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-    gProgressText.value = gDownloadBundle.getFormattedString(&quot;percentFormat&quot;,</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-                                                             [gDownload.percentComplete]);</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+  if (gDownload.stopped) {</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+    gProgressMeter.style.opacity = 0.5;</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+  } else {</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+    gProgressMeter.style.opacity = 1;</span>
<a href="#l3.167"></a><span id="l3.167">   }</span>
<a href="#l3.168"></a><span id="l3.168">   // Update window title</span>
<a href="#l3.169"></a><span id="l3.169">   var statusString;</span>
<a href="#l3.170"></a><span id="l3.170">   switch (gDownload.state) {</span>
<a href="#l3.171"></a><span id="l3.171">     case nsIDownloadManager.DOWNLOAD_PAUSED:</span>
<a href="#l3.172"></a><span id="l3.172">       statusString = gDownloadBundle.getString(&quot;paused&quot;);</span>
<a href="#l3.173"></a><span id="l3.173">       break;</span>
<a href="#l3.174"></a><span id="l3.174">     case nsIDownloadManager.DOWNLOAD_DOWNLOADING:</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineat">@@ -155,44 +122,45 @@ function updateDownload() {</span>
<a href="#l3.176"></a><span id="l3.176">     case nsIDownloadManager.DOWNLOAD_BLOCKED_POLICY:   // Security Zone Policy</span>
<a href="#l3.177"></a><span id="l3.177">     case nsIDownloadManager.DOWNLOAD_DIRTY:            // possible virus/spyware</span>
<a href="#l3.178"></a><span id="l3.178">       statusString = gDownloadBundle.getString(&quot;blocked&quot;);</span>
<a href="#l3.179"></a><span id="l3.179">       break;</span>
<a href="#l3.180"></a><span id="l3.180">     default:</span>
<a href="#l3.181"></a><span id="l3.181">       statusString = gDownloadBundle.getString(&quot;notStarted&quot;);</span>
<a href="#l3.182"></a><span id="l3.182">       break;</span>
<a href="#l3.183"></a><span id="l3.183">   }</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-  var file = GetFileFromString(gDownload.target.spec);</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-  if (gDownload.size &gt; 0) {</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+  if (gDownload.hasProgress) {</span>
<a href="#l3.187"></a><span id="l3.187">     document.title = gDownloadBundle.getFormattedString(&quot;progressTitlePercent&quot;,</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-                                                        [gDownload.percentComplete,</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-                                                         file.leafName, statusString]);</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+                                                        [gDownload.progress,</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+                                                         gDownload.displayName,</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+                                                         statusString]);</span>
<a href="#l3.193"></a><span id="l3.193">   }</span>
<a href="#l3.194"></a><span id="l3.194">   else {</span>
<a href="#l3.195"></a><span id="l3.195">     document.title = gDownloadBundle.getFormattedString(&quot;progressTitle&quot;,</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-                                                        [file.leafName, statusString]);</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+                                                        [gDownload.displayName,</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+                                                         statusString]);</span>
<a href="#l3.199"></a><span id="l3.199">   }</span>
<a href="#l3.200"></a><span id="l3.200"> </span>
<a href="#l3.201"></a><span id="l3.201">   // download size</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-  var transfer = DownloadUtils.getTransferTotal(gDownload.amountTransferred,</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-                                                gDownload.size);</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-  if (gDownload.state == nsIDownloadManager.DOWNLOAD_DOWNLOADING) {</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+  var transfer = DownloadUtils.getTransferTotal(gDownload.currentBytes,</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+                                                gDownload.totalBytes);</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+  if (!gDownload.stopped) {</span>
<a href="#l3.208"></a><span id="l3.208">     var [rate, unit] = DownloadUtils.convertByteUnits(gDownload.speed);</span>
<a href="#l3.209"></a><span id="l3.209">     var dlSpeed = gDownloadBundle.getFormattedString(&quot;speedFormat&quot;, [rate, unit]);</span>
<a href="#l3.210"></a><span id="l3.210">     gDlSize.value = gDownloadBundle.getFormattedString(&quot;sizeSpeed&quot;,</span>
<a href="#l3.211"></a><span id="l3.211">                                                        [transfer, dlSpeed]);</span>
<a href="#l3.212"></a><span id="l3.212">   }</span>
<a href="#l3.213"></a><span id="l3.213">   else</span>
<a href="#l3.214"></a><span id="l3.214">     gDlSize.value = transfer;</span>
<a href="#l3.215"></a><span id="l3.215"> </span>
<a href="#l3.216"></a><span id="l3.216">   // download status</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-  if (gDlActive) {</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+  if (!gDownload.stopped) {</span>
<a href="#l3.219"></a><span id="l3.219">     // Calculate the time remaining if we have valid values</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-    var seconds = (gDownload.speed &gt; 0) &amp;&amp; (gDownload.size &gt; 0)</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-                  ? (gDownload.size - gDownload.amountTransferred) / gDownload.speed</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+    var seconds = (gDownload.speed &gt; 0) &amp;&amp; (gDownload.totalBytes &gt; 0)</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+                  ? (gDownload.totalBytes - gDownload.currentBytes) / gDownload.speed</span>
<a href="#l3.224"></a><span id="l3.224">                   : -1;</span>
<a href="#l3.225"></a><span id="l3.225">     var [timeLeft, newLast] = DownloadUtils.getTimeLeft(seconds, gLastSec);</span>
<a href="#l3.226"></a><span id="l3.226">     gLastSec = newLast;</span>
<a href="#l3.227"></a><span id="l3.227">   }</span>
<a href="#l3.228"></a><span id="l3.228">   switch (gDownload.state) {</span>
<a href="#l3.229"></a><span id="l3.229">     case nsIDownloadManager.DOWNLOAD_BLOCKED_PARENTAL: // Parental Controls</span>
<a href="#l3.230"></a><span id="l3.230">       gDlStatus.value = gTkDlBundle.getString(&quot;stateBlocked&quot;);</span>
<a href="#l3.231"></a><span id="l3.231">       break;</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineat">@@ -207,22 +175,18 @@ function updateDownload() {</span>
<a href="#l3.233"></a><span id="l3.233">         gDlStatus.value = gDownloadBundle.getFormattedString(&quot;statusActive&quot;,</span>
<a href="#l3.234"></a><span id="l3.234">                                                              [statusString, timeLeft]);</span>
<a href="#l3.235"></a><span id="l3.235">       else</span>
<a href="#l3.236"></a><span id="l3.236">         gDlStatus.value = statusString;</span>
<a href="#l3.237"></a><span id="l3.237">       break;</span>
<a href="#l3.238"></a><span id="l3.238">   }</span>
<a href="#l3.239"></a><span id="l3.239"> </span>
<a href="#l3.240"></a><span id="l3.240">   // time elapsed</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-  if (!gStartTime &amp;&amp; gDownload.startTime)</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-    gStartTime = Math.round(gDownload.startTime / 1000)</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-  if (gDlActive)</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-    gEndTime = Date.now();</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-  if (gStartTime &amp;&amp; gEndTime &amp;&amp; (gEndTime &gt; gStartTime)) {</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-    var seconds = (gEndTime - gStartTime) / 1000;</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+  if (gDownload.startTime &amp;&amp; gDownload.endTime &amp;&amp; (gDownload.endTime &gt; gDownload.startTime)) {</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+    var seconds = (gDownload.endTime - gDownload.startTime) / 1000;</span>
<a href="#l3.249"></a><span id="l3.249">     var [time1, unit1, time2, unit2] =</span>
<a href="#l3.250"></a><span id="l3.250">       DownloadUtils.convertTimeUnits(seconds);</span>
<a href="#l3.251"></a><span id="l3.251">     if (seconds &lt; 3600 || time2 == 0)</span>
<a href="#l3.252"></a><span id="l3.252">       gTimeElapsed.value = gDownloadBundle.getFormattedString(&quot;timeElapsedSingle&quot;, [time1, unit1]);</span>
<a href="#l3.253"></a><span id="l3.253">     else</span>
<a href="#l3.254"></a><span id="l3.254">       gTimeElapsed.value = gDownloadBundle.getFormattedString(&quot;timeElapsedDouble&quot;, [time1, unit1, time2, unit2]);</span>
<a href="#l3.255"></a><span id="l3.255">   }</span>
<a href="#l3.256"></a><span id="l3.256">   else {</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineat">@@ -242,56 +206,30 @@ function updateButtons() {</span>
<a href="#l3.258"></a><span id="l3.258">  * in the progress dialog such as displaying amount transferred, transfer</span>
<a href="#l3.259"></a><span id="l3.259">  * rate, and time left for the download.</span>
<a href="#l3.260"></a><span id="l3.260">  *</span>
<a href="#l3.261"></a><span id="l3.261">  * This class implements the nsIDownloadProgressListener interface.</span>
<a href="#l3.262"></a><span id="l3.262">  */</span>
<a href="#l3.263"></a><span id="l3.263"> function DlProgressListener() {}</span>
<a href="#l3.264"></a><span id="l3.264"> </span>
<a href="#l3.265"></a><span id="l3.265"> DlProgressListener.prototype = {</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-  //// nsISupports</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-  QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsIDownloadProgressListener]),</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">-</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-  //// nsIDownloadProgressListener</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineminus">-</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineminus">-  onDownloadStateChange: function(aState, aDownload) {</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-    // first, check if we are retrying and this is the new download starting</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-    if (gRetrying &amp;&amp;</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-        (aDownload.state == nsIDownloadManager.DOWNLOAD_QUEUED ||</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-         aDownload.state == nsIDownloadManager.DOWNLOAD_BLOCKED_POLICY) &amp;&amp;</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-        aDownload.source.spec == gDownload.source.spec &amp;&amp;</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-        aDownload.target.spec == gDownload.target.spec) {</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-      gRetrying = false;</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-      gDownload = aDownload;</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-    }</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+  onDownloadChanged: function(aDownload) {</span>
<a href="#l3.285"></a><span id="l3.285">     if (aDownload == gDownload) {</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-      if (gCloseWhenDone.checked &amp;&amp;</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-          (aDownload.state == nsIDownloadManager.DOWNLOAD_FINISHED)) {</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+      if (gCloseWhenDone.checked &amp;&amp; aDownload.succeeded) {</span>
<a href="#l3.289"></a><span id="l3.289">         window.close();</span>
<a href="#l3.290"></a><span id="l3.290">       }</span>
<a href="#l3.291"></a><span id="l3.291">       updateDownload();</span>
<a href="#l3.292"></a><span id="l3.292">       updateButtons();</span>
<a href="#l3.293"></a><span id="l3.293">       window.updateCommands(&quot;dlstate-change&quot;);</span>
<a href="#l3.294"></a><span id="l3.294">     }</span>
<a href="#l3.295"></a><span id="l3.295">   },</span>
<a href="#l3.296"></a><span id="l3.296"> </span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-  onProgressChange: function(aWebProgress, aRequest,</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-                             aCurSelfProgress, aMaxSelfProgress,</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-                             aCurTotalProgress, aMaxTotalProgress, aDownload) {</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+  onDownloadRemoved: function(aDownload) {</span>
<a href="#l3.301"></a><span id="l3.301">     if (aDownload == gDownload)</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-      updateDownload();</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-  },</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineminus">-</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineminus">-  onStateChange: function(aWebProgress, aRequest, aState, aStatus, aDownload) {</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineminus">-  },</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineminus">-</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineminus">-  onSecurityChange: function(aWebProgress, aRequest, aState, aDownload) {</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+      window.close();</span>
<a href="#l3.310"></a><span id="l3.310">   }</span>
<a href="#l3.311"></a><span id="l3.311"> };</span>
<a href="#l3.312"></a><span id="l3.312"> </span>
<a href="#l3.313"></a><span id="l3.313"> var ProgressDlgController = {</span>
<a href="#l3.314"></a><span id="l3.314">   supportsCommand: function(aCommand) {</span>
<a href="#l3.315"></a><span id="l3.315">     switch (aCommand) {</span>
<a href="#l3.316"></a><span id="l3.316">       case &quot;cmd_pause&quot;:</span>
<a href="#l3.317"></a><span id="l3.317">       case &quot;cmd_resume&quot;:</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineat">@@ -304,52 +242,44 @@ var ProgressDlgController = {</span>
<a href="#l3.319"></a><span id="l3.319">         return true;</span>
<a href="#l3.320"></a><span id="l3.320">     }</span>
<a href="#l3.321"></a><span id="l3.321">     return false;</span>
<a href="#l3.322"></a><span id="l3.322">   },</span>
<a href="#l3.323"></a><span id="l3.323"> </span>
<a href="#l3.324"></a><span id="l3.324">   isCommandEnabled: function(aCommand) {</span>
<a href="#l3.325"></a><span id="l3.325">     switch (aCommand) {</span>
<a href="#l3.326"></a><span id="l3.326">       case &quot;cmd_pause&quot;:</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineminus">-        return gDlActive &amp;&amp;</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineminus">-               gDownload.state != nsIDownloadManager.DOWNLOAD_PAUSED &amp;&amp;</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineminus">-               gDownload.resumable;</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+        return !gDownload.stopped &amp;&amp; gDownload.hasPartialData;</span>
<a href="#l3.331"></a><span id="l3.331">       case &quot;cmd_resume&quot;:</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineminus">-        return gDownload.state == nsIDownloadManager.DOWNLOAD_PAUSED &amp;&amp;</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineminus">-               gDownload.resumable;</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineplus">+        return gDownload.stopped &amp;&amp; gDownload.hasPartialData;</span>
<a href="#l3.335"></a><span id="l3.335">       case &quot;cmd_open&quot;:</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-        return gDownload.state == nsIDownloadManager.DOWNLOAD_FINISHED &amp;&amp;</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">-               gDownload.targetFile.exists();</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+        return gDownload.succeeded &amp;&amp; gDownload.target.exists;</span>
<a href="#l3.339"></a><span id="l3.339">       case &quot;cmd_show&quot;:</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineminus">-        return gDownload.targetFile.exists();</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineplus">+        return gDownload.target.exists;</span>
<a href="#l3.342"></a><span id="l3.342">       case &quot;cmd_cancel&quot;:</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineminus">-        return gDlActive;</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineplus">+        return !gDownload.stopped || gDownload.hasPartialData;</span>
<a href="#l3.345"></a><span id="l3.345">       case &quot;cmd_retry&quot;:</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineminus">-        return gDownload.state == nsIDownloadManager.DOWNLOAD_CANCELED ||</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineminus">-               gDownload.state == nsIDownloadManager.DOWNLOAD_FAILED;</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineplus">+        return !gDownload.succeeded &amp;&amp; gDownload.stopped &amp;&amp; !gDownload.hasPartialData;</span>
<a href="#l3.349"></a><span id="l3.349">       case &quot;cmd_openReferrer&quot;:</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineminus">-        return !!gDownload.referrer;</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineplus">+        return !!gDownload.source.referrer;</span>
<a href="#l3.352"></a><span id="l3.352">       case &quot;cmd_copyLocation&quot;:</span>
<a href="#l3.353"></a><span id="l3.353">         return true;</span>
<a href="#l3.354"></a><span id="l3.354">       default:</span>
<a href="#l3.355"></a><span id="l3.355">         return false;</span>
<a href="#l3.356"></a><span id="l3.356">     }</span>
<a href="#l3.357"></a><span id="l3.357">   },</span>
<a href="#l3.358"></a><span id="l3.358"> </span>
<a href="#l3.359"></a><span id="l3.359">   doCommand: function(aCommand) {</span>
<a href="#l3.360"></a><span id="l3.360">     switch (aCommand) {</span>
<a href="#l3.361"></a><span id="l3.361">       case &quot;cmd_pause&quot;:</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineminus">-        gDownload.pause();</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineplus">+        gDownload.cancel();</span>
<a href="#l3.364"></a><span id="l3.364">         break;</span>
<a href="#l3.365"></a><span id="l3.365">       case &quot;cmd_resume&quot;:</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineminus">-        gDownload.resume();</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-        break;</span>
<a href="#l3.368"></a><span id="l3.368">       case &quot;cmd_retry&quot;:</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineminus">-        gRetrying = true;</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineminus">-        retryDownload(gDownload);</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineplus">+        gDownload.start();</span>
<a href="#l3.372"></a><span id="l3.372">         break;</span>
<a href="#l3.373"></a><span id="l3.373">       case &quot;cmd_cancel&quot;:</span>
<a href="#l3.374"></a><span id="l3.374">         cancelDownload(gDownload);</span>
<a href="#l3.375"></a><span id="l3.375">         break;</span>
<a href="#l3.376"></a><span id="l3.376">       case &quot;cmd_open&quot;:</span>
<a href="#l3.377"></a><span id="l3.377">         openDownload(gDownload);</span>
<a href="#l3.378"></a><span id="l3.378">         break;</span>
<a href="#l3.379"></a><span id="l3.379">       case &quot;cmd_show&quot;:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/suite/common/downloads/treeView.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/suite/common/downloads/treeView.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -3,40 +3,37 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l4.7"></a><span id="l4.7"> Components.utils.import(&quot;resource://gre/modules/DownloadUtils.jsm&quot;);</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> const nsITreeView = Components.interfaces.nsITreeView;</span>
<a href="#l4.10"></a><span id="l4.10"> // const nsIDownloadManager is already defined in downloadmanager.js</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-function DownloadTreeView(aDownloadManager) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  this._dm = aDownloadManager;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+function DownloadTreeView() {</span>
<a href="#l4.15"></a><span id="l4.15">   this._dlList = [];</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-  this._dlMap = {};</span>
<a href="#l4.17"></a><span id="l4.17">   this._searchTerms = [];</span>
<a href="#l4.18"></a><span id="l4.18"> }</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> DownloadTreeView.prototype = {</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-  QueryInterface: XPCOMUtils.generateQI([nsITreeView,</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-                             Components.interfaces.nsIDownloadManagerResult]),</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([nsITreeView]),</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">   // ***** nsITreeView attributes and methods *****</span>
<a href="#l4.26"></a><span id="l4.26">   get rowCount() {</span>
<a href="#l4.27"></a><span id="l4.27">     return this._dlList.length;</span>
<a href="#l4.28"></a><span id="l4.28">   },</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30">   selection: null,</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32">   getRowProperties: function(aRow) {</span>
<a href="#l4.33"></a><span id="l4.33">     var dl = this._dlList[aRow];</span>
<a href="#l4.34"></a><span id="l4.34">     // (in)active</span>
<a href="#l4.35"></a><span id="l4.35">     var properties = dl.isActive ? &quot;active&quot;: &quot;inactive&quot;;</span>
<a href="#l4.36"></a><span id="l4.36">     // resumable</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-    if (dl.resumable)</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+    if (dl.hasPartialData)</span>
<a href="#l4.39"></a><span id="l4.39">       properties += &quot; resumable&quot;;</span>
<a href="#l4.40"></a><span id="l4.40">     // Download states</span>
<a href="#l4.41"></a><span id="l4.41">     switch (dl.state) {</span>
<a href="#l4.42"></a><span id="l4.42">       case nsIDownloadManager.DOWNLOAD_PAUSED:</span>
<a href="#l4.43"></a><span id="l4.43">         properties += &quot; paused&quot;;</span>
<a href="#l4.44"></a><span id="l4.44">         break;</span>
<a href="#l4.45"></a><span id="l4.45">       case nsIDownloadManager.DOWNLOAD_DOWNLOADING:</span>
<a href="#l4.46"></a><span id="l4.46">         properties += &quot; downloading&quot;;</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineat">@@ -71,17 +68,17 @@ DownloadTreeView.prototype = {</span>
<a href="#l4.48"></a><span id="l4.48">   canDrop: function(aIdx, aOrientation) { return false; },</span>
<a href="#l4.49"></a><span id="l4.49">   drop: function(aIdx, aOrientation) { },</span>
<a href="#l4.50"></a><span id="l4.50">   getParentIndex: function(aRow) { return -1; },</span>
<a href="#l4.51"></a><span id="l4.51">   hasNextSibling: function(aRow, aAfterIdx) { return false; },</span>
<a href="#l4.52"></a><span id="l4.52">   getLevel: function(aRow) { return 0; },</span>
<a href="#l4.53"></a><span id="l4.53"> </span>
<a href="#l4.54"></a><span id="l4.54">   getImageSrc: function(aRow, aColumn) {</span>
<a href="#l4.55"></a><span id="l4.55">     if (aColumn.id == &quot;Name&quot;)</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-      return &quot;moz-icon://&quot; + this._dlList[aRow].file + &quot;?size=16&quot;;</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+      return &quot;moz-icon://&quot; + this._dlList[aRow].target.path + &quot;?size=16&quot;;</span>
<a href="#l4.58"></a><span id="l4.58">     return &quot;&quot;;</span>
<a href="#l4.59"></a><span id="l4.59">   },</span>
<a href="#l4.60"></a><span id="l4.60"> </span>
<a href="#l4.61"></a><span id="l4.61">   getProgressMode: function(aRow, aColumn) {</span>
<a href="#l4.62"></a><span id="l4.62">     if (aColumn.id == &quot;Progress&quot;)</span>
<a href="#l4.63"></a><span id="l4.63">       return this._dlList[aRow].progressMode;</span>
<a href="#l4.64"></a><span id="l4.64">     return nsITreeView.PROGRESS_NONE;</span>
<a href="#l4.65"></a><span id="l4.65">   },</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineat">@@ -91,17 +88,17 @@ DownloadTreeView.prototype = {</span>
<a href="#l4.67"></a><span id="l4.67">       return this._dlList[aRow].progress;</span>
<a href="#l4.68"></a><span id="l4.68">     return &quot;&quot;;</span>
<a href="#l4.69"></a><span id="l4.69">   },</span>
<a href="#l4.70"></a><span id="l4.70"> </span>
<a href="#l4.71"></a><span id="l4.71">   getCellText: function(aRow, aColumn) {</span>
<a href="#l4.72"></a><span id="l4.72">     var dl = this._dlList[aRow];</span>
<a href="#l4.73"></a><span id="l4.73">     switch (aColumn.id) {</span>
<a href="#l4.74"></a><span id="l4.74">       case &quot;Name&quot;:</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-        return dl.target;</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+        return dl.displayName;</span>
<a href="#l4.77"></a><span id="l4.77">       case &quot;Status&quot;:</span>
<a href="#l4.78"></a><span id="l4.78">         switch (dl.state) {</span>
<a href="#l4.79"></a><span id="l4.79">           case nsIDownloadManager.DOWNLOAD_PAUSED:</span>
<a href="#l4.80"></a><span id="l4.80">             return this._dlbundle.getString(&quot;paused&quot;);</span>
<a href="#l4.81"></a><span id="l4.81">           case nsIDownloadManager.DOWNLOAD_DOWNLOADING:</span>
<a href="#l4.82"></a><span id="l4.82">             return this._dlbundle.getString(&quot;downloading&quot;);</span>
<a href="#l4.83"></a><span id="l4.83">           case nsIDownloadManager.DOWNLOAD_FINISHED:</span>
<a href="#l4.84"></a><span id="l4.84">             return this._dlbundle.getString(&quot;finished&quot;);</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineat">@@ -127,38 +124,39 @@ DownloadTreeView.prototype = {</span>
<a href="#l4.86"></a><span id="l4.86">             return this._dlbundle.getString(&quot;canceled&quot;);</span>
<a href="#l4.87"></a><span id="l4.87">           case nsIDownloadManager.DOWNLOAD_BLOCKED_PARENTAL: // Parental Controls</span>
<a href="#l4.88"></a><span id="l4.88">           case nsIDownloadManager.DOWNLOAD_BLOCKED_POLICY:   // Security Zone Policy</span>
<a href="#l4.89"></a><span id="l4.89">           case nsIDownloadManager.DOWNLOAD_DIRTY:            // possible virus/spyware</span>
<a href="#l4.90"></a><span id="l4.90">             return this._dlbundle.getString(&quot;blocked&quot;);</span>
<a href="#l4.91"></a><span id="l4.91">         }</span>
<a href="#l4.92"></a><span id="l4.92">         return this._dlbundle.getString(&quot;notStarted&quot;);</span>
<a href="#l4.93"></a><span id="l4.93">       case &quot;ProgressPercent&quot;:</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-        return dl.progress;</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+        return dl.succeeded ? 100 : dl.progress;</span>
<a href="#l4.96"></a><span id="l4.96">       case &quot;TimeRemaining&quot;:</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-        if (dl.isActive) {</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-          var dld = dl.dld;</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+        if (!dl.stopped) {</span>
<a href="#l4.100"></a><span id="l4.100">           var lastSec = (dl.lastSec == null) ? Infinity : dl.lastSec;</span>
<a href="#l4.101"></a><span id="l4.101">           // Calculate the time remaining if we have valid values</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-          var seconds = (dld.speed &gt; 0) &amp;&amp; (dl.maxBytes &gt; 0)</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-                        ? (dl.maxBytes - dl.currBytes) / dld.speed</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+          var seconds = (dl.speed &gt; 0) &amp;&amp; (dl.totalBytes &gt; 0)</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+                        ? (dl.totalBytes - dl.currentBytes) / dl.speed</span>
<a href="#l4.106"></a><span id="l4.106">                         : -1;</span>
<a href="#l4.107"></a><span id="l4.107">           var [timeLeft, newLast] = DownloadUtils.getTimeLeft(seconds, lastSec);</span>
<a href="#l4.108"></a><span id="l4.108">           this._dlList[aRow].lastSec = newLast;</span>
<a href="#l4.109"></a><span id="l4.109">           return timeLeft;</span>
<a href="#l4.110"></a><span id="l4.110">         }</span>
<a href="#l4.111"></a><span id="l4.111">         return &quot;&quot;;</span>
<a href="#l4.112"></a><span id="l4.112">       case &quot;Transferred&quot;:</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-        return DownloadUtils.getTransferTotal(dl.currBytes, dl.maxBytes);</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+        if (dl.succeeded)</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+          return DownloadUtils.getTransferTotal(dl.totalBytes, -1);</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+        if (dl.stopped &amp;&amp; !dl.currentBytes)</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+          return &quot;&quot;;</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+        return DownloadUtils.getTransferTotal(dl.currentBytes, dl.totalBytes);</span>
<a href="#l4.119"></a><span id="l4.119">       case &quot;TransferRate&quot;:</span>
<a href="#l4.120"></a><span id="l4.120">         switch (dl.state) {</span>
<a href="#l4.121"></a><span id="l4.121">           case nsIDownloadManager.DOWNLOAD_DOWNLOADING:</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-            var speed = dl.dld.speed;</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineminus">-            this._dlList[aRow]._speed = speed; // used for sorting</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-            var [rate, unit] = DownloadUtils.convertByteUnits(speed);</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+            var [rate, unit] = DownloadUtils.convertByteUnits(dl.speed);</span>
<a href="#l4.126"></a><span id="l4.126">             return this._dlbundle.getFormattedString(&quot;speedFormat&quot;, [rate, unit]);</span>
<a href="#l4.127"></a><span id="l4.127">           case nsIDownloadManager.DOWNLOAD_PAUSED:</span>
<a href="#l4.128"></a><span id="l4.128">             return this._dlbundle.getString(&quot;paused&quot;);</span>
<a href="#l4.129"></a><span id="l4.129">           case nsIDownloadManager.DOWNLOAD_NOTSTARTED:</span>
<a href="#l4.130"></a><span id="l4.130">           case nsIDownloadManager.DOWNLOAD_QUEUED:</span>
<a href="#l4.131"></a><span id="l4.131">             return this._dlbundle.getString(&quot;notStarted&quot;);</span>
<a href="#l4.132"></a><span id="l4.132">         }</span>
<a href="#l4.133"></a><span id="l4.133">         return &quot;&quot;;</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineat">@@ -176,324 +174,176 @@ DownloadTreeView.prototype = {</span>
<a href="#l4.135"></a><span id="l4.135">         if (dl.startTime)</span>
<a href="#l4.136"></a><span id="l4.136">           return this._convertTimeToString(dl.startTime);</span>
<a href="#l4.137"></a><span id="l4.137">         return &quot;&quot;;</span>
<a href="#l4.138"></a><span id="l4.138">       case &quot;EndTime&quot;:</span>
<a href="#l4.139"></a><span id="l4.139">         if (dl.endTime)</span>
<a href="#l4.140"></a><span id="l4.140">           return this._convertTimeToString(dl.endTime);</span>
<a href="#l4.141"></a><span id="l4.141">         return &quot;&quot;;</span>
<a href="#l4.142"></a><span id="l4.142">       case &quot;Source&quot;:</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-        return dl.uri;</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+        return dl.source.url;</span>
<a href="#l4.145"></a><span id="l4.145">     }</span>
<a href="#l4.146"></a><span id="l4.146">     return &quot;&quot;;</span>
<a href="#l4.147"></a><span id="l4.147">   },</span>
<a href="#l4.148"></a><span id="l4.148"> </span>
<a href="#l4.149"></a><span id="l4.149">   setTree: function(aTree) {</span>
<a href="#l4.150"></a><span id="l4.150">     this._tree = aTree;</span>
<a href="#l4.151"></a><span id="l4.151">     this._dlbundle = document.getElementById(&quot;dmBundle&quot;);</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineminus">-</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineminus">-    this.initTree();</span>
<a href="#l4.154"></a><span id="l4.154">   },</span>
<a href="#l4.155"></a><span id="l4.155"> </span>
<a href="#l4.156"></a><span id="l4.156">   toggleOpenState: function(aRow) { },</span>
<a href="#l4.157"></a><span id="l4.157">   cycleHeader: function(aColumn) { },</span>
<a href="#l4.158"></a><span id="l4.158">   selectionChanged: function() { },</span>
<a href="#l4.159"></a><span id="l4.159">   cycleCell: function(aRow, aColumn) {</span>
<a href="#l4.160"></a><span id="l4.160">     var dl = this._dlList[aRow];</span>
<a href="#l4.161"></a><span id="l4.161">     switch (aColumn.id) {</span>
<a href="#l4.162"></a><span id="l4.162">       case &quot;ActionPlay&quot;:</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-        switch (dl.state) {</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineminus">-          case nsIDownloadManager.DOWNLOAD_DOWNLOADING:</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-            dl.dld.pause();</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineminus">-            break;</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineminus">-          case nsIDownloadManager.DOWNLOAD_PAUSED:</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineminus">-            dl.dld.resume();</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-            break;</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineminus">-          case nsIDownloadManager.DOWNLOAD_FAILED:</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineminus">-          case nsIDownloadManager.DOWNLOAD_CANCELED:</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineminus">-            retryDownload(dl.dld);</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-            break;</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+        if (dl.stopped) {</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+          if (!dl.succeeded)</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+            dl.start();</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+        } else {</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+          if (dl.hasPartialData)</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+            dl.cancel();</span>
<a href="#l4.180"></a><span id="l4.180">         }</span>
<a href="#l4.181"></a><span id="l4.181">         break;</span>
<a href="#l4.182"></a><span id="l4.182">       case &quot;ActionStop&quot;:</span>
<a href="#l4.183"></a><span id="l4.183">         if (dl.isActive)</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineminus">-          cancelDownload(dl.dld);</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+          cancelDownload(dl);</span>
<a href="#l4.186"></a><span id="l4.186">         else</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineminus">-          dl.dld.remove();</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+          removeDownload(dl);</span>
<a href="#l4.189"></a><span id="l4.189">         break;</span>
<a href="#l4.190"></a><span id="l4.190">     }</span>
<a href="#l4.191"></a><span id="l4.191">   },</span>
<a href="#l4.192"></a><span id="l4.192">   isEditable: function(aRow, aColumn) { return false; },</span>
<a href="#l4.193"></a><span id="l4.193">   isSelectable: function(aRow, aColumn) { return false; },</span>
<a href="#l4.194"></a><span id="l4.194">   setCellValue: function(aRow, aColumn, aText) { },</span>
<a href="#l4.195"></a><span id="l4.195">   setCellText: function(aRow, aColumn, aText) { },</span>
<a href="#l4.196"></a><span id="l4.196">   performAction: function(aAction) { },</span>
<a href="#l4.197"></a><span id="l4.197">   performActionOnRow: function(aAction, aRow) { },</span>
<a href="#l4.198"></a><span id="l4.198">   performActionOnCell: function(aAction, aRow, aColumn) { },</span>
<a href="#l4.199"></a><span id="l4.199"> </span>
<a href="#l4.200"></a><span id="l4.200">   // ***** local public methods *****</span>
<a href="#l4.201"></a><span id="l4.201"> </span>
<a href="#l4.202"></a><span id="l4.202">   addDownload: function(aDownload) {</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineminus">-    var attrs = {</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineminus">-      guid: aDownload.guid,</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineminus">-      file: aDownload.target.spec,</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineminus">-      target: aDownload.displayName,</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-      uri: aDownload.source.spec,</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-      state: aDownload.state,</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-      progress: aDownload.percentComplete,</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineminus">-      progressMode: nsITreeView.PROGRESS_NONE,</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineminus">-      resumable: aDownload.resumable,</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-      startTime: Math.round(aDownload.startTime / 1000),</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-      endTime: Date.now(),</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-      referrer: null,</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineminus">-      currBytes: aDownload.amountTransferred,</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-      maxBytes: aDownload.size,</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-      lastSec: Infinity, // For calculations of remaining time</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-      dld: aDownload</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-    };</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-    switch (attrs.state) {</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+    aDownload.progressMode = nsITreeView.PROGRESS_NONE;</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+    aDownload.lastSec = Infinity;</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+    switch (aDownload.state) {</span>
<a href="#l4.224"></a><span id="l4.224">       case nsIDownloadManager.DOWNLOAD_DOWNLOADING:</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+        aDownload.endTime = Date.now();</span>
<a href="#l4.226"></a><span id="l4.226">         // At this point, we know if we are an indeterminate download or not.</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-        attrs.progressMode = attrs.progress == -1 ?</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+        aDownload.progressMode = aDownload.hasProgress ?</span>
<a href="#l4.229"></a><span id="l4.229">                                                nsITreeView.PROGRESS_UNDETERMINED :</span>
<a href="#l4.230"></a><span id="l4.230">                                                nsITreeView.PROGRESS_NORMAL;</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-        // We also know the referrer at this point.</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineminus">-        var referrer = aDownload.referrer;</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineminus">-        if (referrer)</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineminus">-            attrs.referrer = referrer.spec;</span>
<a href="#l4.235"></a><span id="l4.235">       case nsIDownloadManager.DOWNLOAD_NOTSTARTED:</span>
<a href="#l4.236"></a><span id="l4.236">       case nsIDownloadManager.DOWNLOAD_PAUSED:</span>
<a href="#l4.237"></a><span id="l4.237">       case nsIDownloadManager.DOWNLOAD_QUEUED:</span>
<a href="#l4.238"></a><span id="l4.238">       case nsIDownloadManager.DOWNLOAD_SCANNING:</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineminus">-        attrs.isActive = 1;</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+        aDownload.isActive = 1;</span>
<a href="#l4.241"></a><span id="l4.241">         break;</span>
<a href="#l4.242"></a><span id="l4.242">       default:</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineminus">-        attrs.isActive = 0;</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+        aDownload.isActive = 0;</span>
<a href="#l4.245"></a><span id="l4.245">         break;</span>
<a href="#l4.246"></a><span id="l4.246">     }</span>
<a href="#l4.247"></a><span id="l4.247"> </span>
<a href="#l4.248"></a><span id="l4.248">     // prepend in natural sorting</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineminus">-    attrs.listIndex = this._lastListIndex--;</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+    aDownload.listIndex = this._lastListIndex--;</span>
<a href="#l4.251"></a><span id="l4.251"> </span>
<a href="#l4.252"></a><span id="l4.252">     // Prepend data to the download list</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineminus">-    this._dlList.unshift(attrs);</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineminus">-    this._dlMap[attrs.guid] = attrs;</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+    this._dlList.unshift(aDownload);</span>
<a href="#l4.256"></a><span id="l4.256"> </span>
<a href="#l4.257"></a><span id="l4.257">     // Tell the tree we added 1 row at index 0</span>
<a href="#l4.258"></a><span id="l4.258">     this._tree.rowCountChanged(0, 1);</span>
<a href="#l4.259"></a><span id="l4.259"> </span>
<a href="#l4.260"></a><span id="l4.260">     // Data has changed, so re-sorting might be needed</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineminus">-    this.sortView(&quot;&quot;, &quot;&quot;, attrs, 0);</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+    this.sortView(&quot;&quot;, &quot;&quot;, aDownload, 0);</span>
<a href="#l4.263"></a><span id="l4.263"> </span>
<a href="#l4.264"></a><span id="l4.264">     window.updateCommands(&quot;tree-select&quot;);</span>
<a href="#l4.265"></a><span id="l4.265">   },</span>
<a href="#l4.266"></a><span id="l4.266"> </span>
<a href="#l4.267"></a><span id="l4.267">   updateDownload: function(aDownload) {</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineminus">-    var row = this._getIdxForGUID(aDownload.guid);</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+    var row = this._dlList.indexOf(aDownload);</span>
<a href="#l4.270"></a><span id="l4.270">     if (row == -1) {</span>
<a href="#l4.271"></a><span id="l4.271">       // No download row found to update, but as it's obviously going on,</span>
<a href="#l4.272"></a><span id="l4.272">       // add it to the list now (can happen with very fast, e.g. local dls)</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineminus">-      this.addDownload(aDownload);</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+      this.onDownloadAdded(aDownload);</span>
<a href="#l4.275"></a><span id="l4.275">       return;</span>
<a href="#l4.276"></a><span id="l4.276">     }</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineminus">-    var dl = this._dlList[row];</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineminus">-    if (dl.currBytes != aDownload.amountTransferred) {</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineminus">-      dl.endTime = Date.now();</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineminus">-      dl.currBytes = aDownload.amountTransferred;</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineminus">-      dl.maxBytes = aDownload.size;</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineminus">-      dl.progress = aDownload.percentComplete;</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineminus">-    }</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineminus">-    if (dl.state != aDownload.state) {</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineminus">-      dl.state = aDownload.state;</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineminus">-      dl.resumable = aDownload.resumable;</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineminus">-      switch (dl.state) {</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineminus">-        case nsIDownloadManager.DOWNLOAD_DOWNLOADING:</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineminus">-          // At this point, we know if we are an indeterminate download or not.</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineminus">-          dl.progressMode = dl.progress == -1 ?</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineminus">-                                           nsITreeView.PROGRESS_UNDETERMINED :</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineminus">-                                           nsITreeView.PROGRESS_NORMAL;</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineminus">-          // We also know the referrer at this point.</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineminus">-          var referrer = aDownload.referrer;</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineminus">-          if (referrer)</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineminus">-            dl.referrer = referrer.spec;</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineminus">-        case nsIDownloadManager.DOWNLOAD_NOTSTARTED:</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineminus">-        case nsIDownloadManager.DOWNLOAD_PAUSED:</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineminus">-        case nsIDownloadManager.DOWNLOAD_QUEUED:</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineminus">-        case nsIDownloadManager.DOWNLOAD_SCANNING:</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineminus">-          dl.isActive = 1;</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineminus">-          break;</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineminus">-        default:</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineminus">-          dl.isActive = 0;</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineminus">-          dl.progressMode = nsITreeView.PROGRESS_NONE;</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineminus">-          gDMUI.getAttention();</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineminus">-          break;</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineminus">-      }</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineplus">+    switch (aDownload.state) {</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineplus">+      case nsIDownloadManager.DOWNLOAD_DOWNLOADING:</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineplus">+        // At this point, we know if we are an indeterminate download or not.</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineplus">+        aDownload.progressMode = aDownload.hasProgress ?</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineplus">+          nsITreeView.PROGRESS_NORMAL : nsITreeView.PROGRESS_UNDETERMINED;</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineplus">+      case nsIDownloadManager.DOWNLOAD_NOTSTARTED:</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+      case nsIDownloadManager.DOWNLOAD_PAUSED:</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineplus">+      case nsIDownloadManager.DOWNLOAD_QUEUED:</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineplus">+      case nsIDownloadManager.DOWNLOAD_SCANNING:</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineplus">+        aDownload.isActive = 1;</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+        break;</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+      default:</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineplus">+        aDownload.isActive = 0;</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineplus">+        aDownload.progressMode = nsITreeView.PROGRESS_NONE;</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineplus">+        // This preference may not be set, so defaulting to two.</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineplus">+        var flashCount = 2;</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineplus">+        try {</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineplus">+          flashCount = Services.prefs.getIntPref(PREF_FLASH_COUNT);</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineplus">+        } catch (e) { }</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineplus">+        getAttentionWithCycleCount(flashCount);</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineplus">+        break;</span>
<a href="#l4.330"></a><span id="l4.330">     }</span>
<a href="#l4.331"></a><span id="l4.331"> </span>
<a href="#l4.332"></a><span id="l4.332">     // Repaint the tree row</span>
<a href="#l4.333"></a><span id="l4.333">     this._tree.invalidateRow(row);</span>
<a href="#l4.334"></a><span id="l4.334"> </span>
<a href="#l4.335"></a><span id="l4.335">     // Data has changed, so re-sorting might be needed</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineminus">-    this.sortView(&quot;&quot;, &quot;&quot;, dl, row);</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineplus">+    this.sortView(&quot;&quot;, &quot;&quot;, aDownload, row);</span>
<a href="#l4.338"></a><span id="l4.338"> </span>
<a href="#l4.339"></a><span id="l4.339">     window.updateCommands(&quot;tree-select&quot;);</span>
<a href="#l4.340"></a><span id="l4.340">   },</span>
<a href="#l4.341"></a><span id="l4.341"> </span>
<a href="#l4.342"></a><span id="l4.342" class="difflineminus">-  removeDownload: function(aGUID) {</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineminus">-    var row = this._getIdxForGUID(aGUID);</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+  removeDownload: function(aDownload) {</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+    var row = this._dlList.indexOf(aDownload);</span>
<a href="#l4.346"></a><span id="l4.346">     // Make sure we have an item to remove</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineminus">-    if (row &lt; 0) return;</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineplus">+    if (row == -1)</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineplus">+      return;</span>
<a href="#l4.350"></a><span id="l4.350"> </span>
<a href="#l4.351"></a><span id="l4.351">     var index = this.selection.currentIndex;</span>
<a href="#l4.352"></a><span id="l4.352">     var wasSingleSelection = this.selection.count == 1;</span>
<a href="#l4.353"></a><span id="l4.353"> </span>
<a href="#l4.354"></a><span id="l4.354">     // Remove data from the download list</span>
<a href="#l4.355"></a><span id="l4.355">     this._dlList.splice(row, 1);</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineminus">-    delete this._dlMap[aGUID];</span>
<a href="#l4.357"></a><span id="l4.357"> </span>
<a href="#l4.358"></a><span id="l4.358">     // Tell the tree we removed 1 row at the given row index</span>
<a href="#l4.359"></a><span id="l4.359">     this._tree.rowCountChanged(row, -1);</span>
<a href="#l4.360"></a><span id="l4.360"> </span>
<a href="#l4.361"></a><span id="l4.361">     // Update selection if only removed download was selected</span>
<a href="#l4.362"></a><span id="l4.362">     if (wasSingleSelection &amp;&amp; this.selection.count == 0) {</span>
<a href="#l4.363"></a><span id="l4.363">       index = Math.min(index, this.rowCount - 1);</span>
<a href="#l4.364"></a><span id="l4.364">       if (index &gt;= 0)</span>
<a href="#l4.365"></a><span id="l4.365">         this.selection.select(index);</span>
<a href="#l4.366"></a><span id="l4.366">     }</span>
<a href="#l4.367"></a><span id="l4.367"> </span>
<a href="#l4.368"></a><span id="l4.368">     window.updateCommands(&quot;tree-select&quot;);</span>
<a href="#l4.369"></a><span id="l4.369">   },</span>
<a href="#l4.370"></a><span id="l4.370"> </span>
<a href="#l4.371"></a><span id="l4.371" class="difflineminus">-  initTree: function() {</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineminus">-    if (!this._tree)</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineminus">-      return</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineminus">-    // We're resetting the whole list, either because we're creating the tree</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineminus">-    // or because we need to recreate it</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineminus">-    this._tree.beginUpdateBatch();</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineminus">-    this._dlList = [];</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineminus">-    this._dlMap = {};</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineminus">-    this._lastListIndex = 0;</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineminus">-</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineminus">-    this.selection.clearSelection();</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineminus">-</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineminus">-    // sort in reverse and prepend to the list to get continuous list indexes</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineminus">-    // with increasing negative numbers for default-sort in ascending order</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineminus">-    var statement = this._dm.DBConnection.createStatement(</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineminus">-      &quot;SELECT guid, target, name, source, state, startTime, endTime, referrer&quot; +</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineminus">-           &quot;, currBytes, maxBytes, state IN (?1, ?2, ?3, ?4, ?5) AS isActive &quot; +</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineminus">-      &quot;FROM moz_downloads &quot; +</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineminus">-      &quot;ORDER BY isActive ASC, endTime ASC, startTime ASC, id DESC&quot;);</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineminus">-</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineminus">-    statement.bindByIndex(0, nsIDownloadManager.DOWNLOAD_NOTSTARTED);</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineminus">-    statement.bindByIndex(1, nsIDownloadManager.DOWNLOAD_DOWNLOADING);</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineminus">-    statement.bindByIndex(2, nsIDownloadManager.DOWNLOAD_PAUSED);</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineminus">-    statement.bindByIndex(3, nsIDownloadManager.DOWNLOAD_QUEUED);</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineminus">-    statement.bindByIndex(4, nsIDownloadManager.DOWNLOAD_SCANNING);</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineminus">-</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineminus">-    while (statement.executeStep()) {</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineminus">-      // Try to get the attribute values from the statement</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineminus">-      let attrs = {</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineminus">-        guid: statement.getString(0),</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineminus">-        file: statement.getString(1),</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineminus">-        target: statement.getString(2),</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineminus">-        uri: statement.getString(3),</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineminus">-        state: statement.getInt32(4),</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineminus">-        progress: 100,</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineminus">-        progressMode: nsITreeView.PROGRESS_NONE,</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineminus">-        resumable: false,</span>
<a href="#l4.408"></a><span id="l4.408" class="difflineminus">-        startTime: Math.round(statement.getInt64(5) / 1000),</span>
<a href="#l4.409"></a><span id="l4.409" class="difflineminus">-        endTime: Math.round(statement.getInt64(6) / 1000),</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineminus">-        referrer: statement.getString(7),</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineminus">-        currBytes: statement.getInt64(8),</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineminus">-        maxBytes: statement.getInt64(9),</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineminus">-        isActive: statement.getInt32(10),</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineminus">-        lastSec: Infinity, // For calculations of remaining time</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineminus">-        dld: null</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineminus">-      };</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineminus">-</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineminus">-      // Only actually add item to the tree if it's active or matching search</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineminus">-      let matchSearch = true;</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineminus">-      if (this._searchTerms) {</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineminus">-        // Search through the download attributes that are shown to the user and</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineminus">-        // make it into one big string for easy combined searching</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineminus">-        // XXX: toolkit uses the target, status and dateTime attributes of their XBL item</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineminus">-        let combinedSearch = attrs.file.toLowerCase() + &quot; &quot; + attrs.uri.toLowerCase();</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineminus">-        if (attrs.target)</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineminus">-          combinedSearch = combinedSearch + &quot; &quot; + attrs.target.toLowerCase();</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineminus">-</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineminus">-        if (!attrs.isActive)</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineminus">-          for (let term of this._searchTerms)</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineminus">-            if (combinedSearch.indexOf(term) == -1)</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineminus">-              matchSearch = false;</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineminus">-      }</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineminus">-</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineminus">-      // matchSearch is always true for active downloads, see above</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineminus">-      if (matchSearch) {</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineminus">-        attrs.listIndex = this._lastListIndex--;</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineminus">-        this._dlList.unshift(attrs);</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineminus">-        this._dlMap[attrs.guid] = attrs;</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineminus">-      }</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineminus">-    }</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineminus">-    statement.finalize();</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineminus">-    // now read active downloads</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineminus">-    var downloads = this._dm.activeDownloads;</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineminus">-    while (downloads.hasMoreElements()) {</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineminus">-      let dld = downloads.getNext()</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineminus">-                         .QueryInterface(Components.interfaces.nsIDownload);</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineminus">-      if (dld.guid in this._dlMap) {</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineminus">-        var dl = this._dlMap[dld.guid];</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineminus">-        dl.progress = dld.percentComplete;</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineminus">-        dl.progressMode = dl.progress == -1 ?</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineminus">-                          nsITreeView.PROGRESS_UNDETERMINED :</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineminus">-                          nsITreeView.PROGRESS_NORMAL;</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineminus">-        dl.resumable = dld.resumable;</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineminus">-        dl.dld = dld;</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineminus">-      }</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineminus">-    }</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineminus">-    // find sorted column and sort the tree</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineminus">-    var sortedColumn = this._tree.columns.getSortedColumn();</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineminus">-    if (sortedColumn) {</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineminus">-      var direction = sortedColumn.element.getAttribute(&quot;sortDirection&quot;);</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineminus">-      this.sortView(sortedColumn.id, direction);</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineminus">-    }</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineminus">-    this._tree.endUpdateBatch();</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineminus">-</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineminus">-    window.updateCommands(&quot;tree-select&quot;);</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineminus">-</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineminus">-    // ask for nsIDownload objects for finished downloads</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineminus">-    for (let dl of this._dlList)</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineminus">-      if (!dl.dld)</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineminus">-        this._dm.getDownloadByGUID(dl.guid, this);</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineminus">-</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineminus">-    // Send a notification that we finished</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineminus">-    setTimeout(() =&gt;</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineminus">-      Services.obs.notifyObservers(window, &quot;download-manager-ui-done&quot;, null), 0);</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineminus">-  },</span>
<a href="#l4.476"></a><span id="l4.476" class="difflineminus">-</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineminus">-  handleResult: function(aStatus, aDownload) {</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineminus">-    if (aDownload)</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineminus">-      this._dlMap[aDownload.guid].dld = aDownload;</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineminus">-  },</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineminus">-</span>
<a href="#l4.482"></a><span id="l4.482">   searchView: function(aInput) {</span>
<a href="#l4.483"></a><span id="l4.483">     // Stringify the previous search</span>
<a href="#l4.484"></a><span id="l4.484">     var prevSearch = this._searchTerms.join(&quot; &quot;);</span>
<a href="#l4.485"></a><span id="l4.485"> </span>
<a href="#l4.486"></a><span id="l4.486">     // Array of space-separated lower-case search terms</span>
<a href="#l4.487"></a><span id="l4.487">     this._searchTerms = aInput.trim().toLowerCase().split(/\s+/);</span>
<a href="#l4.488"></a><span id="l4.488"> </span>
<a href="#l4.489"></a><span id="l4.489">     // Don't rebuild the download list if the search didn't change</span>
<a href="#l4.490"></a><span id="l4.490">     if (this._searchTerms.join(&quot; &quot;) == prevSearch)</span>
<a href="#l4.491"></a><span id="l4.491">       return;</span>
<a href="#l4.492"></a><span id="l4.492"> </span>
<a href="#l4.493"></a><span id="l4.493">     // Cache the current selection</span>
<a href="#l4.494"></a><span id="l4.494">     this._cacheSelection();</span>
<a href="#l4.495"></a><span id="l4.495"> </span>
<a href="#l4.496"></a><span id="l4.496">     // Rebuild the tree with set search terms</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineminus">-    this.initTree();</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineplus">+    //this.initTree();</span>
<a href="#l4.499"></a><span id="l4.499"> </span>
<a href="#l4.500"></a><span id="l4.500">     // Restore the selection</span>
<a href="#l4.501"></a><span id="l4.501">     this._restoreSelection();</span>
<a href="#l4.502"></a><span id="l4.502">   },</span>
<a href="#l4.503"></a><span id="l4.503"> </span>
<a href="#l4.504"></a><span id="l4.504">   sortView: function(aColumnID, aDirection, aDownload, aRow) {</span>
<a href="#l4.505"></a><span id="l4.505">     var sortAscending = aDirection != &quot;descending&quot;;</span>
<a href="#l4.506"></a><span id="l4.506"> </span>
<a href="#l4.507"></a><span id="l4.507" class="difflineat">@@ -515,18 +365,18 @@ DownloadTreeView.prototype = {</span>
<a href="#l4.508"></a><span id="l4.508">         return 1;</span>
<a href="#l4.509"></a><span id="l4.509">       if (a.isActive &gt; b.isActive)</span>
<a href="#l4.510"></a><span id="l4.510">         return -1;</span>
<a href="#l4.511"></a><span id="l4.511">       // Same active/inactive state, sort normally</span>
<a href="#l4.512"></a><span id="l4.512">       var comp_a = null;</span>
<a href="#l4.513"></a><span id="l4.513">       var comp_b = null;</span>
<a href="#l4.514"></a><span id="l4.514">       switch (aColumnID) {</span>
<a href="#l4.515"></a><span id="l4.515">         case &quot;Name&quot;:</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineminus">-          comp_a = a.target.toLowerCase();</span>
<a href="#l4.517"></a><span id="l4.517" class="difflineminus">-          comp_b = b.target.toLowerCase();</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineplus">+          comp_a = a.displayName.toLowerCase();</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineplus">+          comp_b = b.displayName.toLowerCase();</span>
<a href="#l4.520"></a><span id="l4.520">           break;</span>
<a href="#l4.521"></a><span id="l4.521">         case &quot;Status&quot;:</span>
<a href="#l4.522"></a><span id="l4.522">           comp_a = a.state;</span>
<a href="#l4.523"></a><span id="l4.523">           comp_b = b.state;</span>
<a href="#l4.524"></a><span id="l4.524">           break;</span>
<a href="#l4.525"></a><span id="l4.525">         case &quot;Progress&quot;:</span>
<a href="#l4.526"></a><span id="l4.526">         case &quot;ProgressPercent&quot;:</span>
<a href="#l4.527"></a><span id="l4.527">           // Use original sorting for inactive entries</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineat">@@ -534,22 +384,22 @@ DownloadTreeView.prototype = {</span>
<a href="#l4.529"></a><span id="l4.529">           comp_a = a.isActive ? a.progress : a.listIndex;</span>
<a href="#l4.530"></a><span id="l4.530">           comp_b = a.isActive ? b.progress : b.listIndex;</span>
<a href="#l4.531"></a><span id="l4.531">           break;</span>
<a href="#l4.532"></a><span id="l4.532">         case &quot;TimeRemaining&quot;:</span>
<a href="#l4.533"></a><span id="l4.533">           comp_a = a.isActive ? a.lastSec : a.listIndex;</span>
<a href="#l4.534"></a><span id="l4.534">           comp_b = a.isActive ? b.lastSec : b.listIndex;</span>
<a href="#l4.535"></a><span id="l4.535">           break;</span>
<a href="#l4.536"></a><span id="l4.536">         case &quot;Transferred&quot;:</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineminus">-          comp_a = a.currBytes;</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineminus">-          comp_b = b.currBytes;</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineplus">+          comp_a = a.currentBytes;</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineplus">+          comp_b = b.currentBytes;</span>
<a href="#l4.541"></a><span id="l4.541">           break;</span>
<a href="#l4.542"></a><span id="l4.542">         case &quot;TransferRate&quot;:</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineminus">-          comp_a = a.isActive ? a._speed : a.listIndex;</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineminus">-          comp_b = a.isActive ? b._speed : b.listIndex;</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineplus">+          comp_a = a.isActive ? a.speed : a.listIndex;</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineplus">+          comp_b = a.isActive ? b.speed : b.listIndex;</span>
<a href="#l4.547"></a><span id="l4.547">           break;</span>
<a href="#l4.548"></a><span id="l4.548">         case &quot;TimeElapsed&quot;:</span>
<a href="#l4.549"></a><span id="l4.549">           comp_a = (a.endTime &amp;&amp; a.startTime &amp;&amp; (a.endTime &gt; a.startTime))</span>
<a href="#l4.550"></a><span id="l4.550">                    ? a.endTime - a.startTime</span>
<a href="#l4.551"></a><span id="l4.551">                    : 0;</span>
<a href="#l4.552"></a><span id="l4.552">           comp_b = (b.endTime &amp;&amp; b.startTime &amp;&amp; (b.endTime &gt; b.startTime))</span>
<a href="#l4.553"></a><span id="l4.553">                    ? b.endTime - b.startTime</span>
<a href="#l4.554"></a><span id="l4.554">                    : 0;</span>
<a href="#l4.555"></a><span id="l4.555" class="difflineat">@@ -558,18 +408,18 @@ DownloadTreeView.prototype = {</span>
<a href="#l4.556"></a><span id="l4.556">           comp_a = a.startTime;</span>
<a href="#l4.557"></a><span id="l4.557">           comp_b = b.startTime;</span>
<a href="#l4.558"></a><span id="l4.558">           break;</span>
<a href="#l4.559"></a><span id="l4.559">         case &quot;EndTime&quot;:</span>
<a href="#l4.560"></a><span id="l4.560">           comp_a = a.endTime;</span>
<a href="#l4.561"></a><span id="l4.561">           comp_b = b.endTime;</span>
<a href="#l4.562"></a><span id="l4.562">           break;</span>
<a href="#l4.563"></a><span id="l4.563">         case &quot;Source&quot;:</span>
<a href="#l4.564"></a><span id="l4.564" class="difflineminus">-          comp_a = a.uri;</span>
<a href="#l4.565"></a><span id="l4.565" class="difflineminus">-          comp_b = b.uri;</span>
<a href="#l4.566"></a><span id="l4.566" class="difflineplus">+          comp_a = a.source.url;</span>
<a href="#l4.567"></a><span id="l4.567" class="difflineplus">+          comp_b = b.source.url;</span>
<a href="#l4.568"></a><span id="l4.568">           break;</span>
<a href="#l4.569"></a><span id="l4.569">         case &quot;unsorted&quot;: // Special case for reverting to original order</span>
<a href="#l4.570"></a><span id="l4.570">         default:</span>
<a href="#l4.571"></a><span id="l4.571">           comp_a = a.listIndex;</span>
<a href="#l4.572"></a><span id="l4.572">           comp_b = b.listIndex;</span>
<a href="#l4.573"></a><span id="l4.573">       }</span>
<a href="#l4.574"></a><span id="l4.574">       if (comp_a &gt; comp_b)</span>
<a href="#l4.575"></a><span id="l4.575">         return sortAscending ? 1 : -1;</span>
<a href="#l4.576"></a><span id="l4.576" class="difflineat">@@ -601,16 +451,20 @@ DownloadTreeView.prototype = {</span>
<a href="#l4.577"></a><span id="l4.577">     // Restore the selection</span>
<a href="#l4.578"></a><span id="l4.578">     this._restoreSelection();</span>
<a href="#l4.579"></a><span id="l4.579">   },</span>
<a href="#l4.580"></a><span id="l4.580"> </span>
<a href="#l4.581"></a><span id="l4.581">   getRowData: function(aRow) {</span>
<a href="#l4.582"></a><span id="l4.582">     return this._dlList[aRow];</span>
<a href="#l4.583"></a><span id="l4.583">   },</span>
<a href="#l4.584"></a><span id="l4.584"> </span>
<a href="#l4.585"></a><span id="l4.585" class="difflineplus">+  getActiveDownloads: function() {</span>
<a href="#l4.586"></a><span id="l4.586" class="difflineplus">+    return this._dlList.filter(dld =&gt; !dld.stopped);</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineplus">+  },</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineplus">+</span>
<a href="#l4.589"></a><span id="l4.589">   // ***** local member vars *****</span>
<a href="#l4.590"></a><span id="l4.590"> </span>
<a href="#l4.591"></a><span id="l4.591">   _tree: null,</span>
<a href="#l4.592"></a><span id="l4.592">   _dlBundle: null,</span>
<a href="#l4.593"></a><span id="l4.593">   _lastListIndex: 0,</span>
<a href="#l4.594"></a><span id="l4.594">   _selectionCache: null,</span>
<a href="#l4.595"></a><span id="l4.595">   __dateService: null,</span>
<a href="#l4.596"></a><span id="l4.596"> </span>
<a href="#l4.597"></a><span id="l4.597" class="difflineat">@@ -619,23 +473,16 @@ DownloadTreeView.prototype = {</span>
<a href="#l4.598"></a><span id="l4.598">   get _dateService() {</span>
<a href="#l4.599"></a><span id="l4.599">     if (!this.__dateService) {</span>
<a href="#l4.600"></a><span id="l4.600">       this.__dateService = Components.classes[&quot;@mozilla.org/intl/scriptabledateformat;1&quot;]</span>
<a href="#l4.601"></a><span id="l4.601">                                      .getService(Components.interfaces.nsIScriptableDateFormat);</span>
<a href="#l4.602"></a><span id="l4.602">     }</span>
<a href="#l4.603"></a><span id="l4.603">     return this.__dateService;</span>
<a href="#l4.604"></a><span id="l4.604">   },</span>
<a href="#l4.605"></a><span id="l4.605"> </span>
<a href="#l4.606"></a><span id="l4.606" class="difflineminus">-  // Get array index in _dlList for a given download ID</span>
<a href="#l4.607"></a><span id="l4.607" class="difflineminus">-  _getIdxForGUID: function(aGUID) {</span>
<a href="#l4.608"></a><span id="l4.608" class="difflineminus">-    if (aGUID in this._dlMap)</span>
<a href="#l4.609"></a><span id="l4.609" class="difflineminus">-      return this._dlList.indexOf(this._dlMap[aGUID]);</span>
<a href="#l4.610"></a><span id="l4.610" class="difflineminus">-    return -1;</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineminus">-  },</span>
<a href="#l4.612"></a><span id="l4.612" class="difflineminus">-</span>
<a href="#l4.613"></a><span id="l4.613">   // Cache IDs of selected downloads for later restoration</span>
<a href="#l4.614"></a><span id="l4.614">   _cacheSelection: function() {</span>
<a href="#l4.615"></a><span id="l4.615">     // Abort if there's already something cached</span>
<a href="#l4.616"></a><span id="l4.616">     if (this._selectionCache)</span>
<a href="#l4.617"></a><span id="l4.617">       return;</span>
<a href="#l4.618"></a><span id="l4.618"> </span>
<a href="#l4.619"></a><span id="l4.619">     this._selectionCache = [];</span>
<a href="#l4.620"></a><span id="l4.620">     if (this.selection.count &lt; 1)</span>
<a href="#l4.621"></a><span id="l4.621" class="difflineat">@@ -643,31 +490,31 @@ DownloadTreeView.prototype = {</span>
<a href="#l4.622"></a><span id="l4.622"> </span>
<a href="#l4.623"></a><span id="l4.623">     // Walk all selected rows and cache theior download IDs</span>
<a href="#l4.624"></a><span id="l4.624">     var start = {};</span>
<a href="#l4.625"></a><span id="l4.625">     var end = {};</span>
<a href="#l4.626"></a><span id="l4.626">     var numRanges = this.selection.getRangeCount();</span>
<a href="#l4.627"></a><span id="l4.627">     for (let rg = 0; rg &lt; numRanges; rg++){</span>
<a href="#l4.628"></a><span id="l4.628">       this.selection.getRangeAt(rg, start, end);</span>
<a href="#l4.629"></a><span id="l4.629">       for (let row = start.value; row &lt;= end.value; row++){</span>
<a href="#l4.630"></a><span id="l4.630" class="difflineminus">-        this._selectionCache.push(this._dlList[row].guid);</span>
<a href="#l4.631"></a><span id="l4.631" class="difflineplus">+        this._selectionCache.push(this._dlList[row]);</span>
<a href="#l4.632"></a><span id="l4.632">       }</span>
<a href="#l4.633"></a><span id="l4.633">     }</span>
<a href="#l4.634"></a><span id="l4.634">   },</span>
<a href="#l4.635"></a><span id="l4.635"> </span>
<a href="#l4.636"></a><span id="l4.636">   // Restore selection from cached IDs (as possible)</span>
<a href="#l4.637"></a><span id="l4.637">   _restoreSelection: function() {</span>
<a href="#l4.638"></a><span id="l4.638">     // Abort if the cache is empty</span>
<a href="#l4.639"></a><span id="l4.639">     if (!this._selectionCache)</span>
<a href="#l4.640"></a><span id="l4.640">       return;</span>
<a href="#l4.641"></a><span id="l4.641"> </span>
<a href="#l4.642"></a><span id="l4.642">     this.selection.clearSelection();</span>
<a href="#l4.643"></a><span id="l4.643" class="difflineminus">-    for (let guid of this._selectionCache) {</span>
<a href="#l4.644"></a><span id="l4.644" class="difflineplus">+    for (let dl of this._selectionCache) {</span>
<a href="#l4.645"></a><span id="l4.645">       // Find out what row this is now and if possible, add it to the selection</span>
<a href="#l4.646"></a><span id="l4.646" class="difflineminus">-      var row = this._getIdxForGUID(guid);</span>
<a href="#l4.647"></a><span id="l4.647" class="difflineplus">+      var row = this._dlList.indexOf(dl);</span>
<a href="#l4.648"></a><span id="l4.648">       if (row != -1)</span>
<a href="#l4.649"></a><span id="l4.649">         this.selection.rangedSelect(row, row, true);</span>
<a href="#l4.650"></a><span id="l4.650">     }</span>
<a href="#l4.651"></a><span id="l4.651">     // Work done, clear the cache</span>
<a href="#l4.652"></a><span id="l4.652">     this._selectionCache = null;</span>
<a href="#l4.653"></a><span id="l4.653">   },</span>
<a href="#l4.654"></a><span id="l4.654"> </span>
<a href="#l4.655"></a><span id="l4.655">   _convertTimeToString: function(aTime) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/suite/common/public/nsISuiteGlue.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/suite/common/public/nsISuiteGlue.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -22,16 +22,21 @@ interface nsIDOMWindow;</span>
<a href="#l5.4"></a><span id="l5.4">  * suite windows to accomplish suite-related activities, such as shutdown</span>
<a href="#l5.5"></a><span id="l5.5">  * sanitization (see bug #284086)</span>
<a href="#l5.6"></a><span id="l5.6">  */</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> [scriptable, uuid(2559bb36-2eef-4190-9df1-8afcfbd35bd3)]</span>
<a href="#l5.9"></a><span id="l5.9"> interface nsISuiteGlue : nsISupports</span>
<a href="#l5.10"></a><span id="l5.10"> {</span>
<a href="#l5.11"></a><span id="l5.11">   /**</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+   * Opens the Download Manager.</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+   */</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+  void showDownloadManager();</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+  /**</span>
<a href="#l5.17"></a><span id="l5.17">    * Deletes privacy sensitive data according to user preferences</span>
<a href="#l5.18"></a><span id="l5.18">    *</span>
<a href="#l5.19"></a><span id="l5.19">    * @param aParentWindow an optionally null window which is the parent of the</span>
<a href="#l5.20"></a><span id="l5.20">    *        sanitization dialog (if it has to be shown per user preferences)</span>
<a href="#l5.21"></a><span id="l5.21">    *</span>
<a href="#l5.22"></a><span id="l5.22">    */</span>
<a href="#l5.23"></a><span id="l5.23">   void sanitize(in nsIDOMWindow aParentWindow);</span>
<a href="#l5.24"></a><span id="l5.24"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/suite/common/src/SuiteCommon.manifest</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/suite/common/src/SuiteCommon.manifest</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,13 +1,10 @@</span>
<a href="#l6.4"></a><span id="l6.4"> component {08bbb4af-7bff-4b16-8ff7-d62f3ec5aa0c} nsSuiteDownloadManagerUI.js</span>
<a href="#l6.5"></a><span id="l6.5"> contract @mozilla.org/download-manager-ui;1 {08bbb4af-7bff-4b16-8ff7-d62f3ec5aa0c}</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">-component {49507fe5-2cee-4824-b6a3-e999150ce9b8} nsDownloadsStartup.js</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">-contract @mozilla.org/suite/downloadsstartup;1 {49507fe5-2cee-4824-b6a3-e999150ce9b8}</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">-category profile-after-change DownloadsStartup @mozilla.org/suite/downloadsstartup;1</span>
<a href="#l6.9"></a><span id="l6.9"> component {d54f2c89-8fd6-4eeb-a7a4-51d4dcdf460f} nsAbout.js</span>
<a href="#l6.10"></a><span id="l6.10"> contract @mozilla.org/network/protocol/about;1?what= {d54f2c89-8fd6-4eeb-a7a4-51d4dcdf460f}</span>
<a href="#l6.11"></a><span id="l6.11"> contract @mozilla.org/network/protocol/about;1?what=blocked {d54f2c89-8fd6-4eeb-a7a4-51d4dcdf460f}</span>
<a href="#l6.12"></a><span id="l6.12"> contract @mozilla.org/network/protocol/about;1?what=certerror {d54f2c89-8fd6-4eeb-a7a4-51d4dcdf460f}</span>
<a href="#l6.13"></a><span id="l6.13"> contract @mozilla.org/network/protocol/about;1?what=data {d54f2c89-8fd6-4eeb-a7a4-51d4dcdf460f}</span>
<a href="#l6.14"></a><span id="l6.14"> contract @mozilla.org/network/protocol/about;1?what=feeds {d54f2c89-8fd6-4eeb-a7a4-51d4dcdf460f}</span>
<a href="#l6.15"></a><span id="l6.15"> contract @mozilla.org/network/protocol/about;1?what=life {d54f2c89-8fd6-4eeb-a7a4-51d4dcdf460f}</span>
<a href="#l6.16"></a><span id="l6.16"> contract @mozilla.org/network/protocol/about;1?what=privatebrowsing {d54f2c89-8fd6-4eeb-a7a4-51d4dcdf460f}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/suite/common/src/moz.build</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/suite/common/src/moz.build</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,16 +1,15 @@</span>
<a href="#l7.4"></a><span id="l7.4"> # vim: set filetype=python:</span>
<a href="#l7.5"></a><span id="l7.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.6"></a><span id="l7.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.7"></a><span id="l7.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> EXTRA_COMPONENTS += [</span>
<a href="#l7.10"></a><span id="l7.10">     'nsAbout.js',</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-    'nsDownloadsStartup.js',</span>
<a href="#l7.12"></a><span id="l7.12">     'nsGopherProtocolStubHandler.js',</span>
<a href="#l7.13"></a><span id="l7.13">     'nsSessionStartup.js',</span>
<a href="#l7.14"></a><span id="l7.14">     'nsSidebar.js',</span>
<a href="#l7.15"></a><span id="l7.15">     'nsSuiteDownloadManagerUI.js',</span>
<a href="#l7.16"></a><span id="l7.16">     'nsSuiteGlue.js',</span>
<a href="#l7.17"></a><span id="l7.17">     'SuiteCommon.manifest',</span>
<a href="#l7.18"></a><span id="l7.18"> ]</span>
<a href="#l7.19"></a><span id="l7.19"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">deleted file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- a/suite/common/src/nsDownloadsStartup.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ /dev/null</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -1,56 +0,0 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineminus">-/* -*- indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">-/* vim: set ts=2 et sw=2 tw=80 filetype=javascript: */</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-/**</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">- * This component enables the Legacy API for downloads at startup.</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">- */</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-//// Globals</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-/**</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">- * CID and Contract ID of the JavaScript implementation of nsITransfer.</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">- */</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-const kTransferCid = Components.ID(&quot;{b02be33b-d47c-4bd3-afd9-402a942426b0}&quot;);</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-const kTransferContractId = &quot;@mozilla.org/transfer;1&quot;;</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-//// DownloadsStartup</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-function DownloadsStartup() { }</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-DownloadsStartup.prototype = {</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-  classID: Components.ID(&quot;{49507fe5-2cee-4824-b6a3-e999150ce9b8}&quot;),</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-  _xpcom_factory: XPCOMUtils.generateSingletonFactory(DownloadsStartup),</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-  //// nsISupports</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-  QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsIObserver]),</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-  //// nsIObserver</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-  observe: function DS_observe(aSubject, aTopic, aData)</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-  {</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-    const nsIComponentRegistrar = Components.interfaces.nsIComponentRegistrar;</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-    // Override the JavaScript nsITransfer implementation with the</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-    // Legacy version.</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-    Components.manager.QueryInterface(nsIComponentRegistrar)</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-                      .registerFactory(kTransferCid, &quot;&quot;,</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-                                       kTransferContractId, null);</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-  },</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-};</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-//// Module</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-this.NSGetFactory = XPCOMUtils.generateNSGetFactory([DownloadsStartup]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/suite/common/src/nsSuiteGlue.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/suite/common/src/nsSuiteGlue.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,16 +1,17 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.5"></a><span id="l9.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.6"></a><span id="l9.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> const XULNS = &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;;</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l9.11"></a><span id="l9.11"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l9.13"></a><span id="l9.13"> Components.utils.import(&quot;resource://gre/modules/AddonManager.jsm&quot;);</span>
<a href="#l9.14"></a><span id="l9.14"> Components.utils.import(&quot;resource://gre/modules/LoginManagerParent.jsm&quot;);</span>
<a href="#l9.15"></a><span id="l9.15"> Components.utils.import(&quot;resource:///modules/Sanitizer.jsm&quot;);</span>
<a href="#l9.16"></a><span id="l9.16"> Components.utils.import(&quot;resource:///modules/mailnewsMigrator.js&quot;);</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18"> XPCOMUtils.defineLazyModuleGetter(this, &quot;NetUtil&quot;,</span>
<a href="#l9.19"></a><span id="l9.19">                                   &quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21" class="difflineat">@@ -48,16 +49,51 @@ const BOOKMARKS_BACKUP_IDLE_TIME = 15 * </span>
<a href="#l9.22"></a><span id="l9.22"> const BOOKMARKS_BACKUP_INTERVAL = 86400 * 1000;</span>
<a href="#l9.23"></a><span id="l9.23"> // Maximum number of backups to create.  Old ones will be purged.</span>
<a href="#l9.24"></a><span id="l9.24"> const BOOKMARKS_BACKUP_MAX_BACKUPS = 10;</span>
<a href="#l9.25"></a><span id="l9.25"> // Devtools Preferences</span>
<a href="#l9.26"></a><span id="l9.26"> const DEBUGGER_REMOTE_ENABLED = &quot;devtools.debugger.remote-enabled&quot;;</span>
<a href="#l9.27"></a><span id="l9.27"> const DEBUGGER_REMOTE_PORT = &quot;devtools.debugger.remote-port&quot;;</span>
<a href="#l9.28"></a><span id="l9.28"> const DEBUGGER_FORCE_LOCAL = &quot;devtools.debugger.force-local&quot;;</span>
<a href="#l9.29"></a><span id="l9.29"> const DEBUGGER_WIFI_VISIBLE = &quot;devtools.remote.wifi.visible&quot;;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+const DOWNLOAD_MANAGER_URL = &quot;chrome://communicator/content/downloads/downloadmanager.xul&quot;;</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+const PROGRESS_DIALOG_URL = &quot;chrome://communicator/content/downloads/progressDialog.xul&quot;;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+const PREF_FOCUS_WHEN_STARTING = &quot;browser.download.manager.focusWhenStarting&quot;;</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+const PREF_FLASH_COUNT = &quot;browser.download.manager.flashCount&quot;;</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+const PREF_DM_BEHAVIOR = &quot;browser.download.manager.behavior&quot;;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+var gDownloadManager;</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+var gDownloadsLoaded;</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+var gTaskbarProgress;</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+var gWinTaskbar;</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+var gDownloadsSummary;</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+function onSummaryChanged()</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+{</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+  if (!gTaskbarProgress)</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+    return;</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+  const nsITaskbarProgress = Components.interfaces.nsITaskbarProgress;</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+  var currentBytes = gDownloadsSummary.progressCurrentBytes;</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+  var totalBytes = gDownloadsSummary.progressTotalBytes;</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+  var state = gDownloadsSummary.allHaveStopped ?</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+                currentBytes ? nsITaskbarProgress.STATE_PAUSED :</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+                               nsITaskbarProgress.STATE_NO_PROGRESS :</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+                currentBytes &lt; totalBytes ? nsITaskbarProgress.STATE_NORMAL :</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+                             nsITaskbarProgress.STATE_INDETERMINATE;</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+  switch (state) {</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+    case nsITaskbarProgress.STATE_NO_PROGRESS:</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+    case nsITaskbarProgress.STATE_INDETERMINATE:</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+      gTaskbarProgress.setProgressState(state, 0, 0);</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+      break;</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+    default:</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+      gTaskbarProgress.setProgressState(state, currentBytes, totalBytes);</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+      break;</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+  }</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+}</span>
<a href="#l9.65"></a><span id="l9.65"> </span>
<a href="#l9.66"></a><span id="l9.66"> // Constructor</span>
<a href="#l9.67"></a><span id="l9.67"> </span>
<a href="#l9.68"></a><span id="l9.68"> function SuiteGlue() {</span>
<a href="#l9.69"></a><span id="l9.69">   XPCOMUtils.defineLazyServiceGetter(this, &quot;_idleService&quot;,</span>
<a href="#l9.70"></a><span id="l9.70">                                      &quot;@mozilla.org/widget/idleservice;1&quot;,</span>
<a href="#l9.71"></a><span id="l9.71">                                      &quot;nsIIdleService&quot;);</span>
<a href="#l9.72"></a><span id="l9.72"> </span>
<a href="#l9.73"></a><span id="l9.73" class="difflineat">@@ -160,16 +196,39 @@ SuiteGlue.prototype = {</span>
<a href="#l9.74"></a><span id="l9.74">         this._promptForMasterPassword();</span>
<a href="#l9.75"></a><span id="l9.75">         this._checkForNewAddons();</span>
<a href="#l9.76"></a><span id="l9.76">         Services.search.init();</span>
<a href="#l9.77"></a><span id="l9.77">         LoginManagerParent.init();</span>
<a href="#l9.78"></a><span id="l9.78">         Components.classes[&quot;@mozilla.org/globalmessagemanager;1&quot;]</span>
<a href="#l9.79"></a><span id="l9.79">                   .getService(Components.interfaces.nsIMessageListenerManager)</span>
<a href="#l9.80"></a><span id="l9.80">                   .loadFrameScript(&quot;chrome://navigator/content/content.js&quot;, true);</span>
<a href="#l9.81"></a><span id="l9.81">         Components.utils.import(&quot;resource://gre/modules/NotificationDB.jsm&quot;);</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+        Components.utils.import(&quot;resource://gre/modules/Downloads.jsm&quot;);</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+        Components.utils.import(&quot;resource://gre/modules/DownloadIntegration.jsm&quot;);</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+        DownloadIntegration.shouldPersistDownload = function() { return true; }</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+        Downloads.getList(Downloads.ALL).then(list =&gt; list.addView(this))</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+                                        .then(() =&gt; gDownloadsLoaded = true);</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+        if (&quot;@mozilla.org/widget/macdocksupport;1&quot; in Components.classes)</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+          gTaskbarProgress = Components.classes[&quot;@mozilla.org/widget/macdocksupport;1&quot;]</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+                                       .getService(Components.interfaces.nsITaskbarProgress);</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+        else if (&quot;@mozilla.org/windows-taskbar;1&quot; in Components.classes) {</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+          gWinTaskbar = Components.classes[&quot;@mozilla.org/windows-taskbar;1&quot;]</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+                                  .getService(Components.interfaces.nsIWinTaskbar);</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+          if (!gWinTaskbar.available) {</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+            gWinTaskbar = null;</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+            break;</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+          }</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+        } else {</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+          break;</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+        }</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+        Downloads.getSummary(Downloads.PUBLIC).then(list =&gt; {</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+          gDownloadsSummary = list;</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+          list.addView(this);</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+        });</span>
<a href="#l9.105"></a><span id="l9.105">         break;</span>
<a href="#l9.106"></a><span id="l9.106">       case &quot;sessionstore-windows-restored&quot;:</span>
<a href="#l9.107"></a><span id="l9.107">         this._onBrowserStartup(subject);</span>
<a href="#l9.108"></a><span id="l9.108">         break;</span>
<a href="#l9.109"></a><span id="l9.109">       case &quot;browser:purge-session-history&quot;:</span>
<a href="#l9.110"></a><span id="l9.110">         // reset the console service's error buffer</span>
<a href="#l9.111"></a><span id="l9.111">         Services.console.logStringMessage(null); // clear the console (in case it's open)</span>
<a href="#l9.112"></a><span id="l9.112">         Services.console.reset();</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineat">@@ -1180,20 +1239,97 @@ SuiteGlue.prototype = {</span>
<a href="#l9.114"></a><span id="l9.114">   },</span>
<a href="#l9.115"></a><span id="l9.115"> </span>
<a href="#l9.116"></a><span id="l9.116">   dbgRestart: function()</span>
<a href="#l9.117"></a><span id="l9.117">   {</span>
<a href="#l9.118"></a><span id="l9.118">     this.dbgStop();</span>
<a href="#l9.119"></a><span id="l9.119">     this.dbgStart();</span>
<a href="#l9.120"></a><span id="l9.120">   },</span>
<a href="#l9.121"></a><span id="l9.121"> </span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+  // Download view</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+  onDownloadAdded: function(aDownload, aNewest)</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+  {</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+    aDownload.displayName =</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+                 aDownload.target.path ? OS.Path.basename(aDownload.target.path)</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+                                       : aDownload.source.url;</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+    this.onDownloadChanged(aDownload);</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+    if (!gDownloadsLoaded)</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+      return;</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineplus">+</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+    var behavior = aDownload.source.isPrivate ? 1 :</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+                     Services.prefs.getIntPref(PREF_DM_BEHAVIOR);</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineplus">+    switch (behavior) {</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+      case 0:</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+        this.showDownloadManager(aDownload);</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+        break;</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+      case 1:</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+        Services.ww.openWindow(null, PROGRESS_DIALOG_URL, null,</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+                               &quot;chrome,titlebar,centerscreen,minimizable=yes,dialog=no&quot;,</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+                               { wrappedJSObject: aDownload });</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+        break;</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+    }</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+    return; // No UI for behavior &gt;= 2</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+  },</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+  onDownloadChanged: function(aDownload) {</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+    const nsIDownloadManager = Components.interfaces.nsIDownloadManager;</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+    aDownload.state =</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+                !aDownload.stopped ? nsIDownloadManager.DOWNLOAD_DOWNLOADING :</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+                aDownload.succeeded ? nsIDownloadManager.DOWNLOAD_FINISHED :</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineplus">+                aDownload.error ?  aDownload.error.becauseBlocked ?</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+                  nsIDownloadManager.DOWNLOAD_BLOCKED_POLICY :</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineplus">+                  nsIDownloadManager.DOWNLOAD_FAILED :</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineplus">+                !aDownload.canceled ? nsIDownloadManager.DOWNLOAD_NOTSTARTED :</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+                aDownload.hasPartialData ? nsIDownloadManager.DOWNLOAD_PAUSED :</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineplus">+                                           nsIDownloadManager.DOWNLOAD_CANCELED;</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+    if (gDownloadsLoaded &amp;&amp; (aDownload.succeeded || !aDownload.stopped))</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+      aDownload.endTime = Date.now();</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+  },</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+  // Download summary</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+  onSummaryChanged: onSummaryChanged,</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+</span>
<a href="#l9.166"></a><span id="l9.166">   // ------------------------------</span>
<a href="#l9.167"></a><span id="l9.167">   // public nsISuiteGlue members</span>
<a href="#l9.168"></a><span id="l9.168">   // ------------------------------</span>
<a href="#l9.169"></a><span id="l9.169"> </span>
<a href="#l9.170"></a><span id="l9.170" class="difflineplus">+  showDownloadManager: function(aDownload)</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineplus">+  {</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+    if (!gDownloadManager) {</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineplus">+      gDownloadManager = Services.ww.openWindow(null, DOWNLOAD_MANAGER_URL,</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineplus">+                                                null, &quot;all,dialog=no&quot;,</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+                                                { wrappedJSObject: aDownload });</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+      gDownloadManager.addEventListener(&quot;load&quot;, function() {</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+        gDownloadManager.addEventListener(&quot;unload&quot;, function() {</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineplus">+          gDownloadManager = null;</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineplus">+          if (gWinTaskbar)</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineplus">+            gTaskbarProgress = null;</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineplus">+        });</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineplus">+        if (gWinTaskbar) {</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineplus">+          var docShell = gDownloadManager.QueryInterface(Components.interfaces.nsIInterfaceRequestor)</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineplus">+                                         .getInterface(Components.interfaces.nsIWebNavigation)</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineplus">+                                         .QueryInterface(Components.interfaces.nsIDocShell);</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineplus">+          gTaskbarProgress = gWinTaskbar.getTaskbarProgress(docShell);</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineplus">+          onSummaryChanged();</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineplus">+        }</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineplus">+      });</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineplus">+    } else if (!aDownload ||</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineplus">+               Services.prefs.getBoolPref(PREF_FOCUS_WHEN_STARTING)) {</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineplus">+        gDownloadManager.focus();</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineplus">+    } else {</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineplus">+      // This preference may not be set, so defaulting to two.</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineplus">+      var flashCount = 2;</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineplus">+      try {</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineplus">+        flashCount = Services.prefs.getIntPref(PREF_FLASH_COUNT);</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+      } catch (e) { }</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+      gDownloadManager.getAttentionWithCycleCount(flashCount);</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineplus">+    }</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineplus">+  },</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineplus">+</span>
<a href="#l9.203"></a><span id="l9.203">   sanitize: function(aParentWindow)</span>
<a href="#l9.204"></a><span id="l9.204">   {</span>
<a href="#l9.205"></a><span id="l9.205">     // call the Sanitizer object's sanitize, which might return errors</span>
<a href="#l9.206"></a><span id="l9.206">     // but do not forward them anywhere, as we are defined as void here</span>
<a href="#l9.207"></a><span id="l9.207">     Sanitizer.sanitize(aParentWindow);</span>
<a href="#l9.208"></a><span id="l9.208">   },</span>
<a href="#l9.209"></a><span id="l9.209"> </span>
<a href="#l9.210"></a><span id="l9.210">   ensurePlacesDefaultQueriesInitialized:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/suite/common/tasksOverlay.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/suite/common/tasksOverlay.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -23,25 +23,19 @@ function ExpirePassword()</span>
<a href="#l10.4"></a><span id="l10.4">   Components.classes[&quot;@mozilla.org/security/pk11tokendb;1&quot;]</span>
<a href="#l10.5"></a><span id="l10.5">             .createInstance(Components.interfaces.nsIPK11TokenDB)</span>
<a href="#l10.6"></a><span id="l10.6">             .getInternalKeyToken()</span>
<a href="#l10.7"></a><span id="l10.7">             .checkPassword(&quot;&quot;);</span>
<a href="#l10.8"></a><span id="l10.8"> }</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> function toDownloadManager()</span>
<a href="#l10.11"></a><span id="l10.11"> {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  //Ported extensions may only implement the Basic toolkit Interface</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-  //and not our progress dialogs.</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-  var dlUI = Components.classes[&quot;@mozilla.org/download-manager-ui;1&quot;]</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-                       .getService(Components.interfaces.nsIDownloadManagerUI);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-  if (dlUI instanceof Components.interfaces.nsISuiteDownloadManagerUI) {</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-    dlUI.showManager(window);</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-  } else {</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-    dlUI.show(window);</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-  }</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+  Components.classes[&quot;@mozilla.org/suite/suiteglue;1&quot;]</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+            .getService(Components.interfaces.nsISuiteGlue)</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+            .showDownloadManager();</span>
<a href="#l10.24"></a><span id="l10.24"> }</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26"> function toDataManager(aView)</span>
<a href="#l10.27"></a><span id="l10.27"> {</span>
<a href="#l10.28"></a><span id="l10.28">   var useDlg = Services.prefs.getBoolPref(&quot;suite.manager.dataman.openAsDialog&quot;);</span>
<a href="#l10.29"></a><span id="l10.29"> </span>
<a href="#l10.30"></a><span id="l10.30">   if (useDlg) {</span>
<a href="#l10.31"></a><span id="l10.31">     var url = &quot;chrome://communicator/content/dataman/dataman.xul&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/suite/installer/package-manifest.in</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/suite/installer/package-manifest.in</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -411,17 +411,16 @@</span>
<a href="#l11.4"></a><span id="l11.4"> @RESPATH@/components/nsHandlerService-json.js</span>
<a href="#l11.5"></a><span id="l11.5"> @RESPATH@/components/nsHandlerService-json.manifest</span>
<a href="#l11.6"></a><span id="l11.6"> @RESPATH@/components/nsContentPrefService.js</span>
<a href="#l11.7"></a><span id="l11.7"> @RESPATH@/components/nsContentPrefService.manifest</span>
<a href="#l11.8"></a><span id="l11.8"> @RESPATH@/components/nsCrashMonitor.js</span>
<a href="#l11.9"></a><span id="l11.9"> @RESPATH@/components/crashmonitor.manifest</span>
<a href="#l11.10"></a><span id="l11.10"> @RESPATH@/components/nsDefaultCLH.js</span>
<a href="#l11.11"></a><span id="l11.11"> @RESPATH@/components/nsDefaultCLH.manifest</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-@RESPATH@/components/nsDownloadsStartup.js</span>
<a href="#l11.13"></a><span id="l11.13"> #ifdef MOZ_GTK</span>
<a href="#l11.14"></a><span id="l11.14"> @RESPATH@/components/nsFilePicker.js</span>
<a href="#l11.15"></a><span id="l11.15"> @RESPATH@/components/nsFilePicker.manifest</span>
<a href="#l11.16"></a><span id="l11.16"> #endif</span>
<a href="#l11.17"></a><span id="l11.17"> @RESPATH@/components/nsFormAutoComplete.js</span>
<a href="#l11.18"></a><span id="l11.18"> @RESPATH@/components/FormHistoryStartup.js</span>
<a href="#l11.19"></a><span id="l11.19"> @RESPATH@/components/nsGopherProtocolStubHandler.js</span>
<a href="#l11.20"></a><span id="l11.20"> @RESPATH@/components/nsHandlerService.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/suite/modules/DownloadTaskbarProgress.jsm</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/suite/modules/DownloadTaskbarProgress.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -97,19 +97,16 @@ this.DownloadTaskbarProgress =</span>
<a href="#l12.4"></a><span id="l12.4"> var DownloadTaskbarProgressUpdater =</span>
<a href="#l12.5"></a><span id="l12.5"> {</span>
<a href="#l12.6"></a><span id="l12.6">   // / Whether the taskbar is initialized.</span>
<a href="#l12.7"></a><span id="l12.7">   _initialized: false,</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9">   // / Reference to the taskbar.</span>
<a href="#l12.10"></a><span id="l12.10">   _taskbar: null,</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  // / Reference to the download manager.</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-  _dm: null,</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-</span>
<a href="#l12.15"></a><span id="l12.15">   /**</span>
<a href="#l12.16"></a><span id="l12.16">    * Initialize and register ourselves as a download progress listener.</span>
<a href="#l12.17"></a><span id="l12.17">    */</span>
<a href="#l12.18"></a><span id="l12.18">   _init: function DTPU_init()</span>
<a href="#l12.19"></a><span id="l12.19">   {</span>
<a href="#l12.20"></a><span id="l12.20">     if (this._initialized) {</span>
<a href="#l12.21"></a><span id="l12.21">       return; // Already initialized</span>
<a href="#l12.22"></a><span id="l12.22">     }</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineat">@@ -127,34 +124,29 @@ var DownloadTaskbarProgressUpdater =</span>
<a href="#l12.24"></a><span id="l12.24">                                       getService(Ci.nsITaskbarProgress);</span>
<a href="#l12.25"></a><span id="l12.25">     } else {</span>
<a href="#l12.26"></a><span id="l12.26">       DownloadTaskbarProgressUpdater = null;</span>
<a href="#l12.27"></a><span id="l12.27">       return;</span>
<a href="#l12.28"></a><span id="l12.28">     }</span>
<a href="#l12.29"></a><span id="l12.29"> </span>
<a href="#l12.30"></a><span id="l12.30">     this._taskbarState = Ci.nsITaskbarProgress.STATE_NO_PROGRESS;</span>
<a href="#l12.31"></a><span id="l12.31"> </span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-    this._dm = Cc[&quot;@mozilla.org/download-manager;1&quot;].</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-               getService(Ci.nsIDownloadManager);</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-    this._dm.addPrivacyAwareListener(this);</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-</span>
<a href="#l12.36"></a><span id="l12.36">     this._os = Cc[&quot;@mozilla.org/observer-service;1&quot;].</span>
<a href="#l12.37"></a><span id="l12.37">                getService(Ci.nsIObserverService);</span>
<a href="#l12.38"></a><span id="l12.38">     this._os.addObserver(this, &quot;quit-application-granted&quot;, false);</span>
<a href="#l12.39"></a><span id="l12.39"> </span>
<a href="#l12.40"></a><span id="l12.40">     this._updateStatus();</span>
<a href="#l12.41"></a><span id="l12.41">     // onBrowserWindowLoad/onDownloadWindowLoad are going to set the active</span>
<a href="#l12.42"></a><span id="l12.42">     // window, so don't do it here.</span>
<a href="#l12.43"></a><span id="l12.43">   },</span>
<a href="#l12.44"></a><span id="l12.44"> </span>
<a href="#l12.45"></a><span id="l12.45">   /**</span>
<a href="#l12.46"></a><span id="l12.46">    * Unregisters ourselves as a download progress listener.</span>
<a href="#l12.47"></a><span id="l12.47">    */</span>
<a href="#l12.48"></a><span id="l12.48">   _uninit: function DTPU_uninit() {</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-    this._dm.removeListener(this);</span>
<a href="#l12.50"></a><span id="l12.50">     this._os.removeObserver(this, &quot;quit-application-granted&quot;);</span>
<a href="#l12.51"></a><span id="l12.51">     this._activeTaskbarProgress = null;</span>
<a href="#l12.52"></a><span id="l12.52">     this._initialized = false;</span>
<a href="#l12.53"></a><span id="l12.53">   },</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55">   /**</span>
<a href="#l12.56"></a><span id="l12.56">    * This holds a reference to the taskbar progress for the window we're</span>
<a href="#l12.57"></a><span id="l12.57">    * working with. This window would preferably be download window, but can be</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineat">@@ -278,42 +270,43 @@ var DownloadTaskbarProgressUpdater =</span>
<a href="#l12.59"></a><span id="l12.59">    *   downloads, then we show a paused indicator if we know the size of at</span>
<a href="#l12.60"></a><span id="l12.60">    *   least one download, and no indicator if we don't.</span>
<a href="#l12.61"></a><span id="l12.61">    * - If the number of active downloads is more than the number of paused</span>
<a href="#l12.62"></a><span id="l12.62">    *   downloads, then we show a &quot;normal&quot; indicator if we know the size of at</span>
<a href="#l12.63"></a><span id="l12.63">    *   least one download, and an indeterminate indicator if we don't.</span>
<a href="#l12.64"></a><span id="l12.64">    */</span>
<a href="#l12.65"></a><span id="l12.65">   _updateStatus: function DTPU_updateStatus()</span>
<a href="#l12.66"></a><span id="l12.66">   {</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-    let numActive = this._dm.activeDownloadCount + this._dm.activePrivateDownloadCount;</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+    let numActive = 0;</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+    // this._dm.activeDownloadCount + this._dm.activePrivateDownloadCount;</span>
<a href="#l12.70"></a><span id="l12.70">     let totalSize = 0, totalTransferred = 0;</span>
<a href="#l12.71"></a><span id="l12.71"> </span>
<a href="#l12.72"></a><span id="l12.72">     if (numActive == 0) {</span>
<a href="#l12.73"></a><span id="l12.73">       this._taskbarState = Ci.nsITaskbarProgress.STATE_NO_PROGRESS;</span>
<a href="#l12.74"></a><span id="l12.74">     }</span>
<a href="#l12.75"></a><span id="l12.75">     else {</span>
<a href="#l12.76"></a><span id="l12.76">       let numPaused = 0, numScanning = 0;</span>
<a href="#l12.77"></a><span id="l12.77"> </span>
<a href="#l12.78"></a><span id="l12.78">       // Enumerate all active downloads</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-      [this._dm.activeDownloads, this._dm.activePrivateDownloads].forEach(function(downloads) {</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+      /* [this._dm.activeDownloads, this._dm.activePrivateDownloads].forEach(function(downloads) {</span>
<a href="#l12.81"></a><span id="l12.81">         while (downloads.hasMoreElements()) {</span>
<a href="#l12.82"></a><span id="l12.82">           let download = downloads.getNext().QueryInterface(Ci.nsIDownload);</span>
<a href="#l12.83"></a><span id="l12.83">           // Only set values if we actually know the download size</span>
<a href="#l12.84"></a><span id="l12.84">           if (download.percentComplete != -1) {</span>
<a href="#l12.85"></a><span id="l12.85">             totalSize += download.size;</span>
<a href="#l12.86"></a><span id="l12.86">             totalTransferred += download.amountTransferred;</span>
<a href="#l12.87"></a><span id="l12.87">           }</span>
<a href="#l12.88"></a><span id="l12.88">           // We might need to display a paused state, so track this</span>
<a href="#l12.89"></a><span id="l12.89">           if (download.state == this._dm.DOWNLOAD_PAUSED) {</span>
<a href="#l12.90"></a><span id="l12.90">             numPaused++;</span>
<a href="#l12.91"></a><span id="l12.91">           } else if (download.state == this._dm.DOWNLOAD_SCANNING) {</span>
<a href="#l12.92"></a><span id="l12.92">             numScanning++;</span>
<a href="#l12.93"></a><span id="l12.93">           }</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineminus">-        }</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineminus">-      }.bind(this));</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+        } </span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+      }.bind(this)); */</span>
<a href="#l12.98"></a><span id="l12.98"> </span>
<a href="#l12.99"></a><span id="l12.99">       // If all downloads are paused, show the progress as paused, unless we</span>
<a href="#l12.100"></a><span id="l12.100">       // don't have any information about sizes, in which case we don't</span>
<a href="#l12.101"></a><span id="l12.101">       // display anything</span>
<a href="#l12.102"></a><span id="l12.102">       if (numActive == numPaused) {</span>
<a href="#l12.103"></a><span id="l12.103">         if (totalSize == 0) {</span>
<a href="#l12.104"></a><span id="l12.104">           this._taskbarState = Ci.nsITaskbarProgress.STATE_NO_PROGRESS;</span>
<a href="#l12.105"></a><span id="l12.105">           totalTransferred = 0;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

