<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 12192:45dc9315bd5864f0f36ba7c2806559a5e87b7340</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 45dc9315bd5864f0f36ba7c2806559a5e87b7340" />
<meta property="og:url" content="/comm-central/rev/45dc9315bd5864f0f36ba7c2806559a5e87b7340" />
<meta property="og:description" content="Bug 852690 - Remaining conversion to mailServices.js: compose. r=mconley" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 45dc9315bd5864f0f36ba7c2806559a5e87b7340 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/45dc9315bd5864f0f36ba7c2806559a5e87b7340">shortlog</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/45dc9315bd5864f0f36ba7c2806559a5e87b7340">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340">files</a> |
changeset |
<a href="/comm-central/raw-rev/45dc9315bd5864f0f36ba7c2806559a5e87b7340">raw</a>  | <a href="/comm-central/archive/45dc9315bd5864f0f36ba7c2806559a5e87b7340.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=852690">Bug 852690</a> - Remaining conversion to mailServices.js: compose. r=mconley
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#101;&#98;&#97;&#115;&#116;&#105;&#97;&#110;&#32;&#72;&#101;&#110;&#103;&#115;&#116;&#32;&#60;&#97;&#114;&#99;&#104;&#97;&#101;&#111;&#112;&#116;&#101;&#114;&#121;&#120;&#64;&#99;&#111;&#111;&#108;&#101;&#45;&#102;&#105;&#108;&#101;&#115;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 25 Mar 2013 19:45:51 +0100</td></tr>

<tr>
 <td>changeset 12192</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/45dc9315bd5864f0f36ba7c2806559a5e87b7340">45dc9315bd5864f0f36ba7c2806559a5e87b7340</a></td>
</tr>



<tr>
<td>parent 12191</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2e45eea93d3e4cfe30d0e58e1680387dd154c294">2e45eea93d3e4cfe30d0e58e1680387dd154c294</a>
</td>
</tr>

<tr>
<td>child 12193</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4da58068e80c23270119d46087b7613e3fc1b31d">4da58068e80c23270119d46087b7613e3fc1b31d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=45dc9315bd5864f0f36ba7c2806559a5e87b7340">9038</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 26 Mar 2013 16:20:50 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@fd78e7d7cda7 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=fd78e7d7cda7cab16f071b9e54b0972cc7200ee9">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=fd78e7d7cda7cab16f071b9e54b0972cc7200ee9&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=fd78e7d7cda7cab16f071b9e54b0972cc7200ee9&newProject=comm-central&newRevision=0c65c10dc3aa396dc287e49f662d1c457e847911&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=fd78e7d7cda7cab16f071b9e54b0972cc7200ee9&newProject=comm-central&newRevision=0c65c10dc3aa396dc287e49f662d1c457e847911&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=fd78e7d7cda7cab16f071b9e54b0972cc7200ee9&newProject=comm-central&newRevision=0c65c10dc3aa396dc287e49f662d1c457e847911&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mconley%29&revcount=50">mconley</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=852690">852690</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=852690">Bug 852690</a> - Remaining conversion to mailServices.js: compose. r=mconley</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/components/compose/content/addressingWidgetOverlay.js">mail/components/compose/content/addressingWidgetOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/components/compose/content/addressingWidgetOverlay.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/components/compose/content/addressingWidgetOverlay.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/components/compose/content/addressingWidgetOverlay.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/components/compose/content/addressingWidgetOverlay.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/components/compose/content/addressingWidgetOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/composition/test-forward-headers.js">mail/test/mozmill/composition/test-forward-headers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/composition/test-forward-headers.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/composition/test-forward-headers.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/composition/test-forward-headers.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/composition/test-forward-headers.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/composition/test-forward-headers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/composition/test-signature-updating.js">mail/test/mozmill/composition/test-signature-updating.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/composition/test-signature-updating.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/composition/test-signature-updating.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/composition/test-signature-updating.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/composition/test-signature-updating.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/composition/test-signature-updating.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/message-header/test-reply-identity.js">mail/test/mozmill/message-header/test-reply-identity.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/message-header/test-reply-identity.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/message-header/test-reply-identity.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/message-header/test-reply-identity.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/message-header/test-reply-identity.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/message-header/test-reply-identity.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/head_compose.js">mailnews/compose/test/unit/head_compose.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/head_compose.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/head_compose.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/head_compose.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/head_compose.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/head_compose.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_bug155172.js">mailnews/compose/test/unit/test_bug155172.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_bug155172.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_bug155172.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_bug155172.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_bug155172.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_bug155172.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_bug235432.js">mailnews/compose/test/unit/test_bug235432.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_bug235432.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_bug235432.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_bug235432.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_bug235432.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_bug235432.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_bug474774.js">mailnews/compose/test/unit/test_bug474774.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_bug474774.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_bug474774.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_bug474774.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_bug474774.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_bug474774.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_nsMsgCompose3.js">mailnews/compose/test/unit/test_nsMsgCompose3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_nsMsgCompose3.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_nsMsgCompose3.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_nsMsgCompose3.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_nsMsgCompose3.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_nsMsgCompose3.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendBackground.js">mailnews/compose/test/unit/test_sendBackground.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendBackground.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendBackground.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendBackground.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendBackground.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendBackground.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMailMessage.js">mailnews/compose/test/unit/test_sendMailMessage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMailMessage.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMailMessage.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMailMessage.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMailMessage.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMailMessage.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageFile.js">mailnews/compose/test/unit/test_sendMessageFile.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageFile.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageFile.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageFile.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageFile.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageFile.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageLater.js">mailnews/compose/test/unit/test_sendMessageLater.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageLater.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageLater.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageLater.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageLater.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageLater.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageLater2.js">mailnews/compose/test/unit/test_sendMessageLater2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageLater2.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageLater2.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageLater2.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageLater2.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageLater2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageLater3.js">mailnews/compose/test/unit/test_sendMessageLater3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageLater3.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageLater3.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageLater3.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageLater3.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_sendMessageLater3.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpAuthMethods.js">mailnews/compose/test/unit/test_smtpAuthMethods.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpAuthMethods.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpAuthMethods.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpAuthMethods.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpAuthMethods.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpAuthMethods.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPassword.js">mailnews/compose/test/unit/test_smtpPassword.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPassword.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPassword.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPassword.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPassword.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPassword.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">mailnews/compose/test/unit/test_smtpPasswordFailure1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">mailnews/compose/test/unit/test_smtpPasswordFailure2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">mailnews/compose/test/unit/test_smtpPasswordFailure3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">file</a> |
<a href="/comm-central/annotate/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">annotate</a> |
<a href="/comm-central/diff/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">diff</a> |
<a href="/comm-central/comparison/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">comparison</a> |
<a href="/comm-central/log/45dc9315bd5864f0f36ba7c2806559a5e87b7340/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -3,28 +3,27 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> /**</span>
<a href="#l1.7"></a><span id="l1.7">  * Commands for the message composition window.</span>
<a href="#l1.8"></a><span id="l1.8">  */</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> // Ensure the activity modules are loaded for this window.</span>
<a href="#l1.11"></a><span id="l1.11"> Components.utils.import(&quot;resource:///modules/activity/activityModules.js&quot;);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l1.13"></a><span id="l1.13"> Components.utils.import(&quot;resource:///modules/attachmentChecker.js&quot;);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-Components.utils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+Components.utils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l1.18"></a><span id="l1.18"> Components.utils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l1.20"></a><span id="l1.20"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+Components.utils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l1.23"></a><span id="l1.23"> Components.utils.import(&quot;resource://gre/modules/InlineSpellChecker.jsm&quot;);</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l1.25"></a><span id="l1.25"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;)</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l1.27"></a><span id="l1.27"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-Components.utils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30"> /**</span>
<a href="#l1.31"></a><span id="l1.31">  * interfaces</span>
<a href="#l1.32"></a><span id="l1.32">  */</span>
<a href="#l1.33"></a><span id="l1.33"> const nsIMsgCompDeliverMode = Components.interfaces.nsIMsgCompDeliverMode;</span>
<a href="#l1.34"></a><span id="l1.34"> const nsIMsgCompSendFormat = Components.interfaces.nsIMsgCompSendFormat;</span>
<a href="#l1.35"></a><span id="l1.35"> const nsIMsgCompConvertible = Components.interfaces.nsIMsgCompConvertible;</span>
<a href="#l1.36"></a><span id="l1.36"> const nsIMsgCompType = Components.interfaces.nsIMsgCompType;</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineat">@@ -49,17 +48,16 @@ var gMessenger;</span>
<a href="#l1.38"></a><span id="l1.38"> var gSpellChecker = new InlineSpellChecker();</span>
<a href="#l1.39"></a><span id="l1.39"> </span>
<a href="#l1.40"></a><span id="l1.40"> /**</span>
<a href="#l1.41"></a><span id="l1.41">  * Global variables, need to be re-initialized every time mostly because</span>
<a href="#l1.42"></a><span id="l1.42">  * we need to release them when the window closes.</span>
<a href="#l1.43"></a><span id="l1.43">  */</span>
<a href="#l1.44"></a><span id="l1.44"> var gHideMenus;</span>
<a href="#l1.45"></a><span id="l1.45"> var gMsgCompose;</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-var gAccountManager;</span>
<a href="#l1.47"></a><span id="l1.47"> var gWindowLocked;</span>
<a href="#l1.48"></a><span id="l1.48"> var gContentChanged;</span>
<a href="#l1.49"></a><span id="l1.49"> var gAutoSaving;</span>
<a href="#l1.50"></a><span id="l1.50"> var gCurrentIdentity;</span>
<a href="#l1.51"></a><span id="l1.51"> var defaultSaveOperation;</span>
<a href="#l1.52"></a><span id="l1.52"> var gSendOrSaveOperationInProgress;</span>
<a href="#l1.53"></a><span id="l1.53"> var gCloseWindowAfterSave;</span>
<a href="#l1.54"></a><span id="l1.54"> var gSessionAdded;</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineat">@@ -108,17 +106,16 @@ var gAttachmentsSize;</span>
<a href="#l1.56"></a><span id="l1.56"> var gNumUploadingAttachments;</span>
<a href="#l1.57"></a><span id="l1.57"> </span>
<a href="#l1.58"></a><span id="l1.58"> const kComposeAttachDirPrefName = &quot;mail.compose.attach.dir&quot;;</span>
<a href="#l1.59"></a><span id="l1.59"> </span>
<a href="#l1.60"></a><span id="l1.60"> function InitializeGlobalVariables()</span>
<a href="#l1.61"></a><span id="l1.61"> {</span>
<a href="#l1.62"></a><span id="l1.62">   gMessenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l1.63"></a><span id="l1.63">                          .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-  gAccountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;].getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l1.65"></a><span id="l1.65"> </span>
<a href="#l1.66"></a><span id="l1.66">   gMsgCompose = null;</span>
<a href="#l1.67"></a><span id="l1.67">   gWindowLocked = false;</span>
<a href="#l1.68"></a><span id="l1.68">   gContentChanged = false;</span>
<a href="#l1.69"></a><span id="l1.69">   gCurrentIdentity = null;</span>
<a href="#l1.70"></a><span id="l1.70">   defaultSaveOperation = &quot;draft&quot;;</span>
<a href="#l1.71"></a><span id="l1.71">   gSendOrSaveOperationInProgress = false;</span>
<a href="#l1.72"></a><span id="l1.72">   gAutoSaving = false;</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineat">@@ -144,17 +141,16 @@ function InitializeGlobalVariables()</span>
<a href="#l1.74"></a><span id="l1.74">   msgWindow = Components.classes[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l1.75"></a><span id="l1.75">                         .createInstance(Components.interfaces.nsIMsgWindow);</span>
<a href="#l1.76"></a><span id="l1.76">   MailServices.mailSession.AddMsgWindow(msgWindow);</span>
<a href="#l1.77"></a><span id="l1.77"> }</span>
<a href="#l1.78"></a><span id="l1.78"> InitializeGlobalVariables();</span>
<a href="#l1.79"></a><span id="l1.79"> </span>
<a href="#l1.80"></a><span id="l1.80"> function ReleaseGlobalVariables()</span>
<a href="#l1.81"></a><span id="l1.81"> {</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-  gAccountManager = null;</span>
<a href="#l1.83"></a><span id="l1.83">   gCurrentIdentity = null;</span>
<a href="#l1.84"></a><span id="l1.84">   gCurrentAutocompleteDirectory = null;</span>
<a href="#l1.85"></a><span id="l1.85">   if (gLDAPSession) {</span>
<a href="#l1.86"></a><span id="l1.86">     gLDAPSession = null;</span>
<a href="#l1.87"></a><span id="l1.87">     Components.utils.forceGC();</span>
<a href="#l1.88"></a><span id="l1.88">   }</span>
<a href="#l1.89"></a><span id="l1.89">   gCharsetConvertManager = null;</span>
<a href="#l1.90"></a><span id="l1.90">   gMsgCompose = null;</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineat">@@ -1952,19 +1948,17 @@ function handleMailtoArgs(mailtoUrl)</span>
<a href="#l1.92"></a><span id="l1.92"> {</span>
<a href="#l1.93"></a><span id="l1.93">   // see if the string is a mailto url....do this by checking the first 7 characters of the string</span>
<a href="#l1.94"></a><span id="l1.94">   if (mailtoUrl.toLowerCase().startsWith(&quot;mailto:&quot;))</span>
<a href="#l1.95"></a><span id="l1.95">   {</span>
<a href="#l1.96"></a><span id="l1.96">     // if it is a mailto url, turn the mailto url into a MsgComposeParams object....</span>
<a href="#l1.97"></a><span id="l1.97">     let uri = Services.io.newURI(mailtoUrl, null, null);</span>
<a href="#l1.98"></a><span id="l1.98"> </span>
<a href="#l1.99"></a><span id="l1.99">     if (uri) {</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-      let composeSvc = Components.classes[&quot;@mozilla.org/messengercompose;1&quot;]</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-                                 .getService(Components.interfaces.nsIMsgComposeService);</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineminus">-      return composeSvc.getParamsForMailto(uri);</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+      return MailServices.compose.getParamsForMailto(uri);</span>
<a href="#l1.104"></a><span id="l1.104">     }</span>
<a href="#l1.105"></a><span id="l1.105">   }</span>
<a href="#l1.106"></a><span id="l1.106"> </span>
<a href="#l1.107"></a><span id="l1.107">   return null;</span>
<a href="#l1.108"></a><span id="l1.108"> }</span>
<a href="#l1.109"></a><span id="l1.109"> </span>
<a href="#l1.110"></a><span id="l1.110"> var attachmentWorker = new Worker(&quot;resource:///modules/attachmentChecker.js&quot;);</span>
<a href="#l1.111"></a><span id="l1.111"> </span>
<a href="#l1.112"></a><span id="l1.112" class="difflineat">@@ -2275,30 +2269,28 @@ function ComposeStartup(recycled, aParam</span>
<a href="#l1.113"></a><span id="l1.113">     }</span>
<a href="#l1.114"></a><span id="l1.114">   }</span>
<a href="#l1.115"></a><span id="l1.115"> </span>
<a href="#l1.116"></a><span id="l1.116">   gComposeType = params.type;</span>
<a href="#l1.117"></a><span id="l1.117"> </span>
<a href="#l1.118"></a><span id="l1.118">   // &quot; &lt;&gt;&quot; is an empty identity, and most likely not valid</span>
<a href="#l1.119"></a><span id="l1.119">   if (!params.identity || params.identity.identityName == &quot; &lt;&gt;&quot;) {</span>
<a href="#l1.120"></a><span id="l1.120">     // no pre selected identity, so use the default account</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-    var identities = gAccountManager.defaultAccount.identities;</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+    let identities = MailServices.accounts.defaultAccount.identities;</span>
<a href="#l1.123"></a><span id="l1.123">     if (identities.length == 0)</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-      identities = gAccountManager.allIdentities;</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+      identities = MailServices.accounts.allIdentities;</span>
<a href="#l1.126"></a><span id="l1.126">     params.identity = identities.queryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l1.127"></a><span id="l1.127">   }</span>
<a href="#l1.128"></a><span id="l1.128"> </span>
<a href="#l1.129"></a><span id="l1.129">   identityList.value = params.identity.key;</span>
<a href="#l1.130"></a><span id="l1.130">   LoadIdentity(true);</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-  var composeSvc = Components.classes[&quot;@mozilla.org/messengercompose;1&quot;]</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-                             .getService(Components.interfaces.nsIMsgComposeService);</span>
<a href="#l1.133"></a><span id="l1.133"> </span>
<a href="#l1.134"></a><span id="l1.134">   // Get the &lt;editor&gt; element to startup an editor</span>
<a href="#l1.135"></a><span id="l1.135">   var editorElement = GetCurrentEditorElement();</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-  gMsgCompose = composeSvc.initCompose(params, window, editorElement.docShell);</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+  gMsgCompose = MailServices.compose.initCompose(params, window, editorElement.docShell);</span>
<a href="#l1.138"></a><span id="l1.138"> </span>
<a href="#l1.139"></a><span id="l1.139">   // Set the close listener.</span>
<a href="#l1.140"></a><span id="l1.140">   gMsgCompose.recyclingListener = gComposeRecyclingListener;</span>
<a href="#l1.141"></a><span id="l1.141">   gMsgCompose.addMsgSendListener(gSendListener);</span>
<a href="#l1.142"></a><span id="l1.142">   // Lets the compose object knows that we are dealing with a recycled window.</span>
<a href="#l1.143"></a><span id="l1.143">   gMsgCompose.recycledWindow = recycled;</span>
<a href="#l1.144"></a><span id="l1.144"> </span>
<a href="#l1.145"></a><span id="l1.145">   document.getElementById(&quot;returnReceiptMenu&quot;)</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineat">@@ -2733,17 +2725,17 @@ function GenericSendMessage(msgType)</span>
<a href="#l1.147"></a><span id="l1.147">                             null, null, {value:0});</span>
<a href="#l1.148"></a><span id="l1.148">       if (hadForgotten)</span>
<a href="#l1.149"></a><span id="l1.149">         return;</span>
<a href="#l1.150"></a><span id="l1.150">     }</span>
<a href="#l1.151"></a><span id="l1.151"> </span>
<a href="#l1.152"></a><span id="l1.152">     // Check if the user tries to send a message to a newsgroup through a mail</span>
<a href="#l1.153"></a><span id="l1.153">     // account.</span>
<a href="#l1.154"></a><span id="l1.154">     var currentAccountKey = getCurrentAccountKey();</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-    var account = gAccountManager.getAccount(currentAccountKey);</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+    let account = MailServices.accounts.getAccount(currentAccountKey);</span>
<a href="#l1.157"></a><span id="l1.157">     if (!account)</span>
<a href="#l1.158"></a><span id="l1.158">     {</span>
<a href="#l1.159"></a><span id="l1.159">       throw new Error(&quot;currentAccountKey '&quot; + currentAccountKey +</span>
<a href="#l1.160"></a><span id="l1.160">                       &quot;' has no matching account!&quot;);</span>
<a href="#l1.161"></a><span id="l1.161">     }</span>
<a href="#l1.162"></a><span id="l1.162">     if (account.incomingServer.type != &quot;nntp&quot; &amp;&amp; msgCompFields.newsgroups != &quot;&quot;)</span>
<a href="#l1.163"></a><span id="l1.163">     {</span>
<a href="#l1.164"></a><span id="l1.164">       const kDontAskAgainPref = &quot;mail.compose.dontWarnMail2Newsgroup&quot;;</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineat">@@ -3093,36 +3085,35 @@ function OutputFormatMenuSelect(target)</span>
<a href="#l1.166"></a><span id="l1.166"> }</span>
<a href="#l1.167"></a><span id="l1.167"> </span>
<a href="#l1.168"></a><span id="l1.168"> // walk through the recipients list and add them to the inline spell checker ignore list</span>
<a href="#l1.169"></a><span id="l1.169"> function addRecipientsToIgnoreList(aAddressesToAdd)</span>
<a href="#l1.170"></a><span id="l1.170"> {</span>
<a href="#l1.171"></a><span id="l1.171">   if (gSpellChecker.enabled)</span>
<a href="#l1.172"></a><span id="l1.172">   {</span>
<a href="#l1.173"></a><span id="l1.173">     // break the list of potentially many recipients back into individual names</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-    var hdrParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;].getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l1.175"></a><span id="l1.175">     var emailAddresses = {};</span>
<a href="#l1.176"></a><span id="l1.176">     var names = {};</span>
<a href="#l1.177"></a><span id="l1.177">     var fullNames = {};</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-    var numAddresses = hdrParser.parseHeadersWithArray(aAddressesToAdd, emailAddresses, names, fullNames);</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+    let numAddresses = MailServices.headerParser.parseHeadersWithArray(aAddressesToAdd, emailAddresses, names, fullNames);</span>
<a href="#l1.180"></a><span id="l1.180">     if (!names)</span>
<a href="#l1.181"></a><span id="l1.181">       return;</span>
<a href="#l1.182"></a><span id="l1.182">     var tokenizedNames = new Array();</span>
<a href="#l1.183"></a><span id="l1.183"> </span>
<a href="#l1.184"></a><span id="l1.184">     // each name could consist of multiple word delimited by either commas or spaces. i.e. Green Lantern</span>
<a href="#l1.185"></a><span id="l1.185">     // or Lantern,Green. Tokenize on comma first, then tokenize again on spaces.</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-    for (name in names.value)</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineplus">+    for (let name in names.value)</span>
<a href="#l1.188"></a><span id="l1.188">     {</span>
<a href="#l1.189"></a><span id="l1.189">       if (!names.value[name])</span>
<a href="#l1.190"></a><span id="l1.190">         continue;</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-      var splitNames = names.value[name].split(',');</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+      let splitNames = names.value[name].split(',');</span>
<a href="#l1.193"></a><span id="l1.193">       for (let i = 0; i &lt; splitNames.length; i++)</span>
<a href="#l1.194"></a><span id="l1.194">       {</span>
<a href="#l1.195"></a><span id="l1.195">         // now tokenize off of white space</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineminus">-        var splitNamesFromWhiteSpaceArray = splitNames[i].split(' ');</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+        let splitNamesFromWhiteSpaceArray = splitNames[i].split(' ');</span>
<a href="#l1.198"></a><span id="l1.198">         for (let whiteSpaceIndex = 0; whiteSpaceIndex &lt; splitNamesFromWhiteSpaceArray.length; whiteSpaceIndex++)</span>
<a href="#l1.199"></a><span id="l1.199">           if (splitNamesFromWhiteSpaceArray[whiteSpaceIndex])</span>
<a href="#l1.200"></a><span id="l1.200">             tokenizedNames.push(splitNamesFromWhiteSpaceArray[whiteSpaceIndex]);</span>
<a href="#l1.201"></a><span id="l1.201">       }</span>
<a href="#l1.202"></a><span id="l1.202">     }</span>
<a href="#l1.203"></a><span id="l1.203"> </span>
<a href="#l1.204"></a><span id="l1.204">     gSpellChecker.mInlineSpellChecker.ignoreWords(tokenizedNames, tokenizedNames.length);</span>
<a href="#l1.205"></a><span id="l1.205">   }</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineat">@@ -3322,29 +3313,29 @@ function FillIdentityList(menulist)</span>
<a href="#l1.207"></a><span id="l1.207">       }</span>
<a href="#l1.208"></a><span id="l1.208">     }</span>
<a href="#l1.209"></a><span id="l1.209">   }</span>
<a href="#l1.210"></a><span id="l1.210"> }</span>
<a href="#l1.211"></a><span id="l1.211"> </span>
<a href="#l1.212"></a><span id="l1.212"> function getCurrentIdentity()</span>
<a href="#l1.213"></a><span id="l1.213"> {</span>
<a href="#l1.214"></a><span id="l1.214">   var identityKey = document.getElementById(&quot;msgIdentity&quot;).value;</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineminus">-  return gAccountManager.getIdentity(identityKey);</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+  return MailServices.accounts.getIdentity(identityKey);</span>
<a href="#l1.217"></a><span id="l1.217"> }</span>
<a href="#l1.218"></a><span id="l1.218"> </span>
<a href="#l1.219"></a><span id="l1.219"> function getCurrentAccountKey()</span>
<a href="#l1.220"></a><span id="l1.220"> {</span>
<a href="#l1.221"></a><span id="l1.221">     // get the accounts key</span>
<a href="#l1.222"></a><span id="l1.222">     var identityList = document.getElementById(&quot;msgIdentity&quot;);</span>
<a href="#l1.223"></a><span id="l1.223">     return identityList.selectedItem.getAttribute(&quot;accountkey&quot;);</span>
<a href="#l1.224"></a><span id="l1.224"> }</span>
<a href="#l1.225"></a><span id="l1.225"> </span>
<a href="#l1.226"></a><span id="l1.226"> function getIdentityForKey(key)</span>
<a href="#l1.227"></a><span id="l1.227"> {</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-    return gAccountManager.getIdentity(key);</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+    return MailServices.accounts.getIdentity(key);</span>
<a href="#l1.230"></a><span id="l1.230"> }</span>
<a href="#l1.231"></a><span id="l1.231"> </span>
<a href="#l1.232"></a><span id="l1.232"> function AdjustFocus()</span>
<a href="#l1.233"></a><span id="l1.233"> {</span>
<a href="#l1.234"></a><span id="l1.234">   //dump(&quot;XXX adjusting focus\n&quot;);</span>
<a href="#l1.235"></a><span id="l1.235">   var element = awGetInputElement(awGetNumberOfRecipients());</span>
<a href="#l1.236"></a><span id="l1.236">   if (element.value == &quot;&quot;) {</span>
<a href="#l1.237"></a><span id="l1.237">       //dump(&quot;XXX focus on address\n&quot;);</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineat">@@ -4059,17 +4050,17 @@ function DetermineConvertibility()</span>
<a href="#l1.239"></a><span id="l1.239"> </span>
<a href="#l1.240"></a><span id="l1.240"> function LoadIdentity(startup)</span>
<a href="#l1.241"></a><span id="l1.241"> {</span>
<a href="#l1.242"></a><span id="l1.242">     var identityElement = document.getElementById(&quot;msgIdentity&quot;);</span>
<a href="#l1.243"></a><span id="l1.243">     var prevIdentity = gCurrentIdentity;</span>
<a href="#l1.244"></a><span id="l1.244"> </span>
<a href="#l1.245"></a><span id="l1.245">     if (identityElement) {</span>
<a href="#l1.246"></a><span id="l1.246">         var idKey = identityElement.value;</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-        gCurrentIdentity = gAccountManager.getIdentity(idKey);</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineplus">+        gCurrentIdentity = MailServices.accounts.getIdentity(idKey);</span>
<a href="#l1.249"></a><span id="l1.249"> </span>
<a href="#l1.250"></a><span id="l1.250">         // set the  account name on the menu list value.</span>
<a href="#l1.251"></a><span id="l1.251">         if (identityElement.selectedItem)</span>
<a href="#l1.252"></a><span id="l1.252">           identityElement.setAttribute('accountname', identityElement.selectedItem.getAttribute('accountname'));</span>
<a href="#l1.253"></a><span id="l1.253"> </span>
<a href="#l1.254"></a><span id="l1.254">         let maxRecipients = awGetMaxRecipients();</span>
<a href="#l1.255"></a><span id="l1.255">         for (let i = 1; i &lt;= maxRecipients; i++)</span>
<a href="#l1.256"></a><span id="l1.256">           awGetInputElement(i).setAttribute(&quot;autocompletesearchparam&quot;, idKey);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/compose/content/addressingWidgetOverlay.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/compose/content/addressingWidgetOverlay.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,24 +1,25 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* -*- Mode: Javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l2.5"></a><span id="l2.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.7"></a><span id="l2.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+</span>
<a href="#l2.11"></a><span id="l2.11"> top.MAX_RECIPIENTS = 1; /* for the initial listitem created in the XUL */</span>
<a href="#l2.12"></a><span id="l2.12"> </span>
<a href="#l2.13"></a><span id="l2.13"> var inputElementType = &quot;&quot;;</span>
<a href="#l2.14"></a><span id="l2.14"> var selectElementType = &quot;&quot;;</span>
<a href="#l2.15"></a><span id="l2.15"> var selectElementIndexTable = null;</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> var gNumberOfCols = 0;</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> var gDragService = Components.classes[&quot;@mozilla.org/widget/dragservice;1&quot;].getService();</span>
<a href="#l2.20"></a><span id="l2.20"> gDragService = gDragService.QueryInterface(Components.interfaces.nsIDragService);</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-var gMimeHeaderParser = null;</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23"> var test_addresses_sequence = false;</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25"> try {</span>
<a href="#l2.26"></a><span id="l2.26">   if (sPrefs)</span>
<a href="#l2.27"></a><span id="l2.27">     test_addresses_sequence = sPrefs.getBoolPref(&quot;mail.debug.test_addresses_sequence&quot;);</span>
<a href="#l2.28"></a><span id="l2.28"> }</span>
<a href="#l2.29"></a><span id="l2.29"> catch (ex) {}</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineat">@@ -88,18 +89,16 @@ function Recipients2CompFields(msgCompFi</span>
<a href="#l2.31"></a><span id="l2.31">     var addrOther = &quot;&quot;;</span>
<a href="#l2.32"></a><span id="l2.32">     var to_Sep = &quot;&quot;;</span>
<a href="#l2.33"></a><span id="l2.33">     var cc_Sep = &quot;&quot;;</span>
<a href="#l2.34"></a><span id="l2.34">     var bcc_Sep = &quot;&quot;;</span>
<a href="#l2.35"></a><span id="l2.35">     var reply_Sep = &quot;&quot;;</span>
<a href="#l2.36"></a><span id="l2.36">     var ng_Sep = &quot;&quot;;</span>
<a href="#l2.37"></a><span id="l2.37">     var follow_Sep = &quot;&quot;;</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-    gMimeHeaderParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;].getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-</span>
<a href="#l2.41"></a><span id="l2.41">     var recipientType;</span>
<a href="#l2.42"></a><span id="l2.42">     var inputField;</span>
<a href="#l2.43"></a><span id="l2.43">     var fieldValue;</span>
<a href="#l2.44"></a><span id="l2.44">     var recipient;</span>
<a href="#l2.45"></a><span id="l2.45">     while ((inputField = awGetInputElement(i)))</span>
<a href="#l2.46"></a><span id="l2.46">     {</span>
<a href="#l2.47"></a><span id="l2.47">       fieldValue = inputField.value;</span>
<a href="#l2.48"></a><span id="l2.48"> </span>
<a href="#l2.49"></a><span id="l2.49" class="difflineat">@@ -113,17 +112,17 @@ function Recipients2CompFields(msgCompFi</span>
<a href="#l2.50"></a><span id="l2.50"> </span>
<a href="#l2.51"></a><span id="l2.51">         switch (recipientType)</span>
<a href="#l2.52"></a><span id="l2.52">         {</span>
<a href="#l2.53"></a><span id="l2.53">           case &quot;addr_to&quot;    :</span>
<a href="#l2.54"></a><span id="l2.54">           case &quot;addr_cc&quot;    :</span>
<a href="#l2.55"></a><span id="l2.55">           case &quot;addr_bcc&quot;   :</span>
<a href="#l2.56"></a><span id="l2.56">           case &quot;addr_reply&quot; :</span>
<a href="#l2.57"></a><span id="l2.57">             try {</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-              recipient = gMimeHeaderParser.reformatUnquotedAddresses(fieldValue);</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+              recipient = MailServices.headerParser.reformatUnquotedAddresses(fieldValue);</span>
<a href="#l2.60"></a><span id="l2.60">             } catch (ex) {recipient = fieldValue;}</span>
<a href="#l2.61"></a><span id="l2.61">             break;</span>
<a href="#l2.62"></a><span id="l2.62">         }</span>
<a href="#l2.63"></a><span id="l2.63"> </span>
<a href="#l2.64"></a><span id="l2.64">         switch (recipientType)</span>
<a href="#l2.65"></a><span id="l2.65">         {</span>
<a href="#l2.66"></a><span id="l2.66">           case &quot;addr_to&quot;          : addrTo += to_Sep + recipient; to_Sep = &quot;,&quot;;               break;</span>
<a href="#l2.67"></a><span id="l2.67">           case &quot;addr_cc&quot;          : addrCc += cc_Sep + recipient; cc_Sep = &quot;,&quot;;               break;</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineat">@@ -141,28 +140,24 @@ function Recipients2CompFields(msgCompFi</span>
<a href="#l2.69"></a><span id="l2.69"> </span>
<a href="#l2.70"></a><span id="l2.70">     msgCompFields.to = addrTo;</span>
<a href="#l2.71"></a><span id="l2.71">     msgCompFields.cc = addrCc;</span>
<a href="#l2.72"></a><span id="l2.72">     msgCompFields.bcc = addrBcc;</span>
<a href="#l2.73"></a><span id="l2.73">     msgCompFields.replyTo = addrReply;</span>
<a href="#l2.74"></a><span id="l2.74">     msgCompFields.newsgroups = addrNg;</span>
<a href="#l2.75"></a><span id="l2.75">     msgCompFields.followupTo = addrFollow;</span>
<a href="#l2.76"></a><span id="l2.76">     msgCompFields.otherRandomHeaders = addrOther;</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-    gMimeHeaderParser = null;</span>
<a href="#l2.79"></a><span id="l2.79">   }</span>
<a href="#l2.80"></a><span id="l2.80">   else</span>
<a href="#l2.81"></a><span id="l2.81">     dump(&quot;Message Compose Error: msgCompFields is null (ExtractRecipients)&quot;);</span>
<a href="#l2.82"></a><span id="l2.82"> }</span>
<a href="#l2.83"></a><span id="l2.83"> </span>
<a href="#l2.84"></a><span id="l2.84"> function CompFields2Recipients(msgCompFields)</span>
<a href="#l2.85"></a><span id="l2.85"> {</span>
<a href="#l2.86"></a><span id="l2.86">   if (msgCompFields) {</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-    gMimeHeaderParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;].getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-</span>
<a href="#l2.89"></a><span id="l2.89">     let listbox = document.getElementById('addressingWidget');</span>
<a href="#l2.90"></a><span id="l2.90">     let newListBoxNode = listbox.cloneNode(false);</span>
<a href="#l2.91"></a><span id="l2.91">     let listBoxColsClone = listbox.firstChild.cloneNode(true);</span>
<a href="#l2.92"></a><span id="l2.92">     newListBoxNode.appendChild(listBoxColsClone);</span>
<a href="#l2.93"></a><span id="l2.93">     let templateNode = listbox.querySelector(&quot;listitem&quot;);</span>
<a href="#l2.94"></a><span id="l2.94">     // dump(&quot;replacing child in comp fields 2 recips \n&quot;);</span>
<a href="#l2.95"></a><span id="l2.95">     listbox.parentNode.replaceChild(newListBoxNode, listbox);</span>
<a href="#l2.96"></a><span id="l2.96"> </span>
<a href="#l2.97"></a><span id="l2.97" class="difflineat">@@ -206,18 +201,16 @@ function CompFields2Recipients(msgCompFi</span>
<a href="#l2.98"></a><span id="l2.98">     // If it's a new message, we need to add an extra empty recipient.</span>
<a href="#l2.99"></a><span id="l2.99">     if (!havePrimaryRecipient)</span>
<a href="#l2.100"></a><span id="l2.100">       _awSetInputAndPopup(&quot;&quot;, &quot;addr_to&quot;, newListBoxNode, templateNode);</span>
<a href="#l2.101"></a><span id="l2.101">     awFitDummyRows(2);</span>
<a href="#l2.102"></a><span id="l2.102"> </span>
<a href="#l2.103"></a><span id="l2.103">     // CompFields2Recipients is called whenever a user replies or edits an existing message. We want to</span>
<a href="#l2.104"></a><span id="l2.104">     // add all of the recipients for this message to the ignore list for spell check</span>
<a href="#l2.105"></a><span id="l2.105">     addRecipientsToIgnoreList((gCurrentIdentity ? gCurrentIdentity.identityName + ', ' : '') + msgTo + ', ' + msgCC + ', ' + msgBCC);</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-    gMimeHeaderParser = null; //Release the mime parser</span>
<a href="#l2.108"></a><span id="l2.108">   }</span>
<a href="#l2.109"></a><span id="l2.109"> }</span>
<a href="#l2.110"></a><span id="l2.110"> </span>
<a href="#l2.111"></a><span id="l2.111"> function awSetInputAndPopupId(inputElem, popupElem, rowNumber)</span>
<a href="#l2.112"></a><span id="l2.112"> {</span>
<a href="#l2.113"></a><span id="l2.113">   popupElem.id = &quot;addressCol1#&quot; + rowNumber;</span>
<a href="#l2.114"></a><span id="l2.114">   inputElem.id = &quot;addressCol2#&quot; + rowNumber;</span>
<a href="#l2.115"></a><span id="l2.115">   inputElem.setAttribute(&quot;aria-labelledby&quot;, popupElem.id);</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineat">@@ -266,21 +259,20 @@ function awSetInputAndPopup(inputValue, </span>
<a href="#l2.117"></a><span id="l2.117"> function awSetInputAndPopupFromArray(inputArray, popupValue, parentNode, templateNode)</span>
<a href="#l2.118"></a><span id="l2.118"> {</span>
<a href="#l2.119"></a><span id="l2.119">   if (popupValue)</span>
<a href="#l2.120"></a><span id="l2.120">   {</span>
<a href="#l2.121"></a><span id="l2.121">     var recipient;</span>
<a href="#l2.122"></a><span id="l2.122">     for (var index = 0; index &lt; inputArray.length; index++)</span>
<a href="#l2.123"></a><span id="l2.123">     {</span>
<a href="#l2.124"></a><span id="l2.124">       recipient = null;</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-      if (gMimeHeaderParser)</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-        try {</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-          recipient =</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-            gMimeHeaderParser.unquotePhraseOrAddrWString(inputArray[index], true);</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-        } catch (ex) {};</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+      try {</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+        recipient =</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+          MailServices.headerParser.unquotePhraseOrAddrWString(inputArray[index], true);</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+      } catch (ex) {};</span>
<a href="#l2.134"></a><span id="l2.134">       if (!recipient)</span>
<a href="#l2.135"></a><span id="l2.135">         recipient = inputArray[index];</span>
<a href="#l2.136"></a><span id="l2.136">       _awSetInputAndPopup(recipient, popupValue, parentNode, templateNode);</span>
<a href="#l2.137"></a><span id="l2.137">     }</span>
<a href="#l2.138"></a><span id="l2.138">   }</span>
<a href="#l2.139"></a><span id="l2.139"> }</span>
<a href="#l2.140"></a><span id="l2.140"> </span>
<a href="#l2.141"></a><span id="l2.141"> function awRemoveRecipients(msgCompFields, recipientType, recipientsList)</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineat">@@ -1025,21 +1017,20 @@ function awRecipientInputCommand(event, </span>
<a href="#l2.143"></a><span id="l2.143"> </span>
<a href="#l2.144"></a><span id="l2.144"> var gAutomatedAutoCompleteListener = null;</span>
<a href="#l2.145"></a><span id="l2.145"> </span>
<a href="#l2.146"></a><span id="l2.146"> function parseAndAddAddresses(addressText, recipientType)</span>
<a href="#l2.147"></a><span id="l2.147"> {</span>
<a href="#l2.148"></a><span id="l2.148">   // strip any leading &gt;&gt; characters inserted by the autocomplete widget</span>
<a href="#l2.149"></a><span id="l2.149">   var strippedAddresses = addressText.replace(/.* &gt;&gt; /, &quot;&quot;);</span>
<a href="#l2.150"></a><span id="l2.150"> </span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-  var hdrParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;].getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l2.152"></a><span id="l2.152">   var addresses = {};</span>
<a href="#l2.153"></a><span id="l2.153">   var names = {};</span>
<a href="#l2.154"></a><span id="l2.154">   var fullNames = {};</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-  var numAddresses = hdrParser.parseHeadersWithArray(strippedAddresses, addresses, names, fullNames);</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+  let numAddresses = MailServices.headerParser.parseHeadersWithArray(strippedAddresses, addresses, names, fullNames);</span>
<a href="#l2.157"></a><span id="l2.157"> </span>
<a href="#l2.158"></a><span id="l2.158">   if (numAddresses &gt; 0)</span>
<a href="#l2.159"></a><span id="l2.159">   {</span>
<a href="#l2.160"></a><span id="l2.160">     // we need to set up our own autocomplete session and search for results</span>
<a href="#l2.161"></a><span id="l2.161"> </span>
<a href="#l2.162"></a><span id="l2.162">     setupAutocomplete(); // be safe, make sure we are setup</span>
<a href="#l2.163"></a><span id="l2.163">     if (!gAutomatedAutoCompleteListener)</span>
<a href="#l2.164"></a><span id="l2.164">       gAutomatedAutoCompleteListener = new AutomatedAutoCompleteHandler();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-forward-headers.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-forward-headers.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -54,19 +54,17 @@ function forward_selected_messages_and_g</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5">   // quit -&gt; do you want to save ?</span>
<a href="#l3.6"></a><span id="l3.6">   cwc.window.goDoCommand('cmd_close');</span>
<a href="#l3.7"></a><span id="l3.7">   // wait for the modal dialog to return</span>
<a href="#l3.8"></a><span id="l3.8">   wait_for_modal_dialog();</span>
<a href="#l3.9"></a><span id="l3.9">   // actually quite the window</span>
<a href="#l3.10"></a><span id="l3.10">   wait_for_window_close();</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-  let draftsFolder = acctMgr.localFoldersServer.rootFolder.getChildNamed(&quot;Drafts&quot;);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  let draftsFolder = MailServices.accounts.localFoldersServer.rootFolder.getChildNamed(&quot;Drafts&quot;);</span>
<a href="#l3.16"></a><span id="l3.16">   be_in_folder(draftsFolder);</span>
<a href="#l3.17"></a><span id="l3.17"> }</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19"> function test_forward_inline () {</span>
<a href="#l3.20"></a><span id="l3.20">   be_in_folder(folder);</span>
<a href="#l3.21"></a><span id="l3.21">   // original message header</span>
<a href="#l3.22"></a><span id="l3.22">   let oMsgHdr = select_click_row(0);</span>
<a href="#l3.23"></a><span id="l3.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-signature-updating.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-signature-updating.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -32,19 +32,17 @@ var setupModule = function (module) {</span>
<a href="#l4.4"></a><span id="l4.4">   fdh.installInto(module);</span>
<a href="#l4.5"></a><span id="l4.5">   composeHelper = collector.getModule(&quot;compose-helpers&quot;);</span>
<a href="#l4.6"></a><span id="l4.6">   composeHelper.installInto(module);</span>
<a href="#l4.7"></a><span id="l4.7">   let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l4.8"></a><span id="l4.8">   wh.installInto(module);</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10">   // Ensure we're in the tinderbox account as that has the right identities set</span>
<a href="#l4.11"></a><span id="l4.11">   // up for this test.</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-  let server = acctMgr.FindServer(&quot;tinderbox&quot;, &quot;tinderbox&quot;, &quot;pop3&quot;);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  let server = MailServices.accounts.FindServer(&quot;tinderbox&quot;, &quot;tinderbox&quot;, &quot;pop3&quot;);</span>
<a href="#l4.16"></a><span id="l4.16">   let inbox = server.rootFolder.getChildNamed(&quot;Inbox&quot;);</span>
<a href="#l4.17"></a><span id="l4.17">   be_in_folder(inbox);</span>
<a href="#l4.18"></a><span id="l4.18"> };</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> function setupComposeWin(toAddr, subj, body) {</span>
<a href="#l4.21"></a><span id="l4.21">   cwc.type(null, toAddr);</span>
<a href="#l4.22"></a><span id="l4.22">   cwc.type(cwc.eid(&quot;msgSubject&quot;), subj);</span>
<a href="#l4.23"></a><span id="l4.23">   cwc.type(cwc.eid(&quot;content-frame&quot;), body);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/test/mozmill/message-header/test-reply-identity.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-reply-identity.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -71,31 +71,28 @@ var setupModule = function (module) {</span>
<a href="#l5.4"></a><span id="l5.4">     clobberHeaders: {</span>
<a href="#l5.5"></a><span id="l5.5">       &quot;Delivered-To&quot; : &quot;&lt;other.&quot; + identity2Email + &quot;&gt;&quot;</span>
<a href="#l5.6"></a><span id="l5.6">     }</span>
<a href="#l5.7"></a><span id="l5.7">   }));</span>
<a href="#l5.8"></a><span id="l5.8"> }</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> var addIdentitiesAndFolder = function() {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-                .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-  let server = acctMgr.createIncomingServer(&quot;nobody&quot;,</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-                                            &quot;Reply Identity Testing&quot;, &quot;pop3&quot;);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+  let server = MailServices.accounts.createIncomingServer(&quot;nobody&quot;,</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+                                                          &quot;Reply Identity Testing&quot;, &quot;pop3&quot;);</span>
<a href="#l5.19"></a><span id="l5.19">   testFolder = server.rootFolder.QueryInterface(Ci.nsIMsgLocalMailFolder)</span>
<a href="#l5.20"></a><span id="l5.20">                      .createLocalSubfolder(&quot;Replies&quot;);</span>
<a href="#l5.21"></a><span id="l5.21"> </span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-  let identity = acctMgr.createIdentity();</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+  let identity = MailServices.accounts.createIdentity();</span>
<a href="#l5.24"></a><span id="l5.24">   identity.email = identity1Email;</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-  let identity2 = acctMgr.createIdentity();</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+  let identity2 = MailServices.accounts.createIdentity();</span>
<a href="#l5.28"></a><span id="l5.28">   identity2.email = identity2Email;</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-  let account = acctMgr.createAccount();</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+  let account = MailServices.accounts.createAccount();</span>
<a href="#l5.32"></a><span id="l5.32">   account.incomingServer = server;</span>
<a href="#l5.33"></a><span id="l5.33">   account.addIdentity(identity);</span>
<a href="#l5.34"></a><span id="l5.34">   account.addIdentity(identity2);</span>
<a href="#l5.35"></a><span id="l5.35"> }</span>
<a href="#l5.36"></a><span id="l5.36"> </span>
<a href="#l5.37"></a><span id="l5.37"> var checkReply = function (replyWin, expectedFromEmail) {</span>
<a href="#l5.38"></a><span id="l5.38">   let identityList = replyWin.e(&quot;msgIdentity&quot;);</span>
<a href="#l5.39"></a><span id="l5.39">   if (identityList.selectedItem.label.indexOf(expectedFromEmail) == -1)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -64,33 +64,30 @@ var addMessageToFolder = function (aFold</span>
<a href="#l6.4"></a><span id="l6.4">   aFolder.gettingNewMessages = true;</span>
<a href="#l6.5"></a><span id="l6.5">   aFolder.addMessage(source);</span>
<a href="#l6.6"></a><span id="l6.6">   aFolder.gettingNewMessages = false;</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8">   return aFolder.msgDatabase.getMsgHdrForMessageID(msgId);</span>
<a href="#l6.9"></a><span id="l6.9"> }</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> var addIdentitiesAndFolder = function() {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  var acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-                .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-  var identity2 = acctMgr.createIdentity();</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+  let identity2 = MailServices.accounts.createIdentity();</span>
<a href="#l6.17"></a><span id="l6.17">   //identity.fullName = &quot;Tinderbox_Identity1&quot;;</span>
<a href="#l6.18"></a><span id="l6.18">   identity2.email=&quot;tinderbox_identity1@foo.invalid&quot;;</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-  var identity = acctMgr.createIdentity();</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+  let identity = MailServices.accounts.createIdentity();</span>
<a href="#l6.22"></a><span id="l6.22">   //identity.fullName = &quot;Tinderbox_Identity1&quot;;</span>
<a href="#l6.23"></a><span id="l6.23">   identity.email = identityString1;</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-  var server = acctMgr.createIncomingServer(&quot;nobody&quot;,</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-                                            &quot;Test Local Folders&quot;, &quot;pop3&quot;);</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+  let server = MailServices.accounts.createIncomingServer(&quot;nobody&quot;,</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+                                                          &quot;Test Local Folders&quot;, &quot;pop3&quot;);</span>
<a href="#l6.29"></a><span id="l6.29">   let localRoot = server.rootFolder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l6.30"></a><span id="l6.30">   testFolder = localRoot.createLocalSubfolder(&quot;Test Folder&quot;);</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-  var account = acctMgr.createAccount();</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+  let account = MailServices.accounts.createAccount();</span>
<a href="#l6.34"></a><span id="l6.34">   account.incomingServer = server;</span>
<a href="#l6.35"></a><span id="l6.35">   account.addIdentity(identity);</span>
<a href="#l6.36"></a><span id="l6.36">   account.addIdentity(identity2);</span>
<a href="#l6.37"></a><span id="l6.37"> }</span>
<a href="#l6.38"></a><span id="l6.38"> </span>
<a href="#l6.39"></a><span id="l6.39"> function test_Reply_To_List_From_Address() {</span>
<a href="#l6.40"></a><span id="l6.40">   be_in_folder(testFolder);</span>
<a href="#l6.41"></a><span id="l6.41"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/test/unit/head_compose.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/test/unit/head_compose.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -5,16 +5,18 @@ load(&quot;../../../resources/mailTestUtils.j</span>
<a href="#l7.4"></a><span id="l7.4"> // Import the required setup scripts.</span>
<a href="#l7.5"></a><span id="l7.5"> load(&quot;../../../resources/abSetup.js&quot;);</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> // Import the smtp server scripts</span>
<a href="#l7.8"></a><span id="l7.8"> load(&quot;../../../fakeserver/maild.js&quot;)</span>
<a href="#l7.9"></a><span id="l7.9"> load(&quot;../../../fakeserver/auth.js&quot;)</span>
<a href="#l7.10"></a><span id="l7.10"> load(&quot;../../../fakeserver/smtpd.js&quot;)</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+</span>
<a href="#l7.14"></a><span id="l7.14"> const SMTP_PORT = 1024+120;</span>
<a href="#l7.15"></a><span id="l7.15"> var gDraftFolder;</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17"> // Setup the daemon and server</span>
<a href="#l7.18"></a><span id="l7.18"> function setupServerDaemon(handler) {</span>
<a href="#l7.19"></a><span id="l7.19">   if (!handler)</span>
<a href="#l7.20"></a><span id="l7.20">     handler = function (d) { return new SMTP_RFC2821_handler(d); }</span>
<a href="#l7.21"></a><span id="l7.21">   var server = new nsMailServer(handler, new smtpDaemon());</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -27,22 +29,18 @@ function getBasicSmtpServer() {</span>
<a href="#l7.23"></a><span id="l7.23">   // Override the default greeting so we get something predicitable</span>
<a href="#l7.24"></a><span id="l7.24">   // in the ELHO message</span>
<a href="#l7.25"></a><span id="l7.25">   Services.prefs.setCharPref(&quot;mail.smtpserver.default.hello_argument&quot;, &quot;test&quot;);</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27">   return server;</span>
<a href="#l7.28"></a><span id="l7.28"> }</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30"> function getSmtpIdentity(senderName, smtpServer) {</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-  // Get the servers</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-  var acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-</span>
<a href="#l7.35"></a><span id="l7.35">   // Set up the identity</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-  var identity = acctMgr.createIdentity();</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+  let identity = MailServices.accounts.createIdentity();</span>
<a href="#l7.38"></a><span id="l7.38">   identity.email = senderName;</span>
<a href="#l7.39"></a><span id="l7.39">   identity.smtpServerKey = smtpServer.key;</span>
<a href="#l7.40"></a><span id="l7.40"> </span>
<a href="#l7.41"></a><span id="l7.41">   return identity;</span>
<a href="#l7.42"></a><span id="l7.42"> }</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44"> var test;</span>
<a href="#l7.45"></a><span id="l7.45"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_bug155172.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_bug155172.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,15 +1,17 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l8.5"></a><span id="l8.5"> /**</span>
<a href="#l8.6"></a><span id="l8.6">  * Authentication tests for SMTP.</span>
<a href="#l8.7"></a><span id="l8.7">  */</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+</span>
<a href="#l8.13"></a><span id="l8.13"> var gNewPassword = null;</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15"> function confirmEx(aDialogTitle, aText, aButtonFlags, aButton0Title,</span>
<a href="#l8.16"></a><span id="l8.16">                    aButton1Title, aButton2Title, aCheckMsg, aCheckState) {</span>
<a href="#l8.17"></a><span id="l8.17">   // Just return 2 which will is pressing button 2 - enter a new password.</span>
<a href="#l8.18"></a><span id="l8.18">   return 2;</span>
<a href="#l8.19"></a><span id="l8.19"> }</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -55,35 +57,32 @@ function run_test() {</span>
<a href="#l8.22"></a><span id="l8.22">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24">   // Ensure we have at least one mail account</span>
<a href="#l8.25"></a><span id="l8.25">   loadLocalMailAccount();</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27">   var smtpServer = getBasicSmtpServer();</span>
<a href="#l8.28"></a><span id="l8.28">   var identity = getSmtpIdentity(kSender, smtpServer);</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-  var smtpService = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-                      .getService(Ci.nsISmtpService);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-</span>
<a href="#l8.33"></a><span id="l8.33">   // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l8.34"></a><span id="l8.34">   // the server if something fails.</span>
<a href="#l8.35"></a><span id="l8.35">   try {</span>
<a href="#l8.36"></a><span id="l8.36">     // Start the fake SMTP server</span>
<a href="#l8.37"></a><span id="l8.37">     server.start(SMTP_PORT);</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39">     // This time with auth</span>
<a href="#l8.40"></a><span id="l8.40">     test = &quot;Auth sendMailMessage&quot;;</span>
<a href="#l8.41"></a><span id="l8.41"> </span>
<a href="#l8.42"></a><span id="l8.42">     smtpServer.authMethod = Ci.nsMsgAuthMethod.passwordCleartext;</span>
<a href="#l8.43"></a><span id="l8.43">     smtpServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l8.44"></a><span id="l8.44">     smtpServer.username = kUsername;</span>
<a href="#l8.45"></a><span id="l8.45"> </span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-    smtpService.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-                                null, null, null, null,</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-                                false, {}, {});</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+    MailServices.smtp.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+                                      null, null, null, null,</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+                                      false, {}, {});</span>
<a href="#l8.52"></a><span id="l8.52"> </span>
<a href="#l8.53"></a><span id="l8.53">     // Set the new password for when we get a prompt</span>
<a href="#l8.54"></a><span id="l8.54">     gNewPassword = kPassword1;</span>
<a href="#l8.55"></a><span id="l8.55"> </span>
<a href="#l8.56"></a><span id="l8.56">     server.performTest();</span>
<a href="#l8.57"></a><span id="l8.57"> </span>
<a href="#l8.58"></a><span id="l8.58">     var transaction = server.playTransaction();</span>
<a href="#l8.59"></a><span id="l8.59">     do_check_transaction(transaction, [&quot;EHLO test&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_bug235432.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_bug235432.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l9.5"></a><span id="l9.5"> /**</span>
<a href="#l9.6"></a><span id="l9.6">  * Test for bug 235432</span>
<a href="#l9.7"></a><span id="l9.7">  */</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l9.10"></a><span id="l9.10"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12"> var testmail = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l9.13"></a><span id="l9.13"> var expectedTemporaryFile;</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15"> const kSender = &quot;from@foo.invalid&quot;;</span>
<a href="#l9.16"></a><span id="l9.16"> const kTo = &quot;to@foo.invalid&quot;;</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18" class="difflineat">@@ -56,25 +57,23 @@ function copyFileMessageInLocalFolder(aM</span>
<a href="#l9.19"></a><span id="l9.19">                                       aMessageKeywords,</span>
<a href="#l9.20"></a><span id="l9.20">                                       aMessageWindow,</span>
<a href="#l9.21"></a><span id="l9.21">                                       aCallback) {</span>
<a href="#l9.22"></a><span id="l9.22">   // Set up local folders</span>
<a href="#l9.23"></a><span id="l9.23">   loadLocalMailAccount();</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25">   gCopyListener.callbackFunction = aCallback;</span>
<a href="#l9.26"></a><span id="l9.26">   // Copy a message into the local folder</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-  Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-    .getService(Ci.nsIMsgCopyService)</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-    .CopyFileMessage(aMessageFile,</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-                     gLocalInboxFolder,</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-                     null, false,</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-                     aMessageFlags,</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-                     aMessageKeywords,</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-                     gCopyListener,</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-                     aMessageWindow);</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+  MailServices.copy.CopyFileMessage(aMessageFile,</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+                                    gLocalInboxFolder,</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+                                    null, false,</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+                                    aMessageFlags,</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+                                    aMessageKeywords,</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+                                    gCopyListener,</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+                                    aMessageWindow);</span>
<a href="#l9.43"></a><span id="l9.43"> }</span>
<a href="#l9.44"></a><span id="l9.44"> </span>
<a href="#l9.45"></a><span id="l9.45"> // The attatchment file can not be obtained from js test,</span>
<a href="#l9.46"></a><span id="l9.46"> // so we have to generate the file name here.</span>
<a href="#l9.47"></a><span id="l9.47"> function createExpectedTemporaryFile() {</span>
<a href="#l9.48"></a><span id="l9.48">   function createTemporaryFile() {</span>
<a href="#l9.49"></a><span id="l9.49">     let file = Services.dirsvc.get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l9.50"></a><span id="l9.50">     file.append(&quot;nsmail.tmp&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_bug474774.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_bug474774.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,13 +1,16 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l10.5"></a><span id="l10.5"> /**</span>
<a href="#l10.6"></a><span id="l10.6">  * Tests bug 474774 - assertions when saving send later and when sending with </span>
<a href="#l10.7"></a><span id="l10.7">  * FCC switched off.</span>
<a href="#l10.8"></a><span id="l10.8">  */</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+</span>
<a href="#l10.12"></a><span id="l10.12"> var type = null;</span>
<a href="#l10.13"></a><span id="l10.13"> var test = null;</span>
<a href="#l10.14"></a><span id="l10.14"> var server;</span>
<a href="#l10.15"></a><span id="l10.15"> var sentFolder;</span>
<a href="#l10.16"></a><span id="l10.16"> var originalData;</span>
<a href="#l10.17"></a><span id="l10.17"> var finished = false;</span>
<a href="#l10.18"></a><span id="l10.18"> var identity = null;</span>
<a href="#l10.19"></a><span id="l10.19"> var testFile = do_get_file(&quot;data/429891_testcase.eml&quot;);</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineat">@@ -166,22 +169,20 @@ function sendMessageLater()</span>
<a href="#l10.21"></a><span id="l10.21"> function run_test() {</span>
<a href="#l10.22"></a><span id="l10.22">   // Test file - for bug 429891</span>
<a href="#l10.23"></a><span id="l10.23">   originalData = loadFileToString(testFile);</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25">   // Ensure we have a local mail account, an normal account and appropriate</span>
<a href="#l10.26"></a><span id="l10.26">   // servers and identities.</span>
<a href="#l10.27"></a><span id="l10.27">   loadLocalMailAccount();</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-  var acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-  acctMgr.setSpecialFolders();</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+  MailServices.accounts.setSpecialFolders();</span>
<a href="#l10.33"></a><span id="l10.33"> </span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-  var account = acctMgr.createAccount();</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-  var incomingServer = acctMgr.createIncomingServer(&quot;test&quot;, &quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+  let account = MailServices.accounts.createAccount();</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+  let incomingServer = MailServices.accounts.createIncomingServer(&quot;test&quot;, &quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l10.38"></a><span id="l10.38"> </span>
<a href="#l10.39"></a><span id="l10.39">   var smtpServer = getBasicSmtpServer();</span>
<a href="#l10.40"></a><span id="l10.40">   identity = getSmtpIdentity(kSender, smtpServer);</span>
<a href="#l10.41"></a><span id="l10.41"> </span>
<a href="#l10.42"></a><span id="l10.42">   account.addIdentity(identity);</span>
<a href="#l10.43"></a><span id="l10.43">   account.defaultIdentity = identity;</span>
<a href="#l10.44"></a><span id="l10.44">   account.incomingServer = incomingServer;</span>
<a href="#l10.45"></a><span id="l10.45"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_nsMsgCompose3.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_nsMsgCompose3.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,14 +1,16 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l11.5"></a><span id="l11.5"> /*</span>
<a href="#l11.6"></a><span id="l11.6">  * Test suite for increasing the popularity of contacts via</span>
<a href="#l11.7"></a><span id="l11.7">  * checkAndPopulateRecipients.</span>
<a href="#l11.8"></a><span id="l11.8">  */</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+</span>
<a href="#l11.12"></a><span id="l11.12"> const MsgComposeContractID = &quot;@mozilla.org/messengercompose/compose;1&quot;;</span>
<a href="#l11.13"></a><span id="l11.13"> const MsgComposeParamsContractID = &quot;@mozilla.org/messengercompose/composeparams;1&quot;;</span>
<a href="#l11.14"></a><span id="l11.14"> const MsgComposeFieldsContractID = &quot;@mozilla.org/messengercompose/composefields;1&quot;;</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16"> const TESTS = [</span>
<a href="#l11.17"></a><span id="l11.17">   {</span>
<a href="#l11.18"></a><span id="l11.18">     email: &quot;em@test.invalid&quot;,</span>
<a href="#l11.19"></a><span id="l11.19">     // TB 2 stored popularity as hex, so we need to check correct handling.</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineat">@@ -63,19 +65,17 @@ function checkPopulate(aTo, aNonHTMLReci</span>
<a href="#l11.21"></a><span id="l11.21"> function run_test() {</span>
<a href="#l11.22"></a><span id="l11.22">   // Test setup - copy the data files into place</span>
<a href="#l11.23"></a><span id="l11.23">   let testAB = do_get_file(&quot;../../../data/tb2hexpopularity.mab&quot;);</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25">   // Copy the file to the profile directory for a PAB</span>
<a href="#l11.26"></a><span id="l11.26">   testAB.copyTo(gProfileDir, kPABData.fileName);</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28">   // Check the popularity index on a couple of cards.</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-  let abManager = Cc[&quot;@mozilla.org/abmanager;1&quot;].getService(Ci.nsIAbManager);</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-  let AB = abManager.getDirectory(kPABData.URI);</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+  let AB = MailServices.ab.getDirectory(kPABData.URI);</span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34">   for (let i = 0; i &lt; TESTS.length; ++i) {</span>
<a href="#l11.35"></a><span id="l11.35">     let card = AB.cardForEmailAddress(TESTS[i].email);</span>
<a href="#l11.36"></a><span id="l11.36">     do_check_true(!!card);</span>
<a href="#l11.37"></a><span id="l11.37"> </span>
<a href="#l11.38"></a><span id="l11.38">     // Thunderbird 2 stored its popularityIndexes as hex, hence when we read it</span>
<a href="#l11.39"></a><span id="l11.39">     // now we're going to get a hex value. The AB has a value of &quot;a&quot;.</span>
<a href="#l11.40"></a><span id="l11.40">     do_check_eq(card.getProperty(&quot;PopularityIndex&quot;, -1), TESTS[i].prePopularity);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendBackground.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendBackground.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,12 +1,15 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l12.5"></a><span id="l12.5"> /**</span>
<a href="#l12.6"></a><span id="l12.6">  * Tests sending a message in the background (checks auto-send works).</span>
<a href="#l12.7"></a><span id="l12.7">  */</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+</span>
<a href="#l12.11"></a><span id="l12.11"> var type = null;</span>
<a href="#l12.12"></a><span id="l12.12"> var test = null;</span>
<a href="#l12.13"></a><span id="l12.13"> var server;</span>
<a href="#l12.14"></a><span id="l12.14"> var sentFolder;</span>
<a href="#l12.15"></a><span id="l12.15"> var originalData;</span>
<a href="#l12.16"></a><span id="l12.16"> var finished = false;</span>
<a href="#l12.17"></a><span id="l12.17"> var identity = null;</span>
<a href="#l12.18"></a><span id="l12.18"> var testFile1 = do_get_file(&quot;data/429891_testcase.eml&quot;);</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineat">@@ -91,22 +94,20 @@ function run_test() {</span>
<a href="#l12.20"></a><span id="l12.20">                     .getService(Ci.nsIMsgSendLater);</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22">   // Test file - for bug 429891</span>
<a href="#l12.23"></a><span id="l12.23">   originalData = loadFileToString(testFile1);</span>
<a href="#l12.24"></a><span id="l12.24"> </span>
<a href="#l12.25"></a><span id="l12.25">   // Check that the send later service thinks we don't have messages to send</span>
<a href="#l12.26"></a><span id="l12.26">   do_check_eq(gMsgSendLater.hasUnsentMessages(identity), false);</span>
<a href="#l12.27"></a><span id="l12.27"> </span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-  var acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-  acctMgr.setSpecialFolders();</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+  MailServices.accounts.setSpecialFolders();</span>
<a href="#l12.32"></a><span id="l12.32"> </span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-  var account = acctMgr.createAccount();</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-  var incomingServer = acctMgr.createIncomingServer(&quot;test&quot;, &quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+  let account = MailServices.accounts.createAccount();</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+  let incomingServer = MailServices.accounts.createIncomingServer(&quot;test&quot;, &quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l12.37"></a><span id="l12.37"> </span>
<a href="#l12.38"></a><span id="l12.38">   var smtpServer = getBasicSmtpServer();</span>
<a href="#l12.39"></a><span id="l12.39">   identity = getSmtpIdentity(kSender, smtpServer);</span>
<a href="#l12.40"></a><span id="l12.40"> </span>
<a href="#l12.41"></a><span id="l12.41">   account.addIdentity(identity);</span>
<a href="#l12.42"></a><span id="l12.42">   account.defaultIdentity = identity;</span>
<a href="#l12.43"></a><span id="l12.43">   account.incomingServer = incomingServer;</span>
<a href="#l12.44"></a><span id="l12.44"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMailMessage.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMailMessage.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,16 +1,18 @@</span>
<a href="#l13.4"></a><span id="l13.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l13.5"></a><span id="l13.5"> /**</span>
<a href="#l13.6"></a><span id="l13.6">  * Protocol tests for SMTP.</span>
<a href="#l13.7"></a><span id="l13.7">  *</span>
<a href="#l13.8"></a><span id="l13.8">  * This test currently consists of verifying the correct protocol sequence</span>
<a href="#l13.9"></a><span id="l13.9">  * between mailnews and SMTP server. It does not check the data of the message</span>
<a href="#l13.10"></a><span id="l13.10">  * either side of the link, it will be extended later to do that.</span>
<a href="#l13.11"></a><span id="l13.11">  */</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+</span>
<a href="#l13.14"></a><span id="l13.14"> var test = null;</span>
<a href="#l13.15"></a><span id="l13.15"> var server;</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17"> const kSender = &quot;from@foo.invalid&quot;;</span>
<a href="#l13.18"></a><span id="l13.18"> const kTo = &quot;to@foo.invalid&quot;;</span>
<a href="#l13.19"></a><span id="l13.19"> const kUsername = &quot;testsmtp&quot;;</span>
<a href="#l13.20"></a><span id="l13.20"> const kPassword = &quot;smtptest&quot;;</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -20,31 +22,28 @@ function test_RFC2821() {</span>
<a href="#l13.23"></a><span id="l13.23">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l13.24"></a><span id="l13.24"> </span>
<a href="#l13.25"></a><span id="l13.25">   // Ensure we have at least one mail account</span>
<a href="#l13.26"></a><span id="l13.26">   loadLocalMailAccount();</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28">   var smtpServer = getBasicSmtpServer();</span>
<a href="#l13.29"></a><span id="l13.29">   var identity = getSmtpIdentity(kSender, smtpServer);</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-  var smtpService = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-                      .getService(Ci.nsISmtpService);</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-</span>
<a href="#l13.34"></a><span id="l13.34">   // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l13.35"></a><span id="l13.35">   // the server if something fails.</span>
<a href="#l13.36"></a><span id="l13.36">   try {</span>
<a href="#l13.37"></a><span id="l13.37">     // Start the fake SMTP server</span>
<a href="#l13.38"></a><span id="l13.38">     server.start(SMTP_PORT);</span>
<a href="#l13.39"></a><span id="l13.39"> </span>
<a href="#l13.40"></a><span id="l13.40">     // Just a basic test to check we're sending mail correctly.</span>
<a href="#l13.41"></a><span id="l13.41">     test = &quot;Basic sendMailMessage&quot;;</span>
<a href="#l13.42"></a><span id="l13.42"> </span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-    smtpService.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-                                null, null, null, null,</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-                                false, {}, {});</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+    MailServices.smtp.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+                                      null, null, null, null,</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+                                      false, {}, {});</span>
<a href="#l13.49"></a><span id="l13.49"> </span>
<a href="#l13.50"></a><span id="l13.50">     server.performTest();</span>
<a href="#l13.51"></a><span id="l13.51"> </span>
<a href="#l13.52"></a><span id="l13.52">     var transaction = server.playTransaction();</span>
<a href="#l13.53"></a><span id="l13.53">     do_check_transaction(transaction, [&quot;EHLO test&quot;,</span>
<a href="#l13.54"></a><span id="l13.54">                                        &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=155&quot;,</span>
<a href="#l13.55"></a><span id="l13.55">                                        &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l13.56"></a><span id="l13.56">                                        &quot;DATA&quot;]);</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineat">@@ -54,19 +53,19 @@ function test_RFC2821() {</span>
<a href="#l13.58"></a><span id="l13.58">     // This time with auth</span>
<a href="#l13.59"></a><span id="l13.59">     test = &quot;Auth sendMailMessage&quot;;</span>
<a href="#l13.60"></a><span id="l13.60"> </span>
<a href="#l13.61"></a><span id="l13.61">     smtpServer.authMethod = Ci.nsMsgAuthMethod.passwordCleartext;</span>
<a href="#l13.62"></a><span id="l13.62">     smtpServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l13.63"></a><span id="l13.63">     smtpServer.username = kUsername;</span>
<a href="#l13.64"></a><span id="l13.64">     smtpServer.password = kPassword;</span>
<a href="#l13.65"></a><span id="l13.65"> </span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-    smtpService.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-                                null, null, null, null,</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-                                false, {}, {});</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+    MailServices.smtp.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+                                      null, null, null, null,</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+                                      false, {}, {});</span>
<a href="#l13.72"></a><span id="l13.72"> </span>
<a href="#l13.73"></a><span id="l13.73">     server.performTest();</span>
<a href="#l13.74"></a><span id="l13.74"> </span>
<a href="#l13.75"></a><span id="l13.75">     var transaction = server.playTransaction();</span>
<a href="#l13.76"></a><span id="l13.76">     do_check_transaction(transaction, [&quot;EHLO test&quot;,</span>
<a href="#l13.77"></a><span id="l13.77">                                        &quot;AUTH PLAIN &quot; + AuthPLAIN.encodeLine(kUsername, kPassword),</span>
<a href="#l13.78"></a><span id="l13.78">                                        &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=155&quot;,</span>
<a href="#l13.79"></a><span id="l13.79">                                        &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMessageFile.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMessageFile.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -5,16 +5,19 @@</span>
<a href="#l14.4"></a><span id="l14.4">  * This test verifies:</span>
<a href="#l14.5"></a><span id="l14.5">  * - Sending a message to an SMTP server (which is also covered elsewhere).</span>
<a href="#l14.6"></a><span id="l14.6">  * - Correct reception of the message by the SMTP server.</span>
<a href="#l14.7"></a><span id="l14.7">  * - Correct saving of the message to the sent folder.</span>
<a href="#l14.8"></a><span id="l14.8">  *</span>
<a href="#l14.9"></a><span id="l14.9">  * Originally written to test bug 429891 where saving to the sent folder was</span>
<a href="#l14.10"></a><span id="l14.10">  * mangling the message.</span>
<a href="#l14.11"></a><span id="l14.11">  */</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+</span>
<a href="#l14.15"></a><span id="l14.15"> var type = null;</span>
<a href="#l14.16"></a><span id="l14.16"> var test = null;</span>
<a href="#l14.17"></a><span id="l14.17"> var server;</span>
<a href="#l14.18"></a><span id="l14.18"> var sentFolder;</span>
<a href="#l14.19"></a><span id="l14.19"> var originalData;</span>
<a href="#l14.20"></a><span id="l14.20"> var finished = false;</span>
<a href="#l14.21"></a><span id="l14.21"> </span>
<a href="#l14.22"></a><span id="l14.22"> const kSender = &quot;from@foo.invalid&quot;;</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineat">@@ -105,19 +108,17 @@ function run_test() {</span>
<a href="#l14.24"></a><span id="l14.24"> </span>
<a href="#l14.25"></a><span id="l14.25">   // Test file - for bug 429891</span>
<a href="#l14.26"></a><span id="l14.26">   var testFile = do_get_file(&quot;data/429891_testcase.eml&quot;);</span>
<a href="#l14.27"></a><span id="l14.27">   originalData = loadFileToString(testFile);</span>
<a href="#l14.28"></a><span id="l14.28"> </span>
<a href="#l14.29"></a><span id="l14.29">   // Ensure we have at least one mail account</span>
<a href="#l14.30"></a><span id="l14.30">   loadLocalMailAccount();</span>
<a href="#l14.31"></a><span id="l14.31"> </span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-  var acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-  acctMgr.setSpecialFolders();</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+  MailServices.accounts.setSpecialFolders();</span>
<a href="#l14.36"></a><span id="l14.36"> </span>
<a href="#l14.37"></a><span id="l14.37">   var smtpServer = getBasicSmtpServer();</span>
<a href="#l14.38"></a><span id="l14.38">   var identity = getSmtpIdentity(kSender, smtpServer);</span>
<a href="#l14.39"></a><span id="l14.39"> </span>
<a href="#l14.40"></a><span id="l14.40">   sentFolder = gLocalIncomingServer.rootMsgFolder.createLocalSubfolder(&quot;Sent&quot;);</span>
<a href="#l14.41"></a><span id="l14.41"> </span>
<a href="#l14.42"></a><span id="l14.42">   do_check_eq(identity.doFcc, true);</span>
<a href="#l14.43"></a><span id="l14.43"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMessageLater.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMessageLater.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -5,16 +5,19 @@</span>
<a href="#l15.4"></a><span id="l15.4">  * This test verifies:</span>
<a href="#l15.5"></a><span id="l15.5">  * - Sending a message to an SMTP server (which is also covered elsewhere).</span>
<a href="#l15.6"></a><span id="l15.6">  * - Correct reception of the message by the SMTP server.</span>
<a href="#l15.7"></a><span id="l15.7">  * - Correct saving of the message to the sent folder.</span>
<a href="#l15.8"></a><span id="l15.8">  *</span>
<a href="#l15.9"></a><span id="l15.9">  * Originally written to test bug 429891 where saving to the sent folder was</span>
<a href="#l15.10"></a><span id="l15.10">  * mangling the message.</span>
<a href="#l15.11"></a><span id="l15.11">  */</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+</span>
<a href="#l15.15"></a><span id="l15.15"> var type = null;</span>
<a href="#l15.16"></a><span id="l15.16"> var test = null;</span>
<a href="#l15.17"></a><span id="l15.17"> var server;</span>
<a href="#l15.18"></a><span id="l15.18"> var sentFolder;</span>
<a href="#l15.19"></a><span id="l15.19"> var originalData;</span>
<a href="#l15.20"></a><span id="l15.20"> var finished = false;</span>
<a href="#l15.21"></a><span id="l15.21"> var identity = null;</span>
<a href="#l15.22"></a><span id="l15.22"> var testFile = do_get_file(&quot;data/429891_testcase.eml&quot;);</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineat">@@ -173,22 +176,20 @@ function run_test() {</span>
<a href="#l15.24"></a><span id="l15.24"> </span>
<a href="#l15.25"></a><span id="l15.25">   // Ensure we have a local mail account, an normal account and appropriate</span>
<a href="#l15.26"></a><span id="l15.26">   // servers and identities.</span>
<a href="#l15.27"></a><span id="l15.27">   loadLocalMailAccount();</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29">   // Check that the send later service thinks we don't have messages to send</span>
<a href="#l15.30"></a><span id="l15.30">   do_check_eq(msgSendLater.hasUnsentMessages(identity), false);</span>
<a href="#l15.31"></a><span id="l15.31"> </span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-  var acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-  acctMgr.setSpecialFolders();</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+  MailServices.accounts.setSpecialFolders();</span>
<a href="#l15.36"></a><span id="l15.36"> </span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-  var account = acctMgr.createAccount();</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-  var incomingServer = acctMgr.createIncomingServer(&quot;test&quot;, &quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+  let account = MailServices.accounts.createAccount();</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+  let incomingServer = MailServices.accounts.createIncomingServer(&quot;test&quot;, &quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l15.41"></a><span id="l15.41"> </span>
<a href="#l15.42"></a><span id="l15.42">   var smtpServer = getBasicSmtpServer();</span>
<a href="#l15.43"></a><span id="l15.43">   identity = getSmtpIdentity(kSender, smtpServer);</span>
<a href="#l15.44"></a><span id="l15.44"> </span>
<a href="#l15.45"></a><span id="l15.45">   account.addIdentity(identity);</span>
<a href="#l15.46"></a><span id="l15.46">   account.defaultIdentity = identity;</span>
<a href="#l15.47"></a><span id="l15.47">   account.incomingServer = incomingServer;</span>
<a href="#l15.48"></a><span id="l15.48"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMessageLater2.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMessageLater2.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -10,16 +10,18 @@</span>
<a href="#l16.4"></a><span id="l16.4">  * messages is currently disabled (but commented out for local testing if</span>
<a href="#l16.5"></a><span id="l16.5">  * required), when we fix bug 136871 we should be able to enable the multiple</span>
<a href="#l16.6"></a><span id="l16.6">  * messages option. </span>
<a href="#l16.7"></a><span id="l16.7">  */</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l16.10"></a><span id="l16.10"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+</span>
<a href="#l16.14"></a><span id="l16.14"> var test = &quot;sendMessageLater&quot;;</span>
<a href="#l16.15"></a><span id="l16.15"> var server = null;</span>
<a href="#l16.16"></a><span id="l16.16"> var gSentFolder;</span>
<a href="#l16.17"></a><span id="l16.17"> var originalData;</span>
<a href="#l16.18"></a><span id="l16.18"> var identity = null;</span>
<a href="#l16.19"></a><span id="l16.19"> var gMsgFile =</span>
<a href="#l16.20"></a><span id="l16.20"> [</span>
<a href="#l16.21"></a><span id="l16.21">   do_get_file(&quot;data/message1.eml&quot;),</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -218,22 +220,20 @@ function run_test() {</span>
<a href="#l16.23"></a><span id="l16.23"> </span>
<a href="#l16.24"></a><span id="l16.24">   // Ensure we have a local mail account, an normal account and appropriate</span>
<a href="#l16.25"></a><span id="l16.25">   // servers and identities.</span>
<a href="#l16.26"></a><span id="l16.26">   loadLocalMailAccount();</span>
<a href="#l16.27"></a><span id="l16.27"> </span>
<a href="#l16.28"></a><span id="l16.28">   // Check that the send later service thinks we don't have messages to send.</span>
<a href="#l16.29"></a><span id="l16.29">   do_check_eq(msgSendLater.hasUnsentMessages(identity), false);</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-  var acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-  acctMgr.setSpecialFolders();</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+  MailServices.accounts.setSpecialFolders();</span>
<a href="#l16.35"></a><span id="l16.35"> </span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-  var account = acctMgr.createAccount();</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-  var incomingServer = acctMgr.createIncomingServer(&quot;test&quot;, &quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+  let account = MailServices.accounts.createAccount();</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+  let incomingServer = MailServices.accounts.createIncomingServer(&quot;test&quot;, &quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l16.40"></a><span id="l16.40"> </span>
<a href="#l16.41"></a><span id="l16.41">   var smtpServer = getBasicSmtpServer();</span>
<a href="#l16.42"></a><span id="l16.42">   identity = getSmtpIdentity(kSender, smtpServer);</span>
<a href="#l16.43"></a><span id="l16.43"> </span>
<a href="#l16.44"></a><span id="l16.44">   account.addIdentity(identity);</span>
<a href="#l16.45"></a><span id="l16.45">   account.defaultIdentity = identity;</span>
<a href="#l16.46"></a><span id="l16.46">   account.incomingServer = incomingServer;</span>
<a href="#l16.47"></a><span id="l16.47"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMessageLater3.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMessageLater3.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -5,16 +5,18 @@</span>
<a href="#l17.4"></a><span id="l17.4">  * For trying to send a message later with no server connected, this test</span>
<a href="#l17.5"></a><span id="l17.5">  * verifies:</span>
<a href="#l17.6"></a><span id="l17.6">  *   - A correct status response.</span>
<a href="#l17.7"></a><span id="l17.7">  *   - A correct state at the end of attempting to send.</span>
<a href="#l17.8"></a><span id="l17.8">  */</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+</span>
<a href="#l17.14"></a><span id="l17.14"> var type = null;</span>
<a href="#l17.15"></a><span id="l17.15"> var test = null;</span>
<a href="#l17.16"></a><span id="l17.16"> var server;</span>
<a href="#l17.17"></a><span id="l17.17"> var sentFolder;</span>
<a href="#l17.18"></a><span id="l17.18"> var transaction;</span>
<a href="#l17.19"></a><span id="l17.19"> var originalData;</span>
<a href="#l17.20"></a><span id="l17.20"> var finished = false;</span>
<a href="#l17.21"></a><span id="l17.21"> var identity = null;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -121,22 +123,20 @@ function run_test() {</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24">   // Ensure we have a local mail account, an normal account and appropriate</span>
<a href="#l17.25"></a><span id="l17.25">   // servers and identities.</span>
<a href="#l17.26"></a><span id="l17.26">   loadLocalMailAccount();</span>
<a href="#l17.27"></a><span id="l17.27"> </span>
<a href="#l17.28"></a><span id="l17.28">   // Check that the send later service thinks we don't have messages to send.</span>
<a href="#l17.29"></a><span id="l17.29">   do_check_eq(msgSendLater.hasUnsentMessages(identity), false);</span>
<a href="#l17.30"></a><span id="l17.30"> </span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-  var acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-  acctMgr.setSpecialFolders();</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+  MailServices.accounts.setSpecialFolders();</span>
<a href="#l17.35"></a><span id="l17.35"> </span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-  var account = acctMgr.createAccount();</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-  var incomingServer = acctMgr.createIncomingServer(&quot;test&quot;, &quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+  let account = MailServices.accounts.createAccount();</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+  let incomingServer = MailServices.accounts.createIncomingServer(&quot;test&quot;, &quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l17.40"></a><span id="l17.40"> </span>
<a href="#l17.41"></a><span id="l17.41">   var smtpServer = getBasicSmtpServer();</span>
<a href="#l17.42"></a><span id="l17.42">   identity = getSmtpIdentity(kSender, smtpServer);</span>
<a href="#l17.43"></a><span id="l17.43"> </span>
<a href="#l17.44"></a><span id="l17.44">   account.addIdentity(identity);</span>
<a href="#l17.45"></a><span id="l17.45">   account.defaultIdentity = identity;</span>
<a href="#l17.46"></a><span id="l17.46">   account.incomingServer = incomingServer;</span>
<a href="#l17.47"></a><span id="l17.47"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpAuthMethods.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpAuthMethods.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,19 +1,20 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l18.5"></a><span id="l18.5"> /**</span>
<a href="#l18.6"></a><span id="l18.6">  * Authentication tests for SMTP.</span>
<a href="#l18.7"></a><span id="l18.7">  *</span>
<a href="#l18.8"></a><span id="l18.8">  * Test code &lt;copied from=&quot;test_pop3AuthMethods.js&quot;&gt;</span>
<a href="#l18.9"></a><span id="l18.9">  */</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+</span>
<a href="#l18.13"></a><span id="l18.13"> var server;</span>
<a href="#l18.14"></a><span id="l18.14"> var kAuthSchemes;</span>
<a href="#l18.15"></a><span id="l18.15"> var smtpServer;</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-var smtpService;</span>
<a href="#l18.17"></a><span id="l18.17"> var testFile;</span>
<a href="#l18.18"></a><span id="l18.18"> var identity;</span>
<a href="#l18.19"></a><span id="l18.19"> </span>
<a href="#l18.20"></a><span id="l18.20"> const kUsername = &quot;fred&quot;;</span>
<a href="#l18.21"></a><span id="l18.21"> const kPassword = &quot;wilma&quot;;</span>
<a href="#l18.22"></a><span id="l18.22"> const kSender = &quot;from@foo.invalid&quot;;</span>
<a href="#l18.23"></a><span id="l18.23"> const kTo = &quot;to@foo.invalid&quot;;</span>
<a href="#l18.24"></a><span id="l18.24"> const MAILFROM = &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=155&quot;;</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineat">@@ -68,19 +69,19 @@ function nextTest() {</span>
<a href="#l18.26"></a><span id="l18.26">   dump(&quot;NEXT test: &quot; + curTest.title + &quot;\n&quot;);</span>
<a href="#l18.27"></a><span id="l18.27"> </span>
<a href="#l18.28"></a><span id="l18.28"> </span>
<a href="#l18.29"></a><span id="l18.29">   // Adapt to curTest</span>
<a href="#l18.30"></a><span id="l18.30">   kAuthSchemes = curTest.serverAuthMethods;</span>
<a href="#l18.31"></a><span id="l18.31">   smtpServer.authMethod = curTest.clientAuthMethod;</span>
<a href="#l18.32"></a><span id="l18.32"> </span>
<a href="#l18.33"></a><span id="l18.33">   // Run test</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-  smtpService.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-                              null, null, null, null,</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-                              false, {}, {});</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+  MailServices.smtp.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+                                    null, null, null, null,</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+                                    false, {}, {});</span>
<a href="#l18.40"></a><span id="l18.40">   server.performTest();</span>
<a href="#l18.41"></a><span id="l18.41"> </span>
<a href="#l18.42"></a><span id="l18.42">   do_check_transaction(server.playTransaction(), curTest.transaction);</span>
<a href="#l18.43"></a><span id="l18.43"> </span>
<a href="#l18.44"></a><span id="l18.44">   nextTest();</span>
<a href="#l18.45"></a><span id="l18.45"> }</span>
<a href="#l18.46"></a><span id="l18.46"> </span>
<a href="#l18.47"></a><span id="l18.47"> function run_test() {</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineat">@@ -100,18 +101,16 @@ function run_test() {</span>
<a href="#l18.49"></a><span id="l18.49">     server.start(SMTP_PORT);</span>
<a href="#l18.50"></a><span id="l18.50"> </span>
<a href="#l18.51"></a><span id="l18.51">     loadLocalMailAccount();</span>
<a href="#l18.52"></a><span id="l18.52">     smtpServer = getBasicSmtpServer();</span>
<a href="#l18.53"></a><span id="l18.53">     smtpServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l18.54"></a><span id="l18.54">     smtpServer.username = kUsername;</span>
<a href="#l18.55"></a><span id="l18.55">     smtpServer.password = kPassword;</span>
<a href="#l18.56"></a><span id="l18.56">     identity = getSmtpIdentity(kSender, smtpServer);</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineminus">-    smtpService = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineminus">-                        .getService(Ci.nsISmtpService);</span>
<a href="#l18.59"></a><span id="l18.59"> </span>
<a href="#l18.60"></a><span id="l18.60">     testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l18.61"></a><span id="l18.61"> </span>
<a href="#l18.62"></a><span id="l18.62">     nextTest();</span>
<a href="#l18.63"></a><span id="l18.63"> </span>
<a href="#l18.64"></a><span id="l18.64">   } catch (e) {</span>
<a href="#l18.65"></a><span id="l18.65">     do_throw(e);</span>
<a href="#l18.66"></a><span id="l18.66">   } finally {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPassword.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPassword.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -1,13 +1,15 @@</span>
<a href="#l19.4"></a><span id="l19.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l19.5"></a><span id="l19.5"> /**</span>
<a href="#l19.6"></a><span id="l19.6">  * Authentication tests for SMTP.</span>
<a href="#l19.7"></a><span id="l19.7">  */</span>
<a href="#l19.8"></a><span id="l19.8"> </span>
<a href="#l19.9"></a><span id="l19.9" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineplus">+</span>
<a href="#l19.11"></a><span id="l19.11"> var server;</span>
<a href="#l19.12"></a><span id="l19.12"> </span>
<a href="#l19.13"></a><span id="l19.13"> const kSender = &quot;from@foo.invalid&quot;;</span>
<a href="#l19.14"></a><span id="l19.14"> const kTo = &quot;to@foo.invalid&quot;;</span>
<a href="#l19.15"></a><span id="l19.15"> const kUsername = &quot;testsmtp&quot;;</span>
<a href="#l19.16"></a><span id="l19.16"> // This is the same as in the signons file.</span>
<a href="#l19.17"></a><span id="l19.17"> const kPassword = &quot;smtptest&quot;;</span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19" class="difflineat">@@ -32,35 +34,32 @@ function run_test() {</span>
<a href="#l19.20"></a><span id="l19.20">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l19.21"></a><span id="l19.21"> </span>
<a href="#l19.22"></a><span id="l19.22">   // Ensure we have at least one mail account</span>
<a href="#l19.23"></a><span id="l19.23">   loadLocalMailAccount();</span>
<a href="#l19.24"></a><span id="l19.24"> </span>
<a href="#l19.25"></a><span id="l19.25">   var smtpServer = getBasicSmtpServer();</span>
<a href="#l19.26"></a><span id="l19.26">   var identity = getSmtpIdentity(kSender, smtpServer);</span>
<a href="#l19.27"></a><span id="l19.27"> </span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">-  var smtpService = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineminus">-                      .getService(Ci.nsISmtpService);</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-</span>
<a href="#l19.31"></a><span id="l19.31">   // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l19.32"></a><span id="l19.32">   // the server if something fails.</span>
<a href="#l19.33"></a><span id="l19.33">   try {</span>
<a href="#l19.34"></a><span id="l19.34">     // Start the fake SMTP server</span>
<a href="#l19.35"></a><span id="l19.35">     server.start(SMTP_PORT);</span>
<a href="#l19.36"></a><span id="l19.36"> </span>
<a href="#l19.37"></a><span id="l19.37">     // This time with auth</span>
<a href="#l19.38"></a><span id="l19.38">     test = &quot;Auth sendMailMessage&quot;;</span>
<a href="#l19.39"></a><span id="l19.39"> </span>
<a href="#l19.40"></a><span id="l19.40">     smtpServer.authMethod = Ci.nsMsgAuthMethod.passwordCleartext;</span>
<a href="#l19.41"></a><span id="l19.41">     smtpServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l19.42"></a><span id="l19.42">     smtpServer.username = kUsername;</span>
<a href="#l19.43"></a><span id="l19.43"> </span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-    smtpService.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-                                null, null, null, null,</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-                                false, {}, {});</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+    MailServices.smtp.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+                                      null, null, null, null,</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+                                      false, {}, {});</span>
<a href="#l19.50"></a><span id="l19.50"> </span>
<a href="#l19.51"></a><span id="l19.51">     server.performTest();</span>
<a href="#l19.52"></a><span id="l19.52"> </span>
<a href="#l19.53"></a><span id="l19.53">     var transaction = server.playTransaction();</span>
<a href="#l19.54"></a><span id="l19.54">     do_check_transaction(transaction, [&quot;EHLO test&quot;,</span>
<a href="#l19.55"></a><span id="l19.55">                                        &quot;AUTH PLAIN &quot; + AuthPLAIN.encodeLine(kUsername, kPassword),</span>
<a href="#l19.56"></a><span id="l19.56">                                        &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=155&quot;,</span>
<a href="#l19.57"></a><span id="l19.57">                                        &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPasswordFailure1.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPasswordFailure1.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -5,16 +5,17 @@</span>
<a href="#l20.4"></a><span id="l20.4">  *   - Check we get a prompt asking what to do.</span>
<a href="#l20.5"></a><span id="l20.5">  *   - Check retry does what it should do.</span>
<a href="#l20.6"></a><span id="l20.6">  *   - Check cancel does what it should do.</span>
<a href="#l20.7"></a><span id="l20.7">  *</span>
<a href="#l20.8"></a><span id="l20.8">  * XXX Due to problems with the fakeserver + smtp not using one connection for</span>
<a href="#l20.9"></a><span id="l20.9">  * multiple sends, the rest of this test is in test_smtpPasswordFailure2.js.</span>
<a href="#l20.10"></a><span id="l20.10">  */</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l20.13"></a><span id="l20.13"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l20.14"></a><span id="l20.14"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l20.15"></a><span id="l20.15"> </span>
<a href="#l20.16"></a><span id="l20.16"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l20.17"></a><span id="l20.17"> </span>
<a href="#l20.18"></a><span id="l20.18"> var server;</span>
<a href="#l20.19"></a><span id="l20.19"> var attempt = 0;</span>
<a href="#l20.20"></a><span id="l20.20"> </span>
<a href="#l20.21"></a><span id="l20.21" class="difflineat">@@ -75,37 +76,34 @@ function run_test() {</span>
<a href="#l20.22"></a><span id="l20.22">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l20.23"></a><span id="l20.23"> </span>
<a href="#l20.24"></a><span id="l20.24">   // Ensure we have at least one mail account</span>
<a href="#l20.25"></a><span id="l20.25">   loadLocalMailAccount();</span>
<a href="#l20.26"></a><span id="l20.26"> </span>
<a href="#l20.27"></a><span id="l20.27">   var smtpServer = getBasicSmtpServer();</span>
<a href="#l20.28"></a><span id="l20.28">   var identity = getSmtpIdentity(kSender, smtpServer);</span>
<a href="#l20.29"></a><span id="l20.29"> </span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-  var smtpService = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-                      .getService(Ci.nsISmtpService);</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-</span>
<a href="#l20.33"></a><span id="l20.33">   // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l20.34"></a><span id="l20.34">   // the server if something fails.</span>
<a href="#l20.35"></a><span id="l20.35">   try {</span>
<a href="#l20.36"></a><span id="l20.36">     // Start the fake SMTP server</span>
<a href="#l20.37"></a><span id="l20.37">     server.start(SMTP_PORT);</span>
<a href="#l20.38"></a><span id="l20.38"> </span>
<a href="#l20.39"></a><span id="l20.39">     // This time with auth</span>
<a href="#l20.40"></a><span id="l20.40">     test = &quot;Auth sendMailMessage&quot;;</span>
<a href="#l20.41"></a><span id="l20.41"> </span>
<a href="#l20.42"></a><span id="l20.42">     smtpServer.authMethod = Ci.nsMsgAuthMethod.passwordCleartext;</span>
<a href="#l20.43"></a><span id="l20.43">     smtpServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l20.44"></a><span id="l20.44">     smtpServer.username = kUsername;</span>
<a href="#l20.45"></a><span id="l20.45"> </span>
<a href="#l20.46"></a><span id="l20.46">     dump(&quot;Send\n&quot;);</span>
<a href="#l20.47"></a><span id="l20.47"> </span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-    smtpService.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-                                null, null, null, null,</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-                                false, {}, {});</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+    MailServices.smtp.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+                                      null, null, null, null,</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+                                      false, {}, {});</span>
<a href="#l20.54"></a><span id="l20.54"> </span>
<a href="#l20.55"></a><span id="l20.55">     server.performTest();</span>
<a href="#l20.56"></a><span id="l20.56"> </span>
<a href="#l20.57"></a><span id="l20.57">     dump(&quot;End Send\n&quot;);</span>
<a href="#l20.58"></a><span id="l20.58"> </span>
<a href="#l20.59"></a><span id="l20.59">     do_check_eq(attempt, 2);</span>
<a href="#l20.60"></a><span id="l20.60"> </span>
<a href="#l20.61"></a><span id="l20.61">     // Check that we haven't forgetton the login even though we've retried and</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPasswordFailure2.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPasswordFailure2.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -5,16 +5,17 @@</span>
<a href="#l21.4"></a><span id="l21.4">  *   - Re-initiate connection, this time select enter new password, check that</span>
<a href="#l21.5"></a><span id="l21.5">  *     we get a new password prompt and can enter the password.</span>
<a href="#l21.6"></a><span id="l21.6">  *</span>
<a href="#l21.7"></a><span id="l21.7">  * XXX Due to problems with the fakeserver + smtp not using one connection for</span>
<a href="#l21.8"></a><span id="l21.8">  * multiple sends, the first part of this test is in</span>
<a href="#l21.9"></a><span id="l21.9">  * test_smtpPasswordFailure2.js.</span>
<a href="#l21.10"></a><span id="l21.10">  */</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l21.13"></a><span id="l21.13"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l21.14"></a><span id="l21.14"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l21.15"></a><span id="l21.15"> </span>
<a href="#l21.16"></a><span id="l21.16"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l21.17"></a><span id="l21.17"> </span>
<a href="#l21.18"></a><span id="l21.18"> var server;</span>
<a href="#l21.19"></a><span id="l21.19"> var attempt = 0;</span>
<a href="#l21.20"></a><span id="l21.20"> </span>
<a href="#l21.21"></a><span id="l21.21" class="difflineat">@@ -86,37 +87,34 @@ function run_test() {</span>
<a href="#l21.22"></a><span id="l21.22">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l21.23"></a><span id="l21.23"> </span>
<a href="#l21.24"></a><span id="l21.24">   // Ensure we have at least one mail account</span>
<a href="#l21.25"></a><span id="l21.25">   loadLocalMailAccount();</span>
<a href="#l21.26"></a><span id="l21.26"> </span>
<a href="#l21.27"></a><span id="l21.27">   var smtpServer = getBasicSmtpServer();</span>
<a href="#l21.28"></a><span id="l21.28">   var identity = getSmtpIdentity(kSender, smtpServer);</span>
<a href="#l21.29"></a><span id="l21.29"> </span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-  var smtpService = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-                      .getService(Ci.nsISmtpService);</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-</span>
<a href="#l21.33"></a><span id="l21.33">   // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l21.34"></a><span id="l21.34">   // the server if something fails.</span>
<a href="#l21.35"></a><span id="l21.35">   try {</span>
<a href="#l21.36"></a><span id="l21.36">     // Start the fake SMTP server</span>
<a href="#l21.37"></a><span id="l21.37">     server.start(SMTP_PORT);</span>
<a href="#l21.38"></a><span id="l21.38"> </span>
<a href="#l21.39"></a><span id="l21.39">     // This time with auth</span>
<a href="#l21.40"></a><span id="l21.40">     test = &quot;Auth sendMailMessage&quot;;</span>
<a href="#l21.41"></a><span id="l21.41"> </span>
<a href="#l21.42"></a><span id="l21.42">     smtpServer.authMethod = Ci.nsMsgAuthMethod.passwordCleartext;</span>
<a href="#l21.43"></a><span id="l21.43">     smtpServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l21.44"></a><span id="l21.44">     smtpServer.username = kUsername;</span>
<a href="#l21.45"></a><span id="l21.45"> </span>
<a href="#l21.46"></a><span id="l21.46">     dump(&quot;Send\n&quot;);</span>
<a href="#l21.47"></a><span id="l21.47"> </span>
<a href="#l21.48"></a><span id="l21.48" class="difflineminus">-    smtpService.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineminus">-                                null, null, null, null,</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-                                false, {}, {});</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+    MailServices.smtp.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+                                      null, null, null, null,</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+                                      false, {}, {});</span>
<a href="#l21.54"></a><span id="l21.54"> </span>
<a href="#l21.55"></a><span id="l21.55">     server.performTest();</span>
<a href="#l21.56"></a><span id="l21.56"> </span>
<a href="#l21.57"></a><span id="l21.57">     dump(&quot;End Send\n&quot;);</span>
<a href="#l21.58"></a><span id="l21.58"> </span>
<a href="#l21.59"></a><span id="l21.59">     do_check_eq(attempt, 2);</span>
<a href="#l21.60"></a><span id="l21.60"> </span>
<a href="#l21.61"></a><span id="l21.61">     var transaction = server.playTransaction();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPasswordFailure3.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPasswordFailure3.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -3,16 +3,17 @@</span>
<a href="#l22.4"></a><span id="l22.4">  * when the server drops the connection on an authentication error.</span>
<a href="#l22.5"></a><span id="l22.5">  * The steps are:</span>
<a href="#l22.6"></a><span id="l22.6">  *   - Have an invalid password in the password database.</span>
<a href="#l22.7"></a><span id="l22.7">  *   - Re-initiate connection, this time select enter new password, check that</span>
<a href="#l22.8"></a><span id="l22.8">  *     we get a new password prompt and can enter the password.</span>
<a href="#l22.9"></a><span id="l22.9">  *</span>
<a href="#l22.10"></a><span id="l22.10">  */</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l22.13"></a><span id="l22.13"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l22.14"></a><span id="l22.14"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l22.15"></a><span id="l22.15"> </span>
<a href="#l22.16"></a><span id="l22.16"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l22.17"></a><span id="l22.17"> </span>
<a href="#l22.18"></a><span id="l22.18"> var server;</span>
<a href="#l22.19"></a><span id="l22.19"> var attempt = 0;</span>
<a href="#l22.20"></a><span id="l22.20"> </span>
<a href="#l22.21"></a><span id="l22.21" class="difflineat">@@ -100,19 +101,19 @@ function run_test() {</span>
<a href="#l22.22"></a><span id="l22.22">   test = &quot;Auth sendMailMessage&quot;;</span>
<a href="#l22.23"></a><span id="l22.23"> </span>
<a href="#l22.24"></a><span id="l22.24">   smtpServer.authMethod = Ci.nsMsgAuthMethod.passwordCleartext;</span>
<a href="#l22.25"></a><span id="l22.25">   smtpServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l22.26"></a><span id="l22.26">   smtpServer.username = kUsername;</span>
<a href="#l22.27"></a><span id="l22.27"> </span>
<a href="#l22.28"></a><span id="l22.28">   do_test_pending();</span>
<a href="#l22.29"></a><span id="l22.29"> </span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-  smtpService.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-                              null, URLListener, null, null,</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-                              false, {}, {});</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+  MailServices.smtp.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+                                    null, URLListener, null, null,</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+                                    false, {}, {});</span>
<a href="#l22.36"></a><span id="l22.36"> </span>
<a href="#l22.37"></a><span id="l22.37">   server.performTest();</span>
<a href="#l22.38"></a><span id="l22.38"> }</span>
<a href="#l22.39"></a><span id="l22.39"> </span>
<a href="#l22.40"></a><span id="l22.40"> var URLListener = {</span>
<a href="#l22.41"></a><span id="l22.41">   OnStartRunningUrl: function(url) { },</span>
<a href="#l22.42"></a><span id="l22.42">   OnStopRunningUrl: function(url, rc)</span>
<a href="#l22.43"></a><span id="l22.43">   {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

