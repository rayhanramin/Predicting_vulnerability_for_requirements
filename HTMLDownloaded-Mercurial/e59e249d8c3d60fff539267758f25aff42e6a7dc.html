<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 4646:e59e249d8c3d60fff539267758f25aff42e6a7dc</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ e59e249d8c3d60fff539267758f25aff42e6a7dc" />
<meta property="og:url" content="/comm-central/rev/e59e249d8c3d60fff539267758f25aff42e6a7dc" />
<meta property="og:description" content="fix bug 534382, tb 2 profiles with multiple local folder accounts get one of them turned into smart mailboxes, which messes up pop3 download, remove code that cause problem, and fix deferral to point back to local folders, r=bwinton, sr=standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / e59e249d8c3d60fff539267758f25aff42e6a7dc 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/e59e249d8c3d60fff539267758f25aff42e6a7dc">shortlog</a> |
<a href="/comm-central/log/e59e249d8c3d60fff539267758f25aff42e6a7dc">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/e59e249d8c3d60fff539267758f25aff42e6a7dc">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/e59e249d8c3d60fff539267758f25aff42e6a7dc">files</a> |
changeset |
<a href="/comm-central/raw-rev/e59e249d8c3d60fff539267758f25aff42e6a7dc">raw</a>  | <a href="/comm-central/archive/e59e249d8c3d60fff539267758f25aff42e6a7dc.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=534382">bug 534382</a>, tb 2 profiles with multiple local folder accounts get one of them turned into smart mailboxes, which messes up pop3 download, remove code that cause problem, and fix deferral to point back to local folders, r=bwinton, sr=standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 07 Jan 2010 09:52:13 -0800</td></tr>

<tr>
 <td>changeset 4646</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/e59e249d8c3d60fff539267758f25aff42e6a7dc">e59e249d8c3d60fff539267758f25aff42e6a7dc</a></td>
</tr>



<tr>
<td>parent 4645</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/15b39d7bf60ca0cee095c6192c00e8853d7b9717">15b39d7bf60ca0cee095c6192c00e8853d7b9717</a>
</td>
</tr>

<tr>
<td>child 4647</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/230392d2cf93738969e5466756e899939e7d12ba">230392d2cf93738969e5466756e899939e7d12ba</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=e59e249d8c3d60fff539267758f25aff42e6a7dc">3631</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 07 Jan 2010 17:52:17 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@e59e249d8c3d [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e59e249d8c3d60fff539267758f25aff42e6a7dc">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e59e249d8c3d60fff539267758f25aff42e6a7dc&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e59e249d8c3d60fff539267758f25aff42e6a7dc&newProject=comm-central&newRevision=e59e249d8c3d60fff539267758f25aff42e6a7dc&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e59e249d8c3d60fff539267758f25aff42e6a7dc&newProject=comm-central&newRevision=e59e249d8c3d60fff539267758f25aff42e6a7dc&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e59e249d8c3d60fff539267758f25aff42e6a7dc&newProject=comm-central&newRevision=e59e249d8c3d60fff539267758f25aff42e6a7dc&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bwinton%29&revcount=50">bwinton</a>, <a href="/comm-central/log?rev=reviewer%28standard8%29&revcount=50">standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=534382">534382</a></td></tr>




</table></div>

<div class="page_body description">fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=534382">bug 534382</a>, tb 2 profiles with multiple local folder accounts get one of them turned into smart mailboxes, which messes up pop3 download, remove code that cause problem, and fix deferral to point back to local folders, r=bwinton, sr=standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e59e249d8c3d60fff539267758f25aff42e6a7dc/mailnews/base/src/nsMsgAccountManager.cpp">mailnews/base/src/nsMsgAccountManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e59e249d8c3d60fff539267758f25aff42e6a7dc/mailnews/base/src/nsMsgAccountManager.cpp">file</a> |
<a href="/comm-central/annotate/e59e249d8c3d60fff539267758f25aff42e6a7dc/mailnews/base/src/nsMsgAccountManager.cpp">annotate</a> |
<a href="/comm-central/diff/e59e249d8c3d60fff539267758f25aff42e6a7dc/mailnews/base/src/nsMsgAccountManager.cpp">diff</a> |
<a href="/comm-central/comparison/e59e249d8c3d60fff539267758f25aff42e6a7dc/mailnews/base/src/nsMsgAccountManager.cpp">comparison</a> |
<a href="/comm-central/log/e59e249d8c3d60fff539267758f25aff42e6a7dc/mailnews/base/src/nsMsgAccountManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e59e249d8c3d60fff539267758f25aff42e6a7dc/mailnews/base/test/unit/test_fix_deferred_accounts.js">mailnews/base/test/unit/test_fix_deferred_accounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e59e249d8c3d60fff539267758f25aff42e6a7dc/mailnews/base/test/unit/test_fix_deferred_accounts.js">file</a> |
<a href="/comm-central/annotate/e59e249d8c3d60fff539267758f25aff42e6a7dc/mailnews/base/test/unit/test_fix_deferred_accounts.js">annotate</a> |
<a href="/comm-central/diff/e59e249d8c3d60fff539267758f25aff42e6a7dc/mailnews/base/test/unit/test_fix_deferred_accounts.js">diff</a> |
<a href="/comm-central/comparison/e59e249d8c3d60fff539267758f25aff42e6a7dc/mailnews/base/test/unit/test_fix_deferred_accounts.js">comparison</a> |
<a href="/comm-central/log/e59e249d8c3d60fff539267758f25aff42e6a7dc/mailnews/base/test/unit/test_fix_deferred_accounts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e59e249d8c3d60fff539267758f25aff42e6a7dc/mailnews/local/src/nsPop3IncomingServer.cpp">mailnews/local/src/nsPop3IncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e59e249d8c3d60fff539267758f25aff42e6a7dc/mailnews/local/src/nsPop3IncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/e59e249d8c3d60fff539267758f25aff42e6a7dc/mailnews/local/src/nsPop3IncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/e59e249d8c3d60fff539267758f25aff42e6a7dc/mailnews/local/src/nsPop3IncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/e59e249d8c3d60fff539267758f25aff42e6a7dc/mailnews/local/src/nsPop3IncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/e59e249d8c3d60fff539267758f25aff42e6a7dc/mailnews/local/src/nsPop3IncomingServer.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1354,19 +1354,16 @@ nsMsgAccountManager::LoadAccounts()</span>
<a href="#l1.4"></a><span id="l1.4">     }</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">     // force load of accounts (need to find a better way to do this)</span>
<a href="#l1.7"></a><span id="l1.7">     nsCOMPtr&lt;nsISupportsArray&gt; identities;</span>
<a href="#l1.8"></a><span id="l1.8">     account-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.11"></a><span id="l1.11">     account-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    // if no server, we should get rid of the account.</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-    if (!server)</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-      RemoveAccount(account);</span>
<a href="#l1.15"></a><span id="l1.15">   }</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17">   nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19">   if (NS_SUCCEEDED(rv))</span>
<a href="#l1.20"></a><span id="l1.20">     mailSession-&gt;AddFolderListener(this, nsIFolderListener::added | nsIFolderListener::removed);</span>
<a href="#l1.21"></a><span id="l1.21">   return NS_OK;</span>
<a href="#l1.22"></a><span id="l1.22"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mailnews/base/test/unit/test_fix_deferred_accounts.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,83 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+ *</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+ *</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+ * License.</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+ *</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+ *</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+ * David Bienvenu&lt;bienvenu@mozillamessaging.com&gt;.</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+ *</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+ *</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+ *</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+/**</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+ * This tests that we cleanup the account prefs when a pop3 account has</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+ * been deferred to a hidden account.</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+ */</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+const am = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+                     .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+const prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+                        .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+function run_test()</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+{</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+  // Create account prefs with a pop3 account deferred to a hidden account.</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+  prefs.setCharPref(&quot;mail.account.account1.identities&quot;, &quot;id1&quot;);</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+  prefs.setCharPref(&quot;mail.account.account1.server&quot;, &quot;server1&quot;);</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+  prefs.setCharPref(&quot;mail.account.account2.server&quot;, &quot;server2&quot;);</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+  prefs.setCharPref(&quot;mail.account.account4.identities&quot;, &quot;id2&quot;);</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+  prefs.setCharPref(&quot;mail.account.account4.server&quot;, &quot;server4&quot;);</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+  prefs.setCharPref(&quot;mail.account.account5.identities&quot;, &quot;id3&quot;);</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+  prefs.setCharPref(&quot;mail.account.account5.server&quot;, &quot;server5&quot;);</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+  prefs.setCharPref(&quot;mail.server.server1.hostname&quot;, &quot;Local Folders&quot;);</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+  prefs.setCharPref(&quot;mail.server.server1.type&quot;, &quot;none&quot;);</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+  prefs.setCharPref(&quot;mail.server.server2.hostname&quot;, &quot;Smart Mailboxes&quot;);</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+  prefs.setCharPref(&quot;mail.server.server2.type&quot;, &quot;none&quot;);</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+  prefs.setBoolPref(&quot;mail.server.server2.hidden&quot;, true);</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+  prefs.setCharPref(&quot;mail.server.server4.hostname&quot;, &quot;mail.host4.org&quot;);</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+  prefs.setCharPref(&quot;mail.server.server4.type&quot;, &quot;pop3&quot;);</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  prefs.setCharPref(&quot;mail.server.server4.deferred_to_account&quot;, &quot;account2&quot;);</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+  prefs.setCharPref(&quot;mail.server.server5.hostname&quot;, &quot;mail.host5.org&quot;);</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+  prefs.setCharPref(&quot;mail.server.server5.type&quot;, &quot;pop3&quot;);</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+  prefs.setCharPref(&quot;mail.server.server5.deferred_to_account&quot;, &quot;account2&quot;);</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+  prefs.setCharPref(&quot;mail.accountmanager.accounts&quot;, &quot;account1,account2,account4,account5&quot;);</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+  // Set the default account to one we're going to get rid of. The account manager</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+  // should recover relatively gracefully.</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+  prefs.setCharPref(&quot;mail.accountmanager.defaultaccount&quot;, &quot;account1&quot;);</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+  // This will force the load of the accounts setup above.</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+  do_check_eq(am.accounts.Count(), 3); // hidden account not included</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+  let server4 = am.getAccount(&quot;account4&quot;).incomingServer</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+                  .QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+  do_check_eq(server4.deferredToAccount, &quot;account1&quot;);</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+  let server5 = am.getAccount(&quot;account5&quot;).incomingServer</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+                  .QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+  do_check_eq(server5.deferredToAccount, &quot;account1&quot;);</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/local/src/nsPop3IncomingServer.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3IncomingServer.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -128,17 +128,51 @@ NS_IMPL_SERVERPREF_INT(nsPop3IncomingSer</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> NS_IMPL_SERVERPREF_BOOL(nsPop3IncomingServer,</span>
<a href="#l3.7"></a><span id="l3.7">                             DeferGetNewMail,</span>
<a href="#l3.8"></a><span id="l3.8">                             &quot;defer_get_new_mail&quot;)</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> NS_IMETHODIMP nsPop3IncomingServer::GetDeferredToAccount(nsACString&amp; aRetVal)</span>
<a href="#l3.11"></a><span id="l3.11"> {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  return GetCharValue(&quot;deferred_to_account&quot;, aRetVal);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  nsresult rv = GetCharValue(&quot;deferred_to_account&quot;, aRetVal);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  if (aRetVal.IsEmpty())</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+    return rv;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  // We need to repair broken profiles that defer to hidden or invalid servers,</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+  // so find out if the deferred to account has a valid non-hidden server, and</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+  // if not, defer to the local folders inbox.</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; acctMgr =</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+                      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID);</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+  PRBool invalidAccount = PR_TRUE;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+  if (acctMgr)</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+  {</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+    rv = acctMgr-&gt;GetAccount(aRetVal, getter_AddRefs(account));</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+    if (account)</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+    {</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+      account-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+      if (server)</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+        server-&gt;GetHidden(&amp;invalidAccount);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+    }</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+    if (invalidAccount)</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+    {</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; localServer;</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+      nsCOMPtr&lt;nsIMsgAccount&gt; localAccount;</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+      rv = acctMgr-&gt;GetLocalFoldersServer(getter_AddRefs(localServer));</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+      rv = acctMgr-&gt;FindAccountForServer(localServer, getter_AddRefs(localAccount));</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+      localAccount-&gt;GetKey(aRetVal);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+      // Can't call SetDeferredToAccount because it calls GetDeferredToAccount.</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+      return SetCharValue(&quot;deferred_to_account&quot;, aRetVal);</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+    }</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+  }</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+  return rv;</span>
<a href="#l3.48"></a><span id="l3.48"> }</span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50"> NS_IMETHODIMP nsPop3IncomingServer::SetDeferredToAccount(const nsACString&amp; aAccountKey)</span>
<a href="#l3.51"></a><span id="l3.51"> {</span>
<a href="#l3.52"></a><span id="l3.52">   nsCString deferredToAccount;</span>
<a href="#l3.53"></a><span id="l3.53">   GetDeferredToAccount(deferredToAccount);</span>
<a href="#l3.54"></a><span id="l3.54">   m_rootMsgFolder = nsnull; // clear this so we'll recalculate it on demand.</span>
<a href="#l3.55"></a><span id="l3.55">   //Notify listeners who listen to every folder</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

