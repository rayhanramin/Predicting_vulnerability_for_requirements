<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 6897:600b8c098a8263cee93d5d4895352c5f2de21991</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 600b8c098a8263cee93d5d4895352c5f2de21991" />
<meta property="og:url" content="/comm-central/rev/600b8c098a8263cee93d5d4895352c5f2de21991" />
<meta property="og:description" content="Bug 444093 - Implement nsIAbCard::uuid r/sr=Standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 600b8c098a8263cee93d5d4895352c5f2de21991 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/600b8c098a8263cee93d5d4895352c5f2de21991">shortlog</a> |
<a href="/comm-central/log/600b8c098a8263cee93d5d4895352c5f2de21991">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/600b8c098a8263cee93d5d4895352c5f2de21991">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/600b8c098a8263cee93d5d4895352c5f2de21991">files</a> |
changeset |
<a href="/comm-central/raw-rev/600b8c098a8263cee93d5d4895352c5f2de21991">raw</a>  | <a href="/comm-central/archive/600b8c098a8263cee93d5d4895352c5f2de21991.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=444093">Bug 444093</a> - Implement nsIAbCard::uuid r/sr=Standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#115;&#104;&#117;&#97;&#32;&#67;&#114;&#97;&#110;&#109;&#101;&#114;&#32;&#60;&#80;&#105;&#100;&#103;&#101;&#111;&#116;&#49;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 29 Dec 2010 16:12:15 -0500</td></tr>

<tr>
 <td>changeset 6897</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/600b8c098a8263cee93d5d4895352c5f2de21991">600b8c098a8263cee93d5d4895352c5f2de21991</a></td>
</tr>



<tr>
<td>parent 6896</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7a4f9fdc7a74fb003e231d05929a4b3f59fce9f9">7a4f9fdc7a74fb003e231d05929a4b3f59fce9f9</a>
</td>
</tr>

<tr>
<td>child 6898</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/20c8cf16fd91b66f8798f456a50f5a6933f17ca5">20c8cf16fd91b66f8798f456a50f5a6933f17ca5</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=600b8c098a8263cee93d5d4895352c5f2de21991">5286</a></td></tr>
<tr><td>push user</td><td>Pidgeot18@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 03 Jan 2011 22:17:14 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@600b8c098a82 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=600b8c098a8263cee93d5d4895352c5f2de21991">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=600b8c098a8263cee93d5d4895352c5f2de21991&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=600b8c098a8263cee93d5d4895352c5f2de21991&newProject=comm-central&newRevision=600b8c098a8263cee93d5d4895352c5f2de21991&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=600b8c098a8263cee93d5d4895352c5f2de21991&newProject=comm-central&newRevision=600b8c098a8263cee93d5d4895352c5f2de21991&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=600b8c098a8263cee93d5d4895352c5f2de21991&newProject=comm-central&newRevision=600b8c098a8263cee93d5d4895352c5f2de21991&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=444093">444093</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=444093">Bug 444093</a> - Implement nsIAbCard::uuid r/sr=Standard8

This essentially completes the original address book card refactoring, excluding
the inconsistent implementations of nsIAbCard::equals.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbCard.idl">mailnews/addrbook/public/nsIAbCard.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbCard.idl">file</a> |
<a href="/comm-central/annotate/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbCard.idl">annotate</a> |
<a href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbCard.idl">diff</a> |
<a href="/comm-central/comparison/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbCard.idl">comparison</a> |
<a href="/comm-central/log/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbCard.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbDirectory.idl">mailnews/addrbook/public/nsIAbDirectory.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbDirectory.idl">file</a> |
<a href="/comm-central/annotate/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbDirectory.idl">annotate</a> |
<a href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbDirectory.idl">diff</a> |
<a href="/comm-central/comparison/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbDirectory.idl">comparison</a> |
<a href="/comm-central/log/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbDirectory.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbItem.idl">mailnews/addrbook/public/nsIAbItem.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbItem.idl">file</a> |
<a href="/comm-central/annotate/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbItem.idl">annotate</a> |
<a href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbItem.idl">diff</a> |
<a href="/comm-central/comparison/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbItem.idl">comparison</a> |
<a href="/comm-central/log/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbItem.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbManager.idl">mailnews/addrbook/public/nsIAbManager.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbManager.idl">file</a> |
<a href="/comm-central/annotate/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbManager.idl">annotate</a> |
<a href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbManager.idl">diff</a> |
<a href="/comm-central/comparison/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbManager.idl">comparison</a> |
<a href="/comm-central/log/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/public/nsIAbManager.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbCardProperty.cpp">mailnews/addrbook/src/nsAbCardProperty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbCardProperty.cpp">file</a> |
<a href="/comm-central/annotate/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbCardProperty.cpp">annotate</a> |
<a href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbCardProperty.cpp">diff</a> |
<a href="/comm-central/comparison/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbCardProperty.cpp">comparison</a> |
<a href="/comm-central/log/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbCardProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbCardProperty.h">mailnews/addrbook/src/nsAbCardProperty.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbCardProperty.h">file</a> |
<a href="/comm-central/annotate/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbCardProperty.h">annotate</a> |
<a href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbCardProperty.h">diff</a> |
<a href="/comm-central/comparison/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbCardProperty.h">comparison</a> |
<a href="/comm-central/log/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbCardProperty.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbDirProperty.cpp">mailnews/addrbook/src/nsAbDirProperty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbDirProperty.cpp">file</a> |
<a href="/comm-central/annotate/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbDirProperty.cpp">annotate</a> |
<a href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbDirProperty.cpp">diff</a> |
<a href="/comm-central/comparison/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbDirProperty.cpp">comparison</a> |
<a href="/comm-central/log/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbDirProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPCard.cpp">mailnews/addrbook/src/nsAbLDAPCard.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPCard.cpp">file</a> |
<a href="/comm-central/annotate/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPCard.cpp">annotate</a> |
<a href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPCard.cpp">diff</a> |
<a href="/comm-central/comparison/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPCard.cpp">comparison</a> |
<a href="/comm-central/log/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPCard.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">mailnews/addrbook/src/nsAbLDAPDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">file</a> |
<a href="/comm-central/annotate/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">comparison</a> |
<a href="/comm-central/log/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">file</a> |
<a href="/comm-central/annotate/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">annotate</a> |
<a href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">diff</a> |
<a href="/comm-central/comparison/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">comparison</a> |
<a href="/comm-central/log/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.h">mailnews/addrbook/src/nsAbLDAPDirectoryQuery.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.h">file</a> |
<a href="/comm-central/annotate/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.h">annotate</a> |
<a href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.h">diff</a> |
<a href="/comm-central/comparison/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.h">comparison</a> |
<a href="/comm-central/log/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbManager.cpp">mailnews/addrbook/src/nsAbManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbManager.cpp">file</a> |
<a href="/comm-central/annotate/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbManager.cpp">annotate</a> |
<a href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbManager.cpp">diff</a> |
<a href="/comm-central/comparison/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbManager.cpp">comparison</a> |
<a href="/comm-central/log/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbOSXCard.mm">mailnews/addrbook/src/nsAbOSXCard.mm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbOSXCard.mm">file</a> |
<a href="/comm-central/annotate/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbOSXCard.mm">annotate</a> |
<a href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbOSXCard.mm">diff</a> |
<a href="/comm-central/comparison/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbOSXCard.mm">comparison</a> |
<a href="/comm-central/log/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbOSXCard.mm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbOSXDirectory.mm">mailnews/addrbook/src/nsAbOSXDirectory.mm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbOSXDirectory.mm">file</a> |
<a href="/comm-central/annotate/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbOSXDirectory.mm">annotate</a> |
<a href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbOSXDirectory.mm">diff</a> |
<a href="/comm-central/comparison/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbOSXDirectory.mm">comparison</a> |
<a href="/comm-central/log/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbOSXDirectory.mm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">mailnews/addrbook/src/nsAbOutlookDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">file</a> |
<a href="/comm-central/annotate/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">comparison</a> |
<a href="/comm-central/log/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAbOutlookDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAddrDatabase.cpp">mailnews/addrbook/src/nsAddrDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAddrDatabase.cpp">file</a> |
<a href="/comm-central/annotate/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAddrDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAddrDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAddrDatabase.cpp">comparison</a> |
<a href="/comm-central/log/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/src/nsAddrDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/test/unit/test_uuid.js">mailnews/addrbook/test/unit/test_uuid.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/test/unit/test_uuid.js">file</a> |
<a href="/comm-central/annotate/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/test/unit/test_uuid.js">annotate</a> |
<a href="/comm-central/diff/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/test/unit/test_uuid.js">diff</a> |
<a href="/comm-central/comparison/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/test/unit/test_uuid.js">comparison</a> |
<a href="/comm-central/log/600b8c098a8263cee93d5d4895352c5f2de21991/mailnews/addrbook/test/unit/test_uuid.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbCard.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbCard.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -48,17 +48,25 @@ interface nsIAbPreferMailFormat {</span>
<a href="#l1.4"></a><span id="l1.4">     const unsigned long unknown   = 0;</span>
<a href="#l1.5"></a><span id="l1.5">     const unsigned long plaintext = 1;</span>
<a href="#l1.6"></a><span id="l1.6">     const unsigned long html      = 2;</span>
<a href="#l1.7"></a><span id="l1.7"> };</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> /**</span>
<a href="#l1.10"></a><span id="l1.10">  * An interface representing an address book card.</span>
<a href="#l1.11"></a><span id="l1.11">  *</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">- * Fundamentally, it is a collection of properties. Modifying a property in</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+ * The UUID of a card is a composition of a directory ID and a per-directory ID.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+ * The per-directory ID is reflected in the localId property. If either of these</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+ * properties change, the UUID will change correspondingly.</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+ *</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+ * None of these IDs will be reflected in the property collection. Neither</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+ * nsIAbCard::properties, nsIAbCard::deleteProperty, nor any of the property</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+ * getters and setters are able to interact with these properties.</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+ *</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+ * Fundamentally, a card is a collection of properties. Modifying a property in</span>
<a href="#l1.22"></a><span id="l1.22">  * some way on a card does not change the backend used to store the card; the</span>
<a href="#l1.23"></a><span id="l1.23">  * directory is required to do make the changes here.</span>
<a href="#l1.24"></a><span id="l1.24">  *</span>
<a href="#l1.25"></a><span id="l1.25">  * The following are the core properties that are used:</span>
<a href="#l1.26"></a><span id="l1.26">  * - Names:</span>
<a href="#l1.27"></a><span id="l1.27">  *   - FirstName, LastName</span>
<a href="#l1.28"></a><span id="l1.28">  *   - PhoneticFirstName, PhoneticLastName</span>
<a href="#l1.29"></a><span id="l1.29">  *   - DisplayName, NickName</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineat">@@ -85,20 +93,65 @@ interface nsIAbPreferMailFormat {</span>
<a href="#l1.31"></a><span id="l1.31">  *   - PopularityIndex</span>
<a href="#l1.32"></a><span id="l1.32">  *   - PreferMailFormat (see nsIAbPreferMailFormat)</span>
<a href="#l1.33"></a><span id="l1.33">  * - Boolean properties:</span>
<a href="#l1.34"></a><span id="l1.34">  *   - AllowRemoteContent</span>
<a href="#l1.35"></a><span id="l1.35">  * - Photo properties:</span>
<a href="#l1.36"></a><span id="l1.36">  *   - PhotoName</span>
<a href="#l1.37"></a><span id="l1.37">  *   - PhotoType</span>
<a href="#l1.38"></a><span id="l1.38">  *   - PhotoURI</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+ *</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+ * The contract id for the standard implementation is</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+ * &lt;tt&gt;\@mozilla.org/addressbook/cardproperty;1&lt;/tt&gt;.</span>
<a href="#l1.42"></a><span id="l1.42">  */</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-[scriptable, uuid(fdac4023-cd19-4e75-9a88-8e48881076ea)]</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+[scriptable, uuid(21c4308b-e1e2-4ab2-abdc-e1f4431c7055)]</span>
<a href="#l1.45"></a><span id="l1.45"> interface nsIAbCard : nsIAbItem {</span>
<a href="#l1.46"></a><span id="l1.46">   /**</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+   * The UUID for the nsIAbDirectory containing this card.</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+   *</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+   * The directory considered to contain this card is the directory which</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+   * produced this card (e.g., through nsIAbDirectory::getCardForProperty) or</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+   * the last directory to modify this card, if another directory did so. If the</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+   * last directory to modify this card deleted it, then this card is considered</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+   * unassociated.</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+   *</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+   * If this card is not associated with a directory, this string will be empty.</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+   *</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+   * There is no standardized way to associate a card with multiple directories.</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+   *</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+   * Consumers of this interface outside of directory implementations SHOULD</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+   * NOT, in general, modify this property.</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+   */</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+  attribute AUTF8String directoryId;</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+  /**</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+   * The per-directory ID of this card.</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+   *</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+   * This property is the second part of the tuple logically representing a card</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+   * UUID. It shares many requirements with that of nsIAbItem::uuid. In</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+   * particular:</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+   * - It MUST be unique (within the scope of its directory).</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+   * - The empty string MUST only be used to indicate that it has not yet been</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+   *   assigned a localId.</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+   * - It is STRONGLY RECOMMENDED that this id is consistent across sessions and</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+   *   that, should the card be deleted, its ids will not be reused.</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+   * - The format of localId is left undefined.</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+   *</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+   * As long as directoryId is not changed, this property SHOULD NOT be changed.</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+   * If directoryId is changed, the new directory MAY choose to reuse the same</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+   * localId if reasonable. However, consumers MUST NOT assume that two cards</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+   * with different directoryIds but the same localId are logically the same</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+   * card.</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+   *</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+   * Similar to directoryId, consumers of cards outside of directory</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+   * implementations SHOULD NOT, in general, modify this property.</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+   */</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+  attribute AUTF8String localId;</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+  /**</span>
<a href="#l1.89"></a><span id="l1.89">    * A list of all the properties that this card has as an enumerator, whose</span>
<a href="#l1.90"></a><span id="l1.90">    * members are all nsIProperty objects.</span>
<a href="#l1.91"></a><span id="l1.91">    */</span>
<a href="#l1.92"></a><span id="l1.92">   readonly attribute nsISimpleEnumerator properties;</span>
<a href="#l1.93"></a><span id="l1.93"> </span>
<a href="#l1.94"></a><span id="l1.94">   /**</span>
<a href="#l1.95"></a><span id="l1.95">    * Returns a property for the given name.</span>
<a href="#l1.96"></a><span id="l1.96">    *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbDirectory.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbDirectory.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -55,16 +55,22 @@ interface nsIMutableArray;</span>
<a href="#l2.4"></a><span id="l2.4"> #define kCollectedAddressbook      &quot;history.mab&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> #define kCollectedAddressbookUri   &quot;moz-abmdbdirectory://history.mab&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> #define kABFileName_PreviousSuffix &quot;.na2&quot; /* final v2 address book format */</span>
<a href="#l2.8"></a><span id="l2.8"> #define kABFileName_PreviousSuffixLen 4</span>
<a href="#l2.9"></a><span id="l2.9"> #define kABFileName_CurrentSuffix &quot;.mab&quot;  /* v3 address book extension */</span>
<a href="#l2.10"></a><span id="l2.10"> %}</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+/**</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ * A top-level address book directory.</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+ *</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+ * The UUID of an nsIAbDirectory is its preference ID and its name, concatenated</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+ * together.</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+ */</span>
<a href="#l2.18"></a><span id="l2.18"> [scriptable, uuid(0ef8d12d-f553-4a28-85b5-c838aff34ab1)]</span>
<a href="#l2.19"></a><span id="l2.19"> interface nsIAbDirectory : nsIAbCollection {</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21">   /**</span>
<a href="#l2.22"></a><span id="l2.22">    * The chrome URI to use for bringing up a dialog to edit this directory.</span>
<a href="#l2.23"></a><span id="l2.23">    * When opening the dialog, use a JS argument of</span>
<a href="#l2.24"></a><span id="l2.24">    * {selectedDirectory: thisdir} where thisdir is this directory that you just</span>
<a href="#l2.25"></a><span id="l2.25">    * got the chrome URI from.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbItem.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbItem.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -40,19 +40,36 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> interface nsIMsgHeaderParser;</span>
<a href="#l3.7"></a><span id="l3.7"> interface nsIStringBundle;</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> /**</span>
<a href="#l3.10"></a><span id="l3.10">  * A containable item for address books.</span>
<a href="#l3.11"></a><span id="l3.11">  */</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-[scriptable, uuid(f7320616-3139-419b-a7c3-37441da3caf3)]</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+[scriptable, uuid(bb691a55-cbfe-4cf8-974a-e18cfa845a73)]</span>
<a href="#l3.14"></a><span id="l3.14"> interface nsIAbItem : nsISupports {</span>
<a href="#l3.15"></a><span id="l3.15">   /**</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+   * A universally-unique identifier for this item.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+   *</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+   * If this item cannot be associated with a UUID for some reason, it MUST</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+   * return the empty string. The empty string MUST NOT be a valid UUID for any</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+   * item. Under no circumstances may this function throw an error.</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+   *</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+   * It is STRONGLY RECOMMENDED that implementations guarantee that this UUID</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+   * will not change between two different sessions of the application and that,</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+   * if this item is deleted, the UUID will not be reused.</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+   *</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+   * The format of the UUID for a generic nsIAbItem is purposefully left</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+   * undefined, although any item contained by an nsIAbDirectory SHOULD use</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+   * nsIAbManager::generateUUID to generate the UUID.</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+   */</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  readonly attribute AUTF8String uuid;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  /**</span>
<a href="#l3.33"></a><span id="l3.33">    * @{</span>
<a href="#l3.34"></a><span id="l3.34">    * These constants reflect the possible values of the</span>
<a href="#l3.35"></a><span id="l3.35">    * mail.addr_book.lastnamefirst preferences. They are intended to be used in</span>
<a href="#l3.36"></a><span id="l3.36">    * generateName, defined below.</span>
<a href="#l3.37"></a><span id="l3.37">    */</span>
<a href="#l3.38"></a><span id="l3.38">    const unsigned long GENERATE_DISPLAY_NAME = 0;</span>
<a href="#l3.39"></a><span id="l3.39">    const unsigned long GENERATE_LAST_FIRST_ORDER = 1;</span>
<a href="#l3.40"></a><span id="l3.40">    const unsigned long GENERATE_FIRST_LAST_ORDER = 2;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbManager.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbManager.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -48,17 +48,17 @@ interface nsISimpleEnumerator;</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> /**</span>
<a href="#l4.6"></a><span id="l4.6">  * nsIAbManager is an interface to the main address book mananger</span>
<a href="#l4.7"></a><span id="l4.7">  * via the contract id &quot;@mozilla.org/abmanager;1&quot;</span>
<a href="#l4.8"></a><span id="l4.8">  *</span>
<a href="#l4.9"></a><span id="l4.9">  * It contains the main functions to create and delete address books as well</span>
<a href="#l4.10"></a><span id="l4.10">  * as some helper functions.</span>
<a href="#l4.11"></a><span id="l4.11">  */</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-[scriptable, uuid(3b869b86-c4df-4cae-8dc9-c18073d2593f)]</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+[scriptable, uuid(549bf1f6-ada4-40c5-9f59-4ea9eda4a935)]</span>
<a href="#l4.14"></a><span id="l4.14"> interface nsIAbManager : nsISupports </span>
<a href="#l4.15"></a><span id="l4.15"> {</span>
<a href="#l4.16"></a><span id="l4.16">   /**</span>
<a href="#l4.17"></a><span id="l4.17">    * Returns an enumerator containing all the top-level directories</span>
<a href="#l4.18"></a><span id="l4.18">    * (non-recursive)</span>
<a href="#l4.19"></a><span id="l4.19">    */</span>
<a href="#l4.20"></a><span id="l4.20">   readonly attribute nsISimpleEnumerator directories;</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -184,9 +184,21 @@ interface nsIAbManager : nsISupports</span>
<a href="#l4.23"></a><span id="l4.23">   /**</span>
<a href="#l4.24"></a><span id="l4.24">    * Translates an escaped vcard string into a nsIAbCard.</span>
<a href="#l4.25"></a><span id="l4.25">    *</span>
<a href="#l4.26"></a><span id="l4.26">    * @param  escapedVCardStr  The string containing the vcard.</span>
<a href="#l4.27"></a><span id="l4.27">    *</span>
<a href="#l4.28"></a><span id="l4.28">    * @return            A card containing the translated vcard data.</span>
<a href="#l4.29"></a><span id="l4.29">    */</span>
<a href="#l4.30"></a><span id="l4.30">   nsIAbCard escapedVCardToAbCard(in string escapedVCardStr);</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+  /**</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+   * Generates a UUID from a (directory ID, local ID) tuple.</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+   *</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+   * Use of this method is preferred in such cases, since it is designed to work</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+   * with other methods of this interface.</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+   *</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+   * @param directoryId The directory ID.</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+   * @param localId     The per-directory ID.</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+   * @return            A string to use for the UUID.</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+   */</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+  AUTF8String generateUUID(in AUTF8String directoryId, in AUTF8String localId);</span>
<a href="#l4.43"></a><span id="l4.43"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbCardProperty.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbCardProperty.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -53,16 +53,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsINetUtil.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsMemory.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsVCardObj.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;mozITXTToHTMLConv.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+#include &quot;nsIAbManager.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13"> </span>
<a href="#l5.14"></a><span id="l5.14"> #include &quot;nsIProperty.h&quot;</span>
<a href="#l5.15"></a><span id="l5.15"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l5.16"></a><span id="l5.16"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l5.17"></a><span id="l5.17"> #include &quot;prmem.h&quot;</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19"> #define PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST &quot;mail.addr_book.lastnamefirst&quot;</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -135,17 +136,57 @@ nsAbCardProperty::nsAbCardProperty()</span>
<a href="#l5.22"></a><span id="l5.22">   SetPropertyAsUint32(kLastModifiedDateProperty, 0);</span>
<a href="#l5.23"></a><span id="l5.23">   SetPropertyAsBool(kAllowRemoteContentProperty, PR_FALSE);</span>
<a href="#l5.24"></a><span id="l5.24"> }</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26"> nsAbCardProperty::~nsAbCardProperty(void)</span>
<a href="#l5.27"></a><span id="l5.27"> {</span>
<a href="#l5.28"></a><span id="l5.28"> }</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-NS_IMPL_ISUPPORTS1(nsAbCardProperty, nsIAbCard)</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+NS_IMPL_ISUPPORTS2(nsAbCardProperty, nsIAbCard, nsIAbItem)</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetUuid(nsACString &amp;uuid)</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+{</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+  // If we have indeterminate sub-ids, return an empty uuid.</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+  if (m_directoryId.Equals(&quot;&quot;) || m_localId.Equals(&quot;&quot;))</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+  {</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+    uuid.Truncate();</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+    return NS_OK;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+  }</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+  nsresult rv;</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; manager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+  return manager-&gt;GenerateUUID(m_directoryId, m_localId, uuid);</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+}</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetDirectoryId(nsACString &amp;dirId)</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+{</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+  dirId = m_directoryId;</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+}</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetDirectoryId(const nsACString &amp;aDirId)</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+{</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+  m_directoryId = aDirId;</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+}</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::GetLocalId(nsACString &amp;localId)</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+{</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+  localId = m_localId;</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+}</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+NS_IMETHODIMP nsAbCardProperty::SetLocalId(const nsACString &amp;aLocalId)</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+{</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+  m_localId = aLocalId;</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+}</span>
<a href="#l5.72"></a><span id="l5.72"> </span>
<a href="#l5.73"></a><span id="l5.73"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.74"></a><span id="l5.74"> </span>
<a href="#l5.75"></a><span id="l5.75"> NS_IMETHODIMP nsAbCardProperty::GetIsMailList(PRBool *aIsMailList)</span>
<a href="#l5.76"></a><span id="l5.76"> {</span>
<a href="#l5.77"></a><span id="l5.77">     *aIsMailList = m_IsMailList;</span>
<a href="#l5.78"></a><span id="l5.78">     return NS_OK;</span>
<a href="#l5.79"></a><span id="l5.79"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbCardProperty.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbCardProperty.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -72,16 +72,17 @@ public:</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> protected:</span>
<a href="#l6.6"></a><span id="l6.6"> 	PRBool   m_IsMailList;</span>
<a href="#l6.7"></a><span id="l6.7"> 	nsCString m_MailListURI;</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9">   // Store most of the properties here</span>
<a href="#l6.10"></a><span id="l6.10">   nsInterfaceHashtable&lt;nsCStringHashKey, nsIVariant&gt; m_properties;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+  nsCString m_directoryId, m_localId;</span>
<a href="#l6.13"></a><span id="l6.13"> private:</span>
<a href="#l6.14"></a><span id="l6.14">   nsresult AppendSection(const AppendItem *aArray, PRInt16 aCount, const nsString&amp; aHeading, nsIStringBundle *aBundle, mozITXTToHTMLConv *aConv, nsString &amp;aResult);</span>
<a href="#l6.15"></a><span id="l6.15">   nsresult AppendLine(const AppendItem &amp;aItem, mozITXTToHTMLConv *aConv, nsString &amp;aResult);</span>
<a href="#l6.16"></a><span id="l6.16">   nsresult AppendLabel(const AppendItem &amp;aItem, nsIStringBundle *aBundle, mozITXTToHTMLConv *aConv, nsString &amp;aResult);</span>
<a href="#l6.17"></a><span id="l6.17">   nsresult AppendCityStateZip(const AppendItem &amp;aItem, nsIStringBundle *aBundle, mozITXTToHTMLConv *aConv, nsString &amp;aResult);</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">   nsresult ConvertToBase64EncodedXML(nsACString &amp;result);</span>
<a href="#l6.20"></a><span id="l6.20">   nsresult ConvertToXMLPrintData(nsAString &amp;result);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirProperty.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirProperty.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -70,17 +70,29 @@ nsAbDirProperty::~nsAbDirProperty(void)</span>
<a href="#l7.4"></a><span id="l7.4">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Count failed&quot;);</span>
<a href="#l7.5"></a><span id="l7.5">     PRInt32 i;</span>
<a href="#l7.6"></a><span id="l7.6">     for (i = count - 1; i &gt;= 0; i--)</span>
<a href="#l7.7"></a><span id="l7.7">       m_AddressList-&gt;RemoveElementAt(i);</span>
<a href="#l7.8"></a><span id="l7.8">   }</span>
<a href="#l7.9"></a><span id="l7.9"> #endif</span>
<a href="#l7.10"></a><span id="l7.10"> }</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-NS_IMPL_ISUPPORTS1(nsAbDirProperty,nsIAbDirectory)</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+NS_IMPL_ISUPPORTS3(nsAbDirProperty, nsIAbDirectory, nsIAbCollection, nsIAbItem)</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::GetUuid(nsACString &amp;uuid)</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+{</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+  // XXX: not all directories have a dirPrefId...</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+  nsresult rv = GetDirPrefId(uuid);</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+  uuid.Append('&amp;');</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+  nsString dirName;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+  GetDirName(dirName);</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+  uuid.Append(NS_ConvertUTF16toUTF8(dirName));</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+  return rv;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+}</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27"> NS_IMETHODIMP nsAbDirProperty::GenerateName(PRInt32 aGenerateFormat,</span>
<a href="#l7.28"></a><span id="l7.28">                                             nsIStringBundle *aBundle,</span>
<a href="#l7.29"></a><span id="l7.29">                                             nsAString &amp;name)</span>
<a href="#l7.30"></a><span id="l7.30"> {</span>
<a href="#l7.31"></a><span id="l7.31">   return GetDirName(name);</span>
<a href="#l7.32"></a><span id="l7.32"> }</span>
<a href="#l7.33"></a><span id="l7.33"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPCard.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPCard.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -270,16 +270,17 @@ NS_IMETHODIMP nsAbLDAPCard::BuildRdn(nsI</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> NS_IMETHODIMP nsAbLDAPCard::GetDn(nsACString &amp;aDN)</span>
<a href="#l8.6"></a><span id="l8.6"> {</span>
<a href="#l8.7"></a><span id="l8.7">   return GetPropertyAsAUTF8String(kDNColumn, aDN);</span>
<a href="#l8.8"></a><span id="l8.8"> }</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> NS_IMETHODIMP nsAbLDAPCard::SetDn(const nsACString &amp;aDN)</span>
<a href="#l8.11"></a><span id="l8.11"> {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+  SetLocalId(aDN);</span>
<a href="#l8.13"></a><span id="l8.13">   return SetPropertyAsAUTF8String(kDNColumn, aDN);</span>
<a href="#l8.14"></a><span id="l8.14"> }</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16"> NS_IMETHODIMP nsAbLDAPCard::SetMetaProperties(nsILDAPMessage *aMessage)</span>
<a href="#l8.17"></a><span id="l8.17"> {</span>
<a href="#l8.18"></a><span id="l8.18">   NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l8.19"></a><span id="l8.19">   </span>
<a href="#l8.20"></a><span id="l8.20">   // Get DN</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectory.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectory.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -804,16 +804,20 @@ NS_IMETHODIMP nsAbLDAPDirectory::AddCard</span>
<a href="#l9.4"></a><span id="l9.4">     cardDN);</span>
<a href="#l9.5"></a><span id="l9.5">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.6"></a><span id="l9.6">   cardDN.AppendLiteral(&quot;,&quot;);</span>
<a href="#l9.7"></a><span id="l9.7">   cardDN.Append(baseDN);</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9">   rv = card-&gt;SetDn(cardDN);</span>
<a href="#l9.10"></a><span id="l9.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+  nsCAutoString ourUuid;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  GetUuid(ourUuid);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  copyToCard-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+</span>
<a href="#l9.16"></a><span id="l9.16">   // Launch query</span>
<a href="#l9.17"></a><span id="l9.17">   rv = DoModify(this, nsILDAPModification::MOD_ADD, cardDN, modArray,</span>
<a href="#l9.18"></a><span id="l9.18">                 EmptyCString(), EmptyCString());</span>
<a href="#l9.19"></a><span id="l9.19">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21">   NS_ADDREF(*aAddedCard = copyToCard);</span>
<a href="#l9.22"></a><span id="l9.22">   return NS_OK;</span>
<a href="#l9.23"></a><span id="l9.23"> }</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineat">@@ -837,16 +841,19 @@ NS_IMETHODIMP nsAbLDAPDirectory::DeleteC</span>
<a href="#l9.25"></a><span id="l9.25">     }</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27">     // Set up the search ldap url - this is mURL</span>
<a href="#l9.28"></a><span id="l9.28">     rv = Initiate();</span>
<a href="#l9.29"></a><span id="l9.29">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.30"></a><span id="l9.30">     </span>
<a href="#l9.31"></a><span id="l9.31">     rv = card-&gt;GetDn(cardDN);</span>
<a href="#l9.32"></a><span id="l9.32">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+    nsCOMPtr&lt;nsIAbCard&gt; realCard(do_QueryInterface(card));</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+    realCard-&gt;SetDirectoryId(EmptyCString());</span>
<a href="#l9.36"></a><span id="l9.36">    </span>
<a href="#l9.37"></a><span id="l9.37">     // Launch query</span>
<a href="#l9.38"></a><span id="l9.38">     rv = DoModify(this, nsILDAPModification::MOD_DELETE, cardDN, nsnull,</span>
<a href="#l9.39"></a><span id="l9.39">                   EmptyCString(), EmptyCString());</span>
<a href="#l9.40"></a><span id="l9.40">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.41"></a><span id="l9.41">   }</span>
<a href="#l9.42"></a><span id="l9.42"> </span>
<a href="#l9.43"></a><span id="l9.43">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -397,16 +397,17 @@ NS_IMETHODIMP nsAbLDAPDirectoryQuery::Do</span>
<a href="#l10.4"></a><span id="l10.4">   // If connection params have changed re-create connection</span>
<a href="#l10.5"></a><span id="l10.5">   // else reuse existing connection</span>
<a href="#l10.6"></a><span id="l10.6">   </span>
<a href="#l10.7"></a><span id="l10.7">   PRBool redoConnection = PR_FALSE;</span>
<a href="#l10.8"></a><span id="l10.8">   </span>
<a href="#l10.9"></a><span id="l10.9">   if (!mConnection || !mDirectoryUrl)</span>
<a href="#l10.10"></a><span id="l10.10">   {</span>
<a href="#l10.11"></a><span id="l10.11">     mDirectoryUrl = currentUrl;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+    aDirectory-&gt;GetUuid(mDirectoryId);</span>
<a href="#l10.13"></a><span id="l10.13">     mCurrentLogin = login;</span>
<a href="#l10.14"></a><span id="l10.14">     mCurrentMechanism = saslMechanism;</span>
<a href="#l10.15"></a><span id="l10.15">     mCurrentProtocolVersion = protocolVersion;</span>
<a href="#l10.16"></a><span id="l10.16">     redoConnection = PR_TRUE;</span>
<a href="#l10.17"></a><span id="l10.17">   }</span>
<a href="#l10.18"></a><span id="l10.18">   else</span>
<a href="#l10.19"></a><span id="l10.19">   {</span>
<a href="#l10.20"></a><span id="l10.20">     PRBool equal;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineat">@@ -415,16 +416,17 @@ NS_IMETHODIMP nsAbLDAPDirectoryQuery::Do</span>
<a href="#l10.22"></a><span id="l10.22">   </span>
<a href="#l10.23"></a><span id="l10.23">     nsCString spec;</span>
<a href="#l10.24"></a><span id="l10.24">     mDirectoryUrl-&gt;GetSpec(spec);</span>
<a href="#l10.25"></a><span id="l10.25">     currentUrl-&gt;GetSpec(spec);</span>
<a href="#l10.26"></a><span id="l10.26"> </span>
<a href="#l10.27"></a><span id="l10.27">     if (!equal)</span>
<a href="#l10.28"></a><span id="l10.28">     {</span>
<a href="#l10.29"></a><span id="l10.29">       mDirectoryUrl = currentUrl;</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+      aDirectory-&gt;GetUuid(mDirectoryId);</span>
<a href="#l10.31"></a><span id="l10.31">       mCurrentLogin = login;</span>
<a href="#l10.32"></a><span id="l10.32">       mCurrentMechanism = saslMechanism;</span>
<a href="#l10.33"></a><span id="l10.33">       mCurrentProtocolVersion = protocolVersion;</span>
<a href="#l10.34"></a><span id="l10.34">       redoConnection = PR_TRUE;</span>
<a href="#l10.35"></a><span id="l10.35">     }</span>
<a href="#l10.36"></a><span id="l10.36">     else</span>
<a href="#l10.37"></a><span id="l10.37">     {</span>
<a href="#l10.38"></a><span id="l10.38">       // Has login or version changed?</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineat">@@ -623,16 +625,18 @@ NS_IMETHODIMP nsAbLDAPDirectoryQuery::St</span>
<a href="#l10.40"></a><span id="l10.40">   if (listener)</span>
<a href="#l10.41"></a><span id="l10.41">     return listener-&gt;Cancel();</span>
<a href="#l10.42"></a><span id="l10.42"> </span>
<a href="#l10.43"></a><span id="l10.43">   return NS_OK;</span>
<a href="#l10.44"></a><span id="l10.44"> }</span>
<a href="#l10.45"></a><span id="l10.45"> </span>
<a href="#l10.46"></a><span id="l10.46"> NS_IMETHODIMP nsAbLDAPDirectoryQuery::OnQueryFoundCard(nsIAbCard *aCard)</span>
<a href="#l10.47"></a><span id="l10.47"> {</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+  aCard-&gt;SetDirectoryId(mDirectoryId);</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+</span>
<a href="#l10.50"></a><span id="l10.50">   for (PRInt32 i = 0; i &lt; mListeners.Count(); ++i)</span>
<a href="#l10.51"></a><span id="l10.51">     mListeners[i]-&gt;OnSearchFoundCard(aCard);</span>
<a href="#l10.52"></a><span id="l10.52"> </span>
<a href="#l10.53"></a><span id="l10.53">   return NS_OK;</span>
<a href="#l10.54"></a><span id="l10.54"> }</span>
<a href="#l10.55"></a><span id="l10.55"> </span>
<a href="#l10.56"></a><span id="l10.56"> NS_IMETHODIMP nsAbLDAPDirectoryQuery::OnQueryResult(PRInt32 aResult,</span>
<a href="#l10.57"></a><span id="l10.57">                                                     PRInt32 aErrorCode)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -61,16 +61,17 @@ public:</span>
<a href="#l11.4"></a><span id="l11.4">   virtual ~nsAbLDAPDirectoryQuery();</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> protected:</span>
<a href="#l11.7"></a><span id="l11.7">   nsCOMPtr&lt;nsILDAPMessageListener&gt; mListener;</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9"> private:</span>
<a href="#l11.10"></a><span id="l11.10">   nsCOMPtr&lt;nsILDAPConnection&gt; mConnection;</span>
<a href="#l11.11"></a><span id="l11.11">   nsCOMPtr&lt;nsILDAPURL&gt; mDirectoryUrl;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+  nsCString mDirectoryId;</span>
<a href="#l11.13"></a><span id="l11.13">   nsCOMArray&lt;nsIAbDirSearchListener&gt; mListeners;</span>
<a href="#l11.14"></a><span id="l11.14">   nsCString mCurrentLogin;</span>
<a href="#l11.15"></a><span id="l11.15">   nsCString mCurrentMechanism;</span>
<a href="#l11.16"></a><span id="l11.16">   PRUint32 mCurrentProtocolVersion;</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18">   PRBool mInitialized;</span>
<a href="#l11.19"></a><span id="l11.19"> };</span>
<a href="#l11.20"></a><span id="l11.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbManager.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbManager.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1240,8 +1240,18 @@ nsAbManager::Handle(nsICommandLine* aCmd</span>
<a href="#l12.4"></a><span id="l12.4"> }</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> NS_IMETHODIMP</span>
<a href="#l12.7"></a><span id="l12.7"> nsAbManager::GetHelpInfo(nsACString&amp; aResult)</span>
<a href="#l12.8"></a><span id="l12.8"> {</span>
<a href="#l12.9"></a><span id="l12.9">   aResult.Assign(NS_LITERAL_CSTRING(&quot;  -addressbook       Open the address book at startup.\n&quot;));</span>
<a href="#l12.10"></a><span id="l12.10">   return NS_OK;</span>
<a href="#l12.11"></a><span id="l12.11"> }</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+nsAbManager::GenerateUUID(const nsACString &amp;aDirectoryId,</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+                          const nsACString &amp;aLocalId, nsACString &amp;uuid)</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+{</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+  uuid.Assign(aDirectoryId);</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+  uuid.Append('#');</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+  uuid.Append(aLocalId);</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXCard.mm</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXCard.mm</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -182,16 +182,18 @@ nsAbOSXCard::Init(const char *aUri)</span>
<a href="#l13.4"></a><span id="l13.4"> {</span>
<a href="#l13.5"></a><span id="l13.5">   if (strncmp(aUri, NS_ABOSXCARD_URI_PREFIX,</span>
<a href="#l13.6"></a><span id="l13.6">               sizeof(NS_ABOSXCARD_URI_PREFIX) - 1) != 0)</span>
<a href="#l13.7"></a><span id="l13.7">     return NS_ERROR_FAILURE;</span>
<a href="#l13.8"></a><span id="l13.8">   </span>
<a href="#l13.9"></a><span id="l13.9">   nsresult rv = nsRDFResource::Init(aUri);</span>
<a href="#l13.10"></a><span id="l13.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.11"></a><span id="l13.11">   </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+  SetLocalId(nsDependentCString(aUri));</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+</span>
<a href="#l13.14"></a><span id="l13.14">   return Update(PR_FALSE);</span>
<a href="#l13.15"></a><span id="l13.15"> }</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17"> nsresult</span>
<a href="#l13.18"></a><span id="l13.18"> nsAbOSXCard::Update(PRBool aNotify)</span>
<a href="#l13.19"></a><span id="l13.19"> {</span>
<a href="#l13.20"></a><span id="l13.20">   ABAddressBook *addressBook = [ABAddressBook sharedAddressBook];</span>
<a href="#l13.21"></a><span id="l13.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXDirectory.mm</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXDirectory.mm</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -492,24 +492,29 @@ nsAbOSXDirectory::Init(const char *aUri)</span>
<a href="#l14.4"></a><span id="l14.4">       mCardList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l14.5"></a><span id="l14.5">     else</span>
<a href="#l14.6"></a><span id="l14.6">       rv = mCardList-&gt;Clear();</span>
<a href="#l14.7"></a><span id="l14.7">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9">     cardList = mCardList;</span>
<a href="#l14.10"></a><span id="l14.10">   }</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+  nsCAutoString ourUuid;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  GetUuid(ourUuid);</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+</span>
<a href="#l14.15"></a><span id="l14.15">   unsigned int nbCards = [cards count];</span>
<a href="#l14.16"></a><span id="l14.16">   nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l14.17"></a><span id="l14.17">   for (unsigned int i = 0; i &lt; nbCards; ++i)</span>
<a href="#l14.18"></a><span id="l14.18">   {</span>
<a href="#l14.19"></a><span id="l14.19">     rv = ConvertToCard(gRDFService, [cards objectAtIndex:i],</span>
<a href="#l14.20"></a><span id="l14.20">                        getter_AddRefs(card));</span>
<a href="#l14.21"></a><span id="l14.21">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+    card-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+</span>
<a href="#l14.25"></a><span id="l14.25">     cardList-&gt;AppendElement(card, PR_FALSE);</span>
<a href="#l14.26"></a><span id="l14.26">   }</span>
<a href="#l14.27"></a><span id="l14.27"> </span>
<a href="#l14.28"></a><span id="l14.28">   return NS_OK;</span>
<a href="#l14.29"></a><span id="l14.29"> }</span>
<a href="#l14.30"></a><span id="l14.30"> </span>
<a href="#l14.31"></a><span id="l14.31"> NS_IMETHODIMP</span>
<a href="#l14.32"></a><span id="l14.32"> nsAbOSXDirectory::GetURI(nsACString &amp;aURI)</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineat">@@ -740,16 +745,20 @@ nsAbOSXDirectory::AssertDirectory(nsIAbM</span>
<a href="#l14.34"></a><span id="l14.34"> </span>
<a href="#l14.35"></a><span id="l14.35">   return aManager-&gt;NotifyDirectoryItemAdded(this, aDirectory);</span>
<a href="#l14.36"></a><span id="l14.36"> }</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38"> nsresult</span>
<a href="#l14.39"></a><span id="l14.39"> nsAbOSXDirectory::AssertCard(nsIAbManager *aManager,</span>
<a href="#l14.40"></a><span id="l14.40">                              nsIAbCard *aCard)</span>
<a href="#l14.41"></a><span id="l14.41"> {</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+  nsCAutoString ourUuid;</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+  GetUuid(ourUuid);</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+  aCard-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+</span>
<a href="#l14.46"></a><span id="l14.46">   nsresult rv = m_IsMailList ? m_AddressList-&gt;AppendElement(aCard, PR_FALSE) :</span>
<a href="#l14.47"></a><span id="l14.47">                                mCardList-&gt;AppendElement(aCard, PR_FALSE);</span>
<a href="#l14.48"></a><span id="l14.48">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.49"></a><span id="l14.49"> </span>
<a href="#l14.50"></a><span id="l14.50">   return aManager-&gt;NotifyDirectoryItemAdded(this, aCard);</span>
<a href="#l14.51"></a><span id="l14.51"> }</span>
<a href="#l14.52"></a><span id="l14.52"> </span>
<a href="#l14.53"></a><span id="l14.53"> nsresult</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineat">@@ -813,26 +822,31 @@ nsAbOSXDirectory::GetChildCards(nsISimpl</span>
<a href="#l14.55"></a><span id="l14.55">       return FallbackSearch(expression, aCards);</span>
<a href="#l14.56"></a><span id="l14.56"> </span>
<a href="#l14.57"></a><span id="l14.57">     if (!mCardList)</span>
<a href="#l14.58"></a><span id="l14.58">       mCardList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l14.59"></a><span id="l14.59">     else</span>
<a href="#l14.60"></a><span id="l14.60">       mCardList-&gt;Clear();</span>
<a href="#l14.61"></a><span id="l14.61">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.62"></a><span id="l14.62">   </span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+    // The uuid for initializing cards</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+    nsCAutoString ourUuid;</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+    GetUuid(ourUuid);</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+</span>
<a href="#l14.67"></a><span id="l14.67">     // Fill the results array and update the card list</span>
<a href="#l14.68"></a><span id="l14.68">     unsigned int nbCards = [cards count];</span>
<a href="#l14.69"></a><span id="l14.69">   </span>
<a href="#l14.70"></a><span id="l14.70">     unsigned int i;</span>
<a href="#l14.71"></a><span id="l14.71">     nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l14.72"></a><span id="l14.72">     for (i = 0; i &lt; nbCards; ++i)</span>
<a href="#l14.73"></a><span id="l14.73">     {</span>
<a href="#l14.74"></a><span id="l14.74">       rv = ConvertToCard(gRDFService, [cards objectAtIndex:i],</span>
<a href="#l14.75"></a><span id="l14.75">                          getter_AddRefs(card));</span>
<a href="#l14.76"></a><span id="l14.76">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+      card-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l14.78"></a><span id="l14.78"> </span>
<a href="#l14.79"></a><span id="l14.79">       mCardList-&gt;AppendElement(card, PR_FALSE);</span>
<a href="#l14.80"></a><span id="l14.80">     }</span>
<a href="#l14.81"></a><span id="l14.81"> </span>
<a href="#l14.82"></a><span id="l14.82">     return NS_NewArrayEnumerator(aCards, mCardList);</span>
<a href="#l14.83"></a><span id="l14.83">   }</span>
<a href="#l14.84"></a><span id="l14.84"> </span>
<a href="#l14.85"></a><span id="l14.85">   // Not a search, so just return the appropriate list of items.</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineat">@@ -1040,16 +1054,20 @@ nsAbOSXDirectory::OnSearchFoundCard(nsIA</span>
<a href="#l14.87"></a><span id="l14.87">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.88"></a><span id="l14.88">   }</span>
<a href="#l14.89"></a><span id="l14.89"> </span>
<a href="#l14.90"></a><span id="l14.90">   rv = m_AddressList-&gt;AppendElement(aCard, PR_FALSE);</span>
<a href="#l14.91"></a><span id="l14.91">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.92"></a><span id="l14.92">   </span>
<a href="#l14.93"></a><span id="l14.93">   rv = mCardList-&gt;AppendElement(aCard, PR_FALSE);</span>
<a href="#l14.94"></a><span id="l14.94">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+  nsCAutoString ourUuid;</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+  GetUuid(ourUuid);</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+  aCard-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l14.99"></a><span id="l14.99">   </span>
<a href="#l14.100"></a><span id="l14.100">   return NS_OK;</span>
<a href="#l14.101"></a><span id="l14.101"> }</span>
<a href="#l14.102"></a><span id="l14.102"> </span>
<a href="#l14.103"></a><span id="l14.103"> nsresult</span>
<a href="#l14.104"></a><span id="l14.104"> nsAbOSXDirectory::FallbackSearch(nsIAbBooleanExpression *aExpression,</span>
<a href="#l14.105"></a><span id="l14.105">                                  nsISimpleEnumerator **aCards)</span>
<a href="#l14.106"></a><span id="l14.106"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOutlookDirectory.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOutlookDirectory.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -337,16 +337,17 @@ NS_IMETHODIMP nsAbOutlookDirectory::Dele</span>
<a href="#l15.4"></a><span id="l15.4">     nsMapiEntry cardEntry ;</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6">     for (i = 0 ; i &lt; nbCards ; ++ i) {</span>
<a href="#l15.7"></a><span id="l15.7">         nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryElementAt(aCardList, i, &amp;retCode));</span>
<a href="#l15.8"></a><span id="l15.8">         NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10">         retCode = ExtractCardEntry(card, entryString) ;</span>
<a href="#l15.11"></a><span id="l15.11">         if (NS_SUCCEEDED(retCode) &amp;&amp; !entryString.IsEmpty()) {</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+            card-&gt;SetDirectoryId(EmptyCString());</span>
<a href="#l15.13"></a><span id="l15.13"> </span>
<a href="#l15.14"></a><span id="l15.14">             cardEntry.Assign(entryString) ;</span>
<a href="#l15.15"></a><span id="l15.15">             if (!mapiAddBook-&gt;DeleteEntry(*mMapiData, cardEntry)) {</span>
<a href="#l15.16"></a><span id="l15.16">                 PRINTF((&quot;Cannot delete card %s.\n&quot;, entryString.get())) ;</span>
<a href="#l15.17"></a><span id="l15.17">             }</span>
<a href="#l15.18"></a><span id="l15.18">             else {</span>
<a href="#l15.19"></a><span id="l15.19">                 mCardList.Remove(card);</span>
<a href="#l15.20"></a><span id="l15.20">                 if (m_IsMailList &amp;&amp; m_AddressList) </span>
<a href="#l15.21"></a><span id="l15.21" class="difflineat">@@ -1062,28 +1063,32 @@ nsresult nsAbOutlookDirectory::GetChildC</span>
<a href="#l15.22"></a><span id="l15.22">   nsMapiEntryArray cardEntries;</span>
<a href="#l15.23"></a><span id="l15.23">   LPSRestriction restriction = (LPSRestriction) aRestriction;</span>
<a href="#l15.24"></a><span id="l15.24"> </span>
<a href="#l15.25"></a><span id="l15.25">   if (!mapiAddBook-&gt;GetCards(*mMapiData, restriction, cardEntries)) {</span>
<a href="#l15.26"></a><span id="l15.26">     PRINTF((&quot;Cannot get cards.\n&quot;));</span>
<a href="#l15.27"></a><span id="l15.27">     return NS_ERROR_FAILURE;</span>
<a href="#l15.28"></a><span id="l15.28">   }</span>
<a href="#l15.29"></a><span id="l15.29"> </span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+  nsCAutoString ourUuid;</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+  GetUuid(ourUuid);</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+</span>
<a href="#l15.33"></a><span id="l15.33">   nsCAutoString entryId;</span>
<a href="#l15.34"></a><span id="l15.34">   nsCAutoString uriName;</span>
<a href="#l15.35"></a><span id="l15.35">   nsCOMPtr&lt;nsIAbCard&gt; childCard;</span>
<a href="#l15.36"></a><span id="l15.36">   nsresult rv;</span>
<a href="#l15.37"></a><span id="l15.37"> </span>
<a href="#l15.38"></a><span id="l15.38">   for (ULONG card = 0; card &lt; cardEntries.mNbEntries; ++card) {</span>
<a href="#l15.39"></a><span id="l15.39">     cardEntries.mEntries[card].ToString(entryId);</span>
<a href="#l15.40"></a><span id="l15.40">     buildAbWinUri(kOutlookCardScheme, mAbWinType, uriName);</span>
<a href="#l15.41"></a><span id="l15.41">     uriName.Append(entryId);</span>
<a href="#l15.42"></a><span id="l15.42"> </span>
<a href="#l15.43"></a><span id="l15.43">     rv = OutlookCardForURI(uriName, getter_AddRefs(childCard));</span>
<a href="#l15.44"></a><span id="l15.44">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+    childCard-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l15.46"></a><span id="l15.46"> </span>
<a href="#l15.47"></a><span id="l15.47">     aCards-&gt;AppendElement(childCard, PR_FALSE);</span>
<a href="#l15.48"></a><span id="l15.48">   }</span>
<a href="#l15.49"></a><span id="l15.49">   return rv;</span>
<a href="#l15.50"></a><span id="l15.50"> }</span>
<a href="#l15.51"></a><span id="l15.51"> </span>
<a href="#l15.52"></a><span id="l15.52"> nsresult nsAbOutlookDirectory::GetChildNodes(nsIMutableArray* aNodes)</span>
<a href="#l15.53"></a><span id="l15.53"> {</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineat">@@ -1269,16 +1274,20 @@ nsresult nsAbOutlookDirectory::CreateCar</span>
<a href="#l15.55"></a><span id="l15.55"> </span>
<a href="#l15.56"></a><span id="l15.56">     buildAbWinUri(kOutlookCardScheme, mAbWinType, uri) ;</span>
<a href="#l15.57"></a><span id="l15.57">     uri.Append(entryString) ;</span>
<a href="#l15.58"></a><span id="l15.58">     </span>
<a href="#l15.59"></a><span id="l15.59">     nsCOMPtr&lt;nsIAbCard&gt; newCard;</span>
<a href="#l15.60"></a><span id="l15.60">     retCode = OutlookCardForURI(uri, getter_AddRefs(newCard));</span>
<a href="#l15.61"></a><span id="l15.61">     NS_ENSURE_SUCCESS(retCode, retCode);</span>
<a href="#l15.62"></a><span id="l15.62"> </span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+    nsCAutoString ourUuid;</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+    GetUuid(ourUuid);</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+    newCard-&gt;SetDirectoryId(ourUuid);</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+</span>
<a href="#l15.67"></a><span id="l15.67">     if (!didCopy) {</span>
<a href="#l15.68"></a><span id="l15.68">         retCode = newCard-&gt;Copy(aData) ;</span>
<a href="#l15.69"></a><span id="l15.69">         NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l15.70"></a><span id="l15.70">         retCode = ModifyCard(newCard) ;</span>
<a href="#l15.71"></a><span id="l15.71">         NS_ENSURE_SUCCESS(retCode, retCode) ;</span>
<a href="#l15.72"></a><span id="l15.72">     }</span>
<a href="#l15.73"></a><span id="l15.73">     *aNewCard = newCard ;</span>
<a href="#l15.74"></a><span id="l15.74">     NS_ADDREF(*aNewCard) ;</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineat">@@ -1485,16 +1494,17 @@ nsresult OutlookCardForURI(const nsACStr</span>
<a href="#l15.76"></a><span id="l15.76">   if (!mapiAddBook-&gt;IsOK())</span>
<a href="#l15.77"></a><span id="l15.77">     return NS_ERROR_FAILURE;</span>
<a href="#l15.78"></a><span id="l15.78"> </span>
<a href="#l15.79"></a><span id="l15.79">   nsresult rv;</span>
<a href="#l15.80"></a><span id="l15.80">   nsCOMPtr&lt;nsIAbCard&gt; card = do_CreateInstance(NS_ABCARDPROPERTY_CONTRACTID, &amp;rv);</span>
<a href="#l15.81"></a><span id="l15.81">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.82"></a><span id="l15.82"> </span>
<a href="#l15.83"></a><span id="l15.83">   card-&gt;SetPropertyAsAUTF8String(&quot;OutlookEntryURI&quot;, aUri);</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+  card-&gt;SetLocalId(aUri);</span>
<a href="#l15.85"></a><span id="l15.85"> </span>
<a href="#l15.86"></a><span id="l15.86">   nsMapiEntry mapiData;</span>
<a href="#l15.87"></a><span id="l15.87">   mapiData.Assign(entry);</span>
<a href="#l15.88"></a><span id="l15.88"> </span>
<a href="#l15.89"></a><span id="l15.89">   nsStringArray unichars;</span>
<a href="#l15.90"></a><span id="l15.90">   if (mapiAddBook-&gt;GetPropertiesUString(mapiData, OutlookCardMAPIProps,</span>
<a href="#l15.91"></a><span id="l15.91">                                         index_LastProp, unichars))</span>
<a href="#l15.92"></a><span id="l15.92">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddrDatabase.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddrDatabase.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1247,30 +1247,73 @@ nsresult nsAddrDatabase::AddAttributeCol</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5">   return NS_OK;</span>
<a href="#l16.6"></a><span id="l16.6"> }</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> NS_IMETHODIMP nsAddrDatabase::CreateNewCardAndAddToDB(nsIAbCard *aNewCard, PRBool aNotify /* = FALSE */, nsIAbDirectory *aParent)</span>
<a href="#l16.9"></a><span id="l16.9"> {</span>
<a href="#l16.10"></a><span id="l16.10">   nsCOMPtr &lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  if (!aNewCard || !m_mdbPabTable || !m_mdbEnv)</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+  if (!aNewCard || !m_mdbPabTable || !m_mdbEnv || !m_mdbStore)</span>
<a href="#l16.14"></a><span id="l16.14">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-  nsresult rv = GetNewRow(getter_AddRefs(cardRow));</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+  // Per the UUID requirements, we want to try to reuse the local id if at all</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+  // possible. nsACString::ToInteger probably won't fail if the local id looks</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+  // like &quot;23bozo&quot; (returning 23 instead), but it's okay since we aren't going</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+  // to overwrite anything with 23 if it already exists and the id for the row</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+  // doesn't matter otherwise.</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+  nsresult rv;</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+  nsCAutoString id;</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+  aNewCard-&gt;GetLocalId(id);</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+  mdbOid rowId;</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+  rowId.mOid_Scope = m_CardRowScopeToken;</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+  rowId.mOid_Id = id.ToInteger(&amp;rv, 10);</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+  {</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+    // Mork is being very naughty here. If the table does not have the oid, we</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+    // should be able to reuse it. To be on the safe side, however, we're going</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+    // to reference the store's reference count.</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+    mdb_count rowCount = 1;</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+    m_mdbStore-&gt;GetRowRefCount(m_mdbEnv, &amp;rowId, &amp;rowCount);</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+    if (rowCount == 0)</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+    {</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+      // So apparently, the row can have a count of 0 yet still exist (probably</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+      // meaning we haven't flushed it out of memory). In this case, we need to</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+      // get the row and cut its cells.</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+      rv = m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;rowId, getter_AddRefs(cardRow));</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; cardRow)</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+        cardRow-&gt;CutAllColumns(m_mdbEnv);</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+      else</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+        rv = m_mdbStore-&gt;NewRowWithOid(m_mdbEnv, &amp;rowId, getter_AddRefs(cardRow));</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+    }</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+  }</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+  // If we don't have a cardRow yet, just get one with any ol' id.</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+  if (!cardRow)</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+    rv = GetNewRow(getter_AddRefs(cardRow));</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+</span>
<a href="#l16.54"></a><span id="l16.54">   if (NS_SUCCEEDED(rv) &amp;&amp; cardRow)</span>
<a href="#l16.55"></a><span id="l16.55">   {</span>
<a href="#l16.56"></a><span id="l16.56">     AddAttributeColumnsToRow(aNewCard, cardRow);</span>
<a href="#l16.57"></a><span id="l16.57">     AddRecordKeyColumnToRow(cardRow);</span>
<a href="#l16.58"></a><span id="l16.58"> </span>
<a href="#l16.59"></a><span id="l16.59">     // we need to do this for dnd</span>
<a href="#l16.60"></a><span id="l16.60">     PRUint32 key = 0;</span>
<a href="#l16.61"></a><span id="l16.61">     rv = GetIntColumn(cardRow, m_RecordKeyColumnToken, &amp;key, 0);</span>
<a href="#l16.62"></a><span id="l16.62">     if (NS_SUCCEEDED(rv))</span>
<a href="#l16.63"></a><span id="l16.63">       aNewCard-&gt;SetPropertyAsUint32(kRecordKeyColumn, key);</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+    </span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+    aNewCard-&gt;GetPropertyAsAUTF8String(kRowIDProperty, id);</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+    aNewCard-&gt;SetLocalId(id);</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+    if (m_dbDirectory)</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+      m_dbDirectory-&gt;GetUuid(id);</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+    aNewCard-&gt;SetDirectoryId(id);</span>
<a href="#l16.71"></a><span id="l16.71"> </span>
<a href="#l16.72"></a><span id="l16.72">     mdb_err merror = m_mdbPabTable-&gt;AddRow(m_mdbEnv, cardRow);</span>
<a href="#l16.73"></a><span id="l16.73">     if (merror != NS_OK) return NS_ERROR_FAILURE;</span>
<a href="#l16.74"></a><span id="l16.74"> </span>
<a href="#l16.75"></a><span id="l16.75">   }</span>
<a href="#l16.76"></a><span id="l16.76">   else</span>
<a href="#l16.77"></a><span id="l16.77">     return rv;</span>
<a href="#l16.78"></a><span id="l16.78"> </span>
<a href="#l16.79"></a><span id="l16.79" class="difflineat">@@ -1628,16 +1671,19 @@ NS_IMETHODIMP nsAddrDatabase::DeleteCard</span>
<a href="#l16.80"></a><span id="l16.80">   err = aCard-&gt;GetPropertyAsUint32(kRowIDProperty, &amp;rowOid.mOid_Id);</span>
<a href="#l16.81"></a><span id="l16.81">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l16.82"></a><span id="l16.82"> </span>
<a href="#l16.83"></a><span id="l16.83">   err = m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;rowOid, &amp;pCardRow);</span>
<a href="#l16.84"></a><span id="l16.84">   NS_ENSURE_SUCCESS(err,err);</span>
<a href="#l16.85"></a><span id="l16.85">   if (!pCardRow)</span>
<a href="#l16.86"></a><span id="l16.86">     return NS_OK;</span>
<a href="#l16.87"></a><span id="l16.87"> </span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+  // Reset the directory id</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+  aCard-&gt;SetDirectoryId(EmptyCString());</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+</span>
<a href="#l16.91"></a><span id="l16.91">   // Add the deleted card to the deletedcards table</span>
<a href="#l16.92"></a><span id="l16.92">   nsCOMPtr &lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l16.93"></a><span id="l16.93">   AddRowToDeletedCardsTable(aCard, getter_AddRefs(cardRow));</span>
<a href="#l16.94"></a><span id="l16.94">   err = DeleteRow(m_mdbPabTable, pCardRow);</span>
<a href="#l16.95"></a><span id="l16.95"> </span>
<a href="#l16.96"></a><span id="l16.96">   //delete the person card from all mailing list</span>
<a href="#l16.97"></a><span id="l16.97">   if (!bIsMailList)</span>
<a href="#l16.98"></a><span id="l16.98">     DeleteCardFromAllMailLists(rowOid.mOid_Id);</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineat">@@ -2902,16 +2948,24 @@ nsresult nsAddrDatabase::CreateCard(nsIM</span>
<a href="#l16.100"></a><span id="l16.100">     {</span>
<a href="#l16.101"></a><span id="l16.101">         nsCOMPtr&lt;nsIAbCard&gt; personCard;</span>
<a href="#l16.102"></a><span id="l16.102">       personCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l16.103"></a><span id="l16.103">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l16.104"></a><span id="l16.104"> </span>
<a href="#l16.105"></a><span id="l16.105">         InitCardFromRow(personCard, cardRow);</span>
<a href="#l16.106"></a><span id="l16.106">         personCard-&gt;SetPropertyAsUint32(kRowIDProperty, rowID);</span>
<a href="#l16.107"></a><span id="l16.107"> </span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+        nsCAutoString id;</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+        id.AppendInt(rowID);</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+        personCard-&gt;SetLocalId(id);</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineplus">+        if (m_dbDirectory)</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+         m_dbDirectory-&gt;GetUuid(id);</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+        personCard-&gt;SetDirectoryId(id);</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+</span>
<a href="#l16.116"></a><span id="l16.116">         NS_IF_ADDREF(*result = personCard);</span>
<a href="#l16.117"></a><span id="l16.117">     }</span>
<a href="#l16.118"></a><span id="l16.118"> </span>
<a href="#l16.119"></a><span id="l16.119">     return rv;</span>
<a href="#l16.120"></a><span id="l16.120"> }</span>
<a href="#l16.121"></a><span id="l16.121"> </span>
<a href="#l16.122"></a><span id="l16.122"> nsresult nsAddrDatabase::CreateABCard(nsIMdbRow* cardRow, mdb_id listRowID, nsIAbCard **result)</span>
<a href="#l16.123"></a><span id="l16.123"> {</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineat">@@ -2948,16 +3002,24 @@ nsresult nsAddrDatabase::CreateABListCar</span>
<a href="#l16.125"></a><span id="l16.125"> </span>
<a href="#l16.126"></a><span id="l16.126">         if (personCard)</span>
<a href="#l16.127"></a><span id="l16.127">         {</span>
<a href="#l16.128"></a><span id="l16.128">             GetListCardFromDB(personCard, listRow);</span>
<a href="#l16.129"></a><span id="l16.129"> </span>
<a href="#l16.130"></a><span id="l16.130">             personCard-&gt;SetPropertyAsUint32(kRowIDProperty, rowID);</span>
<a href="#l16.131"></a><span id="l16.131">             personCard-&gt;SetIsMailList(PR_TRUE);</span>
<a href="#l16.132"></a><span id="l16.132">             personCard-&gt;SetMailListURI(listURI);</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineplus">+            nsCAutoString id;</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+            id.AppendInt(rowID);</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+            personCard-&gt;SetLocalId(id);</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineplus">+</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+            if (m_dbDirectory)</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+             m_dbDirectory-&gt;GetUuid(id);</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+            personCard-&gt;SetDirectoryId(id);</span>
<a href="#l16.141"></a><span id="l16.141">         }</span>
<a href="#l16.142"></a><span id="l16.142"> </span>
<a href="#l16.143"></a><span id="l16.143">         NS_IF_ADDREF(*result = personCard);</span>
<a href="#l16.144"></a><span id="l16.144">     }</span>
<a href="#l16.145"></a><span id="l16.145">     if (listURI)</span>
<a href="#l16.146"></a><span id="l16.146">         PR_smprintf_free(listURI);</span>
<a href="#l16.147"></a><span id="l16.147"> </span>
<a href="#l16.148"></a><span id="l16.148">     return rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">new file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- /dev/null</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_uuid.js</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -0,0 +1,124 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+/* This file is testing that the UUID semantics of cards and directories match</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+ * the guarantees of their documented requirements.</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineplus">+ */</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineplus">+</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+var abMgr;</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+/**</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+ * Checks that the directory follows the contract for UUIDs.</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+ *</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+ * If the directory is modifiable, it will be modified, although the net effect</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+ * will not change the state if the code works properly.</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+ */</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+function check_directory(directory) {</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+  var prefId = directory.dirPrefId + '&amp;' + directory.dirName;</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+  var testModification = !directory.readOnly;</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+  dump(&quot;Testing &quot; + prefId);</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+  if (testModification)</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+    dump(&quot; (with modifications)&quot;);</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+  dump(&quot;...\n&quot;);</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+  // Question 1: Is the UUID the preference ID?</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+  do_check_eq(prefId, directory.uuid);</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+  </span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+  // Now we need to run through the cards, checking that each card meets the</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+  // requirements.</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+  var seenIds = [], cards = [];</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+  var enumerator = directory.childCards;</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+    var card = enumerator.getNext().QueryInterface(Ci.nsIAbCard);</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+    cards.push(card);</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+    // Question 2.1: Is the directory ID correct?</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+    do_check_eq(prefId, card.directoryId);</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+    // Question 2.2: Is the local ID unique and valid?</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+    do_check_neq(card.localId, &quot;&quot;);</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+    do_check_eq(seenIds.indexOf(card.localId), -1);</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+    seenIds.push(card.localId);</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+    // Question 2.3: Is the format equal to generateUUID?</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+    do_check_eq(card.uuid, abMgr.generateUUID(prefId, card.localId));</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+  }</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+  // Question 3: Do cards returned via searches return UUIDs correctly?</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+  var uri = directory.URI;</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+  uri += &quot;?(or(DisplayName,=,a)(DisplayName,!=,a))&quot;;</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+  var search = abMgr.getDirectory(uri);</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+  </span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+  enumerator = search.childCards;</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+    var card = enumerator.getNext().QueryInterface(Ci.nsIAbCard);</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+    // Question 3.1: Is the directory ID correct?</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+    do_check_eq(prefId, card.directoryId);</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+    // Question 3.2: Is the local ID valid?</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+    do_check_neq(card.localId, &quot;&quot;);</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineplus">+</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+    // Question 3.3: Is the format equal to generateUUID?</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+    do_check_eq(card.uuid, abMgr.generateUUID(prefId, card.localId));</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+  }</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+  // The remaining tests deal with modification of address books.</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+  if (!testModification)</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+    return;</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+  </span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+  // Question 4: Does adding a new card properly set the UUID?</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+  var newCard = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;]</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+                  .createInstance(Ci.nsIAbCard);</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+  newCard.displayName = &quot;Test User&quot;;</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+  newCard.primaryEmail = &quot;user1@test.invalid&quot;;</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+  newCard.firstName = &quot;Test&quot;;</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+  newCard.lastName = &quot;User&quot;;</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+  newCard = directory.addCard(newCard);</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+  do_check_eq(newCard.directoryId, prefId);</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineplus">+  do_check_neq(newCard.localId, &quot;&quot;);</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+  do_check_eq(seenIds.indexOf(newCard.localId), -1);</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+  // Remove the new card to be stable!</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+  var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+  array.appendElement(newCard, false);</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+  directory.deleteCards(array);</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+  // We need to iterate over the array of cards to avoid any problems if someone</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+  // makes the childCards enumerator reflect changes to directory...</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+  for each (var card in cards) {</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+    // Question 5.1: Does deleting a card properly set the uids?</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+    var localId = card.localId;</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+    array.clear();</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+    array.appendElement(card, false);</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+    directory.deleteCards(array);</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+    do_check_eq(card.directoryId, &quot;&quot;);</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineplus">+    do_check_eq(card.localId, localId);</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineplus">+</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineplus">+    // Question 5.2: Does readding a card try to best-fit the uid?</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineplus">+    card = directory.addCard(card);</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineplus">+    do_check_eq(card.directoryId, prefId);</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineplus">+    do_check_eq(card.localId, localId);</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineplus">+  }</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineplus">+}</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineplus">+</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+function run_test() {</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+  // Preliminary: we need a directory for local tests</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+  var testAB = do_get_file(&quot;data/cardForEmail.mab&quot;);</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineplus">+  // Copy the file to the profile directory for a PAB</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineplus">+  testAB.copyTo(gProfileDir, kPABData.fileName);</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineplus">+</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineplus">+  // Step 1: What is the ID of an empty card?</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineplus">+  var newCard = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;]</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+                  .createInstance(Ci.nsIAbCard);</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineplus">+  do_check_eq(newCard.uuid, &quot;&quot;);</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineplus">+  do_check_eq(newCard.directoryId, &quot;&quot;);</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+  do_check_eq(newCard.localId, &quot;&quot;);</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineplus">+</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+  // Step 2: Check the directories</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineplus">+  abMgr = Cc[&quot;@mozilla.org/abmanager;1&quot;].getService(Ci.nsIAbManager);</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineplus">+  var dirs = abMgr.directories;</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineplus">+  while (dirs.hasMoreElements()) {</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineplus">+    var directory = dirs.getNext().QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineplus">+    check_directory(directory);</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineplus">+  }</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineplus">+}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

