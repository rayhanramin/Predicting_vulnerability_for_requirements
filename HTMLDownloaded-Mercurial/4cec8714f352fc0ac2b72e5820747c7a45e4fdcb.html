<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29798:4cec8714f352fc0ac2b72e5820747c7a45e4fdcb</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 4cec8714f352fc0ac2b72e5820747c7a45e4fdcb" />
<meta property="og:url" content="/comm-central/rev/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb" />
<meta property="og:description" content="Bug 1643262 - Update vCard conversion to correctly handle multiple values of the same type. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 4cec8714f352fc0ac2b72e5820747c7a45e4fdcb 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb">shortlog</a> |
<a href="/comm-central/log/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb">files</a> |
changeset |
<a href="/comm-central/raw-rev/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb">raw</a>  | <a href="/comm-central/archive/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1643262">Bug 1643262</a> - Update vCard conversion to correctly handle multiple values of the same type. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 06 Jun 2020 08:34:01 +0300</td></tr>

<tr>
 <td>changeset 29798</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb">4cec8714f352fc0ac2b72e5820747c7a45e4fdcb</a></td>
</tr>



<tr>
<td>parent 29797</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d146b4e2061c4ec55fce6ac0615c722fed19e756">d146b4e2061c4ec55fce6ac0615c722fed19e756</a>
</td>
</tr>

<tr>
<td>child 29799</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7ebb05223bbd26ee9eb7c42b3491bdb0349c97eb">7ebb05223bbd26ee9eb7c42b3491bdb0349c97eb</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=4cec8714f352fc0ac2b72e5820747c7a45e4fdcb">17537</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Sat, 06 Jun 2020 05:35:03 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@4cec8714f352 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4cec8714f352fc0ac2b72e5820747c7a45e4fdcb">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4cec8714f352fc0ac2b72e5820747c7a45e4fdcb&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4cec8714f352fc0ac2b72e5820747c7a45e4fdcb&newProject=comm-central&newRevision=4cec8714f352fc0ac2b72e5820747c7a45e4fdcb&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4cec8714f352fc0ac2b72e5820747c7a45e4fdcb&newProject=comm-central&newRevision=4cec8714f352fc0ac2b72e5820747c7a45e4fdcb&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4cec8714f352fc0ac2b72e5820747c7a45e4fdcb&newProject=comm-central&newRevision=4cec8714f352fc0ac2b72e5820747c7a45e4fdcb&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1643262">1643262</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1643262">Bug 1643262</a> - Update vCard conversion to correctly handle multiple values of the same type. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/jsaddrbook/VCardUtils.jsm">mailnews/addrbook/jsaddrbook/VCardUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/jsaddrbook/VCardUtils.jsm">file</a> |
<a href="/comm-central/annotate/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/jsaddrbook/VCardUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/jsaddrbook/VCardUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/jsaddrbook/VCardUtils.jsm">comparison</a> |
<a href="/comm-central/log/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/jsaddrbook/VCardUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/test/unit/data/export.vcf">mailnews/addrbook/test/unit/data/export.vcf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/test/unit/data/export.vcf">file</a> |
<a href="/comm-central/annotate/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/test/unit/data/export.vcf">annotate</a> |
<a href="/comm-central/diff/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/test/unit/data/export.vcf">diff</a> |
<a href="/comm-central/comparison/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/test/unit/data/export.vcf">comparison</a> |
<a href="/comm-central/log/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/test/unit/data/export.vcf">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/test/unit/test_nsIAbCard.js">mailnews/addrbook/test/unit/test_nsIAbCard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/test/unit/test_nsIAbCard.js">file</a> |
<a href="/comm-central/annotate/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/test/unit/test_nsIAbCard.js">annotate</a> |
<a href="/comm-central/diff/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/test/unit/test_nsIAbCard.js">diff</a> |
<a href="/comm-central/comparison/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/test/unit/test_nsIAbCard.js">comparison</a> |
<a href="/comm-central/log/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/test/unit/test_nsIAbCard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/test/unit/test_vCard.js">mailnews/addrbook/test/unit/test_vCard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/test/unit/test_vCard.js">file</a> |
<a href="/comm-central/annotate/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/test/unit/test_vCard.js">annotate</a> |
<a href="/comm-central/diff/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/test/unit/test_vCard.js">diff</a> |
<a href="/comm-central/comparison/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/test/unit/test_vCard.js">comparison</a> |
<a href="/comm-central/log/4cec8714f352fc0ac2b72e5820747c7a45e4fdcb/mailnews/addrbook/test/unit/test_vCard.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/addrbook/jsaddrbook/VCardUtils.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/addrbook/jsaddrbook/VCardUtils.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -8,108 +8,154 @@ const { ICAL } = ChromeUtils.import(&quot;res</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> /**</span>
<a href="#l1.6"></a><span id="l1.6">  * Utilities for working with vCard data. This file uses ICAL.js as parser and</span>
<a href="#l1.7"></a><span id="l1.7">  * formatter to avoid reinventing the wheel.</span>
<a href="#l1.8"></a><span id="l1.8">  * @see RFC 6350.</span>
<a href="#l1.9"></a><span id="l1.9">  */</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> var VCardUtils = {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  vCardToAbCard(vCard) {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-    let [, properties] = ICAL.parse(vCard);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-    let abCard = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;].createInstance(</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-      Ci.nsIAbCard</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-    );</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+  _parse(vProps) {</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+    let vPropMap = new Map();</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+    for (let index = 0; index &lt; vProps.length; index++) {</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+      let [name, params, , value] = vProps[index];</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+      // Work out which type in typeMap, if any, this property belongs to.</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-    for (let [name, params, , value] of properties) {</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-      if (name == &quot;uid&quot;) {</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-        abCard.UID = value;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-        continue;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-      }</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-      if (params.type) {</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-        if (Array.isArray(params.type)) {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-          params.type = params.type.map(t =&gt; t.toLowerCase());</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+      // To make the next piece easier, the type param must always be an array</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+      // of lower-case strings.</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+      let type = params.type || [];</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+      if (type) {</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+        if (Array.isArray(type)) {</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+          type = type.map(t =&gt; t.toLowerCase());</span>
<a href="#l1.38"></a><span id="l1.38">         } else {</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-          params.type = [params.type.toLowerCase()];</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+          type = [type.toLowerCase()];</span>
<a href="#l1.41"></a><span id="l1.41">         }</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-      } else {</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-        params.type = [];</span>
<a href="#l1.44"></a><span id="l1.44">       }</span>
<a href="#l1.45"></a><span id="l1.45"> </span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+      // Special cases for address and telephone types.</span>
<a href="#l1.47"></a><span id="l1.47">       if (name == &quot;adr&quot;) {</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-        name = params.type.includes(&quot;home&quot;) ? &quot;adr.home&quot; : &quot;adr.work&quot;;</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+        name = type.includes(&quot;home&quot;) ? &quot;adr.home&quot; : &quot;adr.work&quot;;</span>
<a href="#l1.50"></a><span id="l1.50">       }</span>
<a href="#l1.51"></a><span id="l1.51">       if (name == &quot;tel&quot;) {</span>
<a href="#l1.52"></a><span id="l1.52">         name = &quot;tel.work&quot;;</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-        for (let t of params.type) {</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+        for (let t of type) {</span>
<a href="#l1.55"></a><span id="l1.55">           if ([&quot;home&quot;, &quot;work&quot;, &quot;cell&quot;, &quot;pager&quot;, &quot;fax&quot;].includes(t)) {</span>
<a href="#l1.56"></a><span id="l1.56">             name = `tel.${t}`;</span>
<a href="#l1.57"></a><span id="l1.57">             break;</span>
<a href="#l1.58"></a><span id="l1.58">           }</span>
<a href="#l1.59"></a><span id="l1.59">         }</span>
<a href="#l1.60"></a><span id="l1.60">       }</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-      if (name in propertyMap) {</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-        for (let [abPropName, abPropValue] of Object.entries(</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-          propertyMap[name].toAbCard(value)</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-        )) {</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-          if (abPropValue) {</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-            abCard.setProperty(abPropName, abPropValue);</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-          }</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+      if (!(name in typeMap)) {</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+        continue;</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+      }</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+      // The preference param is 1-100, lower numbers indicate higher</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+      // preference. If not specified, the value is least preferred.</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+      let pref = parseInt(params.pref, 10) || 101;</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+      if (!vPropMap.has(name)) {</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+        vPropMap.set(name, []);</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+      }</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+      vPropMap.get(name).push({ index, pref, value });</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+    }</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+    for (let props of vPropMap.values()) {</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+      // Sort the properties by preference, or by the order they appeared.</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+      props.sort((a, b) =&gt; {</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+        if (a.pref == b.pref) {</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+          return a.index - b.index;</span>
<a href="#l1.88"></a><span id="l1.88">         }</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+        return a.pref - b.pref;</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+      });</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+    }</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+    return vPropMap;</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+  },</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+  vCardToAbCard(vCard) {</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+    let [, vProps] = ICAL.parse(vCard);</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+    let vPropMap = this._parse(vProps);</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+    let abCard = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;].createInstance(</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+      Ci.nsIAbCard</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+    );</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+    for (let [name, , , value] of vProps) {</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+      if (name == &quot;uid&quot;) {</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+        abCard.UID = value;</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+        break;</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+      }</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+    }</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+    for (let [name, props] of vPropMap) {</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+      // Store the value(s) on the abCard.</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+      for (let [abPropName, abPropValue] of typeMap[name].toAbCard(</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+        props[0].value</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+      )) {</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+        if (abPropValue) {</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+          abCard.setProperty(abPropName, abPropValue);</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+        }</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+      }</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+      // Special case for email, which can also have a second preference.</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+      if (name == &quot;email&quot; &amp;&amp; props.length &gt; 1) {</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+        abCard.setProperty(&quot;SecondEmail&quot;, props[1].value);</span>
<a href="#l1.120"></a><span id="l1.120">       }</span>
<a href="#l1.121"></a><span id="l1.121">     }</span>
<a href="#l1.122"></a><span id="l1.122">     return abCard;</span>
<a href="#l1.123"></a><span id="l1.123">   },</span>
<a href="#l1.124"></a><span id="l1.124">   modifyVCard(vCard, abCard) {</span>
<a href="#l1.125"></a><span id="l1.125">     let card = ICAL.parse(vCard);</span>
<a href="#l1.126"></a><span id="l1.126">     let [, vProps] = card;</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+    let vPropMap = this._parse(vProps);</span>
<a href="#l1.128"></a><span id="l1.128"> </span>
<a href="#l1.129"></a><span id="l1.129">     // Collect all of the AB card properties into a Map.</span>
<a href="#l1.130"></a><span id="l1.130">     let abProps = new Map();</span>
<a href="#l1.131"></a><span id="l1.131">     for (let abProp of abCard.properties) {</span>
<a href="#l1.132"></a><span id="l1.132">       if (abProp.value) {</span>
<a href="#l1.133"></a><span id="l1.133">         abProps.set(abProp.name, abProp.value);</span>
<a href="#l1.134"></a><span id="l1.134">       }</span>
<a href="#l1.135"></a><span id="l1.135">     }</span>
<a href="#l1.136"></a><span id="l1.136"> </span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-    // Collect all of the existing vCard properties into a Map.</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-    let indices = new Map();</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-    for (let i = 0; i &lt; vProps.length; i++) {</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-      let [vPropName, vPropParams] = vProps[i];</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-      if (vPropParams.type) {</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-        vPropName += `.${vPropParams.type}`;</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+    // Update the vCard.</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+    let indicesToRemove = [];</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+    for (let vPropName of Object.keys(typeMap)) {</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+      let existingVProps = vPropMap.get(vPropName) || [];</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+      let newVProps = [...typeMap[vPropName].fromAbCard(abProps)];</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+      if (newVProps.length == 0) {</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+        // Removed property, remove it.</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+        for (let existingVProp of existingVProps) {</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+          indicesToRemove.push(existingVProp.index);</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+        }</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+        continue;</span>
<a href="#l1.155"></a><span id="l1.155">       }</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-      indices.set(vPropName, i);</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+      for (let i = 0; i &lt; newVProps.length; i++) {</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+        let newValue = newVProps[i][3];</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+        if (existingVProps[i]) {</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+          if (newValue === undefined) {</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+            // Empty property, remove it.</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+            indicesToRemove.push(existingVProps[i].index);</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+          } else {</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+            // Existing property, update it.</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+            vProps[existingVProps[i].index][3] = newVProps[i][3];</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+          }</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+        } else if (newValue !== undefined) {</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+          // New property, add it.</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+          vProps.push(newVProps[i]);</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+        }</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+      }</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+      // There may be more existing properties than new properties, because we</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+      // haven't stored them. Don't truncate!</span>
<a href="#l1.176"></a><span id="l1.176">     }</span>
<a href="#l1.177"></a><span id="l1.177"> </span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-    // Update the vCard.</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-    for (let vPropName of Object.keys(propertyMap)) {</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-      let vProp = propertyMap[vPropName].fromAbCard(abProps);</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-      let index = indices.get(vPropName);</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-      if (vProp) {</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-        // The vCard might have the property, but with no type specified.</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-        // If it does, use that.</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-        if (index === undefined &amp;&amp; vPropName.includes(&quot;.&quot;)) {</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-          index = indices.get(vPropName.split(&quot;.&quot;)[0]);</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-          // Default to not specifying a type, where this applies.</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-          delete vProp[1].type;</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-        }</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineminus">-        if (index === undefined) {</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-          // New property, add it.</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-          vProps.push(vProp);</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineminus">-        } else {</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineminus">-          // Existing property, update it.</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-          vProps[index][3] = vProp[3];</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-        }</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-      } else if (index !== undefined) {</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineminus">-        // Removed property, remove it.</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineminus">-        vProps.splice(index, 1);</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-      }</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+    // Remove the props we don't want, from end to start to avoid changing indices.</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+    indicesToRemove.sort();</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+    for (let i = indicesToRemove.length - 1; i &gt;= 0; i--) {</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+      vProps.splice(indicesToRemove[i], 1);</span>
<a href="#l1.207"></a><span id="l1.207">     }</span>
<a href="#l1.208"></a><span id="l1.208"> </span>
<a href="#l1.209"></a><span id="l1.209">     // Always add a UID if there isn't one.</span>
<a href="#l1.210"></a><span id="l1.210">     if (vProps.findIndex(prop =&gt; prop[0] == &quot;uid&quot;) == -1) {</span>
<a href="#l1.211"></a><span id="l1.211">       vProps.push([&quot;uid&quot;, {}, &quot;text&quot;, abCard.UID]);</span>
<a href="#l1.212"></a><span id="l1.212">     }</span>
<a href="#l1.213"></a><span id="l1.213"> </span>
<a href="#l1.214"></a><span id="l1.214">     return ICAL.stringify(card);</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineat">@@ -121,20 +167,21 @@ var VCardUtils = {</span>
<a href="#l1.216"></a><span id="l1.216">     let abProps = new Map();</span>
<a href="#l1.217"></a><span id="l1.217">     for (let abProp of abCard.properties) {</span>
<a href="#l1.218"></a><span id="l1.218">       if (abProp.value) {</span>
<a href="#l1.219"></a><span id="l1.219">         abProps.set(abProp.name, abProp.value);</span>
<a href="#l1.220"></a><span id="l1.220">       }</span>
<a href="#l1.221"></a><span id="l1.221">     }</span>
<a href="#l1.222"></a><span id="l1.222"> </span>
<a href="#l1.223"></a><span id="l1.223">     // Add the properties to the vCard.</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">-    for (let vPropName of Object.keys(propertyMap)) {</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-      let vProp = propertyMap[vPropName].fromAbCard(abProps, vPropName);</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-      if (vProp) {</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-        vProps.push(vProp);</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+    for (let vPropName of Object.keys(typeMap)) {</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+      for (let vProp of typeMap[vPropName].fromAbCard(abProps, vPropName)) {</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+        if (vProp[3] !== undefined) {</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineplus">+          vProps.push(vProp);</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+        }</span>
<a href="#l1.233"></a><span id="l1.233">       }</span>
<a href="#l1.234"></a><span id="l1.234">     }</span>
<a href="#l1.235"></a><span id="l1.235"> </span>
<a href="#l1.236"></a><span id="l1.236">     // If there's only one address or telephone number, don't specify type.</span>
<a href="#l1.237"></a><span id="l1.237">     let adrProps = vProps.filter(p =&gt; p[0] == &quot;adr&quot;);</span>
<a href="#l1.238"></a><span id="l1.238">     if (adrProps.length == 1) {</span>
<a href="#l1.239"></a><span id="l1.239">       delete adrProps[0][1].type;</span>
<a href="#l1.240"></a><span id="l1.240">     }</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineat">@@ -211,128 +258,128 @@ VCardMimeConverter.prototype = {</span>
<a href="#l1.242"></a><span id="l1.242">             &lt;/td&gt;</span>
<a href="#l1.243"></a><span id="l1.243">           &lt;/tr&gt;</span>
<a href="#l1.244"></a><span id="l1.244">         &lt;/table&gt;</span>
<a href="#l1.245"></a><span id="l1.245">       &lt;/body&gt;</span>
<a href="#l1.246"></a><span id="l1.246">     &lt;/html&gt;`;</span>
<a href="#l1.247"></a><span id="l1.247">   },</span>
<a href="#l1.248"></a><span id="l1.248"> };</span>
<a href="#l1.249"></a><span id="l1.249"> </span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-/** Helper functions for propertyMap. */</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineplus">+/** Helper functions for typeMap. */</span>
<a href="#l1.252"></a><span id="l1.252"> </span>
<a href="#l1.253"></a><span id="l1.253"> function singleTextProperty(</span>
<a href="#l1.254"></a><span id="l1.254">   abPropName,</span>
<a href="#l1.255"></a><span id="l1.255">   vPropName,</span>
<a href="#l1.256"></a><span id="l1.256">   vPropParams = {},</span>
<a href="#l1.257"></a><span id="l1.257">   vPropType = &quot;text&quot;</span>
<a href="#l1.258"></a><span id="l1.258"> ) {</span>
<a href="#l1.259"></a><span id="l1.259">   return {</span>
<a href="#l1.260"></a><span id="l1.260">     /**</span>
<a href="#l1.261"></a><span id="l1.261">      * Formats nsIAbCard properties into an array for use by ICAL.js.</span>
<a href="#l1.262"></a><span id="l1.262">      *</span>
<a href="#l1.263"></a><span id="l1.263">      * @param {Map} map - A map of address book properties to map.</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineminus">-     * @return {?Array} - Values in a jCard array for use with ICAL.js.</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineplus">+     * @yields {Array} - Values in a jCard array for use with ICAL.js.</span>
<a href="#l1.266"></a><span id="l1.266">      */</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineminus">-    fromAbCard(map) {</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineminus">-      if (map.has(abPropName)) {</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineminus">-        return [vPropName, { ...vPropParams }, vPropType, map.get(abPropName)];</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineminus">-      }</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-      return null;</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineplus">+    *fromAbCard(map) {</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineplus">+      yield [vPropName, { ...vPropParams }, vPropType, map.get(abPropName)];</span>
<a href="#l1.274"></a><span id="l1.274">     },</span>
<a href="#l1.275"></a><span id="l1.275">     /**</span>
<a href="#l1.276"></a><span id="l1.276">      * Parses a vCard value into properties usable by nsIAbCard.</span>
<a href="#l1.277"></a><span id="l1.277">      *</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineminus">-     * @param {string} value - vCard string to map to an address book card property.</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineminus">-     * @return {Object} - A dictionary of address book properties.</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineplus">+     * @param {String} value - vCard string to map to an address book card property.</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineplus">+     * @yields {String[]} - Any number of key, value pairs to set on the nsIAbCard.</span>
<a href="#l1.282"></a><span id="l1.282">      */</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineminus">-    toAbCard(value) {</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineplus">+    *toAbCard(value) {</span>
<a href="#l1.285"></a><span id="l1.285">       if (typeof value != &quot;string&quot;) {</span>
<a href="#l1.286"></a><span id="l1.286">         console.warn(`Unexpected value for ${vPropName}: ${value}`);</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineminus">-        return {};</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineplus">+        return;</span>
<a href="#l1.289"></a><span id="l1.289">       }</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineminus">-      return { [abPropName]: value };</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineplus">+      yield [abPropName, value];</span>
<a href="#l1.292"></a><span id="l1.292">     },</span>
<a href="#l1.293"></a><span id="l1.293">   };</span>
<a href="#l1.294"></a><span id="l1.294"> }</span>
<a href="#l1.295"></a><span id="l1.295"> function dateProperty(abCardPrefix, vPropName) {</span>
<a href="#l1.296"></a><span id="l1.296">   return {</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineminus">-    fromAbCard(map) {</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineplus">+    *fromAbCard(map) {</span>
<a href="#l1.299"></a><span id="l1.299">       if (</span>
<a href="#l1.300"></a><span id="l1.300">         !map.has(`${abCardPrefix}Year`) ||</span>
<a href="#l1.301"></a><span id="l1.301">         !map.has(`${abCardPrefix}Month`) ||</span>
<a href="#l1.302"></a><span id="l1.302">         !map.has(`${abCardPrefix}Day`)</span>
<a href="#l1.303"></a><span id="l1.303">       ) {</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineminus">-        return null;</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineplus">+        return;</span>
<a href="#l1.306"></a><span id="l1.306">       }</span>
<a href="#l1.307"></a><span id="l1.307">       let dateValue = new ICAL.VCardTime(</span>
<a href="#l1.308"></a><span id="l1.308">         {</span>
<a href="#l1.309"></a><span id="l1.309">           year: Number(map.get(`${abCardPrefix}Year`)),</span>
<a href="#l1.310"></a><span id="l1.310">           month: Number(map.get(`${abCardPrefix}Month`)),</span>
<a href="#l1.311"></a><span id="l1.311">           day: Number(map.get(`${abCardPrefix}Day`)),</span>
<a href="#l1.312"></a><span id="l1.312">         },</span>
<a href="#l1.313"></a><span id="l1.313">         null,</span>
<a href="#l1.314"></a><span id="l1.314">         &quot;date&quot;</span>
<a href="#l1.315"></a><span id="l1.315">       );</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineminus">-      return [vPropName, {}, &quot;date&quot;, dateValue.toString()];</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineplus">+      yield [vPropName, {}, &quot;date&quot;, dateValue.toString()];</span>
<a href="#l1.318"></a><span id="l1.318">     },</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineminus">-    toAbCard(value) {</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineplus">+    *toAbCard(value) {</span>
<a href="#l1.321"></a><span id="l1.321">       let dateValue = new Date(value);</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineminus">-      return {</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineminus">-        [`${abCardPrefix}Year`]: String(dateValue.getFullYear()),</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineminus">-        [`${abCardPrefix}Month`]: String(dateValue.getMonth() + 1),</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineminus">-        [`${abCardPrefix}Day`]: String(dateValue.getDate()),</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineminus">-      };</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineplus">+      yield [`${abCardPrefix}Year`, String(dateValue.getFullYear())];</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineplus">+      yield [`${abCardPrefix}Month`, String(dateValue.getMonth() + 1)];</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineplus">+      yield [`${abCardPrefix}Day`, String(dateValue.getDate())];</span>
<a href="#l1.330"></a><span id="l1.330">     },</span>
<a href="#l1.331"></a><span id="l1.331">   };</span>
<a href="#l1.332"></a><span id="l1.332"> }</span>
<a href="#l1.333"></a><span id="l1.333"> function multiTextProperty(abPropNames, vPropName, vPropParams = {}) {</span>
<a href="#l1.334"></a><span id="l1.334">   return {</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineminus">-    fromAbCard(map) {</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineplus">+    *fromAbCard(map) {</span>
<a href="#l1.337"></a><span id="l1.337">       if (abPropNames.every(name =&gt; !map.has(name))) {</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineminus">-        return null;</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineplus">+        return;</span>
<a href="#l1.340"></a><span id="l1.340">       }</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineminus">-      return [</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineplus">+      yield [</span>
<a href="#l1.343"></a><span id="l1.343">         vPropName,</span>
<a href="#l1.344"></a><span id="l1.344">         { ...vPropParams },</span>
<a href="#l1.345"></a><span id="l1.345">         &quot;text&quot;,</span>
<a href="#l1.346"></a><span id="l1.346">         abPropNames.map(name =&gt; map.get(name) || &quot;&quot;),</span>
<a href="#l1.347"></a><span id="l1.347">       ];</span>
<a href="#l1.348"></a><span id="l1.348">     },</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineminus">-    toAbCard(value) {</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineminus">-      let result = {};</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineplus">+    *toAbCard(value) {</span>
<a href="#l1.352"></a><span id="l1.352">       if (Array.isArray(value)) {</span>
<a href="#l1.353"></a><span id="l1.353">         for (let abPropName of abPropNames) {</span>
<a href="#l1.354"></a><span id="l1.354">           let valuePart = value.shift();</span>
<a href="#l1.355"></a><span id="l1.355">           if (abPropName &amp;&amp; valuePart) {</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineminus">-            result[abPropName] = valuePart;</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineplus">+            yield [abPropName, valuePart];</span>
<a href="#l1.358"></a><span id="l1.358">           }</span>
<a href="#l1.359"></a><span id="l1.359">         }</span>
<a href="#l1.360"></a><span id="l1.360">       } else if (typeof value == &quot;string&quot;) {</span>
<a href="#l1.361"></a><span id="l1.361">         // Only one value was given.</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineminus">-        result[abPropNames[0]] = value;</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineplus">+        yield [abPropNames[0], value];</span>
<a href="#l1.364"></a><span id="l1.364">       } else {</span>
<a href="#l1.365"></a><span id="l1.365">         console.warn(`Unexpected value for ${vPropName}: ${value}`);</span>
<a href="#l1.366"></a><span id="l1.366">       }</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineminus">-      return result;</span>
<a href="#l1.368"></a><span id="l1.368">     },</span>
<a href="#l1.369"></a><span id="l1.369">   };</span>
<a href="#l1.370"></a><span id="l1.370"> }</span>
<a href="#l1.371"></a><span id="l1.371"> </span>
<a href="#l1.372"></a><span id="l1.372"> /**</span>
<a href="#l1.373"></a><span id="l1.373">  * Properties we support for conversion between nsIAbCard and vCard.</span>
<a href="#l1.374"></a><span id="l1.374">  *</span>
<a href="#l1.375"></a><span id="l1.375">  * Keys correspond to vCard property keys, with the type appended where more</span>
<a href="#l1.376"></a><span id="l1.376">  * than one type is supported (e.g. work and home).</span>
<a href="#l1.377"></a><span id="l1.377">  *</span>
<a href="#l1.378"></a><span id="l1.378">  * Values are objects with toAbCard and fromAbCard functions which convert</span>
<a href="#l1.379"></a><span id="l1.379">  * property values in each direction. See the docs on the object returned by</span>
<a href="#l1.380"></a><span id="l1.380">  * singleTextProperty.</span>
<a href="#l1.381"></a><span id="l1.381">  */</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineminus">-var propertyMap = {</span>
<a href="#l1.383"></a><span id="l1.383" class="difflineminus">-  email: singleTextProperty(&quot;PrimaryEmail&quot;, &quot;email&quot;),</span>
<a href="#l1.384"></a><span id="l1.384" class="difflineplus">+var typeMap = {</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineplus">+  email: {</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineplus">+    *fromAbCard(map) {</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineplus">+      yield [&quot;email&quot;, { pref: &quot;1&quot; }, &quot;text&quot;, map.get(&quot;PrimaryEmail&quot;)];</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineplus">+      yield [&quot;email&quot;, {}, &quot;text&quot;, map.get(&quot;SecondEmail&quot;)];</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineplus">+    },</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineplus">+    toAbCard: singleTextProperty(&quot;PrimaryEmail&quot;, &quot;email&quot;, { pref: &quot;1&quot; })</span>
<a href="#l1.391"></a><span id="l1.391" class="difflineplus">+      .toAbCard,</span>
<a href="#l1.392"></a><span id="l1.392" class="difflineplus">+  },</span>
<a href="#l1.393"></a><span id="l1.393">   fn: singleTextProperty(&quot;DisplayName&quot;, &quot;fn&quot;),</span>
<a href="#l1.394"></a><span id="l1.394">   nickname: singleTextProperty(&quot;NickName&quot;, &quot;nickname&quot;),</span>
<a href="#l1.395"></a><span id="l1.395">   note: singleTextProperty(&quot;Notes&quot;, &quot;note&quot;),</span>
<a href="#l1.396"></a><span id="l1.396">   org: multiTextProperty([&quot;Company&quot;, &quot;Department&quot;], &quot;org&quot;),</span>
<a href="#l1.397"></a><span id="l1.397">   title: singleTextProperty(&quot;JobTitle&quot;, &quot;title&quot;),</span>
<a href="#l1.398"></a><span id="l1.398">   bday: dateProperty(&quot;Birth&quot;, &quot;bday&quot;),</span>
<a href="#l1.399"></a><span id="l1.399">   anniversary: dateProperty(&quot;Anniversary&quot;, &quot;anniversary&quot;),</span>
<a href="#l1.400"></a><span id="l1.400">   n: multiTextProperty([&quot;LastName&quot;, &quot;FirstName&quot;, null, null, null], &quot;n&quot;),</span>
<a href="#l1.401"></a><span id="l1.401" class="difflineat">@@ -364,26 +411,27 @@ var propertyMap = {</span>
<a href="#l1.402"></a><span id="l1.402">   ),</span>
<a href="#l1.403"></a><span id="l1.403">   &quot;tel.home&quot;: singleTextProperty(&quot;HomePhone&quot;, &quot;tel&quot;, { type: &quot;home&quot; }),</span>
<a href="#l1.404"></a><span id="l1.404">   &quot;tel.work&quot;: singleTextProperty(&quot;WorkPhone&quot;, &quot;tel&quot;, { type: &quot;work&quot; }),</span>
<a href="#l1.405"></a><span id="l1.405">   &quot;tel.fax&quot;: singleTextProperty(&quot;FaxNumber&quot;, &quot;tel&quot;, { type: &quot;fax&quot; }),</span>
<a href="#l1.406"></a><span id="l1.406">   &quot;tel.pager&quot;: singleTextProperty(&quot;PagerNumber&quot;, &quot;tel&quot;, { type: &quot;pager&quot; }),</span>
<a href="#l1.407"></a><span id="l1.407">   &quot;tel.cell&quot;: singleTextProperty(&quot;CellularNumber&quot;, &quot;tel&quot;, { type: &quot;cell&quot; }),</span>
<a href="#l1.408"></a><span id="l1.408">   url: singleTextProperty(&quot;WebPage1&quot;, &quot;url&quot;, {}, &quot;url&quot;),</span>
<a href="#l1.409"></a><span id="l1.409">   &quot;x-mozilla-html&quot;: {</span>
<a href="#l1.410"></a><span id="l1.410" class="difflineminus">-    fromAbCard(map) {</span>
<a href="#l1.411"></a><span id="l1.411" class="difflineplus">+    *fromAbCard(map) {</span>
<a href="#l1.412"></a><span id="l1.412">       switch (map.get(&quot;PreferMailFormat&quot;)) {</span>
<a href="#l1.413"></a><span id="l1.413">         case Ci.nsIAbPreferMailFormat.html:</span>
<a href="#l1.414"></a><span id="l1.414" class="difflineminus">-          return [&quot;x-mozilla-html&quot;, {}, &quot;boolean&quot;, true];</span>
<a href="#l1.415"></a><span id="l1.415" class="difflineplus">+          yield [&quot;x-mozilla-html&quot;, {}, &quot;boolean&quot;, true];</span>
<a href="#l1.416"></a><span id="l1.416" class="difflineplus">+          break;</span>
<a href="#l1.417"></a><span id="l1.417">         case Ci.nsIAbPreferMailFormat.plaintext:</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineminus">-          return [&quot;x-mozilla-html&quot;, {}, &quot;boolean&quot;, false];</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineplus">+          yield [&quot;x-mozilla-html&quot;, {}, &quot;boolean&quot;, false];</span>
<a href="#l1.420"></a><span id="l1.420" class="difflineplus">+          break;</span>
<a href="#l1.421"></a><span id="l1.421">       }</span>
<a href="#l1.422"></a><span id="l1.422" class="difflineminus">-      return null;</span>
<a href="#l1.423"></a><span id="l1.423">     },</span>
<a href="#l1.424"></a><span id="l1.424" class="difflineminus">-    toAbCard(value) {</span>
<a href="#l1.425"></a><span id="l1.425" class="difflineplus">+    *toAbCard(value) {</span>
<a href="#l1.426"></a><span id="l1.426">       if (typeof value != &quot;boolean&quot;) {</span>
<a href="#l1.427"></a><span id="l1.427">         console.warn(`Unexpected value for x-mozilla-html: ${value}`);</span>
<a href="#l1.428"></a><span id="l1.428" class="difflineminus">-        return {};</span>
<a href="#l1.429"></a><span id="l1.429" class="difflineplus">+        return;</span>
<a href="#l1.430"></a><span id="l1.430">       }</span>
<a href="#l1.431"></a><span id="l1.431" class="difflineminus">-      return { PreferMailFormat: value };</span>
<a href="#l1.432"></a><span id="l1.432" class="difflineplus">+      yield [&quot;PreferMailFormat&quot;, value];</span>
<a href="#l1.433"></a><span id="l1.433">     },</span>
<a href="#l1.434"></a><span id="l1.434">   },</span>
<a href="#l1.435"></a><span id="l1.435"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/data/export.vcf</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/data/export.vcf</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l2.4"></a><span id="l2.4"> BEGIN:VCARD</span>
<a href="#l2.5"></a><span id="l2.5"> VERSION:4.0</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineminus">-EMAIL:contact1@invalid</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+EMAIL;PREF=1:contact1@invalid</span>
<a href="#l2.8"></a><span id="l2.8"> FN:contact number one</span>
<a href="#l2.9"></a><span id="l2.9"> N:one;contact;;;</span>
<a href="#l2.10"></a><span id="l2.10"> UID:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</span>
<a href="#l2.11"></a><span id="l2.11"> END:VCARD</span>
<a href="#l2.12"></a><span id="l2.12"> BEGIN:VCARD</span>
<a href="#l2.13"></a><span id="l2.13"> VERSION:4.0</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-EMAIL:contact2@invalid</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+EMAIL;PREF=1:contact2@invalid</span>
<a href="#l2.16"></a><span id="l2.16"> FN:contact number two</span>
<a href="#l2.17"></a><span id="l2.17"> NOTE:here's some unicode text…</span>
<a href="#l2.18"></a><span id="l2.18"> TITLE:&quot;worker&quot;</span>
<a href="#l2.19"></a><span id="l2.19"> N:two;contact;;;</span>
<a href="#l2.20"></a><span id="l2.20"> UID:yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy</span>
<a href="#l2.21"></a><span id="l2.21"> END:VCARD</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsIAbCard.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsIAbCard.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -30,17 +30,17 @@ function run_test() {</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5">   let actual = fullCard.translateTo(&quot;vcard&quot;);</span>
<a href="#l3.6"></a><span id="l3.6">   Assert.ok(actual.startsWith(&quot;BEGIN%3AVCARD%0D%0A&quot;));</span>
<a href="#l3.7"></a><span id="l3.7">   Assert.ok(actual.endsWith(&quot;%0D%0AEND%3AVCARD%0D%0A&quot;));</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9">   let lines = decodeURIComponent(actual).split(&quot;\r\n&quot;);</span>
<a href="#l3.10"></a><span id="l3.10">   // The theory, the lines of the vCard are valid in any order, so just check</span>
<a href="#l3.11"></a><span id="l3.11">   // that they exist. In practice they are in this order.</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  Assert.ok(lines.includes(&quot;EMAIL:PrimaryEmail1@test.invalid&quot;), &quot;EMAIL&quot;);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  Assert.ok(lines.includes(&quot;EMAIL;PREF=1:PrimaryEmail1@test.invalid&quot;), &quot;EMAIL&quot;);</span>
<a href="#l3.14"></a><span id="l3.14">   Assert.ok(lines.includes(&quot;FN:DisplayName1&quot;), &quot;FN&quot;);</span>
<a href="#l3.15"></a><span id="l3.15">   Assert.ok(lines.includes(&quot;NICKNAME:NickName1&quot;), &quot;NICKNAME&quot;);</span>
<a href="#l3.16"></a><span id="l3.16">   Assert.ok(lines.includes(&quot;NOTE:Notes1&quot;), &quot;NOTE&quot;);</span>
<a href="#l3.17"></a><span id="l3.17">   Assert.ok(lines.includes(&quot;ORG:Organization1;Department1&quot;), &quot;ORG&quot;);</span>
<a href="#l3.18"></a><span id="l3.18">   Assert.ok(lines.includes(&quot;TITLE:JobTitle1&quot;), &quot;TITLE&quot;);</span>
<a href="#l3.19"></a><span id="l3.19">   Assert.ok(lines.includes(&quot;N:LastName1;FirstName1;;;&quot;), &quot;N&quot;);</span>
<a href="#l3.20"></a><span id="l3.20">   // These two lines wrap. If the wrapping width changes, this test will break.</span>
<a href="#l3.21"></a><span id="l3.21">   Assert.ok(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_vCard.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_vCard.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -32,16 +32,17 @@ add_task(function testVCardToAbCard() {</span>
<a href="#l4.4"></a><span id="l4.4">       ok(false, `expected ${name} not found`);</span>
<a href="#l4.5"></a><span id="l4.5">     }</span>
<a href="#l4.6"></a><span id="l4.6">   }</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8">   // UID</span>
<a href="#l4.9"></a><span id="l4.9">   check(&quot;UID:12345678-1234-1234-1234-123456789012&quot;, {</span>
<a href="#l4.10"></a><span id="l4.10">     UID: &quot;12345678-1234-1234-1234-123456789012&quot;,</span>
<a href="#l4.11"></a><span id="l4.11">   });</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+</span>
<a href="#l4.13"></a><span id="l4.13">   // Name</span>
<a href="#l4.14"></a><span id="l4.14">   check(&quot;N:Last;First;Middle;Prefix;Suffix&quot;, {</span>
<a href="#l4.15"></a><span id="l4.15">     FirstName: &quot;First&quot;,</span>
<a href="#l4.16"></a><span id="l4.16">     LastName: &quot;Last&quot;,</span>
<a href="#l4.17"></a><span id="l4.17">   });</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19">   // Address</span>
<a href="#l4.20"></a><span id="l4.20">   check(&quot;ADR:;;123 Main Street;Any Town;CA;91921-1234;U.S.A.&quot;, {</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -60,16 +61,17 @@ add_task(function testVCardToAbCard() {</span>
<a href="#l4.22"></a><span id="l4.22">   });</span>
<a href="#l4.23"></a><span id="l4.23">   check(&quot;ADR;TYPE=home:;;123 Main Street;Any Town;CA;91921-1234;U.S.A.&quot;, {</span>
<a href="#l4.24"></a><span id="l4.24">     HomeAddress: &quot;123 Main Street&quot;,</span>
<a href="#l4.25"></a><span id="l4.25">     HomeCity: &quot;Any Town&quot;,</span>
<a href="#l4.26"></a><span id="l4.26">     HomeState: &quot;CA&quot;,</span>
<a href="#l4.27"></a><span id="l4.27">     HomeZipCode: &quot;91921-1234&quot;,</span>
<a href="#l4.28"></a><span id="l4.28">     HomeCountry: &quot;U.S.A.&quot;,</span>
<a href="#l4.29"></a><span id="l4.29">   });</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+</span>
<a href="#l4.31"></a><span id="l4.31">   // Phone</span>
<a href="#l4.32"></a><span id="l4.32">   check(&quot;TEL:11-2358-13-21&quot;, { WorkPhone: &quot;11-2358-13-21&quot; });</span>
<a href="#l4.33"></a><span id="l4.33">   check(&quot;TEL;TYPE=work:11-2358-13-21&quot;, { WorkPhone: &quot;11-2358-13-21&quot; });</span>
<a href="#l4.34"></a><span id="l4.34">   check(&quot;TEL;TYPE=home:11-2358-13-21&quot;, { HomePhone: &quot;11-2358-13-21&quot; });</span>
<a href="#l4.35"></a><span id="l4.35">   check(&quot;TEL;TYPE=cell:11-2358-13-21&quot;, { CellularNumber: &quot;11-2358-13-21&quot; });</span>
<a href="#l4.36"></a><span id="l4.36">   check(&quot;TEL;TYPE=pager:11-2358-13-21&quot;, { PagerNumber: &quot;11-2358-13-21&quot; });</span>
<a href="#l4.37"></a><span id="l4.37">   check(&quot;TEL;TYPE=fax:11-2358-13-21&quot;, { FaxNumber: &quot;11-2358-13-21&quot; });</span>
<a href="#l4.38"></a><span id="l4.38"> </span>
<a href="#l4.39"></a><span id="l4.39" class="difflineat">@@ -86,22 +88,33 @@ add_task(function testVCardToAbCard() {</span>
<a href="#l4.40"></a><span id="l4.40">   });</span>
<a href="#l4.41"></a><span id="l4.41">   check(</span>
<a href="#l4.42"></a><span id="l4.42">     &quot;TEL;TYPE=work;VALUE=TEXT:11-2358-13-21\r\nTEL;TYPE=home;VALUE=TEXT:011-2358-13-21&quot;,</span>
<a href="#l4.43"></a><span id="l4.43">     {</span>
<a href="#l4.44"></a><span id="l4.44">       WorkPhone: &quot;11-2358-13-21&quot;,</span>
<a href="#l4.45"></a><span id="l4.45">       HomePhone: &quot;011-2358-13-21&quot;,</span>
<a href="#l4.46"></a><span id="l4.46">     }</span>
<a href="#l4.47"></a><span id="l4.47">   );</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+  check(&quot;TEL;TYPE=cell:11-2358-13-21\r\nTEL;TYPE=cell:011-2358-13-21&quot;, {</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+    CellularNumber: &quot;11-2358-13-21&quot;,</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+  });</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+  check(&quot;TEL;TYPE=cell;PREF=1:11-2358-13-21\r\nTEL;TYPE=cell:011-2358-13-21&quot;, {</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+    CellularNumber: &quot;11-2358-13-21&quot;,</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+  });</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+  check(&quot;TEL;TYPE=cell:11-2358-13-21\r\nTEL;TYPE=cell;PREF=1:011-2358-13-21&quot;, {</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+    CellularNumber: &quot;011-2358-13-21&quot;,</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+  });</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+</span>
<a href="#l4.58"></a><span id="l4.58">   // Birthday</span>
<a href="#l4.59"></a><span id="l4.59">   check(&quot;BDAY;VALUE=DATE:19830403&quot;, {</span>
<a href="#l4.60"></a><span id="l4.60">     BirthDay: &quot;3&quot;,</span>
<a href="#l4.61"></a><span id="l4.61">     BirthMonth: &quot;4&quot;,</span>
<a href="#l4.62"></a><span id="l4.62">     BirthYear: &quot;1983&quot;,</span>
<a href="#l4.63"></a><span id="l4.63">   });</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+</span>
<a href="#l4.65"></a><span id="l4.65">   // Anniversary</span>
<a href="#l4.66"></a><span id="l4.66">   check(&quot;ANNIVERSARY;VALUE=DATE:20041207&quot;, {</span>
<a href="#l4.67"></a><span id="l4.67">     AnniversaryDay: &quot;7&quot;,</span>
<a href="#l4.68"></a><span id="l4.68">     AnniversaryMonth: &quot;12&quot;,</span>
<a href="#l4.69"></a><span id="l4.69">     AnniversaryYear: &quot;2004&quot;,</span>
<a href="#l4.70"></a><span id="l4.70">   });</span>
<a href="#l4.71"></a><span id="l4.71"> </span>
<a href="#l4.72"></a><span id="l4.72">   // Organization: any number of values is valid here.</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineat">@@ -111,25 +124,91 @@ add_task(function testVCardToAbCard() {</span>
<a href="#l4.74"></a><span id="l4.74">   check(&quot;ORG:Acme Widgets, Inc.;Manufacturing&quot;, {</span>
<a href="#l4.75"></a><span id="l4.75">     Company: &quot;Acme Widgets, Inc.&quot;,</span>
<a href="#l4.76"></a><span id="l4.76">     Department: &quot;Manufacturing&quot;,</span>
<a href="#l4.77"></a><span id="l4.77">   });</span>
<a href="#l4.78"></a><span id="l4.78">   check(&quot;ORG:Acme Widgets, Inc.;Manufacturing;Thingamies&quot;, {</span>
<a href="#l4.79"></a><span id="l4.79">     Company: &quot;Acme Widgets, Inc.&quot;,</span>
<a href="#l4.80"></a><span id="l4.80">     Department: &quot;Manufacturing&quot;,</span>
<a href="#l4.81"></a><span id="l4.81">   });</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+  // Email: just to be difficult, email is stored by priority, not type.</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+  check(&quot;EMAIL:first@invalid&quot;, { PrimaryEmail: &quot;first@invalid&quot; });</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+  check(&quot;EMAIL;PREF=1:first@invalid&quot;, { PrimaryEmail: &quot;first@invalid&quot; });</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+  check(&quot;EMAIL;PREF=1:first@invalid\r\nEMAIL:second@invalid&quot;, {</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+    PrimaryEmail: &quot;first@invalid&quot;,</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+    SecondEmail: &quot;second@invalid&quot;,</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+  });</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+  check(&quot;EMAIL:second@invalid\r\nEMAIL;PREF=1:first@invalid&quot;, {</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+    PrimaryEmail: &quot;first@invalid&quot;,</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+    SecondEmail: &quot;second@invalid&quot;,</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+  });</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+  check(&quot;EMAIL;PREF=1:first@invalid\r\nEMAIL;PREF=2:second@invalid&quot;, {</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+    PrimaryEmail: &quot;first@invalid&quot;,</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+    SecondEmail: &quot;second@invalid&quot;,</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+  });</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+  check(&quot;EMAIL;PREF=2:second@invalid\r\nEMAIL;PREF=1:first@invalid&quot;, {</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+    PrimaryEmail: &quot;first@invalid&quot;,</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+    SecondEmail: &quot;second@invalid&quot;,</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+  });</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+  check(</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+    &quot;EMAIL;PREF=1:first@invalid\r\nEMAIL;PREF=2:second@invalid\r\nEMAIL;PREF=3:third@invalid&quot;,</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+    {</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+      PrimaryEmail: &quot;first@invalid&quot;,</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+      SecondEmail: &quot;second@invalid&quot;,</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+    }</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+  );</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+  check(</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+    &quot;EMAIL;PREF=2:second@invalid\r\nEMAIL;PREF=3:third@invalid\r\nEMAIL;PREF=1:first@invalid&quot;,</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+    {</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+      PrimaryEmail: &quot;first@invalid&quot;,</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+      SecondEmail: &quot;second@invalid&quot;,</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+    }</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+  );</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+  check(</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+    &quot;EMAIL;PREF=3:third@invalid\r\nEMAIL;PREF=1:first@invalid\r\nEMAIL;PREF=2:second@invalid&quot;,</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+    {</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+      PrimaryEmail: &quot;first@invalid&quot;,</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+      SecondEmail: &quot;second@invalid&quot;,</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+    }</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+  );</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+  check(</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+    &quot;EMAIL;PREF=3:third@invalid\r\nEMAIL;PREF=2:second@invalid\r\nEMAIL;PREF=1:first@invalid&quot;,</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+    {</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+      PrimaryEmail: &quot;first@invalid&quot;,</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+      SecondEmail: &quot;second@invalid&quot;,</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+    }</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+  );</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+  check(</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+    &quot;EMAIL;PREF=2:second@invalid\r\nEMAIL;PREF=1:first@invalid\r\nEMAIL;PREF=3:third@invalid&quot;,</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+    {</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+      PrimaryEmail: &quot;first@invalid&quot;,</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+      SecondEmail: &quot;second@invalid&quot;,</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+    }</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+  );</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+  check(</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+    &quot;EMAIL;PREF=1:first@invalid\r\nEMAIL;PREF=3:third@invalid\r\nEMAIL;PREF=2:second@invalid&quot;,</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+    {</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+      PrimaryEmail: &quot;first@invalid&quot;,</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+      SecondEmail: &quot;second@invalid&quot;,</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+    }</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+  );</span>
<a href="#l4.147"></a><span id="l4.147"> });</span>
<a href="#l4.148"></a><span id="l4.148"> </span>
<a href="#l4.149"></a><span id="l4.149"> add_task(function testModifyVCard() {</span>
<a href="#l4.150"></a><span id="l4.150">   function check(</span>
<a href="#l4.151"></a><span id="l4.151">     inVCard,</span>
<a href="#l4.152"></a><span id="l4.152">     newProps,</span>
<a href="#l4.153"></a><span id="l4.153">     expectedLines = [],</span>
<a href="#l4.154"></a><span id="l4.154">     unexpectedPrefixes = []</span>
<a href="#l4.155"></a><span id="l4.155">   ) {</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+    inVCard = `BEGIN:VCARD\r\n${inVCard}\r\nEND:VCARD\r\n`;</span>
<a href="#l4.157"></a><span id="l4.157">     let abCard = VCardUtils.vCardToAbCard(inVCard);</span>
<a href="#l4.158"></a><span id="l4.158">     for (let [name, value] of Object.entries(newProps)) {</span>
<a href="#l4.159"></a><span id="l4.159">       if (value === null) {</span>
<a href="#l4.160"></a><span id="l4.160">         abCard.deleteProperty(name);</span>
<a href="#l4.161"></a><span id="l4.161">       } else {</span>
<a href="#l4.162"></a><span id="l4.162">         abCard.setProperty(name, value);</span>
<a href="#l4.163"></a><span id="l4.163">       }</span>
<a href="#l4.164"></a><span id="l4.164">     }</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineat">@@ -169,115 +248,179 @@ add_task(function testModifyVCard() {</span>
<a href="#l4.166"></a><span id="l4.166"> </span>
<a href="#l4.167"></a><span id="l4.167">     // Check that all expected lines are in `outVCard`.</span>
<a href="#l4.168"></a><span id="l4.168">     for (let [prefix, count] of Object.entries(lineCounts)) {</span>
<a href="#l4.169"></a><span id="l4.169">       equal(count, 0, `${count} ${prefix} lines remain`);</span>
<a href="#l4.170"></a><span id="l4.170">     }</span>
<a href="#l4.171"></a><span id="l4.171">   }</span>
<a href="#l4.172"></a><span id="l4.172"> </span>
<a href="#l4.173"></a><span id="l4.173">   // Empty card, no modifications.</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-  check(</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-    formatVCard`</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-      BEGIN:VCARD</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-      END:VCARD`,</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineminus">-    {},</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineminus">-    [ANY_UID]</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-  );</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+  check(&quot;&quot;, {}, [ANY_UID]);</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+</span>
<a href="#l4.183"></a><span id="l4.183">   // Card with UID, no modifications.</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineminus">-  check(</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineminus">-    formatVCard`</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineminus">-      BEGIN:VCARD</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineminus">-      UID:12345678-1234-1234-1234-123456789012</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineminus">-      END:VCARD`,</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineminus">-    {},</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineminus">-    [&quot;UID:12345678-1234-1234-1234-123456789012&quot;]</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineminus">-  );</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+  check(&quot;UID:12345678-1234-1234-1234-123456789012&quot;, {}, [</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+    &quot;UID:12345678-1234-1234-1234-123456789012&quot;,</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+  ]);</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+</span>
<a href="#l4.196"></a><span id="l4.196">   // Display name changed, notes removed, UID unchanged.</span>
<a href="#l4.197"></a><span id="l4.197">   check(</span>
<a href="#l4.198"></a><span id="l4.198">     formatVCard`</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-      BEGIN:VCARD</span>
<a href="#l4.200"></a><span id="l4.200">       FN:Original Full Name</span>
<a href="#l4.201"></a><span id="l4.201">       NOTE:This property will be removed.</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineminus">-      UID:12345678-1234-1234-1234-123456789012</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineminus">-      END:VCARD`,</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+      UID:12345678-1234-1234-1234-123456789012`,</span>
<a href="#l4.205"></a><span id="l4.205">     {</span>
<a href="#l4.206"></a><span id="l4.206">       DisplayName: &quot;New Full Name&quot;,</span>
<a href="#l4.207"></a><span id="l4.207">       Notes: null,</span>
<a href="#l4.208"></a><span id="l4.208">     },</span>
<a href="#l4.209"></a><span id="l4.209">     [&quot;FN:New Full Name&quot;, &quot;UID:12345678-1234-1234-1234-123456789012&quot;],</span>
<a href="#l4.210"></a><span id="l4.210">     [&quot;NOTE&quot;]</span>
<a href="#l4.211"></a><span id="l4.211">   );</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-  // Last name changed.</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+  // Notes removed, URL removed. This ensures we don't remove the wrong properties.</span>
<a href="#l4.215"></a><span id="l4.215">   check(</span>
<a href="#l4.216"></a><span id="l4.216">     formatVCard`</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-      BEGIN:VCARD</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-      N:Last;First;;;</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-      END:VCARD`,</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+      FN:Original Full Name</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+      NOTE:This property will be removed.</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+      UID:12345678-1234-1234-1234-123456789012</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+      URL:http://www.thunderbird.net/</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+      ORG:Thunderbird;Address Book`,</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+    {</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+      Notes: null,</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+      WebPage1: null,</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+    },</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+    [</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+      &quot;FN:Original Full Name&quot;,</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+      &quot;UID:12345678-1234-1234-1234-123456789012&quot;,</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+      &quot;ORG:Thunderbird;Address Book&quot;,</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+    ],</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+    [&quot;NOTE&quot;, &quot;URL&quot;]</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+  );</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+  // Last name changed.</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+  check(</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+    &quot;N:Last;First;;;&quot;,</span>
<a href="#l4.240"></a><span id="l4.240">     {</span>
<a href="#l4.241"></a><span id="l4.241">       LastName: &quot;Changed&quot;,</span>
<a href="#l4.242"></a><span id="l4.242">     },</span>
<a href="#l4.243"></a><span id="l4.243">     [&quot;N:Changed;First;;;&quot;, ANY_UID]</span>
<a href="#l4.244"></a><span id="l4.244">   );</span>
<a href="#l4.245"></a><span id="l4.245">   // First and last name changed.</span>
<a href="#l4.246"></a><span id="l4.246">   check(</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineminus">-    formatVCard`</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineminus">-      BEGIN:VCARD</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineminus">-      N:Last;First;;;</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineminus">-      END:VCARD`,</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+    &quot;N:Last;First;;;&quot;,</span>
<a href="#l4.252"></a><span id="l4.252">     {</span>
<a href="#l4.253"></a><span id="l4.253">       LastName: &quot;Changed&quot;,</span>
<a href="#l4.254"></a><span id="l4.254">       FirstName: &quot;New&quot;,</span>
<a href="#l4.255"></a><span id="l4.255">     },</span>
<a href="#l4.256"></a><span id="l4.256">     [&quot;N:Changed;New;;;&quot;, ANY_UID]</span>
<a href="#l4.257"></a><span id="l4.257">   );</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+</span>
<a href="#l4.259"></a><span id="l4.259">   // Work address changed. Other address types should not appear.</span>
<a href="#l4.260"></a><span id="l4.260">   check(</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineminus">-    formatVCard`</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineminus">-      BEGIN:VCARD</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineminus">-      ADR;TYPE=work:;;123 Main Street;Any Town;CA;91921-1234;U.S.A.</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineminus">-      END:VCARD`,</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+    &quot;ADR;TYPE=work:;;123 Main Street;Any Town;CA;91921-1234;U.S.A.&quot;,</span>
<a href="#l4.266"></a><span id="l4.266">     {</span>
<a href="#l4.267"></a><span id="l4.267">       WorkAddress: &quot;345 Main Street&quot;,</span>
<a href="#l4.268"></a><span id="l4.268">     },</span>
<a href="#l4.269"></a><span id="l4.269">     [&quot;ADR;TYPE=work:;;345 Main Street;Any Town;CA;91921-1234;U.S.A.&quot;, ANY_UID],</span>
<a href="#l4.270"></a><span id="l4.270">     [&quot;ADR&quot;, &quot;ADR;TYPE=home&quot;]</span>
<a href="#l4.271"></a><span id="l4.271">   );</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineplus">+</span>
<a href="#l4.273"></a><span id="l4.273">   // Home address changed. Other address types should not appear.</span>
<a href="#l4.274"></a><span id="l4.274">   check(</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineminus">-    formatVCard`</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineminus">-      BEGIN:VCARD</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineminus">-      ADR;TYPE=home:;;123 Main Street;Any Town;CA;91921-1234;U.S.A.</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineminus">-      END:VCARD`,</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+    &quot;ADR;TYPE=home:;;123 Main Street;Any Town;CA;91921-1234;U.S.A.&quot;,</span>
<a href="#l4.280"></a><span id="l4.280">     {</span>
<a href="#l4.281"></a><span id="l4.281">       HomeAddress: &quot;345 Main Street&quot;,</span>
<a href="#l4.282"></a><span id="l4.282">     },</span>
<a href="#l4.283"></a><span id="l4.283">     [&quot;ADR;TYPE=home:;;345 Main Street;Any Town;CA;91921-1234;U.S.A.&quot;, ANY_UID],</span>
<a href="#l4.284"></a><span id="l4.284">     [&quot;ADR&quot;, &quot;ADR;TYPE=work&quot;]</span>
<a href="#l4.285"></a><span id="l4.285">   );</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+</span>
<a href="#l4.287"></a><span id="l4.287">   // Address changed. Other address types should not appear.</span>
<a href="#l4.288"></a><span id="l4.288">   check(</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineminus">-    formatVCard`</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineminus">-      BEGIN:VCARD</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineminus">-      ADR:;;123 Main Street;Any Town;CA;91921-1234;U.S.A.</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineminus">-      END:VCARD`,</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineplus">+    &quot;ADR:;;123 Main Street;Any Town;CA;91921-1234;U.S.A.&quot;,</span>
<a href="#l4.294"></a><span id="l4.294">     {</span>
<a href="#l4.295"></a><span id="l4.295">       WorkAddress: &quot;345 Main Street&quot;,</span>
<a href="#l4.296"></a><span id="l4.296">     },</span>
<a href="#l4.297"></a><span id="l4.297">     [&quot;ADR:;;345 Main Street;Any Town;CA;91921-1234;U.S.A.&quot;, ANY_UID],</span>
<a href="#l4.298"></a><span id="l4.298">     [&quot;ADR;TYPE=work&quot;, &quot;ADR;TYPE=home&quot;]</span>
<a href="#l4.299"></a><span id="l4.299">   );</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineplus">+  // Various email properties with no changes.</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+  check(&quot;EMAIL:first@invalid&quot;, {}, [&quot;EMAIL:first@invalid&quot;, ANY_UID]);</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineplus">+  check(&quot;EMAIL:first@invalid\r\nEMAIL:second@invalid&quot;, {}, [</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineplus">+    &quot;EMAIL:first@invalid&quot;,</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+    &quot;EMAIL:second@invalid&quot;,</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineplus">+    ANY_UID,</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineplus">+  ]);</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineplus">+  check(</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineplus">+    &quot;EMAIL:first@invalid\r\nEMAIL:second@invalid\r\nEMAIL:third@invalid&quot;,</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineplus">+    {},</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineplus">+    [</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineplus">+      &quot;EMAIL:first@invalid&quot;,</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineplus">+      &quot;EMAIL:second@invalid&quot;,</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineplus">+      &quot;EMAIL:third@invalid&quot;,</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+      ANY_UID,</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineplus">+    ]</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineplus">+  );</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineplus">+</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+  // Changed primary email.</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+  check(&quot;EMAIL:first@invalid&quot;, { PrimaryEmail: &quot;changed.first@invalid&quot; }, [</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineplus">+    &quot;EMAIL:changed.first@invalid&quot;,</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineplus">+    ANY_UID,</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineplus">+  ]);</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineplus">+</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineplus">+  // Removed primary email, added secondary email.</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineplus">+  check(</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineplus">+    &quot;EMAIL:first@invalid&quot;,</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineplus">+    { PrimaryEmail: null, SecondEmail: &quot;second@invalid&quot; },</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineplus">+    [&quot;EMAIL:second@invalid&quot;, ANY_UID]</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineplus">+  );</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineplus">+</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineplus">+  // Changed primary email, added secondary email.</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineplus">+  check(</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineplus">+    &quot;EMAIL:first@invalid&quot;,</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineplus">+    {</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineplus">+      PrimaryEmail: &quot;changed.first@invalid&quot;,</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineplus">+      SecondEmail: &quot;second@invalid&quot;,</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineplus">+    },</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineplus">+    [&quot;EMAIL:changed.first@invalid&quot;, &quot;EMAIL:second@invalid&quot;, ANY_UID]</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineplus">+  );</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineplus">+</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineplus">+  // Changed primary and secondary email.</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineplus">+  check(</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+    &quot;EMAIL:first@invalid\r\nEMAIL:second@invalid&quot;,</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+    {</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineplus">+      PrimaryEmail: &quot;changed.first@invalid&quot;,</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineplus">+      SecondEmail: &quot;changed.second@invalid&quot;,</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineplus">+    },</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineplus">+    [&quot;EMAIL:changed.first@invalid&quot;, &quot;EMAIL:changed.second@invalid&quot;, ANY_UID]</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineplus">+  );</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineplus">+</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineplus">+  // Removed an email address when there's more than two.</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineplus">+  check(</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineplus">+    &quot;EMAIL:first@invalid\r\nEMAIL:second@invalid\r\nEMAIL:third@invalid&quot;,</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineplus">+    {</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineplus">+      PrimaryEmail: null,</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineplus">+    },</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineplus">+    [&quot;EMAIL:second@invalid&quot;, &quot;EMAIL:third@invalid&quot;, ANY_UID]</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+  );</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineplus">+  check(</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineplus">+    &quot;EMAIL:first@invalid\r\nEMAIL:second@invalid\r\nEMAIL:third@invalid&quot;,</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineplus">+    {</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineplus">+      SecondEmail: null,</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineplus">+    },</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineplus">+    [&quot;EMAIL:first@invalid&quot;, &quot;EMAIL:third@invalid&quot;, ANY_UID]</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineplus">+  );</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineplus">+</span>
<a href="#l4.368"></a><span id="l4.368">   // Card with properties we don't support. They should remain unchanged.</span>
<a href="#l4.369"></a><span id="l4.369">   check(</span>
<a href="#l4.370"></a><span id="l4.370">     formatVCard`</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineminus">-      BEGIN:VCARD</span>
<a href="#l4.372"></a><span id="l4.372">       X-FOO-BAR:foo bar</span>
<a href="#l4.373"></a><span id="l4.373">       X-BAZ;VALUE=URI:https://www.example.com/</span>
<a href="#l4.374"></a><span id="l4.374">       QUUX:This property is out of spec but we shouldn't touch it anyway.</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineminus">-      FN:My full name</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineminus">-      END:VCARD`,</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineplus">+      FN:My full name`,</span>
<a href="#l4.378"></a><span id="l4.378">     {</span>
<a href="#l4.379"></a><span id="l4.379">       DisplayName: &quot;My other full name&quot;,</span>
<a href="#l4.380"></a><span id="l4.380">     },</span>
<a href="#l4.381"></a><span id="l4.381">     [</span>
<a href="#l4.382"></a><span id="l4.382">       &quot;FN:My other full name&quot;,</span>
<a href="#l4.383"></a><span id="l4.383">       &quot;X-FOO-BAR:foo bar&quot;,</span>
<a href="#l4.384"></a><span id="l4.384">       &quot;X-BAZ;VALUE=URI:https://www.example.com/&quot;,</span>
<a href="#l4.385"></a><span id="l4.385">       &quot;QUUX:This property is out of spec but we shouldn't touch it anyway.&quot;,</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineat">@@ -317,16 +460,17 @@ add_task(function testAbCardToVCard() {</span>
<a href="#l4.387"></a><span id="l4.387"> </span>
<a href="#l4.388"></a><span id="l4.388">   // UID</span>
<a href="#l4.389"></a><span id="l4.389">   check(</span>
<a href="#l4.390"></a><span id="l4.390">     {</span>
<a href="#l4.391"></a><span id="l4.391">       UID: &quot;12345678-1234-1234-1234-123456789012&quot;,</span>
<a href="#l4.392"></a><span id="l4.392">     },</span>
<a href="#l4.393"></a><span id="l4.393">     &quot;UID:12345678-1234-1234-1234-123456789012&quot;</span>
<a href="#l4.394"></a><span id="l4.394">   );</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineplus">+</span>
<a href="#l4.396"></a><span id="l4.396">   // Name</span>
<a href="#l4.397"></a><span id="l4.397">   check(</span>
<a href="#l4.398"></a><span id="l4.398">     {</span>
<a href="#l4.399"></a><span id="l4.399">       FirstName: &quot;First&quot;,</span>
<a href="#l4.400"></a><span id="l4.400">       LastName: &quot;Last&quot;,</span>
<a href="#l4.401"></a><span id="l4.401">     },</span>
<a href="#l4.402"></a><span id="l4.402">     &quot;N:Last;First;;;&quot;,</span>
<a href="#l4.403"></a><span id="l4.403">     ANY_UID</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineat">@@ -350,16 +494,17 @@ add_task(function testAbCardToVCard() {</span>
<a href="#l4.405"></a><span id="l4.405">       HomeCity: &quot;Any Town&quot;,</span>
<a href="#l4.406"></a><span id="l4.406">       HomeState: &quot;CA&quot;,</span>
<a href="#l4.407"></a><span id="l4.407">       HomeZipCode: &quot;91921-1234&quot;,</span>
<a href="#l4.408"></a><span id="l4.408">       HomeCountry: &quot;U.S.A.&quot;,</span>
<a href="#l4.409"></a><span id="l4.409">     },</span>
<a href="#l4.410"></a><span id="l4.410">     &quot;ADR:;;123 Main Street;Any Town;CA;91921-1234;U.S.A.&quot;,</span>
<a href="#l4.411"></a><span id="l4.411">     ANY_UID</span>
<a href="#l4.412"></a><span id="l4.412">   );</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineplus">+</span>
<a href="#l4.414"></a><span id="l4.414">   // Phone</span>
<a href="#l4.415"></a><span id="l4.415">   check(</span>
<a href="#l4.416"></a><span id="l4.416">     {</span>
<a href="#l4.417"></a><span id="l4.417">       WorkPhone: &quot;11-2358-13-21&quot;,</span>
<a href="#l4.418"></a><span id="l4.418">     },</span>
<a href="#l4.419"></a><span id="l4.419">     &quot;TEL;VALUE=TEXT:11-2358-13-21&quot;,</span>
<a href="#l4.420"></a><span id="l4.420">     ANY_UID</span>
<a href="#l4.421"></a><span id="l4.421">   );</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineat">@@ -374,36 +519,47 @@ add_task(function testAbCardToVCard() {</span>
<a href="#l4.423"></a><span id="l4.423">     {</span>
<a href="#l4.424"></a><span id="l4.424">       WorkPhone: &quot;11-2358-13-21&quot;,</span>
<a href="#l4.425"></a><span id="l4.425">       HomePhone: &quot;011-2358-13-21&quot;,</span>
<a href="#l4.426"></a><span id="l4.426">     },</span>
<a href="#l4.427"></a><span id="l4.427">     &quot;TEL;TYPE=work;VALUE=TEXT:11-2358-13-21&quot;,</span>
<a href="#l4.428"></a><span id="l4.428">     &quot;TEL;TYPE=home;VALUE=TEXT:011-2358-13-21&quot;,</span>
<a href="#l4.429"></a><span id="l4.429">     ANY_UID</span>
<a href="#l4.430"></a><span id="l4.430">   );</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineplus">+</span>
<a href="#l4.432"></a><span id="l4.432">   // Birthday</span>
<a href="#l4.433"></a><span id="l4.433">   check(</span>
<a href="#l4.434"></a><span id="l4.434">     {</span>
<a href="#l4.435"></a><span id="l4.435">       BirthDay: &quot;3&quot;,</span>
<a href="#l4.436"></a><span id="l4.436">       BirthMonth: &quot;4&quot;,</span>
<a href="#l4.437"></a><span id="l4.437">       BirthYear: &quot;1983&quot;,</span>
<a href="#l4.438"></a><span id="l4.438">     },</span>
<a href="#l4.439"></a><span id="l4.439">     &quot;BDAY;VALUE=DATE:19830403&quot;,</span>
<a href="#l4.440"></a><span id="l4.440">     ANY_UID</span>
<a href="#l4.441"></a><span id="l4.441">   );</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineplus">+</span>
<a href="#l4.443"></a><span id="l4.443">   // Anniversary</span>
<a href="#l4.444"></a><span id="l4.444">   check(</span>
<a href="#l4.445"></a><span id="l4.445">     {</span>
<a href="#l4.446"></a><span id="l4.446">       AnniversaryDay: &quot;7&quot;,</span>
<a href="#l4.447"></a><span id="l4.447">       AnniversaryMonth: &quot;12&quot;,</span>
<a href="#l4.448"></a><span id="l4.448">       AnniversaryYear: &quot;2004&quot;,</span>
<a href="#l4.449"></a><span id="l4.449">     },</span>
<a href="#l4.450"></a><span id="l4.450">     &quot;ANNIVERSARY;VALUE=DATE:20041207&quot;,</span>
<a href="#l4.451"></a><span id="l4.451">     ANY_UID</span>
<a href="#l4.452"></a><span id="l4.452">   );</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineplus">+</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineplus">+  // Email</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineplus">+  check({ PrimaryEmail: &quot;first@invalid&quot; }, &quot;EMAIL;PREF=1:first@invalid&quot;);</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineplus">+  check({ SecondEmail: &quot;second@invalid&quot; }, &quot;EMAIL:second@invalid&quot;);</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineplus">+  check(</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineplus">+    { PrimaryEmail: &quot;first@invalid&quot;, SecondEmail: &quot;second@invalid&quot; },</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineplus">+    &quot;EMAIL;PREF=1:first@invalid&quot;,</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineplus">+    &quot;EMAIL:second@invalid&quot;</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineplus">+  );</span>
<a href="#l4.462"></a><span id="l4.462"> });</span>
<a href="#l4.463"></a><span id="l4.463"> </span>
<a href="#l4.464"></a><span id="l4.464"> add_task(function() {</span>
<a href="#l4.465"></a><span id="l4.465">   // Check that test_becky_addressbook.js won't fail, without being on Windows.</span>
<a href="#l4.466"></a><span id="l4.466">   let v = formatVCard`</span>
<a href="#l4.467"></a><span id="l4.467">     BEGIN:VCARD</span>
<a href="#l4.468"></a><span id="l4.468">     VERSION:3.0</span>
<a href="#l4.469"></a><span id="l4.469">     UID:4E4D17E8.0043655C</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

