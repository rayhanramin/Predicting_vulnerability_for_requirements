<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 10627:06898b5bcf86ff66cfecaf5c4538244246e3f11b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 06898b5bcf86ff66cfecaf5c4538244246e3f11b" />
<meta property="og:url" content="/comm-central/rev/06898b5bcf86ff66cfecaf5c4538244246e3f11b" />
<meta property="og:description" content="Bug 765820 Make MDN (return receipts) work for non-standard headers, and make the MDN confirmation message say which addresses the receipt will be sent to r=IanN sr=Mnyromyr." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 06898b5bcf86ff66cfecaf5c4538244246e3f11b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/06898b5bcf86ff66cfecaf5c4538244246e3f11b">shortlog</a> |
<a href="/comm-central/log/06898b5bcf86ff66cfecaf5c4538244246e3f11b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/06898b5bcf86ff66cfecaf5c4538244246e3f11b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/06898b5bcf86ff66cfecaf5c4538244246e3f11b">files</a> |
changeset |
<a href="/comm-central/raw-rev/06898b5bcf86ff66cfecaf5c4538244246e3f11b">raw</a>  | <a href="/comm-central/archive/06898b5bcf86ff66cfecaf5c4538244246e3f11b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=765820">Bug 765820</a> Make MDN (return receipts) work for non-standard headers, and make the MDN confirmation message say which addresses the receipt will be sent to r=IanN sr=Mnyromyr.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#32;&#67;&#104;&#101;&#101;&#32;&#60;&#112;&#104;&#105;&#108;&#105;&#112;&#46;&#99;&#104;&#101;&#101;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 12 Jul 2012 01:43:47 +0800</td></tr>

<tr>
 <td>changeset 10627</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/06898b5bcf86ff66cfecaf5c4538244246e3f11b">06898b5bcf86ff66cfecaf5c4538244246e3f11b</a></td>
</tr>



<tr>
<td>parent 10626</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f80dc5c5d591398d882181cd5611656c55ca3512">f80dc5c5d591398d882181cd5611656c55ca3512</a>
</td>
</tr>

<tr>
<td>child 10628</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d63b11ddcd554b5ce23bfbc83d68eef4686fe51c">d63b11ddcd554b5ce23bfbc83d68eef4686fe51c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=06898b5bcf86ff66cfecaf5c4538244246e3f11b">8025</a></td></tr>
<tr><td>push user</td><td>philip.chee@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 11 Jul 2012 17:59:37 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@d63b11ddcd55 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d63b11ddcd554b5ce23bfbc83d68eef4686fe51c">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d63b11ddcd554b5ce23bfbc83d68eef4686fe51c&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d63b11ddcd554b5ce23bfbc83d68eef4686fe51c&newProject=comm-central&newRevision=06898b5bcf86ff66cfecaf5c4538244246e3f11b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d63b11ddcd554b5ce23bfbc83d68eef4686fe51c&newProject=comm-central&newRevision=06898b5bcf86ff66cfecaf5c4538244246e3f11b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d63b11ddcd554b5ce23bfbc83d68eef4686fe51c&newProject=comm-central&newRevision=06898b5bcf86ff66cfecaf5c4538244246e3f11b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28IanN%29&revcount=50">IanN</a>, <a href="/comm-central/log?rev=reviewer%28Mnyromyr%29&revcount=50">Mnyromyr</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=765820">765820</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=765820">Bug 765820</a> Make MDN (return receipts) work for non-standard headers, and make the MDN confirmation message say which addresses the receipt will be sent to r=IanN sr=Mnyromyr.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/locales/en-US/chrome/mailnews/messenger.dtd">suite/locales/en-US/chrome/mailnews/messenger.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/locales/en-US/chrome/mailnews/messenger.dtd">file</a> |
<a href="/comm-central/annotate/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/locales/en-US/chrome/mailnews/messenger.dtd">annotate</a> |
<a href="/comm-central/diff/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/locales/en-US/chrome/mailnews/messenger.dtd">diff</a> |
<a href="/comm-central/comparison/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/locales/en-US/chrome/mailnews/messenger.dtd">comparison</a> |
<a href="/comm-central/log/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/locales/en-US/chrome/mailnews/messenger.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/locales/en-US/chrome/mailnews/messenger.properties">suite/locales/en-US/chrome/mailnews/messenger.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/locales/en-US/chrome/mailnews/messenger.properties">file</a> |
<a href="/comm-central/annotate/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/locales/en-US/chrome/mailnews/messenger.properties">annotate</a> |
<a href="/comm-central/diff/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/locales/en-US/chrome/mailnews/messenger.properties">diff</a> |
<a href="/comm-central/comparison/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/locales/en-US/chrome/mailnews/messenger.properties">comparison</a> |
<a href="/comm-central/log/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/locales/en-US/chrome/mailnews/messenger.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/mailnews/mailWindowOverlay.js">suite/mailnews/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/mailnews/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/mailnews/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/mailnews/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/mailnews/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/mailnews/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/mailnews/mailWindowOverlay.xul">suite/mailnews/mailWindowOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/mailnews/mailWindowOverlay.xul">file</a> |
<a href="/comm-central/annotate/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/mailnews/mailWindowOverlay.xul">annotate</a> |
<a href="/comm-central/diff/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/mailnews/mailWindowOverlay.xul">diff</a> |
<a href="/comm-central/comparison/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/mailnews/mailWindowOverlay.xul">comparison</a> |
<a href="/comm-central/log/06898b5bcf86ff66cfecaf5c4538244246e3f11b/suite/mailnews/mailWindowOverlay.xul">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/messenger.dtd</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/messenger.dtd</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -535,11 +535,12 @@</span>
<a href="#l1.4"></a><span id="l1.4"> &lt;!ENTITY remoteContentMessage.label &quot;To protect your privacy, &amp;brandShortName; has blocked remote content in this message.&quot;&gt;</span>
<a href="#l1.5"></a><span id="l1.5"> &lt;!ENTITY loadRemoteContentButton.label &quot;Show Remote Content&quot;&gt;</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> &lt;!-- Phishing Bar --&gt;</span>
<a href="#l1.8"></a><span id="l1.8"> &lt;!ENTITY phishingBarMessage.label &quot;&amp;brandShortName; thinks this message might be an email scam.&quot;&gt;</span>
<a href="#l1.9"></a><span id="l1.9"> &lt;!ENTITY removePhishingBarButton.label &quot;Not a Scam&quot;&gt;</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> &lt;!-- MDN Bar --&gt;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-&lt;!ENTITY mdnBarMessage.label &quot;The sender of this message has asked to be notified when you read this message. Do you wish to notify the sender?&quot;&gt;</span>
<a href="#l1.13"></a><span id="l1.13"> &lt;!ENTITY mdnBarIgnoreButton.label &quot;Ignore Request&quot;&gt;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+&lt;!ENTITY mdnBarIgnoreButton.accesskey &quot;I&quot;&gt;</span>
<a href="#l1.15"></a><span id="l1.15"> &lt;!ENTITY mdnBarSendButton.label &quot;Send Receipt&quot;&gt;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+&lt;!ENTITY mdnBarSendButton.accesskey &quot;S&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/messenger.properties</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/messenger.properties</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -380,16 +380,21 @@ errorOpenMessageForMessageIdMessage=Mess</span>
<a href="#l2.4"></a><span id="l2.4"> confirmPhishingTitle=Email Scam Alert</span>
<a href="#l2.5"></a><span id="l2.5"> #LOCALIZATION NOTE %1$S is the brand name, %2$S is the host name of the url being visited</span>
<a href="#l2.6"></a><span id="l2.6"> confirmPhishingUrl1=%1$S thinks this website is suspicious! It may be trying to impersonate the web page you want to visit. Most legitimate websites use names instead of numbers. Are you sure you want to visit %2$S?</span>
<a href="#l2.7"></a><span id="l2.7"> confirmPhishingUrl2=%1$S thinks this website is suspicious! It may be trying to impersonate the web page you want to visit. Are you sure you want to visit %2$S?</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> #LOCALIZATION NOTE %1$S is the e-mail address of the person we will allow remote content for</span>
<a href="#l2.10"></a><span id="l2.10"> alwaysLoadRemoteContentForSender=Click here to always load remote content from %1$S.</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+#LOCALIZATION NOTE(mdnBarMessageNormal) %1$S is the name of the sender</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+mdnBarMessageNormal=%1$S has asked to be notified when you read this message.</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+#LOCALIZATION NOTE(mdnBarMessageAddressDiffers) %1$S is the name of the sender, %2$S is the address(es) to send return receipt to</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+mdnBarMessageAddressDiffers=%1$S has asked to be notified at %2$S when you read this message.</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+</span>
<a href="#l2.17"></a><span id="l2.17"> # Strings for growl notifications on Mac OS X</span>
<a href="#l2.18"></a><span id="l2.18"> growlNotification=New Mail</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> # mailCommands.js</span>
<a href="#l2.21"></a><span id="l2.21"> emptyJunkTitle=Confirm</span>
<a href="#l2.22"></a><span id="l2.22"> emptyJunkMessage=Are you sure you want to permanently delete all messages and subfolders in the Junk folder?</span>
<a href="#l2.23"></a><span id="l2.23"> emptyJunkDontAsk=Don't ask me again.</span>
<a href="#l2.24"></a><span id="l2.24"> emptyTrashTitle=Confirm</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/suite/mailnews/mailWindowOverlay.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/suite/mailnews/mailWindowOverlay.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -2571,19 +2571,45 @@ var gMessageNotificationBar =</span>
<a href="#l3.4"></a><span id="l3.4">     // if we've explicitly marked this message as not being an email scam, then don't</span>
<a href="#l3.5"></a><span id="l3.5">     // bother checking it with the phishing detector.</span>
<a href="#l3.6"></a><span id="l3.6">     var phishingMsg = false;</span>
<a href="#l3.7"></a><span id="l3.7">     if (!checkMsgHdrPropertyIsNot(&quot;notAPhishMessage&quot;, kIsAPhishMessage))</span>
<a href="#l3.8"></a><span id="l3.8">       phishingMsg = isMsgEmailScam(aUrl);</span>
<a href="#l3.9"></a><span id="l3.9">     this.updateMsgNotificationBar(kMsgNotificationPhishingBar, phishingMsg);</span>
<a href="#l3.10"></a><span id="l3.10">   },</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  setMDNMsg: function(aMdnGenerator, aMsgHeader)</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  setMDNMsg: function(aMdnGenerator, aMsgHeader, aMimeHdr)</span>
<a href="#l3.14"></a><span id="l3.14">   {</span>
<a href="#l3.15"></a><span id="l3.15">     this.mdnGenerator = aMdnGenerator;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    // Return receipts can be RFC 3798 &quot;Disposition-Notification-To&quot;,</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+    // or non-standard &quot;Return-Receipt-To&quot;.</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+    var mdnHdr = aMimeHdr.extractHeader(&quot;Disposition-Notification-To&quot;, false) ||</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+                 aMimeHdr.extractHeader(&quot;Return-Receipt-To&quot;, false);</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+    var fromHdr = aMimeHdr.extractHeader(&quot;From&quot;, false);</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+    var mdnAddr = MailServices.headerParser</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+                              .extractHeaderAddressMailboxes(mdnHdr);</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+    var fromAddr = MailServices.headerParser</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+                               .extractHeaderAddressMailboxes(fromHdr);</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+    var authorName = MailServices.headerParser</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+                                 .extractHeaderAddressName(aMsgHeader.mime2DecodedAuthor) ||</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+                     aMsgHeader.author;</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+    var barMsg;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+    // If the return receipt doesn't go to the sender address, note that in the</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+    // notification.</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+    if (mdnAddr != fromAddr)</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+      barMsg = gMessengerBundle.getFormattedString(&quot;mdnBarMessageAddressDiffers&quot;,</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+                                                   [authorName, mdnAddr]);</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+    else</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+      barMsg = gMessengerBundle.getFormattedString(&quot;mdnBarMessageNormal&quot;,</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+                                                   [authorName]);</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+    document.getElementById(&quot;mdnBarMessage&quot;).textContent = barMsg;</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+</span>
<a href="#l3.42"></a><span id="l3.42">     this.updateMsgNotificationBar(kMsgNotificationMDN, true);</span>
<a href="#l3.43"></a><span id="l3.43">   },</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45">   clearMsgNotifications: function()</span>
<a href="#l3.46"></a><span id="l3.46">   {</span>
<a href="#l3.47"></a><span id="l3.47">     this.mBarStatus = 0;</span>
<a href="#l3.48"></a><span id="l3.48">     var msgNotificationBar = document.getElementById('msgNotificationBar');</span>
<a href="#l3.49"></a><span id="l3.49">     msgNotificationBar.selectedIndex = 0;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineat">@@ -2601,18 +2627,17 @@ var gMessageNotificationBar =</span>
<a href="#l3.51"></a><span id="l3.51">     // which takes precedence over the remote content message</span>
<a href="#l3.52"></a><span id="l3.52">     var msgNotificationBar = document.getElementById('msgNotificationBar');</span>
<a href="#l3.53"></a><span id="l3.53">     msgNotificationBar.selectedIndex = this.mBarFlagValues.indexOf(status &amp; -status);</span>
<a href="#l3.54"></a><span id="l3.54"> </span>
<a href="#l3.55"></a><span id="l3.55">     msgNotificationBar.collapsed = !status;</span>
<a href="#l3.56"></a><span id="l3.56">   },</span>
<a href="#l3.57"></a><span id="l3.57"> </span>
<a href="#l3.58"></a><span id="l3.58">   /**</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-   * @param aFlag  kMsgNotificationPhishingBar, kMsgNotificationJunkBar, or</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-   *               kMsgNotificationRemoteImages</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+   * @param aFlag one of the |mBarFlagValues| values</span>
<a href="#l3.62"></a><span id="l3.62">    * @return true if aFlag is currently set for the loaded message</span>
<a href="#l3.63"></a><span id="l3.63">    */</span>
<a href="#l3.64"></a><span id="l3.64">   isFlagSet: function(aFlag)</span>
<a href="#l3.65"></a><span id="l3.65">   {</span>
<a href="#l3.66"></a><span id="l3.66">     var chunk = this.mBarFlagValues[aFlag];</span>
<a href="#l3.67"></a><span id="l3.67">     return this.mBarStatus &amp; chunk;</span>
<a href="#l3.68"></a><span id="l3.68">   }</span>
<a href="#l3.69"></a><span id="l3.69"> };</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineat">@@ -2843,22 +2868,22 @@ function OnMsgLoaded(aUrl)</span>
<a href="#l3.71"></a><span id="l3.71">         MarkMessageAsRead(msgHdr);</span>
<a href="#l3.72"></a><span id="l3.72">       }</span>
<a href="#l3.73"></a><span id="l3.73">     }</span>
<a href="#l3.74"></a><span id="l3.74"> </span>
<a href="#l3.75"></a><span id="l3.75">     // See if MDN was requested but has not been sent.</span>
<a href="#l3.76"></a><span id="l3.76">     HandleMDNResponse(aUrl);</span>
<a href="#l3.77"></a><span id="l3.77"> }</span>
<a href="#l3.78"></a><span id="l3.78"> </span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-//</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-// This function handles all mdn response generation (ie, imap and pop).</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-// For pop the msg uid can be 0 (ie, 1st msg in a local folder) so no</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-// need to check uid here. No one seems to set mimeHeaders to null so</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-// no need to check it either.</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-//</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+/*</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+ * This function handles all mdn response generation (ie, imap and pop).</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+ * For pop the msg uid can be 0 (ie, 1st msg in a local folder) so no</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+ * need to check uid here. No one seems to set mimeHeaders to null so</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+ * no need to check it either.</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+ */</span>
<a href="#l3.91"></a><span id="l3.91"> function HandleMDNResponse(aUrl)</span>
<a href="#l3.92"></a><span id="l3.92"> {</span>
<a href="#l3.93"></a><span id="l3.93">   if (!aUrl)</span>
<a href="#l3.94"></a><span id="l3.94">     return;</span>
<a href="#l3.95"></a><span id="l3.95"> </span>
<a href="#l3.96"></a><span id="l3.96">   var msgFolder = aUrl.folder;</span>
<a href="#l3.97"></a><span id="l3.97">   var msgURI = GetLoadedMessage();</span>
<a href="#l3.98"></a><span id="l3.98">   if (!msgFolder || !msgURI || IsNewsMessage(msgURI))</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineat">@@ -2886,19 +2911,17 @@ function HandleMDNResponse(aUrl)</span>
<a href="#l3.100"></a><span id="l3.100">   {</span>
<a href="#l3.101"></a><span id="l3.101">     var mimeMsgId = mimeHdr.extractHeader(&quot;Message-Id&quot;, false);</span>
<a href="#l3.102"></a><span id="l3.102">     if (mimeMsgId)</span>
<a href="#l3.103"></a><span id="l3.103">       msgHdr.messageId = mimeMsgId;</span>
<a href="#l3.104"></a><span id="l3.104">   }</span>
<a href="#l3.105"></a><span id="l3.105"> </span>
<a href="#l3.106"></a><span id="l3.106">   // After a msg is downloaded it's already marked READ at this point so we must check if</span>
<a href="#l3.107"></a><span id="l3.107">   // the msg has a &quot;Disposition-Notification-To&quot; header and no MDN report has been sent yet.</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-  var msgFlags = msgHdr.flags;</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-  if ((msgFlags &amp; Components.interfaces.nsMsgMessageFlags.IMAPDeleted) ||</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-      (msgFlags &amp; Components.interfaces.nsMsgMessageFlags.MDNReportSent))</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+  if (msgHdr.flags &amp; Components.interfaces.nsMsgMessageFlags.MDNReportSent)</span>
<a href="#l3.112"></a><span id="l3.112">     return;</span>
<a href="#l3.113"></a><span id="l3.113"> </span>
<a href="#l3.114"></a><span id="l3.114">   var DNTHeader = mimeHdr.extractHeader(&quot;Disposition-Notification-To&quot;, false);</span>
<a href="#l3.115"></a><span id="l3.115">   var oldDNTHeader = mimeHdr.extractHeader(&quot;Return-Receipt-To&quot;, false);</span>
<a href="#l3.116"></a><span id="l3.116">   if (!DNTHeader &amp;&amp; !oldDNTHeader)</span>
<a href="#l3.117"></a><span id="l3.117">     return;</span>
<a href="#l3.118"></a><span id="l3.118"> </span>
<a href="#l3.119"></a><span id="l3.119">   // Everything looks good so far, let's generate the MDN response.</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineat">@@ -2906,17 +2929,17 @@ function HandleMDNResponse(aUrl)</span>
<a href="#l3.121"></a><span id="l3.121">                                .createInstance(Components.interfaces.nsIMsgMdnGenerator);</span>
<a href="#l3.122"></a><span id="l3.122">   var askUser = mdnGenerator.process(Components.interfaces.nsIMsgMdnGenerator.eDisplayed,</span>
<a href="#l3.123"></a><span id="l3.123">                                      msgWindow,</span>
<a href="#l3.124"></a><span id="l3.124">                                      msgFolder,</span>
<a href="#l3.125"></a><span id="l3.125">                                      msgHdr.messageKey,</span>
<a href="#l3.126"></a><span id="l3.126">                                      mimeHdr,</span>
<a href="#l3.127"></a><span id="l3.127">                                      false);</span>
<a href="#l3.128"></a><span id="l3.128">   if (askUser)</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-    gMessageNotificationBar.setMDNMsg(mdnGenerator, msgHdr);</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+    gMessageNotificationBar.setMDNMsg(mdnGenerator, msgHdr, mimeHdr);</span>
<a href="#l3.131"></a><span id="l3.131"> }</span>
<a href="#l3.132"></a><span id="l3.132"> </span>
<a href="#l3.133"></a><span id="l3.133"> function SendMDNResponse()</span>
<a href="#l3.134"></a><span id="l3.134"> {</span>
<a href="#l3.135"></a><span id="l3.135">   gMessageNotificationBar.mdnGenerator.userAgreed();</span>
<a href="#l3.136"></a><span id="l3.136">   gMessageNotificationBar.updateMsgNotificationBar(kMsgNotificationMDN, false);</span>
<a href="#l3.137"></a><span id="l3.137"> }</span>
<a href="#l3.138"></a><span id="l3.138"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/suite/mailnews/mailWindowOverlay.xul</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/suite/mailnews/mailWindowOverlay.xul</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -2263,21 +2263,24 @@</span>
<a href="#l4.4"></a><span id="l4.4">             label=&quot;&amp;loadRemoteContentButton.label;&quot;</span>
<a href="#l4.5"></a><span id="l4.5">             oncommand=&quot;LoadMsgWithRemoteContent();&quot;/&gt;</span>
<a href="#l4.6"></a><span id="l4.6">   &lt;/hbox&gt;</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8">   &lt;hbox id=&quot;mdnBar&quot;</span>
<a href="#l4.9"></a><span id="l4.9">         class=&quot;msgNotificationBar&quot;</span>
<a href="#l4.10"></a><span id="l4.10">         align=&quot;center&quot;&gt;</span>
<a href="#l4.11"></a><span id="l4.11">     &lt;image id=&quot;mdnBarImage&quot;/&gt;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    &lt;description flex=&quot;1&quot;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-                 class=&quot;msgNotificationBarText&quot;&gt;&amp;mdnBarMessage.label;&lt;/description&gt;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+    &lt;description id=&quot;mdnBarMessage&quot;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+                 flex=&quot;1&quot;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+                 class=&quot;msgNotificationBarText&quot;/&gt;</span>
<a href="#l4.17"></a><span id="l4.17">     &lt;button label=&quot;&amp;mdnBarIgnoreButton.label;&quot;</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+            accesskey=&quot;&amp;mdnBarIgnoreButton.accesskey;&quot;</span>
<a href="#l4.19"></a><span id="l4.19">             oncommand=&quot;IgnoreMDNResponse();&quot;/&gt;</span>
<a href="#l4.20"></a><span id="l4.20">     &lt;button label=&quot;&amp;mdnBarSendButton.label;&quot;</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+            accesskey=&quot;&amp;mdnBarSendButton.accesskey;&quot;</span>
<a href="#l4.22"></a><span id="l4.22">             oncommand=&quot;SendMDNResponse();&quot;/&gt;</span>
<a href="#l4.23"></a><span id="l4.23">   &lt;/hbox&gt;</span>
<a href="#l4.24"></a><span id="l4.24"> &lt;/deck&gt;</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26"> &lt;statusbar class=&quot;chromeclass-status&quot; id=&quot;status-bar&quot;&gt;</span>
<a href="#l4.27"></a><span id="l4.27">   &lt;statusbarpanel id=&quot;component-bar&quot;/&gt;</span>
<a href="#l4.28"></a><span id="l4.28">   &lt;statusbarpanel id=&quot;statusText&quot; label=&quot;&amp;statusText.label;&quot; crop=&quot;right&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l4.29"></a><span id="l4.29">   &lt;statusbarpanel class=&quot;statusbarpanel-progress&quot; id=&quot;statusbar-progresspanel&quot; collapsed=&quot;true&quot;&gt;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

