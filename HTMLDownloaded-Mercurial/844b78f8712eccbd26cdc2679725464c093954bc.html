<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 8665:844b78f8712eccbd26cdc2679725464c093954bc</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 844b78f8712eccbd26cdc2679725464c093954bc" />
<meta property="og:url" content="/comm-central/rev/844b78f8712eccbd26cdc2679725464c093954bc" />
<meta property="og:description" content="Fix bug 380060 - Implementation of full offline mode (esp. modification of calendar data). r=philipp" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 844b78f8712eccbd26cdc2679725464c093954bc 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/844b78f8712eccbd26cdc2679725464c093954bc">shortlog</a> |
<a href="/comm-central/log/844b78f8712eccbd26cdc2679725464c093954bc">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/844b78f8712eccbd26cdc2679725464c093954bc">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/844b78f8712eccbd26cdc2679725464c093954bc">files</a> |
changeset |
<a href="/comm-central/raw-rev/844b78f8712eccbd26cdc2679725464c093954bc">raw</a>  | <a href="/comm-central/archive/844b78f8712eccbd26cdc2679725464c093954bc.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=380060">bug 380060</a> - Implementation of full offline mode (esp. modification of calendar data). r=philipp
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#111;&#104;&#105;&#116;&#32;&#75;&#97;&#110;&#119;&#97;&#108;&#32;&#60;&#109;&#111;&#104;&#105;&#116;&#46;&#107;&#97;&#110;&#119;&#97;&#108;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 18 Oct 2011 00:52:45 +0200</td></tr>

<tr>
 <td>changeset 8665</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/844b78f8712eccbd26cdc2679725464c093954bc">844b78f8712eccbd26cdc2679725464c093954bc</a></td>
</tr>



<tr>
<td>parent 8664</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d30928e424c419bac7031006e180fe7fc498d534">d30928e424c419bac7031006e180fe7fc498d534</a>
</td>
</tr>

<tr>
<td>child 8666</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5b97fe84948c2be8074e6a9b0df70d850d11a6e8">5b97fe84948c2be8074e6a9b0df70d850d11a6e8</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=844b78f8712eccbd26cdc2679725464c093954bc">6665</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Mon, 17 Oct 2011 22:53:29 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@844b78f8712e [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=844b78f8712eccbd26cdc2679725464c093954bc">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=844b78f8712eccbd26cdc2679725464c093954bc&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=844b78f8712eccbd26cdc2679725464c093954bc&newProject=comm-central&newRevision=844b78f8712eccbd26cdc2679725464c093954bc&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=844b78f8712eccbd26cdc2679725464c093954bc&newProject=comm-central&newRevision=844b78f8712eccbd26cdc2679725464c093954bc&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=844b78f8712eccbd26cdc2679725464c093954bc&newProject=comm-central&newRevision=844b78f8712eccbd26cdc2679725464c093954bc&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28philipp%29&revcount=50">philipp</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=380060">380060</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=380060">bug 380060</a> - Implementation of full offline mode (esp. modification of calendar data). r=philipp</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/content/calendar-common-sets.js">calendar/base/content/calendar-common-sets.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/content/calendar-common-sets.js">file</a> |
<a href="/comm-central/annotate/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/content/calendar-common-sets.js">annotate</a> |
<a href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/content/calendar-common-sets.js">diff</a> |
<a href="/comm-central/comparison/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/content/calendar-common-sets.js">comparison</a> |
<a href="/comm-central/log/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/content/calendar-common-sets.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/content/dialogs/calendar-conflicts-dialog.xul">calendar/base/content/dialogs/calendar-conflicts-dialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/content/dialogs/calendar-conflicts-dialog.xul">file</a> |
<a href="/comm-central/annotate/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/content/dialogs/calendar-conflicts-dialog.xul">annotate</a> |
<a href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/content/dialogs/calendar-conflicts-dialog.xul">diff</a> |
<a href="/comm-central/comparison/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/content/dialogs/calendar-conflicts-dialog.xul">comparison</a> |
<a href="/comm-central/log/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/content/dialogs/calendar-conflicts-dialog.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/jar.mn">calendar/base/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/jar.mn">file</a> |
<a href="/comm-central/annotate/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/jar.mn">annotate</a> |
<a href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/jar.mn">diff</a> |
<a href="/comm-central/comparison/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/jar.mn">comparison</a> |
<a href="/comm-central/log/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/modules/calProviderUtils.jsm">calendar/base/modules/calProviderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/modules/calProviderUtils.jsm">file</a> |
<a href="/comm-central/annotate/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/modules/calProviderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/modules/calProviderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/modules/calProviderUtils.jsm">comparison</a> |
<a href="/comm-central/log/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/modules/calProviderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/public/calICalendar.idl">calendar/base/public/calICalendar.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/public/calICalendar.idl">file</a> |
<a href="/comm-central/annotate/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/public/calICalendar.idl">annotate</a> |
<a href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/public/calICalendar.idl">diff</a> |
<a href="/comm-central/comparison/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/public/calICalendar.idl">comparison</a> |
<a href="/comm-central/log/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/public/calICalendar.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/public/calIChangeLog.idl">calendar/base/public/calIChangeLog.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/public/calIChangeLog.idl">file</a> |
<a href="/comm-central/annotate/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/public/calIChangeLog.idl">annotate</a> |
<a href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/public/calIChangeLog.idl">diff</a> |
<a href="/comm-central/comparison/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/public/calIChangeLog.idl">comparison</a> |
<a href="/comm-central/log/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/public/calIChangeLog.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/src/calCachedCalendar.js">calendar/base/src/calCachedCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/src/calCachedCalendar.js">file</a> |
<a href="/comm-central/annotate/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/src/calCachedCalendar.js">annotate</a> |
<a href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/src/calCachedCalendar.js">diff</a> |
<a href="/comm-central/comparison/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/src/calCachedCalendar.js">comparison</a> |
<a href="/comm-central/log/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/src/calCachedCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/844b78f8712eccbd26cdc2679725464c093954bc/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/caldav/calDavRequestHandlers.js">calendar/providers/caldav/calDavRequestHandlers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/caldav/calDavRequestHandlers.js">file</a> |
<a href="/comm-central/annotate/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/caldav/calDavRequestHandlers.js">annotate</a> |
<a href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/caldav/calDavRequestHandlers.js">diff</a> |
<a href="/comm-central/comparison/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/caldav/calDavRequestHandlers.js">comparison</a> |
<a href="/comm-central/log/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/caldav/calDavRequestHandlers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/ics/calICSCalendar.js">calendar/providers/ics/calICSCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/ics/calICSCalendar.js">file</a> |
<a href="/comm-central/annotate/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/ics/calICSCalendar.js">annotate</a> |
<a href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/ics/calICSCalendar.js">diff</a> |
<a href="/comm-central/comparison/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/ics/calICSCalendar.js">comparison</a> |
<a href="/comm-central/log/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/ics/calICSCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/memory/calMemoryCalendar.js">calendar/providers/memory/calMemoryCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/memory/calMemoryCalendar.js">file</a> |
<a href="/comm-central/annotate/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/memory/calMemoryCalendar.js">annotate</a> |
<a href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/memory/calMemoryCalendar.js">diff</a> |
<a href="/comm-central/comparison/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/memory/calMemoryCalendar.js">comparison</a> |
<a href="/comm-central/log/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/memory/calMemoryCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/storage/calStorageUpgrade.jsm">calendar/providers/storage/calStorageUpgrade.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/storage/calStorageUpgrade.jsm">file</a> |
<a href="/comm-central/annotate/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/storage/calStorageUpgrade.jsm">annotate</a> |
<a href="/comm-central/diff/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/storage/calStorageUpgrade.jsm">diff</a> |
<a href="/comm-central/comparison/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/storage/calStorageUpgrade.jsm">comparison</a> |
<a href="/comm-central/log/844b78f8712eccbd26cdc2679725464c093954bc/calendar/providers/storage/calStorageUpgrade.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/calendar-common-sets.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/calendar-common-sets.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -473,17 +473,18 @@ var calendarController = {</span>
<a href="#l1.4"></a><span id="l1.4">         let selected_events_requires_network = 0;</span>
<a href="#l1.5"></a><span id="l1.5">         let selected_events_invitation = 0;</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7">         if (selLength &gt; 0) {</span>
<a href="#l1.8"></a><span id="l1.8">             for each (var item in selectedItems) {</span>
<a href="#l1.9"></a><span id="l1.9">                 if (item.calendar.readOnly) {</span>
<a href="#l1.10"></a><span id="l1.10">                     selected_events_readonly++;</span>
<a href="#l1.11"></a><span id="l1.11">                 }</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-                if (item.calendar.getProperty(&quot;requiresNetwork&quot;)) {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+                if (item.calendar.getProperty(&quot;requiresNetwork&quot;) &amp;&amp;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+                    !item.calendar.getProperty(&quot;cache.enabled&quot;)) {</span>
<a href="#l1.15"></a><span id="l1.15">                     selected_events_requires_network++;</span>
<a href="#l1.16"></a><span id="l1.16">                 }</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18">                 if (cal.isInvitation(item)) {</span>
<a href="#l1.19"></a><span id="l1.19">                     selected_events_invitation++;</span>
<a href="#l1.20"></a><span id="l1.20">                 } else if (item.organizer) {</span>
<a href="#l1.21"></a><span id="l1.21">                     // If we are the organizer and there are attendees, then</span>
<a href="#l1.22"></a><span id="l1.22">                     // this is likely also an invitation.</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineat">@@ -521,18 +522,20 @@ var calendarController = {</span>
<a href="#l1.24"></a><span id="l1.24">     selected_events_invitation: false,</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26">     /**</span>
<a href="#l1.27"></a><span id="l1.27">      * Returns a boolean indicating if its possible to write items to any</span>
<a href="#l1.28"></a><span id="l1.28">      * calendar.</span>
<a href="#l1.29"></a><span id="l1.29">      */</span>
<a href="#l1.30"></a><span id="l1.30">     get writable() {</span>
<a href="#l1.31"></a><span id="l1.31">         return !this.all_readonly &amp;&amp;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-               (!this.offline || (this.has_local_calendars &amp;&amp;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-               !this.all_local_calendars_readonly));</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+               (!this.offline ||</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+                this.has_cached_calendars ||</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+                (this.has_local_calendars &amp;&amp;</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+                 !this.all_local_calendars_readonly));</span>
<a href="#l1.38"></a><span id="l1.38">     },</span>
<a href="#l1.39"></a><span id="l1.39"> </span>
<a href="#l1.40"></a><span id="l1.40">     /**</span>
<a href="#l1.41"></a><span id="l1.41">      * Returns a boolean indicating if the application is currently in offline</span>
<a href="#l1.42"></a><span id="l1.42">      * mode.</span>
<a href="#l1.43"></a><span id="l1.43">      */</span>
<a href="#l1.44"></a><span id="l1.44">     get offline() {</span>
<a href="#l1.45"></a><span id="l1.45">         return getIOService().offline;</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineat">@@ -558,16 +561,31 @@ var calendarController = {</span>
<a href="#l1.47"></a><span id="l1.47">      * network access.</span>
<a href="#l1.48"></a><span id="l1.48">      */</span>
<a href="#l1.49"></a><span id="l1.49">     get has_local_calendars() {</span>
<a href="#l1.50"></a><span id="l1.50">         var calMgr = getCalendarManager();</span>
<a href="#l1.51"></a><span id="l1.51">         return (calMgr.networkCalendarCount &lt; calMgr.calendarCount);</span>
<a href="#l1.52"></a><span id="l1.52">     },</span>
<a href="#l1.53"></a><span id="l1.53"> </span>
<a href="#l1.54"></a><span id="l1.54">     /**</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+     * Returns a boolean indicating if there are cached calendars and thus that don't require</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+     * network access.</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+     */</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+    get has_cached_calendars() {</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+        let calMgr = getCalendarManager();</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+        let calendars = calMgr.getCalendars({});</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+        for each (let calendar in calendars) {</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+            if (calendar.getProperty(&quot;cache.enabled&quot;)) {</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+                return true;</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+            }</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+        }</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+        return false;</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+    },</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+    /**</span>
<a href="#l1.70"></a><span id="l1.70">      * Returns a boolean indicating that there is only one calendar left.</span>
<a href="#l1.71"></a><span id="l1.71">      */</span>
<a href="#l1.72"></a><span id="l1.72">     get last_calendar() {</span>
<a href="#l1.73"></a><span id="l1.73">         return (getCalendarManager().calendarCount &lt; 2);</span>
<a href="#l1.74"></a><span id="l1.74">     },</span>
<a href="#l1.75"></a><span id="l1.75"> </span>
<a href="#l1.76"></a><span id="l1.76">     /**</span>
<a href="#l1.77"></a><span id="l1.77">      * Returns a boolean indicating that all local calendars are readonly</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-conflicts-dialog.xul</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,91 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+&lt;!-- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+   - Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+   -</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+   - The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+   - 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+   - the License. You may obtain a copy of the License at</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+   - http://www.mozilla.org/MPL/</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+   -</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+   - Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+   - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+   - for the specific language governing rights and limitations under the</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+   - License.</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+   -</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+   - The Original Code is Mozilla Calendar code.</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+   -</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+   - The Initial Developer of the Original Code is</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+   -   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+   - Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+   - the Initial Developer. All Rights Reserved.</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+   -</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+   - Contributor(s):</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+   -</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+   - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+   - either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+   - the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+   - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+   - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+   - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+   - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+   - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+   - and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+   - the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+   - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+   -</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+   - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+&lt;?xml-stylesheet type=&quot;text/css&quot; href=&quot;chrome://global/skin/global.css&quot;?&gt;</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+&lt;?xml-stylesheet type=&quot;text/css&quot; href=&quot;chrome://calendar/skin/calendar-views.css&quot;?&gt;</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+&lt;dialog id=&quot;calendar-conflicts-dialog&quot;</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+        windowtype=&quot;Calendar:Conflicts&quot;</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+        onload=&quot;onLoad()&quot;</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+        ondialogaccept=&quot;return onAccept();&quot;</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+        ondialogcancel=&quot;return onCancel();&quot;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+        persist=&quot;screenX screenY&quot;</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+        xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/mouseoverPreviews.js&quot;/&gt;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;&gt;&lt;![CDATA[</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+    Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+    function onLoad() {</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+        let docEl = document.documentElement;</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+        let item = window.arguments[0].item;</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+        let vbox = getPreviewForEvent(item);</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+        let descr = document.getElementById(&quot;conflicts-description&quot;);</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+        descr.parentNode.insertBefore(vbox, descr);</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+        // TODO These strings should move to DTD files, but we don't want to</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+        // disrupt string freeze right now. For that matter, this dialog</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+        // should be reworked!</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+        docEl.title =  cal.calGetString(&quot;calendar&quot;, &quot;itemModifiedOnServerTitle&quot;);</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+        descr.textContent = cal.calGetString(&quot;calendar&quot;, &quot;itemModifiedOnServer&quot;);</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+        if (window.arguments[0].mode == &quot;modify&quot;) {</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+            descr.textContent += cal.calGetString(&quot;calendar&quot;, &quot;modifyWillLoseData&quot;);</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+            docEl.getButton(&quot;accept&quot;).setAttribute(&quot;label&quot;, cal.calGetString(&quot;calendar&quot;, &quot;proceedModify&quot;));</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+        } else {</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+            promptMessage += cal.calGetString(&quot;calendar&quot;, &quot;deleteWillLoseData&quot;);</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+            docEl.getButton(&quot;accept&quot;).setAttribute(&quot;label&quot;, cal.calGetString(&quot;calendar&quot;, &quot;proceedDelete&quot;));</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+        }</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+        docEl.getButton(&quot;cancel&quot;).setAttribute(&quot;label&quot;, cal.calGetString(&quot;calendar&quot;, &quot;updateFromServer&quot;));</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+        window.sizeToContent();</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+    }</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+    function onAccept() {</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+        window.arguments[0].overwrite = true;</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+    }</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+    function onCancel() {</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+        window.arguments[0].overwrite = false;</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+    }</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+  ]]&gt;&lt;/script&gt;</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+  &lt;vbox id=&quot;conflicts-vbox&quot;&gt;</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+    &lt;description id=&quot;conflicts-description&quot;</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+                 style=&quot;max-width: 40em; margin-top: 1ex&quot;/&gt;</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+  &lt;/vbox&gt;</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+&lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/jar.mn</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/jar.mn</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -36,16 +36,17 @@ calendar.jar:</span>
<a href="#l3.4"></a><span id="l3.4">     content/calendar/calendar-view-bindings.css            (content/calendar-view-bindings.css)</span>
<a href="#l3.5"></a><span id="l3.5">     content/calendar/calendar-view-core.xml                (content/calendar-view-core.xml)</span>
<a href="#l3.6"></a><span id="l3.6">     content/calendar/calendar-views.js                     (content/calendar-views.js)</span>
<a href="#l3.7"></a><span id="l3.7">     content/calendar/import-export.js                      (content/import-export.js)</span>
<a href="#l3.8"></a><span id="l3.8">     content/calendar/today-pane.xul                        (content/today-pane.xul)</span>
<a href="#l3.9"></a><span id="l3.9">     content/calendar/today-pane.js                         (content/today-pane.js)</span>
<a href="#l3.10"></a><span id="l3.10">     content/calendar/calendar-alarm-dialog.js              (content/dialogs/calendar-alarm-dialog.js)</span>
<a href="#l3.11"></a><span id="l3.11">     content/calendar/calendar-alarm-dialog.xul             (content/dialogs/calendar-alarm-dialog.xul)</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    content/calendar/calendar-conflicts-dialog.xul         (content/dialogs/calendar-conflicts-dialog.xul)</span>
<a href="#l3.13"></a><span id="l3.13">     content/calendar/calendar-creation.js                  (content/dialogs/calendar-creation.js)</span>
<a href="#l3.14"></a><span id="l3.14">     content/calendar/calendar-dialog-utils.js              (content/dialogs/calendar-dialog-utils.js)</span>
<a href="#l3.15"></a><span id="l3.15">     content/calendar/calendar-error-prompt.xul             (content/dialogs/calendar-error-prompt.xul)</span>
<a href="#l3.16"></a><span id="l3.16">     content/calendar/calendar-event-dialog.css             (content/dialogs/calendar-event-dialog.css)</span>
<a href="#l3.17"></a><span id="l3.17">     content/calendar/calendar-event-dialog.js              (content/dialogs/calendar-event-dialog.js)</span>
<a href="#l3.18"></a><span id="l3.18">     content/calendar/calendar-event-dialog.xul             (content/dialogs/calendar-event-dialog.xul)</span>
<a href="#l3.19"></a><span id="l3.19">     content/calendar/calendar-event-dialog-attendees.xml   (content/dialogs/calendar-event-dialog-attendees.xml)</span>
<a href="#l3.20"></a><span id="l3.20">     content/calendar/calendar-event-dialog-freebusy.xml    (content/dialogs/calendar-event-dialog-freebusy.xml)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -476,16 +476,30 @@ cal.toRFC3339 = function toRFC3339(aDate</span>
<a href="#l4.4"></a><span id="l4.4">         } else {</span>
<a href="#l4.5"></a><span id="l4.5">             // ZULU Time, according to ISO8601's timezone-offset</span>
<a href="#l4.6"></a><span id="l4.6">             str += &quot;Z&quot;;</span>
<a href="#l4.7"></a><span id="l4.7">         }</span>
<a href="#l4.8"></a><span id="l4.8">     }</span>
<a href="#l4.9"></a><span id="l4.9">     return str;</span>
<a href="#l4.10"></a><span id="l4.10"> };</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+cal.promptOverwrite = function cal_promptOverwrite(aMode, aItem) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    let window = cal.getCalendarWindow();</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+    let args = { item: aItem,</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+                 mode: aMode,</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+                 overwrite: false };</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+    window.openDialog(&quot;chrome://calendar/content/calendar-conflicts-dialog.xul&quot;,</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+                      &quot;calendarConflictsDialog&quot;,</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+                      &quot;chrome,titlebar,modal&quot;,</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+                      args);</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+    return args.overwrite;</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+};</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+</span>
<a href="#l4.26"></a><span id="l4.26"> /**</span>
<a href="#l4.27"></a><span id="l4.27">  * Observer bag implementation taking care to replay open batch notifications.</span>
<a href="#l4.28"></a><span id="l4.28">  */</span>
<a href="#l4.29"></a><span id="l4.29"> cal.ObserverBag = function calObserverBag(iid) {</span>
<a href="#l4.30"></a><span id="l4.30">     this.init(iid);</span>
<a href="#l4.31"></a><span id="l4.31"> };</span>
<a href="#l4.32"></a><span id="l4.32"> cal.ObserverBag.prototype = {</span>
<a href="#l4.33"></a><span id="l4.33">     __proto__: cal.calListenerBag.prototype,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/public/calICalendar.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/public/calICalendar.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -275,16 +275,26 @@ interface calICalendar : nsISupports</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5">   /**</span>
<a href="#l5.6"></a><span id="l5.6">    * Scope: Attendee</span>
<a href="#l5.7"></a><span id="l5.7">    * Filter items that correspond to an invitation from another</span>
<a href="#l5.8"></a><span id="l5.8">    * user and the current user has not replied to it yet.</span>
<a href="#l5.9"></a><span id="l5.9">    */</span>
<a href="#l5.10"></a><span id="l5.10">   const unsigned long ITEM_FILTER_REQUEST_NEEDS_ACTION = 1 &lt;&lt; 17;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+  /**</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+   * Flags for items that have been created, modified or deleted while</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+   * offline.</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+   * ITEM_FILTER_OFFLINE_DELETED is a particular case in that elements *must*</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+   * be excluded from searches when not specified in the filter mask.</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+   */</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+  const unsigned long ITEM_FILTER_OFFLINE_CREATED = 1 &lt;&lt; 29;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+  const unsigned long ITEM_FILTER_OFFLINE_MODIFIED = 1 &lt;&lt; 30;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+  const unsigned long ITEM_FILTER_OFFLINE_DELETED = 1 &lt;&lt; 31;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+</span>
<a href="#l5.22"></a><span id="l5.22">   void addObserver( in calIObserver observer );</span>
<a href="#l5.23"></a><span id="l5.23">   void removeObserver( in calIObserver observer );</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25">   /**</span>
<a href="#l5.26"></a><span id="l5.26">    * The following five &quot;Item&quot; functions are all asynchronous, and return</span>
<a href="#l5.27"></a><span id="l5.27">    * their results to a calIOperationListener object.</span>
<a href="#l5.28"></a><span id="l5.28">    *</span>
<a href="#l5.29"></a><span id="l5.29">    */</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineat">@@ -337,16 +347,19 @@ interface calICalendar : nsISupports</span>
<a href="#l5.31"></a><span id="l5.31">    * status of NS_ERROR_XXXXX.  If the item is immutable,</span>
<a href="#l5.32"></a><span id="l5.32">    * onOperationComplete is called with a status of NS_ERROR_XXXXX.</span>
<a href="#l5.33"></a><span id="l5.33">    *</span>
<a href="#l5.34"></a><span id="l5.34">    * If the generation of the given aNewItem does not match the generation</span>
<a href="#l5.35"></a><span id="l5.35">    * of the internal item (indicating that someone else modified the</span>
<a href="#l5.36"></a><span id="l5.36">    * item), onOperationComplete is called with a status of NS_ERROR_XXXXX</span>
<a href="#l5.37"></a><span id="l5.37">    * and aDetail is set to the latest-version internal immutable item.</span>
<a href="#l5.38"></a><span id="l5.38">    *</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+   * If you would like to disable revision checks, pass null as aOldItem. This</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+   * will overwrite the item on the server.</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+   *</span>
<a href="#l5.42"></a><span id="l5.42">    * @param aNewItem    new version to replace the old one</span>
<a href="#l5.43"></a><span id="l5.43">    * @param aOldItem    caller's view of the item to be changed, as it is now</span>
<a href="#l5.44"></a><span id="l5.44">    * @param aListener   where to call back the results</span>
<a href="#l5.45"></a><span id="l5.45">    * @return            optional operation handle to track the operation</span>
<a href="#l5.46"></a><span id="l5.46">    *</span>
<a href="#l5.47"></a><span id="l5.47">    * The results of the operation are reported through an</span>
<a href="#l5.48"></a><span id="l5.48">    * onOperationComplete call on the listener, with the following</span>
<a href="#l5.49"></a><span id="l5.49">    * parameters:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/public/calIChangeLog.idl</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/public/calIChangeLog.idl</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -36,16 +36,64 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> #include &quot;calICalendar.idl&quot;</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> interface calIGenericOperationListener;</span>
<a href="#l6.9"></a><span id="l6.9"> interface calIOperation;</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> /**</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+ * Interface for managing offline flags in offline storage</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+ * (calStorageCalendar), in particular from calICachedCalendar.</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+ */</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+[scriptable, uuid(36dc2c93-5851-40d2-9ba9-b1f6e682c75c)]</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+interface calIOfflineStorage : calICalendar {</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+    /**</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+     * Mark the item of which the id is passed as parameter as new.</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+     *</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+     * @param aItem       the item to add</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+     * @param aListener   where to call back the results</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+     */</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+    void addOfflineItem(in calIItemBase aItem, in calIOperationListener aListener);</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+    /**</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+     * Mark the item of which the id is passed as parameter as modified.</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+     *</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+     * @param aItem       the item to modify</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+     * @param aListener   where to call back the results</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+     */</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+    void modifyOfflineItem(in calIItemBase aItem, in calIOperationListener aListener);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+    /**</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+     * Mark the item of which the id is passed as parameter as deleted.</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+     *</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+     * @param aItem       the item to delete</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+     * @param aListener   where to call back the results</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+     */</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+    void deleteOfflineItem(in calIItemBase aItem, in calIOperationListener aListener);</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+    /**</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+     * Retrieves the offline flag for the given item. The flag is returned using the</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+     * detail parameter of the onOperationComplete function in calIOperationLIstener.</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+     *</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+     * @param aItem       the item to reset</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+     * @param aListener   where to call back the results</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+     */</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+    void getItemOfflineFlag(in calIItemBase aItem, in calIOperationListener aListener);</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+    /**</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+     * Remove any offline flag from the item record.</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+     *</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+     * @param aItem       the item to reset</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+     * @param aListener   where to call back the results</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+     */</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+    void resetItemOfflineFlag(in calIItemBase aItem, in calIOperationListener aListener);</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+};</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+/**</span>
<a href="#l6.60"></a><span id="l6.60">  * Interface for synchronously working providers on storing items,</span>
<a href="#l6.61"></a><span id="l6.61">  * e.g. storage, memory. All modifying commands return after the</span>
<a href="#l6.62"></a><span id="l6.62">  * modification has been performed.</span>
<a href="#l6.63"></a><span id="l6.63">  *</span>
<a href="#l6.64"></a><span id="l6.64">  * @note</span>
<a href="#l6.65"></a><span id="l6.65">  *   This interface is used in conjunction with changelog-based synchronization</span>
<a href="#l6.66"></a><span id="l6.66">  *   and additionally offers storing meta-data for items for this purpose.</span>
<a href="#l6.67"></a><span id="l6.67">  *   The meta data is stored as long as the corresponding items persist in</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineat">@@ -95,16 +143,27 @@ interface calISyncWriteCalendar : calICa</span>
<a href="#l6.69"></a><span id="l6.69">  * changelog data. This could for example mean, that the provider can retrieve</span>
<a href="#l6.70"></a><span id="l6.70">  * changes between now and the last sync.</span>
<a href="#l6.71"></a><span id="l6.71">  *</span>
<a href="#l6.72"></a><span id="l6.72">  * Not implementing this interface is perfectly valid for calendars, that need</span>
<a href="#l6.73"></a><span id="l6.73">  * to do a full sync each time anyway (i.e ics)</span>
<a href="#l6.74"></a><span id="l6.74">  */</span>
<a href="#l6.75"></a><span id="l6.75"> [scriptable, uuid(0bf4c6a2-b4c7-4cae-993a-4408d8bded3e)]</span>
<a href="#l6.76"></a><span id="l6.76"> interface calIChangeLog : nsISupports {</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+    // To denote no offline flag, use null</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+    const long OFFLINE_FLAG_CREATED_RECORD = 1;</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+    const long OFFLINE_FLAG_MODIFIED_RECORD = 2;</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+    const long OFFLINE_FLAG_DELETED_RECORD = 4;</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+    /**</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+     * Enable the changelog calendar to retrieve offline data right after instanciation.</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+     */</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+    attribute calISyncWriteCalendar offlineStorage;</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+</span>
<a href="#l6.88"></a><span id="l6.88">     /**</span>
<a href="#l6.89"></a><span id="l6.89">      * Resets the changelog. This is used if the cache should be refreshed.</span>
<a href="#l6.90"></a><span id="l6.90">      */</span>
<a href="#l6.91"></a><span id="l6.91">     void resetLog();</span>
<a href="#l6.92"></a><span id="l6.92"> </span>
<a href="#l6.93"></a><span id="l6.93">     /**</span>
<a href="#l6.94"></a><span id="l6.94">      * Instructs the calendar to replay remote changes into the given</span>
<a href="#l6.95"></a><span id="l6.95">      * calendar. The calendar itself is responsible for storing anything needed</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineat">@@ -112,11 +171,50 @@ interface calIChangeLog : nsISupports {</span>
<a href="#l6.97"></a><span id="l6.97">      *</span>
<a href="#l6.98"></a><span id="l6.98">      * TODO: We might reconsider to replay on calICalendar,</span>
<a href="#l6.99"></a><span id="l6.99">      *       but this complicates implementing this interface</span>
<a href="#l6.100"></a><span id="l6.100">      *       enormously for providers.</span>
<a href="#l6.101"></a><span id="l6.101">      *</span>
<a href="#l6.102"></a><span id="l6.102">      * @param aDestination      The calendar to sync changes into</span>
<a href="#l6.103"></a><span id="l6.103">      * @param aListener         The listener to notify when the operation completes.</span>
<a href="#l6.104"></a><span id="l6.104">      */</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-    calIOperation replayChangesOn(in calISyncWriteCalendar aDestination,</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-                                  in calIGenericOperationListener aListener);</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+    calIOperation replayChangesOn(in calIGenericOperationListener aListener);</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+    /**</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+     * addItemOrUseCache: same as calICalendar::addItem</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+     *</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+     * @param useCache          use the cache for handling availability errors</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+     *</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+     * When 'useCache' is set, failure to perform the operation will result in</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+     * a write in the cache with the corresponding offline operation, when the</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+     * backend supports it. In that case, the listener will thus always</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+     * receive a success code. When unset, the behaviour is similar to the</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+     * corresponding addItem() invocation.</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+     */</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+    calIOperation addItemOrUseCache(in calIItemBase aItem,</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+                                    in boolean useCache,</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+                                    in calIOperationListener aListener);</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+    /**</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+     * adoptItemOrUseCache: same as calICalendar::adoptItem</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+     *</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+     * @param useCache          use the cache for handling availability errors</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+     */</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+    calIOperation adoptItemOrUseCache(in calIItemBase aItem,</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+                                      in boolean useCache,</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+                                      in calIOperationListener aListener);</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+    /**</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+     * modifyItemOrUseCache: same as calICalendar::modifyItem</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+     *</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+     * @param useCache          use the cache for handling availability errors</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+     */</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+    calIOperation modifyItemOrUseCache(in calIItemBase aNewItem,</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+                                       in calIItemBase aOldItem,</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+                                       in boolean useCache,</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+                                       in calIOperationListener aListener);</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+    /**</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+     * deleteItemOrUseCache: same as calICalendar::deleteItem</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+     *</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+     * @param useCache          use the cache for handling availability errors</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+     */</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+    calIOperation deleteItemOrUseCache(in calIItemBase aItem,</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+                                       in boolean useCache,</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+                                       in calIOperationListener aListener);</span>
<a href="#l6.148"></a><span id="l6.148"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/src/calCachedCalendar.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/src/calCachedCalendar.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -32,16 +32,27 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.5"></a><span id="l7.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.6"></a><span id="l7.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.7"></a><span id="l7.7">  *</span>
<a href="#l7.8"></a><span id="l7.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+const calICalendar = Components.interfaces.calICalendar;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+const cICL = Components.interfaces.calIChangeLog;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+let gNoOpListener = {</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+    onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+    },</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+    onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+    }</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+};</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+</span>
<a href="#l7.23"></a><span id="l7.23"> function calCachedCalendarObserverHelper(home, isCachedObserver) {</span>
<a href="#l7.24"></a><span id="l7.24">     this.home = home;</span>
<a href="#l7.25"></a><span id="l7.25">     this.isCachedObserver = isCachedObserver;</span>
<a href="#l7.26"></a><span id="l7.26"> }</span>
<a href="#l7.27"></a><span id="l7.27"> calCachedCalendarObserverHelper.prototype = {</span>
<a href="#l7.28"></a><span id="l7.28">     isCachedObserver: false,</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30">     onStartBatch: function() {</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineat">@@ -56,20 +67,19 @@ calCachedCalendarObserverHelper.prototyp</span>
<a href="#l7.32"></a><span id="l7.32">         if (this.isCachedObserver) {</span>
<a href="#l7.33"></a><span id="l7.33">             this.home.mObservers.notify(&quot;onLoad&quot;, [this.home]);</span>
<a href="#l7.34"></a><span id="l7.34">         } else {</span>
<a href="#l7.35"></a><span id="l7.35">             // start sync action after uncached calendar has been loaded.</span>
<a href="#l7.36"></a><span id="l7.36">             // xxx todo, think about:</span>
<a href="#l7.37"></a><span id="l7.37">             // although onAddItem et al have been called, we need to fire</span>
<a href="#l7.38"></a><span id="l7.38">             // an additional onLoad completing the refresh call (-&gt;composite)</span>
<a href="#l7.39"></a><span id="l7.39">             var home = this.home;</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-            home.synchronize(</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-                function(status) {</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-                    home.mObservers.notify(&quot;onLoad&quot;, [home]);</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-                });</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+            home.synchronize(function(status) {</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+                home.mObservers.notify(&quot;onLoad&quot;, [home]);</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+            });</span>
<a href="#l7.47"></a><span id="l7.47">         }</span>
<a href="#l7.48"></a><span id="l7.48">     },</span>
<a href="#l7.49"></a><span id="l7.49"> </span>
<a href="#l7.50"></a><span id="l7.50">     onAddItem: function(aItem) {</span>
<a href="#l7.51"></a><span id="l7.51">         if (this.isCachedObserver) {</span>
<a href="#l7.52"></a><span id="l7.52">             this.home.mObservers.notify(&quot;onAddItem&quot;, arguments);</span>
<a href="#l7.53"></a><span id="l7.53">         }</span>
<a href="#l7.54"></a><span id="l7.54">     },</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineat">@@ -106,35 +116,42 @@ calCachedCalendarObserverHelper.prototyp</span>
<a href="#l7.56"></a><span id="l7.56"> function calCachedCalendar(uncachedCalendar) {</span>
<a href="#l7.57"></a><span id="l7.57">     this.wrappedJSObject = this;</span>
<a href="#l7.58"></a><span id="l7.58">     this.mSyncQueue = [];</span>
<a href="#l7.59"></a><span id="l7.59">     this.mObservers = new cal.ObserverBag(Components.interfaces.calIObserver);</span>
<a href="#l7.60"></a><span id="l7.60">     uncachedCalendar.superCalendar = this;</span>
<a href="#l7.61"></a><span id="l7.61">     uncachedCalendar.addObserver(new calCachedCalendarObserverHelper(this, false));</span>
<a href="#l7.62"></a><span id="l7.62">     this.mUncachedCalendar = uncachedCalendar;</span>
<a href="#l7.63"></a><span id="l7.63">     this.setupCachedCalendar();</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+    if (this.supportsChangeLog) {</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+        uncachedCalendar.offlineStorage = this.mCachedCalendar;</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+    }</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+    this.offlineCachedItems = {};</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+    this.offlineCachedItemFlags = {};</span>
<a href="#l7.69"></a><span id="l7.69"> }</span>
<a href="#l7.70"></a><span id="l7.70"> calCachedCalendar.prototype = {</span>
<a href="#l7.71"></a><span id="l7.71">     QueryInterface: function cCC_QueryInterface(aIID) {</span>
<a href="#l7.72"></a><span id="l7.72">         if (aIID.equals(Components.interfaces.calISchedulingSupport)) {</span>
<a href="#l7.73"></a><span id="l7.73">             // check whether uncached calendar supports it:</span>
<a href="#l7.74"></a><span id="l7.74">             if (this.mUncachedCalendar.QueryInterface(aIID)) {</span>
<a href="#l7.75"></a><span id="l7.75">                 return this;</span>
<a href="#l7.76"></a><span id="l7.76">             }</span>
<a href="#l7.77"></a><span id="l7.77">         }</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-        return doQueryInterface(this, calCachedCalendar.prototype, aIID,</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-                                [Components.interfaces.calICalendar,</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-                                 Components.interfaces.nsISupports]);</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+        return cal.doQueryInterface(this, calCachedCalendar.prototype, aIID,</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+                                    [Components.interfaces.calICalendar,</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+                                     Components.interfaces.nsISupports]);</span>
<a href="#l7.84"></a><span id="l7.84">     },</span>
<a href="#l7.85"></a><span id="l7.85"> </span>
<a href="#l7.86"></a><span id="l7.86">     mCachedCalendar: null,</span>
<a href="#l7.87"></a><span id="l7.87">     mCachedObserver: null,</span>
<a href="#l7.88"></a><span id="l7.88">     mUncachedCalendar: null,</span>
<a href="#l7.89"></a><span id="l7.89">     mObservers: null,</span>
<a href="#l7.90"></a><span id="l7.90">     mSuperCalendar: null,</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+    offlineCachedItems: null,</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+    offlineCachedItemFlags: null,</span>
<a href="#l7.93"></a><span id="l7.93"> </span>
<a href="#l7.94"></a><span id="l7.94">     onCalendarUnregistering: function() {</span>
<a href="#l7.95"></a><span id="l7.95">         if (this.mCachedCalendar) {</span>
<a href="#l7.96"></a><span id="l7.96">             this.mCachedCalendar.removeObserver(this.mCachedObserver);</span>
<a href="#l7.97"></a><span id="l7.97">             // Although this doesn't really follow the spec, we know the</span>
<a href="#l7.98"></a><span id="l7.98">             // storage calendar's deleteCalendar method is synchronous.</span>
<a href="#l7.99"></a><span id="l7.99">             // TODO put changes into a different calendar and delete</span>
<a href="#l7.100"></a><span id="l7.100">             // afterwards.</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineat">@@ -190,112 +207,419 @@ calCachedCalendar.prototype = {</span>
<a href="#l7.102"></a><span id="l7.102">                 cachedCalendar.addObserver(this.mCachedObserver);</span>
<a href="#l7.103"></a><span id="l7.103">                 this.mCachedCalendar = cachedCalendar;</span>
<a href="#l7.104"></a><span id="l7.104">             }</span>
<a href="#l7.105"></a><span id="l7.105">         } catch (exc) {</span>
<a href="#l7.106"></a><span id="l7.106">             Components.utils.reportError(exc);</span>
<a href="#l7.107"></a><span id="l7.107">         }</span>
<a href="#l7.108"></a><span id="l7.108">     },</span>
<a href="#l7.109"></a><span id="l7.109"> </span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+    getOfflineAddedItems: function cCC_getOfflineAddedItems(callbackFunc) {</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+        let this_ = this;</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+        this_.offlineCachedItems = {};</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+        let getListener = {</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+            onGetResult: function cCC_oOC_cL_onGetResult(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+                for each (let item in aItems) {</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+                    this_.offlineCachedItems[item.hashId] = item;</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+                    this_.offlineCachedItemFlags[item.hashId] = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+                }</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+            },</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+            onOperationComplete: function cCC_oOC_cL_onOperationComplete(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+                this_.getOfflineModifiedItems(callbackFunc);</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+            }</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+        };</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+        this.mCachedCalendar.getItems(calICalendar.ITEM_FILTER_ALL_ITEMS | calICalendar.ITEM_FILTER_OFFLINE_CREATED,</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+                                      0, null, null, getListener);</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+    },</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+    getOfflineModifiedItems: function cCC_getOfflineModifiedItems(callbackFunc) {</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+        let this_ = this;</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+        let getListener = {</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+            onGetResult: function cCC_oOC_cL_onGetResult(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+                for each (let item in aItems) {</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+                    this_.offlineCachedItems[item.hashId] = item;</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+                    this_.offlineCachedItemFlags[item.hashId] = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+                }</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+            },</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+            onOperationComplete: function cCC_oOC_cL_onOperationComplete(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+                this_.getOfflineDeletedItems(callbackFunc);</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+            }</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+        };</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+        this.mCachedCalendar.getItems(calICalendar.ITEM_FILTER_OFFLINE_MODIFIED | calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+                                      0, null, null, getListener);</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+    },</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+    getOfflineDeletedItems: function cCC_getOfflineDeletedItems(callbackFunc) {</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+        let this_ = this;</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+        let getListener = {</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+            onGetResult: function cCC_oOC_cL_onGetResult(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+                for each (let item in aItems) {</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+                    this_.offlineCachedItems[item.hashId] = item;</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+                    this_.offlineCachedItemFlags[item.hashId] = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+                }</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+            },</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+            onOperationComplete: function cCC_oOC_cL_onOperationComplete(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+                if (callbackFunc) {</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+                    callbackFunc();</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+                }</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+            }</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+        };</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+        this.mCachedCalendar.getItems(calICalendar.ITEM_FILTER_OFFLINE_DELETED | calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+                                      0, null, null, getListener);</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+    },</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+</span>
<a href="#l7.167"></a><span id="l7.167">     mPendingSync: null,</span>
<a href="#l7.168"></a><span id="l7.168">     mSyncQueue: null,</span>
<a href="#l7.169"></a><span id="l7.169">     synchronize: function cCC_synchronize(respFunc) {</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+        var this_ = this;</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+        if (this.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+            return emptyQueue(Components.results.NS_OK);</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+        }</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+</span>
<a href="#l7.175"></a><span id="l7.175">         this.mSyncQueue.push(respFunc);</span>
<a href="#l7.176"></a><span id="l7.176">         if (this.mSyncQueue.length &gt; 1) { // don't use mPendingSync here</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-            LOG(&quot;[calCachedCalendar] sync in action/pending.&quot;);</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+            cal.LOG(&quot;[calCachedCalendar] sync in action/pending.&quot;);</span>
<a href="#l7.179"></a><span id="l7.179">             return this.mPendingSync;</span>
<a href="#l7.180"></a><span id="l7.180">         }</span>
<a href="#l7.181"></a><span id="l7.181"> </span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-        var this_ = this;</span>
<a href="#l7.183"></a><span id="l7.183">         function emptyQueue(status) {</span>
<a href="#l7.184"></a><span id="l7.184">             var queue = this_.mSyncQueue;</span>
<a href="#l7.185"></a><span id="l7.185">             this_.mSyncQueue = [];</span>
<a href="#l7.186"></a><span id="l7.186">             function execResponseFunc(func) {</span>
<a href="#l7.187"></a><span id="l7.187">                 try {</span>
<a href="#l7.188"></a><span id="l7.188">                     func(status);</span>
<a href="#l7.189"></a><span id="l7.189">                 } catch (exc) {</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">-                    ASSERT(false, exc);</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+                    cal.ASSERT(false, exc);</span>
<a href="#l7.192"></a><span id="l7.192">                 }</span>
<a href="#l7.193"></a><span id="l7.193">             }</span>
<a href="#l7.194"></a><span id="l7.194">             queue.forEach(execResponseFunc);</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-            LOG(&quot;[calCachedCalendar] sync queue empty.&quot;);</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+            cal.LOG(&quot;[calCachedCalendar] sync queue empty.&quot;);</span>
<a href="#l7.197"></a><span id="l7.197">             var op = this_.mPendingSync;</span>
<a href="#l7.198"></a><span id="l7.198">             this_.mPendingSync = null;</span>
<a href="#l7.199"></a><span id="l7.199">             return op;</span>
<a href="#l7.200"></a><span id="l7.200">         }</span>
<a href="#l7.201"></a><span id="l7.201"> </span>
<a href="#l7.202"></a><span id="l7.202">         if (this.offline) {</span>
<a href="#l7.203"></a><span id="l7.203">             return emptyQueue(Components.results.NS_OK);</span>
<a href="#l7.204"></a><span id="l7.204">         }</span>
<a href="#l7.205"></a><span id="l7.205"> </span>
<a href="#l7.206"></a><span id="l7.206">         if (this.supportsChangeLog) {</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-            LOG(&quot;[calCachedCalendar] Doing changelog based sync for calendar &quot; + this.uri.spec);</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+            cal.LOG(&quot;[calCachedCalendar] Doing changelog based sync for calendar &quot; + this.uri.spec);</span>
<a href="#l7.209"></a><span id="l7.209">             var opListener = {</span>
<a href="#l7.210"></a><span id="l7.210">                 thisCalendar : this,</span>
<a href="#l7.211"></a><span id="l7.211">                 onResult: function(op, result) {</span>
<a href="#l7.212"></a><span id="l7.212">                     if (!op || !op.isPending) {</span>
<a href="#l7.213"></a><span id="l7.213">                         var status = (op ? op.status : Components.results.NS_OK);</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-                        ASSERT(Components.isSuccessCode(status), &quot;replay action failed: &quot; + (op ? op.id : &quot;&lt;unknown&gt;&quot;)+&quot;, uri=&quot; + this.thisCalendar.uri.spec + &quot;, result=&quot;  +result + &quot;, op=&quot; + op);</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineminus">-                        LOG(&quot;[calCachedCalendar] replayChangesOn finished.&quot;);</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+                        if (!Components.isSuccessCode(status)) {</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+                            cal.ERROR(&quot;[calCachedCalendar] replay action failed: &quot; +</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+                                      (op ? op.id : &quot;&lt;unknown&gt;&quot;)+&quot;, uri=&quot; +</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+                                      this.thisCalendar.uri.spec + &quot;, result=&quot; +</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+                                      result + &quot;, op=&quot; + op);</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+                        }</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+                        cal.LOG(&quot;[calCachedCalendar] replayChangesOn finished.&quot;);</span>
<a href="#l7.223"></a><span id="l7.223">                         emptyQueue(status);</span>
<a href="#l7.224"></a><span id="l7.224">                     }</span>
<a href="#l7.225"></a><span id="l7.225">                 }</span>
<a href="#l7.226"></a><span id="l7.226">             };</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-            this.mPendingSync = this.mUncachedCalendar.replayChangesOn(this.mCachedCalendar, opListener);</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+            this.mPendingSync = this.mUncachedCalendar.replayChangesOn(opListener);</span>
<a href="#l7.229"></a><span id="l7.229">             return this.mPendingSync;</span>
<a href="#l7.230"></a><span id="l7.230">         }</span>
<a href="#l7.231"></a><span id="l7.231"> </span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-        LOG(&quot;[calCachedCalendar] Doing full sync for calendar &quot; + this.uri.spec);</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-        // TODO put changes into a different calendar and delete</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineminus">-        // afterwards.</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineminus">-        var completeListener = {</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+        cal.LOG(&quot;[calCachedCalendar] Doing full sync for calendar &quot; + this.uri.spec);</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+        let completeListener = {</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+            modifiedTimes: {},</span>
<a href="#l7.239"></a><span id="l7.239">             hasRenewedCalendar: false,</span>
<a href="#l7.240"></a><span id="l7.240">             onGetResult: function cCC_oOC_cL_onGetResult(aCalendar,</span>
<a href="#l7.241"></a><span id="l7.241">                                                          aStatus,</span>
<a href="#l7.242"></a><span id="l7.242">                                                          aItemType,</span>
<a href="#l7.243"></a><span id="l7.243">                                                          aDetail,</span>
<a href="#l7.244"></a><span id="l7.244">                                                          aCount,</span>
<a href="#l7.245"></a><span id="l7.245">                                                          aItems) {</span>
<a href="#l7.246"></a><span id="l7.246">                 if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l7.247"></a><span id="l7.247">                     if (!this.hasRenewedCalendar) {</span>
<a href="#l7.248"></a><span id="l7.248">                         // TODO instead of deleting the calendar and creating a new</span>
<a href="#l7.249"></a><span id="l7.249">                         // one, maybe we want to do a &quot;real&quot; sync between the</span>
<a href="#l7.250"></a><span id="l7.250">                         // existing local calendar and the remote calendar.</span>
<a href="#l7.251"></a><span id="l7.251">                         this_.setupCachedCalendar();</span>
<a href="#l7.252"></a><span id="l7.252">                         this.hasRenewedCalendar = true;</span>
<a href="#l7.253"></a><span id="l7.253">                     }</span>
<a href="#l7.254"></a><span id="l7.254">                     for each (var item in aItems) {</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineplus">+                        // Adding items recd from the Memory Calendar</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineplus">+                        // These may be different than what the cache has</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineplus">+                        this.modifiedTimes[item.id] = item.lastModifiedTime;</span>
<a href="#l7.258"></a><span id="l7.258">                         this_.mCachedCalendar.addItem(item, null);</span>
<a href="#l7.259"></a><span id="l7.259">                     }</span>
<a href="#l7.260"></a><span id="l7.260">                 }</span>
<a href="#l7.261"></a><span id="l7.261">             },</span>
<a href="#l7.262"></a><span id="l7.262"> </span>
<a href="#l7.263"></a><span id="l7.263">             onOperationComplete: function cCC_oOC_cL_onOperationComplete(aCalendar,</span>
<a href="#l7.264"></a><span id="l7.264">                                                                          aStatus,</span>
<a href="#l7.265"></a><span id="l7.265">                                                                          aOpType,</span>
<a href="#l7.266"></a><span id="l7.266">                                                                          aId,</span>
<a href="#l7.267"></a><span id="l7.267">                                                                          aDetail) {</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineminus">-                ASSERT(Components.isSuccessCode(aStatus), &quot;getItems failed: &quot; + aStatus);</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineplus">+                if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineplus">+                    for each (let item in this_.offlineCachedItems) {</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineplus">+                        switch (this_.offlineCachedItemFlags[item.hashId]) {</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineplus">+                            case cICL.OFFLINE_FLAG_CREATED_RECORD:</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineplus">+                                // Created items are not present on the server, so its safe to adopt them</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+                                this_.adoptOfflineItem(item.clone(), null);</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineplus">+                                break;</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineplus">+                            case cICL.OFFLINE_FLAG_MODIFIED_RECORD:</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineplus">+                                // Two Cases Here:</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineplus">+                                if (item.id in this.modifiedTimes) {</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineplus">+                                    // The item is still on the server, we just retrieved it in the listener above.</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineplus">+                                    if (item.lastModifiedTime.compare(this.modifiedTimes[item.id]) &lt; 0) {</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+                                        // The item on the server has been modified, ask to overwrite</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+                                        cal.WARN(&quot;[calCachedCalendar] Item '&quot; + item.title + &quot;' at the server seems to be modified recently.&quot;);</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+                                        this_.promptOverwrite(&quot;modify&quot;, item, null, null);</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+                                    } else {</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+                                        // Our item is newer, just modify the item</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineplus">+                                        this_.modifyOfflineItem(item, null, null);</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineplus">+                                    }</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineplus">+                                } else {</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineplus">+                                    // The item has been deleted from the server, ask if it should be added again</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineplus">+                                    cal.WARN(&quot;[calCachedCalendar] Item '&quot; + item.title + &quot;' has been deleted from the server&quot;);</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineplus">+                                    if (cal.promptOverwrite(&quot;modify&quot;, item, null, null)) {</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineplus">+                                        this_.adoptOfflineItem(item.clone(), null);</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineplus">+                                    }</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineplus">+                                }</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineplus">+                                break;</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineplus">+                            case cICL.OFFLINE_FLAG_DELETED_RECORD:</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineplus">+                                if (item.id in this.modifiedTimes) {</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineplus">+                                    // The item seems to exist on the server...</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+                                    if (item.lastModifiedTime.compare(this.modifiedTimes[item.id]) &lt; 0) {</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+                                        // ...and has been modified on the server. Ask to overwrite</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+                                        cal.WARN(&quot;[calCachedCalendar] Item '&quot; + item.title + &quot;' at the server seems to be modified recently.&quot;);</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineplus">+                                        this_.promptOverwrite(&quot;delete&quot;, item, null, null);</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineplus">+                                    } else {</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineplus">+                                        // ...and has not been modified. Delete it now.</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineplus">+                                        this_.deleteOfflineItem(item, null);</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineplus">+                                    }</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineplus">+                                } else {</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineplus">+                                    // Item has already been deleted from the server, no need to change anything.</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineplus">+                                }</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineplus">+                                break;</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineplus">+                        }</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineplus">+                    }</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineplus">+                    this_.offlineCachedItems = {};</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineplus">+                    this_.offlineCachedItemFlags = {};</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineplus">+                }</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineplus">+                this_.playbackAddedItems(function() {this_.mCachedObserver.onLoad(this_.mCachedCalendar);});</span>
<a href="#l7.317"></a><span id="l7.317">                 emptyQueue(aStatus);</span>
<a href="#l7.318"></a><span id="l7.318">             }</span>
<a href="#l7.319"></a><span id="l7.319">         };</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineminus">-        this.mPendingSync = this.mUncachedCalendar.getItems(Components.interfaces.calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineminus">-                                                            0, null,  null, completeListener);</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineplus">+</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineplus">+        this.getOfflineAddedItems(function(){</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineplus">+            this_.mPendingSync = this_.mUncachedCalendar.getItems(Components.interfaces.calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineplus">+                                                                    0, null,  null, completeListener);</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineplus">+        });</span>
<a href="#l7.327"></a><span id="l7.327">         return this.mPendingSync;</span>
<a href="#l7.328"></a><span id="l7.328">     },</span>
<a href="#l7.329"></a><span id="l7.329"> </span>
<a href="#l7.330"></a><span id="l7.330">     onOfflineStatusChanged: function cCC_onOfflineStatusChanged(aNewState) {</span>
<a href="#l7.331"></a><span id="l7.331">         if (aNewState) {</span>
<a href="#l7.332"></a><span id="l7.332">             // Going offline: (XXX get items before going offline?) =&gt; we may ask the user to stay online a bit longer</span>
<a href="#l7.333"></a><span id="l7.333">         } else {</span>
<a href="#l7.334"></a><span id="l7.334">             // Going online (start replaying changes to the remote calendar)</span>
<a href="#l7.335"></a><span id="l7.335">             this.refresh();</span>
<a href="#l7.336"></a><span id="l7.336">         }</span>
<a href="#l7.337"></a><span id="l7.337">     },</span>
<a href="#l7.338"></a><span id="l7.338"> </span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+    //aOldItem is already in the cache</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+    promptOverwrite: function cCC_promptOverwrite(aMethod, aItem, aListener, aOldItem) {</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+        let overwrite = cal.promptOverwrite(aMethod, aItem, aListener, aOldItem);</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineplus">+        if (overwrite) {</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineplus">+            if (aMethod == &quot;modify&quot;) {</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineplus">+                this.modifyOfflineItem(aItem, aOldItem, aListener);</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineplus">+            } else {</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineplus">+                this.deleteOfflineItem(aItem, aListener);</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineplus">+            }</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineplus">+        }</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineplus">+    },</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineplus">+</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineplus">+    playbackAddedItems: function cCC_playbackAddedItems(callbackFunc) {</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineplus">+        let this_ = this;</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineplus">+        let storage = this.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineplus">+</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineplus">+        let resetListener = gNoOpListener;</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineplus">+</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineplus">+        let addListener = {</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineplus">+            itemCount: 0,</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineplus">+</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineplus">+            },</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineplus">+                if (Components.isSuccessCode(status)) {</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineplus">+                    storage.resetItemOfflineFlag(detail, resetListener);</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineplus">+                } else {</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineplus">+                    cal.LOG(&quot;[calCachedCalendar.js] Unable to playback the items to the server. Will try back again. Aborting\n&quot;);</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineplus">+                    // TODO does something need to be called back?</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineplus">+                }</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineplus">+</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineplus">+                this.itemCount--;</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineplus">+                if (this.itemCount == 0) {</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineplus">+                    this_.playbackModifiedItems(callbackFunc);</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineplus">+                }</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineplus">+            }</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineplus">+        };</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineplus">+</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineplus">+        let getListener = {</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineplus">+            items: [],</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineplus">+</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineplus">+                this.items = this.items.concat(items);</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineplus">+            },</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineplus">+                if (this_.offline) {</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineplus">+                    cal.LOG(&quot;[calCachedCalendar] back to offline mode, reconciliation aborted&quot;);</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineplus">+                    callbackFunc();</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineplus">+                } else {</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineplus">+                    cal.LOG(&quot;[calCachedCalendar] Adding &quot;  + this.items.length + &quot; items to &quot; + this_.name);</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineplus">+                    if (this.items.length &gt; 0) {</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineplus">+                        addListener.itemCount = this.items.length;</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineplus">+                        for each (var aItem in this.items) {</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineplus">+                            if (this_.supportsChangeLog) {</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineplus">+                                this_.mUncachedCalendar.addItemOrUseCache(aItem, false, addListener);</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineplus">+                            } else {</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineplus">+                                // default mechanism for providers not implementing calIChangeLog</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineplus">+                                this_.mUncachedCalendar.adoptItem(aItem.clone(), addListener);</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineplus">+                            }</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineplus">+                        }</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineplus">+                    } else {</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineplus">+                        this_.playbackModifiedItems(callbackFunc);</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineplus">+                    }</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineplus">+                }</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineplus">+                delete this.items;</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineplus">+            }</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineplus">+        };</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineplus">+</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineplus">+        this.mCachedCalendar.getItems(calICalendar.ITEM_FILTER_ALL_ITEMS | calICalendar.ITEM_FILTER_OFFLINE_CREATED,</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineplus">+                                      0, null, null, getListener);</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineplus">+    },</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineplus">+    playbackModifiedItems: function cCC_playbackModifiedItems(callbackFunc) {</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineplus">+        let this_ = this;</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineplus">+        let storage = this.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineplus">+</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineplus">+        let resetListener = gNoOpListener;</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineplus">+</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineplus">+        let modifyListener = {</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineplus">+            itemCount: 0,</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineplus">+                if (Components.isSuccessCode(status)) {</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineplus">+                    storage.resetItemOfflineFlag(detail, resetListener);</span>
<a href="#l7.422"></a><span id="l7.422" class="difflineplus">+                } else {</span>
<a href="#l7.423"></a><span id="l7.423" class="difflineplus">+                    cal.ERROR(&quot;[calCachedCalendar] Could not modify item &quot; + id + &quot; - &quot; + detail);</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineplus">+                }</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineplus">+</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineplus">+                this.itemCount--;</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineplus">+                if (this.itemCount == 0) {</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineplus">+                    // All items have been pushed in and this is the last.</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineplus">+                    // Continue with deleted items.</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineplus">+                    this_.playbackDeletedItems(callbackFunc);</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineplus">+                }</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineplus">+            }</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineplus">+        };</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineplus">+</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineplus">+        let getListener = {</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineplus">+            items: [],</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineplus">+</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineplus">+                this.items = this.items.concat(items);</span>
<a href="#l7.440"></a><span id="l7.440" class="difflineplus">+            },</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineplus">+                if (this_.offline) {</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineplus">+                    cal.LOG(&quot;[calCachedCalendar] Returning to offline mode, reconciliation aborted&quot;);</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineplus">+                    callbackFunc();</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineplus">+                } else {</span>
<a href="#l7.446"></a><span id="l7.446" class="difflineplus">+                    cal.LOG(&quot;[calCachedCalendar] Modifying &quot; + this.items.length + &quot; items in &quot; + this_.name);</span>
<a href="#l7.447"></a><span id="l7.447" class="difflineplus">+                    if (this.items.length &gt; 0) {</span>
<a href="#l7.448"></a><span id="l7.448" class="difflineplus">+                        modifyListener.itemCount = this.items.length;</span>
<a href="#l7.449"></a><span id="l7.449" class="difflineplus">+                        for each (let item in this.items) {</span>
<a href="#l7.450"></a><span id="l7.450" class="difflineplus">+                            if (this_.supportsChangeLog) {</span>
<a href="#l7.451"></a><span id="l7.451" class="difflineplus">+                                // The calendar supports the changelog functions, let it modify the item</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineplus">+                                // TODO is it ok to not have the old item here? Pass null or the new item?</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineplus">+                                this_.mUncachedCalendar.modifyItemOrUseCache(item, item, false, modifyListener);</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineplus">+                            } else {</span>
<a href="#l7.455"></a><span id="l7.455" class="difflineplus">+                                // Default strategy for providers not implementing calIChangeLog</span>
<a href="#l7.456"></a><span id="l7.456" class="difflineplus">+                                this_.mUncachedCalendar.modifyItem(item, null, modifyListener);</span>
<a href="#l7.457"></a><span id="l7.457" class="difflineplus">+                            }</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineplus">+                        }</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineplus">+                    } else {</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineplus">+                        this_.playbackDeletedItems(callbackFunc);</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineplus">+                    }</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineplus">+                }</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineplus">+                delete this.items;</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineplus">+            }</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineplus">+        };</span>
<a href="#l7.466"></a><span id="l7.466" class="difflineplus">+</span>
<a href="#l7.467"></a><span id="l7.467" class="difflineplus">+        this.mCachedCalendar.getItems(calICalendar.ITEM_FILTER_OFFLINE_MODIFIED | calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l7.468"></a><span id="l7.468" class="difflineplus">+                                      0, null, null, getListener);</span>
<a href="#l7.469"></a><span id="l7.469" class="difflineplus">+    },</span>
<a href="#l7.470"></a><span id="l7.470" class="difflineplus">+</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineplus">+    playbackDeletedItems: function cCC_playbackDeletedItems(callbackFunc) {</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineplus">+        let this_ = this;</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineplus">+        let storage = this.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l7.474"></a><span id="l7.474" class="difflineplus">+</span>
<a href="#l7.475"></a><span id="l7.475" class="difflineplus">+        let resetListener = this.gNoOpListener;</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineplus">+</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineplus">+        let deleteListener = {</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineplus">+            itemCount: 0,</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineplus">+                if (Components.isSuccessCode(status)) {</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineplus">+                    this_.mCachedCalendar.deleteItem(detail, resetListener);</span>
<a href="#l7.483"></a><span id="l7.483" class="difflineplus">+                    this.itemCount--;</span>
<a href="#l7.484"></a><span id="l7.484" class="difflineplus">+                    if (this.itemCount == 0 &amp;&amp; callbackFunc) {</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineplus">+                        callbackFunc();</span>
<a href="#l7.486"></a><span id="l7.486" class="difflineplus">+                    }</span>
<a href="#l7.487"></a><span id="l7.487" class="difflineplus">+                } else {</span>
<a href="#l7.488"></a><span id="l7.488" class="difflineplus">+                    // TODO do something on error</span>
<a href="#l7.489"></a><span id="l7.489" class="difflineplus">+                    cal.WARN(&quot;[calCachedCalendar] failed to playback deleted item &quot; + id + &quot; - &quot; + detail);</span>
<a href="#l7.490"></a><span id="l7.490" class="difflineplus">+                }</span>
<a href="#l7.491"></a><span id="l7.491" class="difflineplus">+            }</span>
<a href="#l7.492"></a><span id="l7.492" class="difflineplus">+        };</span>
<a href="#l7.493"></a><span id="l7.493" class="difflineplus">+</span>
<a href="#l7.494"></a><span id="l7.494" class="difflineplus">+        let getListener = {</span>
<a href="#l7.495"></a><span id="l7.495" class="difflineplus">+            items: [],</span>
<a href="#l7.496"></a><span id="l7.496" class="difflineplus">+</span>
<a href="#l7.497"></a><span id="l7.497" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l7.498"></a><span id="l7.498" class="difflineplus">+                this.items = this.items.concat(items);</span>
<a href="#l7.499"></a><span id="l7.499" class="difflineplus">+            },</span>
<a href="#l7.500"></a><span id="l7.500" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l7.501"></a><span id="l7.501" class="difflineplus">+                if (this_.offline) {</span>
<a href="#l7.502"></a><span id="l7.502" class="difflineplus">+                    cal.LOG(&quot;[calCachedCalendar] Returning to offline mode, reconciliation aborted&quot;);</span>
<a href="#l7.503"></a><span id="l7.503" class="difflineplus">+                    callbackFunc();</span>
<a href="#l7.504"></a><span id="l7.504" class="difflineplus">+                } else {</span>
<a href="#l7.505"></a><span id="l7.505" class="difflineplus">+                    cal.LOG(&quot;[calCachedCalendar] Deleting &quot;  + this.items.length + &quot; items from &quot; + this_.name);</span>
<a href="#l7.506"></a><span id="l7.506" class="difflineplus">+                    if (this.items.length &gt; 0) {</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineplus">+                        deleteListener.itemCount = this.items.length;</span>
<a href="#l7.508"></a><span id="l7.508" class="difflineplus">+                        for each (var aItem in this.items) {</span>
<a href="#l7.509"></a><span id="l7.509" class="difflineplus">+                            if (this_.supportsChangeLog) {</span>
<a href="#l7.510"></a><span id="l7.510" class="difflineplus">+                                this_.mUncachedCalendar.deleteItemOrUseCache(aItem, false, deleteListener);</span>
<a href="#l7.511"></a><span id="l7.511" class="difflineplus">+                            } else {</span>
<a href="#l7.512"></a><span id="l7.512" class="difflineplus">+                                //Default strategy for providers not implementing calIChangeLog</span>
<a href="#l7.513"></a><span id="l7.513" class="difflineplus">+                                this_.mUncachedCalendar.deleteItem(aItem, deleteListener);</span>
<a href="#l7.514"></a><span id="l7.514" class="difflineplus">+                            }</span>
<a href="#l7.515"></a><span id="l7.515" class="difflineplus">+                        }</span>
<a href="#l7.516"></a><span id="l7.516" class="difflineplus">+                    } else if (callbackFunc) {</span>
<a href="#l7.517"></a><span id="l7.517" class="difflineplus">+                        callbackFunc();</span>
<a href="#l7.518"></a><span id="l7.518" class="difflineplus">+                    }</span>
<a href="#l7.519"></a><span id="l7.519" class="difflineplus">+                }</span>
<a href="#l7.520"></a><span id="l7.520" class="difflineplus">+                delete this.items;</span>
<a href="#l7.521"></a><span id="l7.521" class="difflineplus">+            }</span>
<a href="#l7.522"></a><span id="l7.522" class="difflineplus">+        };</span>
<a href="#l7.523"></a><span id="l7.523" class="difflineplus">+</span>
<a href="#l7.524"></a><span id="l7.524" class="difflineplus">+        this.mCachedCalendar.getItems(calICalendar.ITEM_FILTER_OFFLINE_DELETED | calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l7.525"></a><span id="l7.525" class="difflineplus">+                                      0, null, null, getListener);</span>
<a href="#l7.526"></a><span id="l7.526" class="difflineplus">+    },</span>
<a href="#l7.527"></a><span id="l7.527" class="difflineplus">+</span>
<a href="#l7.528"></a><span id="l7.528">     get superCalendar() {</span>
<a href="#l7.529"></a><span id="l7.529">         return this.mSuperCalendar &amp;&amp; this.mSuperCalendar.superCalendar || this;</span>
<a href="#l7.530"></a><span id="l7.530">     },</span>
<a href="#l7.531"></a><span id="l7.531">     set superCalendar(val) {</span>
<a href="#l7.532"></a><span id="l7.532">         return (this.mSuperCalendar = val);</span>
<a href="#l7.533"></a><span id="l7.533">     },</span>
<a href="#l7.534"></a><span id="l7.534"> </span>
<a href="#l7.535"></a><span id="l7.535">     get offline() {</span>
<a href="#l7.536"></a><span id="l7.536" class="difflineat">@@ -304,16 +628,30 @@ calCachedCalendar.prototype = {</span>
<a href="#l7.537"></a><span id="l7.537">     get supportsChangeLog() {</span>
<a href="#l7.538"></a><span id="l7.538">         return calInstanceOf(this.mUncachedCalendar, Components.interfaces.calIChangeLog);</span>
<a href="#l7.539"></a><span id="l7.539">     },</span>
<a href="#l7.540"></a><span id="l7.540"> </span>
<a href="#l7.541"></a><span id="l7.541">     get canRefresh() { // enable triggering sync using the reload button</span>
<a href="#l7.542"></a><span id="l7.542">         return true;</span>
<a href="#l7.543"></a><span id="l7.543">     },</span>
<a href="#l7.544"></a><span id="l7.544">     refresh: function() {</span>
<a href="#l7.545"></a><span id="l7.545" class="difflineplus">+        if (this.offline) {</span>
<a href="#l7.546"></a><span id="l7.546" class="difflineplus">+            this.downstreamRefresh();</span>
<a href="#l7.547"></a><span id="l7.547" class="difflineplus">+        }</span>
<a href="#l7.548"></a><span id="l7.548" class="difflineplus">+        else {</span>
<a href="#l7.549"></a><span id="l7.549" class="difflineplus">+            /* we first ensure that any remaining offline items are reconciled with the calendar server */</span>
<a href="#l7.550"></a><span id="l7.550" class="difflineplus">+            let this_ = this;</span>
<a href="#l7.551"></a><span id="l7.551" class="difflineplus">+            if (this.supportsChangeLog) {</span>
<a href="#l7.552"></a><span id="l7.552" class="difflineplus">+                this.playbackAddedItems(this.downstreamRefresh.bind(this));</span>
<a href="#l7.553"></a><span id="l7.553" class="difflineplus">+            } else {</span>
<a href="#l7.554"></a><span id="l7.554" class="difflineplus">+                this.downstreamRefresh();</span>
<a href="#l7.555"></a><span id="l7.555" class="difflineplus">+            }</span>
<a href="#l7.556"></a><span id="l7.556" class="difflineplus">+        }</span>
<a href="#l7.557"></a><span id="l7.557" class="difflineplus">+    },</span>
<a href="#l7.558"></a><span id="l7.558" class="difflineplus">+    downstreamRefresh: function() {</span>
<a href="#l7.559"></a><span id="l7.559">         if (this.mUncachedCalendar.canRefresh &amp;&amp; !this.offline) {</span>
<a href="#l7.560"></a><span id="l7.560">             return this.mUncachedCalendar.refresh(); // will trigger synchronize once the calendar is loaded</span>
<a href="#l7.561"></a><span id="l7.561">         } else {</span>
<a href="#l7.562"></a><span id="l7.562">             var this_ = this;</span>
<a href="#l7.563"></a><span id="l7.563">             return this.synchronize(</span>
<a href="#l7.564"></a><span id="l7.564">                 function(status) { // fire completing onLoad for this refresh call</span>
<a href="#l7.565"></a><span id="l7.565">                     this_.mCachedObserver.onLoad(this_.mCachedCalendar);</span>
<a href="#l7.566"></a><span id="l7.566">                 });</span>
<a href="#l7.567"></a><span id="l7.567" class="difflineat">@@ -327,117 +665,156 @@ calCachedCalendar.prototype = {</span>
<a href="#l7.568"></a><span id="l7.568">         this.mObservers.remove(aObserver);</span>
<a href="#l7.569"></a><span id="l7.569">     },</span>
<a href="#l7.570"></a><span id="l7.570"> </span>
<a href="#l7.571"></a><span id="l7.571">     addItem: function(item, listener) {</span>
<a href="#l7.572"></a><span id="l7.572">         return this.adoptItem(item.clone(), listener);</span>
<a href="#l7.573"></a><span id="l7.573">     },</span>
<a href="#l7.574"></a><span id="l7.574">     adoptItem: function(item, listener) {</span>
<a href="#l7.575"></a><span id="l7.575">         if (this.offline) {</span>
<a href="#l7.576"></a><span id="l7.576" class="difflineminus">-            ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l7.577"></a><span id="l7.577" class="difflineminus">-            if (listener) {</span>
<a href="#l7.578"></a><span id="l7.578" class="difflineminus">-                listener.onOperationComplete(this, Components.interfaces.calIErrors.CAL_IS_READONLY,</span>
<a href="#l7.579"></a><span id="l7.579" class="difflineminus">-                                             Components.interfaces.calIOperation.ADD, null, null);</span>
<a href="#l7.580"></a><span id="l7.580" class="difflineminus">-            }</span>
<a href="#l7.581"></a><span id="l7.581" class="difflineminus">-            return null;</span>
<a href="#l7.582"></a><span id="l7.582" class="difflineplus">+            this.adoptOfflineItem(item, listener);</span>
<a href="#l7.583"></a><span id="l7.583" class="difflineplus">+            return;</span>
<a href="#l7.584"></a><span id="l7.584">         }</span>
<a href="#l7.585"></a><span id="l7.585">         // Forwarding add/modify/delete to the cached calendar using the calIObserver</span>
<a href="#l7.586"></a><span id="l7.586">         // callbacks would be advantageous, because the uncached provider could implement</span>
<a href="#l7.587"></a><span id="l7.587">         // a true push mechanism firing without being triggered from within the program.</span>
<a href="#l7.588"></a><span id="l7.588">         // But this would mean the uncached provider fires on the passed</span>
<a href="#l7.589"></a><span id="l7.589">         // calIOperationListener, e.g. *before* it fires on calIObservers</span>
<a href="#l7.590"></a><span id="l7.590">         // (because that order is undefined). Firing onOperationComplete before onAddItem et al</span>
<a href="#l7.591"></a><span id="l7.591">         // would result in this facade firing onOperationComplete even though the modification</span>
<a href="#l7.592"></a><span id="l7.592">         // hasn't yet been performed on the cached calendar (which happens in onAddItem et al).</span>
<a href="#l7.593"></a><span id="l7.593">         // Result is that we currently stick to firing onOperationComplete if the cached calendar</span>
<a href="#l7.594"></a><span id="l7.594">         // has performed the modification, see below:</span>
<a href="#l7.595"></a><span id="l7.595">         var this_ = this;</span>
<a href="#l7.596"></a><span id="l7.596">         var opListener = {</span>
<a href="#l7.597"></a><span id="l7.597">             onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l7.598"></a><span id="l7.598" class="difflineminus">-                ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l7.599"></a><span id="l7.599" class="difflineplus">+                cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l7.600"></a><span id="l7.600">             },</span>
<a href="#l7.601"></a><span id="l7.601">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l7.602"></a><span id="l7.602" class="difflineminus">-                if (Components.isSuccessCode(status)) {</span>
<a href="#l7.603"></a><span id="l7.603" class="difflineplus">+                if (Components.isSuccessCode(status) &amp;&amp; !this_.supportsChangeLog) {</span>
<a href="#l7.604"></a><span id="l7.604">                     this_.mCachedCalendar.addItem(detail, listener);</span>
<a href="#l7.605"></a><span id="l7.605">                 } else if (listener) {</span>
<a href="#l7.606"></a><span id="l7.606">                     listener.onOperationComplete(this_, status, opType, id, detail);</span>
<a href="#l7.607"></a><span id="l7.607">                 }</span>
<a href="#l7.608"></a><span id="l7.608">             }</span>
<a href="#l7.609"></a><span id="l7.609">         }</span>
<a href="#l7.610"></a><span id="l7.610" class="difflineplus">+        if (this.supportsChangeLog) {</span>
<a href="#l7.611"></a><span id="l7.611" class="difflineplus">+            return this.mUncachedCalendar.addItemOrUseCache(item, true, opListener);</span>
<a href="#l7.612"></a><span id="l7.612" class="difflineplus">+        }</span>
<a href="#l7.613"></a><span id="l7.613">         return this.mUncachedCalendar.adoptItem(item, opListener);</span>
<a href="#l7.614"></a><span id="l7.614">     },</span>
<a href="#l7.615"></a><span id="l7.615" class="difflineplus">+    adoptOfflineItem: function(item, listener) {</span>
<a href="#l7.616"></a><span id="l7.616" class="difflineplus">+        var this_ = this;</span>
<a href="#l7.617"></a><span id="l7.617" class="difflineplus">+        var opListener = {</span>
<a href="#l7.618"></a><span id="l7.618" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l7.619"></a><span id="l7.619" class="difflineplus">+                cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l7.620"></a><span id="l7.620" class="difflineplus">+            },</span>
<a href="#l7.621"></a><span id="l7.621" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l7.622"></a><span id="l7.622" class="difflineplus">+                if (Components.isSuccessCode(status)) {</span>
<a href="#l7.623"></a><span id="l7.623" class="difflineplus">+                    var storage = this_.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l7.624"></a><span id="l7.624" class="difflineplus">+                    storage.addOfflineItem(detail, listener);</span>
<a href="#l7.625"></a><span id="l7.625" class="difflineplus">+                } else if (listener) {</span>
<a href="#l7.626"></a><span id="l7.626" class="difflineplus">+                    listener.onOperationComplete(this_, status, opType, id, detail);</span>
<a href="#l7.627"></a><span id="l7.627" class="difflineplus">+                }</span>
<a href="#l7.628"></a><span id="l7.628" class="difflineplus">+            }</span>
<a href="#l7.629"></a><span id="l7.629" class="difflineplus">+        };</span>
<a href="#l7.630"></a><span id="l7.630" class="difflineplus">+        this.mCachedCalendar.adoptItem(item, opListener);</span>
<a href="#l7.631"></a><span id="l7.631" class="difflineplus">+    },</span>
<a href="#l7.632"></a><span id="l7.632"> </span>
<a href="#l7.633"></a><span id="l7.633">     modifyItem: function(newItem, oldItem, listener) {</span>
<a href="#l7.634"></a><span id="l7.634">         if (this.offline) {</span>
<a href="#l7.635"></a><span id="l7.635" class="difflineminus">-            ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l7.636"></a><span id="l7.636" class="difflineminus">-            if (listener) {</span>
<a href="#l7.637"></a><span id="l7.637" class="difflineminus">-                listener.onOperationComplete(this, Components.interfaces.calIErrors.CAL_IS_READONLY,</span>
<a href="#l7.638"></a><span id="l7.638" class="difflineminus">-                                             Components.interfaces.calIOperation.MODIFY, null, null);</span>
<a href="#l7.639"></a><span id="l7.639" class="difflineplus">+            this.modifyOfflineItem(newItem, oldItem, listener);</span>
<a href="#l7.640"></a><span id="l7.640" class="difflineplus">+            return;</span>
<a href="#l7.641"></a><span id="l7.641" class="difflineplus">+        }</span>
<a href="#l7.642"></a><span id="l7.642" class="difflineplus">+</span>
<a href="#l7.643"></a><span id="l7.643" class="difflineplus">+        // Forwarding add/modify/delete to the cached calendar using the calIObserver</span>
<a href="#l7.644"></a><span id="l7.644" class="difflineplus">+        // callbacks would be advantageous, because the uncached provider could implement</span>
<a href="#l7.645"></a><span id="l7.645" class="difflineplus">+        // a true push mechanism firing without being triggered from within the program.</span>
<a href="#l7.646"></a><span id="l7.646" class="difflineplus">+        // But this would mean the uncached provider fires on the passed</span>
<a href="#l7.647"></a><span id="l7.647" class="difflineplus">+        // calIOperationListener, e.g. *before* it fires on calIObservers</span>
<a href="#l7.648"></a><span id="l7.648" class="difflineplus">+        // (because that order is undefined). Firing onOperationComplete before onAddItem et al</span>
<a href="#l7.649"></a><span id="l7.649" class="difflineplus">+        // would result in this facade firing onOperationComplete even though the modification</span>
<a href="#l7.650"></a><span id="l7.650" class="difflineplus">+        // hasn't yet been performed on the cached calendar (which happens in onAddItem et al).</span>
<a href="#l7.651"></a><span id="l7.651" class="difflineplus">+        // Result is that we currently stick to firing onOperationComplete if the cached calendar</span>
<a href="#l7.652"></a><span id="l7.652" class="difflineplus">+        // has performed the modification, see below:</span>
<a href="#l7.653"></a><span id="l7.653" class="difflineplus">+        var this_ = this;</span>
<a href="#l7.654"></a><span id="l7.654" class="difflineplus">+        var opListener = {</span>
<a href="#l7.655"></a><span id="l7.655" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l7.656"></a><span id="l7.656" class="difflineplus">+                cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l7.657"></a><span id="l7.657" class="difflineplus">+            },</span>
<a href="#l7.658"></a><span id="l7.658" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l7.659"></a><span id="l7.659" class="difflineplus">+                if (Components.isSuccessCode(status)) {</span>
<a href="#l7.660"></a><span id="l7.660" class="difflineplus">+                    this_.mCachedCalendar.modifyItem(detail, oldItem, listener);</span>
<a href="#l7.661"></a><span id="l7.661" class="difflineplus">+                } else if (listener) {</span>
<a href="#l7.662"></a><span id="l7.662" class="difflineplus">+                    listener.onOperationComplete(this_, status, opType, id, detail);</span>
<a href="#l7.663"></a><span id="l7.663" class="difflineplus">+                }</span>
<a href="#l7.664"></a><span id="l7.664">             }</span>
<a href="#l7.665"></a><span id="l7.665" class="difflineminus">-            return null;</span>
<a href="#l7.666"></a><span id="l7.666" class="difflineplus">+        }</span>
<a href="#l7.667"></a><span id="l7.667" class="difflineplus">+        if (this.supportsChangeLog) {</span>
<a href="#l7.668"></a><span id="l7.668" class="difflineplus">+            return this.mUncachedCalendar.modifyItemOrUseCache(newItem, oldItem, true, opListener);</span>
<a href="#l7.669"></a><span id="l7.669" class="difflineplus">+        } else {</span>
<a href="#l7.670"></a><span id="l7.670" class="difflineplus">+            return this.mUncachedCalendar.modifyItem(newItem, oldItem, opListener);</span>
<a href="#l7.671"></a><span id="l7.671" class="difflineplus">+        }</span>
<a href="#l7.672"></a><span id="l7.672" class="difflineplus">+    },</span>
<a href="#l7.673"></a><span id="l7.673" class="difflineplus">+    modifyOfflineItem: function(newItem, oldItem, listener) {</span>
<a href="#l7.674"></a><span id="l7.674" class="difflineplus">+        var this_ = this;</span>
<a href="#l7.675"></a><span id="l7.675" class="difflineplus">+        var opListener = {</span>
<a href="#l7.676"></a><span id="l7.676" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l7.677"></a><span id="l7.677" class="difflineplus">+                cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l7.678"></a><span id="l7.678" class="difflineplus">+            },</span>
<a href="#l7.679"></a><span id="l7.679" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l7.680"></a><span id="l7.680" class="difflineplus">+                if (Components.isSuccessCode(status)) {</span>
<a href="#l7.681"></a><span id="l7.681" class="difflineplus">+                    var storage = this_.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l7.682"></a><span id="l7.682" class="difflineplus">+                    storage.modifyOfflineItem(detail, listener);</span>
<a href="#l7.683"></a><span id="l7.683" class="difflineplus">+                } else if (listener) {</span>
<a href="#l7.684"></a><span id="l7.684" class="difflineplus">+                    listener.onOperationComplete(this_, status, opType, id, detail);</span>
<a href="#l7.685"></a><span id="l7.685" class="difflineplus">+                }</span>
<a href="#l7.686"></a><span id="l7.686" class="difflineplus">+            }</span>
<a href="#l7.687"></a><span id="l7.687" class="difflineplus">+        };</span>
<a href="#l7.688"></a><span id="l7.688" class="difflineplus">+</span>
<a href="#l7.689"></a><span id="l7.689" class="difflineplus">+        this.mCachedCalendar.modifyItem(newItem, oldItem, opListener);</span>
<a href="#l7.690"></a><span id="l7.690" class="difflineplus">+    },</span>
<a href="#l7.691"></a><span id="l7.691" class="difflineplus">+</span>
<a href="#l7.692"></a><span id="l7.692" class="difflineplus">+    deleteItem: function(item, listener) {</span>
<a href="#l7.693"></a><span id="l7.693" class="difflineplus">+        if (this.offline) {</span>
<a href="#l7.694"></a><span id="l7.694" class="difflineplus">+            this.deleteOfflineItem(item, listener);</span>
<a href="#l7.695"></a><span id="l7.695" class="difflineplus">+            return;</span>
<a href="#l7.696"></a><span id="l7.696">         }</span>
<a href="#l7.697"></a><span id="l7.697">         // Forwarding add/modify/delete to the cached calendar using the calIObserver</span>
<a href="#l7.698"></a><span id="l7.698">         // callbacks would be advantageous, because the uncached provider could implement</span>
<a href="#l7.699"></a><span id="l7.699">         // a true push mechanism firing without being triggered from within the program.</span>
<a href="#l7.700"></a><span id="l7.700">         // But this would mean the uncached provider fires on the passed</span>
<a href="#l7.701"></a><span id="l7.701">         // calIOperationListener, e.g. *before* it fires on calIObservers</span>
<a href="#l7.702"></a><span id="l7.702">         // (because that order is undefined). Firing onOperationComplete before onAddItem et al</span>
<a href="#l7.703"></a><span id="l7.703">         // would result in this facade firing onOperationComplete even though the modification</span>
<a href="#l7.704"></a><span id="l7.704">         // hasn't yet been performed on the cached calendar (which happens in onAddItem et al).</span>
<a href="#l7.705"></a><span id="l7.705">         // Result is that we currently stick to firing onOperationComplete if the cached calendar</span>
<a href="#l7.706"></a><span id="l7.706">         // has performed the modification, see below:</span>
<a href="#l7.707"></a><span id="l7.707">         var this_ = this;</span>
<a href="#l7.708"></a><span id="l7.708">         var opListener = {</span>
<a href="#l7.709"></a><span id="l7.709">             onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l7.710"></a><span id="l7.710" class="difflineminus">-                ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l7.711"></a><span id="l7.711" class="difflineminus">-            },</span>
<a href="#l7.712"></a><span id="l7.712" class="difflineminus">-            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l7.713"></a><span id="l7.713" class="difflineminus">-                if (Components.isSuccessCode(status)) {</span>
<a href="#l7.714"></a><span id="l7.714" class="difflineminus">-                    this_.mCachedCalendar.modifyItem(detail, oldItem, listener);</span>
<a href="#l7.715"></a><span id="l7.715" class="difflineminus">-                } else if (listener) {</span>
<a href="#l7.716"></a><span id="l7.716" class="difflineminus">-                    listener.onOperationComplete(this_, status, opType, id, detail);</span>
<a href="#l7.717"></a><span id="l7.717" class="difflineminus">-                }</span>
<a href="#l7.718"></a><span id="l7.718" class="difflineminus">-            }</span>
<a href="#l7.719"></a><span id="l7.719" class="difflineminus">-        }</span>
<a href="#l7.720"></a><span id="l7.720" class="difflineminus">-        return this.mUncachedCalendar.modifyItem(newItem, oldItem, opListener);</span>
<a href="#l7.721"></a><span id="l7.721" class="difflineminus">-    },</span>
<a href="#l7.722"></a><span id="l7.722" class="difflineminus">-</span>
<a href="#l7.723"></a><span id="l7.723" class="difflineminus">-    deleteItem: function(item, listener) {</span>
<a href="#l7.724"></a><span id="l7.724" class="difflineminus">-        if (this.offline) {</span>
<a href="#l7.725"></a><span id="l7.725" class="difflineminus">-            ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l7.726"></a><span id="l7.726" class="difflineminus">-            if (listener) {</span>
<a href="#l7.727"></a><span id="l7.727" class="difflineminus">-                listener.onOperationComplete(this, Components.interfaces.calIErrors.CAL_IS_READONLY,</span>
<a href="#l7.728"></a><span id="l7.728" class="difflineminus">-                                             Components.interfaces.calIOperation.DELETE, null, null);</span>
<a href="#l7.729"></a><span id="l7.729" class="difflineminus">-            }</span>
<a href="#l7.730"></a><span id="l7.730" class="difflineminus">-            return null;</span>
<a href="#l7.731"></a><span id="l7.731" class="difflineminus">-        }</span>
<a href="#l7.732"></a><span id="l7.732" class="difflineminus">-        // Forwarding add/modify/delete to the cached calendar using the calIObserver</span>
<a href="#l7.733"></a><span id="l7.733" class="difflineminus">-        // callbacks would be advantageous, because the uncached provider could implement</span>
<a href="#l7.734"></a><span id="l7.734" class="difflineminus">-        // a true push mechanism firing without being triggered from within the program.</span>
<a href="#l7.735"></a><span id="l7.735" class="difflineminus">-        // But this would mean the uncached provider fires on the passed</span>
<a href="#l7.736"></a><span id="l7.736" class="difflineminus">-        // calIOperationListener, e.g. *before* it fires on calIObservers</span>
<a href="#l7.737"></a><span id="l7.737" class="difflineminus">-        // (because that order is undefined). Firing onOperationComplete before onAddItem et al</span>
<a href="#l7.738"></a><span id="l7.738" class="difflineminus">-        // would result in this facade firing onOperationComplete even though the modification</span>
<a href="#l7.739"></a><span id="l7.739" class="difflineminus">-        // hasn't yet been performed on the cached calendar (which happens in onAddItem et al).</span>
<a href="#l7.740"></a><span id="l7.740" class="difflineminus">-        // Result is that we currently stick to firing onOperationComplete if the cached calendar</span>
<a href="#l7.741"></a><span id="l7.741" class="difflineminus">-        // has performed the modification, see below:</span>
<a href="#l7.742"></a><span id="l7.742" class="difflineminus">-        var this_ = this;</span>
<a href="#l7.743"></a><span id="l7.743" class="difflineminus">-        var opListener = {</span>
<a href="#l7.744"></a><span id="l7.744" class="difflineminus">-            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l7.745"></a><span id="l7.745" class="difflineminus">-                ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l7.746"></a><span id="l7.746" class="difflineplus">+                cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l7.747"></a><span id="l7.747">             },</span>
<a href="#l7.748"></a><span id="l7.748">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l7.749"></a><span id="l7.749">                 if (Components.isSuccessCode(status)) {</span>
<a href="#l7.750"></a><span id="l7.750">                     this_.mCachedCalendar.deleteItem(item, listener);</span>
<a href="#l7.751"></a><span id="l7.751">                 } else if (listener) {</span>
<a href="#l7.752"></a><span id="l7.752">                     listener.onOperationComplete(this_, status, opType, id, detail);</span>
<a href="#l7.753"></a><span id="l7.753">                 }</span>
<a href="#l7.754"></a><span id="l7.754">             }</span>
<a href="#l7.755"></a><span id="l7.755">         }</span>
<a href="#l7.756"></a><span id="l7.756" class="difflineplus">+        if (this.supportsChangeLog) {</span>
<a href="#l7.757"></a><span id="l7.757" class="difflineplus">+            return this.mUncachedCalendar.deleteItemOrUseCache(item, true, opListener);</span>
<a href="#l7.758"></a><span id="l7.758" class="difflineplus">+        }</span>
<a href="#l7.759"></a><span id="l7.759">         return this.mUncachedCalendar.deleteItem(item, opListener);</span>
<a href="#l7.760"></a><span id="l7.760" class="difflineplus">+    },</span>
<a href="#l7.761"></a><span id="l7.761" class="difflineplus">+    deleteOfflineItem: function(item, listener) {</span>
<a href="#l7.762"></a><span id="l7.762" class="difflineplus">+        /* We do not delete the item from the cache, as we will need it when reconciling the cache content and the server content. */</span>
<a href="#l7.763"></a><span id="l7.763" class="difflineplus">+        var storage = this.mCachedCalendar.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l7.764"></a><span id="l7.764" class="difflineplus">+        storage.deleteOfflineItem(item, listener);</span>
<a href="#l7.765"></a><span id="l7.765">     }</span>
<a href="#l7.766"></a><span id="l7.766"> };</span>
<a href="#l7.767"></a><span id="l7.767"> (function() {</span>
<a href="#l7.768"></a><span id="l7.768">     function defineForwards(proto, targetName, functions, getters, gettersAndSetters) {</span>
<a href="#l7.769"></a><span id="l7.769">         function defineForwardGetter(attr) {</span>
<a href="#l7.770"></a><span id="l7.770">             proto.__defineGetter__(attr, function() { return this[targetName][attr]; });</span>
<a href="#l7.771"></a><span id="l7.771">         }</span>
<a href="#l7.772"></a><span id="l7.772">         function defineForwardGetterAndSetter(attr) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -290,16 +290,17 @@ function getCalendarDirectory() {</span>
<a href="#l8.4"></a><span id="l8.4">  *</span>
<a href="#l8.5"></a><span id="l8.5">  * @param aCalendar     The calendar to check</span>
<a href="#l8.6"></a><span id="l8.6">  * @return              True if the calendar is writable</span>
<a href="#l8.7"></a><span id="l8.7">  */</span>
<a href="#l8.8"></a><span id="l8.8"> function isCalendarWritable(aCalendar) {</span>
<a href="#l8.9"></a><span id="l8.9">     return (!aCalendar.getProperty(&quot;disabled&quot;) &amp;&amp;</span>
<a href="#l8.10"></a><span id="l8.10">             !aCalendar.readOnly &amp;&amp;</span>
<a href="#l8.11"></a><span id="l8.11">             (!getIOService().offline ||</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+             aCalendar.getProperty(&quot;cache.enabled&quot;) ||</span>
<a href="#l8.13"></a><span id="l8.13">              aCalendar.getProperty(&quot;requiresNetwork&quot;) === false));</span>
<a href="#l8.14"></a><span id="l8.14"> }</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16"> /**</span>
<a href="#l8.17"></a><span id="l8.17">  * Opens the Create Calendar wizard</span>
<a href="#l8.18"></a><span id="l8.18">  *</span>
<a href="#l8.19"></a><span id="l8.19">  * @param aCallback  a function to be performed after calendar creation</span>
<a href="#l8.20"></a><span id="l8.20">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -54,38 +54,38 @@ Components.utils.import(&quot;resource://cale</span>
<a href="#l9.4"></a><span id="l9.4"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l9.5"></a><span id="l9.5"> Components.utils.import(&quot;resource://calendar/modules/calAuthUtils.jsm&quot;);</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7"> //</span>
<a href="#l9.8"></a><span id="l9.8"> // calDavCalendar.js</span>
<a href="#l9.9"></a><span id="l9.9"> //</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> const xmlHeader = '&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n';</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+const cICL = Components.interfaces.calIChangeLog;</span>
<a href="#l9.13"></a><span id="l9.13"> </span>
<a href="#l9.14"></a><span id="l9.14"> function calDavCalendar() {</span>
<a href="#l9.15"></a><span id="l9.15">     this.initProviderBase();</span>
<a href="#l9.16"></a><span id="l9.16">     this.unmappedProperties = [];</span>
<a href="#l9.17"></a><span id="l9.17">     this.mUriParams = null;</span>
<a href="#l9.18"></a><span id="l9.18">     this.mItemInfoCache = {};</span>
<a href="#l9.19"></a><span id="l9.19">     this.mDisabled = false;</span>
<a href="#l9.20"></a><span id="l9.20">     this.mCalHomeSet = null;</span>
<a href="#l9.21"></a><span id="l9.21">     this.mInboxUrl = null;</span>
<a href="#l9.22"></a><span id="l9.22">     this.mOutboxUrl = null;</span>
<a href="#l9.23"></a><span id="l9.23">     this.mCalendarUserAddress = null;</span>
<a href="#l9.24"></a><span id="l9.24">     this.mPrincipalUrl = null;</span>
<a href="#l9.25"></a><span id="l9.25">     this.mSenderAddress = null;</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-    this.mPathIndex = {};</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+    this.mHrefIndex = {};</span>
<a href="#l9.28"></a><span id="l9.28">     this.mAuthScheme = null;</span>
<a href="#l9.29"></a><span id="l9.29">     this.mAuthRealm = null;</span>
<a href="#l9.30"></a><span id="l9.30">     this.mObserver = null;</span>
<a href="#l9.31"></a><span id="l9.31">     this.mFirstRefreshDone = false;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-    this.mTargetCalendar = null;</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+    this.mOfflineStorage = null;</span>
<a href="#l9.34"></a><span id="l9.34">     this.mQueuedQueries = [];</span>
<a href="#l9.35"></a><span id="l9.35">     this.mCtag = null;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-    this.mOldCtag = null;</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38">     // By default, support both events and todos.</span>
<a href="#l9.39"></a><span id="l9.39">     this.mGenerallySupportedItemTypes = [&quot;VEVENT&quot;, &quot;VTODO&quot;];</span>
<a href="#l9.40"></a><span id="l9.40">     this.mSupportedItemTypes = this.mGenerallySupportedItemTypes.slice(0);</span>
<a href="#l9.41"></a><span id="l9.41"> }</span>
<a href="#l9.42"></a><span id="l9.42"> </span>
<a href="#l9.43"></a><span id="l9.43"> // some shorthand</span>
<a href="#l9.44"></a><span id="l9.44"> const calICalendar = Components.interfaces.calICalendar;</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineat">@@ -94,19 +94,18 @@ const calIFreeBusyInterval = Components.</span>
<a href="#l9.46"></a><span id="l9.46"> const calICalDavCalendar = Components.interfaces.calICalDavCalendar;</span>
<a href="#l9.47"></a><span id="l9.47"> </span>
<a href="#l9.48"></a><span id="l9.48"> // used in checking calendar URI for (Cal)DAV-ness</span>
<a href="#l9.49"></a><span id="l9.49"> const kDavResourceTypeNone = 0;</span>
<a href="#l9.50"></a><span id="l9.50"> const kDavResourceTypeCollection = 1;</span>
<a href="#l9.51"></a><span id="l9.51"> const kDavResourceTypeCalendar = 2;</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53"> // used for etag checking</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-const CALDAV_ADOPT_ITEM = 1;</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-const CALDAV_MODIFY_ITEM = 2;</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-const CALDAV_DELETE_ITEM = 3;</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+const CALDAV_MODIFY_ITEM = &quot;modify&quot;;</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+const CALDAV_DELETE_ITEM = &quot;delete&quot;;</span>
<a href="#l9.59"></a><span id="l9.59"> </span>
<a href="#l9.60"></a><span id="l9.60"> calDavCalendar.prototype = {</span>
<a href="#l9.61"></a><span id="l9.61">     __proto__: cal.ProviderBase.prototype,</span>
<a href="#l9.62"></a><span id="l9.62"> </span>
<a href="#l9.63"></a><span id="l9.63">     classID: Components.ID(&quot;{a35fc6ea-3d92-11d9-89f9-00045ace3b8d}&quot;),</span>
<a href="#l9.64"></a><span id="l9.64">     contractID: &quot;@mozilla.org/calendar/calendar;1?type=caldav&quot;,</span>
<a href="#l9.65"></a><span id="l9.65">     classDescription: &quot;Calendar CalDAV back-end&quot;,</span>
<a href="#l9.66"></a><span id="l9.66"> </span>
<a href="#l9.67"></a><span id="l9.67" class="difflineat">@@ -146,28 +145,28 @@ calDavCalendar.prototype = {</span>
<a href="#l9.68"></a><span id="l9.68">         return this.mSupportedItemTypes;</span>
<a href="#l9.69"></a><span id="l9.69">     },</span>
<a href="#l9.70"></a><span id="l9.70"> </span>
<a href="#l9.71"></a><span id="l9.71">     get isCached() {</span>
<a href="#l9.72"></a><span id="l9.72">         return (this != this.superCalendar);</span>
<a href="#l9.73"></a><span id="l9.73">     },</span>
<a href="#l9.74"></a><span id="l9.74"> </span>
<a href="#l9.75"></a><span id="l9.75">     ensureTargetCalendar: function caldav_ensureTargetCalendar() {</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-        if (!this.isCached &amp;&amp; !this.mTargetCalendar) {</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+        if (!this.isCached &amp;&amp; !this.mOfflineStorage) {</span>
<a href="#l9.78"></a><span id="l9.78">             // If this is a cached calendar, the actual cache is taken care of</span>
<a href="#l9.79"></a><span id="l9.79">             // by the calCachedCalendar facade. In any other case, we use a</span>
<a href="#l9.80"></a><span id="l9.80">             // memory calendar to cache things.</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-            this.mTargetCalendar = Components</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+            this.mOfflineStorage = Components</span>
<a href="#l9.83"></a><span id="l9.83">                                    .classes[&quot;@mozilla.org/calendar/calendar;1?type=memory&quot;]</span>
<a href="#l9.84"></a><span id="l9.84">                                    .createInstance(Components.interfaces.calISyncWriteCalendar);</span>
<a href="#l9.85"></a><span id="l9.85"> </span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-            this.mTargetCalendar.superCalendar = this;</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+            this.mOfflineStorage.superCalendar = this;</span>
<a href="#l9.88"></a><span id="l9.88">             this.mObserver = new calDavObserver(this);</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-            this.mTargetCalendar.addObserver(this.mObserver);</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-            this.mTargetCalendar.setProperty(&quot;relaxedMode&quot;, true);</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+            this.mOfflineStorage.addObserver(this.mObserver);</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+            this.mOfflineStorage.setProperty(&quot;relaxedMode&quot;, true);</span>
<a href="#l9.93"></a><span id="l9.93">         }</span>
<a href="#l9.94"></a><span id="l9.94">     },</span>
<a href="#l9.95"></a><span id="l9.95"> </span>
<a href="#l9.96"></a><span id="l9.96">     //</span>
<a href="#l9.97"></a><span id="l9.97">     // calICalendarProvider interface</span>
<a href="#l9.98"></a><span id="l9.98">     //</span>
<a href="#l9.99"></a><span id="l9.99">     get prefChromeOverlay() {</span>
<a href="#l9.100"></a><span id="l9.100">         return null;</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineat">@@ -180,103 +179,130 @@ calDavCalendar.prototype = {</span>
<a href="#l9.102"></a><span id="l9.102">     createCalendar: function caldav_createCalendar() {</span>
<a href="#l9.103"></a><span id="l9.103">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.104"></a><span id="l9.104">     },</span>
<a href="#l9.105"></a><span id="l9.105"> </span>
<a href="#l9.106"></a><span id="l9.106">     deleteCalendar: function caldav_deleteCalendar(cal, listener) {</span>
<a href="#l9.107"></a><span id="l9.107">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.108"></a><span id="l9.108">     },</span>
<a href="#l9.109"></a><span id="l9.109"> </span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+    // calIChangeLog interface</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+    get offlineStorage() {</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+        return this.mOfflineStorage;</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+    },</span>
<a href="#l9.114"></a><span id="l9.114"> </span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-    // calIChangeLog interface</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+    set offlineStorage(storage) {</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+        this.mOfflineStorage = storage;</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+        this.fetchCachedMetaData();</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+    },</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+</span>
<a href="#l9.121"></a><span id="l9.121">     resetLog: function caldav_resetLog() {</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-        if (this.isCached &amp;&amp; this.mTargetCalendar) {</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-            this.mTargetCalendar.startBatch();</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+        if (this.isCached &amp;&amp; this.mOfflineStorage) {</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+            this.mOfflineStorage.startBatch();</span>
<a href="#l9.126"></a><span id="l9.126">             try {</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-                try {</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-                    this.mCtag = null;</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-                    this.mOldCtag = null;</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineminus">-                    this.mTargetCalendar.deleteMetaData(&quot;ctag&quot;);</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-                } catch(e) {</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-                    cal.ERROR(e);</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-                }</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-                try {</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-                    this.mWebdavSyncToken = null;</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-                    this.mTargetCalendar.deleteMetaData(&quot;webdav-sync-token&quot;);</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-                } catch(e) {</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-                    cal.ERROR(e);</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-                }</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-                for (var itemId in this.mItemInfoCache) {</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-                    this.mTargetCalendar.deleteMetaData(itemId);</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+                for (let itemId in this.mItemInfoCache) {</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+                    this.mOfflineStorage.deleteMetaData(itemId);</span>
<a href="#l9.145"></a><span id="l9.145">                     delete this.mItemInfoCache[itemId];</span>
<a href="#l9.146"></a><span id="l9.146">                 }</span>
<a href="#l9.147"></a><span id="l9.147">             } finally {</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-                this.mTargetCalendar.endBatch();</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+                this.mOfflineStorage.endBatch();</span>
<a href="#l9.150"></a><span id="l9.150">             }</span>
<a href="#l9.151"></a><span id="l9.151">         }</span>
<a href="#l9.152"></a><span id="l9.152">     },</span>
<a href="#l9.153"></a><span id="l9.153"> </span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-    // in calISyncWriteCalendar aDestination,</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineplus">+    get offlineCachedProperties() {</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineplus">+        return [ &quot;mAuthScheme&quot;, &quot;mAuthRealm&quot;, &quot;mHasWebdavSyncSupport&quot;,</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+                &quot;mCtag&quot;, &quot;mWebdavSyncToken&quot;, &quot;mSupportedItemTypes&quot;,</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineplus">+                &quot;mPrincipalUrl&quot;, &quot;mCalHomeSet&quot;,</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+                &quot;mShouldPollInbox&quot;, &quot;hasAutoScheduling&quot;, &quot;mHaveScheduling&quot;,</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+                &quot;mCalendarUserAddress&quot;, &quot;mShouldPollInbox&quot;, &quot;mOutboxUrl&quot; ];</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+    },</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+    saveCalendarProperties: function caldav_saveCalendarProperties() {</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+        let properties = {};</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+        for each (let property in this.offlineCachedProperties) {</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+            if (this[property] !== undefined) {</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineplus">+                properties[property] = this[property];</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineplus">+            }</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineplus">+        }</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineplus">+        this.mOfflineStorage.setMetaData(&quot;calendar-properties&quot;, JSON.stringify(properties));</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineplus">+    },</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+    restoreCalendarProperties: function caldav_restoreCalendarProperties(data) {</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineplus">+        let properties = JSON.parse(data);</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineplus">+        for each (let property in this.offlineCachedProperties) {</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+            if (properties[property] !== undefined) {</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+                this[property] = properties[property];</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+            }</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineplus">+        }</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineplus">+    },</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineplus">+</span>
<a href="#l9.181"></a><span id="l9.181">     // in calIGenericOperationListener aListener</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineminus">-    replayChangesOn: function caldav_replayChangesOn(aDestination, aChangeLogListener) {</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-        if (!this.mTargetCalendar) {</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineminus">-            this.mTargetCalendar = aDestination.wrappedJSObject;</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineminus">-            this.fetchItemVersions();</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineplus">+    replayChangesOn: function caldav_replayChangesOn(aChangeLogListener) {</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineplus">+        if (!this.mCheckedServerInfo) {</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineplus">+            // If we haven't refreshed yet, then we should check the resource</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineplus">+            // type first. This will call refresh() again afterwards.</span>
<a href="#l9.190"></a><span id="l9.190">             this.checkDavResourceType(aChangeLogListener);</span>
<a href="#l9.191"></a><span id="l9.191">         } else {</span>
<a href="#l9.192"></a><span id="l9.192">             this.safeRefresh(aChangeLogListener);</span>
<a href="#l9.193"></a><span id="l9.193">         }</span>
<a href="#l9.194"></a><span id="l9.194">     },</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineminus">-</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-    fetchItemVersions: function caldav_fetchItemVersions() {</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineplus">+    setMetaData: function caldav_setMetaData(id, path, etag, isInboxItem) {</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+        if (this.mOfflineStorage.setMetaData) {</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+            if (id) {</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineplus">+                var dataString = [etag,path,(isInboxItem ? &quot;true&quot; : &quot;false&quot;)].join(&quot;\u001A&quot;);</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineplus">+                this.mOfflineStorage.setMetaData(id, dataString);</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineplus">+            } else {</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+                cal.LOG(&quot;CalDAV: cannot store meta data without an id&quot;);</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineplus">+            }</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineplus">+        } else {</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineplus">+            cal.ERROR(&quot;CalDAV: calendar storage does not support meta data&quot;);</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineplus">+        }</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineplus">+    },</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineplus">+    fetchCachedMetaData: function caldav_fetchCachedMetaData() {</span>
<a href="#l9.210"></a><span id="l9.210">         var cacheIds = {};</span>
<a href="#l9.211"></a><span id="l9.211">         var cacheValues = {};</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineminus">-        this.mTargetCalendar.getAllMetaData({}, cacheIds, cacheValues);</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineplus">+        this.mOfflineStorage.getAllMetaData({}, cacheIds, cacheValues);</span>
<a href="#l9.214"></a><span id="l9.214">         cacheIds = cacheIds.value;</span>
<a href="#l9.215"></a><span id="l9.215">         cacheValues = cacheValues.value;</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineplus">+        let needsResave = false;</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineplus">+        let calendarProperties = null;</span>
<a href="#l9.218"></a><span id="l9.218">         for (var count = 0; count &lt; cacheIds.length; count++) {</span>
<a href="#l9.219"></a><span id="l9.219">             var itemId = cacheIds[count];</span>
<a href="#l9.220"></a><span id="l9.220">             var itemData = cacheValues[count];</span>
<a href="#l9.221"></a><span id="l9.221">             if (itemId == &quot;ctag&quot;) {</span>
<a href="#l9.222"></a><span id="l9.222">                 this.mCtag = itemData;</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineplus">+                this.mOfflineStorage.deleteMetaData(&quot;ctag&quot;);</span>
<a href="#l9.224"></a><span id="l9.224">             } else if (itemId == &quot;webdav-sync-token&quot;) {</span>
<a href="#l9.225"></a><span id="l9.225">                 this.mWebdavSyncToken = itemData;</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineplus">+                this.mOfflineStorage.deleteMetaData(&quot;sync-token&quot;);</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineplus">+            } else if (itemId == &quot;calendar-properties&quot;) {</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineplus">+                this.restoreCalendarProperties(itemData);</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineplus">+                this.mCheckedServerInfo = true;</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineplus">+                this.setProperty(&quot;currentStatus&quot;, Components.results.NS_OK);</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineplus">+                this.readOnly = false;</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineplus">+                this.disabled = false;</span>
<a href="#l9.233"></a><span id="l9.233">             } else {</span>
<a href="#l9.234"></a><span id="l9.234">                 var itemDataArray = itemData.split(&quot;\u001A&quot;);</span>
<a href="#l9.235"></a><span id="l9.235">                 var etag = itemDataArray[0];</span>
<a href="#l9.236"></a><span id="l9.236">                 var resourcePath = itemDataArray[1];</span>
<a href="#l9.237"></a><span id="l9.237">                 var isInboxItem = itemDataArray[2];</span>
<a href="#l9.238"></a><span id="l9.238">                 if (itemDataArray.length == 3) {</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineminus">-                    this.mPathIndex[resourcePath] = itemId;</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineplus">+                    this.mHrefIndex[resourcePath] = itemId;</span>
<a href="#l9.241"></a><span id="l9.241">                     var locationPath = resourcePath</span>
<a href="#l9.242"></a><span id="l9.242">                         .substr(this.mLocationPath.length);</span>
<a href="#l9.243"></a><span id="l9.243">                     var item = { etag: etag,</span>
<a href="#l9.244"></a><span id="l9.244">                                  isNew: false,</span>
<a href="#l9.245"></a><span id="l9.245">                                  locationPath: locationPath,</span>
<a href="#l9.246"></a><span id="l9.246">                                  isInboxItem: (isInboxItem == &quot;true&quot;)};</span>
<a href="#l9.247"></a><span id="l9.247">                     this.mItemInfoCache[itemId] = item;</span>
<a href="#l9.248"></a><span id="l9.248">                 }</span>
<a href="#l9.249"></a><span id="l9.249">             }</span>
<a href="#l9.250"></a><span id="l9.250">         }</span>
<a href="#l9.251"></a><span id="l9.251">     },</span>
<a href="#l9.252"></a><span id="l9.252"> </span>
<a href="#l9.253"></a><span id="l9.253" class="difflineminus">-    setMetaData: function caldav_setMetaData(id, path, etag, isInboxItem) {</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineminus">-        if (this.mTargetCalendar.setMetaData) {</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineminus">-            if (id) {</span>
<a href="#l9.256"></a><span id="l9.256" class="difflineminus">-                var dataString = [etag,path,(isInboxItem ? &quot;true&quot; : &quot;false&quot;)].join(&quot;\u001A&quot;);</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineminus">-                this.mTargetCalendar.setMetaData(id, dataString);</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineminus">-            } else {</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineminus">-                cal.LOG(&quot;CAlDAV: cannot store meta data without an id&quot;);</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineminus">-            }</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineminus">-        } else {</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineminus">-            cal.LOG(&quot;CalDAV: calendar storage does not support meta data&quot;);</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineminus">-        }</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineminus">-    },</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineminus">-</span>
<a href="#l9.266"></a><span id="l9.266">     //</span>
<a href="#l9.267"></a><span id="l9.267">     // calICalendar interface</span>
<a href="#l9.268"></a><span id="l9.268">     //</span>
<a href="#l9.269"></a><span id="l9.269"> </span>
<a href="#l9.270"></a><span id="l9.270">     // readonly attribute AUTF8String type;</span>
<a href="#l9.271"></a><span id="l9.271">     get type() { return &quot;caldav&quot;; },</span>
<a href="#l9.272"></a><span id="l9.272"> </span>
<a href="#l9.273"></a><span id="l9.273">     mDisabled: true,</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineat">@@ -361,18 +387,17 @@ calDavCalendar.prototype = {</span>
<a href="#l9.275"></a><span id="l9.275"> </span>
<a href="#l9.276"></a><span id="l9.276">     mFirstRefreshDone: false,</span>
<a href="#l9.277"></a><span id="l9.277"> </span>
<a href="#l9.278"></a><span id="l9.278">     mQueuedQueries: null,</span>
<a href="#l9.279"></a><span id="l9.279"> </span>
<a href="#l9.280"></a><span id="l9.280">     mCtag: null,</span>
<a href="#l9.281"></a><span id="l9.281">     mOldCtag: null,</span>
<a href="#l9.282"></a><span id="l9.282"> </span>
<a href="#l9.283"></a><span id="l9.283" class="difflineminus">-    mTargetCalendar: null,</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineminus">-</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineplus">+    mOfflineStorage: null,</span>
<a href="#l9.286"></a><span id="l9.286">     // Contains the last valid synctoken returned</span>
<a href="#l9.287"></a><span id="l9.287">     // from the server with Webdav Sync enabled servers</span>
<a href="#l9.288"></a><span id="l9.288">     mWebdavSyncToken: null,</span>
<a href="#l9.289"></a><span id="l9.289">     // Indicates that the server supports Webdav Sync</span>
<a href="#l9.290"></a><span id="l9.290">     // see: http://tools.ietf.org/html/draft-daboo-webdav-sync</span>
<a href="#l9.291"></a><span id="l9.291">     mHasWebdavSyncSupport: false,</span>
<a href="#l9.292"></a><span id="l9.292"> </span>
<a href="#l9.293"></a><span id="l9.293">     get authRealm() {</span>
<a href="#l9.294"></a><span id="l9.294" class="difflineat">@@ -440,89 +465,71 @@ calDavCalendar.prototype = {</span>
<a href="#l9.295"></a><span id="l9.295">                 return (this.supportedItemTypes.indexOf(&quot;VEVENT&quot;) &gt; -1);</span>
<a href="#l9.296"></a><span id="l9.296">             case &quot;capabilities.autoschedule.supported&quot;:</span>
<a href="#l9.297"></a><span id="l9.297">                 return this.hasAutoScheduling;</span>
<a href="#l9.298"></a><span id="l9.298">         }</span>
<a href="#l9.299"></a><span id="l9.299">         return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l9.300"></a><span id="l9.300">     },</span>
<a href="#l9.301"></a><span id="l9.301"> </span>
<a href="#l9.302"></a><span id="l9.302">     promptOverwrite: function caldav_promptOverwrite(aMethod, aItem, aListener, aOldItem) {</span>
<a href="#l9.303"></a><span id="l9.303" class="difflineminus">-        var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l9.304"></a><span id="l9.304" class="difflineminus">-                                      .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l9.305"></a><span id="l9.305" class="difflineminus">-</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineminus">-        var promptTitle = calGetString(&quot;calendar&quot;, &quot;itemModifiedOnServerTitle&quot;);</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineminus">-        var promptMessage = calGetString(&quot;calendar&quot;, &quot;itemModifiedOnServer&quot;);</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineminus">-        var buttonLabel1;</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineminus">-</span>
<a href="#l9.310"></a><span id="l9.310" class="difflineminus">-        if (aMethod == CALDAV_MODIFY_ITEM) {</span>
<a href="#l9.311"></a><span id="l9.311" class="difflineminus">-            promptMessage += calGetString(&quot;calendar&quot;, &quot;modifyWillLoseData&quot;);</span>
<a href="#l9.312"></a><span id="l9.312" class="difflineminus">-            buttonLabel1 = calGetString(&quot;calendar&quot;, &quot;proceedModify&quot;);</span>
<a href="#l9.313"></a><span id="l9.313" class="difflineminus">-        } else {</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineminus">-            promptMessage += calGetString(&quot;calendar&quot;, &quot;deleteWillLoseData&quot;);</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineminus">-            buttonLabel1 = calGetString(&quot;calendar&quot;, &quot;proceedDelete&quot;);</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineminus">-        }</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineminus">-</span>
<a href="#l9.318"></a><span id="l9.318" class="difflineminus">-        var buttonLabel2 = calGetString(&quot;calendar&quot;, &quot;updateFromServer&quot;);</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineminus">-</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineminus">-        var flags = promptService.BUTTON_TITLE_IS_STRING *</span>
<a href="#l9.321"></a><span id="l9.321" class="difflineminus">-                    promptService.BUTTON_POS_0 +</span>
<a href="#l9.322"></a><span id="l9.322" class="difflineminus">-                    promptService.BUTTON_TITLE_IS_STRING *</span>
<a href="#l9.323"></a><span id="l9.323" class="difflineminus">-                    promptService.BUTTON_POS_1;</span>
<a href="#l9.324"></a><span id="l9.324" class="difflineminus">-</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineminus">-        var choice = promptService.confirmEx(null, promptTitle, promptMessage,</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineminus">-                                             flags, buttonLabel1, buttonLabel2,</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineminus">-                                             null, null, {});</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineminus">-</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineminus">-        if (choice == 0) {</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineplus">+        let overwrite = cal.promptOverwrite(aMethod, aItem, aListener, aOldItem);</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineplus">+        if (overwrite) {</span>
<a href="#l9.332"></a><span id="l9.332">             if (aMethod == CALDAV_MODIFY_ITEM) {</span>
<a href="#l9.333"></a><span id="l9.333" class="difflineminus">-                this.doModifyItem(aItem, aOldItem, aListener, true);</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineplus">+                this.doModifyItemOrUseCache(aItem, aOldItem, true, aListener, true);</span>
<a href="#l9.335"></a><span id="l9.335">             } else {</span>
<a href="#l9.336"></a><span id="l9.336" class="difflineminus">-                this.doDeleteItem(aItem, aListener, true, false, null);</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineplus">+                this.doDeleteItemOrUseCache(aItem, true, aListener, true, false, null);</span>
<a href="#l9.338"></a><span id="l9.338">             }</span>
<a href="#l9.339"></a><span id="l9.339">         } else {</span>
<a href="#l9.340"></a><span id="l9.340">             this.getUpdatedItem(aItem, aListener);</span>
<a href="#l9.341"></a><span id="l9.341">         }</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineminus">-</span>
<a href="#l9.343"></a><span id="l9.343">     },</span>
<a href="#l9.344"></a><span id="l9.344"> </span>
<a href="#l9.345"></a><span id="l9.345">     mItemInfoCache: null,</span>
<a href="#l9.346"></a><span id="l9.346"> </span>
<a href="#l9.347"></a><span id="l9.347" class="difflineminus">-    mPathIndex: null,</span>
<a href="#l9.348"></a><span id="l9.348" class="difflineplus">+    mHrefIndex: null,</span>
<a href="#l9.349"></a><span id="l9.349"> </span>
<a href="#l9.350"></a><span id="l9.350">     /**</span>
<a href="#l9.351"></a><span id="l9.351">      * addItem()</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineminus">-     * we actually use doAdoptItem()</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineplus">+     * we actually use doAdoptItemOrUseCache()</span>
<a href="#l9.354"></a><span id="l9.354">      *</span>
<a href="#l9.355"></a><span id="l9.355">      * @param aItem       item to add</span>
<a href="#l9.356"></a><span id="l9.356">      * @param aListener   listener for method completion</span>
<a href="#l9.357"></a><span id="l9.357">      */</span>
<a href="#l9.358"></a><span id="l9.358">     addItem: function caldav_addItem(aItem, aListener) {</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineminus">-        var newItem = aItem.clone();</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineminus">-        return this.doAdoptItem(newItem, aListener, false);</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineplus">+        return this.addItemOrUseCache(aItem, true, aListener);</span>
<a href="#l9.362"></a><span id="l9.362">     },</span>
<a href="#l9.363"></a><span id="l9.363"> </span>
<a href="#l9.364"></a><span id="l9.364" class="difflineplus">+    addItemOrUseCache: function caldav_addItemOrUseCache(aItem, useCache, aListener){</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineplus">+        let newItem = aItem.clone();</span>
<a href="#l9.366"></a><span id="l9.366" class="difflineplus">+        this.adoptItemOrUseCache(newItem, useCache, aListener);</span>
<a href="#l9.367"></a><span id="l9.367" class="difflineplus">+    },</span>
<a href="#l9.368"></a><span id="l9.368">     /**</span>
<a href="#l9.369"></a><span id="l9.369">      * adoptItem()</span>
<a href="#l9.370"></a><span id="l9.370" class="difflineminus">-     * we actually use doAdoptItem()</span>
<a href="#l9.371"></a><span id="l9.371" class="difflineplus">+     * we actually use doAdoptItemOrUseCache()</span>
<a href="#l9.372"></a><span id="l9.372">      *</span>
<a href="#l9.373"></a><span id="l9.373">      * @param aItem       item to check</span>
<a href="#l9.374"></a><span id="l9.374">      * @param aListener   listener for method completion</span>
<a href="#l9.375"></a><span id="l9.375">      */</span>
<a href="#l9.376"></a><span id="l9.376">     adoptItem: function caldav_adoptItem(aItem, aListener) {</span>
<a href="#l9.377"></a><span id="l9.377" class="difflineminus">-        return this.doAdoptItem(aItem, aListener, false);</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineplus">+        return this.adoptItemOrUseCache(aItem, true, aListener);</span>
<a href="#l9.379"></a><span id="l9.379" class="difflineplus">+    },</span>
<a href="#l9.380"></a><span id="l9.380" class="difflineplus">+</span>
<a href="#l9.381"></a><span id="l9.381" class="difflineplus">+    adoptItemOrUseCache: function caldav_adoptItemOrUseCache(aItem, useCache, aListener){</span>
<a href="#l9.382"></a><span id="l9.382" class="difflineplus">+        return this.doAdoptItemOrUseCache(aItem, useCache, aListener, false);</span>
<a href="#l9.383"></a><span id="l9.383">     },</span>
<a href="#l9.384"></a><span id="l9.384"> </span>
<a href="#l9.385"></a><span id="l9.385">     /**</span>
<a href="#l9.386"></a><span id="l9.386">      * Performs the actual addition of the item to CalDAV store</span>
<a href="#l9.387"></a><span id="l9.387">      *</span>
<a href="#l9.388"></a><span id="l9.388">      * @param aItem       item to add</span>
<a href="#l9.389"></a><span id="l9.389">      * @param aListener   listener for method completion</span>
<a href="#l9.390"></a><span id="l9.390" class="difflineminus">-     * @param aIgnoreEtag ignore item etag</span>
<a href="#l9.391"></a><span id="l9.391" class="difflineplus">+     * @param useCache    flag to use the cache when a server failure occurs</span>
<a href="#l9.392"></a><span id="l9.392" class="difflineplus">+     * @param aIgnoreEtag flag to indicate ignoring of Etag</span>
<a href="#l9.393"></a><span id="l9.393">      */</span>
<a href="#l9.394"></a><span id="l9.394" class="difflineminus">-    doAdoptItem: function caldav_doAdoptItem(aItem, aListener, aIgnoreEtag) {</span>
<a href="#l9.395"></a><span id="l9.395" class="difflineplus">+    doAdoptItemOrUseCache: function caldav_doAdoptItemOrUseCache(aItem, useCache, aListener, aIgnoreEtag){</span>
<a href="#l9.396"></a><span id="l9.396">         if (aItem.id == null &amp;&amp; aItem.isMutable) {</span>
<a href="#l9.397"></a><span id="l9.397">             aItem.id = cal.getUUID();</span>
<a href="#l9.398"></a><span id="l9.398">         }</span>
<a href="#l9.399"></a><span id="l9.399"> </span>
<a href="#l9.400"></a><span id="l9.400">         if (aItem.id == null) {</span>
<a href="#l9.401"></a><span id="l9.401">             this.notifyOperationComplete(aListener,</span>
<a href="#l9.402"></a><span id="l9.402">                                          Components.results.NS_ERROR_FAILURE,</span>
<a href="#l9.403"></a><span id="l9.403">                                          Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l9.404"></a><span id="l9.404" class="difflineat">@@ -568,16 +575,20 @@ calDavCalendar.prototype = {</span>
<a href="#l9.405"></a><span id="l9.405">             if (status == 201 || status == 204) {</span>
<a href="#l9.406"></a><span id="l9.406">                 cal.LOG(&quot;CalDAV: Item added to &quot; + thisCalendar.name + &quot; successfully&quot;);</span>
<a href="#l9.407"></a><span id="l9.407"> </span>
<a href="#l9.408"></a><span id="l9.408">                 // Some CalDAV servers will modify items on PUT (add X-props,</span>
<a href="#l9.409"></a><span id="l9.409">                 // for instance) so we'd best re-fetch in order to know</span>
<a href="#l9.410"></a><span id="l9.410">                 // the current state of the item</span>
<a href="#l9.411"></a><span id="l9.411">                 // Observers will be notified in getUpdatedItem()</span>
<a href="#l9.412"></a><span id="l9.412">                 thisCalendar.getUpdatedItem(parentItem, aListener);</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineplus">+            } else if (status &gt;= 500 &amp;&amp; status &lt;= 510 &amp;&amp;</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineplus">+                       useCache &amp;&amp; thisCalendar.mOfflineStorage) {</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineplus">+                cal.LOG(&quot;[calDavCalendar] Server unavailability code received. Items are being put into cache for a later try&quot;);</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineplus">+                thisCalendar.adoptOfflineItem(aItem, aListener);</span>
<a href="#l9.417"></a><span id="l9.417">             } else {</span>
<a href="#l9.418"></a><span id="l9.418">                 if (status &gt; 999) {</span>
<a href="#l9.419"></a><span id="l9.419">                     status = &quot;0x&quot; + status.toString(16);</span>
<a href="#l9.420"></a><span id="l9.420">                 }</span>
<a href="#l9.421"></a><span id="l9.421">                 let responseBody=&quot;&quot;;</span>
<a href="#l9.422"></a><span id="l9.422">                 try {</span>
<a href="#l9.423"></a><span id="l9.423">                     responseBody = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l9.424"></a><span id="l9.424">                 } catch(e) {}</span>
<a href="#l9.425"></a><span id="l9.425" class="difflineat">@@ -595,44 +606,81 @@ calDavCalendar.prototype = {</span>
<a href="#l9.426"></a><span id="l9.426"> </span>
<a href="#l9.427"></a><span id="l9.427">         parentItem.calendar = this.superCalendar;</span>
<a href="#l9.428"></a><span id="l9.428"> </span>
<a href="#l9.429"></a><span id="l9.429">         let httpchannel = cal.prepHttpChannel(itemUri,</span>
<a href="#l9.430"></a><span id="l9.430">                                               serializedItem,</span>
<a href="#l9.431"></a><span id="l9.431">                                               &quot;text/calendar; charset=utf-8&quot;,</span>
<a href="#l9.432"></a><span id="l9.432">                                               this);</span>
<a href="#l9.433"></a><span id="l9.433"> </span>
<a href="#l9.434"></a><span id="l9.434" class="difflineminus">-</span>
<a href="#l9.435"></a><span id="l9.435">         if (!aIgnoreEtag) {</span>
<a href="#l9.436"></a><span id="l9.436">             httpchannel.setRequestHeader(&quot;If-None-Match&quot;, &quot;*&quot;, false);</span>
<a href="#l9.437"></a><span id="l9.437">         }</span>
<a href="#l9.438"></a><span id="l9.438"> </span>
<a href="#l9.439"></a><span id="l9.439">         cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, addListener);</span>
<a href="#l9.440"></a><span id="l9.440">     },</span>
<a href="#l9.441"></a><span id="l9.441"> </span>
<a href="#l9.442"></a><span id="l9.442" class="difflineplus">+    adoptOfflineItem: function(item, listener) {</span>
<a href="#l9.443"></a><span id="l9.443" class="difflineplus">+        let thisCalendar = this;</span>
<a href="#l9.444"></a><span id="l9.444" class="difflineplus">+        let opListener = {</span>
<a href="#l9.445"></a><span id="l9.445" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l9.446"></a><span id="l9.446" class="difflineplus">+                cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l9.447"></a><span id="l9.447" class="difflineplus">+            },</span>
<a href="#l9.448"></a><span id="l9.448" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l9.449"></a><span id="l9.449" class="difflineplus">+                if (Components.isSuccessCode(status)) {</span>
<a href="#l9.450"></a><span id="l9.450" class="difflineplus">+                    let storage = thisCalendar.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l9.451"></a><span id="l9.451" class="difflineplus">+                    storage.addOfflineItem(detail, listener);</span>
<a href="#l9.452"></a><span id="l9.452" class="difflineplus">+                } else if (listener) {</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineplus">+                    listener.onOperationComplete(thisCalendar, status, opType, id, detail);</span>
<a href="#l9.454"></a><span id="l9.454" class="difflineplus">+                }</span>
<a href="#l9.455"></a><span id="l9.455" class="difflineplus">+            }</span>
<a href="#l9.456"></a><span id="l9.456" class="difflineplus">+        };</span>
<a href="#l9.457"></a><span id="l9.457" class="difflineplus">+        thisCalendar.mOfflineStorage.adoptItem(item, opListener);</span>
<a href="#l9.458"></a><span id="l9.458" class="difflineplus">+    },</span>
<a href="#l9.459"></a><span id="l9.459" class="difflineplus">+</span>
<a href="#l9.460"></a><span id="l9.460">     /**</span>
<a href="#l9.461"></a><span id="l9.461">      * modifyItem(); required by calICalendar.idl</span>
<a href="#l9.462"></a><span id="l9.462" class="difflineminus">-     * we actually use doModifyItem()</span>
<a href="#l9.463"></a><span id="l9.463" class="difflineplus">+     * we actually use modifyItemOrUseCache()</span>
<a href="#l9.464"></a><span id="l9.464">      *</span>
<a href="#l9.465"></a><span id="l9.465">      * @param aItem       item to check</span>
<a href="#l9.466"></a><span id="l9.466">      * @param aListener   listener for method completion</span>
<a href="#l9.467"></a><span id="l9.467" class="difflineminus">-     */</span>
<a href="#l9.468"></a><span id="l9.468" class="difflineplus">+    */</span>
<a href="#l9.469"></a><span id="l9.469">     modifyItem: function caldav_modifyItem(aNewItem, aOldItem, aListener) {</span>
<a href="#l9.470"></a><span id="l9.470" class="difflineminus">-        return this.doModifyItem(aNewItem, aOldItem, aListener, false);</span>
<a href="#l9.471"></a><span id="l9.471" class="difflineplus">+        return this.modifyItemOrUseCache(aNewItem, aOldItem, true, aListener);</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineplus">+    },</span>
<a href="#l9.473"></a><span id="l9.473" class="difflineplus">+</span>
<a href="#l9.474"></a><span id="l9.474" class="difflineplus">+    modifyItemOrUseCache: function caldav_modifyItemOrUseCache(aNewItem, aOldItem, useCache, aListener){</span>
<a href="#l9.475"></a><span id="l9.475" class="difflineplus">+        let thisCalendar = this;</span>
<a href="#l9.476"></a><span id="l9.476" class="difflineplus">+        let opListener = {</span>
<a href="#l9.477"></a><span id="l9.477" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l9.478"></a><span id="l9.478" class="difflineplus">+            },</span>
<a href="#l9.479"></a><span id="l9.479" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l9.480"></a><span id="l9.480" class="difflineplus">+                let offline_flag = detail;</span>
<a href="#l9.481"></a><span id="l9.481" class="difflineplus">+                if ((offline_flag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l9.482"></a><span id="l9.482" class="difflineplus">+                     offline_flag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) &amp;&amp; useCache) {</span>
<a href="#l9.483"></a><span id="l9.483" class="difflineplus">+                    thisCalendar.modifyOfflineItem(aNewItem, aOldItem, aListener);</span>
<a href="#l9.484"></a><span id="l9.484" class="difflineplus">+                } else {</span>
<a href="#l9.485"></a><span id="l9.485" class="difflineplus">+                    thisCalendar.doModifyItemOrUseCache(aNewItem, aOldItem, useCache, aListener, false);</span>
<a href="#l9.486"></a><span id="l9.486" class="difflineplus">+                }</span>
<a href="#l9.487"></a><span id="l9.487" class="difflineplus">+            }</span>
<a href="#l9.488"></a><span id="l9.488" class="difflineplus">+        };</span>
<a href="#l9.489"></a><span id="l9.489" class="difflineplus">+        let storage = thisCalendar.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l9.490"></a><span id="l9.490" class="difflineplus">+        storage.getItemOfflineFlag(aOldItem, opListener);</span>
<a href="#l9.491"></a><span id="l9.491">     },</span>
<a href="#l9.492"></a><span id="l9.492"> </span>
<a href="#l9.493"></a><span id="l9.493">     /**</span>
<a href="#l9.494"></a><span id="l9.494">      * Modifies existing item in CalDAV store.</span>
<a href="#l9.495"></a><span id="l9.495">      *</span>
<a href="#l9.496"></a><span id="l9.496">      * @param aItem       item to check</span>
<a href="#l9.497"></a><span id="l9.497">      * @param aOldItem    previous version of item to be modified</span>
<a href="#l9.498"></a><span id="l9.498" class="difflineplus">+     * @param useCache    Flag to use the cached entry in case of failure</span>
<a href="#l9.499"></a><span id="l9.499">      * @param aListener   listener from original request</span>
<a href="#l9.500"></a><span id="l9.500">      * @param aIgnoreEtag ignore item etag</span>
<a href="#l9.501"></a><span id="l9.501">      */</span>
<a href="#l9.502"></a><span id="l9.502" class="difflineminus">-    doModifyItem: function caldav_doModifyItem(aNewItem, aOldItem, aListener, aIgnoreEtag) {</span>
<a href="#l9.503"></a><span id="l9.503" class="difflineplus">+    doModifyItemOrUseCache: function caldav_doModifyItemOrUseCache(aNewItem, aOldItem, useCache, aListener, aIgnoreEtag){</span>
<a href="#l9.504"></a><span id="l9.504">         if (aNewItem.id == null) {</span>
<a href="#l9.505"></a><span id="l9.505">             this.notifyOperationComplete(aListener,</span>
<a href="#l9.506"></a><span id="l9.506">                                          Components.results.NS_ERROR_FAILURE,</span>
<a href="#l9.507"></a><span id="l9.507">                                          Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l9.508"></a><span id="l9.508">                                          aItem.id,</span>
<a href="#l9.509"></a><span id="l9.509">                                          &quot;ID for modifyItem doesn't exist or is null&quot;);</span>
<a href="#l9.510"></a><span id="l9.510">             return;</span>
<a href="#l9.511"></a><span id="l9.511">         }</span>
<a href="#l9.512"></a><span id="l9.512" class="difflineat">@@ -675,32 +723,34 @@ calDavCalendar.prototype = {</span>
<a href="#l9.513"></a><span id="l9.513">                 // Some CalDAV servers will modify items on PUT (add X-props,</span>
<a href="#l9.514"></a><span id="l9.514">                 // for instance) so we'd best re-fetch in order to know</span>
<a href="#l9.515"></a><span id="l9.515">                 // the current state of the item</span>
<a href="#l9.516"></a><span id="l9.516">                 // Observers will be notified in getUpdatedItem()</span>
<a href="#l9.517"></a><span id="l9.517">                 thisCalendar.getUpdatedItem(aNewItem, aListener);</span>
<a href="#l9.518"></a><span id="l9.518">                 // SOGo has calendarUri == inboxUri so we need to be careful</span>
<a href="#l9.519"></a><span id="l9.519">                 // about deletions</span>
<a href="#l9.520"></a><span id="l9.520">                 if (wasInboxItem &amp;&amp; thisCalendar.mShouldPollInbox) {</span>
<a href="#l9.521"></a><span id="l9.521" class="difflineminus">-                    thisCalendar.doDeleteItem(aNewItem, null, true, true, null);</span>
<a href="#l9.522"></a><span id="l9.522" class="difflineplus">+                    thisCalendar.doDeleteItemOrUseCache(aNewItem, true, null, true, true, null);</span>
<a href="#l9.523"></a><span id="l9.523">                 }</span>
<a href="#l9.524"></a><span id="l9.524">             } else if (status == 412) {</span>
<a href="#l9.525"></a><span id="l9.525">                 thisCalendar.promptOverwrite(CALDAV_MODIFY_ITEM, aNewItem,</span>
<a href="#l9.526"></a><span id="l9.526">                                              aListener, aOldItem);</span>
<a href="#l9.527"></a><span id="l9.527" class="difflineplus">+            } else if ((status &gt;= 500 &amp;&amp; status &lt;= 510) &amp;&amp; (useCache &amp;&amp; thisCalendar.mOfflineStorage)) {</span>
<a href="#l9.528"></a><span id="l9.528" class="difflineplus">+                cal.LOG(&quot;[calDavCalendar] doModifyItemOrUseCache received status code of server unavailibity. Putting entry in cache for later try.&quot;);</span>
<a href="#l9.529"></a><span id="l9.529" class="difflineplus">+                thisCalendar.modifyOfflineItem(aNewItem, aOldItem, aListener);</span>
<a href="#l9.530"></a><span id="l9.530">             } else {</span>
<a href="#l9.531"></a><span id="l9.531">                 if (status &gt; 999) {</span>
<a href="#l9.532"></a><span id="l9.532">                     status = &quot;0x &quot; + status.toString(16);</span>
<a href="#l9.533"></a><span id="l9.533">                 }</span>
<a href="#l9.534"></a><span id="l9.534"> </span>
<a href="#l9.535"></a><span id="l9.535">                 let responseBody=&quot;&quot;;</span>
<a href="#l9.536"></a><span id="l9.536">                 try {</span>
<a href="#l9.537"></a><span id="l9.537">                     responseBody = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l9.538"></a><span id="l9.538">                 } catch(e) {}</span>
<a href="#l9.539"></a><span id="l9.539"> </span>
<a href="#l9.540"></a><span id="l9.540" class="difflineminus">-</span>
<a href="#l9.541"></a><span id="l9.541">                 cal.ERROR(&quot;CalDAV: Unexpected status modifying item to &quot; +</span>
<a href="#l9.542"></a><span id="l9.542">                         thisCalendar.name + &quot;: &quot; + status + &quot;\n&quot; +</span>
<a href="#l9.543"></a><span id="l9.543">                         responseBody + &quot;\n&quot; +</span>
<a href="#l9.544"></a><span id="l9.544">                         modifiedItemICS);</span>
<a href="#l9.545"></a><span id="l9.545"> </span>
<a href="#l9.546"></a><span id="l9.546">                 thisCalendar.reportDavError(Components.interfaces.calIErrors.DAV_PUT_ERROR,</span>
<a href="#l9.547"></a><span id="l9.547">                                             status,</span>
<a href="#l9.548"></a><span id="l9.548">                                             responseBody);</span>
<a href="#l9.549"></a><span id="l9.549" class="difflineat">@@ -716,37 +766,91 @@ calDavCalendar.prototype = {</span>
<a href="#l9.550"></a><span id="l9.550">             httpchannel.setRequestHeader(&quot;If-Match&quot;,</span>
<a href="#l9.551"></a><span id="l9.551">                                          this.mItemInfoCache[aNewItem.id].etag,</span>
<a href="#l9.552"></a><span id="l9.552">                                          false);</span>
<a href="#l9.553"></a><span id="l9.553">         }</span>
<a href="#l9.554"></a><span id="l9.554"> </span>
<a href="#l9.555"></a><span id="l9.555">         cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, modListener);</span>
<a href="#l9.556"></a><span id="l9.556">     },</span>
<a href="#l9.557"></a><span id="l9.557"> </span>
<a href="#l9.558"></a><span id="l9.558" class="difflineplus">+    modifyOfflineItem: function(aNewItem, aOldItem, aListener) {</span>
<a href="#l9.559"></a><span id="l9.559" class="difflineplus">+        let thisCalendar = this;</span>
<a href="#l9.560"></a><span id="l9.560" class="difflineplus">+        let opListener = {</span>
<a href="#l9.561"></a><span id="l9.561" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l9.562"></a><span id="l9.562" class="difflineplus">+                cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l9.563"></a><span id="l9.563" class="difflineplus">+            },</span>
<a href="#l9.564"></a><span id="l9.564" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l9.565"></a><span id="l9.565" class="difflineplus">+                if (Components.isSuccessCode(status)) {</span>
<a href="#l9.566"></a><span id="l9.566" class="difflineplus">+                    // Modify the offline item in the storage, passing the</span>
<a href="#l9.567"></a><span id="l9.567" class="difflineplus">+                    // listener will make sure its notified</span>
<a href="#l9.568"></a><span id="l9.568" class="difflineplus">+                    let storage = thisCalendar.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l9.569"></a><span id="l9.569" class="difflineplus">+                    storage.modifyOfflineItem(detail, aListener);</span>
<a href="#l9.570"></a><span id="l9.570" class="difflineplus">+                } else if (aListener) {</span>
<a href="#l9.571"></a><span id="l9.571" class="difflineplus">+                    // If there was not a success, then we need to notify the</span>
<a href="#l9.572"></a><span id="l9.572" class="difflineplus">+                    // listener ourselves</span>
<a href="#l9.573"></a><span id="l9.573" class="difflineplus">+                    aListener.onOperationComplete(thisCalendar.superCalendar, status, opType, id, detail);</span>
<a href="#l9.574"></a><span id="l9.574" class="difflineplus">+                }</span>
<a href="#l9.575"></a><span id="l9.575" class="difflineplus">+            }</span>
<a href="#l9.576"></a><span id="l9.576" class="difflineplus">+        };</span>
<a href="#l9.577"></a><span id="l9.577" class="difflineplus">+        thisCalendar.mOfflineStorage.modifyItem(aNewItem, aOldItem, opListener);</span>
<a href="#l9.578"></a><span id="l9.578" class="difflineplus">+    },</span>
<a href="#l9.579"></a><span id="l9.579" class="difflineplus">+</span>
<a href="#l9.580"></a><span id="l9.580">     /**</span>
<a href="#l9.581"></a><span id="l9.581">      * deleteItem(); required by calICalendar.idl</span>
<a href="#l9.582"></a><span id="l9.582" class="difflineminus">-     * the actual deletion is done in doDeleteItem()</span>
<a href="#l9.583"></a><span id="l9.583" class="difflineplus">+     * the actual deletion is done in deleteItemOrUseCache()</span>
<a href="#l9.584"></a><span id="l9.584">      *</span>
<a href="#l9.585"></a><span id="l9.585">      * @param aItem       item to delete</span>
<a href="#l9.586"></a><span id="l9.586">      * @param aListener   listener for method completion</span>
<a href="#l9.587"></a><span id="l9.587">      */</span>
<a href="#l9.588"></a><span id="l9.588">     deleteItem: function caldav_deleteItem(aItem, aListener) {</span>
<a href="#l9.589"></a><span id="l9.589" class="difflineminus">-        return this.doDeleteItem(aItem, aListener, false);</span>
<a href="#l9.590"></a><span id="l9.590" class="difflineplus">+        return this.deleteItemOrUseCache(aItem, true, aListener);</span>
<a href="#l9.591"></a><span id="l9.591">     },</span>
<a href="#l9.592"></a><span id="l9.592"> </span>
<a href="#l9.593"></a><span id="l9.593" class="difflineplus">+    deleteItemOrUseCache: function caldav_deleteItemOrUseCache(aItem, useCache, aListener){</span>
<a href="#l9.594"></a><span id="l9.594" class="difflineplus">+        let thisCalendar = this;</span>
<a href="#l9.595"></a><span id="l9.595" class="difflineplus">+</span>
<a href="#l9.596"></a><span id="l9.596" class="difflineplus">+        let deleteListener = { //We need a listener because the original doDeleteItemOrUseCache would return null upon successful item deletion</span>
<a href="#l9.597"></a><span id="l9.597" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l9.598"></a><span id="l9.598" class="difflineplus">+                cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l9.599"></a><span id="l9.599" class="difflineplus">+            },</span>
<a href="#l9.600"></a><span id="l9.600" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l9.601"></a><span id="l9.601" class="difflineplus">+                aListener.onOperationComplete(calendar, status, opType, aItem.id, aItem);</span>
<a href="#l9.602"></a><span id="l9.602" class="difflineplus">+            }</span>
<a href="#l9.603"></a><span id="l9.603" class="difflineplus">+        };</span>
<a href="#l9.604"></a><span id="l9.604" class="difflineplus">+</span>
<a href="#l9.605"></a><span id="l9.605" class="difflineplus">+        // If the item has an offline_flag associated with itself then it is better to</span>
<a href="#l9.606"></a><span id="l9.606" class="difflineplus">+        // do offline deletion since the items will not be present in the</span>
<a href="#l9.607"></a><span id="l9.607" class="difflineplus">+        // mItemInfoCache. The items will be reconciled whenever the server becomes available</span>
<a href="#l9.608"></a><span id="l9.608" class="difflineplus">+        let opListener = {</span>
<a href="#l9.609"></a><span id="l9.609" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l9.610"></a><span id="l9.610" class="difflineplus">+            },</span>
<a href="#l9.611"></a><span id="l9.611" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l9.612"></a><span id="l9.612" class="difflineplus">+                let offline_flag = detail;</span>
<a href="#l9.613"></a><span id="l9.613" class="difflineplus">+                if ((offline_flag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l9.614"></a><span id="l9.614" class="difflineplus">+                     offline_flag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) &amp;&amp; useCache) {</span>
<a href="#l9.615"></a><span id="l9.615" class="difflineplus">+                    thisCalendar.deleteOfflineItem(aItem, deleteListener);</span>
<a href="#l9.616"></a><span id="l9.616" class="difflineplus">+                } else {</span>
<a href="#l9.617"></a><span id="l9.617" class="difflineplus">+                    thisCalendar.doDeleteItemOrUseCache(aItem, useCache, deleteListener, false);</span>
<a href="#l9.618"></a><span id="l9.618" class="difflineplus">+                }</span>
<a href="#l9.619"></a><span id="l9.619" class="difflineplus">+            }</span>
<a href="#l9.620"></a><span id="l9.620" class="difflineplus">+        };</span>
<a href="#l9.621"></a><span id="l9.621" class="difflineplus">+        let storage = thisCalendar.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l9.622"></a><span id="l9.622" class="difflineplus">+        storage.getItemOfflineFlag(aItem, opListener);</span>
<a href="#l9.623"></a><span id="l9.623" class="difflineplus">+    },</span>
<a href="#l9.624"></a><span id="l9.624">     /**</span>
<a href="#l9.625"></a><span id="l9.625">      * Deletes item from CalDAV store.</span>
<a href="#l9.626"></a><span id="l9.626">      *</span>
<a href="#l9.627"></a><span id="l9.627">      * @param aItem       item to delete</span>
<a href="#l9.628"></a><span id="l9.628">      * @param aListener   listener for method completion</span>
<a href="#l9.629"></a><span id="l9.629" class="difflineplus">+     * @param useCache    flag to use the cache in case of failure</span>
<a href="#l9.630"></a><span id="l9.630">      * @param aIgnoreEtag ignore item etag</span>
<a href="#l9.631"></a><span id="l9.631">      * @param aFromInbox  delete from inbox rather than calendar</span>
<a href="#l9.632"></a><span id="l9.632" class="difflineminus">-     * @param aUri        uri of item to delete     */</span>
<a href="#l9.633"></a><span id="l9.633" class="difflineminus">-    doDeleteItem: function caldav_doDeleteItem(aItem, aListener, aIgnoreEtag, aFromInbox, aUri) {</span>
<a href="#l9.634"></a><span id="l9.634" class="difflineminus">-</span>
<a href="#l9.635"></a><span id="l9.635" class="difflineplus">+     * @param aUri        uri of item to delete</span>
<a href="#l9.636"></a><span id="l9.636" class="difflineplus">+     * */</span>
<a href="#l9.637"></a><span id="l9.637" class="difflineplus">+    doDeleteItemOrUseCache: function caldav_doDeleteItemOrUseCache(aItem, useCache, aListener, aIgnoreEtag, aFromInbox, aUri){</span>
<a href="#l9.638"></a><span id="l9.638">         if (aItem.id == null) {</span>
<a href="#l9.639"></a><span id="l9.639">             this.notifyOperationComplete(aListener,</span>
<a href="#l9.640"></a><span id="l9.640">                                          Components.results.NS_ERROR_FAILURE,</span>
<a href="#l9.641"></a><span id="l9.641">                                          Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l9.642"></a><span id="l9.642">                                          aItem.id,</span>
<a href="#l9.643"></a><span id="l9.643">                                          &quot;ID doesn't exist for deleteItem&quot;);</span>
<a href="#l9.644"></a><span id="l9.644">             return;</span>
<a href="#l9.645"></a><span id="l9.645">         }</span>
<a href="#l9.646"></a><span id="l9.646" class="difflineat">@@ -778,35 +882,47 @@ calDavCalendar.prototype = {</span>
<a href="#l9.647"></a><span id="l9.647">             //</span>
<a href="#l9.648"></a><span id="l9.648">             if (status == 204 || status == 200) {</span>
<a href="#l9.649"></a><span id="l9.649">                 if (!aFromInbox) {</span>
<a href="#l9.650"></a><span id="l9.650">                     if (thisCalendar.isCached) {</span>
<a href="#l9.651"></a><span id="l9.651">                         // the item is deleted in the storage calendar from calCachedCalendar</span>
<a href="#l9.652"></a><span id="l9.652">                         realListener.onOperationComplete(thisCalendar, status,</span>
<a href="#l9.653"></a><span id="l9.653">                                                          Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l9.654"></a><span id="l9.654">                                                          null, null);</span>
<a href="#l9.655"></a><span id="l9.655" class="difflineplus">+                        thisCalendar.mOfflineStorage.deleteMetaData(aItem.id);</span>
<a href="#l9.656"></a><span id="l9.656">                     } else {</span>
<a href="#l9.657"></a><span id="l9.657" class="difflineminus">-                        thisCalendar.mTargetCalendar.deleteItem(aItem, aListener);</span>
<a href="#l9.658"></a><span id="l9.658" class="difflineplus">+                        thisCalendar.mOfflineStorage.deleteItem(aItem, aListener);</span>
<a href="#l9.659"></a><span id="l9.659">                     }</span>
<a href="#l9.660"></a><span id="l9.660">                     let decodedPath = thisCalendar.ensureDecodedPath(eventUri.path);</span>
<a href="#l9.661"></a><span id="l9.661" class="difflineminus">-                    delete thisCalendar.mPathIndex[decodedPath];</span>
<a href="#l9.662"></a><span id="l9.662" class="difflineplus">+                    delete thisCalendar.mHrefIndex[decodedPath];</span>
<a href="#l9.663"></a><span id="l9.663">                     delete thisCalendar.mItemInfoCache[aItem.id];</span>
<a href="#l9.664"></a><span id="l9.664">                     cal.LOG(&quot;CalDAV: Item deleted successfully from calendar&quot; +</span>
<a href="#l9.665"></a><span id="l9.665">                             thisCalendar.name);</span>
<a href="#l9.666"></a><span id="l9.666">                 }</span>
<a href="#l9.667"></a><span id="l9.667">             } else if (status == 412) {</span>
<a href="#l9.668"></a><span id="l9.668">                 // item has either been modified or deleted by someone else</span>
<a href="#l9.669"></a><span id="l9.669">                 // check to see which</span>
<a href="#l9.670"></a><span id="l9.670"> </span>
<a href="#l9.671"></a><span id="l9.671">                 let httpchannel2 = cal.prepHttpChannel(eventUri,</span>
<a href="#l9.672"></a><span id="l9.672">                                                        null,</span>
<a href="#l9.673"></a><span id="l9.673">                                                        null,</span>
<a href="#l9.674"></a><span id="l9.674">                                                        thisCalendar);</span>
<a href="#l9.675"></a><span id="l9.675">                 httpchannel2.requestMethod = &quot;HEAD&quot;;</span>
<a href="#l9.676"></a><span id="l9.676">                 cal.sendHttpRequest(cal.createStreamLoader(), httpchannel2, delListener2);</span>
<a href="#l9.677"></a><span id="l9.677" class="difflineplus">+            } else if ((status &gt;= 500 &amp;&amp; status &lt;= 510) &amp;&amp; (useCache &amp;&amp; thisCalendar.mOfflineStorage)) {</span>
<a href="#l9.678"></a><span id="l9.678" class="difflineplus">+                cal.LOG(&quot;[calDavCalendar] Remote Calendar &quot; + thisCalendar.name + &quot; is currently unavailabile. Putting entry in cache for a later try.&quot;);</span>
<a href="#l9.679"></a><span id="l9.679" class="difflineplus">+                let opListener = {</span>
<a href="#l9.680"></a><span id="l9.680" class="difflineplus">+                    // We should not return a success code since the listeners can delete the physical item in case of success</span>
<a href="#l9.681"></a><span id="l9.681" class="difflineplus">+                    onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l9.682"></a><span id="l9.682" class="difflineplus">+                    onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l9.683"></a><span id="l9.683" class="difflineplus">+                         aListener.onOperationComplete(calendar, Components.results.NS_ERROR_CONNECTION_REFUSED,</span>
<a href="#l9.684"></a><span id="l9.684" class="difflineplus">+                                          Components.interfaces.calIOperationListener.GET, aItem.id, aItem);</span>
<a href="#l9.685"></a><span id="l9.685" class="difflineplus">+                    }</span>
<a href="#l9.686"></a><span id="l9.686" class="difflineplus">+                };</span>
<a href="#l9.687"></a><span id="l9.687" class="difflineplus">+                thisCalendar.deleteOfflineItem(aItem, opListener);</span>
<a href="#l9.688"></a><span id="l9.688">             } else {</span>
<a href="#l9.689"></a><span id="l9.689">                 let responseBody=&quot;&quot;;</span>
<a href="#l9.690"></a><span id="l9.690">                 try {</span>
<a href="#l9.691"></a><span id="l9.691">                     responseBody = cal.convertByteArray(aResult, aResultLength);</span>
<a href="#l9.692"></a><span id="l9.692">                 } catch(e) {}</span>
<a href="#l9.693"></a><span id="l9.693"> </span>
<a href="#l9.694"></a><span id="l9.694">                 cal.ERROR(&quot;CalDAV: Unexpected status deleting item from &quot; +</span>
<a href="#l9.695"></a><span id="l9.695">                           thisCalendar.name + &quot;: &quot; + status + &quot;\n&quot; +</span>
<a href="#l9.696"></a><span id="l9.696" class="difflineat">@@ -815,43 +931,61 @@ calDavCalendar.prototype = {</span>
<a href="#l9.697"></a><span id="l9.697"> </span>
<a href="#l9.698"></a><span id="l9.698">                 thisCalendar.reportDavError(Components.interfaces.calIErrors.DAV_REMOVE_ERROR,</span>
<a href="#l9.699"></a><span id="l9.699">                                             status,</span>
<a href="#l9.700"></a><span id="l9.700">                                             responseBody);</span>
<a href="#l9.701"></a><span id="l9.701">             }</span>
<a href="#l9.702"></a><span id="l9.702">         };</span>
<a href="#l9.703"></a><span id="l9.703">         var delListener2 = {};</span>
<a href="#l9.704"></a><span id="l9.704">         delListener2.onStreamComplete =</span>
<a href="#l9.705"></a><span id="l9.705" class="difflineminus">-        function caldav_dDI_del2_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l9.706"></a><span id="l9.706" class="difflineminus">-            let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l9.707"></a><span id="l9.707" class="difflineminus">-            let status = request.responseStatus;</span>
<a href="#l9.708"></a><span id="l9.708" class="difflineminus">-            if (status == 404) {</span>
<a href="#l9.709"></a><span id="l9.709" class="difflineminus">-                // someone else already deleted it</span>
<a href="#l9.710"></a><span id="l9.710" class="difflineminus">-                return;</span>
<a href="#l9.711"></a><span id="l9.711" class="difflineminus">-            } else {</span>
<a href="#l9.712"></a><span id="l9.712" class="difflineminus">-                thisCalendar.promptOverwrite(CALDAV_DELETE_ITEM, aItem,</span>
<a href="#l9.713"></a><span id="l9.713" class="difflineminus">-                                             realListener, null);</span>
<a href="#l9.714"></a><span id="l9.714" class="difflineminus">-            }</span>
<a href="#l9.715"></a><span id="l9.715" class="difflineminus">-        };</span>
<a href="#l9.716"></a><span id="l9.716" class="difflineplus">+            function caldav_dDI_del2_onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l9.717"></a><span id="l9.717" class="difflineplus">+                let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l9.718"></a><span id="l9.718" class="difflineplus">+                let status = request.responseStatus;</span>
<a href="#l9.719"></a><span id="l9.719" class="difflineplus">+                if (status == 404) {</span>
<a href="#l9.720"></a><span id="l9.720" class="difflineplus">+                    // someone else already deleted it</span>
<a href="#l9.721"></a><span id="l9.721" class="difflineplus">+                    return;</span>
<a href="#l9.722"></a><span id="l9.722" class="difflineplus">+                } else if ((status &gt;= 500 &amp;&amp; status &lt;= 510) &amp;&amp; (useCache &amp;&amp; thisCalendar.mOfflineStorage)) {</span>
<a href="#l9.723"></a><span id="l9.723" class="difflineplus">+                    cal.LOG(&quot;[calDavCalendar] doDeleteItemOrUseCache recd status response of remote calendar unavailability. Putting entry in cache for a later try.&quot;);</span>
<a href="#l9.724"></a><span id="l9.724" class="difflineplus">+                    let opListener = {</span>
<a href="#l9.725"></a><span id="l9.725" class="difflineplus">+                         //We should not return a success code since the listeners can delete the physical item in case of success</span>
<a href="#l9.726"></a><span id="l9.726" class="difflineplus">+                         onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l9.727"></a><span id="l9.727" class="difflineplus">+                        },</span>
<a href="#l9.728"></a><span id="l9.728" class="difflineplus">+                         onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l9.729"></a><span id="l9.729" class="difflineplus">+                              aListener.onOperationComplete(calendar, Components.results.NS_ERROR_CONNECTION_REFUSED,</span>
<a href="#l9.730"></a><span id="l9.730" class="difflineplus">+                                               Components.interfaces.calIOperationListener.GET, aItem.id, aItem);</span>
<a href="#l9.731"></a><span id="l9.731" class="difflineplus">+                        }</span>
<a href="#l9.732"></a><span id="l9.732" class="difflineplus">+                    };</span>
<a href="#l9.733"></a><span id="l9.733" class="difflineplus">+                    thisCalendar.deleteOfflineItem(aItem, opListener);</span>
<a href="#l9.734"></a><span id="l9.734" class="difflineplus">+                } else {</span>
<a href="#l9.735"></a><span id="l9.735" class="difflineplus">+                    thisCalendar.promptOverwrite(CALDAV_DELETE_ITEM, aItem,</span>
<a href="#l9.736"></a><span id="l9.736" class="difflineplus">+                                                 realListener, null);</span>
<a href="#l9.737"></a><span id="l9.737" class="difflineplus">+                }</span>
<a href="#l9.738"></a><span id="l9.738" class="difflineplus">+            };</span>
<a href="#l9.739"></a><span id="l9.739"> </span>
<a href="#l9.740"></a><span id="l9.740">         if (this.verboseLogging()) {</span>
<a href="#l9.741"></a><span id="l9.741">             cal.LOG(&quot;CalDAV: Deleting &quot; + eventUri.spec);</span>
<a href="#l9.742"></a><span id="l9.742">         }</span>
<a href="#l9.743"></a><span id="l9.743"> </span>
<a href="#l9.744"></a><span id="l9.744">         let httpchannel = cal.prepHttpChannel(eventUri, null, null, this);</span>
<a href="#l9.745"></a><span id="l9.745">         if (!aIgnoreEtag) {</span>
<a href="#l9.746"></a><span id="l9.746">             httpchannel.setRequestHeader(&quot;If-Match&quot;,</span>
<a href="#l9.747"></a><span id="l9.747">                                          this.mItemInfoCache[aItem.id].etag,</span>
<a href="#l9.748"></a><span id="l9.748">                                          false);</span>
<a href="#l9.749"></a><span id="l9.749">         }</span>
<a href="#l9.750"></a><span id="l9.750">         httpchannel.requestMethod = &quot;DELETE&quot;;</span>
<a href="#l9.751"></a><span id="l9.751"> </span>
<a href="#l9.752"></a><span id="l9.752">         cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, delListener);</span>
<a href="#l9.753"></a><span id="l9.753">     },</span>
<a href="#l9.754"></a><span id="l9.754"> </span>
<a href="#l9.755"></a><span id="l9.755" class="difflineplus">+    deleteOfflineItem: function(item, listener) {</span>
<a href="#l9.756"></a><span id="l9.756" class="difflineplus">+        /* We do not delete the item from the cache, as we will need it when reconciling the cache content and the server content. */</span>
<a href="#l9.757"></a><span id="l9.757" class="difflineplus">+        let storage = this.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l9.758"></a><span id="l9.758" class="difflineplus">+        storage.deleteOfflineItem(item, listener);</span>
<a href="#l9.759"></a><span id="l9.759" class="difflineplus">+    },</span>
<a href="#l9.760"></a><span id="l9.760" class="difflineplus">+</span>
<a href="#l9.761"></a><span id="l9.761">     /**</span>
<a href="#l9.762"></a><span id="l9.762">      * Add an item to the target calendar</span>
<a href="#l9.763"></a><span id="l9.763">      *</span>
<a href="#l9.764"></a><span id="l9.764">      * @param path      Item path MUST NOT BE ENCODED</span>
<a href="#l9.765"></a><span id="l9.765">      * @param calData   iCalendar string representation of the item</span>
<a href="#l9.766"></a><span id="l9.766">      * @param aUri      Base URI of the request</span>
<a href="#l9.767"></a><span id="l9.767">      * @param aListener Listener</span>
<a href="#l9.768"></a><span id="l9.768">      */</span>
<a href="#l9.769"></a><span id="l9.769" class="difflineat">@@ -899,38 +1033,38 @@ calDavCalendar.prototype = {</span>
<a href="#l9.770"></a><span id="l9.770">         // uri's path has. This way we make sure to handle servers</span>
<a href="#l9.771"></a><span id="l9.771">         // that pass paths like /dav/user/Calendar while</span>
<a href="#l9.772"></a><span id="l9.772">         // the request uri is like /dav/user@example.org/Calendar.</span>
<a href="#l9.773"></a><span id="l9.773">         let resPathComponents = path.split(&quot;/&quot;);</span>
<a href="#l9.774"></a><span id="l9.774">         resPathComponents.splice(0, uriPathComponentLength - 1);</span>
<a href="#l9.775"></a><span id="l9.775">         let locationPath = resPathComponents.join(&quot;/&quot;);</span>
<a href="#l9.776"></a><span id="l9.776">         let isInboxItem = this.isInbox(aUri.spec);</span>
<a href="#l9.777"></a><span id="l9.777"> </span>
<a href="#l9.778"></a><span id="l9.778" class="difflineminus">-        if (this.mPathIndex[path] &amp;&amp;</span>
<a href="#l9.779"></a><span id="l9.779" class="difflineplus">+        if (this.mHrefIndex[path] &amp;&amp;</span>
<a href="#l9.780"></a><span id="l9.780">             !this.mItemInfoCache[item.id]) {</span>
<a href="#l9.781"></a><span id="l9.781">             // If we get here it means a meeting has kept the same filename</span>
<a href="#l9.782"></a><span id="l9.782">             // but changed its uid, which can happen server side.</span>
<a href="#l9.783"></a><span id="l9.783">             // Delete the meeting before re-adding it</span>
<a href="#l9.784"></a><span id="l9.784">             this.deleteTargetCalendarItem(path);</span>
<a href="#l9.785"></a><span id="l9.785">         }</span>
<a href="#l9.786"></a><span id="l9.786"> </span>
<a href="#l9.787"></a><span id="l9.787">         if (this.mItemInfoCache[item.id]) {</span>
<a href="#l9.788"></a><span id="l9.788">             this.mItemInfoCache[item.id].isNew = false;</span>
<a href="#l9.789"></a><span id="l9.789">         } else {</span>
<a href="#l9.790"></a><span id="l9.790">             this.mItemInfoCache[item.id] = { isNew: true };</span>
<a href="#l9.791"></a><span id="l9.791">         }</span>
<a href="#l9.792"></a><span id="l9.792">         this.mItemInfoCache[item.id].locationPath = locationPath;</span>
<a href="#l9.793"></a><span id="l9.793">         this.mItemInfoCache[item.id].isInboxItem = isInboxItem;</span>
<a href="#l9.794"></a><span id="l9.794"> </span>
<a href="#l9.795"></a><span id="l9.795" class="difflineminus">-        this.mPathIndex[path] = item.id;</span>
<a href="#l9.796"></a><span id="l9.796" class="difflineplus">+        this.mHrefIndex[path] = item.id;</span>
<a href="#l9.797"></a><span id="l9.797">         this.mItemInfoCache[item.id].etag = etag;</span>
<a href="#l9.798"></a><span id="l9.798">         if (this.mItemInfoCache[item.id].isNew) {</span>
<a href="#l9.799"></a><span id="l9.799" class="difflineminus">-            this.mTargetCalendar.adoptItem(item, aListener);</span>
<a href="#l9.800"></a><span id="l9.800" class="difflineplus">+            this.mOfflineStorage.adoptItem(item, aListener);</span>
<a href="#l9.801"></a><span id="l9.801">         } else {</span>
<a href="#l9.802"></a><span id="l9.802" class="difflineminus">-            this.mTargetCalendar.modifyItem(item, null, aListener);</span>
<a href="#l9.803"></a><span id="l9.803" class="difflineplus">+            this.mOfflineStorage.modifyItem(item, null, aListener);</span>
<a href="#l9.804"></a><span id="l9.804">         }</span>
<a href="#l9.805"></a><span id="l9.805"> </span>
<a href="#l9.806"></a><span id="l9.806">         if (this.isCached) {</span>
<a href="#l9.807"></a><span id="l9.807">             this.setMetaData(item.id, path, etag, isInboxItem);</span>
<a href="#l9.808"></a><span id="l9.808">         }</span>
<a href="#l9.809"></a><span id="l9.809">     },</span>
<a href="#l9.810"></a><span id="l9.810"> </span>
<a href="#l9.811"></a><span id="l9.811">     /**</span>
<a href="#l9.812"></a><span id="l9.812" class="difflineat">@@ -949,29 +1083,32 @@ calDavCalendar.prototype = {</span>
<a href="#l9.813"></a><span id="l9.813">                                                      aCount,</span>
<a href="#l9.814"></a><span id="l9.814">                                                      aItems) {</span>
<a href="#l9.815"></a><span id="l9.815"> </span>
<a href="#l9.816"></a><span id="l9.816">                 foundItem = aItems[0];</span>
<a href="#l9.817"></a><span id="l9.817">             },</span>
<a href="#l9.818"></a><span id="l9.818">             onOperationComplete: function deleteLocalItem_getItem_onOperationComplete() {}</span>
<a href="#l9.819"></a><span id="l9.819">         };</span>
<a href="#l9.820"></a><span id="l9.820"> </span>
<a href="#l9.821"></a><span id="l9.821" class="difflineminus">-        this.mTargetCalendar.getItem(this.mPathIndex[path],</span>
<a href="#l9.822"></a><span id="l9.822" class="difflineplus">+        this.mOfflineStorage.getItem(this.mHrefIndex[path],</span>
<a href="#l9.823"></a><span id="l9.823">                                      getItemListener);</span>
<a href="#l9.824"></a><span id="l9.824">         // Since the target calendar's operations are synchronous, we can</span>
<a href="#l9.825"></a><span id="l9.825">         // safely set variables from this function.</span>
<a href="#l9.826"></a><span id="l9.826">         if (foundItem) {</span>
<a href="#l9.827"></a><span id="l9.827">             let wasInboxItem = this.mItemInfoCache[foundItem.id].isInboxItem;</span>
<a href="#l9.828"></a><span id="l9.828">             if ((wasInboxItem &amp;&amp; this.isInbox(path)) ||</span>
<a href="#l9.829"></a><span id="l9.829">                 (wasInboxItem === false &amp;&amp; !this.isInbox(path))) {</span>
<a href="#l9.830"></a><span id="l9.830"> </span>
<a href="#l9.831"></a><span id="l9.831">                 cal.LOG(&quot;CalDAV: deleting item: &quot; + path + &quot;, uid: &quot; + foundItem.id);</span>
<a href="#l9.832"></a><span id="l9.832" class="difflineminus">-                delete this.mPathIndex[path];</span>
<a href="#l9.833"></a><span id="l9.833" class="difflineplus">+                delete this.mHrefIndex[path];</span>
<a href="#l9.834"></a><span id="l9.834">                 delete this.mItemInfoCache[foundItem.id];</span>
<a href="#l9.835"></a><span id="l9.835" class="difflineminus">-                this.mTargetCalendar.deleteItem(foundItem,</span>
<a href="#l9.836"></a><span id="l9.836" class="difflineplus">+                if (this.isCached) {</span>
<a href="#l9.837"></a><span id="l9.837" class="difflineplus">+                    this.mOfflineStorage.deleteMetaData(foundItem.id);</span>
<a href="#l9.838"></a><span id="l9.838" class="difflineplus">+                }</span>
<a href="#l9.839"></a><span id="l9.839" class="difflineplus">+                this.mOfflineStorage.deleteItem(foundItem,</span>
<a href="#l9.840"></a><span id="l9.840">                                                 getItemListener);</span>
<a href="#l9.841"></a><span id="l9.841">                 isDeleted = true;</span>
<a href="#l9.842"></a><span id="l9.842">             }</span>
<a href="#l9.843"></a><span id="l9.843">         }</span>
<a href="#l9.844"></a><span id="l9.844">         return isDeleted;</span>
<a href="#l9.845"></a><span id="l9.845">     },</span>
<a href="#l9.846"></a><span id="l9.846"> </span>
<a href="#l9.847"></a><span id="l9.847">     /**</span>
<a href="#l9.848"></a><span id="l9.848" class="difflineat">@@ -994,18 +1131,18 @@ calDavCalendar.prototype = {</span>
<a href="#l9.849"></a><span id="l9.849">             }</span>
<a href="#l9.850"></a><span id="l9.850">         } else {</span>
<a href="#l9.851"></a><span id="l9.851">             this.mObservers.notify(&quot;onLoad&quot;, [this]);</span>
<a href="#l9.852"></a><span id="l9.852">         }</span>
<a href="#l9.853"></a><span id="l9.853"> </span>
<a href="#l9.854"></a><span id="l9.854">         this.mFirstRefreshDone = true;</span>
<a href="#l9.855"></a><span id="l9.855">         while (this.mQueuedQueries.length) {</span>
<a href="#l9.856"></a><span id="l9.856">             let query = this.mQueuedQueries.pop();</span>
<a href="#l9.857"></a><span id="l9.857" class="difflineminus">-            this.mTargetCalendar.getItems</span>
<a href="#l9.858"></a><span id="l9.858" class="difflineminus">-                .apply(this.mTargetCalendar, query);</span>
<a href="#l9.859"></a><span id="l9.859" class="difflineplus">+            this.mOfflineStorage.getItems</span>
<a href="#l9.860"></a><span id="l9.860" class="difflineplus">+                .apply(this.mOfflineStorage, query);</span>
<a href="#l9.861"></a><span id="l9.861">         }</span>
<a href="#l9.862"></a><span id="l9.862">         if (this.hasScheduling &amp;&amp;</span>
<a href="#l9.863"></a><span id="l9.863">             !this.isInbox(calendarURI.spec)) {</span>
<a href="#l9.864"></a><span id="l9.864">             this.pollInbox();</span>
<a href="#l9.865"></a><span id="l9.865">         }</span>
<a href="#l9.866"></a><span id="l9.866">     },</span>
<a href="#l9.867"></a><span id="l9.867"> </span>
<a href="#l9.868"></a><span id="l9.868">     /**</span>
<a href="#l9.869"></a><span id="l9.869" class="difflineat">@@ -1013,21 +1150,16 @@ calDavCalendar.prototype = {</span>
<a href="#l9.870"></a><span id="l9.870">      *</span>
<a href="#l9.871"></a><span id="l9.871">      * @param errorMsg           Error message</span>
<a href="#l9.872"></a><span id="l9.872">      * @param aListener          (optional) Listener of the request</span>
<a href="#l9.873"></a><span id="l9.873">      * @param aChangeLogListener (optional)Listener for cached calendars</span>
<a href="#l9.874"></a><span id="l9.874">      */</span>
<a href="#l9.875"></a><span id="l9.875">     notifyGetFailed: function notifyGetFailed(errorMsg, aListener, aChangeLogListener) {</span>
<a href="#l9.876"></a><span id="l9.876">          cal.WARN(&quot;CalDAV: Get failed: &quot; + errorMsg);</span>
<a href="#l9.877"></a><span id="l9.877"> </span>
<a href="#l9.878"></a><span id="l9.878" class="difflineminus">-         // Revert the ctag, since something failed it is no longer valid.</span>
<a href="#l9.879"></a><span id="l9.879" class="difflineminus">-         this.mCtag = this.mOldCtag;</span>
<a href="#l9.880"></a><span id="l9.880" class="difflineminus">-         this.mTargetCalendar.setMetaData(&quot;ctag&quot;, this.mCtag);</span>
<a href="#l9.881"></a><span id="l9.881" class="difflineminus">-         this.mOldCtag = null;</span>
<a href="#l9.882"></a><span id="l9.882" class="difflineminus">-</span>
<a href="#l9.883"></a><span id="l9.883">          // Notify changelog listener</span>
<a href="#l9.884"></a><span id="l9.884">          if (this.isCached &amp;&amp; aChangeLogListener) {</span>
<a href="#l9.885"></a><span id="l9.885">              aChangeLogListener.onResult({ status: Components.results.NS_ERROR_FAILURE },</span>
<a href="#l9.886"></a><span id="l9.886">                                          Components.results.NS_ERROR_FAILURE);</span>
<a href="#l9.887"></a><span id="l9.887">          }</span>
<a href="#l9.888"></a><span id="l9.888"> </span>
<a href="#l9.889"></a><span id="l9.889">          // Notify operation listener</span>
<a href="#l9.890"></a><span id="l9.890">          this.notifyOperationComplete(aListener,</span>
<a href="#l9.891"></a><span id="l9.891" class="difflineat">@@ -1078,39 +1210,39 @@ calDavCalendar.prototype = {</span>
<a href="#l9.892"></a><span id="l9.892">                                                null,</span>
<a href="#l9.893"></a><span id="l9.893">                                                aListener,</span>
<a href="#l9.894"></a><span id="l9.894">                                                aChangeLogListener);</span>
<a href="#l9.895"></a><span id="l9.895">         multiget.doMultiGet();</span>
<a href="#l9.896"></a><span id="l9.896">     },</span>
<a href="#l9.897"></a><span id="l9.897"> </span>
<a href="#l9.898"></a><span id="l9.898">     // void getItem( in string id, in calIOperationListener aListener );</span>
<a href="#l9.899"></a><span id="l9.899">     getItem: function caldav_getItem(aId, aListener) {</span>
<a href="#l9.900"></a><span id="l9.900" class="difflineminus">-        this.mTargetCalendar.getItem(aId, aListener);</span>
<a href="#l9.901"></a><span id="l9.901" class="difflineplus">+        this.mOfflineStorage.getItem(aId, aListener);</span>
<a href="#l9.902"></a><span id="l9.902">     },</span>
<a href="#l9.903"></a><span id="l9.903"> </span>
<a href="#l9.904"></a><span id="l9.904">     // void getItems( in unsigned long aItemFilter, in unsigned long aCount,</span>
<a href="#l9.905"></a><span id="l9.905">     //                in calIDateTime aRangeStart, in calIDateTime aRangeEnd,</span>
<a href="#l9.906"></a><span id="l9.906">     //                in calIOperationListener aListener );</span>
<a href="#l9.907"></a><span id="l9.907">     getItems: function caldav_getItems(aItemFilter, aCount, aRangeStart,</span>
<a href="#l9.908"></a><span id="l9.908">                                        aRangeEnd, aListener) {</span>
<a href="#l9.909"></a><span id="l9.909">         if (this.isCached) {</span>
<a href="#l9.910"></a><span id="l9.910" class="difflineminus">-            if (this.mTargetCalendar) {</span>
<a href="#l9.911"></a><span id="l9.911" class="difflineminus">-                this.mTargetCalendar.getItems.apply(this.mTargetCalendar, arguments);</span>
<a href="#l9.912"></a><span id="l9.912" class="difflineplus">+            if (this.mOfflineStorage) {</span>
<a href="#l9.913"></a><span id="l9.913" class="difflineplus">+                this.mOfflineStorage.getItems.apply(this.mOfflineStorage, arguments);</span>
<a href="#l9.914"></a><span id="l9.914">             } else {</span>
<a href="#l9.915"></a><span id="l9.915">                 this.notifyOperationComplete(aListener,</span>
<a href="#l9.916"></a><span id="l9.916">                                              Components.results.NS_OK,</span>
<a href="#l9.917"></a><span id="l9.917">                                              Components.interfaces.calIOperationListener.GET,</span>
<a href="#l9.918"></a><span id="l9.918">                                              null,</span>
<a href="#l9.919"></a><span id="l9.919">                                              null);</span>
<a href="#l9.920"></a><span id="l9.920">             }</span>
<a href="#l9.921"></a><span id="l9.921">         } else {</span>
<a href="#l9.922"></a><span id="l9.922">             if (!this.mCheckedServerInfo) {</span>
<a href="#l9.923"></a><span id="l9.923">                 this.mQueuedQueries.push(arguments);</span>
<a href="#l9.924"></a><span id="l9.924">             } else {</span>
<a href="#l9.925"></a><span id="l9.925" class="difflineminus">-                this.mTargetCalendar.getItems.apply(this.mTargetCalendar, arguments);</span>
<a href="#l9.926"></a><span id="l9.926" class="difflineplus">+                this.mOfflineStorage.getItems.apply(this.mOfflineStorage, arguments);</span>
<a href="#l9.927"></a><span id="l9.927">             }</span>
<a href="#l9.928"></a><span id="l9.928">         }</span>
<a href="#l9.929"></a><span id="l9.929">     },</span>
<a href="#l9.930"></a><span id="l9.930"> </span>
<a href="#l9.931"></a><span id="l9.931">     safeRefresh: function caldav_safeRefresh(aChangeLogListener) {</span>
<a href="#l9.932"></a><span id="l9.932">         this.ensureTargetCalendar();</span>
<a href="#l9.933"></a><span id="l9.933"> </span>
<a href="#l9.934"></a><span id="l9.934">         if (this.mAuthScheme == &quot;Digest&quot;) {</span>
<a href="#l9.935"></a><span id="l9.935" class="difflineat">@@ -1214,19 +1346,18 @@ calDavCalendar.prototype = {</span>
<a href="#l9.936"></a><span id="l9.936">                                                 Components.results.NS_OK);</span>
<a href="#l9.937"></a><span id="l9.937">                 }</span>
<a href="#l9.938"></a><span id="l9.938">                 return;</span>
<a href="#l9.939"></a><span id="l9.939">             }</span>
<a href="#l9.940"></a><span id="l9.940"> </span>
<a href="#l9.941"></a><span id="l9.941">             var ctag = multistatus..CS::getctag.toString();</span>
<a href="#l9.942"></a><span id="l9.942">             if (!ctag.length || ctag != thisCalendar.mCtag) {</span>
<a href="#l9.943"></a><span id="l9.943">                 // ctag mismatch, need to fetch calendar-data</span>
<a href="#l9.944"></a><span id="l9.944" class="difflineminus">-                thisCalendar.mOldCtag = thisCalendar.mCtag;</span>
<a href="#l9.945"></a><span id="l9.945">                 thisCalendar.mCtag = ctag;</span>
<a href="#l9.946"></a><span id="l9.946" class="difflineminus">-                thisCalendar.mTargetCalendar.setMetaData(&quot;ctag&quot;, ctag);</span>
<a href="#l9.947"></a><span id="l9.947" class="difflineplus">+                thisCalendar.saveCalendarProperties();</span>
<a href="#l9.948"></a><span id="l9.948">                 thisCalendar.getUpdatedItems(thisCalendar.calendarUri,</span>
<a href="#l9.949"></a><span id="l9.949">                                              aChangeLogListener);</span>
<a href="#l9.950"></a><span id="l9.950">                 if (thisCalendar.verboseLogging()) {</span>
<a href="#l9.951"></a><span id="l9.951">                     cal.LOG(&quot;CalDAV: ctag mismatch on refresh, fetching data for &quot; +</span>
<a href="#l9.952"></a><span id="l9.952">                             &quot;calendar &quot; + thisCalendar.name);</span>
<a href="#l9.953"></a><span id="l9.953"> </span>
<a href="#l9.954"></a><span id="l9.954">                 }</span>
<a href="#l9.955"></a><span id="l9.955">             } else {</span>
<a href="#l9.956"></a><span id="l9.956" class="difflineat">@@ -1245,23 +1376,17 @@ calDavCalendar.prototype = {</span>
<a href="#l9.957"></a><span id="l9.957">                     thisCalendar.pollInbox();</span>
<a href="#l9.958"></a><span id="l9.958">                 }</span>
<a href="#l9.959"></a><span id="l9.959">             }</span>
<a href="#l9.960"></a><span id="l9.960">         };</span>
<a href="#l9.961"></a><span id="l9.961">         cal.sendHttpRequest(cal.createStreamLoader(), httpchannel, streamListener);</span>
<a href="#l9.962"></a><span id="l9.962">     },</span>
<a href="#l9.963"></a><span id="l9.963"> </span>
<a href="#l9.964"></a><span id="l9.964">     refresh: function caldav_refresh() {</span>
<a href="#l9.965"></a><span id="l9.965" class="difflineminus">-        if (!this.mCheckedServerInfo) {</span>
<a href="#l9.966"></a><span id="l9.966" class="difflineminus">-            // If we haven't refreshed yet, then we should check the resource</span>
<a href="#l9.967"></a><span id="l9.967" class="difflineminus">-            // type first. This will call refresh() again afterwards.</span>
<a href="#l9.968"></a><span id="l9.968" class="difflineminus">-            this.checkDavResourceType(null);</span>
<a href="#l9.969"></a><span id="l9.969" class="difflineminus">-        } else {</span>
<a href="#l9.970"></a><span id="l9.970" class="difflineminus">-            this.safeRefresh();</span>
<a href="#l9.971"></a><span id="l9.971" class="difflineminus">-        }</span>
<a href="#l9.972"></a><span id="l9.972" class="difflineplus">+        this.replayChangesOn(null);</span>
<a href="#l9.973"></a><span id="l9.973">     },</span>
<a href="#l9.974"></a><span id="l9.974"> </span>
<a href="#l9.975"></a><span id="l9.975">     firstInRealm: function caldav_firstInRealm() {</span>
<a href="#l9.976"></a><span id="l9.976">         var calendars = getCalendarManager().getCalendars({});</span>
<a href="#l9.977"></a><span id="l9.977">         for (var i = 0; i &lt; calendars.length ; i++) {</span>
<a href="#l9.978"></a><span id="l9.978">             if (calendars[i].type != &quot;caldav&quot;) {</span>
<a href="#l9.979"></a><span id="l9.979">                 continue;</span>
<a href="#l9.980"></a><span id="l9.980">             }</span>
<a href="#l9.981"></a><span id="l9.981" class="difflineat">@@ -1450,32 +1575,31 @@ calDavCalendar.prototype = {</span>
<a href="#l9.982"></a><span id="l9.982">                 thisCalendar.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l9.983"></a><span id="l9.983">                                                      Components.interfaces.calIErrors.DAV_NOT_DAV);</span>
<a href="#l9.984"></a><span id="l9.984">                 return;</span>
<a href="#l9.985"></a><span id="l9.985">             }</span>
<a href="#l9.986"></a><span id="l9.986"> </span>
<a href="#l9.987"></a><span id="l9.987">             // check for webdav-sync capability</span>
<a href="#l9.988"></a><span id="l9.988">             // http://tools.ietf.org/html/draft-daboo-webdav-sync</span>
<a href="#l9.989"></a><span id="l9.989">             if (multistatus..D::[&quot;supported-report-set&quot;]..D::[&quot;sync-collection&quot;].length() &gt; 0) {</span>
<a href="#l9.990"></a><span id="l9.990" class="difflineminus">-                LOG(&quot;CalDAV: Collection has webdav sync support&quot;);</span>
<a href="#l9.991"></a><span id="l9.991" class="difflineplus">+                cal.LOG(&quot;CalDAV: Collection has webdav sync support&quot;);</span>
<a href="#l9.992"></a><span id="l9.992">                 thisCalendar.mHasWebdavSyncSupport = true;</span>
<a href="#l9.993"></a><span id="l9.993">             }</span>
<a href="#l9.994"></a><span id="l9.994"> </span>
<a href="#l9.995"></a><span id="l9.995">             // check for server-side ctag support only if webdav sync is not available</span>
<a href="#l9.996"></a><span id="l9.996">             var ctag = multistatus..CS::[&quot;getctag&quot;].toString();</span>
<a href="#l9.997"></a><span id="l9.997">             if (!thisCalendar.mHasWebdavSyncSupport &amp;&amp; ctag.length) {</span>
<a href="#l9.998"></a><span id="l9.998">                 // We compare the stored ctag with the one we just got, if</span>
<a href="#l9.999"></a><span id="l9.999">                 // they don't match, we update the items in safeRefresh.</span>
<a href="#l9.1000"></a><span id="l9.1000">                 if (ctag == thisCalendar.mCtag) {</span>
<a href="#l9.1001"></a><span id="l9.1001">                     thisCalendar.mFirstRefreshDone = true;</span>
<a href="#l9.1002"></a><span id="l9.1002">                 }</span>
<a href="#l9.1003"></a><span id="l9.1003"> </span>
<a href="#l9.1004"></a><span id="l9.1004">                 thisCalendar.mCtag = ctag;</span>
<a href="#l9.1005"></a><span id="l9.1005" class="difflineminus">-                thisCalendar.mOldCtag = null;</span>
<a href="#l9.1006"></a><span id="l9.1006" class="difflineminus">-                thisCalendar.mTargetCalendar.setMetaData(&quot;ctag&quot;, ctag);</span>
<a href="#l9.1007"></a><span id="l9.1007" class="difflineplus">+                thisCalendar.saveCalendarProperties();</span>
<a href="#l9.1008"></a><span id="l9.1008">                 if (thisCalendar.verboseLogging()) {</span>
<a href="#l9.1009"></a><span id="l9.1009">                     cal.LOG(&quot;CalDAV: initial ctag &quot; + ctag + &quot; for calendar &quot; +</span>
<a href="#l9.1010"></a><span id="l9.1010">                             thisCalendar.name);</span>
<a href="#l9.1011"></a><span id="l9.1011">                 }</span>
<a href="#l9.1012"></a><span id="l9.1012">             }</span>
<a href="#l9.1013"></a><span id="l9.1013"> </span>
<a href="#l9.1014"></a><span id="l9.1014">             supportedComponentsXml = multistatus..C::[&quot;supported-calendar-component-set&quot;];</span>
<a href="#l9.1015"></a><span id="l9.1015">             // use supported-calendar-component-set if the server supports it; some do not</span>
<a href="#l9.1016"></a><span id="l9.1016" class="difflineat">@@ -1902,16 +2026,17 @@ calDavCalendar.prototype = {</span>
<a href="#l9.1017"></a><span id="l9.1017">      * checkServerCaps</span>
<a href="#l9.1018"></a><span id="l9.1018">      * findPrincipalNS</span>
<a href="#l9.1019"></a><span id="l9.1019">      * checkPrincipalsNameSpace</span>
<a href="#l9.1020"></a><span id="l9.1020">      * completeCheckServerInfo                      * You are here</span>
<a href="#l9.1021"></a><span id="l9.1021">      */</span>
<a href="#l9.1022"></a><span id="l9.1022">     completeCheckServerInfo: function caldav_completeCheckServerInfo(aChangeLogListener, aError) {</span>
<a href="#l9.1023"></a><span id="l9.1023">         if (Components.isSuccessCode(aError)) {</span>
<a href="#l9.1024"></a><span id="l9.1024">             // &quot;undefined&quot; is a successcode, so all is good</span>
<a href="#l9.1025"></a><span id="l9.1025" class="difflineplus">+            this.saveCalendarProperties();</span>
<a href="#l9.1026"></a><span id="l9.1026">             this.mCheckedServerInfo = true;</span>
<a href="#l9.1027"></a><span id="l9.1027">             this.setProperty(&quot;currentStatus&quot;, Components.results.NS_OK);</span>
<a href="#l9.1028"></a><span id="l9.1028"> </span>
<a href="#l9.1029"></a><span id="l9.1029">             if (this.isCached) {</span>
<a href="#l9.1030"></a><span id="l9.1030">                 this.safeRefresh(aChangeLogListener);</span>
<a href="#l9.1031"></a><span id="l9.1031">             } else {</span>
<a href="#l9.1032"></a><span id="l9.1032">                 this.refresh();</span>
<a href="#l9.1033"></a><span id="l9.1033">             }</span>
<a href="#l9.1034"></a><span id="l9.1034" class="difflineat">@@ -2269,38 +2394,38 @@ calDavCalendar.prototype = {</span>
<a href="#l9.1035"></a><span id="l9.1035">                 var att = newItem.getAttendeeById(attendee.id);</span>
<a href="#l9.1036"></a><span id="l9.1036">                 if (att) {</span>
<a href="#l9.1037"></a><span id="l9.1037">                     newItem.removeAttendee(att);</span>
<a href="#l9.1038"></a><span id="l9.1038">                     att = att.clone();</span>
<a href="#l9.1039"></a><span id="l9.1039">                     att.participationStatus = attendee.participationStatus;</span>
<a href="#l9.1040"></a><span id="l9.1040">                     newItem.addAttendee(att);</span>
<a href="#l9.1041"></a><span id="l9.1041">                 }</span>
<a href="#l9.1042"></a><span id="l9.1042">             }</span>
<a href="#l9.1043"></a><span id="l9.1043" class="difflineminus">-            thisCalendar.doModifyItem(newItem, itemToUpdate.parentItem /* related to bug 396182 */,</span>
<a href="#l9.1044"></a><span id="l9.1044" class="difflineminus">-                                      modListener, true);</span>
<a href="#l9.1045"></a><span id="l9.1045" class="difflineplus">+            thisCalendar.doModifyItemOrUseCache(newItem, itemToUpdate.parentItem /* related to bug 396182 */,</span>
<a href="#l9.1046"></a><span id="l9.1046" class="difflineplus">+                                      true, modListener, true);</span>
<a href="#l9.1047"></a><span id="l9.1047">         };</span>
<a href="#l9.1048"></a><span id="l9.1048"> </span>
<a href="#l9.1049"></a><span id="l9.1049">         var modListener = {};</span>
<a href="#l9.1050"></a><span id="l9.1050">         modListener.onOperationComplete = function caldav_pIR_moOC(aCalendar,</span>
<a href="#l9.1051"></a><span id="l9.1051">                                                                    aStatus,</span>
<a href="#l9.1052"></a><span id="l9.1052">                                                                    aOperationType,</span>
<a href="#l9.1053"></a><span id="l9.1053">                                                                    aItemId,</span>
<a href="#l9.1054"></a><span id="l9.1054">                                                                    aDetail) {</span>
<a href="#l9.1055"></a><span id="l9.1055">             cal.LOG(&quot;CalDAV: status &quot; + aStatus + &quot; while processing iTIP REPLY &quot; +</span>
<a href="#l9.1056"></a><span id="l9.1056">                     &quot; for &quot; + thisCalendar.name);</span>
<a href="#l9.1057"></a><span id="l9.1057">             // don't delete the REPLY item from inbox unless modifying the master</span>
<a href="#l9.1058"></a><span id="l9.1058">             // item was successful</span>
<a href="#l9.1059"></a><span id="l9.1059">             if (aStatus == 0) { // aStatus undocumented; 0 seems to indicate no error</span>
<a href="#l9.1060"></a><span id="l9.1060">                 var delUri = thisCalendar.calendarUri.clone();</span>
<a href="#l9.1061"></a><span id="l9.1061">                 delUri.path = thisCalendar.ensureEncodedPath(aPath);</span>
<a href="#l9.1062"></a><span id="l9.1062" class="difflineminus">-                thisCalendar.doDeleteItem(aItem, null, true, true, delUri);</span>
<a href="#l9.1063"></a><span id="l9.1063" class="difflineplus">+                thisCalendar.doDeleteItemOrUseCache(aItem, true, null, true, true, delUri);</span>
<a href="#l9.1064"></a><span id="l9.1064">             }</span>
<a href="#l9.1065"></a><span id="l9.1065">         };</span>
<a href="#l9.1066"></a><span id="l9.1066"> </span>
<a href="#l9.1067"></a><span id="l9.1067" class="difflineminus">-        this.mTargetCalendar.getItem(aItem.id, getItemListener);</span>
<a href="#l9.1068"></a><span id="l9.1068" class="difflineplus">+        this.mOfflineStorage.getItem(aItem.id, getItemListener);</span>
<a href="#l9.1069"></a><span id="l9.1069">     },</span>
<a href="#l9.1070"></a><span id="l9.1070"> </span>
<a href="#l9.1071"></a><span id="l9.1071">     canNotify: function caldav_canNotify(aMethod, aItem) {</span>
<a href="#l9.1072"></a><span id="l9.1072">         if (this.hasAutoScheduling) {</span>
<a href="#l9.1073"></a><span id="l9.1073">             // canNotify should return false if the schedule agent is client</span>
<a href="#l9.1074"></a><span id="l9.1074">             // so the itip transport(imip) takes care of notifying participants</span>
<a href="#l9.1075"></a><span id="l9.1075">             if (aItem.organizer &amp;&amp;</span>
<a href="#l9.1076"></a><span id="l9.1076">                 aItem.organizer.getProperty(&quot;SCHEDULE-AGENT&quot;) == &quot;CLIENT&quot;) {</span>
<a href="#l9.1077"></a><span id="l9.1077" class="difflineat">@@ -2490,17 +2615,16 @@ calDavCalendar.prototype = {</span>
<a href="#l9.1078"></a><span id="l9.1078">                             uploadContent,</span>
<a href="#l9.1079"></a><span id="l9.1079">                             this,</span>
<a href="#l9.1080"></a><span id="l9.1080">                             aNewChannel);</span>
<a href="#l9.1081"></a><span id="l9.1081"> </span>
<a href="#l9.1082"></a><span id="l9.1082">         // Make sure we can get/set headers on both channels.</span>
<a href="#l9.1083"></a><span id="l9.1083">         aNewChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l9.1084"></a><span id="l9.1084">         aOldChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l9.1085"></a><span id="l9.1085"> </span>
<a href="#l9.1086"></a><span id="l9.1086" class="difflineminus">-</span>
<a href="#l9.1087"></a><span id="l9.1087">         function copyHeader(aHdr) {</span>
<a href="#l9.1088"></a><span id="l9.1088">             try {</span>
<a href="#l9.1089"></a><span id="l9.1089">                 let hdrValue = aOldChannel.getRequestHeader(aHdr);</span>
<a href="#l9.1090"></a><span id="l9.1090">                 if (hdrValue) {</span>
<a href="#l9.1091"></a><span id="l9.1091">                     aNewChannel.setRequestHeader(aHdr, hdrValue, false);</span>
<a href="#l9.1092"></a><span id="l9.1092">                 }</span>
<a href="#l9.1093"></a><span id="l9.1093">             } catch(e) {</span>
<a href="#l9.1094"></a><span id="l9.1094">                 if (e.code != Components.results.NS_ERROR_NOT_AVAILIBLE) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -130,17 +130,17 @@ etagsHandler.prototype = {</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5">         // Now that we are done, check which items need fetching.</span>
<a href="#l10.6"></a><span id="l10.6">         if (this.calendar.isCached) {</span>
<a href="#l10.7"></a><span id="l10.7">             this.calendar.superCalendar.startBatch();</span>
<a href="#l10.8"></a><span id="l10.8">         }</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10">         let needsRefresh = false;</span>
<a href="#l10.11"></a><span id="l10.11">         try {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-            for (let path in this.calendar.mPathIndex) {</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+            for (let path in this.calendar.mHrefIndex) {</span>
<a href="#l10.14"></a><span id="l10.14">                 if (path in this.itemsReported ||</span>
<a href="#l10.15"></a><span id="l10.15">                     path.substr(0, this.baseUri.length) == this.baseUri) {</span>
<a href="#l10.16"></a><span id="l10.16">                     // If the item is also on the server, check the next.</span>
<a href="#l10.17"></a><span id="l10.17">                     continue;</span>
<a href="#l10.18"></a><span id="l10.18">                 }</span>
<a href="#l10.19"></a><span id="l10.19">                 // If an item has been deleted from the server, delete it here too.</span>
<a href="#l10.20"></a><span id="l10.20">                 // Since the target calendar's operations are synchronous, we can</span>
<a href="#l10.21"></a><span id="l10.21">                 // safely set variables from this function.</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineat">@@ -152,25 +152,25 @@ etagsHandler.prototype = {</span>
<a href="#l10.23"></a><span id="l10.23">                                                                  aDetail,</span>
<a href="#l10.24"></a><span id="l10.24">                                                                  aCount,</span>
<a href="#l10.25"></a><span id="l10.25">                                                                  aItems) {</span>
<a href="#l10.26"></a><span id="l10.26">                         foundItem = aItems[0];</span>
<a href="#l10.27"></a><span id="l10.27">                     },</span>
<a href="#l10.28"></a><span id="l10.28">                     onOperationComplete: function etags_getItem_onOperationComplete() {}</span>
<a href="#l10.29"></a><span id="l10.29">                 };</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-                this.calendar.mTargetCalendar.getItem(this.calendar.mPathIndex[path],</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+                this.calendar.mOfflineStorage.getItem(this.calendar.mHrefIndex[path],</span>
<a href="#l10.33"></a><span id="l10.33">                                                       getItemListener);</span>
<a href="#l10.34"></a><span id="l10.34">                 if (foundItem) {</span>
<a href="#l10.35"></a><span id="l10.35">                     let wasInboxItem = this.calendar.mItemInfoCache[foundItem.id].isInboxItem;</span>
<a href="#l10.36"></a><span id="l10.36">                     if ((wasInboxItem &amp;&amp; this.calendar.isInbox(this.baseUri.spec)) ||</span>
<a href="#l10.37"></a><span id="l10.37">                         (wasInboxItem === false &amp;&amp; !this.calendar.isInbox(this.baseUri.spec))) {</span>
<a href="#l10.38"></a><span id="l10.38">                         cal.LOG(&quot;Deleting local href: &quot; + path)</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-                        delete this.calendar.mPathIndex[path];</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-                        this.calendar.mTargetCalendar.deleteItem(foundItem, null);</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+                        delete this.calendar.mHrefIndex[path];</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+                        this.calendar.mOfflineStorage.deleteItem(foundItem, null);</span>
<a href="#l10.43"></a><span id="l10.43">                         needsRefresh = true;</span>
<a href="#l10.44"></a><span id="l10.44">                     }</span>
<a href="#l10.45"></a><span id="l10.45">                 }</span>
<a href="#l10.46"></a><span id="l10.46">             }</span>
<a href="#l10.47"></a><span id="l10.47">         } finally {</span>
<a href="#l10.48"></a><span id="l10.48">             if (this.calendar.isCached) {</span>
<a href="#l10.49"></a><span id="l10.49">                 this.calendar.superCalendar.endBatch();</span>
<a href="#l10.50"></a><span id="l10.50">             }</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineat">@@ -282,17 +282,17 @@ etagsHandler.prototype = {</span>
<a href="#l10.52"></a><span id="l10.52">                         r.getcontenttype = &quot;text/calendar&quot;;</span>
<a href="#l10.53"></a><span id="l10.53">                     }</span>
<a href="#l10.54"></a><span id="l10.54"> </span>
<a href="#l10.55"></a><span id="l10.55">                     // Only handle calendar items</span>
<a href="#l10.56"></a><span id="l10.56">                     if (r.getcontenttype.substr(0,13) == &quot;text/calendar&quot;) {</span>
<a href="#l10.57"></a><span id="l10.57">                         if (r.href &amp;&amp; r.href.length) {</span>
<a href="#l10.58"></a><span id="l10.58">                             this.itemsReported[r.href] = r.getetag;</span>
<a href="#l10.59"></a><span id="l10.59"> </span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-                            let itemUid = this.calendar.mPathIndex[r.href];</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+                            let itemUid = this.calendar.mHrefIndex[r.href];</span>
<a href="#l10.62"></a><span id="l10.62">                             if (!itemUid ||</span>
<a href="#l10.63"></a><span id="l10.63">                                 r.getetag != this.calendar.mItemInfoCache[itemUid].etag) {</span>
<a href="#l10.64"></a><span id="l10.64">                                 this.itemsNeedFetching.push(r.href);</span>
<a href="#l10.65"></a><span id="l10.65">                             }</span>
<a href="#l10.66"></a><span id="l10.66">                         }</span>
<a href="#l10.67"></a><span id="l10.67">                     }</span>
<a href="#l10.68"></a><span id="l10.68">                 }</span>
<a href="#l10.69"></a><span id="l10.69">                 break;</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineat">@@ -422,18 +422,18 @@ webDavSyncHandler.prototype = {</span>
<a href="#l10.71"></a><span id="l10.71">         }</span>
<a href="#l10.72"></a><span id="l10.72">         // Invalidate sync token with 4xx errors that could indicate the</span>
<a href="#l10.73"></a><span id="l10.73">         // sync token has become invalid and do a refresh</span>
<a href="#l10.74"></a><span id="l10.74">         else if (this.calendar.mWebdavSyncToken != null &amp;&amp;</span>
<a href="#l10.75"></a><span id="l10.75">                  responseStatus &gt;= 400 &amp;&amp;</span>
<a href="#l10.76"></a><span id="l10.76">                  responseStatus &lt;= 499) {</span>
<a href="#l10.77"></a><span id="l10.77">             cal.LOG(&quot;CalDAV: Reseting sync token because server returned status code: &quot; + responseStatus);</span>
<a href="#l10.78"></a><span id="l10.78">             this._reader = null;</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-            this.calendar.mWebdavSyncToken=null;</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-            this.calendar.mTargetCalendar.deleteMetaData(&quot;webdav-sync-token&quot;);</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+            this.calendar.mWebdavSyncToken = null;</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+            this.calendar.saveCalendarProperties();</span>
<a href="#l10.83"></a><span id="l10.83">             this.calendar.safeRefresh(this.changeLogListener);</span>
<a href="#l10.84"></a><span id="l10.84">         } else {</span>
<a href="#l10.85"></a><span id="l10.85">             cal.WARN(&quot;CalDAV: Error doing webdav sync: &quot; + responseStatus);</span>
<a href="#l10.86"></a><span id="l10.86">             this.calendar.reportDavError(Components.interfaces.calIErrors.DAV_REPORT_ERROR);</span>
<a href="#l10.87"></a><span id="l10.87">             if (this.calendar.isCached &amp;&amp; this.changeLogListener) {</span>
<a href="#l10.88"></a><span id="l10.88">                 this.changeLogListener.onResult({ status: Components.results.NS_ERROR_FAILURE },</span>
<a href="#l10.89"></a><span id="l10.89">                                                 Components.results.NS_ERROR_FAILURE);</span>
<a href="#l10.90"></a><span id="l10.90">             }</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineat">@@ -500,31 +500,30 @@ webDavSyncHandler.prototype = {</span>
<a href="#l10.92"></a><span id="l10.92">             }</span>
<a href="#l10.93"></a><span id="l10.93">             return;</span>
<a href="#l10.94"></a><span id="l10.94">         }</span>
<a href="#l10.95"></a><span id="l10.95"> </span>
<a href="#l10.96"></a><span id="l10.96">         if (this.calendar.mWebdavSyncToken == null) {</span>
<a href="#l10.97"></a><span id="l10.97">             // null token means reset or first refresh indicating we did</span>
<a href="#l10.98"></a><span id="l10.98">             // a full sync; remove local items that were not returned in this full</span>
<a href="#l10.99"></a><span id="l10.99">             // sync</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-            for (let path in this.calendar.mPathIndex) {</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+            for (let path in this.calendar.mHrefIndex) {</span>
<a href="#l10.102"></a><span id="l10.102">                 if (!this.itemsReported[path]) {</span>
<a href="#l10.103"></a><span id="l10.103">                     this.calendar.deleteTargetCalendarItem(path);</span>
<a href="#l10.104"></a><span id="l10.104">                 }</span>
<a href="#l10.105"></a><span id="l10.105">             }</span>
<a href="#l10.106"></a><span id="l10.106">         }</span>
<a href="#l10.107"></a><span id="l10.107">         if (this.calendar.isCached) {</span>
<a href="#l10.108"></a><span id="l10.108">             this.calendar.superCalendar.endBatch();</span>
<a href="#l10.109"></a><span id="l10.109">         }</span>
<a href="#l10.110"></a><span id="l10.110"> </span>
<a href="#l10.111"></a><span id="l10.111">         if (!this.itemsNeedFetching.length) {</span>
<a href="#l10.112"></a><span id="l10.112">             if (this.newSyncToken) {</span>
<a href="#l10.113"></a><span id="l10.113">                 this.calendar.mWebdavSyncToken = this.newSyncToken;</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineminus">-                this.calendar.mTargetCalendar.setMetaData(&quot;webdav-sync-token&quot;,</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineminus">-                                                          this.newSyncToken);</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+                this.calendar.saveCalendarProperties();</span>
<a href="#l10.117"></a><span id="l10.117">                 cal.LOG(&quot;CalDAV: New webdav-sync Token: &quot; + this.calendar.mWebdavSyncToken);</span>
<a href="#l10.118"></a><span id="l10.118">             }</span>
<a href="#l10.119"></a><span id="l10.119">             this.calendar.finalizeUpdatedItems(this.changeLogListener,</span>
<a href="#l10.120"></a><span id="l10.120">                                                this.baseUri);</span>
<a href="#l10.121"></a><span id="l10.121">         } else {</span>
<a href="#l10.122"></a><span id="l10.122">             let multiget = new multigetSyncHandler(this.itemsNeedFetching,</span>
<a href="#l10.123"></a><span id="l10.123">                                                    this.calendar,</span>
<a href="#l10.124"></a><span id="l10.124">                                                    this.baseUri,</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineat">@@ -578,34 +577,34 @@ webDavSyncHandler.prototype = {</span>
<a href="#l10.126"></a><span id="l10.126">                     r.href.length) {</span>
<a href="#l10.127"></a><span id="l10.127">                     r.href = this.calendar.ensureDecodedPath(r.href);</span>
<a href="#l10.128"></a><span id="l10.128">                 }</span>
<a href="#l10.129"></a><span id="l10.129">                 // Deleted item</span>
<a href="#l10.130"></a><span id="l10.130">                 if (r.href &amp;&amp; r.href.length &amp;&amp;</span>
<a href="#l10.131"></a><span id="l10.131">                     r.status &amp;&amp;</span>
<a href="#l10.132"></a><span id="l10.132">                     r.status.length &amp;&amp;</span>
<a href="#l10.133"></a><span id="l10.133">                     r.status.indexOf(&quot; 404&quot;) &gt; 0) {</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-                    if (this.calendar.mPathIndex[r.href]) {</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+                    if (this.calendar.mHrefIndex[r.href]) {</span>
<a href="#l10.136"></a><span id="l10.136">                         this.changeCount++;</span>
<a href="#l10.137"></a><span id="l10.137">                         this.calendar.deleteTargetCalendarItem(r.href);</span>
<a href="#l10.138"></a><span id="l10.138">                     }</span>
<a href="#l10.139"></a><span id="l10.139">                     else {</span>
<a href="#l10.140"></a><span id="l10.140">                         cal.LOG(&quot;CalDAV: skipping unfound deleted item : &quot; + r.href);</span>
<a href="#l10.141"></a><span id="l10.141">                     }</span>
<a href="#l10.142"></a><span id="l10.142">                 // Only handle Created or Updated calendar items</span>
<a href="#l10.143"></a><span id="l10.143">                 } else if (r.getcontenttype &amp;&amp;</span>
<a href="#l10.144"></a><span id="l10.144">                            r.getcontenttype.substr(0,13) == &quot;text/calendar&quot; &amp;&amp;</span>
<a href="#l10.145"></a><span id="l10.145">                            r.getetag &amp;&amp; r.getetag.length &amp;&amp;</span>
<a href="#l10.146"></a><span id="l10.146">                            r.href &amp;&amp; r.href.length &amp;&amp;</span>
<a href="#l10.147"></a><span id="l10.147">                            (!r.status ||                 // Draft 3 does not require</span>
<a href="#l10.148"></a><span id="l10.148">                             r.status.length == 0 ||      // a status for created or updated items but</span>
<a href="#l10.149"></a><span id="l10.149">                             r.status.indexOf(&quot; 204&quot;) ||  // draft 0, 1 and 2 needed it so treat no status</span>
<a href="#l10.150"></a><span id="l10.150">                             r.status.indexOf(&quot; 201&quot;))) { // and status 201 and 204 the same</span>
<a href="#l10.151"></a><span id="l10.151">                     this.itemsReported[r.href] = r.getetag;</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineminus">-                    let itemId = this.calendar.mPathIndex[r.href];</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+                    let itemId = this.calendar.mHrefIndex[r.href];</span>
<a href="#l10.154"></a><span id="l10.154">                     let oldEtag = (itemId &amp;&amp; this.calendar.mItemInfoCache[itemId].etag);</span>
<a href="#l10.155"></a><span id="l10.155"> </span>
<a href="#l10.156"></a><span id="l10.156">                     if (!oldEtag || oldEtag != r.getetag) {</span>
<a href="#l10.157"></a><span id="l10.157">                         // Etag mismatch, getting new/updated item.</span>
<a href="#l10.158"></a><span id="l10.158">                         this.itemsNeedFetching.push(r.href);</span>
<a href="#l10.159"></a><span id="l10.159">                     }</span>
<a href="#l10.160"></a><span id="l10.160">                 // If the response element is still not handled, log an error</span>
<a href="#l10.161"></a><span id="l10.161">                 // only if the content-type is text/calendar or the</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineat">@@ -765,17 +764,17 @@ multigetSyncHandler.prototype = {</span>
<a href="#l10.163"></a><span id="l10.163">         if (this.unhandledErrors) {</span>
<a href="#l10.164"></a><span id="l10.164">             this.calendar.superCalendar.endBatch();</span>
<a href="#l10.165"></a><span id="l10.165">             this.calendar.notifyGetFailed(&quot;multiget error&quot;, this.listener, this.changeLogListener);</span>
<a href="#l10.166"></a><span id="l10.166">             return;</span>
<a href="#l10.167"></a><span id="l10.167">         }</span>
<a href="#l10.168"></a><span id="l10.168">         if (this.itemsNeedFetching.length == 0) {</span>
<a href="#l10.169"></a><span id="l10.169">             if (this.newSyncToken) {</span>
<a href="#l10.170"></a><span id="l10.170">                 this.calendar.mWebdavSyncToken = this.newSyncToken;</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineminus">-                this.calendar.mTargetCalendar.setMetaData(&quot;webdav-sync-token&quot;, this.newSyncToken);</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+                this.calendar.saveCalendarProperties();</span>
<a href="#l10.173"></a><span id="l10.173">               cal.LOG(&quot;CalDAV: New webdav-sync Token: &quot; + this.calendar.mWebdavSyncToken);</span>
<a href="#l10.174"></a><span id="l10.174">             }</span>
<a href="#l10.175"></a><span id="l10.175"> </span>
<a href="#l10.176"></a><span id="l10.176">             this.calendar.finalizeUpdatedItems(this.changeLogListener,</span>
<a href="#l10.177"></a><span id="l10.177">                                                this.baseUri);</span>
<a href="#l10.178"></a><span id="l10.178">         }</span>
<a href="#l10.179"></a><span id="l10.179">         if (!this._reader) {</span>
<a href="#l10.180"></a><span id="l10.180">             // No reader means there was a request error. The error is already</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineat">@@ -889,28 +888,28 @@ multigetSyncHandler.prototype = {</span>
<a href="#l10.182"></a><span id="l10.182">                 if (r.href &amp;&amp;</span>
<a href="#l10.183"></a><span id="l10.183">                     r.href.length) {</span>
<a href="#l10.184"></a><span id="l10.184">                     r.href = this.calendar.ensureDecodedPath(r.href);</span>
<a href="#l10.185"></a><span id="l10.185">                 }</span>
<a href="#l10.186"></a><span id="l10.186">                 if (r.href &amp;&amp; r.href.length &amp;&amp;</span>
<a href="#l10.187"></a><span id="l10.187">                     r.status &amp;&amp;</span>
<a href="#l10.188"></a><span id="l10.188">                     r.status.length &amp;&amp;</span>
<a href="#l10.189"></a><span id="l10.189">                     r.status.indexOf(&quot; 404&quot;) &gt; 0) {</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineminus">-                    if (this.calendar.mPathIndex[r.href]) {</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineplus">+                    if (this.calendar.mHrefIndex[r.href]) {</span>
<a href="#l10.192"></a><span id="l10.192">                         this.changeCount++;</span>
<a href="#l10.193"></a><span id="l10.193">                         this.calendar.deleteTargetCalendarItem(r.href);</span>
<a href="#l10.194"></a><span id="l10.194">                     } else {</span>
<a href="#l10.195"></a><span id="l10.195">                         cal.LOG(&quot;CalDAV: skipping unfound deleted item : &quot; + r.href);</span>
<a href="#l10.196"></a><span id="l10.196">                     }</span>
<a href="#l10.197"></a><span id="l10.197">                 // Created or Updated item</span>
<a href="#l10.198"></a><span id="l10.198">                 } else if (r.getetag &amp;&amp; r.getetag.length &amp;&amp;</span>
<a href="#l10.199"></a><span id="l10.199">                            r.href &amp;&amp; r.href.length &amp;&amp;</span>
<a href="#l10.200"></a><span id="l10.200">                            r.calendardata &amp;&amp; r.calendardata.length) {</span>
<a href="#l10.201"></a><span id="l10.201">                     let oldEtag;</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineminus">-                    let itemId = this.calendar.mPathIndex[r.href];</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+                    let itemId = this.calendar.mHrefIndex[r.href];</span>
<a href="#l10.204"></a><span id="l10.204">                     if (itemId) {</span>
<a href="#l10.205"></a><span id="l10.205">                         oldEtag = this.calendar.mItemInfoCache[itemId].etag;</span>
<a href="#l10.206"></a><span id="l10.206">                     } else {</span>
<a href="#l10.207"></a><span id="l10.207">                         oldEtag = null;</span>
<a href="#l10.208"></a><span id="l10.208">                     }</span>
<a href="#l10.209"></a><span id="l10.209">                     if (!oldEtag || oldEtag != r.getetag) {</span>
<a href="#l10.210"></a><span id="l10.210">                         this.changeCount++;</span>
<a href="#l10.211"></a><span id="l10.211">                         this.calendar.addTargetCalendarItem(r.href,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -242,16 +242,19 @@ calICSCalendar.prototype = {</span>
<a href="#l11.4"></a><span id="l11.4">         } else {</span>
<a href="#l11.5"></a><span id="l11.5">             // Failure may be due to temporary connection issue, keep old data to</span>
<a href="#l11.6"></a><span id="l11.6">             // prevent potential data loss if it becomes available again.</span>
<a href="#l11.7"></a><span id="l11.7">             cal.LOG(&quot;[calICSCalendar] Unable to load stream - status: &quot; + status);</span>
<a href="#l11.8"></a><span id="l11.8">         }</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10">         if (!cont) {</span>
<a href="#l11.11"></a><span id="l11.11">             // no need to process further, we can use the previous data</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+            // HACK Sorry, but offline support requires the items to be signaled</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+            // even if nothing has changed (especially at startup)</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+            this.mObserver.onLoad(this);</span>
<a href="#l11.15"></a><span id="l11.15">             this.unlock();</span>
<a href="#l11.16"></a><span id="l11.16">             return;</span>
<a href="#l11.17"></a><span id="l11.17">         }</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19">          // Clear any existing events if there was no result</span>
<a href="#l11.20"></a><span id="l11.20">         if (!resultLength) {</span>
<a href="#l11.21"></a><span id="l11.21">             this.createMemoryCalendar();</span>
<a href="#l11.22"></a><span id="l11.22">             this.mMemoryCalendar.addObserver(this.mObserver);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -44,32 +44,34 @@ Components.utils.import(&quot;resource://cale</span>
<a href="#l12.4"></a><span id="l12.4"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> //</span>
<a href="#l12.7"></a><span id="l12.7"> // calMemoryCalendar.js</span>
<a href="#l12.8"></a><span id="l12.8"> //</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10"> const calCalendarManagerContractID = &quot;@mozilla.org/calendar/manager;1&quot;;</span>
<a href="#l12.11"></a><span id="l12.11"> const calICalendarManager = Components.interfaces.calICalendarManager;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+const cICL = Components.interfaces.calIChangeLog;</span>
<a href="#l12.13"></a><span id="l12.13"> </span>
<a href="#l12.14"></a><span id="l12.14"> function calMemoryCalendar() {</span>
<a href="#l12.15"></a><span id="l12.15">     this.initProviderBase();</span>
<a href="#l12.16"></a><span id="l12.16">     this.initMemoryCalendar();</span>
<a href="#l12.17"></a><span id="l12.17"> }</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19"> calMemoryCalendar.prototype = {</span>
<a href="#l12.20"></a><span id="l12.20">     __proto__: cal.ProviderBase.prototype,</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22">     classID: Components.ID(&quot;{bda0dd7f-0a2f-4fcf-ba08-5517e6fbf133}&quot;),</span>
<a href="#l12.23"></a><span id="l12.23">     contractID: &quot;@mozilla.org/calendar/calendar;1?type=memory&quot;,</span>
<a href="#l12.24"></a><span id="l12.24">     classDescription: &quot;Calendar Memory Provider&quot;,</span>
<a href="#l12.25"></a><span id="l12.25"> </span>
<a href="#l12.26"></a><span id="l12.26">     getInterfaces: function getInterfaces(count) {</span>
<a href="#l12.27"></a><span id="l12.27">         const ifaces = [Components.interfaces.calICalendar,</span>
<a href="#l12.28"></a><span id="l12.28">                         Components.interfaces.calISchedulingSupport,</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+                        Components.interfaces.calIOfflineStorage,</span>
<a href="#l12.30"></a><span id="l12.30">                         Components.interfaces.calISyncWriteCalendar,</span>
<a href="#l12.31"></a><span id="l12.31">                         Components.interfaces.calICalendarProvider,</span>
<a href="#l12.32"></a><span id="l12.32">                         Components.interfaces.nsIClassInfo,</span>
<a href="#l12.33"></a><span id="l12.33">                         Components.interfaces.nsISupports];</span>
<a href="#l12.34"></a><span id="l12.34">         count.value = ifaces.length;</span>
<a href="#l12.35"></a><span id="l12.35">         return ifaces;</span>
<a href="#l12.36"></a><span id="l12.36">     },</span>
<a href="#l12.37"></a><span id="l12.37">     getHelperForLanguage: function getHelperForLanguage(language) {</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineat">@@ -80,19 +82,25 @@ calMemoryCalendar.prototype = {</span>
<a href="#l12.39"></a><span id="l12.39"> </span>
<a href="#l12.40"></a><span id="l12.40">     //</span>
<a href="#l12.41"></a><span id="l12.41">     // nsISupports interface</span>
<a href="#l12.42"></a><span id="l12.42">     // </span>
<a href="#l12.43"></a><span id="l12.43">     QueryInterface: function (aIID) {</span>
<a href="#l12.44"></a><span id="l12.44">         return cal.doQueryInterface(this, calMemoryCalendar.prototype, aIID, null, this);</span>
<a href="#l12.45"></a><span id="l12.45">     },</span>
<a href="#l12.46"></a><span id="l12.46"> </span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+    mItems: null,</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+    mOfflineFlags: null,</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+    mObservers: null,</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+    mMetaData: null,</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+</span>
<a href="#l12.52"></a><span id="l12.52">     initMemoryCalendar: function() {</span>
<a href="#l12.53"></a><span id="l12.53">         this.mObservers = new cal.ObserverBag(Components.interfaces.calIObserver);</span>
<a href="#l12.54"></a><span id="l12.54">         this.mItems = {};</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+        this.mOfflineFlags = {};</span>
<a href="#l12.56"></a><span id="l12.56">         this.mMetaData = new cal.calPropertyBag();</span>
<a href="#l12.57"></a><span id="l12.57">     },</span>
<a href="#l12.58"></a><span id="l12.58"> </span>
<a href="#l12.59"></a><span id="l12.59">     //</span>
<a href="#l12.60"></a><span id="l12.60">     // calICalendarProvider interface</span>
<a href="#l12.61"></a><span id="l12.61">     //</span>
<a href="#l12.62"></a><span id="l12.62">     get prefChromeOverlay() {</span>
<a href="#l12.63"></a><span id="l12.63">         return null;</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineat">@@ -157,29 +165,33 @@ calMemoryCalendar.prototype = {</span>
<a href="#l12.65"></a><span id="l12.65">             this.notifyOperationComplete(aListener,</span>
<a href="#l12.66"></a><span id="l12.66">                                          Components.results.NS_ERROR_FAILURE,</span>
<a href="#l12.67"></a><span id="l12.67">                                          Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l12.68"></a><span id="l12.68">                                          aItem.id,</span>
<a href="#l12.69"></a><span id="l12.69">                                          &quot;Can't set ID on non-mutable item to addItem&quot;);</span>
<a href="#l12.70"></a><span id="l12.70">             return;</span>
<a href="#l12.71"></a><span id="l12.71">         }</span>
<a href="#l12.72"></a><span id="l12.72"> </span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-        if (this.mItems[aItem.id] != null) {</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+        //Lines below are commented because of the offline bug 380060</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+        //Memory Calendar cannot assume that a new item should not have an ID.</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+        //calCachedCalendar could send over an item with an id.</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+        /*if (this.mItems[aItem.id] != null) {</span>
<a href="#l12.79"></a><span id="l12.79">             if (this.relaxedMode) {</span>
<a href="#l12.80"></a><span id="l12.80">                 // we possibly want to interact with the user before deleting</span>
<a href="#l12.81"></a><span id="l12.81">                 delete this.mItems[aItem.id];</span>
<a href="#l12.82"></a><span id="l12.82">             } else {</span>
<a href="#l12.83"></a><span id="l12.83">                 this.notifyOperationComplete(aListener,</span>
<a href="#l12.84"></a><span id="l12.84">                                              Components.interfaces.calIErrors.DUPLICATE_ID,</span>
<a href="#l12.85"></a><span id="l12.85">                                              Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l12.86"></a><span id="l12.86">                                              aItem.id,</span>
<a href="#l12.87"></a><span id="l12.87">                                              &quot;ID already exists for addItem&quot;);</span>
<a href="#l12.88"></a><span id="l12.88">                 return;</span>
<a href="#l12.89"></a><span id="l12.89">             }</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-        }</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+        }*/</span>
<a href="#l12.92"></a><span id="l12.92"> </span>
<a href="#l12.93"></a><span id="l12.93">         let parentItem = aItem.parentItem;</span>
<a href="#l12.94"></a><span id="l12.94">         if (parentItem != aItem) {</span>
<a href="#l12.95"></a><span id="l12.95">             parentItem = parentItem.clone();</span>
<a href="#l12.96"></a><span id="l12.96">             parentItem.recurrenceInfo.modifyException(aItem, true);</span>
<a href="#l12.97"></a><span id="l12.97">         }</span>
<a href="#l12.98"></a><span id="l12.98">         parentItem.calendar = this.superCalendar;</span>
<a href="#l12.99"></a><span id="l12.99"> </span>
<a href="#l12.100"></a><span id="l12.100" class="difflineat">@@ -219,39 +231,50 @@ calMemoryCalendar.prototype = {</span>
<a href="#l12.101"></a><span id="l12.101">             return reportError(null, &quot;ID for modifyItem item is null&quot;);</span>
<a href="#l12.102"></a><span id="l12.102">         }</span>
<a href="#l12.103"></a><span id="l12.103"> </span>
<a href="#l12.104"></a><span id="l12.104">         var modifiedItem = aNewItem.parentItem.clone();</span>
<a href="#l12.105"></a><span id="l12.105">         if (aNewItem.parentItem != aNewItem) {</span>
<a href="#l12.106"></a><span id="l12.106">             modifiedItem.recurrenceInfo.modifyException(aNewItem, false);</span>
<a href="#l12.107"></a><span id="l12.107">         }</span>
<a href="#l12.108"></a><span id="l12.108"> </span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+        // If no old item was passed, then we should overwrite in any case.</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+        // Pick up the old item from our items array and use this as an old item</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+        // later on.</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+        if (!aOldItem) {</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+            aOldItem = this.mItems[aNewItem.id];</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+        }</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+</span>
<a href="#l12.116"></a><span id="l12.116">         if (this.relaxedMode) {</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+            // We've already filled in the old item above, if this doesn't exist</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+            // then just take the current item as its old version</span>
<a href="#l12.119"></a><span id="l12.119">             if (!aOldItem) {</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineminus">-                aOldItem = (this.mItems[aNewItem.id] || modifiedItem);</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+                aOldItem = modifiedItem;</span>
<a href="#l12.122"></a><span id="l12.122">             }</span>
<a href="#l12.123"></a><span id="l12.123">             aOldItem = aOldItem.parentItem;</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-        } else {</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+        } else if (!this.relaxedMode) {</span>
<a href="#l12.126"></a><span id="l12.126">             if (!aOldItem || !this.mItems[aNewItem.id]) {</span>
<a href="#l12.127"></a><span id="l12.127">                 // no old item found?  should be using addItem, then.</span>
<a href="#l12.128"></a><span id="l12.128">                 return reportError(&quot;ID for modifyItem doesn't exist, is null, or is from different calendar&quot;);</span>
<a href="#l12.129"></a><span id="l12.129">             }</span>
<a href="#l12.130"></a><span id="l12.130"> </span>
<a href="#l12.131"></a><span id="l12.131">             // do the old and new items match?</span>
<a href="#l12.132"></a><span id="l12.132">             if (aOldItem.id != modifiedItem.id) {</span>
<a href="#l12.133"></a><span id="l12.133">                 return reportError(&quot;item ID mismatch between old and new items&quot;);</span>
<a href="#l12.134"></a><span id="l12.134">             }</span>
<a href="#l12.135"></a><span id="l12.135"> </span>
<a href="#l12.136"></a><span id="l12.136">             aOldItem = aOldItem.parentItem;</span>
<a href="#l12.137"></a><span id="l12.137">             var storedOldItem = this.mItems[aOldItem.id];</span>
<a href="#l12.138"></a><span id="l12.138"> </span>
<a href="#l12.139"></a><span id="l12.139">             // compareItems is not suitable here. See bug 418805.</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+            // Cannot compare here due to bug 380060</span>
<a href="#l12.141"></a><span id="l12.141">             if (!cal.compareItemContent(storedOldItem, aOldItem)) {</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineminus">-                return reportError(&quot;old item mismatch in modifyItem&quot;);</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+                return reportError(&quot;old item mismatch in modifyItem&quot; + &quot; storedId:&quot; + storedOldItem.icalComponent + &quot; old item:&quot; + aOldItem.icalComponent);</span>
<a href="#l12.144"></a><span id="l12.144">             }</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+           // offline bug</span>
<a href="#l12.146"></a><span id="l12.146"> </span>
<a href="#l12.147"></a><span id="l12.147">             if (aOldItem.generation != storedOldItem.generation) {</span>
<a href="#l12.148"></a><span id="l12.148">                 return reportError(&quot;generation mismatch in modifyItem&quot;);</span>
<a href="#l12.149"></a><span id="l12.149">             }</span>
<a href="#l12.150"></a><span id="l12.150"> </span>
<a href="#l12.151"></a><span id="l12.151">             if (aOldItem.generation == modifiedItem.generation) { // has been cloned and modified</span>
<a href="#l12.152"></a><span id="l12.152">                 // Only take care of incrementing the generation if relaxed mode is</span>
<a href="#l12.153"></a><span id="l12.153">                 // off. Users of relaxed mode need to take care of this themselves.</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineat">@@ -435,27 +458,43 @@ calMemoryCalendar.prototype = {</span>
<a href="#l12.155"></a><span id="l12.155">             } else if (wantTodos) {</span>
<a href="#l12.156"></a><span id="l12.156">                 typeIID = Components.interfaces.calITodo;</span>
<a href="#l12.157"></a><span id="l12.157">             }</span>
<a href="#l12.158"></a><span id="l12.158">         }</span>
<a href="#l12.159"></a><span id="l12.159"> </span>
<a href="#l12.160"></a><span id="l12.160">         aRangeStart = cal.ensureDateTime(aRangeStart);</span>
<a href="#l12.161"></a><span id="l12.161">         aRangeEnd = cal.ensureDateTime(aRangeEnd);</span>
<a href="#l12.162"></a><span id="l12.162"> </span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+        let offline_filter = aItemFilter &amp;</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+            (calICalendar.ITEM_FILTER_OFFLINE_DELETED |</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+             calICalendar.ITEM_FILTER_OFFLINE_CREATED |</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+             calICalendar.ITEM_FILTER_OFFLINE_MODIFIED);</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+</span>
<a href="#l12.169"></a><span id="l12.169">         for (let itemIndex in this.mItems) {</span>
<a href="#l12.170"></a><span id="l12.170">             let item = this.mItems[itemIndex];</span>
<a href="#l12.171"></a><span id="l12.171">             let isEvent_ = cal.isEvent(item);</span>
<a href="#l12.172"></a><span id="l12.172">             if (isEvent_) {</span>
<a href="#l12.173"></a><span id="l12.173">                 if (!wantEvents) {</span>
<a href="#l12.174"></a><span id="l12.174">                     continue;</span>
<a href="#l12.175"></a><span id="l12.175">                 }</span>
<a href="#l12.176"></a><span id="l12.176">             } else if (!wantTodos) {</span>
<a href="#l12.177"></a><span id="l12.177">                 continue;</span>
<a href="#l12.178"></a><span id="l12.178">             }</span>
<a href="#l12.179"></a><span id="l12.179"> </span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+            let hasItemFlag = (item.id in this.mOfflineFlags);</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+            let offlineFlag = (hasItemFlag ? this.mOfflineFlags[item.id] : null);</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+            // If the offline flag doesn't match, skip the item</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+            if ((hasItemFlag ||</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+                    (offline_filter != 0 &amp;&amp; offlineFlag == cICL.OFFLINE_FLAG_DELETED_RECORD)) &amp;&amp;</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+                (offlineFlag != offline_filter)) {</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+                continue;</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+            }</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+</span>
<a href="#l12.190"></a><span id="l12.190">             if (itemReturnOccurrences &amp;&amp; item.recurrenceInfo) {</span>
<a href="#l12.191"></a><span id="l12.191">                 let startDate  = aRangeStart;</span>
<a href="#l12.192"></a><span id="l12.192">                 if (!aRangeStart &amp;&amp; cal.isToDo(item)) {</span>
<a href="#l12.193"></a><span id="l12.193">                     startDate = item.entryDate;</span>
<a href="#l12.194"></a><span id="l12.194">                 }</span>
<a href="#l12.195"></a><span id="l12.195">                 let occurrences = item.recurrenceInfo.getOccurrences(</span>
<a href="#l12.196"></a><span id="l12.196">                     startDate, aRangeEnd, aCount ? aCount - itemsFound.length : 0, {});</span>
<a href="#l12.197"></a><span id="l12.197">                 if (wantUnrespondedInvitations) {</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineat">@@ -487,16 +526,74 @@ calMemoryCalendar.prototype = {</span>
<a href="#l12.199"></a><span id="l12.199">         this.notifyOperationComplete(aListener,</span>
<a href="#l12.200"></a><span id="l12.200">                                      Components.results.NS_OK,</span>
<a href="#l12.201"></a><span id="l12.201">                                      Components.interfaces.calIOperationListener.GET,</span>
<a href="#l12.202"></a><span id="l12.202">                                      null,</span>
<a href="#l12.203"></a><span id="l12.203">                                      null);</span>
<a href="#l12.204"></a><span id="l12.204">     },</span>
<a href="#l12.205"></a><span id="l12.205"> </span>
<a href="#l12.206"></a><span id="l12.206">     //</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+    // calIOfflineStorage interface</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineplus">+    //</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineplus">+    addOfflineItem: function addOfflineItem(aItem, aListener) {</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineplus">+        this.mOfflineFlags[aItem.id] = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineplus">+        this.notifyOperationComplete(aListener,</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineplus">+                                     Components.results.NS_OK,</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineplus">+                                     Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineplus">+                                     aItem.id,</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+                                     aItem);</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+    },</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+    modifyOfflineItem: function modifyOfflineItem(aItem, aListener) {</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineplus">+        let oldFlag = this.mOfflineFlags[aItem.id];</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+        if (oldFlag != cICL.OFFLINE_FLAG_CREATED_RECORD &amp;&amp;</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+            oldFlag != cICL.OFFLINE_FLAG_DELETED_RECORD) {</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+            this.mOfflineFlags[aItem.id] = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+        }</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineplus">+</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineplus">+        this_.notifyOperationComplete(aListener,</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineplus">+                                      Components.results.NS_OK,</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineplus">+                                      Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineplus">+                                      aItem.id,</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+                                      aItem);</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineplus">+    },</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineplus">+</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineplus">+    deleteOfflineItem: function deleteOfflineItem(aItem, aListener) {</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineplus">+        let oldFlag = this.mOfflineFlags[aItem.id];</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+        if (oldFlag == cICL.OFFLINE_FLAG_CREATED_RECORD) {</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineplus">+            delete this.mItems[aItem.id];</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineplus">+            delete this.mOfflineFlags[aItem.id];</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineplus">+        } else {</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineplus">+            this.mOfflineFlags[aItem.id] = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineplus">+        }</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineplus">+        this.notifyOperationComplete(aListener,</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineplus">+                                     Components.results.NS_OK,</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineplus">+                                     Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+                                     aItem.id,</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineplus">+                                     aItem);</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineplus">+        // notify observers</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineplus">+        this_.observers.notify(&quot;onDeleteItem&quot;, [aItem]);</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineplus">+    },</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineplus">+    getItemOfflineFlag: function getItemOfflineFlag(aItem, aListener) {</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineplus">+        let flag = (aItem &amp;&amp; aItem.id in this.mOfflineFlags ? this.mOfflineFlags[aItem.id] : null);</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineplus">+        this.notifyOperationComplete(aListener, Components.results.NS_OK,</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineplus">+                                     Components.interfaces.calIOperationListener.GET,</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+                                     null, flag);</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+    },</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineplus">+</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineplus">+    resetItemOfflineFlag: function resetItemOfflineFlag(aItem, aListener) {</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineplus">+        delete this.mOfflineFlags[aItem.id];</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineplus">+        this.notifyOperationComplete(aListener, Components.results.NS_OK,</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineplus">+                                     Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineplus">+                                     aItem.id, aItem);</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineplus">+    },</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineplus">+</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineplus">+    //</span>
<a href="#l12.265"></a><span id="l12.265">     // calISyncWriteCalendar interface</span>
<a href="#l12.266"></a><span id="l12.266">     //</span>
<a href="#l12.267"></a><span id="l12.267">     setMetaData: function memory_setMetaData(id, value) {</span>
<a href="#l12.268"></a><span id="l12.268">         this.mMetaData.setProperty(id, value);</span>
<a href="#l12.269"></a><span id="l12.269">     },</span>
<a href="#l12.270"></a><span id="l12.270">     deleteMetaData: function memory_deleteMetaData(id) {</span>
<a href="#l12.271"></a><span id="l12.271">         this.mMetaData.deleteProperty(id);</span>
<a href="#l12.272"></a><span id="l12.272">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -49,16 +49,17 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l13.4"></a><span id="l13.4"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l13.5"></a><span id="l13.5"> Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l13.6"></a><span id="l13.6"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l13.7"></a><span id="l13.7"> Components.utils.import(&quot;resource://calendar/modules/calStorageUpgrade.jsm&quot;);</span>
<a href="#l13.8"></a><span id="l13.8"> Components.utils.import(&quot;resource://calendar/modules/calStorageHelpers.jsm&quot;);</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10"> const USECS_PER_SECOND = 1000000;</span>
<a href="#l13.11"></a><span id="l13.11"> const kCalICalendar = Components.interfaces.calICalendar;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+const cICL = Components.interfaces.calIChangeLog;</span>
<a href="#l13.13"></a><span id="l13.13"> </span>
<a href="#l13.14"></a><span id="l13.14"> //</span>
<a href="#l13.15"></a><span id="l13.15"> // calStorageCalendar</span>
<a href="#l13.16"></a><span id="l13.16"> //</span>
<a href="#l13.17"></a><span id="l13.17"> </span>
<a href="#l13.18"></a><span id="l13.18"> function calStorageCalendar() {</span>
<a href="#l13.19"></a><span id="l13.19">     this.initProviderBase();</span>
<a href="#l13.20"></a><span id="l13.20">     this.mItemCache = {};</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineat">@@ -85,44 +86,46 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.22"></a><span id="l13.22">     },</span>
<a href="#l13.23"></a><span id="l13.23"> </span>
<a href="#l13.24"></a><span id="l13.24">     getHelperForLanguage: function (language) {</span>
<a href="#l13.25"></a><span id="l13.25">         return null;</span>
<a href="#l13.26"></a><span id="l13.26">     },</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28">     implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l13.29"></a><span id="l13.29">     flags: 0,</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+</span>
<a href="#l13.31"></a><span id="l13.31">     //</span>
<a href="#l13.32"></a><span id="l13.32">     // private members</span>
<a href="#l13.33"></a><span id="l13.33">     //</span>
<a href="#l13.34"></a><span id="l13.34">     mDB: null,</span>
<a href="#l13.35"></a><span id="l13.35">     mItemCache: null,</span>
<a href="#l13.36"></a><span id="l13.36">     mRecItemCacheInited: false,</span>
<a href="#l13.37"></a><span id="l13.37">     mRecEventCache: null,</span>
<a href="#l13.38"></a><span id="l13.38">     mRecTodoCache: null,</span>
<a href="#l13.39"></a><span id="l13.39">     mLastStatement: null,</span>
<a href="#l13.40"></a><span id="l13.40"> </span>
<a href="#l13.41"></a><span id="l13.41">     //</span>
<a href="#l13.42"></a><span id="l13.42">     // nsISupports interface</span>
<a href="#l13.43"></a><span id="l13.43">     //</span>
<a href="#l13.44"></a><span id="l13.44">     QueryInterface: function (aIID) {</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-        return doQueryInterface(this, calStorageCalendar.prototype, aIID,</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-                                [Components.interfaces.calICalendarProvider,</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-                                 Components.interfaces.calISyncWriteCalendar]);</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+        return cal.doQueryInterface(this, calStorageCalendar.prototype, aIID,</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+                                   [Components.interfaces.calICalendarProvider,</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+                                    Components.interfaces.calIOfflineStorage,</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+                                    Components.interfaces.calISyncWriteCalendar]);</span>
<a href="#l13.52"></a><span id="l13.52">     },</span>
<a href="#l13.53"></a><span id="l13.53"> </span>
<a href="#l13.54"></a><span id="l13.54">     //</span>
<a href="#l13.55"></a><span id="l13.55">     // calICalendarProvider interface</span>
<a href="#l13.56"></a><span id="l13.56">     //</span>
<a href="#l13.57"></a><span id="l13.57">     get prefChromeOverlay() {</span>
<a href="#l13.58"></a><span id="l13.58">         return null;</span>
<a href="#l13.59"></a><span id="l13.59">     },</span>
<a href="#l13.60"></a><span id="l13.60"> </span>
<a href="#l13.61"></a><span id="l13.61">     get displayName() {</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-        return calGetString(&quot;calendar&quot;, &quot;storageName&quot;);</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+        return cal.calGetString(&quot;calendar&quot;, &quot;storageName&quot;);</span>
<a href="#l13.64"></a><span id="l13.64">     },</span>
<a href="#l13.65"></a><span id="l13.65"> </span>
<a href="#l13.66"></a><span id="l13.66">     createCalendar: function cSC_createCalendar() {</span>
<a href="#l13.67"></a><span id="l13.67">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l13.68"></a><span id="l13.68">     },</span>
<a href="#l13.69"></a><span id="l13.69"> </span>
<a href="#l13.70"></a><span id="l13.70">     deleteCalendar: function cSC_deleteCalendar(aCalendar, listener) {</span>
<a href="#l13.71"></a><span id="l13.71">         aCalendar = aCalendar.wrappedJSObject;</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineat">@@ -257,17 +260,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.73"></a><span id="l13.73">             localDB = Services.storage.openDatabase(localDB);</span>
<a href="#l13.74"></a><span id="l13.74"> </span>
<a href="#l13.75"></a><span id="l13.75">             // First, we need to check if this is from 0.9, i.e we need to</span>
<a href="#l13.76"></a><span id="l13.76">             // migrate from storage.sdb to local.sqlite.</span>
<a href="#l13.77"></a><span id="l13.77">             let storageSdb = Services.dirsvc.get(&quot;ProfD&quot;, Components.interfaces.nsILocalFile);</span>
<a href="#l13.78"></a><span id="l13.78">             storageSdb.append(&quot;storage.sdb&quot;);</span>
<a href="#l13.79"></a><span id="l13.79">             this.mDB = Services.storage.openDatabase(storageSdb);</span>
<a href="#l13.80"></a><span id="l13.80">             if (this.mDB.tableExists(&quot;cal_events&quot;)) {</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-                cal.LOG(&quot;Storage: Migrating storage.sdb -&gt; local.sqlite&quot;);</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+                cal.LOG(&quot;[calStorageCalendar] Migrating storage.sdb -&gt; local.sqlite&quot;);</span>
<a href="#l13.83"></a><span id="l13.83">                 upgradeDB(this.mDB); // upgrade schema before migating data</span>
<a href="#l13.84"></a><span id="l13.84">                 let attachStatement = createStatement(this.mDB, &quot;ATTACH DATABASE :file_path AS local_sqlite&quot;);</span>
<a href="#l13.85"></a><span id="l13.85">                 try {</span>
<a href="#l13.86"></a><span id="l13.86">                     attachStatement.params.file_path = localDB.databaseFile.path;</span>
<a href="#l13.87"></a><span id="l13.87">                     attachStatement.execute();</span>
<a href="#l13.88"></a><span id="l13.88">                 } catch (exc) {</span>
<a href="#l13.89"></a><span id="l13.89">                     this.logError(&quot;prepareInitDB attachStatement.execute exception&quot;, exc);</span>
<a href="#l13.90"></a><span id="l13.90">                     throw exc;</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineat">@@ -355,17 +358,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.92"></a><span id="l13.92">                 let path = this.uri.path;</span>
<a href="#l13.93"></a><span id="l13.93">                 let pos = path.indexOf(&quot;?id=&quot;);</span>
<a href="#l13.94"></a><span id="l13.94"> </span>
<a href="#l13.95"></a><span id="l13.95">                 if (pos != -1) {</span>
<a href="#l13.96"></a><span id="l13.96">                     // There is an &quot;id&quot; parameter in the uri. This calendar</span>
<a href="#l13.97"></a><span id="l13.97">                     // has not been migrated to using the uuid as its cal_id.</span>
<a href="#l13.98"></a><span id="l13.98">                     pos = this.uri.path.indexOf(&quot;?id=&quot;);</span>
<a href="#l13.99"></a><span id="l13.99">                     if (pos != -1) {</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineminus">-                        cal.LOG(&quot;Storage: Migrating numeric cal_id to uuid&quot;);</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+                        cal.LOG(&quot;[calStorageCalendar] Migrating numeric cal_id to uuid&quot;);</span>
<a href="#l13.102"></a><span id="l13.102">                         id = parseInt(path.substr(pos + 4), 10);</span>
<a href="#l13.103"></a><span id="l13.103">                         migrateTables(this.mDB, this.id, id);</span>
<a href="#l13.104"></a><span id="l13.104"> </span>
<a href="#l13.105"></a><span id="l13.105">                         // Now remove the id from the uri to make sure we don't do this</span>
<a href="#l13.106"></a><span id="l13.106">                         // again. Remeber the id, so we can recover in case something</span>
<a href="#l13.107"></a><span id="l13.107">                         // goes wrong.</span>
<a href="#l13.108"></a><span id="l13.108">                         this.setProperty(&quot;uri&quot;, &quot;moz-storage-calendar://&quot;);</span>
<a href="#l13.109"></a><span id="l13.109">                         this.setProperty(&quot;old_calendar_id&quot;, id);</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineat">@@ -374,17 +377,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.111"></a><span id="l13.111">                     } else {</span>
<a href="#l13.112"></a><span id="l13.112">                         this.mDB.rollbackTransaction();</span>
<a href="#l13.113"></a><span id="l13.113">                     }</span>
<a href="#l13.114"></a><span id="l13.114">                 } else {</span>
<a href="#l13.115"></a><span id="l13.115">                     // For some reason, the first storage calendar before the</span>
<a href="#l13.116"></a><span id="l13.116">                     // v19 upgrade has cal_id=0. If we still have a</span>
<a href="#l13.117"></a><span id="l13.117">                     // moz-profile-calendar here, then this is the one and we</span>
<a href="#l13.118"></a><span id="l13.118">                     // need to move all events with cal_id=0 to this id.</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineminus">-                    cal.LOG(&quot;Storage: Migrating stray cal_id=0 calendar to uuid&quot;);</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+                    cal.LOG(&quot;[calStorageCalendar] Migrating stray cal_id=0 calendar to uuid&quot;);</span>
<a href="#l13.121"></a><span id="l13.121">                     migrateTables(this.mDB, this.id, 0);</span>
<a href="#l13.122"></a><span id="l13.122">                     this.setProperty(&quot;uri&quot;, &quot;moz-storage-calendar://&quot;);</span>
<a href="#l13.123"></a><span id="l13.123">                     this.setProperty(&quot;old_calendar_id&quot;, 0);</span>
<a href="#l13.124"></a><span id="l13.124">                     this.mDB.commitTransaction();</span>
<a href="#l13.125"></a><span id="l13.125">                 }</span>
<a href="#l13.126"></a><span id="l13.126">             } catch (exc) {</span>
<a href="#l13.127"></a><span id="l13.127">                 this.logError(&quot;prepareInitDB  moz-profile-calendar migration exception&quot;, exc);</span>
<a href="#l13.128"></a><span id="l13.128">                 this.mDB.rollbackTransaction();</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineat">@@ -438,17 +441,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.130"></a><span id="l13.130">                                          Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l13.131"></a><span id="l13.131">                                          null,</span>
<a href="#l13.132"></a><span id="l13.132">                                          &quot;Calendar is readonly&quot;);</span>
<a href="#l13.133"></a><span id="l13.133">             return;</span>
<a href="#l13.134"></a><span id="l13.134">         }</span>
<a href="#l13.135"></a><span id="l13.135"> </span>
<a href="#l13.136"></a><span id="l13.136">         if (aItem.id == null) {</span>
<a href="#l13.137"></a><span id="l13.137">             // is this an error?  Or should we generate an IID?</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineminus">-            aItem.id = getUUID();</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+            aItem.id = cal.getUUID();</span>
<a href="#l13.140"></a><span id="l13.140">         } else {</span>
<a href="#l13.141"></a><span id="l13.141">             var olditem = this.getItemById(aItem.id);</span>
<a href="#l13.142"></a><span id="l13.142">             if (olditem) {</span>
<a href="#l13.143"></a><span id="l13.143">                 if (this.relaxedMode) {</span>
<a href="#l13.144"></a><span id="l13.144">                     // we possibly want to interact with the user before deleting</span>
<a href="#l13.145"></a><span id="l13.145">                     this.deleteItemById(aItem.id);</span>
<a href="#l13.146"></a><span id="l13.146">                 } else {</span>
<a href="#l13.147"></a><span id="l13.147">                     this.notifyOperationComplete(aListener,</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineat">@@ -478,55 +481,80 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.149"></a><span id="l13.149">                                      aItem.id,</span>
<a href="#l13.150"></a><span id="l13.150">                                      aItem);</span>
<a href="#l13.151"></a><span id="l13.151"> </span>
<a href="#l13.152"></a><span id="l13.152">         // notify observers</span>
<a href="#l13.153"></a><span id="l13.153">         this.observers.notify(&quot;onAddItem&quot;, [aItem]);</span>
<a href="#l13.154"></a><span id="l13.154">     },</span>
<a href="#l13.155"></a><span id="l13.155"> </span>
<a href="#l13.156"></a><span id="l13.156">     // void modifyItem( in calIItemBase aNewItem, in calIItemBase aOldItem, in calIOperationListener aListener );</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+    // Actually uses doModifyItem</span>
<a href="#l13.158"></a><span id="l13.158">     modifyItem: function cSC_modifyItem(aNewItem, aOldItem, aListener) {</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+        let this_ = this;</span>
<a href="#l13.160"></a><span id="l13.160"> </span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+        // HACK Just modifying the item would clear the offline flag, we need to</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineplus">+        // retrieve the flag and pass it to the real modify function.</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+        let offlineJournalFlagListener = {</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+            onGetResult: function (calendar, status, opType, id, detail) {</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+            },</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+            onOperationComplete: function (this_, status, opType, id, offlineFlag) {</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+                this_.doModifyItem(aNewItem, aOldItem, aListener, offlineFlag);</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+            }</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+        };</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+        this.getItemOfflineFlag(aOldItem, offlineJournalFlagListener);</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+    },</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+    doModifyItem: function cSC_doModifyItem(aNewItem, aOldItem, aListener, offlineFlag) {</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineplus">+        let oldOfflineFlag = offlineFlag;</span>
<a href="#l13.175"></a><span id="l13.175">         if (this.readOnly) {</span>
<a href="#l13.176"></a><span id="l13.176">             this.notifyOperationComplete(aListener,</span>
<a href="#l13.177"></a><span id="l13.177">                                          Components.interfaces.calIErrors.CAL_IS_READONLY,</span>
<a href="#l13.178"></a><span id="l13.178">                                          Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l13.179"></a><span id="l13.179">                                          null,</span>
<a href="#l13.180"></a><span id="l13.180">                                          &quot;Calendar is readonly&quot;);</span>
<a href="#l13.181"></a><span id="l13.181">             return null;</span>
<a href="#l13.182"></a><span id="l13.182">         }</span>
<a href="#l13.183"></a><span id="l13.183">         if (!aNewItem) {</span>
<a href="#l13.184"></a><span id="l13.184">             throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l13.185"></a><span id="l13.185">         }</span>
<a href="#l13.186"></a><span id="l13.186"> </span>
<a href="#l13.187"></a><span id="l13.187" class="difflineminus">-        var this_ = this;</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+        let this_ = this;</span>
<a href="#l13.189"></a><span id="l13.189">         function reportError(errStr, errId) {</span>
<a href="#l13.190"></a><span id="l13.190">             this_.notifyOperationComplete(aListener,</span>
<a href="#l13.191"></a><span id="l13.191">                                           errId ? errId : Components.results.NS_ERROR_FAILURE,</span>
<a href="#l13.192"></a><span id="l13.192">                                           Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l13.193"></a><span id="l13.193">                                           aNewItem.id,</span>
<a href="#l13.194"></a><span id="l13.194">                                           errStr);</span>
<a href="#l13.195"></a><span id="l13.195">             return null;</span>
<a href="#l13.196"></a><span id="l13.196">         }</span>
<a href="#l13.197"></a><span id="l13.197"> </span>
<a href="#l13.198"></a><span id="l13.198">         if (aNewItem.id == null) {</span>
<a href="#l13.199"></a><span id="l13.199">             // this is definitely an error</span>
<a href="#l13.200"></a><span id="l13.200">             return reportError(&quot;ID for modifyItem item is null&quot;);</span>
<a href="#l13.201"></a><span id="l13.201">         }</span>
<a href="#l13.202"></a><span id="l13.202"> </span>
<a href="#l13.203"></a><span id="l13.203">         // Ensure that we're looking at the base item if we were given an</span>
<a href="#l13.204"></a><span id="l13.204">         // occurrence.  Later we can optimize this.</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineminus">-        var modifiedItem = aNewItem.parentItem.clone();</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineplus">+        let modifiedItem = aNewItem.parentItem.clone();</span>
<a href="#l13.207"></a><span id="l13.207">         if (aNewItem.parentItem != aNewItem) {</span>
<a href="#l13.208"></a><span id="l13.208">             modifiedItem.recurrenceInfo.modifyException(aNewItem, false);</span>
<a href="#l13.209"></a><span id="l13.209">         }</span>
<a href="#l13.210"></a><span id="l13.210"> </span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+        // If no old item was passed, then we should overwrite in any case.</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+        // Pick up the old item from the database and use this as an old item</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+        // later on.</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+        if (!aOldItem) {</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineplus">+            aOldItem = this.getItemById(aNewItem.id);</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+        }</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+</span>
<a href="#l13.218"></a><span id="l13.218">         if (this.relaxedMode) {</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+            // We've already filled in the old item above, if this doesn't exist</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+            // then just take the current item as its old version</span>
<a href="#l13.221"></a><span id="l13.221">             if (!aOldItem) {</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineminus">-                aOldItem = this.getItemById(aNewItem.id) || aNewItem;</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineplus">+                aOldItem = aNewItem;</span>
<a href="#l13.224"></a><span id="l13.224">             }</span>
<a href="#l13.225"></a><span id="l13.225">             aOldItem = aOldItem.parentItem;</span>
<a href="#l13.226"></a><span id="l13.226">         } else {</span>
<a href="#l13.227"></a><span id="l13.227">             var storedOldItem = (aOldItem ? this.getItemById(aOldItem.id) : null);</span>
<a href="#l13.228"></a><span id="l13.228">             if (!aOldItem || !storedOldItem) {</span>
<a href="#l13.229"></a><span id="l13.229">                 // no old item found?  should be using addItem, then.</span>
<a href="#l13.230"></a><span id="l13.230">                 return reportError(&quot;ID does not already exist for modifyItem&quot;);</span>
<a href="#l13.231"></a><span id="l13.231">             }</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineat">@@ -543,16 +571,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.233"></a><span id="l13.233">                 // Only take care of incrementing the generation if relaxed mode is</span>
<a href="#l13.234"></a><span id="l13.234">                 // off. Users of relaxed mode need to take care of this themselves.</span>
<a href="#l13.235"></a><span id="l13.235">                 modifiedItem.generation += 1;</span>
<a href="#l13.236"></a><span id="l13.236">             }</span>
<a href="#l13.237"></a><span id="l13.237">         }</span>
<a href="#l13.238"></a><span id="l13.238"> </span>
<a href="#l13.239"></a><span id="l13.239">         modifiedItem.makeImmutable();</span>
<a href="#l13.240"></a><span id="l13.240">         this.flushItem (modifiedItem, aOldItem);</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineplus">+        this.setOfflineJournalFlag(aNewItem, oldOfflineFlag);</span>
<a href="#l13.242"></a><span id="l13.242"> </span>
<a href="#l13.243"></a><span id="l13.243">         this.notifyOperationComplete(aListener,</span>
<a href="#l13.244"></a><span id="l13.244">                                      Components.results.NS_OK,</span>
<a href="#l13.245"></a><span id="l13.245">                                      Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l13.246"></a><span id="l13.246">                                      modifiedItem.id,</span>
<a href="#l13.247"></a><span id="l13.247">                                      modifiedItem);</span>
<a href="#l13.248"></a><span id="l13.248"> </span>
<a href="#l13.249"></a><span id="l13.249">         // notify observers</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineat">@@ -610,21 +639,21 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.251"></a><span id="l13.251">                                          Components.results.NS_OK,</span>
<a href="#l13.252"></a><span id="l13.252">                                          Components.interfaces.calIOperationListener.GET,</span>
<a href="#l13.253"></a><span id="l13.253">                                          aId,</span>
<a href="#l13.254"></a><span id="l13.254">                                          null);</span>
<a href="#l13.255"></a><span id="l13.255">             return;</span>
<a href="#l13.256"></a><span id="l13.256">         }</span>
<a href="#l13.257"></a><span id="l13.257"> </span>
<a href="#l13.258"></a><span id="l13.258">         var item_iid = null;</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineminus">-        if (isEvent(item))</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineplus">+        if (cal.isEvent(item)) {</span>
<a href="#l13.261"></a><span id="l13.261">             item_iid = Components.interfaces.calIEvent;</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineminus">-        else if (isToDo(item))</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineplus">+        } else if (cal.isToDo(item)) {</span>
<a href="#l13.264"></a><span id="l13.264">             item_iid = Components.interfaces.calITodo;</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineminus">-        else {</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineplus">+        } else {</span>
<a href="#l13.267"></a><span id="l13.267">             this.notifyOperationComplete(aListener,</span>
<a href="#l13.268"></a><span id="l13.268">                                          Components.results.NS_ERROR_FAILURE,</span>
<a href="#l13.269"></a><span id="l13.269">                                          Components.interfaces.calIOperationListener.GET,</span>
<a href="#l13.270"></a><span id="l13.270">                                          aId,</span>
<a href="#l13.271"></a><span id="l13.271">                                          &quot;Can't deduce item type based on QI&quot;);</span>
<a href="#l13.272"></a><span id="l13.272">             return;</span>
<a href="#l13.273"></a><span id="l13.273">         }</span>
<a href="#l13.274"></a><span id="l13.274"> </span>
<a href="#l13.275"></a><span id="l13.275" class="difflineat">@@ -679,26 +708,37 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.276"></a><span id="l13.276">         function checkUnrespondedInvitation(item) {</span>
<a href="#l13.277"></a><span id="l13.277">             var att = superCal.getInvitedAttendee(item);</span>
<a href="#l13.278"></a><span id="l13.278">             return (att &amp;&amp; (att.participationStatus == &quot;NEEDS-ACTION&quot;));</span>
<a href="#l13.279"></a><span id="l13.279">         }</span>
<a href="#l13.280"></a><span id="l13.280"> </span>
<a href="#l13.281"></a><span id="l13.281">         var wantEvents = ((aItemFilter &amp; kCalICalendar.ITEM_FILTER_TYPE_EVENT) != 0);</span>
<a href="#l13.282"></a><span id="l13.282">         var wantTodos = ((aItemFilter &amp; kCalICalendar.ITEM_FILTER_TYPE_TODO) != 0);</span>
<a href="#l13.283"></a><span id="l13.283">         var asOccurrences = ((aItemFilter &amp; kCalICalendar.ITEM_FILTER_CLASS_OCCURRENCES) != 0);</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineplus">+        var wantOfflineDeletedItems = ((aItemFilter &amp; kCalICalendar.ITEM_FILTER_OFFLINE_DELETED) != 0);</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineplus">+        var wantOfflineCreatedItems = ((aItemFilter &amp; kCalICalendar.ITEM_FILTER_OFFLINE_CREATED) != 0);</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineplus">+        var wantOfflineModifiedItems = ((aItemFilter &amp; kCalICalendar.ITEM_FILTER_OFFLINE_MODIFIED) != 0);</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineplus">+</span>
<a href="#l13.288"></a><span id="l13.288">         if (!wantEvents &amp;&amp; !wantTodos) {</span>
<a href="#l13.289"></a><span id="l13.289">             // nothing to do</span>
<a href="#l13.290"></a><span id="l13.290">             this.notifyOperationComplete(aListener,</span>
<a href="#l13.291"></a><span id="l13.291">                                          Components.results.NS_OK,</span>
<a href="#l13.292"></a><span id="l13.292">                                          Components.interfaces.calIOperationListener.GET,</span>
<a href="#l13.293"></a><span id="l13.293">                                          null,</span>
<a href="#l13.294"></a><span id="l13.294">                                          null);</span>
<a href="#l13.295"></a><span id="l13.295">             return;</span>
<a href="#l13.296"></a><span id="l13.296">         }</span>
<a href="#l13.297"></a><span id="l13.297"> </span>
<a href="#l13.298"></a><span id="l13.298" class="difflineplus">+        // HACK because recurring offline events/todos objects dont have offline_journal information</span>
<a href="#l13.299"></a><span id="l13.299" class="difflineplus">+        // Hence we need to update the mRecEventCacheOfflineFlags and  mRecTodoCacheOfflineFlags hash-tables</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineplus">+        // It can be an expensive operation but is only used in Online Reconciliation mode</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineplus">+        if (wantOfflineCreatedItems | wantOfflineDeletedItems | wantOfflineModifiedItems) {</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineplus">+            this.mRecItemCacheInited = false;</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineplus">+        }</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineplus">+</span>
<a href="#l13.305"></a><span id="l13.305">         this.assureRecurringItemCaches();</span>
<a href="#l13.306"></a><span id="l13.306"> </span>
<a href="#l13.307"></a><span id="l13.307">         var itemCompletedFilter = ((aItemFilter &amp; kCalICalendar.ITEM_FILTER_COMPLETED_YES) != 0);</span>
<a href="#l13.308"></a><span id="l13.308">         var itemNotCompletedFilter = ((aItemFilter &amp; kCalICalendar.ITEM_FILTER_COMPLETED_NO) != 0);</span>
<a href="#l13.309"></a><span id="l13.309"> </span>
<a href="#l13.310"></a><span id="l13.310">         function checkCompleted(item) {</span>
<a href="#l13.311"></a><span id="l13.311">             return (item.isCompleted ? itemCompletedFilter : itemNotCompletedFilter);</span>
<a href="#l13.312"></a><span id="l13.312">         }</span>
<a href="#l13.313"></a><span id="l13.313" class="difflineat">@@ -792,40 +832,51 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.314"></a><span id="l13.314">             //</span>
<a href="#l13.315"></a><span id="l13.315">             try {</span>
<a href="#l13.316"></a><span id="l13.316">                 this.prepareStatement(this.mSelectNonRecurringEventsByRange);</span>
<a href="#l13.317"></a><span id="l13.317">                 sp = this.mSelectNonRecurringEventsByRange.params;</span>
<a href="#l13.318"></a><span id="l13.318">                 sp.range_start = startTime;</span>
<a href="#l13.319"></a><span id="l13.319">                 sp.range_end = endTime;</span>
<a href="#l13.320"></a><span id="l13.320">                 sp.start_offset = aRangeStart ? aRangeStart.timezoneOffset * USECS_PER_SECOND : 0;</span>
<a href="#l13.321"></a><span id="l13.321">                 sp.end_offset = aRangeEnd ? aRangeEnd.timezoneOffset * USECS_PER_SECOND : 0;</span>
<a href="#l13.322"></a><span id="l13.322" class="difflineplus">+                sp.offline_journal = null;</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineplus">+</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineplus">+                if (wantOfflineDeletedItems) sp.offline_journal = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineplus">+                else if (wantOfflineCreatedItems) sp.offline_journal = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineplus">+                else if (wantOfflineModifiedItems) sp.offline_journal = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l13.327"></a><span id="l13.327"> </span>
<a href="#l13.328"></a><span id="l13.328">                 while (this.mSelectNonRecurringEventsByRange.step()) {</span>
<a href="#l13.329"></a><span id="l13.329">                     let row = this.mSelectNonRecurringEventsByRange.row;</span>
<a href="#l13.330"></a><span id="l13.330">                     resultItems.push(this.getEventFromRow(row, {}));</span>
<a href="#l13.331"></a><span id="l13.331">                 }</span>
<a href="#l13.332"></a><span id="l13.332">             } catch (e) {</span>
<a href="#l13.333"></a><span id="l13.333">                 this.logError(&quot;Error selecting non recurring events by range!\n&quot;, e);</span>
<a href="#l13.334"></a><span id="l13.334">             } finally {</span>
<a href="#l13.335"></a><span id="l13.335">                 this.mSelectNonRecurringEventsByRange.reset();</span>
<a href="#l13.336"></a><span id="l13.336">             }</span>
<a href="#l13.337"></a><span id="l13.337"> </span>
<a href="#l13.338"></a><span id="l13.338" class="difflineminus">-            // process the non-recurring events:</span>
<a href="#l13.339"></a><span id="l13.339" class="difflineplus">+            // Process the non-recurring events:</span>
<a href="#l13.340"></a><span id="l13.340">             for each (var evitem in resultItems) {</span>
<a href="#l13.341"></a><span id="l13.341">                 count += handleResultItem(evitem, Components.interfaces.calIEvent);</span>
<a href="#l13.342"></a><span id="l13.342">                 if (checkCount()) {</span>
<a href="#l13.343"></a><span id="l13.343">                     return;</span>
<a href="#l13.344"></a><span id="l13.344">                 }</span>
<a href="#l13.345"></a><span id="l13.345">             }</span>
<a href="#l13.346"></a><span id="l13.346"> </span>
<a href="#l13.347"></a><span id="l13.347" class="difflineminus">-            // process the recurring events from the cache</span>
<a href="#l13.348"></a><span id="l13.348" class="difflineminus">-            for each (var evitem in this.mRecEventCache) {</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineminus">-                count += handleResultItem(evitem, Components.interfaces.calIEvent);</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineminus">-                if (checkCount()) {</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineminus">-                    return;</span>
<a href="#l13.352"></a><span id="l13.352" class="difflineplus">+            // Process the recurring events from the cache</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineplus">+            for each (let evitem in this.mRecEventCache) {</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineplus">+                let offline_journal_flag = this.mRecEventCacheOfflineFlags[evitem.id] || null;</span>
<a href="#l13.355"></a><span id="l13.355" class="difflineplus">+                // No need to return flagged unless asked i.e. sp.offline_journal == offline_journal_flag</span>
<a href="#l13.356"></a><span id="l13.356" class="difflineplus">+                // Return created and modified offline records if sp.offline_journal is null alongwith events that have no flag</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineplus">+                if ((sp.offline_journal == null &amp;&amp; offline_journal_flag != cICL.OFFLINE_FLAG_DELETED_RECORD)</span>
<a href="#l13.358"></a><span id="l13.358" class="difflineplus">+                    || (sp.offline_journal != null &amp;&amp; offline_journal_flag == sp.offline_journal)) {</span>
<a href="#l13.359"></a><span id="l13.359" class="difflineplus">+                    count += handleResultItem(evitem, Components.interfaces.calIEvent);</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineplus">+                    if (checkCount()) {</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineplus">+                        return;</span>
<a href="#l13.362"></a><span id="l13.362" class="difflineplus">+                    }</span>
<a href="#l13.363"></a><span id="l13.363">                 }</span>
<a href="#l13.364"></a><span id="l13.364">             }</span>
<a href="#l13.365"></a><span id="l13.365">         }</span>
<a href="#l13.366"></a><span id="l13.366"> </span>
<a href="#l13.367"></a><span id="l13.367">         // if todos are wanted, do them next</span>
<a href="#l13.368"></a><span id="l13.368">         if (wantTodos) {</span>
<a href="#l13.369"></a><span id="l13.369">             var sp;             // stmt params</span>
<a href="#l13.370"></a><span id="l13.370">             var resultItems = [];</span>
<a href="#l13.371"></a><span id="l13.371" class="difflineat">@@ -833,16 +884,20 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.372"></a><span id="l13.372">             // first get non-recurring todos that happen to fall within the range</span>
<a href="#l13.373"></a><span id="l13.373">             try {</span>
<a href="#l13.374"></a><span id="l13.374">                 this.prepareStatement(this.mSelectNonRecurringTodosByRange);</span>
<a href="#l13.375"></a><span id="l13.375">                 sp = this.mSelectNonRecurringTodosByRange.params;</span>
<a href="#l13.376"></a><span id="l13.376">                 sp.range_start = startTime;</span>
<a href="#l13.377"></a><span id="l13.377">                 sp.range_end = endTime;</span>
<a href="#l13.378"></a><span id="l13.378">                 sp.start_offset = aRangeStart ? aRangeStart.timezoneOffset * USECS_PER_SECOND : 0;</span>
<a href="#l13.379"></a><span id="l13.379">                 sp.end_offset = aRangeEnd ? aRangeEnd.timezoneOffset * USECS_PER_SECOND : 0;</span>
<a href="#l13.380"></a><span id="l13.380" class="difflineplus">+                sp.offline_journal = null;</span>
<a href="#l13.381"></a><span id="l13.381" class="difflineplus">+                if (wantOfflineCreatedItems) sp.offline_journal = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l13.382"></a><span id="l13.382" class="difflineplus">+                if (wantOfflineDeletedItems) sp.offline_journal = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l13.383"></a><span id="l13.383" class="difflineplus">+                if (wantOfflineModifiedItems) sp.offline_journal = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l13.384"></a><span id="l13.384"> </span>
<a href="#l13.385"></a><span id="l13.385">                 while (this.mSelectNonRecurringTodosByRange.step()) {</span>
<a href="#l13.386"></a><span id="l13.386">                     let row = this.mSelectNonRecurringTodosByRange.row;</span>
<a href="#l13.387"></a><span id="l13.387">                     resultItems.push(this.getTodoFromRow(row, {}));</span>
<a href="#l13.388"></a><span id="l13.388">                 }</span>
<a href="#l13.389"></a><span id="l13.389">             } catch (e) {</span>
<a href="#l13.390"></a><span id="l13.390">                 this.logError(&quot;Error selecting non recurring todos by range&quot;, e);</span>
<a href="#l13.391"></a><span id="l13.391">             } finally {</span>
<a href="#l13.392"></a><span id="l13.392" class="difflineat">@@ -857,20 +912,31 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.393"></a><span id="l13.393">                 }</span>
<a href="#l13.394"></a><span id="l13.394">             }</span>
<a href="#l13.395"></a><span id="l13.395"> </span>
<a href="#l13.396"></a><span id="l13.396">             // Note: Reading the code, completed *occurrences* seems to be broken, because</span>
<a href="#l13.397"></a><span id="l13.397">             //       only the parent item has been filtered; I fixed that.</span>
<a href="#l13.398"></a><span id="l13.398">             //       Moreover item.todo_complete etc seems to be a leftover...</span>
<a href="#l13.399"></a><span id="l13.399"> </span>
<a href="#l13.400"></a><span id="l13.400">             // process the recurring todos from the cache</span>
<a href="#l13.401"></a><span id="l13.401" class="difflineminus">-            for each (var todoitem in this.mRecTodoCache) {</span>
<a href="#l13.402"></a><span id="l13.402" class="difflineminus">-                count += handleResultItem(todoitem, Components.interfaces.calITodo, checkCompleted);</span>
<a href="#l13.403"></a><span id="l13.403" class="difflineminus">-                if (checkCount()) {</span>
<a href="#l13.404"></a><span id="l13.404" class="difflineminus">-                    return;</span>
<a href="#l13.405"></a><span id="l13.405" class="difflineplus">+            for each (let todoitem in this.mRecTodoCache) {</span>
<a href="#l13.406"></a><span id="l13.406" class="difflineplus">+                let offline_journal_flag = this.mRecTodoCacheOfflineFlags[todoitem.id] || null;</span>
<a href="#l13.407"></a><span id="l13.407" class="difflineplus">+                if ((sp.offline_journal == null &amp;&amp;</span>
<a href="#l13.408"></a><span id="l13.408" class="difflineplus">+                     (offline_journal_flag == cICL.OFFLINE_FLAG_MODIFIED_RECORD ||</span>
<a href="#l13.409"></a><span id="l13.409" class="difflineplus">+                      offline_journal_flag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l13.410"></a><span id="l13.410" class="difflineplus">+                      offline_journal_flag == null)) ||</span>
<a href="#l13.411"></a><span id="l13.411" class="difflineplus">+                    (sp.offline_journal != null &amp;&amp;</span>
<a href="#l13.412"></a><span id="l13.412" class="difflineplus">+                     (offline_journal_flag == sp.offline_journal))) {</span>
<a href="#l13.413"></a><span id="l13.413" class="difflineplus">+</span>
<a href="#l13.414"></a><span id="l13.414" class="difflineplus">+                    count += handleResultItem(todoitem,</span>
<a href="#l13.415"></a><span id="l13.415" class="difflineplus">+                                              Components.interfaces.calITodo,</span>
<a href="#l13.416"></a><span id="l13.416" class="difflineplus">+                                              checkCompleted);</span>
<a href="#l13.417"></a><span id="l13.417" class="difflineplus">+                    if (checkCount()) {</span>
<a href="#l13.418"></a><span id="l13.418" class="difflineplus">+                        return;</span>
<a href="#l13.419"></a><span id="l13.419" class="difflineplus">+                    }</span>
<a href="#l13.420"></a><span id="l13.420">                 }</span>
<a href="#l13.421"></a><span id="l13.421">             }</span>
<a href="#l13.422"></a><span id="l13.422">         }</span>
<a href="#l13.423"></a><span id="l13.423"> </span>
<a href="#l13.424"></a><span id="l13.424">         // flush the queue</span>
<a href="#l13.425"></a><span id="l13.425">         queueItems(null);</span>
<a href="#l13.426"></a><span id="l13.426"> </span>
<a href="#l13.427"></a><span id="l13.427">         // and finish</span>
<a href="#l13.428"></a><span id="l13.428" class="difflineat">@@ -879,25 +945,166 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.429"></a><span id="l13.429">                                      Components.interfaces.calIOperationListener.GET,</span>
<a href="#l13.430"></a><span id="l13.430">                                      null,</span>
<a href="#l13.431"></a><span id="l13.431">                                      null);</span>
<a href="#l13.432"></a><span id="l13.432"> </span>
<a href="#l13.433"></a><span id="l13.433">         //var profEndTime = Date.now();</span>
<a href="#l13.434"></a><span id="l13.434">         //dump (&quot;++++ getItems took: &quot; + (profEndTime - profStartTime) + &quot; ms\n&quot;);</span>
<a href="#l13.435"></a><span id="l13.435">     },</span>
<a href="#l13.436"></a><span id="l13.436"> </span>
<a href="#l13.437"></a><span id="l13.437" class="difflineplus">+    getItemOfflineFlag: function cSC_getOfflineJournalFlag(aItem, aListener) {</span>
<a href="#l13.438"></a><span id="l13.438" class="difflineplus">+        let flag = null;</span>
<a href="#l13.439"></a><span id="l13.439" class="difflineplus">+        if (!aItem) {</span>
<a href="#l13.440"></a><span id="l13.440" class="difflineplus">+            // It is possible that aItem can be null, flag provided should be null in this case</span>
<a href="#l13.441"></a><span id="l13.441" class="difflineplus">+            aListener.onOperationComplete(this, Components.results.NS_OK,</span>
<a href="#l13.442"></a><span id="l13.442" class="difflineplus">+                                               Components.interfaces.calIOperationListener.GET, null, flag);</span>
<a href="#l13.443"></a><span id="l13.443" class="difflineplus">+        } else {</span>
<a href="#l13.444"></a><span id="l13.444" class="difflineplus">+            let aID = aItem.id;</span>
<a href="#l13.445"></a><span id="l13.445" class="difflineplus">+            let this_ = this;</span>
<a href="#l13.446"></a><span id="l13.446" class="difflineplus">+            let listener = {</span>
<a href="#l13.447"></a><span id="l13.447" class="difflineplus">+                handleResult: function(aResultSet) {</span>
<a href="#l13.448"></a><span id="l13.448" class="difflineplus">+                        let row = aResultSet.getNextRow();</span>
<a href="#l13.449"></a><span id="l13.449" class="difflineplus">+                        flag = row.getResultByName(&quot;offline_journal&quot;) || null;</span>
<a href="#l13.450"></a><span id="l13.450" class="difflineplus">+                },</span>
<a href="#l13.451"></a><span id="l13.451" class="difflineplus">+                handleError: function(aError) {</span>
<a href="#l13.452"></a><span id="l13.452" class="difflineplus">+                    this_.logError(&quot;Error getting offline flag&quot;, aError);</span>
<a href="#l13.453"></a><span id="l13.453" class="difflineplus">+                    aListener.onOperationComplete(this_, Components.results.NS_ERROR_FAILURE,</span>
<a href="#l13.454"></a><span id="l13.454" class="difflineplus">+                                                   Components.interfaces.calIOperationListener.GET, aItem.id, aItem);</span>
<a href="#l13.455"></a><span id="l13.455" class="difflineplus">+                },</span>
<a href="#l13.456"></a><span id="l13.456" class="difflineplus">+                handleCompletion: function(aReason) {</span>
<a href="#l13.457"></a><span id="l13.457" class="difflineplus">+                    aListener.onOperationComplete(this_, Components.results.NS_OK,</span>
<a href="#l13.458"></a><span id="l13.458" class="difflineplus">+                                                   Components.interfaces.calIOperationListener.GET, aItem.id, flag);</span>
<a href="#l13.459"></a><span id="l13.459" class="difflineplus">+                }</span>
<a href="#l13.460"></a><span id="l13.460" class="difflineplus">+            };</span>
<a href="#l13.461"></a><span id="l13.461" class="difflineplus">+            if (cal.isEvent(aItem)) {</span>
<a href="#l13.462"></a><span id="l13.462" class="difflineplus">+                this.prepareStatement(this.mSelectEvent);</span>
<a href="#l13.463"></a><span id="l13.463" class="difflineplus">+                this.mSelectEvent.params.id = aID;</span>
<a href="#l13.464"></a><span id="l13.464" class="difflineplus">+                this.mSelectEvent.statement.executeAsync(listener);</span>
<a href="#l13.465"></a><span id="l13.465" class="difflineplus">+            } else if (cal.isToDo(aItem)) {</span>
<a href="#l13.466"></a><span id="l13.466" class="difflineplus">+                this.prepareStatement(this.mSelectTodo);</span>
<a href="#l13.467"></a><span id="l13.467" class="difflineplus">+                this.mSelectTodo.params.id = aID;</span>
<a href="#l13.468"></a><span id="l13.468" class="difflineplus">+                this.mSelectTodo.statement.executeAsync(listener);</span>
<a href="#l13.469"></a><span id="l13.469" class="difflineplus">+            }</span>
<a href="#l13.470"></a><span id="l13.470" class="difflineplus">+        }</span>
<a href="#l13.471"></a><span id="l13.471" class="difflineplus">+    },</span>
<a href="#l13.472"></a><span id="l13.472" class="difflineplus">+</span>
<a href="#l13.473"></a><span id="l13.473" class="difflineplus">+    setOfflineJournalFlag: function cSC_setOfflineJournalFlag(aItem, flag) {</span>
<a href="#l13.474"></a><span id="l13.474" class="difflineplus">+        let aID = aItem.id;</span>
<a href="#l13.475"></a><span id="l13.475" class="difflineplus">+        if (cal.isEvent(aItem)) {</span>
<a href="#l13.476"></a><span id="l13.476" class="difflineplus">+            this.prepareStatement(this.mEditEventOfflineFlag);</span>
<a href="#l13.477"></a><span id="l13.477" class="difflineplus">+            this.mEditEventOfflineFlag.params.id = aID;</span>
<a href="#l13.478"></a><span id="l13.478" class="difflineplus">+            this.mEditEventOfflineFlag.params.offline_journal = flag || null;</span>
<a href="#l13.479"></a><span id="l13.479" class="difflineplus">+            try {</span>
<a href="#l13.480"></a><span id="l13.480" class="difflineplus">+                this.mEditEventOfflineFlag.execute();</span>
<a href="#l13.481"></a><span id="l13.481" class="difflineplus">+            } catch (e) {</span>
<a href="#l13.482"></a><span id="l13.482" class="difflineplus">+                this.logError(&quot;Error setting offline journal flag for &quot;  + aItem.title, e);</span>
<a href="#l13.483"></a><span id="l13.483" class="difflineplus">+            } finally {</span>
<a href="#l13.484"></a><span id="l13.484" class="difflineplus">+                this.mEditEventOfflineFlag.reset();</span>
<a href="#l13.485"></a><span id="l13.485" class="difflineplus">+            }</span>
<a href="#l13.486"></a><span id="l13.486" class="difflineplus">+</span>
<a href="#l13.487"></a><span id="l13.487" class="difflineplus">+        } else if (cal.isToDo(aItem)) {</span>
<a href="#l13.488"></a><span id="l13.488" class="difflineplus">+            this.prepareStatement(this.mEditTodoOfflineFlag);</span>
<a href="#l13.489"></a><span id="l13.489" class="difflineplus">+            this.mEditTodoOfflineFlag.params.id = aID;</span>
<a href="#l13.490"></a><span id="l13.490" class="difflineplus">+            this.mEditTodoOfflineFlag.params.offline_journal = flag || null;</span>
<a href="#l13.491"></a><span id="l13.491" class="difflineplus">+            try {</span>
<a href="#l13.492"></a><span id="l13.492" class="difflineplus">+                this.mEditTodoOfflineFlag.execute();</span>
<a href="#l13.493"></a><span id="l13.493" class="difflineplus">+            } catch (e) {</span>
<a href="#l13.494"></a><span id="l13.494" class="difflineplus">+                this.logError(&quot;Error setting offline journal flag for &quot;  + aItem.title, e);</span>
<a href="#l13.495"></a><span id="l13.495" class="difflineplus">+            } finally {</span>
<a href="#l13.496"></a><span id="l13.496" class="difflineplus">+                this.mEditEventOfflineFlag.reset();</span>
<a href="#l13.497"></a><span id="l13.497" class="difflineplus">+            }</span>
<a href="#l13.498"></a><span id="l13.498" class="difflineplus">+        }</span>
<a href="#l13.499"></a><span id="l13.499" class="difflineplus">+    },</span>
<a href="#l13.500"></a><span id="l13.500" class="difflineplus">+</span>
<a href="#l13.501"></a><span id="l13.501" class="difflineplus">+    //</span>
<a href="#l13.502"></a><span id="l13.502" class="difflineplus">+    // calIOfflineStorage interface</span>
<a href="#l13.503"></a><span id="l13.503" class="difflineplus">+    //</span>
<a href="#l13.504"></a><span id="l13.504" class="difflineplus">+    addOfflineItem: function(aItem, aListener) {</span>
<a href="#l13.505"></a><span id="l13.505" class="difflineplus">+        let newOfflineJournalFlag = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l13.506"></a><span id="l13.506" class="difflineplus">+        this.setOfflineJournalFlag(aItem, newOfflineJournalFlag);</span>
<a href="#l13.507"></a><span id="l13.507" class="difflineplus">+        this.notifyOperationComplete(aListener,</span>
<a href="#l13.508"></a><span id="l13.508" class="difflineplus">+                                     Components.results.NS_OK,</span>
<a href="#l13.509"></a><span id="l13.509" class="difflineplus">+                                     Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l13.510"></a><span id="l13.510" class="difflineplus">+                                     aItem.id,</span>
<a href="#l13.511"></a><span id="l13.511" class="difflineplus">+                                     aItem);</span>
<a href="#l13.512"></a><span id="l13.512" class="difflineplus">+    },</span>
<a href="#l13.513"></a><span id="l13.513" class="difflineplus">+</span>
<a href="#l13.514"></a><span id="l13.514" class="difflineplus">+    modifyOfflineItem: function(aItem, aListener) {</span>
<a href="#l13.515"></a><span id="l13.515" class="difflineplus">+        let this_ = this;</span>
<a href="#l13.516"></a><span id="l13.516" class="difflineplus">+        let opListener = {</span>
<a href="#l13.517"></a><span id="l13.517" class="difflineplus">+            onGetResult: function (calendar, status, itemType, detail, count, items) {</span>
<a href="#l13.518"></a><span id="l13.518" class="difflineplus">+            },</span>
<a href="#l13.519"></a><span id="l13.519" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, oldOfflineJournalFlag ) {</span>
<a href="#l13.520"></a><span id="l13.520" class="difflineplus">+                let newOfflineJournalFlag = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l13.521"></a><span id="l13.521" class="difflineplus">+                if (oldOfflineJournalFlag == cICL.OFFLINE_FLAG_CREATED_RECORD || oldOfflineJournalFlag == cICL.OFFLINE_FLAG_DELETED_RECORD) {</span>
<a href="#l13.522"></a><span id="l13.522" class="difflineplus">+                    // Do nothing since a flag of &quot;created&quot; or &quot;deleted&quot; exists</span>
<a href="#l13.523"></a><span id="l13.523" class="difflineplus">+                }</span>
<a href="#l13.524"></a><span id="l13.524" class="difflineplus">+                else {</span>
<a href="#l13.525"></a><span id="l13.525" class="difflineplus">+                    this_.setOfflineJournalFlag(aItem, newOfflineJournalFlag);</span>
<a href="#l13.526"></a><span id="l13.526" class="difflineplus">+                }</span>
<a href="#l13.527"></a><span id="l13.527" class="difflineplus">+                this_.notifyOperationComplete(aListener,</span>
<a href="#l13.528"></a><span id="l13.528" class="difflineplus">+                                              Components.results.NS_OK,</span>
<a href="#l13.529"></a><span id="l13.529" class="difflineplus">+                                              Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l13.530"></a><span id="l13.530" class="difflineplus">+                                              aItem.id,</span>
<a href="#l13.531"></a><span id="l13.531" class="difflineplus">+                                              aItem);</span>
<a href="#l13.532"></a><span id="l13.532" class="difflineplus">+            }</span>
<a href="#l13.533"></a><span id="l13.533" class="difflineplus">+        };</span>
<a href="#l13.534"></a><span id="l13.534" class="difflineplus">+        this.getItemOfflineFlag(aItem, opListener);</span>
<a href="#l13.535"></a><span id="l13.535" class="difflineplus">+    },</span>
<a href="#l13.536"></a><span id="l13.536" class="difflineplus">+</span>
<a href="#l13.537"></a><span id="l13.537" class="difflineplus">+    deleteOfflineItem: function(aItem, aListener) {</span>
<a href="#l13.538"></a><span id="l13.538" class="difflineplus">+        let this_ = this;</span>
<a href="#l13.539"></a><span id="l13.539" class="difflineplus">+        let opListener = {</span>
<a href="#l13.540"></a><span id="l13.540" class="difflineplus">+            onGetResult: function (calendar, status, itemType, detail, count, items) {</span>
<a href="#l13.541"></a><span id="l13.541" class="difflineplus">+</span>
<a href="#l13.542"></a><span id="l13.542" class="difflineplus">+            },</span>
<a href="#l13.543"></a><span id="l13.543" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, oldOfflineJournalFlag) {</span>
<a href="#l13.544"></a><span id="l13.544" class="difflineplus">+                var newOfflineJournalFlag = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l13.545"></a><span id="l13.545" class="difflineplus">+                if (oldOfflineJournalFlag) {</span>
<a href="#l13.546"></a><span id="l13.546" class="difflineplus">+                    // Delete item if flag is c</span>
<a href="#l13.547"></a><span id="l13.547" class="difflineplus">+                    if (oldOfflineJournalFlag == cICL.OFFLINE_FLAG_CREATED_RECORD) {</span>
<a href="#l13.548"></a><span id="l13.548" class="difflineplus">+                        this_.deleteItemById(aItem.id);</span>
<a href="#l13.549"></a><span id="l13.549" class="difflineplus">+                    }</span>
<a href="#l13.550"></a><span id="l13.550" class="difflineplus">+                    else if (oldOfflineJournalFlag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) {</span>
<a href="#l13.551"></a><span id="l13.551" class="difflineplus">+                        this_.setOfflineJournalFlag(aItem, cICL.OFFLINE_FLAG_DELETED_RECORD);</span>
<a href="#l13.552"></a><span id="l13.552" class="difflineplus">+                    }</span>
<a href="#l13.553"></a><span id="l13.553" class="difflineplus">+                } else {</span>
<a href="#l13.554"></a><span id="l13.554" class="difflineplus">+                    this_.setOfflineJournalFlag(aItem, cICL.OFFLINE_FLAG_DELETED_RECORD);</span>
<a href="#l13.555"></a><span id="l13.555" class="difflineplus">+                }</span>
<a href="#l13.556"></a><span id="l13.556" class="difflineplus">+</span>
<a href="#l13.557"></a><span id="l13.557" class="difflineplus">+                this_.notifyOperationComplete(aListener,</span>
<a href="#l13.558"></a><span id="l13.558" class="difflineplus">+                                             Components.results.NS_OK,</span>
<a href="#l13.559"></a><span id="l13.559" class="difflineplus">+                                             Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l13.560"></a><span id="l13.560" class="difflineplus">+                                             aItem.id,</span>
<a href="#l13.561"></a><span id="l13.561" class="difflineplus">+                                             aItem);</span>
<a href="#l13.562"></a><span id="l13.562" class="difflineplus">+                // notify observers</span>
<a href="#l13.563"></a><span id="l13.563" class="difflineplus">+                this_.observers.notify(&quot;onDeleteItem&quot;, [aItem]);</span>
<a href="#l13.564"></a><span id="l13.564" class="difflineplus">+            }</span>
<a href="#l13.565"></a><span id="l13.565" class="difflineplus">+        };</span>
<a href="#l13.566"></a><span id="l13.566" class="difflineplus">+        this.getItemOfflineFlag(aItem, opListener);</span>
<a href="#l13.567"></a><span id="l13.567" class="difflineplus">+    },</span>
<a href="#l13.568"></a><span id="l13.568" class="difflineplus">+</span>
<a href="#l13.569"></a><span id="l13.569" class="difflineplus">+    resetItemOfflineFlag: function(aItem, aListener) {</span>
<a href="#l13.570"></a><span id="l13.570" class="difflineplus">+        this.setOfflineJournalFlag(aItem,null);</span>
<a href="#l13.571"></a><span id="l13.571" class="difflineplus">+        this.notifyOperationComplete(aListener,</span>
<a href="#l13.572"></a><span id="l13.572" class="difflineplus">+                                     Components.results.NS_OK,</span>
<a href="#l13.573"></a><span id="l13.573" class="difflineplus">+                                     Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l13.574"></a><span id="l13.574" class="difflineplus">+                                     aItem.id,</span>
<a href="#l13.575"></a><span id="l13.575" class="difflineplus">+                                     aItem);</span>
<a href="#l13.576"></a><span id="l13.576" class="difflineplus">+    },</span>
<a href="#l13.577"></a><span id="l13.577" class="difflineplus">+</span>
<a href="#l13.578"></a><span id="l13.578">     //</span>
<a href="#l13.579"></a><span id="l13.579">     // database handling</span>
<a href="#l13.580"></a><span id="l13.580">     //</span>
<a href="#l13.581"></a><span id="l13.581"> </span>
<a href="#l13.582"></a><span id="l13.582">     // database initialization</span>
<a href="#l13.583"></a><span id="l13.583">     // assumes mDB is valid</span>
<a href="#l13.584"></a><span id="l13.584"> </span>
<a href="#l13.585"></a><span id="l13.585">     initDB: function cSC_initDB() {</span>
<a href="#l13.586"></a><span id="l13.586" class="difflineminus">-        ASSERT(this.mDB, &quot;Database has not been opened!&quot;, true);</span>
<a href="#l13.587"></a><span id="l13.587" class="difflineplus">+        cal.ASSERT(this.mDB, &quot;Database has not been opened!&quot;, true);</span>
<a href="#l13.588"></a><span id="l13.588"> </span>
<a href="#l13.589"></a><span id="l13.589">         this.mSelectEvent = createStatement (</span>
<a href="#l13.590"></a><span id="l13.590">             this.mDB,</span>
<a href="#l13.591"></a><span id="l13.591">             &quot;SELECT * FROM cal_events &quot; +</span>
<a href="#l13.592"></a><span id="l13.592">             &quot;WHERE id = :id AND cal_id = :cal_id &quot; +</span>
<a href="#l13.593"></a><span id="l13.593">             &quot; AND recurrence_id IS NULL &quot; +</span>
<a href="#l13.594"></a><span id="l13.594">             &quot;LIMIT 1&quot;</span>
<a href="#l13.595"></a><span id="l13.595">             );</span>
<a href="#l13.596"></a><span id="l13.596" class="difflineat">@@ -932,17 +1139,21 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.597"></a><span id="l13.597">             &quot;  (&quot;+nonFloatingEventEnd+&quot; &gt; :range_start) OR &quot; +</span>
<a href="#l13.598"></a><span id="l13.598">             &quot;  (((&quot;+floatingEventEnd+&quot; = :range_start + :start_offset) OR &quot; +</span>
<a href="#l13.599"></a><span id="l13.599">             &quot;    (&quot;+nonFloatingEventEnd+&quot; = :range_start)) AND &quot; +</span>
<a href="#l13.600"></a><span id="l13.600">             &quot;   ((&quot;+floatingEventStart+&quot; = :range_start + :start_offset) OR &quot; +</span>
<a href="#l13.601"></a><span id="l13.601">             &quot;    (&quot;+nonFloatingEventStart+&quot; = :range_start)))) &quot; +</span>
<a href="#l13.602"></a><span id="l13.602">             &quot; AND &quot; +</span>
<a href="#l13.603"></a><span id="l13.603">             &quot;  ((&quot;+floatingEventStart+&quot; &lt; :range_end + :end_offset) OR &quot; +</span>
<a href="#l13.604"></a><span id="l13.604">             &quot;   (&quot;+nonFloatingEventStart+&quot; &lt; :range_end)) &quot; +</span>
<a href="#l13.605"></a><span id="l13.605" class="difflineminus">-            &quot; AND cal_id = :cal_id AND flags &amp; 16 == 0 AND recurrence_id IS NULL&quot;</span>
<a href="#l13.606"></a><span id="l13.606" class="difflineplus">+            &quot; AND cal_id = :cal_id AND flags &amp; 16 == 0 AND recurrence_id IS NULL&quot; +</span>
<a href="#l13.607"></a><span id="l13.607" class="difflineplus">+            &quot; AND ((:offline_journal IS NULL &quot; +</span>
<a href="#l13.608"></a><span id="l13.608" class="difflineplus">+            &quot; AND  (offline_journal IS NULL &quot; +</span>
<a href="#l13.609"></a><span id="l13.609" class="difflineplus">+            &quot;  OR   offline_journal != &quot; + cICL.OFFLINE_FLAG_DELETED_RECORD + &quot;)) &quot; +</span>
<a href="#l13.610"></a><span id="l13.610" class="difflineplus">+            &quot;  OR (offline_journal == :offline_journal))&quot;</span>
<a href="#l13.611"></a><span id="l13.611">             );</span>
<a href="#l13.612"></a><span id="l13.612">        /**</span>
<a href="#l13.613"></a><span id="l13.613">         * WHERE (due &gt; rangeStart AND start &lt; rangeEnd) OR</span>
<a href="#l13.614"></a><span id="l13.614">         *       (due = rangeStart AND start = rangeStart) OR</span>
<a href="#l13.615"></a><span id="l13.615">         *       (due IS NULL AND ((start &gt;= rangeStart AND start &lt; rangeEnd) OR</span>
<a href="#l13.616"></a><span id="l13.616">         *                         (start IS NULL AND</span>
<a href="#l13.617"></a><span id="l13.617">         *                          (completed &gt; rangeStart OR completed IS NULL))) OR</span>
<a href="#l13.618"></a><span id="l13.618">         *       (start IS NULL AND due &gt;= rangeStart AND due &lt; rangeEnd)</span>
<a href="#l13.619"></a><span id="l13.619" class="difflineat">@@ -971,17 +1182,21 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.620"></a><span id="l13.620">             &quot;  (((&quot;+floatingTodoEntry+&quot; &gt;= :range_start + :start_offset) OR &quot; +</span>
<a href="#l13.621"></a><span id="l13.621">             &quot;    (&quot;+nonFloatingTodoEntry+&quot; &gt;= :range_start)) AND &quot; +</span>
<a href="#l13.622"></a><span id="l13.622">             &quot;    ((&quot;+floatingTodoEntry+&quot; &lt; :range_end + :end_offset) OR &quot; +</span>
<a href="#l13.623"></a><span id="l13.623">             &quot;     (&quot;+nonFloatingTodoEntry+&quot; &lt; :range_end)))) OR &quot; +</span>
<a href="#l13.624"></a><span id="l13.624">             &quot; ((todo_entry IS NULL) AND &quot; +</span>
<a href="#l13.625"></a><span id="l13.625">             &quot;  (((&quot;+floatingCompleted+&quot; &gt; :range_start + :start_offset) OR &quot; +</span>
<a href="#l13.626"></a><span id="l13.626">             &quot;    (&quot;+nonFloatingCompleted+&quot; &gt; :range_start)) OR &quot; +</span>
<a href="#l13.627"></a><span id="l13.627">             &quot;   (todo_completed IS NULL)))) &quot; +</span>
<a href="#l13.628"></a><span id="l13.628" class="difflineminus">-            &quot; AND cal_id = :cal_id AND flags &amp; 16 == 0 AND recurrence_id IS NULL&quot;</span>
<a href="#l13.629"></a><span id="l13.629" class="difflineplus">+            &quot; AND cal_id = :cal_id AND flags &amp; 16 == 0 AND recurrence_id IS NULL &quot; +</span>
<a href="#l13.630"></a><span id="l13.630" class="difflineplus">+            &quot; AND ((:offline_journal IS NULL&quot; +</span>
<a href="#l13.631"></a><span id="l13.631" class="difflineplus">+            &quot; AND  (offline_journal IS NULL&quot; +</span>
<a href="#l13.632"></a><span id="l13.632" class="difflineplus">+            &quot;  OR   offline_journal != &quot; + cICL.OFFLINE_FLAG_DELETED_RECORD + &quot;)) &quot; +</span>
<a href="#l13.633"></a><span id="l13.633" class="difflineplus">+            &quot;  OR (offline_journal == :offline_journal))&quot;</span>
<a href="#l13.634"></a><span id="l13.634">             );</span>
<a href="#l13.635"></a><span id="l13.635"> </span>
<a href="#l13.636"></a><span id="l13.636">         this.mSelectEventsWithRecurrence = createStatement(</span>
<a href="#l13.637"></a><span id="l13.637">             this.mDB,</span>
<a href="#l13.638"></a><span id="l13.638">             &quot;SELECT * FROM cal_events &quot; +</span>
<a href="#l13.639"></a><span id="l13.639">             &quot; WHERE flags &amp; 16 == 16 &quot; +</span>
<a href="#l13.640"></a><span id="l13.640">             &quot;   AND cal_id = :cal_id AND recurrence_id is NULL&quot;</span>
<a href="#l13.641"></a><span id="l13.641">             );</span>
<a href="#l13.642"></a><span id="l13.642" class="difflineat">@@ -1169,16 +1384,28 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.643"></a><span id="l13.643">             + &quot; VALUES (:cal_id, :item_id, :value)&quot;);</span>
<a href="#l13.644"></a><span id="l13.644"> </span>
<a href="#l13.645"></a><span id="l13.645">         this.mInsertAlarm = createStatement(</span>
<a href="#l13.646"></a><span id="l13.646">             this.mDB,</span>
<a href="#l13.647"></a><span id="l13.647">             &quot;INSERT INTO cal_alarms &quot; +</span>
<a href="#l13.648"></a><span id="l13.648">             &quot;  (cal_id, item_id, icalString, recurrence_id, recurrence_id_tz) &quot; +</span>
<a href="#l13.649"></a><span id="l13.649">             &quot;VALUES  (:cal_id, :item_id, :icalString, :recurrence_id, :recurrence_id_tz)  &quot;</span>
<a href="#l13.650"></a><span id="l13.650">             );</span>
<a href="#l13.651"></a><span id="l13.651" class="difflineplus">+        //Offline Operations</span>
<a href="#l13.652"></a><span id="l13.652" class="difflineplus">+        this.mEditEventOfflineFlag = createStatement(</span>
<a href="#l13.653"></a><span id="l13.653" class="difflineplus">+            this.mDB,</span>
<a href="#l13.654"></a><span id="l13.654" class="difflineplus">+            &quot;UPDATE cal_events SET offline_journal = :offline_journal&quot; +</span>
<a href="#l13.655"></a><span id="l13.655" class="difflineplus">+            &quot; WHERE id = :id AND cal_id = :cal_id&quot;</span>
<a href="#l13.656"></a><span id="l13.656" class="difflineplus">+        );</span>
<a href="#l13.657"></a><span id="l13.657" class="difflineplus">+</span>
<a href="#l13.658"></a><span id="l13.658" class="difflineplus">+        this.mEditTodoOfflineFlag = createStatement(</span>
<a href="#l13.659"></a><span id="l13.659" class="difflineplus">+            this.mDB,</span>
<a href="#l13.660"></a><span id="l13.660" class="difflineplus">+            &quot;UPDATE cal_todos SET offline_journal = :offline_journal&quot; +</span>
<a href="#l13.661"></a><span id="l13.661" class="difflineplus">+            &quot; WHERE id = :id AND cal_id = :cal_id&quot;</span>
<a href="#l13.662"></a><span id="l13.662" class="difflineplus">+        );</span>
<a href="#l13.663"></a><span id="l13.663"> </span>
<a href="#l13.664"></a><span id="l13.664">         // delete statements</span>
<a href="#l13.665"></a><span id="l13.665">         this.mDeleteEvent = createStatement (</span>
<a href="#l13.666"></a><span id="l13.666">             this.mDB,</span>
<a href="#l13.667"></a><span id="l13.667">             &quot;DELETE FROM cal_events WHERE id = :id AND cal_id = :cal_id&quot;</span>
<a href="#l13.668"></a><span id="l13.668">             );</span>
<a href="#l13.669"></a><span id="l13.669">         this.mDeleteTodo = createStatement (</span>
<a href="#l13.670"></a><span id="l13.670">             this.mDB,</span>
<a href="#l13.671"></a><span id="l13.671" class="difflineat">@@ -1297,52 +1524,57 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.672"></a><span id="l13.672">         if (row.last_modified) {</span>
<a href="#l13.673"></a><span id="l13.673">             item.setProperty(&quot;LAST-MODIFIED&quot;, newDateTime(row.last_modified, &quot;UTC&quot;));</span>
<a href="#l13.674"></a><span id="l13.674">         }</span>
<a href="#l13.675"></a><span id="l13.675">     },</span>
<a href="#l13.676"></a><span id="l13.676"> </span>
<a href="#l13.677"></a><span id="l13.677">     cacheItem: function cSC_cacheItem(item) {</span>
<a href="#l13.678"></a><span id="l13.678">         this.mItemCache[item.id] = item;</span>
<a href="#l13.679"></a><span id="l13.679">         if (item.recurrenceInfo) {</span>
<a href="#l13.680"></a><span id="l13.680" class="difflineminus">-            if (isEvent(item)) {</span>
<a href="#l13.681"></a><span id="l13.681" class="difflineplus">+            if (cal.isEvent(item)) {</span>
<a href="#l13.682"></a><span id="l13.682">                 this.mRecEventCache[item.id] = item;</span>
<a href="#l13.683"></a><span id="l13.683">             } else {</span>
<a href="#l13.684"></a><span id="l13.684">                 this.mRecTodoCache[item.id] = item;</span>
<a href="#l13.685"></a><span id="l13.685">             }</span>
<a href="#l13.686"></a><span id="l13.686">         }</span>
<a href="#l13.687"></a><span id="l13.687">     },</span>
<a href="#l13.688"></a><span id="l13.688"> </span>
<a href="#l13.689"></a><span id="l13.689" class="difflineplus">+    mRecEventCacheOfflineFlags: {},</span>
<a href="#l13.690"></a><span id="l13.690" class="difflineplus">+    mRecTodoCacheOfflineFlags : {},</span>
<a href="#l13.691"></a><span id="l13.691">     assureRecurringItemCaches: function cSC_assureRecurringItemCaches() {</span>
<a href="#l13.692"></a><span id="l13.692">         if (this.mRecItemCacheInited) {</span>
<a href="#l13.693"></a><span id="l13.693">             return;</span>
<a href="#l13.694"></a><span id="l13.694">         }</span>
<a href="#l13.695"></a><span id="l13.695" class="difflineminus">-        // build up recurring event and todo cache, because we need that on every query:</span>
<a href="#l13.696"></a><span id="l13.696" class="difflineminus">-        // for recurring items, we need to query database-wide.. yuck</span>
<a href="#l13.697"></a><span id="l13.697" class="difflineplus">+        // build up recurring event and todo cache with its offline flags,</span>
<a href="#l13.698"></a><span id="l13.698" class="difflineplus">+        // because we need that on every query: for recurring items, we need to</span>
<a href="#l13.699"></a><span id="l13.699" class="difflineplus">+        // query database-wide.. yuck</span>
<a href="#l13.700"></a><span id="l13.700"> </span>
<a href="#l13.701"></a><span id="l13.701">         try {</span>
<a href="#l13.702"></a><span id="l13.702">             this.prepareStatement(this.mSelectEventsWithRecurrence);</span>
<a href="#l13.703"></a><span id="l13.703">             let sp = this.mSelectEventsWithRecurrence.params;</span>
<a href="#l13.704"></a><span id="l13.704">             while (this.mSelectEventsWithRecurrence.step()) {</span>
<a href="#l13.705"></a><span id="l13.705" class="difflineminus">-                var row = this.mSelectEventsWithRecurrence.row;</span>
<a href="#l13.706"></a><span id="l13.706" class="difflineminus">-                var item = this.getEventFromRow(row, {});</span>
<a href="#l13.707"></a><span id="l13.707" class="difflineplus">+                let row = this.mSelectEventsWithRecurrence.row;</span>
<a href="#l13.708"></a><span id="l13.708" class="difflineplus">+                let item = this.getEventFromRow(row, {});</span>
<a href="#l13.709"></a><span id="l13.709">                 this.mRecEventCache[item.id] = item;</span>
<a href="#l13.710"></a><span id="l13.710" class="difflineplus">+                this.mRecEventCacheOfflineFlags[item.id] = row.offline_journal || null;</span>
<a href="#l13.711"></a><span id="l13.711">             }</span>
<a href="#l13.712"></a><span id="l13.712">         } catch (e) {</span>
<a href="#l13.713"></a><span id="l13.713">             this.logError(&quot;Error selecting events with recurrence!&quot;, e);</span>
<a href="#l13.714"></a><span id="l13.714">         } finally {</span>
<a href="#l13.715"></a><span id="l13.715">             this.mSelectEventsWithRecurrence.reset();</span>
<a href="#l13.716"></a><span id="l13.716">         }</span>
<a href="#l13.717"></a><span id="l13.717"> </span>
<a href="#l13.718"></a><span id="l13.718">         try {</span>
<a href="#l13.719"></a><span id="l13.719">             this.prepareStatement(this.mSelectTodosWithRecurrence);</span>
<a href="#l13.720"></a><span id="l13.720">             sp = this.mSelectTodosWithRecurrence.params;</span>
<a href="#l13.721"></a><span id="l13.721">             while (this.mSelectTodosWithRecurrence.step()) {</span>
<a href="#l13.722"></a><span id="l13.722">                 var row = this.mSelectTodosWithRecurrence.row;</span>
<a href="#l13.723"></a><span id="l13.723">                 var item = this.getTodoFromRow(row, {});</span>
<a href="#l13.724"></a><span id="l13.724">                 this.mRecTodoCache[item.id] = item;</span>
<a href="#l13.725"></a><span id="l13.725" class="difflineplus">+                this.mRecTodoCacheOfflineFlags[item.id] = row.offline_journal || null;</span>
<a href="#l13.726"></a><span id="l13.726">             }</span>
<a href="#l13.727"></a><span id="l13.727">         } catch (e) {</span>
<a href="#l13.728"></a><span id="l13.728">             this.logError(&quot;Error selecting todos with recurrence!&quot;, e);</span>
<a href="#l13.729"></a><span id="l13.729">         } finally {</span>
<a href="#l13.730"></a><span id="l13.730">             this.mSelectTodosWithRecurrence.reset();</span>
<a href="#l13.731"></a><span id="l13.731">         }</span>
<a href="#l13.732"></a><span id="l13.732"> </span>
<a href="#l13.733"></a><span id="l13.733">         this.mRecItemCacheInited = true;</span>
<a href="#l13.734"></a><span id="l13.734" class="difflineat">@@ -1524,27 +1756,27 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.735"></a><span id="l13.735">                         ritem.date = textToDate(d);</span>
<a href="#l13.736"></a><span id="l13.736">                     } else {</span>
<a href="#l13.737"></a><span id="l13.737">                         ritem = cal.createRecurrenceRule();</span>
<a href="#l13.738"></a><span id="l13.738"> </span>
<a href="#l13.739"></a><span id="l13.739">                         ritem.type = row.recur_type;</span>
<a href="#l13.740"></a><span id="l13.740">                         if (row.count) {</span>
<a href="#l13.741"></a><span id="l13.741">                             try {</span>
<a href="#l13.742"></a><span id="l13.742">                                 ritem.count = row.count;</span>
<a href="#l13.743"></a><span id="l13.743" class="difflineminus">-                            } catch(exc) {</span>
<a href="#l13.744"></a><span id="l13.744" class="difflineplus">+                            } catch (exc) {</span>
<a href="#l13.745"></a><span id="l13.745">                             }</span>
<a href="#l13.746"></a><span id="l13.746">                         } else {</span>
<a href="#l13.747"></a><span id="l13.747">                             if (row.end_date)</span>
<a href="#l13.748"></a><span id="l13.748">                                 ritem.untilDate = newDateTime(row.end_date, &quot;UTC&quot;);</span>
<a href="#l13.749"></a><span id="l13.749">                             else</span>
<a href="#l13.750"></a><span id="l13.750">                                 ritem.untilDate = null;</span>
<a href="#l13.751"></a><span id="l13.751">                         }</span>
<a href="#l13.752"></a><span id="l13.752">                         try {</span>
<a href="#l13.753"></a><span id="l13.753">                             ritem.interval = row.interval;</span>
<a href="#l13.754"></a><span id="l13.754" class="difflineminus">-                        } catch(exc) {</span>
<a href="#l13.755"></a><span id="l13.755" class="difflineplus">+                        } catch (exc) {</span>
<a href="#l13.756"></a><span id="l13.756">                         }</span>
<a href="#l13.757"></a><span id="l13.757"> </span>
<a href="#l13.758"></a><span id="l13.758">                         var rtypes = [&quot;second&quot;,</span>
<a href="#l13.759"></a><span id="l13.759">                                       &quot;minute&quot;,</span>
<a href="#l13.760"></a><span id="l13.760">                                       &quot;hour&quot;,</span>
<a href="#l13.761"></a><span id="l13.761">                                       &quot;day&quot;,</span>
<a href="#l13.762"></a><span id="l13.762">                                       &quot;monthday&quot;,</span>
<a href="#l13.763"></a><span id="l13.763">                                       &quot;yearday&quot;,</span>
<a href="#l13.764"></a><span id="l13.764" class="difflineat">@@ -1845,22 +2077,23 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.765"></a><span id="l13.765"> </span>
<a href="#l13.766"></a><span id="l13.766">         flags |= this.writeAttendees(item, olditem);</span>
<a href="#l13.767"></a><span id="l13.767">         flags |= this.writeRecurrence(item, olditem);</span>
<a href="#l13.768"></a><span id="l13.768">         flags |= this.writeProperties(item, olditem);</span>
<a href="#l13.769"></a><span id="l13.769">         flags |= this.writeAttachments(item, olditem);</span>
<a href="#l13.770"></a><span id="l13.770">         flags |= this.writeRelations(item, olditem);</span>
<a href="#l13.771"></a><span id="l13.771">         flags |= this.writeAlarms(item, olditem);</span>
<a href="#l13.772"></a><span id="l13.772"> </span>
<a href="#l13.773"></a><span id="l13.773" class="difflineminus">-        if (isEvent(item))</span>
<a href="#l13.774"></a><span id="l13.774" class="difflineplus">+        if (cal.isEvent(item)) {</span>
<a href="#l13.775"></a><span id="l13.775">             this.writeEvent(item, olditem, flags);</span>
<a href="#l13.776"></a><span id="l13.776" class="difflineminus">-        else if (isToDo(item))</span>
<a href="#l13.777"></a><span id="l13.777" class="difflineplus">+        } else if (cal.isToDo(item)) {</span>
<a href="#l13.778"></a><span id="l13.778">             this.writeTodo(item, olditem, flags);</span>
<a href="#l13.779"></a><span id="l13.779" class="difflineminus">-        else</span>
<a href="#l13.780"></a><span id="l13.780" class="difflineplus">+        } else {</span>
<a href="#l13.781"></a><span id="l13.781">             throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l13.782"></a><span id="l13.782" class="difflineplus">+        }</span>
<a href="#l13.783"></a><span id="l13.783">     },</span>
<a href="#l13.784"></a><span id="l13.784"> </span>
<a href="#l13.785"></a><span id="l13.785">     writeEvent: function cSC_writeEvent(item, olditem, flags) {</span>
<a href="#l13.786"></a><span id="l13.786">         try {</span>
<a href="#l13.787"></a><span id="l13.787">             this.prepareStatement(this.mInsertEvent);</span>
<a href="#l13.788"></a><span id="l13.788">             let ip = this.mInsertEvent.params;</span>
<a href="#l13.789"></a><span id="l13.789">             this.setupItemBaseParams(item, olditem, ip);</span>
<a href="#l13.790"></a><span id="l13.790"> </span>
<a href="#l13.791"></a><span id="l13.791" class="difflineat">@@ -2187,17 +2420,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.792"></a><span id="l13.792">         for each (let alarm in alarms) {</span>
<a href="#l13.793"></a><span id="l13.793">             let pp = this.mInsertAlarm.params;</span>
<a href="#l13.794"></a><span id="l13.794">             try {</span>
<a href="#l13.795"></a><span id="l13.795">                 this.prepareStatement(this.mInsertAlarm);</span>
<a href="#l13.796"></a><span id="l13.796">                 this.setDateParamHelper(pp, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l13.797"></a><span id="l13.797">                 pp.item_id = item.id;</span>
<a href="#l13.798"></a><span id="l13.798">                 pp.icalString = alarm.icalString;</span>
<a href="#l13.799"></a><span id="l13.799">                 this.mInsertAlarm.execute();</span>
<a href="#l13.800"></a><span id="l13.800" class="difflineminus">-            } catch(e) {</span>
<a href="#l13.801"></a><span id="l13.801" class="difflineplus">+            } catch (e) {</span>
<a href="#l13.802"></a><span id="l13.802">                 this.logError(&quot;Error writing alarm for item &quot; + item.title + &quot; (&quot; + item.id + &quot;)&quot;, e);</span>
<a href="#l13.803"></a><span id="l13.803">             } finally {</span>
<a href="#l13.804"></a><span id="l13.804">                 this.mInsertAlarm.reset();</span>
<a href="#l13.805"></a><span id="l13.805">             }</span>
<a href="#l13.806"></a><span id="l13.806">         }</span>
<a href="#l13.807"></a><span id="l13.807"> </span>
<a href="#l13.808"></a><span id="l13.808">         return CAL_ITEM_FLAG.HAS_ALARMS;</span>
<a href="#l13.809"></a><span id="l13.809">     },</span>
<a href="#l13.810"></a><span id="l13.810" class="difflineat">@@ -2213,16 +2446,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.811"></a><span id="l13.811">             this.mDeleteAttendees(aID, this.id);</span>
<a href="#l13.812"></a><span id="l13.812">             this.mDeleteProperties(aID, this.id);</span>
<a href="#l13.813"></a><span id="l13.813">             this.mDeleteRecurrence(aID, this.id);</span>
<a href="#l13.814"></a><span id="l13.814">             this.mDeleteEvent(aID, this.id);</span>
<a href="#l13.815"></a><span id="l13.815">             this.mDeleteTodo(aID, this.id);</span>
<a href="#l13.816"></a><span id="l13.816">             this.mDeleteAttachments(aID, this.id);</span>
<a href="#l13.817"></a><span id="l13.817">             this.mDeleteRelations(aID, this.id);</span>
<a href="#l13.818"></a><span id="l13.818">             this.mDeleteMetaData(aID, this.id);</span>
<a href="#l13.819"></a><span id="l13.819" class="difflineplus">+            //this.mDeleteAllMetaData(aID, this.id);</span>
<a href="#l13.820"></a><span id="l13.820">             this.mDeleteAlarms(aID, this.id);</span>
<a href="#l13.821"></a><span id="l13.821">         } catch (e) {</span>
<a href="#l13.822"></a><span id="l13.822">             this.releaseTransaction(e);</span>
<a href="#l13.823"></a><span id="l13.823">             throw e;</span>
<a href="#l13.824"></a><span id="l13.824">         }</span>
<a href="#l13.825"></a><span id="l13.825">         this.releaseTransaction();</span>
<a href="#l13.826"></a><span id="l13.826"> </span>
<a href="#l13.827"></a><span id="l13.827">         delete this.mItemCache[aID];</span>
<a href="#l13.828"></a><span id="l13.828" class="difflineat">@@ -2240,17 +2474,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.829"></a><span id="l13.829">     /**</span>
<a href="#l13.830"></a><span id="l13.830">      * Releases one level of transactions for this calendar.</span>
<a href="#l13.831"></a><span id="l13.831">      *</span>
<a href="#l13.832"></a><span id="l13.832">      * @param err       (optional) If set, the transaction is set to fail when</span>
<a href="#l13.833"></a><span id="l13.833">      *                    the count reaches zero.</span>
<a href="#l13.834"></a><span id="l13.834">      */</span>
<a href="#l13.835"></a><span id="l13.835">     releaseTransaction: function cSC_releaseTransaction(err) {</span>
<a href="#l13.836"></a><span id="l13.836">         if (err) {</span>
<a href="#l13.837"></a><span id="l13.837" class="difflineminus">-            cal.ERROR(&quot;DB error: &quot; + this.mDB.lastErrorString + &quot;\nexc: &quot; + err);</span>
<a href="#l13.838"></a><span id="l13.838" class="difflineplus">+            cal.ERROR(&quot;[calStorageCalendar] DB error: &quot; + this.mDB.lastErrorString + &quot;\nexc: &quot; + err);</span>
<a href="#l13.839"></a><span id="l13.839">             this.mDB.rollbackTransaction();</span>
<a href="#l13.840"></a><span id="l13.840">         } else {</span>
<a href="#l13.841"></a><span id="l13.841">             this.mDB.commitTransaction();</span>
<a href="#l13.842"></a><span id="l13.842">         }</span>
<a href="#l13.843"></a><span id="l13.843">     },</span>
<a href="#l13.844"></a><span id="l13.844"> </span>
<a href="#l13.845"></a><span id="l13.845">     //</span>
<a href="#l13.846"></a><span id="l13.846">     // calISyncWriteCalendar interface</span>
<a href="#l13.847"></a><span id="l13.847" class="difflineat">@@ -2360,17 +2594,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l13.848"></a><span id="l13.848">                     logMessage += &quot;\nLast Statement param [&quot; + param + &quot;]: &quot; + this.mLastStatement.params[param];</span>
<a href="#l13.849"></a><span id="l13.849">                 }</span>
<a href="#l13.850"></a><span id="l13.850">             }</span>
<a href="#l13.851"></a><span id="l13.851">         }</span>
<a href="#l13.852"></a><span id="l13.852"> </span>
<a href="#l13.853"></a><span id="l13.853">         if (exception) {</span>
<a href="#l13.854"></a><span id="l13.854">             logMessage += &quot;\nException: &quot; + exception;</span>
<a href="#l13.855"></a><span id="l13.855">         }</span>
<a href="#l13.856"></a><span id="l13.856" class="difflineminus">-        cal.ERROR(logMessage + &quot;\n&quot; + STACK(10));</span>
<a href="#l13.857"></a><span id="l13.857" class="difflineplus">+        cal.ERROR(&quot;[calStorageCalendar] &quot; + logMessage + &quot;\n&quot; + cal.STACK(10));</span>
<a href="#l13.858"></a><span id="l13.858">     }</span>
<a href="#l13.859"></a><span id="l13.859"> };</span>
<a href="#l13.860"></a><span id="l13.860"> </span>
<a href="#l13.861"></a><span id="l13.861"> /** Module Registration */</span>
<a href="#l13.862"></a><span id="l13.862"> const scriptLoadOrder = [</span>
<a href="#l13.863"></a><span id="l13.863">     &quot;calUtils.js&quot;,</span>
<a href="#l13.864"></a><span id="l13.864"> ];</span>
<a href="#l13.865"></a><span id="l13.865"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -99,17 +99,17 @@</span>
<a href="#l14.4"></a><span id="l14.4">  */</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6"> Components.utils.import(&quot;resource:///modules/Services.jsm&quot;);</span>
<a href="#l14.7"></a><span id="l14.7"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l14.8"></a><span id="l14.8"> Components.utils.import(&quot;resource://calendar/modules/calStorageHelpers.jsm&quot;);</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> // The current database version. Be sure to increment this when you create a new</span>
<a href="#l14.11"></a><span id="l14.11"> // updater.</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-var DB_SCHEMA_VERSION = 19;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+var DB_SCHEMA_VERSION = 20;</span>
<a href="#l14.14"></a><span id="l14.14"> </span>
<a href="#l14.15"></a><span id="l14.15"> var EXPORTED_SYMBOLS = [&quot;DB_SCHEMA_VERSION&quot;, &quot;getSql&quot;, &quot;getAllSql&quot;, &quot;getSqlTable&quot;, &quot;upgradeDB&quot;, &quot;backupDB&quot;];</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17"> /**</span>
<a href="#l14.18"></a><span id="l14.18">  * Gets the SQL for the given table data and table name. This can be both a real</span>
<a href="#l14.19"></a><span id="l14.19">  * table or the name of an index. Indexes must contain the idx_ prefix.</span>
<a href="#l14.20"></a><span id="l14.20">  *</span>
<a href="#l14.21"></a><span id="l14.21">  * @param tblName       The name of the table or index to retrieve sql for</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -1326,8 +1326,29 @@ upgrade.v19 = function upgrade_v19(db, v</span>
<a href="#l14.23"></a><span id="l14.23">         }</span>
<a href="#l14.24"></a><span id="l14.24">         setDbVersionAndCommit(db, 19);</span>
<a href="#l14.25"></a><span id="l14.25">     } catch (e) {</span>
<a href="#l14.26"></a><span id="l14.26">         throw reportErrorAndRollback(db, e);</span>
<a href="#l14.27"></a><span id="l14.27">     }</span>
<a href="#l14.28"></a><span id="l14.28"> </span>
<a href="#l14.29"></a><span id="l14.29">     return tbl;</span>
<a href="#l14.30"></a><span id="l14.30"> };</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+/**</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+ * Bug 380060 - Offline Sync feature for calendar</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+ * Setting a offline_journal column in cal_events tables</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+ * r=philipp, p=redDragon</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+ */</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+upgrade.v20 = function upgrade_v20(db,version){</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+    let tbl = upgrade.v19(version&lt;19 &amp;&amp; db, version);</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+    LOGdb(db, &quot;Storage: Upgrading to v20&quot;);</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+    beginTransaction(db);</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+    try{</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+        //Adding a offline_journal column</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+        for each (let tblName in [&quot;cal_events&quot;, &quot;cal_todos&quot;]) {</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+            addColumn(tbl, tblName, [&quot;offline_journal&quot;], &quot;INTEGER&quot;, db);</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+        }</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+        setDbVersionAndCommit(db, 20);</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+    } catch (e) {</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+        throw reportErrorAndRollback(db,e);</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+    }</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+    return tbl;</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

