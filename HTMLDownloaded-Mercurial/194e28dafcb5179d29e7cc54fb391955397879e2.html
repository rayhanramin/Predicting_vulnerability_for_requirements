<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24094:194e28dafcb5179d29e7cc54fb391955397879e2</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 194e28dafcb5179d29e7cc54fb391955397879e2" />
<meta property="og:url" content="/comm-central/rev/194e28dafcb5179d29e7cc54fb391955397879e2" />
<meta property="og:description" content="Bug 1466705 - Restore IMAP and NNTP subscribe to use a C++ nsITreeView. r=jorgk,aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 194e28dafcb5179d29e7cc54fb391955397879e2 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/194e28dafcb5179d29e7cc54fb391955397879e2">shortlog</a> |
<a href="/comm-central/log/194e28dafcb5179d29e7cc54fb391955397879e2">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/194e28dafcb5179d29e7cc54fb391955397879e2">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/194e28dafcb5179d29e7cc54fb391955397879e2">files</a> |
changeset |
<a href="/comm-central/raw-rev/194e28dafcb5179d29e7cc54fb391955397879e2">raw</a>  | <a href="/comm-central/archive/194e28dafcb5179d29e7cc54fb391955397879e2.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1466705">Bug 1466705</a> - Restore IMAP and NNTP subscribe to use a C++ nsITreeView. r=jorgk,aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#115;&#104;&#117;&#97;&#32;&#67;&#114;&#97;&#110;&#109;&#101;&#114;&#32;&#60;&#80;&#105;&#100;&#103;&#101;&#111;&#116;&#49;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;&#44;&#32;&#97;&#99;&#101;&#109;&#97;&#110;&#32;&#60;&#97;&#99;&#101;&#108;&#105;&#115;&#116;&#115;&#64;&#97;&#116;&#108;&#97;&#115;&#46;&#115;&#107;&#62;&#32;&#97;&#110;&#100;&#32;&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 24 Mar 2011 12:24:48 -0400</td></tr>

<tr>
 <td>changeset 24094</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/194e28dafcb5179d29e7cc54fb391955397879e2">194e28dafcb5179d29e7cc54fb391955397879e2</a></td>
</tr>



<tr>
<td>parent 24093</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/829b7ff18e5b385deec7bc1fc72ed1dc305f539e">829b7ff18e5b385deec7bc1fc72ed1dc305f539e</a>
</td>
</tr>

<tr>
<td>child 24095</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ce10f3ede4cc25cfc77b80b6f9203f13bcc22080">ce10f3ede4cc25cfc77b80b6f9203f13bcc22080</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=194e28dafcb5179d29e7cc54fb391955397879e2">14528</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 16 Jun 2018 22:51:40 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@02374870bf1a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=02374870bf1a3bcca70b1f836080a131a439eada">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=02374870bf1a3bcca70b1f836080a131a439eada&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=02374870bf1a3bcca70b1f836080a131a439eada&newProject=comm-central&newRevision=194e28dafcb5179d29e7cc54fb391955397879e2&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=02374870bf1a3bcca70b1f836080a131a439eada&newProject=comm-central&newRevision=194e28dafcb5179d29e7cc54fb391955397879e2&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=02374870bf1a3bcca70b1f836080a131a439eada&newProject=comm-central&newRevision=194e28dafcb5179d29e7cc54fb391955397879e2&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a>, <a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1466705">1466705</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1466705">Bug 1466705</a> - Restore IMAP and NNTP subscribe to use a C++ nsITreeView. r=jorgk,aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/194e28dafcb5179d29e7cc54fb391955397879e2/mail/locales/en-US/chrome/messenger/subscribe.properties">mail/locales/en-US/chrome/messenger/subscribe.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/194e28dafcb5179d29e7cc54fb391955397879e2/mail/locales/en-US/chrome/messenger/subscribe.properties">file</a> |
<a href="/comm-central/annotate/194e28dafcb5179d29e7cc54fb391955397879e2/mail/locales/en-US/chrome/messenger/subscribe.properties">annotate</a> |
<a href="/comm-central/diff/194e28dafcb5179d29e7cc54fb391955397879e2/mail/locales/en-US/chrome/messenger/subscribe.properties">diff</a> |
<a href="/comm-central/comparison/194e28dafcb5179d29e7cc54fb391955397879e2/mail/locales/en-US/chrome/messenger/subscribe.properties">comparison</a> |
<a href="/comm-central/log/194e28dafcb5179d29e7cc54fb391955397879e2/mail/locales/en-US/chrome/messenger/subscribe.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/content/subscribe.js">mailnews/base/content/subscribe.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/content/subscribe.js">file</a> |
<a href="/comm-central/annotate/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/content/subscribe.js">annotate</a> |
<a href="/comm-central/diff/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/content/subscribe.js">diff</a> |
<a href="/comm-central/comparison/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/content/subscribe.js">comparison</a> |
<a href="/comm-central/log/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/content/subscribe.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/content/subscribe.xul">mailnews/base/content/subscribe.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/content/subscribe.xul">file</a> |
<a href="/comm-central/annotate/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/content/subscribe.xul">annotate</a> |
<a href="/comm-central/diff/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/content/subscribe.xul">diff</a> |
<a href="/comm-central/comparison/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/content/subscribe.xul">comparison</a> |
<a href="/comm-central/log/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/content/subscribe.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/public/nsISubscribableServer.idl">mailnews/base/public/nsISubscribableServer.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/public/nsISubscribableServer.idl">file</a> |
<a href="/comm-central/annotate/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/public/nsISubscribableServer.idl">annotate</a> |
<a href="/comm-central/diff/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/public/nsISubscribableServer.idl">diff</a> |
<a href="/comm-central/comparison/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/public/nsISubscribableServer.idl">comparison</a> |
<a href="/comm-central/log/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/public/nsISubscribableServer.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/src/nsSubscribableServer.cpp">mailnews/base/src/nsSubscribableServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/src/nsSubscribableServer.cpp">file</a> |
<a href="/comm-central/annotate/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/src/nsSubscribableServer.cpp">annotate</a> |
<a href="/comm-central/diff/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/src/nsSubscribableServer.cpp">diff</a> |
<a href="/comm-central/comparison/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/src/nsSubscribableServer.cpp">comparison</a> |
<a href="/comm-central/log/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/src/nsSubscribableServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/src/nsSubscribableServer.h">mailnews/base/src/nsSubscribableServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/src/nsSubscribableServer.h">file</a> |
<a href="/comm-central/annotate/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/src/nsSubscribableServer.h">annotate</a> |
<a href="/comm-central/diff/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/src/nsSubscribableServer.h">diff</a> |
<a href="/comm-central/comparison/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/src/nsSubscribableServer.h">comparison</a> |
<a href="/comm-central/log/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/base/src/nsSubscribableServer.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/imap/src/nsImapIncomingServer.cpp">mailnews/imap/src/nsImapIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/imap/src/nsImapIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/imap/src/nsImapIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/imap/src/nsImapIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/imap/src/nsImapIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/imap/src/nsImapIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/news/src/nsNntpIncomingServer.cpp">mailnews/news/src/nsNntpIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/news/src/nsNntpIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/news/src/nsNntpIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/news/src/nsNntpIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/news/src/nsNntpIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/194e28dafcb5179d29e7cc54fb391955397879e2/mailnews/news/src/nsNntpIncomingServer.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/subscribe.properties</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/subscribe.properties</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -4,8 +4,10 @@</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> subscribeLabel-nntp=Select the newsgroups to subscribe to:</span>
<a href="#l1.6"></a><span id="l1.6"> subscribeLabel-imap=Select the folders to subscribe to:</span>
<a href="#l1.7"></a><span id="l1.7"> currentListTab-nntp.label=Current Group List</span>
<a href="#l1.8"></a><span id="l1.8"> currentListTab-nntp.accesskey=L</span>
<a href="#l1.9"></a><span id="l1.9"> currentListTab-imap.label=Folder List</span>
<a href="#l1.10"></a><span id="l1.10"> currentListTab-imap.accesskey=L</span>
<a href="#l1.11"></a><span id="l1.11"> pleaseWaitString=Please waitâ€¦</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+offlineState=You are offline. Items could not be retrieved from the server.</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+errorPopulating=Error retrieving items from the server.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/content/subscribe.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/content/subscribe.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -13,22 +13,20 @@ var gChangeTable = {};</span>
<a href="#l2.4"></a><span id="l2.4"> var gServerURI = null;</span>
<a href="#l2.5"></a><span id="l2.5"> var gSubscribableServer = null;</span>
<a href="#l2.6"></a><span id="l2.6"> var gNameField = null;</span>
<a href="#l2.7"></a><span id="l2.7"> var gNameFieldLabel = null;</span>
<a href="#l2.8"></a><span id="l2.8"> var gStatusFeedback;</span>
<a href="#l2.9"></a><span id="l2.9"> var gSubscribeDeck = null;</span>
<a href="#l2.10"></a><span id="l2.10"> var gSearchView = null;</span>
<a href="#l2.11"></a><span id="l2.11"> var gSearchTreeBoxObject = null;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-var gItemsFound = new Map();</span>
<a href="#l2.13"></a><span id="l2.13"> var gSubscribeBundle;</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> function Stop()</span>
<a href="#l2.16"></a><span id="l2.16"> {</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-  //dump(&quot;Stop()\n&quot;)</span>
<a href="#l2.18"></a><span id="l2.18">   if (gSubscribableServer) {</span>
<a href="#l2.19"></a><span id="l2.19">     gSubscribableServer.stopPopulating(msgWindow);</span>
<a href="#l2.20"></a><span id="l2.20">   }</span>
<a href="#l2.21"></a><span id="l2.21"> }</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23"> function SetServerTypeSpecificTextValues()</span>
<a href="#l2.24"></a><span id="l2.24"> {</span>
<a href="#l2.25"></a><span id="l2.25">   if (!gServerURI)</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineat">@@ -54,131 +52,85 @@ function onServerClick(aFolder)</span>
<a href="#l2.27"></a><span id="l2.27">   let serverMenu = document.getElementById(&quot;serverMenu&quot;);</span>
<a href="#l2.28"></a><span id="l2.28">   serverMenu.menupopup.selectFolder(aFolder);</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30">   SetServerTypeSpecificTextValues();</span>
<a href="#l2.31"></a><span id="l2.31">   ShowCurrentList();</span>
<a href="#l2.32"></a><span id="l2.32"> }</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34"> var MySubscribeListener = {</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-  OnItemDiscovered: function(aPath, aSubscribable) {</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-    if (!gItemsFound.has(aPath))</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-      gItemsFound.set(aPath, gSubscribableServer.getLeafName(aPath));</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-  },</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-</span>
<a href="#l2.40"></a><span id="l2.40">   OnDonePopulating: function() {</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-    createSubscribeTree();</span>
<a href="#l2.42"></a><span id="l2.42">     gStatusFeedback._stopMeteors();</span>
<a href="#l2.43"></a><span id="l2.43">     document.getElementById(&quot;stopButton&quot;).disabled = true;</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-// XXX what does this do? Is this needed without RDF/template?</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-    // Only re-root the tree, if it is null.</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-    // Otherwise, we are in here because we are populating a part of the tree.</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-/*    let refValue = gSubscribeTree.getAttribute('ref');</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-    if (!refValue) {</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-      //dump(&quot;root subscribe tree at: &quot;+ gServerURI +&quot;\n&quot;);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-      gSubscribeTree.database.AddDataSource(subscribeDS);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-      gSubscribeTree.setAttribute('ref',gServerURI);</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-    }</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-*/</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-</span>
<a href="#l2.56"></a><span id="l2.56">     document.getElementById(&quot;refreshButton&quot;).disabled = false;</span>
<a href="#l2.57"></a><span id="l2.57">     document.getElementById(&quot;currentListTab&quot;).disabled = false;</span>
<a href="#l2.58"></a><span id="l2.58">     document.getElementById(&quot;newGroupsTab&quot;).disabled = false;</span>
<a href="#l2.59"></a><span id="l2.59">   }</span>
<a href="#l2.60"></a><span id="l2.60"> };</span>
<a href="#l2.61"></a><span id="l2.61"> </span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-function setSubscribableCellState(aSubscribeCell, aSubscribed, aSubscribable) {</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-  aSubscribeCell.setAttribute(&quot;properties&quot;, &quot;subscribed-&quot; + aSubscribed +</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-                                            &quot; subscribable-&quot; + aSubscribable);</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-  aSubscribeCell.setAttribute(&quot;value&quot;, aSubscribed);</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-}</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-/**</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">- * Populate the subscribe tree with the items found on the server.</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">- */</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-function createSubscribeTree() {</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-  let items = toArray(gItemsFound.entries());</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-  items.sort((a,b) =&gt; a[0].localeCompare(b[0]));</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-  for (let [path, name] of items) {</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-    let subscribed = gSubscribableServer.isSubscribed(path);</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-    let subscribable = gSubscribableServer.isSubscribable(path);</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-    let itemEl = document.createElement(&quot;treeitem&quot;);</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-    let rowEl = document.createElement(&quot;treerow&quot;);</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-    let nameEl = document.createElement(&quot;treecell&quot;);</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-    let subscribeEl = document.createElement(&quot;treecell&quot;);</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-    nameEl.setAttribute(&quot;label&quot;, name);</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-    nameEl.setAttribute(&quot;value&quot;, path);</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-    nameEl.setAttribute(&quot;properties&quot;, &quot;serverType-&quot; + gSubscribableServer.type +</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-                                      &quot; subscribable-&quot; + subscribable);</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-    setSubscribableCellState(subscribeEl, subscribed, subscribable);</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-    rowEl.appendChild(nameEl);</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-    rowEl.appendChild(subscribeEl);</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-    itemEl.appendChild(rowEl);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-    gSubscribeBody.appendChild(itemEl);</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">- }</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-}</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-</span>
<a href="#l2.94"></a><span id="l2.94"> function SetUpTree(forceToServer, getOnlyNew)</span>
<a href="#l2.95"></a><span id="l2.95"> {</span>
<a href="#l2.96"></a><span id="l2.96">   if (!gServerURI)</span>
<a href="#l2.97"></a><span id="l2.97">     return;</span>
<a href="#l2.98"></a><span id="l2.98"> </span>
<a href="#l2.99"></a><span id="l2.99">   var server = MailUtils.getFolderForURI(gServerURI, true).server;</span>
<a href="#l2.100"></a><span id="l2.100">   try</span>
<a href="#l2.101"></a><span id="l2.101">   {</span>
<a href="#l2.102"></a><span id="l2.102">     CleanUpSearchView();</span>
<a href="#l2.103"></a><span id="l2.103">     gSubscribableServer = server.QueryInterface(Ci.nsISubscribableServer);</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-    gSubscribeTree.setAttribute('ref', ''); // XXX: what is this?</span>
<a href="#l2.105"></a><span id="l2.105"> </span>
<a href="#l2.106"></a><span id="l2.106">     // enable (or disable) the search related UI</span>
<a href="#l2.107"></a><span id="l2.107">     EnableSearchUI();</span>
<a href="#l2.108"></a><span id="l2.108"> </span>
<a href="#l2.109"></a><span id="l2.109">     // clear out the text field when switching server</span>
<a href="#l2.110"></a><span id="l2.110">     gNameField.value = &quot;&quot;;</span>
<a href="#l2.111"></a><span id="l2.111"> </span>
<a href="#l2.112"></a><span id="l2.112">     // since there is no text, switch to the non-search view...</span>
<a href="#l2.113"></a><span id="l2.113">     SwitchToNormalView();</span>
<a href="#l2.114"></a><span id="l2.114"> </span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-    // Clear the subscribe tree.</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-    while (gSubscribeBody.hasChildNodes())</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-      gSubscribeBody.lastChild.remove();</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-    gSubscribableServer.subscribeListener = MySubscribeListener;</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+    if (!gSubscribableServer.subscribeListener) {</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+      gSubscribeTree.view = gSubscribableServer.folderView;</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+      gSubscribableServer.subscribeListener = MySubscribeListener;</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+    }</span>
<a href="#l2.124"></a><span id="l2.124"> </span>
<a href="#l2.125"></a><span id="l2.125">     var currentListTab = document.getElementById(&quot;currentListTab&quot;);</span>
<a href="#l2.126"></a><span id="l2.126">     if (currentListTab.selected)</span>
<a href="#l2.127"></a><span id="l2.127">       document.getElementById(&quot;newGroupsTab&quot;).disabled = true;</span>
<a href="#l2.128"></a><span id="l2.128">     else</span>
<a href="#l2.129"></a><span id="l2.129">       currentListTab.disabled = true;</span>
<a href="#l2.130"></a><span id="l2.130"> </span>
<a href="#l2.131"></a><span id="l2.131">     document.getElementById(&quot;refreshButton&quot;).disabled = true;</span>
<a href="#l2.132"></a><span id="l2.132"> </span>
<a href="#l2.133"></a><span id="l2.133">     gStatusFeedback._startMeteors();</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+    gStatusFeedback.setStatusString(&quot;&quot;);</span>
<a href="#l2.135"></a><span id="l2.135">     gStatusFeedback.showStatusString(gSubscribeBundle.getString(&quot;pleaseWaitString&quot;));</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-    document.getElementById(&quot;stopButton&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+    document.getElementById(&quot;stopButton&quot;).disabled = false;</span>
<a href="#l2.138"></a><span id="l2.138"> </span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-    gItemsFound.clear();</span>
<a href="#l2.140"></a><span id="l2.140">     gSubscribableServer.startPopulating(msgWindow, forceToServer, getOnlyNew);</span>
<a href="#l2.141"></a><span id="l2.141">   }</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-  catch (ex)</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+  catch (e)</span>
<a href="#l2.144"></a><span id="l2.144">   {</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-    dump(&quot;failed to populate subscribe ds: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+    if (e.result == 0x80550014) {  // NS_MSG_ERROR_OFFLINE</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+      gStatusFeedback.setStatusString(gSubscribeBundle.getString(&quot;offlineState&quot;));</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+    } else {</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+      Cu.reportError(&quot;Failed to populate subscribe tree: &quot; + e);</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+      gStatusFeedback.setStatusString(gSubscribeBundle.getString(&quot;errorPopulating&quot;));</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+    }</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+    Stop();</span>
<a href="#l2.153"></a><span id="l2.153">   }</span>
<a href="#l2.154"></a><span id="l2.154"> }</span>
<a href="#l2.155"></a><span id="l2.155"> </span>
<a href="#l2.156"></a><span id="l2.156"> </span>
<a href="#l2.157"></a><span id="l2.157"> function SubscribeOnUnload()</span>
<a href="#l2.158"></a><span id="l2.158"> {</span>
<a href="#l2.159"></a><span id="l2.159">   try {</span>
<a href="#l2.160"></a><span id="l2.160">     CleanUpSearchView();</span>
<a href="#l2.161"></a><span id="l2.161">   }</span>
<a href="#l2.162"></a><span id="l2.162">   catch (ex) {</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-    dump(&quot;failed to remove the subscribe ds: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+    dump(&quot;Failed to remove the subscribe tree: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l2.165"></a><span id="l2.165">   }</span>
<a href="#l2.166"></a><span id="l2.166"> }</span>
<a href="#l2.167"></a><span id="l2.167"> </span>
<a href="#l2.168"></a><span id="l2.168"> function EnableSearchUI()</span>
<a href="#l2.169"></a><span id="l2.169"> {</span>
<a href="#l2.170"></a><span id="l2.170">   if (gSubscribableServer.supportsSubscribeSearch) {</span>
<a href="#l2.171"></a><span id="l2.171">     gNameField.removeAttribute('disabled');</span>
<a href="#l2.172"></a><span id="l2.172">     gNameFieldLabel.removeAttribute('disabled');</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineat">@@ -186,17 +138,16 @@ function EnableSearchUI()</span>
<a href="#l2.174"></a><span id="l2.174">   else {</span>
<a href="#l2.175"></a><span id="l2.175">     gNameField.setAttribute('disabled',true);</span>
<a href="#l2.176"></a><span id="l2.176">     gNameFieldLabel.setAttribute('disabled',true);</span>
<a href="#l2.177"></a><span id="l2.177">   }</span>
<a href="#l2.178"></a><span id="l2.178"> }</span>
<a href="#l2.179"></a><span id="l2.179"> </span>
<a href="#l2.180"></a><span id="l2.180"> function SubscribeOnLoad()</span>
<a href="#l2.181"></a><span id="l2.181"> {</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-  //dump(&quot;SubscribeOnLoad()\n&quot;);</span>
<a href="#l2.183"></a><span id="l2.183">   gSubscribeBundle = document.getElementById(&quot;bundle_subscribe&quot;);</span>
<a href="#l2.184"></a><span id="l2.184"> </span>
<a href="#l2.185"></a><span id="l2.185">   gSubscribeTree = document.getElementById(&quot;subscribeTree&quot;);</span>
<a href="#l2.186"></a><span id="l2.186">   gSubscribeBody = document.getElementById(&quot;subscribeTreeBody&quot;);</span>
<a href="#l2.187"></a><span id="l2.187">   gSearchTree = document.getElementById(&quot;searchTree&quot;);</span>
<a href="#l2.188"></a><span id="l2.188">   gSearchTreeBoxObject = document.getElementById(&quot;searchTree&quot;).treeBoxObject;</span>
<a href="#l2.189"></a><span id="l2.189">   gNameField = document.getElementById(&quot;namefield&quot;);</span>
<a href="#l2.190"></a><span id="l2.190">   gNameFieldLabel = document.getElementById(&quot;namefieldlabel&quot;);</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineat">@@ -259,17 +210,16 @@ function SubscribeOnLoad()</span>
<a href="#l2.192"></a><span id="l2.192"> </span>
<a href="#l2.193"></a><span id="l2.193">   ShowCurrentList();</span>
<a href="#l2.194"></a><span id="l2.194"> </span>
<a href="#l2.195"></a><span id="l2.195">   gNameField.focus();</span>
<a href="#l2.196"></a><span id="l2.196"> }</span>
<a href="#l2.197"></a><span id="l2.197"> </span>
<a href="#l2.198"></a><span id="l2.198"> function subscribeOK()</span>
<a href="#l2.199"></a><span id="l2.199"> {</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-  //dump(&quot;in subscribeOK()\n&quot;)</span>
<a href="#l2.201"></a><span id="l2.201">   if (top.okCallback) {</span>
<a href="#l2.202"></a><span id="l2.202">     top.okCallback(top.gChangeTable);</span>
<a href="#l2.203"></a><span id="l2.203">   }</span>
<a href="#l2.204"></a><span id="l2.204">   Stop();</span>
<a href="#l2.205"></a><span id="l2.205">   if (gSubscribableServer) {</span>
<a href="#l2.206"></a><span id="l2.206">     gSubscribableServer.subscribeCleanup();</span>
<a href="#l2.207"></a><span id="l2.207">   }</span>
<a href="#l2.208"></a><span id="l2.208">   return true;</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineat">@@ -279,42 +229,21 @@ function subscribeCancel()</span>
<a href="#l2.210"></a><span id="l2.210"> {</span>
<a href="#l2.211"></a><span id="l2.211">   Stop();</span>
<a href="#l2.212"></a><span id="l2.212">   if (gSubscribableServer) {</span>
<a href="#l2.213"></a><span id="l2.213">     gSubscribableServer.subscribeCleanup();</span>
<a href="#l2.214"></a><span id="l2.214">   }</span>
<a href="#l2.215"></a><span id="l2.215">   return true;</span>
<a href="#l2.216"></a><span id="l2.216"> }</span>
<a href="#l2.217"></a><span id="l2.217"> </span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-function SetState(name, state, aRow)</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+function SetState(name, state)</span>
<a href="#l2.220"></a><span id="l2.220"> {</span>
<a href="#l2.221"></a><span id="l2.221">   var changed = gSubscribableServer.setState(name, state);</span>
<a href="#l2.222"></a><span id="l2.222">   if (changed)</span>
<a href="#l2.223"></a><span id="l2.223">     StateChanged(name, state);</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineminus">-</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineminus">-  let subscribeCell;</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineminus">-  if (aRow === undefined) {</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineminus">-    // XXX This won't work when multiple levels of children are implemented</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineminus">-    for (let row of gSubscribeBody.children) {</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineminus">-      if (row.children[0].children[0].getAttribute(&quot;value&quot;) == name) {</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineminus">-        subscribeCell = row;</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineminus">-        break;</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineminus">-      }</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-    }</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-  } else {</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">-    subscribeCell = gSubscribeBody.children[aRow];</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">-  }</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">-  setSubscribableCellState(subscribeCell.children[0].children[1], state, true);</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-}</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">-function changeTableRecord(server, name, state)</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-{</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineminus">-  this.server = server;</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineminus">-  this.name = name;</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineminus">-  this.state = state;</span>
<a href="#l2.245"></a><span id="l2.245"> }</span>
<a href="#l2.246"></a><span id="l2.246"> </span>
<a href="#l2.247"></a><span id="l2.247"> function StateChanged(name,state)</span>
<a href="#l2.248"></a><span id="l2.248"> {</span>
<a href="#l2.249"></a><span id="l2.249">   if (gServerURI in gChangeTable) {</span>
<a href="#l2.250"></a><span id="l2.250">     if (name in gChangeTable[gServerURI]) {</span>
<a href="#l2.251"></a><span id="l2.251">       var oldValue = gChangeTable[gServerURI][name];</span>
<a href="#l2.252"></a><span id="l2.252">       if (oldValue != state)</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineat">@@ -413,17 +342,16 @@ function SetSubscribeState(state)</span>
<a href="#l2.254"></a><span id="l2.254">   catch (ex) {</span>
<a href="#l2.255"></a><span id="l2.255">     dump(&quot;SetSubscribedState failed:  &quot; + ex + &quot;\n&quot;);</span>
<a href="#l2.256"></a><span id="l2.256">   }</span>
<a href="#l2.257"></a><span id="l2.257"> }</span>
<a href="#l2.258"></a><span id="l2.258"> </span>
<a href="#l2.259"></a><span id="l2.259"> function ReverseStateFromNode(row)</span>
<a href="#l2.260"></a><span id="l2.260"> {</span>
<a href="#l2.261"></a><span id="l2.261">   let name = gSubscribeTree.view.getCellValue(row, gSubscribeTree.columns[&quot;nameColumn&quot;]);</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineminus">-</span>
<a href="#l2.263"></a><span id="l2.263">   SetState(name, !gSubscribableServer.isSubscribed(name), row);</span>
<a href="#l2.264"></a><span id="l2.264"> }</span>
<a href="#l2.265"></a><span id="l2.265"> </span>
<a href="#l2.266"></a><span id="l2.266"> function SubscribeOnClick(event)</span>
<a href="#l2.267"></a><span id="l2.267"> {</span>
<a href="#l2.268"></a><span id="l2.268">   // we only care about button 0 (left click) events</span>
<a href="#l2.269"></a><span id="l2.269">   if (event.button != 0 || event.originalTarget.localName != &quot;treechildren&quot;)</span>
<a href="#l2.270"></a><span id="l2.270">    return;</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineat">@@ -438,31 +366,19 @@ function SubscribeOnClick(event)</span>
<a href="#l2.272"></a><span id="l2.272">     // that isn't a container</span>
<a href="#l2.273"></a><span id="l2.273">     if (!gSubscribeTree.view.isContainer(row.value)) {</span>
<a href="#l2.274"></a><span id="l2.274">       ReverseStateFromNode(row.value);</span>
<a href="#l2.275"></a><span id="l2.275">       return;</span>
<a href="#l2.276"></a><span id="l2.276">     }</span>
<a href="#l2.277"></a><span id="l2.277">   }</span>
<a href="#l2.278"></a><span id="l2.278">   else if (event.detail == 1)</span>
<a href="#l2.279"></a><span id="l2.279">   {</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineminus">-    if (obj.value == &quot;twisty&quot;) {</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-        if (gSubscribeTree.view.isContainerOpen(row.value)) {</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineminus">-          var uri = gSubscribeTree.builderView.getResourceAtIndex(row.value).Value;</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineminus">-</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineminus">-          gStatusFeedback._startMeteors();</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-          gStatusFeedback.showStatusString(gSubscribeBundle.getString(&quot;pleaseWaitString&quot;));</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineminus">-</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineminus">-          gSubscribableServer.startPopulatingWithUri(msgWindow, true /* force to server */, uri);</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineminus">-        }</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineminus">-    }</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineminus">-    else {</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineminus">-      // if the user single clicks on the subscribe check box, we handle it here</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineminus">-      if (col.value.id == &quot;subscribedColumn&quot;)</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-        ReverseStateFromNode(row.value);</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineminus">-    }</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+    // if the user single clicks on the subscribe check box, we handle it here</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineplus">+    if (col.value.id == &quot;subscribedColumn&quot;)</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+      ReverseStateFromNode(row.value);</span>
<a href="#l2.298"></a><span id="l2.298">   }</span>
<a href="#l2.299"></a><span id="l2.299"> }</span>
<a href="#l2.300"></a><span id="l2.300"> </span>
<a href="#l2.301"></a><span id="l2.301"> function Refresh()</span>
<a href="#l2.302"></a><span id="l2.302"> {</span>
<a href="#l2.303"></a><span id="l2.303">   // clear out the textfield's entry</span>
<a href="#l2.304"></a><span id="l2.304">   gNameField.value = &quot;&quot;;</span>
<a href="#l2.305"></a><span id="l2.305"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/content/subscribe.xul</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/content/subscribe.xul</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -2,16 +2,17 @@</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> &lt;?xml-stylesheet href=&quot;chrome://messenger/skin/subscribe.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l3.10"></a><span id="l3.10"> &lt;!-- &lt;?xml-stylesheet href=&quot;chrome://messenger/skin/messenger.css&quot; type=&quot;text/css&quot;?&gt; --&gt;</span>
<a href="#l3.11"></a><span id="l3.11"> &lt;?xml-stylesheet href=&quot;chrome://messenger/skin/folderMenus.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://messenger/content/bindings.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l3.13"></a><span id="l3.13"> </span>
<a href="#l3.14"></a><span id="l3.14"> &lt;!DOCTYPE window SYSTEM &quot;chrome://messenger/locale/subscribe.dtd&quot;&gt;</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16"> &lt;dialog id=&quot;subscribeWindow&quot;</span>
<a href="#l3.17"></a><span id="l3.17">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l3.18"></a><span id="l3.18">         title=&quot;&amp;subscribeDialog.title;&quot;</span>
<a href="#l3.19"></a><span id="l3.19">         style=&quot;width: 44em; height: 33em;&quot;</span>
<a href="#l3.20"></a><span id="l3.20">         persist=&quot;width height screenX screenY&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/public/nsISubscribableServer.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/public/nsISubscribableServer.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -5,28 +5,32 @@</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> interface nsIMsgWindow;</span>
<a href="#l4.8"></a><span id="l4.8"> interface nsIMsgIncomingServer;</span>
<a href="#l4.9"></a><span id="l4.9"> interface nsIRDFResource;</span>
<a href="#l4.10"></a><span id="l4.10"> interface nsIRDFNode;</span>
<a href="#l4.11"></a><span id="l4.11"> interface nsISimpleEnumerator;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+interface nsITreeView;</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14"> [scriptable, uuid(61a08c3a-1dd2-11b2-b64f-c4b2de1cf129)]</span>
<a href="#l4.15"></a><span id="l4.15"> interface nsISubscribeDataSource : nsISupports {</span>
<a href="#l4.16"></a><span id="l4.16">     readonly attribute boolean hasObservers;</span>
<a href="#l4.17"></a><span id="l4.17">     void NotifyObservers(in nsIRDFResource subject, in nsIRDFResource property, in nsIRDFNode object, in boolean isAssert, in boolean isChange);</span>
<a href="#l4.18"></a><span id="l4.18"> };</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+/**</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+ * A listener to receive notification of the subscribable folders of a server.</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+ */</span>
<a href="#l4.23"></a><span id="l4.23"> [scriptable, uuid(f337b84a-1dd1-11b2-97c7-fb8b2e3f2280)]</span>
<a href="#l4.24"></a><span id="l4.24"> interface nsISubscribeListener : nsISupports {</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-  // Announce a new item found on the server.</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-  void OnItemDiscovered(in AUTF8String aPath, in boolean aSubscribable);</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-  // Announce finish of discovering server items.</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+  /**</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+   * The server has finished finding all folders to subscribe to.</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+   */</span>
<a href="#l4.31"></a><span id="l4.31">   void OnDonePopulating();</span>
<a href="#l4.32"></a><span id="l4.32"> };</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34"> [scriptable, uuid(14b8597a-755b-4e93-b364-e0903801e6ea)]</span>
<a href="#l4.35"></a><span id="l4.35"> interface nsISubscribableServer : nsISupports {</span>
<a href="#l4.36"></a><span id="l4.36">   attribute nsISubscribeListener subscribeListener;</span>
<a href="#l4.37"></a><span id="l4.37">   attribute char delimiter;</span>
<a href="#l4.38"></a><span id="l4.38"> </span>
<a href="#l4.39"></a><span id="l4.39" class="difflineat">@@ -70,10 +74,11 @@ interface nsISubscribableServer : nsISup</span>
<a href="#l4.40"></a><span id="l4.40">    */</span>
<a href="#l4.41"></a><span id="l4.41">   nsISimpleEnumerator getChildren(in AUTF8String aPath);</span>
<a href="#l4.42"></a><span id="l4.42">   // if path is null, use the root</span>
<a href="#l4.43"></a><span id="l4.43">   AUTF8String getFirstChildURI(in AUTF8String path);</span>
<a href="#l4.44"></a><span id="l4.44"> </span>
<a href="#l4.45"></a><span id="l4.45">   // for searching</span>
<a href="#l4.46"></a><span id="l4.46">   void setSearchValue(in AString searchValue);</span>
<a href="#l4.47"></a><span id="l4.47">   readonly attribute boolean supportsSubscribeSearch;</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+  readonly attribute nsITreeView folderView;</span>
<a href="#l4.49"></a><span id="l4.49"> };</span>
<a href="#l4.50"></a><span id="l4.50"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/src/nsSubscribableServer.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/src/nsSubscribableServer.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -9,16 +9,18 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;rdf.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsRDFCID.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+#include &quot;nsTreeColumns.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+#include &quot;mozilla/dom/DataTransfer.h&quot;</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17"> nsSubscribableServer::nsSubscribableServer(void)</span>
<a href="#l5.18"></a><span id="l5.18"> {</span>
<a href="#l5.19"></a><span id="l5.19">     mDelimiter = '.';</span>
<a href="#l5.20"></a><span id="l5.20">     mShowFullName = true;</span>
<a href="#l5.21"></a><span id="l5.21">     mTreeRoot = nullptr;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -46,42 +48,46 @@ nsSubscribableServer::Init()</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24">     rv = mRDFService-&gt;GetLiteral(u&quot;false&quot;, getter_AddRefs(kFalseLiteral));</span>
<a href="#l5.25"></a><span id="l5.25">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.26"></a><span id="l5.26">     return NS_OK;</span>
<a href="#l5.27"></a><span id="l5.27"> }</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29"> nsSubscribableServer::~nsSubscribableServer(void)</span>
<a href="#l5.30"></a><span id="l5.30"> {</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-  mozilla::DebugOnly&lt;nsresult&gt; rv = FreeSubtree(mTreeRoot);</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  mozilla::DebugOnly&lt;nsresult&gt; rv = FreeRows();</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to free tree rows&quot;);</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+  rv = FreeSubtree(mTreeRoot);</span>
<a href="#l5.35"></a><span id="l5.35">   NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to free tree&quot;);</span>
<a href="#l5.36"></a><span id="l5.36"> }</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-NS_IMPL_ISUPPORTS(nsSubscribableServer, nsISubscribableServer)</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+NS_IMPL_ISUPPORTS(nsSubscribableServer, nsISubscribableServer, nsITreeView)</span>
<a href="#l5.40"></a><span id="l5.40"> </span>
<a href="#l5.41"></a><span id="l5.41"> NS_IMETHODIMP</span>
<a href="#l5.42"></a><span id="l5.42"> nsSubscribableServer::SetIncomingServer(nsIMsgIncomingServer *aServer)</span>
<a href="#l5.43"></a><span id="l5.43"> {</span>
<a href="#l5.44"></a><span id="l5.44">   if (!aServer) {</span>
<a href="#l5.45"></a><span id="l5.45">     mIncomingServerUri.AssignLiteral(&quot;&quot;);</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+    mServerType.Truncate();</span>
<a href="#l5.47"></a><span id="l5.47">     return NS_OK;</span>
<a href="#l5.48"></a><span id="l5.48">   }</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+  aServer-&gt;GetType(mServerType);</span>
<a href="#l5.50"></a><span id="l5.50"> </span>
<a href="#l5.51"></a><span id="l5.51">   // We intentionally do not store a pointer to the aServer here</span>
<a href="#l5.52"></a><span id="l5.52">   // as it would create reference loops, because nsIImapIncomingServer</span>
<a href="#l5.53"></a><span id="l5.53">   // and nsINntpIncomingServer keep a reference to an internal</span>
<a href="#l5.54"></a><span id="l5.54">   // nsISubscribableServer object.</span>
<a href="#l5.55"></a><span id="l5.55">   // We only need the URI of the server anyway.</span>
<a href="#l5.56"></a><span id="l5.56">   return aServer-&gt;GetServerURI(mIncomingServerUri);</span>
<a href="#l5.57"></a><span id="l5.57"> }</span>
<a href="#l5.58"></a><span id="l5.58"> </span>
<a href="#l5.59"></a><span id="l5.59"> NS_IMETHODIMP</span>
<a href="#l5.60"></a><span id="l5.60"> nsSubscribableServer::GetDelimiter(char *aDelimiter)</span>
<a href="#l5.61"></a><span id="l5.61"> {</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-  if (!aDelimiter) return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDelimiter);</span>
<a href="#l5.64"></a><span id="l5.64">   *aDelimiter = mDelimiter;</span>
<a href="#l5.65"></a><span id="l5.65">   return NS_OK;</span>
<a href="#l5.66"></a><span id="l5.66"> }</span>
<a href="#l5.67"></a><span id="l5.67"> </span>
<a href="#l5.68"></a><span id="l5.68"> NS_IMETHODIMP</span>
<a href="#l5.69"></a><span id="l5.69"> nsSubscribableServer::SetDelimiter(char aDelimiter)</span>
<a href="#l5.70"></a><span id="l5.70"> {</span>
<a href="#l5.71"></a><span id="l5.71">   mDelimiter = aDelimiter;</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineat">@@ -94,61 +100,53 @@ nsSubscribableServer::SetAsSubscribed(co</span>
<a href="#l5.73"></a><span id="l5.73">     nsresult rv = NS_OK;</span>
<a href="#l5.74"></a><span id="l5.74"> </span>
<a href="#l5.75"></a><span id="l5.75">     SubscribeTreeNode *node = nullptr;</span>
<a href="#l5.76"></a><span id="l5.76">     rv = FindAndCreateNode(path, &amp;node);</span>
<a href="#l5.77"></a><span id="l5.77">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.78"></a><span id="l5.78"> </span>
<a href="#l5.79"></a><span id="l5.79">     NS_ASSERTION(node,&quot;didn't find the node&quot;);</span>
<a href="#l5.80"></a><span id="l5.80">     if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-</span>
<a href="#l5.82"></a><span id="l5.82">     node-&gt;isSubscribable = true;</span>
<a href="#l5.83"></a><span id="l5.83">     node-&gt;isSubscribed = true;</span>
<a href="#l5.84"></a><span id="l5.84"> </span>
<a href="#l5.85"></a><span id="l5.85">     rv = NotifyChange(node, kNC_Subscribed, node-&gt;isSubscribed);</span>
<a href="#l5.86"></a><span id="l5.86">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.87"></a><span id="l5.87"> </span>
<a href="#l5.88"></a><span id="l5.88">     return rv;</span>
<a href="#l5.89"></a><span id="l5.89"> }</span>
<a href="#l5.90"></a><span id="l5.90"> </span>
<a href="#l5.91"></a><span id="l5.91"> NS_IMETHODIMP</span>
<a href="#l5.92"></a><span id="l5.92"> nsSubscribableServer::AddTo(const nsACString&amp; aName, bool aAddAsSubscribed,</span>
<a href="#l5.93"></a><span id="l5.93">                             bool aSubscribable, bool aChangeIfExists)</span>
<a href="#l5.94"></a><span id="l5.94"> {</span>
<a href="#l5.95"></a><span id="l5.95">     nsresult rv = NS_OK;</span>
<a href="#l5.96"></a><span id="l5.96"> </span>
<a href="#l5.97"></a><span id="l5.97">     if (mStopped) {</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-#ifdef DEBUG_seth</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-        printf(&quot;stopped!\n&quot;);</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-#endif</span>
<a href="#l5.101"></a><span id="l5.101">         return NS_ERROR_FAILURE;</span>
<a href="#l5.102"></a><span id="l5.102">     }</span>
<a href="#l5.103"></a><span id="l5.103"> </span>
<a href="#l5.104"></a><span id="l5.104">     SubscribeTreeNode *node = nullptr;</span>
<a href="#l5.105"></a><span id="l5.105"> </span>
<a href="#l5.106"></a><span id="l5.106">     // todo, shouldn't we pass in aAddAsSubscribed, for the</span>
<a href="#l5.107"></a><span id="l5.107">     // default value if we create it?</span>
<a href="#l5.108"></a><span id="l5.108">     rv = FindAndCreateNode(aName, &amp;node);</span>
<a href="#l5.109"></a><span id="l5.109">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-</span>
<a href="#l5.111"></a><span id="l5.111">     NS_ASSERTION(node,&quot;didn't find the node&quot;);</span>
<a href="#l5.112"></a><span id="l5.112">     if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l5.113"></a><span id="l5.113"> </span>
<a href="#l5.114"></a><span id="l5.114">     if (aChangeIfExists) {</span>
<a href="#l5.115"></a><span id="l5.115">         node-&gt;isSubscribed = aAddAsSubscribed;</span>
<a href="#l5.116"></a><span id="l5.116">         rv = NotifyChange(node, kNC_Subscribed, node-&gt;isSubscribed);</span>
<a href="#l5.117"></a><span id="l5.117">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.118"></a><span id="l5.118">     }</span>
<a href="#l5.119"></a><span id="l5.119"> </span>
<a href="#l5.120"></a><span id="l5.120">     node-&gt;isSubscribable = aSubscribable;</span>
<a href="#l5.121"></a><span id="l5.121"> </span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-    if (mSubscribeListener)</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-        mSubscribeListener-&gt;OnItemDiscovered(aName, aSubscribable);</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-    return rv;</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+    return NS_OK;</span>
<a href="#l5.127"></a><span id="l5.127"> }</span>
<a href="#l5.128"></a><span id="l5.128"> </span>
<a href="#l5.129"></a><span id="l5.129"> NS_IMETHODIMP</span>
<a href="#l5.130"></a><span id="l5.130"> nsSubscribableServer::SetState(const nsACString &amp;aPath, bool aState,</span>
<a href="#l5.131"></a><span id="l5.131">                                bool *aStateChanged)</span>
<a href="#l5.132"></a><span id="l5.132"> {</span>
<a href="#l5.133"></a><span id="l5.133">     nsresult rv = NS_OK;</span>
<a href="#l5.134"></a><span id="l5.134">     NS_ASSERTION(!aPath.IsEmpty() &amp;&amp; aStateChanged, &quot;no path or stateChanged&quot;);</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineat">@@ -173,19 +171,26 @@ nsSubscribableServer::SetState(const nsA</span>
<a href="#l5.136"></a><span id="l5.136">     if (node-&gt;isSubscribed == aState) {</span>
<a href="#l5.137"></a><span id="l5.137">         return NS_OK;</span>
<a href="#l5.138"></a><span id="l5.138">     }</span>
<a href="#l5.139"></a><span id="l5.139">     else {</span>
<a href="#l5.140"></a><span id="l5.140">         node-&gt;isSubscribed = aState;</span>
<a href="#l5.141"></a><span id="l5.141">         *aStateChanged = true;</span>
<a href="#l5.142"></a><span id="l5.142">         rv = NotifyChange(node, kNC_Subscribed, node-&gt;isSubscribed);</span>
<a href="#l5.143"></a><span id="l5.143">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+        // Repaint the tree row to show/clear the check mark.</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+        if (mTree) {</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+          bool dummy;</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+          int32_t index = GetRow(node, &amp;dummy);</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+          if (index &gt;= 0)</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+            mTree-&gt;InvalidateRow(index);</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+        }</span>
<a href="#l5.152"></a><span id="l5.152">     }</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-    return rv;</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+    return NS_OK;</span>
<a href="#l5.156"></a><span id="l5.156"> }</span>
<a href="#l5.157"></a><span id="l5.157"> </span>
<a href="#l5.158"></a><span id="l5.158"> void</span>
<a href="#l5.159"></a><span id="l5.159"> nsSubscribableServer::BuildURIFromNode(SubscribeTreeNode *node, nsACString &amp;uri)</span>
<a href="#l5.160"></a><span id="l5.160"> {</span>
<a href="#l5.161"></a><span id="l5.161">     if (node-&gt;parent) {</span>
<a href="#l5.162"></a><span id="l5.162">         BuildURIFromNode(node-&gt;parent, uri);</span>
<a href="#l5.163"></a><span id="l5.163">         if (node-&gt;parent == mTreeRoot) {</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineat">@@ -329,17 +334,17 @@ nsSubscribableServer::SetSubscribeListen</span>
<a href="#l5.165"></a><span id="l5.165"> {</span>
<a href="#l5.166"></a><span id="l5.166">   mSubscribeListener = aListener;</span>
<a href="#l5.167"></a><span id="l5.167">   return NS_OK;</span>
<a href="#l5.168"></a><span id="l5.168"> }</span>
<a href="#l5.169"></a><span id="l5.169"> </span>
<a href="#l5.170"></a><span id="l5.170"> NS_IMETHODIMP</span>
<a href="#l5.171"></a><span id="l5.171"> nsSubscribableServer::GetSubscribeListener(nsISubscribeListener **aListener)</span>
<a href="#l5.172"></a><span id="l5.172"> {</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-  if (!aListener) return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l5.175"></a><span id="l5.175">   NS_IF_ADDREF(*aListener = mSubscribeListener);</span>
<a href="#l5.176"></a><span id="l5.176">   return NS_OK;</span>
<a href="#l5.177"></a><span id="l5.177"> }</span>
<a href="#l5.178"></a><span id="l5.178"> </span>
<a href="#l5.179"></a><span id="l5.179"> NS_IMETHODIMP</span>
<a href="#l5.180"></a><span id="l5.180"> nsSubscribableServer::SubscribeCleanup()</span>
<a href="#l5.181"></a><span id="l5.181"> {</span>
<a href="#l5.182"></a><span id="l5.182">   NS_ASSERTION(false,&quot;override this.&quot;);</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineat">@@ -351,31 +356,63 @@ nsSubscribableServer::StartPopulatingWit</span>
<a href="#l5.184"></a><span id="l5.184"> {</span>
<a href="#l5.185"></a><span id="l5.185">     mStopped = false;</span>
<a href="#l5.186"></a><span id="l5.186">     return NS_OK;</span>
<a href="#l5.187"></a><span id="l5.187"> }</span>
<a href="#l5.188"></a><span id="l5.188"> </span>
<a href="#l5.189"></a><span id="l5.189"> NS_IMETHODIMP</span>
<a href="#l5.190"></a><span id="l5.190"> nsSubscribableServer::StartPopulating(nsIMsgWindow *aMsgWindow, bool aForceToServer, bool aGetOnlyNew /*ignored*/)</span>
<a href="#l5.191"></a><span id="l5.191"> {</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+    mStopped = false;</span>
<a href="#l5.194"></a><span id="l5.194"> </span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-    mStopped = false;</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+    nsresult rv = FreeRows();</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.198"></a><span id="l5.198"> </span>
<a href="#l5.199"></a><span id="l5.199">     rv = FreeSubtree(mTreeRoot);</span>
<a href="#l5.200"></a><span id="l5.200">     mTreeRoot = nullptr;</span>
<a href="#l5.201"></a><span id="l5.201">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.202"></a><span id="l5.202">     return NS_OK;</span>
<a href="#l5.203"></a><span id="l5.203"> }</span>
<a href="#l5.204"></a><span id="l5.204"> </span>
<a href="#l5.205"></a><span id="l5.205"> NS_IMETHODIMP</span>
<a href="#l5.206"></a><span id="l5.206"> nsSubscribableServer::StopPopulating(nsIMsgWindow *aMsgWindow)</span>
<a href="#l5.207"></a><span id="l5.207"> {</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineminus">-    mStopped = true;</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+  mStopped = true;</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+  nsresult rv = FreeRows();</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineplus">+  if (mTreeRoot) {</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineplus">+    SubscribeTreeNode *node = mTreeRoot-&gt;lastChild;</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineplus">+    // Add top level items as closed.</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineplus">+    while (node)</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineplus">+    {</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineplus">+      node-&gt;isOpen = false;</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineplus">+      mRowMap.AppendElement(node);</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+      node = node-&gt;prevSibling;</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+    }</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineplus">+</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineplus">+    // Invalidate the whole thing.</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+    if (mTree)</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+      mTree-&gt;RowCountChanged(0, mRowMap.Length());</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+    // Open all the top level items if they are containers.</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineplus">+    uint32_t topRows = mRowMap.Length();</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineplus">+    for (int32_t i = topRows - 1; i &gt;= 0; i--) {</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineplus">+      bool isContainer = false;</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineplus">+      IsContainer(i, &amp;isContainer);</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineplus">+      if (isContainer)</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+        ToggleOpenState(i);</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+    }</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineplus">+  }</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineplus">+  if (mSubscribeListener)</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+    mSubscribeListener-&gt;OnDonePopulating();</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.243"></a><span id="l5.243"> }</span>
<a href="#l5.244"></a><span id="l5.244"> </span>
<a href="#l5.245"></a><span id="l5.245"> </span>
<a href="#l5.246"></a><span id="l5.246"> NS_IMETHODIMP</span>
<a href="#l5.247"></a><span id="l5.247"> nsSubscribableServer::UpdateSubscribed()</span>
<a href="#l5.248"></a><span id="l5.248"> {</span>
<a href="#l5.249"></a><span id="l5.249">   NS_ASSERTION(false,&quot;override this.&quot;);</span>
<a href="#l5.250"></a><span id="l5.250">   return NS_ERROR_FAILURE;</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineat">@@ -430,34 +467,48 @@ nsSubscribableServer::FreeSubtree(Subscr</span>
<a href="#l5.252"></a><span id="l5.252">         free(node-&gt;name);</span>
<a href="#l5.253"></a><span id="l5.253"> #if 0</span>
<a href="#l5.254"></a><span id="l5.254">         node-&gt;name = nullptr;</span>
<a href="#l5.255"></a><span id="l5.255">         node-&gt;parent = nullptr;</span>
<a href="#l5.256"></a><span id="l5.256">         node-&gt;lastChild = nullptr;</span>
<a href="#l5.257"></a><span id="l5.257">         node-&gt;cachedChild = nullptr;</span>
<a href="#l5.258"></a><span id="l5.258"> #endif</span>
<a href="#l5.259"></a><span id="l5.259"> </span>
<a href="#l5.260"></a><span id="l5.260" class="difflineminus">-        PR_Free(node);</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineplus">+        delete node;</span>
<a href="#l5.262"></a><span id="l5.262">     }</span>
<a href="#l5.263"></a><span id="l5.263"> </span>
<a href="#l5.264"></a><span id="l5.264">     return NS_OK;</span>
<a href="#l5.265"></a><span id="l5.265"> }</span>
<a href="#l5.266"></a><span id="l5.266"> </span>
<a href="#l5.267"></a><span id="l5.267"> nsresult</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineminus">-nsSubscribableServer::CreateNode(SubscribeTreeNode *parent, const char *name, SubscribeTreeNode **result)</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+nsSubscribableServer::FreeRows()</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineplus">+{</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineplus">+  int32_t rowCount = mRowMap.Length();</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+  mRowMap.Clear();</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+  if (mTree)</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+    mTree-&gt;RowCountChanged(0, -rowCount);</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineplus">+}</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+nsresult</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+nsSubscribableServer::CreateNode(SubscribeTreeNode *parent, const char *name, const nsACString &amp;aPath, SubscribeTreeNode **result)</span>
<a href="#l5.281"></a><span id="l5.281"> {</span>
<a href="#l5.282"></a><span id="l5.282">     NS_ASSERTION(result &amp;&amp; name, &quot;result or name is null&quot;);</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineminus">-    if (!result || !name) return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+    NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+    NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l5.286"></a><span id="l5.286"> </span>
<a href="#l5.287"></a><span id="l5.287" class="difflineminus">-    *result = (SubscribeTreeNode *) PR_Malloc(sizeof(SubscribeTreeNode));</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineplus">+    *result = new SubscribeTreeNode();</span>
<a href="#l5.289"></a><span id="l5.289">     if (!*result) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.290"></a><span id="l5.290"> </span>
<a href="#l5.291"></a><span id="l5.291">     (*result)-&gt;name = strdup(name);</span>
<a href="#l5.292"></a><span id="l5.292">     if (!(*result)-&gt;name) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.293"></a><span id="l5.293"> </span>
<a href="#l5.294"></a><span id="l5.294" class="difflineplus">+    (*result)-&gt;path.Assign(aPath);</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineplus">+</span>
<a href="#l5.296"></a><span id="l5.296">     (*result)-&gt;parent = parent;</span>
<a href="#l5.297"></a><span id="l5.297">     (*result)-&gt;prevSibling = nullptr;</span>
<a href="#l5.298"></a><span id="l5.298">     (*result)-&gt;nextSibling = nullptr;</span>
<a href="#l5.299"></a><span id="l5.299">     (*result)-&gt;firstChild = nullptr;</span>
<a href="#l5.300"></a><span id="l5.300">     (*result)-&gt;lastChild = nullptr;</span>
<a href="#l5.301"></a><span id="l5.301">     (*result)-&gt;isSubscribed = false;</span>
<a href="#l5.302"></a><span id="l5.302">     (*result)-&gt;isSubscribable = false;</span>
<a href="#l5.303"></a><span id="l5.303"> #ifdef HAVE_SUBSCRIBE_DESCRIPTION</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineat">@@ -467,29 +518,31 @@ nsSubscribableServer::CreateNode(Subscri</span>
<a href="#l5.305"></a><span id="l5.305">     (*result)-&gt;messages = 0;</span>
<a href="#l5.306"></a><span id="l5.306"> #endif</span>
<a href="#l5.307"></a><span id="l5.307">     (*result)-&gt;cachedChild = nullptr;</span>
<a href="#l5.308"></a><span id="l5.308"> </span>
<a href="#l5.309"></a><span id="l5.309">     if (parent) {</span>
<a href="#l5.310"></a><span id="l5.310">         parent-&gt;cachedChild = *result;</span>
<a href="#l5.311"></a><span id="l5.311">     }</span>
<a href="#l5.312"></a><span id="l5.312"> </span>
<a href="#l5.313"></a><span id="l5.313" class="difflineplus">+    (*result)-&gt;isOpen = true;</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineplus">+</span>
<a href="#l5.315"></a><span id="l5.315">     return NS_OK;</span>
<a href="#l5.316"></a><span id="l5.316"> }</span>
<a href="#l5.317"></a><span id="l5.317"> </span>
<a href="#l5.318"></a><span id="l5.318"> nsresult</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineminus">-nsSubscribableServer::AddChildNode(SubscribeTreeNode *parent, const char *name, SubscribeTreeNode **child)</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineplus">+nsSubscribableServer::AddChildNode(SubscribeTreeNode *parent, const char *name, const nsACString &amp;aPath, SubscribeTreeNode **child)</span>
<a href="#l5.321"></a><span id="l5.321"> {</span>
<a href="#l5.322"></a><span id="l5.322">     nsresult rv = NS_OK;</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineminus">-    NS_ASSERTION(parent &amp;&amp; child &amp;&amp; name, &quot;parent, child or name is null&quot;);</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineminus">-    if (!parent || !child || !name) return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+    NS_ASSERTION(parent &amp;&amp; child &amp;&amp; name &amp;&amp; !aPath.IsEmpty(), &quot;parent, child or name is null&quot;);</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+    if (!parent || !child || !name || aPath.IsEmpty()) return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.327"></a><span id="l5.327"> </span>
<a href="#l5.328"></a><span id="l5.328">     if (!parent-&gt;firstChild) {</span>
<a href="#l5.329"></a><span id="l5.329">         // CreateNode will set the parent-&gt;cachedChild</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineminus">-        rv = CreateNode(parent, name, child);</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineplus">+        rv = CreateNode(parent, name, aPath, child);</span>
<a href="#l5.332"></a><span id="l5.332">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.333"></a><span id="l5.333"> </span>
<a href="#l5.334"></a><span id="l5.334">         parent-&gt;firstChild = *child;</span>
<a href="#l5.335"></a><span id="l5.335">         parent-&gt;lastChild = *child;</span>
<a href="#l5.336"></a><span id="l5.336"> </span>
<a href="#l5.337"></a><span id="l5.337">         rv = NotifyAssert(parent, kNC_Child, *child);</span>
<a href="#l5.338"></a><span id="l5.338">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.339"></a><span id="l5.339"> </span>
<a href="#l5.340"></a><span id="l5.340" class="difflineat">@@ -518,17 +571,17 @@ nsSubscribableServer::AddChildNode(Subsc</span>
<a href="#l5.341"></a><span id="l5.341">      * we can efficiently reverse the order when dumping to hostinfo.dat</span>
<a href="#l5.342"></a><span id="l5.342">      * or to GetTargets()</span>
<a href="#l5.343"></a><span id="l5.343">      */</span>
<a href="#l5.344"></a><span id="l5.344">     int32_t compare = strcmp(current-&gt;name, name);</span>
<a href="#l5.345"></a><span id="l5.345"> </span>
<a href="#l5.346"></a><span id="l5.346">     while (current &amp;&amp; (compare != 0)) {</span>
<a href="#l5.347"></a><span id="l5.347">         if (compare &lt; 0) {</span>
<a href="#l5.348"></a><span id="l5.348">             // CreateNode will set the parent-&gt;cachedChild</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineminus">-            rv = CreateNode(parent, name, child);</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+            rv = CreateNode(parent, name, aPath, child);</span>
<a href="#l5.351"></a><span id="l5.351">             NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.352"></a><span id="l5.352"> </span>
<a href="#l5.353"></a><span id="l5.353">             (*child)-&gt;nextSibling = current;</span>
<a href="#l5.354"></a><span id="l5.354">             (*child)-&gt;prevSibling = current-&gt;prevSibling;</span>
<a href="#l5.355"></a><span id="l5.355">             current-&gt;prevSibling = (*child);</span>
<a href="#l5.356"></a><span id="l5.356">             if (!(*child)-&gt;prevSibling) {</span>
<a href="#l5.357"></a><span id="l5.357">                 parent-&gt;firstChild = (*child);</span>
<a href="#l5.358"></a><span id="l5.358">             }</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineat">@@ -555,17 +608,17 @@ nsSubscribableServer::AddChildNode(Subsc</span>
<a href="#l5.360"></a><span id="l5.360">         *child = current;</span>
<a href="#l5.361"></a><span id="l5.361"> </span>
<a href="#l5.362"></a><span id="l5.362">         // set the cachedChild</span>
<a href="#l5.363"></a><span id="l5.363">         parent-&gt;cachedChild = *child;</span>
<a href="#l5.364"></a><span id="l5.364">         return NS_OK;</span>
<a href="#l5.365"></a><span id="l5.365">     }</span>
<a href="#l5.366"></a><span id="l5.366"> </span>
<a href="#l5.367"></a><span id="l5.367">     // CreateNode will set the parent-&gt;cachedChild</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineminus">-    rv = CreateNode(parent, name, child);</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineplus">+    rv = CreateNode(parent, name, aPath, child);</span>
<a href="#l5.370"></a><span id="l5.370">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.371"></a><span id="l5.371"> </span>
<a href="#l5.372"></a><span id="l5.372">     (*child)-&gt;prevSibling = parent-&gt;lastChild;</span>
<a href="#l5.373"></a><span id="l5.373">     (*child)-&gt;nextSibling = nullptr;</span>
<a href="#l5.374"></a><span id="l5.374">     parent-&gt;lastChild-&gt;nextSibling = *child;</span>
<a href="#l5.375"></a><span id="l5.375">     parent-&gt;lastChild = *child;</span>
<a href="#l5.376"></a><span id="l5.376"> </span>
<a href="#l5.377"></a><span id="l5.377">     rv = NotifyAssert(parent, kNC_Child, *child);</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineat">@@ -574,85 +627,81 @@ nsSubscribableServer::AddChildNode(Subsc</span>
<a href="#l5.379"></a><span id="l5.379"> }</span>
<a href="#l5.380"></a><span id="l5.380"> </span>
<a href="#l5.381"></a><span id="l5.381"> nsresult</span>
<a href="#l5.382"></a><span id="l5.382"> nsSubscribableServer::FindAndCreateNode(const nsACString &amp;aPath,</span>
<a href="#l5.383"></a><span id="l5.383">                                         SubscribeTreeNode **aResult)</span>
<a href="#l5.384"></a><span id="l5.384"> {</span>
<a href="#l5.385"></a><span id="l5.385">   nsresult rv = NS_OK;</span>
<a href="#l5.386"></a><span id="l5.386">   NS_ASSERTION(aResult, &quot;no result&quot;);</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineminus">-  if (!aResult) return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l5.389"></a><span id="l5.389"> </span>
<a href="#l5.390"></a><span id="l5.390">   if (!mTreeRoot) {</span>
<a href="#l5.391"></a><span id="l5.391">       // the root has no parent, and its name is server uri</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineminus">-      rv = CreateNode(nullptr, mIncomingServerUri.get(), &amp;mTreeRoot);</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineplus">+      rv = CreateNode(nullptr, mIncomingServerUri.get(), EmptyCString(), &amp;mTreeRoot);</span>
<a href="#l5.394"></a><span id="l5.394">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.395"></a><span id="l5.395">   }</span>
<a href="#l5.396"></a><span id="l5.396"> </span>
<a href="#l5.397"></a><span id="l5.397">   if (aPath.IsEmpty()) {</span>
<a href="#l5.398"></a><span id="l5.398">       *aResult = mTreeRoot;</span>
<a href="#l5.399"></a><span id="l5.399">       return NS_OK;</span>
<a href="#l5.400"></a><span id="l5.400">   }</span>
<a href="#l5.401"></a><span id="l5.401"> </span>
<a href="#l5.402"></a><span id="l5.402" class="difflineminus">-  char *token = nullptr;</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineminus">-  nsCString pathStr(aPath);</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineminus">-  char *rest = pathStr.BeginWriting();</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineminus">-</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineminus">-  // todo do this only once</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineminus">-  char delimstr[2];</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineminus">-  delimstr[0] = mDelimiter;</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineminus">-  delimstr[1] = '\0';</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineminus">-</span>
<a href="#l5.411"></a><span id="l5.411">   *aResult = nullptr;</span>
<a href="#l5.412"></a><span id="l5.412"> </span>
<a href="#l5.413"></a><span id="l5.413">   SubscribeTreeNode *parent = mTreeRoot;</span>
<a href="#l5.414"></a><span id="l5.414">   SubscribeTreeNode *child = nullptr;</span>
<a href="#l5.415"></a><span id="l5.415"> </span>
<a href="#l5.416"></a><span id="l5.416" class="difflineminus">-  token = NS_strtok(delimstr, &amp;rest);</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineminus">-  // special case paths that start with the hierarchy delimiter.</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineplus">+  uint32_t tokenStart = 0;</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineplus">+  // Special case paths that start with the hierarchy delimiter.</span>
<a href="#l5.420"></a><span id="l5.420">   // We want to include that delimiter in the first token name.</span>
<a href="#l5.421"></a><span id="l5.421" class="difflineminus">-  if (token &amp;&amp; pathStr[0] == mDelimiter)</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineminus">-    --token;</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineminus">-  while (token &amp;&amp; *token) {</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineminus">-    rv = AddChildNode(parent, token, &amp;child);</span>
<a href="#l5.425"></a><span id="l5.425" class="difflineplus">+  // So start from position 1.</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineplus">+  int32_t tokenEnd = aPath.FindChar(mDelimiter, tokenStart + 1);</span>
<a href="#l5.427"></a><span id="l5.427" class="difflineplus">+  while (true) {</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineplus">+    if (tokenEnd == kNotFound) {</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineplus">+      if (tokenStart &gt;= aPath.Length())</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineplus">+        break;</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineplus">+      tokenEnd = aPath.Length();</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineplus">+    }</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineplus">+    nsCString token(Substring(aPath, tokenStart, tokenEnd - tokenStart));</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineplus">+    rv = AddChildNode(parent, token.BeginReading(), Substring(aPath, 0, tokenEnd), &amp;child);</span>
<a href="#l5.435"></a><span id="l5.435">     if (NS_FAILED(rv))</span>
<a href="#l5.436"></a><span id="l5.436">       return rv;</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineminus">-    token = NS_strtok(delimstr, &amp;rest);</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineplus">+    tokenStart = tokenEnd + 1;</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineplus">+    tokenEnd = aPath.FindChar(mDelimiter, tokenStart);</span>
<a href="#l5.440"></a><span id="l5.440">     parent = child;</span>
<a href="#l5.441"></a><span id="l5.441">   }</span>
<a href="#l5.442"></a><span id="l5.442"> </span>
<a href="#l5.443"></a><span id="l5.443">   // the last child we add is the result</span>
<a href="#l5.444"></a><span id="l5.444">   *aResult = child;</span>
<a href="#l5.445"></a><span id="l5.445">   return rv;</span>
<a href="#l5.446"></a><span id="l5.446"> }</span>
<a href="#l5.447"></a><span id="l5.447"> </span>
<a href="#l5.448"></a><span id="l5.448"> NS_IMETHODIMP</span>
<a href="#l5.449"></a><span id="l5.449"> nsSubscribableServer::HasChildren(const nsACString &amp;aPath, bool *aHasChildren)</span>
<a href="#l5.450"></a><span id="l5.450"> {</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l5.452"></a><span id="l5.452">     NS_ASSERTION(aHasChildren, &quot;no hasChildren&quot;);</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineminus">-    if (!aHasChildren) return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineplus">+    NS_ENSURE_ARG_POINTER(aHasChildren);</span>
<a href="#l5.455"></a><span id="l5.455"> </span>
<a href="#l5.456"></a><span id="l5.456">     *aHasChildren = false;</span>
<a href="#l5.457"></a><span id="l5.457"> </span>
<a href="#l5.458"></a><span id="l5.458">     SubscribeTreeNode *node = nullptr;</span>
<a href="#l5.459"></a><span id="l5.459" class="difflineminus">-    rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineplus">+    nsresult rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l5.461"></a><span id="l5.461">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.462"></a><span id="l5.462"> </span>
<a href="#l5.463"></a><span id="l5.463">     NS_ASSERTION(node,&quot;didn't find the node&quot;);</span>
<a href="#l5.464"></a><span id="l5.464">     if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l5.465"></a><span id="l5.465"> </span>
<a href="#l5.466"></a><span id="l5.466">     *aHasChildren = (node-&gt;firstChild != nullptr);</span>
<a href="#l5.467"></a><span id="l5.467">     return NS_OK;</span>
<a href="#l5.468"></a><span id="l5.468"> }</span>
<a href="#l5.469"></a><span id="l5.469"> </span>
<a href="#l5.470"></a><span id="l5.470"> </span>
<a href="#l5.471"></a><span id="l5.471"> NS_IMETHODIMP</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineminus">-nsSubscribableServer::IsSubscribed(const nsACString &amp;aPath,</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineminus">-                                   bool *aIsSubscribed)</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineplus">+nsSubscribableServer::IsSubscribed(const nsACString &amp;aPath, bool *aIsSubscribed)</span>
<a href="#l5.475"></a><span id="l5.475"> {</span>
<a href="#l5.476"></a><span id="l5.476">     NS_ENSURE_ARG_POINTER(aIsSubscribed);</span>
<a href="#l5.477"></a><span id="l5.477"> </span>
<a href="#l5.478"></a><span id="l5.478">     *aIsSubscribed = false;</span>
<a href="#l5.479"></a><span id="l5.479"> </span>
<a href="#l5.480"></a><span id="l5.480">     SubscribeTreeNode *node = nullptr;</span>
<a href="#l5.481"></a><span id="l5.481">     nsresult rv = FindAndCreateNode(aPath, &amp;node);</span>
<a href="#l5.482"></a><span id="l5.482">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineat">@@ -797,8 +846,360 @@ nsSubscribableServer::SetSearchValue(con</span>
<a href="#l5.484"></a><span id="l5.484">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.485"></a><span id="l5.485"> }</span>
<a href="#l5.486"></a><span id="l5.486"> </span>
<a href="#l5.487"></a><span id="l5.487"> NS_IMETHODIMP</span>
<a href="#l5.488"></a><span id="l5.488"> nsSubscribableServer::GetSupportsSubscribeSearch(bool *retVal)</span>
<a href="#l5.489"></a><span id="l5.489"> {</span>
<a href="#l5.490"></a><span id="l5.490">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.491"></a><span id="l5.491"> }</span>
<a href="#l5.492"></a><span id="l5.492" class="difflineplus">+</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineplus">+nsSubscribableServer::GetFolderView(nsITreeView **aView)</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineplus">+{</span>
<a href="#l5.496"></a><span id="l5.496" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aView);</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineplus">+  return this-&gt;QueryInterface(NS_GET_IID(nsITreeView), (void**)aView);</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineplus">+}</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineplus">+</span>
<a href="#l5.500"></a><span id="l5.500" class="difflineplus">+int32_t</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineplus">+nsSubscribableServer::GetRow(SubscribeTreeNode *node, bool *open)</span>
<a href="#l5.502"></a><span id="l5.502" class="difflineplus">+{</span>
<a href="#l5.503"></a><span id="l5.503" class="difflineplus">+  int32_t parentRow = -1;</span>
<a href="#l5.504"></a><span id="l5.504" class="difflineplus">+  if (node-&gt;parent)</span>
<a href="#l5.505"></a><span id="l5.505" class="difflineplus">+    parentRow = GetRow(node-&gt;parent, open);</span>
<a href="#l5.506"></a><span id="l5.506" class="difflineplus">+</span>
<a href="#l5.507"></a><span id="l5.507" class="difflineplus">+  // If the parent wasn't opened, we're not in the row map</span>
<a href="#l5.508"></a><span id="l5.508" class="difflineplus">+  if (open &amp;&amp; *open == false)</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineplus">+    return -1;</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineplus">+</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineplus">+  if (open)</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineplus">+    *open = node-&gt;isOpen;</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineplus">+</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineplus">+  for (uint32_t row = parentRow + 1; row &lt; mRowMap.Length(); row++)</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineplus">+  {</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineplus">+    if (mRowMap[row] == node)</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineplus">+      return row;</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineplus">+  }</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineplus">+</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineplus">+  // Apparently, we're not in the map</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineplus">+  return -1;</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineplus">+}</span>
<a href="#l5.523"></a><span id="l5.523" class="difflineplus">+</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.525"></a><span id="l5.525" class="difflineplus">+nsSubscribableServer::GetSelection(nsITreeSelection **selection)</span>
<a href="#l5.526"></a><span id="l5.526" class="difflineplus">+{</span>
<a href="#l5.527"></a><span id="l5.527" class="difflineplus">+  NS_IF_ADDREF(*selection = mSelection);</span>
<a href="#l5.528"></a><span id="l5.528" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.529"></a><span id="l5.529" class="difflineplus">+}</span>
<a href="#l5.530"></a><span id="l5.530" class="difflineplus">+</span>
<a href="#l5.531"></a><span id="l5.531" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.532"></a><span id="l5.532" class="difflineplus">+nsSubscribableServer::SetSelection(nsITreeSelection *selection)</span>
<a href="#l5.533"></a><span id="l5.533" class="difflineplus">+{</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineplus">+  mSelection = selection;</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineplus">+}</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineplus">+</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.539"></a><span id="l5.539" class="difflineplus">+nsSubscribableServer::GetRowCount(int32_t *rowCount)</span>
<a href="#l5.540"></a><span id="l5.540" class="difflineplus">+{</span>
<a href="#l5.541"></a><span id="l5.541" class="difflineplus">+  *rowCount = mRowMap.Length();</span>
<a href="#l5.542"></a><span id="l5.542" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineplus">+}</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineplus">+</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineplus">+nsSubscribableServer::SetTree(nsITreeBoxObject *aTree)</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineplus">+{</span>
<a href="#l5.548"></a><span id="l5.548" class="difflineplus">+  mTree = aTree;</span>
<a href="#l5.549"></a><span id="l5.549" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.550"></a><span id="l5.550" class="difflineplus">+}</span>
<a href="#l5.551"></a><span id="l5.551" class="difflineplus">+</span>
<a href="#l5.552"></a><span id="l5.552" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.553"></a><span id="l5.553" class="difflineplus">+nsSubscribableServer::IsContainer(int32_t aIndex, bool *retval)</span>
<a href="#l5.554"></a><span id="l5.554" class="difflineplus">+{</span>
<a href="#l5.555"></a><span id="l5.555" class="difflineplus">+  *retval = !!mRowMap[aIndex]-&gt;firstChild;</span>
<a href="#l5.556"></a><span id="l5.556" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.557"></a><span id="l5.557" class="difflineplus">+}</span>
<a href="#l5.558"></a><span id="l5.558" class="difflineplus">+</span>
<a href="#l5.559"></a><span id="l5.559" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.560"></a><span id="l5.560" class="difflineplus">+nsSubscribableServer::IsContainerEmpty(int32_t aIndex, bool *retval)</span>
<a href="#l5.561"></a><span id="l5.561" class="difflineplus">+{</span>
<a href="#l5.562"></a><span id="l5.562" class="difflineplus">+  *retval = false;</span>
<a href="#l5.563"></a><span id="l5.563" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.564"></a><span id="l5.564" class="difflineplus">+}</span>
<a href="#l5.565"></a><span id="l5.565" class="difflineplus">+</span>
<a href="#l5.566"></a><span id="l5.566" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.567"></a><span id="l5.567" class="difflineplus">+nsSubscribableServer::IsContainerOpen(int32_t aIndex, bool *retval)</span>
<a href="#l5.568"></a><span id="l5.568" class="difflineplus">+{</span>
<a href="#l5.569"></a><span id="l5.569" class="difflineplus">+  *retval = mRowMap[aIndex]-&gt;isOpen;</span>
<a href="#l5.570"></a><span id="l5.570" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.571"></a><span id="l5.571" class="difflineplus">+}</span>
<a href="#l5.572"></a><span id="l5.572" class="difflineplus">+</span>
<a href="#l5.573"></a><span id="l5.573" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.574"></a><span id="l5.574" class="difflineplus">+nsSubscribableServer::GetParentIndex(int32_t aIndex, int32_t *retval)</span>
<a href="#l5.575"></a><span id="l5.575" class="difflineplus">+{</span>
<a href="#l5.576"></a><span id="l5.576" class="difflineplus">+  SubscribeTreeNode *parent = mRowMap[aIndex]-&gt;parent;</span>
<a href="#l5.577"></a><span id="l5.577" class="difflineplus">+  if (!parent)</span>
<a href="#l5.578"></a><span id="l5.578" class="difflineplus">+  {</span>
<a href="#l5.579"></a><span id="l5.579" class="difflineplus">+    *retval = -1;</span>
<a href="#l5.580"></a><span id="l5.580" class="difflineplus">+    return NS_OK;</span>
<a href="#l5.581"></a><span id="l5.581" class="difflineplus">+  }</span>
<a href="#l5.582"></a><span id="l5.582" class="difflineplus">+</span>
<a href="#l5.583"></a><span id="l5.583" class="difflineplus">+  int32_t index;</span>
<a href="#l5.584"></a><span id="l5.584" class="difflineplus">+  for (index = aIndex - 1; index &gt;= 0; index--)</span>
<a href="#l5.585"></a><span id="l5.585" class="difflineplus">+  {</span>
<a href="#l5.586"></a><span id="l5.586" class="difflineplus">+    if (mRowMap[index] == parent)</span>
<a href="#l5.587"></a><span id="l5.587" class="difflineplus">+    {</span>
<a href="#l5.588"></a><span id="l5.588" class="difflineplus">+      *retval = index;</span>
<a href="#l5.589"></a><span id="l5.589" class="difflineplus">+      return NS_OK;</span>
<a href="#l5.590"></a><span id="l5.590" class="difflineplus">+    }</span>
<a href="#l5.591"></a><span id="l5.591" class="difflineplus">+  }</span>
<a href="#l5.592"></a><span id="l5.592" class="difflineplus">+  *retval = -1;</span>
<a href="#l5.593"></a><span id="l5.593" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.594"></a><span id="l5.594" class="difflineplus">+}</span>
<a href="#l5.595"></a><span id="l5.595" class="difflineplus">+</span>
<a href="#l5.596"></a><span id="l5.596" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.597"></a><span id="l5.597" class="difflineplus">+nsSubscribableServer::HasNextSibling(int32_t aRowIndex, int32_t aAfterIndex,</span>
<a href="#l5.598"></a><span id="l5.598" class="difflineplus">+                                     bool *retval)</span>
<a href="#l5.599"></a><span id="l5.599" class="difflineplus">+{</span>
<a href="#l5.600"></a><span id="l5.600" class="difflineplus">+  // This looks odd, but is correct. Using -&gt;nextSibling gives a bad tree.</span>
<a href="#l5.601"></a><span id="l5.601" class="difflineplus">+  *retval = !!mRowMap[aRowIndex]-&gt;prevSibling;</span>
<a href="#l5.602"></a><span id="l5.602" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.603"></a><span id="l5.603" class="difflineplus">+}</span>
<a href="#l5.604"></a><span id="l5.604" class="difflineplus">+</span>
<a href="#l5.605"></a><span id="l5.605" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.606"></a><span id="l5.606" class="difflineplus">+nsSubscribableServer::GetLevel(int32_t aIndex, int32_t *retval)</span>
<a href="#l5.607"></a><span id="l5.607" class="difflineplus">+{</span>
<a href="#l5.608"></a><span id="l5.608" class="difflineplus">+  // When starting with -2, we increase twice and return 0 for a top level node.</span>
<a href="#l5.609"></a><span id="l5.609" class="difflineplus">+  int32_t level = -2;</span>
<a href="#l5.610"></a><span id="l5.610" class="difflineplus">+  SubscribeTreeNode *node = mRowMap[aIndex];</span>
<a href="#l5.611"></a><span id="l5.611" class="difflineplus">+  while (node)</span>
<a href="#l5.612"></a><span id="l5.612" class="difflineplus">+  {</span>
<a href="#l5.613"></a><span id="l5.613" class="difflineplus">+    node = node-&gt;parent;</span>
<a href="#l5.614"></a><span id="l5.614" class="difflineplus">+    level++;</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineplus">+  }</span>
<a href="#l5.616"></a><span id="l5.616" class="difflineplus">+</span>
<a href="#l5.617"></a><span id="l5.617" class="difflineplus">+  *retval = level;</span>
<a href="#l5.618"></a><span id="l5.618" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.619"></a><span id="l5.619" class="difflineplus">+}</span>
<a href="#l5.620"></a><span id="l5.620" class="difflineplus">+</span>
<a href="#l5.621"></a><span id="l5.621" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.622"></a><span id="l5.622" class="difflineplus">+nsSubscribableServer::ToggleOpenState(int32_t aIndex)</span>
<a href="#l5.623"></a><span id="l5.623" class="difflineplus">+{</span>
<a href="#l5.624"></a><span id="l5.624" class="difflineplus">+  SubscribeTreeNode *node = mRowMap[aIndex];</span>
<a href="#l5.625"></a><span id="l5.625" class="difflineplus">+  if (node-&gt;isOpen)</span>
<a href="#l5.626"></a><span id="l5.626" class="difflineplus">+  {</span>
<a href="#l5.627"></a><span id="l5.627" class="difflineplus">+    // Close the node by finding the next sibling</span>
<a href="#l5.628"></a><span id="l5.628" class="difflineplus">+    node-&gt;isOpen = false;</span>
<a href="#l5.629"></a><span id="l5.629" class="difflineplus">+    int32_t count = node-&gt;prevSibling</span>
<a href="#l5.630"></a><span id="l5.630" class="difflineplus">+      ? (mRowMap.IndexOf(node-&gt;prevSibling, aIndex) - aIndex - 1)</span>
<a href="#l5.631"></a><span id="l5.631" class="difflineplus">+      : (mRowMap.Length() - aIndex - 1);</span>
<a href="#l5.632"></a><span id="l5.632" class="difflineplus">+    mRowMap.RemoveElementsAt(aIndex + 1, count);</span>
<a href="#l5.633"></a><span id="l5.633" class="difflineplus">+    if (mTree)</span>
<a href="#l5.634"></a><span id="l5.634" class="difflineplus">+    {</span>
<a href="#l5.635"></a><span id="l5.635" class="difflineplus">+      mTree-&gt;RowCountChanged(aIndex + 1, -count);</span>
<a href="#l5.636"></a><span id="l5.636" class="difflineplus">+      mTree-&gt;InvalidateRow(aIndex);</span>
<a href="#l5.637"></a><span id="l5.637" class="difflineplus">+    }</span>
<a href="#l5.638"></a><span id="l5.638" class="difflineplus">+  }</span>
<a href="#l5.639"></a><span id="l5.639" class="difflineplus">+  else</span>
<a href="#l5.640"></a><span id="l5.640" class="difflineplus">+  {</span>
<a href="#l5.641"></a><span id="l5.641" class="difflineplus">+    // Recursively add the children nodes (i.e., remember open)</span>
<a href="#l5.642"></a><span id="l5.642" class="difflineplus">+    node-&gt;isOpen = true;</span>
<a href="#l5.643"></a><span id="l5.643" class="difflineplus">+    int32_t total = 0;</span>
<a href="#l5.644"></a><span id="l5.644" class="difflineplus">+    node = node-&gt;lastChild;</span>
<a href="#l5.645"></a><span id="l5.645" class="difflineplus">+    while (node)</span>
<a href="#l5.646"></a><span id="l5.646" class="difflineplus">+    {</span>
<a href="#l5.647"></a><span id="l5.647" class="difflineplus">+      total += AddSubtree(node, aIndex + 1 + total);</span>
<a href="#l5.648"></a><span id="l5.648" class="difflineplus">+      node = node-&gt;prevSibling;</span>
<a href="#l5.649"></a><span id="l5.649" class="difflineplus">+    }</span>
<a href="#l5.650"></a><span id="l5.650" class="difflineplus">+    if (mTree)</span>
<a href="#l5.651"></a><span id="l5.651" class="difflineplus">+    {</span>
<a href="#l5.652"></a><span id="l5.652" class="difflineplus">+      mTree-&gt;RowCountChanged(aIndex + 1, total);</span>
<a href="#l5.653"></a><span id="l5.653" class="difflineplus">+      mTree-&gt;InvalidateRow(aIndex);</span>
<a href="#l5.654"></a><span id="l5.654" class="difflineplus">+    }</span>
<a href="#l5.655"></a><span id="l5.655" class="difflineplus">+  }</span>
<a href="#l5.656"></a><span id="l5.656" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.657"></a><span id="l5.657" class="difflineplus">+}</span>
<a href="#l5.658"></a><span id="l5.658" class="difflineplus">+</span>
<a href="#l5.659"></a><span id="l5.659" class="difflineplus">+int32_t</span>
<a href="#l5.660"></a><span id="l5.660" class="difflineplus">+nsSubscribableServer::AddSubtree(SubscribeTreeNode *node, int32_t index)</span>
<a href="#l5.661"></a><span id="l5.661" class="difflineplus">+{</span>
<a href="#l5.662"></a><span id="l5.662" class="difflineplus">+  mRowMap.InsertElementAt(index, node);</span>
<a href="#l5.663"></a><span id="l5.663" class="difflineplus">+  int32_t total = 1;</span>
<a href="#l5.664"></a><span id="l5.664" class="difflineplus">+  if (node-&gt;isOpen)</span>
<a href="#l5.665"></a><span id="l5.665" class="difflineplus">+  {</span>
<a href="#l5.666"></a><span id="l5.666" class="difflineplus">+    node = node-&gt;lastChild;</span>
<a href="#l5.667"></a><span id="l5.667" class="difflineplus">+    while (node)</span>
<a href="#l5.668"></a><span id="l5.668" class="difflineplus">+    {</span>
<a href="#l5.669"></a><span id="l5.669" class="difflineplus">+      total += AddSubtree(node, index + total);</span>
<a href="#l5.670"></a><span id="l5.670" class="difflineplus">+      node = node-&gt;prevSibling;</span>
<a href="#l5.671"></a><span id="l5.671" class="difflineplus">+    }</span>
<a href="#l5.672"></a><span id="l5.672" class="difflineplus">+  }</span>
<a href="#l5.673"></a><span id="l5.673" class="difflineplus">+  return total;</span>
<a href="#l5.674"></a><span id="l5.674" class="difflineplus">+}</span>
<a href="#l5.675"></a><span id="l5.675" class="difflineplus">+</span>
<a href="#l5.676"></a><span id="l5.676" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.677"></a><span id="l5.677" class="difflineplus">+nsSubscribableServer::GetCellText(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l5.678"></a><span id="l5.678" class="difflineplus">+                                  nsAString &amp;retval)</span>
<a href="#l5.679"></a><span id="l5.679" class="difflineplus">+{</span>
<a href="#l5.680"></a><span id="l5.680" class="difflineplus">+  nsString colId;</span>
<a href="#l5.681"></a><span id="l5.681" class="difflineplus">+  aCol-&gt;GetId(colId);</span>
<a href="#l5.682"></a><span id="l5.682" class="difflineplus">+  if (colId.EqualsLiteral(&quot;nameColumn&quot;)) {</span>
<a href="#l5.683"></a><span id="l5.683" class="difflineplus">+    nsCString path(mRowMap[aRow]-&gt;path);</span>
<a href="#l5.684"></a><span id="l5.684" class="difflineplus">+    GetLeafName(path, retval);</span>
<a href="#l5.685"></a><span id="l5.685" class="difflineplus">+  }</span>
<a href="#l5.686"></a><span id="l5.686" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.687"></a><span id="l5.687" class="difflineplus">+}</span>
<a href="#l5.688"></a><span id="l5.688" class="difflineplus">+</span>
<a href="#l5.689"></a><span id="l5.689" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.690"></a><span id="l5.690" class="difflineplus">+nsSubscribableServer::GetCellValue(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l5.691"></a><span id="l5.691" class="difflineplus">+                                   nsAString &amp;retval)</span>
<a href="#l5.692"></a><span id="l5.692" class="difflineplus">+{</span>
<a href="#l5.693"></a><span id="l5.693" class="difflineplus">+  nsString colId;</span>
<a href="#l5.694"></a><span id="l5.694" class="difflineplus">+  aCol-&gt;GetId(colId);</span>
<a href="#l5.695"></a><span id="l5.695" class="difflineplus">+  if (colId.EqualsLiteral(&quot;nameColumn&quot;))</span>
<a href="#l5.696"></a><span id="l5.696" class="difflineplus">+    retval = NS_ConvertUTF8toUTF16(mRowMap[aRow]-&gt;path);</span>
<a href="#l5.697"></a><span id="l5.697" class="difflineplus">+  if (colId.EqualsLiteral(&quot;subscribedColumn&quot;))</span>
<a href="#l5.698"></a><span id="l5.698" class="difflineplus">+  {</span>
<a href="#l5.699"></a><span id="l5.699" class="difflineplus">+    retval = mRowMap[aRow]-&gt;isSubscribed ? NS_LITERAL_STRING(&quot;true&quot;)</span>
<a href="#l5.700"></a><span id="l5.700" class="difflineplus">+                                         : NS_LITERAL_STRING(&quot;false&quot;);</span>
<a href="#l5.701"></a><span id="l5.701" class="difflineplus">+  }</span>
<a href="#l5.702"></a><span id="l5.702" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.703"></a><span id="l5.703" class="difflineplus">+}</span>
<a href="#l5.704"></a><span id="l5.704" class="difflineplus">+</span>
<a href="#l5.705"></a><span id="l5.705" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.706"></a><span id="l5.706" class="difflineplus">+nsSubscribableServer::SetCellText(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l5.707"></a><span id="l5.707" class="difflineplus">+                                  const nsAString &amp;aText)</span>
<a href="#l5.708"></a><span id="l5.708" class="difflineplus">+{</span>
<a href="#l5.709"></a><span id="l5.709" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.710"></a><span id="l5.710" class="difflineplus">+}</span>
<a href="#l5.711"></a><span id="l5.711" class="difflineplus">+</span>
<a href="#l5.712"></a><span id="l5.712" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.713"></a><span id="l5.713" class="difflineplus">+nsSubscribableServer::SetCellValue(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l5.714"></a><span id="l5.714" class="difflineplus">+                                   const nsAString &amp;aText)</span>
<a href="#l5.715"></a><span id="l5.715" class="difflineplus">+{</span>
<a href="#l5.716"></a><span id="l5.716" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.717"></a><span id="l5.717" class="difflineplus">+}</span>
<a href="#l5.718"></a><span id="l5.718" class="difflineplus">+</span>
<a href="#l5.719"></a><span id="l5.719" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.720"></a><span id="l5.720" class="difflineplus">+nsSubscribableServer::GetCellProperties(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l5.721"></a><span id="l5.721" class="difflineplus">+                                        nsAString&amp; aProps)</span>
<a href="#l5.722"></a><span id="l5.722" class="difflineplus">+{</span>
<a href="#l5.723"></a><span id="l5.723" class="difflineplus">+  SubscribeTreeNode *node = mRowMap[aRow];</span>
<a href="#l5.724"></a><span id="l5.724" class="difflineplus">+  if (node-&gt;isSubscribable)</span>
<a href="#l5.725"></a><span id="l5.725" class="difflineplus">+    aProps.AssignLiteral(&quot;subscribable-true&quot;);</span>
<a href="#l5.726"></a><span id="l5.726" class="difflineplus">+  else</span>
<a href="#l5.727"></a><span id="l5.727" class="difflineplus">+    aProps.AssignLiteral(&quot;subscribable-false&quot;);</span>
<a href="#l5.728"></a><span id="l5.728" class="difflineplus">+</span>
<a href="#l5.729"></a><span id="l5.729" class="difflineplus">+  nsString colId;</span>
<a href="#l5.730"></a><span id="l5.730" class="difflineplus">+  aCol-&gt;GetId(colId);</span>
<a href="#l5.731"></a><span id="l5.731" class="difflineplus">+  if (colId.EqualsLiteral(&quot;subscribedColumn&quot;)) {</span>
<a href="#l5.732"></a><span id="l5.732" class="difflineplus">+    if (node-&gt;isSubscribed)</span>
<a href="#l5.733"></a><span id="l5.733" class="difflineplus">+      aProps.AppendLiteral(&quot; subscribed-true&quot;);</span>
<a href="#l5.734"></a><span id="l5.734" class="difflineplus">+    else</span>
<a href="#l5.735"></a><span id="l5.735" class="difflineplus">+      aProps.AppendLiteral(&quot; subscribed-false&quot;);</span>
<a href="#l5.736"></a><span id="l5.736" class="difflineplus">+  } else if (colId.EqualsLiteral(&quot;nameColumn&quot;)) {</span>
<a href="#l5.737"></a><span id="l5.737" class="difflineplus">+    aProps.AppendLiteral(&quot; serverType-&quot;);</span>
<a href="#l5.738"></a><span id="l5.738" class="difflineplus">+    aProps.Append(NS_ConvertUTF8toUTF16(mServerType));</span>
<a href="#l5.739"></a><span id="l5.739" class="difflineplus">+  }</span>
<a href="#l5.740"></a><span id="l5.740" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.741"></a><span id="l5.741" class="difflineplus">+}</span>
<a href="#l5.742"></a><span id="l5.742" class="difflineplus">+</span>
<a href="#l5.743"></a><span id="l5.743" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.744"></a><span id="l5.744" class="difflineplus">+nsSubscribableServer::GetRowProperties(int32_t aRow, nsAString&amp; aProps)</span>
<a href="#l5.745"></a><span id="l5.745" class="difflineplus">+{</span>
<a href="#l5.746"></a><span id="l5.746" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.747"></a><span id="l5.747" class="difflineplus">+}</span>
<a href="#l5.748"></a><span id="l5.748" class="difflineplus">+</span>
<a href="#l5.749"></a><span id="l5.749" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.750"></a><span id="l5.750" class="difflineplus">+nsSubscribableServer::GetColumnProperties(nsTreeColumn *aCol,</span>
<a href="#l5.751"></a><span id="l5.751" class="difflineplus">+                                          nsAString&amp; aProps)</span>
<a href="#l5.752"></a><span id="l5.752" class="difflineplus">+{</span>
<a href="#l5.753"></a><span id="l5.753" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.754"></a><span id="l5.754" class="difflineplus">+}</span>
<a href="#l5.755"></a><span id="l5.755" class="difflineplus">+</span>
<a href="#l5.756"></a><span id="l5.756" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.757"></a><span id="l5.757" class="difflineplus">+nsSubscribableServer::IsEditable(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l5.758"></a><span id="l5.758" class="difflineplus">+                                 bool *retval)</span>
<a href="#l5.759"></a><span id="l5.759" class="difflineplus">+{</span>
<a href="#l5.760"></a><span id="l5.760" class="difflineplus">+  *retval = false;</span>
<a href="#l5.761"></a><span id="l5.761" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.762"></a><span id="l5.762" class="difflineplus">+}</span>
<a href="#l5.763"></a><span id="l5.763" class="difflineplus">+</span>
<a href="#l5.764"></a><span id="l5.764" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.765"></a><span id="l5.765" class="difflineplus">+nsSubscribableServer::IsSelectable(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l5.766"></a><span id="l5.766" class="difflineplus">+                                   bool *retval)</span>
<a href="#l5.767"></a><span id="l5.767" class="difflineplus">+{</span>
<a href="#l5.768"></a><span id="l5.768" class="difflineplus">+  *retval = false;</span>
<a href="#l5.769"></a><span id="l5.769" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.770"></a><span id="l5.770" class="difflineplus">+}</span>
<a href="#l5.771"></a><span id="l5.771" class="difflineplus">+</span>
<a href="#l5.772"></a><span id="l5.772" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.773"></a><span id="l5.773" class="difflineplus">+nsSubscribableServer::IsSeparator(int32_t aRowIndex, bool *retval)</span>
<a href="#l5.774"></a><span id="l5.774" class="difflineplus">+{</span>
<a href="#l5.775"></a><span id="l5.775" class="difflineplus">+  *retval = false;</span>
<a href="#l5.776"></a><span id="l5.776" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.777"></a><span id="l5.777" class="difflineplus">+}</span>
<a href="#l5.778"></a><span id="l5.778" class="difflineplus">+</span>
<a href="#l5.779"></a><span id="l5.779" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.780"></a><span id="l5.780" class="difflineplus">+nsSubscribableServer::IsSorted(bool *retval)</span>
<a href="#l5.781"></a><span id="l5.781" class="difflineplus">+{</span>
<a href="#l5.782"></a><span id="l5.782" class="difflineplus">+  *retval = false;</span>
<a href="#l5.783"></a><span id="l5.783" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.784"></a><span id="l5.784" class="difflineplus">+}</span>
<a href="#l5.785"></a><span id="l5.785" class="difflineplus">+</span>
<a href="#l5.786"></a><span id="l5.786" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.787"></a><span id="l5.787" class="difflineplus">+nsSubscribableServer::CanDrop(int32_t aIndex, int32_t aOrientation,</span>
<a href="#l5.788"></a><span id="l5.788" class="difflineplus">+                              mozilla::dom::DataTransfer *aData, bool *retval)</span>
<a href="#l5.789"></a><span id="l5.789" class="difflineplus">+{</span>
<a href="#l5.790"></a><span id="l5.790" class="difflineplus">+  *retval = false;</span>
<a href="#l5.791"></a><span id="l5.791" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.792"></a><span id="l5.792" class="difflineplus">+}</span>
<a href="#l5.793"></a><span id="l5.793" class="difflineplus">+</span>
<a href="#l5.794"></a><span id="l5.794" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.795"></a><span id="l5.795" class="difflineplus">+nsSubscribableServer::Drop(int32_t aRow, int32_t aOrientation,</span>
<a href="#l5.796"></a><span id="l5.796" class="difflineplus">+                           mozilla::dom::DataTransfer *aData)</span>
<a href="#l5.797"></a><span id="l5.797" class="difflineplus">+{</span>
<a href="#l5.798"></a><span id="l5.798" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.799"></a><span id="l5.799" class="difflineplus">+}</span>
<a href="#l5.800"></a><span id="l5.800" class="difflineplus">+</span>
<a href="#l5.801"></a><span id="l5.801" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.802"></a><span id="l5.802" class="difflineplus">+nsSubscribableServer::GetImageSrc(int32_t aRow, nsTreeColumn *aCol,</span>
<a href="#l5.803"></a><span id="l5.803" class="difflineplus">+                                  nsAString &amp;retval)</span>
<a href="#l5.804"></a><span id="l5.804" class="difflineplus">+{</span>
<a href="#l5.805"></a><span id="l5.805" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.806"></a><span id="l5.806" class="difflineplus">+}</span>
<a href="#l5.807"></a><span id="l5.807" class="difflineplus">+</span>
<a href="#l5.808"></a><span id="l5.808" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.809"></a><span id="l5.809" class="difflineplus">+nsSubscribableServer::CycleHeader(nsTreeColumn *aCol)</span>
<a href="#l5.810"></a><span id="l5.810" class="difflineplus">+{</span>
<a href="#l5.811"></a><span id="l5.811" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.812"></a><span id="l5.812" class="difflineplus">+}</span>
<a href="#l5.813"></a><span id="l5.813" class="difflineplus">+</span>
<a href="#l5.814"></a><span id="l5.814" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.815"></a><span id="l5.815" class="difflineplus">+nsSubscribableServer::SelectionChanged()</span>
<a href="#l5.816"></a><span id="l5.816" class="difflineplus">+{</span>
<a href="#l5.817"></a><span id="l5.817" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.818"></a><span id="l5.818" class="difflineplus">+}</span>
<a href="#l5.819"></a><span id="l5.819" class="difflineplus">+</span>
<a href="#l5.820"></a><span id="l5.820" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.821"></a><span id="l5.821" class="difflineplus">+nsSubscribableServer::CycleCell(int32_t aRow, nsTreeColumn *aCol)</span>
<a href="#l5.822"></a><span id="l5.822" class="difflineplus">+{</span>
<a href="#l5.823"></a><span id="l5.823" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.824"></a><span id="l5.824" class="difflineplus">+}</span>
<a href="#l5.825"></a><span id="l5.825" class="difflineplus">+</span>
<a href="#l5.826"></a><span id="l5.826" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.827"></a><span id="l5.827" class="difflineplus">+nsSubscribableServer::PerformAction(const char16_t *aAction)</span>
<a href="#l5.828"></a><span id="l5.828" class="difflineplus">+{</span>
<a href="#l5.829"></a><span id="l5.829" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.830"></a><span id="l5.830" class="difflineplus">+}</span>
<a href="#l5.831"></a><span id="l5.831" class="difflineplus">+</span>
<a href="#l5.832"></a><span id="l5.832" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.833"></a><span id="l5.833" class="difflineplus">+nsSubscribableServer::PerformActionOnRow(const char16_t *aAction, int32_t aRow)</span>
<a href="#l5.834"></a><span id="l5.834" class="difflineplus">+{</span>
<a href="#l5.835"></a><span id="l5.835" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.836"></a><span id="l5.836" class="difflineplus">+}</span>
<a href="#l5.837"></a><span id="l5.837" class="difflineplus">+</span>
<a href="#l5.838"></a><span id="l5.838" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.839"></a><span id="l5.839" class="difflineplus">+nsSubscribableServer::PerformActionOnCell(const char16_t *aAction,</span>
<a href="#l5.840"></a><span id="l5.840" class="difflineplus">+                                          int32_t aRow, nsTreeColumn *aCol)</span>
<a href="#l5.841"></a><span id="l5.841" class="difflineplus">+{</span>
<a href="#l5.842"></a><span id="l5.842" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.843"></a><span id="l5.843" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/src/nsSubscribableServer.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/src/nsSubscribableServer.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -3,78 +3,96 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.5"></a><span id="l6.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> #ifndef nsSubscribableServer_h__</span>
<a href="#l6.8"></a><span id="l6.8"> #define nsSubscribableServer_h__</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l6.11"></a><span id="l6.11"> #include &quot;nsString.h&quot;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+#include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+#include &quot;nsITreeBoxObject.h&quot;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+#include &quot;nsITreeSelection.h&quot;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+#include &quot;nsITreeView.h&quot;</span>
<a href="#l6.16"></a><span id="l6.16"> #include &quot;nsISubscribableServer.h&quot;</span>
<a href="#l6.17"></a><span id="l6.17"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l6.18"></a><span id="l6.18"> #include &quot;nsSubscribeDataSource.h&quot;</span>
<a href="#l6.19"></a><span id="l6.19"> #include &quot;nsIRDFResource.h&quot;</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+#include &quot;nsTArray.h&quot;</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+/**</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+ * The basic structure for the tree of the implementation.</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+ *</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+ * These elements are stored in reverse alphabetical order.</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+ */</span>
<a href="#l6.27"></a><span id="l6.27"> typedef struct _subscribeTreeNode {</span>
<a href="#l6.28"></a><span id="l6.28">   char *name;</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+  nsCString path;</span>
<a href="#l6.30"></a><span id="l6.30">   bool isSubscribed;</span>
<a href="#l6.31"></a><span id="l6.31">   struct _subscribeTreeNode *prevSibling;</span>
<a href="#l6.32"></a><span id="l6.32">   struct _subscribeTreeNode *nextSibling;</span>
<a href="#l6.33"></a><span id="l6.33">   struct _subscribeTreeNode *firstChild;</span>
<a href="#l6.34"></a><span id="l6.34">   struct _subscribeTreeNode *lastChild;</span>
<a href="#l6.35"></a><span id="l6.35">   struct _subscribeTreeNode *parent;</span>
<a href="#l6.36"></a><span id="l6.36">   struct _subscribeTreeNode *cachedChild;</span>
<a href="#l6.37"></a><span id="l6.37"> #ifdef HAVE_SUBSCRIBE_DESCRIPTION</span>
<a href="#l6.38"></a><span id="l6.38">   char16_t *description;</span>
<a href="#l6.39"></a><span id="l6.39"> #endif</span>
<a href="#l6.40"></a><span id="l6.40"> #ifdef HAVE_SUBSCRIBE_MESSAGES</span>
<a href="#l6.41"></a><span id="l6.41">   uint32_t messages;</span>
<a href="#l6.42"></a><span id="l6.42"> #endif</span>
<a href="#l6.43"></a><span id="l6.43">   bool isSubscribable;</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+  bool isOpen;</span>
<a href="#l6.45"></a><span id="l6.45"> } SubscribeTreeNode;</span>
<a href="#l6.46"></a><span id="l6.46"> </span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-#if defined(DEBUG_sspitzer) || defined(DEBUG_seth)</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-#define DEBUG_SUBSCRIBE 1</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-#endif</span>
<a href="#l6.50"></a><span id="l6.50"> </span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-class nsSubscribableServer : public nsISubscribableServer</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+class nsSubscribableServer : public nsISubscribableServer,</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+                             public nsITreeView</span>
<a href="#l6.54"></a><span id="l6.54"> {</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">- public:</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+public:</span>
<a href="#l6.57"></a><span id="l6.57">   nsSubscribableServer();</span>
<a href="#l6.58"></a><span id="l6.58"> </span>
<a href="#l6.59"></a><span id="l6.59">   nsresult Init();</span>
<a href="#l6.60"></a><span id="l6.60"> </span>
<a href="#l6.61"></a><span id="l6.61">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l6.62"></a><span id="l6.62">   NS_DECL_NSISUBSCRIBABLESERVER</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+  NS_DECL_NSITREEVIEW</span>
<a href="#l6.64"></a><span id="l6.64"> </span>
<a href="#l6.65"></a><span id="l6.65"> private:</span>
<a href="#l6.66"></a><span id="l6.66">   virtual ~nsSubscribableServer();</span>
<a href="#l6.67"></a><span id="l6.67"> </span>
<a href="#l6.68"></a><span id="l6.68">   nsresult ConvertNameToUnichar(const char *inStr, char16_t **outStr);</span>
<a href="#l6.69"></a><span id="l6.69">   nsCOMPtr &lt;nsISubscribeListener&gt; mSubscribeListener;</span>
<a href="#l6.70"></a><span id="l6.70">   nsCString mIncomingServerUri;</span>
<a href="#l6.71"></a><span id="l6.71">   nsCOMPtr &lt;nsISubscribeDataSource&gt; mSubscribeDS;</span>
<a href="#l6.72"></a><span id="l6.72">   char mDelimiter;</span>
<a href="#l6.73"></a><span id="l6.73">   bool mShowFullName;</span>
<a href="#l6.74"></a><span id="l6.74">   bool mStopped;</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+  nsCString mServerType;</span>
<a href="#l6.76"></a><span id="l6.76"> </span>
<a href="#l6.77"></a><span id="l6.77">   nsCOMPtr &lt;nsIRDFResource&gt;      kNC_Child;</span>
<a href="#l6.78"></a><span id="l6.78">   nsCOMPtr &lt;nsIRDFResource&gt;      kNC_Subscribed;</span>
<a href="#l6.79"></a><span id="l6.79">   nsCOMPtr &lt;nsIRDFLiteral&gt;       kTrueLiteral;</span>
<a href="#l6.80"></a><span id="l6.80">   nsCOMPtr &lt;nsIRDFLiteral&gt;       kFalseLiteral;</span>
<a href="#l6.81"></a><span id="l6.81"> </span>
<a href="#l6.82"></a><span id="l6.82">   nsCOMPtr &lt;nsIRDFService&gt;       mRDFService;</span>
<a href="#l6.83"></a><span id="l6.83"> </span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-  SubscribeTreeNode *mTreeRoot;</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+  SubscribeTreeNode *mTreeRoot;          // root of the folder tree while items are discovered on the server</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+  nsTArray&lt;SubscribeTreeNode*&gt; mRowMap;  // array of nodes representing the rows for the tree element</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+  nsCOMPtr&lt;nsITreeSelection&gt; mSelection;</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+  nsCOMPtr&lt;nsITreeBoxObject&gt; mTree;</span>
<a href="#l6.89"></a><span id="l6.89">   nsresult FreeSubtree(SubscribeTreeNode *node);</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-  nsresult CreateNode(SubscribeTreeNode *parent, const char *name, SubscribeTreeNode **result);</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-  nsresult AddChildNode(SubscribeTreeNode *parent, const char *name, SubscribeTreeNode **child);</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-  nsresult FindAndCreateNode(const nsACString &amp;aPath,</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-                             SubscribeTreeNode **aResult);</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+  nsresult FreeRows();</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+  nsresult CreateNode(SubscribeTreeNode *parent, const char *name, const nsACString &amp;aPath, SubscribeTreeNode **result);</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+  nsresult AddChildNode(SubscribeTreeNode *parent, const char *name, const nsACString &amp;aPath, SubscribeTreeNode **child);</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+  nsresult FindAndCreateNode(const nsACString &amp;aPath, SubscribeTreeNode **aResult);</span>
<a href="#l6.98"></a><span id="l6.98">   nsresult NotifyAssert(SubscribeTreeNode *subjectNode, nsIRDFResource *property, SubscribeTreeNode *objectNode);</span>
<a href="#l6.99"></a><span id="l6.99">   nsresult NotifyChange(SubscribeTreeNode *subjectNode, nsIRDFResource *property, bool value);</span>
<a href="#l6.100"></a><span id="l6.100">   nsresult Notify(nsIRDFResource *subject, nsIRDFResource *property, nsIRDFNode *object, bool isAssert, bool isChange);</span>
<a href="#l6.101"></a><span id="l6.101">   void BuildURIFromNode(SubscribeTreeNode *node, nsACString &amp;uri);</span>
<a href="#l6.102"></a><span id="l6.102">   nsresult EnsureSubscribeDS();</span>
<a href="#l6.103"></a><span id="l6.103">   nsresult EnsureRDFService();</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+  int32_t GetRow(SubscribeTreeNode *node, bool *open);</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+  int32_t AddSubtree(SubscribeTreeNode *node, int32_t index);</span>
<a href="#l6.107"></a><span id="l6.107"> };</span>
<a href="#l6.108"></a><span id="l6.108"> </span>
<a href="#l6.109"></a><span id="l6.109"> #endif // nsSubscribableServer_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -2497,22 +2497,16 @@ nsImapIncomingServer::AddTo(const nsACSt</span>
<a href="#l7.4"></a><span id="l7.4">     return mInner-&gt;AddTo(name, addAsSubscribed, aSubscribable, changeIfExists);</span>
<a href="#l7.5"></a><span id="l7.5">   }</span>
<a href="#l7.6"></a><span id="l7.6">   return mInner-&gt;AddTo(aName, addAsSubscribed, aSubscribable, changeIfExists);</span>
<a href="#l7.7"></a><span id="l7.7"> }</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> NS_IMETHODIMP</span>
<a href="#l7.10"></a><span id="l7.10"> nsImapIncomingServer::StopPopulating(nsIMsgWindow *aMsgWindow)</span>
<a href="#l7.11"></a><span id="l7.11"> {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  nsCOMPtr&lt;nsISubscribeListener&gt; listener;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  (void) GetSubscribeListener(getter_AddRefs(listener));</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-  if (listener)</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-    listener-&gt;OnDonePopulating();</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-</span>
<a href="#l7.18"></a><span id="l7.18">   nsresult rv = EnsureInner();</span>
<a href="#l7.19"></a><span id="l7.19">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l7.20"></a><span id="l7.20">   return mInner-&gt;StopPopulating(aMsgWindow);</span>
<a href="#l7.21"></a><span id="l7.21"> }</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24"> NS_IMETHODIMP</span>
<a href="#l7.25"></a><span id="l7.25"> nsImapIncomingServer::SubscribeCleanup()</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineat">@@ -2987,16 +2981,24 @@ NS_IMETHODIMP</span>
<a href="#l7.27"></a><span id="l7.27"> nsImapIncomingServer::GetSupportsSubscribeSearch(bool *retVal)</span>
<a href="#l7.28"></a><span id="l7.28"> {</span>
<a href="#l7.29"></a><span id="l7.29">   NS_ENSURE_ARG_POINTER(retVal);</span>
<a href="#l7.30"></a><span id="l7.30">   *retVal = false;</span>
<a href="#l7.31"></a><span id="l7.31">   return NS_OK;</span>
<a href="#l7.32"></a><span id="l7.32"> }</span>
<a href="#l7.33"></a><span id="l7.33"> </span>
<a href="#l7.34"></a><span id="l7.34"> NS_IMETHODIMP</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+nsImapIncomingServer::GetFolderView(nsITreeView **aView)</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+{</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+  nsresult rv = EnsureInner();</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+  return mInner-&gt;GetFolderView(aView);</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+}</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l7.43"></a><span id="l7.43"> nsImapIncomingServer::GetFilterScope(nsMsgSearchScopeValue *filterScope)</span>
<a href="#l7.44"></a><span id="l7.44"> {</span>
<a href="#l7.45"></a><span id="l7.45">   NS_ENSURE_ARG_POINTER(filterScope);</span>
<a href="#l7.46"></a><span id="l7.46">   // If the inbox is enabled for offline use, then use the offline filter</span>
<a href="#l7.47"></a><span id="l7.47">   // scope, else use the online filter scope.</span>
<a href="#l7.48"></a><span id="l7.48">   //</span>
<a href="#l7.49"></a><span id="l7.49">   // XXX We use the same scope for all folders with the same incoming server,</span>
<a href="#l7.50"></a><span id="l7.50">   // yet it is possible to set the offline flag separately for each folder.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -942,34 +942,34 @@ nsNntpIncomingServer::StartPopulating(ns</span>
<a href="#l8.4"></a><span id="l8.4">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6">   mHostInfoLoaded = false;</span>
<a href="#l8.7"></a><span id="l8.7">   mVersion = INVALID_VERSION;</span>
<a href="#l8.8"></a><span id="l8.8">   mGroupsOnServer.Clear();</span>
<a href="#l8.9"></a><span id="l8.9">   mGetOnlyNew = aGetOnlyNew;</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11">   if (!aForceToServer) {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  rv = LoadHostInfoFile();</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+    rv = LoadHostInfoFile();</span>
<a href="#l8.14"></a><span id="l8.14">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l8.15"></a><span id="l8.15">   }</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17">   // mHostInfoLoaded can be false if we failed to load anything</span>
<a href="#l8.18"></a><span id="l8.18">   if (aForceToServer || !mHostInfoLoaded || (mVersion != VALID_VERSION)) {</span>
<a href="#l8.19"></a><span id="l8.19">     // set these to true, so when we are done and we call WriteHostInfoFile()</span>
<a href="#l8.20"></a><span id="l8.20">     // we'll write out to hostinfo.dat</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-  mHostInfoHasChanged = true;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-  mVersion = VALID_VERSION;</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+    mHostInfoHasChanged = true;</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+    mVersion = VALID_VERSION;</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-  mGroupsOnServer.Clear();</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-  rv = nntpService-&gt;GetListOfGroupsOnServer(this, aMsgWindow, aGetOnlyNew);</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+    mGroupsOnServer.Clear();</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+    rv = nntpService-&gt;GetListOfGroupsOnServer(this, aMsgWindow, aGetOnlyNew);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l8.32"></a><span id="l8.32">   }</span>
<a href="#l8.33"></a><span id="l8.33">   else {</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-  rv = StopPopulating(aMsgWindow);</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+    rv = StopPopulating(aMsgWindow);</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l8.38"></a><span id="l8.38">   }</span>
<a href="#l8.39"></a><span id="l8.39"> </span>
<a href="#l8.40"></a><span id="l8.40">   return NS_OK;</span>
<a href="#l8.41"></a><span id="l8.41"> }</span>
<a href="#l8.42"></a><span id="l8.42"> </span>
<a href="#l8.43"></a><span id="l8.43"> /**</span>
<a href="#l8.44"></a><span id="l8.44">  * This method is the entry point for |nsNNTPProtocol| class. |aName| is now</span>
<a href="#l8.45"></a><span id="l8.45">  * encoded in the serverside character encoding, but we need to handle</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineat">@@ -1111,26 +1111,16 @@ nsNntpIncomingServer::AddTo(const nsACSt</span>
<a href="#l8.47"></a><span id="l8.47">   return rv;</span>
<a href="#l8.48"></a><span id="l8.48"> }</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50"> NS_IMETHODIMP</span>
<a href="#l8.51"></a><span id="l8.51"> nsNntpIncomingServer::StopPopulating(nsIMsgWindow *aMsgWindow)</span>
<a href="#l8.52"></a><span id="l8.52"> {</span>
<a href="#l8.53"></a><span id="l8.53">   nsresult rv = NS_OK;</span>
<a href="#l8.54"></a><span id="l8.54"> </span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-  nsCOMPtr&lt;nsISubscribeListener&gt; listener;</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-  rv = GetSubscribeListener(getter_AddRefs(listener));</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-  if (!listener)</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-  rv = listener-&gt;OnDonePopulating();</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-</span>
<a href="#l8.65"></a><span id="l8.65">   rv = EnsureInner();</span>
<a href="#l8.66"></a><span id="l8.66">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.67"></a><span id="l8.67">   rv = mInner-&gt;StopPopulating(aMsgWindow);</span>
<a href="#l8.68"></a><span id="l8.68">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.69"></a><span id="l8.69"> </span>
<a href="#l8.70"></a><span id="l8.70">   if (!mGetOnlyNew &amp;&amp; !mHostInfoLoaded)</span>
<a href="#l8.71"></a><span id="l8.71">   {</span>
<a href="#l8.72"></a><span id="l8.72">     rv = WriteHostInfoFile();</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineat">@@ -1691,16 +1681,24 @@ nsNntpIncomingServer::SetSearchValue(con</span>
<a href="#l8.74"></a><span id="l8.74"> NS_IMETHODIMP</span>
<a href="#l8.75"></a><span id="l8.75"> nsNntpIncomingServer::GetSupportsSubscribeSearch(bool *retVal)</span>
<a href="#l8.76"></a><span id="l8.76"> {</span>
<a href="#l8.77"></a><span id="l8.77">   *retVal = true;</span>
<a href="#l8.78"></a><span id="l8.78">   return NS_OK;</span>
<a href="#l8.79"></a><span id="l8.79"> }</span>
<a href="#l8.80"></a><span id="l8.80"> </span>
<a href="#l8.81"></a><span id="l8.81"> NS_IMETHODIMP</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+nsNntpIncomingServer::GetFolderView(nsITreeView **aView)</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+{</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+  nsresult rv = EnsureInner();</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+  return mInner-&gt;GetFolderView(aView);</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+}</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l8.90"></a><span id="l8.90"> nsNntpIncomingServer::GetRowCount(int32_t *aRowCount)</span>
<a href="#l8.91"></a><span id="l8.91"> {</span>
<a href="#l8.92"></a><span id="l8.92">   *aRowCount = mSubscribeSearchResult.Length();</span>
<a href="#l8.93"></a><span id="l8.93">   return NS_OK;</span>
<a href="#l8.94"></a><span id="l8.94"> }</span>
<a href="#l8.95"></a><span id="l8.95"> </span>
<a href="#l8.96"></a><span id="l8.96"> NS_IMETHODIMP</span>
<a href="#l8.97"></a><span id="l8.97"> nsNntpIncomingServer::GetSelection(nsITreeSelection * *aSelection)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

