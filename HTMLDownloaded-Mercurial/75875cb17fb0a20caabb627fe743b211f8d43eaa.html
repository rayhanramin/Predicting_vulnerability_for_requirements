<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 7277:75875cb17fb0a20caabb627fe743b211f8d43eaa</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 75875cb17fb0a20caabb627fe743b211f8d43eaa" />
<meta property="og:url" content="/comm-central/rev/75875cb17fb0a20caabb627fe743b211f8d43eaa" />
<meta property="og:description" content="Rewrite account creation wizard UI code (emailWizard.js). Bug 549045, r=bwinton, ui-r=clarkbw, a=Standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 75875cb17fb0a20caabb627fe743b211f8d43eaa 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/75875cb17fb0a20caabb627fe743b211f8d43eaa">shortlog</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/75875cb17fb0a20caabb627fe743b211f8d43eaa">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa">files</a> |
changeset |
<a href="/comm-central/raw-rev/75875cb17fb0a20caabb627fe743b211f8d43eaa">raw</a>  | <a href="/comm-central/archive/75875cb17fb0a20caabb627fe743b211f8d43eaa.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Rewrite account creation wizard UI code (emailWizard.js). <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=549045">Bug 549045</a>, r=bwinton, ui-r=clarkbw, a=Standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#66;&#117;&#99;&#107;&#115;&#99;&#104;&#32;&#60;&#98;&#101;&#110;&#46;&#98;&#117;&#99;&#107;&#115;&#99;&#104;&#64;&#98;&#101;&#111;&#110;&#101;&#120;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 08 Mar 2011 14:27:43 +0100</td></tr>

<tr>
 <td>changeset 7277</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/75875cb17fb0a20caabb627fe743b211f8d43eaa">75875cb17fb0a20caabb627fe743b211f8d43eaa</a></td>
</tr>



<tr>
<td>parent 7276</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2bb4e4f86e8d83f947818258b4c0f46ede2f3847">2bb4e4f86e8d83f947818258b4c0f46ede2f3847</a>
</td>
</tr>

<tr>
<td>child 7278</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/382b3365a2e9c19f9ac3227d04e0f43cc6c96ddd">382b3365a2e9c19f9ac3227d04e0f43cc6c96ddd</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=75875cb17fb0a20caabb627fe743b211f8d43eaa">5585</a></td></tr>
<tr><td>push user</td><td>mozilla.BenB@bucksch.org</td></tr>
<tr><td>push date</td><td class="date age">Tue, 08 Mar 2011 13:28:40 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@75875cb17fb0 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=75875cb17fb0a20caabb627fe743b211f8d43eaa">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=75875cb17fb0a20caabb627fe743b211f8d43eaa&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=75875cb17fb0a20caabb627fe743b211f8d43eaa&newProject=comm-central&newRevision=75875cb17fb0a20caabb627fe743b211f8d43eaa&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=75875cb17fb0a20caabb627fe743b211f8d43eaa&newProject=comm-central&newRevision=75875cb17fb0a20caabb627fe743b211f8d43eaa&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=75875cb17fb0a20caabb627fe743b211f8d43eaa&newProject=comm-central&newRevision=75875cb17fb0a20caabb627fe743b211f8d43eaa&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bwinton%29&revcount=50">bwinton</a>, <a href="/comm-central/log?rev=reviewer%28clarkbw%29&revcount=50">clarkbw</a>, <a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=549045">549045</a></td></tr>




</table></div>

<div class="page_body description">Rewrite account creation wizard UI code (emailWizard.js). <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=549045">Bug 549045</a>, r=bwinton, ui-r=clarkbw, a=Standard8

The previous UI code had a bit the taste of spaghetti bolognese. Delicious, but hard to follow.

Concrete problem was mostly when you did not want autodetection, but manual config:
1. The Stop button didn't work, it continued for a bit after you pressed Stop
2. When you pressed &quot;Manual Config&quot;, we immediately created the account and went into the
   account manager, instead of going into the inline &quot;Edit&quot; mode.
3. Worse, the account was created with whatever server happened to be tested last,
   so when pressing &quot;Manual config&quot;, you got a litterally random config.
   You couldn't change IMAP&lt;-&gt;POP3 later, either.
4. The inline Edit didn't take the values you gave it as given, but second-guessed them
   upon testing, and felt free to change them, even if the user explicitly said otherwise.

Understandably, that infuriated some users.
This change should fix all that.
The stop button now actually works, and the &quot;Manual config&quot; button goes into &quot;Edit&quot; mode.

This also uses a different philosophy, in a way:
After detection, we have a &quot;result&quot; screen, where the user is only *presented*
the values that we found, but he cannot *change* them (apart from IMAP vs. POP3).
The result screen is only to confirm that the servers are good. It should be
very quick and easy to read.
If the user wants to change the values, we make that easy with the &quot;manual config&quot;
button (formerly &quot;Edit&quot;) and going into a different where we present all the values
as input fields. There, we take what the user said as a given command.
But the default is &quot;Auto&quot;, where we can guess, so you have a combination of both
user being in command and us supporting the user.
Only if the user needs to change some advanced values like IMAP root folder, and
wants to do so immediately, we have the &quot;Advanced config&quot; button, which does the
same as the old &quot;manual config&quot;.

This was a lot of work to code, and then even more with a one-year foray to get
this reviewed, so I really hope this helps.

Permission to commit into CLOSED TREE by Standard8/9 on IRC.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/locales/en-US/chrome/messenger/accountCreation.dtd">mail/locales/en-US/chrome/messenger/accountCreation.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/locales/en-US/chrome/messenger/accountCreation.dtd">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/locales/en-US/chrome/messenger/accountCreation.dtd">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/locales/en-US/chrome/messenger/accountCreation.dtd">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/locales/en-US/chrome/messenger/accountCreation.dtd">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/locales/en-US/chrome/messenger/accountCreation.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/locales/en-US/chrome/messenger/accountCreation.properties">mail/locales/en-US/chrome/messenger/accountCreation.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/locales/en-US/chrome/messenger/accountCreation.properties">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/locales/en-US/chrome/messenger/accountCreation.properties">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/locales/en-US/chrome/messenger/accountCreation.properties">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/locales/en-US/chrome/messenger/accountCreation.properties">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/locales/en-US/chrome/messenger/accountCreation.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/test/mozmill/account/test-mail-account-setup-wizard.js">mail/test/mozmill/account/test-mail-account-setup-wizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/test/mozmill/account/test-mail-account-setup-wizard.js">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/test/mozmill/account/test-mail-account-setup-wizard.js">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/test/mozmill/account/test-mail-account-setup-wizard.js">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/test/mozmill/account/test-mail-account-setup-wizard.js">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/test/mozmill/account/test-mail-account-setup-wizard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/test/mozmill/account/test-retest-config.js">mail/test/mozmill/account/test-retest-config.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/test/mozmill/account/test-retest-config.js">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/test/mozmill/account/test-retest-config.js">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/test/mozmill/account/test-retest-config.js">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/test/mozmill/account/test-retest-config.js">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/test/mozmill/account/test-retest-config.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">mail/test/mozmill/shared-modules/test-account-manager-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/themes/gnomestripe/mail/accountCreation.css">mail/themes/gnomestripe/mail/accountCreation.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/themes/gnomestripe/mail/accountCreation.css">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/themes/gnomestripe/mail/accountCreation.css">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/themes/gnomestripe/mail/accountCreation.css">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/themes/gnomestripe/mail/accountCreation.css">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/themes/gnomestripe/mail/accountCreation.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/themes/pinstripe/mail/accountCreation.css">mail/themes/pinstripe/mail/accountCreation.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/themes/pinstripe/mail/accountCreation.css">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/themes/pinstripe/mail/accountCreation.css">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/themes/pinstripe/mail/accountCreation.css">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/themes/pinstripe/mail/accountCreation.css">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/themes/pinstripe/mail/accountCreation.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/themes/qute/mail/accountCreation.css">mail/themes/qute/mail/accountCreation.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/themes/qute/mail/accountCreation.css">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/themes/qute/mail/accountCreation.css">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/themes/qute/mail/accountCreation.css">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/themes/qute/mail/accountCreation.css">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mail/themes/qute/mail/accountCreation.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountUtils.js">mailnews/base/prefs/content/accountUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountUtils.js">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountUtils.js">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountUtils.js">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountUtils.js">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/accountConfig.js">mailnews/base/prefs/content/accountcreation/accountConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/accountConfig.js">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/accountConfig.js">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/accountConfig.js">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/accountConfig.js">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/accountConfig.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/createInBackend.js">mailnews/base/prefs/content/accountcreation/createInBackend.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/createInBackend.js">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/createInBackend.js">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/createInBackend.js">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/createInBackend.js">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/createInBackend.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/emailWizard.js">mailnews/base/prefs/content/accountcreation/emailWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/emailWizard.js">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/emailWizard.js">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/emailWizard.js">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/emailWizard.js">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/emailWizard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/emailWizard.xul">mailnews/base/prefs/content/accountcreation/emailWizard.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/emailWizard.xul">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/emailWizard.xul">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/emailWizard.xul">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/emailWizard.xul">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/emailWizard.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/fetchConfig.js">mailnews/base/prefs/content/accountcreation/fetchConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/fetchConfig.js">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/fetchConfig.js">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/fetchConfig.js">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/fetchConfig.js">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/fetchConfig.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/fetchhttp.js">mailnews/base/prefs/content/accountcreation/fetchhttp.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/fetchhttp.js">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/fetchhttp.js">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/fetchhttp.js">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/fetchhttp.js">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/fetchhttp.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/guessConfig.js">mailnews/base/prefs/content/accountcreation/guessConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/guessConfig.js">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/guessConfig.js">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/guessConfig.js">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/guessConfig.js">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/guessConfig.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/readFromXML.js">mailnews/base/prefs/content/accountcreation/readFromXML.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/readFromXML.js">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/readFromXML.js">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/readFromXML.js">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/readFromXML.js">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/readFromXML.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/sanitizeDatatypes.js">mailnews/base/prefs/content/accountcreation/sanitizeDatatypes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/sanitizeDatatypes.js">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/sanitizeDatatypes.js">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/sanitizeDatatypes.js">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/sanitizeDatatypes.js">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/sanitizeDatatypes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/util.js">mailnews/base/prefs/content/accountcreation/util.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/util.js">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/util.js">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/util.js">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/util.js">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/util.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/verifyConfig.js">mailnews/base/prefs/content/accountcreation/verifyConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/verifyConfig.js">file</a> |
<a href="/comm-central/annotate/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/verifyConfig.js">annotate</a> |
<a href="/comm-central/diff/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/verifyConfig.js">diff</a> |
<a href="/comm-central/comparison/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/verifyConfig.js">comparison</a> |
<a href="/comm-central/log/75875cb17fb0a20caabb627fe743b211f8d43eaa/mailnews/base/prefs/content/accountcreation/verifyConfig.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/accountCreation.dtd</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/accountCreation.dtd</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -5,52 +5,56 @@</span>
<a href="#l1.4"></a><span id="l1.4"> &lt;!ENTITY name.text                       &quot;Your name, as shown to others&quot;&gt;</span>
<a href="#l1.5"></a><span id="l1.5"> &lt;!ENTITY email.label                     &quot;Email address:&quot;&gt;</span>
<a href="#l1.6"></a><span id="l1.6"> &lt;!ENTITY email.accesskey                 &quot;l&quot;&gt;</span>
<a href="#l1.7"></a><span id="l1.7"> &lt;!ENTITY email.placeholder               &quot;email@example.com&quot;&gt;</span>
<a href="#l1.8"></a><span id="l1.8"> &lt;!ENTITY password.label                  &quot;Password:&quot;&gt;</span>
<a href="#l1.9"></a><span id="l1.9"> &lt;!ENTITY password.accesskey              &quot;P&quot;&gt;</span>
<a href="#l1.10"></a><span id="l1.10"> &lt;!ENTITY password.placeholder            &quot;Password&quot;&gt;</span>
<a href="#l1.11"></a><span id="l1.11"> &lt;!ENTITY password.text                   &quot;Optional, will only be used to validate the username&quot;&gt;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+&lt;!ENTITY rememberPassword.label          &quot;Remember password&quot;&gt;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+&lt;!ENTITY rememberPassword.accesskey      &quot;m&quot;&gt;</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-&lt;!ENTITY accountInformation.label        &quot;Account Information&quot;&gt;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-&lt;!ENTITY username2.label                 &quot;Username:&quot;&gt;</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+&lt;!ENTITY imapLong.label                  &quot;IMAP (remote folders)&quot;&gt;</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+&lt;!ENTITY pop3Long.label                  &quot;POP3 (keep mail on your computer)&quot;&gt;</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+</span>
<a href="#l1.20"></a><span id="l1.20"> &lt;!ENTITY incoming.label                  &quot;Incoming:&quot;&gt;</span>
<a href="#l1.21"></a><span id="l1.21"> &lt;!ENTITY outgoing.label                  &quot;Outgoing:&quot;&gt;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+&lt;!ENTITY username.label                  &quot;Username:&quot;&gt;</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+&lt;!ENTITY hostname.label                  &quot;Server hostname&quot;&gt;</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+&lt;!ENTITY port.label                      &quot;Port&quot;&gt;</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+&lt;!ENTITY ssl.label                       &quot;SSL&quot;&gt;</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+&lt;!ENTITY auth.label                      &quot;Authentication&quot;&gt;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+&lt;!ENTITY imap.label                      &quot;IMAP&quot;&gt;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+&lt;!ENTITY pop3.label                       &quot;POP3&quot;&gt;</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+&lt;!ENTITY smtp.label                      &quot;SMTP&quot;&gt;</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+&lt;!ENTITY autodetect.label                &quot;Autodetect&quot;&gt;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+&lt;!-- LOCALIZATION NOTE(noEncryption.label): Neither SSL/TLS nor STARTTLS.</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+     Transmission of emails in cleartext over the Internet. --&gt;</span>
<a href="#l1.33"></a><span id="l1.33"> &lt;!ENTITY noEncryption.label              &quot;None&quot;&gt;</span>
<a href="#l1.34"></a><span id="l1.34"> &lt;!ENTITY starttls.label                  &quot;STARTTLS&quot;&gt;</span>
<a href="#l1.35"></a><span id="l1.35"> &lt;!ENTITY sslTls.label                    &quot;SSL/TLS&quot;&gt;</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-&lt;!ENTITY imap.label                      &quot;IMAP&quot;&gt;</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-&lt;!ENTITY pop.label                       &quot;POP&quot;&gt;</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-&lt;!ENTITY smtp.label                      &quot;SMTP&quot;&gt;</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-&lt;!ENTITY imap.description                &quot;IMAP - Access folders and messages from multiple computers&quot;&gt;</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-&lt;!ENTITY pop.description                 &quot;POP - Download all messages onto this computer, folders are local only&quot;&gt;</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-&lt;!ENTITY recommended-appendix.label      &quot;(recommended)&quot;&gt;</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-&lt;!ENTITY manualSetup.label               &quot;Manual Setup…&quot;&gt;</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-&lt;!ENTITY manualSetup.accesskey           &quot;S&quot;&gt;</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+&lt;!ENTITY advancedSetup.label             &quot;Advanced config&quot;&gt;</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+&lt;!ENTITY advancedSetup.accesskey         &quot;A&quot;&gt;</span>
<a href="#l1.48"></a><span id="l1.48"> &lt;!ENTITY cancel.label                    &quot;Cancel&quot;&gt;</span>
<a href="#l1.49"></a><span id="l1.49"> &lt;!ENTITY cancel.accesskey                &quot;a&quot;&gt;</span>
<a href="#l1.50"></a><span id="l1.50"> &lt;!ENTITY continue.label                  &quot;Continue&quot;&gt;</span>
<a href="#l1.51"></a><span id="l1.51"> &lt;!ENTITY continue.accesskey              &quot;C&quot;&gt;</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-&lt;!ENTITY startOver.label                 &quot;Start over&quot;&gt;</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-&lt;!ENTITY startOver.accesskey             &quot;o&quot;&gt;</span>
<a href="#l1.54"></a><span id="l1.54"> &lt;!ENTITY stop.label                      &quot;Stop&quot;&gt;</span>
<a href="#l1.55"></a><span id="l1.55"> &lt;!ENTITY stop.accesskey                  &quot;S&quot;&gt;</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-&lt;!-- LOCALIZATION NOTE (retest.label): This is the text that is</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-     displayed on the button which will re-guess the account configuration,</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-     taking into account the settings the user has changed. --&gt;</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-&lt;!ENTITY retest.label                    &quot;Re-test Configuration&quot;&gt;</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-&lt;!ENTITY retest.accesskey                &quot;R&quot;&gt;</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-&lt;!ENTITY edit.label                      &quot;Edit&quot;&gt;</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-&lt;!ENTITY edit.accesskey                  &quot;E&quot;&gt;</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (half-manual-test.label): This is the text that is</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+     displayed on the button in manual edit mode which will re-guess</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+     the account configuration, taking into account the settings that</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+     the user has manually changed. --&gt;</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+&lt;!ENTITY half-manual-test.label          &quot;Re-test&quot;&gt;</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+&lt;!ENTITY half-manual-test.accesskey      &quot;t&quot;&gt;</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+&lt;!ENTITY manual-edit.label               &quot;Manual config&quot;&gt;</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+&lt;!ENTITY manual-edit.accesskey           &quot;M&quot;&gt;</span>
<a href="#l1.71"></a><span id="l1.71"> </span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-&lt;!ENTITY rememberPassword.label          &quot;Remember password&quot;&gt;</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-&lt;!ENTITY rememberPassword.accesskey      &quot;m&quot;&gt;</span>
<a href="#l1.74"></a><span id="l1.74"> </span>
<a href="#l1.75"></a><span id="l1.75"> &lt;!ENTITY warning.label                   &quot;Warning!&quot;&gt;</span>
<a href="#l1.76"></a><span id="l1.76"> &lt;!ENTITY incomingSettings.label          &quot;Incoming settings:&quot;&gt;</span>
<a href="#l1.77"></a><span id="l1.77"> &lt;!ENTITY outgoingSettings.label          &quot;Outgoing settings:&quot;&gt;</span>
<a href="#l1.78"></a><span id="l1.78"> &lt;!ENTITY technicaldetails.label          &quot;Technical Details&quot;&gt;</span>
<a href="#l1.79"></a><span id="l1.79"> &lt;!-- LOCALIZATION NOTE (confirmWarning.label): If there is a security</span>
<a href="#l1.80"></a><span id="l1.80">      warning on the outgoing server, then the user will need to check a</span>
<a href="#l1.81"></a><span id="l1.81">      checkbox beside this text before continuing. --&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/accountCreation.properties</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/accountCreation.properties</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -4,32 +4,38 @@</span>
<a href="#l2.4"></a><span id="l2.4"> cleartext_warning=%1$S does not use encryption.</span>
<a href="#l2.5"></a><span id="l2.5"> # LOCALIZATION NOTE(selfsigned_warning): %1$S will be the hostname of the server the user was trying to connect to.</span>
<a href="#l2.6"></a><span id="l2.6"> selfsigned_warning=%1$S does not use a trusted certificate.</span>
<a href="#l2.7"></a><span id="l2.7"> selfsigned_details=Normally, a secure mail server will present a trusted certificate to prove that it is really the server it claims to be. The connection to the mail server will be encrypted but cannot be validated as being the correct server.</span>
<a href="#l2.8"></a><span id="l2.8"> cleartext_details=Insecure mail servers do not use encrypted connections to protect your passwords and private information. By connecting to this server you could expose your password and private information.</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> # LOCALIZATION NOTE(default_server_tag): Used to indicate the default smtp server in the server dropdown list.</span>
<a href="#l2.11"></a><span id="l2.11"> default_server_tag= (default)</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+# LOCALIZATION NOTE(port_auto): It must be short (4-5 characters max.).</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+# Content of server port field (usually a number), used when the user didn't</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+# enter anything yet and we'll automatically detect it later.</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+port_auto=Auto</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> # config titles</span>
<a href="#l2.18"></a><span id="l2.18"> # LOCALIZATION NOTE(looking_up_settings_disk): Referring to Thunderbird installation folder on user's harddisk. %1$S will be the brandShortName.</span>
<a href="#l2.19"></a><span id="l2.19"> looking_up_settings_disk=Looking up configuration: %1$S installation</span>
<a href="#l2.20"></a><span id="l2.20"> looking_up_settings_isp=Looking up configuration: Email provider</span>
<a href="#l2.21"></a><span id="l2.21"> # LOCALIZATION NOTE(looking_up_settings_db): Do not translate or replace Mozilla. It stands for the public project mozilla.org, not Mozilla Messaging. The database is a generic, public domain facility usable by any client.</span>
<a href="#l2.22"></a><span id="l2.22"> looking_up_settings_db=Looking up configuration: Mozilla ISP database</span>
<a href="#l2.23"></a><span id="l2.23"> # LOCALIZATION NOTE(looking_up_settings_guess): We are checking common server names like pop., pop3., smtp., mail., without knowing whether they exist or really serve this email account. If a server responds, we try to talk to it via POP/IMAP/SMTP protocols and query its capabilities. If that succeeds, we assume we found a configuration. Of course, it may still be wrong, but it often works.</span>
<a href="#l2.24"></a><span id="l2.24"> looking_up_settings_guess=Looking up configuration: Trying common server names</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+looking_up_settings_halfmanual=Looking up configuration: Probing server</span>
<a href="#l2.26"></a><span id="l2.26"> # LOCALIZATION NOTE(found_settings_disk): Referring to Thunderbird installation folder on user's harddisk. %1$S will be the brandShortName.</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-found_settings_disk=The following settings were found on: %1$S installation</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-found_settings_isp=The following settings were found from: Email provider</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+found_settings_disk=Configuration found on %1$S installation</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+found_settings_isp=Configuration found at email provider</span>
<a href="#l2.31"></a><span id="l2.31"> # LOCALIZATION NOTE(found_settings_db): Do not translate or replace Mozilla. It stands for the public project mozilla.org, not Mozilla Messaging. The database is a generic, public domain facility usable by any client.</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-found_settings_db=The following settings were found from: Mozilla ISP database</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+found_settings_db=Configuration found in Mozilla ISP database</span>
<a href="#l2.34"></a><span id="l2.34"> # LOCALIZATION NOTE(found_settings_guess): We tried common mail server names and we found a mail server and talked to it and it responded properly, so we think we found a suitable configuration, but we are only about 80% certain that it is the correct setting for this email address. There's a chance that email address may not actually be served by this server and it won't work, or that there is a better server.</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-found_settings_guess=The following settings were found by trying common server names</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+found_settings_guess=Configuration found by trying common server names</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+found_settings_halfmanual=The following settings were found by probing the given server</span>
<a href="#l2.38"></a><span id="l2.38"> # LOCALIZATION NOTE(failed_to_find_settings): %1$S will be the brandShortName.</span>
<a href="#l2.39"></a><span id="l2.39"> failed_to_find_settings=%1$S failed to find the settings for your email account.</span>
<a href="#l2.40"></a><span id="l2.40"> manually_edit_config=Editing Config</span>
<a href="#l2.41"></a><span id="l2.41"> </span>
<a href="#l2.42"></a><span id="l2.42"> # config subtitles</span>
<a href="#l2.43"></a><span id="l2.43"> check_preconfig=checking for pre-configuration…</span>
<a href="#l2.44"></a><span id="l2.44"> found_preconfig=found pre-configuration</span>
<a href="#l2.45"></a><span id="l2.45"> checking_config=checking configuration…</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineat">@@ -50,15 +56,42 @@ password_ok=Password ok!</span>
<a href="#l2.47"></a><span id="l2.47"> user_pass_invalid=Username or password invalid</span>
<a href="#l2.48"></a><span id="l2.48"> check_server_details=Checking server details</span>
<a href="#l2.49"></a><span id="l2.49"> check_in_server_details=Checking incoming server details</span>
<a href="#l2.50"></a><span id="l2.50"> check_out_server_details=Checking outgoing server details</span>
<a href="#l2.51"></a><span id="l2.51"> </span>
<a href="#l2.52"></a><span id="l2.52"> error_creating_account=Error Creating Account</span>
<a href="#l2.53"></a><span id="l2.53"> incoming_server_exists=Incoming server already exists.</span>
<a href="#l2.54"></a><span id="l2.54"> </span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-# LOCALIZATION NOTE(no_encryption): Neither SSL/TLS nor STARTTLS. Transmission of emails in cleartext over the Internet.</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-no_encryption=No encryption</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-ssl_tls=SSL/TLS</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-starttls=STARTTLS</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-</span>
<a href="#l2.60"></a><span id="l2.60"> please_enter_name=Please enter your name.</span>
<a href="#l2.61"></a><span id="l2.61"> double_check_email=Double check this email address!</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+#config result display</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+# LOCALIZATION NOTE(resultUnknown): Displayed instead of resultIncoming,</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+# resultOutgoing or resultUsername when we don't have a proper value.</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+resultUnknown=Unknown</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+# LOCALIZATION NOTE(resultIncoming):</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+# %1$S will be replaced with either resultIMAP, resultPOP3 or resultSMTP.</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+# %2$S will be replaced with the server hostname</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+#   with possibly a port appended as &quot;:&quot;+port.</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+#   The domain part may be made bold.</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+# %3$S will be replaced with either resultNoEncryption or resultSSL or</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+#    resultSTARTTLS.</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+# %4$S will be replaced with either resultSSLCertWeak or resultSSLCertOK</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+#    (which should normally be empty)</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+# You may adjust the strings to be a real sentence.</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+resultIncoming=%1$S, %2$S, %3$S%4$S</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+# LOCALIZATION NOTE(resultOutgoing): see resultIncoming</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+resultOutgoing=%1$S, %2$S, %3$S%4$S</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+resultOutgoingExisting=Use existing outgoing SMTP server</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+resultIMAP=IMAP</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+resultPOP3=POP3</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+resultSMTP=SMTP</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+# LOCALIZATION NOTE(resultNoEncryption): Neither SSL/TLS nor STARTTLS. Transmission of emails in cleartext over the Internet.</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+resultNoEncryption=No Encryption</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+resultSSL=SSL</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+resultSTARTTLS=STARTTLS</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+# LOCALIZATION NOTE(resultSSLCertWeak): \u0020 is just a space</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+resultSSLCertWeak=\u0020(Warning: Could not verify server)</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+resultSSLCertOK=</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+resultSTARTTLS=STARTTLS</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+resultUsernameBoth=%1$S</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+resultUsernameDifferent=Incoming: %1$S, Outgoing: %2$S</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/test/mozmill/account/test-mail-account-setup-wizard.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-mail-account-setup-wizard.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -118,19 +118,19 @@ function test_mail_account_setup() {</span>
<a href="#l3.4"></a><span id="l3.4">   input_value(awc, user.password);</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6">   // Load the autoconfig file from http://localhost:433**/autoconfig/example.com</span>
<a href="#l3.7"></a><span id="l3.7">   awc.e(&quot;next_button&quot;).click();</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9">   let config = null;</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11">   // XXX: This should probably use a notification, once we fix bug 561143.</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  awc.waitForEval(&quot;subject._currentConfigFilledIn != null&quot;, 8000, 600,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  awc.waitForEval(&quot;subject._currentConfig != null&quot;, 8000, 600,</span>
<a href="#l3.14"></a><span id="l3.14">                   awc.window.gEmailConfigWizard);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-  config = awc.window.gEmailConfigWizard._currentConfigFilledIn;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  config = awc.window.gEmailConfigWizard.getConcreteConfig();</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18">   // Open the advanced settings (Account Manager) to create the account</span>
<a href="#l3.19"></a><span id="l3.19">   // immediately.  We use an invalid email/password so the setup will fail</span>
<a href="#l3.20"></a><span id="l3.20">   // anyway.</span>
<a href="#l3.21"></a><span id="l3.21">   open_advanced_settings_from_account_wizard(subtest_verify_account, awc);</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23">   // Clean up</span>
<a href="#l3.24"></a><span id="l3.24">   pref.clearUserPref(pref_name);</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineat">@@ -143,17 +143,17 @@ function subtest_verify_account(amc) {</span>
<a href="#l3.26"></a><span id="l3.26">   incoming = account.incomingServer;</span>
<a href="#l3.27"></a><span id="l3.27">   outgoing = amc.window.smtpService.getServerByKey(identity.smtpServerKey);</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29">   let config = {</span>
<a href="#l3.30"></a><span id="l3.30">     &quot;incoming server username&quot;: {</span>
<a href="#l3.31"></a><span id="l3.31">       actual: incoming.username, expected: user.email.split(&quot;@&quot;)[0]</span>
<a href="#l3.32"></a><span id="l3.32">     },</span>
<a href="#l3.33"></a><span id="l3.33">     &quot;outgoing server username&quot;: {</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-      actual: outgoing.username, expected: user.email</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+      actual: outgoing.username, expected: user.email.split(&quot;@&quot;)[0]</span>
<a href="#l3.36"></a><span id="l3.36">     },</span>
<a href="#l3.37"></a><span id="l3.37">     &quot;incoming server hostname&quot;: {</span>
<a href="#l3.38"></a><span id="l3.38">       // Note: N in the hostName is uppercase</span>
<a href="#l3.39"></a><span id="l3.39">       actual: incoming.hostName, expected: user.incomingHost</span>
<a href="#l3.40"></a><span id="l3.40">     },</span>
<a href="#l3.41"></a><span id="l3.41">     &quot;outgoing server hostname&quot;: {</span>
<a href="#l3.42"></a><span id="l3.42">       // And this is lowercase</span>
<a href="#l3.43"></a><span id="l3.43">       actual: outgoing.hostname, expected: user.outgoingHost</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineat">@@ -186,17 +186,17 @@ function test_bad_password_uses_old_sett</span>
<a href="#l3.45"></a><span id="l3.45">   // Set the pref to load a local autoconfig file.</span>
<a href="#l3.46"></a><span id="l3.46">   let pref = Cc[&quot;@mozilla.org/preferences-service;1&quot;].getService(Ci.nsIPrefBranch);</span>
<a href="#l3.47"></a><span id="l3.47">   let pref_name = &quot;mailnews.auto_config_url&quot;;</span>
<a href="#l3.48"></a><span id="l3.48">   let url = collector.addHttpResource(&quot;../account/xml&quot;, &quot;autoconfig&quot;);</span>
<a href="#l3.49"></a><span id="l3.49">   try {</span>
<a href="#l3.50"></a><span id="l3.50">     pref.setCharPref(pref_name, url);</span>
<a href="#l3.51"></a><span id="l3.51"> </span>
<a href="#l3.52"></a><span id="l3.52">     // Force .com MIME-Type to text/xml</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-   collector.httpd.registerContentType(&quot;com&quot;, &quot;text/xml&quot;);</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+    collector.httpd.registerContentType(&quot;com&quot;, &quot;text/xml&quot;);</span>
<a href="#l3.55"></a><span id="l3.55"> </span>
<a href="#l3.56"></a><span id="l3.56">     mc.sleep(0);</span>
<a href="#l3.57"></a><span id="l3.57">     awc = open_mail_account_setup_wizard();</span>
<a href="#l3.58"></a><span id="l3.58"> </span>
<a href="#l3.59"></a><span id="l3.59">     // Input user's account information</span>
<a href="#l3.60"></a><span id="l3.60">     awc.e(&quot;realname&quot;).focus();</span>
<a href="#l3.61"></a><span id="l3.61">     input_value(awc, user.name);</span>
<a href="#l3.62"></a><span id="l3.62">     awc.keypress(null, &quot;VK_TAB&quot;, {});</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineat">@@ -204,29 +204,30 @@ function test_bad_password_uses_old_sett</span>
<a href="#l3.64"></a><span id="l3.64">     awc.keypress(null, &quot;VK_TAB&quot;, {});</span>
<a href="#l3.65"></a><span id="l3.65">     input_value(awc, user.password);</span>
<a href="#l3.66"></a><span id="l3.66"> </span>
<a href="#l3.67"></a><span id="l3.67">     // Load the autoconfig file from http://localhost:433**/autoconfig/example.com</span>
<a href="#l3.68"></a><span id="l3.68">     awc.e(&quot;next_button&quot;).click();</span>
<a href="#l3.69"></a><span id="l3.69"> </span>
<a href="#l3.70"></a><span id="l3.70">     let config = null;</span>
<a href="#l3.71"></a><span id="l3.71"> </span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-    awc.waitForEval(&quot;subject.disabled == false&quot;, 8000, 600,</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-                    awc.e(&quot;create_button&quot;));</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+    awc.waitForEval(&quot;subject.disabled == false &amp;&amp; subject.hidden == false&quot;,</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+                    8000, 600, awc.e(&quot;create_button&quot;));</span>
<a href="#l3.76"></a><span id="l3.76">     awc.e(&quot;create_button&quot;).click();</span>
<a href="#l3.77"></a><span id="l3.77"> </span>
<a href="#l3.78"></a><span id="l3.78">     awc.waitForEval(&quot;subject.disabled == false&quot;, 8000, 600,</span>
<a href="#l3.79"></a><span id="l3.79">                     awc.e(&quot;create_button&quot;));</span>
<a href="#l3.80"></a><span id="l3.80">     awc.e(&quot;create_button&quot;).click();</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+    awc.e(&quot;manual-edit_button&quot;).click();</span>
<a href="#l3.82"></a><span id="l3.82"> </span>
<a href="#l3.83"></a><span id="l3.83">     // Make sure all the values are the same as in the user object.</span>
<a href="#l3.84"></a><span id="l3.84">     awc.sleep(1000);</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-    assert_equals(awc.e(&quot;outgoing_server&quot;).value, user.outgoingHost,</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+    assert_equals(awc.e(&quot;outgoing_hostname&quot;).value, user.outgoingHost,</span>
<a href="#l3.87"></a><span id="l3.87">                   &quot;Outgoing server changed!&quot;);</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-    assert_equals(awc.e(&quot;incoming_server&quot;).value, user.incomingHost,</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+    assert_equals(awc.e(&quot;incoming_hostname&quot;).value, user.incomingHost,</span>
<a href="#l3.90"></a><span id="l3.90">                   &quot;incoming server changed!&quot;);</span>
<a href="#l3.91"></a><span id="l3.91">   }</span>
<a href="#l3.92"></a><span id="l3.92">   finally {</span>
<a href="#l3.93"></a><span id="l3.93">     // Clean up</span>
<a href="#l3.94"></a><span id="l3.94">     pref.clearUserPref(pref_name);</span>
<a href="#l3.95"></a><span id="l3.95">     awc.e(&quot;cancel_button&quot;).click();</span>
<a href="#l3.96"></a><span id="l3.96">   }</span>
<a href="#l3.97"></a><span id="l3.97"> }</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineat">@@ -249,50 +250,36 @@ function remember_password_test(aPrefVal</span>
<a href="#l3.99"></a><span id="l3.99"> </span>
<a href="#l3.100"></a><span id="l3.100">   pref.setBoolPref(&quot;signon.rememberSignons&quot;, aPrefValue);</span>
<a href="#l3.101"></a><span id="l3.101"> </span>
<a href="#l3.102"></a><span id="l3.102">   // without this, it breaks the test, don't know why</span>
<a href="#l3.103"></a><span id="l3.103">   mc.sleep(0);</span>
<a href="#l3.104"></a><span id="l3.104">   awc = open_mail_account_setup_wizard();</span>
<a href="#l3.105"></a><span id="l3.105"> </span>
<a href="#l3.106"></a><span id="l3.106">   try {</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-  let password = new elementslib.ID(awc.window.document, &quot;password&quot;);</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-  let rememberPassword =</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-      new elementslib.ID(awc.window.document, &quot;remember_password&quot;);</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-  // password field is empty and the checkbox is disabled initially</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-  // -&gt; uncheck checkbox</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+    let password = new elementslib.ID(awc.window.document, &quot;password&quot;);</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+    let rememberPassword =</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+        new elementslib.ID(awc.window.document, &quot;remember_password&quot;);</span>
<a href="#l3.116"></a><span id="l3.116"> </span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-  awc.assertProperty(rememberPassword, &quot;disabled&quot;, true);</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-  awc.assertNotChecked(rememberPassword);</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-  // type something in the password field</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-  awc.e(&quot;password&quot;).focus();</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-  input_value(awc, &quot;testing&quot;);</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+    // type something in the password field</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+    awc.e(&quot;password&quot;).focus();</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+    input_value(awc, &quot;testing&quot;);</span>
<a href="#l3.126"></a><span id="l3.126"> </span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-  awc.assertProperty(rememberPassword, &quot;disabled&quot;, !aPrefValue);</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-  if (aPrefValue) {</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-    // password field is not empty any more</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-    // -&gt; enable and check checkbox</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-    awc.assertChecked(rememberPassword);</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-  }</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-  else {</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-    // password field is not empty any more, but aPrefValue is false</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-    // -&gt; disable and uncheck checkbox</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-    awc.assertNotChecked(rememberPassword);</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-  }</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+    awc.assertProperty(rememberPassword, &quot;disabled&quot;, !aPrefValue);</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+    if (aPrefValue) {</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+      awc.assertChecked(rememberPassword);</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+    }</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+    else {</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+      awc.assertNotChecked(rememberPassword);</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+    }</span>
<a href="#l3.145"></a><span id="l3.145"> </span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-  // empty the password field</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-  awc.keypress(password, 'a', {accelKey: true});</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-  awc.keypress(password, 'VK_DELETE', {});</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+    // empty the password field</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+    awc.keypress(password, 'a', {accelKey: true});</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+    awc.keypress(password, 'VK_DELETE', {});</span>
<a href="#l3.152"></a><span id="l3.152"> </span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-  // password field is empty -&gt; disable and uncheck checkbox</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-  awc.assertProperty(rememberPassword, &quot;disabled&quot;, true);</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-  awc.assertNotChecked(rememberPassword);</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-  // restore the saved signon.rememberSignons value</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-  pref.setBoolPref(&quot;signon.rememberSignons&quot;, rememberSignons_pref_save);</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+    // restore the saved signon.rememberSignons value</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+    pref.setBoolPref(&quot;signon.rememberSignons&quot;, rememberSignons_pref_save);</span>
<a href="#l3.161"></a><span id="l3.161">   }</span>
<a href="#l3.162"></a><span id="l3.162">   finally {</span>
<a href="#l3.163"></a><span id="l3.163">     // close the wizard</span>
<a href="#l3.164"></a><span id="l3.164">     awc.e(&quot;cancel_button&quot;).click();</span>
<a href="#l3.165"></a><span id="l3.165">   }</span>
<a href="#l3.166"></a><span id="l3.166"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/test/mozmill/account/test-retest-config.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-retest-config.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -33,35 +33,37 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.5"></a><span id="l4.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.6"></a><span id="l4.6">  *</span>
<a href="#l4.7"></a><span id="l4.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> var MODULE_NAME = &quot;test-retest-config&quot;;</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-var MODULE_REQUIRES = [&quot;window-helpers&quot;];</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+var MODULE_REQUIRES = [&quot;window-helpers&quot;, &quot;folder-display-helpers&quot;];</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15"> var mozmill = {};</span>
<a href="#l4.16"></a><span id="l4.16"> Components.utils.import(&quot;resource://mozmill/modules/mozmill.js&quot;, mozmill);</span>
<a href="#l4.17"></a><span id="l4.17"> var controller = {};</span>
<a href="#l4.18"></a><span id="l4.18"> Components.utils.import(&quot;resource://mozmill/modules/controller.js&quot;, controller);</span>
<a href="#l4.19"></a><span id="l4.19"> var elib = {};</span>
<a href="#l4.20"></a><span id="l4.20"> Components.utils.import(&quot;resource://mozmill/modules/elementslib.js&quot;, elib);</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-var wh, mc, awc, account, incoming, outgoing;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+var wh, awc, account, incoming, outgoing;</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25"> var user = {</span>
<a href="#l4.26"></a><span id="l4.26">   name: &quot;test&quot;,</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-  email: &quot;test@yahoo.com&quot;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+  email: &quot;test@yahoo.com&quot;,</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+  altEmail: &quot;test2@yahoo.com&quot;,</span>
<a href="#l4.30"></a><span id="l4.30"> };</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32"> function setupModule(module) {</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l4.35"></a><span id="l4.35">   wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-  mc = wh.wait_for_existing_window(&quot;mail:3pane&quot;);</span>
<a href="#l4.37"></a><span id="l4.37">   wh.installInto(module);</span>
<a href="#l4.38"></a><span id="l4.38"> }</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40"> // Select File &gt; New &gt; Mail Account to open the Mail Account Setup Wizard</span>
<a href="#l4.41"></a><span id="l4.41"> function open_mail_account_setup_wizard() {</span>
<a href="#l4.42"></a><span id="l4.42">   wh.plan_for_new_window(&quot;mail:autoconfig&quot;);</span>
<a href="#l4.43"></a><span id="l4.43">   mc.click(new elib.Elem(mc.menus.menu_File.menu_New.newMailAccountMenuItem));</span>
<a href="#l4.44"></a><span id="l4.44">   return wh.wait_for_new_window(&quot;mail:autoconfig&quot;);</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineat">@@ -86,42 +88,45 @@ function test_re_test_config() {</span>
<a href="#l4.46"></a><span id="l4.46">   input_value(user.name);</span>
<a href="#l4.47"></a><span id="l4.47">   awc.keypress(null, &quot;VK_TAB&quot;, {});</span>
<a href="#l4.48"></a><span id="l4.48">   input_value(user.email);</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50">   // Click &quot;continue&quot; button</span>
<a href="#l4.51"></a><span id="l4.51">   awc.e(&quot;next_button&quot;).click();</span>
<a href="#l4.52"></a><span id="l4.52"> </span>
<a href="#l4.53"></a><span id="l4.53">   // Wait for 'edit' button to be enabled</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-  awc.waitForEval(&quot;subject.hidden == false&quot;, 100000, 600,</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-                  awc.e(&quot;edit_button&quot;));</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+  awc.waitForEval(&quot;subject.disabled == false &amp;&amp; subject.hidden == false&quot;,</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+                  8000, 600, awc.e(&quot;create_button&quot;));</span>
<a href="#l4.58"></a><span id="l4.58"> </span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-  awc.e(&quot;edit_button&quot;).click();</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-  awc.waitForEval(&quot;subject.hidden == false&quot;, 20000, 600,</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-                  awc.e(&quot;go_button&quot;));</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  awc.e(&quot;manual-edit_button&quot;).click();</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+  mc.sleep(0);</span>
<a href="#l4.65"></a><span id="l4.65"> </span>
<a href="#l4.66"></a><span id="l4.66">   // Click &quot;re-test&quot; button</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-  awc.e(&quot;go_button&quot;).click();</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+  awc.e(&quot;half-manual-test_button&quot;).click();</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+  awc.waitForEval(&quot;subject.disabled == false&quot;, 20000, 600,</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+                  awc.e(&quot;half-manual-test_button&quot;));</span>
<a href="#l4.72"></a><span id="l4.72"> </span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-  awc.waitForEval(&quot;subject.hidden == false&quot;, 20000, 600,</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-                  awc.e(&quot;stop_button&quot;));</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+  // There used to be a &quot;start over&quot; button (line commented out below). Now just</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+  // changing the value of the email field does the trick. Line left out for</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+  // posterity.</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  //   awc.e(&quot;back_button&quot;).click();</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+  awc.e(&quot;realname&quot;).focus();</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+  awc.keypress(null, &quot;VK_TAB&quot;, {});</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+  input_value(user.altEmail);</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+  awc.keypress(null, &quot;VK_TAB&quot;, {});</span>
<a href="#l4.83"></a><span id="l4.83"> </span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-  // Click 'start over' button</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-  awc.e(&quot;back_button&quot;).click();</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+  // Wait for the &quot;continue&quot; button to be back, which means we're back to the</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+  // original state.</span>
<a href="#l4.89"></a><span id="l4.89">   awc.waitForEval(&quot;subject.hidden == false&quot;, 20000, 600,</span>
<a href="#l4.90"></a><span id="l4.90">                   awc.e(&quot;next_button&quot;));</span>
<a href="#l4.91"></a><span id="l4.91"> </span>
<a href="#l4.92"></a><span id="l4.92">   awc.e(&quot;next_button&quot;).click();</span>
<a href="#l4.93"></a><span id="l4.93"> </span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-  var incoming_server = awc.e(&quot;incoming_server&quot;);</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-  var wizard_window = awc.e(&quot;autoconfigWizard&quot;);</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-  var right = incoming_server.boxObject.y+incoming_server.boxObject.height;</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-  var bottom = incoming_server.boxObject.x+incoming_server.boxObject.width;</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-  if (right &gt; wizard_window.boxObject.height ||</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-      bottom &gt; wizard_window.boxObject.width)</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-    throw new Error(&quot;The start over button didn't collapse the window.&quot;);</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+  // Previously, we'd switched to the manual editing state. Now we've started</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+  // over, we should make sure the information is presented back in its original</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+  // &quot;automatic&quot; mode.</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+  assert_true(!awc.e(&quot;manual-edit_button&quot;).hidden,</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+    &quot;We're not back to the original state!&quot;);  </span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+  assert_true(awc.e(&quot;advanced-setup_button&quot;).hidden,</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+    &quot;We're not back to the original state!&quot;);  </span>
<a href="#l4.111"></a><span id="l4.111"> }</span>
<a href="#l4.112"></a><span id="l4.112"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-account-manager-helpers.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-account-manager-helpers.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -72,23 +72,27 @@ function installInto(module) {</span>
<a href="#l5.4"></a><span id="l5.4">  *</span>
<a href="#l5.5"></a><span id="l5.5">  * @param callback Callback for the modal dialog that is opened.</span>
<a href="#l5.6"></a><span id="l5.6">  */</span>
<a href="#l5.7"></a><span id="l5.7"> function open_advanced_settings(aCallback, aController) {</span>
<a href="#l5.8"></a><span id="l5.8">   if (aController === undefined)</span>
<a href="#l5.9"></a><span id="l5.9">     aController = mc;</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11">   wh.plan_for_modal_dialog(&quot;mailnews:accountmanager&quot;, aCallback);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  aController.click(new elib.Elem(mc.menus.tasksMenu.menu_accountmgr));</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  if (mc.isLinux)</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+    aController.click(new elib.Elem(mc.menus.menu_Edit.menu_accountmgr));</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+  else</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+    aController.click(new elib.Elem(mc.menus.tasksMenu.menu_accountmgr));</span>
<a href="#l5.17"></a><span id="l5.17">   return wh.wait_for_modal_dialog(&quot;mailnews:accountmanager&quot;);</span>
<a href="#l5.18"></a><span id="l5.18"> }</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20"> /**</span>
<a href="#l5.21"></a><span id="l5.21">  * Opens the Account Manager from the mail account setup wizard.</span>
<a href="#l5.22"></a><span id="l5.22">  *</span>
<a href="#l5.23"></a><span id="l5.23">  * @param callback Callback for the modal dialog that is opened.</span>
<a href="#l5.24"></a><span id="l5.24">  */</span>
<a href="#l5.25"></a><span id="l5.25"> function open_advanced_settings_from_account_wizard(aCallback, aController) {</span>
<a href="#l5.26"></a><span id="l5.26">   wh.plan_for_modal_dialog(&quot;mailnews:accountmanager&quot;, aCallback);</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-  aController.e(&quot;advanced_settings&quot;).click();</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+  aController.e(&quot;manual-edit_button&quot;).click();</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+  aController.e(&quot;advanced-setup_button&quot;).click();</span>
<a href="#l5.30"></a><span id="l5.30">   return wh.wait_for_modal_dialog(&quot;mailnews:accountmanager&quot;);</span>
<a href="#l5.31"></a><span id="l5.31"> }</span>
<a href="#l5.32"></a><span id="l5.32"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/themes/gnomestripe/mail/accountCreation.css</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/themes/gnomestripe/mail/accountCreation.css</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -19,17 +19,17 @@</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> .errordescription {</span>
<a href="#l6.6"></a><span id="l6.6">   background-color: InfoBackground;</span>
<a href="#l6.7"></a><span id="l6.7">   border-radius: 4px;</span>
<a href="#l6.8"></a><span id="l6.8">   margin-top: 3px;</span>
<a href="#l6.9"></a><span id="l6.9">   -moz-padding-start: 3px;</span>
<a href="#l6.10"></a><span id="l6.10"> }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-.initialDesc {</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+.initialDesc, .columnHeader {</span>
<a href="#l6.14"></a><span id="l6.14">   margin-top: 2px;</span>
<a href="#l6.15"></a><span id="l6.15">   color: GrayText;</span>
<a href="#l6.16"></a><span id="l6.16"> }</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18"> menulist[disabled=&quot;true&quot;] {</span>
<a href="#l6.19"></a><span id="l6.19">   -moz-appearance: menulist;</span>
<a href="#l6.20"></a><span id="l6.20">   color: -moz-DialogText;</span>
<a href="#l6.21"></a><span id="l6.21"> }</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -40,23 +40,18 @@ menulist[disabled=&quot;true&quot;] &gt; .menulist-dr</span>
<a href="#l6.23"></a><span id="l6.23">   -moz-appearance: none;</span>
<a href="#l6.24"></a><span id="l6.24">   color: -moz-DialogText;</span>
<a href="#l6.25"></a><span id="l6.25"> }</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27"> #outgoing_protocol {</span>
<a href="#l6.28"></a><span id="l6.28">   padding: 6px;</span>
<a href="#l6.29"></a><span id="l6.29"> }</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-#config_status_title {</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-  font-weight: bold;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-}</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-</span>
<a href="#l6.35"></a><span id="l6.35"> window {</span>
<a href="#l6.36"></a><span id="l6.36">   -moz-appearance: none;</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-  background-color: #fff;</span>
<a href="#l6.38"></a><span id="l6.38"> }</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40"> vbox.icon {</span>
<a href="#l6.41"></a><span id="l6.41">   width: 22px;</span>
<a href="#l6.42"></a><span id="l6.42">   height: 22px;</span>
<a href="#l6.43"></a><span id="l6.43">   background-repeat: no-repeat;</span>
<a href="#l6.44"></a><span id="l6.44"> }</span>
<a href="#l6.45"></a><span id="l6.45"> </span>
<a href="#l6.46"></a><span id="l6.46" class="difflineat">@@ -225,19 +220,68 @@ textbox[disabled=&quot;true&quot;],</span>
<a href="#l6.47"></a><span id="l6.47"> input[disabled=&quot;true&quot;],</span>
<a href="#l6.48"></a><span id="l6.48"> menulist[disabled=&quot;true&quot;] {</span>
<a href="#l6.49"></a><span id="l6.49">   -moz-appearance: none;</span>
<a href="#l6.50"></a><span id="l6.50">   border: 0;</span>
<a href="#l6.51"></a><span id="l6.51">   background-color: dialog;</span>
<a href="#l6.52"></a><span id="l6.52">   color: -moz-DialogText;</span>
<a href="#l6.53"></a><span id="l6.53"> }</span>
<a href="#l6.54"></a><span id="l6.54"> </span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+/* status area */</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+#status_area {</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+  -moz-box-pack: center;</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+}</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+#status_area[status=loading] #status_msg {</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+  font-weight: bold;</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+}</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+#status_area[status=error] #status_msg {</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+  font-weight: bold;</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+}</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+#status_area[status=error] #status_img_before {</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+  background: url(&quot;moz-icon://stock/gtk-dialog-warning?size=menu&quot;) no-repeat;</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+  width: 16px;</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+  height: 16px;</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+}</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+#status_area[status=loading] #status_img_after {</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+  background: url(&quot;chrome://global/skin/icons/loading_16.png&quot;) no-repeat;</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+  width: 16px;</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+  height: 16px;</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+}</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+</span>
<a href="#l6.83"></a><span id="l6.83"> /* Missing:</span>
<a href="#l6.84"></a><span id="l6.84">  * .menulist-dropmarker[disabled=&quot;true&quot;]</span>
<a href="#l6.85"></a><span id="l6.85">  */</span>
<a href="#l6.86"></a><span id="l6.86"> </span>
<a href="#l6.87"></a><span id="l6.87"> textbox.port[disabled=&quot;true&quot;] {</span>
<a href="#l6.88"></a><span id="l6.88">   padding-top: 4px;</span>
<a href="#l6.89"></a><span id="l6.89"> }</span>
<a href="#l6.90"></a><span id="l6.90"> </span>
<a href="#l6.91"></a><span id="l6.91"> #incoming_protocol[disabled=&quot;true&quot;] {</span>
<a href="#l6.92"></a><span id="l6.92">   padding-left: 5px;</span>
<a href="#l6.93"></a><span id="l6.93"> }</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+#initialSettings, #status_area {</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+  margin-bottom: 1em;</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+}</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+#result_area, #result_imappop {</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+  margin-bottom: 1.5em;</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+}</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+#manual-edit_area {</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+  margin-bottom: 2em;</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+}</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+#status_msg {</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+  min-height: 2em;</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+}</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+#incoming_hostname {</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+  width: 15em;</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+}</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+#incoming_username {</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+  width: 10em;</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/themes/pinstripe/mail/accountCreation.css</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/themes/pinstripe/mail/accountCreation.css</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -12,17 +12,17 @@</span>
<a href="#l7.4"></a><span id="l7.4">   cursor: pointer;</span>
<a href="#l7.5"></a><span id="l7.5"> }</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> .errordescription {</span>
<a href="#l7.8"></a><span id="l7.8">   -moz-padding-start: 3px;</span>
<a href="#l7.9"></a><span id="l7.9">   margin-top: 3px;</span>
<a href="#l7.10"></a><span id="l7.10"> }</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-.initialDesc {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+.initialDesc, .columnHeader {</span>
<a href="#l7.14"></a><span id="l7.14">   margin-top: 2px;</span>
<a href="#l7.15"></a><span id="l7.15">   color: GrayText;</span>
<a href="#l7.16"></a><span id="l7.16"> }</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18"> /* Missing:</span>
<a href="#l7.19"></a><span id="l7.19">  * menulist[disabled=&quot;true&quot;]</span>
<a href="#l7.20"></a><span id="l7.20">  * menulist[disabled=&quot;true&quot;] &gt; .menulist-editable-box</span>
<a href="#l7.21"></a><span id="l7.21">  * menulist[disabled=&quot;true&quot;] &gt; .menulist-editable-box &gt; .menulist-editable-input</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -208,19 +208,65 @@ textbox[disabled=&quot;true&quot;],</span>
<a href="#l7.23"></a><span id="l7.23"> input[disabled=&quot;true&quot;],</span>
<a href="#l7.24"></a><span id="l7.24"> menulist[disabled=&quot;true&quot;] {</span>
<a href="#l7.25"></a><span id="l7.25">   -moz-appearance: none;</span>
<a href="#l7.26"></a><span id="l7.26">   border: 0;</span>
<a href="#l7.27"></a><span id="l7.27">   background-color: #ececec;</span>
<a href="#l7.28"></a><span id="l7.28">   color: #000000 !important;</span>
<a href="#l7.29"></a><span id="l7.29"> }</span>
<a href="#l7.30"></a><span id="l7.30"> </span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+/* status area */</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+#status_area[status=loading] #status_msg {</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+  font-weight: bold;</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+}</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+#status_area[status=error] #status_msg {</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+  font-weight: bold;</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+}</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+#status_area[status=error] #status_img_before {</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+  background: url(&quot;chrome://global/skin/icons/warning-16.png&quot;) no-repeat;</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+  width: 16px;</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+  height: 16px;</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+  margin-right: 1em;</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+}</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+#status_area[status=loading] #status_img_after {</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+  background: url(&quot;chrome://global/skin/icons/loading_16.png&quot;) no-repeat;</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+  width: 16px;</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+  height: 16px;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+}</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+</span>
<a href="#l7.56"></a><span id="l7.56"> /* Missing:</span>
<a href="#l7.57"></a><span id="l7.57">  * .menulist-dropmarker[disabled=&quot;true&quot;]</span>
<a href="#l7.58"></a><span id="l7.58">  */</span>
<a href="#l7.59"></a><span id="l7.59"> </span>
<a href="#l7.60"></a><span id="l7.60"> textbox.port[disabled=&quot;true&quot;] {</span>
<a href="#l7.61"></a><span id="l7.61">   padding-top: 4px;</span>
<a href="#l7.62"></a><span id="l7.62"> }</span>
<a href="#l7.63"></a><span id="l7.63"> </span>
<a href="#l7.64"></a><span id="l7.64"> #incoming_protocol[disabled=&quot;true&quot;] {</span>
<a href="#l7.65"></a><span id="l7.65">   padding-left: 5px;</span>
<a href="#l7.66"></a><span id="l7.66"> }</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+#initialSettings, #status_area {</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  margin-bottom: 1em;</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+}</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+#result_area, #result_imappop {</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+  margin-bottom: 1.5em;</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+}</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+#manual-edit_area {</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+  margin-bottom: 2em;</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+}</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+#status_msg {</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+  min-height: 2em;</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+}</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+#incoming_hostname {</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+  width: 15em;</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+}</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+#incoming_username {</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+  width: 10em;</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/themes/qute/mail/accountCreation.css</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/themes/qute/mail/accountCreation.css</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -17,17 +17,17 @@</span>
<a href="#l8.4"></a><span id="l8.4">   cursor: pointer;</span>
<a href="#l8.5"></a><span id="l8.5"> }</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> .errordescription {</span>
<a href="#l8.8"></a><span id="l8.8">   -moz-padding-start: 3px;</span>
<a href="#l8.9"></a><span id="l8.9">   margin-top: 3px;</span>
<a href="#l8.10"></a><span id="l8.10"> }</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-.initialDesc {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+.initialDesc, .columnHeader {</span>
<a href="#l8.14"></a><span id="l8.14">   margin-top: 2px;</span>
<a href="#l8.15"></a><span id="l8.15">   color: GrayText;</span>
<a href="#l8.16"></a><span id="l8.16"> }</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18"> menulist[disabled=&quot;true&quot;] {</span>
<a href="#l8.19"></a><span id="l8.19">   -moz-appearance: none;</span>
<a href="#l8.20"></a><span id="l8.20">   border: none;</span>
<a href="#l8.21"></a><span id="l8.21">   background-color: #fff;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -222,19 +222,64 @@ textbox[disabled=&quot;true&quot;],</span>
<a href="#l8.23"></a><span id="l8.23"> input[disabled=&quot;true&quot;],</span>
<a href="#l8.24"></a><span id="l8.24"> menulist[disabled=&quot;true&quot;] {</span>
<a href="#l8.25"></a><span id="l8.25">   -moz-appearance: none;</span>
<a href="#l8.26"></a><span id="l8.26">   border: 0;</span>
<a href="#l8.27"></a><span id="l8.27">   background-color: -moz-dialog;</span>
<a href="#l8.28"></a><span id="l8.28">   color: -moz-DialogText;</span>
<a href="#l8.29"></a><span id="l8.29"> }</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+/* status area */</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+#status_area[status=loading] #status_msg {</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+  font-weight: bold;</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+}</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+#status_area[status=error] #status_msg {</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+  font-weight: bold;</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+}</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+#status_area[status=error] #status_img_before {</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+  background: url(&quot;chrome://global/skin/icons/warning-16.png&quot;) no-repeat;</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+  width: 16px;</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+  height: 16px;</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+}</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+#status_area[status=loading] #status_img_after {</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  background: url(&quot;chrome://global/skin/icons/loading_16.png&quot;) no-repeat;</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+  width: 16px;</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  height: 16px;</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+}</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+</span>
<a href="#l8.55"></a><span id="l8.55"> .menulist-dropmarker[disabled=&quot;true&quot;] {</span>
<a href="#l8.56"></a><span id="l8.56">   visibility: hidden;</span>
<a href="#l8.57"></a><span id="l8.57"> }</span>
<a href="#l8.58"></a><span id="l8.58"> </span>
<a href="#l8.59"></a><span id="l8.59"> textbox.port[disabled=&quot;true&quot;] {</span>
<a href="#l8.60"></a><span id="l8.60">   padding-top: 6px;</span>
<a href="#l8.61"></a><span id="l8.61"> }</span>
<a href="#l8.62"></a><span id="l8.62"> </span>
<a href="#l8.63"></a><span id="l8.63"> #incoming_protocol[disabled=&quot;true&quot;] {</span>
<a href="#l8.64"></a><span id="l8.64">   padding-left: 6px;</span>
<a href="#l8.65"></a><span id="l8.65"> }</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+#initialSettings, #status_area {</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+  margin-bottom: 1em;</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+}</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+#result_area, #result_imappop {</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+  margin-bottom: 1.5em;</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+}</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+#manual-edit_area {</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+  margin-bottom: 2em;</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+}</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+#status_msg {</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+  min-height: 2em;</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+}</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+#incoming_hostname {</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+  width: 15em;</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+}</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+#incoming_username {</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+  width: 10em;</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountUtils.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountUtils.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -345,17 +345,17 @@ function msgNewMailAccount(msgWindow, ok</span>
<a href="#l9.4"></a><span id="l9.4">   let wm = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l9.5"></a><span id="l9.5">                      .getService()</span>
<a href="#l9.6"></a><span id="l9.6">                      .QueryInterface(Components.interfaces.nsIWindowMediator);</span>
<a href="#l9.7"></a><span id="l9.7">   let existingWindow = wm.getMostRecentWindow(&quot;mail:autoconfig&quot;);</span>
<a href="#l9.8"></a><span id="l9.8">   if (existingWindow)</span>
<a href="#l9.9"></a><span id="l9.9">     existingWindow.focus();</span>
<a href="#l9.10"></a><span id="l9.10">   else</span>
<a href="#l9.11"></a><span id="l9.11">     window.openDialog(&quot;chrome://messenger/content/accountcreation/emailWizard.xul&quot;,</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-                      &quot;AccountSetup&quot;, &quot;chrome,titlebar,centerscreen&quot;,</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+                      &quot;AccountSetup&quot;, &quot;chrome,titlebar,modal,centerscreen&quot;,</span>
<a href="#l9.14"></a><span id="l9.14">                       {msgWindow:msgWindow,</span>
<a href="#l9.15"></a><span id="l9.15">                        okCallback:okCallback,</span>
<a href="#l9.16"></a><span id="l9.16">                        extraData:extraData});</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18">   // If we started with no servers at all and &quot;smtp servers&quot; list selected,</span>
<a href="#l9.19"></a><span id="l9.19">   // refresh display somehow. Bug 58506.</span>
<a href="#l9.20"></a><span id="l9.20">   // TODO Better fix: select newly created account (in all cases)</span>
<a href="#l9.21"></a><span id="l9.21">   if (typeof(getCurrentAccount) == &quot;function&quot; &amp;&amp; // in AccountManager, not menu</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/accountConfig.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/accountConfig.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -42,17 +42,18 @@</span>
<a href="#l10.4"></a><span id="l10.4">  *</span>
<a href="#l10.5"></a><span id="l10.5">  * Several AccountConfig objects may co-exist, e.g. for autoconfig.</span>
<a href="#l10.6"></a><span id="l10.6">  * One AccountConfig object is used to prefill and read the widgets</span>
<a href="#l10.7"></a><span id="l10.7">  * in the Wizard UI.</span>
<a href="#l10.8"></a><span id="l10.8">  * When we autoconfigure, we autoconfig writes the values into a</span>
<a href="#l10.9"></a><span id="l10.9">  * new object and returns that, and the caller can copy these</span>
<a href="#l10.10"></a><span id="l10.10">  * values into the object used by the UI.</span>
<a href="#l10.11"></a><span id="l10.11">  *</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">- * See also &lt;https://wiki.mozilla.org/Thunderbird:Autoconfiguration:ConfigFileFormat&gt;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+ * See also</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+ * &lt;https://wiki.mozilla.org/Thunderbird:Autoconfiguration:ConfigFileFormat&gt;</span>
<a href="#l10.15"></a><span id="l10.15">  * for values stored.</span>
<a href="#l10.16"></a><span id="l10.16">  */</span>
<a href="#l10.17"></a><span id="l10.17"> </span>
<a href="#l10.18"></a><span id="l10.18"> function AccountConfig()</span>
<a href="#l10.19"></a><span id="l10.19"> {</span>
<a href="#l10.20"></a><span id="l10.20">   this.incoming = this.createNewIncoming();</span>
<a href="#l10.21"></a><span id="l10.21">   this.incomingAlternatives = [];</span>
<a href="#l10.22"></a><span id="l10.22">   this.outgoing = this.createNewOutgoing();</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineat">@@ -64,46 +65,55 @@ function AccountConfig()</span>
<a href="#l10.24"></a><span id="l10.24">     // email address of user, as shown in From of outgoing mails</span>
<a href="#l10.25"></a><span id="l10.25">     emailAddress : &quot;%EMAILADDRESS%&quot;,</span>
<a href="#l10.26"></a><span id="l10.26">   };</span>
<a href="#l10.27"></a><span id="l10.27">   this.inputFields = [];</span>
<a href="#l10.28"></a><span id="l10.28">   this.domains = [];</span>
<a href="#l10.29"></a><span id="l10.29"> };</span>
<a href="#l10.30"></a><span id="l10.30"> AccountConfig.prototype =</span>
<a href="#l10.31"></a><span id="l10.31"> {</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-  incoming : null, // see |createNewIncoming()|</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-  outgoing : null, // see |createNewOutgoing()|</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+  // @see createNewIncoming()</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+  incoming : null,</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+  // @see createNewOutgoing()</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+  outgoing : null,</span>
<a href="#l10.38"></a><span id="l10.38">   /**</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-   * {Array of |incoming|/|createNewIncoming|}</span>
<a href="#l10.40"></a><span id="l10.40">    * Other servers which can be used instead of |incoming|,</span>
<a href="#l10.41"></a><span id="l10.41">    * in order of decreasing preference.</span>
<a href="#l10.42"></a><span id="l10.42">    * (|incoming| itself should not be included here.)</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+   * { Array of incoming/createNewIncoming() }</span>
<a href="#l10.44"></a><span id="l10.44">    */</span>
<a href="#l10.45"></a><span id="l10.45">   incomingAlternatives : null,</span>
<a href="#l10.46"></a><span id="l10.46">   outgoingAlternatives : null,</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-  id : null, // just an internal string to refer to this. Do not show to user.</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-  source : 0, // who created the config. kSource*</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+  // just an internal string to refer to this. Do not show to user.</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+  id : null,</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+  // who created the config.</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+  // { one of kSource* }</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+  source : 0,</span>
<a href="#l10.54"></a><span id="l10.54">   displayName : null,</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-  // Array of Objects with properties varname (value without %), displayName, exampleValue</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+  // { Array of { varname (value without %), displayName, exampleValue } }</span>
<a href="#l10.57"></a><span id="l10.57">   inputFields : null,</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-  // Array of Strings - email address domains for which this config is applicable</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+  // email address domains for which this config is applicable</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+  // { Array of Strings }</span>
<a href="#l10.61"></a><span id="l10.61">   domains : null,</span>
<a href="#l10.62"></a><span id="l10.62"> </span>
<a href="#l10.63"></a><span id="l10.63">   /**</span>
<a href="#l10.64"></a><span id="l10.64">    * Factory function for incoming and incomingAlternatives</span>
<a href="#l10.65"></a><span id="l10.65">    */</span>
<a href="#l10.66"></a><span id="l10.66">   createNewIncoming : function()</span>
<a href="#l10.67"></a><span id="l10.67">   {</span>
<a href="#l10.68"></a><span id="l10.68">     return {</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-      type : null, // string-enum: &quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+      // { String-enum: &quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot; }</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+      type : null,</span>
<a href="#l10.72"></a><span id="l10.72">       hostname : null,</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-      port : null, // Integer</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-      username : null, // String. May be a placeholder (starts and ends with %).</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+      // { Integer }</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+      port : null,</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+      // May be a placeholder (starts and ends with %). { String }</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+      username : null,</span>
<a href="#l10.79"></a><span id="l10.79">       password : null,</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-      // enum: 1 = plain, 2 = SSL/TLS, 3 = STARTTLS always, 0 = not inited</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+      // { enum: 1 = plain, 2 = SSL/TLS, 3 = STARTTLS always, 0 = not inited }</span>
<a href="#l10.82"></a><span id="l10.82">       // ('TLS when available' is insecure and not supported here)</span>
<a href="#l10.83"></a><span id="l10.83">       socketType : 0,</span>
<a href="#l10.84"></a><span id="l10.84">       /**</span>
<a href="#l10.85"></a><span id="l10.85">        * true when the cert is invalid (and thus SSL useless), because it's</span>
<a href="#l10.86"></a><span id="l10.86">        * 1) not from an accepted CA (including self-signed certs)</span>
<a href="#l10.87"></a><span id="l10.87">        * 2) for a different hostname or</span>
<a href="#l10.88"></a><span id="l10.88">        * 3) expired.</span>
<a href="#l10.89"></a><span id="l10.89">        * May go back to false when user explicitly accepted the cert.</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineat">@@ -111,26 +121,28 @@ AccountConfig.prototype =</span>
<a href="#l10.91"></a><span id="l10.91">       badCert : false,</span>
<a href="#l10.92"></a><span id="l10.92">       /**</span>
<a href="#l10.93"></a><span id="l10.93">        * How to log in to the server: plaintext or encrypted pw, GSSAPI etc.</span>
<a href="#l10.94"></a><span id="l10.94">        * Defined by Ci.nsMsgAuthMethod</span>
<a href="#l10.95"></a><span id="l10.95">        * Same as server pref &quot;authMethod&quot;.</span>
<a href="#l10.96"></a><span id="l10.96">        */</span>
<a href="#l10.97"></a><span id="l10.97">       auth : 0,</span>
<a href="#l10.98"></a><span id="l10.98">       /**</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-       * {Array of Ci.nsMsgAuthMethod} (same as .auth)</span>
<a href="#l10.100"></a><span id="l10.100">        * Other auth methods that we think the server supports.</span>
<a href="#l10.101"></a><span id="l10.101">        * They are ordered by descreasing preference.</span>
<a href="#l10.102"></a><span id="l10.102">        * (|auth| itself is not included in |authAlternatives|)</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+       * {Array of Ci.nsMsgAuthMethod} (same as .auth)</span>
<a href="#l10.104"></a><span id="l10.104">        */</span>
<a href="#l10.105"></a><span id="l10.105">       authAlternatives : null,</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-      checkInterval : 10, // Integer, in minutes</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+      // in minutes { Integer }</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+      checkInterval : 10,</span>
<a href="#l10.109"></a><span id="l10.109">       loginAtStartup : true,</span>
<a href="#l10.110"></a><span id="l10.110">       // POP3 only:</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineminus">-      useGlobalInbox : false, // boolean. Not yet implemented.</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+      // Not yet implemented. { Boolean }</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+      useGlobalInbox : false,</span>
<a href="#l10.114"></a><span id="l10.114">       leaveMessagesOnServer : true,</span>
<a href="#l10.115"></a><span id="l10.115">       daysToLeaveMessagesOnServer : 14,</span>
<a href="#l10.116"></a><span id="l10.116">       deleteByAgeFromServer : true,</span>
<a href="#l10.117"></a><span id="l10.117">       // When user hits delete, delete from local store and from server</span>
<a href="#l10.118"></a><span id="l10.118">       deleteOnServerWhenLocalDelete : true,</span>
<a href="#l10.119"></a><span id="l10.119">       downloadOnBiff : true,</span>
<a href="#l10.120"></a><span id="l10.120">     };</span>
<a href="#l10.121"></a><span id="l10.121">   },</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineat">@@ -144,20 +156,21 @@ AccountConfig.prototype =</span>
<a href="#l10.123"></a><span id="l10.123">       hostname : null,</span>
<a href="#l10.124"></a><span id="l10.124">       port : null, // see incoming</span>
<a href="#l10.125"></a><span id="l10.125">       username : null, // see incoming. may be null, if auth is 0.</span>
<a href="#l10.126"></a><span id="l10.126">       password : null, // see incoming. may be null, if auth is 0.</span>
<a href="#l10.127"></a><span id="l10.127">       socketType : 0, // see incoming</span>
<a href="#l10.128"></a><span id="l10.128">       badCert : false, // see incoming</span>
<a href="#l10.129"></a><span id="l10.129">       auth : 0, // see incoming</span>
<a href="#l10.130"></a><span id="l10.130">       authAlternatives : null, // see incoming</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-      addThisServer : true, // if we already have an SMTP server, add this or not.</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+      addThisServer : true, // if we already have an SMTP server, add this</span>
<a href="#l10.133"></a><span id="l10.133">       // if we already have an SMTP server, use it.</span>
<a href="#l10.134"></a><span id="l10.134">       useGlobalPreferredServer : false,</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineminus">-      // we should reuse an already configured SMTP server. This is nsISmtpServer.key.</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+      // we should reuse an already configured SMTP server.</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+      // nsISmtpServer.key</span>
<a href="#l10.138"></a><span id="l10.138">       existingServerKey : null,</span>
<a href="#l10.139"></a><span id="l10.139">       // user display value for existingServerKey</span>
<a href="#l10.140"></a><span id="l10.140">       existingServerLabel : null,</span>
<a href="#l10.141"></a><span id="l10.141">     };</span>
<a href="#l10.142"></a><span id="l10.142">   },</span>
<a href="#l10.143"></a><span id="l10.143"> </span>
<a href="#l10.144"></a><span id="l10.144">   /**</span>
<a href="#l10.145"></a><span id="l10.145">    * Returns a deep copy of this object,</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineat">@@ -192,17 +205,17 @@ AccountConfig.kSourceUser = 1; // user m</span>
<a href="#l10.147"></a><span id="l10.147"> AccountConfig.kSourceXML = 2; // config from XML from ISP or Mozilla DB</span>
<a href="#l10.148"></a><span id="l10.148"> AccountConfig.kSourceGuess = 3; // guessConfig()</span>
<a href="#l10.149"></a><span id="l10.149"> </span>
<a href="#l10.150"></a><span id="l10.150"> </span>
<a href="#l10.151"></a><span id="l10.151"> /**</span>
<a href="#l10.152"></a><span id="l10.152">  * Some fields on the account config accept placeholders (when coming from XML).</span>
<a href="#l10.153"></a><span id="l10.153">  *</span>
<a href="#l10.154"></a><span id="l10.154">  * These are the predefined ones</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineminus">- * * %EMAILADDRESS% (full email address of the user, usually entered by the user)</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+ * * %EMAILADDRESS% (full email address of the user, usually entered by user)</span>
<a href="#l10.157"></a><span id="l10.157">  * * %EMAILLOCALPART% (email address, part before @)</span>
<a href="#l10.158"></a><span id="l10.158">  * * %EMAILDOMAIN% (email address, part after @)</span>
<a href="#l10.159"></a><span id="l10.159">  * * %REALNAME%</span>
<a href="#l10.160"></a><span id="l10.160">  * as well as those defined in account.inputFields.*.varname, with % added</span>
<a href="#l10.161"></a><span id="l10.161">  * before and after.</span>
<a href="#l10.162"></a><span id="l10.162">  *</span>
<a href="#l10.163"></a><span id="l10.163">  * These must replaced with real values, supplied by the user or app,</span>
<a href="#l10.164"></a><span id="l10.164">  * before the account is created. This is done here. You call this function once</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineat">@@ -245,24 +258,24 @@ function replaceVariables(account, realn</span>
<a href="#l10.166"></a><span id="l10.166"> </span>
<a href="#l10.167"></a><span id="l10.167">   account.incoming.password = password;</span>
<a href="#l10.168"></a><span id="l10.168">   account.outgoing.password = password; // set member only if auth required?</span>
<a href="#l10.169"></a><span id="l10.169">   account.incoming.username = _replaceVariable(account.incoming.username,</span>
<a href="#l10.170"></a><span id="l10.170">                                                otherVariables);</span>
<a href="#l10.171"></a><span id="l10.171">   account.outgoing.username = _replaceVariable(account.outgoing.username,</span>
<a href="#l10.172"></a><span id="l10.172">                                                otherVariables);</span>
<a href="#l10.173"></a><span id="l10.173">   account.incoming.hostname =</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineminus">-    _replaceVariable(account.incoming.hostname, otherVariables);</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+      _replaceVariable(account.incoming.hostname, otherVariables);</span>
<a href="#l10.176"></a><span id="l10.176">   if (account.outgoing.hostname) // will be null if user picked existing server.</span>
<a href="#l10.177"></a><span id="l10.177">     account.outgoing.hostname =</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineminus">-      _replaceVariable(account.outgoing.hostname, otherVariables);</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+        _replaceVariable(account.outgoing.hostname, otherVariables);</span>
<a href="#l10.180"></a><span id="l10.180">   account.identity.realname =</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineminus">-    _replaceVariable(account.identity.realname, otherVariables);</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+      _replaceVariable(account.identity.realname, otherVariables);</span>
<a href="#l10.183"></a><span id="l10.183">   account.identity.emailAddress =</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineminus">-    _replaceVariable(account.identity.emailAddress, otherVariables);</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineplus">+      _replaceVariable(account.identity.emailAddress, otherVariables);</span>
<a href="#l10.186"></a><span id="l10.186">   account.displayName = _replaceVariable(account.displayName, otherVariables);</span>
<a href="#l10.187"></a><span id="l10.187"> }</span>
<a href="#l10.188"></a><span id="l10.188"> </span>
<a href="#l10.189"></a><span id="l10.189"> function _replaceVariable(variable, values)</span>
<a href="#l10.190"></a><span id="l10.190"> {</span>
<a href="#l10.191"></a><span id="l10.191">   let str = variable;</span>
<a href="#l10.192"></a><span id="l10.192">   if (typeof(str) != &quot;string&quot;)</span>
<a href="#l10.193"></a><span id="l10.193">     return str;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/createInBackend.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/createInBackend.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -32,27 +32,25 @@</span>
<a href="#l11.4"></a><span id="l11.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l11.5"></a><span id="l11.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l11.6"></a><span id="l11.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.7"></a><span id="l11.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.8"></a><span id="l11.8">  *</span>
<a href="#l11.9"></a><span id="l11.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> /**</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">- * Takes an AccountConfig JS object and creates that account in the</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+ * Takes an |AccountConfig| JS object and creates that account in the</span>
<a href="#l11.14"></a><span id="l11.14">  * Thunderbird backend (which also writes it to prefs).</span>
<a href="#l11.15"></a><span id="l11.15">  *</span>
<a href="#l11.16"></a><span id="l11.16">  * @param config {AccountConfig} The account to create</span>
<a href="#l11.17"></a><span id="l11.17">  *</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">- * @ret - the account created.</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+ * @return - the account created.</span>
<a href="#l11.20"></a><span id="l11.20">  */</span>
<a href="#l11.21"></a><span id="l11.21"> function createAccountInBackend(config)</span>
<a href="#l11.22"></a><span id="l11.22"> {</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-  const Cc = Components.classes;</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-  const Ci = Components.interfaces;</span>
<a href="#l11.25"></a><span id="l11.25">   var accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l11.26"></a><span id="l11.26">                        .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l11.27"></a><span id="l11.27">   var smtpManager = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l11.28"></a><span id="l11.28">                     .getService(Ci.nsISmtpService);</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30">   // incoming server</span>
<a href="#l11.31"></a><span id="l11.31">   var inServer = accountManager.createIncomingServer(</span>
<a href="#l11.32"></a><span id="l11.32">       config.incoming.username,</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineat">@@ -196,17 +194,18 @@ function createAccountInBackend(config)</span>
<a href="#l11.34"></a><span id="l11.34">   } catch (ex) {</span>
<a href="#l11.35"></a><span id="l11.35">     ddump(&quot;Could not write out prefs: &quot; + ex);</span>
<a href="#l11.36"></a><span id="l11.36">   }</span>
<a href="#l11.37"></a><span id="l11.37">   return account;</span>
<a href="#l11.38"></a><span id="l11.38"> }</span>
<a href="#l11.39"></a><span id="l11.39"> </span>
<a href="#l11.40"></a><span id="l11.40"> function setFolders(identity, server)</span>
<a href="#l11.41"></a><span id="l11.41"> {</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-  // TODO: support for local folders for global inbox (or use smart search folder instead)</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+  // TODO: support for local folders for global inbox (or use smart search</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+  // folder instead)</span>
<a href="#l11.45"></a><span id="l11.45"> </span>
<a href="#l11.46"></a><span id="l11.46">   var baseURI = server.serverURI + &quot;/&quot;;</span>
<a href="#l11.47"></a><span id="l11.47"> </span>
<a href="#l11.48"></a><span id="l11.48">   // Names will be localized in UI, not in folder names on server/disk</span>
<a href="#l11.49"></a><span id="l11.49">   // TODO allow to override these names in the XML config file,</span>
<a href="#l11.50"></a><span id="l11.50">   // in case e.g. Google or AOL use different names?</span>
<a href="#l11.51"></a><span id="l11.51">   // Workaround: Let user fix it :)</span>
<a href="#l11.52"></a><span id="l11.52">   var fccName = &quot;Sent&quot;;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineat">@@ -238,18 +237,81 @@ function rememberPassword(server, passwo</span>
<a href="#l11.54"></a><span id="l11.54">   login.init(passwordURI, null, passwordURI, server.username, password, &quot;&quot;, &quot;&quot;);</span>
<a href="#l11.55"></a><span id="l11.55">   try {</span>
<a href="#l11.56"></a><span id="l11.56">     lm.addLogin(login);</span>
<a href="#l11.57"></a><span id="l11.57">   } catch (e if e.message.indexOf(&quot;This login already exists&quot;) != -1) {</span>
<a href="#l11.58"></a><span id="l11.58">     // TODO modify</span>
<a href="#l11.59"></a><span id="l11.59">   }</span>
<a href="#l11.60"></a><span id="l11.60"> }</span>
<a href="#l11.61"></a><span id="l11.61"> </span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-// Check if there already is a &quot;Local Folders&quot;. If not, create it. This routine</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-//  is copied from AccountWizard.js with minor updates.</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+/**</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+ * Check whether the user's setup already has an incoming server</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+ * which matches (hostname, port, username) the primary one</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+ * in the config.</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+ * (We also check the email address as username.)</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+ *</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+ * @param config {AccountConfig} filled in (no placeholders)</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+ * @return {nsIMsgIncomingServer} If it already exists, the server</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+ *     object is returned.</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+ *     If it's a new server, |null| is returned.</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+ */</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+function checkIncomingServerAlreadyExists(config)</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+{</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+  assert(config instanceof AccountConfig);</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+  var accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+                       .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+  var incoming = config.incoming;</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+  var existing = accountManager.findRealServer(incoming.username,</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+        incoming.hostname,</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+        sanitize.enum(incoming.type, [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]),</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+        incoming.port);</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+  // if username does not have an '@', also check the e-mail</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+  // address form of the name.</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+  if (!existing &amp;&amp; incoming.username.indexOf(&quot;@&quot;) == -1)</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+    existing = accountManager.findRealServer(config.identity.emailAddress,</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+          incoming.hostname,</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+          sanitize.enum(incoming.type, [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]),</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+          incoming.port);</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+  return existing;</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+};</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+/**</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+ * Check whether the user's setup already has an outgoing server</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+ * which matches (hostname, port, username) the primary one</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+ * in the config.</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+ *</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+ * @param config {AccountConfig} filled in (no placeholders)</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+ * @return {nsISmtpServer} If it already exists, the server</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+ *     object is returned.</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+ *     If it's a new server, |null| is returned.</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+ */</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+function checkOutgoingServerAlreadyExists(config)</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+{</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+  assert(config instanceof AccountConfig);</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+  var smtpManager = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+                    .getService(Ci.nsISmtpService);</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+  var smtpServers = smtpManager.smtpServers;</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+  while (smtpServers.hasMoreElements())</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+  {</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+    let existingServer = smtpServers.getNext()</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+        .QueryInterface(Ci.nsISmtpServer);</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+    // TODO check username with full email address, too, like for incoming</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+    if (existingServer.hostname == config.outgoing.hostname &amp;&amp;</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+        existingServer.port == config.outgoing.port &amp;&amp;</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+        existingServer.username == config.outgoing.username)</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+      return existingServer;</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+  }</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+  return null;</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+};</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+/**</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+ * Check if there already is a &quot;Local Folders&quot;. If not, create it.</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+ * Copied from AccountWizard.js with minor updates.</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+ */</span>
<a href="#l11.129"></a><span id="l11.129"> function verifyLocalFoldersAccount(am) </span>
<a href="#l11.130"></a><span id="l11.130"> {</span>
<a href="#l11.131"></a><span id="l11.131">   let localMailServer;</span>
<a href="#l11.132"></a><span id="l11.132">   try {</span>
<a href="#l11.133"></a><span id="l11.133">     localMailServer = am.localFoldersServer;</span>
<a href="#l11.134"></a><span id="l11.134">   }</span>
<a href="#l11.135"></a><span id="l11.135">   catch (ex) {</span>
<a href="#l11.136"></a><span id="l11.136">     localMailServer = null;</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineat">@@ -259,15 +321,15 @@ function verifyLocalFoldersAccount(am)</span>
<a href="#l11.138"></a><span id="l11.138">     if (!localMailServer) </span>
<a href="#l11.139"></a><span id="l11.139">     {</span>
<a href="#l11.140"></a><span id="l11.140">       // creates a copy of the identity you pass in</span>
<a href="#l11.141"></a><span id="l11.141">       am.createLocalMailAccount();</span>
<a href="#l11.142"></a><span id="l11.142">       try {</span>
<a href="#l11.143"></a><span id="l11.143">         localMailServer = am.localFoldersServer;</span>
<a href="#l11.144"></a><span id="l11.144">       }</span>
<a href="#l11.145"></a><span id="l11.145">       catch (ex) {</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineminus">-        dump(&quot;error!  we should have found the local mail server after we created it.\n&quot;);</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+        ddump(&quot;Error! we should have found the local mail server &quot; +</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+              &quot;after we created it.&quot;);</span>
<a href="#l11.149"></a><span id="l11.149">       }</span>
<a href="#l11.150"></a><span id="l11.150">     }</span>
<a href="#l11.151"></a><span id="l11.151">   }</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineminus">-  catch (ex) {dump(&quot;Error in verifyLocalFoldersAccount &quot; + ex + &quot;\n&quot;);  }</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineminus">-</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+  catch (ex) { ddump(&quot;Error in verifyLocalFoldersAccount &quot; + ex); }</span>
<a href="#l11.155"></a><span id="l11.155"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/emailWizard.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/emailWizard.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -11,18 +11,18 @@</span>
<a href="#l12.4"></a><span id="l12.4">  * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l12.5"></a><span id="l12.5">  * for the specific language governing rights and limitations under the</span>
<a href="#l12.6"></a><span id="l12.6">  * License.</span>
<a href="#l12.7"></a><span id="l12.7">  *</span>
<a href="#l12.8"></a><span id="l12.8">  * The Original Code is mozilla.org code.</span>
<a href="#l12.9"></a><span id="l12.9">  *</span>
<a href="#l12.10"></a><span id="l12.10">  * The Initial Developer of the Original Code is</span>
<a href="#l12.11"></a><span id="l12.11">  * David Ascher &lt;davida@mozilla.com&gt; and</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">- * Ben Bucksch &lt;mozilla bucksch.org&gt;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2008-2009</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+ * Ben Bucksch &lt;ben.bucksch beonex.com&gt;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008-2011</span>
<a href="#l12.16"></a><span id="l12.16">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l12.17"></a><span id="l12.17">  *</span>
<a href="#l12.18"></a><span id="l12.18">  * Contributor(s):</span>
<a href="#l12.19"></a><span id="l12.19">  *</span>
<a href="#l12.20"></a><span id="l12.20">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l12.21"></a><span id="l12.21">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l12.22"></a><span id="l12.22">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l12.23"></a><span id="l12.23">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineat">@@ -61,1531 +61,1788 @@</span>
<a href="#l12.25"></a><span id="l12.25"> </span>
<a href="#l12.26"></a><span id="l12.26"> </span>
<a href="#l12.27"></a><span id="l12.27"> // from http://xyfer.blogspot.com/2005/01/javascript-regexp-email-validator.html</span>
<a href="#l12.28"></a><span id="l12.28"> var emailRE = /^[-_a-z0-9\'+*$^&amp;%=~!?{}]+(?:\.[-_a-z0-9\'+*$^&amp;%=~!?{}]+)*@(?:[-a-z0-9.]+\.[a-z]{2,6}|\d{1,3}(?:\.\d{1,3}){3})(?::\d+)?$/i;</span>
<a href="#l12.29"></a><span id="l12.29"> var domainRE = /^((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$|(\[?(\d{1,3}\.){3}\d{1,3}\]?)$/i</span>
<a href="#l12.30"></a><span id="l12.30"> const kHighestPort = 65535;</span>
<a href="#l12.31"></a><span id="l12.31"> </span>
<a href="#l12.32"></a><span id="l12.32"> Cu.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+let gEmailWizardLogger = Log4Moz.getConfiguredLogger(&quot;mail.wizard&quot;);</span>
<a href="#l12.34"></a><span id="l12.34"> </span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-let gSmtpManager = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-                   .getService(Ci.nsISmtpService);</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-let gAccountMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-let gEmailWizardLogger = Log4Moz.getConfiguredLogger(&quot;mail.wizard&quot;);</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-let gStringsBundle;</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">-let gBrandBundle;</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+var gStringsBundle;</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+var gMessengerBundle;</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+var gBrandShortName;</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+/*********************</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+TODO for bug 549045</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+- autodetect protocol</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+Polish</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+- reformat code style to match</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+&lt;https://developer.mozilla.org/En/Mozilla_Coding_Style_Guide#Control_Structures&gt;</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+- bold status</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+- remove status when user edited in manual edit</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+- add and adapt test from bug 534588</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+Bugs</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+- SSL cert errors</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+  - invalid cert (hostname mismatch) doesn't trigger warning dialog as it should</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+  - accept self-signed cert (e.g. imap.mail.ru) doesn't work</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+    (works without my patch),</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+    verifyConfig.js line 124 has no inServer, for whatever reason,</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+    although I didn't change verifyConfig.js at all</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+    (the change you see in that file is irrelevant: that was an attempt to fix</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+    the bug and clean up the code).</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+- Set radio IMAP vs. POP3, see TODO in code</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+Things to test (works for me):</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+- state transitions, buttons enable, status msgs</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+  - stop button</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+    - showes up again after stopping detection and restarting it</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+    - when stopping [retest]: buttons proper?</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+  - enter nonsense domain. guess fails, (so automatically) manual,</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+    change domain to real one (not in DB), guess succeeds.</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+    former bug: goes to manual first shortly, then to result</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+**********************/</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+// To debug, set mail.wizard.logging.dump (or .console)=&quot;All&quot; and kDebug = true</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+function e(elementID)</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+{</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+  return document.getElementById(elementID);</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+};</span>
<a href="#l12.81"></a><span id="l12.81"> </span>
<a href="#l12.82"></a><span id="l12.82"> function _hide(id)</span>
<a href="#l12.83"></a><span id="l12.83"> {</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-  document.getElementById(id).hidden = true;</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+  e(id).hidden = true;</span>
<a href="#l12.86"></a><span id="l12.86"> }</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+</span>
<a href="#l12.88"></a><span id="l12.88"> function _show(id)</span>
<a href="#l12.89"></a><span id="l12.89"> {</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-  document.getElementById(id).hidden = false;</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+  e(id).hidden = false;</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+}</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+function _enable(id)</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+{</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+  e(id).disabled = false;</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+}</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+function _disable(id)</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+{</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+  e(id).disabled = true;</span>
<a href="#l12.102"></a><span id="l12.102"> }</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+function setText(id, value)</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+{</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+  var element = e(id);</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+  assert(element, &quot;setText() on non-existant element ID&quot;);</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+  if (element.localName == &quot;textbox&quot; || element.localName == &quot;label&quot;) {</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+    element.value = value;</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+  } else if (element.localName == &quot;description&quot;) {</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+    element.textContent = value;</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+  } else {</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+    throw new NotReached(&quot;XUL element type not supported&quot;);</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+  }</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+}</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+function setLabelFromStringBundle(elementID, stringName)</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+{</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+  e(elementID).label = gMessengerBundle.getString(stringName);</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+};</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+</span>
<a href="#l12.123"></a><span id="l12.123"> function EmailConfigWizard()</span>
<a href="#l12.124"></a><span id="l12.124"> {</span>
<a href="#l12.125"></a><span id="l12.125">   this._init();</span>
<a href="#l12.126"></a><span id="l12.126"> }</span>
<a href="#l12.127"></a><span id="l12.127"> EmailConfigWizard.prototype =</span>
<a href="#l12.128"></a><span id="l12.128"> {</span>
<a href="#l12.129"></a><span id="l12.129">   _init : function EmailConfigWizard__init()</span>
<a href="#l12.130"></a><span id="l12.130">   {</span>
<a href="#l12.131"></a><span id="l12.131">     gEmailWizardLogger.info(&quot;Initializing setup wizard&quot;);</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineminus">-    this._probeAbortable = null;</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+    this._abortable = null;</span>
<a href="#l12.134"></a><span id="l12.134">   },</span>
<a href="#l12.135"></a><span id="l12.135"> </span>
<a href="#l12.136"></a><span id="l12.136">   onLoad : function()</span>
<a href="#l12.137"></a><span id="l12.137">   {</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+    /**</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+     * this._currentConfig is the config we got either from the XML file or</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+     * from guessing or from the user. Unless it's from the user, it contains</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+     * placeholders like %EMAILLOCALPART% in username and other fields.</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineplus">+     *</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+     * The config here must retain these placeholders, to be able to</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+     * adapt when the user enters a different realname, or password or</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+     * email local part. (A change of the domain name will trigger a new</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+     * detection anyways.)</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+     * That means, before you actually use the config (e.g. to create an</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+     * account or to show it to the user), you need to run replaceVariables().</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+     */</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+    this._currentConfig = null;</span>
<a href="#l12.151"></a><span id="l12.151">     this._domain = &quot;&quot;;</span>
<a href="#l12.152"></a><span id="l12.152">     this._email = &quot;&quot;;</span>
<a href="#l12.153"></a><span id="l12.153">     this._realname = &quot;&quot;;</span>
<a href="#l12.154"></a><span id="l12.154">     this._password = &quot;&quot;;</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineminus">-    this._verifiedConfig = false;</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineminus">-    this._userChangedIncomingServer = false;</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineminus">-    this._userChangedIncomingProtocol = false;</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineminus">-    this._userChangedIncomingPort = false;</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineminus">-    this._userChangedIncomingSocketType = false;</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineminus">-    this._userChangedOutgoingPort = false;</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineminus">-    this._userChangedOutgoingSocketType = false;</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineminus">-    this._userChangedPassword = false;</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineminus">-</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineminus">-    this._incomingWarning = 'cleartext';</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineminus">-    this._outgoingWarning = 'cleartext';</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineminus">-    this._userPickedOutgoingServer = false;</span>
<a href="#l12.167"></a><span id="l12.167">     this._okCallback = null;</span>
<a href="#l12.168"></a><span id="l12.168"> </span>
<a href="#l12.169"></a><span id="l12.169">     if (window.arguments &amp;&amp; window.arguments[0]) {</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineminus">-      if (window.arguments[0].msgWindow)</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+      if (window.arguments[0].msgWindow) {</span>
<a href="#l12.172"></a><span id="l12.172">         this._parentMsgWindow = window.arguments[0].msgWindow;</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineminus">-      if (window.arguments[0].okCallback)</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+      }</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+      if (window.arguments[0].okCallback) {</span>
<a href="#l12.176"></a><span id="l12.176">         this._okCallback = window.arguments[0].okCallback;</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+      }</span>
<a href="#l12.178"></a><span id="l12.178">     }</span>
<a href="#l12.179"></a><span id="l12.179"> </span>
<a href="#l12.180"></a><span id="l12.180" class="difflineminus">-    gStringsBundle = document.getElementById(&quot;strings&quot;);</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineminus">-    gBrandBundle = document.getElementById(&quot;bundle_brand&quot;);</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+    gStringsBundle = e(&quot;strings&quot;);</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+    gMessengerBundle = e(&quot;bundle_messenger&quot;);</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+    gBrandShortName = e(&quot;bundle_brand&quot;).getString(&quot;brandShortName&quot;);</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+    setLabelFromStringBundle(&quot;in-authMethod-password-cleartext&quot;,</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+        &quot;authPasswordCleartextViaSSL&quot;); // will warn about insecure later</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+    setLabelFromStringBundle(&quot;in-authMethod-password-encrypted&quot;,</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+        &quot;authPasswordEncrypted&quot;);</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+    setLabelFromStringBundle(&quot;in-authMethod-kerberos&quot;, &quot;authKerberos&quot;);</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+    setLabelFromStringBundle(&quot;in-authMethod-ntlm&quot;, &quot;authNTLM&quot;);</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+    setLabelFromStringBundle(&quot;out-authMethod-no&quot;, &quot;authNo&quot;);</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+    setLabelFromStringBundle(&quot;out-authMethod-password-cleartext&quot;,</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineplus">+        &quot;authPasswordCleartextViaSSL&quot;); // will warn about insecure later</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+    setLabelFromStringBundle(&quot;out-authMethod-password-encrypted&quot;,</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+        &quot;authPasswordEncrypted&quot;);</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+    setLabelFromStringBundle(&quot;out-authMethod-kerberos&quot;, &quot;authKerberos&quot;);</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineplus">+    setLabelFromStringBundle(&quot;out-authMethod-ntlm&quot;, &quot;authNTLM&quot;);</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineplus">+</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+    e(&quot;incoming_port&quot;).value = gStringsBundle.getString(&quot;port_auto&quot;);</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+    this.fillPortDropdown(&quot;smtp&quot;);</span>
<a href="#l12.202"></a><span id="l12.202"> </span>
<a href="#l12.203"></a><span id="l12.203">     // Populate SMTP server dropdown with already configured SMTP servers from</span>
<a href="#l12.204"></a><span id="l12.204">     // other accounts.</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineminus">-    let gSmtpManager = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineminus">-                       .getService(Ci.nsISmtpService);</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineminus">-    this._smtpServers = gSmtpManager.smtpServers;</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineminus">-    var menupopup = document.getElementById(&quot;smtp_menupopup&quot;);</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineminus">-    this._smtpServerCount = 0;</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineminus">-    while (this._smtpServers.hasMoreElements())</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineminus">-    {</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineminus">-      var server = this._smtpServers.getNext().QueryInterface(Ci.nsISmtpServer);</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineminus">-      this._smtpServerCount++;</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineminus">-      var menuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineminus">-      var label = server.displayname;</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineminus">-      if (server.key == gSmtpManager.defaultServer.key)</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+    var menulist = e(&quot;outgoing_hostname&quot;);</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+    var smtpManager = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineplus">+        .getService(Ci.nsISmtpService);</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+    var smtpServers = smtpManager.smtpServers;</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+    while (smtpServers.hasMoreElements()) {</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+      let server = smtpServers.getNext().QueryInterface(Ci.nsISmtpServer);</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+      let label = server.displayname;</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineplus">+      let key = server.key;</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineplus">+      if (smtpManager.defaultServer &amp;&amp;</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineplus">+          smtpManager.defaultServer.key == key) {</span>
<a href="#l12.227"></a><span id="l12.227">         label += &quot; &quot; + gStringsBundle.getString(&quot;default_server_tag&quot;);</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineplus">+      }</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+      let menuitem = menulist.appendItem(label, key, &quot;&quot;); // label,value,descr</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineplus">+      menuitem.serverKey = key;</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineplus">+    }</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineplus">+    // Add the entry for the new host to the menulist</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineplus">+    let menuitem = menulist.insertItemAt(0, &quot;&quot;, &quot;-new-&quot;); // pos,label,value</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+    menuitem.serverKey = null;</span>
<a href="#l12.235"></a><span id="l12.235"> </span>
<a href="#l12.236"></a><span id="l12.236" class="difflineminus">-      menuitem.setAttribute(&quot;label&quot;, label);</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineminus">-      menuitem.setAttribute(&quot;value&quot;, server.key);</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineminus">-      menuitem.hostname = server.hostname;</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineminus">-      menupopup.appendChild(menuitem);</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+    // admin-locked prefs hurray</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineplus">+    if (!Application.prefs.getValue(&quot;signon.rememberSignons&quot;, true)) {</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineplus">+      let rememberPasswordE = e(&quot;remember_password&quot;);</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineplus">+      rememberPasswordE.checked = false;</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+      rememberPasswordE.disabled = true;</span>
<a href="#l12.245"></a><span id="l12.245">     }</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineminus">-    var menulist = document.getElementById(&quot;outgoing_server&quot;);</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineminus">-    menulist.addEventListener(&quot;command&quot;,</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineminus">-      function(event) { gEmailConfigWizard.userChangedOutgoing(event); }, true);</span>
<a href="#l12.249"></a><span id="l12.249"> </span>
<a href="#l12.250"></a><span id="l12.250" class="difflineminus">-    // Store the size of the bottom half of the window in the fullspacer</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineminus">-    // element, so that we don't resize wildly when we show and hide it.</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineplus">+    // First, unhide the main window areas, and store the width,</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineplus">+    // so that we don't resize wildly when we unhide areas.</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+    // switchToMode() will then hide the unneeded parts again.</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+    // We will add some leeway of 10px, in case some of the &lt;description&gt;s wrap,</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineplus">+    // e.g. outgoing username != incoming username.</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineplus">+    _show(&quot;status_area&quot;);</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineplus">+    _show(&quot;result_area&quot;);</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineplus">+    _hide(&quot;manual-edit_area&quot;);</span>
<a href="#l12.260"></a><span id="l12.260">     window.sizeToContent();</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineminus">-    document.getElementById(&quot;settingsbox&quot;).hidden = true;</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineminus">-    document.getElementById(&quot;fullspacer&quot;).width = document.width;</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineminus">-    window.sizeToContent();</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineplus">+    e(&quot;mastervbox&quot;).setAttribute(&quot;style&quot;,</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineplus">+        &quot;min-width: &quot; + document.width + &quot;px; &quot; +</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineplus">+        &quot;min-height: &quot; + (document.height + 10) + &quot;px;&quot;);</span>
<a href="#l12.267"></a><span id="l12.267" class="difflineplus">+</span>
<a href="#l12.268"></a><span id="l12.268" class="difflineplus">+    this.switchToMode(&quot;start&quot;);</span>
<a href="#l12.269"></a><span id="l12.269" class="difflineplus">+    e(&quot;realname&quot;).focus();</span>
<a href="#l12.270"></a><span id="l12.270">   },</span>
<a href="#l12.271"></a><span id="l12.271"> </span>
<a href="#l12.272"></a><span id="l12.272" class="difflineminus">-  /* Correct the behavior of remember_password checkbox in case we change</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineminus">-   * signon.rememberSignons = true and come back</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineminus">-   */</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineminus">-  onFocus: function() {</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineminus">-    let passwordElt = document.getElementById(&quot;password&quot;);</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineminus">-    let rememberPasswordElt = document.getElementById(&quot;remember_password&quot;);</span>
<a href="#l12.278"></a><span id="l12.278" class="difflineminus">-    let rememberSignons_pref =</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineminus">-      Application.prefs.getValue(&quot;signon.rememberSignons&quot;, true);</span>
<a href="#l12.280"></a><span id="l12.280" class="difflineminus">-</span>
<a href="#l12.281"></a><span id="l12.281" class="difflineminus">-    rememberPasswordElt.disabled = !rememberSignons_pref ||</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineminus">-                                  passwordElt.value.length &lt; 1;</span>
<a href="#l12.283"></a><span id="l12.283" class="difflineminus">-    rememberPasswordElt.checked = rememberSignons_pref &amp;&amp;</span>
<a href="#l12.284"></a><span id="l12.284" class="difflineminus">-                                  !this._userChangedPassword &amp;&amp;</span>
<a href="#l12.285"></a><span id="l12.285" class="difflineminus">-                                  passwordElt.value.length &gt;= 1;</span>
<a href="#l12.286"></a><span id="l12.286" class="difflineminus">-  },</span>
<a href="#l12.287"></a><span id="l12.287" class="difflineminus">-</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineminus">-  /* When the next button is clicked we've moved from the initial account</span>
<a href="#l12.289"></a><span id="l12.289" class="difflineminus">-   * information stage to using that information to configure account details.</span>
<a href="#l12.290"></a><span id="l12.290" class="difflineplus">+  /**</span>
<a href="#l12.291"></a><span id="l12.291" class="difflineplus">+   * Changes the window configuration to the different modes we have.</span>
<a href="#l12.292"></a><span id="l12.292" class="difflineplus">+   * Shows/hides various window parts and buttons.</span>
<a href="#l12.293"></a><span id="l12.293" class="difflineplus">+   * @param modename {String-enum}</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineplus">+   *    &quot;start&quot; : Just the realname, email address, password fields</span>
<a href="#l12.295"></a><span id="l12.295" class="difflineplus">+   *    &quot;find-config&quot; : detection step, adds the progress message/spinner</span>
<a href="#l12.296"></a><span id="l12.296" class="difflineplus">+   *    &quot;result&quot; : We found a config and display it to the user.</span>
<a href="#l12.297"></a><span id="l12.297" class="difflineplus">+   *       The user may create the account.</span>
<a href="#l12.298"></a><span id="l12.298" class="difflineplus">+   *    &quot;manual-edit&quot; : The user wants (or needs) to manually enter their</span>
<a href="#l12.299"></a><span id="l12.299" class="difflineplus">+   *       the server hostname and other settings. We'll use them as provided.</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineplus">+   * Additionally, there are the following sub-modes which can be entered after</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineplus">+   * you entered the main mode:</span>
<a href="#l12.302"></a><span id="l12.302" class="difflineplus">+   *    &quot;manual-edit-have-hostname&quot; : user entered a hostname for both servers</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineplus">+   *        that we can use</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineplus">+   *    &quot;manual-edit-testing&quot; : User pressed the [Re-test] button and</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineplus">+   *         we're currently detecting the &quot;Auto&quot; values</span>
<a href="#l12.306"></a><span id="l12.306" class="difflineplus">+   *    &quot;manual-edit-complete&quot; : user entered (or we tested) all necessary</span>
<a href="#l12.307"></a><span id="l12.307" class="difflineplus">+   *         values, and we're ready to create to account</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineplus">+   * Currently, this doesn't cover the warning dialogs etc.. It may later.</span>
<a href="#l12.309"></a><span id="l12.309">    */</span>
<a href="#l12.310"></a><span id="l12.310" class="difflineminus">-  onNext : function()</span>
<a href="#l12.311"></a><span id="l12.311" class="difflineplus">+  switchToMode : function(modename)</span>
<a href="#l12.312"></a><span id="l12.312">   {</span>
<a href="#l12.313"></a><span id="l12.313" class="difflineminus">-    // change the inputs to a flat look</span>
<a href="#l12.314"></a><span id="l12.314" class="difflineminus">-    this._accountInfoInputs(true);</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineplus">+    if (modename == this._currentModename) {</span>
<a href="#l12.316"></a><span id="l12.316" class="difflineplus">+      return;</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineplus">+    }</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineplus">+    this._currentModename = modename;</span>
<a href="#l12.319"></a><span id="l12.319" class="difflineplus">+    gEmailWizardLogger.info(&quot;switching to UI mode &quot; + modename)</span>
<a href="#l12.320"></a><span id="l12.320" class="difflineplus">+</span>
<a href="#l12.321"></a><span id="l12.321" class="difflineplus">+    //_show(&quot;initialSettings&quot;); always visible</span>
<a href="#l12.322"></a><span id="l12.322" class="difflineplus">+    //_show(&quot;cancel_button&quot;); always visible</span>
<a href="#l12.323"></a><span id="l12.323" class="difflineplus">+    if (modename == &quot;start&quot;) {</span>
<a href="#l12.324"></a><span id="l12.324" class="difflineplus">+      _hide(&quot;status_area&quot;);</span>
<a href="#l12.325"></a><span id="l12.325" class="difflineplus">+      _hide(&quot;result_area&quot;);</span>
<a href="#l12.326"></a><span id="l12.326" class="difflineplus">+      _hide(&quot;manual-edit_area&quot;);</span>
<a href="#l12.327"></a><span id="l12.327"> </span>
<a href="#l12.328"></a><span id="l12.328" class="difflineminus">-    this._email = document.getElementById(&quot;email&quot;).value;</span>
<a href="#l12.329"></a><span id="l12.329" class="difflineminus">-    this._realname = document.getElementById(&quot;realname&quot;).value;</span>
<a href="#l12.330"></a><span id="l12.330" class="difflineminus">-    this._password = document.getElementById(&quot;password&quot;).value;</span>
<a href="#l12.331"></a><span id="l12.331" class="difflineplus">+      _show(&quot;next_button&quot;);</span>
<a href="#l12.332"></a><span id="l12.332" class="difflineplus">+      _disable(&quot;next_button&quot;); // will be enabled by code</span>
<a href="#l12.333"></a><span id="l12.333" class="difflineplus">+      _hide(&quot;half-manual-test_button&quot;);</span>
<a href="#l12.334"></a><span id="l12.334" class="difflineplus">+      _hide(&quot;create_button&quot;);</span>
<a href="#l12.335"></a><span id="l12.335" class="difflineplus">+      _hide(&quot;stop_button&quot;);</span>
<a href="#l12.336"></a><span id="l12.336" class="difflineplus">+      _hide(&quot;manual-edit_button&quot;);</span>
<a href="#l12.337"></a><span id="l12.337" class="difflineplus">+      _hide(&quot;advanced-setup_button&quot;);</span>
<a href="#l12.338"></a><span id="l12.338" class="difflineplus">+    } else if (modename == &quot;find-config&quot;) {</span>
<a href="#l12.339"></a><span id="l12.339" class="difflineplus">+      _show(&quot;status_area&quot;);</span>
<a href="#l12.340"></a><span id="l12.340" class="difflineplus">+      _hide(&quot;result_area&quot;);</span>
<a href="#l12.341"></a><span id="l12.341" class="difflineplus">+      _hide(&quot;manual-edit_area&quot;);</span>
<a href="#l12.342"></a><span id="l12.342"> </span>
<a href="#l12.343"></a><span id="l12.343" class="difflineminus">-    this.showConfigDetails();</span>
<a href="#l12.344"></a><span id="l12.344" class="difflineplus">+      _show(&quot;next_button&quot;);</span>
<a href="#l12.345"></a><span id="l12.345" class="difflineplus">+      _disable(&quot;next_button&quot;);</span>
<a href="#l12.346"></a><span id="l12.346" class="difflineplus">+      _hide(&quot;half-manual-test_button&quot;);</span>
<a href="#l12.347"></a><span id="l12.347" class="difflineplus">+      _hide(&quot;create_button&quot;);</span>
<a href="#l12.348"></a><span id="l12.348" class="difflineplus">+      _show(&quot;stop_button&quot;);</span>
<a href="#l12.349"></a><span id="l12.349" class="difflineplus">+      this.onStop = this.onStopFindConfig;</span>
<a href="#l12.350"></a><span id="l12.350" class="difflineplus">+      _show(&quot;manual-edit_button&quot;);</span>
<a href="#l12.351"></a><span id="l12.351" class="difflineplus">+      _hide(&quot;advanced-setup_button&quot;);</span>
<a href="#l12.352"></a><span id="l12.352" class="difflineplus">+    } else if (modename == &quot;result&quot;) {</span>
<a href="#l12.353"></a><span id="l12.353" class="difflineplus">+      _show(&quot;status_area&quot;);</span>
<a href="#l12.354"></a><span id="l12.354" class="difflineplus">+      _show(&quot;result_area&quot;);</span>
<a href="#l12.355"></a><span id="l12.355" class="difflineplus">+      _hide(&quot;manual-edit_area&quot;);</span>
<a href="#l12.356"></a><span id="l12.356" class="difflineplus">+</span>
<a href="#l12.357"></a><span id="l12.357" class="difflineplus">+      _hide(&quot;next_button&quot;);</span>
<a href="#l12.358"></a><span id="l12.358" class="difflineplus">+      _hide(&quot;half-manual-test_button&quot;);</span>
<a href="#l12.359"></a><span id="l12.359" class="difflineplus">+      _show(&quot;create_button&quot;);</span>
<a href="#l12.360"></a><span id="l12.360" class="difflineplus">+      _enable(&quot;create_button&quot;);</span>
<a href="#l12.361"></a><span id="l12.361" class="difflineplus">+      _hide(&quot;stop_button&quot;);</span>
<a href="#l12.362"></a><span id="l12.362" class="difflineplus">+      _show(&quot;manual-edit_button&quot;);</span>
<a href="#l12.363"></a><span id="l12.363" class="difflineplus">+      _hide(&quot;advanced-setup_button&quot;);</span>
<a href="#l12.364"></a><span id="l12.364" class="difflineplus">+    } else if (modename == &quot;manual-edit&quot;) {</span>
<a href="#l12.365"></a><span id="l12.365" class="difflineplus">+      _show(&quot;status_area&quot;);</span>
<a href="#l12.366"></a><span id="l12.366" class="difflineplus">+      _hide(&quot;result_area&quot;);</span>
<a href="#l12.367"></a><span id="l12.367" class="difflineplus">+      _show(&quot;manual-edit_area&quot;);</span>
<a href="#l12.368"></a><span id="l12.368"> </span>
<a href="#l12.369"></a><span id="l12.369" class="difflineminus">-    this._domain = this._email.split(&quot;@&quot;)[1].toLowerCase();</span>
<a href="#l12.370"></a><span id="l12.370" class="difflineminus">-    this.findConfig(this._domain, this._email);</span>
<a href="#l12.371"></a><span id="l12.371" class="difflineplus">+      _hide(&quot;next_button&quot;);</span>
<a href="#l12.372"></a><span id="l12.372" class="difflineplus">+      _show(&quot;half-manual-test_button&quot;);</span>
<a href="#l12.373"></a><span id="l12.373" class="difflineplus">+      _disable(&quot;half-manual-test_button&quot;);</span>
<a href="#l12.374"></a><span id="l12.374" class="difflineplus">+      _show(&quot;create_button&quot;);</span>
<a href="#l12.375"></a><span id="l12.375" class="difflineplus">+      _disable(&quot;create_button&quot;);</span>
<a href="#l12.376"></a><span id="l12.376" class="difflineplus">+      _hide(&quot;stop_button&quot;);</span>
<a href="#l12.377"></a><span id="l12.377" class="difflineplus">+      _hide(&quot;manual-edit_button&quot;);</span>
<a href="#l12.378"></a><span id="l12.378" class="difflineplus">+      _show(&quot;advanced-setup_button&quot;);</span>
<a href="#l12.379"></a><span id="l12.379" class="difflineplus">+      _disable(&quot;advanced-setup_button&quot;);</span>
<a href="#l12.380"></a><span id="l12.380" class="difflineplus">+    } else if (modename == &quot;manual-edit-have-hostname&quot;) {</span>
<a href="#l12.381"></a><span id="l12.381" class="difflineplus">+      _show(&quot;status_area&quot;);</span>
<a href="#l12.382"></a><span id="l12.382" class="difflineplus">+      _hide(&quot;result_area&quot;);</span>
<a href="#l12.383"></a><span id="l12.383" class="difflineplus">+      _show(&quot;manual-edit_area&quot;);</span>
<a href="#l12.384"></a><span id="l12.384" class="difflineplus">+      _hide(&quot;manual-edit_button&quot;);</span>
<a href="#l12.385"></a><span id="l12.385" class="difflineplus">+      _hide(&quot;next_button&quot;);</span>
<a href="#l12.386"></a><span id="l12.386" class="difflineplus">+      _show(&quot;create_button&quot;);</span>
<a href="#l12.387"></a><span id="l12.387"> </span>
<a href="#l12.388"></a><span id="l12.388" class="difflineminus">-    // swap out buttons</span>
<a href="#l12.389"></a><span id="l12.389" class="difflineminus">-    _hide(&quot;next_button&quot;);</span>
<a href="#l12.390"></a><span id="l12.390" class="difflineminus">-    _show(&quot;back_button&quot;);</span>
<a href="#l12.391"></a><span id="l12.391" class="difflineminus">-    _show(&quot;stop_button&quot;);</span>
<a href="#l12.392"></a><span id="l12.392" class="difflineminus">-    _hide(&quot;edit_button&quot;);</span>
<a href="#l12.393"></a><span id="l12.393" class="difflineminus">-    _hide(&quot;go_button&quot;);</span>
<a href="#l12.394"></a><span id="l12.394" class="difflineplus">+      _show(&quot;half-manual-test_button&quot;);</span>
<a href="#l12.395"></a><span id="l12.395" class="difflineplus">+      _enable(&quot;half-manual-test_button&quot;);</span>
<a href="#l12.396"></a><span id="l12.396" class="difflineplus">+      _disable(&quot;create_button&quot;);</span>
<a href="#l12.397"></a><span id="l12.397" class="difflineplus">+      _hide(&quot;stop_button&quot;);</span>
<a href="#l12.398"></a><span id="l12.398" class="difflineplus">+      _show(&quot;advanced-setup_button&quot;);</span>
<a href="#l12.399"></a><span id="l12.399" class="difflineplus">+      _disable(&quot;advanced-setup_button&quot;);</span>
<a href="#l12.400"></a><span id="l12.400" class="difflineplus">+    } else if (modename == &quot;manual-edit-testing&quot;) {</span>
<a href="#l12.401"></a><span id="l12.401" class="difflineplus">+      _show(&quot;status_area&quot;);</span>
<a href="#l12.402"></a><span id="l12.402" class="difflineplus">+      _hide(&quot;result_area&quot;);</span>
<a href="#l12.403"></a><span id="l12.403" class="difflineplus">+      _show(&quot;manual-edit_area&quot;);</span>
<a href="#l12.404"></a><span id="l12.404" class="difflineplus">+      _hide(&quot;manual-edit_button&quot;);</span>
<a href="#l12.405"></a><span id="l12.405" class="difflineplus">+      _hide(&quot;next_button&quot;);</span>
<a href="#l12.406"></a><span id="l12.406" class="difflineplus">+      _show(&quot;create_button&quot;);</span>
<a href="#l12.407"></a><span id="l12.407"> </span>
<a href="#l12.408"></a><span id="l12.408" class="difflineplus">+      _show(&quot;half-manual-test_button&quot;);</span>
<a href="#l12.409"></a><span id="l12.409" class="difflineplus">+      _disable(&quot;half-manual-test_button&quot;);</span>
<a href="#l12.410"></a><span id="l12.410" class="difflineplus">+      _disable(&quot;create_button&quot;);</span>
<a href="#l12.411"></a><span id="l12.411" class="difflineplus">+      _show(&quot;stop_button&quot;);</span>
<a href="#l12.412"></a><span id="l12.412" class="difflineplus">+      this.onStop = this.onStopHalfManualTesting;</span>
<a href="#l12.413"></a><span id="l12.413" class="difflineplus">+      _show(&quot;advanced-setup_button&quot;);</span>
<a href="#l12.414"></a><span id="l12.414" class="difflineplus">+      _disable(&quot;advanced-setup_button&quot;);</span>
<a href="#l12.415"></a><span id="l12.415" class="difflineplus">+    } else if (modename == &quot;manual-edit-complete&quot;) {</span>
<a href="#l12.416"></a><span id="l12.416" class="difflineplus">+      _show(&quot;status_area&quot;);</span>
<a href="#l12.417"></a><span id="l12.417" class="difflineplus">+      _hide(&quot;result_area&quot;);</span>
<a href="#l12.418"></a><span id="l12.418" class="difflineplus">+      _show(&quot;manual-edit_area&quot;);</span>
<a href="#l12.419"></a><span id="l12.419" class="difflineplus">+      _hide(&quot;manual-edit_button&quot;);</span>
<a href="#l12.420"></a><span id="l12.420" class="difflineplus">+      _hide(&quot;next_button&quot;);</span>
<a href="#l12.421"></a><span id="l12.421" class="difflineplus">+      _show(&quot;create_button&quot;);</span>
<a href="#l12.422"></a><span id="l12.422" class="difflineplus">+</span>
<a href="#l12.423"></a><span id="l12.423" class="difflineplus">+      _show(&quot;half-manual-test_button&quot;);</span>
<a href="#l12.424"></a><span id="l12.424" class="difflineplus">+      _enable(&quot;half-manual-test_button&quot;);</span>
<a href="#l12.425"></a><span id="l12.425" class="difflineplus">+      _enable(&quot;create_button&quot;);</span>
<a href="#l12.426"></a><span id="l12.426" class="difflineplus">+      _hide(&quot;stop_button&quot;);</span>
<a href="#l12.427"></a><span id="l12.427" class="difflineplus">+      _show(&quot;advanced-setup_button&quot;);</span>
<a href="#l12.428"></a><span id="l12.428" class="difflineplus">+      _enable(&quot;advanced-setup_button&quot;);</span>
<a href="#l12.429"></a><span id="l12.429" class="difflineplus">+    } else {</span>
<a href="#l12.430"></a><span id="l12.430" class="difflineplus">+      throw new NotReached(&quot;unknown mode&quot;);</span>
<a href="#l12.431"></a><span id="l12.431" class="difflineplus">+    }</span>
<a href="#l12.432"></a><span id="l12.432">     window.sizeToContent();</span>
<a href="#l12.433"></a><span id="l12.433">   },</span>
<a href="#l12.434"></a><span id="l12.434"> </span>
<a href="#l12.435"></a><span id="l12.435" class="difflineminus">-  /* The back button can be clicked at anytime and should stop all probing of</span>
<a href="#l12.436"></a><span id="l12.436" class="difflineminus">-   * account details.  This allows the person to return to their account</span>
<a href="#l12.437"></a><span id="l12.437" class="difflineminus">-   * information details in case anything was incorrect.</span>
<a href="#l12.438"></a><span id="l12.438" class="difflineminus">-   *</span>
<a href="#l12.439"></a><span id="l12.439" class="difflineminus">-   * Any account details that were manually entered should be remembered even</span>
<a href="#l12.440"></a><span id="l12.440" class="difflineminus">-   * when this back button is clicked</span>
<a href="#l12.441"></a><span id="l12.441" class="difflineplus">+  /**</span>
<a href="#l12.442"></a><span id="l12.442" class="difflineplus">+   * Start from beginning with possibly new email address.</span>
<a href="#l12.443"></a><span id="l12.443">    */</span>
<a href="#l12.444"></a><span id="l12.444" class="difflineminus">-  onBack : function()</span>
<a href="#l12.445"></a><span id="l12.445" class="difflineplus">+  onStartOver : function()</span>
<a href="#l12.446"></a><span id="l12.446">   {</span>
<a href="#l12.447"></a><span id="l12.447" class="difflineminus">-    this._disableConfigDetails(true);</span>
<a href="#l12.448"></a><span id="l12.448" class="difflineminus">-    _hide(&quot;popimap_radio_area&quot;);</span>
<a href="#l12.449"></a><span id="l12.449" class="difflineminus">-    this.hideConfigDetails();</span>
<a href="#l12.450"></a><span id="l12.450" class="difflineminus">-    this.clearConfigDetails();</span>
<a href="#l12.451"></a><span id="l12.451" class="difflineminus">-</span>
<a href="#l12.452"></a><span id="l12.452" class="difflineminus">-    // change the inputs back to regular</span>
<a href="#l12.453"></a><span id="l12.453" class="difflineminus">-    this._accountInfoInputs(false);</span>
<a href="#l12.454"></a><span id="l12.454" class="difflineminus">-</span>
<a href="#l12.455"></a><span id="l12.455" class="difflineminus">-    // swap buttons back</span>
<a href="#l12.456"></a><span id="l12.456" class="difflineminus">-    _show(&quot;next_button&quot;);</span>
<a href="#l12.457"></a><span id="l12.457" class="difflineminus">-    _hide(&quot;back_button&quot;);</span>
<a href="#l12.458"></a><span id="l12.458" class="difflineminus">-    document.getElementById(&quot;advanced_settings&quot;).disabled = true;</span>
<a href="#l12.459"></a><span id="l12.459" class="difflineminus">-    _hide(&quot;advanced_settings&quot;);</span>
<a href="#l12.460"></a><span id="l12.460" class="difflineminus">-    window.sizeToContent();</span>
<a href="#l12.461"></a><span id="l12.461" class="difflineminus">-  },</span>
<a href="#l12.462"></a><span id="l12.462" class="difflineminus">-</span>
<a href="#l12.463"></a><span id="l12.463" class="difflineminus">-  /* Helper method that enables or disabled all the account information inputs</span>
<a href="#l12.464"></a><span id="l12.464" class="difflineminus">-   */</span>
<a href="#l12.465"></a><span id="l12.465" class="difflineminus">-  _accountInfoInputs : function(disabled)</span>
<a href="#l12.466"></a><span id="l12.466" class="difflineminus">-  {</span>
<a href="#l12.467"></a><span id="l12.467" class="difflineminus">-    let ids = [&quot;realname&quot;, &quot;email&quot;, &quot;password&quot;, &quot;remember_password&quot;];</span>
<a href="#l12.468"></a><span id="l12.468" class="difflineminus">-    if (disabled &amp;&amp; document.getElementById(&quot;password&quot;).getAttribute(&quot;empty&quot;)) {</span>
<a href="#l12.469"></a><span id="l12.469" class="difflineminus">-      document.getElementById(&quot;password&quot;).value = &quot; &quot;;</span>
<a href="#l12.470"></a><span id="l12.470" class="difflineminus">-      document.getElementById(&quot;password&quot;).setAttribute(&quot;empty&quot;, true);</span>
<a href="#l12.471"></a><span id="l12.471" class="difflineminus">-      document.getElementById(&quot;remember_password&quot;).checked = false;</span>
<a href="#l12.472"></a><span id="l12.472" class="difflineplus">+    if (this._abortable) {</span>
<a href="#l12.473"></a><span id="l12.473" class="difflineplus">+      this.onStop();</span>
<a href="#l12.474"></a><span id="l12.474">     }</span>
<a href="#l12.475"></a><span id="l12.475" class="difflineminus">-</span>
<a href="#l12.476"></a><span id="l12.476" class="difflineminus">-    for ( let i = 0; i &lt; ids.length; i++ )</span>
<a href="#l12.477"></a><span id="l12.477" class="difflineminus">-      document.getElementById(ids[i]).disabled = disabled;</span>
<a href="#l12.478"></a><span id="l12.478" class="difflineminus">-</span>
<a href="#l12.479"></a><span id="l12.479" class="difflineminus">-    if (!disabled &amp;&amp;</span>
<a href="#l12.480"></a><span id="l12.480" class="difflineminus">-        document.getElementById(&quot;password&quot;).getAttribute(&quot;empty&quot;)) {</span>
<a href="#l12.481"></a><span id="l12.481" class="difflineminus">-      document.getElementById(&quot;password&quot;).value = &quot;&quot;;</span>
<a href="#l12.482"></a><span id="l12.482" class="difflineminus">-      document.getElementById(&quot;password&quot;).setAttribute(&quot;empty&quot;, true);</span>
<a href="#l12.483"></a><span id="l12.483" class="difflineminus">-      document.getElementById(&quot;remember_password&quot;).checked = false;</span>
<a href="#l12.484"></a><span id="l12.484" class="difflineminus">-    }</span>
<a href="#l12.485"></a><span id="l12.485" class="difflineplus">+    this.switchToMode(&quot;start&quot;);</span>
<a href="#l12.486"></a><span id="l12.486">   },</span>
<a href="#l12.487"></a><span id="l12.487"> </span>
<a href="#l12.488"></a><span id="l12.488" class="difflineminus">-  userChangedOutgoing : function(event)</span>
<a href="#l12.489"></a><span id="l12.489" class="difflineplus">+  getConcreteConfig : function()</span>
<a href="#l12.490"></a><span id="l12.490">   {</span>
<a href="#l12.491"></a><span id="l12.491" class="difflineminus">-    let menulist = document.getElementById(&quot;outgoing_server&quot;);</span>
<a href="#l12.492"></a><span id="l12.492" class="difflineminus">-</span>
<a href="#l12.493"></a><span id="l12.493" class="difflineminus">-    let selectedIndex = menulist.getIndexOfItem(event.target);</span>
<a href="#l12.494"></a><span id="l12.494" class="difflineminus">-</span>
<a href="#l12.495"></a><span id="l12.495" class="difflineminus">-    if (selectedIndex != -1) {</span>
<a href="#l12.496"></a><span id="l12.496" class="difflineminus">-      document.getElementById(&quot;outgoing_port&quot;).value =</span>
<a href="#l12.497"></a><span id="l12.497" class="difflineminus">-        this._currentConfig.outgoing.port;</span>
<a href="#l12.498"></a><span id="l12.498" class="difflineminus">-      document.getElementById(&quot;outgoing_security&quot;).value =</span>
<a href="#l12.499"></a><span id="l12.499" class="difflineminus">-        this._currentConfig.outgoing.socketType;</span>
<a href="#l12.500"></a><span id="l12.500" class="difflineminus">-    }</span>
<a href="#l12.501"></a><span id="l12.501" class="difflineminus">-</span>
<a href="#l12.502"></a><span id="l12.502" class="difflineminus">-    if (selectedIndex == -1 || selectedIndex == 0) {</span>
<a href="#l12.503"></a><span id="l12.503" class="difflineminus">-      this._outgoingState = '';</span>
<a href="#l12.504"></a><span id="l12.504" class="difflineminus">-      this._userPickedOutgoingServer = false;</span>
<a href="#l12.505"></a><span id="l12.505" class="difflineminus">-      _show('outgoing_protocol');</span>
<a href="#l12.506"></a><span id="l12.506" class="difflineminus">-      _show('outgoing_port');</span>
<a href="#l12.507"></a><span id="l12.507" class="difflineminus">-      _show('outgoing_security');</span>
<a href="#l12.508"></a><span id="l12.508" class="difflineminus">-      menulist.setAttribute(&quot;editable&quot;, true);</span>
<a href="#l12.509"></a><span id="l12.509" class="difflineminus">-      return;</span>
<a href="#l12.510"></a><span id="l12.510" class="difflineminus">-    }</span>
<a href="#l12.511"></a><span id="l12.511" class="difflineminus">-    menulist.setAttribute(&quot;editable&quot;, false);</span>
<a href="#l12.512"></a><span id="l12.512" class="difflineminus">-    this._outgoingState = 'done';</span>
<a href="#l12.513"></a><span id="l12.513" class="difflineminus">-    this._outgoingWarning = '';</span>
<a href="#l12.514"></a><span id="l12.514" class="difflineminus">-</span>
<a href="#l12.515"></a><span id="l12.515" class="difflineminus">-    if (this._probeAbortable)</span>
<a href="#l12.516"></a><span id="l12.516" class="difflineminus">-      this._probeAbortable.cancel('outgoing');</span>
<a href="#l12.517"></a><span id="l12.517" class="difflineminus">-</span>
<a href="#l12.518"></a><span id="l12.518" class="difflineminus">-    // Re-set the outgoing port and security.</span>
<a href="#l12.519"></a><span id="l12.519" class="difflineminus">-    this._userPickedOutgoingServer = true;</span>
<a href="#l12.520"></a><span id="l12.520" class="difflineminus">-    _hide('outgoing_protocol');</span>
<a href="#l12.521"></a><span id="l12.521" class="difflineminus">-    _hide('outgoing_port');</span>
<a href="#l12.522"></a><span id="l12.522" class="difflineminus">-    _hide('outgoing_security');</span>
<a href="#l12.523"></a><span id="l12.523" class="difflineminus">-</span>
<a href="#l12.524"></a><span id="l12.524" class="difflineminus">-    if (this._incomingState == 'done')</span>
<a href="#l12.525"></a><span id="l12.525" class="difflineminus">-      this.foundConfig(this.getUserConfig());</span>
<a href="#l12.526"></a><span id="l12.526" class="difflineminus">-  },</span>
<a href="#l12.527"></a><span id="l12.527" class="difflineminus">-</span>
<a href="#l12.528"></a><span id="l12.528" class="difflineminus">-  /* This does very little other than to check that a name was entered at all</span>
<a href="#l12.529"></a><span id="l12.529" class="difflineminus">-   * Since this is such an insignificant test we should be using a very light</span>
<a href="#l12.530"></a><span id="l12.530" class="difflineminus">-   * or even jovial warning.</span>
<a href="#l12.531"></a><span id="l12.531" class="difflineminus">-   */</span>
<a href="#l12.532"></a><span id="l12.532" class="difflineminus">-  validateRealname : function()</span>
<a href="#l12.533"></a><span id="l12.533" class="difflineminus">-  {</span>
<a href="#l12.534"></a><span id="l12.534" class="difflineminus">-    let realname = document.getElementById(&quot;realname&quot;);</span>
<a href="#l12.535"></a><span id="l12.535" class="difflineminus">-    if (realname.value.length &gt; 0) {</span>
<a href="#l12.536"></a><span id="l12.536" class="difflineminus">-      this.clearError(&quot;nameerror&quot;);</span>
<a href="#l12.537"></a><span id="l12.537" class="difflineminus">-      _show(&quot;nametext&quot;);</span>
<a href="#l12.538"></a><span id="l12.538" class="difflineminus">-      realname.removeAttribute(&quot;error&quot;);</span>
<a href="#l12.539"></a><span id="l12.539" class="difflineminus">-    }</span>
<a href="#l12.540"></a><span id="l12.540" class="difflineminus">-    else {</span>
<a href="#l12.541"></a><span id="l12.541" class="difflineminus">-      _hide(&quot;nametext&quot;);</span>
<a href="#l12.542"></a><span id="l12.542" class="difflineminus">-      this.setError(&quot;nameerror&quot;, &quot;please_enter_name&quot;);</span>
<a href="#l12.543"></a><span id="l12.543" class="difflineminus">-      realname.setAttribute(&quot;error&quot;, &quot;true&quot;);</span>
<a href="#l12.544"></a><span id="l12.544" class="difflineminus">-    }</span>
<a href="#l12.545"></a><span id="l12.545" class="difflineplus">+    var result = this._currentConfig.copy();</span>
<a href="#l12.546"></a><span id="l12.546" class="difflineplus">+    replaceVariables(result, this._realname, this._email, this._password);</span>
<a href="#l12.547"></a><span id="l12.547" class="difflineplus">+    result.rememberPassword = e(&quot;remember_password&quot;).checked &amp;&amp;</span>
<a href="#l12.548"></a><span id="l12.548" class="difflineplus">+                              !!this._password;</span>
<a href="#l12.549"></a><span id="l12.549" class="difflineplus">+    return result;</span>
<a href="#l12.550"></a><span id="l12.550">   },</span>
<a href="#l12.551"></a><span id="l12.551"> </span>
<a href="#l12.552"></a><span id="l12.552">   /*</span>
<a href="#l12.553"></a><span id="l12.553">    * This checks if the email address is at least possibly valid, meaning it</span>
<a href="#l12.554"></a><span id="l12.554">    * has an '@' before the last char.</span>
<a href="#l12.555"></a><span id="l12.555">    */</span>
<a href="#l12.556"></a><span id="l12.556" class="difflineminus">-  emailAddrValidish : function()</span>
<a href="#l12.557"></a><span id="l12.557" class="difflineplus">+  validateEmailMinimally : function(emailAddr)</span>
<a href="#l12.558"></a><span id="l12.558">   {</span>
<a href="#l12.559"></a><span id="l12.559" class="difflineminus">-    let emailAddr = document.getElementById('email').value;</span>
<a href="#l12.560"></a><span id="l12.560">     let atPos = emailAddr.lastIndexOf(&quot;@&quot;);</span>
<a href="#l12.561"></a><span id="l12.561" class="difflineminus">-    return  atPos &gt; 0 &amp;&amp; atPos + 1 &lt; emailAddr.length;</span>
<a href="#l12.562"></a><span id="l12.562" class="difflineplus">+    return atPos &gt; 0 &amp;&amp; atPos + 1 &lt; emailAddr.length;</span>
<a href="#l12.563"></a><span id="l12.563">   },</span>
<a href="#l12.564"></a><span id="l12.564"> </span>
<a href="#l12.565"></a><span id="l12.565">   /*</span>
<a href="#l12.566"></a><span id="l12.566" class="difflineminus">-   * onEmailInput and onRealnameInput are called onInput, and just handle</span>
<a href="#l12.567"></a><span id="l12.567" class="difflineminus">-   * hiding/showing the next button based on whether there's a semi-reasonable</span>
<a href="#l12.568"></a><span id="l12.568" class="difflineminus">-   * e-mail address and nonblank realname to start with.</span>
<a href="#l12.569"></a><span id="l12.569" class="difflineplus">+   * This checks if the email address is syntactically valid,</span>
<a href="#l12.570"></a><span id="l12.570" class="difflineplus">+   * as far as we can determine. We try hard to make full checks.</span>
<a href="#l12.571"></a><span id="l12.571" class="difflineplus">+   *</span>
<a href="#l12.572"></a><span id="l12.572" class="difflineplus">+   * OTOH, we have a very small chance of false negatives,</span>
<a href="#l12.573"></a><span id="l12.573" class="difflineplus">+   * because the RFC822 address spec is insanely complicated,</span>
<a href="#l12.574"></a><span id="l12.574" class="difflineplus">+   * but rarely needed, so when this here fails, we show an error message,</span>
<a href="#l12.575"></a><span id="l12.575" class="difflineplus">+   * but don't stop the user from continuing.</span>
<a href="#l12.576"></a><span id="l12.576" class="difflineplus">+   * In contrast, if validateEmailMinimally() fails, we stop the user.</span>
<a href="#l12.577"></a><span id="l12.577">    */</span>
<a href="#l12.578"></a><span id="l12.578" class="difflineminus">-  onEmailInput : function()</span>
<a href="#l12.579"></a><span id="l12.579" class="difflineplus">+  validateEmail : function(emailAddr)</span>
<a href="#l12.580"></a><span id="l12.580">   {</span>
<a href="#l12.581"></a><span id="l12.581" class="difflineminus">-    if (document.getElementById(&quot;realname&quot;).value.length &gt; 0 &amp;&amp;</span>
<a href="#l12.582"></a><span id="l12.582" class="difflineminus">-        this.emailAddrValidish())</span>
<a href="#l12.583"></a><span id="l12.583" class="difflineminus">-      document.getElementById(&quot;next_button&quot;).disabled = false;</span>
<a href="#l12.584"></a><span id="l12.584" class="difflineminus">-    else</span>
<a href="#l12.585"></a><span id="l12.585" class="difflineminus">-      document.getElementById(&quot;next_button&quot;).disabled = true;</span>
<a href="#l12.586"></a><span id="l12.586" class="difflineminus">-   },</span>
<a href="#l12.587"></a><span id="l12.587" class="difflineplus">+    return emailRE.test(emailAddr);</span>
<a href="#l12.588"></a><span id="l12.588" class="difflineplus">+  },</span>
<a href="#l12.589"></a><span id="l12.589"> </span>
<a href="#l12.590"></a><span id="l12.590" class="difflineminus">-  onRealnameInput : function()</span>
<a href="#l12.591"></a><span id="l12.591" class="difflineplus">+  /**</span>
<a href="#l12.592"></a><span id="l12.592" class="difflineplus">+   * onInputEmail and onInputRealname are called on input = keypresses, and</span>
<a href="#l12.593"></a><span id="l12.593" class="difflineplus">+   * enable/disable the next button based on whether there's a semi-proper</span>
<a href="#l12.594"></a><span id="l12.594" class="difflineplus">+   * e-mail address and non-blank realname to start with.</span>
<a href="#l12.595"></a><span id="l12.595" class="difflineplus">+   *</span>
<a href="#l12.596"></a><span id="l12.596" class="difflineplus">+   * A change to the email address also automatically restarts the</span>
<a href="#l12.597"></a><span id="l12.597" class="difflineplus">+   * whole process.</span>
<a href="#l12.598"></a><span id="l12.598" class="difflineplus">+   */</span>
<a href="#l12.599"></a><span id="l12.599" class="difflineplus">+  onInputEmail : function()</span>
<a href="#l12.600"></a><span id="l12.600">   {</span>
<a href="#l12.601"></a><span id="l12.601" class="difflineminus">-    if (document.getElementById('realname').value.length &gt; 0 &amp;&amp;</span>
<a href="#l12.602"></a><span id="l12.602" class="difflineminus">-        this.emailAddrValidish())</span>
<a href="#l12.603"></a><span id="l12.603" class="difflineminus">-      document.getElementById(&quot;next_button&quot;).disabled = false;</span>
<a href="#l12.604"></a><span id="l12.604" class="difflineminus">-    else</span>
<a href="#l12.605"></a><span id="l12.605" class="difflineminus">-      document.getElementById(&quot;next_button&quot;).disabled = true;</span>
<a href="#l12.606"></a><span id="l12.606" class="difflineminus">-   },</span>
<a href="#l12.607"></a><span id="l12.607" class="difflineplus">+    this._email = e(&quot;email&quot;).value;</span>
<a href="#l12.608"></a><span id="l12.608" class="difflineplus">+    this.onStartOver();</span>
<a href="#l12.609"></a><span id="l12.609" class="difflineplus">+    this.checkStartDone();</span>
<a href="#l12.610"></a><span id="l12.610" class="difflineplus">+  },</span>
<a href="#l12.611"></a><span id="l12.611" class="difflineplus">+  onInputRealname : function()</span>
<a href="#l12.612"></a><span id="l12.612" class="difflineplus">+  {</span>
<a href="#l12.613"></a><span id="l12.613" class="difflineplus">+    this._realname = e(&quot;realname&quot;).value;</span>
<a href="#l12.614"></a><span id="l12.614" class="difflineplus">+    this.checkStartDone();</span>
<a href="#l12.615"></a><span id="l12.615" class="difflineplus">+  },</span>
<a href="#l12.616"></a><span id="l12.616"> </span>
<a href="#l12.617"></a><span id="l12.617" class="difflineminus">-  /* This check is done on blur and is only done as an informative warning</span>
<a href="#l12.618"></a><span id="l12.618" class="difflineminus">-   * we don't want to block the person if they've entered and email that</span>
<a href="#l12.619"></a><span id="l12.619" class="difflineminus">-   * doesn't conform to our regex</span>
<a href="#l12.620"></a><span id="l12.620" class="difflineplus">+  onInputPassword : function()</span>
<a href="#l12.621"></a><span id="l12.621" class="difflineplus">+  {</span>
<a href="#l12.622"></a><span id="l12.622" class="difflineplus">+    this._password = e(&quot;password&quot;).value;</span>
<a href="#l12.623"></a><span id="l12.623" class="difflineplus">+  },</span>
<a href="#l12.624"></a><span id="l12.624" class="difflineplus">+</span>
<a href="#l12.625"></a><span id="l12.625" class="difflineplus">+  /**</span>
<a href="#l12.626"></a><span id="l12.626" class="difflineplus">+   * This does very little other than to check that a name was entered at all</span>
<a href="#l12.627"></a><span id="l12.627" class="difflineplus">+   * Since this is such an insignificant test we should be using a very light</span>
<a href="#l12.628"></a><span id="l12.628" class="difflineplus">+   * or even jovial warning.</span>
<a href="#l12.629"></a><span id="l12.629">    */</span>
<a href="#l12.630"></a><span id="l12.630" class="difflineminus">-  validateEmail : function()</span>
<a href="#l12.631"></a><span id="l12.631" class="difflineplus">+  onBlurRealname : function()</span>
<a href="#l12.632"></a><span id="l12.632">   {</span>
<a href="#l12.633"></a><span id="l12.633" class="difflineminus">-    let email = document.getElementById(&quot;email&quot;);</span>
<a href="#l12.634"></a><span id="l12.634" class="difflineminus">-    if (email.value.length &lt;= 0)</span>
<a href="#l12.635"></a><span id="l12.635" class="difflineminus">-      return;</span>
<a href="#l12.636"></a><span id="l12.636" class="difflineminus">-</span>
<a href="#l12.637"></a><span id="l12.637" class="difflineminus">-    if (emailRE.test(email.value)) {</span>
<a href="#l12.638"></a><span id="l12.638" class="difflineminus">-      this.clearError(&quot;emailerror&quot;);</span>
<a href="#l12.639"></a><span id="l12.639" class="difflineminus">-      email.removeAttribute(&quot;error&quot;);</span>
<a href="#l12.640"></a><span id="l12.640" class="difflineminus">-    }</span>
<a href="#l12.641"></a><span id="l12.641" class="difflineminus">-    else {</span>
<a href="#l12.642"></a><span id="l12.642" class="difflineminus">-      this.setError(&quot;emailerror&quot;, &quot;double_check_email&quot;);</span>
<a href="#l12.643"></a><span id="l12.643" class="difflineminus">-      email.setAttribute(&quot;error&quot;, &quot;true&quot;);</span>
<a href="#l12.644"></a><span id="l12.644" class="difflineplus">+    let realnameEl = e(&quot;realname&quot;);</span>
<a href="#l12.645"></a><span id="l12.645" class="difflineplus">+    if (this._realname) {</span>
<a href="#l12.646"></a><span id="l12.646" class="difflineplus">+      this.clearError(&quot;nameerror&quot;);</span>
<a href="#l12.647"></a><span id="l12.647" class="difflineplus">+      _show(&quot;nametext&quot;);</span>
<a href="#l12.648"></a><span id="l12.648" class="difflineplus">+      realnameEl.removeAttribute(&quot;error&quot;);</span>
<a href="#l12.649"></a><span id="l12.649" class="difflineplus">+    // bug 638790: don't show realname error until user enter an email address</span>
<a href="#l12.650"></a><span id="l12.650" class="difflineplus">+    } else if (this.validateEmailMinimally(this._email)) {</span>
<a href="#l12.651"></a><span id="l12.651" class="difflineplus">+      _hide(&quot;nametext&quot;);</span>
<a href="#l12.652"></a><span id="l12.652" class="difflineplus">+      this.setError(&quot;nameerror&quot;, &quot;please_enter_name&quot;);</span>
<a href="#l12.653"></a><span id="l12.653" class="difflineplus">+      realnameEl.setAttribute(&quot;error&quot;, &quot;true&quot;);</span>
<a href="#l12.654"></a><span id="l12.654">     }</span>
<a href="#l12.655"></a><span id="l12.655">   },</span>
<a href="#l12.656"></a><span id="l12.656"> </span>
<a href="#l12.657"></a><span id="l12.657" class="difflineminus">-  // We use this to  prevent probing from forgetting the user's choice.</span>
<a href="#l12.658"></a><span id="l12.658" class="difflineminus">-  setSecurity : function(eltId)</span>
<a href="#l12.659"></a><span id="l12.659" class="difflineplus">+  /**</span>
<a href="#l12.660"></a><span id="l12.660" class="difflineplus">+   * This check is only done as an informative warning.</span>
<a href="#l12.661"></a><span id="l12.661" class="difflineplus">+   * We don't want to block the person, if they've entered an email address</span>
<a href="#l12.662"></a><span id="l12.662" class="difflineplus">+   * that doesn't conform to our regex.</span>
<a href="#l12.663"></a><span id="l12.663" class="difflineplus">+   */</span>
<a href="#l12.664"></a><span id="l12.664" class="difflineplus">+  onBlurEmail : function()</span>
<a href="#l12.665"></a><span id="l12.665">   {</span>
<a href="#l12.666"></a><span id="l12.666" class="difflineminus">-    switch (eltId) {</span>
<a href="#l12.667"></a><span id="l12.667" class="difflineminus">-      case 'incoming_security':</span>
<a href="#l12.668"></a><span id="l12.668" class="difflineminus">-        this._userChangedIncomingSocketType = true;</span>
<a href="#l12.669"></a><span id="l12.669" class="difflineminus">-        this._incomingState = &quot;&quot;;</span>
<a href="#l12.670"></a><span id="l12.670" class="difflineminus">-        break;</span>
<a href="#l12.671"></a><span id="l12.671" class="difflineminus">-      case 'outgoing_security':</span>
<a href="#l12.672"></a><span id="l12.672" class="difflineminus">-        this._userChangedOutgoingSocketType = true;</span>
<a href="#l12.673"></a><span id="l12.673" class="difflineminus">-        this._outgoingState = &quot;&quot;;</span>
<a href="#l12.674"></a><span id="l12.674" class="difflineminus">-        break;</span>
<a href="#l12.675"></a><span id="l12.675" class="difflineplus">+    if (!this._email) {</span>
<a href="#l12.676"></a><span id="l12.676" class="difflineplus">+      return;</span>
<a href="#l12.677"></a><span id="l12.677" class="difflineplus">+    }</span>
<a href="#l12.678"></a><span id="l12.678" class="difflineplus">+    var emailEl = e(&quot;email&quot;);</span>
<a href="#l12.679"></a><span id="l12.679" class="difflineplus">+    if (this.validateEmail(this._email)) {</span>
<a href="#l12.680"></a><span id="l12.680" class="difflineplus">+      this.clearError(&quot;emailerror&quot;);</span>
<a href="#l12.681"></a><span id="l12.681" class="difflineplus">+      emailEl.removeAttribute(&quot;error&quot;);</span>
<a href="#l12.682"></a><span id="l12.682" class="difflineplus">+      this.onBlurRealname();</span>
<a href="#l12.683"></a><span id="l12.683" class="difflineplus">+    } else {</span>
<a href="#l12.684"></a><span id="l12.684" class="difflineplus">+      this.setError(&quot;emailerror&quot;, &quot;double_check_email&quot;);</span>
<a href="#l12.685"></a><span id="l12.685" class="difflineplus">+      emailEl.setAttribute(&quot;error&quot;, &quot;true&quot;);</span>
<a href="#l12.686"></a><span id="l12.686">     }</span>
<a href="#l12.687"></a><span id="l12.687">   },</span>
<a href="#l12.688"></a><span id="l12.688"> </span>
<a href="#l12.689"></a><span id="l12.689" class="difflineminus">-  setIncomingServer : function()</span>
<a href="#l12.690"></a><span id="l12.690" class="difflineminus">-  {</span>
<a href="#l12.691"></a><span id="l12.691" class="difflineminus">-    this._userChangedIncomingServer = true;</span>
<a href="#l12.692"></a><span id="l12.692" class="difflineminus">-    this._incomingState = &quot;&quot;;</span>
<a href="#l12.693"></a><span id="l12.693" class="difflineminus">-  },</span>
<a href="#l12.694"></a><span id="l12.694" class="difflineminus">-</span>
<a href="#l12.695"></a><span id="l12.695" class="difflineminus">-  // The IMAP vs. POP dropdown (not radio), settable during manual edit.</span>
<a href="#l12.696"></a><span id="l12.696" class="difflineminus">-  // In the normal result screen, it's not editable and people use the</span>
<a href="#l12.697"></a><span id="l12.697" class="difflineminus">-  // radios instead.</span>
<a href="#l12.698"></a><span id="l12.698" class="difflineminus">-  setIncomingProtocol : function()</span>
<a href="#l12.699"></a><span id="l12.699" class="difflineminus">-  {</span>
<a href="#l12.700"></a><span id="l12.700" class="difflineminus">-    this._userChangedIncomingProtocol = true;</span>
<a href="#l12.701"></a><span id="l12.701" class="difflineminus">-    this._incomingState = &quot;&quot;;</span>
<a href="#l12.702"></a><span id="l12.702" class="difflineminus">-  },</span>
<a href="#l12.703"></a><span id="l12.703" class="difflineminus">-</span>
<a href="#l12.704"></a><span id="l12.704" class="difflineminus">-  // IMAP vs. POP3 radio (not *dropdown*) changed</span>
<a href="#l12.705"></a><span id="l12.705" class="difflineminus">-  setIncomingProtocolRadio : function()</span>
<a href="#l12.706"></a><span id="l12.706" class="difflineminus">-  {</span>
<a href="#l12.707"></a><span id="l12.707" class="difflineminus">-    let newTypeSelected = document.getElementById(&quot;popimap_radiogroup&quot;)</span>
<a href="#l12.708"></a><span id="l12.708" class="difflineminus">-                                  .selectedItem.value;</span>
<a href="#l12.709"></a><span id="l12.709" class="difflineminus">-    var config = this._currentConfig;</span>
<a href="#l12.710"></a><span id="l12.710" class="difflineminus">-    // this is also called when we set the fields programmatically</span>
<a href="#l12.711"></a><span id="l12.711" class="difflineminus">-    if (newTypeSelected == config.incoming.type ||</span>
<a href="#l12.712"></a><span id="l12.712" class="difflineminus">-        !config.incomingAlternatives || !config.incomingAlternatives.length)</span>
<a href="#l12.713"></a><span id="l12.713" class="difflineminus">-      return;</span>
<a href="#l12.714"></a><span id="l12.714" class="difflineminus">-    let alternates = config.incomingAlternatives.filter(function(c) {</span>
<a href="#l12.715"></a><span id="l12.715" class="difflineminus">-      return c.type != config.incoming.type;</span>
<a href="#l12.716"></a><span id="l12.716" class="difflineminus">-    });</span>
<a href="#l12.717"></a><span id="l12.717" class="difflineminus">-    if (alternates.length == 0)</span>
<a href="#l12.718"></a><span id="l12.718" class="difflineminus">-      return;</span>
<a href="#l12.719"></a><span id="l12.719" class="difflineminus">-</span>
<a href="#l12.720"></a><span id="l12.720" class="difflineminus">-    // re-add current incoming server to alternatives</span>
<a href="#l12.721"></a><span id="l12.721" class="difflineminus">-    config.incomingAlternatives.unshift(config.incoming);</span>
<a href="#l12.722"></a><span id="l12.722" class="difflineminus">-    // find alternative config which matches newly selected protocol</span>
<a href="#l12.723"></a><span id="l12.723" class="difflineminus">-    for each (let alt in config.incomingAlternatives) {</span>
<a href="#l12.724"></a><span id="l12.724" class="difflineminus">-      if (alt.type == newTypeSelected) {</span>
<a href="#l12.725"></a><span id="l12.725" class="difflineminus">-        config.incoming = alt;</span>
<a href="#l12.726"></a><span id="l12.726" class="difflineminus">-        break;</span>
<a href="#l12.727"></a><span id="l12.727" class="difflineminus">-      }</span>
<a href="#l12.728"></a><span id="l12.728" class="difflineminus">-    }</span>
<a href="#l12.729"></a><span id="l12.729" class="difflineminus">-    this.foundConfig(config);</span>
<a href="#l12.730"></a><span id="l12.730" class="difflineminus">-  },</span>
<a href="#l12.731"></a><span id="l12.731" class="difflineminus">-</span>
<a href="#l12.732"></a><span id="l12.732" class="difflineminus">-  setPort : function(eltId)</span>
<a href="#l12.733"></a><span id="l12.733" class="difflineminus">-  {</span>
<a href="#l12.734"></a><span id="l12.734" class="difflineminus">-    switch (eltId) {</span>
<a href="#l12.735"></a><span id="l12.735" class="difflineminus">-      case 'incoming_port':</span>
<a href="#l12.736"></a><span id="l12.736" class="difflineminus">-        this._userChangedIncomingPort = true;</span>
<a href="#l12.737"></a><span id="l12.737" class="difflineminus">-        this._incomingState = &quot;&quot;;</span>
<a href="#l12.738"></a><span id="l12.738" class="difflineminus">-        break;</span>
<a href="#l12.739"></a><span id="l12.739" class="difflineminus">-      case 'outgoing_port':</span>
<a href="#l12.740"></a><span id="l12.740" class="difflineminus">-        this._userChangedOutgoingPort = true;</span>
<a href="#l12.741"></a><span id="l12.741" class="difflineminus">-        this._outgoingState = &quot;&quot;;</span>
<a href="#l12.742"></a><span id="l12.742" class="difflineminus">-        break;</span>
<a href="#l12.743"></a><span id="l12.743" class="difflineminus">-    }</span>
<a href="#l12.744"></a><span id="l12.744" class="difflineminus">-  },</span>
<a href="#l12.745"></a><span id="l12.745" class="difflineminus">-</span>
<a href="#l12.746"></a><span id="l12.746" class="difflineminus">-  oninputPassword : function()</span>
<a href="#l12.747"></a><span id="l12.747" class="difflineminus">-  {</span>
<a href="#l12.748"></a><span id="l12.748" class="difflineminus">-    let passwordElt = document.getElementById(&quot;password&quot;);</span>
<a href="#l12.749"></a><span id="l12.749" class="difflineminus">-    let rememberPasswordElt = document.getElementById(&quot;remember_password&quot;);</span>
<a href="#l12.750"></a><span id="l12.750" class="difflineminus">-    let rememberSignons_pref =</span>
<a href="#l12.751"></a><span id="l12.751" class="difflineminus">-        Application.prefs.getValue(&quot;signon.rememberSignons&quot;, true);</span>
<a href="#l12.752"></a><span id="l12.752" class="difflineminus">-</span>
<a href="#l12.753"></a><span id="l12.753" class="difflineminus">-    rememberPasswordElt.disabled = !rememberSignons_pref ||</span>
<a href="#l12.754"></a><span id="l12.754" class="difflineminus">-                                   passwordElt.value.length &lt; 1;</span>
<a href="#l12.755"></a><span id="l12.755" class="difflineminus">-    rememberPasswordElt.checked = rememberSignons_pref &amp;&amp;</span>
<a href="#l12.756"></a><span id="l12.756" class="difflineminus">-                                  !this._userChangedPassword &amp;&amp;</span>
<a href="#l12.757"></a><span id="l12.757" class="difflineminus">-                                  passwordElt.value.length &gt;= 1;</span>
<a href="#l12.758"></a><span id="l12.758" class="difflineminus">-  },</span>
<a href="#l12.759"></a><span id="l12.759" class="difflineminus">-</span>
<a href="#l12.760"></a><span id="l12.760" class="difflineminus">-  /* If the user just tabbed through the password input without entering</span>
<a href="#l12.761"></a><span id="l12.761" class="difflineplus">+  /**</span>
<a href="#l12.762"></a><span id="l12.762" class="difflineplus">+   * If the user just tabbed through the password input without entering</span>
<a href="#l12.763"></a><span id="l12.763">    * anything, set the type back to text so we don't wind up showing the</span>
<a href="#l12.764"></a><span id="l12.764">    * emptytext as bullet characters.</span>
<a href="#l12.765"></a><span id="l12.765">    */</span>
<a href="#l12.766"></a><span id="l12.766" class="difflineminus">-  onblurPassword : function()</span>
<a href="#l12.767"></a><span id="l12.767" class="difflineplus">+  onBlurPassword : function()</span>
<a href="#l12.768"></a><span id="l12.768">   {</span>
<a href="#l12.769"></a><span id="l12.769" class="difflineminus">-    let passwordElt = document.getElementById(&quot;password&quot;);</span>
<a href="#l12.770"></a><span id="l12.770" class="difflineminus">-    let rememberPasswordElt = document.getElementById(&quot;remember_password&quot;);</span>
<a href="#l12.771"></a><span id="l12.771" class="difflineminus">-    let rememberSignons_pref =</span>
<a href="#l12.772"></a><span id="l12.772" class="difflineminus">-        Application.prefs.getValue(&quot;signon.rememberSignons&quot;, true);</span>
<a href="#l12.773"></a><span id="l12.773" class="difflineplus">+    if (!this._password) {</span>
<a href="#l12.774"></a><span id="l12.774" class="difflineplus">+      e(&quot;password&quot;).type = &quot;text&quot;;</span>
<a href="#l12.775"></a><span id="l12.775" class="difflineplus">+    }</span>
<a href="#l12.776"></a><span id="l12.776" class="difflineplus">+  },</span>
<a href="#l12.777"></a><span id="l12.777"> </span>
<a href="#l12.778"></a><span id="l12.778" class="difflineminus">-    if (passwordElt.value.length &lt; 1) {</span>
<a href="#l12.779"></a><span id="l12.779" class="difflineminus">-      rememberPasswordElt.disabled = true;</span>
<a href="#l12.780"></a><span id="l12.780" class="difflineminus">-      passwordElt.type = &quot;text&quot;;</span>
<a href="#l12.781"></a><span id="l12.781" class="difflineminus">-    }</span>
<a href="#l12.782"></a><span id="l12.782" class="difflineminus">-    else if (rememberSignons_pref)</span>
<a href="#l12.783"></a><span id="l12.783" class="difflineminus">-      rememberPasswordElt.disabled = false;</span>
<a href="#l12.784"></a><span id="l12.784" class="difflineplus">+  /**</span>
<a href="#l12.785"></a><span id="l12.785" class="difflineplus">+   * @see onBlurPassword()</span>
<a href="#l12.786"></a><span id="l12.786" class="difflineplus">+   */</span>
<a href="#l12.787"></a><span id="l12.787" class="difflineplus">+  onFocusPassword : function()</span>
<a href="#l12.788"></a><span id="l12.788" class="difflineplus">+  {</span>
<a href="#l12.789"></a><span id="l12.789" class="difflineplus">+    e(&quot;password&quot;).type = &quot;password&quot;;</span>
<a href="#l12.790"></a><span id="l12.790">   },</span>
<a href="#l12.791"></a><span id="l12.791"> </span>
<a href="#l12.792"></a><span id="l12.792" class="difflineplus">+  /**</span>
<a href="#l12.793"></a><span id="l12.793" class="difflineplus">+   * Check whether the user entered the minimum of information</span>
<a href="#l12.794"></a><span id="l12.794" class="difflineplus">+   * needed to leave the &quot;start&quot; mode (entering of name, email, pw)</span>
<a href="#l12.795"></a><span id="l12.795" class="difflineplus">+   * and is allowed to proceed to detection step.</span>
<a href="#l12.796"></a><span id="l12.796" class="difflineplus">+   */</span>
<a href="#l12.797"></a><span id="l12.797" class="difflineplus">+  checkStartDone : function()</span>
<a href="#l12.798"></a><span id="l12.798" class="difflineplus">+  {</span>
<a href="#l12.799"></a><span id="l12.799" class="difflineplus">+    if (this.validateEmailMinimally(this._email) &amp;&amp;</span>
<a href="#l12.800"></a><span id="l12.800" class="difflineplus">+        this._realname) {</span>
<a href="#l12.801"></a><span id="l12.801" class="difflineplus">+      this._domain = this._email.split(&quot;@&quot;)[1].toLowerCase();</span>
<a href="#l12.802"></a><span id="l12.802" class="difflineplus">+      _enable(&quot;next_button&quot;);</span>
<a href="#l12.803"></a><span id="l12.803" class="difflineplus">+    } else {</span>
<a href="#l12.804"></a><span id="l12.804" class="difflineplus">+      _disable(&quot;next_button&quot;);</span>
<a href="#l12.805"></a><span id="l12.805" class="difflineplus">+    }</span>
<a href="#l12.806"></a><span id="l12.806" class="difflineplus">+  },</span>
<a href="#l12.807"></a><span id="l12.807" class="difflineplus">+</span>
<a href="#l12.808"></a><span id="l12.808" class="difflineplus">+  /**</span>
<a href="#l12.809"></a><span id="l12.809" class="difflineplus">+   * When the [Continue] button is clicked, we move from the initial account</span>
<a href="#l12.810"></a><span id="l12.810" class="difflineplus">+   * information stage to using that information to configure account details.</span>
<a href="#l12.811"></a><span id="l12.811" class="difflineplus">+   */</span>
<a href="#l12.812"></a><span id="l12.812" class="difflineplus">+  onNext : function()</span>
<a href="#l12.813"></a><span id="l12.813" class="difflineplus">+  {</span>
<a href="#l12.814"></a><span id="l12.814" class="difflineplus">+    this.findConfig(this._domain, this._email);</span>
<a href="#l12.815"></a><span id="l12.815" class="difflineplus">+  },</span>
<a href="#l12.816"></a><span id="l12.816" class="difflineplus">+</span>
<a href="#l12.817"></a><span id="l12.817" class="difflineplus">+</span>
<a href="#l12.818"></a><span id="l12.818" class="difflineplus">+  /////////////////////////////////////////////////////////////////</span>
<a href="#l12.819"></a><span id="l12.819" class="difflineplus">+  // Detection step</span>
<a href="#l12.820"></a><span id="l12.820" class="difflineplus">+</span>
<a href="#l12.821"></a><span id="l12.821" class="difflineplus">+  /**</span>
<a href="#l12.822"></a><span id="l12.822" class="difflineplus">+   * Try to find an account configuration for this email address.</span>
<a href="#l12.823"></a><span id="l12.823" class="difflineplus">+   * This is the function which runs the autoconfig.</span>
<a href="#l12.824"></a><span id="l12.824" class="difflineplus">+   */</span>
<a href="#l12.825"></a><span id="l12.825">   findConfig : function(domain, email)</span>
<a href="#l12.826"></a><span id="l12.826">   {</span>
<a href="#l12.827"></a><span id="l12.827">     gEmailWizardLogger.info(&quot;findConfig()&quot;);</span>
<a href="#l12.828"></a><span id="l12.828" class="difflineminus">-    if (this._probeAbortable)</span>
<a href="#l12.829"></a><span id="l12.829" class="difflineminus">-    {</span>
<a href="#l12.830"></a><span id="l12.830" class="difflineminus">-      gEmailWizardLogger.info(&quot;aborting existing config search&quot;);</span>
<a href="#l12.831"></a><span id="l12.831" class="difflineminus">-      this._probeAbortable.cancel();</span>
<a href="#l12.832"></a><span id="l12.832" class="difflineplus">+    if (this._abortable) {</span>
<a href="#l12.833"></a><span id="l12.833" class="difflineplus">+      this.onStop();</span>
<a href="#l12.834"></a><span id="l12.834">     }</span>
<a href="#l12.835"></a><span id="l12.835" class="difflineminus">-    this.startSpinner(&quot;all&quot;, &quot;looking_up_settings_disk&quot;);</span>
<a href="#l12.836"></a><span id="l12.836" class="difflineminus">-    var me = this;</span>
<a href="#l12.837"></a><span id="l12.837" class="difflineminus">-    this._probeAbortable = fetchConfigFromDisk(domain,</span>
<a href="#l12.838"></a><span id="l12.838" class="difflineplus">+    this.switchToMode(&quot;find-config&quot;);</span>
<a href="#l12.839"></a><span id="l12.839" class="difflineplus">+    this.startSpinner(&quot;looking_up_settings_disk&quot;);</span>
<a href="#l12.840"></a><span id="l12.840" class="difflineplus">+    var self = this;</span>
<a href="#l12.841"></a><span id="l12.841" class="difflineplus">+    this._abortable = fetchConfigFromDisk(domain,</span>
<a href="#l12.842"></a><span id="l12.842">       function(config) // success</span>
<a href="#l12.843"></a><span id="l12.843">       {</span>
<a href="#l12.844"></a><span id="l12.844" class="difflineminus">-        me.foundConfig(config);</span>
<a href="#l12.845"></a><span id="l12.845" class="difflineminus">-        me.stopSpinner(&quot;found_settings_disk&quot;);</span>
<a href="#l12.846"></a><span id="l12.846" class="difflineminus">-        me._probeAbortable = null;</span>
<a href="#l12.847"></a><span id="l12.847" class="difflineplus">+        self._abortable = null;</span>
<a href="#l12.848"></a><span id="l12.848" class="difflineplus">+        self.foundConfig(config);</span>
<a href="#l12.849"></a><span id="l12.849" class="difflineplus">+        self.stopSpinner(&quot;found_settings_disk&quot;);</span>
<a href="#l12.850"></a><span id="l12.850">       },</span>
<a href="#l12.851"></a><span id="l12.851">       function(e) // fetchConfigFromDisk failed</span>
<a href="#l12.852"></a><span id="l12.852">       {</span>
<a href="#l12.853"></a><span id="l12.853" class="difflineplus">+        if (e instanceof CancelledException) {</span>
<a href="#l12.854"></a><span id="l12.854" class="difflineplus">+          return;</span>
<a href="#l12.855"></a><span id="l12.855" class="difflineplus">+        }</span>
<a href="#l12.856"></a><span id="l12.856">         gEmailWizardLogger.info(&quot;fetchConfigFromDisk failed: &quot; + e);</span>
<a href="#l12.857"></a><span id="l12.857" class="difflineminus">-        me.startSpinner(&quot;all&quot;, &quot;looking_up_settings_isp&quot;);</span>
<a href="#l12.858"></a><span id="l12.858" class="difflineminus">-        me._probeAbortable = fetchConfigFromISP(domain, email,</span>
<a href="#l12.859"></a><span id="l12.859" class="difflineplus">+        self.startSpinner(&quot;looking_up_settings_isp&quot;);</span>
<a href="#l12.860"></a><span id="l12.860" class="difflineplus">+        self._abortable = fetchConfigFromISP(domain, email,</span>
<a href="#l12.861"></a><span id="l12.861">           function(config) // success</span>
<a href="#l12.862"></a><span id="l12.862">           {</span>
<a href="#l12.863"></a><span id="l12.863" class="difflineminus">-            me.foundConfig(config);</span>
<a href="#l12.864"></a><span id="l12.864" class="difflineminus">-            me.stopSpinner(&quot;found_settings_isp&quot;);</span>
<a href="#l12.865"></a><span id="l12.865" class="difflineminus">-            me.showEditButton();</span>
<a href="#l12.866"></a><span id="l12.866" class="difflineminus">-            me._probeAbortable = null;</span>
<a href="#l12.867"></a><span id="l12.867" class="difflineplus">+            self._abortable = null;</span>
<a href="#l12.868"></a><span id="l12.868" class="difflineplus">+            self.foundConfig(config);</span>
<a href="#l12.869"></a><span id="l12.869" class="difflineplus">+            self.stopSpinner(&quot;found_settings_isp&quot;);</span>
<a href="#l12.870"></a><span id="l12.870">           },</span>
<a href="#l12.871"></a><span id="l12.871">           function(e) // fetchConfigFromISP failed</span>
<a href="#l12.872"></a><span id="l12.872">           {</span>
<a href="#l12.873"></a><span id="l12.873" class="difflineplus">+            if (e instanceof CancelledException) {</span>
<a href="#l12.874"></a><span id="l12.874" class="difflineplus">+              return;</span>
<a href="#l12.875"></a><span id="l12.875" class="difflineplus">+            }</span>
<a href="#l12.876"></a><span id="l12.876">             gEmailWizardLogger.info(&quot;fetchConfigFromISP failed: &quot; + e);</span>
<a href="#l12.877"></a><span id="l12.877" class="difflineminus">-            me.startSpinner(&quot;all&quot;, &quot;looking_up_settings_db&quot;);</span>
<a href="#l12.878"></a><span id="l12.878" class="difflineminus">-            me._probeAbortable = fetchConfigFromDB(domain,</span>
<a href="#l12.879"></a><span id="l12.879" class="difflineplus">+            logException(e);</span>
<a href="#l12.880"></a><span id="l12.880" class="difflineplus">+            self.startSpinner(&quot;looking_up_settings_db&quot;);</span>
<a href="#l12.881"></a><span id="l12.881" class="difflineplus">+            self._abortable = fetchConfigFromDB(domain,</span>
<a href="#l12.882"></a><span id="l12.882">               function(config) // success</span>
<a href="#l12.883"></a><span id="l12.883">               {</span>
<a href="#l12.884"></a><span id="l12.884" class="difflineminus">-                me.foundConfig(config);</span>
<a href="#l12.885"></a><span id="l12.885" class="difflineminus">-                me.stopSpinner(&quot;found_settings_db&quot;);</span>
<a href="#l12.886"></a><span id="l12.886" class="difflineminus">-                me.showEditButton();</span>
<a href="#l12.887"></a><span id="l12.887" class="difflineminus">-                me._probeAbortable = null;</span>
<a href="#l12.888"></a><span id="l12.888" class="difflineplus">+                self._abortable = null;</span>
<a href="#l12.889"></a><span id="l12.889" class="difflineplus">+                self.foundConfig(config);</span>
<a href="#l12.890"></a><span id="l12.890" class="difflineplus">+                self.stopSpinner(&quot;found_settings_db&quot;);</span>
<a href="#l12.891"></a><span id="l12.891">               },</span>
<a href="#l12.892"></a><span id="l12.892">               function(e) // fetchConfigFromDB failed</span>
<a href="#l12.893"></a><span id="l12.893">               {</span>
<a href="#l12.894"></a><span id="l12.894" class="difflineplus">+                if (e instanceof CancelledException) {</span>
<a href="#l12.895"></a><span id="l12.895" class="difflineplus">+                  return;</span>
<a href="#l12.896"></a><span id="l12.896" class="difflineplus">+                }</span>
<a href="#l12.897"></a><span id="l12.897" class="difflineplus">+                logException(e);</span>
<a href="#l12.898"></a><span id="l12.898">                 gEmailWizardLogger.info(&quot;fetchConfigFromDB failed: &quot; + e);</span>
<a href="#l12.899"></a><span id="l12.899" class="difflineminus">-                me.startSpinner(&quot;all&quot;, &quot;looking_up_settings_db&quot;);</span>
<a href="#l12.900"></a><span id="l12.900" class="difflineminus">-                me._probeAbortable = fetchConfigForMX(domain,</span>
<a href="#l12.901"></a><span id="l12.901" class="difflineminus">-                  function(config) // success</span>
<a href="#l12.902"></a><span id="l12.902" class="difflineminus">-                  {</span>
<a href="#l12.903"></a><span id="l12.903" class="difflineminus">-                    me.foundConfig(config);</span>
<a href="#l12.904"></a><span id="l12.904" class="difflineminus">-                    me.stopSpinner(&quot;found_settings_db&quot;);</span>
<a href="#l12.905"></a><span id="l12.905" class="difflineminus">-                    me.showEditButton();</span>
<a href="#l12.906"></a><span id="l12.906" class="difflineminus">-                    me._probeAbortable = null;</span>
<a href="#l12.907"></a><span id="l12.907" class="difflineminus">-                  },</span>
<a href="#l12.908"></a><span id="l12.908" class="difflineminus">-                  function(e) // fetchConfigForMX failed</span>
<a href="#l12.909"></a><span id="l12.909" class="difflineminus">-                  {</span>
<a href="#l12.910"></a><span id="l12.910" class="difflineminus">-                    gEmailWizardLogger.info(&quot;fetchConfigForMX failed: &quot; + e);</span>
<a href="#l12.911"></a><span id="l12.911" class="difflineminus">-                    var initialConfig = new AccountConfig();</span>
<a href="#l12.912"></a><span id="l12.912" class="difflineminus">-                    me._prefillConfig(initialConfig);</span>
<a href="#l12.913"></a><span id="l12.913" class="difflineminus">-                    me.startSpinner(&quot;all&quot;, &quot;looking_up_settings_guess&quot;)</span>
<a href="#l12.914"></a><span id="l12.914" class="difflineminus">-                    me._guessConfig(domain, initialConfig, &quot;both&quot;);</span>
<a href="#l12.915"></a><span id="l12.915" class="difflineminus">-                  });</span>
<a href="#l12.916"></a><span id="l12.916" class="difflineplus">+                var initialConfig = new AccountConfig();</span>
<a href="#l12.917"></a><span id="l12.917" class="difflineplus">+                self._prefillConfig(initialConfig);</span>
<a href="#l12.918"></a><span id="l12.918" class="difflineplus">+                self._guessConfig(domain, initialConfig);</span>
<a href="#l12.919"></a><span id="l12.919">               });</span>
<a href="#l12.920"></a><span id="l12.920">           });</span>
<a href="#l12.921"></a><span id="l12.921">       });</span>
<a href="#l12.922"></a><span id="l12.922">   },</span>
<a href="#l12.923"></a><span id="l12.923"> </span>
<a href="#l12.924"></a><span id="l12.924" class="difflineminus">-  _guessConfig : function(domain, initialConfig, which)</span>
<a href="#l12.925"></a><span id="l12.925" class="difflineplus">+  /**</span>
<a href="#l12.926"></a><span id="l12.926" class="difflineplus">+   * Just a continuation of findConfig()</span>
<a href="#l12.927"></a><span id="l12.927" class="difflineplus">+   */</span>
<a href="#l12.928"></a><span id="l12.928" class="difflineplus">+  _guessConfig : function(domain, initialConfig)</span>
<a href="#l12.929"></a><span id="l12.929">   {</span>
<a href="#l12.930"></a><span id="l12.930" class="difflineminus">-    let me = this;</span>
<a href="#l12.931"></a><span id="l12.931" class="difflineminus">-    // guessConfig takes several callback functions, which we define inline.</span>
<a href="#l12.932"></a><span id="l12.932" class="difflineminus">-    me._probeAbortable = guessConfig(domain,</span>
<a href="#l12.933"></a><span id="l12.933" class="difflineminus">-          function(type, hostname, port, ssl, done, config) // progress</span>
<a href="#l12.934"></a><span id="l12.934" class="difflineminus">-          {</span>
<a href="#l12.935"></a><span id="l12.935" class="difflineminus">-            gEmailWizardLogger.info(&quot;progress callback host &quot; + hostname +</span>
<a href="#l12.936"></a><span id="l12.936" class="difflineminus">-                                    &quot; port &quot; +  port + &quot; type &quot; + type);</span>
<a href="#l12.937"></a><span id="l12.937" class="difflineminus">-            if (type == &quot;imap&quot; || type == &quot;pop3&quot;)</span>
<a href="#l12.938"></a><span id="l12.938" class="difflineminus">-            {</span>
<a href="#l12.939"></a><span id="l12.939" class="difflineminus">-              config.incoming.type = type;</span>
<a href="#l12.940"></a><span id="l12.940" class="difflineminus">-              config.incoming.hostname = hostname;</span>
<a href="#l12.941"></a><span id="l12.941" class="difflineminus">-              config.incoming.port = port;</span>
<a href="#l12.942"></a><span id="l12.942" class="difflineminus">-              config.incoming.socketType = ssl;</span>
<a href="#l12.943"></a><span id="l12.943" class="difflineminus">-              config.incoming._inprogress = !done; // XXX not nice to change the AccountConfig object</span>
<a href="#l12.944"></a><span id="l12.944" class="difflineminus">-            }</span>
<a href="#l12.945"></a><span id="l12.945" class="difflineminus">-            else if (type == &quot;smtp&quot; &amp;&amp; !me._userPickedOutgoingServer)</span>
<a href="#l12.946"></a><span id="l12.946" class="difflineminus">-            {</span>
<a href="#l12.947"></a><span id="l12.947" class="difflineminus">-              config.outgoing.hostname = hostname;</span>
<a href="#l12.948"></a><span id="l12.948" class="difflineminus">-              config.outgoing.port = port;</span>
<a href="#l12.949"></a><span id="l12.949" class="difflineminus">-              config.outgoing.socketType = ssl;</span>
<a href="#l12.950"></a><span id="l12.950" class="difflineminus">-              config.outgoing._inprogress = !done;</span>
<a href="#l12.951"></a><span id="l12.951" class="difflineminus">-            }</span>
<a href="#l12.952"></a><span id="l12.952" class="difflineminus">-            me.updateConfig(config);</span>
<a href="#l12.953"></a><span id="l12.953" class="difflineminus">-          },</span>
<a href="#l12.954"></a><span id="l12.954" class="difflineminus">-          function(config) // success</span>
<a href="#l12.955"></a><span id="l12.955" class="difflineminus">-          {</span>
<a href="#l12.956"></a><span id="l12.956" class="difflineminus">-            me.foundConfig(config);</span>
<a href="#l12.957"></a><span id="l12.957" class="difflineminus">-            gEmailWizardLogger.info(&quot;in success, incomingState = &quot; +</span>
<a href="#l12.958"></a><span id="l12.958" class="difflineminus">-                                    me._incomingState + &quot; outgoingState = &quot; +</span>
<a href="#l12.959"></a><span id="l12.959" class="difflineminus">-                                    me._outgoingState);</span>
<a href="#l12.960"></a><span id="l12.960" class="difflineminus">-            if (me._incomingState == 'done' &amp;&amp; me._outgoingState == 'done')</span>
<a href="#l12.961"></a><span id="l12.961" class="difflineminus">-            {</span>
<a href="#l12.962"></a><span id="l12.962" class="difflineminus">-              me.stopSpinner(&quot;found_settings_guess&quot;);</span>
<a href="#l12.963"></a><span id="l12.963" class="difflineminus">-              _hide(&quot;stop_button&quot;);</span>
<a href="#l12.964"></a><span id="l12.964" class="difflineminus">-              _show(&quot;edit_button&quot;);</span>
<a href="#l12.965"></a><span id="l12.965" class="difflineminus">-            }</span>
<a href="#l12.966"></a><span id="l12.966" class="difflineminus">-            else if (me._incomingState == 'done' &amp;&amp; me._outgoingState != 'probing')</span>
<a href="#l12.967"></a><span id="l12.967" class="difflineminus">-            {</span>
<a href="#l12.968"></a><span id="l12.968" class="difflineminus">-              if (me._outgoingState == &quot;failed&quot;)</span>
<a href="#l12.969"></a><span id="l12.969" class="difflineminus">-                me.stopSpinner(&quot;failed_to_find_settings&quot;);</span>
<a href="#l12.970"></a><span id="l12.970" class="difflineminus">-              else</span>
<a href="#l12.971"></a><span id="l12.971" class="difflineminus">-                me.stopSpinner(&quot;found_settings_guess&quot;);</span>
<a href="#l12.972"></a><span id="l12.972" class="difflineminus">-              me.editConfigDetails();</span>
<a href="#l12.973"></a><span id="l12.973" class="difflineminus">-            }</span>
<a href="#l12.974"></a><span id="l12.974" class="difflineminus">-            else if (me._outgoingState == 'done' &amp;&amp; me._incomingState != 'probing')</span>
<a href="#l12.975"></a><span id="l12.975" class="difflineminus">-            {</span>
<a href="#l12.976"></a><span id="l12.976" class="difflineminus">-              if (me._incomingState == &quot;failed&quot;)</span>
<a href="#l12.977"></a><span id="l12.977" class="difflineminus">-                me.stopSpinner(&quot;failed_to_find_settings&quot;);</span>
<a href="#l12.978"></a><span id="l12.978" class="difflineminus">-              else</span>
<a href="#l12.979"></a><span id="l12.979" class="difflineminus">-                me.stopSpinner(&quot;found_settings_guess&quot;);</span>
<a href="#l12.980"></a><span id="l12.980" class="difflineminus">-              me.editConfigDetails();</span>
<a href="#l12.981"></a><span id="l12.981" class="difflineminus">-            }</span>
<a href="#l12.982"></a><span id="l12.982" class="difflineminus">-            if (me._outgoingState != 'probing' &amp;&amp;</span>
<a href="#l12.983"></a><span id="l12.983" class="difflineminus">-                me._incomingState != 'probing')</span>
<a href="#l12.984"></a><span id="l12.984" class="difflineminus">-              me._probeAbortable = null;</span>
<a href="#l12.985"></a><span id="l12.985" class="difflineminus">-</span>
<a href="#l12.986"></a><span id="l12.986" class="difflineminus">-          },</span>
<a href="#l12.987"></a><span id="l12.987" class="difflineminus">-          function(e, config) // guessconfig failed</span>
<a href="#l12.988"></a><span id="l12.988" class="difflineminus">-          {</span>
<a href="#l12.989"></a><span id="l12.989" class="difflineminus">-            gEmailWizardLogger.info(&quot;guessConfig failed: &quot; + e);</span>
<a href="#l12.990"></a><span id="l12.990" class="difflineminus">-            me.updateConfig(config);</span>
<a href="#l12.991"></a><span id="l12.991" class="difflineminus">-            me.stopSpinner(&quot;failed_to_find_settings&quot;);</span>
<a href="#l12.992"></a><span id="l12.992" class="difflineminus">-            me._probeAbortable = null;</span>
<a href="#l12.993"></a><span id="l12.993" class="difflineminus">-            me.editConfigDetails();</span>
<a href="#l12.994"></a><span id="l12.994" class="difflineminus">-          },</span>
<a href="#l12.995"></a><span id="l12.995" class="difflineminus">-          function(e, config) // guessconfig failed for incoming</span>
<a href="#l12.996"></a><span id="l12.996" class="difflineminus">-          {</span>
<a href="#l12.997"></a><span id="l12.997" class="difflineminus">-            gEmailWizardLogger.info(&quot;guessConfig failed for incoming: &quot; + e);</span>
<a href="#l12.998"></a><span id="l12.998" class="difflineminus">-            me._setIconAndTooltip(&quot;incoming&quot;, &quot;failed&quot;, &quot;&quot;);</span>
<a href="#l12.999"></a><span id="l12.999" class="difflineminus">-            me._incomingState = &quot;failed&quot;;</span>
<a href="#l12.1000"></a><span id="l12.1000" class="difflineminus">-            config.incoming.hostname = -1;</span>
<a href="#l12.1001"></a><span id="l12.1001" class="difflineminus">-            me.updateConfig(config);</span>
<a href="#l12.1002"></a><span id="l12.1002" class="difflineminus">-          },</span>
<a href="#l12.1003"></a><span id="l12.1003" class="difflineminus">-          function(e, config) // guessconfig failed for outgoing</span>
<a href="#l12.1004"></a><span id="l12.1004" class="difflineminus">-          {</span>
<a href="#l12.1005"></a><span id="l12.1005" class="difflineminus">-            gEmailWizardLogger.info(&quot;guessConfig failed for outgoing: &quot; + e);</span>
<a href="#l12.1006"></a><span id="l12.1006" class="difflineminus">-            me._setIconAndTooltip(&quot;outgoing&quot;, &quot;failed&quot;, &quot;&quot;);</span>
<a href="#l12.1007"></a><span id="l12.1007" class="difflineminus">-            me._outgoingState = &quot;failed&quot;;</span>
<a href="#l12.1008"></a><span id="l12.1008" class="difflineminus">-            if (!me._userPickedOutgoingServer)</span>
<a href="#l12.1009"></a><span id="l12.1009" class="difflineminus">-              config.outgoing.hostname = -1;</span>
<a href="#l12.1010"></a><span id="l12.1010" class="difflineminus">-</span>
<a href="#l12.1011"></a><span id="l12.1011" class="difflineminus">-            me.updateConfig(config);</span>
<a href="#l12.1012"></a><span id="l12.1012" class="difflineminus">-          },</span>
<a href="#l12.1013"></a><span id="l12.1013" class="difflineminus">-    initialConfig, which);</span>
<a href="#l12.1014"></a><span id="l12.1014" class="difflineplus">+    this.startSpinner(&quot;looking_up_settings_guess&quot;)</span>
<a href="#l12.1015"></a><span id="l12.1015" class="difflineplus">+    var self = this;</span>
<a href="#l12.1016"></a><span id="l12.1016" class="difflineplus">+    self._abortable = guessConfig(domain,</span>
<a href="#l12.1017"></a><span id="l12.1017" class="difflineplus">+      function(type, hostname, port, ssl, done, config) // progress</span>
<a href="#l12.1018"></a><span id="l12.1018" class="difflineplus">+      {</span>
<a href="#l12.1019"></a><span id="l12.1019" class="difflineplus">+        gEmailWizardLogger.info(&quot;progress callback host &quot; + hostname +</span>
<a href="#l12.1020"></a><span id="l12.1020" class="difflineplus">+                                &quot; port &quot; +  port + &quot; type &quot; + type);</span>
<a href="#l12.1021"></a><span id="l12.1021" class="difflineplus">+      },</span>
<a href="#l12.1022"></a><span id="l12.1022" class="difflineplus">+      function(config) // success</span>
<a href="#l12.1023"></a><span id="l12.1023" class="difflineplus">+      {</span>
<a href="#l12.1024"></a><span id="l12.1024" class="difflineplus">+        self._abortable = null;</span>
<a href="#l12.1025"></a><span id="l12.1025" class="difflineplus">+        self.foundConfig(config);</span>
<a href="#l12.1026"></a><span id="l12.1026" class="difflineplus">+        self.stopSpinner(&quot;found_settings_guess&quot;);</span>
<a href="#l12.1027"></a><span id="l12.1027" class="difflineplus">+      },</span>
<a href="#l12.1028"></a><span id="l12.1028" class="difflineplus">+      function(e, config) // guessconfig failed</span>
<a href="#l12.1029"></a><span id="l12.1029" class="difflineplus">+      {</span>
<a href="#l12.1030"></a><span id="l12.1030" class="difflineplus">+        if (e instanceof CancelledException) {</span>
<a href="#l12.1031"></a><span id="l12.1031" class="difflineplus">+          return;</span>
<a href="#l12.1032"></a><span id="l12.1032" class="difflineplus">+        }</span>
<a href="#l12.1033"></a><span id="l12.1033" class="difflineplus">+        self._abortable = null;</span>
<a href="#l12.1034"></a><span id="l12.1034" class="difflineplus">+        gEmailWizardLogger.info(&quot;guessConfig failed: &quot; + e);</span>
<a href="#l12.1035"></a><span id="l12.1035" class="difflineplus">+        self.showErrorStatus(&quot;failed_to_find_settings&quot;);</span>
<a href="#l12.1036"></a><span id="l12.1036" class="difflineplus">+        self.editConfigDetails();</span>
<a href="#l12.1037"></a><span id="l12.1037" class="difflineplus">+      },</span>
<a href="#l12.1038"></a><span id="l12.1038" class="difflineplus">+      initialConfig, &quot;both&quot;);</span>
<a href="#l12.1039"></a><span id="l12.1039">   },</span>
<a href="#l12.1040"></a><span id="l12.1040"> </span>
<a href="#l12.1041"></a><span id="l12.1041" class="difflineplus">+  /**</span>
<a href="#l12.1042"></a><span id="l12.1042" class="difflineplus">+   * When findConfig() was successful, it calls this.</span>
<a href="#l12.1043"></a><span id="l12.1043" class="difflineplus">+   * This displays the config to the user.</span>
<a href="#l12.1044"></a><span id="l12.1044" class="difflineplus">+   */</span>
<a href="#l12.1045"></a><span id="l12.1045">   foundConfig : function(config)</span>
<a href="#l12.1046"></a><span id="l12.1046">   {</span>
<a href="#l12.1047"></a><span id="l12.1047">     gEmailWizardLogger.info(&quot;foundConfig()&quot;);</span>
<a href="#l12.1048"></a><span id="l12.1048" class="difflineminus">-    assert(config instanceof AccountConfig, &quot;BUG: Arg 'config' needs to be an AccountConfig object&quot;);</span>
<a href="#l12.1049"></a><span id="l12.1049" class="difflineplus">+    assert(config instanceof AccountConfig,</span>
<a href="#l12.1050"></a><span id="l12.1050" class="difflineplus">+        &quot;BUG: Arg 'config' needs to be an AccountConfig object&quot;);</span>
<a href="#l12.1051"></a><span id="l12.1051"> </span>
<a href="#l12.1052"></a><span id="l12.1052" class="difflineminus">-    if (!config)</span>
<a href="#l12.1053"></a><span id="l12.1053" class="difflineminus">-      config = new AccountConfig();</span>
<a href="#l12.1054"></a><span id="l12.1054" class="difflineminus">-</span>
<a href="#l12.1055"></a><span id="l12.1055" class="difflineminus">-    this._currentConfig = config;</span>
<a href="#l12.1056"></a><span id="l12.1056">     this._haveValidConfigForDomain = this._email.split(&quot;@&quot;)[1];;</span>
<a href="#l12.1057"></a><span id="l12.1057"> </span>
<a href="#l12.1058"></a><span id="l12.1058" class="difflineminus">-    if (!this._realname || !this._email)</span>
<a href="#l12.1059"></a><span id="l12.1059" class="difflineplus">+    if (!this._realname || !this._email) {</span>
<a href="#l12.1060"></a><span id="l12.1060">       return;</span>
<a href="#l12.1061"></a><span id="l12.1061" class="difflineminus">-</span>
<a href="#l12.1062"></a><span id="l12.1062" class="difflineplus">+    }</span>
<a href="#l12.1063"></a><span id="l12.1063">     return this._foundConfig2(config);</span>
<a href="#l12.1064"></a><span id="l12.1064">   },</span>
<a href="#l12.1065"></a><span id="l12.1065" class="difflineplus">+</span>
<a href="#l12.1066"></a><span id="l12.1066">   // Continuation of foundConfig2() after custom fields.</span>
<a href="#l12.1067"></a><span id="l12.1067">   _foundConfig2 : function(config)</span>
<a href="#l12.1068"></a><span id="l12.1068">   {</span>
<a href="#l12.1069"></a><span id="l12.1069" class="difflineminus">-    this._currentConfigFilledIn = config.copy();</span>
<a href="#l12.1070"></a><span id="l12.1070" class="difflineminus">-    _show(&quot;advanced_settings&quot;);</span>
<a href="#l12.1071"></a><span id="l12.1071" class="difflineminus">-    document.getElementById(&quot;advanced_settings&quot;).disabled = false;</span>
<a href="#l12.1072"></a><span id="l12.1072" class="difflineminus">-    replaceVariables(this._currentConfigFilledIn, this._realname, this._email,</span>
<a href="#l12.1073"></a><span id="l12.1073" class="difflineminus">-                     this._password);</span>
<a href="#l12.1074"></a><span id="l12.1074" class="difflineplus">+    this.displayConfigResult(config);</span>
<a href="#l12.1075"></a><span id="l12.1075" class="difflineplus">+  },</span>
<a href="#l12.1076"></a><span id="l12.1076" class="difflineplus">+</span>
<a href="#l12.1077"></a><span id="l12.1077" class="difflineplus">+  /**</span>
<a href="#l12.1078"></a><span id="l12.1078" class="difflineplus">+   * [Stop] button click handler.</span>
<a href="#l12.1079"></a><span id="l12.1079" class="difflineplus">+   * This allows the user to abort any longer operation, esp. network activity.</span>
<a href="#l12.1080"></a><span id="l12.1080" class="difflineplus">+   * We currently have 3 such cases here:</span>
<a href="#l12.1081"></a><span id="l12.1081" class="difflineplus">+   * 1. findConfig(), i.e. fetch config from DB, guessConfig etc.</span>
<a href="#l12.1082"></a><span id="l12.1082" class="difflineplus">+   * 2. onHalfManualTest(), i.e. the [Retest] button in manual config.</span>
<a href="#l12.1083"></a><span id="l12.1083" class="difflineplus">+   * 3. verifyConfig() - We can't stop this yet, so irrelevant here currently.</span>
<a href="#l12.1084"></a><span id="l12.1084" class="difflineplus">+   * Given that these need slightly different actions, this function will be set</span>
<a href="#l12.1085"></a><span id="l12.1085" class="difflineplus">+   * to a function (i.e. overwritten) by whoever enables the stop button.</span>
<a href="#l12.1086"></a><span id="l12.1086" class="difflineplus">+   *</span>
<a href="#l12.1087"></a><span id="l12.1087" class="difflineplus">+   * We also call this from the code when the user started a different action</span>
<a href="#l12.1088"></a><span id="l12.1088" class="difflineplus">+   * without explicitly clicking [Stop] for the old one first.</span>
<a href="#l12.1089"></a><span id="l12.1089" class="difflineplus">+   */</span>
<a href="#l12.1090"></a><span id="l12.1090" class="difflineplus">+  onStop : function()</span>
<a href="#l12.1091"></a><span id="l12.1091" class="difflineplus">+  {</span>
<a href="#l12.1092"></a><span id="l12.1092" class="difflineplus">+    throw new NotReached(&quot;onStop should be overridden by now&quot;);</span>
<a href="#l12.1093"></a><span id="l12.1093" class="difflineplus">+  },</span>
<a href="#l12.1094"></a><span id="l12.1094" class="difflineplus">+  _onStopCommon : function()</span>
<a href="#l12.1095"></a><span id="l12.1095" class="difflineplus">+  {</span>
<a href="#l12.1096"></a><span id="l12.1096" class="difflineplus">+    if (!this._abortable) {</span>
<a href="#l12.1097"></a><span id="l12.1097" class="difflineplus">+      throw new NotReached(&quot;onStop called although there's nothing to stop&quot;);</span>
<a href="#l12.1098"></a><span id="l12.1098" class="difflineplus">+    }</span>
<a href="#l12.1099"></a><span id="l12.1099" class="difflineplus">+    gEmailWizardLogger.info(&quot;onStop cancelled _abortable&quot;);</span>
<a href="#l12.1100"></a><span id="l12.1100" class="difflineplus">+    this._abortable.cancel(new UserCancelledException());</span>
<a href="#l12.1101"></a><span id="l12.1101" class="difflineplus">+    this._abortable = null;</span>
<a href="#l12.1102"></a><span id="l12.1102" class="difflineplus">+    this.stopSpinner();</span>
<a href="#l12.1103"></a><span id="l12.1103" class="difflineplus">+  },</span>
<a href="#l12.1104"></a><span id="l12.1104" class="difflineplus">+  onStopFindConfig : function()</span>
<a href="#l12.1105"></a><span id="l12.1105" class="difflineplus">+  {</span>
<a href="#l12.1106"></a><span id="l12.1106" class="difflineplus">+    this._onStopCommon();</span>
<a href="#l12.1107"></a><span id="l12.1107" class="difflineplus">+    this.switchToMode(&quot;start&quot;);</span>
<a href="#l12.1108"></a><span id="l12.1108" class="difflineplus">+    this.checkStartDone();</span>
<a href="#l12.1109"></a><span id="l12.1109" class="difflineplus">+  },</span>
<a href="#l12.1110"></a><span id="l12.1110" class="difflineplus">+  onStopHalfManualTesting : function()</span>
<a href="#l12.1111"></a><span id="l12.1111" class="difflineplus">+  {</span>
<a href="#l12.1112"></a><span id="l12.1112" class="difflineplus">+    this._onStopCommon();</span>
<a href="#l12.1113"></a><span id="l12.1113" class="difflineplus">+    this.validateManualEditComplete();</span>
<a href="#l12.1114"></a><span id="l12.1114" class="difflineplus">+  },</span>
<a href="#l12.1115"></a><span id="l12.1115" class="difflineplus">+</span>
<a href="#l12.1116"></a><span id="l12.1116" class="difflineplus">+</span>
<a href="#l12.1117"></a><span id="l12.1117" class="difflineplus">+</span>
<a href="#l12.1118"></a><span id="l12.1118" class="difflineplus">+  ///////////////////////////////////////////////////////////////////</span>
<a href="#l12.1119"></a><span id="l12.1119" class="difflineplus">+  // status area</span>
<a href="#l12.1120"></a><span id="l12.1120" class="difflineplus">+</span>
<a href="#l12.1121"></a><span id="l12.1121" class="difflineplus">+  startSpinner : function(actionStrName)</span>
<a href="#l12.1122"></a><span id="l12.1122" class="difflineplus">+  {</span>
<a href="#l12.1123"></a><span id="l12.1123" class="difflineplus">+    e(&quot;status_area&quot;).setAttribute(&quot;status&quot;, &quot;loading&quot;);</span>
<a href="#l12.1124"></a><span id="l12.1124" class="difflineplus">+    gEmailWizardLogger.warn(&quot;spinner start &quot; + actionStrName);</span>
<a href="#l12.1125"></a><span id="l12.1125" class="difflineplus">+    this._showStatusTitle(actionStrName);</span>
<a href="#l12.1126"></a><span id="l12.1126" class="difflineplus">+  },</span>
<a href="#l12.1127"></a><span id="l12.1127" class="difflineplus">+</span>
<a href="#l12.1128"></a><span id="l12.1128" class="difflineplus">+  stopSpinner : function(actionStrName)</span>
<a href="#l12.1129"></a><span id="l12.1129" class="difflineplus">+  {</span>
<a href="#l12.1130"></a><span id="l12.1130" class="difflineplus">+    e(&quot;status_area&quot;).setAttribute(&quot;status&quot;, &quot;result&quot;);</span>
<a href="#l12.1131"></a><span id="l12.1131" class="difflineplus">+    _hide(&quot;stop_button&quot;);</span>
<a href="#l12.1132"></a><span id="l12.1132" class="difflineplus">+    this._showStatusTitle(actionStrName);</span>
<a href="#l12.1133"></a><span id="l12.1133" class="difflineplus">+    gEmailWizardLogger.warn(&quot;all spinner stop &quot; + actionStrName);</span>
<a href="#l12.1134"></a><span id="l12.1134" class="difflineplus">+  },</span>
<a href="#l12.1135"></a><span id="l12.1135" class="difflineplus">+</span>
<a href="#l12.1136"></a><span id="l12.1136" class="difflineplus">+  showErrorStatus : function(actionStrName)</span>
<a href="#l12.1137"></a><span id="l12.1137" class="difflineplus">+  {</span>
<a href="#l12.1138"></a><span id="l12.1138" class="difflineplus">+    e(&quot;status_area&quot;).setAttribute(&quot;status&quot;, &quot;error&quot;);</span>
<a href="#l12.1139"></a><span id="l12.1139" class="difflineplus">+    gEmailWizardLogger.warn(&quot;status error &quot; + actionStrName);</span>
<a href="#l12.1140"></a><span id="l12.1140" class="difflineplus">+    this._showStatusTitle(actionStrName);</span>
<a href="#l12.1141"></a><span id="l12.1141" class="difflineplus">+  },</span>
<a href="#l12.1142"></a><span id="l12.1142" class="difflineplus">+</span>
<a href="#l12.1143"></a><span id="l12.1143" class="difflineplus">+  _showStatusTitle : function(msgName)</span>
<a href="#l12.1144"></a><span id="l12.1144" class="difflineplus">+  {</span>
<a href="#l12.1145"></a><span id="l12.1145" class="difflineplus">+    let msg = &quot; &quot;; // assure height. Do via min-height in CSS, for 2 lines?</span>
<a href="#l12.1146"></a><span id="l12.1146" class="difflineplus">+    try {</span>
<a href="#l12.1147"></a><span id="l12.1147" class="difflineplus">+      if (msgName) {</span>
<a href="#l12.1148"></a><span id="l12.1148" class="difflineplus">+        msg = gStringsBundle.getFormattedString(msgName, [gBrandShortName]);</span>
<a href="#l12.1149"></a><span id="l12.1149" class="difflineplus">+      }</span>
<a href="#l12.1150"></a><span id="l12.1150" class="difflineplus">+    } catch(ex) {</span>
<a href="#l12.1151"></a><span id="l12.1151" class="difflineplus">+      gEmailWizardLogger.error(&quot;missing string for &quot; + msgName);</span>
<a href="#l12.1152"></a><span id="l12.1152" class="difflineplus">+      msg = msgName + &quot; (missing string in translation!)&quot;;</span>
<a href="#l12.1153"></a><span id="l12.1153" class="difflineplus">+    }</span>
<a href="#l12.1154"></a><span id="l12.1154" class="difflineplus">+</span>
<a href="#l12.1155"></a><span id="l12.1155" class="difflineplus">+    e(&quot;status_msg&quot;).textContent = msg;</span>
<a href="#l12.1156"></a><span id="l12.1156" class="difflineplus">+    gEmailWizardLogger.info(&quot;status msg: &quot; + msg);</span>
<a href="#l12.1157"></a><span id="l12.1157" class="difflineplus">+  },</span>
<a href="#l12.1158"></a><span id="l12.1158" class="difflineplus">+</span>
<a href="#l12.1159"></a><span id="l12.1159" class="difflineplus">+</span>
<a href="#l12.1160"></a><span id="l12.1160" class="difflineplus">+</span>
<a href="#l12.1161"></a><span id="l12.1161" class="difflineplus">+  /////////////////////////////////////////////////////////////////</span>
<a href="#l12.1162"></a><span id="l12.1162" class="difflineplus">+  // Result area</span>
<a href="#l12.1163"></a><span id="l12.1163" class="difflineplus">+</span>
<a href="#l12.1164"></a><span id="l12.1164" class="difflineplus">+  /**</span>
<a href="#l12.1165"></a><span id="l12.1165" class="difflineplus">+   * Displays a (probed) config to the user,</span>
<a href="#l12.1166"></a><span id="l12.1166" class="difflineplus">+   * in the result config details area.</span>
<a href="#l12.1167"></a><span id="l12.1167" class="difflineplus">+   *</span>
<a href="#l12.1168"></a><span id="l12.1168" class="difflineplus">+   * @param config {AccountConfig} The config to present to user</span>
<a href="#l12.1169"></a><span id="l12.1169" class="difflineplus">+   */</span>
<a href="#l12.1170"></a><span id="l12.1170" class="difflineplus">+  displayConfigResult : function(config)</span>
<a href="#l12.1171"></a><span id="l12.1171" class="difflineplus">+  {</span>
<a href="#l12.1172"></a><span id="l12.1172" class="difflineplus">+    assert(config instanceof AccountConfig);</span>
<a href="#l12.1173"></a><span id="l12.1173" class="difflineplus">+    this._currentConfig = config;</span>
<a href="#l12.1174"></a><span id="l12.1174" class="difflineplus">+    var configFilledIn = this.getConcreteConfig();</span>
<a href="#l12.1175"></a><span id="l12.1175" class="difflineplus">+</span>
<a href="#l12.1176"></a><span id="l12.1176" class="difflineplus">+    var unknownString = gStringsBundle.getString(&quot;resultUnknown&quot;);</span>
<a href="#l12.1177"></a><span id="l12.1177" class="difflineplus">+</span>
<a href="#l12.1178"></a><span id="l12.1178" class="difflineplus">+    function _makeHostDisplayString(server, stringName)</span>
<a href="#l12.1179"></a><span id="l12.1179" class="difflineplus">+    {</span>
<a href="#l12.1180"></a><span id="l12.1180" class="difflineplus">+      let type = gStringsBundle.getString(sanitize.translate(server.type,</span>
<a href="#l12.1181"></a><span id="l12.1181" class="difflineplus">+          { imap : &quot;resultIMAP&quot;, pop3 : &quot;resultPOP3&quot;, smtp : &quot;resultSMTP&quot; }),</span>
<a href="#l12.1182"></a><span id="l12.1182" class="difflineplus">+          unknownString);</span>
<a href="#l12.1183"></a><span id="l12.1183" class="difflineplus">+      let host = server.hostname +</span>
<a href="#l12.1184"></a><span id="l12.1184" class="difflineplus">+          (isStandardPort(server.port) ? &quot;&quot; : &quot;:&quot; + server.port);</span>
<a href="#l12.1185"></a><span id="l12.1185" class="difflineplus">+      let ssl = gStringsBundle.getString(sanitize.translate(server.socketType,</span>
<a href="#l12.1186"></a><span id="l12.1186" class="difflineplus">+          { 1 : &quot;resultNoEncryption&quot;, 2 : &quot;resultSSL&quot;, 3 : &quot;resultSTARTTLS&quot; }),</span>
<a href="#l12.1187"></a><span id="l12.1187" class="difflineplus">+          unknownString);</span>
<a href="#l12.1188"></a><span id="l12.1188" class="difflineplus">+      let certStatus = gStringsBundle.getString(server.badCert ?</span>
<a href="#l12.1189"></a><span id="l12.1189" class="difflineplus">+          &quot;resultSSLCertWeak&quot; : &quot;resultSSLCertOK&quot;);</span>
<a href="#l12.1190"></a><span id="l12.1190" class="difflineplus">+      return gStringsBundle.getFormattedString(stringName,</span>
<a href="#l12.1191"></a><span id="l12.1191" class="difflineplus">+          [ type, host, ssl, certStatus ]);</span>
<a href="#l12.1192"></a><span id="l12.1192" class="difflineplus">+    };</span>
<a href="#l12.1193"></a><span id="l12.1193" class="difflineplus">+</span>
<a href="#l12.1194"></a><span id="l12.1194" class="difflineplus">+    var incomingResult = unknownString;</span>
<a href="#l12.1195"></a><span id="l12.1195" class="difflineplus">+    if (configFilledIn.incoming.hostname) {</span>
<a href="#l12.1196"></a><span id="l12.1196" class="difflineplus">+      incomingResult = _makeHostDisplayString(configFilledIn.incoming,</span>
<a href="#l12.1197"></a><span id="l12.1197" class="difflineplus">+          &quot;resultIncoming&quot;);</span>
<a href="#l12.1198"></a><span id="l12.1198" class="difflineplus">+    }</span>
<a href="#l12.1199"></a><span id="l12.1199" class="difflineplus">+</span>
<a href="#l12.1200"></a><span id="l12.1200" class="difflineplus">+    var outgoingResult = unknownString;</span>
<a href="#l12.1201"></a><span id="l12.1201" class="difflineplus">+    if (!config.outgoing.existingServerKey) {</span>
<a href="#l12.1202"></a><span id="l12.1202" class="difflineplus">+      if (configFilledIn.outgoing.hostname) {</span>
<a href="#l12.1203"></a><span id="l12.1203" class="difflineplus">+        outgoingResult = _makeHostDisplayString(configFilledIn.outgoing,</span>
<a href="#l12.1204"></a><span id="l12.1204" class="difflineplus">+            &quot;resultOutgoing&quot;);</span>
<a href="#l12.1205"></a><span id="l12.1205" class="difflineplus">+      }</span>
<a href="#l12.1206"></a><span id="l12.1206" class="difflineplus">+    } else {</span>
<a href="#l12.1207"></a><span id="l12.1207" class="difflineplus">+      outgoingResult = gStringsBundle.getString(&quot;resultOutgoingExisting&quot;);</span>
<a href="#l12.1208"></a><span id="l12.1208" class="difflineplus">+    }</span>
<a href="#l12.1209"></a><span id="l12.1209" class="difflineplus">+</span>
<a href="#l12.1210"></a><span id="l12.1210" class="difflineplus">+    var usernameResult;</span>
<a href="#l12.1211"></a><span id="l12.1211" class="difflineplus">+    if (configFilledIn.incoming.username == configFilledIn.outgoing.username) {</span>
<a href="#l12.1212"></a><span id="l12.1212" class="difflineplus">+      usernameResult = gStringsBundle.getFormattedString(&quot;resultUsernameBoth&quot;,</span>
<a href="#l12.1213"></a><span id="l12.1213" class="difflineplus">+            [ configFilledIn.incoming.username || unknownString ]);</span>
<a href="#l12.1214"></a><span id="l12.1214" class="difflineplus">+    } else {</span>
<a href="#l12.1215"></a><span id="l12.1215" class="difflineplus">+      usernameResult = gStringsBundle.getFormattedString(</span>
<a href="#l12.1216"></a><span id="l12.1216" class="difflineplus">+            &quot;resultUsernameDifferent&quot;,</span>
<a href="#l12.1217"></a><span id="l12.1217" class="difflineplus">+            [ configFilledIn.incoming.username || unknownString,</span>
<a href="#l12.1218"></a><span id="l12.1218" class="difflineplus">+              configFilledIn.outgoing.username || unknownString ]);</span>
<a href="#l12.1219"></a><span id="l12.1219" class="difflineplus">+    }</span>
<a href="#l12.1220"></a><span id="l12.1220" class="difflineplus">+</span>
<a href="#l12.1221"></a><span id="l12.1221" class="difflineplus">+    setText(&quot;result-incoming&quot;, incomingResult);</span>
<a href="#l12.1222"></a><span id="l12.1222" class="difflineplus">+    setText(&quot;result-outgoing&quot;, outgoingResult);</span>
<a href="#l12.1223"></a><span id="l12.1223" class="difflineplus">+    setText(&quot;result-username&quot;, usernameResult);</span>
<a href="#l12.1224"></a><span id="l12.1224" class="difflineplus">+</span>
<a href="#l12.1225"></a><span id="l12.1225" class="difflineplus">+    gEmailWizardLogger.info(debugObject(config, &quot;config&quot;));</span>
<a href="#l12.1226"></a><span id="l12.1226" class="difflineplus">+    // IMAP / POP dropdown</span>
<a href="#l12.1227"></a><span id="l12.1227" class="difflineplus">+    var lookForAltType =</span>
<a href="#l12.1228"></a><span id="l12.1228" class="difflineplus">+        configFilledIn.incoming.type == &quot;imap&quot; ? &quot;pop3&quot; : &quot;imap&quot;;</span>
<a href="#l12.1229"></a><span id="l12.1229" class="difflineplus">+    var alternative = null;</span>
<a href="#l12.1230"></a><span id="l12.1230" class="difflineplus">+    for (let i = 0; i &lt; configFilledIn.incomingAlternatives.length; i++) {</span>
<a href="#l12.1231"></a><span id="l12.1231" class="difflineplus">+      let alt = configFilledIn.incomingAlternatives[i];</span>
<a href="#l12.1232"></a><span id="l12.1232" class="difflineplus">+      if (alt.type == lookForAltType) {</span>
<a href="#l12.1233"></a><span id="l12.1233" class="difflineplus">+        alternative = alt;</span>
<a href="#l12.1234"></a><span id="l12.1234" class="difflineplus">+        break;</span>
<a href="#l12.1235"></a><span id="l12.1235" class="difflineplus">+      }</span>
<a href="#l12.1236"></a><span id="l12.1236" class="difflineplus">+    }</span>
<a href="#l12.1237"></a><span id="l12.1237" class="difflineplus">+    if (alternative) {</span>
<a href="#l12.1238"></a><span id="l12.1238" class="difflineplus">+      _show(&quot;result_imappop&quot;);</span>
<a href="#l12.1239"></a><span id="l12.1239" class="difflineplus">+      // TODO breaks, no idea why</span>
<a href="#l12.1240"></a><span id="l12.1240" class="difflineplus">+      //e(&quot;result_imappop&quot;).value =</span>
<a href="#l12.1241"></a><span id="l12.1241" class="difflineplus">+      //    configFilledIn.incoming.type == &quot;imap&quot; ? 1 : 2;</span>
<a href="#l12.1242"></a><span id="l12.1242" class="difflineplus">+      e(&quot;result_select_&quot; + alternative.type).configIncoming = alternative;</span>
<a href="#l12.1243"></a><span id="l12.1243" class="difflineplus">+      e(&quot;result_select_&quot; + configFilledIn.incoming.type).configIncoming =</span>
<a href="#l12.1244"></a><span id="l12.1244" class="difflineplus">+                                                configFilledIn.incoming;</span>
<a href="#l12.1245"></a><span id="l12.1245" class="difflineplus">+    } else {</span>
<a href="#l12.1246"></a><span id="l12.1246" class="difflineplus">+      _hide(&quot;result_imappop&quot;);</span>
<a href="#l12.1247"></a><span id="l12.1247" class="difflineplus">+    }</span>
<a href="#l12.1248"></a><span id="l12.1248" class="difflineplus">+</span>
<a href="#l12.1249"></a><span id="l12.1249" class="difflineplus">+    this.switchToMode(&quot;result&quot;);</span>
<a href="#l12.1250"></a><span id="l12.1250" class="difflineplus">+  },</span>
<a href="#l12.1251"></a><span id="l12.1251"> </span>
<a href="#l12.1252"></a><span id="l12.1252" class="difflineminus">-    this.updateConfig(this._currentConfigFilledIn);</span>
<a href="#l12.1253"></a><span id="l12.1253" class="difflineplus">+  onResultIMAPOrPOP3 : function()</span>
<a href="#l12.1254"></a><span id="l12.1254" class="difflineplus">+  {</span>
<a href="#l12.1255"></a><span id="l12.1255" class="difflineplus">+    var config = this._currentConfig;</span>
<a href="#l12.1256"></a><span id="l12.1256" class="difflineplus">+    if (!config) { // &lt;radiogroup&gt;.onselect is also called on window open</span>
<a href="#l12.1257"></a><span id="l12.1257" class="difflineplus">+      return;</span>
<a href="#l12.1258"></a><span id="l12.1258" class="difflineplus">+    }</span>
<a href="#l12.1259"></a><span id="l12.1259" class="difflineplus">+    var radiogroup = e(&quot;result_imappop&quot;);</span>
<a href="#l12.1260"></a><span id="l12.1260" class="difflineplus">+    // add current server as best alternative to start of array</span>
<a href="#l12.1261"></a><span id="l12.1261" class="difflineplus">+    config.incomingAlternatives.unshift(config.incoming);</span>
<a href="#l12.1262"></a><span id="l12.1262" class="difflineplus">+    // use selected server (stored as special property on the &lt;radio&gt; node)</span>
<a href="#l12.1263"></a><span id="l12.1263" class="difflineplus">+    config.incoming = radiogroup.selectedItem.configIncoming;</span>
<a href="#l12.1264"></a><span id="l12.1264" class="difflineplus">+    // remove newly selected server from list of alternatives</span>
<a href="#l12.1265"></a><span id="l12.1265" class="difflineplus">+    config.incomingAlternatives = config.incomingAlternatives.filter(</span>
<a href="#l12.1266"></a><span id="l12.1266" class="difflineplus">+        function(e) { return e != config.incoming; }); // TODO doesn't work</span>
<a href="#l12.1267"></a><span id="l12.1267" class="difflineplus">+    this.displayConfigResult(config);</span>
<a href="#l12.1268"></a><span id="l12.1268" class="difflineplus">+  },</span>
<a href="#l12.1269"></a><span id="l12.1269" class="difflineplus">+</span>
<a href="#l12.1270"></a><span id="l12.1270" class="difflineplus">+</span>
<a href="#l12.1271"></a><span id="l12.1271" class="difflineplus">+</span>
<a href="#l12.1272"></a><span id="l12.1272" class="difflineplus">+  /////////////////////////////////////////////////////////////////</span>
<a href="#l12.1273"></a><span id="l12.1273" class="difflineplus">+  // Manual Edit area</span>
<a href="#l12.1274"></a><span id="l12.1274" class="difflineplus">+</span>
<a href="#l12.1275"></a><span id="l12.1275" class="difflineplus">+  /**</span>
<a href="#l12.1276"></a><span id="l12.1276" class="difflineplus">+   * Gets the values from the user in the manual edit area.</span>
<a href="#l12.1277"></a><span id="l12.1277" class="difflineplus">+   *</span>
<a href="#l12.1278"></a><span id="l12.1278" class="difflineplus">+   * Realname and password are not part of that area and still</span>
<a href="#l12.1279"></a><span id="l12.1279" class="difflineplus">+   * placeholders, but hostname and username are concrete and</span>
<a href="#l12.1280"></a><span id="l12.1280" class="difflineplus">+   * no placeholders anymore.</span>
<a href="#l12.1281"></a><span id="l12.1281" class="difflineplus">+   */</span>
<a href="#l12.1282"></a><span id="l12.1282" class="difflineplus">+  getUserConfig : function()</span>
<a href="#l12.1283"></a><span id="l12.1283" class="difflineplus">+  {</span>
<a href="#l12.1284"></a><span id="l12.1284" class="difflineplus">+    var config = this.getConcreteConfig();</span>
<a href="#l12.1285"></a><span id="l12.1285" class="difflineplus">+    if (!config) {</span>
<a href="#l12.1286"></a><span id="l12.1286" class="difflineplus">+      config = new AccountConfig();</span>
<a href="#l12.1287"></a><span id="l12.1287" class="difflineplus">+    }</span>
<a href="#l12.1288"></a><span id="l12.1288" class="difflineplus">+    config.source = AccountConfig.kSourceUser;</span>
<a href="#l12.1289"></a><span id="l12.1289" class="difflineplus">+</span>
<a href="#l12.1290"></a><span id="l12.1290" class="difflineplus">+    // Incoming server</span>
<a href="#l12.1291"></a><span id="l12.1291" class="difflineplus">+    try {</span>
<a href="#l12.1292"></a><span id="l12.1292" class="difflineplus">+      var inHostnameField = e(&quot;incoming_hostname&quot;);</span>
<a href="#l12.1293"></a><span id="l12.1293" class="difflineplus">+      config.incoming.hostname = sanitize.hostname(inHostnameField.value);</span>
<a href="#l12.1294"></a><span id="l12.1294" class="difflineplus">+      inHostnameField.value = config.incoming.hostname;</span>
<a href="#l12.1295"></a><span id="l12.1295" class="difflineplus">+    } catch (e) { gEmailWizardLogger.warn(e); }</span>
<a href="#l12.1296"></a><span id="l12.1296" class="difflineplus">+    try {</span>
<a href="#l12.1297"></a><span id="l12.1297" class="difflineplus">+      config.incoming.port = sanitize.integerRange(e(&quot;incoming_port&quot;).value,</span>
<a href="#l12.1298"></a><span id="l12.1298" class="difflineplus">+                                                   1, kHighestPort);</span>
<a href="#l12.1299"></a><span id="l12.1299" class="difflineplus">+    } catch (e) {</span>
<a href="#l12.1300"></a><span id="l12.1300" class="difflineplus">+      config.incoming.port = undefined; // incl. default &quot;Auto&quot;</span>
<a href="#l12.1301"></a><span id="l12.1301" class="difflineplus">+    }</span>
<a href="#l12.1302"></a><span id="l12.1302" class="difflineplus">+    config.incoming.type = sanitize.translate(e(&quot;incoming_protocol&quot;).value,</span>
<a href="#l12.1303"></a><span id="l12.1303" class="difflineplus">+        { 1: &quot;imap&quot;, 2 : &quot;pop3&quot;, 0 : null });</span>
<a href="#l12.1304"></a><span id="l12.1304" class="difflineplus">+    config.incoming.socketType = parseInt(e(&quot;incoming_ssl&quot;).value);</span>
<a href="#l12.1305"></a><span id="l12.1305" class="difflineplus">+    config.incoming.auth = parseInt(e(&quot;incoming_authMethod&quot;).value);</span>
<a href="#l12.1306"></a><span id="l12.1306" class="difflineplus">+    config.incoming.username = e(&quot;incoming_username&quot;).value;</span>
<a href="#l12.1307"></a><span id="l12.1307" class="difflineplus">+</span>
<a href="#l12.1308"></a><span id="l12.1308" class="difflineplus">+    // Outgoing server</span>
<a href="#l12.1309"></a><span id="l12.1309" class="difflineplus">+</span>
<a href="#l12.1310"></a><span id="l12.1310" class="difflineplus">+    // Did the user select one of the already configured SMTP servers from the</span>
<a href="#l12.1311"></a><span id="l12.1311" class="difflineplus">+    // drop-down list? If so, use it.</span>
<a href="#l12.1312"></a><span id="l12.1312" class="difflineplus">+    var outHostnameCombo = e(&quot;outgoing_hostname&quot;);</span>
<a href="#l12.1313"></a><span id="l12.1313" class="difflineplus">+    var outMenuitem = outHostnameCombo.selectedItem;</span>
<a href="#l12.1314"></a><span id="l12.1314" class="difflineplus">+    if (outMenuitem &amp;&amp; outMenuitem.serverKey) {</span>
<a href="#l12.1315"></a><span id="l12.1315" class="difflineplus">+      config.outgoing.existingServerKey = outMenuitem.serverKey;</span>
<a href="#l12.1316"></a><span id="l12.1316" class="difflineplus">+      config.outgoing.existingServerLabel = outMenuitem.label;</span>
<a href="#l12.1317"></a><span id="l12.1317" class="difflineplus">+      config.outgoing.addThisServer = false;</span>
<a href="#l12.1318"></a><span id="l12.1318" class="difflineplus">+      config.outgoing.useGlobalPreferredServer = false;</span>
<a href="#l12.1319"></a><span id="l12.1319" class="difflineplus">+    } else {</span>
<a href="#l12.1320"></a><span id="l12.1320" class="difflineplus">+      config.outgoing.existingServerKey = null;</span>
<a href="#l12.1321"></a><span id="l12.1321" class="difflineplus">+      config.outgoing.addThisServer = true;</span>
<a href="#l12.1322"></a><span id="l12.1322" class="difflineplus">+      config.outgoing.useGlobalPreferredServer = false;</span>
<a href="#l12.1323"></a><span id="l12.1323" class="difflineplus">+</span>
<a href="#l12.1324"></a><span id="l12.1324" class="difflineplus">+      try {</span>
<a href="#l12.1325"></a><span id="l12.1325" class="difflineplus">+        config.outgoing.hostname = sanitize.hostname(</span>
<a href="#l12.1326"></a><span id="l12.1326" class="difflineplus">+              outHostnameCombo.inputField.value);</span>
<a href="#l12.1327"></a><span id="l12.1327" class="difflineplus">+        outHostnameCombo.inputField.value = config.outgoing.hostname;</span>
<a href="#l12.1328"></a><span id="l12.1328" class="difflineplus">+      } catch (e) { gEmailWizardLogger.warn(e); }</span>
<a href="#l12.1329"></a><span id="l12.1329" class="difflineplus">+      try {</span>
<a href="#l12.1330"></a><span id="l12.1330" class="difflineplus">+        config.outgoing.port = sanitize.integerRange(e(&quot;outgoing_port&quot;).value,</span>
<a href="#l12.1331"></a><span id="l12.1331" class="difflineplus">+              1, kHighestPort);</span>
<a href="#l12.1332"></a><span id="l12.1332" class="difflineplus">+      } catch (e) {</span>
<a href="#l12.1333"></a><span id="l12.1333" class="difflineplus">+        config.outgoing.port = undefined; // incl. default &quot;Auto&quot;</span>
<a href="#l12.1334"></a><span id="l12.1334" class="difflineplus">+      }</span>
<a href="#l12.1335"></a><span id="l12.1335" class="difflineplus">+      config.outgoing.socketType = e(&quot;outgoing_ssl&quot;).value;</span>
<a href="#l12.1336"></a><span id="l12.1336" class="difflineplus">+      config.outgoing.auth = e(&quot;outgoing_authMethod&quot;).value;</span>
<a href="#l12.1337"></a><span id="l12.1337" class="difflineplus">+      config.outgoing.username = config.incoming.username;</span>
<a href="#l12.1338"></a><span id="l12.1338" class="difflineplus">+    }</span>
<a href="#l12.1339"></a><span id="l12.1339" class="difflineplus">+</span>
<a href="#l12.1340"></a><span id="l12.1340" class="difflineplus">+    return config;</span>
<a href="#l12.1341"></a><span id="l12.1341" class="difflineplus">+  },</span>
<a href="#l12.1342"></a><span id="l12.1342"> </span>
<a href="#l12.1343"></a><span id="l12.1343" class="difflineminus">-    document.getElementById('create_button').disabled = false;</span>
<a href="#l12.1344"></a><span id="l12.1344" class="difflineminus">-    document.getElementById('create_button').hidden = false;</span>
<a href="#l12.1345"></a><span id="l12.1345" class="difflineplus">+  /**</span>
<a href="#l12.1346"></a><span id="l12.1346" class="difflineplus">+   * [Manual Config] button click handler. This turns the config details area</span>
<a href="#l12.1347"></a><span id="l12.1347" class="difflineplus">+   * into an editable form and makes the (Go) button appear. The edit button</span>
<a href="#l12.1348"></a><span id="l12.1348" class="difflineplus">+   * should only be available after the config probing is completely finished,</span>
<a href="#l12.1349"></a><span id="l12.1349" class="difflineplus">+   * replacing what was the (Stop) button.</span>
<a href="#l12.1350"></a><span id="l12.1350" class="difflineplus">+   */</span>
<a href="#l12.1351"></a><span id="l12.1351" class="difflineplus">+  onManualEdit : function()</span>
<a href="#l12.1352"></a><span id="l12.1352" class="difflineplus">+  {</span>
<a href="#l12.1353"></a><span id="l12.1353" class="difflineplus">+    if (this._abortable) {</span>
<a href="#l12.1354"></a><span id="l12.1354" class="difflineplus">+      this.onStop();</span>
<a href="#l12.1355"></a><span id="l12.1355" class="difflineplus">+    }</span>
<a href="#l12.1356"></a><span id="l12.1356" class="difflineplus">+    this.editConfigDetails();</span>
<a href="#l12.1357"></a><span id="l12.1357" class="difflineplus">+  },</span>
<a href="#l12.1358"></a><span id="l12.1358" class="difflineplus">+</span>
<a href="#l12.1359"></a><span id="l12.1359" class="difflineplus">+  /**</span>
<a href="#l12.1360"></a><span id="l12.1360" class="difflineplus">+   * Setting the config details form so it can be edited. We also disable</span>
<a href="#l12.1361"></a><span id="l12.1361" class="difflineplus">+   * (and hide) the create button during this time because we don't know what</span>
<a href="#l12.1362"></a><span id="l12.1362" class="difflineplus">+   * might have changed. The function called from the button that restarts</span>
<a href="#l12.1363"></a><span id="l12.1363" class="difflineplus">+   * the config check should be enabling the config button as needed.</span>
<a href="#l12.1364"></a><span id="l12.1364" class="difflineplus">+   */</span>
<a href="#l12.1365"></a><span id="l12.1365" class="difflineplus">+  editConfigDetails : function()</span>
<a href="#l12.1366"></a><span id="l12.1366" class="difflineplus">+  {</span>
<a href="#l12.1367"></a><span id="l12.1367" class="difflineplus">+    gEmailWizardLogger.info(&quot;manual edit&quot;);</span>
<a href="#l12.1368"></a><span id="l12.1368" class="difflineplus">+</span>
<a href="#l12.1369"></a><span id="l12.1369" class="difflineplus">+    if (!this._currentConfig) {</span>
<a href="#l12.1370"></a><span id="l12.1370" class="difflineplus">+      this._currentConfig = new AccountConfig();</span>
<a href="#l12.1371"></a><span id="l12.1371" class="difflineplus">+      this._currentConfig.incoming.type = &quot;imap&quot;;</span>
<a href="#l12.1372"></a><span id="l12.1372" class="difflineplus">+      this._currentConfig.incoming.username = &quot;%EMAILLOCALPART%&quot;;</span>
<a href="#l12.1373"></a><span id="l12.1373" class="difflineplus">+      this._currentConfig.outgoing.username = &quot;%EMAILLOCALPART%&quot;;</span>
<a href="#l12.1374"></a><span id="l12.1374" class="difflineplus">+      this._currentConfig.incoming.hostname = &quot;.%EMAILDOMAIN%&quot;;</span>
<a href="#l12.1375"></a><span id="l12.1375" class="difflineplus">+      this._currentConfig.outgoing.hostname = &quot;.%EMAILDOMAIN%&quot;;</span>
<a href="#l12.1376"></a><span id="l12.1376" class="difflineplus">+    }</span>
<a href="#l12.1377"></a><span id="l12.1377" class="difflineplus">+    // Although we go manual, and we need to display the concrete username,</span>
<a href="#l12.1378"></a><span id="l12.1378" class="difflineplus">+    // however the realname and password is not part of manual config and</span>
<a href="#l12.1379"></a><span id="l12.1379" class="difflineplus">+    // must stay a placeholder in _currentConfig. @see getUserConfig()</span>
<a href="#l12.1380"></a><span id="l12.1380" class="difflineplus">+</span>
<a href="#l12.1381"></a><span id="l12.1381" class="difflineplus">+    this._fillManualEditFields(this.getConcreteConfig());</span>
<a href="#l12.1382"></a><span id="l12.1382" class="difflineplus">+</span>
<a href="#l12.1383"></a><span id="l12.1383" class="difflineplus">+    // _fillManualEditFields() indirectly calls validateManualEditComplete(),</span>
<a href="#l12.1384"></a><span id="l12.1384" class="difflineplus">+    // but it's important to not forget it in case the code is rewritten,</span>
<a href="#l12.1385"></a><span id="l12.1385" class="difflineplus">+    // so calling it explicitly again. Doesn't do harm, speed is irrelevant.</span>
<a href="#l12.1386"></a><span id="l12.1386" class="difflineplus">+    this.validateManualEditComplete();</span>
<a href="#l12.1387"></a><span id="l12.1387" class="difflineplus">+  },</span>
<a href="#l12.1388"></a><span id="l12.1388" class="difflineplus">+</span>
<a href="#l12.1389"></a><span id="l12.1389" class="difflineplus">+  /**</span>
<a href="#l12.1390"></a><span id="l12.1390" class="difflineplus">+   * Fills the manual edit textfields with the provided config.</span>
<a href="#l12.1391"></a><span id="l12.1391" class="difflineplus">+   * @param config {AccountConfig} The config to present to user</span>
<a href="#l12.1392"></a><span id="l12.1392" class="difflineplus">+   */</span>
<a href="#l12.1393"></a><span id="l12.1393" class="difflineplus">+  _fillManualEditFields : function(config)</span>
<a href="#l12.1394"></a><span id="l12.1394" class="difflineplus">+  {</span>
<a href="#l12.1395"></a><span id="l12.1395" class="difflineplus">+    assert(config instanceof AccountConfig);</span>
<a href="#l12.1396"></a><span id="l12.1396" class="difflineplus">+</span>
<a href="#l12.1397"></a><span id="l12.1397" class="difflineplus">+    // incoming server</span>
<a href="#l12.1398"></a><span id="l12.1398" class="difflineplus">+    e(&quot;incoming_protocol&quot;).value = sanitize.translate(config.incoming.type,</span>
<a href="#l12.1399"></a><span id="l12.1399" class="difflineplus">+                                                { &quot;imap&quot; : 1, &quot;pop3&quot; : 2 }, 1);</span>
<a href="#l12.1400"></a><span id="l12.1400" class="difflineplus">+    e(&quot;incoming_hostname&quot;).value = config.incoming.hostname;</span>
<a href="#l12.1401"></a><span id="l12.1401" class="difflineplus">+    e(&quot;incoming_ssl&quot;).value = sanitize.enum(config.incoming.socketType,</span>
<a href="#l12.1402"></a><span id="l12.1402" class="difflineplus">+                                            [ 0, 1, 2, 3 ], 0);</span>
<a href="#l12.1403"></a><span id="l12.1403" class="difflineplus">+    e(&quot;incoming_authMethod&quot;).value = sanitize.enum(config.incoming.auth,</span>
<a href="#l12.1404"></a><span id="l12.1404" class="difflineplus">+                                                   [ 0, 3, 4, 5, 6 ], 0);</span>
<a href="#l12.1405"></a><span id="l12.1405" class="difflineplus">+    e(&quot;incoming_username&quot;).value = config.incoming.username;</span>
<a href="#l12.1406"></a><span id="l12.1406" class="difflineplus">+    if (config.incoming.port) {</span>
<a href="#l12.1407"></a><span id="l12.1407" class="difflineplus">+      e(&quot;incoming_port&quot;).value = config.incoming.port;</span>
<a href="#l12.1408"></a><span id="l12.1408" class="difflineplus">+    } else {</span>
<a href="#l12.1409"></a><span id="l12.1409" class="difflineplus">+      this.adjustIncomingPortToSSLAndProtocol(config);</span>
<a href="#l12.1410"></a><span id="l12.1410" class="difflineplus">+    }</span>
<a href="#l12.1411"></a><span id="l12.1411" class="difflineplus">+    this.fillPortDropdown(config.incoming.type);</span>
<a href="#l12.1412"></a><span id="l12.1412" class="difflineplus">+</span>
<a href="#l12.1413"></a><span id="l12.1413" class="difflineplus">+    // outgoing server</span>
<a href="#l12.1414"></a><span id="l12.1414" class="difflineplus">+    e(&quot;outgoing_hostname&quot;).value = config.outgoing.hostname;</span>
<a href="#l12.1415"></a><span id="l12.1415" class="difflineplus">+    e(&quot;outgoing_ssl&quot;).value = sanitize.enum(config.outgoing.socketType,</span>
<a href="#l12.1416"></a><span id="l12.1416" class="difflineplus">+                                            [ 0, 1, 2, 3 ], 0);</span>
<a href="#l12.1417"></a><span id="l12.1417" class="difflineplus">+    e(&quot;outgoing_authMethod&quot;).value = sanitize.enum(config.outgoing.auth,</span>
<a href="#l12.1418"></a><span id="l12.1418" class="difflineplus">+                                                   [ 0, 1, 3, 4, 5, 6 ], 0);</span>
<a href="#l12.1419"></a><span id="l12.1419" class="difflineplus">+    if (config.outgoing.port) {</span>
<a href="#l12.1420"></a><span id="l12.1420" class="difflineplus">+      e(&quot;outgoing_port&quot;).value = config.outgoing.port;</span>
<a href="#l12.1421"></a><span id="l12.1421" class="difflineplus">+    } else {</span>
<a href="#l12.1422"></a><span id="l12.1422" class="difflineplus">+      this.adjustOutgoingPortToSSLAndProtocol(config);</span>
<a href="#l12.1423"></a><span id="l12.1423" class="difflineplus">+    }</span>
<a href="#l12.1424"></a><span id="l12.1424" class="difflineplus">+    // populate fields even if existingServerKey, in case user changes back</span>
<a href="#l12.1425"></a><span id="l12.1425" class="difflineplus">+</span>
<a href="#l12.1426"></a><span id="l12.1426" class="difflineplus">+    if (config.outgoing.existingServerKey) {</span>
<a href="#l12.1427"></a><span id="l12.1427" class="difflineplus">+      let menulist = e(&quot;outgoing_hostname&quot;);</span>
<a href="#l12.1428"></a><span id="l12.1428" class="difflineplus">+      // We can't use menulist.value = config.outgoing.existingServerKey</span>
<a href="#l12.1429"></a><span id="l12.1429" class="difflineplus">+      // because would overwrite the text field, so have to do it manually:</span>
<a href="#l12.1430"></a><span id="l12.1430" class="difflineplus">+      for each (let menuitem in e(&quot;outgoing_hostname_popup&quot;).childNodes) {</span>
<a href="#l12.1431"></a><span id="l12.1431" class="difflineplus">+        if (menuitem.serverKey == config.outgoing.existingServerKey) {</span>
<a href="#l12.1432"></a><span id="l12.1432" class="difflineplus">+          menulist.selectedItem = menuitem;</span>
<a href="#l12.1433"></a><span id="l12.1433" class="difflineplus">+          break;</span>
<a href="#l12.1434"></a><span id="l12.1434" class="difflineplus">+        }</span>
<a href="#l12.1435"></a><span id="l12.1435" class="difflineplus">+      }</span>
<a href="#l12.1436"></a><span id="l12.1436" class="difflineplus">+    }</span>
<a href="#l12.1437"></a><span id="l12.1437" class="difflineplus">+    this.onChangedOutgoingDropdown(); // show/hide outgoing port, SSL, ...</span>
<a href="#l12.1438"></a><span id="l12.1438">   },</span>
<a href="#l12.1439"></a><span id="l12.1439"> </span>
<a href="#l12.1440"></a><span id="l12.1440" class="difflineminus">-  /*</span>
<a href="#l12.1441"></a><span id="l12.1441" class="difflineminus">-   * Returns either the nsISmtpServer.key for an existing account that matches</span>
<a href="#l12.1442"></a><span id="l12.1442" class="difflineminus">-   * our discovered hostname + port + username, or false if no match is found.</span>
<a href="#l12.1443"></a><span id="l12.1443" class="difflineplus">+  /**</span>
<a href="#l12.1444"></a><span id="l12.1444" class="difflineplus">+   * Automatically fill port field in manual edit,</span>
<a href="#l12.1445"></a><span id="l12.1445" class="difflineplus">+   * unless user entered a non-standard port.</span>
<a href="#l12.1446"></a><span id="l12.1446" class="difflineplus">+   * @param config {AccountConfig}</span>
<a href="#l12.1447"></a><span id="l12.1447" class="difflineplus">+   */</span>
<a href="#l12.1448"></a><span id="l12.1448" class="difflineplus">+  adjustIncomingPortToSSLAndProtocol : function(config)</span>
<a href="#l12.1449"></a><span id="l12.1449" class="difflineplus">+  {</span>
<a href="#l12.1450"></a><span id="l12.1450" class="difflineplus">+    var autoPort = gStringsBundle.getString(&quot;port_auto&quot;);</span>
<a href="#l12.1451"></a><span id="l12.1451" class="difflineplus">+    var incoming = config.incoming;</span>
<a href="#l12.1452"></a><span id="l12.1452" class="difflineplus">+    // we could use getHostEntry() here, but that API is bad, so don't bother</span>
<a href="#l12.1453"></a><span id="l12.1453" class="difflineplus">+    var newInPort = undefined;</span>
<a href="#l12.1454"></a><span id="l12.1454" class="difflineplus">+    if (!incoming.port || isStandardPort(incoming.port)) {</span>
<a href="#l12.1455"></a><span id="l12.1455" class="difflineplus">+      if (incoming.type == &quot;imap&quot;) {</span>
<a href="#l12.1456"></a><span id="l12.1456" class="difflineplus">+        if (incoming.socketType == 1 || incoming.socketType == 3) {</span>
<a href="#l12.1457"></a><span id="l12.1457" class="difflineplus">+          newInPort = 143;</span>
<a href="#l12.1458"></a><span id="l12.1458" class="difflineplus">+        } else if (incoming.socketType == 2) { // Normal SSL</span>
<a href="#l12.1459"></a><span id="l12.1459" class="difflineplus">+          newInPort = 993;</span>
<a href="#l12.1460"></a><span id="l12.1460" class="difflineplus">+        } else { // auto</span>
<a href="#l12.1461"></a><span id="l12.1461" class="difflineplus">+          newInPort = autoPort;</span>
<a href="#l12.1462"></a><span id="l12.1462" class="difflineplus">+        }</span>
<a href="#l12.1463"></a><span id="l12.1463" class="difflineplus">+      } else if (incoming.type == &quot;pop3&quot;) {</span>
<a href="#l12.1464"></a><span id="l12.1464" class="difflineplus">+        if (incoming.socketType == 1 || incoming.socketType == 3) {</span>
<a href="#l12.1465"></a><span id="l12.1465" class="difflineplus">+          newInPort = 110;</span>
<a href="#l12.1466"></a><span id="l12.1466" class="difflineplus">+        } else if (incoming.socketType == 2) { // Normal SSLs</span>
<a href="#l12.1467"></a><span id="l12.1467" class="difflineplus">+          newInPort = 995;</span>
<a href="#l12.1468"></a><span id="l12.1468" class="difflineplus">+        } else { // auto</span>
<a href="#l12.1469"></a><span id="l12.1469" class="difflineplus">+          newInPort = autoPort;</span>
<a href="#l12.1470"></a><span id="l12.1470" class="difflineplus">+        }</span>
<a href="#l12.1471"></a><span id="l12.1471" class="difflineplus">+      }</span>
<a href="#l12.1472"></a><span id="l12.1472" class="difflineplus">+    }</span>
<a href="#l12.1473"></a><span id="l12.1473" class="difflineplus">+    if (newInPort != undefined) {</span>
<a href="#l12.1474"></a><span id="l12.1474" class="difflineplus">+      e(&quot;incoming_port&quot;).value = newInPort;</span>
<a href="#l12.1475"></a><span id="l12.1475" class="difflineplus">+      e(&quot;incoming_authMethod&quot;).value = 0; // auto</span>
<a href="#l12.1476"></a><span id="l12.1476" class="difflineplus">+    }</span>
<a href="#l12.1477"></a><span id="l12.1477" class="difflineplus">+  },</span>
<a href="#l12.1478"></a><span id="l12.1478" class="difflineplus">+</span>
<a href="#l12.1479"></a><span id="l12.1479" class="difflineplus">+  /**</span>
<a href="#l12.1480"></a><span id="l12.1480" class="difflineplus">+   * @see adjustIncomingPortToSSLAndProtocol()</span>
<a href="#l12.1481"></a><span id="l12.1481" class="difflineplus">+   */</span>
<a href="#l12.1482"></a><span id="l12.1482" class="difflineplus">+  adjustOutgoingPortToSSLAndProtocol : function(config)</span>
<a href="#l12.1483"></a><span id="l12.1483" class="difflineplus">+  {</span>
<a href="#l12.1484"></a><span id="l12.1484" class="difflineplus">+    var autoPort = gStringsBundle.getString(&quot;port_auto&quot;);</span>
<a href="#l12.1485"></a><span id="l12.1485" class="difflineplus">+    var outgoing = config.outgoing;</span>
<a href="#l12.1486"></a><span id="l12.1486" class="difflineplus">+    var newOutPort = undefined;</span>
<a href="#l12.1487"></a><span id="l12.1487" class="difflineplus">+    if (!outgoing.port || isStandardPort(outgoing.port)) {</span>
<a href="#l12.1488"></a><span id="l12.1488" class="difflineplus">+      if (outgoing.socketType == 1 || outgoing.socketType == 3) {</span>
<a href="#l12.1489"></a><span id="l12.1489" class="difflineplus">+        // standard port is 587 *or* 25, so set to auto</span>
<a href="#l12.1490"></a><span id="l12.1490" class="difflineplus">+        // unless user or config already entered one of these two ports.</span>
<a href="#l12.1491"></a><span id="l12.1491" class="difflineplus">+        if (outgoing.port != 25 &amp;&amp; outgoing.port != 587) {</span>
<a href="#l12.1492"></a><span id="l12.1492" class="difflineplus">+          newOutPort = autoPort;</span>
<a href="#l12.1493"></a><span id="l12.1493" class="difflineplus">+        }</span>
<a href="#l12.1494"></a><span id="l12.1494" class="difflineplus">+      } else if (outgoing.socketType == 2) { // Normal SSL</span>
<a href="#l12.1495"></a><span id="l12.1495" class="difflineplus">+        newOutPort = 465;</span>
<a href="#l12.1496"></a><span id="l12.1496" class="difflineplus">+      } else { // auto</span>
<a href="#l12.1497"></a><span id="l12.1497" class="difflineplus">+        newOutPort = autoPort;</span>
<a href="#l12.1498"></a><span id="l12.1498" class="difflineplus">+      }</span>
<a href="#l12.1499"></a><span id="l12.1499" class="difflineplus">+    }</span>
<a href="#l12.1500"></a><span id="l12.1500" class="difflineplus">+    if (newOutPort != undefined) {</span>
<a href="#l12.1501"></a><span id="l12.1501" class="difflineplus">+      e(&quot;outgoing_port&quot;).value = newOutPort;</span>
<a href="#l12.1502"></a><span id="l12.1502" class="difflineplus">+      e(&quot;outgoing_authMethod&quot;).value = 0; // auto</span>
<a href="#l12.1503"></a><span id="l12.1503" class="difflineplus">+    }</span>
<a href="#l12.1504"></a><span id="l12.1504" class="difflineplus">+  },</span>
<a href="#l12.1505"></a><span id="l12.1505" class="difflineplus">+</span>
<a href="#l12.1506"></a><span id="l12.1506" class="difflineplus">+  /**</span>
<a href="#l12.1507"></a><span id="l12.1507" class="difflineplus">+   * If the user changed the port manually, adjust the SSL value,</span>
<a href="#l12.1508"></a><span id="l12.1508" class="difflineplus">+   * (only) if the new port is impossible with the old SSL value.</span>
<a href="#l12.1509"></a><span id="l12.1509" class="difflineplus">+   * @param config {AccountConfig}</span>
<a href="#l12.1510"></a><span id="l12.1510">    */</span>
<a href="#l12.1511"></a><span id="l12.1511" class="difflineminus">-  keyForExistingOutgoingAccount : function()</span>
<a href="#l12.1512"></a><span id="l12.1512" class="difflineplus">+  adjustIncomingSSLToPort : function(config)</span>
<a href="#l12.1513"></a><span id="l12.1513" class="difflineplus">+  {</span>
<a href="#l12.1514"></a><span id="l12.1514" class="difflineplus">+    var incoming = config.incoming;</span>
<a href="#l12.1515"></a><span id="l12.1515" class="difflineplus">+    var newInSocketType = undefined;</span>
<a href="#l12.1516"></a><span id="l12.1516" class="difflineplus">+    if (!incoming.port || // auto</span>
<a href="#l12.1517"></a><span id="l12.1517" class="difflineplus">+        !isStandardPort(incoming.port)) {</span>
<a href="#l12.1518"></a><span id="l12.1518" class="difflineplus">+      return;</span>
<a href="#l12.1519"></a><span id="l12.1519" class="difflineplus">+    }</span>
<a href="#l12.1520"></a><span id="l12.1520" class="difflineplus">+    if (incoming.type == &quot;imap&quot;) {</span>
<a href="#l12.1521"></a><span id="l12.1521" class="difflineplus">+      // normal SSL impossible</span>
<a href="#l12.1522"></a><span id="l12.1522" class="difflineplus">+      if (incoming.port == 143 &amp;&amp; incoming.socketType == 2) {</span>
<a href="#l12.1523"></a><span id="l12.1523" class="difflineplus">+        newInSocketType = 0; // auto</span>
<a href="#l12.1524"></a><span id="l12.1524" class="difflineplus">+      // must be normal SSL</span>
<a href="#l12.1525"></a><span id="l12.1525" class="difflineplus">+      } else if (incoming.port == 993 &amp;&amp; incoming.socketType != 2) {</span>
<a href="#l12.1526"></a><span id="l12.1526" class="difflineplus">+        newInSocketType = 2;</span>
<a href="#l12.1527"></a><span id="l12.1527" class="difflineplus">+      }</span>
<a href="#l12.1528"></a><span id="l12.1528" class="difflineplus">+    } else if (incoming.type == &quot;pop3&quot;) {</span>
<a href="#l12.1529"></a><span id="l12.1529" class="difflineplus">+      // normal SSL impossible</span>
<a href="#l12.1530"></a><span id="l12.1530" class="difflineplus">+      if (incoming.port == 110 &amp;&amp; incoming.socketType == 2) {</span>
<a href="#l12.1531"></a><span id="l12.1531" class="difflineplus">+        newInSocketType = 0; // auto</span>
<a href="#l12.1532"></a><span id="l12.1532" class="difflineplus">+      // must be normal SSL</span>
<a href="#l12.1533"></a><span id="l12.1533" class="difflineplus">+      } else if (incoming.port == 995 &amp;&amp; incoming.socketType != 2) {</span>
<a href="#l12.1534"></a><span id="l12.1534" class="difflineplus">+        newInSocketType = 2;</span>
<a href="#l12.1535"></a><span id="l12.1535" class="difflineplus">+      }</span>
<a href="#l12.1536"></a><span id="l12.1536" class="difflineplus">+    }</span>
<a href="#l12.1537"></a><span id="l12.1537" class="difflineplus">+    if (newInSocketType != undefined) {</span>
<a href="#l12.1538"></a><span id="l12.1538" class="difflineplus">+      e(&quot;incoming_ssl&quot;).value = newInSocketType;</span>
<a href="#l12.1539"></a><span id="l12.1539" class="difflineplus">+      e(&quot;incoming_authMethod&quot;).value = 0; // auto</span>
<a href="#l12.1540"></a><span id="l12.1540" class="difflineplus">+    }</span>
<a href="#l12.1541"></a><span id="l12.1541" class="difflineplus">+  },</span>
<a href="#l12.1542"></a><span id="l12.1542" class="difflineplus">+</span>
<a href="#l12.1543"></a><span id="l12.1543" class="difflineplus">+  /**</span>
<a href="#l12.1544"></a><span id="l12.1544" class="difflineplus">+   * @see adjustIncomingSSLToPort()</span>
<a href="#l12.1545"></a><span id="l12.1545" class="difflineplus">+   */</span>
<a href="#l12.1546"></a><span id="l12.1546" class="difflineplus">+  adjustOutgoingSSLToPort : function(config)</span>
<a href="#l12.1547"></a><span id="l12.1547" class="difflineplus">+  {</span>
<a href="#l12.1548"></a><span id="l12.1548" class="difflineplus">+    var outgoing = config.outgoing;</span>
<a href="#l12.1549"></a><span id="l12.1549" class="difflineplus">+    var newOutSocketType = undefined;</span>
<a href="#l12.1550"></a><span id="l12.1550" class="difflineplus">+    if (!outgoing.port || // auto</span>
<a href="#l12.1551"></a><span id="l12.1551" class="difflineplus">+        !isStandardPort(outgoing.port)) {</span>
<a href="#l12.1552"></a><span id="l12.1552" class="difflineplus">+      return;</span>
<a href="#l12.1553"></a><span id="l12.1553" class="difflineplus">+    }</span>
<a href="#l12.1554"></a><span id="l12.1554" class="difflineplus">+    // normal SSL impossible</span>
<a href="#l12.1555"></a><span id="l12.1555" class="difflineplus">+    if ((outgoing.port == 587 || outgoing.port == 25) &amp;&amp;</span>
<a href="#l12.1556"></a><span id="l12.1556" class="difflineplus">+        outgoing.socketType == 2) {</span>
<a href="#l12.1557"></a><span id="l12.1557" class="difflineplus">+      newOutSocketType = 0; // auto</span>
<a href="#l12.1558"></a><span id="l12.1558" class="difflineplus">+    // must be normal SSL</span>
<a href="#l12.1559"></a><span id="l12.1559" class="difflineplus">+    } else if (outgoing.port == 465 &amp;&amp; outgoing.socketType != 2) {</span>
<a href="#l12.1560"></a><span id="l12.1560" class="difflineplus">+      newOutSocketType = 2;</span>
<a href="#l12.1561"></a><span id="l12.1561" class="difflineplus">+    }</span>
<a href="#l12.1562"></a><span id="l12.1562" class="difflineplus">+    if (newOutSocketType != undefined) {</span>
<a href="#l12.1563"></a><span id="l12.1563" class="difflineplus">+      e(&quot;outgoing_ssl&quot;).value = newOutSocketType;</span>
<a href="#l12.1564"></a><span id="l12.1564" class="difflineplus">+      e(&quot;outgoing_authMethod&quot;).value = 0; // auto</span>
<a href="#l12.1565"></a><span id="l12.1565" class="difflineplus">+    }</span>
<a href="#l12.1566"></a><span id="l12.1566" class="difflineplus">+  },</span>
<a href="#l12.1567"></a><span id="l12.1567" class="difflineplus">+</span>
<a href="#l12.1568"></a><span id="l12.1568" class="difflineplus">+  /**</span>
<a href="#l12.1569"></a><span id="l12.1569" class="difflineplus">+   * Sets the prefilled values of the port fields.</span>
<a href="#l12.1570"></a><span id="l12.1570" class="difflineplus">+   * Filled statically with the standard ports for the given protocol,</span>
<a href="#l12.1571"></a><span id="l12.1571" class="difflineplus">+   * plus &quot;Auto&quot;.</span>
<a href="#l12.1572"></a><span id="l12.1572" class="difflineplus">+   */</span>
<a href="#l12.1573"></a><span id="l12.1573" class="difflineplus">+  fillPortDropdown : function(protocolType)</span>
<a href="#l12.1574"></a><span id="l12.1574" class="difflineplus">+  {</span>
<a href="#l12.1575"></a><span id="l12.1575" class="difflineplus">+    var menu = e(protocolType == &quot;smtp&quot; ? &quot;outgoing_port&quot; : &quot;incoming_port&quot;);</span>
<a href="#l12.1576"></a><span id="l12.1576" class="difflineplus">+</span>
<a href="#l12.1577"></a><span id="l12.1577" class="difflineplus">+    // menulist.removeAllItems() is nice, but nicely clears the user value, too</span>
<a href="#l12.1578"></a><span id="l12.1578" class="difflineplus">+    var popup = menu.menupopup;</span>
<a href="#l12.1579"></a><span id="l12.1579" class="difflineplus">+    while (popup.hasChildNodes())</span>
<a href="#l12.1580"></a><span id="l12.1580" class="difflineplus">+      popup.removeChild(popup.firstChild);</span>
<a href="#l12.1581"></a><span id="l12.1581" class="difflineplus">+</span>
<a href="#l12.1582"></a><span id="l12.1582" class="difflineplus">+    // add standard ports</span>
<a href="#l12.1583"></a><span id="l12.1583" class="difflineplus">+    var autoPort = gStringsBundle.getString(&quot;port_auto&quot;);</span>
<a href="#l12.1584"></a><span id="l12.1584" class="difflineplus">+    menu.appendItem(autoPort, autoPort, &quot;&quot;); // label,value,descr</span>
<a href="#l12.1585"></a><span id="l12.1585" class="difflineplus">+    for each (let port in getStandardPorts(protocolType)) {</span>
<a href="#l12.1586"></a><span id="l12.1586" class="difflineplus">+      menu.appendItem(port, port, &quot;&quot;); // label,value,descr</span>
<a href="#l12.1587"></a><span id="l12.1587" class="difflineplus">+    }</span>
<a href="#l12.1588"></a><span id="l12.1588" class="difflineplus">+  },</span>
<a href="#l12.1589"></a><span id="l12.1589" class="difflineplus">+</span>
<a href="#l12.1590"></a><span id="l12.1590" class="difflineplus">+  onChangedProtocolIncoming : function()</span>
<a href="#l12.1591"></a><span id="l12.1591" class="difflineplus">+  {</span>
<a href="#l12.1592"></a><span id="l12.1592" class="difflineplus">+    var config = this.getUserConfig();</span>
<a href="#l12.1593"></a><span id="l12.1593" class="difflineplus">+    this.adjustIncomingPortToSSLAndProtocol(config);</span>
<a href="#l12.1594"></a><span id="l12.1594" class="difflineplus">+    this.fillPortDropdown(config.incoming.type);</span>
<a href="#l12.1595"></a><span id="l12.1595" class="difflineplus">+    this.onChangedManualEdit();</span>
<a href="#l12.1596"></a><span id="l12.1596" class="difflineplus">+  },</span>
<a href="#l12.1597"></a><span id="l12.1597" class="difflineplus">+  onChangedPortIncoming : function()</span>
<a href="#l12.1598"></a><span id="l12.1598" class="difflineplus">+  {</span>
<a href="#l12.1599"></a><span id="l12.1599" class="difflineplus">+    gEmailWizardLogger.info(&quot;incoming port changed&quot;);</span>
<a href="#l12.1600"></a><span id="l12.1600" class="difflineplus">+    this.adjustIncomingSSLToPort(this.getUserConfig());</span>
<a href="#l12.1601"></a><span id="l12.1601" class="difflineplus">+    this.onChangedManualEdit();</span>
<a href="#l12.1602"></a><span id="l12.1602" class="difflineplus">+  },</span>
<a href="#l12.1603"></a><span id="l12.1603" class="difflineplus">+  onChangedPortOutgoing : function()</span>
<a href="#l12.1604"></a><span id="l12.1604" class="difflineplus">+  {</span>
<a href="#l12.1605"></a><span id="l12.1605" class="difflineplus">+    gEmailWizardLogger.info(&quot;outgoing port changed&quot;);</span>
<a href="#l12.1606"></a><span id="l12.1606" class="difflineplus">+    this.adjustOutgoingSSLToPort(this.getUserConfig());</span>
<a href="#l12.1607"></a><span id="l12.1607" class="difflineplus">+    this.onChangedManualEdit();</span>
<a href="#l12.1608"></a><span id="l12.1608" class="difflineplus">+  },</span>
<a href="#l12.1609"></a><span id="l12.1609" class="difflineplus">+  onChangedSSLIncoming : function()</span>
<a href="#l12.1610"></a><span id="l12.1610" class="difflineplus">+  {</span>
<a href="#l12.1611"></a><span id="l12.1611" class="difflineplus">+    this.adjustIncomingPortToSSLAndProtocol(this.getUserConfig());</span>
<a href="#l12.1612"></a><span id="l12.1612" class="difflineplus">+    this.onChangedManualEdit();</span>
<a href="#l12.1613"></a><span id="l12.1613" class="difflineplus">+  },</span>
<a href="#l12.1614"></a><span id="l12.1614" class="difflineplus">+  onChangedSSLOutgoing : function()</span>
<a href="#l12.1615"></a><span id="l12.1615" class="difflineplus">+  {</span>
<a href="#l12.1616"></a><span id="l12.1616" class="difflineplus">+    this.adjustOutgoingPortToSSLAndProtocol(this.getUserConfig());</span>
<a href="#l12.1617"></a><span id="l12.1617" class="difflineplus">+    this.onChangedManualEdit();</span>
<a href="#l12.1618"></a><span id="l12.1618" class="difflineplus">+  },</span>
<a href="#l12.1619"></a><span id="l12.1619" class="difflineplus">+  onChangedAuth : function()</span>
<a href="#l12.1620"></a><span id="l12.1620" class="difflineplus">+  {</span>
<a href="#l12.1621"></a><span id="l12.1621" class="difflineplus">+    this.onChangedManualEdit();</span>
<a href="#l12.1622"></a><span id="l12.1622" class="difflineplus">+  },</span>
<a href="#l12.1623"></a><span id="l12.1623" class="difflineplus">+  onInputUsername : function()</span>
<a href="#l12.1624"></a><span id="l12.1624" class="difflineplus">+  {</span>
<a href="#l12.1625"></a><span id="l12.1625" class="difflineplus">+    this.onChangedManualEdit();</span>
<a href="#l12.1626"></a><span id="l12.1626" class="difflineplus">+  },</span>
<a href="#l12.1627"></a><span id="l12.1627" class="difflineplus">+  onInputHostname : function()</span>
<a href="#l12.1628"></a><span id="l12.1628" class="difflineplus">+  {</span>
<a href="#l12.1629"></a><span id="l12.1629" class="difflineplus">+    this.onChangedManualEdit();</span>
<a href="#l12.1630"></a><span id="l12.1630" class="difflineplus">+  },</span>
<a href="#l12.1631"></a><span id="l12.1631" class="difflineplus">+</span>
<a href="#l12.1632"></a><span id="l12.1632" class="difflineplus">+  /**</span>
<a href="#l12.1633"></a><span id="l12.1633" class="difflineplus">+   * Sets the label of the first entry of the dropdown which represents</span>
<a href="#l12.1634"></a><span id="l12.1634" class="difflineplus">+   * the new outgoing server.</span>
<a href="#l12.1635"></a><span id="l12.1635" class="difflineplus">+   */</span>
<a href="#l12.1636"></a><span id="l12.1636" class="difflineplus">+  onOpenOutgoingDropdown : function()</span>
<a href="#l12.1637"></a><span id="l12.1637">   {</span>
<a href="#l12.1638"></a><span id="l12.1638" class="difflineminus">-    var smtpServers = gSmtpManager.smtpServers;</span>
<a href="#l12.1639"></a><span id="l12.1639" class="difflineminus">-    while (smtpServers.hasMoreElements())</span>
<a href="#l12.1640"></a><span id="l12.1640" class="difflineminus">-    {</span>
<a href="#l12.1641"></a><span id="l12.1641" class="difflineminus">-      let existingServer = smtpServers.getNext().QueryInterface(Components.interfaces.nsISmtpServer);</span>
<a href="#l12.1642"></a><span id="l12.1642" class="difflineminus">-      if (existingServer.hostname == this._currentConfigFilledIn.outgoing.hostname &amp;&amp;</span>
<a href="#l12.1643"></a><span id="l12.1643" class="difflineminus">-          existingServer.port == this._currentConfigFilledIn.outgoing.port &amp;&amp;</span>
<a href="#l12.1644"></a><span id="l12.1644" class="difflineminus">-          existingServer.username == this._currentConfigFilledIn.outgoing.username)</span>
<a href="#l12.1645"></a><span id="l12.1645" class="difflineminus">-        return existingServer.key;</span>
<a href="#l12.1646"></a><span id="l12.1646" class="difflineplus">+    var menulist = e(&quot;outgoing_hostname&quot;);</span>
<a href="#l12.1647"></a><span id="l12.1647" class="difflineplus">+    var menuitem = menulist.getItemAtIndex(0);</span>
<a href="#l12.1648"></a><span id="l12.1648" class="difflineplus">+    assert(!menuitem.serverKey, &quot;I wanted the special item for the new host&quot;);</span>
<a href="#l12.1649"></a><span id="l12.1649" class="difflineplus">+    menuitem.label = menulist.inputField.value;</span>
<a href="#l12.1650"></a><span id="l12.1650" class="difflineplus">+  },</span>
<a href="#l12.1651"></a><span id="l12.1651" class="difflineplus">+</span>
<a href="#l12.1652"></a><span id="l12.1652" class="difflineplus">+  /**</span>
<a href="#l12.1653"></a><span id="l12.1653" class="difflineplus">+   * User selected an existing SMTP server (or deselected it).</span>
<a href="#l12.1654"></a><span id="l12.1654" class="difflineplus">+   * This changes only the UI. The values are read in getUserConfig().</span>
<a href="#l12.1655"></a><span id="l12.1655" class="difflineplus">+   */</span>
<a href="#l12.1656"></a><span id="l12.1656" class="difflineplus">+  onChangedOutgoingDropdown : function()</span>
<a href="#l12.1657"></a><span id="l12.1657" class="difflineplus">+  {</span>
<a href="#l12.1658"></a><span id="l12.1658" class="difflineplus">+    var menulist = e(&quot;outgoing_hostname&quot;);</span>
<a href="#l12.1659"></a><span id="l12.1659" class="difflineplus">+    var menuitem = menulist.selectedItem;</span>
<a href="#l12.1660"></a><span id="l12.1660" class="difflineplus">+    if (menuitem &amp;&amp; menuitem.serverKey) {</span>
<a href="#l12.1661"></a><span id="l12.1661" class="difflineplus">+      // an existing server has been selected from the dropdown</span>
<a href="#l12.1662"></a><span id="l12.1662" class="difflineplus">+      menulist.setAttribute(&quot;editable&quot;, false);</span>
<a href="#l12.1663"></a><span id="l12.1663" class="difflineplus">+      _hide(&quot;outgoing_port&quot;);</span>
<a href="#l12.1664"></a><span id="l12.1664" class="difflineplus">+      _hide(&quot;outgoing_ssl&quot;);</span>
<a href="#l12.1665"></a><span id="l12.1665" class="difflineplus">+      _hide(&quot;outgoing_authMethod&quot;);</span>
<a href="#l12.1666"></a><span id="l12.1666" class="difflineplus">+    } else {</span>
<a href="#l12.1667"></a><span id="l12.1667" class="difflineplus">+      // new server, with hostname, port etc.</span>
<a href="#l12.1668"></a><span id="l12.1668" class="difflineplus">+      menulist.setAttribute(&quot;editable&quot;, true);</span>
<a href="#l12.1669"></a><span id="l12.1669" class="difflineplus">+      _show(&quot;outgoing_port&quot;);</span>
<a href="#l12.1670"></a><span id="l12.1670" class="difflineplus">+      _show(&quot;outgoing_ssl&quot;);</span>
<a href="#l12.1671"></a><span id="l12.1671" class="difflineplus">+      _show(&quot;outgoing_authMethod&quot;);</span>
<a href="#l12.1672"></a><span id="l12.1672" class="difflineplus">+    }</span>
<a href="#l12.1673"></a><span id="l12.1673" class="difflineplus">+</span>
<a href="#l12.1674"></a><span id="l12.1674" class="difflineplus">+    this.onChangedManualEdit();</span>
<a href="#l12.1675"></a><span id="l12.1675" class="difflineplus">+  },</span>
<a href="#l12.1676"></a><span id="l12.1676" class="difflineplus">+</span>
<a href="#l12.1677"></a><span id="l12.1677" class="difflineplus">+  onChangedManualEdit : function()</span>
<a href="#l12.1678"></a><span id="l12.1678" class="difflineplus">+  {</span>
<a href="#l12.1679"></a><span id="l12.1679" class="difflineplus">+    if (this._abortable) {</span>
<a href="#l12.1680"></a><span id="l12.1680" class="difflineplus">+      this.onStop();</span>
<a href="#l12.1681"></a><span id="l12.1681" class="difflineplus">+    }</span>
<a href="#l12.1682"></a><span id="l12.1682" class="difflineplus">+    this.validateManualEditComplete();</span>
<a href="#l12.1683"></a><span id="l12.1683" class="difflineplus">+  },</span>
<a href="#l12.1684"></a><span id="l12.1684" class="difflineplus">+</span>
<a href="#l12.1685"></a><span id="l12.1685" class="difflineplus">+  /**</span>
<a href="#l12.1686"></a><span id="l12.1686" class="difflineplus">+   * This enables the buttons which allow the user to proceed</span>
<a href="#l12.1687"></a><span id="l12.1687" class="difflineplus">+   * once he has entered enough information.</span>
<a href="#l12.1688"></a><span id="l12.1688" class="difflineplus">+   *</span>
<a href="#l12.1689"></a><span id="l12.1689" class="difflineplus">+   * We can easily and faily surely autodetect everything apart from the</span>
<a href="#l12.1690"></a><span id="l12.1690" class="difflineplus">+   * hostname (and username). So, once the user has entered</span>
<a href="#l12.1691"></a><span id="l12.1691" class="difflineplus">+   * proper hostnames, change to &quot;manual-edit-have-hostname&quot; mode</span>
<a href="#l12.1692"></a><span id="l12.1692" class="difflineplus">+   * which allows to press [Re-test], which starts the detection</span>
<a href="#l12.1693"></a><span id="l12.1693" class="difflineplus">+   * of the other values.</span>
<a href="#l12.1694"></a><span id="l12.1694" class="difflineplus">+   * Once the user has entered (or we detected) all values, he may</span>
<a href="#l12.1695"></a><span id="l12.1695" class="difflineplus">+   * do [Create Account] (tests login and if successful creates the account)</span>
<a href="#l12.1696"></a><span id="l12.1696" class="difflineplus">+   * or [Advanced Setup] (goes to Account Manager). Esp. in the latter case,</span>
<a href="#l12.1697"></a><span id="l12.1697" class="difflineplus">+   * we will not second-guess his setup and just to as told, so here we make</span>
<a href="#l12.1698"></a><span id="l12.1698" class="difflineplus">+   * sure that he at least entered all values.</span>
<a href="#l12.1699"></a><span id="l12.1699" class="difflineplus">+   */</span>
<a href="#l12.1700"></a><span id="l12.1700" class="difflineplus">+  validateManualEditComplete : function()</span>
<a href="#l12.1701"></a><span id="l12.1701" class="difflineplus">+  {</span>
<a href="#l12.1702"></a><span id="l12.1702" class="difflineplus">+    // getUserConfig() is expensive, but still OK, not a problem</span>
<a href="#l12.1703"></a><span id="l12.1703" class="difflineplus">+    var manualConfig = this.getUserConfig();</span>
<a href="#l12.1704"></a><span id="l12.1704" class="difflineplus">+    this._currentConfig = manualConfig;</span>
<a href="#l12.1705"></a><span id="l12.1705" class="difflineplus">+    if (manualConfig.isComplete()) {</span>
<a href="#l12.1706"></a><span id="l12.1706" class="difflineplus">+      this.switchToMode(&quot;manual-edit-complete&quot;);</span>
<a href="#l12.1707"></a><span id="l12.1707" class="difflineplus">+    } else if (!!manualConfig.incoming.hostname &amp;&amp;</span>
<a href="#l12.1708"></a><span id="l12.1708" class="difflineplus">+               !!manualConfig.outgoing.hostname) {</span>
<a href="#l12.1709"></a><span id="l12.1709" class="difflineplus">+      this.switchToMode(&quot;manual-edit-have-hostname&quot;);</span>
<a href="#l12.1710"></a><span id="l12.1710" class="difflineplus">+    } else {</span>
<a href="#l12.1711"></a><span id="l12.1711" class="difflineplus">+      this.switchToMode(&quot;manual-edit&quot;);</span>
<a href="#l12.1712"></a><span id="l12.1712" class="difflineplus">+    }</span>
<a href="#l12.1713"></a><span id="l12.1713" class="difflineplus">+  },</span>
<a href="#l12.1714"></a><span id="l12.1714" class="difflineplus">+</span>
<a href="#l12.1715"></a><span id="l12.1715" class="difflineplus">+  /**</span>
<a href="#l12.1716"></a><span id="l12.1716" class="difflineplus">+   * [Advanced Setup...] button click handler</span>
<a href="#l12.1717"></a><span id="l12.1717" class="difflineplus">+   * Only active in manual edit mode, and goes straight into</span>
<a href="#l12.1718"></a><span id="l12.1718" class="difflineplus">+   * Account Settings (pref UI) dialog. Requires a backend account,</span>
<a href="#l12.1719"></a><span id="l12.1719" class="difflineplus">+   * which requires proper hostname, port and protocol.</span>
<a href="#l12.1720"></a><span id="l12.1720" class="difflineplus">+   */</span>
<a href="#l12.1721"></a><span id="l12.1721" class="difflineplus">+  onAdvancedSetup : function()</span>
<a href="#l12.1722"></a><span id="l12.1722" class="difflineplus">+  {</span>
<a href="#l12.1723"></a><span id="l12.1723" class="difflineplus">+    assert(this._currentConfig instanceof AccountConfig);</span>
<a href="#l12.1724"></a><span id="l12.1724" class="difflineplus">+    var configFilledIn = this.getConcreteConfig();</span>
<a href="#l12.1725"></a><span id="l12.1725" class="difflineplus">+</span>
<a href="#l12.1726"></a><span id="l12.1726" class="difflineplus">+    if (checkIncomingServerAlreadyExists(configFilledIn)) {</span>
<a href="#l12.1727"></a><span id="l12.1727" class="difflineplus">+      alertPrompt(gStringsBundle.getString(&quot;error_creating_account&quot;),</span>
<a href="#l12.1728"></a><span id="l12.1728" class="difflineplus">+                  gStringsBundle.getString(&quot;incoming_server_exists&quot;));</span>
<a href="#l12.1729"></a><span id="l12.1729" class="difflineplus">+      return;</span>
<a href="#l12.1730"></a><span id="l12.1730" class="difflineplus">+    }</span>
<a href="#l12.1731"></a><span id="l12.1731" class="difflineplus">+</span>
<a href="#l12.1732"></a><span id="l12.1732" class="difflineplus">+    gEmailWizardLogger.info(&quot;creating account in backend&quot;);</span>
<a href="#l12.1733"></a><span id="l12.1733" class="difflineplus">+    var newAccount = createAccountInBackend(configFilledIn);</span>
<a href="#l12.1734"></a><span id="l12.1734" class="difflineplus">+</span>
<a href="#l12.1735"></a><span id="l12.1735" class="difflineplus">+    var windowManager = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l12.1736"></a><span id="l12.1736" class="difflineplus">+        .getService(Ci.nsIWindowMediator);</span>
<a href="#l12.1737"></a><span id="l12.1737" class="difflineplus">+    var existingAccountManager = windowManager</span>
<a href="#l12.1738"></a><span id="l12.1738" class="difflineplus">+        .getMostRecentWindow(&quot;mailnews:accountmanager&quot;);</span>
<a href="#l12.1739"></a><span id="l12.1739" class="difflineplus">+    if (existingAccountManager) {</span>
<a href="#l12.1740"></a><span id="l12.1740" class="difflineplus">+      existingAccountManager.focus();</span>
<a href="#l12.1741"></a><span id="l12.1741" class="difflineplus">+    } else {</span>
<a href="#l12.1742"></a><span id="l12.1742" class="difflineplus">+      window.openDialog(&quot;chrome://messenger/content/AccountManager.xul&quot;,</span>
<a href="#l12.1743"></a><span id="l12.1743" class="difflineplus">+                        &quot;AccountManager&quot;, &quot;chrome,centerscreen,modal,titlebar&quot;,</span>
<a href="#l12.1744"></a><span id="l12.1744" class="difflineplus">+                        { server: newAccount.incomingServer,</span>
<a href="#l12.1745"></a><span id="l12.1745" class="difflineplus">+                          selectPage: &quot;am-server.xul&quot; });</span>
<a href="#l12.1746"></a><span id="l12.1746" class="difflineplus">+    }</span>
<a href="#l12.1747"></a><span id="l12.1747" class="difflineplus">+    window.close();</span>
<a href="#l12.1748"></a><span id="l12.1748" class="difflineplus">+  },</span>
<a href="#l12.1749"></a><span id="l12.1749" class="difflineplus">+</span>
<a href="#l12.1750"></a><span id="l12.1750" class="difflineplus">+  /**</span>
<a href="#l12.1751"></a><span id="l12.1751" class="difflineplus">+   * [Re-test] button click handler.</span>
<a href="#l12.1752"></a><span id="l12.1752" class="difflineplus">+   * Restarts the config guessing process after a person editing the server</span>
<a href="#l12.1753"></a><span id="l12.1753" class="difflineplus">+   * fields.</span>
<a href="#l12.1754"></a><span id="l12.1754" class="difflineplus">+   * It's called &quot;half-manual&quot;, because we take the user-entered values</span>
<a href="#l12.1755"></a><span id="l12.1755" class="difflineplus">+   * as given and will not second-guess them, to respect the user wishes.</span>
<a href="#l12.1756"></a><span id="l12.1756" class="difflineplus">+   * (Yes, Sir! Will do as told!)</span>
<a href="#l12.1757"></a><span id="l12.1757" class="difflineplus">+   * The values that the user left empty or on &quot;Auto&quot; will be guessed/probed</span>
<a href="#l12.1758"></a><span id="l12.1758" class="difflineplus">+   * here. We will also check that the user-provided values work.</span>
<a href="#l12.1759"></a><span id="l12.1759" class="difflineplus">+   */</span>
<a href="#l12.1760"></a><span id="l12.1760" class="difflineplus">+  onHalfManualTest : function()</span>
<a href="#l12.1761"></a><span id="l12.1761" class="difflineplus">+  {</span>
<a href="#l12.1762"></a><span id="l12.1762" class="difflineplus">+    var newConfig = this.getUserConfig();</span>
<a href="#l12.1763"></a><span id="l12.1763" class="difflineplus">+    gEmailWizardLogger.info(debugObject(newConfig, &quot;manualConfigToTest&quot;));</span>
<a href="#l12.1764"></a><span id="l12.1764" class="difflineplus">+    this.startSpinner(&quot;looking_up_settings_halfmanual&quot;);</span>
<a href="#l12.1765"></a><span id="l12.1765" class="difflineplus">+    this.switchToMode(&quot;manual-edit-testing&quot;);</span>
<a href="#l12.1766"></a><span id="l12.1766" class="difflineplus">+    // if (this._userPickedOutgoingServer) TODO</span>
<a href="#l12.1767"></a><span id="l12.1767" class="difflineplus">+    var self = this;</span>
<a href="#l12.1768"></a><span id="l12.1768" class="difflineplus">+    this._abortable = guessConfig(this._domain,</span>
<a href="#l12.1769"></a><span id="l12.1769" class="difflineplus">+      function(type, hostname, port, ssl, done, config) // progress</span>
<a href="#l12.1770"></a><span id="l12.1770" class="difflineplus">+      {</span>
<a href="#l12.1771"></a><span id="l12.1771" class="difflineplus">+        gEmailWizardLogger.info(&quot;progress callback host &quot; + hostname +</span>
<a href="#l12.1772"></a><span id="l12.1772" class="difflineplus">+                                &quot; port &quot; +  port + &quot; type &quot; + type);</span>
<a href="#l12.1773"></a><span id="l12.1773" class="difflineplus">+      },</span>
<a href="#l12.1774"></a><span id="l12.1774" class="difflineplus">+      function(config) // success</span>
<a href="#l12.1775"></a><span id="l12.1775" class="difflineplus">+      {</span>
<a href="#l12.1776"></a><span id="l12.1776" class="difflineplus">+        self._abortable = null;</span>
<a href="#l12.1777"></a><span id="l12.1777" class="difflineplus">+        self._fillManualEditFields(config);</span>
<a href="#l12.1778"></a><span id="l12.1778" class="difflineplus">+        self.switchToMode(&quot;manual-edit-complete&quot;);</span>
<a href="#l12.1779"></a><span id="l12.1779" class="difflineplus">+        self.stopSpinner(&quot;found_settings_halfmanual&quot;);</span>
<a href="#l12.1780"></a><span id="l12.1780" class="difflineplus">+      },</span>
<a href="#l12.1781"></a><span id="l12.1781" class="difflineplus">+      function(e, config) // guessconfig failed</span>
<a href="#l12.1782"></a><span id="l12.1782" class="difflineplus">+      {</span>
<a href="#l12.1783"></a><span id="l12.1783" class="difflineplus">+        if (e instanceof CancelledException) {</span>
<a href="#l12.1784"></a><span id="l12.1784" class="difflineplus">+          return;</span>
<a href="#l12.1785"></a><span id="l12.1785" class="difflineplus">+        }</span>
<a href="#l12.1786"></a><span id="l12.1786" class="difflineplus">+        self._abortable = null;</span>
<a href="#l12.1787"></a><span id="l12.1787" class="difflineplus">+        gEmailWizardLogger.info(&quot;guessConfig failed: &quot; + e);</span>
<a href="#l12.1788"></a><span id="l12.1788" class="difflineplus">+        self.showErrorStatus(&quot;failed_to_find_settings&quot;);</span>
<a href="#l12.1789"></a><span id="l12.1789" class="difflineplus">+        self.switchToMode(&quot;manual-edit-have-hostname&quot;);</span>
<a href="#l12.1790"></a><span id="l12.1790" class="difflineplus">+      },</span>
<a href="#l12.1791"></a><span id="l12.1791" class="difflineplus">+      newConfig,</span>
<a href="#l12.1792"></a><span id="l12.1792" class="difflineplus">+      newConfig.outgoing.existingServerKey ? &quot;incoming&quot; : &quot;both&quot;);</span>
<a href="#l12.1793"></a><span id="l12.1793" class="difflineplus">+  },</span>
<a href="#l12.1794"></a><span id="l12.1794" class="difflineplus">+</span>
<a href="#l12.1795"></a><span id="l12.1795" class="difflineplus">+</span>
<a href="#l12.1796"></a><span id="l12.1796" class="difflineplus">+</span>
<a href="#l12.1797"></a><span id="l12.1797" class="difflineplus">+  /////////////////////////////////////////////////////////////////</span>
<a href="#l12.1798"></a><span id="l12.1798" class="difflineplus">+  // UI helper functions</span>
<a href="#l12.1799"></a><span id="l12.1799" class="difflineplus">+</span>
<a href="#l12.1800"></a><span id="l12.1800" class="difflineplus">+  _prefillConfig : function(initialConfig)</span>
<a href="#l12.1801"></a><span id="l12.1801" class="difflineplus">+  {</span>
<a href="#l12.1802"></a><span id="l12.1802" class="difflineplus">+    var emailsplit = this._email.split(&quot;@&quot;);</span>
<a href="#l12.1803"></a><span id="l12.1803" class="difflineplus">+    assert(emailsplit.length &gt; 1);</span>
<a href="#l12.1804"></a><span id="l12.1804" class="difflineplus">+    var emaillocal = sanitize.nonemptystring(emailsplit[0]);</span>
<a href="#l12.1805"></a><span id="l12.1805" class="difflineplus">+    initialConfig.incoming.username = emaillocal;</span>
<a href="#l12.1806"></a><span id="l12.1806" class="difflineplus">+    initialConfig.outgoing.username = emaillocal;</span>
<a href="#l12.1807"></a><span id="l12.1807" class="difflineplus">+    return initialConfig;</span>
<a href="#l12.1808"></a><span id="l12.1808" class="difflineplus">+  },</span>
<a href="#l12.1809"></a><span id="l12.1809" class="difflineplus">+</span>
<a href="#l12.1810"></a><span id="l12.1810" class="difflineplus">+  clearError : function(which)</span>
<a href="#l12.1811"></a><span id="l12.1811" class="difflineplus">+  {</span>
<a href="#l12.1812"></a><span id="l12.1812" class="difflineplus">+    _hide(which);</span>
<a href="#l12.1813"></a><span id="l12.1813" class="difflineplus">+    _hide(which + &quot;icon&quot;);</span>
<a href="#l12.1814"></a><span id="l12.1814" class="difflineplus">+    e(which).textContent = &quot;&quot;;</span>
<a href="#l12.1815"></a><span id="l12.1815" class="difflineplus">+  },</span>
<a href="#l12.1816"></a><span id="l12.1816" class="difflineplus">+</span>
<a href="#l12.1817"></a><span id="l12.1817" class="difflineplus">+  setError : function(which, msg_name)</span>
<a href="#l12.1818"></a><span id="l12.1818" class="difflineplus">+  {</span>
<a href="#l12.1819"></a><span id="l12.1819" class="difflineplus">+    try {</span>
<a href="#l12.1820"></a><span id="l12.1820" class="difflineplus">+      _show(which);</span>
<a href="#l12.1821"></a><span id="l12.1821" class="difflineplus">+      _show(which + &quot;icon&quot;);</span>
<a href="#l12.1822"></a><span id="l12.1822" class="difflineplus">+      e(which).textContent = gStringsBundle.getString(msg_name);</span>
<a href="#l12.1823"></a><span id="l12.1823" class="difflineplus">+    } catch (ex) { alertPrompt(&quot;missing error string&quot;, msg_name); }</span>
<a href="#l12.1824"></a><span id="l12.1824" class="difflineplus">+  },</span>
<a href="#l12.1825"></a><span id="l12.1825" class="difflineplus">+</span>
<a href="#l12.1826"></a><span id="l12.1826" class="difflineplus">+</span>
<a href="#l12.1827"></a><span id="l12.1827" class="difflineplus">+</span>
<a href="#l12.1828"></a><span id="l12.1828" class="difflineplus">+  /////////////////////////////////////////////////////////////////</span>
<a href="#l12.1829"></a><span id="l12.1829" class="difflineplus">+  // Finish &amp; dialog close functions</span>
<a href="#l12.1830"></a><span id="l12.1830" class="difflineplus">+</span>
<a href="#l12.1831"></a><span id="l12.1831" class="difflineplus">+  onKeyDown : function(event)</span>
<a href="#l12.1832"></a><span id="l12.1832" class="difflineplus">+  {</span>
<a href="#l12.1833"></a><span id="l12.1833" class="difflineplus">+    let key = event.keyCode;</span>
<a href="#l12.1834"></a><span id="l12.1834" class="difflineplus">+    if (key == 27) { // Escape key</span>
<a href="#l12.1835"></a><span id="l12.1835" class="difflineplus">+      this.onCancel();</span>
<a href="#l12.1836"></a><span id="l12.1836" class="difflineplus">+      return true;</span>
<a href="#l12.1837"></a><span id="l12.1837" class="difflineplus">+    }</span>
<a href="#l12.1838"></a><span id="l12.1838" class="difflineplus">+    if (key == 13) { // OK key</span>
<a href="#l12.1839"></a><span id="l12.1839" class="difflineplus">+      let buttons = [</span>
<a href="#l12.1840"></a><span id="l12.1840" class="difflineplus">+        { id: &quot;next_button&quot;, action: makeCallback(this, this.onNext) },</span>
<a href="#l12.1841"></a><span id="l12.1841" class="difflineplus">+        { id: &quot;create_button&quot;, action: makeCallback(this, this.onCreate) },</span>
<a href="#l12.1842"></a><span id="l12.1842" class="difflineplus">+        { id: &quot;half-manual-test_button&quot;,</span>
<a href="#l12.1843"></a><span id="l12.1843" class="difflineplus">+          action: makeCallback(this, this.onHalfManualTest) },</span>
<a href="#l12.1844"></a><span id="l12.1844" class="difflineplus">+      ];</span>
<a href="#l12.1845"></a><span id="l12.1845" class="difflineplus">+      for each (let button in buttons) {</span>
<a href="#l12.1846"></a><span id="l12.1846" class="difflineplus">+        button.e = e(button.id);</span>
<a href="#l12.1847"></a><span id="l12.1847" class="difflineplus">+        if (button.e.hidden || button.e.disabled) {</span>
<a href="#l12.1848"></a><span id="l12.1848" class="difflineplus">+          continue;</span>
<a href="#l12.1849"></a><span id="l12.1849" class="difflineplus">+        }</span>
<a href="#l12.1850"></a><span id="l12.1850" class="difflineplus">+        button.action();</span>
<a href="#l12.1851"></a><span id="l12.1851" class="difflineplus">+        return true;</span>
<a href="#l12.1852"></a><span id="l12.1852" class="difflineplus">+      }</span>
<a href="#l12.1853"></a><span id="l12.1853">     }</span>
<a href="#l12.1854"></a><span id="l12.1854">     return false;</span>
<a href="#l12.1855"></a><span id="l12.1855">   },</span>
<a href="#l12.1856"></a><span id="l12.1856"> </span>
<a href="#l12.1857"></a><span id="l12.1857" class="difflineminus">-  checkIncomingAccountIsNew : function()</span>
<a href="#l12.1858"></a><span id="l12.1858" class="difflineplus">+  onCancel : function()</span>
<a href="#l12.1859"></a><span id="l12.1859">   {</span>
<a href="#l12.1860"></a><span id="l12.1860" class="difflineminus">-    let incoming = this._currentConfigFilledIn.incoming;</span>
<a href="#l12.1861"></a><span id="l12.1861" class="difflineminus">-    let isNew = gAccountMgr.findRealServer(incoming.username,</span>
<a href="#l12.1862"></a><span id="l12.1862" class="difflineminus">-                                          incoming.hostname,</span>
<a href="#l12.1863"></a><span id="l12.1863" class="difflineminus">-                                          sanitize.enum(incoming.type,</span>
<a href="#l12.1864"></a><span id="l12.1864" class="difflineminus">-                                                        [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]),</span>
<a href="#l12.1865"></a><span id="l12.1865" class="difflineminus">-                                          incoming.port) == null;</span>
<a href="#l12.1866"></a><span id="l12.1866" class="difflineminus">-</span>
<a href="#l12.1867"></a><span id="l12.1867" class="difflineminus">-    // if username does not have an '@', also check the e-mail</span>
<a href="#l12.1868"></a><span id="l12.1868" class="difflineminus">-    // address form of the name.</span>
<a href="#l12.1869"></a><span id="l12.1869" class="difflineminus">-    if (isNew &amp;&amp; incoming.username.indexOf(&quot;@&quot;) &lt; 0) {</span>
<a href="#l12.1870"></a><span id="l12.1870" class="difflineminus">-      return gAccountMgr.findRealServer(this._email,</span>
<a href="#l12.1871"></a><span id="l12.1871" class="difflineminus">-                                        incoming.hostname,</span>
<a href="#l12.1872"></a><span id="l12.1872" class="difflineminus">-                                        sanitize.enum(incoming.type,</span>
<a href="#l12.1873"></a><span id="l12.1873" class="difflineminus">-                                                      [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]),</span>
<a href="#l12.1874"></a><span id="l12.1874" class="difflineminus">-                                        incoming.port) == null;</span>
<a href="#l12.1875"></a><span id="l12.1875" class="difflineminus">-    }</span>
<a href="#l12.1876"></a><span id="l12.1876" class="difflineminus">-    return isNew;</span>
<a href="#l12.1877"></a><span id="l12.1877" class="difflineplus">+    window.close();</span>
<a href="#l12.1878"></a><span id="l12.1878" class="difflineplus">+    // The window onclose handler will call onWizardShutdown for us.</span>
<a href="#l12.1879"></a><span id="l12.1879">   },</span>
<a href="#l12.1880"></a><span id="l12.1880"> </span>
<a href="#l12.1881"></a><span id="l12.1881" class="difflineminus">-  toggleDetails : function (id)</span>
<a href="#l12.1882"></a><span id="l12.1882" class="difflineplus">+  onWizardShutdown : function()</span>
<a href="#l12.1883"></a><span id="l12.1883">   {</span>
<a href="#l12.1884"></a><span id="l12.1884" class="difflineminus">-    let tech = document.getElementById(id+&quot;_technical&quot;);</span>
<a href="#l12.1885"></a><span id="l12.1885" class="difflineminus">-    let details = document.getElementById(id+&quot;_details&quot;);</span>
<a href="#l12.1886"></a><span id="l12.1886" class="difflineminus">-    if (details.getAttribute(&quot;collapsed&quot;)) {</span>
<a href="#l12.1887"></a><span id="l12.1887" class="difflineminus">-      tech.setAttribute(&quot;expanded&quot;, true);</span>
<a href="#l12.1888"></a><span id="l12.1888" class="difflineminus">-      details.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l12.1889"></a><span id="l12.1889" class="difflineplus">+    if (this._abortable) {</span>
<a href="#l12.1890"></a><span id="l12.1890" class="difflineplus">+      this._abortable.cancel(new UserCancelledException());</span>
<a href="#l12.1891"></a><span id="l12.1891">     }</span>
<a href="#l12.1892"></a><span id="l12.1892" class="difflineminus">-    else {</span>
<a href="#l12.1893"></a><span id="l12.1893" class="difflineminus">-      details.setAttribute(&quot;collapsed&quot;, true);</span>
<a href="#l12.1894"></a><span id="l12.1894" class="difflineminus">-      tech.removeAttribute(&quot;expanded&quot;);</span>
<a href="#l12.1895"></a><span id="l12.1895" class="difflineplus">+</span>
<a href="#l12.1896"></a><span id="l12.1896" class="difflineplus">+    if (this._okCallback) {</span>
<a href="#l12.1897"></a><span id="l12.1897" class="difflineplus">+      this._okCallback();</span>
<a href="#l12.1898"></a><span id="l12.1898">     }</span>
<a href="#l12.1899"></a><span id="l12.1899" class="difflineplus">+    gEmailWizardLogger.info(&quot;Shutting down email config dialog&quot;);</span>
<a href="#l12.1900"></a><span id="l12.1900">   },</span>
<a href="#l12.1901"></a><span id="l12.1901"> </span>
<a href="#l12.1902"></a><span id="l12.1902" class="difflineminus">-  toggleAcknowledgeWarning : function()</span>
<a href="#l12.1903"></a><span id="l12.1903" class="difflineminus">-  {</span>
<a href="#l12.1904"></a><span id="l12.1904" class="difflineminus">-    this._warningAcknowledged =</span>
<a href="#l12.1905"></a><span id="l12.1905" class="difflineminus">-      document.getElementById('acknowledge_warning').checked;</span>
<a href="#l12.1906"></a><span id="l12.1906" class="difflineminus">-    this.checkEnableIKnow();</span>
<a href="#l12.1907"></a><span id="l12.1907" class="difflineminus">-  },</span>
<a href="#l12.1908"></a><span id="l12.1908"> </span>
<a href="#l12.1909"></a><span id="l12.1909" class="difflineminus">-  checkEnableIKnow: function()</span>
<a href="#l12.1910"></a><span id="l12.1910" class="difflineminus">-  {</span>
<a href="#l12.1911"></a><span id="l12.1911" class="difflineminus">-    if ((!this._incomingWarning &amp;&amp; !this._outgoingWarning) ||</span>
<a href="#l12.1912"></a><span id="l12.1912" class="difflineminus">-        this._warningAcknowledged)</span>
<a href="#l12.1913"></a><span id="l12.1913" class="difflineminus">-      document.getElementById('iknow').disabled = false;</span>
<a href="#l12.1914"></a><span id="l12.1914" class="difflineminus">-    else</span>
<a href="#l12.1915"></a><span id="l12.1915" class="difflineminus">-      document.getElementById('iknow').disabled = true;</span>
<a href="#l12.1916"></a><span id="l12.1916" class="difflineminus">-  },</span>
<a href="#l12.1917"></a><span id="l12.1917" class="difflineminus">-</span>
<a href="#l12.1918"></a><span id="l12.1918" class="difflineminus">-  onOK : function()</span>
<a href="#l12.1919"></a><span id="l12.1919" class="difflineplus">+  onCreate : function()</span>
<a href="#l12.1920"></a><span id="l12.1920">   {</span>
<a href="#l12.1921"></a><span id="l12.1921">     try {</span>
<a href="#l12.1922"></a><span id="l12.1922" class="difflineminus">-</span>
<a href="#l12.1923"></a><span id="l12.1923" class="difflineminus">-      gEmailWizardLogger.info(&quot;OK/Create button clicked&quot;);</span>
<a href="#l12.1924"></a><span id="l12.1924" class="difflineminus">-</span>
<a href="#l12.1925"></a><span id="l12.1925" class="difflineminus">-      this._password = document.getElementById(&quot;password&quot;).value;</span>
<a href="#l12.1926"></a><span id="l12.1926" class="difflineminus">-      replaceVariables(this._currentConfigFilledIn, this._realname, this._email,</span>
<a href="#l12.1927"></a><span id="l12.1927" class="difflineminus">-                       this._password);</span>
<a href="#l12.1928"></a><span id="l12.1928" class="difflineminus">-      this.updateConfig(this._currentConfigFilledIn);</span>
<a href="#l12.1929"></a><span id="l12.1929" class="difflineplus">+      gEmailWizardLogger.info(&quot;Create button clicked&quot;);</span>
<a href="#l12.1930"></a><span id="l12.1930"> </span>
<a href="#l12.1931"></a><span id="l12.1931" class="difflineminus">-      // we can't check if the account already exists here, because</span>
<a href="#l12.1932"></a><span id="l12.1932" class="difflineminus">-      // we created it to test the password already.</span>
<a href="#l12.1933"></a><span id="l12.1933" class="difflineminus">-      if (this._outgoingWarning || this._incomingWarning)</span>
<a href="#l12.1934"></a><span id="l12.1934" class="difflineminus">-      {</span>
<a href="#l12.1935"></a><span id="l12.1935" class="difflineminus">-        _hide('mastervbox');</span>
<a href="#l12.1936"></a><span id="l12.1936" class="difflineminus">-        _show('warningbox');</span>
<a href="#l12.1937"></a><span id="l12.1937" class="difflineminus">-</span>
<a href="#l12.1938"></a><span id="l12.1938" class="difflineminus">-        let incomingwarningstring;</span>
<a href="#l12.1939"></a><span id="l12.1939" class="difflineminus">-        let outgoingwarningstring;</span>
<a href="#l12.1940"></a><span id="l12.1940" class="difflineminus">-        let incoming_details;</span>
<a href="#l12.1941"></a><span id="l12.1941" class="difflineminus">-        let outgoing_details;</span>
<a href="#l12.1942"></a><span id="l12.1942" class="difflineminus">-        let incoming = this._currentConfigFilledIn.incoming;</span>
<a href="#l12.1943"></a><span id="l12.1943" class="difflineminus">-        let outgoing = this._currentConfigFilledIn.outgoing;</span>
<a href="#l12.1944"></a><span id="l12.1944" class="difflineminus">-        var brandShortName = gBrandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l12.1945"></a><span id="l12.1945" class="difflineminus">-        switch (this._incomingWarning)</span>
<a href="#l12.1946"></a><span id="l12.1946" class="difflineplus">+      var configFilledIn = this.getConcreteConfig();</span>
<a href="#l12.1947"></a><span id="l12.1947" class="difflineplus">+      var self = this;</span>
<a href="#l12.1948"></a><span id="l12.1948" class="difflineplus">+      // If the dialog is not needed, it will go straight to OK callback</span>
<a href="#l12.1949"></a><span id="l12.1949" class="difflineplus">+      gSecurityWarningDialog.open(this._currentConfig, configFilledIn, true,</span>
<a href="#l12.1950"></a><span id="l12.1950" class="difflineplus">+        function() // on OK</span>
<a href="#l12.1951"></a><span id="l12.1951">         {</span>
<a href="#l12.1952"></a><span id="l12.1952" class="difflineminus">-          case 'cleartext':</span>
<a href="#l12.1953"></a><span id="l12.1953" class="difflineminus">-            incomingwarningstring = gStringsBundle.getFormattedString(</span>
<a href="#l12.1954"></a><span id="l12.1954" class="difflineminus">-              &quot;cleartext_warning&quot;, [incoming.hostname]);</span>
<a href="#l12.1955"></a><span id="l12.1955" class="difflineminus">-            incoming_details = gStringsBundle.getString(&quot;cleartext_details&quot;);</span>
<a href="#l12.1956"></a><span id="l12.1956" class="difflineminus">-            setText('warning_incoming', incomingwarningstring);</span>
<a href="#l12.1957"></a><span id="l12.1957" class="difflineminus">-            setText('incoming_details', incoming_details);</span>
<a href="#l12.1958"></a><span id="l12.1958" class="difflineminus">-            _show('incoming_box');</span>
<a href="#l12.1959"></a><span id="l12.1959" class="difflineminus">-            _show('acknowledge_warning');</span>
<a href="#l12.1960"></a><span id="l12.1960" class="difflineminus">-            break;</span>
<a href="#l12.1961"></a><span id="l12.1961" class="difflineminus">-          case 'selfsigned':</span>
<a href="#l12.1962"></a><span id="l12.1962" class="difflineminus">-            incomingwarningstring = gStringsBundle.getFormattedString(</span>
<a href="#l12.1963"></a><span id="l12.1963" class="difflineminus">-              &quot;selfsigned_warning&quot;, [incoming.hostname]);</span>
<a href="#l12.1964"></a><span id="l12.1964" class="difflineminus">-            incoming_details = gStringsBundle.getString(&quot;selfsigned_details&quot;);</span>
<a href="#l12.1965"></a><span id="l12.1965" class="difflineminus">-            setText('warning_incoming', incomingwarningstring);</span>
<a href="#l12.1966"></a><span id="l12.1966" class="difflineminus">-            setText('incoming_details', incoming_details);</span>
<a href="#l12.1967"></a><span id="l12.1967" class="difflineminus">-            _show('incoming_box');</span>
<a href="#l12.1968"></a><span id="l12.1968" class="difflineminus">-            _show('acknowledge_warning');</span>
<a href="#l12.1969"></a><span id="l12.1969" class="difflineminus">-            break;</span>
<a href="#l12.1970"></a><span id="l12.1970" class="difflineminus">-          case '':</span>
<a href="#l12.1971"></a><span id="l12.1971" class="difflineminus">-            _hide('incoming_box');</span>
<a href="#l12.1972"></a><span id="l12.1972" class="difflineminus">-            _hide('acknowledge_warning');</span>
<a href="#l12.1973"></a><span id="l12.1973" class="difflineminus">-        }</span>
<a href="#l12.1974"></a><span id="l12.1974" class="difflineminus">-        switch (this._outgoingWarning)</span>
<a href="#l12.1975"></a><span id="l12.1975" class="difflineminus">-        {</span>
<a href="#l12.1976"></a><span id="l12.1976" class="difflineminus">-          case 'cleartext':</span>
<a href="#l12.1977"></a><span id="l12.1977" class="difflineminus">-            outgoingwarningstring = gStringsBundle.getFormattedString(</span>
<a href="#l12.1978"></a><span id="l12.1978" class="difflineminus">-              &quot;cleartext_warning&quot;, [outgoing.hostname]);</span>
<a href="#l12.1979"></a><span id="l12.1979" class="difflineminus">-            outgoing_details = gStringsBundle.getString(&quot;cleartext_details&quot;);</span>
<a href="#l12.1980"></a><span id="l12.1980" class="difflineminus">-            setText('warning_outgoing', outgoingwarningstring);</span>
<a href="#l12.1981"></a><span id="l12.1981" class="difflineminus">-            setText('outgoing_details', outgoing_details);</span>
<a href="#l12.1982"></a><span id="l12.1982" class="difflineminus">-            _show('outgoing_box');</span>
<a href="#l12.1983"></a><span id="l12.1983" class="difflineminus">-            _show('acknowledge_warning');</span>
<a href="#l12.1984"></a><span id="l12.1984" class="difflineminus">-            break;</span>
<a href="#l12.1985"></a><span id="l12.1985" class="difflineminus">-          case 'selfsigned':</span>
<a href="#l12.1986"></a><span id="l12.1986" class="difflineminus">-            outgoingwarningstring = gStringsBundle.getFormattedString(</span>
<a href="#l12.1987"></a><span id="l12.1987" class="difflineminus">-              &quot;selfsigned_warning&quot;, [outgoing.hostname]);</span>
<a href="#l12.1988"></a><span id="l12.1988" class="difflineminus">-            outgoing_details = gStringsBundle.getString(&quot;selfsigned_details&quot;);</span>
<a href="#l12.1989"></a><span id="l12.1989" class="difflineminus">-            setText('warning_outgoing', outgoingwarningstring);</span>
<a href="#l12.1990"></a><span id="l12.1990" class="difflineminus">-            setText('outgoing_details', outgoing_details);</span>
<a href="#l12.1991"></a><span id="l12.1991" class="difflineminus">-            _show('outgoing_box');</span>
<a href="#l12.1992"></a><span id="l12.1992" class="difflineminus">-            _show('acknowledge_warning');</span>
<a href="#l12.1993"></a><span id="l12.1993" class="difflineminus">-            break;</span>
<a href="#l12.1994"></a><span id="l12.1994" class="difflineminus">-          case '':</span>
<a href="#l12.1995"></a><span id="l12.1995" class="difflineminus">-            _hide('outgoing_box');</span>
<a href="#l12.1996"></a><span id="l12.1996" class="difflineminus">-            if (this._incomingWarning == '')</span>
<a href="#l12.1997"></a><span id="l12.1997" class="difflineminus">-              _hide('acknowledge_warning');</span>
<a href="#l12.1998"></a><span id="l12.1998" class="difflineminus">-        }</span>
<a href="#l12.1999"></a><span id="l12.1999" class="difflineminus">-        window.sizeToContent();</span>
<a href="#l12.2000"></a><span id="l12.2000" class="difflineminus">-      }</span>
<a href="#l12.2001"></a><span id="l12.2001" class="difflineminus">-      else</span>
<a href="#l12.2002"></a><span id="l12.2002" class="difflineminus">-      {</span>
<a href="#l12.2003"></a><span id="l12.2003" class="difflineminus">-        // no certificate or cleartext issues</span>
<a href="#l12.2004"></a><span id="l12.2004" class="difflineminus">-        this.validateAndFinish();</span>
<a href="#l12.2005"></a><span id="l12.2005" class="difflineminus">-      }</span>
<a href="#l12.2006"></a><span id="l12.2006" class="difflineplus">+          self.validateAndFinish(configFilledIn);</span>
<a href="#l12.2007"></a><span id="l12.2007" class="difflineplus">+        },</span>
<a href="#l12.2008"></a><span id="l12.2008" class="difflineplus">+        function() {}); // on cancel, do nothing</span>
<a href="#l12.2009"></a><span id="l12.2009">     } catch (ex) {</span>
<a href="#l12.2010"></a><span id="l12.2010">       gEmailWizardLogger.error(&quot;Error creating account.  ex=&quot; + ex +</span>
<a href="#l12.2011"></a><span id="l12.2011">                                &quot;, stack=&quot; + ex.stack);</span>
<a href="#l12.2012"></a><span id="l12.2012">       alertPrompt(gStringsBundle.getString(&quot;error_creating_account&quot;), ex);</span>
<a href="#l12.2013"></a><span id="l12.2013">     }</span>
<a href="#l12.2014"></a><span id="l12.2014">   },</span>
<a href="#l12.2015"></a><span id="l12.2015"> </span>
<a href="#l12.2016"></a><span id="l12.2016" class="difflineminus">-  getMeOutOfHere : function()</span>
<a href="#l12.2017"></a><span id="l12.2017" class="difflineminus">-  {</span>
<a href="#l12.2018"></a><span id="l12.2018" class="difflineminus">-    // If we're going backwards, we should reset the acknowledge_warning.</span>
<a href="#l12.2019"></a><span id="l12.2019" class="difflineminus">-    document.getElementById('acknowledge_warning').checked = false;</span>
<a href="#l12.2020"></a><span id="l12.2020" class="difflineminus">-    this.toggleAcknowledgeWarning();</span>
<a href="#l12.2021"></a><span id="l12.2021" class="difflineminus">-    document.getElementById(&quot;incoming_technical&quot;).removeAttribute(&quot;expanded&quot;);;</span>
<a href="#l12.2022"></a><span id="l12.2022" class="difflineminus">-    document.getElementById(&quot;incoming_details&quot;).setAttribute(&quot;collapsed&quot;, true);;</span>
<a href="#l12.2023"></a><span id="l12.2023" class="difflineminus">-    document.getElementById(&quot;outgoing_technical&quot;).removeAttribute(&quot;expanded&quot;);;</span>
<a href="#l12.2024"></a><span id="l12.2024" class="difflineminus">-    document.getElementById(&quot;outgoing_details&quot;).setAttribute(&quot;collapsed&quot;, true);;</span>
<a href="#l12.2025"></a><span id="l12.2025" class="difflineminus">-    _hide('warningbox');</span>
<a href="#l12.2026"></a><span id="l12.2026" class="difflineminus">-    _show('mastervbox');</span>
<a href="#l12.2027"></a><span id="l12.2027" class="difflineminus">-    window.sizeToContent();</span>
<a href="#l12.2028"></a><span id="l12.2028" class="difflineminus">-  },</span>
<a href="#l12.2029"></a><span id="l12.2029" class="difflineminus">-</span>
<a href="#l12.2030"></a><span id="l12.2030" class="difflineplus">+  // called by onCreate()</span>
<a href="#l12.2031"></a><span id="l12.2031">   validateAndFinish : function()</span>
<a href="#l12.2032"></a><span id="l12.2032">   {</span>
<a href="#l12.2033"></a><span id="l12.2033" class="difflineminus">-    // if we're coming from the cert warning dialog</span>
<a href="#l12.2034"></a><span id="l12.2034" class="difflineminus">-    _show('mastervbox');</span>
<a href="#l12.2035"></a><span id="l12.2035" class="difflineminus">-    _hide('warningbox');</span>
<a href="#l12.2036"></a><span id="l12.2036" class="difflineminus">-    window.sizeToContent();</span>
<a href="#l12.2037"></a><span id="l12.2037" class="difflineplus">+    var configFilledIn = this.getConcreteConfig();</span>
<a href="#l12.2038"></a><span id="l12.2038"> </span>
<a href="#l12.2039"></a><span id="l12.2039" class="difflineminus">-    if (!this.checkIncomingAccountIsNew())</span>
<a href="#l12.2040"></a><span id="l12.2040" class="difflineminus">-    {</span>
<a href="#l12.2041"></a><span id="l12.2041" class="difflineplus">+    if (checkIncomingServerAlreadyExists(configFilledIn)) {</span>
<a href="#l12.2042"></a><span id="l12.2042">       alertPrompt(gStringsBundle.getString(&quot;error_creating_account&quot;),</span>
<a href="#l12.2043"></a><span id="l12.2043">                   gStringsBundle.getString(&quot;incoming_server_exists&quot;));</span>
<a href="#l12.2044"></a><span id="l12.2044">       return;</span>
<a href="#l12.2045"></a><span id="l12.2045">     }</span>
<a href="#l12.2046"></a><span id="l12.2046"> </span>
<a href="#l12.2047"></a><span id="l12.2047" class="difflineminus">-    // No need to check if we aren't adding it.</span>
<a href="#l12.2048"></a><span id="l12.2048" class="difflineminus">-    if (this._currentConfigFilledIn.outgoing.addThisServer)</span>
<a href="#l12.2049"></a><span id="l12.2049" class="difflineminus">-    {</span>
<a href="#l12.2050"></a><span id="l12.2050" class="difflineminus">-      let existingKey = this.keyForExistingOutgoingAccount();</span>
<a href="#l12.2051"></a><span id="l12.2051" class="difflineminus">-      if (existingKey)</span>
<a href="#l12.2052"></a><span id="l12.2052" class="difflineminus">-      {</span>
<a href="#l12.2053"></a><span id="l12.2053" class="difflineminus">-        this._currentConfigFilledIn.outgoing.addThisServer = false;</span>
<a href="#l12.2054"></a><span id="l12.2054" class="difflineminus">-        this._currentConfigFilledIn.outgoing.existingServerKey = existingKey;</span>
<a href="#l12.2055"></a><span id="l12.2055" class="difflineplus">+    if (configFilledIn.outgoing.addThisServer) {</span>
<a href="#l12.2056"></a><span id="l12.2056" class="difflineplus">+      let existingServer = checkOutgoingServerAlreadyExists(configFilledIn);</span>
<a href="#l12.2057"></a><span id="l12.2057" class="difflineplus">+      if (existingServer) {</span>
<a href="#l12.2058"></a><span id="l12.2058" class="difflineplus">+        configFilledIn.outgoing.addThisServer = false;</span>
<a href="#l12.2059"></a><span id="l12.2059" class="difflineplus">+        configFilledIn.outgoing.existingServerKey = existingServer.key;</span>
<a href="#l12.2060"></a><span id="l12.2060">       }</span>
<a href="#l12.2061"></a><span id="l12.2061">     }</span>
<a href="#l12.2062"></a><span id="l12.2062"> </span>
<a href="#l12.2063"></a><span id="l12.2063" class="difflineminus">-    document.getElementById('create_button').disabled = true;</span>
<a href="#l12.2064"></a><span id="l12.2064" class="difflineminus">-    var me = this;</span>
<a href="#l12.2065"></a><span id="l12.2065" class="difflineminus">-    if (!this._verifiedConfig)</span>
<a href="#l12.2066"></a><span id="l12.2066" class="difflineminus">-      this.verifyConfig(function(successfulConfig) // success</span>
<a href="#l12.2067"></a><span id="l12.2067" class="difflineminus">-                        {</span>
<a href="#l12.2068"></a><span id="l12.2068" class="difflineminus">-                          // the auth might have changed, so we</span>
<a href="#l12.2069"></a><span id="l12.2069" class="difflineminus">-                          // should back-port it to the current config.</span>
<a href="#l12.2070"></a><span id="l12.2070" class="difflineminus">-                          me._currentConfigFilledIn.incoming.auth =</span>
<a href="#l12.2071"></a><span id="l12.2071" class="difflineminus">-                              successfulConfig.incoming.auth;</span>
<a href="#l12.2072"></a><span id="l12.2072" class="difflineminus">-                          me._currentConfigFilledIn.outgoing.auth =</span>
<a href="#l12.2073"></a><span id="l12.2073" class="difflineminus">-                              successfulConfig.outgoing.auth;</span>
<a href="#l12.2074"></a><span id="l12.2074" class="difflineminus">-                          me.finish();</span>
<a href="#l12.2075"></a><span id="l12.2075" class="difflineminus">-                        },</span>
<a href="#l12.2076"></a><span id="l12.2076" class="difflineminus">-                        function(e) // failure</span>
<a href="#l12.2077"></a><span id="l12.2077" class="difflineminus">-                        {</span>
<a href="#l12.2078"></a><span id="l12.2078" class="difflineminus">-                          // Enable the username and password fields, and</span>
<a href="#l12.2079"></a><span id="l12.2079" class="difflineminus">-                          // the create button to re-check.</span>
<a href="#l12.2080"></a><span id="l12.2080" class="difflineminus">-                          document.getElementById(&quot;create_button&quot;).disabled = false;</span>
<a href="#l12.2081"></a><span id="l12.2081" class="difflineminus">-                          document.getElementById(&quot;username&quot;).disabled = false;</span>
<a href="#l12.2082"></a><span id="l12.2082" class="difflineminus">-                          document.getElementById(&quot;password&quot;).disabled = false;</span>
<a href="#l12.2083"></a><span id="l12.2083" class="difflineminus">-                        });</span>
<a href="#l12.2084"></a><span id="l12.2084" class="difflineminus">-    else</span>
<a href="#l12.2085"></a><span id="l12.2085" class="difflineminus">-      this.finish();</span>
<a href="#l12.2086"></a><span id="l12.2086" class="difflineminus">-  },</span>
<a href="#l12.2087"></a><span id="l12.2087" class="difflineminus">-</span>
<a href="#l12.2088"></a><span id="l12.2088" class="difflineminus">-  verifyConfig : function(successCallback, errorCallback)</span>
<a href="#l12.2089"></a><span id="l12.2089" class="difflineminus">-  {</span>
<a href="#l12.2090"></a><span id="l12.2090" class="difflineminus">-    var me = this;</span>
<a href="#l12.2091"></a><span id="l12.2091" class="difflineminus">-    gEmailWizardLogger.info(&quot;Verifying config.&quot;);</span>
<a href="#l12.2092"></a><span id="l12.2092" class="difflineminus">-    this.startSpinner(&quot;username&quot;, &quot;checking_password&quot;);</span>
<a href="#l12.2093"></a><span id="l12.2093" class="difflineminus">-</span>
<a href="#l12.2094"></a><span id="l12.2094" class="difflineplus">+    // TODO use a UI mode (switchToMode()) for verfication, too.</span>
<a href="#l12.2095"></a><span id="l12.2095" class="difflineplus">+    // But we need to go back to the previous mode, because we might be in</span>
<a href="#l12.2096"></a><span id="l12.2096" class="difflineplus">+    // &quot;result&quot; or &quot;manual-edit-complete&quot; mode.</span>
<a href="#l12.2097"></a><span id="l12.2097" class="difflineplus">+    _disable(&quot;create_button&quot;);</span>
<a href="#l12.2098"></a><span id="l12.2098" class="difflineplus">+    _disable(&quot;half-manual-test_button&quot;);</span>
<a href="#l12.2099"></a><span id="l12.2099" class="difflineplus">+    _disable(&quot;advanced-setup_button&quot;);</span>
<a href="#l12.2100"></a><span id="l12.2100" class="difflineplus">+    // no stop button: backend has no ability to stop :-(</span>
<a href="#l12.2101"></a><span id="l12.2101" class="difflineplus">+    var self = this;</span>
<a href="#l12.2102"></a><span id="l12.2102" class="difflineplus">+    this.startSpinner(&quot;checking_password&quot;);</span>
<a href="#l12.2103"></a><span id="l12.2103">     // logic function defined in verifyConfig.js</span>
<a href="#l12.2104"></a><span id="l12.2104">     verifyConfig(</span>
<a href="#l12.2105"></a><span id="l12.2105" class="difflineminus">-      this._currentConfigFilledIn,</span>
<a href="#l12.2106"></a><span id="l12.2106" class="difflineplus">+      configFilledIn,</span>
<a href="#l12.2107"></a><span id="l12.2107">       // guess login config?</span>
<a href="#l12.2108"></a><span id="l12.2108" class="difflineminus">-      this._currentConfigFilledIn.source != AccountConfig.kSourceXML,</span>
<a href="#l12.2109"></a><span id="l12.2109" class="difflineplus">+      configFilledIn.source != AccountConfig.kSourceXML,</span>
<a href="#l12.2110"></a><span id="l12.2110" class="difflineplus">+      // TODO Instead, the following line would be correct, but I cannot use it,</span>
<a href="#l12.2111"></a><span id="l12.2111" class="difflineplus">+      // because some other code doesn't adhere to the expectations/specs.</span>
<a href="#l12.2112"></a><span id="l12.2112" class="difflineplus">+      // Find out what it was and fix it.</span>
<a href="#l12.2113"></a><span id="l12.2113" class="difflineplus">+      //concreteConfig.source == AccountConfig.kSourceGuess,</span>
<a href="#l12.2114"></a><span id="l12.2114">       this._parentMsgWindow,</span>
<a href="#l12.2115"></a><span id="l12.2115" class="difflineminus">-      function(successfulServer) // success</span>
<a href="#l12.2116"></a><span id="l12.2116" class="difflineplus">+      function(successfulConfig) // success</span>
<a href="#l12.2117"></a><span id="l12.2117">       {</span>
<a href="#l12.2118"></a><span id="l12.2118" class="difflineminus">-        me._verifiedConfig = true;</span>
<a href="#l12.2119"></a><span id="l12.2119" class="difflineminus">-        if (me._currentConfigFilledIn.incoming.password)</span>
<a href="#l12.2120"></a><span id="l12.2120" class="difflineminus">-          me.stopSpinner(&quot;password_ok&quot;);</span>
<a href="#l12.2121"></a><span id="l12.2121" class="difflineminus">-        if (successCallback)</span>
<a href="#l12.2122"></a><span id="l12.2122" class="difflineminus">-          successCallback(successfulServer);</span>
<a href="#l12.2123"></a><span id="l12.2123" class="difflineplus">+        self.stopSpinner(successfulConfig.incoming.password ?</span>
<a href="#l12.2124"></a><span id="l12.2124" class="difflineplus">+                         &quot;password_ok&quot; : null);</span>
<a href="#l12.2125"></a><span id="l12.2125" class="difflineplus">+</span>
<a href="#l12.2126"></a><span id="l12.2126" class="difflineplus">+        // the auth might have changed, so we</span>
<a href="#l12.2127"></a><span id="l12.2127" class="difflineplus">+        // should back-port it to the current config.</span>
<a href="#l12.2128"></a><span id="l12.2128" class="difflineplus">+        self._currentConfig.incoming.auth = successfulConfig.incoming.auth;</span>
<a href="#l12.2129"></a><span id="l12.2129" class="difflineplus">+        self._currentConfig.outgoing.auth = successfulConfig.outgoing.auth;</span>
<a href="#l12.2130"></a><span id="l12.2130" class="difflineplus">+        self.finish();</span>
<a href="#l12.2131"></a><span id="l12.2131">       },</span>
<a href="#l12.2132"></a><span id="l12.2132">       function(e) // failed</span>
<a href="#l12.2133"></a><span id="l12.2133">       {</span>
<a href="#l12.2134"></a><span id="l12.2134" class="difflineminus">-        me.stopSpinner(&quot;config_unverifiable&quot;);</span>
<a href="#l12.2135"></a><span id="l12.2135" class="difflineminus">-        me._updateSpinner(&quot;username&quot;, true);</span>
<a href="#l12.2136"></a><span id="l12.2136" class="difflineminus">-        me.setError('passworderror', 'user_pass_invalid');</span>
<a href="#l12.2137"></a><span id="l12.2137" class="difflineminus">-        if (errorCallback)</span>
<a href="#l12.2138"></a><span id="l12.2138" class="difflineminus">-          errorCallback(e);</span>
<a href="#l12.2139"></a><span id="l12.2139" class="difflineplus">+        self.showErrorStatus(&quot;config_unverifiable&quot;);</span>
<a href="#l12.2140"></a><span id="l12.2140" class="difflineplus">+        // TODO bug 555448: wrong error msg, there may be a 1000 other</span>
<a href="#l12.2141"></a><span id="l12.2141" class="difflineplus">+        // reasons why this failed, and this is misleading users.</span>
<a href="#l12.2142"></a><span id="l12.2142" class="difflineplus">+        self.setError(&quot;passworderror&quot;, &quot;user_pass_invalid&quot;);</span>
<a href="#l12.2143"></a><span id="l12.2143" class="difflineplus">+        // TODO use switchToMode(), see above</span>
<a href="#l12.2144"></a><span id="l12.2144" class="difflineplus">+        // give user something to proceed after fixing</span>
<a href="#l12.2145"></a><span id="l12.2145" class="difflineplus">+        _enable(&quot;create_button&quot;);</span>
<a href="#l12.2146"></a><span id="l12.2146" class="difflineplus">+        // hidden in non-manual mode, so it's fine to enable</span>
<a href="#l12.2147"></a><span id="l12.2147" class="difflineplus">+        _enable(&quot;half-manual-test_button&quot;);</span>
<a href="#l12.2148"></a><span id="l12.2148" class="difflineplus">+        _enable(&quot;advanced-setup_button&quot;);</span>
<a href="#l12.2149"></a><span id="l12.2149">       });</span>
<a href="#l12.2150"></a><span id="l12.2150">   },</span>
<a href="#l12.2151"></a><span id="l12.2151"> </span>
<a href="#l12.2152"></a><span id="l12.2152">   finish : function()</span>
<a href="#l12.2153"></a><span id="l12.2153">   {</span>
<a href="#l12.2154"></a><span id="l12.2154">     gEmailWizardLogger.info(&quot;creating account in backend&quot;);</span>
<a href="#l12.2155"></a><span id="l12.2155" class="difflineminus">-    this._currentConfigFilledIn.rememberPassword =</span>
<a href="#l12.2156"></a><span id="l12.2156" class="difflineminus">-      document.getElementById(&quot;remember_password&quot;).checked;</span>
<a href="#l12.2157"></a><span id="l12.2157" class="difflineminus">-    createAccountInBackend(this._currentConfigFilledIn);</span>
<a href="#l12.2158"></a><span id="l12.2158" class="difflineminus">-    window.close();</span>
<a href="#l12.2159"></a><span id="l12.2159" class="difflineminus">-  },</span>
<a href="#l12.2160"></a><span id="l12.2160" class="difflineminus">-</span>
<a href="#l12.2161"></a><span id="l12.2161" class="difflineminus">-  advancedSettings : function()</span>
<a href="#l12.2162"></a><span id="l12.2162" class="difflineminus">-  {</span>
<a href="#l12.2163"></a><span id="l12.2163" class="difflineminus">-    let shouldEraseConfig = !this._currentConfigFilledIn;</span>
<a href="#l12.2164"></a><span id="l12.2164" class="difflineminus">-    let config = this.getUserConfig();</span>
<a href="#l12.2165"></a><span id="l12.2165" class="difflineminus">-    this._currentConfigFilledIn = config.copy();</span>
<a href="#l12.2166"></a><span id="l12.2166" class="difflineminus">-</span>
<a href="#l12.2167"></a><span id="l12.2167" class="difflineminus">-    // call this to set the password</span>
<a href="#l12.2168"></a><span id="l12.2168" class="difflineminus">-    replaceVariables(config, this._realname, this._email, this._password);</span>
<a href="#l12.2169"></a><span id="l12.2169" class="difflineminus">-</span>
<a href="#l12.2170"></a><span id="l12.2170" class="difflineminus">-    if (!this.checkIncomingAccountIsNew()) {</span>
<a href="#l12.2171"></a><span id="l12.2171" class="difflineminus">-      alertPrompt(gStringsBundle.getString(&quot;error_creating_account&quot;),</span>
<a href="#l12.2172"></a><span id="l12.2172" class="difflineminus">-                  gStringsBundle.getString(&quot;incoming_server_exists&quot;));</span>
<a href="#l12.2173"></a><span id="l12.2173" class="difflineminus">-      if (shouldEraseConfig)</span>
<a href="#l12.2174"></a><span id="l12.2174" class="difflineminus">-        this._currentConfigFilledIn = null;</span>
<a href="#l12.2175"></a><span id="l12.2175" class="difflineminus">-      return;</span>
<a href="#l12.2176"></a><span id="l12.2176" class="difflineminus">-    }</span>
<a href="#l12.2177"></a><span id="l12.2177" class="difflineminus">-</span>
<a href="#l12.2178"></a><span id="l12.2178" class="difflineminus">-    gEmailWizardLogger.info(&quot;creating account in backend&quot;);</span>
<a href="#l12.2179"></a><span id="l12.2179" class="difflineminus">-    config.rememberPassword =</span>
<a href="#l12.2180"></a><span id="l12.2180" class="difflineminus">-      document.getElementById(&quot;remember_password&quot;).checked;</span>
<a href="#l12.2181"></a><span id="l12.2181" class="difflineminus">-    var newAccount = createAccountInBackend(config);</span>
<a href="#l12.2182"></a><span id="l12.2182" class="difflineminus">-    var windowManager =</span>
<a href="#l12.2183"></a><span id="l12.2183" class="difflineminus">-      Components.classes['@mozilla.org/appshell/window-mediator;1']</span>
<a href="#l12.2184"></a><span id="l12.2184" class="difflineminus">-                .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l12.2185"></a><span id="l12.2185" class="difflineminus">-</span>
<a href="#l12.2186"></a><span id="l12.2186" class="difflineminus">-    var existingAccountManager =</span>
<a href="#l12.2187"></a><span id="l12.2187" class="difflineminus">-      windowManager.getMostRecentWindow(&quot;mailnews:accountmanager&quot;);</span>
<a href="#l12.2188"></a><span id="l12.2188" class="difflineminus">-</span>
<a href="#l12.2189"></a><span id="l12.2189" class="difflineminus">-    if (existingAccountManager)</span>
<a href="#l12.2190"></a><span id="l12.2190" class="difflineminus">-      existingAccountManager.focus();</span>
<a href="#l12.2191"></a><span id="l12.2191" class="difflineminus">-    else</span>
<a href="#l12.2192"></a><span id="l12.2192" class="difflineminus">-      window.openDialog(&quot;chrome://messenger/content/AccountManager.xul&quot;,</span>
<a href="#l12.2193"></a><span id="l12.2193" class="difflineminus">-                        &quot;AccountManager&quot;, &quot;chrome,centerscreen,modal,titlebar&quot;,</span>
<a href="#l12.2194"></a><span id="l12.2194" class="difflineminus">-                        { server: newAccount.incomingServer,</span>
<a href="#l12.2195"></a><span id="l12.2195" class="difflineminus">-                          selectPage: 'am-server.xul' });</span>
<a href="#l12.2196"></a><span id="l12.2196" class="difflineplus">+    createAccountInBackend(this.getConcreteConfig());</span>
<a href="#l12.2197"></a><span id="l12.2197">     window.close();</span>
<a href="#l12.2198"></a><span id="l12.2198">   },</span>
<a href="#l12.2199"></a><span id="l12.2199" class="difflineminus">-  /**</span>
<a href="#l12.2200"></a><span id="l12.2200" class="difflineminus">-   * Gets the values that the user edited in the right of the dialog.</span>
<a href="#l12.2201"></a><span id="l12.2201" class="difflineminus">-   */</span>
<a href="#l12.2202"></a><span id="l12.2202" class="difflineminus">-  getUserConfig : function()</span>
<a href="#l12.2203"></a><span id="l12.2203" class="difflineminus">-  {</span>
<a href="#l12.2204"></a><span id="l12.2204" class="difflineminus">-    var config = this._currentConfig;</span>
<a href="#l12.2205"></a><span id="l12.2205" class="difflineminus">-    if (!config)</span>
<a href="#l12.2206"></a><span id="l12.2206" class="difflineminus">-      config = new AccountConfig();</span>
<a href="#l12.2207"></a><span id="l12.2207" class="difflineminus">-</span>
<a href="#l12.2208"></a><span id="l12.2208" class="difflineminus">-    config.source = AccountConfig.kSourceGuess;</span>
<a href="#l12.2209"></a><span id="l12.2209" class="difflineminus">-</span>
<a href="#l12.2210"></a><span id="l12.2210" class="difflineminus">-    // Did the user select one of the already configured SMTP servers from the</span>
<a href="#l12.2211"></a><span id="l12.2211" class="difflineminus">-    // drop-down list? If so, use it.</span>
<a href="#l12.2212"></a><span id="l12.2212" class="difflineminus">-    if (this._userPickedOutgoingServer)</span>
<a href="#l12.2213"></a><span id="l12.2213" class="difflineminus">-    {</span>
<a href="#l12.2214"></a><span id="l12.2214" class="difflineminus">-      config.outgoing.addThisServer = false;</span>
<a href="#l12.2215"></a><span id="l12.2215" class="difflineminus">-      config.outgoing.existingServerKey =</span>
<a href="#l12.2216"></a><span id="l12.2216" class="difflineminus">-        document.getElementById(&quot;outgoing_server&quot;).selectedItem.value;</span>
<a href="#l12.2217"></a><span id="l12.2217" class="difflineminus">-      config.outgoing.existingServerLabel =</span>
<a href="#l12.2218"></a><span id="l12.2218" class="difflineminus">-        document.getElementById(&quot;outgoing_server&quot;).selectedItem.label;</span>
<a href="#l12.2219"></a><span id="l12.2219" class="difflineminus">-    }</span>
<a href="#l12.2220"></a><span id="l12.2220" class="difflineminus">-    else</span>
<a href="#l12.2221"></a><span id="l12.2221" class="difflineminus">-    {</span>
<a href="#l12.2222"></a><span id="l12.2222" class="difflineminus">-      if (!config.outgoing.username)</span>
<a href="#l12.2223"></a><span id="l12.2223" class="difflineminus">-        config.outgoing.username = document.getElementById(&quot;username&quot;).value;</span>
<a href="#l12.2224"></a><span id="l12.2224" class="difflineminus">-      config.outgoing.hostname =</span>
<a href="#l12.2225"></a><span id="l12.2225" class="difflineminus">-        sanitize.hostname(document.getElementById(&quot;outgoing_server&quot;).value);</span>
<a href="#l12.2226"></a><span id="l12.2226" class="difflineminus">-      document.getElementById(&quot;outgoing_server&quot;).value =</span>
<a href="#l12.2227"></a><span id="l12.2227" class="difflineminus">-        config.outgoing.hostname;</span>
<a href="#l12.2228"></a><span id="l12.2228" class="difflineminus">-      config.outgoing.port =</span>
<a href="#l12.2229"></a><span id="l12.2229" class="difflineminus">-        sanitize.integerRange(document.getElementById(&quot;outgoing_port&quot;).value, 1,</span>
<a href="#l12.2230"></a><span id="l12.2230" class="difflineminus">-                              kHighestPort);</span>
<a href="#l12.2231"></a><span id="l12.2231" class="difflineminus">-      config.outgoing.socketType =</span>
<a href="#l12.2232"></a><span id="l12.2232" class="difflineminus">-        parseInt(document.getElementById(&quot;outgoing_security&quot;).value);</span>
<a href="#l12.2233"></a><span id="l12.2233" class="difflineminus">-    }</span>
<a href="#l12.2234"></a><span id="l12.2234" class="difflineminus">-    config.incoming.username = document.getElementById(&quot;username&quot;).value;</span>
<a href="#l12.2235"></a><span id="l12.2235" class="difflineminus">-    config.incoming.hostname =</span>
<a href="#l12.2236"></a><span id="l12.2236" class="difflineminus">-      sanitize.hostname(document.getElementById(&quot;incoming_server&quot;).value);</span>
<a href="#l12.2237"></a><span id="l12.2237" class="difflineminus">-    document.getElementById(&quot;incoming_server&quot;).value = config.incoming.hostname;</span>
<a href="#l12.2238"></a><span id="l12.2238" class="difflineminus">-    config.incoming.port =</span>
<a href="#l12.2239"></a><span id="l12.2239" class="difflineminus">-      sanitize.integerRange(document.getElementById(&quot;incoming_port&quot;).value, 1,</span>
<a href="#l12.2240"></a><span id="l12.2240" class="difflineminus">-                            kHighestPort);</span>
<a href="#l12.2241"></a><span id="l12.2241" class="difflineminus">-    config.incoming.type =</span>
<a href="#l12.2242"></a><span id="l12.2242" class="difflineminus">-      document.getElementById(&quot;incoming_protocol&quot;).value == 1 ? &quot;imap&quot; : &quot;pop3&quot;;</span>
<a href="#l12.2243"></a><span id="l12.2243" class="difflineminus">-    // type is a string, &quot;imap&quot; or &quot;pop3&quot;, protocol is a protocol type.</span>
<a href="#l12.2244"></a><span id="l12.2244" class="difflineminus">-    config.incoming.protocol = sanitize.translate(config.incoming.type, { &quot;imap&quot; : 0, &quot;pop3&quot; : 1});</span>
<a href="#l12.2245"></a><span id="l12.2245" class="difflineminus">-    config.incoming.socketType =</span>
<a href="#l12.2246"></a><span id="l12.2246" class="difflineminus">-      parseInt(document.getElementById(&quot;incoming_security&quot;).value);</span>
<a href="#l12.2247"></a><span id="l12.2247" class="difflineminus">-</span>
<a href="#l12.2248"></a><span id="l12.2248" class="difflineminus">-    return config;</span>
<a href="#l12.2249"></a><span id="l12.2249" class="difflineminus">-  },</span>
<a href="#l12.2250"></a><span id="l12.2250" class="difflineminus">-</span>
<a href="#l12.2251"></a><span id="l12.2251" class="difflineminus">-  _setIncomingStatus : function(state, details)</span>
<a href="#l12.2252"></a><span id="l12.2252" class="difflineminus">-  {</span>
<a href="#l12.2253"></a><span id="l12.2253" class="difflineminus">-    if (!details)</span>
<a href="#l12.2254"></a><span id="l12.2254" class="difflineminus">-      details = &quot;&quot;;</span>
<a href="#l12.2255"></a><span id="l12.2255" class="difflineminus">-</span>
<a href="#l12.2256"></a><span id="l12.2256" class="difflineminus">-    switch (state)</span>
<a href="#l12.2257"></a><span id="l12.2257" class="difflineminus">-    {</span>
<a href="#l12.2258"></a><span id="l12.2258" class="difflineminus">-      case 'strong':</span>
<a href="#l12.2259"></a><span id="l12.2259" class="difflineminus">-        this._incomingState = 'done';</span>
<a href="#l12.2260"></a><span id="l12.2260" class="difflineminus">-        this._incomingWarning = '';</span>
<a href="#l12.2261"></a><span id="l12.2261" class="difflineminus">-        // fall through</span>
<a href="#l12.2262"></a><span id="l12.2262" class="difflineminus">-      case 'weak':</span>
<a href="#l12.2263"></a><span id="l12.2263" class="difflineminus">-        this._incomingWarning = details;</span>
<a href="#l12.2264"></a><span id="l12.2264" class="difflineminus">-        this._warningAcknowledged = false;</span>
<a href="#l12.2265"></a><span id="l12.2265" class="difflineminus">-        break;</span>
<a href="#l12.2266"></a><span id="l12.2266" class="difflineminus">-      default:</span>
<a href="#l12.2267"></a><span id="l12.2267" class="difflineminus">-        this._incomingState = state;</span>
<a href="#l12.2268"></a><span id="l12.2268" class="difflineminus">-    }</span>
<a href="#l12.2269"></a><span id="l12.2269" class="difflineminus">-    // since we look for SSL/TLS first, if we get 'weak', we're</span>
<a href="#l12.2270"></a><span id="l12.2270" class="difflineminus">-    // stuck with it, and might as well admit we're done.</span>
<a href="#l12.2271"></a><span id="l12.2271" class="difflineminus">-    if (state == 'weak')</span>
<a href="#l12.2272"></a><span id="l12.2272" class="difflineminus">-      this._incomingState = 'done';</span>
<a href="#l12.2273"></a><span id="l12.2273" class="difflineminus">-</span>
<a href="#l12.2274"></a><span id="l12.2274" class="difflineminus">-    this._setIconAndTooltip('incoming', state, details);</span>
<a href="#l12.2275"></a><span id="l12.2275" class="difflineminus">-  },</span>
<a href="#l12.2276"></a><span id="l12.2276" class="difflineminus">-</span>
<a href="#l12.2277"></a><span id="l12.2277" class="difflineminus">-  _setOutgoingStatus: function(state, details)</span>
<a href="#l12.2278"></a><span id="l12.2278" class="difflineminus">-  {</span>
<a href="#l12.2279"></a><span id="l12.2279" class="difflineminus">-    if (!details)</span>
<a href="#l12.2280"></a><span id="l12.2280" class="difflineminus">-      details = '';</span>
<a href="#l12.2281"></a><span id="l12.2281" class="difflineminus">-</span>
<a href="#l12.2282"></a><span id="l12.2282" class="difflineminus">-    if (this._userPickedOutgoingServer)</span>
<a href="#l12.2283"></a><span id="l12.2283" class="difflineminus">-      return;</span>
<a href="#l12.2284"></a><span id="l12.2284" class="difflineminus">-</span>
<a href="#l12.2285"></a><span id="l12.2285" class="difflineminus">-    switch (state)</span>
<a href="#l12.2286"></a><span id="l12.2286" class="difflineminus">-    {</span>
<a href="#l12.2287"></a><span id="l12.2287" class="difflineminus">-      case 'strong':</span>
<a href="#l12.2288"></a><span id="l12.2288" class="difflineminus">-        this._outgoingState = 'done';</span>
<a href="#l12.2289"></a><span id="l12.2289" class="difflineminus">-        this._outgoingWarning = '';</span>
<a href="#l12.2290"></a><span id="l12.2290" class="difflineminus">-        // fall through</span>
<a href="#l12.2291"></a><span id="l12.2291" class="difflineminus">-      case 'weak':</span>
<a href="#l12.2292"></a><span id="l12.2292" class="difflineminus">-        this._outgoingWarning = details;</span>
<a href="#l12.2293"></a><span id="l12.2293" class="difflineminus">-        this._warningAcknowledged = false;</span>
<a href="#l12.2294"></a><span id="l12.2294" class="difflineminus">-        break</span>
<a href="#l12.2295"></a><span id="l12.2295" class="difflineminus">-      default:</span>
<a href="#l12.2296"></a><span id="l12.2296" class="difflineminus">-        this._outgoingState = state;</span>
<a href="#l12.2297"></a><span id="l12.2297" class="difflineminus">-    }</span>
<a href="#l12.2298"></a><span id="l12.2298" class="difflineminus">-    // since we look for SSL/TLS first, if we get 'weak', we're</span>
<a href="#l12.2299"></a><span id="l12.2299" class="difflineminus">-    // stuck with it, and might as well admit we're done.</span>
<a href="#l12.2300"></a><span id="l12.2300" class="difflineminus">-    if (state == 'weak')</span>
<a href="#l12.2301"></a><span id="l12.2301" class="difflineminus">-      this._outgoingState = 'done';</span>
<a href="#l12.2302"></a><span id="l12.2302" class="difflineminus">-</span>
<a href="#l12.2303"></a><span id="l12.2303" class="difflineminus">-    this._setIconAndTooltip('outgoing', state, details);</span>
<a href="#l12.2304"></a><span id="l12.2304" class="difflineminus">-  },</span>
<a href="#l12.2305"></a><span id="l12.2305" class="difflineminus">-</span>
<a href="#l12.2306"></a><span id="l12.2306" class="difflineminus">-  _setIconAndTooltip : function(id, state, details)</span>
<a href="#l12.2307"></a><span id="l12.2307" class="difflineminus">-  {</span>
<a href="#l12.2308"></a><span id="l12.2308" class="difflineminus">-    gEmailWizardLogger.warn(id + &quot; setting icon and tooltip &quot; +</span>
<a href="#l12.2309"></a><span id="l12.2309" class="difflineminus">-                            state + &quot;:&quot; + details);</span>
<a href="#l12.2310"></a><span id="l12.2310" class="difflineminus">-    let icon = document.getElementById(id + &quot;_status&quot;);</span>
<a href="#l12.2311"></a><span id="l12.2311" class="difflineminus">-    icon.setAttribute(&quot;state&quot;, state);</span>
<a href="#l12.2312"></a><span id="l12.2312" class="difflineminus">-    switch (state)</span>
<a href="#l12.2313"></a><span id="l12.2313" class="difflineminus">-    {</span>
<a href="#l12.2314"></a><span id="l12.2314" class="difflineminus">-      case &quot;weak&quot;:</span>
<a href="#l12.2315"></a><span id="l12.2315" class="difflineminus">-        icon.setAttribute(&quot;tooltip&quot;, &quot;insecureserver-&quot; + details);</span>
<a href="#l12.2316"></a><span id="l12.2316" class="difflineminus">-        icon.setAttribute(&quot;popup&quot;, &quot;insecureserver-&quot; + details + &quot;-panel&quot;);</span>
<a href="#l12.2317"></a><span id="l12.2317" class="difflineminus">-        this._updateSpinner(id, true);</span>
<a href="#l12.2318"></a><span id="l12.2318" class="difflineminus">-        break;</span>
<a href="#l12.2319"></a><span id="l12.2319" class="difflineminus">-      case &quot;hidden&quot;:</span>
<a href="#l12.2320"></a><span id="l12.2320" class="difflineminus">-        icon.removeAttribute(&quot;tooltip&quot;);</span>
<a href="#l12.2321"></a><span id="l12.2321" class="difflineminus">-        icon.removeAttribute(&quot;popup&quot;);</span>
<a href="#l12.2322"></a><span id="l12.2322" class="difflineminus">-        this._updateSpinner(id, false);</span>
<a href="#l12.2323"></a><span id="l12.2323" class="difflineminus">-        break;</span>
<a href="#l12.2324"></a><span id="l12.2324" class="difflineminus">-      case &quot;strong&quot;:</span>
<a href="#l12.2325"></a><span id="l12.2325" class="difflineminus">-        icon.setAttribute(&quot;tooltip&quot;, &quot;secureservertooltip&quot;);</span>
<a href="#l12.2326"></a><span id="l12.2326" class="difflineminus">-        icon.setAttribute(&quot;popup&quot;, &quot;secureserver-panel&quot;);</span>
<a href="#l12.2327"></a><span id="l12.2327" class="difflineminus">-        this._updateSpinner(id, true);</span>
<a href="#l12.2328"></a><span id="l12.2328" class="difflineminus">-        break;</span>
<a href="#l12.2329"></a><span id="l12.2329" class="difflineminus">-      case &quot;failed&quot;:</span>
<a href="#l12.2330"></a><span id="l12.2330" class="difflineminus">-        icon.removeAttribute(&quot;tooltip&quot;);</span>
<a href="#l12.2331"></a><span id="l12.2331" class="difflineminus">-        icon.removeAttribute(&quot;popup&quot;);</span>
<a href="#l12.2332"></a><span id="l12.2332" class="difflineminus">-        this._updateSpinner(id, true);</span>
<a href="#l12.2333"></a><span id="l12.2333" class="difflineminus">-        break;</span>
<a href="#l12.2334"></a><span id="l12.2334" class="difflineminus">-    }</span>
<a href="#l12.2335"></a><span id="l12.2335" class="difflineminus">-  },</span>
<a href="#l12.2336"></a><span id="l12.2336" class="difflineminus">-</span>
<a href="#l12.2337"></a><span id="l12.2337" class="difflineminus">-  showConfigDetails : function()</span>
<a href="#l12.2338"></a><span id="l12.2338" class="difflineminus">-  {</span>
<a href="#l12.2339"></a><span id="l12.2339" class="difflineminus">-    // show the config details area</span>
<a href="#l12.2340"></a><span id="l12.2340" class="difflineminus">-    _show(&quot;settingsbox&quot;);</span>
<a href="#l12.2341"></a><span id="l12.2341" class="difflineminus">-    // also show the create button because it's outside of the area</span>
<a href="#l12.2342"></a><span id="l12.2342" class="difflineminus">-    _show(&quot;create_button&quot;);</span>
<a href="#l12.2343"></a><span id="l12.2343" class="difflineminus">-  },</span>
<a href="#l12.2344"></a><span id="l12.2344" class="difflineminus">-</span>
<a href="#l12.2345"></a><span id="l12.2345" class="difflineminus">-  hideConfigDetails : function()</span>
<a href="#l12.2346"></a><span id="l12.2346" class="difflineminus">-  {</span>
<a href="#l12.2347"></a><span id="l12.2347" class="difflineminus">-    _hide(&quot;settingsbox&quot;);</span>
<a href="#l12.2348"></a><span id="l12.2348" class="difflineminus">-    document.getElementById(&quot;create_button&quot;).disabled = true;</span>
<a href="#l12.2349"></a><span id="l12.2349" class="difflineminus">-    _hide(&quot;create_button&quot;);</span>
<a href="#l12.2350"></a><span id="l12.2350" class="difflineminus">-  },</span>
<a href="#l12.2351"></a><span id="l12.2351" class="difflineminus">-</span>
<a href="#l12.2352"></a><span id="l12.2352" class="difflineminus">-  /* Clears out the config details information, this is really only meant to be</span>
<a href="#l12.2353"></a><span id="l12.2353" class="difflineminus">-   * called from the (Back) button.</span>
<a href="#l12.2354"></a><span id="l12.2354" class="difflineminus">-   * XXX This can destroy user input where it might not be necessary</span>
<a href="#l12.2355"></a><span id="l12.2355" class="difflineminus">-   */</span>
<a href="#l12.2356"></a><span id="l12.2356" class="difflineminus">-  clearConfigDetails : function()</span>
<a href="#l12.2357"></a><span id="l12.2357" class="difflineminus">-  {</span>
<a href="#l12.2358"></a><span id="l12.2358" class="difflineminus">-    for (let i = 0; i &lt; this._configDetailTextInputs.length; i++ )</span>
<a href="#l12.2359"></a><span id="l12.2359" class="difflineminus">-    {</span>
<a href="#l12.2360"></a><span id="l12.2360" class="difflineminus">-      document.getElementById(this._configDetailTextInputs[i]).value = &quot;&quot;;</span>
<a href="#l12.2361"></a><span id="l12.2361" class="difflineminus">-    }</span>
<a href="#l12.2362"></a><span id="l12.2362" class="difflineminus">-</span>
<a href="#l12.2363"></a><span id="l12.2363" class="difflineminus">-    this._setIncomingStatus('hidden');</span>
<a href="#l12.2364"></a><span id="l12.2364" class="difflineminus">-    this._setOutgoingStatus('hidden');</span>
<a href="#l12.2365"></a><span id="l12.2365" class="difflineminus">-  },</span>
<a href="#l12.2366"></a><span id="l12.2366" class="difflineminus">-</span>
<a href="#l12.2367"></a><span id="l12.2367" class="difflineminus">-  /* Setting the config details form so it can be edited.  We also disable</span>
<a href="#l12.2368"></a><span id="l12.2368" class="difflineminus">-   * (and hide) the create button during this time because we don't know what</span>
<a href="#l12.2369"></a><span id="l12.2369" class="difflineminus">-   * might have changed.  The function called from the button that restarts</span>
<a href="#l12.2370"></a><span id="l12.2370" class="difflineminus">-   * the config check should be enabling the config button as needed.</span>
<a href="#l12.2371"></a><span id="l12.2371" class="difflineminus">-   */</span>
<a href="#l12.2372"></a><span id="l12.2372" class="difflineminus">-  editConfigDetails : function()</span>
<a href="#l12.2373"></a><span id="l12.2373" class="difflineminus">-  {</span>
<a href="#l12.2374"></a><span id="l12.2374" class="difflineminus">-    gEmailWizardLogger.info(&quot;onEdit&quot;);</span>
<a href="#l12.2375"></a><span id="l12.2375" class="difflineminus">-    // Add the custom entry to the menulist, if it's not already there.</span>
<a href="#l12.2376"></a><span id="l12.2376" class="difflineminus">-    let menulist = document.getElementById(&quot;outgoing_server&quot;);</span>
<a href="#l12.2377"></a><span id="l12.2377" class="difflineminus">-    if (this._smtpServerCount == menulist.itemCount) {</span>
<a href="#l12.2378"></a><span id="l12.2378" class="difflineminus">-      var hostname = document.getElementById(&quot;outgoing_server&quot;).value;</span>
<a href="#l12.2379"></a><span id="l12.2379" class="difflineminus">-      let menuitem = menulist.insertItemAt(0, hostname, hostname);</span>
<a href="#l12.2380"></a><span id="l12.2380" class="difflineminus">-      menuitem.hostname = hostname;</span>
<a href="#l12.2381"></a><span id="l12.2381" class="difflineminus">-    }</span>
<a href="#l12.2382"></a><span id="l12.2382" class="difflineminus">-    this._currentConfig.incomingAlternatives = [];</span>
<a href="#l12.2383"></a><span id="l12.2383" class="difflineminus">-    this._currentConfig.outgoingAlternatives = [];</span>
<a href="#l12.2384"></a><span id="l12.2384" class="difflineminus">-</span>
<a href="#l12.2385"></a><span id="l12.2385" class="difflineminus">-    this._disableConfigDetails(false);</span>
<a href="#l12.2386"></a><span id="l12.2386" class="difflineminus">-    _hide(&quot;popimap_radio_area&quot;);</span>
<a href="#l12.2387"></a><span id="l12.2387" class="difflineminus">-    this._setIncomingStatus(&quot;failed&quot;);</span>
<a href="#l12.2388"></a><span id="l12.2388" class="difflineminus">-    this._setOutgoingStatus(&quot;failed&quot;);</span>
<a href="#l12.2389"></a><span id="l12.2389" class="difflineminus">-    document.getElementById(&quot;advanced_settings&quot;).disabled = false;</span>
<a href="#l12.2390"></a><span id="l12.2390" class="difflineminus">-    document.getElementById(&quot;create_button&quot;).disabled = true;</span>
<a href="#l12.2391"></a><span id="l12.2391" class="difflineminus">-    _hide(&quot;stop_button&quot;);</span>
<a href="#l12.2392"></a><span id="l12.2392" class="difflineminus">-    _hide(&quot;edit_button&quot;);</span>
<a href="#l12.2393"></a><span id="l12.2393" class="difflineminus">-    _show(&quot;go_button&quot;);</span>
<a href="#l12.2394"></a><span id="l12.2394" class="difflineminus">-  },</span>
<a href="#l12.2395"></a><span id="l12.2395" class="difflineminus">-</span>
<a href="#l12.2396"></a><span id="l12.2396" class="difflineminus">-  /* This _doesn't_ set create back to enabled, that needs to be done in a</span>
<a href="#l12.2397"></a><span id="l12.2397" class="difflineminus">-   * config check.  Only showing the button.</span>
<a href="#l12.2398"></a><span id="l12.2398" class="difflineminus">-   * XXX However it seems that a disabled button can still receive click</span>
<a href="#l12.2399"></a><span id="l12.2399" class="difflineminus">-   *     events so this needs to be looked into further.</span>
<a href="#l12.2400"></a><span id="l12.2400" class="difflineminus">-   */</span>
<a href="#l12.2401"></a><span id="l12.2401" class="difflineminus">-  goWithConfigDetails : function()</span>
<a href="#l12.2402"></a><span id="l12.2402" class="difflineminus">-  {</span>
<a href="#l12.2403"></a><span id="l12.2403" class="difflineminus">-    this._disableConfigDetails(true);</span>
<a href="#l12.2404"></a><span id="l12.2404" class="difflineminus">-    _show(&quot;create_button&quot;);</span>
<a href="#l12.2405"></a><span id="l12.2405" class="difflineminus">-  },</span>
<a href="#l12.2406"></a><span id="l12.2406" class="difflineminus">-</span>
<a href="#l12.2407"></a><span id="l12.2407" class="difflineminus">-  // IDs of &lt;textbox&gt; inputs that can have a .value attr set</span>
<a href="#l12.2408"></a><span id="l12.2408" class="difflineminus">-  _configDetailTextInputs : [&quot;username&quot;, &quot;incoming_server&quot;,</span>
<a href="#l12.2409"></a><span id="l12.2409" class="difflineminus">-                             &quot;incoming_port&quot;, &quot;incoming_protocol&quot;,</span>
<a href="#l12.2410"></a><span id="l12.2410" class="difflineminus">-                             &quot;outgoing_port&quot;],</span>
<a href="#l12.2411"></a><span id="l12.2411" class="difflineminus">-</span>
<a href="#l12.2412"></a><span id="l12.2412" class="difflineminus">-  // IDs of the &lt;menulist&gt; elements that don't accept a .value attr but can</span>
<a href="#l12.2413"></a><span id="l12.2413" class="difflineminus">-  // be disabled</span>
<a href="#l12.2414"></a><span id="l12.2414" class="difflineminus">-  _configDetailMenulists : [&quot;remember_password&quot;, &quot;incoming_security&quot;,</span>
<a href="#l12.2415"></a><span id="l12.2415" class="difflineminus">-                            &quot;outgoing_server&quot;, &quot;outgoing_security&quot;],</span>
<a href="#l12.2416"></a><span id="l12.2416" class="difflineminus">-</span>
<a href="#l12.2417"></a><span id="l12.2417" class="difflineminus">-  /* Helper function to loop through all config details form elements and</span>
<a href="#l12.2418"></a><span id="l12.2418" class="difflineminus">-   * enable or disable each</span>
<a href="#l12.2419"></a><span id="l12.2419" class="difflineminus">-   */</span>
<a href="#l12.2420"></a><span id="l12.2420" class="difflineminus">-  _disableConfigDetails : function(disabled)</span>
<a href="#l12.2421"></a><span id="l12.2421" class="difflineminus">-  {</span>
<a href="#l12.2422"></a><span id="l12.2422" class="difflineminus">-    let formElements =</span>
<a href="#l12.2423"></a><span id="l12.2423" class="difflineminus">-      this._configDetailTextInputs.concat(this._configDetailMenulists)</span>
<a href="#l12.2424"></a><span id="l12.2424" class="difflineminus">-                                  .concat(&quot;password&quot;);</span>
<a href="#l12.2425"></a><span id="l12.2425" class="difflineminus">-    for (let i = 0; i &lt; formElements.length; i++)</span>
<a href="#l12.2426"></a><span id="l12.2426" class="difflineminus">-    {</span>
<a href="#l12.2427"></a><span id="l12.2427" class="difflineminus">-      document.getElementById(formElements[i]).disabled = disabled;</span>
<a href="#l12.2428"></a><span id="l12.2428" class="difflineminus">-    }</span>
<a href="#l12.2429"></a><span id="l12.2429" class="difflineminus">-  },</span>
<a href="#l12.2430"></a><span id="l12.2430" class="difflineminus">-</span>
<a href="#l12.2431"></a><span id="l12.2431" class="difflineminus">-  /**</span>
<a href="#l12.2432"></a><span id="l12.2432" class="difflineminus">-   * Updates a (probed) config to the user,</span>
<a href="#l12.2433"></a><span id="l12.2433" class="difflineminus">-   * in the config details area</span>
<a href="#l12.2434"></a><span id="l12.2434" class="difflineminus">-   *</span>
<a href="#l12.2435"></a><span id="l12.2435" class="difflineminus">-   * @param config {AccountConfig} The config to present to user</span>
<a href="#l12.2436"></a><span id="l12.2436" class="difflineminus">-   */</span>
<a href="#l12.2437"></a><span id="l12.2437" class="difflineminus">-  updateConfig : function(config)</span>
<a href="#l12.2438"></a><span id="l12.2438" class="difflineminus">-  {</span>
<a href="#l12.2439"></a><span id="l12.2439" class="difflineminus">-    _show(&quot;advanced_settings&quot;);</span>
<a href="#l12.2440"></a><span id="l12.2440" class="difflineminus">-    this._currentConfig = config;</span>
<a href="#l12.2441"></a><span id="l12.2441" class="difflineminus">-    // if we have a username, set it.</span>
<a href="#l12.2442"></a><span id="l12.2442" class="difflineminus">-    if (config.incoming.username)</span>
<a href="#l12.2443"></a><span id="l12.2443" class="difflineminus">-    {</span>
<a href="#l12.2444"></a><span id="l12.2444" class="difflineminus">-      document.getElementById(&quot;username&quot;).value = config.incoming.username;</span>
<a href="#l12.2445"></a><span id="l12.2445" class="difflineminus">-    }</span>
<a href="#l12.2446"></a><span id="l12.2446" class="difflineminus">-    else</span>
<a href="#l12.2447"></a><span id="l12.2447" class="difflineminus">-    {</span>
<a href="#l12.2448"></a><span id="l12.2448" class="difflineminus">-      // XXX needs more thought</span>
<a href="#l12.2449"></a><span id="l12.2449" class="difflineminus">-    }</span>
<a href="#l12.2450"></a><span id="l12.2450" class="difflineminus">-</span>
<a href="#l12.2451"></a><span id="l12.2451" class="difflineminus">-    // incoming server</span>
<a href="#l12.2452"></a><span id="l12.2452" class="difflineminus">-    if (config.incoming.hostname &amp;&amp; config.incoming.hostname != -1)</span>
<a href="#l12.2453"></a><span id="l12.2453" class="difflineminus">-    {</span>
<a href="#l12.2454"></a><span id="l12.2454" class="difflineminus">-      /* -1 failure needs to be handled in the context of the failure</span>
<a href="#l12.2455"></a><span id="l12.2455" class="difflineminus">-        * at this point all we know is there is no hostname, but not why</span>
<a href="#l12.2456"></a><span id="l12.2456" class="difflineminus">-        * the error handling behaviour needs to be done above</span>
<a href="#l12.2457"></a><span id="l12.2457" class="difflineminus">-        */</span>
<a href="#l12.2458"></a><span id="l12.2458" class="difflineminus">-      document.getElementById(&quot;incoming_server&quot;).value =</span>
<a href="#l12.2459"></a><span id="l12.2459" class="difflineminus">-        config.incoming.hostname;</span>
<a href="#l12.2460"></a><span id="l12.2460" class="difflineminus">-      document.getElementById(&quot;incoming_port&quot;).value = config.incoming.port;</span>
<a href="#l12.2461"></a><span id="l12.2461" class="difflineminus">-      document.getElementById(&quot;incoming_security&quot;).value =</span>
<a href="#l12.2462"></a><span id="l12.2462" class="difflineminus">-        config.incoming.socketType;</span>
<a href="#l12.2463"></a><span id="l12.2463" class="difflineminus">-      document.getElementById(&quot;incoming_protocol&quot;).value =</span>
<a href="#l12.2464"></a><span id="l12.2464" class="difflineminus">-        sanitize.translate(config.incoming.type, { &quot;imap&quot; : 1, &quot;pop3&quot; : 2});</span>
<a href="#l12.2465"></a><span id="l12.2465" class="difflineminus">-      document.getElementById(&quot;popimap_radiogroup&quot;).value =</span>
<a href="#l12.2466"></a><span id="l12.2466" class="difflineminus">-        config.incoming.type;</span>
<a href="#l12.2467"></a><span id="l12.2467" class="difflineminus">-</span>
<a href="#l12.2468"></a><span id="l12.2468" class="difflineminus">-      // en/disable IMAP vs. POP radiogroup</span>
<a href="#l12.2469"></a><span id="l12.2469" class="difflineminus">-      let haveOther = false;</span>
<a href="#l12.2470"></a><span id="l12.2470" class="difflineminus">-      if (config.incomingAlternatives &amp;&amp; config.incomingAlternatives.length)</span>
<a href="#l12.2471"></a><span id="l12.2471" class="difflineminus">-      {</span>
<a href="#l12.2472"></a><span id="l12.2472" class="difflineminus">-        let alternates = config.incomingAlternatives.filter(function(c) {</span>
<a href="#l12.2473"></a><span id="l12.2473" class="difflineminus">-          return c.type != config.incoming.type;</span>
<a href="#l12.2474"></a><span id="l12.2474" class="difflineminus">-        });</span>
<a href="#l12.2475"></a><span id="l12.2475" class="difflineminus">-        haveOther = alternates.length &gt; 0;</span>
<a href="#l12.2476"></a><span id="l12.2476" class="difflineminus">-      }</span>
<a href="#l12.2477"></a><span id="l12.2477" class="difflineminus">-      let popImapRadiogroup = document.getElementById(&quot;popimap_radio_area&quot;);</span>
<a href="#l12.2478"></a><span id="l12.2478" class="difflineminus">-      let wasHidden = popImapRadiogroup.hidden;</span>
<a href="#l12.2479"></a><span id="l12.2479" class="difflineminus">-      popImapRadiogroup.hidden = !haveOther;</span>
<a href="#l12.2480"></a><span id="l12.2480" class="difflineminus">-      // Hide &quot;(recommended)&quot; behind IMAP, if POP3 was first choice from XML,</span>
<a href="#l12.2481"></a><span id="l12.2481" class="difflineminus">-      // and not just selected by user later.</span>
<a href="#l12.2482"></a><span id="l12.2482" class="difflineminus">-      if (!config._imapRecommendedToggled)</span>
<a href="#l12.2483"></a><span id="l12.2483" class="difflineminus">-        document.getElementById(&quot;imap_recommended&quot;).hidden =</span>
<a href="#l12.2484"></a><span id="l12.2484" class="difflineminus">-            config.incoming.type == &quot;pop3&quot;;</span>
<a href="#l12.2485"></a><span id="l12.2485" class="difflineminus">-      config._imapRecommendedToggled = true;</span>
<a href="#l12.2486"></a><span id="l12.2486" class="difflineminus">-      if (wasHidden == haveOther) // hidden changed, so resize</span>
<a href="#l12.2487"></a><span id="l12.2487" class="difflineminus">-        window.sizeToContent();</span>
<a href="#l12.2488"></a><span id="l12.2488" class="difflineminus">-</span>
<a href="#l12.2489"></a><span id="l12.2489" class="difflineminus">-      if (config.incoming._inprogress)</span>
<a href="#l12.2490"></a><span id="l12.2490" class="difflineminus">-      {</span>
<a href="#l12.2491"></a><span id="l12.2491" class="difflineminus">-        this._setIncomingStatus('probing');</span>
<a href="#l12.2492"></a><span id="l12.2492" class="difflineminus">-      }</span>
<a href="#l12.2493"></a><span id="l12.2493" class="difflineminus">-      else</span>
<a href="#l12.2494"></a><span id="l12.2494" class="difflineminus">-      {</span>
<a href="#l12.2495"></a><span id="l12.2495" class="difflineminus">-        // We got an incoming server, so we can enable the advanced settings.</span>
<a href="#l12.2496"></a><span id="l12.2496" class="difflineminus">-        document.getElementById(&quot;advanced_settings&quot;).disabled = false;</span>
<a href="#l12.2497"></a><span id="l12.2497" class="difflineminus">-        switch (config.incoming.socketType)</span>
<a href="#l12.2498"></a><span id="l12.2498" class="difflineminus">-        {</span>
<a href="#l12.2499"></a><span id="l12.2499" class="difflineminus">-          case 2: // SSL / TLS</span>
<a href="#l12.2500"></a><span id="l12.2500" class="difflineminus">-          case 3: // STARTTLS</span>
<a href="#l12.2501"></a><span id="l12.2501" class="difflineminus">-            if (config.incoming.badCert)</span>
<a href="#l12.2502"></a><span id="l12.2502" class="difflineminus">-            {</span>
<a href="#l12.2503"></a><span id="l12.2503" class="difflineminus">-              this._setIncomingStatus('weak', 'selfsigned');</span>
<a href="#l12.2504"></a><span id="l12.2504" class="difflineminus">-              var params = { exceptionAdded : false };</span>
<a href="#l12.2505"></a><span id="l12.2505" class="difflineminus">-              params.prefetchCert = true;</span>
<a href="#l12.2506"></a><span id="l12.2506" class="difflineminus">-              params.location = config.incoming.targetSite;</span>
<a href="#l12.2507"></a><span id="l12.2507" class="difflineminus">-              window.openDialog('chrome://pippki/content/exceptionDialog.xul',</span>
<a href="#l12.2508"></a><span id="l12.2508" class="difflineminus">-                                '','chrome,centerscreen,modal', params);</span>
<a href="#l12.2509"></a><span id="l12.2509" class="difflineminus">-              config.incoming.badCert = false;</span>
<a href="#l12.2510"></a><span id="l12.2510" class="difflineminus">-            }</span>
<a href="#l12.2511"></a><span id="l12.2511" class="difflineminus">-            else</span>
<a href="#l12.2512"></a><span id="l12.2512" class="difflineminus">-            {</span>
<a href="#l12.2513"></a><span id="l12.2513" class="difflineminus">-              this._setIncomingStatus('strong');</span>
<a href="#l12.2514"></a><span id="l12.2514" class="difflineminus">-            }</span>
<a href="#l12.2515"></a><span id="l12.2515" class="difflineminus">-            break;</span>
<a href="#l12.2516"></a><span id="l12.2516" class="difflineminus">-          case 1: // plain</span>
<a href="#l12.2517"></a><span id="l12.2517" class="difflineminus">-            this._setIncomingStatus('weak', 'cleartext');</span>
<a href="#l12.2518"></a><span id="l12.2518" class="difflineminus">-            break;</span>
<a href="#l12.2519"></a><span id="l12.2519" class="difflineminus">-          default:</span>
<a href="#l12.2520"></a><span id="l12.2520" class="difflineminus">-            throw new NotReached(&quot;sslType &quot; + config.incoming.socketType + &quot; unknown&quot;);</span>
<a href="#l12.2521"></a><span id="l12.2521" class="difflineminus">-        }</span>
<a href="#l12.2522"></a><span id="l12.2522" class="difflineminus">-      }</span>
<a href="#l12.2523"></a><span id="l12.2523" class="difflineminus">-    }</span>
<a href="#l12.2524"></a><span id="l12.2524" class="difflineminus">-</span>
<a href="#l12.2525"></a><span id="l12.2525" class="difflineminus">-    // outgoing server</span>
<a href="#l12.2526"></a><span id="l12.2526" class="difflineminus">-    if (config.outgoing.hostname &amp;&amp; config.outgoing.hostname != -1)</span>
<a href="#l12.2527"></a><span id="l12.2527" class="difflineminus">-    {</span>
<a href="#l12.2528"></a><span id="l12.2528" class="difflineminus">-      /* -1 failure needs to be handled in the context of the failure</span>
<a href="#l12.2529"></a><span id="l12.2529" class="difflineminus">-       * at this point all we know is there is no hostname, but not why.</span>
<a href="#l12.2530"></a><span id="l12.2530" class="difflineminus">-       * The error handling behaviour needs to be done elsewhere</span>
<a href="#l12.2531"></a><span id="l12.2531" class="difflineminus">-       */</span>
<a href="#l12.2532"></a><span id="l12.2532" class="difflineminus">-      if (!gEmailConfigWizard._userPickedOutgoingServer)</span>
<a href="#l12.2533"></a><span id="l12.2533" class="difflineminus">-      {</span>
<a href="#l12.2534"></a><span id="l12.2534" class="difflineminus">-        document.getElementById(&quot;outgoing_server&quot;).value =</span>
<a href="#l12.2535"></a><span id="l12.2535" class="difflineminus">-          config.outgoing.hostname;</span>
<a href="#l12.2536"></a><span id="l12.2536" class="difflineminus">-        document.getElementById(&quot;outgoing_port&quot;).value = config.outgoing.port;</span>
<a href="#l12.2537"></a><span id="l12.2537" class="difflineminus">-        document.getElementById(&quot;outgoing_security&quot;).value =</span>
<a href="#l12.2538"></a><span id="l12.2538" class="difflineminus">-          config.outgoing.socketType;</span>
<a href="#l12.2539"></a><span id="l12.2539" class="difflineminus">-        _show(&quot;outgoing_port&quot;);</span>
<a href="#l12.2540"></a><span id="l12.2540" class="difflineminus">-        _show(&quot;outgoing_security&quot;);</span>
<a href="#l12.2541"></a><span id="l12.2541" class="difflineminus">-        if (config.outgoing._inprogress) {</span>
<a href="#l12.2542"></a><span id="l12.2542" class="difflineminus">-          this._setOutgoingStatus('probing');</span>
<a href="#l12.2543"></a><span id="l12.2543" class="difflineminus">-        }</span>
<a href="#l12.2544"></a><span id="l12.2544" class="difflineminus">-        else</span>
<a href="#l12.2545"></a><span id="l12.2545" class="difflineminus">-        {</span>
<a href="#l12.2546"></a><span id="l12.2546" class="difflineminus">-          switch (config.outgoing.socketType)</span>
<a href="#l12.2547"></a><span id="l12.2547" class="difflineminus">-          {</span>
<a href="#l12.2548"></a><span id="l12.2548" class="difflineminus">-            case 2: // SSL / TLS</span>
<a href="#l12.2549"></a><span id="l12.2549" class="difflineminus">-            case 3: // STARTTLS</span>
<a href="#l12.2550"></a><span id="l12.2550" class="difflineminus">-              if (config.outgoing.badCert)</span>
<a href="#l12.2551"></a><span id="l12.2551" class="difflineminus">-                this._setOutgoingStatus('weak', 'selfsigned');</span>
<a href="#l12.2552"></a><span id="l12.2552" class="difflineminus">-              else</span>
<a href="#l12.2553"></a><span id="l12.2553" class="difflineminus">-                this._setOutgoingStatus('strong');</span>
<a href="#l12.2554"></a><span id="l12.2554" class="difflineminus">-              break;</span>
<a href="#l12.2555"></a><span id="l12.2555" class="difflineminus">-            case 1: // plain</span>
<a href="#l12.2556"></a><span id="l12.2556" class="difflineminus">-              this._setOutgoingStatus('weak', 'cleartext');</span>
<a href="#l12.2557"></a><span id="l12.2557" class="difflineminus">-              break;</span>
<a href="#l12.2558"></a><span id="l12.2558" class="difflineminus">-            default:</span>
<a href="#l12.2559"></a><span id="l12.2559" class="difflineminus">-              throw new NotReached(&quot;sslType &quot; + config.incoming.socketType + &quot; unknown&quot;);</span>
<a href="#l12.2560"></a><span id="l12.2560" class="difflineminus">-          }</span>
<a href="#l12.2561"></a><span id="l12.2561" class="difflineminus">-        }</span>
<a href="#l12.2562"></a><span id="l12.2562" class="difflineminus">-      }</span>
<a href="#l12.2563"></a><span id="l12.2563" class="difflineminus">-      else</span>
<a href="#l12.2564"></a><span id="l12.2564" class="difflineminus">-      {</span>
<a href="#l12.2565"></a><span id="l12.2565" class="difflineminus">-        config.outgoing.addThisServer = false;</span>
<a href="#l12.2566"></a><span id="l12.2566" class="difflineminus">-        config.outgoing.useGlobalPreferredServer = true;</span>
<a href="#l12.2567"></a><span id="l12.2567" class="difflineminus">-      }</span>
<a href="#l12.2568"></a><span id="l12.2568" class="difflineminus">-    }</span>
<a href="#l12.2569"></a><span id="l12.2569" class="difflineminus">-  },</span>
<a href="#l12.2570"></a><span id="l12.2570" class="difflineminus">-</span>
<a href="#l12.2571"></a><span id="l12.2571" class="difflineminus">-  /* (Edit) button click handler.  This turns the config details area into an</span>
<a href="#l12.2572"></a><span id="l12.2572" class="difflineminus">-   * editable form and makes the (Go) button appear.  The edit button should</span>
<a href="#l12.2573"></a><span id="l12.2573" class="difflineminus">-   * only be available after the config probing is completely finished,</span>
<a href="#l12.2574"></a><span id="l12.2574" class="difflineminus">-   * replacing what was the (Stop) button.</span>
<a href="#l12.2575"></a><span id="l12.2575" class="difflineminus">-   */</span>
<a href="#l12.2576"></a><span id="l12.2576" class="difflineminus">-  onEdit : function()</span>
<a href="#l12.2577"></a><span id="l12.2577" class="difflineminus">-  {</span>
<a href="#l12.2578"></a><span id="l12.2578" class="difflineminus">-    this.editConfigDetails();</span>
<a href="#l12.2579"></a><span id="l12.2579" class="difflineminus">-  },</span>
<a href="#l12.2580"></a><span id="l12.2580" class="difflineminus">-</span>
<a href="#l12.2581"></a><span id="l12.2581" class="difflineminus">-  // short hand so I didn't have to insert the swap functions in various places</span>
<a href="#l12.2582"></a><span id="l12.2582" class="difflineminus">-  showEditButton : function() { _show(&quot;edit_button&quot;); _hide(&quot;stop_button&quot;); },</span>
<a href="#l12.2583"></a><span id="l12.2583" class="difflineminus">-</span>
<a href="#l12.2584"></a><span id="l12.2584" class="difflineminus">-  /* (Stop) button click handler.  This should stop short any probing or config</span>
<a href="#l12.2585"></a><span id="l12.2585" class="difflineminus">-   * guessing progress and changing the config details area into manual edit</span>
<a href="#l12.2586"></a><span id="l12.2586" class="difflineminus">-   * mode.  This button should only be available during probing, after which it</span>
<a href="#l12.2587"></a><span id="l12.2587" class="difflineminus">-   * is replaced by the (Edit) button.</span>
<a href="#l12.2588"></a><span id="l12.2588" class="difflineminus">-   */</span>
<a href="#l12.2589"></a><span id="l12.2589" class="difflineminus">-  onStop : function()</span>
<a href="#l12.2590"></a><span id="l12.2590" class="difflineminus">-  {</span>
<a href="#l12.2591"></a><span id="l12.2591" class="difflineminus">-    if (!this._probeAbortable)</span>
<a href="#l12.2592"></a><span id="l12.2592" class="difflineminus">-    {</span>
<a href="#l12.2593"></a><span id="l12.2593" class="difflineminus">-      gEmailWizardLogger.info(&quot;onStop without a _probeAbortable to cancel&quot;);</span>
<a href="#l12.2594"></a><span id="l12.2594" class="difflineminus">-    }</span>
<a href="#l12.2595"></a><span id="l12.2595" class="difflineminus">-    else</span>
<a href="#l12.2596"></a><span id="l12.2596" class="difflineminus">-    {</span>
<a href="#l12.2597"></a><span id="l12.2597" class="difflineminus">-      this._probeAbortable.cancel();</span>
<a href="#l12.2598"></a><span id="l12.2598" class="difflineminus">-      gEmailWizardLogger.info(&quot;onStop cancelled _probeAbortable&quot;);</span>
<a href="#l12.2599"></a><span id="l12.2599" class="difflineminus">-    }</span>
<a href="#l12.2600"></a><span id="l12.2600" class="difflineminus">-    this.stopSpinner('manually_edit_config');</span>
<a href="#l12.2601"></a><span id="l12.2601" class="difflineminus">-    this.editConfigDetails();</span>
<a href="#l12.2602"></a><span id="l12.2602" class="difflineminus">-  },</span>
<a href="#l12.2603"></a><span id="l12.2603" class="difflineminus">-</span>
<a href="#l12.2604"></a><span id="l12.2604" class="difflineminus">-  /* (Go) button click handler.  Restarts the config guessing process after a</span>
<a href="#l12.2605"></a><span id="l12.2605" class="difflineminus">-   * person possibly editing the fields.  The go button replaces either the</span>
<a href="#l12.2606"></a><span id="l12.2606" class="difflineminus">-   * (Stop) or (Edit) button after they have been clicked.</span>
<a href="#l12.2607"></a><span id="l12.2607" class="difflineminus">-   */</span>
<a href="#l12.2608"></a><span id="l12.2608" class="difflineminus">-  onGo : function()</span>
<a href="#l12.2609"></a><span id="l12.2609" class="difflineminus">-  {</span>
<a href="#l12.2610"></a><span id="l12.2610" class="difflineminus">-    // swap out go for stop button</span>
<a href="#l12.2611"></a><span id="l12.2611" class="difflineminus">-    _hide(&quot;go_button&quot;);</span>
<a href="#l12.2612"></a><span id="l12.2612" class="difflineminus">-    // the stop is naturally not hidden so has no place in the code where it is</span>
<a href="#l12.2613"></a><span id="l12.2613" class="difflineminus">-    // told to be shown</span>
<a href="#l12.2614"></a><span id="l12.2614" class="difflineminus">-    _show(&quot;stop_button&quot;);</span>
<a href="#l12.2615"></a><span id="l12.2615" class="difflineminus">-    this._password = document.getElementById(&quot;password&quot;).value;</span>
<a href="#l12.2616"></a><span id="l12.2616" class="difflineminus">-    this.goWithConfigDetails();</span>
<a href="#l12.2617"></a><span id="l12.2617" class="difflineminus">-    var newConfig = this.getUserConfig();</span>
<a href="#l12.2618"></a><span id="l12.2618" class="difflineminus">-    if (this._incomingState != &quot;done&quot;) {</span>
<a href="#l12.2619"></a><span id="l12.2619" class="difflineminus">-      newConfig.incoming._inprogress = true;</span>
<a href="#l12.2620"></a><span id="l12.2620" class="difflineminus">-      gEmailConfigWizard._startProbingIncoming(newConfig);</span>
<a href="#l12.2621"></a><span id="l12.2621" class="difflineminus">-    }</span>
<a href="#l12.2622"></a><span id="l12.2622" class="difflineminus">-    if (!this._userPickedOutgoingServer &amp;&amp; this._outgoingState != &quot;done&quot;) {</span>
<a href="#l12.2623"></a><span id="l12.2623" class="difflineminus">-      newConfig.outgoing._inprogress = true;</span>
<a href="#l12.2624"></a><span id="l12.2624" class="difflineminus">-      gEmailConfigWizard._startProbingOutgoing(newConfig);</span>
<a href="#l12.2625"></a><span id="l12.2625" class="difflineminus">-    }</span>
<a href="#l12.2626"></a><span id="l12.2626" class="difflineminus">-  },</span>
<a href="#l12.2627"></a><span id="l12.2627" class="difflineminus">-</span>
<a href="#l12.2628"></a><span id="l12.2628" class="difflineminus">-  onCancel : function()</span>
<a href="#l12.2629"></a><span id="l12.2629" class="difflineminus">-  {</span>
<a href="#l12.2630"></a><span id="l12.2630" class="difflineminus">-    // The window onclose handler will call onWizardShutdown for us.</span>
<a href="#l12.2631"></a><span id="l12.2631" class="difflineminus">-    window.close();</span>
<a href="#l12.2632"></a><span id="l12.2632" class="difflineminus">-  },</span>
<a href="#l12.2633"></a><span id="l12.2633" class="difflineminus">-</span>
<a href="#l12.2634"></a><span id="l12.2634" class="difflineminus">-  // UI helper functions</span>
<a href="#l12.2635"></a><span id="l12.2635" class="difflineminus">-</span>
<a href="#l12.2636"></a><span id="l12.2636" class="difflineminus">-  startSpinner: function(which, actionStrName)</span>
<a href="#l12.2637"></a><span id="l12.2637" class="difflineminus">-  {</span>
<a href="#l12.2638"></a><span id="l12.2638" class="difflineminus">-    this._showStatusTitle(false, actionStrName);</span>
<a href="#l12.2639"></a><span id="l12.2639" class="difflineminus">-    if (which == &quot;all&quot;) {</span>
<a href="#l12.2640"></a><span id="l12.2640" class="difflineminus">-      this._setIconAndTooltip(&quot;incoming&quot;, &quot;hidden&quot;, &quot;&quot;);</span>
<a href="#l12.2641"></a><span id="l12.2641" class="difflineminus">-      this._setIconAndTooltip(&quot;outgoing&quot;, &quot;hidden&quot;, &quot;&quot;);</span>
<a href="#l12.2642"></a><span id="l12.2642" class="difflineminus">-    }</span>
<a href="#l12.2643"></a><span id="l12.2643" class="difflineminus">-    else</span>
<a href="#l12.2644"></a><span id="l12.2644" class="difflineminus">-      this._setIconAndTooltip(which, &quot;hidden&quot;, &quot;&quot;);</span>
<a href="#l12.2645"></a><span id="l12.2645" class="difflineminus">-    gEmailWizardLogger.warn(which + &quot;spinner start &quot; + actionStrName);</span>
<a href="#l12.2646"></a><span id="l12.2646" class="difflineminus">-  },</span>
<a href="#l12.2647"></a><span id="l12.2647" class="difflineminus">-</span>
<a href="#l12.2648"></a><span id="l12.2648" class="difflineminus">-  stopSpinner: function(actionStrName)</span>
<a href="#l12.2649"></a><span id="l12.2649" class="difflineminus">-  {</span>
<a href="#l12.2650"></a><span id="l12.2650" class="difflineminus">-    this._showStatusTitle(true, actionStrName);</span>
<a href="#l12.2651"></a><span id="l12.2651" class="difflineminus">-    this._updateSpinner(&quot;incoming&quot;, true);</span>
<a href="#l12.2652"></a><span id="l12.2652" class="difflineminus">-    this._updateSpinner(&quot;outgoing&quot;, true);</span>
<a href="#l12.2653"></a><span id="l12.2653" class="difflineminus">-    gEmailWizardLogger.warn(&quot;all spinner stop &quot; + actionStrName);</span>
<a href="#l12.2654"></a><span id="l12.2654" class="difflineminus">-  },</span>
<a href="#l12.2655"></a><span id="l12.2655" class="difflineminus">-</span>
<a href="#l12.2656"></a><span id="l12.2656" class="difflineminus">-  _updateSpinner: function(which, stop)</span>
<a href="#l12.2657"></a><span id="l12.2657" class="difflineminus">-  {</span>
<a href="#l12.2658"></a><span id="l12.2658" class="difflineminus">-    document.getElementById(which + &quot;_spinner&quot;).hidden = stop;</span>
<a href="#l12.2659"></a><span id="l12.2659" class="difflineminus">-  },</span>
<a href="#l12.2660"></a><span id="l12.2660" class="difflineminus">-</span>
<a href="#l12.2661"></a><span id="l12.2661" class="difflineminus">-  _showStatusTitle: function(success, msgName)</span>
<a href="#l12.2662"></a><span id="l12.2662" class="difflineminus">-  {</span>
<a href="#l12.2663"></a><span id="l12.2663" class="difflineminus">-    let brandShortName = document.getElementById(&quot;bundle_brand&quot;)</span>
<a href="#l12.2664"></a><span id="l12.2664" class="difflineminus">-                                 .getString(&quot;brandShortName&quot;);</span>
<a href="#l12.2665"></a><span id="l12.2665" class="difflineminus">-    let msg;</span>
<a href="#l12.2666"></a><span id="l12.2666" class="difflineminus">-    try {</span>
<a href="#l12.2667"></a><span id="l12.2667" class="difflineminus">-      msg = msgName</span>
<a href="#l12.2668"></a><span id="l12.2668" class="difflineminus">-            ? gStringsBundle.getFormattedString(msgName, [brandShortName])</span>
<a href="#l12.2669"></a><span id="l12.2669" class="difflineminus">-            : &quot;&quot;;</span>
<a href="#l12.2670"></a><span id="l12.2670" class="difflineminus">-    } catch(ex) {</span>
<a href="#l12.2671"></a><span id="l12.2671" class="difflineminus">-      gEmailWizardLogger.error(&quot;missing string for &quot; + msgName);</span>
<a href="#l12.2672"></a><span id="l12.2672" class="difflineminus">-      logException(new Exception(&quot;missing string for name: &quot; + msgName));</span>
<a href="#l12.2673"></a><span id="l12.2673" class="difflineminus">-    }</span>
<a href="#l12.2674"></a><span id="l12.2674" class="difflineminus">-</span>
<a href="#l12.2675"></a><span id="l12.2675" class="difflineminus">-    let title = document.getElementById(&quot;config_status_title&quot;);</span>
<a href="#l12.2676"></a><span id="l12.2676" class="difflineminus">-    title.hidden = false;</span>
<a href="#l12.2677"></a><span id="l12.2677" class="difflineminus">-    title.textContent = msg;</span>
<a href="#l12.2678"></a><span id="l12.2678" class="difflineminus">-    gEmailWizardLogger.info(&quot;show status title &quot; + (success ? &quot;success&quot; : &quot;failure&quot;) +</span>
<a href="#l12.2679"></a><span id="l12.2679" class="difflineminus">-                            &quot;, msg: &quot; + msg);</span>
<a href="#l12.2680"></a><span id="l12.2680" class="difflineminus">-  },</span>
<a href="#l12.2681"></a><span id="l12.2681" class="difflineminus">-</span>
<a href="#l12.2682"></a><span id="l12.2682" class="difflineminus">-  _prefillConfig: function(initialConfig)</span>
<a href="#l12.2683"></a><span id="l12.2683" class="difflineminus">-  {</span>
<a href="#l12.2684"></a><span id="l12.2684" class="difflineminus">-    var emailsplit = this._email.split(&quot;@&quot;);</span>
<a href="#l12.2685"></a><span id="l12.2685" class="difflineminus">-    if (emailsplit.length != 2)</span>
<a href="#l12.2686"></a><span id="l12.2686" class="difflineminus">-      throw new Exception(gStringsBundle.getString(&quot;double_check_email&quot;));</span>
<a href="#l12.2687"></a><span id="l12.2687" class="difflineminus">-</span>
<a href="#l12.2688"></a><span id="l12.2688" class="difflineminus">-    var emaillocal = sanitize.nonemptystring(emailsplit[0]);</span>
<a href="#l12.2689"></a><span id="l12.2689" class="difflineminus">-    initialConfig.incoming.username = emaillocal;</span>
<a href="#l12.2690"></a><span id="l12.2690" class="difflineminus">-    initialConfig.outgoing.username = emaillocal;</span>
<a href="#l12.2691"></a><span id="l12.2691" class="difflineminus">-    initialConfig.outgoing.protocol = 'smtp';</span>
<a href="#l12.2692"></a><span id="l12.2692" class="difflineminus">-    return initialConfig;</span>
<a href="#l12.2693"></a><span id="l12.2693" class="difflineminus">-  },</span>
<a href="#l12.2694"></a><span id="l12.2694" class="difflineminus">-</span>
<a href="#l12.2695"></a><span id="l12.2695" class="difflineminus">-  _startProbingIncoming : function(config)</span>
<a href="#l12.2696"></a><span id="l12.2696" class="difflineminus">-  {</span>
<a href="#l12.2697"></a><span id="l12.2697" class="difflineminus">-    gEmailWizardLogger.info(&quot;_startProbingIncoming: &quot; + config.incoming.hostname +</span>
<a href="#l12.2698"></a><span id="l12.2698" class="difflineminus">-                            &quot; probe = &quot; + this._probeAbortable);</span>
<a href="#l12.2699"></a><span id="l12.2699" class="difflineminus">-    this.startSpinner(&quot;incoming&quot;, &quot;looking_up_settings_guess&quot;);</span>
<a href="#l12.2700"></a><span id="l12.2700" class="difflineminus">-</span>
<a href="#l12.2701"></a><span id="l12.2701" class="difflineminus">-    config.incoming._inprogress = true;</span>
<a href="#l12.2702"></a><span id="l12.2702" class="difflineminus">-    // User entered hostname, we may want to probe port and protocol and socketType</span>
<a href="#l12.2703"></a><span id="l12.2703" class="difflineminus">-    if (!this._userChangedIncomingProtocol)</span>
<a href="#l12.2704"></a><span id="l12.2704" class="difflineminus">-      config.incoming.protocol = undefined;</span>
<a href="#l12.2705"></a><span id="l12.2705" class="difflineminus">-    if (!this._userChangedIncomingPort)</span>
<a href="#l12.2706"></a><span id="l12.2706" class="difflineminus">-      config.incoming.port = undefined;</span>
<a href="#l12.2707"></a><span id="l12.2707" class="difflineminus">-    if (!this._userChangedIncomingSocketType)</span>
<a href="#l12.2708"></a><span id="l12.2708" class="difflineminus">-      config.incoming.socketType = undefined;</span>
<a href="#l12.2709"></a><span id="l12.2709" class="difflineminus">-    if (!this._userChangedIncomingServer)</span>
<a href="#l12.2710"></a><span id="l12.2710" class="difflineminus">-      config.incoming.hostname = undefined;</span>
<a href="#l12.2711"></a><span id="l12.2711" class="difflineminus">-</span>
<a href="#l12.2712"></a><span id="l12.2712" class="difflineminus">-    let domain = this._domain;</span>
<a href="#l12.2713"></a><span id="l12.2713" class="difflineminus">-    if (config.incoming.hostname)</span>
<a href="#l12.2714"></a><span id="l12.2714" class="difflineminus">-      domain = config.incoming.hostname;</span>
<a href="#l12.2715"></a><span id="l12.2715" class="difflineminus">-</span>
<a href="#l12.2716"></a><span id="l12.2716" class="difflineminus">-    if (this._probeAbortable)</span>
<a href="#l12.2717"></a><span id="l12.2717" class="difflineminus">-    {</span>
<a href="#l12.2718"></a><span id="l12.2718" class="difflineminus">-      gEmailWizardLogger.info(&quot;restarting probe: &quot; + domain);</span>
<a href="#l12.2719"></a><span id="l12.2719" class="difflineminus">-      this._probeAbortable.restart(domain, config, &quot;incoming&quot;,</span>
<a href="#l12.2720"></a><span id="l12.2720" class="difflineminus">-                                   config.incoming.type,</span>
<a href="#l12.2721"></a><span id="l12.2721" class="difflineminus">-                                   config.incoming.port,</span>
<a href="#l12.2722"></a><span id="l12.2722" class="difflineminus">-                                   config.incoming.socketType);</span>
<a href="#l12.2723"></a><span id="l12.2723" class="difflineminus">-    }</span>
<a href="#l12.2724"></a><span id="l12.2724" class="difflineminus">-    else</span>
<a href="#l12.2725"></a><span id="l12.2725" class="difflineminus">-    {</span>
<a href="#l12.2726"></a><span id="l12.2726" class="difflineminus">-      this._guessConfig(domain, config, &quot;incoming&quot;);</span>
<a href="#l12.2727"></a><span id="l12.2727" class="difflineminus">-    }</span>
<a href="#l12.2728"></a><span id="l12.2728" class="difflineminus">-  },</span>
<a href="#l12.2729"></a><span id="l12.2729" class="difflineminus">-</span>
<a href="#l12.2730"></a><span id="l12.2730" class="difflineminus">-  _startProbingOutgoing : function(config)</span>
<a href="#l12.2731"></a><span id="l12.2731" class="difflineminus">-  {</span>
<a href="#l12.2732"></a><span id="l12.2732" class="difflineminus">-    gEmailWizardLogger.info(&quot;_startProbingOutgoing: &quot; + config.outgoing.hostname +</span>
<a href="#l12.2733"></a><span id="l12.2733" class="difflineminus">-                            &quot; probe = &quot; + this._probeAbortable);</span>
<a href="#l12.2734"></a><span id="l12.2734" class="difflineminus">-    this.startSpinner(&quot;outgoing&quot;, &quot;looking_up_settings_guess&quot;);</span>
<a href="#l12.2735"></a><span id="l12.2735" class="difflineminus">-</span>
<a href="#l12.2736"></a><span id="l12.2736" class="difflineminus">-    config.outgoing._inprogress = true;</span>
<a href="#l12.2737"></a><span id="l12.2737" class="difflineminus">-    // User entered hostname, we want to probe port and protocol and socketType</span>
<a href="#l12.2738"></a><span id="l12.2738" class="difflineminus">-    if (!this._userChangedOutgoingPort)</span>
<a href="#l12.2739"></a><span id="l12.2739" class="difflineminus">-      config.outgoing.port = undefined;</span>
<a href="#l12.2740"></a><span id="l12.2740" class="difflineminus">-    if (!this._userChangedOutgoingSocketType)</span>
<a href="#l12.2741"></a><span id="l12.2741" class="difflineminus">-      config.outgoing.socketType = undefined;</span>
<a href="#l12.2742"></a><span id="l12.2742" class="difflineminus">-</span>
<a href="#l12.2743"></a><span id="l12.2743" class="difflineminus">-    if (this._probeAbortable)</span>
<a href="#l12.2744"></a><span id="l12.2744" class="difflineminus">-    {</span>
<a href="#l12.2745"></a><span id="l12.2745" class="difflineminus">-      gEmailWizardLogger.info(&quot;restarting probe: &quot; + config.outgoing.hostname);</span>
<a href="#l12.2746"></a><span id="l12.2746" class="difflineminus">-      this._probeAbortable.restart(config.outgoing.hostname, config, &quot;outgoing&quot;,</span>
<a href="#l12.2747"></a><span id="l12.2747" class="difflineminus">-                                   &quot;smtp&quot;, config.outgoing.port,</span>
<a href="#l12.2748"></a><span id="l12.2748" class="difflineminus">-                                   config.outgoing.socketType);</span>
<a href="#l12.2749"></a><span id="l12.2749" class="difflineminus">-    }</span>
<a href="#l12.2750"></a><span id="l12.2750" class="difflineminus">-    else</span>
<a href="#l12.2751"></a><span id="l12.2751" class="difflineminus">-    {</span>
<a href="#l12.2752"></a><span id="l12.2752" class="difflineminus">-      this._guessConfig(config.outgoing.hostname, config, &quot;outgoing&quot;);</span>
<a href="#l12.2753"></a><span id="l12.2753" class="difflineminus">-    }</span>
<a href="#l12.2754"></a><span id="l12.2754" class="difflineminus">-  },</span>
<a href="#l12.2755"></a><span id="l12.2755" class="difflineminus">-</span>
<a href="#l12.2756"></a><span id="l12.2756" class="difflineminus">-  clearError: function(which) {</span>
<a href="#l12.2757"></a><span id="l12.2757" class="difflineminus">-    _hide(which);</span>
<a href="#l12.2758"></a><span id="l12.2758" class="difflineminus">-    _hide(which+&quot;icon&quot;);</span>
<a href="#l12.2759"></a><span id="l12.2759" class="difflineminus">-    document.getElementById(which).textContent = &quot;&quot;;</span>
<a href="#l12.2760"></a><span id="l12.2760" class="difflineminus">-  },</span>
<a href="#l12.2761"></a><span id="l12.2761" class="difflineminus">-</span>
<a href="#l12.2762"></a><span id="l12.2762" class="difflineminus">-  setError: function(which, msg_name) {</span>
<a href="#l12.2763"></a><span id="l12.2763" class="difflineminus">-    try {</span>
<a href="#l12.2764"></a><span id="l12.2764" class="difflineminus">-      _show(which);</span>
<a href="#l12.2765"></a><span id="l12.2765" class="difflineminus">-      _show(which+&quot;icon&quot;);</span>
<a href="#l12.2766"></a><span id="l12.2766" class="difflineminus">-      document.getElementById(which).textContent =</span>
<a href="#l12.2767"></a><span id="l12.2767" class="difflineminus">-        gStringsBundle.getString(msg_name);</span>
<a href="#l12.2768"></a><span id="l12.2768" class="difflineminus">-    }</span>
<a href="#l12.2769"></a><span id="l12.2769" class="difflineminus">-    catch(ex) {</span>
<a href="#l12.2770"></a><span id="l12.2770" class="difflineminus">-      alertPrompt(&quot;missing error string&quot;, msg_name);</span>
<a href="#l12.2771"></a><span id="l12.2771" class="difflineminus">-    }</span>
<a href="#l12.2772"></a><span id="l12.2772" class="difflineminus">-  },</span>
<a href="#l12.2773"></a><span id="l12.2773" class="difflineminus">-</span>
<a href="#l12.2774"></a><span id="l12.2774" class="difflineminus">-  onKeyDown : function(event)</span>
<a href="#l12.2775"></a><span id="l12.2775" class="difflineminus">-  {</span>
<a href="#l12.2776"></a><span id="l12.2776" class="difflineminus">-    let key = event.keyCode;</span>
<a href="#l12.2777"></a><span id="l12.2777" class="difflineminus">-    if (key == 27) {</span>
<a href="#l12.2778"></a><span id="l12.2778" class="difflineminus">-      this.onCancel();</span>
<a href="#l12.2779"></a><span id="l12.2779" class="difflineminus">-      return true;</span>
<a href="#l12.2780"></a><span id="l12.2780" class="difflineminus">-    }</span>
<a href="#l12.2781"></a><span id="l12.2781" class="difflineminus">-    if (key == 13 &amp;&amp; !document.getElementById(&quot;go_button&quot;).hidden</span>
<a href="#l12.2782"></a><span id="l12.2782" class="difflineminus">-                  &amp;&amp; !document.getElementById(&quot;go_button&quot;).disabled) {</span>
<a href="#l12.2783"></a><span id="l12.2783" class="difflineminus">-      this.onGo();</span>
<a href="#l12.2784"></a><span id="l12.2784" class="difflineminus">-      return true;</span>
<a href="#l12.2785"></a><span id="l12.2785" class="difflineminus">-    }</span>
<a href="#l12.2786"></a><span id="l12.2786" class="difflineminus">-    if (key == 13 &amp;&amp; !document.getElementById(&quot;create_button&quot;).hidden</span>
<a href="#l12.2787"></a><span id="l12.2787" class="difflineminus">-                  &amp;&amp; !document.getElementById(&quot;create_button&quot;).disabled) {</span>
<a href="#l12.2788"></a><span id="l12.2788" class="difflineminus">-      this.onOK();</span>
<a href="#l12.2789"></a><span id="l12.2789" class="difflineminus">-      return true;</span>
<a href="#l12.2790"></a><span id="l12.2790" class="difflineminus">-    }</span>
<a href="#l12.2791"></a><span id="l12.2791" class="difflineminus">-    if (key == 13 &amp;&amp; !document.getElementById(&quot;next_button&quot;).hidden</span>
<a href="#l12.2792"></a><span id="l12.2792" class="difflineminus">-                  &amp;&amp; !document.getElementById(&quot;next_button&quot;).disabled) {</span>
<a href="#l12.2793"></a><span id="l12.2793" class="difflineminus">-      this.onNext();</span>
<a href="#l12.2794"></a><span id="l12.2794" class="difflineminus">-      return true;</span>
<a href="#l12.2795"></a><span id="l12.2795" class="difflineminus">-    }</span>
<a href="#l12.2796"></a><span id="l12.2796" class="difflineminus">-    return false;</span>
<a href="#l12.2797"></a><span id="l12.2797" class="difflineminus">-  },</span>
<a href="#l12.2798"></a><span id="l12.2798" class="difflineminus">-</span>
<a href="#l12.2799"></a><span id="l12.2799" class="difflineminus">-  onWizardShutdown: function EmailConfigWizard_onWizardshutdown() {</span>
<a href="#l12.2800"></a><span id="l12.2800" class="difflineminus">-    if (this._probeAbortable)</span>
<a href="#l12.2801"></a><span id="l12.2801" class="difflineminus">-      this._probeAbortable.cancel();</span>
<a href="#l12.2802"></a><span id="l12.2802" class="difflineminus">-</span>
<a href="#l12.2803"></a><span id="l12.2803" class="difflineminus">-    if (this._okCallback)</span>
<a href="#l12.2804"></a><span id="l12.2804" class="difflineminus">-      this._okCallback();</span>
<a href="#l12.2805"></a><span id="l12.2805" class="difflineminus">-    gEmailWizardLogger.info(&quot;Shutting down email config dialog&quot;);</span>
<a href="#l12.2806"></a><span id="l12.2806" class="difflineminus">-  }</span>
<a href="#l12.2807"></a><span id="l12.2807"> };</span>
<a href="#l12.2808"></a><span id="l12.2808"> </span>
<a href="#l12.2809"></a><span id="l12.2809"> var gEmailConfigWizard = new EmailConfigWizard();</span>
<a href="#l12.2810"></a><span id="l12.2810"> gEmailWizardLogger.info(&quot;email account setup dialog&quot;);</span>
<a href="#l12.2811"></a><span id="l12.2811"> </span>
<a href="#l12.2812"></a><span id="l12.2812" class="difflineminus">-function sslLabel(val)</span>
<a href="#l12.2813"></a><span id="l12.2813" class="difflineplus">+</span>
<a href="#l12.2814"></a><span id="l12.2814" class="difflineplus">+function serverMatches(a, b)</span>
<a href="#l12.2815"></a><span id="l12.2815"> {</span>
<a href="#l12.2816"></a><span id="l12.2816" class="difflineminus">-  switch (val)</span>
<a href="#l12.2817"></a><span id="l12.2817" class="difflineminus">-  {</span>
<a href="#l12.2818"></a><span id="l12.2818" class="difflineminus">-    case 1:</span>
<a href="#l12.2819"></a><span id="l12.2819" class="difflineminus">-      return gStringsBundle.getString(&quot;no_encryption&quot;);</span>
<a href="#l12.2820"></a><span id="l12.2820" class="difflineminus">-    case 2:</span>
<a href="#l12.2821"></a><span id="l12.2821" class="difflineminus">-      return gStringsBundle.getString(&quot;ssl_tls&quot;);</span>
<a href="#l12.2822"></a><span id="l12.2822" class="difflineminus">-    case 3:</span>
<a href="#l12.2823"></a><span id="l12.2823" class="difflineminus">-      return gStringsBundle.getString(&quot;starttls&quot;);;</span>
<a href="#l12.2824"></a><span id="l12.2824" class="difflineminus">-    default:</span>
<a href="#l12.2825"></a><span id="l12.2825" class="difflineminus">-      throw new NotReached(&quot;Unknown SSL type&quot;);</span>
<a href="#l12.2826"></a><span id="l12.2826" class="difflineminus">-  }</span>
<a href="#l12.2827"></a><span id="l12.2827" class="difflineplus">+  return a.type == b.type &amp;&amp;</span>
<a href="#l12.2828"></a><span id="l12.2828" class="difflineplus">+         a.hostname == b.hostname &amp;&amp;</span>
<a href="#l12.2829"></a><span id="l12.2829" class="difflineplus">+         a.port == b.port &amp;&amp;</span>
<a href="#l12.2830"></a><span id="l12.2830" class="difflineplus">+         a.socketType == b.socketType &amp;&amp;</span>
<a href="#l12.2831"></a><span id="l12.2831" class="difflineplus">+         a.auth == b.auth;</span>
<a href="#l12.2832"></a><span id="l12.2832" class="difflineplus">+}</span>
<a href="#l12.2833"></a><span id="l12.2833" class="difflineplus">+</span>
<a href="#l12.2834"></a><span id="l12.2834" class="difflineplus">+var _gStandardPorts = {};</span>
<a href="#l12.2835"></a><span id="l12.2835" class="difflineplus">+_gStandardPorts[&quot;imap&quot;] = [ 143, 993 ];</span>
<a href="#l12.2836"></a><span id="l12.2836" class="difflineplus">+_gStandardPorts[&quot;pop3&quot;] = [ 110, 995 ];</span>
<a href="#l12.2837"></a><span id="l12.2837" class="difflineplus">+_gStandardPorts[&quot;smtp&quot;] = [ 587, 25, 465 ]; // order matters</span>
<a href="#l12.2838"></a><span id="l12.2838" class="difflineplus">+var _gAllStandardPorts = _gStandardPorts[&quot;smtp&quot;]</span>
<a href="#l12.2839"></a><span id="l12.2839" class="difflineplus">+    .concat(_gStandardPorts[&quot;imap&quot;]).concat(_gStandardPorts[&quot;pop3&quot;]);</span>
<a href="#l12.2840"></a><span id="l12.2840" class="difflineplus">+</span>
<a href="#l12.2841"></a><span id="l12.2841" class="difflineplus">+function isStandardPort(port)</span>
<a href="#l12.2842"></a><span id="l12.2842" class="difflineplus">+{</span>
<a href="#l12.2843"></a><span id="l12.2843" class="difflineplus">+  return _gAllStandardPorts.indexOf(port) != -1;</span>
<a href="#l12.2844"></a><span id="l12.2844" class="difflineplus">+}</span>
<a href="#l12.2845"></a><span id="l12.2845" class="difflineplus">+</span>
<a href="#l12.2846"></a><span id="l12.2846" class="difflineplus">+function getStandardPorts(protocolType)</span>
<a href="#l12.2847"></a><span id="l12.2847" class="difflineplus">+{</span>
<a href="#l12.2848"></a><span id="l12.2848" class="difflineplus">+  return _gStandardPorts[protocolType];</span>
<a href="#l12.2849"></a><span id="l12.2849"> }</span>
<a href="#l12.2850"></a><span id="l12.2850"> </span>
<a href="#l12.2851"></a><span id="l12.2851"> </span>
<a href="#l12.2852"></a><span id="l12.2852" class="difflineminus">-function setText(id, value)</span>
<a href="#l12.2853"></a><span id="l12.2853" class="difflineplus">+/**</span>
<a href="#l12.2854"></a><span id="l12.2854" class="difflineplus">+ * Warning dialog, warning user about lack of, or inappropriate, encryption.</span>
<a href="#l12.2855"></a><span id="l12.2855" class="difflineplus">+ *</span>
<a href="#l12.2856"></a><span id="l12.2856" class="difflineplus">+ * This is effectively a separate dialog, but implemented as part of</span>
<a href="#l12.2857"></a><span id="l12.2857" class="difflineplus">+ * this dialog. It works by hiding the main dialog part and unhiding</span>
<a href="#l12.2858"></a><span id="l12.2858" class="difflineplus">+ * the this part, and vice versa, and resizing the dialog.</span>
<a href="#l12.2859"></a><span id="l12.2859" class="difflineplus">+ */</span>
<a href="#l12.2860"></a><span id="l12.2860" class="difflineplus">+function SecurityWarningDialog()</span>
<a href="#l12.2861"></a><span id="l12.2861" class="difflineplus">+{</span>
<a href="#l12.2862"></a><span id="l12.2862" class="difflineplus">+  this._acknowledged = new Array();</span>
<a href="#l12.2863"></a><span id="l12.2863" class="difflineplus">+}</span>
<a href="#l12.2864"></a><span id="l12.2864" class="difflineplus">+SecurityWarningDialog.prototype =</span>
<a href="#l12.2865"></a><span id="l12.2865"> {</span>
<a href="#l12.2866"></a><span id="l12.2866" class="difflineminus">-  var element = document.getElementById(id);</span>
<a href="#l12.2867"></a><span id="l12.2867" class="difflineminus">-  if (!element)</span>
<a href="#l12.2868"></a><span id="l12.2868" class="difflineminus">-    return;</span>
<a href="#l12.2869"></a><span id="l12.2869" class="difflineplus">+  /**</span>
<a href="#l12.2870"></a><span id="l12.2870" class="difflineplus">+   * {Array of {(incoming or outgoing) server part of {AccountConfig}}</span>
<a href="#l12.2871"></a><span id="l12.2871" class="difflineplus">+   * A list of the servers for which we already showed this dialog and the</span>
<a href="#l12.2872"></a><span id="l12.2872" class="difflineplus">+   * user approved the configs. For those, we won't show the warning again.</span>
<a href="#l12.2873"></a><span id="l12.2873" class="difflineplus">+   * (Make sure to store a copy in case the underlying object is changed.)</span>
<a href="#l12.2874"></a><span id="l12.2874" class="difflineplus">+   */</span>
<a href="#l12.2875"></a><span id="l12.2875" class="difflineplus">+  _acknowledged : null,</span>
<a href="#l12.2876"></a><span id="l12.2876" class="difflineplus">+</span>
<a href="#l12.2877"></a><span id="l12.2877" class="difflineplus">+  /**</span>
<a href="#l12.2878"></a><span id="l12.2878" class="difflineplus">+   * Checks whether we need to warn about this config.</span>
<a href="#l12.2879"></a><span id="l12.2879" class="difflineplus">+   *</span>
<a href="#l12.2880"></a><span id="l12.2880" class="difflineplus">+   * We (currently) warn if</span>
<a href="#l12.2881"></a><span id="l12.2881" class="difflineplus">+   * - the mail travels unsecured (no SSL/STARTTLS)</span>
<a href="#l12.2882"></a><span id="l12.2882" class="difflineplus">+   * - the SSL certificate is not proper</span>
<a href="#l12.2883"></a><span id="l12.2883" class="difflineplus">+   * - (We don't warn about unencrypted passwords specifically,</span>
<a href="#l12.2884"></a><span id="l12.2884" class="difflineplus">+   *   because they'd be encrypted with SSL and without SSL, we'd</span>
<a href="#l12.2885"></a><span id="l12.2885" class="difflineplus">+   *   warn anyways.)</span>
<a href="#l12.2886"></a><span id="l12.2886" class="difflineplus">+   *</span>
<a href="#l12.2887"></a><span id="l12.2887" class="difflineplus">+   * We may not warn despite these conditions if we had shown the</span>
<a href="#l12.2888"></a><span id="l12.2888" class="difflineplus">+   * warning for that server before and the user acknowledged it.</span>
<a href="#l12.2889"></a><span id="l12.2889" class="difflineplus">+   * (Given that this dialog object is static/global and persistent,</span>
<a href="#l12.2890"></a><span id="l12.2890" class="difflineplus">+   * we can store that approval state here in this object.)</span>
<a href="#l12.2891"></a><span id="l12.2891" class="difflineplus">+   *</span>
<a href="#l12.2892"></a><span id="l12.2892" class="difflineplus">+   * @param configSchema @see open()</span>
<a href="#l12.2893"></a><span id="l12.2893" class="difflineplus">+   * @param configFilledIn @see open()</span>
<a href="#l12.2894"></a><span id="l12.2894" class="difflineplus">+   * @returns {Boolean}   true when the dialog should be shown</span>
<a href="#l12.2895"></a><span id="l12.2895" class="difflineplus">+   *      (call open()). if false, the dialog can and should be skipped.</span>
<a href="#l12.2896"></a><span id="l12.2896" class="difflineplus">+   */</span>
<a href="#l12.2897"></a><span id="l12.2897" class="difflineplus">+  needed : function(configSchema, configFilledIn)</span>
<a href="#l12.2898"></a><span id="l12.2898" class="difflineplus">+  {</span>
<a href="#l12.2899"></a><span id="l12.2899" class="difflineplus">+    assert(configSchema instanceof AccountConfig);</span>
<a href="#l12.2900"></a><span id="l12.2900" class="difflineplus">+    assert(configFilledIn instanceof AccountConfig);</span>
<a href="#l12.2901"></a><span id="l12.2901" class="difflineplus">+    assert(configSchema.isComplete());</span>
<a href="#l12.2902"></a><span id="l12.2902" class="difflineplus">+    assert(configFilledIn.isComplete());</span>
<a href="#l12.2903"></a><span id="l12.2903" class="difflineplus">+</span>
<a href="#l12.2904"></a><span id="l12.2904" class="difflineplus">+    var incomingOK = configFilledIn.incoming.socketType &gt; 1 &amp;&amp;</span>
<a href="#l12.2905"></a><span id="l12.2905" class="difflineplus">+        !configFilledIn.incoming.badCert;</span>
<a href="#l12.2906"></a><span id="l12.2906" class="difflineplus">+    var outgoingOK = configFilledIn.outgoing.socketType &gt; 1 &amp;&amp;</span>
<a href="#l12.2907"></a><span id="l12.2907" class="difflineplus">+        !configFilledIn.outgoing.badCert;</span>
<a href="#l12.2908"></a><span id="l12.2908" class="difflineplus">+</span>
<a href="#l12.2909"></a><span id="l12.2909" class="difflineplus">+    if (!incomingOK) {</span>
<a href="#l12.2910"></a><span id="l12.2910" class="difflineplus">+      incomingOK = this._acknowledged.some(</span>
<a href="#l12.2911"></a><span id="l12.2911" class="difflineplus">+          function(ackServer) {</span>
<a href="#l12.2912"></a><span id="l12.2912" class="difflineplus">+            return serverMatches(ackServer, configFilledIn.incoming);</span>
<a href="#l12.2913"></a><span id="l12.2913" class="difflineplus">+          });</span>
<a href="#l12.2914"></a><span id="l12.2914" class="difflineplus">+    }</span>
<a href="#l12.2915"></a><span id="l12.2915" class="difflineplus">+    if (!outgoingOK) {</span>
<a href="#l12.2916"></a><span id="l12.2916" class="difflineplus">+      outgoingOK = this._acknowledged.some(</span>
<a href="#l12.2917"></a><span id="l12.2917" class="difflineplus">+          function(ackServer) {</span>
<a href="#l12.2918"></a><span id="l12.2918" class="difflineplus">+            return serverMatches(ackServer, configFilledIn.outgoing);</span>
<a href="#l12.2919"></a><span id="l12.2919" class="difflineplus">+          });</span>
<a href="#l12.2920"></a><span id="l12.2920" class="difflineplus">+    }</span>
<a href="#l12.2921"></a><span id="l12.2921" class="difflineplus">+    return !incomingOK || !outgoingOK;</span>
<a href="#l12.2922"></a><span id="l12.2922" class="difflineplus">+  },</span>
<a href="#l12.2923"></a><span id="l12.2923" class="difflineplus">+</span>
<a href="#l12.2924"></a><span id="l12.2924" class="difflineplus">+  /**</span>
<a href="#l12.2925"></a><span id="l12.2925" class="difflineplus">+   * Opens the dialog, fills it with values, and shows it to the user.</span>
<a href="#l12.2926"></a><span id="l12.2926" class="difflineplus">+   *</span>
<a href="#l12.2927"></a><span id="l12.2927" class="difflineplus">+   * The function is async: it returns immediately, and when the user clicks</span>
<a href="#l12.2928"></a><span id="l12.2928" class="difflineplus">+   * OK or Cancel, the callbacks are called. There the callers proceed as</span>
<a href="#l12.2929"></a><span id="l12.2929" class="difflineplus">+   * appropriate.</span>
<a href="#l12.2930"></a><span id="l12.2930" class="difflineplus">+   *</span>
<a href="#l12.2931"></a><span id="l12.2931" class="difflineplus">+   * @param configSchema   The config, with placeholders not replaced yet.</span>
<a href="#l12.2932"></a><span id="l12.2932" class="difflineplus">+   *      This object may be modified to store the user's confirmations, but</span>
<a href="#l12.2933"></a><span id="l12.2933" class="difflineplus">+   *      currently that's not the case.</span>
<a href="#l12.2934"></a><span id="l12.2934" class="difflineplus">+   * @param configFilledIn   The concrete config with placeholders replaced.</span>
<a href="#l12.2935"></a><span id="l12.2935" class="difflineplus">+   * @param onlyIfNeeded {Boolean}   If there is nothing to warn about,</span>
<a href="#l12.2936"></a><span id="l12.2936" class="difflineplus">+   *     call okCallback() immediately (and sync).</span>
<a href="#l12.2937"></a><span id="l12.2937" class="difflineplus">+   * @param okCallback {function(config {AccountConfig})}</span>
<a href="#l12.2938"></a><span id="l12.2938" class="difflineplus">+   *      Called when the user clicked OK and approved the config including</span>
<a href="#l12.2939"></a><span id="l12.2939" class="difflineplus">+   *      the warnings. |config| is without placeholders replaced.</span>
<a href="#l12.2940"></a><span id="l12.2940" class="difflineplus">+   * @param cancalCallback {function()}</span>
<a href="#l12.2941"></a><span id="l12.2941" class="difflineplus">+   *      Called when the user decided to heed the warnings and not approve.</span>
<a href="#l12.2942"></a><span id="l12.2942" class="difflineplus">+   */</span>
<a href="#l12.2943"></a><span id="l12.2943" class="difflineplus">+  open : function(configSchema, configFilledIn, onlyIfNeeded,</span>
<a href="#l12.2944"></a><span id="l12.2944" class="difflineplus">+                  okCallback, cancelCallback)</span>
<a href="#l12.2945"></a><span id="l12.2945" class="difflineplus">+  {</span>
<a href="#l12.2946"></a><span id="l12.2946" class="difflineplus">+    assert(typeof(okCallback) == &quot;function&quot;);</span>
<a href="#l12.2947"></a><span id="l12.2947" class="difflineplus">+    assert(typeof(cancelCallback) == &quot;function&quot;);</span>
<a href="#l12.2948"></a><span id="l12.2948" class="difflineplus">+    // needed() also checks the parameters</span>
<a href="#l12.2949"></a><span id="l12.2949" class="difflineplus">+    var needed = this.needed(configSchema, configFilledIn);</span>
<a href="#l12.2950"></a><span id="l12.2950" class="difflineplus">+    if (!needed &amp;&amp; onlyIfNeeded) {</span>
<a href="#l12.2951"></a><span id="l12.2951" class="difflineplus">+      okCallback();</span>
<a href="#l12.2952"></a><span id="l12.2952" class="difflineplus">+      return;</span>
<a href="#l12.2953"></a><span id="l12.2953" class="difflineplus">+    }</span>
<a href="#l12.2954"></a><span id="l12.2954" class="difflineplus">+    assert(needed, &quot;security dialog opened needlessly&quot;);</span>
<a href="#l12.2955"></a><span id="l12.2955" class="difflineplus">+    this._currentConfigFilledIn = configFilledIn;</span>
<a href="#l12.2956"></a><span id="l12.2956" class="difflineplus">+    this._okCallback = okCallback;</span>
<a href="#l12.2957"></a><span id="l12.2957" class="difflineplus">+    this._cancelCallback = cancelCallback;</span>
<a href="#l12.2958"></a><span id="l12.2958" class="difflineplus">+    var incoming = configFilledIn.incoming;</span>
<a href="#l12.2959"></a><span id="l12.2959" class="difflineplus">+    var outgoing = configFilledIn.outgoing;</span>
<a href="#l12.2960"></a><span id="l12.2960" class="difflineplus">+</span>
<a href="#l12.2961"></a><span id="l12.2961" class="difflineplus">+    _hide(&quot;mastervbox&quot;);</span>
<a href="#l12.2962"></a><span id="l12.2962" class="difflineplus">+    _show(&quot;warningbox&quot;);</span>
<a href="#l12.2963"></a><span id="l12.2963" class="difflineplus">+    // reset dialog, in case we've shown it before</span>
<a href="#l12.2964"></a><span id="l12.2964" class="difflineplus">+    e(&quot;acknowledge_warning&quot;).checked = false;</span>
<a href="#l12.2965"></a><span id="l12.2965" class="difflineplus">+    _disable(&quot;iknow&quot;);</span>
<a href="#l12.2966"></a><span id="l12.2966" class="difflineplus">+    e(&quot;incoming_technical&quot;).removeAttribute(&quot;expanded&quot;);</span>
<a href="#l12.2967"></a><span id="l12.2967" class="difflineplus">+    e(&quot;incoming_details&quot;).setAttribute(&quot;collapsed&quot;, true);</span>
<a href="#l12.2968"></a><span id="l12.2968" class="difflineplus">+    e(&quot;outgoing_technical&quot;).removeAttribute(&quot;expanded&quot;);</span>
<a href="#l12.2969"></a><span id="l12.2969" class="difflineplus">+    e(&quot;outgoing_details&quot;).setAttribute(&quot;collapsed&quot;, true);</span>
<a href="#l12.2970"></a><span id="l12.2970" class="difflineplus">+</span>
<a href="#l12.2971"></a><span id="l12.2971" class="difflineplus">+    if (incoming.socketType == 1) {</span>
<a href="#l12.2972"></a><span id="l12.2972" class="difflineplus">+      setText(&quot;warning_incoming&quot;, gStringsBundle.getFormattedString(</span>
<a href="#l12.2973"></a><span id="l12.2973" class="difflineplus">+          &quot;cleartext_warning&quot;, [incoming.hostname]));</span>
<a href="#l12.2974"></a><span id="l12.2974" class="difflineplus">+      setText(&quot;incoming_details&quot;, gStringsBundle.getString(</span>
<a href="#l12.2975"></a><span id="l12.2975" class="difflineplus">+          &quot;cleartext_details&quot;));</span>
<a href="#l12.2976"></a><span id="l12.2976" class="difflineplus">+      _show(&quot;incoming_box&quot;);</span>
<a href="#l12.2977"></a><span id="l12.2977" class="difflineplus">+      _show(&quot;acknowledge_warning&quot;);</span>
<a href="#l12.2978"></a><span id="l12.2978" class="difflineplus">+    } else if (incoming.badCert) {</span>
<a href="#l12.2979"></a><span id="l12.2979" class="difflineplus">+      setText(&quot;warning_incoming&quot;, gStringsBundle.getFormattedString(</span>
<a href="#l12.2980"></a><span id="l12.2980" class="difflineplus">+          &quot;selfsigned_warning&quot;, [incoming.hostname]));</span>
<a href="#l12.2981"></a><span id="l12.2981" class="difflineplus">+      setText(&quot;incoming_details&quot;, gStringsBundle.getString(</span>
<a href="#l12.2982"></a><span id="l12.2982" class="difflineplus">+          &quot;selfsigned_details&quot;));</span>
<a href="#l12.2983"></a><span id="l12.2983" class="difflineplus">+      _show(&quot;incoming_box&quot;);</span>
<a href="#l12.2984"></a><span id="l12.2984" class="difflineplus">+      _show(&quot;acknowledge_warning&quot;);</span>
<a href="#l12.2985"></a><span id="l12.2985" class="difflineplus">+    } else {</span>
<a href="#l12.2986"></a><span id="l12.2986" class="difflineplus">+      _hide(&quot;incoming_box&quot;);</span>
<a href="#l12.2987"></a><span id="l12.2987" class="difflineplus">+      _hide(&quot;acknowledge_warning&quot;);</span>
<a href="#l12.2988"></a><span id="l12.2988" class="difflineplus">+    }</span>
<a href="#l12.2989"></a><span id="l12.2989"> </span>
<a href="#l12.2990"></a><span id="l12.2990" class="difflineminus">-  if (element.localName == &quot;textbox&quot; || element.localName == &quot;label&quot;)</span>
<a href="#l12.2991"></a><span id="l12.2991" class="difflineminus">-    element.value = value;</span>
<a href="#l12.2992"></a><span id="l12.2992" class="difflineminus">-  else if (element.localName == &quot;description&quot;)</span>
<a href="#l12.2993"></a><span id="l12.2993" class="difflineminus">-    element.textContent = value;</span>
<a href="#l12.2994"></a><span id="l12.2994" class="difflineminus">-  else</span>
<a href="#l12.2995"></a><span id="l12.2995" class="difflineminus">-    throw new NotReached(&quot;XUL element type not supported&quot;);</span>
<a href="#l12.2996"></a><span id="l12.2996" class="difflineplus">+    if (outgoing.socketType == 1) {</span>
<a href="#l12.2997"></a><span id="l12.2997" class="difflineplus">+      setText(&quot;warning_outgoing&quot;, gStringsBundle.getFormattedString(</span>
<a href="#l12.2998"></a><span id="l12.2998" class="difflineplus">+          &quot;cleartext_warning&quot;, [outgoing.hostname]));</span>
<a href="#l12.2999"></a><span id="l12.2999" class="difflineplus">+      setText(&quot;outgoing_details&quot;, gStringsBundle.getString(</span>
<a href="#l12.3000"></a><span id="l12.3000" class="difflineplus">+          &quot;cleartext_details&quot;));</span>
<a href="#l12.3001"></a><span id="l12.3001" class="difflineplus">+      _show(&quot;outgoing_box&quot;);</span>
<a href="#l12.3002"></a><span id="l12.3002" class="difflineplus">+      _show(&quot;acknowledge_warning&quot;);</span>
<a href="#l12.3003"></a><span id="l12.3003" class="difflineplus">+    } else if (outgoing.badCert) {</span>
<a href="#l12.3004"></a><span id="l12.3004" class="difflineplus">+      setText(&quot;warning_outgoing&quot;, gStringsBundle.getFormattedString(</span>
<a href="#l12.3005"></a><span id="l12.3005" class="difflineplus">+          &quot;selfsigned_warning&quot;, [outgoing.hostname]));</span>
<a href="#l12.3006"></a><span id="l12.3006" class="difflineplus">+      setText(&quot;outgoing_details&quot;, gStringsBundle.getString(</span>
<a href="#l12.3007"></a><span id="l12.3007" class="difflineplus">+          &quot;selfsigned_details&quot;));</span>
<a href="#l12.3008"></a><span id="l12.3008" class="difflineplus">+      _show(&quot;outgoing_box&quot;);</span>
<a href="#l12.3009"></a><span id="l12.3009" class="difflineplus">+      _show(&quot;acknowledge_warning&quot;);</span>
<a href="#l12.3010"></a><span id="l12.3010" class="difflineplus">+    } else {</span>
<a href="#l12.3011"></a><span id="l12.3011" class="difflineplus">+      _hide(&quot;outgoing_box&quot;);</span>
<a href="#l12.3012"></a><span id="l12.3012" class="difflineplus">+    }</span>
<a href="#l12.3013"></a><span id="l12.3013" class="difflineplus">+    window.sizeToContent();</span>
<a href="#l12.3014"></a><span id="l12.3014" class="difflineplus">+  },</span>
<a href="#l12.3015"></a><span id="l12.3015" class="difflineplus">+</span>
<a href="#l12.3016"></a><span id="l12.3016" class="difflineplus">+  toggleDetails : function (id)</span>
<a href="#l12.3017"></a><span id="l12.3017" class="difflineplus">+  {</span>
<a href="#l12.3018"></a><span id="l12.3018" class="difflineplus">+    let details = e(id + &quot;_details&quot;);</span>
<a href="#l12.3019"></a><span id="l12.3019" class="difflineplus">+    let tech = e(id + &quot;_technical&quot;);</span>
<a href="#l12.3020"></a><span id="l12.3020" class="difflineplus">+    if (details.getAttribute(&quot;collapsed&quot;)) {</span>
<a href="#l12.3021"></a><span id="l12.3021" class="difflineplus">+      details.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l12.3022"></a><span id="l12.3022" class="difflineplus">+      tech.setAttribute(&quot;expanded&quot;, true);</span>
<a href="#l12.3023"></a><span id="l12.3023" class="difflineplus">+    } else {</span>
<a href="#l12.3024"></a><span id="l12.3024" class="difflineplus">+      details.setAttribute(&quot;collapsed&quot;, true);</span>
<a href="#l12.3025"></a><span id="l12.3025" class="difflineplus">+      tech.removeAttribute(&quot;expanded&quot;);</span>
<a href="#l12.3026"></a><span id="l12.3026" class="difflineplus">+    }</span>
<a href="#l12.3027"></a><span id="l12.3027" class="difflineplus">+  },</span>
<a href="#l12.3028"></a><span id="l12.3028" class="difflineplus">+</span>
<a href="#l12.3029"></a><span id="l12.3029" class="difflineplus">+  /**</span>
<a href="#l12.3030"></a><span id="l12.3030" class="difflineplus">+   * user checked checkbox that he understood it and wishes</span>
<a href="#l12.3031"></a><span id="l12.3031" class="difflineplus">+   * to ignore the warning.</span>
<a href="#l12.3032"></a><span id="l12.3032" class="difflineplus">+   */</span>
<a href="#l12.3033"></a><span id="l12.3033" class="difflineplus">+  toggleAcknowledge : function()</span>
<a href="#l12.3034"></a><span id="l12.3034" class="difflineplus">+  {</span>
<a href="#l12.3035"></a><span id="l12.3035" class="difflineplus">+    if (e(&quot;acknowledge_warning&quot;).checked) {</span>
<a href="#l12.3036"></a><span id="l12.3036" class="difflineplus">+      _enable(&quot;iknow&quot;);</span>
<a href="#l12.3037"></a><span id="l12.3037" class="difflineplus">+    } else {</span>
<a href="#l12.3038"></a><span id="l12.3038" class="difflineplus">+      _disable(&quot;iknow&quot;);</span>
<a href="#l12.3039"></a><span id="l12.3039" class="difflineplus">+    }</span>
<a href="#l12.3040"></a><span id="l12.3040" class="difflineplus">+  },</span>
<a href="#l12.3041"></a><span id="l12.3041" class="difflineplus">+</span>
<a href="#l12.3042"></a><span id="l12.3042" class="difflineplus">+  /**</span>
<a href="#l12.3043"></a><span id="l12.3043" class="difflineplus">+   * [Cancel] button pressed. Get me out of here!</span>
<a href="#l12.3044"></a><span id="l12.3044" class="difflineplus">+   */</span>
<a href="#l12.3045"></a><span id="l12.3045" class="difflineplus">+  onCancel : function()</span>
<a href="#l12.3046"></a><span id="l12.3046" class="difflineplus">+  {</span>
<a href="#l12.3047"></a><span id="l12.3047" class="difflineplus">+    _hide(&quot;warningbox&quot;);</span>
<a href="#l12.3048"></a><span id="l12.3048" class="difflineplus">+    _show(&quot;mastervbox&quot;);</span>
<a href="#l12.3049"></a><span id="l12.3049" class="difflineplus">+    window.sizeToContent();</span>
<a href="#l12.3050"></a><span id="l12.3050" class="difflineplus">+</span>
<a href="#l12.3051"></a><span id="l12.3051" class="difflineplus">+    this._cancelCallback();</span>
<a href="#l12.3052"></a><span id="l12.3052" class="difflineplus">+  },</span>
<a href="#l12.3053"></a><span id="l12.3053" class="difflineplus">+</span>
<a href="#l12.3054"></a><span id="l12.3054" class="difflineplus">+  /**</span>
<a href="#l12.3055"></a><span id="l12.3055" class="difflineplus">+   * [OK] button pressed.</span>
<a href="#l12.3056"></a><span id="l12.3056" class="difflineplus">+   * Implies that the user toggled the acknowledge checkbox,</span>
<a href="#l12.3057"></a><span id="l12.3057" class="difflineplus">+   * i.e. approved the config and ignored the warnings,</span>
<a href="#l12.3058"></a><span id="l12.3058" class="difflineplus">+   * otherwise the button would have been disabled.</span>
<a href="#l12.3059"></a><span id="l12.3059" class="difflineplus">+   */</span>
<a href="#l12.3060"></a><span id="l12.3060" class="difflineplus">+  onOK : function()</span>
<a href="#l12.3061"></a><span id="l12.3061" class="difflineplus">+  {</span>
<a href="#l12.3062"></a><span id="l12.3062" class="difflineplus">+    assert(e(&quot;acknowledge_warning&quot;).checked);</span>
<a href="#l12.3063"></a><span id="l12.3063" class="difflineplus">+</span>
<a href="#l12.3064"></a><span id="l12.3064" class="difflineplus">+    var overrideOK = this.showCertOverrideDialog(this._currentConfigFilledIn);</span>
<a href="#l12.3065"></a><span id="l12.3065" class="difflineplus">+    if (!overrideOK) {</span>
<a href="#l12.3066"></a><span id="l12.3066" class="difflineplus">+      this.onCancel();</span>
<a href="#l12.3067"></a><span id="l12.3067" class="difflineplus">+      return;</span>
<a href="#l12.3068"></a><span id="l12.3068" class="difflineplus">+    }</span>
<a href="#l12.3069"></a><span id="l12.3069" class="difflineplus">+</span>
<a href="#l12.3070"></a><span id="l12.3070" class="difflineplus">+    // need filled in, in case hostname is placeholder</span>
<a href="#l12.3071"></a><span id="l12.3071" class="difflineplus">+    var storeConfig = this._currentConfigFilledIn.copy();</span>
<a href="#l12.3072"></a><span id="l12.3072" class="difflineplus">+    this._acknowledged.push(storeConfig.incoming);</span>
<a href="#l12.3073"></a><span id="l12.3073" class="difflineplus">+    this._acknowledged.push(storeConfig.outgoing);</span>
<a href="#l12.3074"></a><span id="l12.3074" class="difflineplus">+</span>
<a href="#l12.3075"></a><span id="l12.3075" class="difflineplus">+    _show(&quot;mastervbox&quot;);</span>
<a href="#l12.3076"></a><span id="l12.3076" class="difflineplus">+    _hide(&quot;warningbox&quot;);</span>
<a href="#l12.3077"></a><span id="l12.3077" class="difflineplus">+    window.sizeToContent();</span>
<a href="#l12.3078"></a><span id="l12.3078" class="difflineplus">+</span>
<a href="#l12.3079"></a><span id="l12.3079" class="difflineplus">+    this._okCallback();</span>
<a href="#l12.3080"></a><span id="l12.3080" class="difflineplus">+  },</span>
<a href="#l12.3081"></a><span id="l12.3081" class="difflineplus">+</span>
<a href="#l12.3082"></a><span id="l12.3082" class="difflineplus">+  /**</span>
<a href="#l12.3083"></a><span id="l12.3083" class="difflineplus">+   * Shows a(nother) dialog which allows the user to see and override</span>
<a href="#l12.3084"></a><span id="l12.3084" class="difflineplus">+   * (manually accept) a bad certificate. It also optionally adds it</span>
<a href="#l12.3085"></a><span id="l12.3085" class="difflineplus">+   * permanently to the &quot;good certs&quot; store of NSS in the profile.</span>
<a href="#l12.3086"></a><span id="l12.3086" class="difflineplus">+   * Only shows the dialog, if there are bad certs. Otherwise, it's a no-op.</span>
<a href="#l12.3087"></a><span id="l12.3087" class="difflineplus">+   *</span>
<a href="#l12.3088"></a><span id="l12.3088" class="difflineplus">+   * The dialog is the standard PSM cert override dialog.</span>
<a href="#l12.3089"></a><span id="l12.3089" class="difflineplus">+   *</span>
<a href="#l12.3090"></a><span id="l12.3090" class="difflineplus">+   * @param config {AccountConfig} concrete</span>
<a href="#l12.3091"></a><span id="l12.3091" class="difflineplus">+   * @returns true, if all certs are fine or the user accepted them.</span>
<a href="#l12.3092"></a><span id="l12.3092" class="difflineplus">+   *     false, if the user cancelled.</span>
<a href="#l12.3093"></a><span id="l12.3093" class="difflineplus">+   *</span>
<a href="#l12.3094"></a><span id="l12.3094" class="difflineplus">+   * static function</span>
<a href="#l12.3095"></a><span id="l12.3095" class="difflineplus">+   * sync function: blocks until the dialog is closed.</span>
<a href="#l12.3096"></a><span id="l12.3096" class="difflineplus">+   */</span>
<a href="#l12.3097"></a><span id="l12.3097" class="difflineplus">+  showCertOverrideDialog : function(config)</span>
<a href="#l12.3098"></a><span id="l12.3098" class="difflineplus">+  {</span>
<a href="#l12.3099"></a><span id="l12.3099" class="difflineplus">+    if (config.incoming.socketType &gt; 1 &amp;&amp; // SSL or STARTTLS</span>
<a href="#l12.3100"></a><span id="l12.3100" class="difflineplus">+        config.incoming.badCert) {</span>
<a href="#l12.3101"></a><span id="l12.3101" class="difflineplus">+      var params = {</span>
<a href="#l12.3102"></a><span id="l12.3102" class="difflineplus">+        exceptionAdded : false,</span>
<a href="#l12.3103"></a><span id="l12.3103" class="difflineplus">+        prefetchCert : true,</span>
<a href="#l12.3104"></a><span id="l12.3104" class="difflineplus">+        location : config.incoming.targetSite,</span>
<a href="#l12.3105"></a><span id="l12.3105" class="difflineplus">+      };</span>
<a href="#l12.3106"></a><span id="l12.3106" class="difflineplus">+      window.openDialog(&quot;chrome://pippki/content/exceptionDialog.xul&quot;,</span>
<a href="#l12.3107"></a><span id="l12.3107" class="difflineplus">+                        &quot;&quot;,&quot;chrome,centerscreen,modal&quot;, params);</span>
<a href="#l12.3108"></a><span id="l12.3108" class="difflineplus">+      if (params.exceptionAdded) { // set by dialog</span>
<a href="#l12.3109"></a><span id="l12.3109" class="difflineplus">+        config.incoming.badCert = false;</span>
<a href="#l12.3110"></a><span id="l12.3110" class="difflineplus">+      } else {</span>
<a href="#l12.3111"></a><span id="l12.3111" class="difflineplus">+        return false;</span>
<a href="#l12.3112"></a><span id="l12.3112" class="difflineplus">+      }</span>
<a href="#l12.3113"></a><span id="l12.3113" class="difflineplus">+    }</span>
<a href="#l12.3114"></a><span id="l12.3114" class="difflineplus">+    if (!config.outgoing.existingServerKey) {</span>
<a href="#l12.3115"></a><span id="l12.3115" class="difflineplus">+      if (config.outgoing.socketType &gt; 1 &amp;&amp; // SSL or STARTTLS</span>
<a href="#l12.3116"></a><span id="l12.3116" class="difflineplus">+          config.outgoing.badCert) {</span>
<a href="#l12.3117"></a><span id="l12.3117" class="difflineplus">+        var params = {</span>
<a href="#l12.3118"></a><span id="l12.3118" class="difflineplus">+          exceptionAdded : false,</span>
<a href="#l12.3119"></a><span id="l12.3119" class="difflineplus">+          prefetchCert : true,</span>
<a href="#l12.3120"></a><span id="l12.3120" class="difflineplus">+          location : config.outgoing.targetSite,</span>
<a href="#l12.3121"></a><span id="l12.3121" class="difflineplus">+        };</span>
<a href="#l12.3122"></a><span id="l12.3122" class="difflineplus">+        window.openDialog(&quot;chrome://pippki/content/exceptionDialog.xul&quot;,</span>
<a href="#l12.3123"></a><span id="l12.3123" class="difflineplus">+                          &quot;&quot;,&quot;chrome,centerscreen,modal&quot;, params);</span>
<a href="#l12.3124"></a><span id="l12.3124" class="difflineplus">+        if (params.exceptionAdded) { // set by dialog</span>
<a href="#l12.3125"></a><span id="l12.3125" class="difflineplus">+          config.outgoing.badCert = false;</span>
<a href="#l12.3126"></a><span id="l12.3126" class="difflineplus">+        } else {</span>
<a href="#l12.3127"></a><span id="l12.3127" class="difflineplus">+          return false;</span>
<a href="#l12.3128"></a><span id="l12.3128" class="difflineplus">+        }</span>
<a href="#l12.3129"></a><span id="l12.3129" class="difflineplus">+      }</span>
<a href="#l12.3130"></a><span id="l12.3130" class="difflineplus">+    }</span>
<a href="#l12.3131"></a><span id="l12.3131" class="difflineplus">+    return true;</span>
<a href="#l12.3132"></a><span id="l12.3132" class="difflineplus">+  },</span>
<a href="#l12.3133"></a><span id="l12.3133"> }</span>
<a href="#l12.3134"></a><span id="l12.3134" class="difflineplus">+var gSecurityWarningDialog = new SecurityWarningDialog();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/emailWizard.xul</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/emailWizard.xul</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -31,40 +31,45 @@</span>
<a href="#l13.4"></a><span id="l13.4">    - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l13.5"></a><span id="l13.5">    - and other provisions required by the LGPL or the GPL. If you do not delete</span>
<a href="#l13.6"></a><span id="l13.6">    - the provisions above, a recipient may use your version of this file under</span>
<a href="#l13.7"></a><span id="l13.7">    - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l13.8"></a><span id="l13.8">    -</span>
<a href="#l13.9"></a><span id="l13.9">    - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> &lt;?xml-stylesheet href=&quot;chrome://global/skin/&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://messenger/skin/accountCreation.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://messenger/skin/accountCreation.css&quot;</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+                                              type=&quot;text/css&quot;?&gt;</span>
<a href="#l13.15"></a><span id="l13.15"> </span>
<a href="#l13.16"></a><span id="l13.16"> &lt;!DOCTYPE window [</span>
<a href="#l13.17"></a><span id="l13.17">   &lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot;&gt;</span>
<a href="#l13.18"></a><span id="l13.18">   %brandDTD;</span>
<a href="#l13.19"></a><span id="l13.19">   &lt;!ENTITY % acDTD SYSTEM &quot;chrome://messenger/locale/accountCreation.dtd&quot;&gt;</span>
<a href="#l13.20"></a><span id="l13.20">   %acDTD;</span>
<a href="#l13.21"></a><span id="l13.21"> ]&gt;</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23"> &lt;window xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l13.24"></a><span id="l13.24">         id=&quot;autoconfigWizard&quot;</span>
<a href="#l13.25"></a><span id="l13.25">         windowtype=&quot;mail:autoconfig&quot;</span>
<a href="#l13.26"></a><span id="l13.26">         title=&quot;&amp;autoconfigWizard.title;&quot;</span>
<a href="#l13.27"></a><span id="l13.27">         onload=&quot;gEmailConfigWizard.onLoad();&quot;</span>
<a href="#l13.28"></a><span id="l13.28">         onkeypress=&quot;gEmailConfigWizard.onKeyDown(event)&quot;</span>
<a href="#l13.29"></a><span id="l13.29">         onclose=&quot;gEmailConfigWizard.onWizardShutdown();&quot;</span>
<a href="#l13.30"></a><span id="l13.30">         onunload=&quot;gEmailConfigWizard.onWizardShutdown();&quot;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-        onfocus=&quot;gEmailConfigWizard.onFocus();&quot;</span>
<a href="#l13.32"></a><span id="l13.32">         &gt;</span>
<a href="#l13.33"></a><span id="l13.33"> </span>
<a href="#l13.34"></a><span id="l13.34">   &lt;stringbundleset&gt;</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-    &lt;stringbundle id=&quot;bundle_brand&quot; src=&quot;chrome://branding/locale/brand.properties&quot;/&gt;</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-    &lt;stringbundle id=&quot;strings&quot; src=&quot;chrome://messenger/locale/accountCreation.properties&quot;/&gt;</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-    &lt;stringbundle id=&quot;utilstrings&quot; src=&quot;chrome://messenger/locale/accountCreationUtil.properties&quot;/&gt;</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+    &lt;stringbundle id=&quot;bundle_brand&quot;</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+          src=&quot;chrome://branding/locale/brand.properties&quot;/&gt;</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+    &lt;stringbundle id=&quot;strings&quot;</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+          src=&quot;chrome://messenger/locale/accountCreation.properties&quot;/&gt;</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+    &lt;stringbundle id=&quot;utilstrings&quot;</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+          src=&quot;chrome://messenger/locale/accountCreationUtil.properties&quot;/&gt;</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+    &lt;stringbundle id=&quot;bundle_messenger&quot;</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+          src=&quot;chrome://messenger/locale/messenger.properties&quot;/&gt;</span>
<a href="#l13.46"></a><span id="l13.46">   &lt;/stringbundleset&gt;</span>
<a href="#l13.47"></a><span id="l13.47">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l13.48"></a><span id="l13.48">           src=&quot;chrome://messenger/content/accountcreation/util.js&quot;/&gt;</span>
<a href="#l13.49"></a><span id="l13.49">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l13.50"></a><span id="l13.50">           src=&quot;chrome://messenger/content/accountcreation/accountConfig.js&quot;/&gt;</span>
<a href="#l13.51"></a><span id="l13.51">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l13.52"></a><span id="l13.52">           src=&quot;chrome://messenger/content/accountcreation/emailWizard.js&quot;/&gt;</span>
<a href="#l13.53"></a><span id="l13.53">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineat">@@ -88,26 +93,28 @@</span>
<a href="#l13.55"></a><span id="l13.55">     &lt;key keycode=&quot;VK_ESCAPE&quot; oncommand=&quot;window.close();&quot;/&gt;</span>
<a href="#l13.56"></a><span id="l13.56">   &lt;/keyset&gt;</span>
<a href="#l13.57"></a><span id="l13.57"> </span>
<a href="#l13.58"></a><span id="l13.58">   &lt;panel id=&quot;insecureserver-cleartext-panel&quot; class=&quot;popup-panel&quot;&gt;</span>
<a href="#l13.59"></a><span id="l13.59">     &lt;hbox&gt;</span>
<a href="#l13.60"></a><span id="l13.60">       &lt;image class=&quot;insecureLarry&quot;/&gt;</span>
<a href="#l13.61"></a><span id="l13.61">       &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l13.62"></a><span id="l13.62">         &lt;description class=&quot;title&quot;&gt;&amp;insecureServer.tooltip.title;&lt;/description&gt;</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-        &lt;description class=&quot;details&quot;&gt;&amp;insecureUnencrypted.description;&lt;/description&gt;</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+        &lt;description class=&quot;details&quot;&gt;</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+                                &amp;insecureUnencrypted.description;&lt;/description&gt;</span>
<a href="#l13.66"></a><span id="l13.66">       &lt;/vbox&gt;</span>
<a href="#l13.67"></a><span id="l13.67">     &lt;/hbox&gt;</span>
<a href="#l13.68"></a><span id="l13.68">   &lt;/panel&gt;</span>
<a href="#l13.69"></a><span id="l13.69">   &lt;panel id=&quot;insecureserver-selfsigned-panel&quot; class=&quot;popup-panel&quot;&gt;</span>
<a href="#l13.70"></a><span id="l13.70">     &lt;hbox&gt;</span>
<a href="#l13.71"></a><span id="l13.71">       &lt;image class=&quot;insecureLarry&quot;/&gt;</span>
<a href="#l13.72"></a><span id="l13.72">       &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l13.73"></a><span id="l13.73">         &lt;description class=&quot;title&quot;&gt;&amp;insecureServer.tooltip.title;&lt;/description&gt;</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-        &lt;description class=&quot;details&quot;&gt;&amp;insecureSelfSigned.description;&lt;/description&gt;</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+        &lt;description class=&quot;details&quot;&gt;</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+                                 &amp;insecureSelfSigned.description;&lt;/description&gt;</span>
<a href="#l13.77"></a><span id="l13.77">       &lt;/vbox&gt;</span>
<a href="#l13.78"></a><span id="l13.78">     &lt;/hbox&gt;</span>
<a href="#l13.79"></a><span id="l13.79">   &lt;/panel&gt;</span>
<a href="#l13.80"></a><span id="l13.80">   &lt;panel id=&quot;secureserver-panel&quot; class=&quot;popup-panel&quot;&gt;</span>
<a href="#l13.81"></a><span id="l13.81">     &lt;hbox&gt;</span>
<a href="#l13.82"></a><span id="l13.82">       &lt;image class=&quot;secureLarry&quot;/&gt;</span>
<a href="#l13.83"></a><span id="l13.83">       &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l13.84"></a><span id="l13.84">         &lt;description class=&quot;title&quot;&gt;&amp;secureServer.description;&lt;/description&gt;</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineat">@@ -115,69 +122,71 @@</span>
<a href="#l13.86"></a><span id="l13.86">     &lt;/hbox&gt;</span>
<a href="#l13.87"></a><span id="l13.87">   &lt;/panel&gt;</span>
<a href="#l13.88"></a><span id="l13.88"> </span>
<a href="#l13.89"></a><span id="l13.89">   &lt;tooltip id=&quot;insecureserver-cleartext&quot;&gt;</span>
<a href="#l13.90"></a><span id="l13.90">     &lt;hbox&gt;</span>
<a href="#l13.91"></a><span id="l13.91">       &lt;image class=&quot;insecureLarry&quot;/&gt;</span>
<a href="#l13.92"></a><span id="l13.92">       &lt;vbox&gt;</span>
<a href="#l13.93"></a><span id="l13.93">         &lt;description class=&quot;title&quot;&gt;&amp;insecureServer.tooltip.title;&lt;/description&gt;</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineminus">-        &lt;description class=&quot;details&quot;&gt;&amp;insecureServer.tooltip.details;&lt;/description&gt;</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+        &lt;description class=&quot;details&quot;&gt;</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+                                 &amp;insecureServer.tooltip.details;&lt;/description&gt;</span>
<a href="#l13.97"></a><span id="l13.97">       &lt;/vbox&gt;</span>
<a href="#l13.98"></a><span id="l13.98">     &lt;/hbox&gt;</span>
<a href="#l13.99"></a><span id="l13.99">   &lt;/tooltip&gt;</span>
<a href="#l13.100"></a><span id="l13.100">   &lt;tooltip id=&quot;insecureserver-selfsigned&quot;&gt;</span>
<a href="#l13.101"></a><span id="l13.101">     &lt;hbox&gt;</span>
<a href="#l13.102"></a><span id="l13.102">       &lt;image class=&quot;insecureLarry&quot;/&gt;</span>
<a href="#l13.103"></a><span id="l13.103">       &lt;vbox&gt;</span>
<a href="#l13.104"></a><span id="l13.104">         &lt;description class=&quot;title&quot;&gt;&amp;insecureServer.tooltip.title;&lt;/description&gt;</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineminus">-        &lt;description class=&quot;details&quot;&gt;&amp;insecureServer.tooltip.details;&lt;/description&gt;</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+        &lt;description class=&quot;details&quot;&gt;</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+                                 &amp;insecureServer.tooltip.details;&lt;/description&gt;</span>
<a href="#l13.108"></a><span id="l13.108">       &lt;/vbox&gt;</span>
<a href="#l13.109"></a><span id="l13.109">     &lt;/hbox&gt;</span>
<a href="#l13.110"></a><span id="l13.110">   &lt;/tooltip&gt;</span>
<a href="#l13.111"></a><span id="l13.111">   &lt;tooltip id=&quot;secureservertooltip&quot;&gt;</span>
<a href="#l13.112"></a><span id="l13.112">     &lt;hbox&gt;</span>
<a href="#l13.113"></a><span id="l13.113">       &lt;image class=&quot;secureLarry&quot;/&gt;</span>
<a href="#l13.114"></a><span id="l13.114">       &lt;description class=&quot;title&quot;&gt;&amp;secureServer.description;&lt;/description&gt;</span>
<a href="#l13.115"></a><span id="l13.115">     &lt;/hbox&gt;</span>
<a href="#l13.116"></a><span id="l13.116">   &lt;/tooltip&gt;</span>
<a href="#l13.117"></a><span id="l13.117">   &lt;tooltip id=&quot;optional-password&quot;&gt;</span>
<a href="#l13.118"></a><span id="l13.118">     &lt;description&gt;&amp;password.text;&lt;/description&gt;</span>
<a href="#l13.119"></a><span id="l13.119">   &lt;/tooltip&gt;</span>
<a href="#l13.120"></a><span id="l13.120"> </span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+  &lt;spacer id=&quot;fullwidth&quot;/&gt;</span>
<a href="#l13.122"></a><span id="l13.122"> </span>
<a href="#l13.123"></a><span id="l13.123">   &lt;vbox id=&quot;mastervbox&quot; class=&quot;mastervbox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l13.124"></a><span id="l13.124">     &lt;groupbox id=&quot;initialSettings&quot;&gt;</span>
<a href="#l13.125"></a><span id="l13.125">       &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l13.126"></a><span id="l13.126">         &lt;label accesskey=&quot;&amp;name.accesskey;&quot;</span>
<a href="#l13.127"></a><span id="l13.127">                class=&quot;autoconfigLabel&quot;</span>
<a href="#l13.128"></a><span id="l13.128">                value=&quot;&amp;name.label;&quot;</span>
<a href="#l13.129"></a><span id="l13.129">                control=&quot;realname&quot;/&gt;</span>
<a href="#l13.130"></a><span id="l13.130">         &lt;textbox id=&quot;realname&quot;</span>
<a href="#l13.131"></a><span id="l13.131">                  class=&quot;padded&quot;</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineminus">-                 value=&quot;&quot;</span>
<a href="#l13.133"></a><span id="l13.133">                  placeholder=&quot;&amp;name.placeholder;&quot;</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineminus">-                 oninput=&quot;gEmailConfigWizard.onRealnameInput()&quot;</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineminus">-                 onblur=&quot;gEmailConfigWizard.validateRealname();&quot;/&gt;</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+                 oninput=&quot;gEmailConfigWizard.onInputRealname();&quot;</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+                 onblur=&quot;gEmailConfigWizard.onBlurRealname();&quot;/&gt;</span>
<a href="#l13.138"></a><span id="l13.138">         &lt;description id=&quot;nametext&quot; class=&quot;initialDesc&quot;&gt;&amp;name.text;&lt;/description&gt;</span>
<a href="#l13.139"></a><span id="l13.139">         &lt;image id=&quot;nameerroricon&quot;</span>
<a href="#l13.140"></a><span id="l13.140">                hidden=&quot;true&quot;</span>
<a href="#l13.141"></a><span id="l13.141">                src=&quot;chrome://global/skin/icons/warning-16.png&quot;/&gt;</span>
<a href="#l13.142"></a><span id="l13.142">         &lt;description id=&quot;nameerror&quot; class=&quot;errordescription&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l13.143"></a><span id="l13.143">       &lt;/hbox&gt;</span>
<a href="#l13.144"></a><span id="l13.144">       &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l13.145"></a><span id="l13.145">         &lt;label accesskey=&quot;&amp;email.accesskey;&quot;</span>
<a href="#l13.146"></a><span id="l13.146">                class=&quot;autoconfigLabel&quot;</span>
<a href="#l13.147"></a><span id="l13.147">                value=&quot;&amp;email.label;&quot;</span>
<a href="#l13.148"></a><span id="l13.148">                control=&quot;email&quot;/&gt;</span>
<a href="#l13.149"></a><span id="l13.149">         &lt;textbox id=&quot;email&quot;</span>
<a href="#l13.150"></a><span id="l13.150">                  class=&quot;padded uri-element&quot;</span>
<a href="#l13.151"></a><span id="l13.151">                  placeholder=&quot;&amp;email.placeholder;&quot;</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineminus">-                 oninput=&quot;gEmailConfigWizard.onEmailInput()&quot;</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineminus">-                 onblur=&quot;gEmailConfigWizard.validateEmail();&quot;/&gt;</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+                 oninput=&quot;gEmailConfigWizard.onInputEmail();&quot;</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+                 onblur=&quot;gEmailConfigWizard.onBlurEmail();&quot;/&gt;</span>
<a href="#l13.156"></a><span id="l13.156">         &lt;image id=&quot;emailerroricon&quot;</span>
<a href="#l13.157"></a><span id="l13.157">                hidden=&quot;true&quot;</span>
<a href="#l13.158"></a><span id="l13.158">                src=&quot;chrome://global/skin/icons/warning-16.png&quot;/&gt;</span>
<a href="#l13.159"></a><span id="l13.159">         &lt;description id=&quot;emailerror&quot; class=&quot;errordescription&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l13.160"></a><span id="l13.160">       &lt;/hbox&gt;</span>
<a href="#l13.161"></a><span id="l13.161">       &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l13.162"></a><span id="l13.162">         &lt;!-- this starts out as text so the emptytext shows, but then</span>
<a href="#l13.163"></a><span id="l13.163">              changes to type=password once it's not empty --&gt;</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineat">@@ -185,243 +194,243 @@</span>
<a href="#l13.165"></a><span id="l13.165">                class=&quot;autoconfigLabel&quot;</span>
<a href="#l13.166"></a><span id="l13.166">                value=&quot;&amp;password.label;&quot;</span>
<a href="#l13.167"></a><span id="l13.167">                control=&quot;password&quot;</span>
<a href="#l13.168"></a><span id="l13.168">                tooltip=&quot;optional-password&quot;/&gt;</span>
<a href="#l13.169"></a><span id="l13.169">         &lt;textbox id=&quot;password&quot;</span>
<a href="#l13.170"></a><span id="l13.170">                  class=&quot;padded&quot;</span>
<a href="#l13.171"></a><span id="l13.171">                  placeholder=&quot;&amp;password.placeholder;&quot;</span>
<a href="#l13.172"></a><span id="l13.172">                  type=&quot;text&quot;</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineminus">-                 oninput=&quot;gEmailConfigWizard.oninputPassword();&quot;</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineminus">-                 onfocus=&quot;this.type='password';&quot;</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineminus">-                 onblur=&quot;gEmailConfigWizard.onblurPassword();&quot;/&gt;</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+                 oninput=&quot;gEmailConfigWizard.onInputPassword();&quot;</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+                 onfocus=&quot;gEmailConfigWizard.onFocusPassword();&quot;</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineplus">+                 onblur=&quot;gEmailConfigWizard.onBlurPassword();&quot;/&gt;</span>
<a href="#l13.179"></a><span id="l13.179">         &lt;image id=&quot;passworderroricon&quot;</span>
<a href="#l13.180"></a><span id="l13.180">                hidden=&quot;true&quot;</span>
<a href="#l13.181"></a><span id="l13.181">                src=&quot;chrome://global/skin/icons/warning-16.png&quot;/&gt;</span>
<a href="#l13.182"></a><span id="l13.182">         &lt;description id=&quot;passworderror&quot; class=&quot;errordescription&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l13.183"></a><span id="l13.183">       &lt;/hbox&gt;</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineminus">-      &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+      &lt;hbox align=&quot;center&quot; pack=&quot;start&quot;&gt;</span>
<a href="#l13.186"></a><span id="l13.186">         &lt;label class=&quot;autoconfigLabel&quot;/&gt;</span>
<a href="#l13.187"></a><span id="l13.187">         &lt;checkbox id=&quot;remember_password&quot;</span>
<a href="#l13.188"></a><span id="l13.188">                   label=&quot;&amp;rememberPassword.label;&quot;</span>
<a href="#l13.189"></a><span id="l13.189">                   accesskey=&quot;&amp;rememberPassword.accesskey;&quot;</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineminus">-                  disabled=&quot;true&quot;</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineminus">-                  checked=&quot;false&quot;</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineminus">-                  onclick=&quot;gEmailConfigWizard._userChangedPassword=true;&quot;/&gt;</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineminus">-        &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineminus">-        &lt;hbox&gt;</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineminus">-          &lt;button id=&quot;back_button&quot;</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineminus">-                  label=&quot;&amp;startOver.label;&quot;</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineminus">-                  accesskey=&quot;&amp;startOver.accesskey;&quot;</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineminus">-                  class=&quot;larger-button&quot;</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineminus">-                  hidden=&quot;true&quot;</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineminus">-                  oncommand=&quot;gEmailConfigWizard.onBack();&quot;/&gt;</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineminus">-        &lt;/hbox&gt;</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+                  checked=&quot;true&quot;/&gt;</span>
<a href="#l13.203"></a><span id="l13.203">       &lt;/hbox&gt;</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineminus">-      &lt;hbox id=&quot;fullspacer&quot;/&gt;</span>
<a href="#l13.205"></a><span id="l13.205">     &lt;/groupbox&gt;</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineminus">-    &lt;vbox&gt;</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineminus">-      &lt;groupbox id=&quot;popimap_radio_area&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineminus">-        &lt;radiogroup id=&quot;popimap_radiogroup&quot;&gt;</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineminus">-          &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineminus">-            &lt;radio id=&quot;incoming_protocol_imap&quot;</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineminus">-                   label=&quot;&amp;imap.description;&quot; value=&quot;imap&quot;</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineminus">-                   oncommand=&quot;gEmailConfigWizard.setIncomingProtocolRadio();&quot;/&gt;</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineminus">-            &lt;label id=&quot;imap_recommended&quot;</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineminus">-                   value=&quot;&amp;recommended-appendix.label;&quot;/&gt;</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineminus">-          &lt;/hbox&gt;</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineminus">-          &lt;radio id=&quot;incoming_protocol_pop3&quot;</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineminus">-                 label=&quot;&amp;pop.description;&quot; value=&quot;pop3&quot;</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineminus">-                 oncommand=&quot;gEmailConfigWizard.setIncomingProtocolRadio();&quot;/&gt;</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineminus">-        &lt;/radiogroup&gt;</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineminus">-      &lt;/groupbox&gt;</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineminus">-      &lt;groupbox id=&quot;settingsbox&quot;&gt;</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineminus">-        &lt;vbox&gt;</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineminus">-          &lt;vbox id=&quot;configarea&quot;&gt;</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineminus">-            &lt;hbox&gt;</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineminus">-              &lt;hbox flex=&quot;1&quot;&gt;</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineminus">-                &lt;description id=&quot;config_status_title&quot; flex=&quot;1&quot; class=&quot;title&quot;/&gt;</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineminus">-              &lt;/hbox&gt;</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineminus">-            &lt;/hbox&gt;</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineminus">-          &lt;/vbox&gt;</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineminus">-          &lt;hbox id=&quot;usernamearea&quot; align=&quot;center&quot;&gt;</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineminus">-            &lt;vbox id=&quot;username_status&quot;</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineminus">-                  class=&quot;icon&quot;</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineminus">-                  align=&quot;center&quot;</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineminus">-                  pack=&quot;center&quot;&gt;</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineminus">-              &lt;image id=&quot;username_spinner&quot;</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineminus">-                     src=&quot;chrome://global/skin/icons/loading_16.png&quot;</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineminus">-                     hidden=&quot;true&quot;/&gt;</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineminus">-            &lt;/vbox&gt;</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineminus">-            &lt;label class=&quot;textbox-label&quot;</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineminus">-                   value=&quot;&amp;username2.label;&quot;</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineminus">-                   control=&quot;username&quot;/&gt;</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineminus">-            &lt;textbox id=&quot;username&quot;</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineminus">-                     value=&quot;&quot;</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineminus">-                     disabled=&quot;true&quot;</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineminus">-                     class=&quot;username&quot;/&gt;</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineminus">-            &lt;hbox flex=&quot;1&quot; pack=&quot;end&quot;&gt;</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineminus">-              &lt;button id=&quot;stop_button&quot;</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineminus">-                      label=&quot;&amp;stop.label;&quot;</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineminus">-                      accesskey=&quot;&amp;stop.accesskey;&quot;</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineminus">-                      class=&quot;smaller-button&quot;</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineminus">-                      oncommand=&quot;gEmailConfigWizard.onStop();&quot;/&gt;</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineminus">-              &lt;button id=&quot;edit_button&quot;</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineminus">-                      label=&quot;&amp;edit.label;&quot;</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineminus">-                      accesskey=&quot;&amp;edit.accesskey;&quot;</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineminus">-                      class=&quot;smaller-button&quot;</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineminus">-                      hidden=&quot;true&quot;</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineminus">-                      oncommand=&quot;gEmailConfigWizard.onEdit();&quot;/&gt;</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineminus">-              &lt;button id=&quot;go_button&quot;</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineminus">-                      label=&quot;&amp;retest.label;&quot;</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineminus">-                      accesskey=&quot;&amp;retest.accesskey;&quot;</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineminus">-                      class=&quot;smaller-button&quot;</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineminus">-                      hidden=&quot;true&quot;</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineminus">-                      oncommand=&quot;gEmailConfigWizard.onGo();&quot;/&gt;</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineminus">-            &lt;/hbox&gt;</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineminus">-          &lt;/hbox&gt;</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineminus">-          &lt;hbox id=&quot;incomingarea&quot; align=&quot;center&quot;&gt;</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineminus">-            &lt;vbox id=&quot;incoming_status&quot;</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineminus">-                  class=&quot;icon&quot;</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineminus">-                  align=&quot;center&quot;</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineminus">-                  pack=&quot;center&quot;&gt;</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineminus">-              &lt;image id=&quot;incoming_spinner&quot;</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineminus">-                     src=&quot;chrome://global/skin/icons/loading_16.png&quot;</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineminus">-                     hidden=&quot;true&quot;/&gt;</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineminus">-            &lt;/vbox&gt;</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineplus">+    &lt;spacer flex=&quot;1&quot; /&gt;</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineplus">+</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineplus">+     &lt;hbox id=&quot;status_area&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineplus">+      &lt;vbox id=&quot;status_img_before&quot; pack=&quot;start&quot;/&gt;</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineplus">+      &lt;description id=&quot;status_msg&quot;&gt;&amp;#160;&lt;/description&gt;</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineplus">+              &lt;!-- Include 160 = nbsp, to make the element occupy the</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineplus">+                   full height, for at least one line. With a normal space,</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineplus">+                   it does not have sufficient height. --&gt;</span>
<a href="#l13.283"></a><span id="l13.283" class="difflineplus">+      &lt;vbox id=&quot;status_img_after&quot; pack=&quot;start&quot;/&gt;</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineplus">+    &lt;/hbox&gt;</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineplus">+</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineplus">+    &lt;groupbox id=&quot;result_area&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineplus">+      &lt;radiogroup id=&quot;result_imappop&quot; orient=&quot;horizontal&quot;</span>
<a href="#l13.288"></a><span id="l13.288" class="difflineplus">+                  onselect=&quot;gEmailConfigWizard.onResultIMAPOrPOP3();&quot;&gt;</span>
<a href="#l13.289"></a><span id="l13.289" class="difflineplus">+        &lt;radio id=&quot;result_select_imap&quot; label=&quot;&amp;imapLong.label;&quot; value=&quot;1&quot;/&gt;</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineplus">+        &lt;radio id=&quot;result_select_pop3&quot; label=&quot;&amp;pop3Long.label;&quot; value=&quot;2&quot;/&gt;</span>
<a href="#l13.291"></a><span id="l13.291" class="difflineplus">+      &lt;/radiogroup&gt;</span>
<a href="#l13.292"></a><span id="l13.292" class="difflineplus">+      &lt;hbox&gt;</span>
<a href="#l13.293"></a><span id="l13.293" class="difflineplus">+        &lt;label class=&quot;textbox-label&quot; value=&quot;&amp;incoming.label;&quot;/&gt;</span>
<a href="#l13.294"></a><span id="l13.294" class="difflineplus">+        &lt;description id=&quot;result-incoming&quot; flex=&quot;1&quot;&gt;&amp;#160;&lt;/description&gt;</span>
<a href="#l13.295"></a><span id="l13.295" class="difflineplus">+      &lt;/hbox&gt;</span>
<a href="#l13.296"></a><span id="l13.296" class="difflineplus">+      &lt;hbox&gt;</span>
<a href="#l13.297"></a><span id="l13.297" class="difflineplus">+        &lt;label class=&quot;textbox-label&quot; value=&quot;&amp;outgoing.label;&quot;/&gt;</span>
<a href="#l13.298"></a><span id="l13.298" class="difflineplus">+        &lt;description id=&quot;result-outgoing&quot; flex=&quot;1&quot;&gt;&amp;#160;&lt;/description&gt;</span>
<a href="#l13.299"></a><span id="l13.299" class="difflineplus">+      &lt;/hbox&gt;</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineplus">+      &lt;hbox&gt;</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineplus">+        &lt;label class=&quot;textbox-label&quot; value=&quot;&amp;username.label;&quot;/&gt;</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineplus">+        &lt;description id=&quot;result-username&quot; flex=&quot;1&quot;&gt;&amp;#160;&lt;/description&gt;</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineplus">+      &lt;/hbox&gt;</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineplus">+    &lt;/groupbox&gt;</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineplus">+</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineplus">+    &lt;groupbox id=&quot;manual-edit_area&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineplus">+      &lt;grid&gt;</span>
<a href="#l13.308"></a><span id="l13.308" class="difflineplus">+        &lt;columns&gt;</span>
<a href="#l13.309"></a><span id="l13.309" class="difflineplus">+          &lt;column/&gt;&lt;!-- row label, e.g. &quot;incoming&quot; --&gt;</span>
<a href="#l13.310"></a><span id="l13.310" class="difflineplus">+          &lt;column/&gt;&lt;!-- protocol, e.g. &quot;IMAP&quot; --&gt;</span>
<a href="#l13.311"></a><span id="l13.311" class="difflineplus">+          &lt;column flex=&quot;1&quot;/&gt;&lt;!-- hostname / username --&gt;</span>
<a href="#l13.312"></a><span id="l13.312" class="difflineplus">+          &lt;column/&gt;&lt;!-- port --&gt;</span>
<a href="#l13.313"></a><span id="l13.313" class="difflineplus">+          &lt;column/&gt;&lt;!-- SSL --&gt;</span>
<a href="#l13.314"></a><span id="l13.314" class="difflineplus">+          &lt;column/&gt;&lt;!-- auth method --&gt;</span>
<a href="#l13.315"></a><span id="l13.315" class="difflineplus">+        &lt;/columns&gt;</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineplus">+        &lt;rows&gt;</span>
<a href="#l13.317"></a><span id="l13.317" class="difflineplus">+          &lt;row id=&quot;labels_row&quot; align=&quot;center&quot;&gt;</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineplus">+            &lt;spacer/&gt;</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineplus">+            &lt;spacer/&gt;</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineplus">+            &lt;label value=&quot;&amp;hostname.label;&quot; class=&quot;columnHeader&quot;/&gt;</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineplus">+            &lt;label value=&quot;&amp;port.label;&quot; class=&quot;columnHeader&quot;/&gt;</span>
<a href="#l13.322"></a><span id="l13.322" class="difflineplus">+            &lt;label value=&quot;&amp;ssl.label;&quot; class=&quot;columnHeader&quot;/&gt;</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineplus">+            &lt;label value=&quot;&amp;auth.label;&quot; class=&quot;columnHeader&quot;/&gt;</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineplus">+          &lt;/row&gt;</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineplus">+          &lt;row id=&quot;incoming_server_area&quot; align=&quot;center&quot;&gt;</span>
<a href="#l13.326"></a><span id="l13.326">             &lt;label class=&quot;textbox-label&quot;</span>
<a href="#l13.327"></a><span id="l13.327">                    value=&quot;&amp;incoming.label;&quot;</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineminus">-                   control=&quot;incoming_server&quot;/&gt;</span>
<a href="#l13.329"></a><span id="l13.329" class="difflineminus">-            &lt;hbox&gt;</span>
<a href="#l13.330"></a><span id="l13.330" class="difflineminus">-              &lt;textbox id=&quot;incoming_server&quot;</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineminus">-                       class=&quot;host uri-element&quot;</span>
<a href="#l13.332"></a><span id="l13.332" class="difflineminus">-                       value=&quot;&quot;</span>
<a href="#l13.333"></a><span id="l13.333" class="difflineminus">-                       disabled=&quot;true&quot;</span>
<a href="#l13.334"></a><span id="l13.334" class="difflineminus">-                       oninput=&quot;gEmailConfigWizard.setIncomingServer()&quot;/&gt;</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineminus">-            &lt;/hbox&gt;</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineminus">-            &lt;hbox&gt;</span>
<a href="#l13.337"></a><span id="l13.337" class="difflineminus">-              &lt;spacer height=&quot;30&quot; width=&quot;12&quot;/&gt;</span>
<a href="#l13.338"></a><span id="l13.338" class="difflineminus">-              &lt;hbox class=&quot;protocol&quot;&gt;</span>
<a href="#l13.339"></a><span id="l13.339" class="difflineminus">-                &lt;menulist id=&quot;incoming_protocol&quot;</span>
<a href="#l13.340"></a><span id="l13.340" class="difflineminus">-                          value=&quot;&quot;</span>
<a href="#l13.341"></a><span id="l13.341" class="difflineminus">-                          disabled=&quot;true&quot;</span>
<a href="#l13.342"></a><span id="l13.342" class="difflineminus">-                          sizetopopup=&quot;always&quot;&gt;</span>
<a href="#l13.343"></a><span id="l13.343" class="difflineminus">-                  &lt;menupopup onpopuphidden=&quot;gEmailConfigWizard.setIncomingProtocol()&quot;&gt;</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineminus">-                    &lt;menuitem label=&quot;&amp;imap.label;&quot; value=&quot;1&quot;/&gt;</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineminus">-                    &lt;menuitem label=&quot;&amp;pop.label;&quot; value=&quot;2&quot;/&gt;</span>
<a href="#l13.346"></a><span id="l13.346" class="difflineminus">-                  &lt;/menupopup&gt;</span>
<a href="#l13.347"></a><span id="l13.347" class="difflineminus">-                &lt;/menulist&gt;</span>
<a href="#l13.348"></a><span id="l13.348" class="difflineminus">-              &lt;/hbox&gt;</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineminus">-              &lt;hbox&gt;</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineminus">-                &lt;textbox id=&quot;incoming_port&quot;</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineminus">-                         class=&quot;port&quot;</span>
<a href="#l13.352"></a><span id="l13.352" class="difflineminus">-                         value=&quot;&quot;</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineminus">-                         disabled=&quot;true&quot;</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineminus">-                         oninput=&quot;gEmailConfigWizard.setPort('incoming_port')&quot;/&gt;</span>
<a href="#l13.355"></a><span id="l13.355" class="difflineminus">-              &lt;/hbox&gt;</span>
<a href="#l13.356"></a><span id="l13.356" class="difflineminus">-              &lt;hbox&gt;</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineminus">-                &lt;menulist id=&quot;incoming_security&quot;</span>
<a href="#l13.358"></a><span id="l13.358" class="difflineminus">-                          class=&quot;security&quot;</span>
<a href="#l13.359"></a><span id="l13.359" class="difflineminus">-                          value=&quot;&quot;</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineminus">-                          disabled=&quot;true&quot;</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineminus">-                          sizetopopup=&quot;always&quot;&gt;</span>
<a href="#l13.362"></a><span id="l13.362" class="difflineminus">-                  &lt;menupopup onpopuphidden=&quot;gEmailConfigWizard.setSecurity('incoming_security')&quot;&gt;</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineminus">-                    &lt;menuitem label=&quot;&amp;noEncryption.label;&quot; value=&quot;1&quot;/&gt;</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineminus">-                    &lt;menuitem label=&quot;&amp;starttls.label;&quot; value=&quot;3&quot;/&gt;</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineminus">-                    &lt;menuitem label=&quot;&amp;sslTls.label;&quot; value=&quot;2&quot;/&gt;</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineminus">-                  &lt;/menupopup&gt;</span>
<a href="#l13.367"></a><span id="l13.367" class="difflineminus">-                &lt;/menulist&gt;</span>
<a href="#l13.368"></a><span id="l13.368" class="difflineminus">-              &lt;/hbox&gt;</span>
<a href="#l13.369"></a><span id="l13.369" class="difflineminus">-            &lt;/hbox&gt;</span>
<a href="#l13.370"></a><span id="l13.370" class="difflineminus">-          &lt;/hbox&gt;</span>
<a href="#l13.371"></a><span id="l13.371" class="difflineminus">-          &lt;hbox id=&quot;outgoingarea&quot; align=&quot;center&quot;&gt;</span>
<a href="#l13.372"></a><span id="l13.372" class="difflineminus">-            &lt;vbox id=&quot;outgoing_status&quot;</span>
<a href="#l13.373"></a><span id="l13.373" class="difflineminus">-                  class=&quot;icon&quot;</span>
<a href="#l13.374"></a><span id="l13.374" class="difflineminus">-                  align=&quot;center&quot;</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineminus">-                  pack=&quot;center&quot;&gt;</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineminus">-              &lt;image id=&quot;outgoing_spinner&quot;</span>
<a href="#l13.377"></a><span id="l13.377" class="difflineminus">-                     src=&quot;chrome://global/skin/icons/loading_16.png&quot;</span>
<a href="#l13.378"></a><span id="l13.378" class="difflineminus">-                     hidden=&quot;true&quot;/&gt;</span>
<a href="#l13.379"></a><span id="l13.379" class="difflineminus">-            &lt;/vbox&gt;</span>
<a href="#l13.380"></a><span id="l13.380" class="difflineplus">+                   control=&quot;incoming_hostname&quot;/&gt;</span>
<a href="#l13.381"></a><span id="l13.381" class="difflineplus">+            &lt;menulist id=&quot;incoming_protocol&quot;</span>
<a href="#l13.382"></a><span id="l13.382" class="difflineplus">+                      sizetopopup=&quot;always&quot;&gt;</span>
<a href="#l13.383"></a><span id="l13.383" class="difflineplus">+              &lt;menupopup</span>
<a href="#l13.384"></a><span id="l13.384" class="difflineplus">+              onpopuphidden=&quot;gEmailConfigWizard.onChangedProtocolIncoming();&quot;&gt;</span>
<a href="#l13.385"></a><span id="l13.385" class="difflineplus">+                &lt;menuitem label=&quot;&amp;imap.label;&quot; value=&quot;1&quot;/&gt;</span>
<a href="#l13.386"></a><span id="l13.386" class="difflineplus">+                &lt;menuitem label=&quot;&amp;pop3.label;&quot; value=&quot;2&quot;/&gt;</span>
<a href="#l13.387"></a><span id="l13.387" class="difflineplus">+              &lt;/menupopup&gt;</span>
<a href="#l13.388"></a><span id="l13.388" class="difflineplus">+            &lt;/menulist&gt;</span>
<a href="#l13.389"></a><span id="l13.389" class="difflineplus">+            &lt;textbox id=&quot;incoming_hostname&quot;</span>
<a href="#l13.390"></a><span id="l13.390" class="difflineplus">+                     oninput=&quot;gEmailConfigWizard.onInputHostname();&quot;</span>
<a href="#l13.391"></a><span id="l13.391" class="difflineplus">+                     class=&quot;host uri-element&quot;/&gt;</span>
<a href="#l13.392"></a><span id="l13.392" class="difflineplus">+            &lt;menulist id=&quot;incoming_port&quot;</span>
<a href="#l13.393"></a><span id="l13.393" class="difflineplus">+                      editable=&quot;true&quot;</span>
<a href="#l13.394"></a><span id="l13.394" class="difflineplus">+                      oninput=&quot;gEmailConfigWizard.onChangedPortIncoming();&quot;</span>
<a href="#l13.395"></a><span id="l13.395" class="difflineplus">+                      class=&quot;port&quot;&gt;</span>
<a href="#l13.396"></a><span id="l13.396" class="difflineplus">+              &lt;menupopup</span>
<a href="#l13.397"></a><span id="l13.397" class="difflineplus">+                    onpopuphidden=&quot;gEmailConfigWizard.onChangedPortIncoming();&quot;/&gt;</span>
<a href="#l13.398"></a><span id="l13.398" class="difflineplus">+            &lt;/menulist&gt;</span>
<a href="#l13.399"></a><span id="l13.399" class="difflineplus">+            &lt;menulist id=&quot;incoming_ssl&quot;</span>
<a href="#l13.400"></a><span id="l13.400" class="difflineplus">+                      class=&quot;security&quot;</span>
<a href="#l13.401"></a><span id="l13.401" class="difflineplus">+                      sizetopopup=&quot;always&quot;&gt;</span>
<a href="#l13.402"></a><span id="l13.402" class="difflineplus">+              &lt;menupopup</span>
<a href="#l13.403"></a><span id="l13.403" class="difflineplus">+                  onpopuphidden=&quot;gEmailConfigWizard.onChangedSSLIncoming();&quot;&gt;</span>
<a href="#l13.404"></a><span id="l13.404" class="difflineplus">+                &lt;!-- values defined in nsMsgSocketType --&gt;</span>
<a href="#l13.405"></a><span id="l13.405" class="difflineplus">+                &lt;menuitem label=&quot;&amp;autodetect.label;&quot; value=&quot;0&quot;/&gt;</span>
<a href="#l13.406"></a><span id="l13.406" class="difflineplus">+                &lt;menuitem label=&quot;&amp;noEncryption.label;&quot; value=&quot;1&quot;/&gt;</span>
<a href="#l13.407"></a><span id="l13.407" class="difflineplus">+                &lt;menuitem label=&quot;&amp;starttls.label;&quot; value=&quot;3&quot;/&gt;</span>
<a href="#l13.408"></a><span id="l13.408" class="difflineplus">+                &lt;menuitem label=&quot;&amp;sslTls.label;&quot; value=&quot;2&quot;/&gt;</span>
<a href="#l13.409"></a><span id="l13.409" class="difflineplus">+              &lt;/menupopup&gt;</span>
<a href="#l13.410"></a><span id="l13.410" class="difflineplus">+            &lt;/menulist&gt;</span>
<a href="#l13.411"></a><span id="l13.411" class="difflineplus">+            &lt;menulist id=&quot;incoming_authMethod&quot;</span>
<a href="#l13.412"></a><span id="l13.412" class="difflineplus">+                      class=&quot;auth&quot;</span>
<a href="#l13.413"></a><span id="l13.413" class="difflineplus">+                      sizetopopup=&quot;always&quot;&gt;</span>
<a href="#l13.414"></a><span id="l13.414" class="difflineplus">+              &lt;menupopup onpopuphidden=&quot;gEmailConfigWizard.onChangedAuth();&quot;&gt;</span>
<a href="#l13.415"></a><span id="l13.415" class="difflineplus">+                &lt;menuitem label=&quot;&amp;autodetect.label;&quot; value=&quot;0&quot;/&gt;</span>
<a href="#l13.416"></a><span id="l13.416" class="difflineplus">+                &lt;!-- values defined in nsMsgAuthMethod --&gt;</span>
<a href="#l13.417"></a><span id="l13.417" class="difflineplus">+                &lt;!-- labels set from messenger.properties</span>
<a href="#l13.418"></a><span id="l13.418" class="difflineplus">+                     to avoid duplication --&gt;</span>
<a href="#l13.419"></a><span id="l13.419" class="difflineplus">+                &lt;menuitem id=&quot;in-authMethod-password-cleartext&quot; value=&quot;3&quot;/&gt;</span>
<a href="#l13.420"></a><span id="l13.420" class="difflineplus">+                &lt;menuitem id=&quot;in-authMethod-password-encrypted&quot; value=&quot;4&quot;/&gt;</span>
<a href="#l13.421"></a><span id="l13.421" class="difflineplus">+                &lt;menuitem id=&quot;in-authMethod-kerberos&quot; value=&quot;5&quot;/&gt;</span>
<a href="#l13.422"></a><span id="l13.422" class="difflineplus">+                &lt;menuitem id=&quot;in-authMethod-ntlm&quot; value=&quot;6&quot;/&gt;</span>
<a href="#l13.423"></a><span id="l13.423" class="difflineplus">+              &lt;/menupopup&gt;</span>
<a href="#l13.424"></a><span id="l13.424" class="difflineplus">+            &lt;/menulist&gt;</span>
<a href="#l13.425"></a><span id="l13.425" class="difflineplus">+          &lt;/row&gt;</span>
<a href="#l13.426"></a><span id="l13.426" class="difflineplus">+          &lt;row id=&quot;outgoing_server_area&quot; align=&quot;center&quot;&gt;</span>
<a href="#l13.427"></a><span id="l13.427">             &lt;label class=&quot;textbox-label&quot;</span>
<a href="#l13.428"></a><span id="l13.428">                    value=&quot;&amp;outgoing.label;&quot;</span>
<a href="#l13.429"></a><span id="l13.429" class="difflineminus">-                   control=&quot;outgoing_server&quot;/&gt;</span>
<a href="#l13.430"></a><span id="l13.430" class="difflineminus">-            &lt;hbox&gt;</span>
<a href="#l13.431"></a><span id="l13.431" class="difflineminus">-              &lt;!-- oncommand, and onchange and onmousedown of menulist's</span>
<a href="#l13.432"></a><span id="l13.432" class="difflineminus">-                   inputfield, set in constructor --&gt;</span>
<a href="#l13.433"></a><span id="l13.433" class="difflineminus">-              &lt;menulist id=&quot;outgoing_server&quot;</span>
<a href="#l13.434"></a><span id="l13.434" class="difflineminus">-                        class=&quot;host uri-element&quot;</span>
<a href="#l13.435"></a><span id="l13.435" class="difflineminus">-                        disabled=&quot;true&quot;</span>
<a href="#l13.436"></a><span id="l13.436" class="difflineminus">-                        sizetopopup=&quot;none&quot;</span>
<a href="#l13.437"></a><span id="l13.437" class="difflineminus">-                        editable=&quot;true&quot; &gt;</span>
<a href="#l13.438"></a><span id="l13.438" class="difflineminus">-                &lt;menupopup id=&quot;smtp_menupopup&quot;/&gt;</span>
<a href="#l13.439"></a><span id="l13.439" class="difflineminus">-              &lt;/menulist&gt;</span>
<a href="#l13.440"></a><span id="l13.440" class="difflineminus">-            &lt;/hbox&gt;</span>
<a href="#l13.441"></a><span id="l13.441" class="difflineminus">-            &lt;hbox&gt;</span>
<a href="#l13.442"></a><span id="l13.442" class="difflineminus">-              &lt;spacer height=&quot;30&quot; width=&quot;12&quot;/&gt;</span>
<a href="#l13.443"></a><span id="l13.443" class="difflineminus">-              &lt;hbox class=&quot;protocol&quot; align=&quot;center&quot;&gt;</span>
<a href="#l13.444"></a><span id="l13.444" class="difflineminus">-                &lt;label id=&quot;outgoing_protocol&quot;</span>
<a href="#l13.445"></a><span id="l13.445" class="difflineminus">-                       value=&quot;&amp;smtp.label;&quot;/&gt;</span>
<a href="#l13.446"></a><span id="l13.446" class="difflineminus">-              &lt;/hbox&gt;</span>
<a href="#l13.447"></a><span id="l13.447" class="difflineminus">-              &lt;hbox&gt;</span>
<a href="#l13.448"></a><span id="l13.448" class="difflineminus">-                &lt;textbox id=&quot;outgoing_port&quot;</span>
<a href="#l13.449"></a><span id="l13.449" class="difflineminus">-                         class=&quot;port&quot;</span>
<a href="#l13.450"></a><span id="l13.450" class="difflineminus">-                         value=&quot;&quot;</span>
<a href="#l13.451"></a><span id="l13.451" class="difflineminus">-                         disabled=&quot;true&quot;</span>
<a href="#l13.452"></a><span id="l13.452" class="difflineminus">-                         oninput=&quot;gEmailConfigWizard.setPort('outgoing_port')&quot;/&gt;</span>
<a href="#l13.453"></a><span id="l13.453" class="difflineminus">-              &lt;/hbox&gt;</span>
<a href="#l13.454"></a><span id="l13.454" class="difflineminus">-              &lt;hbox&gt;</span>
<a href="#l13.455"></a><span id="l13.455" class="difflineminus">-                &lt;menulist id=&quot;outgoing_security&quot;</span>
<a href="#l13.456"></a><span id="l13.456" class="difflineminus">-                          class=&quot;security&quot;</span>
<a href="#l13.457"></a><span id="l13.457" class="difflineminus">-                          value=&quot;&quot;</span>
<a href="#l13.458"></a><span id="l13.458" class="difflineminus">-                          disabled=&quot;true&quot;</span>
<a href="#l13.459"></a><span id="l13.459" class="difflineminus">-                          sizetopopup=&quot;always&quot;&gt;</span>
<a href="#l13.460"></a><span id="l13.460" class="difflineminus">-                  &lt;menupopup onpopuphidden=&quot;gEmailConfigWizard.setSecurity('outgoing_security')&quot;&gt;</span>
<a href="#l13.461"></a><span id="l13.461" class="difflineminus">-                    &lt;menuitem label=&quot;&amp;noEncryption.label;&quot; value=&quot;1&quot;/&gt;</span>
<a href="#l13.462"></a><span id="l13.462" class="difflineminus">-                    &lt;menuitem label=&quot;&amp;starttls.label;&quot; value=&quot;3&quot;/&gt;</span>
<a href="#l13.463"></a><span id="l13.463" class="difflineminus">-                    &lt;menuitem label=&quot;&amp;sslTls.label;&quot; value=&quot;2&quot;/&gt;</span>
<a href="#l13.464"></a><span id="l13.464" class="difflineminus">-                  &lt;/menupopup&gt;</span>
<a href="#l13.465"></a><span id="l13.465" class="difflineminus">-                &lt;/menulist&gt;</span>
<a href="#l13.466"></a><span id="l13.466" class="difflineminus">-              &lt;/hbox&gt;</span>
<a href="#l13.467"></a><span id="l13.467" class="difflineminus">-            &lt;/hbox&gt;</span>
<a href="#l13.468"></a><span id="l13.468" class="difflineminus">-          &lt;/hbox&gt;</span>
<a href="#l13.469"></a><span id="l13.469" class="difflineminus">-        &lt;/vbox&gt;</span>
<a href="#l13.470"></a><span id="l13.470" class="difflineminus">-      &lt;/groupbox&gt;</span>
<a href="#l13.471"></a><span id="l13.471" class="difflineminus">-    &lt;/vbox&gt;</span>
<a href="#l13.472"></a><span id="l13.472" class="difflineminus">-    &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l13.473"></a><span id="l13.473" class="difflineminus">-    &lt;hbox id=&quot;button_box&quot;&gt;</span>
<a href="#l13.474"></a><span id="l13.474" class="difflineminus">-      &lt;button id=&quot;advanced_settings&quot;</span>
<a href="#l13.475"></a><span id="l13.475" class="difflineminus">-              label=&quot;&amp;manualSetup.label;&quot;</span>
<a href="#l13.476"></a><span id="l13.476" class="difflineminus">-              accesskey=&quot;&amp;manualSetup.accesskey;&quot;</span>
<a href="#l13.477"></a><span id="l13.477" class="difflineminus">-              class=&quot;larger-button&quot;</span>
<a href="#l13.478"></a><span id="l13.478" class="difflineminus">-              disabled=&quot;true&quot;</span>
<a href="#l13.479"></a><span id="l13.479" class="difflineminus">-              hidden=&quot;true&quot;</span>
<a href="#l13.480"></a><span id="l13.480" class="difflineminus">-              oncommand=&quot;gEmailConfigWizard.advancedSettings();&quot;/&gt;</span>
<a href="#l13.481"></a><span id="l13.481" class="difflineplus">+                   control=&quot;outgoing_hostname&quot;/&gt;</span>
<a href="#l13.482"></a><span id="l13.482" class="difflineplus">+            &lt;label id=&quot;outgoing_protocol&quot;</span>
<a href="#l13.483"></a><span id="l13.483" class="difflineplus">+                   value=&quot;&amp;smtp.label;&quot;/&gt;</span>
<a href="#l13.484"></a><span id="l13.484" class="difflineplus">+            &lt;menulist id=&quot;outgoing_hostname&quot;</span>
<a href="#l13.485"></a><span id="l13.485" class="difflineplus">+                editable=&quot;true&quot;</span>
<a href="#l13.486"></a><span id="l13.486" class="difflineplus">+                sizetopopup=&quot;none&quot;</span>
<a href="#l13.487"></a><span id="l13.487" class="difflineplus">+                oninput=&quot;gEmailConfigWizard.onInputHostname();&quot;</span>
<a href="#l13.488"></a><span id="l13.488" class="difflineplus">+                onpopuphidden=&quot;gEmailConfigWizard.onChangedOutgoingDropdown();&quot;</span>
<a href="#l13.489"></a><span id="l13.489" class="difflineplus">+                onpopupshowing=&quot;gEmailConfigWizard.onOpenOutgoingDropdown();&quot;</span>
<a href="#l13.490"></a><span id="l13.490" class="difflineplus">+                class=&quot;host uri-element&quot;&gt;</span>
<a href="#l13.491"></a><span id="l13.491" class="difflineplus">+              &lt;menupopup id=&quot;outgoing_hostname_popup&quot;/&gt;</span>
<a href="#l13.492"></a><span id="l13.492" class="difflineplus">+            &lt;/menulist&gt;</span>
<a href="#l13.493"></a><span id="l13.493" class="difflineplus">+            &lt;menulist id=&quot;outgoing_port&quot;</span>
<a href="#l13.494"></a><span id="l13.494" class="difflineplus">+                      editable=&quot;true&quot;</span>
<a href="#l13.495"></a><span id="l13.495" class="difflineplus">+                      oninput=&quot;gEmailConfigWizard.onChangedPortOutgoing();&quot;</span>
<a href="#l13.496"></a><span id="l13.496" class="difflineplus">+                      class=&quot;port&quot;&gt;</span>
<a href="#l13.497"></a><span id="l13.497" class="difflineplus">+              &lt;menupopup</span>
<a href="#l13.498"></a><span id="l13.498" class="difflineplus">+                    onpopuphidden=&quot;gEmailConfigWizard.onChangedPortOutgoing();&quot;/&gt;</span>
<a href="#l13.499"></a><span id="l13.499" class="difflineplus">+            &lt;/menulist&gt;</span>
<a href="#l13.500"></a><span id="l13.500" class="difflineplus">+            &lt;menulist id=&quot;outgoing_ssl&quot;</span>
<a href="#l13.501"></a><span id="l13.501" class="difflineplus">+                      class=&quot;security&quot;</span>
<a href="#l13.502"></a><span id="l13.502" class="difflineplus">+                      sizetopopup=&quot;always&quot;&gt;</span>
<a href="#l13.503"></a><span id="l13.503" class="difflineplus">+              &lt;menupopup</span>
<a href="#l13.504"></a><span id="l13.504" class="difflineplus">+                    onpopuphidden=&quot;gEmailConfigWizard.onChangedSSLOutgoing();&quot;&gt;</span>
<a href="#l13.505"></a><span id="l13.505" class="difflineplus">+                &lt;!-- @see incoming --&gt;</span>
<a href="#l13.506"></a><span id="l13.506" class="difflineplus">+                &lt;menuitem label=&quot;&amp;autodetect.label;&quot; value=&quot;0&quot;/&gt;</span>
<a href="#l13.507"></a><span id="l13.507" class="difflineplus">+                &lt;menuitem label=&quot;&amp;noEncryption.label;&quot; value=&quot;1&quot;/&gt;</span>
<a href="#l13.508"></a><span id="l13.508" class="difflineplus">+                &lt;menuitem label=&quot;&amp;starttls.label;&quot; value=&quot;3&quot;/&gt;</span>
<a href="#l13.509"></a><span id="l13.509" class="difflineplus">+                &lt;menuitem label=&quot;&amp;sslTls.label;&quot; value=&quot;2&quot;/&gt;</span>
<a href="#l13.510"></a><span id="l13.510" class="difflineplus">+              &lt;/menupopup&gt;</span>
<a href="#l13.511"></a><span id="l13.511" class="difflineplus">+            &lt;/menulist&gt;</span>
<a href="#l13.512"></a><span id="l13.512" class="difflineplus">+            &lt;menulist id=&quot;outgoing_authMethod&quot;</span>
<a href="#l13.513"></a><span id="l13.513" class="difflineplus">+                      class=&quot;auth&quot;</span>
<a href="#l13.514"></a><span id="l13.514" class="difflineplus">+                      sizetopopup=&quot;always&quot;&gt;</span>
<a href="#l13.515"></a><span id="l13.515" class="difflineplus">+              &lt;menupopup onpopuphidden=&quot;gEmailConfigWizard.onChangedAuth();&quot;&gt;</span>
<a href="#l13.516"></a><span id="l13.516" class="difflineplus">+                &lt;menuitem label=&quot;&amp;autodetect.label;&quot; value=&quot;0&quot;/&gt;</span>
<a href="#l13.517"></a><span id="l13.517" class="difflineplus">+                &lt;!-- @see incoming --&gt;</span>
<a href="#l13.518"></a><span id="l13.518" class="difflineplus">+                &lt;menuitem id=&quot;out-authMethod-no&quot; value=&quot;1&quot;/&gt;</span>
<a href="#l13.519"></a><span id="l13.519" class="difflineplus">+                &lt;menuitem id=&quot;out-authMethod-password-cleartext&quot; value=&quot;3&quot;/&gt;</span>
<a href="#l13.520"></a><span id="l13.520" class="difflineplus">+                &lt;menuitem id=&quot;out-authMethod-password-encrypted&quot; value=&quot;4&quot;/&gt;</span>
<a href="#l13.521"></a><span id="l13.521" class="difflineplus">+                &lt;menuitem id=&quot;out-authMethod-kerberos&quot; value=&quot;5&quot;/&gt;</span>
<a href="#l13.522"></a><span id="l13.522" class="difflineplus">+                &lt;menuitem id=&quot;out-authMethod-ntlm&quot; value=&quot;6&quot;/&gt;</span>
<a href="#l13.523"></a><span id="l13.523" class="difflineplus">+              &lt;/menupopup&gt;</span>
<a href="#l13.524"></a><span id="l13.524" class="difflineplus">+            &lt;/menulist&gt;</span>
<a href="#l13.525"></a><span id="l13.525" class="difflineplus">+          &lt;/row&gt;</span>
<a href="#l13.526"></a><span id="l13.526" class="difflineplus">+          &lt;row id=&quot;username_area&quot; align=&quot;center&quot;&gt;</span>
<a href="#l13.527"></a><span id="l13.527" class="difflineplus">+            &lt;label class=&quot;textbox-label&quot;</span>
<a href="#l13.528"></a><span id="l13.528" class="difflineplus">+                   value=&quot;&amp;username.label;&quot;</span>
<a href="#l13.529"></a><span id="l13.529" class="difflineplus">+                   control=&quot;incoming_username&quot;/&gt;</span>
<a href="#l13.530"></a><span id="l13.530" class="difflineplus">+            &lt;spacer/&gt;</span>
<a href="#l13.531"></a><span id="l13.531" class="difflineplus">+            &lt;textbox id=&quot;incoming_username&quot;</span>
<a href="#l13.532"></a><span id="l13.532" class="difflineplus">+                     oninput=&quot;gEmailConfigWizard.onInputUsername();&quot;</span>
<a href="#l13.533"></a><span id="l13.533" class="difflineplus">+                     class=&quot;username&quot;/&gt;</span>
<a href="#l13.534"></a><span id="l13.534" class="difflineplus">+            &lt;spacer/&gt;</span>
<a href="#l13.535"></a><span id="l13.535" class="difflineplus">+            &lt;spacer/&gt;</span>
<a href="#l13.536"></a><span id="l13.536" class="difflineplus">+            &lt;spacer/&gt;</span>
<a href="#l13.537"></a><span id="l13.537" class="difflineplus">+          &lt;/row&gt;</span>
<a href="#l13.538"></a><span id="l13.538" class="difflineplus">+        &lt;/rows&gt;</span>
<a href="#l13.539"></a><span id="l13.539" class="difflineplus">+      &lt;/grid&gt;</span>
<a href="#l13.540"></a><span id="l13.540" class="difflineplus">+    &lt;/groupbox&gt;</span>
<a href="#l13.541"></a><span id="l13.541" class="difflineplus">+</span>
<a href="#l13.542"></a><span id="l13.542" class="difflineplus">+    &lt;spacer flex=&quot;1&quot; /&gt;</span>
<a href="#l13.543"></a><span id="l13.543" class="difflineplus">+    &lt;hbox id=&quot;buttons_area&quot;&gt;</span>
<a href="#l13.544"></a><span id="l13.544" class="difflineplus">+      &lt;hbox id=&quot;left_buttons_area&quot; align=&quot;center&quot; pack=&quot;start&quot;&gt;</span>
<a href="#l13.545"></a><span id="l13.545" class="difflineplus">+        &lt;button id=&quot;manual-edit_button&quot;</span>
<a href="#l13.546"></a><span id="l13.546" class="difflineplus">+                label=&quot;&amp;manual-edit.label;&quot;</span>
<a href="#l13.547"></a><span id="l13.547" class="difflineplus">+                accesskey=&quot;&amp;manual-edit.accesskey;&quot;</span>
<a href="#l13.548"></a><span id="l13.548" class="difflineplus">+                class=&quot;smaller-button&quot;</span>
<a href="#l13.549"></a><span id="l13.549" class="difflineplus">+                hidden=&quot;true&quot;</span>
<a href="#l13.550"></a><span id="l13.550" class="difflineplus">+                oncommand=&quot;gEmailConfigWizard.onManualEdit();&quot;/&gt;</span>
<a href="#l13.551"></a><span id="l13.551" class="difflineplus">+        &lt;button id=&quot;advanced-setup_button&quot;</span>
<a href="#l13.552"></a><span id="l13.552" class="difflineplus">+                label=&quot;&amp;advancedSetup.label;&quot;</span>
<a href="#l13.553"></a><span id="l13.553" class="difflineplus">+                accesskey=&quot;&amp;advancedSetup.accesskey;&quot;</span>
<a href="#l13.554"></a><span id="l13.554" class="difflineplus">+                class=&quot;smaller-button&quot;</span>
<a href="#l13.555"></a><span id="l13.555" class="difflineplus">+                disabled=&quot;true&quot;</span>
<a href="#l13.556"></a><span id="l13.556" class="difflineplus">+                hidden=&quot;true&quot;</span>
<a href="#l13.557"></a><span id="l13.557" class="difflineplus">+                oncommand=&quot;gEmailConfigWizard.onAdvancedSetup();&quot;/&gt;</span>
<a href="#l13.558"></a><span id="l13.558" class="difflineplus">+      &lt;/hbox&gt;</span>
<a href="#l13.559"></a><span id="l13.559">       &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l13.560"></a><span id="l13.560" class="difflineminus">-      &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l13.561"></a><span id="l13.561" class="difflineplus">+      &lt;hbox id=&quot;right_buttons_area&quot; align=&quot;center&quot; pack=&quot;end&quot;&gt;</span>
<a href="#l13.562"></a><span id="l13.562" class="difflineplus">+        &lt;button id=&quot;stop_button&quot;</span>
<a href="#l13.563"></a><span id="l13.563" class="difflineplus">+                label=&quot;&amp;stop.label;&quot;</span>
<a href="#l13.564"></a><span id="l13.564" class="difflineplus">+                accesskey=&quot;&amp;stop.accesskey;&quot;</span>
<a href="#l13.565"></a><span id="l13.565" class="difflineplus">+                class=&quot;smaller-button&quot;</span>
<a href="#l13.566"></a><span id="l13.566" class="difflineplus">+                hidden=&quot;true&quot;</span>
<a href="#l13.567"></a><span id="l13.567" class="difflineplus">+                oncommand=&quot;gEmailConfigWizard.onStop();&quot;/&gt;</span>
<a href="#l13.568"></a><span id="l13.568">         &lt;button id=&quot;cancel_button&quot;</span>
<a href="#l13.569"></a><span id="l13.569">                 label=&quot;&amp;cancel.label;&quot;</span>
<a href="#l13.570"></a><span id="l13.570" class="difflineplus">+                class=&quot;smaller-button&quot;</span>
<a href="#l13.571"></a><span id="l13.571">                 accesskey=&quot;&amp;cancel.accesskey;&quot;</span>
<a href="#l13.572"></a><span id="l13.572">                 oncommand=&quot;gEmailConfigWizard.onCancel();&quot;/&gt;</span>
<a href="#l13.573"></a><span id="l13.573" class="difflineminus">-      &lt;/hbox&gt;</span>
<a href="#l13.574"></a><span id="l13.574" class="difflineminus">-      &lt;button id=&quot;create_button&quot;</span>
<a href="#l13.575"></a><span id="l13.575" class="difflineminus">-              label=&quot;&amp;createAccount.label;&quot;</span>
<a href="#l13.576"></a><span id="l13.576" class="difflineminus">-              accesskey=&quot;&amp;createAccount.accesskey;&quot;</span>
<a href="#l13.577"></a><span id="l13.577" class="difflineminus">-              class=&quot;larger-button&quot;</span>
<a href="#l13.578"></a><span id="l13.578" class="difflineminus">-              hidden=&quot;true&quot;</span>
<a href="#l13.579"></a><span id="l13.579" class="difflineminus">-              disabled=&quot;true&quot;</span>
<a href="#l13.580"></a><span id="l13.580" class="difflineminus">-              oncommand=&quot;gEmailConfigWizard.onOK();&quot;/&gt;</span>
<a href="#l13.581"></a><span id="l13.581" class="difflineminus">-      &lt;hbox pack=&quot;end&quot;&gt;</span>
<a href="#l13.582"></a><span id="l13.582" class="difflineplus">+        &lt;button id=&quot;half-manual-test_button&quot;</span>
<a href="#l13.583"></a><span id="l13.583" class="difflineplus">+                label=&quot;&amp;half-manual-test.label;&quot;</span>
<a href="#l13.584"></a><span id="l13.584" class="difflineplus">+                accesskey=&quot;&amp;half-manual-test.accesskey;&quot;</span>
<a href="#l13.585"></a><span id="l13.585" class="difflineplus">+                class=&quot;larger-button&quot;</span>
<a href="#l13.586"></a><span id="l13.586" class="difflineplus">+                hidden=&quot;true&quot;</span>
<a href="#l13.587"></a><span id="l13.587" class="difflineplus">+                oncommand=&quot;gEmailConfigWizard.onHalfManualTest();&quot;/&gt;</span>
<a href="#l13.588"></a><span id="l13.588">         &lt;button id=&quot;next_button&quot;</span>
<a href="#l13.589"></a><span id="l13.589">                 label=&quot;&amp;continue.label;&quot;</span>
<a href="#l13.590"></a><span id="l13.590">                 accesskey=&quot;&amp;continue.accesskey;&quot;</span>
<a href="#l13.591"></a><span id="l13.591">                 class=&quot;larger-button&quot;</span>
<a href="#l13.592"></a><span id="l13.592">                 hidden=&quot;false&quot;</span>
<a href="#l13.593"></a><span id="l13.593" class="difflineminus">-                disabled=&quot;true&quot;</span>
<a href="#l13.594"></a><span id="l13.594">                 oncommand=&quot;gEmailConfigWizard.onNext();&quot;/&gt;</span>
<a href="#l13.595"></a><span id="l13.595" class="difflineplus">+        &lt;button id=&quot;create_button&quot;</span>
<a href="#l13.596"></a><span id="l13.596" class="difflineplus">+                label=&quot;&amp;createAccount.label;&quot;</span>
<a href="#l13.597"></a><span id="l13.597" class="difflineplus">+                accesskey=&quot;&amp;createAccount.accesskey;&quot;</span>
<a href="#l13.598"></a><span id="l13.598" class="difflineplus">+                class=&quot;larger-button&quot;</span>
<a href="#l13.599"></a><span id="l13.599" class="difflineplus">+                hidden=&quot;true&quot;</span>
<a href="#l13.600"></a><span id="l13.600" class="difflineplus">+                oncommand=&quot;gEmailConfigWizard.onCreate();&quot;/&gt;</span>
<a href="#l13.601"></a><span id="l13.601">       &lt;/hbox&gt;</span>
<a href="#l13.602"></a><span id="l13.602">     &lt;/hbox&gt;</span>
<a href="#l13.603"></a><span id="l13.603">   &lt;/vbox&gt;</span>
<a href="#l13.604"></a><span id="l13.604"> </span>
<a href="#l13.605"></a><span id="l13.605"> </span>
<a href="#l13.606"></a><span id="l13.606">   &lt;vbox id=&quot;warningbox&quot; hidden=&quot;true&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l13.607"></a><span id="l13.607">     &lt;hbox class=&quot;warning&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l13.608"></a><span id="l13.608">       &lt;vbox class=&quot;larrybox&quot;&gt;</span>
<a href="#l13.609"></a><span id="l13.609" class="difflineat">@@ -432,46 +441,47 @@</span>
<a href="#l13.610"></a><span id="l13.610">         &lt;vbox id=&quot;incoming_box&quot;&gt;</span>
<a href="#l13.611"></a><span id="l13.611">           &lt;hbox&gt;</span>
<a href="#l13.612"></a><span id="l13.612">             &lt;label class=&quot;warning_settings&quot; value=&quot;&amp;incomingSettings.label;&quot;/&gt;</span>
<a href="#l13.613"></a><span id="l13.613">             &lt;description id=&quot;warning_incoming&quot;/&gt;</span>
<a href="#l13.614"></a><span id="l13.614">           &lt;/hbox&gt;</span>
<a href="#l13.615"></a><span id="l13.615">           &lt;label id=&quot;incoming_technical&quot;</span>
<a href="#l13.616"></a><span id="l13.616">                  class=&quot;technical_details&quot;</span>
<a href="#l13.617"></a><span id="l13.617">                  value=&quot;&amp;technicaldetails.label;&quot;</span>
<a href="#l13.618"></a><span id="l13.618" class="difflineminus">-                 onclick=&quot;gEmailConfigWizard.toggleDetails('incoming');&quot;/&gt;</span>
<a href="#l13.619"></a><span id="l13.619" class="difflineplus">+                 onclick=&quot;gSecurityWarningDialog.toggleDetails('incoming');&quot;/&gt;</span>
<a href="#l13.620"></a><span id="l13.620">           &lt;description id=&quot;incoming_details&quot; collapsed=&quot;true&quot;/&gt;</span>
<a href="#l13.621"></a><span id="l13.621">         &lt;/vbox&gt;</span>
<a href="#l13.622"></a><span id="l13.622">         &lt;vbox id=&quot;outgoing_box&quot;&gt;</span>
<a href="#l13.623"></a><span id="l13.623">           &lt;hbox&gt;</span>
<a href="#l13.624"></a><span id="l13.624">             &lt;label class=&quot;warning_settings&quot; value=&quot;&amp;outgoingSettings.label;&quot;/&gt;</span>
<a href="#l13.625"></a><span id="l13.625">             &lt;description id=&quot;warning_outgoing&quot;/&gt;</span>
<a href="#l13.626"></a><span id="l13.626">           &lt;/hbox&gt;</span>
<a href="#l13.627"></a><span id="l13.627">           &lt;label id=&quot;outgoing_technical&quot;</span>
<a href="#l13.628"></a><span id="l13.628">                  class=&quot;technical_details&quot;</span>
<a href="#l13.629"></a><span id="l13.629">                  value=&quot;&amp;technicaldetails.label;&quot;</span>
<a href="#l13.630"></a><span id="l13.630" class="difflineminus">-                 onclick=&quot;gEmailConfigWizard.toggleDetails('outgoing');&quot;/&gt;</span>
<a href="#l13.631"></a><span id="l13.631" class="difflineplus">+                 onclick=&quot;gSecurityWarningDialog.toggleDetails('outgoing');&quot;/&gt;</span>
<a href="#l13.632"></a><span id="l13.632">           &lt;description id=&quot;outgoing_details&quot; collapsed=&quot;true&quot;/&gt;</span>
<a href="#l13.633"></a><span id="l13.633">         &lt;/vbox&gt;</span>
<a href="#l13.634"></a><span id="l13.634">         &lt;spacer flex=&quot;10&quot;/&gt;</span>
<a href="#l13.635"></a><span id="l13.635" class="difflineminus">-        &lt;description id=&quot;findoutmore&quot;&gt;&amp;contactYourProvider.description;&lt;/description&gt;</span>
<a href="#l13.636"></a><span id="l13.636" class="difflineplus">+        &lt;description id=&quot;findoutmore&quot;&gt;</span>
<a href="#l13.637"></a><span id="l13.637" class="difflineplus">+            &amp;contactYourProvider.description;&lt;/description&gt;</span>
<a href="#l13.638"></a><span id="l13.638">         &lt;spacer flex=&quot;100&quot;/&gt;</span>
<a href="#l13.639"></a><span id="l13.639">         &lt;checkbox id=&quot;acknowledge_warning&quot;</span>
<a href="#l13.640"></a><span id="l13.640">                   label=&quot;&amp;confirmWarning.label;&quot;</span>
<a href="#l13.641"></a><span id="l13.641">                   accesskey=&quot;&amp;confirmWarning.accesskey;&quot;</span>
<a href="#l13.642"></a><span id="l13.642">                   class=&quot;acknowledge_checkbox&quot;</span>
<a href="#l13.643"></a><span id="l13.643" class="difflineminus">-                  oncommand=&quot;gEmailConfigWizard.toggleAcknowledgeWarning()&quot;/&gt;</span>
<a href="#l13.644"></a><span id="l13.644" class="difflineplus">+                  oncommand=&quot;gSecurityWarningDialog.toggleAcknowledge()&quot;/&gt;</span>
<a href="#l13.645"></a><span id="l13.645">         &lt;hbox&gt;</span>
<a href="#l13.646"></a><span id="l13.646">           &lt;button id=&quot;getmeoutofhere&quot;</span>
<a href="#l13.647"></a><span id="l13.647">                   label=&quot;&amp;changeSettings.label;&quot;</span>
<a href="#l13.648"></a><span id="l13.648">                   accesskey=&quot;&amp;changeSettings.accesskey;&quot;</span>
<a href="#l13.649"></a><span id="l13.649" class="difflineminus">-                  oncommand=&quot;gEmailConfigWizard.getMeOutOfHere()&quot;/&gt;</span>
<a href="#l13.650"></a><span id="l13.650" class="difflineplus">+                  oncommand=&quot;gSecurityWarningDialog.onCancel()&quot;/&gt;</span>
<a href="#l13.651"></a><span id="l13.651">           &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l13.652"></a><span id="l13.652">           &lt;button id=&quot;iknow&quot;</span>
<a href="#l13.653"></a><span id="l13.653">                   label=&quot;&amp;createAccount.label;&quot;</span>
<a href="#l13.654"></a><span id="l13.654">                   accesskey=&quot;&amp;createAccount.accesskey;&quot;</span>
<a href="#l13.655"></a><span id="l13.655">                   disabled=&quot;true&quot;</span>
<a href="#l13.656"></a><span id="l13.656" class="difflineminus">-                  oncommand=&quot;gEmailConfigWizard.validateAndFinish()&quot;/&gt;</span>
<a href="#l13.657"></a><span id="l13.657" class="difflineplus">+                  oncommand=&quot;gSecurityWarningDialog.onOK()&quot;/&gt;</span>
<a href="#l13.658"></a><span id="l13.658">         &lt;/hbox&gt;</span>
<a href="#l13.659"></a><span id="l13.659">       &lt;/vbox&gt;</span>
<a href="#l13.660"></a><span id="l13.660">     &lt;/hbox&gt;</span>
<a href="#l13.661"></a><span id="l13.661">   &lt;/vbox&gt;</span>
<a href="#l13.662"></a><span id="l13.662"> &lt;/window&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/fetchConfig.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/fetchConfig.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -67,17 +67,18 @@ function fetchConfigFromDisk(domain, suc</span>
<a href="#l14.4"></a><span id="l14.4">  * @param domain {String}   The domain part of the user's email address</span>
<a href="#l14.5"></a><span id="l14.5">  * @param emailAddress {String}   The user's email address</span>
<a href="#l14.6"></a><span id="l14.6">  * @param successCallback {Function(config {AccountConfig}})}   A callback that</span>
<a href="#l14.7"></a><span id="l14.7">  *         will be called when we could retrieve a configuration.</span>
<a href="#l14.8"></a><span id="l14.8">  *         The AccountConfig object will be passed in as first parameter.</span>
<a href="#l14.9"></a><span id="l14.9">  * @param errorCallback {Function(ex)}   A callback that</span>
<a href="#l14.10"></a><span id="l14.10">  *         will be called when we could not retrieve a configuration,</span>
<a href="#l14.11"></a><span id="l14.11">  *         for whatever reason. This is expected (e.g. when there's no config</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">- *         for this domain at this location), so do not unconditionally show this to the user.</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+ *         for this domain at this location),</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+ *         so do not unconditionally show this to the user.</span>
<a href="#l14.15"></a><span id="l14.15">  *         The first paramter will be an exception object or error string.</span>
<a href="#l14.16"></a><span id="l14.16">  */</span>
<a href="#l14.17"></a><span id="l14.17"> function fetchConfigFromISP(domain, emailAddress, successCallback,</span>
<a href="#l14.18"></a><span id="l14.18">                             errorCallback)</span>
<a href="#l14.19"></a><span id="l14.19"> {</span>
<a href="#l14.20"></a><span id="l14.20">   let url1 = &quot;http://autoconfig.&quot; + sanitize.hostname(domain) +</span>
<a href="#l14.21"></a><span id="l14.21">              &quot;/mail/config-v1.1.xml&quot;;</span>
<a href="#l14.22"></a><span id="l14.22">   // .well-known/ &lt;http://tools.ietf.org/html/draft-nottingham-site-meta-04&gt;</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineat">@@ -91,27 +92,35 @@ function fetchConfigFromISP(domain, emai</span>
<a href="#l14.24"></a><span id="l14.24">     {</span>
<a href="#l14.25"></a><span id="l14.25">       successCallback(readFromXML(result));</span>
<a href="#l14.26"></a><span id="l14.26">     },</span>
<a href="#l14.27"></a><span id="l14.27">     function(e1) // fetch1 failed</span>
<a href="#l14.28"></a><span id="l14.28">     {</span>
<a href="#l14.29"></a><span id="l14.29">       ddump(&quot;fetchisp 1 &lt;&quot; + url1 + &quot;&gt; took &quot; + (Date.now() - time) +</span>
<a href="#l14.30"></a><span id="l14.30">           &quot;ms and failed with &quot; + e1);</span>
<a href="#l14.31"></a><span id="l14.31">       time = Date.now();</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+      if (e1 instanceof CancelledException)</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+      {</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+        errorCallback(e1);</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+        return;</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+      }</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+</span>
<a href="#l14.38"></a><span id="l14.38">       let fetch2 = new FetchHTTP(</span>
<a href="#l14.39"></a><span id="l14.39">         url2, { emailaddress: emailAddress }, false,</span>
<a href="#l14.40"></a><span id="l14.40">         function(result)</span>
<a href="#l14.41"></a><span id="l14.41">         {</span>
<a href="#l14.42"></a><span id="l14.42">           successCallback(readFromXML(result));</span>
<a href="#l14.43"></a><span id="l14.43">         },</span>
<a href="#l14.44"></a><span id="l14.44">         function(e2)</span>
<a href="#l14.45"></a><span id="l14.45">         {</span>
<a href="#l14.46"></a><span id="l14.46">           ddump(&quot;fetchisp 2 &lt;&quot; + url2 + &quot;&gt; took &quot; + (Date.now() - time) +</span>
<a href="#l14.47"></a><span id="l14.47">               &quot;ms and failed with &quot; + e2);</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-          errorCallback(e1); // return error for primary call</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+          // return the error for the primary call,</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+          // unless the fetch was cancelled</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+          errorCallback(e2 instanceof CancelledException ? e2 : e1);</span>
<a href="#l14.52"></a><span id="l14.52">         });</span>
<a href="#l14.53"></a><span id="l14.53">       sucAbortable.current = fetch2;</span>
<a href="#l14.54"></a><span id="l14.54">       fetch2.start();</span>
<a href="#l14.55"></a><span id="l14.55">     });</span>
<a href="#l14.56"></a><span id="l14.56">   sucAbortable.current = fetch1;</span>
<a href="#l14.57"></a><span id="l14.57">   fetch1.start();</span>
<a href="#l14.58"></a><span id="l14.58">   return sucAbortable;</span>
<a href="#l14.59"></a><span id="l14.59"> }</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineat">@@ -119,27 +128,29 @@ function fetchConfigFromISP(domain, emai</span>
<a href="#l14.61"></a><span id="l14.61"> /**</span>
<a href="#l14.62"></a><span id="l14.62">  * Tries to get a configuration for this ISP from a central database at</span>
<a href="#l14.63"></a><span id="l14.63">  * Mozilla servers.</span>
<a href="#l14.64"></a><span id="l14.64">  * Params @see fetchConfigFromISP()</span>
<a href="#l14.65"></a><span id="l14.65">  */</span>
<a href="#l14.66"></a><span id="l14.66"> </span>
<a href="#l14.67"></a><span id="l14.67"> function fetchConfigFromDB(domain, successCallback, errorCallback)</span>
<a href="#l14.68"></a><span id="l14.68"> {</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-  let pref = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-                               .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+  let pref = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+             .getService(Ci.nsIPrefBranch);</span>
<a href="#l14.73"></a><span id="l14.73">   let url = pref.getCharPref(&quot;mailnews.auto_config_url&quot;);</span>
<a href="#l14.74"></a><span id="l14.74">   let domain = sanitize.hostname(domain);</span>
<a href="#l14.75"></a><span id="l14.75"> </span>
<a href="#l14.76"></a><span id="l14.76">   // If we don't specify a place to put the domain, put it at the end.</span>
<a href="#l14.77"></a><span id="l14.77">   if (url.indexOf(&quot;{{domain}}&quot;) == -1)</span>
<a href="#l14.78"></a><span id="l14.78">     url = url + domain;</span>
<a href="#l14.79"></a><span id="l14.79">   else</span>
<a href="#l14.80"></a><span id="l14.80">     url = url.replace(&quot;{{domain}}&quot;, domain);</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineminus">-  url = url.replace(&quot;{{accounts}}&quot;, gAccountMgr.accounts.Count());</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+  var accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+                       .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+  url = url.replace(&quot;{{accounts}}&quot;, accountManager.accounts.Count());</span>
<a href="#l14.85"></a><span id="l14.85"> </span>
<a href="#l14.86"></a><span id="l14.86">   if (!url.length)</span>
<a href="#l14.87"></a><span id="l14.87">     return errorCallback(&quot;no fetch url set&quot;);</span>
<a href="#l14.88"></a><span id="l14.88">   let fetch = new FetchHTTP(url, null, false,</span>
<a href="#l14.89"></a><span id="l14.89">                             function(result)</span>
<a href="#l14.90"></a><span id="l14.90">                             {</span>
<a href="#l14.91"></a><span id="l14.91">                               successCallback(readFromXML(result));</span>
<a href="#l14.92"></a><span id="l14.92">                             },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/fetchhttp.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/fetchhttp.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -178,60 +178,78 @@ FetchHTTP.prototype =</span>
<a href="#l15.4"></a><span id="l15.4">           //ddump(&quot;mimetype: &quot; + mimetype + &quot; only supported as text&quot;);</span>
<a href="#l15.5"></a><span id="l15.5">           this.result = this._request.responseText;</span>
<a href="#l15.6"></a><span id="l15.6">         }</span>
<a href="#l15.7"></a><span id="l15.7">         //ddump(&quot;result:\n&quot; + this.result);</span>
<a href="#l15.8"></a><span id="l15.8">       }</span>
<a href="#l15.9"></a><span id="l15.9">       catch (e)</span>
<a href="#l15.10"></a><span id="l15.10">       {</span>
<a href="#l15.11"></a><span id="l15.11">         success = false;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-        let stringBundle = getStringBundle(&quot;chrome://messenger/locale/accountCreationUtil.properties&quot;);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-        errorStr = stringBundle.GetStringFromName(&quot;bad_response_content.error&quot;);</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+        errorStr = getStringBundle(</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+                   &quot;chrome://messenger/locale/accountCreationUtil.properties&quot;)</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+                   .GetStringFromName(&quot;bad_response_content.error&quot;);</span>
<a href="#l15.17"></a><span id="l15.17">         errorCode = -4;</span>
<a href="#l15.18"></a><span id="l15.18">       }</span>
<a href="#l15.19"></a><span id="l15.19">     }</span>
<a href="#l15.20"></a><span id="l15.20">     else</span>
<a href="#l15.21"></a><span id="l15.21">     {</span>
<a href="#l15.22"></a><span id="l15.22">       success = false;</span>
<a href="#l15.23"></a><span id="l15.23">       try</span>
<a href="#l15.24"></a><span id="l15.24">       {</span>
<a href="#l15.25"></a><span id="l15.25">         errorCode = this._request.status;</span>
<a href="#l15.26"></a><span id="l15.26">         errorStr = this._request.statusText;</span>
<a href="#l15.27"></a><span id="l15.27">       } catch (e) {</span>
<a href="#l15.28"></a><span id="l15.28">         // If we can't resolve the hostname in DNS etc., .statusText throws</span>
<a href="#l15.29"></a><span id="l15.29">         errorCode = -2;</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-        let stringBundle = getStringBundle(&quot;chrome://messenger/locale/accountCreationUtil.properties&quot;)</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-        errorStr = stringBundle.GetStringFromName(&quot;cannot_contact_server.error&quot;);</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+        errorStr = getStringBundle(</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+                   &quot;chrome://messenger/locale/accountCreationUtil.properties&quot;)</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+                   .GetStringFromName(&quot;cannot_contact_server.error&quot;);</span>
<a href="#l15.35"></a><span id="l15.35">         ddump(errorStr);</span>
<a href="#l15.36"></a><span id="l15.36">       }</span>
<a href="#l15.37"></a><span id="l15.37">     }</span>
<a href="#l15.38"></a><span id="l15.38"> </span>
<a href="#l15.39"></a><span id="l15.39">     // Callbacks</span>
<a href="#l15.40"></a><span id="l15.40">     if (success)</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-      this._successCallback(this.result);</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+    {</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+      try {</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+        this._successCallback(this.result);</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+      } catch (e) {</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+        logException(e);</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+        this._error(e);</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+      }</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+    }</span>
<a href="#l15.50"></a><span id="l15.50">     else if (exStored)</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-      this._errorCallback(exStored);</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+      this._error(exStored);</span>
<a href="#l15.53"></a><span id="l15.53">     else</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-      this._errorCallback(new ServerException(errorStr, errorCode, this._url));</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+      this._error(new ServerException(errorStr, errorCode, this._url));</span>
<a href="#l15.56"></a><span id="l15.56"> </span>
<a href="#l15.57"></a><span id="l15.57">     if (this._finishedCallback)</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-      this._finishedCallback(this);</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+    {</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+      try {</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+        this._finishedCallback(this);</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+      } catch (e) {</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+        logException(e);</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+        this._error(e);</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+      }</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+    }</span>
<a href="#l15.67"></a><span id="l15.67"> </span>
<a href="#l15.68"></a><span id="l15.68">     } catch (e) {</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-      // error in callback or our fetchhttp._response() code</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-      try</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-      {</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-        ddump(&quot;Error in errorCallback or _response(): &quot; + e);</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-        this._errorCallback(e);</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-      } catch (e) {</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-        //ddump(&quot;Error in errorCallback: &quot; + e);</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-        // XXX TODO FIXME BOGUS</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-        alert(e); // error in errorCallback, too!</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-        throw(e); // to error console</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-      }</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+      // error in our fetchhttp._response() code</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+      logException(e);</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+      this._error(e);</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+    }</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+  },</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+  _error : function(e)</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+  {</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+    try {</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+      this._errorCallback(e);</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+    } catch (e) {</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+      // error in errorCallback, too!</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+      logException(e);</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+      alertPrompt(&quot;Error in errorCallback for fetchhttp&quot;, e);</span>
<a href="#l15.93"></a><span id="l15.93">     }</span>
<a href="#l15.94"></a><span id="l15.94">   },</span>
<a href="#l15.95"></a><span id="l15.95">   /**</span>
<a href="#l15.96"></a><span id="l15.96">    * Call this between start() and finishedCallback fired.</span>
<a href="#l15.97"></a><span id="l15.97">    */</span>
<a href="#l15.98"></a><span id="l15.98">   cancel : function(ex)</span>
<a href="#l15.99"></a><span id="l15.99">   {</span>
<a href="#l15.100"></a><span id="l15.100">     assert(!this.result, &quot;Call already returned&quot;);</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineat">@@ -249,28 +267,38 @@ FetchHTTP.prototype =</span>
<a href="#l15.102"></a><span id="l15.102">    */</span>
<a href="#l15.103"></a><span id="l15.103">   setFinishedCallback : function(finishedCallback)</span>
<a href="#l15.104"></a><span id="l15.104">   {</span>
<a href="#l15.105"></a><span id="l15.105">     this._finishedCallback = finishedCallback;</span>
<a href="#l15.106"></a><span id="l15.106">   }</span>
<a href="#l15.107"></a><span id="l15.107"> }</span>
<a href="#l15.108"></a><span id="l15.108"> extend(FetchHTTP, Abortable);</span>
<a href="#l15.109"></a><span id="l15.109"> </span>
<a href="#l15.110"></a><span id="l15.110" class="difflineplus">+</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineplus">+function CancelledException(msg)</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineplus">+{</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+  Exception.call(this, msg);</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineplus">+}</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+CancelledException.prototype =</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+{</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineplus">+}</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineplus">+extend(CancelledException, Exception);</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+</span>
<a href="#l15.120"></a><span id="l15.120"> function UserCancelledException(msg)</span>
<a href="#l15.121"></a><span id="l15.121"> {</span>
<a href="#l15.122"></a><span id="l15.122">   // The user knows they cancelled so I don't see a need</span>
<a href="#l15.123"></a><span id="l15.123">   // for a message to that effect.</span>
<a href="#l15.124"></a><span id="l15.124">   if (!msg)</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-    msg = &quot;&quot;;</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineminus">-  Exception.call(this, msg);</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineplus">+    msg = &quot;User cancelled&quot;;</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineplus">+  CancelledException.call(this, msg);</span>
<a href="#l15.129"></a><span id="l15.129"> }</span>
<a href="#l15.130"></a><span id="l15.130"> UserCancelledException.prototype =</span>
<a href="#l15.131"></a><span id="l15.131"> {</span>
<a href="#l15.132"></a><span id="l15.132"> }</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineminus">-extend(UserCancelledException, Exception);</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineplus">+extend(UserCancelledException, CancelledException);</span>
<a href="#l15.135"></a><span id="l15.135"> </span>
<a href="#l15.136"></a><span id="l15.136"> function ServerException(msg, code, uri)</span>
<a href="#l15.137"></a><span id="l15.137"> {</span>
<a href="#l15.138"></a><span id="l15.138">   Exception.call(this, msg);</span>
<a href="#l15.139"></a><span id="l15.139">   this.code = code;</span>
<a href="#l15.140"></a><span id="l15.140">   this.uri = uri;</span>
<a href="#l15.141"></a><span id="l15.141"> }</span>
<a href="#l15.142"></a><span id="l15.142"> ServerException.prototype =</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/guessConfig.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/guessConfig.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -76,50 +76,35 @@ var outgoingDone = false;</span>
<a href="#l16.4"></a><span id="l16.4">  *   param accountConfig {AccountConfig} The guessed account config.</span>
<a href="#l16.5"></a><span id="l16.5">  *       username, password, realname, emailaddress etc. are not filled out,</span>
<a href="#l16.6"></a><span id="l16.6">  *       but placeholders to be filled out via replaceVariables().</span>
<a href="#l16.7"></a><span id="l16.7">  * @param errorCallback function(ex)</span>
<a href="#l16.8"></a><span id="l16.8">  *   Called when we could guess not the config, either</span>
<a href="#l16.9"></a><span id="l16.9">  *   because we have not found anything or</span>
<a href="#l16.10"></a><span id="l16.10">  *   because there was an error (e.g. no network connection).</span>
<a href="#l16.11"></a><span id="l16.11">  *   The ex.message will contain a user-presentable message.</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">- * @param incomingErrorCallback {function(ex, config {AccountConfig})}</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">- *   Like errorCallback, just that we do have a config for the</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">- *   outgoing server, just not for the incoming server.</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">- *   This is not terribly useful, because we may have guessed</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">- *   the MX server (SMTP server for incoming mail from other SMTP servers),</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">- *   not the outbound SMTP for users.</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">- *   Showing MX will highly mislead users, so better to treat that as total error.</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">- * @param outgoingErrorCallback {function(ex, config {AccountConfig})}</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">- *   Like errorCallback, just that we do have a config for the</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">- *   incoming server, just not for the outgoing server.</span>
<a href="#l16.22"></a><span id="l16.22">  * @param resultConfig {AccountConfig} (optional)</span>
<a href="#l16.23"></a><span id="l16.23">  *   A config which may be partially filled in. If so, it will be used as base</span>
<a href="#l16.24"></a><span id="l16.24">  *   for the guess.</span>
<a href="#l16.25"></a><span id="l16.25">  * @param which {String-enum} (optional)  &quot;incoming&quot;, &quot;outgoing&quot;, or &quot;both&quot;.</span>
<a href="#l16.26"></a><span id="l16.26">  *   Default &quot;both&quot;. Whether to guess only the incoming or outgoing server.</span>
<a href="#l16.27"></a><span id="l16.27">  * @result {Abortable} Allows you to cancel the guess</span>
<a href="#l16.28"></a><span id="l16.28">  */</span>
<a href="#l16.29"></a><span id="l16.29"> function guessConfig(domain, progressCallback, successCallback, errorCallback,</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-                     incomingErrorCallback, outgoingErrorCallback,</span>
<a href="#l16.31"></a><span id="l16.31">                      resultConfig, which)</span>
<a href="#l16.32"></a><span id="l16.32"> {</span>
<a href="#l16.33"></a><span id="l16.33">   assert(typeof(progressCallback) == &quot;function&quot;, &quot;need progressCallback&quot;);</span>
<a href="#l16.34"></a><span id="l16.34">   assert(typeof(successCallback) == &quot;function&quot;, &quot;need successCallback&quot;);</span>
<a href="#l16.35"></a><span id="l16.35">   assert(typeof(errorCallback) == &quot;function&quot;, &quot;need errorCallback&quot;);</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-  assert(typeof(incomingErrorCallback) == &quot;function&quot;,</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-    &quot;need incomingErrorCallback&quot;);</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-  assert(typeof(outgoingErrorCallback) == &quot;function&quot;,</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-    &quot;need outgoingErrorCallback&quot;);</span>
<a href="#l16.40"></a><span id="l16.40">   if (!resultConfig)</span>
<a href="#l16.41"></a><span id="l16.41">     resultConfig = new AccountConfig();</span>
<a href="#l16.42"></a><span id="l16.42">   resultConfig.source = AccountConfig.kSourceGuess;</span>
<a href="#l16.43"></a><span id="l16.43"> </span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+  var incomingHostDetector = null;</span>
<a href="#l16.45"></a><span id="l16.45">   var outgoingHostDetector = null;</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-  var incomingHostDetector = null;</span>
<a href="#l16.47"></a><span id="l16.47">   var incomingEx = null; // if incoming had error, store ex here</span>
<a href="#l16.48"></a><span id="l16.48">   var outgoingEx = null; // if incoming had error, store ex here</span>
<a href="#l16.49"></a><span id="l16.49">   var incomingDone = (which == &quot;outgoing&quot;);</span>
<a href="#l16.50"></a><span id="l16.50">   var outgoingDone = (which == &quot;incoming&quot;);</span>
<a href="#l16.51"></a><span id="l16.51"> </span>
<a href="#l16.52"></a><span id="l16.52">   var progress = function(thisTry)</span>
<a href="#l16.53"></a><span id="l16.53">   {</span>
<a href="#l16.54"></a><span id="l16.54">     progressCallback(protocolToString(thisTry.protocol), thisTry.hostname,</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineat">@@ -127,41 +112,57 @@ function guessConfig(domain, progressCal</span>
<a href="#l16.56"></a><span id="l16.56">                      resultConfig);</span>
<a href="#l16.57"></a><span id="l16.57">   };</span>
<a href="#l16.58"></a><span id="l16.58"> </span>
<a href="#l16.59"></a><span id="l16.59">   var updateConfig = function(config)</span>
<a href="#l16.60"></a><span id="l16.60">   {</span>
<a href="#l16.61"></a><span id="l16.61">     resultConfig = config;</span>
<a href="#l16.62"></a><span id="l16.62">   };</span>
<a href="#l16.63"></a><span id="l16.63"> </span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+  var errorInCallback = function(e)</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+  {</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+    // The caller's errorCallback threw.</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+    // hopefully shouldn't happen for users.</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+    alertPrompt(&quot;Error in errorCallback for guessConfig()&quot;, e);</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+  };</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+</span>
<a href="#l16.71"></a><span id="l16.71">   var checkDone = function()</span>
<a href="#l16.72"></a><span id="l16.72">   {</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineminus">-    if (outgoingEx)</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-      outgoingErrorCallback(outgoingEx, resultConfig);</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-</span>
<a href="#l16.76"></a><span id="l16.76">     if (incomingEx)</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-      incomingErrorCallback(incomingEx, resultConfig);</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineminus">-    if (incomingEx &amp;&amp; outgoingEx)</span>
<a href="#l16.80"></a><span id="l16.80">     {</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineminus">-      errorCallback(incomingEx, resultConfig);</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+      try {</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+        errorCallback(incomingEx, resultConfig);</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+      } catch (e) { errorInCallback(e); }</span>
<a href="#l16.85"></a><span id="l16.85">       return;</span>
<a href="#l16.86"></a><span id="l16.86">     }</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-    if ((incomingDone || incomingEx) &amp;&amp; (outgoingDone || outgoingEx))</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+    if (outgoingEx)</span>
<a href="#l16.89"></a><span id="l16.89">     {</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-      successCallback(resultConfig);</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+      try {</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineplus">+        errorCallback(outgoingEx, resultConfig);</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+      } catch (e) { errorInCallback(e); }</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+      return;</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+    }</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+    if (incomingDone &amp;&amp; outgoingDone)</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+    {</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+      try {</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+        successCallback(resultConfig);</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+      } catch (e) {</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+        try {</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+          errorCallback(e);</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+        } catch (e) { errorInCallback(e); }</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+      }</span>
<a href="#l16.105"></a><span id="l16.105">       return;</span>
<a href="#l16.106"></a><span id="l16.106">     }</span>
<a href="#l16.107"></a><span id="l16.107">   };</span>
<a href="#l16.108"></a><span id="l16.108"> </span>
<a href="#l16.109"></a><span id="l16.109">   var outgoingSuccess = function(thisTry)</span>
<a href="#l16.110"></a><span id="l16.110">   {</span>
<a href="#l16.111"></a><span id="l16.111">     assert(thisTry.protocol == SMTP, &quot;I only know SMTP for outgoing&quot;);</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineminus">-    // Ensure there are no previously saved outgoing errors if we've got success</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineminus">-    // here.</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+    // Ensure there are no previously saved outgoing errors, if we've got</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+    // success here.</span>
<a href="#l16.116"></a><span id="l16.116">     outgoingEx = null;</span>
<a href="#l16.117"></a><span id="l16.117">     resultConfig.outgoing.type = &quot;smtp&quot;;</span>
<a href="#l16.118"></a><span id="l16.118">     resultConfig.outgoing.hostname = thisTry.hostname;</span>
<a href="#l16.119"></a><span id="l16.119">     resultConfig.outgoing.port = thisTry.port;</span>
<a href="#l16.120"></a><span id="l16.120">     resultConfig.outgoing.socketType = sslConvertToSocketType(thisTry.ssl);</span>
<a href="#l16.121"></a><span id="l16.121">     resultConfig.outgoing.auth = chooseBestAuthMethod(thisTry.authMethods);</span>
<a href="#l16.122"></a><span id="l16.122">     resultConfig.outgoing.authAlternatives = thisTry.authMethods;</span>
<a href="#l16.123"></a><span id="l16.123">     // TODO</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineat">@@ -172,26 +173,20 @@ function guessConfig(domain, progressCal</span>
<a href="#l16.125"></a><span id="l16.125"> </span>
<a href="#l16.126"></a><span id="l16.126">     progressCallback(resultConfig.outgoing.type,</span>
<a href="#l16.127"></a><span id="l16.127">         resultConfig.outgoing.hostname, resultConfig.outgoing.port,</span>
<a href="#l16.128"></a><span id="l16.128">         resultConfig.outgoing.socketType, true, resultConfig);</span>
<a href="#l16.129"></a><span id="l16.129">     outgoingDone = true;</span>
<a href="#l16.130"></a><span id="l16.130">     checkDone();</span>
<a href="#l16.131"></a><span id="l16.131">   };</span>
<a href="#l16.132"></a><span id="l16.132"> </span>
<a href="#l16.133"></a><span id="l16.133" class="difflineminus">-  var outgoingError = function(ex)</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineminus">-  {</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineminus">-    outgoingEx = ex;</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineminus">-    checkDone();</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineminus">-  };</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineminus">-</span>
<a href="#l16.139"></a><span id="l16.139">   var incomingSuccess = function(thisTry)</span>
<a href="#l16.140"></a><span id="l16.140">   {</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineminus">-    // Ensure there are no previously saved incoming errors if we've got success</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineminus">-    // here.</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+    // Ensure there are no previously saved incoming errors, if we've got</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+    // success here.</span>
<a href="#l16.145"></a><span id="l16.145">     incomingEx = null;</span>
<a href="#l16.146"></a><span id="l16.146">     resultConfig.incoming.type = protocolToString(thisTry.protocol);</span>
<a href="#l16.147"></a><span id="l16.147">     resultConfig.incoming.hostname = thisTry.hostname;</span>
<a href="#l16.148"></a><span id="l16.148">     resultConfig.incoming.port = thisTry.port;</span>
<a href="#l16.149"></a><span id="l16.149">     resultConfig.incoming.socketType = sslConvertToSocketType(thisTry.ssl);</span>
<a href="#l16.150"></a><span id="l16.150">     resultConfig.incoming.auth = chooseBestAuthMethod(thisTry.authMethods);</span>
<a href="#l16.151"></a><span id="l16.151">     resultConfig.incoming.authAlternatives = thisTry.authMethods;</span>
<a href="#l16.152"></a><span id="l16.152">     resultConfig.incoming.badCert = thisTry.selfSignedCert;</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineat">@@ -203,114 +198,66 @@ function guessConfig(domain, progressCal</span>
<a href="#l16.154"></a><span id="l16.154">     incomingDone = true;</span>
<a href="#l16.155"></a><span id="l16.155">     checkDone();</span>
<a href="#l16.156"></a><span id="l16.156">   };</span>
<a href="#l16.157"></a><span id="l16.157"> </span>
<a href="#l16.158"></a><span id="l16.158">   var incomingError = function(ex)</span>
<a href="#l16.159"></a><span id="l16.159">   {</span>
<a href="#l16.160"></a><span id="l16.160">     incomingEx = ex;</span>
<a href="#l16.161"></a><span id="l16.161">     checkDone();</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineplus">+    incomingHostDetector.cancel(new CancelOthersException());</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineplus">+    outgoingHostDetector.cancel(new CancelOthersException());</span>
<a href="#l16.164"></a><span id="l16.164">   };</span>
<a href="#l16.165"></a><span id="l16.165"> </span>
<a href="#l16.166"></a><span id="l16.166" class="difflineminus">-  let incomingHostDetector = null;</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineminus">-  let outgoingHostDetector = null;</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineplus">+  var outgoingError = function(ex)</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+  {</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+    outgoingEx = ex;</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineplus">+    checkDone();</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineplus">+    incomingHostDetector.cancel(new CancelOthersException());</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+    outgoingHostDetector.cancel(new CancelOthersException());</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineplus">+  };</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineplus">+</span>
<a href="#l16.176"></a><span id="l16.176">   incomingHostDetector = new IncomingHostDetector(progress, incomingSuccess,</span>
<a href="#l16.177"></a><span id="l16.177">                                                   incomingError);</span>
<a href="#l16.178"></a><span id="l16.178">   outgoingHostDetector = new OutgoingHostDetector(progress, outgoingSuccess,</span>
<a href="#l16.179"></a><span id="l16.179">                                                   outgoingError);</span>
<a href="#l16.180"></a><span id="l16.180">   if (which == &quot;incoming&quot; || which == &quot;both&quot;)</span>
<a href="#l16.181"></a><span id="l16.181">   {</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineminus">-    incomingHostDetector.start(domain, !!resultConfig.incoming.hostname,</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineminus">-        resultConfig.incoming.type, resultConfig.incoming.port,</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineminus">-        resultConfig.incoming.socketType);</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineplus">+    incomingHostDetector.start(resultConfig.incoming.hostname ?</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineplus">+            resultConfig.incoming.hostname : domain,</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineplus">+        !!resultConfig.incoming.hostname, resultConfig.incoming.type,</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineplus">+        resultConfig.incoming.port, resultConfig.incoming.socketType);</span>
<a href="#l16.189"></a><span id="l16.189">   }</span>
<a href="#l16.190"></a><span id="l16.190">   if (which == &quot;outgoing&quot; || which == &quot;both&quot;)</span>
<a href="#l16.191"></a><span id="l16.191">   {</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineminus">-    outgoingHostDetector.start(domain, !!resultConfig.outgoing.hostname,</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineminus">-        &quot;smtp&quot;, resultConfig.outgoing.port, resultConfig.outgoing.socketType);</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineplus">+    outgoingHostDetector.start(resultConfig.outgoing.hostname ?</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineplus">+            resultConfig.outgoing.hostname : domain,</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineplus">+        !!resultConfig.outgoing.hostname, &quot;smtp&quot;,</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineplus">+        resultConfig.outgoing.port, resultConfig.outgoing.socketType);</span>
<a href="#l16.198"></a><span id="l16.198">   }</span>
<a href="#l16.199"></a><span id="l16.199"> </span>
<a href="#l16.200"></a><span id="l16.200">   return new GuessAbortable(incomingHostDetector, outgoingHostDetector,</span>
<a href="#l16.201"></a><span id="l16.201">                             updateConfig);</span>
<a href="#l16.202"></a><span id="l16.202"> }</span>
<a href="#l16.203"></a><span id="l16.203"> </span>
<a href="#l16.204"></a><span id="l16.204"> function GuessAbortable(incomingHostDetector, outgoingHostDetector,</span>
<a href="#l16.205"></a><span id="l16.205">                         updateConfig)</span>
<a href="#l16.206"></a><span id="l16.206"> {</span>
<a href="#l16.207"></a><span id="l16.207">   Abortable.call(this);</span>
<a href="#l16.208"></a><span id="l16.208">   this._incomingHostDetector = incomingHostDetector;</span>
<a href="#l16.209"></a><span id="l16.209">   this._outgoingHostDetector = outgoingHostDetector;</span>
<a href="#l16.210"></a><span id="l16.210">   this._updateConfig = updateConfig;</span>
<a href="#l16.211"></a><span id="l16.211"> }</span>
<a href="#l16.212"></a><span id="l16.212"> GuessAbortable.prototype =</span>
<a href="#l16.213"></a><span id="l16.213"> {</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineminus">-  cancel : function(which)</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineplus">+  cancel : function(ex)</span>
<a href="#l16.216"></a><span id="l16.216">   {</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineminus">-    switch (which)</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineminus">-    {</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineminus">-      case &quot;incoming&quot;:</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineminus">-      default:</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineminus">-        if (this._incomingHostDetector)</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineminus">-          this._incomingHostDetector.cancel();</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineminus">-      case &quot;outgoing&quot;:</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineminus">-        if (which != &quot;incoming&quot;)</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineminus">-        {</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineminus">-          if (this._outgoingHostDetector)</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineminus">-            this._outgoingHostDetector.cancel();</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineminus">-          outgoingDone = true;</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineminus">-        }</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineminus">-    }</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineplus">+    this._incomingHostDetector.cancel(ex);</span>
<a href="#l16.232"></a><span id="l16.232" class="difflineplus">+    this._outgoingHostDetector.cancel(ex);</span>
<a href="#l16.233"></a><span id="l16.233">   },</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineminus">-</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineminus">-  /**</span>
<a href="#l16.236"></a><span id="l16.236" class="difflineminus">-   * Start a detection that has been cancel()ed before,</span>
<a href="#l16.237"></a><span id="l16.237" class="difflineminus">-   * possibly with other parameters.</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineminus">-   *</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineminus">-   * This is basically an alternative to calling guessConfig() again.</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineminus">-   * TODO deprecate in favor of that?</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineminus">-   *</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineminus">-   * @param domain {String} @see HostDetector.start()</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineminus">-   * @param config {AccountConfig} @see guessConfig() resultConfig</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineminus">-   * @param which {String-enum} @see guessConfig() which</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineminus">-   * @param type {String-enum} @see HostDetector.start()</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineminus">-   * @param port {Integer} @see HostDetector.start()</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineminus">-   * @param socketType {Integer-enum} @see HostDetector.start()</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineminus">-   */</span>
<a href="#l16.249"></a><span id="l16.249" class="difflineminus">-  restart : function(domain, config, which, type, port, socketType)</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineminus">-  {</span>
<a href="#l16.251"></a><span id="l16.251" class="difflineminus">-    // Calling code may have changed config (e.g., user may have changed</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineminus">-    // username) so put new values in resultConfig.</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineminus">-    this._updateConfig(config);</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineminus">-    var incomingHostIsPrecise = !!config.incoming.hostname;</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineminus">-    var outgoingHostIsPrecise = !!config.outgoing.hostname;</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineminus">-    switch (which)</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineminus">-    {</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineminus">-      case &quot;incoming&quot;:</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineminus">-        assert(this._incomingHostDetector, &quot;need this._incomingHostDetector&quot;);</span>
<a href="#l16.260"></a><span id="l16.260" class="difflineminus">-        this._incomingHostDetector.cancel();</span>
<a href="#l16.261"></a><span id="l16.261" class="difflineminus">-        this._incomingHostDetector.start(domain, incomingHostIsPrecise,</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineminus">-                                         type, port, socketType);</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineminus">-        break;</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineminus">-      case &quot;outgoing&quot;:</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineminus">-        assert(this._outgoingHostDetector, &quot;need this._outgoingHostDetector&quot;);</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineminus">-        this._outgoingHostDetector.cancel();</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineminus">-        this._outgoingHostDetector.start(domain, outgoingHostIsPrecise,</span>
<a href="#l16.268"></a><span id="l16.268" class="difflineminus">-                                         &quot;smtp&quot;, port, socketType);</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineminus">-        break;</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineminus">-      default: // both</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineminus">-        assert(this._incomingHostDetector, &quot;need this._incomingHostDetector&quot;);</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineminus">-        assert(this._outgoingHostDetector, &quot;need this._outgoingHostDetector&quot;);</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineminus">-        this._incomingHostDetector.cancel();</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineminus">-        this._incomingHostDetector.start(domain, incomingHostIsPrecise,</span>
<a href="#l16.275"></a><span id="l16.275" class="difflineminus">-                                         type, port, socketType);</span>
<a href="#l16.276"></a><span id="l16.276" class="difflineminus">-        this._outgoingHostDetector.cancel();</span>
<a href="#l16.277"></a><span id="l16.277" class="difflineminus">-        this._outgoingHostDetector.start(domain, outgoingHostIsPrecise,</span>
<a href="#l16.278"></a><span id="l16.278" class="difflineminus">-                                         &quot;smtp&quot;, port, socketType);</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineminus">-    }</span>
<a href="#l16.280"></a><span id="l16.280" class="difflineminus">-  }</span>
<a href="#l16.281"></a><span id="l16.281"> }</span>
<a href="#l16.282"></a><span id="l16.282"> extend(GuessAbortable, Abortable);</span>
<a href="#l16.283"></a><span id="l16.283"> </span>
<a href="#l16.284"></a><span id="l16.284"> </span>
<a href="#l16.285"></a><span id="l16.285"> </span>
<a href="#l16.286"></a><span id="l16.286"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.287"></a><span id="l16.287"> // Implementation</span>
<a href="#l16.288"></a><span id="l16.288"> //</span>
<a href="#l16.289"></a><span id="l16.289" class="difflineat">@@ -356,28 +303,39 @@ HostTry.prototype =</span>
<a href="#l16.290"></a><span id="l16.290">   // {String} Whether the SSL cert is not from a proper CA</span>
<a href="#l16.291"></a><span id="l16.291">   selfSignedCert : false,</span>
<a href="#l16.292"></a><span id="l16.292">   // {String} Which host the SSL cert is made for, if not hostname.</span>
<a href="#l16.293"></a><span id="l16.293">   // If set, this is an SSL error.</span>
<a href="#l16.294"></a><span id="l16.294">   targetSite : null,</span>
<a href="#l16.295"></a><span id="l16.295"> };</span>
<a href="#l16.296"></a><span id="l16.296"> </span>
<a href="#l16.297"></a><span id="l16.297"> /**</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineplus">+ * When the success or errorCallbacks are called to abort the other requests</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineplus">+ * which happened in parallel, this ex is used as param for cancel(), so that</span>
<a href="#l16.300"></a><span id="l16.300" class="difflineplus">+ * the cancel doesn't trigger another callback.</span>
<a href="#l16.301"></a><span id="l16.301" class="difflineplus">+ */</span>
<a href="#l16.302"></a><span id="l16.302" class="difflineplus">+function CancelOthersException()</span>
<a href="#l16.303"></a><span id="l16.303" class="difflineplus">+{</span>
<a href="#l16.304"></a><span id="l16.304" class="difflineplus">+  CancelledException.call(this, &quot;we're done, cancelling the other probes&quot;);</span>
<a href="#l16.305"></a><span id="l16.305" class="difflineplus">+}</span>
<a href="#l16.306"></a><span id="l16.306" class="difflineplus">+CancelOthersException.prototype = {}</span>
<a href="#l16.307"></a><span id="l16.307" class="difflineplus">+extend(CancelOthersException, CancelledException);</span>
<a href="#l16.308"></a><span id="l16.308" class="difflineplus">+</span>
<a href="#l16.309"></a><span id="l16.309" class="difflineplus">+/**</span>
<a href="#l16.310"></a><span id="l16.310">  * @param successCallback {function(result {HostTry})}</span>
<a href="#l16.311"></a><span id="l16.311">  *    Called when the config is OK</span>
<a href="#l16.312"></a><span id="l16.312">  * @param errorCallback {function(ex)} Called when we could not find a config</span>
<a href="#l16.313"></a><span id="l16.313">  * @param progressCallback { function(server {HostTry}) } Called when we tried</span>
<a href="#l16.314"></a><span id="l16.314">  *    (will try?) a new hostname and port</span>
<a href="#l16.315"></a><span id="l16.315">  */</span>
<a href="#l16.316"></a><span id="l16.316"> function HostDetector(progressCallback, successCallback, errorCallback)</span>
<a href="#l16.317"></a><span id="l16.317"> {</span>
<a href="#l16.318"></a><span id="l16.318">   this.mSuccessCallback = successCallback;</span>
<a href="#l16.319"></a><span id="l16.319">   this.mProgressCallback = progressCallback;</span>
<a href="#l16.320"></a><span id="l16.320">   this.mErrorCallback = errorCallback;</span>
<a href="#l16.321"></a><span id="l16.321" class="difflineminus">-  this._done = false;</span>
<a href="#l16.322"></a><span id="l16.322">   this._cancel = false;</span>
<a href="#l16.323"></a><span id="l16.323">   // {Array of {HostTry}}, ordered by decreasing preference</span>
<a href="#l16.324"></a><span id="l16.324">   this._hostsToTry = new Array();</span>
<a href="#l16.325"></a><span id="l16.325"> </span>
<a href="#l16.326"></a><span id="l16.326">   // init logging</span>
<a href="#l16.327"></a><span id="l16.327">   this._log = Log4Moz.getConfiguredLogger(&quot;mail.wizard&quot;);</span>
<a href="#l16.328"></a><span id="l16.328">   this._log.info(&quot;created host detector&quot;);</span>
<a href="#l16.329"></a><span id="l16.329"> }</span>
<a href="#l16.330"></a><span id="l16.330" class="difflineat">@@ -389,24 +347,24 @@ HostDetector.prototype =</span>
<a href="#l16.331"></a><span id="l16.331">     this._cancel = true;</span>
<a href="#l16.332"></a><span id="l16.332">     // We have to actively stop the network calls, as they may result in</span>
<a href="#l16.333"></a><span id="l16.333">     // callbacks e.g. to the cert handler. If the dialog is gone by the time</span>
<a href="#l16.334"></a><span id="l16.334">     // this happens, the javascript stack is horked.</span>
<a href="#l16.335"></a><span id="l16.335">     for (let i = 0; i &lt; this._hostsToTry.length; i++)</span>
<a href="#l16.336"></a><span id="l16.336">     {</span>
<a href="#l16.337"></a><span id="l16.337">       let thisTry = this._hostsToTry[i]; // {HostTry}</span>
<a href="#l16.338"></a><span id="l16.338">       if (thisTry.abortable)</span>
<a href="#l16.339"></a><span id="l16.339" class="difflineminus">-        thisTry.abortable.cancel();</span>
<a href="#l16.340"></a><span id="l16.340" class="difflineplus">+        thisTry.abortable.cancel(ex);</span>
<a href="#l16.341"></a><span id="l16.341">       thisTry.status = kFailed; // or don't set? Maybe we want to continue.</span>
<a href="#l16.342"></a><span id="l16.342">     }</span>
<a href="#l16.343"></a><span id="l16.343" class="difflineplus">+    if (ex instanceof CancelOthersException)</span>
<a href="#l16.344"></a><span id="l16.344" class="difflineplus">+      return;</span>
<a href="#l16.345"></a><span id="l16.345">     if (!ex)</span>
<a href="#l16.346"></a><span id="l16.346" class="difflineminus">-      ex = new UserCancelledException(); // TODO use CanceledException, after it was added to util.js (not fetchhttp.js) in bug 534588 or bug 549045.</span>
<a href="#l16.347"></a><span id="l16.347" class="difflineminus">-    if (!this._done) // success also calls cancel() - skip this in this case</span>
<a href="#l16.348"></a><span id="l16.348" class="difflineminus">-      this.mErrorCallback(ex);</span>
<a href="#l16.349"></a><span id="l16.349" class="difflineminus">-    this._done = true;</span>
<a href="#l16.350"></a><span id="l16.350" class="difflineplus">+      ex = new CancelledException();</span>
<a href="#l16.351"></a><span id="l16.351" class="difflineplus">+    this.mErrorCallback(ex);</span>
<a href="#l16.352"></a><span id="l16.352">   },</span>
<a href="#l16.353"></a><span id="l16.353"> </span>
<a href="#l16.354"></a><span id="l16.354">   /**</span>
<a href="#l16.355"></a><span id="l16.355">    * Start the detection</span>
<a href="#l16.356"></a><span id="l16.356">    *</span>
<a href="#l16.357"></a><span id="l16.357">    * @param domain {String} to be used as base for guessing.</span>
<a href="#l16.358"></a><span id="l16.358">    *     Should be a domain (e.g. yahoo.co.uk).</span>
<a href="#l16.359"></a><span id="l16.359">    *     If hostIsPrecise == true, it should be a full hostname</span>
<a href="#l16.360"></a><span id="l16.360" class="difflineat">@@ -580,27 +538,25 @@ HostDetector.prototype =</span>
<a href="#l16.361"></a><span id="l16.361">     if (successfulTry)</span>
<a href="#l16.362"></a><span id="l16.362">     {</span>
<a href="#l16.363"></a><span id="l16.363">       this._log.info(&quot;CHOOSING &quot; + successfulTry.hostname + &quot;:&quot; +</span>
<a href="#l16.364"></a><span id="l16.364">           successfulTry.port + &quot; &quot; +</span>
<a href="#l16.365"></a><span id="l16.365">           protocolToString(successfulTry.protocol) + &quot; auth methods [&quot; +</span>
<a href="#l16.366"></a><span id="l16.366">           successfulTry.authMethods.join(&quot;,&quot;) + &quot;] ssl &quot; + successfulTry.ssl +</span>
<a href="#l16.367"></a><span id="l16.367">           (successfulTry.selfSignedCert ? &quot; (selfSignedCert)&quot; : &quot;&quot;));</span>
<a href="#l16.368"></a><span id="l16.368">       this.mSuccessCallback(successfulTry);</span>
<a href="#l16.369"></a><span id="l16.369" class="difflineminus">-      this._done = true;</span>
<a href="#l16.370"></a><span id="l16.370" class="difflineminus">-      this.cancel();</span>
<a href="#l16.371"></a><span id="l16.371" class="difflineplus">+      this.cancel(new CancelOthersException());</span>
<a href="#l16.372"></a><span id="l16.372">     }</span>
<a href="#l16.373"></a><span id="l16.373">     else if (!unfinishedBusiness) // all failed</span>
<a href="#l16.374"></a><span id="l16.374">     {</span>
<a href="#l16.375"></a><span id="l16.375">       this._log.info(&quot;ran out of options&quot;);</span>
<a href="#l16.376"></a><span id="l16.376" class="difflineminus">-      var errorMsg =</span>
<a href="#l16.377"></a><span id="l16.377" class="difflineminus">-        getStringBundle(&quot;chrome://messenger/locale/accountCreationModel.properties&quot;)</span>
<a href="#l16.378"></a><span id="l16.378" class="difflineminus">-        .GetStringFromName(&quot;cannot_find_server.error&quot;);</span>
<a href="#l16.379"></a><span id="l16.379" class="difflineplus">+      var errorMsg = getStringBundle(</span>
<a href="#l16.380"></a><span id="l16.380" class="difflineplus">+          &quot;chrome://messenger/locale/accountCreationModel.properties&quot;)</span>
<a href="#l16.381"></a><span id="l16.381" class="difflineplus">+          .GetStringFromName(&quot;cannot_find_server.error&quot;);</span>
<a href="#l16.382"></a><span id="l16.382">       this.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l16.383"></a><span id="l16.383" class="difflineminus">-      this._done = true;</span>
<a href="#l16.384"></a><span id="l16.384">       // no need to cancel, all failed</span>
<a href="#l16.385"></a><span id="l16.385">     }</span>
<a href="#l16.386"></a><span id="l16.386">     // else let ongoing calls continue</span>
<a href="#l16.387"></a><span id="l16.387">   },</span>
<a href="#l16.388"></a><span id="l16.388"> </span>
<a href="#l16.389"></a><span id="l16.389"> </span>
<a href="#l16.390"></a><span id="l16.390">   /**</span>
<a href="#l16.391"></a><span id="l16.391">    * Which auth mechanism the server claims to support.</span>
<a href="#l16.392"></a><span id="l16.392" class="difflineat">@@ -930,17 +886,17 @@ function SSLErrorHandler(thisTry, logger</span>
<a href="#l16.393"></a><span id="l16.393">   this._try = thisTry;</span>
<a href="#l16.394"></a><span id="l16.394">   this._log = logger;</span>
<a href="#l16.395"></a><span id="l16.395">   this._gotCertError = false;</span>
<a href="#l16.396"></a><span id="l16.396"> }</span>
<a href="#l16.397"></a><span id="l16.397"> SSLErrorHandler.prototype =</span>
<a href="#l16.398"></a><span id="l16.398"> {</span>
<a href="#l16.399"></a><span id="l16.399">   processCertError : function(socketInfo, status, targetSite)</span>
<a href="#l16.400"></a><span id="l16.400">   {</span>
<a href="#l16.401"></a><span id="l16.401" class="difflineminus">-    this._log.warn(&quot;Got Cert error for &quot;+ targetSite);</span>
<a href="#l16.402"></a><span id="l16.402" class="difflineplus">+    this._log.error(&quot;Got Cert error for &quot;+ targetSite);</span>
<a href="#l16.403"></a><span id="l16.403"> </span>
<a href="#l16.404"></a><span id="l16.404">     if (!status)</span>
<a href="#l16.405"></a><span id="l16.405">       return true;</span>
<a href="#l16.406"></a><span id="l16.406"> </span>
<a href="#l16.407"></a><span id="l16.407">     let cert = status.QueryInterface(Ci.nsISSLStatus).serverCert;</span>
<a href="#l16.408"></a><span id="l16.408">     let flags = 0;</span>
<a href="#l16.409"></a><span id="l16.409"> </span>
<a href="#l16.410"></a><span id="l16.410">     let parts = targetSite.split(&quot;:&quot;);</span>
<a href="#l16.411"></a><span id="l16.411" class="difflineat">@@ -1137,17 +1093,17 @@ function SocketUtil(hostname, port, ssl,</span>
<a href="#l16.412"></a><span id="l16.412"> function SocketAbortable(transport)</span>
<a href="#l16.413"></a><span id="l16.413"> {</span>
<a href="#l16.414"></a><span id="l16.414">   Abortable.call(this);</span>
<a href="#l16.415"></a><span id="l16.415">   assert(transport instanceof Ci.nsITransport, &quot;need transport&quot;);</span>
<a href="#l16.416"></a><span id="l16.416">   this._transport = transport;</span>
<a href="#l16.417"></a><span id="l16.417"> }</span>
<a href="#l16.418"></a><span id="l16.418"> SocketAbortable.prototype =</span>
<a href="#l16.419"></a><span id="l16.419"> {</span>
<a href="#l16.420"></a><span id="l16.420" class="difflineminus">-  cancel : function()</span>
<a href="#l16.421"></a><span id="l16.421" class="difflineplus">+  cancel : function(ex)</span>
<a href="#l16.422"></a><span id="l16.422">   {</span>
<a href="#l16.423"></a><span id="l16.423">     try {</span>
<a href="#l16.424"></a><span id="l16.424">       this._transport.close(Components.results.NS_ERROR_ABORT);</span>
<a href="#l16.425"></a><span id="l16.425">     } catch (e) {</span>
<a href="#l16.426"></a><span id="l16.426">       ddump(&quot;canceling socket failed: &quot; + e);</span>
<a href="#l16.427"></a><span id="l16.427">     }</span>
<a href="#l16.428"></a><span id="l16.428">   }</span>
<a href="#l16.429"></a><span id="l16.429"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/readFromXML.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/readFromXML.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -103,19 +103,21 @@ function readFromXML(clientConfigXML)</span>
<a href="#l17.4"></a><span id="l17.4">         throw exception ? exception : &quot;need proper &lt;socketType&gt; in XML&quot;;</span>
<a href="#l17.5"></a><span id="l17.5">       exception = null;</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7">       for each (let iXauth in iX.authentication)</span>
<a href="#l17.8"></a><span id="l17.8">       {</span>
<a href="#l17.9"></a><span id="l17.9">         try {</span>
<a href="#l17.10"></a><span id="l17.10">           iO.auth = sanitize.translate(iXauth,</span>
<a href="#l17.11"></a><span id="l17.11">               { &quot;password-cleartext&quot; : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-                &quot;plain&quot; : Ci.nsMsgAuthMethod.passwordCleartext, // @deprecated, remove</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+                // @deprecated TODO remove</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+                &quot;plain&quot; : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l17.15"></a><span id="l17.15">                 &quot;password-encrypted&quot; : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-                &quot;secure&quot; : Ci.nsMsgAuthMethod.passwordEncrypted, // @deprecated, remove</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+                // @deprecated TODO remove</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+                &quot;secure&quot; : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l17.19"></a><span id="l17.19">                 &quot;GSSAPI&quot; : Ci.nsMsgAuthMethod.GSSAPI,</span>
<a href="#l17.20"></a><span id="l17.20">                 &quot;NTLM&quot; : Ci.nsMsgAuthMethod.NTLM });</span>
<a href="#l17.21"></a><span id="l17.21">           break; // take first that we support</span>
<a href="#l17.22"></a><span id="l17.22">         } catch (e) { exception = e; }</span>
<a href="#l17.23"></a><span id="l17.23">       }</span>
<a href="#l17.24"></a><span id="l17.24">       if (!iO.auth)</span>
<a href="#l17.25"></a><span id="l17.25">         throw exception ? exception : &quot;need proper &lt;authentication&gt; in XML&quot;;</span>
<a href="#l17.26"></a><span id="l17.26">       exception = null;</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineat">@@ -174,25 +176,31 @@ function readFromXML(clientConfigXML)</span>
<a href="#l17.28"></a><span id="l17.28">       if (!oO.socketType)</span>
<a href="#l17.29"></a><span id="l17.29">         throw exception ? exception : &quot;need proper &lt;socketType&gt; in XML&quot;;</span>
<a href="#l17.30"></a><span id="l17.30">       exception = null;</span>
<a href="#l17.31"></a><span id="l17.31"> </span>
<a href="#l17.32"></a><span id="l17.32">       for each (let oXauth in oX.authentication)</span>
<a href="#l17.33"></a><span id="l17.33">       {</span>
<a href="#l17.34"></a><span id="l17.34">         try {</span>
<a href="#l17.35"></a><span id="l17.35">           oO.auth = sanitize.translate(oXauth,</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-              { &quot;none&quot; : Ci.nsMsgAuthMethod.none, // open relay</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-                &quot;client-IP-address&quot; : Ci.nsMsgAuthMethod.none, // inside ISP or corp network</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-                &quot;smtp-after-pop&quot; : Ci.nsMsgAuthMethod.none, // hope for the best</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+              { // open relay</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+                &quot;none&quot; : Ci.nsMsgAuthMethod.none,</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+                // inside ISP or corp network</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+                &quot;client-IP-address&quot; : Ci.nsMsgAuthMethod.none,</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+                // hope for the best</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+                &quot;smtp-after-pop&quot; : Ci.nsMsgAuthMethod.none,</span>
<a href="#l17.45"></a><span id="l17.45">                 &quot;password-cleartext&quot; : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-                &quot;plain&quot; : Ci.nsMsgAuthMethod.passwordCleartext, // @deprecated, remove</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+                // @deprecated TODO remove</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+                &quot;plain&quot; : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l17.49"></a><span id="l17.49">                 &quot;password-encrypted&quot; : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-                &quot;secure&quot; : Ci.nsMsgAuthMethod.passwordEncrypted, // @deprecated, remove</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+                // @deprecated TODO remove</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+                &quot;secure&quot; : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l17.53"></a><span id="l17.53">                 &quot;GSSAPI&quot; : Ci.nsMsgAuthMethod.GSSAPI,</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-                &quot;NTLM&quot; : Ci.nsMsgAuthMethod.NTLM });</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+                &quot;NTLM&quot; : Ci.nsMsgAuthMethod.NTLM,</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+              });</span>
<a href="#l17.57"></a><span id="l17.57">           break; // take first that we support</span>
<a href="#l17.58"></a><span id="l17.58">         } catch (e) { exception = e; }</span>
<a href="#l17.59"></a><span id="l17.59">       }</span>
<a href="#l17.60"></a><span id="l17.60">       if (!oO.auth)</span>
<a href="#l17.61"></a><span id="l17.61">         throw exception ? exception : &quot;need proper &lt;authentication&gt; in XML&quot;;</span>
<a href="#l17.62"></a><span id="l17.62">       exception = null;</span>
<a href="#l17.63"></a><span id="l17.63"> </span>
<a href="#l17.64"></a><span id="l17.64">       if (&quot;username&quot; in oX ||</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/sanitizeDatatypes.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/sanitizeDatatypes.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -47,21 +47,21 @@</span>
<a href="#l18.4"></a><span id="l18.4">  * the expected datatype in JS types. If the value is not as expected,</span>
<a href="#l18.5"></a><span id="l18.5">  * they throw exceptions.</span>
<a href="#l18.6"></a><span id="l18.6">  */</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8"> var sanitize =</span>
<a href="#l18.9"></a><span id="l18.9"> {</span>
<a href="#l18.10"></a><span id="l18.10">   integer : function(unchecked)</span>
<a href="#l18.11"></a><span id="l18.11">   {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-    if (typeof(unchecked) == &quot;number&quot;)</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+    if (typeof(unchecked) == &quot;number&quot; &amp;&amp; !isNaN(unchecked))</span>
<a href="#l18.14"></a><span id="l18.14">       return unchecked;</span>
<a href="#l18.15"></a><span id="l18.15"> </span>
<a href="#l18.16"></a><span id="l18.16">     var r = parseInt(unchecked);</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-    if (r == NaN)</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+    if (isNaN(r))</span>
<a href="#l18.19"></a><span id="l18.19">       throw new MalformedException(&quot;no_number.error&quot;, unchecked);</span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21">     return r;</span>
<a href="#l18.22"></a><span id="l18.22">   },</span>
<a href="#l18.23"></a><span id="l18.23"> </span>
<a href="#l18.24"></a><span id="l18.24">   integerRange : function(unchecked, min, max)</span>
<a href="#l18.25"></a><span id="l18.25">   {</span>
<a href="#l18.26"></a><span id="l18.26">     var int = this.integer(unchecked);</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineat">@@ -185,17 +185,16 @@ var sanitize =</span>
<a href="#l18.28"></a><span id="l18.28">     {</span>
<a href="#l18.29"></a><span id="l18.29">       if (allowedValue == unchecked)</span>
<a href="#l18.30"></a><span id="l18.30">         return allowedValue;</span>
<a href="#l18.31"></a><span id="l18.31">     }</span>
<a href="#l18.32"></a><span id="l18.32">     // value is bad</span>
<a href="#l18.33"></a><span id="l18.33">     var e = new MalformedException(&quot;allowed_value.error&quot;, unchecked);</span>
<a href="#l18.34"></a><span id="l18.34">     if (typeof(defaultValue) == &quot;undefined&quot;)</span>
<a href="#l18.35"></a><span id="l18.35">       throw e;</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-    logException(e);</span>
<a href="#l18.37"></a><span id="l18.37">     return defaultValue;</span>
<a href="#l18.38"></a><span id="l18.38">   },</span>
<a href="#l18.39"></a><span id="l18.39"> </span>
<a href="#l18.40"></a><span id="l18.40">   /**</span>
<a href="#l18.41"></a><span id="l18.41">    * Like enum, allows only certain (string) values as input, but allows the</span>
<a href="#l18.42"></a><span id="l18.42">    * caller to specify another value to return instead of the input value. E.g.,</span>
<a href="#l18.43"></a><span id="l18.43">    * if unchecked == &quot;foo&quot;, return 1, if unchecked == &quot;bar&quot;, return 2,</span>
<a href="#l18.44"></a><span id="l18.44">    * otherwise throw. This allows to translate string enums into integer enums.</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineat">@@ -217,17 +216,16 @@ var sanitize =</span>
<a href="#l18.46"></a><span id="l18.46">     {</span>
<a href="#l18.47"></a><span id="l18.47">       if (inputValue == unchecked)</span>
<a href="#l18.48"></a><span id="l18.48">         return mapping[inputValue];</span>
<a href="#l18.49"></a><span id="l18.49">     }</span>
<a href="#l18.50"></a><span id="l18.50">     // value is bad</span>
<a href="#l18.51"></a><span id="l18.51">     var e = new MalformedException(&quot;allowed_value.error&quot;, unchecked);</span>
<a href="#l18.52"></a><span id="l18.52">     if (typeof(defaultValue) == &quot;undefined&quot;)</span>
<a href="#l18.53"></a><span id="l18.53">       throw e;</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-    logException(e);</span>
<a href="#l18.55"></a><span id="l18.55">     return defaultValue;</span>
<a href="#l18.56"></a><span id="l18.56">   }</span>
<a href="#l18.57"></a><span id="l18.57"> };</span>
<a href="#l18.58"></a><span id="l18.58"> </span>
<a href="#l18.59"></a><span id="l18.59"> function MalformedException(msgID, uncheckedBadValue)</span>
<a href="#l18.60"></a><span id="l18.60"> {</span>
<a href="#l18.61"></a><span id="l18.61">   var stringBundle = getStringBundle(</span>
<a href="#l18.62"></a><span id="l18.62">       &quot;chrome://messenger/locale/accountCreationUtil.properties&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/util.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/util.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -55,17 +55,26 @@ Cu.import(&quot;resource:///modules/errUtils.</span>
<a href="#l19.4"></a><span id="l19.4"> function extend(child, supertype)</span>
<a href="#l19.5"></a><span id="l19.5"> {</span>
<a href="#l19.6"></a><span id="l19.6">   child.prototype.__proto__ = supertype.prototype;</span>
<a href="#l19.7"></a><span id="l19.7"> }</span>
<a href="#l19.8"></a><span id="l19.8"> </span>
<a href="#l19.9"></a><span id="l19.9"> function assert(test, errorMsg)</span>
<a href="#l19.10"></a><span id="l19.10"> {</span>
<a href="#l19.11"></a><span id="l19.11">   if (!test)</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-    throw new NotReached(errorMsg);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+    throw new NotReached(errorMsg ? errorMsg :</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+          &quot;Programming bug. Assertion failed, see log.&quot;);</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+}</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+function makeCallback(obj, func)</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+{</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+  return function()</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+  {</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+    return func.apply(obj, arguments);</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+  }</span>
<a href="#l19.23"></a><span id="l19.23"> }</span>
<a href="#l19.24"></a><span id="l19.24"> </span>
<a href="#l19.25"></a><span id="l19.25"> </span>
<a href="#l19.26"></a><span id="l19.26"> /**</span>
<a href="#l19.27"></a><span id="l19.27">  * Runs the given function sometime later</span>
<a href="#l19.28"></a><span id="l19.28">  *</span>
<a href="#l19.29"></a><span id="l19.29">  * Currently implemented using setTimeout(), but</span>
<a href="#l19.30"></a><span id="l19.30">  * can later be replaced with an nsITimer impl,</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineat">@@ -160,17 +169,18 @@ var _gIOServiceCached;</span>
<a href="#l19.32"></a><span id="l19.32">  */</span>
<a href="#l19.33"></a><span id="l19.33"> function getStringBundle(bundleURI)</span>
<a href="#l19.34"></a><span id="l19.34"> {</span>
<a href="#l19.35"></a><span id="l19.35">   try {</span>
<a href="#l19.36"></a><span id="l19.36">     return Cc[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l19.37"></a><span id="l19.37">            .getService(Ci.nsIStringBundleService)</span>
<a href="#l19.38"></a><span id="l19.38">            .createBundle(bundleURI);</span>
<a href="#l19.39"></a><span id="l19.39">   } catch (e) {</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-    throw new Exception(&quot;Failed to get stringbundle URI &lt;&quot; + bundleURI + &quot;&gt;. Error: &quot; + e);</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+    throw new Exception(&quot;Failed to get stringbundle URI &lt;&quot; + bundleURI +</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+                        &quot;&gt;. Error: &quot; + e);</span>
<a href="#l19.43"></a><span id="l19.43">   }</span>
<a href="#l19.44"></a><span id="l19.44"> }</span>
<a href="#l19.45"></a><span id="l19.45"> </span>
<a href="#l19.46"></a><span id="l19.46"> </span>
<a href="#l19.47"></a><span id="l19.47"> function Exception(msg)</span>
<a href="#l19.48"></a><span id="l19.48"> {</span>
<a href="#l19.49"></a><span id="l19.49">   this._message = msg;</span>
<a href="#l19.50"></a><span id="l19.50"> </span>
<a href="#l19.51"></a><span id="l19.51" class="difflineat">@@ -191,16 +201,17 @@ Exception.prototype =</span>
<a href="#l19.52"></a><span id="l19.52">   {</span>
<a href="#l19.53"></a><span id="l19.53">     return this._message;</span>
<a href="#l19.54"></a><span id="l19.54">   }</span>
<a href="#l19.55"></a><span id="l19.55"> }</span>
<a href="#l19.56"></a><span id="l19.56"> </span>
<a href="#l19.57"></a><span id="l19.57"> function NotReached(msg)</span>
<a href="#l19.58"></a><span id="l19.58"> {</span>
<a href="#l19.59"></a><span id="l19.59">   Exception.call(this, msg);</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+  logException(this);</span>
<a href="#l19.61"></a><span id="l19.61"> }</span>
<a href="#l19.62"></a><span id="l19.62"> extend(NotReached, Exception);</span>
<a href="#l19.63"></a><span id="l19.63"> </span>
<a href="#l19.64"></a><span id="l19.64"> </span>
<a href="#l19.65"></a><span id="l19.65"> /**</span>
<a href="#l19.66"></a><span id="l19.66">  * A handle for an async function which you can cancel.</span>
<a href="#l19.67"></a><span id="l19.67">  * The async function will return an object of this type (a subtype)</span>
<a href="#l19.68"></a><span id="l19.68">  * and you can call cancel() when you feel like killing the function.</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineat">@@ -247,17 +258,18 @@ IntervalAbortable.prototype =</span>
<a href="#l19.70"></a><span id="l19.70">   cancel : function()</span>
<a href="#l19.71"></a><span id="l19.71">   {</span>
<a href="#l19.72"></a><span id="l19.72">     clearInterval(this._id);</span>
<a href="#l19.73"></a><span id="l19.73">   }</span>
<a href="#l19.74"></a><span id="l19.74"> }</span>
<a href="#l19.75"></a><span id="l19.75"> extend(IntervalAbortable, Abortable);</span>
<a href="#l19.76"></a><span id="l19.76"> </span>
<a href="#l19.77"></a><span id="l19.77"> </span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-// Allows you to make several network calls, but return only one Abortable object.</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+// Allows you to make several network calls, but return</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+// only one Abortable object.</span>
<a href="#l19.81"></a><span id="l19.81"> function SuccessiveAbortable()</span>
<a href="#l19.82"></a><span id="l19.82"> {</span>
<a href="#l19.83"></a><span id="l19.83">   this._current = null;</span>
<a href="#l19.84"></a><span id="l19.84"> }</span>
<a href="#l19.85"></a><span id="l19.85"> SuccessiveAbortable.prototype =</span>
<a href="#l19.86"></a><span id="l19.86"> {</span>
<a href="#l19.87"></a><span id="l19.87">   set current(abortable)</span>
<a href="#l19.88"></a><span id="l19.88">   {</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineat">@@ -306,47 +318,51 @@ function deepCopy(org)</span>
<a href="#l19.90"></a><span id="l19.90"> }</span>
<a href="#l19.91"></a><span id="l19.91"> </span>
<a href="#l19.92"></a><span id="l19.92"> let kDebug = false;</span>
<a href="#l19.93"></a><span id="l19.93"> function ddump(text)</span>
<a href="#l19.94"></a><span id="l19.94"> {</span>
<a href="#l19.95"></a><span id="l19.95">   if (kDebug)</span>
<a href="#l19.96"></a><span id="l19.96">     dump(text + &quot;\n&quot;);</span>
<a href="#l19.97"></a><span id="l19.97"> }</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineminus">-function ddumpObject(obj, name, maxDepth, curDepth)</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineplus">+</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+function debugObject(obj, name, maxDepth, curDepth)</span>
<a href="#l19.101"></a><span id="l19.101"> {</span>
<a href="#l19.102"></a><span id="l19.102">   if (curDepth == undefined)</span>
<a href="#l19.103"></a><span id="l19.103">     curDepth = 0;</span>
<a href="#l19.104"></a><span id="l19.104">   if (maxDepth != undefined &amp;&amp; curDepth &gt; maxDepth)</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineminus">-    return;</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l19.107"></a><span id="l19.107"> </span>
<a href="#l19.108"></a><span id="l19.108" class="difflineplus">+  var result = &quot;&quot;;</span>
<a href="#l19.109"></a><span id="l19.109">   var i = 0;</span>
<a href="#l19.110"></a><span id="l19.110">   for (let prop in obj)</span>
<a href="#l19.111"></a><span id="l19.111">   {</span>
<a href="#l19.112"></a><span id="l19.112">     i++;</span>
<a href="#l19.113"></a><span id="l19.113">     try {</span>
<a href="#l19.114"></a><span id="l19.114">       if (typeof(obj[prop]) == &quot;object&quot;)</span>
<a href="#l19.115"></a><span id="l19.115">       {</span>
<a href="#l19.116"></a><span id="l19.116">         if (obj[prop] &amp;&amp; obj[prop].length != undefined)</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineminus">-          ddump(name + &quot;.&quot; + prop + &quot;=[probably array, length &quot; +</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineminus">-                obj[prop].length + &quot;]&quot;);</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineplus">+          result += name + &quot;.&quot; + prop + &quot;=[probably array, length &quot; +</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineplus">+                obj[prop].length + &quot;]\n&quot;;</span>
<a href="#l19.121"></a><span id="l19.121">         else</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineminus">-          ddump(name + &quot;.&quot; + prop + &quot;=[&quot; + typeof(obj[prop]) + &quot;]&quot;);</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineminus">-        ddumpObject(obj[prop], name + &quot;.&quot; + prop, maxDepth, curDepth+1);</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineplus">+          result += name + &quot;.&quot; + prop + &quot;=[&quot; + typeof(obj[prop]) + &quot;]\n&quot;;</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineplus">+        result += debugObject(obj[prop], name + &quot;.&quot; + prop,</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineplus">+                              maxDepth, curDepth + 1);</span>
<a href="#l19.127"></a><span id="l19.127">       }</span>
<a href="#l19.128"></a><span id="l19.128">       else if (typeof(obj[prop]) == &quot;function&quot;)</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineminus">-        ddump(name + &quot;.&quot; + prop + &quot;=[function]&quot;);</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineplus">+        result += name + &quot;.&quot; + prop + &quot;=[function]\n&quot;;</span>
<a href="#l19.131"></a><span id="l19.131">       else</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineminus">-        ddump(name + &quot;.&quot; + prop + &quot;=&quot; + obj[prop]);</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineplus">+        result += name + &quot;.&quot; + prop + &quot;=&quot; + obj[prop] + &quot;\n&quot;;</span>
<a href="#l19.134"></a><span id="l19.134">     } catch (e) {</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineminus">-      ddump(name + &quot;.&quot; + prop + &quot;-&gt; Exception(&quot; + e + &quot;)&quot;);</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineplus">+      result += name + &quot;.&quot; + prop + &quot;-&gt; Exception(&quot; + e + &quot;)\n&quot;;</span>
<a href="#l19.137"></a><span id="l19.137">     }</span>
<a href="#l19.138"></a><span id="l19.138">   }</span>
<a href="#l19.139"></a><span id="l19.139">   if (!i)</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineminus">-    ddump(name + &quot; is empty&quot;);</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineplus">+    result += name + &quot; is empty\n&quot;;</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineplus">+  return result;</span>
<a href="#l19.143"></a><span id="l19.143"> }</span>
<a href="#l19.144"></a><span id="l19.144"> </span>
<a href="#l19.145"></a><span id="l19.145"> function alertPrompt(alertTitle, alertMsg)</span>
<a href="#l19.146"></a><span id="l19.146"> {</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineminus">-  Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineminus">-                    .getService(Components.interfaces.nsIPromptService)</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineminus">-                    .alert(window, alertTitle, alertMsg);</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineplus">+  Cc[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineplus">+      .getService(Ci.nsIPromptService)</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineplus">+      .alert(window, alertTitle, alertMsg);</span>
<a href="#l19.153"></a><span id="l19.153"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/verifyConfig.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/verifyConfig.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -36,16 +36,20 @@</span>
<a href="#l20.4"></a><span id="l20.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l20.5"></a><span id="l20.5">  *</span>
<a href="#l20.6"></a><span id="l20.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8"> /**</span>
<a href="#l20.9"></a><span id="l20.9">  * This checks a given config, by trying a real connection and login,</span>
<a href="#l20.10"></a><span id="l20.10">  * with username and password.</span>
<a href="#l20.11"></a><span id="l20.11">  *</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+ * TODO</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+ * - give specific errors, bug 555448</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+ * - return a working |Abortable| to allow cancel</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+ *</span>
<a href="#l20.16"></a><span id="l20.16">  * @param accountConfig {AccountConfig} The guessed account config.</span>
<a href="#l20.17"></a><span id="l20.17">  *    username, password, realname, emailaddress etc. are not filled out,</span>
<a href="#l20.18"></a><span id="l20.18">  *    but placeholders to be filled out via replaceVariables().</span>
<a href="#l20.19"></a><span id="l20.19">  * @param alter {boolean}</span>
<a href="#l20.20"></a><span id="l20.20">  *    Try other usernames and login schemes, until login works.</span>
<a href="#l20.21"></a><span id="l20.21">  *    Warning: Modifies |accountConfig|.</span>
<a href="#l20.22"></a><span id="l20.22">  *</span>
<a href="#l20.23"></a><span id="l20.23">  * This function is async.</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineat">@@ -55,38 +59,39 @@</span>
<a href="#l20.25"></a><span id="l20.25">  * @param errorCallback function(ex)</span>
<a href="#l20.26"></a><span id="l20.26">  *   Called when we could guess not the config, either</span>
<a href="#l20.27"></a><span id="l20.27">  *   because we have not found anything or</span>
<a href="#l20.28"></a><span id="l20.28">  *   because there was an error (e.g. no network connection).</span>
<a href="#l20.29"></a><span id="l20.29">  *   The ex.message will contain a user-presentable message.</span>
<a href="#l20.30"></a><span id="l20.30">  */</span>
<a href="#l20.31"></a><span id="l20.31"> function verifyConfig(config, alter, msgWindow, successCallback, errorCallback)</span>
<a href="#l20.32"></a><span id="l20.32"> {</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-  ddumpObject(config, &quot;config&quot;, 3);</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-  assert(config instanceof AccountConfig, &quot;BUG: Arg 'config' needs to be an AccountConfig object&quot;);</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-  assert(typeof(alter) == &quot;boolean&quot;, &quot;BUG: Bad arg 'alter'&quot;);</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-  assert(typeof(successCallback) == &quot;function&quot;, &quot;BUG: 'successCallback' is not a function&quot;);</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-  assert(typeof(errorCallback) == &quot;function&quot;, &quot;BUG: 'errorCallback' is not a function&quot;);</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+  ddump(debugObject(config, &quot;config&quot;, 3));</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+  assert(config instanceof AccountConfig,</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+         &quot;BUG: Arg 'config' needs to be an AccountConfig object&quot;);</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+  assert(typeof(alter) == &quot;boolean&quot;);</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+  assert(typeof(successCallback) == &quot;function&quot;);</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+  assert(typeof(errorCallback) == &quot;function&quot;);</span>
<a href="#l20.44"></a><span id="l20.44"> </span>
<a href="#l20.45"></a><span id="l20.45">   var accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l20.46"></a><span id="l20.46">                        .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l20.47"></a><span id="l20.47"> </span>
<a href="#l20.48"></a><span id="l20.48">   if (accountManager.findRealServer(config.incoming.username,</span>
<a href="#l20.49"></a><span id="l20.49">                                     config.incoming.hostname,</span>
<a href="#l20.50"></a><span id="l20.50">                                     sanitize.enum(config.incoming.type,</span>
<a href="#l20.51"></a><span id="l20.51">                                                   [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]),</span>
<a href="#l20.52"></a><span id="l20.52">                                     config.incoming.port))</span>
<a href="#l20.53"></a><span id="l20.53">     return errorCallback(&quot;Incoming server exists&quot;);</span>
<a href="#l20.54"></a><span id="l20.54"> </span>
<a href="#l20.55"></a><span id="l20.55">   // incoming server</span>
<a href="#l20.56"></a><span id="l20.56">   var inServer =</span>
<a href="#l20.57"></a><span id="l20.57">     accountManager.createIncomingServer(config.incoming.username,</span>
<a href="#l20.58"></a><span id="l20.58">                                         config.incoming.hostname,</span>
<a href="#l20.59"></a><span id="l20.59">                                         sanitize.enum(config.incoming.type,</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-                                                      [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]));</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+                                                    [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]));</span>
<a href="#l20.62"></a><span id="l20.62">   inServer.port = config.incoming.port;</span>
<a href="#l20.63"></a><span id="l20.63">   inServer.password = config.incoming.password;</span>
<a href="#l20.64"></a><span id="l20.64">   if (config.incoming.socketType == 1) // plain</span>
<a href="#l20.65"></a><span id="l20.65">     inServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l20.66"></a><span id="l20.66">   else if (config.incoming.socketType == 2) // SSL</span>
<a href="#l20.67"></a><span id="l20.67">     inServer.socketType = Ci.nsMsgSocketType.SSL;</span>
<a href="#l20.68"></a><span id="l20.68">   else if (config.incoming.socketType == 3) // STARTTLS</span>
<a href="#l20.69"></a><span id="l20.69">     inServer.socketType = Ci.nsMsgSocketType.alwaysSTARTTLS;</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineat">@@ -160,28 +165,29 @@ urlListener.prototype =</span>
<a href="#l20.71"></a><span id="l20.71">                           this.mConfig.identity.emailAddress) +</span>
<a href="#l20.72"></a><span id="l20.72">                           &quot;, have savedUsername=&quot; +</span>
<a href="#l20.73"></a><span id="l20.73">                           (this.mConfig.usernameSaved ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l20.74"></a><span id="l20.74">     this._log.info(&quot;  authMethod=&quot; + this.mServer.authMethod);</span>
<a href="#l20.75"></a><span id="l20.75">   },</span>
<a href="#l20.76"></a><span id="l20.76"> </span>
<a href="#l20.77"></a><span id="l20.77">   OnStopRunningUrl: function(aUrl, aExitCode)</span>
<a href="#l20.78"></a><span id="l20.78">   {</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-    this._log.info(&quot;Finished testing &quot; + aUrl + &quot; resulted in &quot; + aExitCode);</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+    this._log.info(&quot;Finished verifyConfig resulted in &quot; + aExitCode);</span>
<a href="#l20.81"></a><span id="l20.81">     if (Components.isSuccessCode(aExitCode))</span>
<a href="#l20.82"></a><span id="l20.82">     {</span>
<a href="#l20.83"></a><span id="l20.83">       this._cleanup();</span>
<a href="#l20.84"></a><span id="l20.84">       this.mSuccessCallback(this.mConfig);</span>
<a href="#l20.85"></a><span id="l20.85">     }</span>
<a href="#l20.86"></a><span id="l20.86">     // Logon failed, and we aren't supposed to try other variations.</span>
<a href="#l20.87"></a><span id="l20.87">     else if (!this.mAlter)</span>
<a href="#l20.88"></a><span id="l20.88">     {</span>
<a href="#l20.89"></a><span id="l20.89">       this._cleanup();</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineminus">-      var stringBundle = getStringBundle(&quot;chrome://messenger/locale/accountCreationModel.properties&quot;);</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineminus">-      var errorMsg = stringBundle.GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineplus">+      var errorMsg = getStringBundle(</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineplus">+          &quot;chrome://messenger/locale/accountCreationModel.properties&quot;)</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineplus">+          .GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l20.95"></a><span id="l20.95">       this.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l20.96"></a><span id="l20.96">     }</span>
<a href="#l20.97"></a><span id="l20.97">     // Try other variations, unless there's a cert error, in which</span>
<a href="#l20.98"></a><span id="l20.98">     // case we'll see what the user chooses.</span>
<a href="#l20.99"></a><span id="l20.99">     else if (!this.mCertError)</span>
<a href="#l20.100"></a><span id="l20.100">     {</span>
<a href="#l20.101"></a><span id="l20.101">       this.tryNextLogon()</span>
<a href="#l20.102"></a><span id="l20.102">     }</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineat">@@ -224,24 +230,24 @@ urlListener.prototype =</span>
<a href="#l20.104"></a><span id="l20.104">     // sec auth seems to have failed, and we've tried both</span>
<a href="#l20.105"></a><span id="l20.105">     // varieties of user name, sadly.</span>
<a href="#l20.106"></a><span id="l20.106">     // So fall back to non-secure auth, and</span>
<a href="#l20.107"></a><span id="l20.107">     // again try the user name and email address as username</span>
<a href="#l20.108"></a><span id="l20.108">     assert(this.mConfig.incoming.auth == this.mServer.authMethod);</span>
<a href="#l20.109"></a><span id="l20.109">     this._log.info(&quot;  Using SSL: &quot; +</span>
<a href="#l20.110"></a><span id="l20.110">         (this.mServer.socketType == Ci.nsMsgSocketType.SSL ||</span>
<a href="#l20.111"></a><span id="l20.111">          this.mServer.socketType == Ci.nsMsgSocketType.alwaysSTARTTLS));</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineminus">-    this._log.info(&quot;  auth alternatives = &quot; +</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineminus">-        this.mConfig.incoming.authAlternatives.join(&quot;,&quot;));</span>
<a href="#l20.114"></a><span id="l20.114">     if (this.mConfig.incoming.authAlternatives &amp;&amp;</span>
<a href="#l20.115"></a><span id="l20.115">         this.mConfig.incoming.authAlternatives.length)</span>
<a href="#l20.116"></a><span id="l20.116">         // We may be dropping back to insecure auth methods here,</span>
<a href="#l20.117"></a><span id="l20.117">         // which is not good. But then again, we already warned the user,</span>
<a href="#l20.118"></a><span id="l20.118">         // if it is a config without SSL.</span>
<a href="#l20.119"></a><span id="l20.119">     {</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineplus">+      this._log.info(&quot;  auth alternatives = &quot; +</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineplus">+          this.mConfig.incoming.authAlternatives.join(&quot;,&quot;));</span>
<a href="#l20.122"></a><span id="l20.122">       this._log.info(&quot;  Decreasing auth.&quot;);</span>
<a href="#l20.123"></a><span id="l20.123">       this._log.info(&quot;  Have password: &quot; +</span>
<a href="#l20.124"></a><span id="l20.124">                      (this.mServer.password ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l20.125"></a><span id="l20.125">       let brokenAuth = this.mConfig.incoming.auth;</span>
<a href="#l20.126"></a><span id="l20.126">       // take the next best method (compare chooseBestAuthMethod() in guess)</span>
<a href="#l20.127"></a><span id="l20.127">       this.mConfig.incoming.auth =</span>
<a href="#l20.128"></a><span id="l20.128">           this.mConfig.incoming.authAlternatives.shift();</span>
<a href="#l20.129"></a><span id="l20.129">       this.mServer.authMethod = this.mConfig.incoming.auth;</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineat">@@ -256,63 +262,73 @@ urlListener.prototype =</span>
<a href="#l20.131"></a><span id="l20.131">       verifyLogon(this.mConfig, this.mServer, this.mAlter, this.mMsgWindow,</span>
<a href="#l20.132"></a><span id="l20.132">                   this.mSuccessCallback, this.mErrorCallback);</span>
<a href="#l20.133"></a><span id="l20.133">       return;</span>
<a href="#l20.134"></a><span id="l20.134">     }</span>
<a href="#l20.135"></a><span id="l20.135"> </span>
<a href="#l20.136"></a><span id="l20.136">     // Tried all variations we can. Give up.</span>
<a href="#l20.137"></a><span id="l20.137">     this._log.info(&quot;Giving up.&quot;);</span>
<a href="#l20.138"></a><span id="l20.138">     this._cleanup();</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineminus">-    let stringBundle = getStringBundle(&quot;chrome://messenger/locale/accountCreationModel.properties&quot;);</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineminus">-    let errorMsg = stringBundle.GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineplus">+    let errorMsg = getStringBundle(</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineplus">+        &quot;chrome://messenger/locale/accountCreationModel.properties&quot;)</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineplus">+        .GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l20.144"></a><span id="l20.144">     this.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l20.145"></a><span id="l20.145">     return;</span>
<a href="#l20.146"></a><span id="l20.146">   },</span>
<a href="#l20.147"></a><span id="l20.147"> </span>
<a href="#l20.148"></a><span id="l20.148">   _cleanup : function()</span>
<a href="#l20.149"></a><span id="l20.149">   {</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineminus">-    // Avoid pref pollution, clear out server prefs.</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineminus">-    if (this.mServer) {</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineminus">-      Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineminus">-      .getService(Ci.nsIMsgAccountManager)</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineminus">-      .removeIncomingServer(this.mServer, true);</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineminus">-</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineminus">-      this.mServer = null;</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineminus">-    }</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineplus">+    try {</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineplus">+      // Avoid pref pollution, clear out server prefs.</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineplus">+      if (this.mServer) {</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineplus">+        Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineplus">+          .getService(Ci.nsIMsgAccountManager)</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineplus">+          .removeIncomingServer(this.mServer, true);</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineplus">+        this.mServer = null;</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineplus">+      }</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineplus">+    } catch (e) { this._log.error(e); }</span>
<a href="#l20.167"></a><span id="l20.167">   },</span>
<a href="#l20.168"></a><span id="l20.168"> </span>
<a href="#l20.169"></a><span id="l20.169">   // Suppress any certificate errors</span>
<a href="#l20.170"></a><span id="l20.170">   notifyCertProblem: function(socketInfo, status, targetSite) {</span>
<a href="#l20.171"></a><span id="l20.171">     if (!status)</span>
<a href="#l20.172"></a><span id="l20.172">       return true;</span>
<a href="#l20.173"></a><span id="l20.173"> </span>
<a href="#l20.174"></a><span id="l20.174">     this.mCertError = true;</span>
<a href="#l20.175"></a><span id="l20.175">     this._log.error(&quot;cert error&quot;);</span>
<a href="#l20.176"></a><span id="l20.176" class="difflineminus">-    setTimeout(this.informUserOfCertError, 0, socketInfo, targetSite, this);</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineplus">+    var me = this;</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineplus">+    setTimeout(function () {</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineplus">+      try {</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineplus">+        me.informUserOfCertError(socketInfo, targetSite);</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineplus">+      } catch (e)  { logException(e); }</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineplus">+    }, 0);</span>
<a href="#l20.183"></a><span id="l20.183">     return true;</span>
<a href="#l20.184"></a><span id="l20.184">   },</span>
<a href="#l20.185"></a><span id="l20.185"> </span>
<a href="#l20.186"></a><span id="l20.186" class="difflineminus">-  informUserOfCertError : function(socketInfo, targetSite, self) {</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineminus">-    let params = { exceptionAdded : false };</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineminus">-    params.prefetchCert = true;</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineminus">-    params.location = targetSite;</span>
<a href="#l20.190"></a><span id="l20.190" class="difflineplus">+  informUserOfCertError : function(socketInfo, targetSite) {</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineplus">+    var params = {</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineplus">+      exceptionAdded : false,</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineplus">+      prefetchCert : true,</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineplus">+      location : targetSite,</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineplus">+    };</span>
<a href="#l20.196"></a><span id="l20.196">     window.openDialog(&quot;chrome://pippki/content/exceptionDialog.xul&quot;,</span>
<a href="#l20.197"></a><span id="l20.197">                       &quot;&quot;,&quot;chrome,centerscreen,modal&quot;, params);</span>
<a href="#l20.198"></a><span id="l20.198" class="difflineminus">-    self._log.info(&quot;cert exception dialog closed&quot;);</span>
<a href="#l20.199"></a><span id="l20.199" class="difflineminus">-    self._log.info(&quot;cert exceptionAdded = &quot; + params.exceptionAdded);</span>
<a href="#l20.200"></a><span id="l20.200" class="difflineplus">+    this._log.info(&quot;cert exception dialog closed&quot;);</span>
<a href="#l20.201"></a><span id="l20.201" class="difflineplus">+    this._log.info(&quot;cert exceptionAdded = &quot; + params.exceptionAdded);</span>
<a href="#l20.202"></a><span id="l20.202">     if (!params.exceptionAdded) {</span>
<a href="#l20.203"></a><span id="l20.203" class="difflineminus">-      self._cleanup();</span>
<a href="#l20.204"></a><span id="l20.204" class="difflineminus">-      let stringBundle = getStringBundle(&quot;chrome://messenger/locale/accountCreationModel.properties&quot;);</span>
<a href="#l20.205"></a><span id="l20.205" class="difflineminus">-      let errorMsg = stringBundle.GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l20.206"></a><span id="l20.206" class="difflineminus">-      self.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l20.207"></a><span id="l20.207" class="difflineplus">+      this._cleanup();</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineplus">+      let errorMsg = getStringBundle(</span>
<a href="#l20.209"></a><span id="l20.209" class="difflineplus">+          &quot;chrome://messenger/locale/accountCreationModel.properties&quot;)</span>
<a href="#l20.210"></a><span id="l20.210" class="difflineplus">+          .GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l20.211"></a><span id="l20.211" class="difflineplus">+      this.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l20.212"></a><span id="l20.212">     }</span>
<a href="#l20.213"></a><span id="l20.213">     else {</span>
<a href="#l20.214"></a><span id="l20.214">       // Retry the logon now that we've added the cert exception.</span>
<a href="#l20.215"></a><span id="l20.215" class="difflineminus">-      verifyLogon(self.mConfig, self.mServer, self.mAlter, self.mMsgWindow,</span>
<a href="#l20.216"></a><span id="l20.216" class="difflineminus">-                  self.mSuccessCallback, self.mErrorCallback);</span>
<a href="#l20.217"></a><span id="l20.217" class="difflineplus">+      verifyLogon(this.mConfig, this.mServer, this.mAlter, this.mMsgWindow,</span>
<a href="#l20.218"></a><span id="l20.218" class="difflineplus">+                  this.mSuccessCallback, this.mErrorCallback);</span>
<a href="#l20.219"></a><span id="l20.219">     }</span>
<a href="#l20.220"></a><span id="l20.220">   },</span>
<a href="#l20.221"></a><span id="l20.221"> </span>
<a href="#l20.222"></a><span id="l20.222">   // nsIInterfaceRequestor</span>
<a href="#l20.223"></a><span id="l20.223">   getInterface: function(iid) {</span>
<a href="#l20.224"></a><span id="l20.224">     return this.QueryInterface(iid);</span>
<a href="#l20.225"></a><span id="l20.225">   },</span>
<a href="#l20.226"></a><span id="l20.226"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

