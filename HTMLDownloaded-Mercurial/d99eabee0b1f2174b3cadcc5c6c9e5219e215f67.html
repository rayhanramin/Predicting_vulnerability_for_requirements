<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26393:d99eabee0b1f2174b3cadcc5c6c9e5219e215f67</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ d99eabee0b1f2174b3cadcc5c6c9e5219e215f67" />
<meta property="og:url" content="/comm-central/rev/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67" />
<meta property="og:description" content="Bug 1515877 - Turn on ESLint in mailnews/compose. r=aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / d99eabee0b1f2174b3cadcc5c6c9e5219e215f67 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67">shortlog</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67">files</a> |
changeset |
<a href="/comm-central/raw-rev/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67">raw</a>  | <a href="/comm-central/archive/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">Bug 1515877</a> - Turn on ESLint in mailnews/compose. r=aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 19 Apr 2019 14:52:59 +1200</td></tr>

<tr>
 <td>changeset 26393</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67">d99eabee0b1f2174b3cadcc5c6c9e5219e215f67</a></td>
</tr>



<tr>
<td>parent 26392</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5461dc8b55557676edd3ff9862c87e236f67eb64">5461dc8b55557676edd3ff9862c87e236f67eb64</a>
</td>
</tr>

<tr>
<td>child 26394</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f8a27eb022631ef4e106dd7cb0af077f1858ea24">f8a27eb022631ef4e106dd7cb0af077f1858ea24</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=d99eabee0b1f2174b3cadcc5c6c9e5219e215f67">15817</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 19 Apr 2019 17:02:40 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@d99eabee0b1f [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d99eabee0b1f2174b3cadcc5c6c9e5219e215f67">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d99eabee0b1f2174b3cadcc5c6c9e5219e215f67&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d99eabee0b1f2174b3cadcc5c6c9e5219e215f67&newProject=comm-central&newRevision=d99eabee0b1f2174b3cadcc5c6c9e5219e215f67&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d99eabee0b1f2174b3cadcc5c6c9e5219e215f67&newProject=comm-central&newRevision=d99eabee0b1f2174b3cadcc5c6c9e5219e215f67&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d99eabee0b1f2174b3cadcc5c6c9e5219e215f67&newProject=comm-central&newRevision=d99eabee0b1f2174b3cadcc5c6c9e5219e215f67&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">1515877</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">Bug 1515877</a> - Turn on ESLint in mailnews/compose. r=aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/.eslintignore">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/.eslintignore">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/.eslintignore">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/.eslintignore">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/content/askSendFormat.js">mailnews/compose/content/askSendFormat.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/content/askSendFormat.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/content/askSendFormat.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/content/askSendFormat.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/content/askSendFormat.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/content/askSendFormat.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/content/sendProgress.js">mailnews/compose/content/sendProgress.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/content/sendProgress.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/content/sendProgress.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/content/sendProgress.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/content/sendProgress.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/content/sendProgress.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/src/nsSMTPProtocolHandler.js">mailnews/compose/src/nsSMTPProtocolHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/src/nsSMTPProtocolHandler.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/src/nsSMTPProtocolHandler.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/src/nsSMTPProtocolHandler.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/src/nsSMTPProtocolHandler.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/src/nsSMTPProtocolHandler.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/.eslintrc.js">mailnews/compose/test/unit/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/head_compose.js">mailnews/compose/test/unit/head_compose.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/head_compose.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/head_compose.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/head_compose.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/head_compose.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/head_compose.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_attachment.js">mailnews/compose/test/unit/test_attachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_attachment.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_attachment.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_attachment.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_attachment.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_attachment.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_autoReply.js">mailnews/compose/test/unit/test_autoReply.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_autoReply.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_autoReply.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_autoReply.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_autoReply.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_autoReply.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_bug155172.js">mailnews/compose/test/unit/test_bug155172.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_bug155172.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_bug155172.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_bug155172.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_bug155172.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_bug155172.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_bug235432.js">mailnews/compose/test/unit/test_bug235432.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_bug235432.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_bug235432.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_bug235432.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_bug235432.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_bug235432.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_bug474774.js">mailnews/compose/test/unit/test_bug474774.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_bug474774.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_bug474774.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_bug474774.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_bug474774.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_bug474774.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_detectAttachmentCharset.js">mailnews/compose/test/unit/test_detectAttachmentCharset.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_detectAttachmentCharset.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_detectAttachmentCharset.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_detectAttachmentCharset.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_detectAttachmentCharset.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_detectAttachmentCharset.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_expandMailingLists.js">mailnews/compose/test/unit/test_expandMailingLists.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_expandMailingLists.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_expandMailingLists.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_expandMailingLists.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_expandMailingLists.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_expandMailingLists.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_longLines.js">mailnews/compose/test/unit/test_longLines.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_longLines.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_longLines.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_longLines.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_longLines.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_longLines.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_mailtoURL.js">mailnews/compose/test/unit/test_mailtoURL.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_mailtoURL.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_mailtoURL.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_mailtoURL.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_mailtoURL.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_mailtoURL.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_messageHeaders.js">mailnews/compose/test/unit/test_messageHeaders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_messageHeaders.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_messageHeaders.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_messageHeaders.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_messageHeaders.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_messageHeaders.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsIMsgCompFields.js">mailnews/compose/test/unit/test_nsIMsgCompFields.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsIMsgCompFields.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsIMsgCompFields.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsIMsgCompFields.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsIMsgCompFields.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsIMsgCompFields.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose1.js">mailnews/compose/test/unit/test_nsMsgCompose1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose1.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose1.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose1.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose1.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose1.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose2.js">mailnews/compose/test/unit/test_nsMsgCompose2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose2.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose2.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose2.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose2.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose3.js">mailnews/compose/test/unit/test_nsMsgCompose3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose3.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose3.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose3.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose3.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose3.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose4.js">mailnews/compose/test/unit/test_nsMsgCompose4.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose4.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose4.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose4.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose4.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsMsgCompose4.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsSmtpService1.js">mailnews/compose/test/unit/test_nsSmtpService1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsSmtpService1.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsSmtpService1.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsSmtpService1.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsSmtpService1.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_nsSmtpService1.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendBackground.js">mailnews/compose/test/unit/test_sendBackground.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendBackground.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendBackground.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendBackground.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendBackground.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendBackground.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMailAddressIDN.js">mailnews/compose/test/unit/test_sendMailAddressIDN.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMailAddressIDN.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMailAddressIDN.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMailAddressIDN.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMailAddressIDN.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMailAddressIDN.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMailMessage.js">mailnews/compose/test/unit/test_sendMailMessage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMailMessage.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMailMessage.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMailMessage.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMailMessage.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMailMessage.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageFile.js">mailnews/compose/test/unit/test_sendMessageFile.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageFile.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageFile.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageFile.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageFile.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageFile.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageLater.js">mailnews/compose/test/unit/test_sendMessageLater.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageLater.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageLater.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageLater.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageLater.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageLater.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageLater2.js">mailnews/compose/test/unit/test_sendMessageLater2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageLater2.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageLater2.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageLater2.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageLater2.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageLater2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageLater3.js">mailnews/compose/test/unit/test_sendMessageLater3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageLater3.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageLater3.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageLater3.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageLater3.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendMessageLater3.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendObserver.js">mailnews/compose/test/unit/test_sendObserver.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendObserver.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendObserver.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendObserver.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendObserver.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_sendObserver.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtp8bitMime.js">mailnews/compose/test/unit/test_smtp8bitMime.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtp8bitMime.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtp8bitMime.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtp8bitMime.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtp8bitMime.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtp8bitMime.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpAuthMethods.js">mailnews/compose/test/unit/test_smtpAuthMethods.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpAuthMethods.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpAuthMethods.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpAuthMethods.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpAuthMethods.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpAuthMethods.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPassword.js">mailnews/compose/test/unit/test_smtpPassword.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPassword.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPassword.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPassword.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPassword.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPassword.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPassword2.js">mailnews/compose/test/unit/test_smtpPassword2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPassword2.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPassword2.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPassword2.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPassword2.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPassword2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">mailnews/compose/test/unit/test_smtpPasswordFailure1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">mailnews/compose/test/unit/test_smtpPasswordFailure2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">mailnews/compose/test/unit/test_smtpPasswordFailure3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpPasswordFailure3.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpProtocols.js">mailnews/compose/test/unit/test_smtpProtocols.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpProtocols.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpProtocols.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpProtocols.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpProtocols.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpProtocols.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpProxy.js">mailnews/compose/test/unit/test_smtpProxy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpProxy.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpProxy.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpProxy.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpProxy.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpProxy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpURL.js">mailnews/compose/test/unit/test_smtpURL.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpURL.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpURL.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpURL.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpURL.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_smtpURL.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_splitRecipients.js">mailnews/compose/test/unit/test_splitRecipients.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_splitRecipients.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_splitRecipients.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_splitRecipients.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_splitRecipients.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_splitRecipients.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_staleTemporaryFileCleanup.js">mailnews/compose/test/unit/test_staleTemporaryFileCleanup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_staleTemporaryFileCleanup.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_staleTemporaryFileCleanup.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_staleTemporaryFileCleanup.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_staleTemporaryFileCleanup.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_staleTemporaryFileCleanup.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_temporaryFilesRemoved.js">mailnews/compose/test/unit/test_temporaryFilesRemoved.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_temporaryFilesRemoved.js">file</a> |
<a href="/comm-central/annotate/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_temporaryFilesRemoved.js">annotate</a> |
<a href="/comm-central/diff/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_temporaryFilesRemoved.js">diff</a> |
<a href="/comm-central/comparison/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_temporaryFilesRemoved.js">comparison</a> |
<a href="/comm-central/log/d99eabee0b1f2174b3cadcc5c6c9e5219e215f67/mailnews/compose/test/unit/test_temporaryFilesRemoved.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -57,18 +57,16 @@ editor/ui/dialogs/content/EditorSaveAsCh</span>
<a href="#l1.4"></a><span id="l1.4"> editor/ui/dialogs/content/EdLinkChecker.js</span>
<a href="#l1.5"></a><span id="l1.5"> editor/ui/dialogs/content/EdLinkChecker.xul</span>
<a href="#l1.6"></a><span id="l1.6"> editor/ui/dialogs/content/EdSnapToGrid.js</span>
<a href="#l1.7"></a><span id="l1.7"> editor/ui/dialogs/content/EdSnapToGrid.xul</span>
<a href="#l1.8"></a><span id="l1.8"> editor/ui/texzilla/**</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> # mailnews exclusions</span>
<a href="#l1.11"></a><span id="l1.11"> mailnews/mailnews.js</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-mailnews/build/*</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-mailnews/compose/*</span>
<a href="#l1.14"></a><span id="l1.14"> mailnews/db/*</span>
<a href="#l1.15"></a><span id="l1.15"> mailnews/imap/*</span>
<a href="#l1.16"></a><span id="l1.16"> mailnews/import/*</span>
<a href="#l1.17"></a><span id="l1.17"> mailnews/intl/*</span>
<a href="#l1.18"></a><span id="l1.18"> mailnews/jsaccount/*</span>
<a href="#l1.19"></a><span id="l1.19"> mailnews/mime/*</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21"> # mailnews/extensions exclusions</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/content/askSendFormat.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/content/askSendFormat.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -5,34 +5,32 @@</span>
<a href="#l2.4"></a><span id="l2.4"> var gParam = null;</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> document.addEventListener(&quot;dialogaccept&quot;, Send);</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> /**</span>
<a href="#l2.9"></a><span id="l2.9">  * This dialog should be opened with arguments like e.g.</span>
<a href="#l2.10"></a><span id="l2.10">  * {action: nsIMsgCompSendFormat.AskUser, convertible: nsIMsgCompConvertible.Yes}</span>
<a href="#l2.11"></a><span id="l2.11">  */</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-function Startup()</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-{</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+function Startup() {</span>
<a href="#l2.15"></a><span id="l2.15">   gParam = window.arguments[0];</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17">   const msgCompSendFormat = Ci.nsIMsgCompSendFormat;</span>
<a href="#l2.18"></a><span id="l2.18">   const msgCompConvertible = Ci.nsIMsgCompConvertible;</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">   var bundle = document.getElementById(&quot;askSendFormatStringBundle&quot;);</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22">   // If the user hits the close box, we will abort.</span>
<a href="#l2.23"></a><span id="l2.23">   gParam.abort = true;</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25">   // Set the question label</span>
<a href="#l2.26"></a><span id="l2.26">   var mailSendFormatExplanation = document.getElementById(&quot;mailSendFormatExplanation&quot;);</span>
<a href="#l2.27"></a><span id="l2.27">   var icon = document.getElementById(&quot;convertDefault&quot;);</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-  switch (gParam.convertible)</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-  {</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  switch (gParam.convertible) {</span>
<a href="#l2.32"></a><span id="l2.32">     case msgCompConvertible.Altering:</span>
<a href="#l2.33"></a><span id="l2.33">       mailSendFormatExplanation.textContent = bundle.getString(&quot;convertibleAltering&quot;);</span>
<a href="#l2.34"></a><span id="l2.34">       icon.className = &quot;question-icon&quot;;</span>
<a href="#l2.35"></a><span id="l2.35">       break;</span>
<a href="#l2.36"></a><span id="l2.36">     case msgCompConvertible.No:</span>
<a href="#l2.37"></a><span id="l2.37">       mailSendFormatExplanation.textContent = bundle.getString(&quot;convertibleNo&quot;);</span>
<a href="#l2.38"></a><span id="l2.38">       icon.className = &quot;alert-icon&quot;;</span>
<a href="#l2.39"></a><span id="l2.39">       break;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineat">@@ -40,21 +38,19 @@ function Startup()</span>
<a href="#l2.41"></a><span id="l2.41">       mailSendFormatExplanation.textContent = bundle.getString(&quot;convertibleYes&quot;);</span>
<a href="#l2.42"></a><span id="l2.42">       // XXX change this to use class message-icon once bug 512173 is fixed</span>
<a href="#l2.43"></a><span id="l2.43">       icon.className = &quot;question-icon&quot;;</span>
<a href="#l2.44"></a><span id="l2.44">       break;</span>
<a href="#l2.45"></a><span id="l2.45">   }</span>
<a href="#l2.46"></a><span id="l2.46"> </span>
<a href="#l2.47"></a><span id="l2.47">   // Set the default radio array value and recommendation.</span>
<a href="#l2.48"></a><span id="l2.48">   var group = document.getElementById(&quot;mailDefaultHTMLAction&quot;);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-  if (gParam.action != msgCompSendFormat.AskUser)</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-  {</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+  if (gParam.action != msgCompSendFormat.AskUser) {</span>
<a href="#l2.52"></a><span id="l2.52">     group.value = gParam.action;</span>
<a href="#l2.53"></a><span id="l2.53">     group.selectedItem.label += &quot; &quot; + bundle.getString(&quot;recommended&quot;);</span>
<a href="#l2.54"></a><span id="l2.54">   }</span>
<a href="#l2.55"></a><span id="l2.55"> }</span>
<a href="#l2.56"></a><span id="l2.56"> </span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-function Send()</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-{</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+function Send() {</span>
<a href="#l2.60"></a><span id="l2.60">   // gParam.action should be an integer for when it is returned to MsgComposeCommands.js</span>
<a href="#l2.61"></a><span id="l2.61">   gParam.action = parseInt(document.getElementById(&quot;mailDefaultHTMLAction&quot;).value);</span>
<a href="#l2.62"></a><span id="l2.62">   gParam.abort = false;</span>
<a href="#l2.63"></a><span id="l2.63"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/content/sendProgress.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/content/sendProgress.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -14,26 +14,23 @@ var msgProgress = null;</span>
<a href="#l3.4"></a><span id="l3.4"> // random global variables...</span>
<a href="#l3.5"></a><span id="l3.5"> var itsASaveOperation = false;</span>
<a href="#l3.6"></a><span id="l3.6"> var gSendProgressStringBundle;</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> // all progress notifications are done through the nsIWebProgressListener implementation...</span>
<a href="#l3.11"></a><span id="l3.11"> var progressListener = {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    onStateChange: function(aWebProgress, aRequest, aStateFlags, aStatus)</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    {</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-      if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_START)</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-      {</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    onStateChange(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+      if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_START) {</span>
<a href="#l3.18"></a><span id="l3.18">         // Set no value to progress meter when undetermined.</span>
<a href="#l3.19"></a><span id="l3.19">         dialog.progress.removeAttribute(&quot;value&quot;);</span>
<a href="#l3.20"></a><span id="l3.20">       }</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-      if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_STOP)</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-      {</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+      if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_STOP) {</span>
<a href="#l3.25"></a><span id="l3.25">         // we are done sending/saving the message...</span>
<a href="#l3.26"></a><span id="l3.26">         // Indicate completion in status area.</span>
<a href="#l3.27"></a><span id="l3.27">         var msg;</span>
<a href="#l3.28"></a><span id="l3.28">         if (itsASaveOperation)</span>
<a href="#l3.29"></a><span id="l3.29">           msg = gSendProgressStringBundle.getString(&quot;messageSaved&quot;);</span>
<a href="#l3.30"></a><span id="l3.30">         else</span>
<a href="#l3.31"></a><span id="l3.31">           msg = gSendProgressStringBundle.getString(&quot;messageSent&quot;);</span>
<a href="#l3.32"></a><span id="l3.32">         dialog.status.setAttribute(&quot;value&quot;, msg);</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineat">@@ -42,84 +39,72 @@ var progressListener = {</span>
<a href="#l3.34"></a><span id="l3.34">         dialog.progress.setAttribute(&quot;value&quot;, 100);</span>
<a href="#l3.35"></a><span id="l3.35">         var percentMsg = gSendProgressStringBundle.getFormattedString(&quot;percentMsg&quot;, [100]);</span>
<a href="#l3.36"></a><span id="l3.36">         dialog.progressText.setAttribute(&quot;value&quot;, percentMsg);</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38">         window.close();</span>
<a href="#l3.39"></a><span id="l3.39">       }</span>
<a href="#l3.40"></a><span id="l3.40">     },</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-    onProgressChange: function(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress, aCurTotalProgress, aMaxTotalProgress)</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-    {</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+    onProgressChange(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress, aCurTotalProgress, aMaxTotalProgress) {</span>
<a href="#l3.45"></a><span id="l3.45">       // Calculate percentage.</span>
<a href="#l3.46"></a><span id="l3.46">       var percent;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-      if (aMaxTotalProgress &gt; 0)</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-      {</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+      if (aMaxTotalProgress &gt; 0) {</span>
<a href="#l3.50"></a><span id="l3.50">         percent = Math.round(aCurTotalProgress / aMaxTotalProgress * 100);</span>
<a href="#l3.51"></a><span id="l3.51">         if (percent &gt; 100)</span>
<a href="#l3.52"></a><span id="l3.52">           percent = 100;</span>
<a href="#l3.53"></a><span id="l3.53"> </span>
<a href="#l3.54"></a><span id="l3.54">         // Advance progress meter.</span>
<a href="#l3.55"></a><span id="l3.55">         dialog.progress.value = percent;</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57">         // Update percentage label on progress meter.</span>
<a href="#l3.58"></a><span id="l3.58">         var percentMsg = gSendProgressStringBundle.getFormattedString(&quot;percentMsg&quot;, [percent]);</span>
<a href="#l3.59"></a><span id="l3.59">         dialog.progressText.value = percentMsg;</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-      }</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-      else</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-      {</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+      } else {</span>
<a href="#l3.64"></a><span id="l3.64">         // Progress meter should show no value in this case.</span>
<a href="#l3.65"></a><span id="l3.65">         dialog.progress.removeAttribute(&quot;value&quot;);</span>
<a href="#l3.66"></a><span id="l3.66">       }</span>
<a href="#l3.67"></a><span id="l3.67">     },</span>
<a href="#l3.68"></a><span id="l3.68"> </span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-    onLocationChange: function(aWebProgress, aRequest, aLocation, aFlags)</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-    {</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+    onLocationChange(aWebProgress, aRequest, aLocation, aFlags) {</span>
<a href="#l3.72"></a><span id="l3.72">       // we can ignore this notification</span>
<a href="#l3.73"></a><span id="l3.73">     },</span>
<a href="#l3.74"></a><span id="l3.74"> </span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-    onStatusChange: function(aWebProgress, aRequest, aStatus, aMessage)</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-    {</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+    onStatusChange(aWebProgress, aRequest, aStatus, aMessage) {</span>
<a href="#l3.78"></a><span id="l3.78">       if (aMessage != &quot;&quot;)</span>
<a href="#l3.79"></a><span id="l3.79">         dialog.status.setAttribute(&quot;value&quot;, aMessage);</span>
<a href="#l3.80"></a><span id="l3.80">     },</span>
<a href="#l3.81"></a><span id="l3.81"> </span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-    onSecurityChange: function(aWebProgress, aRequest, state)</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-    {</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+    onSecurityChange(aWebProgress, aRequest, state) {</span>
<a href="#l3.85"></a><span id="l3.85">       // we can ignore this notification</span>
<a href="#l3.86"></a><span id="l3.86">     },</span>
<a href="#l3.87"></a><span id="l3.87"> </span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-    onContentBlockingEvent: function(aWebProgress, aRequest, aEvent)</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-    {</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+    onContentBlockingEvent(aWebProgress, aRequest, aEvent) {</span>
<a href="#l3.91"></a><span id="l3.91">       // we can ignore this notification</span>
<a href="#l3.92"></a><span id="l3.92">     },</span>
<a href="#l3.93"></a><span id="l3.93"> </span>
<a href="#l3.94"></a><span id="l3.94">     QueryInterface: ChromeUtils.generateQI([&quot;nsIWebProgressListener&quot;,</span>
<a href="#l3.95"></a><span id="l3.95">                                             &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l3.96"></a><span id="l3.96"> };</span>
<a href="#l3.97"></a><span id="l3.97"> </span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-function onLoad()</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-{</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+function onLoad() {</span>
<a href="#l3.101"></a><span id="l3.101">     // Set global variables.</span>
<a href="#l3.102"></a><span id="l3.102">     let subject = &quot;&quot;;</span>
<a href="#l3.103"></a><span id="l3.103">     gSendProgressStringBundle = document.getElementById(&quot;sendProgressStringBundle&quot;);</span>
<a href="#l3.104"></a><span id="l3.104"> </span>
<a href="#l3.105"></a><span id="l3.105">     msgProgress = window.arguments[0];</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-    if (!msgProgress)</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-    {</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+    if (!msgProgress) {</span>
<a href="#l3.109"></a><span id="l3.109">       Cu.reportError(&quot;Invalid argument to sendProgress.xul.&quot;);</span>
<a href="#l3.110"></a><span id="l3.110">       window.close();</span>
<a href="#l3.111"></a><span id="l3.111">       return;</span>
<a href="#l3.112"></a><span id="l3.112">     }</span>
<a href="#l3.113"></a><span id="l3.113"> </span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-    if (window.arguments[1])</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-    {</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+    if (window.arguments[1]) {</span>
<a href="#l3.117"></a><span id="l3.117">       let progressParams = window.arguments[1].QueryInterface(Ci.nsIMsgComposeProgressParams);</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-      if (progressParams)</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-      {</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+      if (progressParams) {</span>
<a href="#l3.121"></a><span id="l3.121">         itsASaveOperation = (progressParams.deliveryMode != nsIMsgCompDeliverMode.Now);</span>
<a href="#l3.122"></a><span id="l3.122">         subject = progressParams.subject;</span>
<a href="#l3.123"></a><span id="l3.123">       }</span>
<a href="#l3.124"></a><span id="l3.124">     }</span>
<a href="#l3.125"></a><span id="l3.125"> </span>
<a href="#l3.126"></a><span id="l3.126">     if (subject) {</span>
<a href="#l3.127"></a><span id="l3.127">       let title = itsASaveOperation ? &quot;titleSaveMsgSubject&quot; : &quot;titleSendMsgSubject&quot;;</span>
<a href="#l3.128"></a><span id="l3.128">       document.title = gSendProgressStringBundle.getFormattedString(title, [subject]);</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineat">@@ -132,35 +117,29 @@ function onLoad()</span>
<a href="#l3.130"></a><span id="l3.130">     dialog.status       = document.getElementById(&quot;dialog.status&quot;);</span>
<a href="#l3.131"></a><span id="l3.131">     dialog.progress     = document.getElementById(&quot;dialog.progress&quot;);</span>
<a href="#l3.132"></a><span id="l3.132">     dialog.progressText = document.getElementById(&quot;dialog.progressText&quot;);</span>
<a href="#l3.133"></a><span id="l3.133"> </span>
<a href="#l3.134"></a><span id="l3.134">     // set our web progress listener on the helper app launcher</span>
<a href="#l3.135"></a><span id="l3.135">     msgProgress.registerListener(progressListener);</span>
<a href="#l3.136"></a><span id="l3.136"> }</span>
<a href="#l3.137"></a><span id="l3.137"> </span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-function onUnload()</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-{</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-  if (msgProgress)</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-  {</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-    try</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-    {</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+function onUnload() {</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+  if (msgProgress) {</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+    try {</span>
<a href="#l3.147"></a><span id="l3.147">       msgProgress.unregisterListener(progressListener);</span>
<a href="#l3.148"></a><span id="l3.148">       msgProgress = null;</span>
<a href="#l3.149"></a><span id="l3.149">     } catch (e) {}</span>
<a href="#l3.150"></a><span id="l3.150">   }</span>
<a href="#l3.151"></a><span id="l3.151"> }</span>
<a href="#l3.152"></a><span id="l3.152"> </span>
<a href="#l3.153"></a><span id="l3.153"> // If the user presses cancel, tell the app launcher and close the dialog...</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-function onCancel(event)</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-{</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+function onCancel(event) {</span>
<a href="#l3.157"></a><span id="l3.157">   // Cancel app launcher.</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-  try</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-  {</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+  try {</span>
<a href="#l3.161"></a><span id="l3.161">     msgProgress.processCanceledByUser = true;</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-  } catch (e)</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-  {</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+  } catch (e) {</span>
<a href="#l3.165"></a><span id="l3.165">     return;</span>
<a href="#l3.166"></a><span id="l3.166">   }</span>
<a href="#l3.167"></a><span id="l3.167"> </span>
<a href="#l3.168"></a><span id="l3.168">   // Don't close up dialog, the backend will close the dialog when everything will be aborted.</span>
<a href="#l3.169"></a><span id="l3.169">   event.preventDefault();</span>
<a href="#l3.170"></a><span id="l3.170"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/src/nsSMTPProtocolHandler.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/src/nsSMTPProtocolHandler.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -15,31 +15,31 @@ function makeProtocolHandler(aProtocol, </span>
<a href="#l4.4"></a><span id="l4.4">     scheme: aProtocol,</span>
<a href="#l4.5"></a><span id="l4.5">     defaultPort: aDefaultPort,</span>
<a href="#l4.6"></a><span id="l4.6">     protocolFlags: nsIProtocolHandler.URI_NORELATIVE |</span>
<a href="#l4.7"></a><span id="l4.7">                    nsIProtocolHandler.URI_DANGEROUS_TO_LOAD |</span>
<a href="#l4.8"></a><span id="l4.8">       nsIProtocolHandler.URI_NON_PERSISTABLE |</span>
<a href="#l4.9"></a><span id="l4.9">       nsIProtocolHandler.ALLOWS_PROXY |</span>
<a href="#l4.10"></a><span id="l4.10">       nsIProtocolHandler.URI_FORBIDS_AUTOMATIC_DOCUMENT_REPLACEMENT,</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    newURI: function (aSpec, aOriginCharset, aBaseURI) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    newURI(aSpec, aOriginCharset, aBaseURI) {</span>
<a href="#l4.14"></a><span id="l4.14">       var url = Cc[&quot;@mozilla.org/messengercompose/smtpurl;1&quot;]</span>
<a href="#l4.15"></a><span id="l4.15">                   .createInstance(Ci.nsIURI);</span>
<a href="#l4.16"></a><span id="l4.16">       if (url instanceof Ci.nsISmtpUrl)</span>
<a href="#l4.17"></a><span id="l4.17">         url.init(aSpec);</span>
<a href="#l4.18"></a><span id="l4.18">       return url;</span>
<a href="#l4.19"></a><span id="l4.19">     },</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-    newChannel: function(aURI, aLoadInfo) {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+    newChannel(aURI, aLoadInfo) {</span>
<a href="#l4.23"></a><span id="l4.23">       throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.24"></a><span id="l4.24">     },</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-    allowPort: function (port, scheme) {</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+    allowPort(port, scheme) {</span>
<a href="#l4.28"></a><span id="l4.28">       return port == aDefaultPort;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-    }</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+    },</span>
<a href="#l4.31"></a><span id="l4.31">   };</span>
<a href="#l4.32"></a><span id="l4.32"> }</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34"> function nsSMTPProtocolHandler() {}</span>
<a href="#l4.35"></a><span id="l4.35"> </span>
<a href="#l4.36"></a><span id="l4.36"> nsSMTPProtocolHandler.prototype =</span>
<a href="#l4.37"></a><span id="l4.37">   makeProtocolHandler(&quot;smtp&quot;,</span>
<a href="#l4.38"></a><span id="l4.38">                       Ci.nsISmtpUrl.DEFAULT_SMTP_PORT,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mailnews/compose/test/unit/.eslintrc.js</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+module.exports = {</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+  &quot;extends&quot;: &quot;plugin:mozilla/xpcshell-test&quot;,</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+  &quot;rules&quot;: {</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+    &quot;func-names&quot;: &quot;off&quot;,</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+    &quot;mozilla/import-headjs-globals&quot;: &quot;error&quot;,</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    &quot;no-unused-vars&quot;: [&quot;error&quot;, {</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+      &quot;args&quot;: &quot;none&quot;,</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+      &quot;vars&quot;: &quot;all&quot;,</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+    }],</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+  },</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/test/unit/head_compose.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/test/unit/head_compose.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -12,16 +12,18 @@ var {getAppInfo, newAppInfo, updateAppIn</span>
<a href="#l6.4"></a><span id="l6.4"> updateAppInfo();</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> // Ensure the profile directory is set up</span>
<a href="#l6.7"></a><span id="l6.7"> do_get_profile();</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> var gDEPTH = &quot;../../../../&quot;;</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> // Import the required setup scripts.</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+/* import-globals-from ../../../test/resources/abSetup.js */</span>
<a href="#l6.14"></a><span id="l6.14"> load(&quot;../../../resources/abSetup.js&quot;);</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16"> // Import the smtp server scripts</span>
<a href="#l6.17"></a><span id="l6.17"> var {</span>
<a href="#l6.18"></a><span id="l6.18">   nsMailServer,</span>
<a href="#l6.19"></a><span id="l6.19">   gThreadManager,</span>
<a href="#l6.20"></a><span id="l6.20">   fsDebugNone,</span>
<a href="#l6.21"></a><span id="l6.21">   fsDebugAll,</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -33,29 +35,27 @@ var {</span>
<a href="#l6.23"></a><span id="l6.23">   SMTP_RFC2821_handler,</span>
<a href="#l6.24"></a><span id="l6.24"> } = ChromeUtils.import(&quot;resource://testing-common/mailnews/smtpd.js&quot;);</span>
<a href="#l6.25"></a><span id="l6.25"> var {</span>
<a href="#l6.26"></a><span id="l6.26">   AuthPLAIN,</span>
<a href="#l6.27"></a><span id="l6.27">   AuthLOGIN,</span>
<a href="#l6.28"></a><span id="l6.28">   AuthCRAM,</span>
<a href="#l6.29"></a><span id="l6.29"> } = ChromeUtils.import(&quot;resource://testing-common/mailnews/auth.js&quot;);</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-</span>
<a href="#l6.33"></a><span id="l6.33"> var gDraftFolder;</span>
<a href="#l6.34"></a><span id="l6.34"> </span>
<a href="#l6.35"></a><span id="l6.35"> // Setup the daemon and server</span>
<a href="#l6.36"></a><span id="l6.36"> function setupServerDaemon(handler) {</span>
<a href="#l6.37"></a><span id="l6.37">   if (!handler)</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-    handler = function (d) { return new SMTP_RFC2821_handler(d); };</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+    handler = function(d) { return new SMTP_RFC2821_handler(d); };</span>
<a href="#l6.40"></a><span id="l6.40">   var server = new nsMailServer(handler, new smtpDaemon());</span>
<a href="#l6.41"></a><span id="l6.41">   return server;</span>
<a href="#l6.42"></a><span id="l6.42"> }</span>
<a href="#l6.43"></a><span id="l6.43"> </span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-function getBasicSmtpServer(port=1, hostname=&quot;localhost&quot;) {</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+function getBasicSmtpServer(port = 1, hostname = &quot;localhost&quot;) {</span>
<a href="#l6.46"></a><span id="l6.46">   let server = localAccountUtils.create_outgoing_server(port, &quot;user&quot;,</span>
<a href="#l6.47"></a><span id="l6.47">     &quot;password&quot;, hostname);</span>
<a href="#l6.48"></a><span id="l6.48"> </span>
<a href="#l6.49"></a><span id="l6.49">   // Override the default greeting so we get something predicitable</span>
<a href="#l6.50"></a><span id="l6.50">   // in the ELHO message</span>
<a href="#l6.51"></a><span id="l6.51">   Services.prefs.setCharPref(&quot;mail.smtpserver.default.hello_argument&quot;, &quot;test&quot;);</span>
<a href="#l6.52"></a><span id="l6.52"> </span>
<a href="#l6.53"></a><span id="l6.53">   return server;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineat">@@ -71,89 +71,90 @@ function getSmtpIdentity(senderName, smt</span>
<a href="#l6.55"></a><span id="l6.55"> }</span>
<a href="#l6.56"></a><span id="l6.56"> </span>
<a href="#l6.57"></a><span id="l6.57"> var test;</span>
<a href="#l6.58"></a><span id="l6.58"> </span>
<a href="#l6.59"></a><span id="l6.59"> function do_check_transaction(real, expected) {</span>
<a href="#l6.60"></a><span id="l6.60">   // real.them may have an extra QUIT on the end, where the stream is only</span>
<a href="#l6.61"></a><span id="l6.61">   // closed after we have a chance to process it and not them. We therefore</span>
<a href="#l6.62"></a><span id="l6.62">   // excise this from the list</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-  if (real.them[real.them.length-1] == &quot;QUIT&quot;)</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+  if (real.them[real.them.length - 1] == &quot;QUIT&quot;)</span>
<a href="#l6.65"></a><span id="l6.65">     real.them.pop();</span>
<a href="#l6.66"></a><span id="l6.66"> </span>
<a href="#l6.67"></a><span id="l6.67">   Assert.equal(real.them.join(&quot;,&quot;), expected.join(&quot;,&quot;));</span>
<a href="#l6.68"></a><span id="l6.68">   dump(&quot;Passed test &quot; + test + &quot;\n&quot;);</span>
<a href="#l6.69"></a><span id="l6.69"> }</span>
<a href="#l6.70"></a><span id="l6.70"> </span>
<a href="#l6.71"></a><span id="l6.71"> // This listener is designed just to call OnStopCopy() when its OnStopCopy</span>
<a href="#l6.72"></a><span id="l6.72"> // function is called - the rest of the functions are unneeded for a lot of</span>
<a href="#l6.73"></a><span id="l6.73"> // tests (but we can't use asyncCopyListener because we need the</span>
<a href="#l6.74"></a><span id="l6.74"> // nsIMsgSendListener interface as well).</span>
<a href="#l6.75"></a><span id="l6.75"> var copyListener = {</span>
<a href="#l6.76"></a><span id="l6.76">   // nsIMsgSendListener</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-  onStartSending: function (aMsgID, aMsgSize) {},</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-  onProgress: function (aMsgID, aProgress, aProgressMax) {},</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-  onStatus: function (aMsgID, aMsg) {},</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-  onStopSending: function (aMsgID, aStatus, aMsg, aReturnFile) {},</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-  onGetDraftFolderURI: function (aFolderURI) {},</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-  onSendNotPerformed: function (aMsgID, aStatus) {},</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+  onStartSending(aMsgID, aMsgSize) {},</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+  onProgress(aMsgID, aProgress, aProgressMax) {},</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+  onStatus(aMsgID, aMsg) {},</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+  onStopSending(aMsgID, aStatus, aMsg, aReturnFile) {},</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+  onGetDraftFolderURI(aFolderURI) {},</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+  onSendNotPerformed(aMsgID, aStatus) {},</span>
<a href="#l6.89"></a><span id="l6.89"> </span>
<a href="#l6.90"></a><span id="l6.90">   // nsIMsgCopyServiceListener</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-  OnStartCopy: function () {},</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-  OnProgress: function (aProgress, aProgressMax) {},</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-  SetMessageKey: function (aKey) {},</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-  GetMessageId: function (aMessageId) {},</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-  OnStopCopy: function (aStatus) {</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+  SetMessageKey(aKey) {},</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+  GetMessageId(aMessageId) {},</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+    /* globals OnStopCopy */</span>
<a href="#l6.102"></a><span id="l6.102">     OnStopCopy(aStatus);</span>
<a href="#l6.103"></a><span id="l6.103">   },</span>
<a href="#l6.104"></a><span id="l6.104"> </span>
<a href="#l6.105"></a><span id="l6.105">   // QueryInterface</span>
<a href="#l6.106"></a><span id="l6.106">   QueryInterface: ChromeUtils.generateQI([&quot;nsIMsgSendListener&quot;,</span>
<a href="#l6.107"></a><span id="l6.107">                                           &quot;nsIMsgCopyServiceListener&quot;]),</span>
<a href="#l6.108"></a><span id="l6.108"> };</span>
<a href="#l6.109"></a><span id="l6.109"> </span>
<a href="#l6.110"></a><span id="l6.110"> var progressListener = {</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-  onStateChange: function(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+  onStateChange(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l6.113"></a><span id="l6.113">     if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_STOP)</span>
<a href="#l6.114"></a><span id="l6.114">       this.resolve(mailTestUtils.firstMsgHdr(gDraftFolder));</span>
<a href="#l6.115"></a><span id="l6.115">   },</span>
<a href="#l6.116"></a><span id="l6.116"> </span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-  onProgressChange: function(aWebProgress, aRequest, aCurSelfProgress,</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+  onProgressChange(aWebProgress, aRequest, aCurSelfProgress,</span>
<a href="#l6.119"></a><span id="l6.119">     aMaxSelfProgress, aCurTotalProgress, aMaxTotalProgress) {},</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-  onLocationChange: function(aWebProgress, aRequest, aLocation, aFlags) {},</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-  onStatusChange: function(aWebProgress, aRequest, aStatus, aMessage) {},</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-  onSecurityChange: function(aWebProgress, aRequest, state) {},</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-  onContentBlockingEvent: function(aWebProgress, aRequest, aEvent) {},</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+  onLocationChange(aWebProgress, aRequest, aLocation, aFlags) {},</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+  onStatusChange(aWebProgress, aRequest, aStatus, aMessage) {},</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+  onSecurityChange(aWebProgress, aRequest, state) {},</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+  onContentBlockingEvent(aWebProgress, aRequest, aEvent) {},</span>
<a href="#l6.128"></a><span id="l6.128"> </span>
<a href="#l6.129"></a><span id="l6.129">   QueryInterface: ChromeUtils.generateQI([&quot;nsIWebProgressListener&quot;,</span>
<a href="#l6.130"></a><span id="l6.130">                                           &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l6.131"></a><span id="l6.131"> };</span>
<a href="#l6.132"></a><span id="l6.132"> </span>
<a href="#l6.133"></a><span id="l6.133"> function createMessage(aAttachment) {</span>
<a href="#l6.134"></a><span id="l6.134">   let fields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l6.135"></a><span id="l6.135">                  .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l6.136"></a><span id="l6.136">   let attachments = [];</span>
<a href="#l6.137"></a><span id="l6.137">   if (aAttachment) {</span>
<a href="#l6.138"></a><span id="l6.138">     let attachment = Cc[&quot;@mozilla.org/messengercompose/attachment;1&quot;]</span>
<a href="#l6.139"></a><span id="l6.139">                        .createInstance(Ci.nsIMsgAttachment);</span>
<a href="#l6.140"></a><span id="l6.140">     if (aAttachment instanceof Ci.nsIFile) {</span>
<a href="#l6.141"></a><span id="l6.141">       attachment.url = &quot;file://&quot; + aAttachment.path;</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-      attachment.contentType = 'text/plain';</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+      attachment.contentType = &quot;text/plain&quot;;</span>
<a href="#l6.144"></a><span id="l6.144">       attachment.name = aAttachment.leafName;</span>
<a href="#l6.145"></a><span id="l6.145">     } else {</span>
<a href="#l6.146"></a><span id="l6.146">       attachment.url = &quot;data:,sometext&quot;;</span>
<a href="#l6.147"></a><span id="l6.147">       attachment.name = aAttachment;</span>
<a href="#l6.148"></a><span id="l6.148">     }</span>
<a href="#l6.149"></a><span id="l6.149">     attachments = [attachment];</span>
<a href="#l6.150"></a><span id="l6.150">   }</span>
<a href="#l6.151"></a><span id="l6.151">   return richCreateMessage(fields, attachments);</span>
<a href="#l6.152"></a><span id="l6.152"> }</span>
<a href="#l6.153"></a><span id="l6.153"> </span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-function richCreateMessage(fields, attachments=[], identity=null,</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-                           account=null) {</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+function richCreateMessage(fields, attachments = [], identity = null,</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+                           account = null) {</span>
<a href="#l6.158"></a><span id="l6.158">   let params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l6.159"></a><span id="l6.159">                  .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l6.160"></a><span id="l6.160">   params.composeFields = fields;</span>
<a href="#l6.161"></a><span id="l6.161"> </span>
<a href="#l6.162"></a><span id="l6.162">   let msgCompose = MailServices.compose.initCompose(params);</span>
<a href="#l6.163"></a><span id="l6.163">   if (identity === null)</span>
<a href="#l6.164"></a><span id="l6.164">     identity = getSmtpIdentity(null, getBasicSmtpServer());</span>
<a href="#l6.165"></a><span id="l6.165"> </span>
<a href="#l6.166"></a><span id="l6.166" class="difflineat">@@ -188,23 +189,23 @@ function richCreateMessage(fields, attac</span>
<a href="#l6.167"></a><span id="l6.167">   progress.registerListener(progressListener);</span>
<a href="#l6.168"></a><span id="l6.168">   msgCompose.SendMsg(Ci.nsIMsgSend.nsMsgSaveAsDraft, identity,</span>
<a href="#l6.169"></a><span id="l6.169">                      account ? account.key : &quot;&quot;, null,</span>
<a href="#l6.170"></a><span id="l6.170">                      progress);</span>
<a href="#l6.171"></a><span id="l6.171">   return promise;</span>
<a href="#l6.172"></a><span id="l6.172"> }</span>
<a href="#l6.173"></a><span id="l6.173"> </span>
<a href="#l6.174"></a><span id="l6.174"> function getAttachmentFromContent(aContent) {</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-  function getBoundaryStringFromContent(aContent) {</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+  function getBoundaryStringFromContent() {</span>
<a href="#l6.177"></a><span id="l6.177">     let found = aContent.match(/Content-Type: multipart\/mixed;\s+boundary=&quot;(.*?)&quot;/);</span>
<a href="#l6.178"></a><span id="l6.178">     Assert.notEqual(found, null);</span>
<a href="#l6.179"></a><span id="l6.179">     Assert.equal(found.length, 2);</span>
<a href="#l6.180"></a><span id="l6.180"> </span>
<a href="#l6.181"></a><span id="l6.181">     return found[1];</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-  };</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+  }</span>
<a href="#l6.184"></a><span id="l6.184"> </span>
<a href="#l6.185"></a><span id="l6.185">   let boundary = getBoundaryStringFromContent(aContent);</span>
<a href="#l6.186"></a><span id="l6.186">   let regex = new RegExp(&quot;\\r\\n\\r\\n--&quot; + boundary + &quot;\\r\\n&quot; +</span>
<a href="#l6.187"></a><span id="l6.187">                          &quot;([\\s\\S]*?)\\r\\n&quot; +</span>
<a href="#l6.188"></a><span id="l6.188">                          &quot;--&quot; + boundary + &quot;--&quot;, &quot;m&quot;);</span>
<a href="#l6.189"></a><span id="l6.189">   let attachments = aContent.match(regex);</span>
<a href="#l6.190"></a><span id="l6.190">   Assert.notEqual(attachments, null);</span>
<a href="#l6.191"></a><span id="l6.191">   Assert.equal(attachments.length, 2);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_attachment.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_attachment.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,25 +1,25 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.5"></a><span id="l7.5"> /*</span>
<a href="#l7.6"></a><span id="l7.6">  * Test suite for attachment file name.</span>
<a href="#l7.7"></a><span id="l7.7">  */</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-var input0 = &quot; !\&quot;#$%&amp;'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_&quot;+</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-    &quot;`abcdefghijklmnopqrstuvwxyz{|}~&quot;+</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-    &quot;\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf&quot;+</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    &quot;\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf&quot;+</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-    &quot;\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf&quot;+</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-    &quot;\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf&quot;+</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-    &quot;\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef&quot;+</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-    &quot;\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff.txt&quot;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+var input0 = &quot; !\&quot;#$%&amp;'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_&quot; +</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+    &quot;`abcdefghijklmnopqrstuvwxyz{|}~&quot; +</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+    &quot;\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf&quot; +</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+    &quot;\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf&quot; +</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+    &quot;\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf&quot; +</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+    &quot;\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf&quot; +</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+    &quot;\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef&quot; +</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+    &quot;\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff.txt&quot;;</span>
<a href="#l7.25"></a><span id="l7.25"> </span>
<a href="#l7.26"></a><span id="l7.26"> // ascii only</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-var input1 = &quot; !\&quot;#$%&amp;'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_&quot;+</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-    &quot;`abcdefghijklmnopqrstuvwxyz{|}~.txt&quot;</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+var input1 = &quot; !\&quot;#$%&amp;'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_&quot; +</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+    &quot;`abcdefghijklmnopqrstuvwxyz{|}~.txt&quot;;</span>
<a href="#l7.31"></a><span id="l7.31"> </span>
<a href="#l7.32"></a><span id="l7.32"> var expectedCD0 = [&quot;Content-Disposition: attachment;&quot;,</span>
<a href="#l7.33"></a><span id="l7.33">   &quot; filename*0*=UTF-8''%20%21%22%23%24%25%26%27%28%29%2A%2B%2C%2D%2E%2F%30%31;&quot;,</span>
<a href="#l7.34"></a><span id="l7.34">   &quot; filename*1*=%32%33%34%35%36%37%38%39%3A%3B%3C%3D%3E%3F%40%41%42%43%44%45;&quot;,</span>
<a href="#l7.35"></a><span id="l7.35">   &quot; filename*2*=%46%47%48%49%4A%4B%4C%4D%4E%4F%50%51%52%53%54%55%56%57%58%59;&quot;,</span>
<a href="#l7.36"></a><span id="l7.36">   &quot; filename*3*=%5A%5B%5C%5D%5E%5F%60%61%62%63%64%65%66%67%68%69%6A%6B%6C%6D;&quot;,</span>
<a href="#l7.37"></a><span id="l7.37">   &quot; filename*4*=%6E%6F%70%71%72%73%74%75%76%77%78%79%7A%7B%7C%7D%7E%C2%A0%C2;&quot;,</span>
<a href="#l7.38"></a><span id="l7.38">   &quot; filename*5*=%A1%C2%A2%C2%A3%C2%A4%C2%A5%C2%A6%C2%A7%C2%A8%C2%A9%C2%AA%C2;&quot;,</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineat">@@ -29,57 +29,57 @@ var expectedCD0 = [&quot;Content-Disposition:</span>
<a href="#l7.40"></a><span id="l7.40">   &quot; filename*9*=%89%C3%8A%C3%8B%C3%8C%C3%8D%C3%8E%C3%8F%C3%90%C3%91%C3%92%C3;&quot;,</span>
<a href="#l7.41"></a><span id="l7.41">   &quot; filename*10*=%93%C3%94%C3%95%C3%96%C3%97%C3%98%C3%99%C3%9A%C3%9B%C3%9C;&quot;,</span>
<a href="#l7.42"></a><span id="l7.42">   &quot; filename*11*=%C3%9D%C3%9E%C3%9F%C3%A0%C3%A1%C3%A2%C3%A3%C3%A4%C3%A5%C3;&quot;,</span>
<a href="#l7.43"></a><span id="l7.43">   &quot; filename*12*=%A6%C3%A7%C3%A8%C3%A9%C3%AA%C3%AB%C3%AC%C3%AD%C3%AE%C3%AF;&quot;,</span>
<a href="#l7.44"></a><span id="l7.44">   &quot; filename*13*=%C3%B0%C3%B1%C3%B2%C3%B3%C3%B4%C3%B5%C3%B6%C3%B7%C3%B8%C3;&quot;,</span>
<a href="#l7.45"></a><span id="l7.45">   &quot; filename*14*=%B9%C3%BA%C3%BB%C3%BC%C3%BD%C3%BE%C3%BF%2E%74%78%74&quot;,</span>
<a href="#l7.46"></a><span id="l7.46">   &quot;&quot;].join(&quot;\r\n&quot;);</span>
<a href="#l7.47"></a><span id="l7.47"> </span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-var expectedCD1 = &quot;Content-Disposition: attachment;\r\n&quot;+</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-    ' filename*0=&quot; !\\&quot;#$%&amp;\'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;;\r\n'+</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+var expectedCD1 = &quot;Content-Disposition: attachment;\r\n&quot; +</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+    ' filename*0=&quot; !\\&quot;#$%&amp;\'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;;\r\n' +</span>
<a href="#l7.52"></a><span id="l7.52">     ' filename*1=&quot;[\\\\]^_`abcdefghijklmnopqrstuvwxyz{|}~.txt&quot;\r\n';</span>
<a href="#l7.53"></a><span id="l7.53"> </span>
<a href="#l7.54"></a><span id="l7.54"> var ParamFoldingPref = {</span>
<a href="#l7.55"></a><span id="l7.55">   RFC2047: 0,</span>
<a href="#l7.56"></a><span id="l7.56">   RFC2047WithCRLF: 1,</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-  RFC2231: 2</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-}</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+  RFC2231: 2,</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+};</span>
<a href="#l7.61"></a><span id="l7.61"> </span>
<a href="#l7.62"></a><span id="l7.62"> var expectedCTList0 = {</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-  RFC2047: 'Content-Type: text/plain; charset=US-ASCII;\r\n'+</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-           ' name=&quot;=?UTF-8?B?ICEiIyQlJicoKSorLC0uLzAxMjM0NTY3ODk6Ozw9Pj9AQUJDREVGR0hJ?='+</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-           '=?UTF-8?Q?JKLMNOPQRSTUVWXYZ=5b=5c=5d=5e=5f=60abcdefghijklmnopqrstuvwx?='+</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-           '=?UTF-8?B?eXp7fH1+wqDCocKiwqPCpMKlwqbCp8KowqnCqsKrwqzCrcKuwq/CsMKx?='+</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-           '=?UTF-8?B?wrLCs8K0wrXCtsK3wrjCucK6wrvCvMK9wr7Cv8OAw4HDgsODw4TDhcOG?='+</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-           '=?UTF-8?B?w4fDiMOJw4rDi8OMw43DjsOPw5DDkcOSw5PDlMOVw5bDl8OYw5nDmsOb?='+</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-           '=?UTF-8?B?w5zDncOew5/DoMOhw6LDo8Okw6XDpsOnw6jDqcOqw6vDrMOtw67Dr8Ow?='+</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+  RFC2047: &quot;Content-Type: text/plain; charset=US-ASCII;\r\n&quot; +</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+           ' name=&quot;=?UTF-8?B?ICEiIyQlJicoKSorLC0uLzAxMjM0NTY3ODk6Ozw9Pj9AQUJDREVGR0hJ?=' +</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+           &quot;=?UTF-8?Q?JKLMNOPQRSTUVWXYZ=5b=5c=5d=5e=5f=60abcdefghijklmnopqrstuvwx?=&quot; +</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+           &quot;=?UTF-8?B?eXp7fH1+wqDCocKiwqPCpMKlwqbCp8KowqnCqsKrwqzCrcKuwq/CsMKx?=&quot; +</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+           &quot;=?UTF-8?B?wrLCs8K0wrXCtsK3wrjCucK6wrvCvMK9wr7Cv8OAw4HDgsODw4TDhcOG?=&quot; +</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+           &quot;=?UTF-8?B?w4fDiMOJw4rDi8OMw43DjsOPw5DDkcOSw5PDlMOVw5bDl8OYw5nDmsOb?=&quot; +</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+           &quot;=?UTF-8?B?w5zDncOew5/DoMOhw6LDo8Okw6XDpsOnw6jDqcOqw6vDrMOtw67Dr8Ow?=&quot; +</span>
<a href="#l7.77"></a><span id="l7.77">            '=?UTF-8?B?w7HDssOzw7TDtcO2w7fDuMO5w7rDu8O8w73DvsO/LnR4dA==?=&quot;\r\n',</span>
<a href="#l7.78"></a><span id="l7.78"> </span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-  RFC2047WithCRLF: 'Content-Type: text/plain; charset=US-ASCII;\r\n'+</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-                  ' name=&quot;=?UTF-8?B?ICEiIyQlJicoKSorLC0uLzAxMjM0NTY3ODk6Ozw9Pj9AQUJDREVGR0hJ?=\r\n'+</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-                  ' =?UTF-8?Q?JKLMNOPQRSTUVWXYZ=5b=5c=5d=5e=5f=60abcdefghijklmnopqrstuvwx?=\r\n'+</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-                  ' =?UTF-8?B?eXp7fH1+wqDCocKiwqPCpMKlwqbCp8KowqnCqsKrwqzCrcKuwq/CsMKx?=\r\n'+</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-                  ' =?UTF-8?B?wrLCs8K0wrXCtsK3wrjCucK6wrvCvMK9wr7Cv8OAw4HDgsODw4TDhcOG?=\r\n'+</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-                  ' =?UTF-8?B?w4fDiMOJw4rDi8OMw43DjsOPw5DDkcOSw5PDlMOVw5bDl8OYw5nDmsOb?=\r\n'+</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-                  ' =?UTF-8?B?w5zDncOew5/DoMOhw6LDo8Okw6XDpsOnw6jDqcOqw6vDrMOtw67Dr8Ow?=\r\n'+</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+  RFC2047WithCRLF: &quot;Content-Type: text/plain; charset=US-ASCII;\r\n&quot; +</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+                  ' name=&quot;=?UTF-8?B?ICEiIyQlJicoKSorLC0uLzAxMjM0NTY3ODk6Ozw9Pj9AQUJDREVGR0hJ?=\r\n' +</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+                  &quot; =?UTF-8?Q?JKLMNOPQRSTUVWXYZ=5b=5c=5d=5e=5f=60abcdefghijklmnopqrstuvwx?=\r\n&quot; +</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+                  &quot; =?UTF-8?B?eXp7fH1+wqDCocKiwqPCpMKlwqbCp8KowqnCqsKrwqzCrcKuwq/CsMKx?=\r\n&quot; +</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+                  &quot; =?UTF-8?B?wrLCs8K0wrXCtsK3wrjCucK6wrvCvMK9wr7Cv8OAw4HDgsODw4TDhcOG?=\r\n&quot; +</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+                  &quot; =?UTF-8?B?w4fDiMOJw4rDi8OMw43DjsOPw5DDkcOSw5PDlMOVw5bDl8OYw5nDmsOb?=\r\n&quot; +</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+                  &quot; =?UTF-8?B?w5zDncOew5/DoMOhw6LDo8Okw6XDpsOnw6jDqcOqw6vDrMOtw67Dr8Ow?=\r\n&quot; +</span>
<a href="#l7.93"></a><span id="l7.93">                   ' =?UTF-8?B?w7HDssOzw7TDtcO2w7fDuMO5w7rDu8O8w73DvsO/LnR4dA==?=&quot;\r\n',</span>
<a href="#l7.94"></a><span id="l7.94"> </span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-  RFC2231: 'Content-Type: text/plain; charset=US-ASCII\r\n'</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-}</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+  RFC2231: &quot;Content-Type: text/plain; charset=US-ASCII\r\n&quot;,</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+};</span>
<a href="#l7.99"></a><span id="l7.99"> </span>
<a href="#l7.100"></a><span id="l7.100"> var expectedCTList1 = {</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-  RFC2047: 'Content-Type: text/plain; charset=US-ASCII;\r\n'+</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+  RFC2047: &quot;Content-Type: text/plain; charset=US-ASCII;\r\n&quot; +</span>
<a href="#l7.103"></a><span id="l7.103">            ' name=&quot;!\\&quot;#$%&amp;\'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\\\]^_`abcdefghijklmnopqrstuvwxyz{|}~.txt&quot;\r\n',</span>
<a href="#l7.104"></a><span id="l7.104"> </span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-  RFC2047WithCRLF: 'Content-Type: text/plain; charset=US-ASCII;\r\n'+</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+  RFC2047WithCRLF: &quot;Content-Type: text/plain; charset=US-ASCII;\r\n&quot; +</span>
<a href="#l7.107"></a><span id="l7.107">                    ' name=&quot;!\\&quot;#$%&amp;\'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\\\]^_`abcdefghijklmnopqrstuvwxyz{|}~.txt&quot;\r\n',</span>
<a href="#l7.108"></a><span id="l7.108"> </span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-  RFC2231: 'Content-Type: text/plain; charset=US-ASCII\r\n'</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-}</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+  RFC2231: &quot;Content-Type: text/plain; charset=US-ASCII\r\n&quot;,</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+};</span>
<a href="#l7.113"></a><span id="l7.113"> </span>
<a href="#l7.114"></a><span id="l7.114"> function checkAttachment(expectedCD, expectedCT) {</span>
<a href="#l7.115"></a><span id="l7.115">   let msgData = mailTestUtils</span>
<a href="#l7.116"></a><span id="l7.116">     .loadMessageToString(gDraftFolder, mailTestUtils.firstMsgHdr(gDraftFolder));</span>
<a href="#l7.117"></a><span id="l7.117">   let pos = msgData.indexOf(&quot;Content-Disposition:&quot;);</span>
<a href="#l7.118"></a><span id="l7.118">   Assert.notEqual(pos, -1);</span>
<a href="#l7.119"></a><span id="l7.119">   let contentDisposition = msgData.substr(pos);</span>
<a href="#l7.120"></a><span id="l7.120">   pos = 0;</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineat">@@ -123,16 +123,16 @@ async function testInput1() {</span>
<a href="#l7.122"></a><span id="l7.122">     Services.prefs.setIntPref(&quot;mail.strictly_mime.parm_folding&quot;, ParamFoldingPref[folding]);</span>
<a href="#l7.123"></a><span id="l7.123">     await createMessage(input1);</span>
<a href="#l7.124"></a><span id="l7.124">     checkAttachment(expectedCD1, expectedCTList1[folding]);</span>
<a href="#l7.125"></a><span id="l7.125">   }</span>
<a href="#l7.126"></a><span id="l7.126"> }</span>
<a href="#l7.127"></a><span id="l7.127"> </span>
<a href="#l7.128"></a><span id="l7.128"> var tests = [</span>
<a href="#l7.129"></a><span id="l7.129">   testInput0,</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-  testInput1</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-]</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+  testInput1,</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+];</span>
<a href="#l7.134"></a><span id="l7.134"> </span>
<a href="#l7.135"></a><span id="l7.135"> function run_test() {</span>
<a href="#l7.136"></a><span id="l7.136">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l7.137"></a><span id="l7.137">   tests.forEach(x =&gt; add_task(x));</span>
<a href="#l7.138"></a><span id="l7.138">   run_next_test();</span>
<a href="#l7.139"></a><span id="l7.139"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_autoReply.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_autoReply.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -78,87 +78,83 @@ add_task(async function copy_gTemplateMa</span>
<a href="#l8.4"></a><span id="l8.4">   let promiseCopyListener = new PromiseTestUtils.PromiseCopyListener();</span>
<a href="#l8.5"></a><span id="l8.5">   // Copy gTemplateMailFile2 into the Templates folder.</span>
<a href="#l8.6"></a><span id="l8.6">   MailServices.copy.CopyFileMessage(gTemplateMailFile2,</span>
<a href="#l8.7"></a><span id="l8.7">     gTemplateFolder, null, true, 0, &quot;&quot;,</span>
<a href="#l8.8"></a><span id="l8.8">     promiseCopyListener, null);</span>
<a href="#l8.9"></a><span id="l8.9">   await promiseCopyListener.promise;</span>
<a href="#l8.10"></a><span id="l8.10"> });</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-/// Test that a reply is NOT sent when the message is not addressed to &quot;me&quot;.</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+// Test that a reply is NOT sent when the message is not addressed to &quot;me&quot;.</span>
<a href="#l8.14"></a><span id="l8.14"> add_task(function testReplyingToUnaddressedFails() {</span>
<a href="#l8.15"></a><span id="l8.15">   try {</span>
<a href="#l8.16"></a><span id="l8.16">     testReply(0); // mail 0 is not to us!</span>
<a href="#l8.17"></a><span id="l8.17">     do_throw(&quot;Replied to a message not addressed to us!&quot;);</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-  }</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-  catch (e) {</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+  } catch (e) {</span>
<a href="#l8.21"></a><span id="l8.21">     if (e.result != Cr.NS_ERROR_ABORT)</span>
<a href="#l8.22"></a><span id="l8.22">       throw e;</span>
<a href="#l8.23"></a><span id="l8.23">     // Ok! We didn't reply to the message not specifically addressed to</span>
<a href="#l8.24"></a><span id="l8.24">     // us (from@foo.invalid).</span>
<a href="#l8.25"></a><span id="l8.25">   }</span>
<a href="#l8.26"></a><span id="l8.26"> });</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-/// Test that a reply is sent when the message is addressed to &quot;me&quot;.</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+// Test that a reply is sent when the message is addressed to &quot;me&quot;.</span>
<a href="#l8.30"></a><span id="l8.30"> add_task(function testReplyingToAdressedWorksLatin1() {</span>
<a href="#l8.31"></a><span id="l8.31">   try {</span>
<a href="#l8.32"></a><span id="l8.32">     testReply(1); // mail 1 is addressed to us, using template-latin1</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-  }</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-  catch (e) {</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-    do_throw(&quot;Didn't reply properly to a message addressed to us! &quot;  + e);</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+  } catch (e) {</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+    do_throw(&quot;Didn't reply properly to a message addressed to us! &quot; + e);</span>
<a href="#l8.38"></a><span id="l8.38">   }</span>
<a href="#l8.39"></a><span id="l8.39"> });</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-/// Test that a reply is sent when the message is addressed to &quot;me&quot;.</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+// Test that a reply is sent when the message is addressed to &quot;me&quot;.</span>
<a href="#l8.43"></a><span id="l8.43"> add_task(function testReplyingToAdressedWorksUTF8() {</span>
<a href="#l8.44"></a><span id="l8.44">   try {</span>
<a href="#l8.45"></a><span id="l8.45">     testReply(1, 1); // mail 1 is addressed to us, template-utf8</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-  }</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-  catch (e) {</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-    do_throw(&quot;Didn't reply properly to a message addressed to us! &quot;  + e);</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  } catch (e) {</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+    do_throw(&quot;Didn't reply properly to a message addressed to us! &quot; + e);</span>
<a href="#l8.51"></a><span id="l8.51">   }</span>
<a href="#l8.52"></a><span id="l8.52"> });</span>
<a href="#l8.53"></a><span id="l8.53"> </span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-/// Test that a reply is NOT even tried when the message has no From.</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+// Test that a reply is NOT even tried when the message has no From.</span>
<a href="#l8.56"></a><span id="l8.56"> add_task(function testReplyingToMailWithNoFrom() {</span>
<a href="#l8.57"></a><span id="l8.57">   try {</span>
<a href="#l8.58"></a><span id="l8.58">     testReply(2); // mail 2 has no From</span>
<a href="#l8.59"></a><span id="l8.59">     do_throw(&quot;Shouldn't even have tried to reply reply to the message &quot; +</span>
<a href="#l8.60"></a><span id="l8.60">              &quot;with no From and no Reply-To&quot;);</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-  }</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-  catch (e) {</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+  } catch (e) {</span>
<a href="#l8.64"></a><span id="l8.64">     if (e.result != Cr.NS_ERROR_FAILURE)</span>
<a href="#l8.65"></a><span id="l8.65">       throw e;</span>
<a href="#l8.66"></a><span id="l8.66">   }</span>
<a href="#l8.67"></a><span id="l8.67"> });</span>
<a href="#l8.68"></a><span id="l8.68"> </span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-/// Test reply with template.</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+// Test reply with template.</span>
<a href="#l8.71"></a><span id="l8.71"> function testReply(aHrdIdx, aTemplateHdrIdx = 0) {</span>
<a href="#l8.72"></a><span id="l8.72">   let smtpServer = getBasicSmtpServer();</span>
<a href="#l8.73"></a><span id="l8.73">   smtpServer.port = gServer.port;</span>
<a href="#l8.74"></a><span id="l8.74"> </span>
<a href="#l8.75"></a><span id="l8.75">   let identity = getSmtpIdentity(kSender, smtpServer);</span>
<a href="#l8.76"></a><span id="l8.76">   localAccountUtils.msgAccount.addIdentity(identity);</span>
<a href="#l8.77"></a><span id="l8.77"> </span>
<a href="#l8.78"></a><span id="l8.78">   let msgHdr = mailTestUtils.getMsgHdrN(localAccountUtils.inboxFolder, aHrdIdx);</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-  info(&quot;Msg#&quot; + aHrdIdx +  &quot; author=&quot; + msgHdr.author + &quot;, recipients=&quot; +</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+  info(&quot;Msg#&quot; + aHrdIdx + &quot; author=&quot; + msgHdr.author + &quot;, recipients=&quot; +</span>
<a href="#l8.81"></a><span id="l8.81">        msgHdr.recipients);</span>
<a href="#l8.82"></a><span id="l8.82">   let templateHdr = mailTestUtils.getMsgHdrN(gTemplateFolder, aTemplateHdrIdx);</span>
<a href="#l8.83"></a><span id="l8.83"> </span>
<a href="#l8.84"></a><span id="l8.84">   // See &lt;method name=&quot;getTemplates&quot;&gt; in searchWidgets.xml</span>
<a href="#l8.85"></a><span id="l8.85">   let msgTemplateUri = gTemplateFolder.URI +</span>
<a href="#l8.86"></a><span id="l8.86">                        &quot;?messageId=&quot; + templateHdr.messageId +</span>
<a href="#l8.87"></a><span id="l8.87">                        &quot;&amp;subject=&quot; + templateHdr.mime2DecodedSubject;</span>
<a href="#l8.88"></a><span id="l8.88">   MailServices.compose.replyWithTemplate(msgHdr, msgTemplateUri, null,</span>
<a href="#l8.89"></a><span id="l8.89">     localAccountUtils.incomingServer);</span>
<a href="#l8.90"></a><span id="l8.90">   gServer.performTest();</span>
<a href="#l8.91"></a><span id="l8.91"> </span>
<a href="#l8.92"></a><span id="l8.92">   let headers, body;</span>
<a href="#l8.93"></a><span id="l8.93">   [headers, body] = MimeParser.extractHeadersAndBody(gServer._daemon.post);</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-  //dump(&quot;xxxmagnus gServer._daemon.post=&quot; + gServer._daemon.post + &quot;\n&quot;);</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+  // dump(&quot;xxxmagnus gServer._daemon.post=&quot; + gServer._daemon.post + &quot;\n&quot;);</span>
<a href="#l8.96"></a><span id="l8.96">   Assert.ok(headers.get(&quot;Subject&quot;).startsWith(&quot;Auto: &quot;));</span>
<a href="#l8.97"></a><span id="l8.97">   Assert.equal(headers.get(&quot;Auto-submitted&quot;), &quot;auto-replied&quot;);</span>
<a href="#l8.98"></a><span id="l8.98">   Assert.equal(headers.get(&quot;In-Reply-To&quot;), &quot;&lt;&quot; + msgHdr.messageId + &quot;&gt;&quot;);</span>
<a href="#l8.99"></a><span id="l8.99">   Assert.equal(headers.get(&quot;References&quot;), &quot;&lt;&quot; + msgHdr.messageId + &quot;&gt;&quot;);</span>
<a href="#l8.100"></a><span id="l8.100">   // XXX: something's wrong with how the fake server gets the data.</span>
<a href="#l8.101"></a><span id="l8.101">   // The text gets converted to UTF-8 (regardless of what it is) at some point.</span>
<a href="#l8.102"></a><span id="l8.102">   // Suspect a bug with how BinaryInputStream handles the strings.</span>
<a href="#l8.103"></a><span id="l8.103">   if (templateHdr.Charset == &quot;windows-1252&quot;) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_bug155172.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_bug155172.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,20 +1,23 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l9.5"></a><span id="l9.5"> /**</span>
<a href="#l9.6"></a><span id="l9.6">  * Authentication tests for SMTP.</span>
<a href="#l9.7"></a><span id="l9.7">  */</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+/* import-globals-from ../../../test/resources/passwordStorage.js */</span>
<a href="#l9.11"></a><span id="l9.11"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l9.12"></a><span id="l9.12"> load(&quot;../../../resources/passwordStorage.js&quot;);</span>
<a href="#l9.13"></a><span id="l9.13"> </span>
<a href="#l9.14"></a><span id="l9.14"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l9.15"></a><span id="l9.15"> </span>
<a href="#l9.16"></a><span id="l9.16"> var gNewPassword = null;</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+/* exported confirmEx, promptPasswordPS */// for alertTestUtils.js</span>
<a href="#l9.19"></a><span id="l9.19"> function confirmEx(aDialogTitle, aText, aButtonFlags, aButton0Title,</span>
<a href="#l9.20"></a><span id="l9.20">                    aButton1Title, aButton2Title, aCheckMsg, aCheckState) {</span>
<a href="#l9.21"></a><span id="l9.21">   // Just return 2 which will is pressing button 2 - enter a new password.</span>
<a href="#l9.22"></a><span id="l9.22">   return 2;</span>
<a href="#l9.23"></a><span id="l9.23"> }</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25"> function promptPasswordPS(aParent, aDialogTitle, aText, aPassword,</span>
<a href="#l9.26"></a><span id="l9.26">                           aCheckMsg, aCheckState) {</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineat">@@ -28,17 +31,17 @@ var kIdentityMail = &quot;identity@foo.invali</span>
<a href="#l9.28"></a><span id="l9.28"> var kSender = &quot;from@foo.invalid&quot;;</span>
<a href="#l9.29"></a><span id="l9.29"> var kTo = &quot;to@foo.invalid&quot;;</span>
<a href="#l9.30"></a><span id="l9.30"> var kUsername = &quot;test.smtp@fakeserver&quot;;</span>
<a href="#l9.31"></a><span id="l9.31"> // kPasswordSaved is the one defined in signons-smtp.json, the other one</span>
<a href="#l9.32"></a><span id="l9.32"> // is intentionally wrong.</span>
<a href="#l9.33"></a><span id="l9.33"> var kPasswordWrong = &quot;wrong&quot;;</span>
<a href="#l9.34"></a><span id="l9.34"> var kPasswordSaved = &quot;smtptest&quot;;</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-add_task(async function () {</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+add_task(async function() {</span>
<a href="#l9.38"></a><span id="l9.38">   registerAlertTestUtils();</span>
<a href="#l9.39"></a><span id="l9.39"> </span>
<a href="#l9.40"></a><span id="l9.40">   function createHandler(d) {</span>
<a href="#l9.41"></a><span id="l9.41">     var handler = new SMTP_RFC2821_handler(d);</span>
<a href="#l9.42"></a><span id="l9.42">     // Username needs to match the login information stored in the signons json</span>
<a href="#l9.43"></a><span id="l9.43">     // file.</span>
<a href="#l9.44"></a><span id="l9.44">     handler.kUsername = kUsername;</span>
<a href="#l9.45"></a><span id="l9.45">     handler.kPassword = kPasswordWrong;</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineat">@@ -86,23 +89,18 @@ add_task(async function () {</span>
<a href="#l9.47"></a><span id="l9.47">     var transaction = server.playTransaction();</span>
<a href="#l9.48"></a><span id="l9.48">     do_check_transaction(transaction, [&quot;EHLO test&quot;,</span>
<a href="#l9.49"></a><span id="l9.49">                                        &quot;AUTH PLAIN &quot; + AuthPLAIN.encodeLine(kUsername, kPasswordSaved),</span>
<a href="#l9.50"></a><span id="l9.50">                                        &quot;AUTH LOGIN&quot;,</span>
<a href="#l9.51"></a><span id="l9.51">                                        &quot;AUTH PLAIN &quot; + AuthPLAIN.encodeLine(kUsername, kPasswordWrong),</span>
<a href="#l9.52"></a><span id="l9.52">                                        &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; BODY=8BITMIME SIZE=159&quot;,</span>
<a href="#l9.53"></a><span id="l9.53">                                        &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l9.54"></a><span id="l9.54">                                        &quot;DATA&quot;]);</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-</span>
<a href="#l9.56"></a><span id="l9.56">   } catch (e) {</span>
<a href="#l9.57"></a><span id="l9.57">     do_throw(e);</span>
<a href="#l9.58"></a><span id="l9.58">   } finally {</span>
<a href="#l9.59"></a><span id="l9.59">     server.stop();</span>
<a href="#l9.60"></a><span id="l9.60"> </span>
<a href="#l9.61"></a><span id="l9.61">     var thread = gThreadManager.currentThread;</span>
<a href="#l9.62"></a><span id="l9.62">     while (thread.hasPendingEvents())</span>
<a href="#l9.63"></a><span id="l9.63">       thread.processNextEvent(true);</span>
<a href="#l9.64"></a><span id="l9.64">   }</span>
<a href="#l9.65"></a><span id="l9.65"> });</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-function run_test() {</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-  run_next_test();</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_bug235432.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_bug235432.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -10,37 +10,36 @@ var testmail = do_get_file(&quot;data/message</span>
<a href="#l10.4"></a><span id="l10.4"> var expectedTemporaryFile;</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> var kSender = &quot;from@foo.invalid&quot;;</span>
<a href="#l10.7"></a><span id="l10.7"> var kTo = &quot;to@foo.invalid&quot;;</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> var msgSend = Cc[&quot;@mozilla.org/messengercompose/send;1&quot;]</span>
<a href="#l10.10"></a><span id="l10.10">                 .createInstance(Ci.nsIMsgSend);</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-var gCopyListener =</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-{</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+var gCopyListener = {</span>
<a href="#l10.15"></a><span id="l10.15">   callbackFunction: null,</span>
<a href="#l10.16"></a><span id="l10.16">   copiedMessageHeaderKeys: [],</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-  SetMessageKey: function(aKey) {</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+  SetMessageKey(aKey) {</span>
<a href="#l10.23"></a><span id="l10.23">     try {</span>
<a href="#l10.24"></a><span id="l10.24">       this.copiedMessageHeaderKeys.push(aKey);</span>
<a href="#l10.25"></a><span id="l10.25">     } catch (ex) {</span>
<a href="#l10.26"></a><span id="l10.26">       dump(ex);</span>
<a href="#l10.27"></a><span id="l10.27">     }</span>
<a href="#l10.28"></a><span id="l10.28">   },</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-  GetMessageId: function(aMessageId) {},</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-  OnStopCopy: function(aStatus) {</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+  GetMessageId(aMessageId) {},</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l10.33"></a><span id="l10.33">     if (this.callbackFunction) {</span>
<a href="#l10.34"></a><span id="l10.34">       mailTestUtils.do_timeout_function(0, this.callbackFunction,</span>
<a href="#l10.35"></a><span id="l10.35">                                         null,</span>
<a href="#l10.36"></a><span id="l10.36">                                         [ this.copiedMessageHeaderKeys, aStatus ]);</span>
<a href="#l10.37"></a><span id="l10.37">     }</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-  }</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+  },</span>
<a href="#l10.40"></a><span id="l10.40"> };</span>
<a href="#l10.41"></a><span id="l10.41"> </span>
<a href="#l10.42"></a><span id="l10.42"> /**</span>
<a href="#l10.43"></a><span id="l10.43">  * copyFileMessageInLocalFolder</span>
<a href="#l10.44"></a><span id="l10.44">  * A utility wrapper of nsIMsgCopyService.CopyFileMessage to copy a message</span>
<a href="#l10.45"></a><span id="l10.45">  * into local inbox folder.</span>
<a href="#l10.46"></a><span id="l10.46">  *</span>
<a href="#l10.47"></a><span id="l10.47">  * @param aMessageFile     An instance of nsIFile to copy.</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineat">@@ -87,16 +86,17 @@ function createExpectedTemporaryFile() {</span>
<a href="#l10.49"></a><span id="l10.49">   });</span>
<a href="#l10.50"></a><span id="l10.50"> </span>
<a href="#l10.51"></a><span id="l10.51">   let expectedFile = createTemporaryFile();</span>
<a href="#l10.52"></a><span id="l10.52">   expectedFile.remove(false);</span>
<a href="#l10.53"></a><span id="l10.53"> </span>
<a href="#l10.54"></a><span id="l10.54">   return expectedFile;</span>
<a href="#l10.55"></a><span id="l10.55"> }</span>
<a href="#l10.56"></a><span id="l10.56"> </span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+/* exported OnStopCopy */// for head_compose.js</span>
<a href="#l10.58"></a><span id="l10.58"> function OnStopCopy(aStatus) {</span>
<a href="#l10.59"></a><span id="l10.59">   msgSend.abort();</span>
<a href="#l10.60"></a><span id="l10.60"> </span>
<a href="#l10.61"></a><span id="l10.61">   Assert.ok(!expectedTemporaryFile.exists());</span>
<a href="#l10.62"></a><span id="l10.62"> </span>
<a href="#l10.63"></a><span id="l10.63">   do_test_finished();</span>
<a href="#l10.64"></a><span id="l10.64"> }</span>
<a href="#l10.65"></a><span id="l10.65"> </span>
<a href="#l10.66"></a><span id="l10.66" class="difflineat">@@ -106,46 +106,45 @@ function run_test() {</span>
<a href="#l10.67"></a><span id="l10.67"> }</span>
<a href="#l10.68"></a><span id="l10.68"> </span>
<a href="#l10.69"></a><span id="l10.69"> function send_message_later(aMessageHeaderKeys, aStatus) {</span>
<a href="#l10.70"></a><span id="l10.70">   let compFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l10.71"></a><span id="l10.71">                      .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l10.72"></a><span id="l10.72">   let params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l10.73"></a><span id="l10.73">                  .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l10.74"></a><span id="l10.74">   params.composeFields = compFields;</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-  let msgCompose = MailServices.compose.initCompose(params);</span>
<a href="#l10.76"></a><span id="l10.76">   localAccountUtils.rootFolder.createLocalSubfolder(&quot;Drafts&quot;);</span>
<a href="#l10.77"></a><span id="l10.77"> </span>
<a href="#l10.78"></a><span id="l10.78">   let smtpServer = getBasicSmtpServer();</span>
<a href="#l10.79"></a><span id="l10.79">   let identity = getSmtpIdentity(kSender, smtpServer);</span>
<a href="#l10.80"></a><span id="l10.80"> </span>
<a href="#l10.81"></a><span id="l10.81">   compFields.from = identity.email;</span>
<a href="#l10.82"></a><span id="l10.82">   compFields.to = kTo;</span>
<a href="#l10.83"></a><span id="l10.83"> </span>
<a href="#l10.84"></a><span id="l10.84">   let msgHdr = localAccountUtils.inboxFolder.GetMessageHeader(aMessageHeaderKeys[0]);</span>
<a href="#l10.85"></a><span id="l10.85">   let messageUri = localAccountUtils.inboxFolder.getUriForMsg(msgHdr);</span>
<a href="#l10.86"></a><span id="l10.86"> </span>
<a href="#l10.87"></a><span id="l10.87">   let attachment = Cc[&quot;@mozilla.org/messengercompose/attachment;1&quot;]</span>
<a href="#l10.88"></a><span id="l10.88">                      .createInstance(Ci.nsIMsgAttachment);</span>
<a href="#l10.89"></a><span id="l10.89">   attachment.url = messageUri;</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-  attachment.contentType = 'message/rfc822';</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-  attachment.name = 'Attachment e-mail';</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+  attachment.contentType = &quot;message/rfc822&quot;;</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+  attachment.name = &quot;Attachment e-mail&quot;;</span>
<a href="#l10.94"></a><span id="l10.94">   compFields.addAttachment(attachment);</span>
<a href="#l10.95"></a><span id="l10.95"> </span>
<a href="#l10.96"></a><span id="l10.96">   expectedTemporaryFile = createExpectedTemporaryFile();</span>
<a href="#l10.97"></a><span id="l10.97">   msgSend.createAndSendMessage(null,</span>
<a href="#l10.98"></a><span id="l10.98">                                identity,</span>
<a href="#l10.99"></a><span id="l10.99">                                &quot;&quot;,</span>
<a href="#l10.100"></a><span id="l10.100">                                compFields,</span>
<a href="#l10.101"></a><span id="l10.101">                                false,</span>
<a href="#l10.102"></a><span id="l10.102">                                false,</span>
<a href="#l10.103"></a><span id="l10.103">                                Ci.nsIMsgSend.nsMsgQueueForLater,</span>
<a href="#l10.104"></a><span id="l10.104">                                null,</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-                               'text/plain',</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-                               'bodyText\n',</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+                               &quot;text/plain&quot;,</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+                               &quot;bodyText\n&quot;,</span>
<a href="#l10.109"></a><span id="l10.109">                                null,</span>
<a href="#l10.110"></a><span id="l10.110">                                null,</span>
<a href="#l10.111"></a><span id="l10.111">                                null,</span>
<a href="#l10.112"></a><span id="l10.112">                                null,</span>
<a href="#l10.113"></a><span id="l10.113">                                copyListener,</span>
<a href="#l10.114"></a><span id="l10.114">                                null,</span>
<a href="#l10.115"></a><span id="l10.115">                                &quot;&quot;,</span>
<a href="#l10.116"></a><span id="l10.116">                                Ci.nsIMsgCompType.New);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_bug474774.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_bug474774.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,21 +1,18 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l11.5"></a><span id="l11.5"> /**</span>
<a href="#l11.6"></a><span id="l11.6">  * Tests bug 474774 - assertions when saving send later and when sending with</span>
<a href="#l11.7"></a><span id="l11.7">  * FCC switched off.</span>
<a href="#l11.8"></a><span id="l11.8">  */</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-var type = null;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-var test = null;</span>
<a href="#l11.14"></a><span id="l11.14"> var server;</span>
<a href="#l11.15"></a><span id="l11.15"> var smtpServer;</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-var sentFolder;</span>
<a href="#l11.17"></a><span id="l11.17"> var originalData;</span>
<a href="#l11.18"></a><span id="l11.18"> var finished = false;</span>
<a href="#l11.19"></a><span id="l11.19"> var identity = null;</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21"> var testFile = do_get_file(&quot;data/429891_testcase.eml&quot;);</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23"> var kTestFileSender = &quot;from_A@foo.invalid&quot;;</span>
<a href="#l11.24"></a><span id="l11.24"> var kTestFileRecipient = &quot;to_A@foo.invalid&quot;;</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineat">@@ -29,32 +26,30 @@ var msgSendLater = Cc[&quot;@mozilla.org/mess</span>
<a href="#l11.26"></a><span id="l11.26"> // sequence and ensures the data is correct.</span>
<a href="#l11.27"></a><span id="l11.27"> function msll() {</span>
<a href="#l11.28"></a><span id="l11.28"> }</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30"> msll.prototype = {</span>
<a href="#l11.31"></a><span id="l11.31">   _initialTotal: 0,</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33">   // nsIMsgSendLaterListener</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-  onStartSending: function (aTotalMessageCount) {</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+  onStartSending(aTotalMessageCount) {</span>
<a href="#l11.36"></a><span id="l11.36">     this._initialTotal = 1;</span>
<a href="#l11.37"></a><span id="l11.37">     Assert.equal(msgSendLater.sendingMessages, true);</span>
<a href="#l11.38"></a><span id="l11.38">   },</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-  onMessageStartSending: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-                                   aMessageHeader, aIdentity) {</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+  onMessageStartSending(aCurrentMessage, aTotalMessageCount, aMessageHeader, aIdentity) {</span>
<a href="#l11.42"></a><span id="l11.42">   },</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-  onMessageSendProgress: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-                                   aMessageSendPercent, aMessageCopyPercent) {</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+  onMessageSendProgress(aCurrentMessage, aTotalMessageCount,</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+                        aMessageSendPercent, aMessageCopyPercent) {</span>
<a href="#l11.47"></a><span id="l11.47">     // XXX Enable this function</span>
<a href="#l11.48"></a><span id="l11.48">   },</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-  onMessageSendError: function (aCurrentMessage, aMessageHeader, aStatus,</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-                                aMsg) {</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+  onMessageSendError(aCurrentMessage, aMessageHeader, aStatus, aMsg) {</span>
<a href="#l11.52"></a><span id="l11.52">     do_throw(&quot;onMessageSendError should not have been called, status: &quot; + aStatus);</span>
<a href="#l11.53"></a><span id="l11.53">   },</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-  onStopSending: function (aStatus, aMsg, aTotalTried, aSuccessful) {</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+  onStopSending(aStatus, aMsg, aTotalTried, aSuccessful) {</span>
<a href="#l11.56"></a><span id="l11.56">     print(&quot;msll onStopSending\n&quot;);</span>
<a href="#l11.57"></a><span id="l11.57">     try {</span>
<a href="#l11.58"></a><span id="l11.58">       Assert.equal(aSuccessful, 1);</span>
<a href="#l11.59"></a><span id="l11.59">       Assert.equal(aStatus, 0);</span>
<a href="#l11.60"></a><span id="l11.60">       Assert.equal(aTotalTried, 1);</span>
<a href="#l11.61"></a><span id="l11.61">       Assert.equal(this._initialTotal, 1);</span>
<a href="#l11.62"></a><span id="l11.62">       Assert.equal(msgSendLater.sendingMessages, false);</span>
<a href="#l11.63"></a><span id="l11.63"> </span>
<a href="#l11.64"></a><span id="l11.64" class="difflineat">@@ -75,21 +70,21 @@ msll.prototype = {</span>
<a href="#l11.65"></a><span id="l11.65">     } finally {</span>
<a href="#l11.66"></a><span id="l11.66">       server.stop();</span>
<a href="#l11.67"></a><span id="l11.67"> </span>
<a href="#l11.68"></a><span id="l11.68">       var thread = gThreadManager.currentThread;</span>
<a href="#l11.69"></a><span id="l11.69">       while (thread.hasPendingEvents())</span>
<a href="#l11.70"></a><span id="l11.70">         thread.processNextEvent(true);</span>
<a href="#l11.71"></a><span id="l11.71">     }</span>
<a href="#l11.72"></a><span id="l11.72">     do_test_finished();</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-  }</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+  },</span>
<a href="#l11.75"></a><span id="l11.75"> };</span>
<a href="#l11.76"></a><span id="l11.76"> </span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-function OnStopCopy(aStatus)</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-{</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+/* exported OnStopCopy */// for head_compose.js</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+function OnStopCopy(aStatus) {</span>
<a href="#l11.81"></a><span id="l11.81">   do_test_finished();</span>
<a href="#l11.82"></a><span id="l11.82"> </span>
<a href="#l11.83"></a><span id="l11.83">   try {</span>
<a href="#l11.84"></a><span id="l11.84">     Assert.equal(aStatus, 0);</span>
<a href="#l11.85"></a><span id="l11.85"> </span>
<a href="#l11.86"></a><span id="l11.86">     // Check this is false before we start sending</span>
<a href="#l11.87"></a><span id="l11.87">     Assert.equal(msgSendLater.sendingMessages, false);</span>
<a href="#l11.88"></a><span id="l11.88"> </span>
<a href="#l11.89"></a><span id="l11.89" class="difflineat">@@ -122,25 +117,22 @@ function OnStopCopy(aStatus)</span>
<a href="#l11.90"></a><span id="l11.90">     while (thread.hasPendingEvents())</span>
<a href="#l11.91"></a><span id="l11.91">       thread.processNextEvent(true);</span>
<a href="#l11.92"></a><span id="l11.92"> </span>
<a href="#l11.93"></a><span id="l11.93">     finished = true;</span>
<a href="#l11.94"></a><span id="l11.94">   }</span>
<a href="#l11.95"></a><span id="l11.95"> }</span>
<a href="#l11.96"></a><span id="l11.96"> </span>
<a href="#l11.97"></a><span id="l11.97"> // This function does the actual send later</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-function sendMessageLater()</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-{</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+function sendMessageLater() {</span>
<a href="#l11.101"></a><span id="l11.101">   do_test_finished();</span>
<a href="#l11.102"></a><span id="l11.102"> </span>
<a href="#l11.103"></a><span id="l11.103">   // Set up the SMTP server.</span>
<a href="#l11.104"></a><span id="l11.104">   server = setupServerDaemon();</span>
<a href="#l11.105"></a><span id="l11.105"> </span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-  type = &quot;sendMessageLater&quot;;</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-</span>
<a href="#l11.108"></a><span id="l11.108">   // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l11.109"></a><span id="l11.109">   // the server if something fails.</span>
<a href="#l11.110"></a><span id="l11.110">   try {</span>
<a href="#l11.111"></a><span id="l11.111">     // Start the fake SMTP server</span>
<a href="#l11.112"></a><span id="l11.112">     server.start();</span>
<a href="#l11.113"></a><span id="l11.113">     smtpServer.port = server.port;</span>
<a href="#l11.114"></a><span id="l11.114"> </span>
<a href="#l11.115"></a><span id="l11.115">     // A test to check that we are sending files correctly, including checking</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineat">@@ -151,22 +143,22 @@ function sendMessageLater()</span>
<a href="#l11.117"></a><span id="l11.117"> </span>
<a href="#l11.118"></a><span id="l11.118">     msgSendLater.addListener(messageListener);</span>
<a href="#l11.119"></a><span id="l11.119"> </span>
<a href="#l11.120"></a><span id="l11.120">     // Send the unsent message</span>
<a href="#l11.121"></a><span id="l11.121">     msgSendLater.sendUnsentMessages(identity);</span>
<a href="#l11.122"></a><span id="l11.122"> </span>
<a href="#l11.123"></a><span id="l11.123">     server.performTest();</span>
<a href="#l11.124"></a><span id="l11.124"> </span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-    do_timeout(10000, function()</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-        {if (!finished) do_throw('Notifications of message send/copy not received');}</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-      );</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+    do_timeout(10000, function() {</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+      if (!finished)</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+        do_throw(&quot;Notifications of message send/copy not received&quot;);</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+    });</span>
<a href="#l11.132"></a><span id="l11.132"> </span>
<a href="#l11.133"></a><span id="l11.133">     do_test_pending();</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-</span>
<a href="#l11.135"></a><span id="l11.135">   } catch (e) {</span>
<a href="#l11.136"></a><span id="l11.136">     do_throw(e);</span>
<a href="#l11.137"></a><span id="l11.137">   } finally {</span>
<a href="#l11.138"></a><span id="l11.138">     server.stop();</span>
<a href="#l11.139"></a><span id="l11.139"> </span>
<a href="#l11.140"></a><span id="l11.140">     var thread = gThreadManager.currentThread;</span>
<a href="#l11.141"></a><span id="l11.141">     while (thread.hasPendingEvents())</span>
<a href="#l11.142"></a><span id="l11.142">       thread.processNextEvent(true);</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineat">@@ -189,17 +181,17 @@ function run_test() {</span>
<a href="#l11.144"></a><span id="l11.144">   smtpServer = getBasicSmtpServer(0);</span>
<a href="#l11.145"></a><span id="l11.145">   identity = getSmtpIdentity(kIdentityMail, smtpServer);</span>
<a href="#l11.146"></a><span id="l11.146"> </span>
<a href="#l11.147"></a><span id="l11.147">   account.addIdentity(identity);</span>
<a href="#l11.148"></a><span id="l11.148">   account.defaultIdentity = identity;</span>
<a href="#l11.149"></a><span id="l11.149">   account.incomingServer = incomingServer;</span>
<a href="#l11.150"></a><span id="l11.150">   MailServices.accounts.defaultAccount = account;</span>
<a href="#l11.151"></a><span id="l11.151"> </span>
<a href="#l11.152"></a><span id="l11.152" class="difflineminus">-  sentFolder = localAccountUtils.rootFolder.createLocalSubfolder(&quot;Sent&quot;);</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+  localAccountUtils.rootFolder.createLocalSubfolder(&quot;Sent&quot;);</span>
<a href="#l11.154"></a><span id="l11.154"> </span>
<a href="#l11.155"></a><span id="l11.155">   identity.doFcc = false;</span>
<a href="#l11.156"></a><span id="l11.156"> </span>
<a href="#l11.157"></a><span id="l11.157">   // Now prepare to actually &quot;send&quot; the message later, i.e. dump it in the</span>
<a href="#l11.158"></a><span id="l11.158">   // unsent messages folder.</span>
<a href="#l11.159"></a><span id="l11.159"> </span>
<a href="#l11.160"></a><span id="l11.160">   var compFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l11.161"></a><span id="l11.161">                      .createInstance(Ci.nsIMsgCompFields);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_detectAttachmentCharset.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_detectAttachmentCharset.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,15 +1,14 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l12.5"></a><span id="l12.5"> /*</span>
<a href="#l12.6"></a><span id="l12.6">  * Test suite for auto-detecting attachment file charset.</span>
<a href="#l12.7"></a><span id="l12.7">  */</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12"> function checkAttachmentCharset(expectedCharset) {</span>
<a href="#l12.13"></a><span id="l12.13">   let msgData = mailTestUtils</span>
<a href="#l12.14"></a><span id="l12.14">     .loadMessageToString(gDraftFolder, mailTestUtils.firstMsgHdr(gDraftFolder));</span>
<a href="#l12.15"></a><span id="l12.15">   let attachmentData = getAttachmentFromContent(msgData);</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17">   Assert.equal(expectedCharset, getContentCharset(attachmentData));</span>
<a href="#l12.18"></a><span id="l12.18"> }</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineat">@@ -64,18 +63,18 @@ async function testWindows1252() {</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21"> var tests = [</span>
<a href="#l12.22"></a><span id="l12.22">   testUTF8,</span>
<a href="#l12.23"></a><span id="l12.23">   testUTF16BE,</span>
<a href="#l12.24"></a><span id="l12.24">   testUTF16LE,</span>
<a href="#l12.25"></a><span id="l12.25">   testShiftJIS,</span>
<a href="#l12.26"></a><span id="l12.26">   testISO2022JP,</span>
<a href="#l12.27"></a><span id="l12.27">   testKOI8R,</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-  testWindows1252</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-]</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+  testWindows1252,</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+];</span>
<a href="#l12.32"></a><span id="l12.32"> </span>
<a href="#l12.33"></a><span id="l12.33"> function run_test() {</span>
<a href="#l12.34"></a><span id="l12.34">   // Ensure we have at least one mail account</span>
<a href="#l12.35"></a><span id="l12.35">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l12.36"></a><span id="l12.36">   Services.prefs.setIntPref(&quot;mail.strictly_mime.parm_folding&quot;, 0);</span>
<a href="#l12.37"></a><span id="l12.37"> </span>
<a href="#l12.38"></a><span id="l12.38">   tests.forEach(x =&gt; add_task(x));</span>
<a href="#l12.39"></a><span id="l12.39">   run_next_test();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_expandMailingLists.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_expandMailingLists.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -6,26 +6,24 @@</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> var MsgComposeContractID = &quot;@mozilla.org/messengercompose/compose;1&quot;;</span>
<a href="#l13.6"></a><span id="l13.6"> var MsgComposeParamsContractID = &quot;@mozilla.org/messengercompose/composeparams;1&quot;;</span>
<a href="#l13.7"></a><span id="l13.7"> var MsgComposeFieldsContractID = &quot;@mozilla.org/messengercompose/composefields;1&quot;;</span>
<a href="#l13.8"></a><span id="l13.8"> var nsIMsgCompose = Ci.nsIMsgCompose;</span>
<a href="#l13.9"></a><span id="l13.9"> var nsIMsgComposeParams = Ci.nsIMsgComposeParams;</span>
<a href="#l13.10"></a><span id="l13.10"> var nsIMsgCompFields = Ci.nsIMsgCompFields;</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l13.13"></a><span id="l13.13"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l13.14"></a><span id="l13.14"> </span>
<a href="#l13.15"></a><span id="l13.15"> /**</span>
<a href="#l13.16"></a><span id="l13.16">  * Helper to check population worked as expected.</span>
<a href="#l13.17"></a><span id="l13.17">  * @param aTo - text in the To field</span>
<a href="#l13.18"></a><span id="l13.18">  * @param aCheckTo - the expected To addresses (after possible list population)</span>
<a href="#l13.19"></a><span id="l13.19">  */</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-function checkPopulate(aTo, aCheckTo)</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-{</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+function checkPopulate(aTo, aCheckTo) {</span>
<a href="#l13.23"></a><span id="l13.23">   let msgCompose = Cc[MsgComposeContractID]</span>
<a href="#l13.24"></a><span id="l13.24">                      .createInstance(nsIMsgCompose);</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26">   // Set up some basic fields for compose.</span>
<a href="#l13.27"></a><span id="l13.27">   let fields = Cc[MsgComposeFieldsContractID]</span>
<a href="#l13.28"></a><span id="l13.28">                  .createInstance(nsIMsgCompFields);</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30">   fields.to = aTo;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineat">@@ -69,21 +67,20 @@ function run_test() {</span>
<a href="#l13.32"></a><span id="l13.32">   checkPopulate(&quot;family &lt;family&gt;&quot;, &quot;Simpson &lt;homer@example.com&gt;, Marge &lt;marge@example.com&gt;, &quot; +</span>
<a href="#l13.33"></a><span id="l13.33">     &quot;\&quot;lisa@example.com\&quot; &lt;lisa@example.com&gt;, Bart &lt;bart@foobar.invalid&gt;, Maggie &lt;maggie@example.com&gt;&quot;);</span>
<a href="#l13.34"></a><span id="l13.34">   checkPopulate(&quot;parents &lt;parents&gt;&quot;, &quot;Simpson &lt;homer@example.com&gt;, Marge &lt;marge@example.com&gt;&quot;);</span>
<a href="#l13.35"></a><span id="l13.35">   checkPopulate(&quot;kids &lt;kids&gt;&quot;, &quot;\&quot;lisa@example.com\&quot; &lt;lisa@example.com&gt;, Bart &lt;bart@foobar.invalid&gt;, &quot; +</span>
<a href="#l13.36"></a><span id="l13.36">     &quot;Maggie &lt;maggie@example.com&gt;&quot;);</span>
<a href="#l13.37"></a><span id="l13.37">   checkPopulate(&quot;older-kids &lt;older-kids&gt;&quot;, &quot;\&quot;lisa@example.com\&quot; &lt;lisa@example.com&gt;, Bart &lt;bart@foobar.invalid&gt;&quot;);</span>
<a href="#l13.38"></a><span id="l13.38">   checkPopulate(&quot;bad-kids &lt;bad-kids&gt;&quot;, &quot;\&quot;lisa@example.com\&quot; &lt;lisa@example.com&gt;, Bart &lt;bart@foobar.invalid&gt;, &quot; +</span>
<a href="#l13.39"></a><span id="l13.39">     &quot;Maggie &lt;maggie@example.com&gt;&quot;);</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-  checkPopulate(&quot;bad-younger-kids &lt;bad-younger-kids&gt;&quot;, &quot;Maggie &lt;maggie@example.com&gt;, &quot;+</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+  checkPopulate(&quot;bad-younger-kids &lt;bad-younger-kids&gt;&quot;, &quot;Maggie &lt;maggie@example.com&gt;, &quot; +</span>
<a href="#l13.42"></a><span id="l13.42">     &quot;\&quot;lisa@example.com\&quot; &lt;lisa@example.com&gt;, Bart &lt;bart@foobar.invalid&gt;&quot;);</span>
<a href="#l13.43"></a><span id="l13.43"> </span>
<a href="#l13.44"></a><span id="l13.44">   // Test we don't mistake an email address for a list, with a few variations.</span>
<a href="#l13.45"></a><span id="l13.45">   checkPopulate(&quot;Simpson &lt;homer@example.com&gt;&quot;, &quot;Simpson &lt;homer@example.com&gt;&quot;);</span>
<a href="#l13.46"></a><span id="l13.46">   checkPopulate(&quot;simpson &lt;homer@example.com&gt;&quot;, &quot;simpson &lt;homer@example.com&gt;&quot;);</span>
<a href="#l13.47"></a><span id="l13.47">   checkPopulate(&quot;simpson &lt;homer@not-in-ab.invalid&gt;&quot;, &quot;simpson &lt;homer@not-in-ab.invalid&gt;&quot;);</span>
<a href="#l13.48"></a><span id="l13.48"> </span>
<a href="#l13.49"></a><span id="l13.49">   checkPopulate(&quot;Marge &lt;marge@example.com&gt;&quot;, &quot;Marge &lt;marge@example.com&gt;&quot;);</span>
<a href="#l13.50"></a><span id="l13.50">   checkPopulate(&quot;marge &lt;marge@example.com&gt;&quot;, &quot;marge &lt;marge@example.com&gt;&quot;);</span>
<a href="#l13.51"></a><span id="l13.51">   checkPopulate(&quot;marge &lt;marge@not-in-ab.invalid&gt;&quot;, &quot;marge &lt;marge@not-in-ab.invalid&gt;&quot;);</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-};</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_longLines.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_longLines.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,15 +1,14 @@</span>
<a href="#l14.4"></a><span id="l14.4"> /*</span>
<a href="#l14.5"></a><span id="l14.5">  * Test ensuring that messages with &quot;long lines&quot; are transmitted correctly.</span>
<a href="#l14.6"></a><span id="l14.6">  * Most of this test was copied from test_messageHeaders.js.</span>
<a href="#l14.7"></a><span id="l14.7">  */</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineminus">-var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l14.11"></a><span id="l14.11"> const {MimeParser} = ChromeUtils.import(&quot;resource:///modules/mimeParser.jsm&quot;);</span>
<a href="#l14.12"></a><span id="l14.12"> </span>
<a href="#l14.13"></a><span id="l14.13"> var CompFields = CC(&quot;@mozilla.org/messengercompose/composefields;1&quot;,</span>
<a href="#l14.14"></a><span id="l14.14">                     Ci.nsIMsgCompFields);</span>
<a href="#l14.15"></a><span id="l14.15"> </span>
<a href="#l14.16"></a><span id="l14.16"> // Copied from jsmime.js.</span>
<a href="#l14.17"></a><span id="l14.17"> function stringToTypedArray(buffer) {</span>
<a href="#l14.18"></a><span id="l14.18">   var typedarray = new Uint8Array(buffer.length);</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineat">@@ -47,34 +46,38 @@ function checkDraftHeadersAndBody(expect</span>
<a href="#l14.20"></a><span id="l14.20">     let decodedBody = new TextDecoder(charset).decode(strView);</span>
<a href="#l14.21"></a><span id="l14.21">     Assert.equal(decodedBody, expectedBody);</span>
<a href="#l14.22"></a><span id="l14.22">   }</span>
<a href="#l14.23"></a><span id="l14.23"> }</span>
<a href="#l14.24"></a><span id="l14.24"> </span>
<a href="#l14.25"></a><span id="l14.25"> function checkMessageHeaders(msgData, expectedHeaders, partNum = &quot;&quot;) {</span>
<a href="#l14.26"></a><span id="l14.26">   let seen = false;</span>
<a href="#l14.27"></a><span id="l14.27">   let handler = {</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-    startPart: function (part, headers) {</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+    startPart(part, headers) {</span>
<a href="#l14.30"></a><span id="l14.30">       if (part != partNum)</span>
<a href="#l14.31"></a><span id="l14.31">         return;</span>
<a href="#l14.32"></a><span id="l14.32">       seen = true;</span>
<a href="#l14.33"></a><span id="l14.33">       for (let header in expectedHeaders) {</span>
<a href="#l14.34"></a><span id="l14.34">         let expected = expectedHeaders[header];</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-        if (expected === undefined)</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+        if (expected === undefined) {</span>
<a href="#l14.37"></a><span id="l14.37">           Assert.ok(!headers.has(header));</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-        else {</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+        } else {</span>
<a href="#l14.40"></a><span id="l14.40">           let value = headers.getRawHeader(header);</span>
<a href="#l14.41"></a><span id="l14.41">           Assert.equal(value.length, 1);</span>
<a href="#l14.42"></a><span id="l14.42">           value[0] = value[0].replace(/boundary=[^;]*(;|$)/, &quot;boundary=.&quot;);</span>
<a href="#l14.43"></a><span id="l14.43">           Assert.equal(value[0], expected);</span>
<a href="#l14.44"></a><span id="l14.44">         }</span>
<a href="#l14.45"></a><span id="l14.45">       }</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-    }</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+    },</span>
<a href="#l14.48"></a><span id="l14.48">   };</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-  MimeParser.parseSync(msgData, handler, {onerror: function (e) { throw e; }});</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+  MimeParser.parseSync(msgData, handler, {</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+    onerror(e) {</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+      throw e;</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+    },</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+  });</span>
<a href="#l14.55"></a><span id="l14.55">   Assert.ok(seen);</span>
<a href="#l14.56"></a><span id="l14.56"> }</span>
<a href="#l14.57"></a><span id="l14.57"> </span>
<a href="#l14.58"></a><span id="l14.58"> // Create a line with 600 letters 'a' with acute accent, encoded as</span>
<a href="#l14.59"></a><span id="l14.59"> // two bytes c3a1 in UTF-8.</span>
<a href="#l14.60"></a><span id="l14.60"> let longMultibyteLine = &quot;\u00E1&quot;.repeat(600);</span>
<a href="#l14.61"></a><span id="l14.61"> </span>
<a href="#l14.62"></a><span id="l14.62"> // And here a line with a Korean character, encoded as three bytes</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineat">@@ -107,75 +110,75 @@ async function testBodyWithLongLine() {</span>
<a href="#l14.64"></a><span id="l14.64">   let htmlMessage = &quot;&lt;html&gt;&lt;head&gt;&quot; +</span>
<a href="#l14.65"></a><span id="l14.65">     &quot;&lt;meta http-equiv=\&quot;content-type\&quot; content=\&quot;text/html; charset=utf-8\&quot;&gt;&quot; +</span>
<a href="#l14.66"></a><span id="l14.66">     &quot;&lt;/head&gt;&lt;body&gt;&quot; + longMultibyteLine + &quot;&lt;/body&gt;&lt;/html&gt;&quot;;</span>
<a href="#l14.67"></a><span id="l14.67">   fields.body = htmlMessage;</span>
<a href="#l14.68"></a><span id="l14.68">   await richCreateMessage(fields, [], identity);</span>
<a href="#l14.69"></a><span id="l14.69">   checkDraftHeadersAndBody(</span>
<a href="#l14.70"></a><span id="l14.70">     {</span>
<a href="#l14.71"></a><span id="l14.71">       &quot;Content-Type&quot;: &quot;text/html; charset=UTF-8&quot;,</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-      &quot;Content-Transfer-Encoding&quot;: &quot;base64&quot;</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+      &quot;Content-Transfer-Encoding&quot;: &quot;base64&quot;,</span>
<a href="#l14.74"></a><span id="l14.74">     },</span>
<a href="#l14.75"></a><span id="l14.75">     htmlMessage</span>
<a href="#l14.76"></a><span id="l14.76">   );</span>
<a href="#l14.77"></a><span id="l14.77"> </span>
<a href="#l14.78"></a><span id="l14.78">   // Again, but this time as plain text.</span>
<a href="#l14.79"></a><span id="l14.79">   fields.body = htmlMessage;</span>
<a href="#l14.80"></a><span id="l14.80">   fields.forcePlainText = true;</span>
<a href="#l14.81"></a><span id="l14.81">   fields.useMultipartAlternative = false;</span>
<a href="#l14.82"></a><span id="l14.82">   await richCreateMessage(fields, [], identity);</span>
<a href="#l14.83"></a><span id="l14.83">   checkDraftHeadersAndBody(</span>
<a href="#l14.84"></a><span id="l14.84">     {</span>
<a href="#l14.85"></a><span id="l14.85">       &quot;Content-Type&quot;: &quot;text/plain; charset=UTF-8; format=flowed&quot;,</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineminus">-      &quot;Content-Transfer-Encoding&quot;: &quot;base64&quot;</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+      &quot;Content-Transfer-Encoding&quot;: &quot;base64&quot;,</span>
<a href="#l14.88"></a><span id="l14.88">     },</span>
<a href="#l14.89"></a><span id="l14.89">     longMultibyteLine + newline // Expected body: The message without the tags.</span>
<a href="#l14.90"></a><span id="l14.90">   );</span>
<a href="#l14.91"></a><span id="l14.91"> </span>
<a href="#l14.92"></a><span id="l14.92">   // Now CJK.</span>
<a href="#l14.93"></a><span id="l14.93">   fields.forcePlainText = false;</span>
<a href="#l14.94"></a><span id="l14.94">   htmlMessage = &quot;&lt;html&gt;&lt;head&gt;&quot; +</span>
<a href="#l14.95"></a><span id="l14.95">     &quot;&lt;meta http-equiv=\&quot;content-type\&quot; content=\&quot;text/html; charset=utf-8\&quot;&gt;&quot; +</span>
<a href="#l14.96"></a><span id="l14.96">     &quot;&lt;/head&gt;&lt;body&gt;&quot; + longMultibyteLineCJK + &quot;&lt;/body&gt;&lt;/html&gt;&quot;;</span>
<a href="#l14.97"></a><span id="l14.97">   fields.body = htmlMessage;</span>
<a href="#l14.98"></a><span id="l14.98">   await richCreateMessage(fields, [], identity);</span>
<a href="#l14.99"></a><span id="l14.99">   checkDraftHeadersAndBody(</span>
<a href="#l14.100"></a><span id="l14.100">     {</span>
<a href="#l14.101"></a><span id="l14.101">       &quot;Content-Type&quot;: &quot;text/html; charset=UTF-8&quot;,</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineminus">-      &quot;Content-Transfer-Encoding&quot;: &quot;base64&quot;</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+      &quot;Content-Transfer-Encoding&quot;: &quot;base64&quot;,</span>
<a href="#l14.104"></a><span id="l14.104">     },</span>
<a href="#l14.105"></a><span id="l14.105">     htmlMessage</span>
<a href="#l14.106"></a><span id="l14.106">   );</span>
<a href="#l14.107"></a><span id="l14.107"> </span>
<a href="#l14.108"></a><span id="l14.108">   // Again, but this time as plain text.</span>
<a href="#l14.109"></a><span id="l14.109">   fields.body = htmlMessage;</span>
<a href="#l14.110"></a><span id="l14.110">   fields.forcePlainText = true;</span>
<a href="#l14.111"></a><span id="l14.111">   fields.useMultipartAlternative = false;</span>
<a href="#l14.112"></a><span id="l14.112">   await richCreateMessage(fields, [], identity);</span>
<a href="#l14.113"></a><span id="l14.113">   checkDraftHeadersAndBody(</span>
<a href="#l14.114"></a><span id="l14.114">     {</span>
<a href="#l14.115"></a><span id="l14.115">       &quot;Content-Type&quot;: &quot;text/plain; charset=UTF-8; format=flowed&quot;,</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineminus">-      &quot;Content-Transfer-Encoding&quot;: &quot;base64&quot;</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+      &quot;Content-Transfer-Encoding&quot;: &quot;base64&quot;,</span>
<a href="#l14.118"></a><span id="l14.118">     },</span>
<a href="#l14.119"></a><span id="l14.119">     longMultibyteLineCJK + newline // Expected body: The message without the tags.</span>
<a href="#l14.120"></a><span id="l14.120">   );</span>
<a href="#l14.121"></a><span id="l14.121"> </span>
<a href="#l14.122"></a><span id="l14.122">   // Now a special test for ISO-2022-JP.</span>
<a href="#l14.123"></a><span id="l14.123">   fields.characterSet = &quot;ISO-2022-JP&quot;;</span>
<a href="#l14.124"></a><span id="l14.124"> </span>
<a href="#l14.125"></a><span id="l14.125">   fields.forcePlainText = false;</span>
<a href="#l14.126"></a><span id="l14.126">   htmlMessage = &quot;&lt;html&gt;&lt;head&gt;&quot; +</span>
<a href="#l14.127"></a><span id="l14.127">     &quot;&lt;meta http-equiv=\&quot;content-type\&quot; content=\&quot;text/html; charset=ISO-2022-JP\&quot;&gt;&quot; +</span>
<a href="#l14.128"></a><span id="l14.128">     &quot;&lt;/head&gt;&lt;body&gt;&quot; + longMultibyteLineJapanese + &quot;&lt;/body&gt;&lt;/html&gt;&quot;;</span>
<a href="#l14.129"></a><span id="l14.129">   fields.body = htmlMessage;</span>
<a href="#l14.130"></a><span id="l14.130">   await richCreateMessage(fields, [], identity);</span>
<a href="#l14.131"></a><span id="l14.131">   checkDraftHeadersAndBody(</span>
<a href="#l14.132"></a><span id="l14.132">     {</span>
<a href="#l14.133"></a><span id="l14.133">       &quot;Content-Type&quot;: &quot;text/html; charset=ISO-2022-JP&quot;,</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineminus">-      &quot;Content-Transfer-Encoding&quot;: &quot;base64&quot;</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+      &quot;Content-Transfer-Encoding&quot;: &quot;base64&quot;,</span>
<a href="#l14.136"></a><span id="l14.136">     },</span>
<a href="#l14.137"></a><span id="l14.137">     htmlMessage,</span>
<a href="#l14.138"></a><span id="l14.138">     &quot;ISO-2022-JP&quot;</span>
<a href="#l14.139"></a><span id="l14.139">   );</span>
<a href="#l14.140"></a><span id="l14.140"> </span>
<a href="#l14.141"></a><span id="l14.141">   // Again, but this time as plain text.</span>
<a href="#l14.142"></a><span id="l14.142">   fields.body = htmlMessage;</span>
<a href="#l14.143"></a><span id="l14.143">   fields.forcePlainText = true;</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineat">@@ -190,39 +193,39 @@ async function testBodyWithLongLine() {</span>
<a href="#l14.145"></a><span id="l14.145">     expectedBody = expectedBody + longMultibyteLineJapanese.substr(i, 36) + &quot; \r\n&quot;;</span>
<a href="#l14.146"></a><span id="l14.146">     lastIndex = i + 36;</span>
<a href="#l14.147"></a><span id="l14.147">   }</span>
<a href="#l14.148"></a><span id="l14.148">   expectedBody += longMultibyteLineJapanese.substr(lastIndex) + &quot;\r\n&quot;;</span>
<a href="#l14.149"></a><span id="l14.149"> </span>
<a href="#l14.150"></a><span id="l14.150">   checkDraftHeadersAndBody(</span>
<a href="#l14.151"></a><span id="l14.151">     {</span>
<a href="#l14.152"></a><span id="l14.152">       &quot;Content-Type&quot;: &quot;text/plain; charset=ISO-2022-JP; format=flowed; delsp=yes&quot;,</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineminus">-      &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+      &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;,</span>
<a href="#l14.155"></a><span id="l14.155">     },</span>
<a href="#l14.156"></a><span id="l14.156">     expectedBody,</span>
<a href="#l14.157"></a><span id="l14.157">     &quot;ISO-2022-JP&quot;</span>
<a href="#l14.158"></a><span id="l14.158">   );</span>
<a href="#l14.159"></a><span id="l14.159"> </span>
<a href="#l14.160"></a><span id="l14.160">   // Again, but this time not flowed.</span>
<a href="#l14.161"></a><span id="l14.161">   fields.body = htmlMessage;</span>
<a href="#l14.162"></a><span id="l14.162">   Services.prefs.setBoolPref(&quot;mailnews.send_plaintext_flowed&quot;, false);</span>
<a href="#l14.163"></a><span id="l14.163"> </span>
<a href="#l14.164"></a><span id="l14.164">   await richCreateMessage(fields, [], identity);</span>
<a href="#l14.165"></a><span id="l14.165">   checkDraftHeadersAndBody(</span>
<a href="#l14.166"></a><span id="l14.166">     {</span>
<a href="#l14.167"></a><span id="l14.167">       &quot;Content-Type&quot;: &quot;text/plain; charset=ISO-2022-JP&quot;,</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineminus">-      &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+      &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;,</span>
<a href="#l14.170"></a><span id="l14.170">     },</span>
<a href="#l14.171"></a><span id="l14.171">     expectedBody.replace(/ /g, &quot;&quot;), // No spaces expected this time.</span>
<a href="#l14.172"></a><span id="l14.172">     &quot;ISO-2022-JP&quot;</span>
<a href="#l14.173"></a><span id="l14.173">   );</span>
<a href="#l14.174"></a><span id="l14.174"> }</span>
<a href="#l14.175"></a><span id="l14.175"> </span>
<a href="#l14.176"></a><span id="l14.176"> var tests = [</span>
<a href="#l14.177"></a><span id="l14.177">   testBodyWithLongLine,</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineminus">-]</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineplus">+];</span>
<a href="#l14.180"></a><span id="l14.180"> </span>
<a href="#l14.181"></a><span id="l14.181"> function run_test() {</span>
<a href="#l14.182"></a><span id="l14.182">   // Ensure we have at least one mail account</span>
<a href="#l14.183"></a><span id="l14.183">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l14.184"></a><span id="l14.184">   tests.forEach(x =&gt; add_task(x));</span>
<a href="#l14.185"></a><span id="l14.185">   run_next_test();</span>
<a href="#l14.186"></a><span id="l14.186"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_mailtoURL.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_mailtoURL.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,19 +1,17 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /*</span>
<a href="#l15.5"></a><span id="l15.5">  * Test suite for mailto: URLs</span>
<a href="#l15.6"></a><span id="l15.6">  */</span>
<a href="#l15.7"></a><span id="l15.7"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">-var nsIMailtoUrl = Ci.nsIMailtoUrl;</span>
<a href="#l15.10"></a><span id="l15.10"> var COMPOSE_HTML = Ci.nsIMsgCompFormat.HTML;</span>
<a href="#l15.11"></a><span id="l15.11"> var COMPOSE_DEFAULT = Ci.nsIMsgCompFormat.Default;</span>
<a href="#l15.12"></a><span id="l15.12"> </span>
<a href="#l15.13"></a><span id="l15.13"> function run_test() {</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-</span>
<a href="#l15.15"></a><span id="l15.15">   function test(aTest) {</span>
<a href="#l15.16"></a><span id="l15.16">     var uri = Services.io.newURI(aTest.url);</span>
<a href="#l15.17"></a><span id="l15.17">     uri = uri.QueryInterface(Ci.nsIMailtoUrl);</span>
<a href="#l15.18"></a><span id="l15.18"> </span>
<a href="#l15.19"></a><span id="l15.19">     var to = {}, cc = {}, bcc = {}, subject = {}, body = {}, html = {},</span>
<a href="#l15.20"></a><span id="l15.20">         reference = {}, newsgroup = {}, composeformat = {};</span>
<a href="#l15.21"></a><span id="l15.21">     uri.getMessageContents(to, cc, bcc, subject, body, html, reference,</span>
<a href="#l15.22"></a><span id="l15.22">                            newsgroup, composeformat);</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineat">@@ -40,17 +38,17 @@ function run_test() {</span>
<a href="#l15.24"></a><span id="l15.24"> </span>
<a href="#l15.25"></a><span id="l15.25">   // Test cloning reparses the url by checking the to field.</span>
<a href="#l15.26"></a><span id="l15.26">   let uri = Services.io.newURI(tests[0].url).QueryInterface(Ci.nsIMailtoUrl);</span>
<a href="#l15.27"></a><span id="l15.27">   var to = {}, cc = {}, bcc = {}, subject = {}, body = {}, html = {},</span>
<a href="#l15.28"></a><span id="l15.28">       reference = {}, newsgroup = {}, composeformat = {};</span>
<a href="#l15.29"></a><span id="l15.29">   uri.getMessageContents(to, cc, bcc, subject, body, html, reference,</span>
<a href="#l15.30"></a><span id="l15.30">                          newsgroup, composeformat);</span>
<a href="#l15.31"></a><span id="l15.31">   Assert.equal(to.value, tests[0].to);</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-};</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+}</span>
<a href="#l15.34"></a><span id="l15.34"> </span>
<a href="#l15.35"></a><span id="l15.35"> var tests = [</span>
<a href="#l15.36"></a><span id="l15.36">   {</span>
<a href="#l15.37"></a><span id="l15.37">     url: &quot;mailto:one@example.com&quot;,</span>
<a href="#l15.38"></a><span id="l15.38">     to: &quot;one@example.com&quot;,</span>
<a href="#l15.39"></a><span id="l15.39">     cc: &quot;&quot;,</span>
<a href="#l15.40"></a><span id="l15.40">     bcc: &quot;&quot;,</span>
<a href="#l15.41"></a><span id="l15.41">     subject: &quot;&quot;,</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineat">@@ -59,35 +57,34 @@ var tests = [</span>
<a href="#l15.43"></a><span id="l15.43">     reference: &quot;&quot;,</span>
<a href="#l15.44"></a><span id="l15.44">     newsgroup: &quot;&quot;,</span>
<a href="#l15.45"></a><span id="l15.45">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.46"></a><span id="l15.46">     from: &quot;&quot;,</span>
<a href="#l15.47"></a><span id="l15.47">     followupto: &quot;&quot;,</span>
<a href="#l15.48"></a><span id="l15.48">     organization: &quot;&quot;,</span>
<a href="#l15.49"></a><span id="l15.49">     replyto: &quot;&quot;,</span>
<a href="#l15.50"></a><span id="l15.50">     priority: &quot;&quot;,</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-  },</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-  {</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+  }, {</span>
<a href="#l15.56"></a><span id="l15.56">     url: &quot;mailto:two@example.com?&quot;,</span>
<a href="#l15.57"></a><span id="l15.57">     to: &quot;two@example.com&quot;,</span>
<a href="#l15.58"></a><span id="l15.58">     cc: &quot;&quot;,</span>
<a href="#l15.59"></a><span id="l15.59">     bcc: &quot;&quot;,</span>
<a href="#l15.60"></a><span id="l15.60">     subject: &quot;&quot;,</span>
<a href="#l15.61"></a><span id="l15.61">     body: &quot;&quot;,</span>
<a href="#l15.62"></a><span id="l15.62">     html: &quot;&quot;,</span>
<a href="#l15.63"></a><span id="l15.63">     reference: &quot;&quot;,</span>
<a href="#l15.64"></a><span id="l15.64">     newsgroup: &quot;&quot;,</span>
<a href="#l15.65"></a><span id="l15.65">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.66"></a><span id="l15.66">     from: &quot;&quot;,</span>
<a href="#l15.67"></a><span id="l15.67">     followupto: &quot;&quot;,</span>
<a href="#l15.68"></a><span id="l15.68">     organization: &quot;&quot;,</span>
<a href="#l15.69"></a><span id="l15.69">     replyto: &quot;&quot;,</span>
<a href="#l15.70"></a><span id="l15.70">     priority: &quot;&quot;,</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.73"></a><span id="l15.73">   },</span>
<a href="#l15.74"></a><span id="l15.74">   /* the heirarchical-part address shouldn't be mime-decoded */</span>
<a href="#l15.75"></a><span id="l15.75">   {</span>
<a href="#l15.76"></a><span id="l15.76">     url: &quot;mailto:%3D%3FUTF-8%3FQ%3Fthree%3F%3D@example.com&quot;,</span>
<a href="#l15.77"></a><span id="l15.77">     to: &quot;=?UTF-8?Q?three?=@example.com&quot;,</span>
<a href="#l15.78"></a><span id="l15.78">     cc: &quot;&quot;,</span>
<a href="#l15.79"></a><span id="l15.79">     bcc: &quot;&quot;,</span>
<a href="#l15.80"></a><span id="l15.80">     subject: &quot;&quot;,</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineat">@@ -96,17 +93,17 @@ var tests = [</span>
<a href="#l15.82"></a><span id="l15.82">     reference: &quot;&quot;,</span>
<a href="#l15.83"></a><span id="l15.83">     newsgroup: &quot;&quot;,</span>
<a href="#l15.84"></a><span id="l15.84">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.85"></a><span id="l15.85">     from: &quot;&quot;,</span>
<a href="#l15.86"></a><span id="l15.86">     followupto: &quot;&quot;,</span>
<a href="#l15.87"></a><span id="l15.87">     organization: &quot;&quot;,</span>
<a href="#l15.88"></a><span id="l15.88">     replyto: &quot;&quot;,</span>
<a href="#l15.89"></a><span id="l15.89">     priority: &quot;&quot;,</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.92"></a><span id="l15.92">   },</span>
<a href="#l15.93"></a><span id="l15.93">   /* a to=address should be mime-decoded */</span>
<a href="#l15.94"></a><span id="l15.94">   {</span>
<a href="#l15.95"></a><span id="l15.95">     url: &quot;mailto:?to=%3D%3FUTF-8%3FQ%3Ffour%3F%3D@example.com&quot;,</span>
<a href="#l15.96"></a><span id="l15.96">     to: &quot;four@example.com&quot;,</span>
<a href="#l15.97"></a><span id="l15.97">     cc: &quot;&quot;,</span>
<a href="#l15.98"></a><span id="l15.98">     bcc: &quot;&quot;,</span>
<a href="#l15.99"></a><span id="l15.99">     subject: &quot;&quot;,</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineat">@@ -115,651 +112,615 @@ var tests = [</span>
<a href="#l15.101"></a><span id="l15.101">     reference: &quot;&quot;,</span>
<a href="#l15.102"></a><span id="l15.102">     newsgroup: &quot;&quot;,</span>
<a href="#l15.103"></a><span id="l15.103">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.104"></a><span id="l15.104">     from: &quot;&quot;,</span>
<a href="#l15.105"></a><span id="l15.105">     followupto: &quot;&quot;,</span>
<a href="#l15.106"></a><span id="l15.106">     organization: &quot;&quot;,</span>
<a href="#l15.107"></a><span id="l15.107">     replyto: &quot;&quot;,</span>
<a href="#l15.108"></a><span id="l15.108">     priority: &quot;&quot;,</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineminus">-  },</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineminus">-  {</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+  }, {</span>
<a href="#l15.114"></a><span id="l15.114">     url: &quot;mailto:fivea@example.com?to=%3D%3FUTF-8%3FQ%3Ffiveb%3F%3D@example.com&quot;,</span>
<a href="#l15.115"></a><span id="l15.115">     to: &quot;fivea@example.com, fiveb@example.com&quot;,</span>
<a href="#l15.116"></a><span id="l15.116">     cc: &quot;&quot;,</span>
<a href="#l15.117"></a><span id="l15.117">     bcc: &quot;&quot;,</span>
<a href="#l15.118"></a><span id="l15.118">     subject: &quot;&quot;,</span>
<a href="#l15.119"></a><span id="l15.119">     body: &quot;&quot;,</span>
<a href="#l15.120"></a><span id="l15.120">     html: &quot;&quot;,</span>
<a href="#l15.121"></a><span id="l15.121">     reference: &quot;&quot;,</span>
<a href="#l15.122"></a><span id="l15.122">     newsgroup: &quot;&quot;,</span>
<a href="#l15.123"></a><span id="l15.123">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.124"></a><span id="l15.124">     from: &quot;&quot;,</span>
<a href="#l15.125"></a><span id="l15.125">     followupto: &quot;&quot;,</span>
<a href="#l15.126"></a><span id="l15.126">     organization: &quot;&quot;,</span>
<a href="#l15.127"></a><span id="l15.127">     replyto: &quot;&quot;,</span>
<a href="#l15.128"></a><span id="l15.128">     priority: &quot;&quot;,</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-  },</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineminus">-  {</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineplus">+  }, {</span>
<a href="#l15.134"></a><span id="l15.134">     url: &quot;mailto:sixa@example.com?to=sixb@example.com&amp;to=sixc@example.com&quot;,</span>
<a href="#l15.135"></a><span id="l15.135">     to: &quot;sixa@example.com, sixb@example.com, sixc@example.com&quot;,</span>
<a href="#l15.136"></a><span id="l15.136">     cc: &quot;&quot;,</span>
<a href="#l15.137"></a><span id="l15.137">     bcc: &quot;&quot;,</span>
<a href="#l15.138"></a><span id="l15.138">     subject: &quot;&quot;,</span>
<a href="#l15.139"></a><span id="l15.139">     body: &quot;&quot;,</span>
<a href="#l15.140"></a><span id="l15.140">     html: &quot;&quot;,</span>
<a href="#l15.141"></a><span id="l15.141">     reference: &quot;&quot;,</span>
<a href="#l15.142"></a><span id="l15.142">     newsgroup: &quot;&quot;,</span>
<a href="#l15.143"></a><span id="l15.143">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.144"></a><span id="l15.144">     from: &quot;&quot;,</span>
<a href="#l15.145"></a><span id="l15.145">     followupto: &quot;&quot;,</span>
<a href="#l15.146"></a><span id="l15.146">     organization: &quot;&quot;,</span>
<a href="#l15.147"></a><span id="l15.147">     replyto: &quot;&quot;,</span>
<a href="#l15.148"></a><span id="l15.148">     priority: &quot;&quot;,</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineminus">-  },</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineminus">-  {</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineplus">+  }, {</span>
<a href="#l15.154"></a><span id="l15.154">     url: &quot;mailto:?cc=seven@example.com&quot;,</span>
<a href="#l15.155"></a><span id="l15.155">     to: &quot;&quot;,</span>
<a href="#l15.156"></a><span id="l15.156">     cc: &quot;seven@example.com&quot;,</span>
<a href="#l15.157"></a><span id="l15.157">     bcc: &quot;&quot;,</span>
<a href="#l15.158"></a><span id="l15.158">     subject: &quot;&quot;,</span>
<a href="#l15.159"></a><span id="l15.159">     body: &quot;&quot;,</span>
<a href="#l15.160"></a><span id="l15.160">     html: &quot;&quot;,</span>
<a href="#l15.161"></a><span id="l15.161">     reference: &quot;&quot;,</span>
<a href="#l15.162"></a><span id="l15.162">     newsgroup: &quot;&quot;,</span>
<a href="#l15.163"></a><span id="l15.163">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.164"></a><span id="l15.164">     from: &quot;&quot;,</span>
<a href="#l15.165"></a><span id="l15.165">     followupto: &quot;&quot;,</span>
<a href="#l15.166"></a><span id="l15.166">     organization: &quot;&quot;,</span>
<a href="#l15.167"></a><span id="l15.167">     replyto: &quot;&quot;,</span>
<a href="#l15.168"></a><span id="l15.168">     priority: &quot;&quot;,</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineminus">-  },</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineminus">-  {</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineplus">+  }, {</span>
<a href="#l15.174"></a><span id="l15.174">     url: &quot;mailto:?cc=%3D%3FUTF-8%3FQ%3Feight%3F%3D@example.com&quot;,</span>
<a href="#l15.175"></a><span id="l15.175">     to: &quot;&quot;,</span>
<a href="#l15.176"></a><span id="l15.176">     cc: &quot;eight@example.com&quot;,</span>
<a href="#l15.177"></a><span id="l15.177">     bcc: &quot;&quot;,</span>
<a href="#l15.178"></a><span id="l15.178">     subject: &quot;&quot;,</span>
<a href="#l15.179"></a><span id="l15.179">     body: &quot;&quot;,</span>
<a href="#l15.180"></a><span id="l15.180">     html: &quot;&quot;,</span>
<a href="#l15.181"></a><span id="l15.181">     reference: &quot;&quot;,</span>
<a href="#l15.182"></a><span id="l15.182">     newsgroup: &quot;&quot;,</span>
<a href="#l15.183"></a><span id="l15.183">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.184"></a><span id="l15.184">     from: &quot;&quot;,</span>
<a href="#l15.185"></a><span id="l15.185">     followupto: &quot;&quot;,</span>
<a href="#l15.186"></a><span id="l15.186">     organization: &quot;&quot;,</span>
<a href="#l15.187"></a><span id="l15.187">     replyto: &quot;&quot;,</span>
<a href="#l15.188"></a><span id="l15.188">     priority: &quot;&quot;,</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineminus">-  },</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineminus">-  {</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineplus">+  }, {</span>
<a href="#l15.194"></a><span id="l15.194">     url: &quot;mailto:?bcc=nine@example.com&quot;,</span>
<a href="#l15.195"></a><span id="l15.195">     to: &quot;&quot;,</span>
<a href="#l15.196"></a><span id="l15.196">     cc: &quot;&quot;,</span>
<a href="#l15.197"></a><span id="l15.197">     bcc: &quot;nine@example.com&quot;,</span>
<a href="#l15.198"></a><span id="l15.198">     subject: &quot;&quot;,</span>
<a href="#l15.199"></a><span id="l15.199">     body: &quot;&quot;,</span>
<a href="#l15.200"></a><span id="l15.200">     html: &quot;&quot;,</span>
<a href="#l15.201"></a><span id="l15.201">     reference: &quot;&quot;,</span>
<a href="#l15.202"></a><span id="l15.202">     newsgroup: &quot;&quot;,</span>
<a href="#l15.203"></a><span id="l15.203">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.204"></a><span id="l15.204">     from: &quot;&quot;,</span>
<a href="#l15.205"></a><span id="l15.205">     followupto: &quot;&quot;,</span>
<a href="#l15.206"></a><span id="l15.206">     organization: &quot;&quot;,</span>
<a href="#l15.207"></a><span id="l15.207">     replyto: &quot;&quot;,</span>
<a href="#l15.208"></a><span id="l15.208">     priority: &quot;&quot;,</span>
<a href="#l15.209"></a><span id="l15.209" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.210"></a><span id="l15.210" class="difflineminus">-  },</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineminus">-  {</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.213"></a><span id="l15.213" class="difflineplus">+  }, {</span>
<a href="#l15.214"></a><span id="l15.214">     url: &quot;mailto:?bcc=%3D%3FUTF-8%3FQ%3Ften%3F%3D@example.com&quot;,</span>
<a href="#l15.215"></a><span id="l15.215">     to: &quot;&quot;,</span>
<a href="#l15.216"></a><span id="l15.216">     cc: &quot;&quot;,</span>
<a href="#l15.217"></a><span id="l15.217">     bcc: &quot;ten@example.com&quot;,</span>
<a href="#l15.218"></a><span id="l15.218">     subject: &quot;&quot;,</span>
<a href="#l15.219"></a><span id="l15.219">     body: &quot;&quot;,</span>
<a href="#l15.220"></a><span id="l15.220">     html: &quot;&quot;,</span>
<a href="#l15.221"></a><span id="l15.221">     reference: &quot;&quot;,</span>
<a href="#l15.222"></a><span id="l15.222">     newsgroup: &quot;&quot;,</span>
<a href="#l15.223"></a><span id="l15.223">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.224"></a><span id="l15.224">     from: &quot;&quot;,</span>
<a href="#l15.225"></a><span id="l15.225">     followupto: &quot;&quot;,</span>
<a href="#l15.226"></a><span id="l15.226">     organization: &quot;&quot;,</span>
<a href="#l15.227"></a><span id="l15.227">     replyto: &quot;&quot;,</span>
<a href="#l15.228"></a><span id="l15.228">     priority: &quot;&quot;,</span>
<a href="#l15.229"></a><span id="l15.229" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineminus">-  },</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineminus">-  {</span>
<a href="#l15.232"></a><span id="l15.232" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineplus">+  }, {</span>
<a href="#l15.234"></a><span id="l15.234">     url: &quot;mailto:?subject=foo&quot;,</span>
<a href="#l15.235"></a><span id="l15.235">     to: &quot;&quot;,</span>
<a href="#l15.236"></a><span id="l15.236">     cc: &quot;&quot;,</span>
<a href="#l15.237"></a><span id="l15.237">     bcc: &quot;&quot;,</span>
<a href="#l15.238"></a><span id="l15.238">     subject: &quot;foo&quot;,</span>
<a href="#l15.239"></a><span id="l15.239">     body: &quot;&quot;,</span>
<a href="#l15.240"></a><span id="l15.240">     html: &quot;&quot;,</span>
<a href="#l15.241"></a><span id="l15.241">     reference: &quot;&quot;,</span>
<a href="#l15.242"></a><span id="l15.242">     newsgroup: &quot;&quot;,</span>
<a href="#l15.243"></a><span id="l15.243">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.244"></a><span id="l15.244">     from: &quot;&quot;,</span>
<a href="#l15.245"></a><span id="l15.245">     followupto: &quot;&quot;,</span>
<a href="#l15.246"></a><span id="l15.246">     organization: &quot;&quot;,</span>
<a href="#l15.247"></a><span id="l15.247">     replyto: &quot;&quot;,</span>
<a href="#l15.248"></a><span id="l15.248">     priority: &quot;&quot;,</span>
<a href="#l15.249"></a><span id="l15.249" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.250"></a><span id="l15.250" class="difflineminus">-  },</span>
<a href="#l15.251"></a><span id="l15.251" class="difflineminus">-  {</span>
<a href="#l15.252"></a><span id="l15.252" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.253"></a><span id="l15.253" class="difflineplus">+  }, {</span>
<a href="#l15.254"></a><span id="l15.254">     url: &quot;mailto:?subject=%62%61%72&quot;,</span>
<a href="#l15.255"></a><span id="l15.255">     to: &quot;&quot;,</span>
<a href="#l15.256"></a><span id="l15.256">     cc: &quot;&quot;,</span>
<a href="#l15.257"></a><span id="l15.257">     bcc: &quot;&quot;,</span>
<a href="#l15.258"></a><span id="l15.258">     subject: &quot;bar&quot;,</span>
<a href="#l15.259"></a><span id="l15.259">     body: &quot;&quot;,</span>
<a href="#l15.260"></a><span id="l15.260">     html: &quot;&quot;,</span>
<a href="#l15.261"></a><span id="l15.261">     reference: &quot;&quot;,</span>
<a href="#l15.262"></a><span id="l15.262">     newsgroup: &quot;&quot;,</span>
<a href="#l15.263"></a><span id="l15.263">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.264"></a><span id="l15.264">     from: &quot;&quot;,</span>
<a href="#l15.265"></a><span id="l15.265">     followupto: &quot;&quot;,</span>
<a href="#l15.266"></a><span id="l15.266">     organization: &quot;&quot;,</span>
<a href="#l15.267"></a><span id="l15.267">     replyto: &quot;&quot;,</span>
<a href="#l15.268"></a><span id="l15.268">     priority: &quot;&quot;,</span>
<a href="#l15.269"></a><span id="l15.269" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.270"></a><span id="l15.270" class="difflineminus">-  },</span>
<a href="#l15.271"></a><span id="l15.271" class="difflineminus">-  {</span>
<a href="#l15.272"></a><span id="l15.272" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.273"></a><span id="l15.273" class="difflineplus">+  }, {</span>
<a href="#l15.274"></a><span id="l15.274">     url: &quot;mailto:?subject=%3D%3Futf-8%3FQ%3F%3DC2%3DA1encoded_subject%21%3F%3D&quot;,</span>
<a href="#l15.275"></a><span id="l15.275">     to: &quot;&quot;,</span>
<a href="#l15.276"></a><span id="l15.276">     cc: &quot;&quot;,</span>
<a href="#l15.277"></a><span id="l15.277">     bcc: &quot;&quot;,</span>
<a href="#l15.278"></a><span id="l15.278">     subject: &quot;encoded subject!&quot;,</span>
<a href="#l15.279"></a><span id="l15.279">     body: &quot;&quot;,</span>
<a href="#l15.280"></a><span id="l15.280">     html: &quot;&quot;,</span>
<a href="#l15.281"></a><span id="l15.281">     reference: &quot;&quot;,</span>
<a href="#l15.282"></a><span id="l15.282">     newsgroup: &quot;&quot;,</span>
<a href="#l15.283"></a><span id="l15.283">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.284"></a><span id="l15.284">     from: &quot;&quot;,</span>
<a href="#l15.285"></a><span id="l15.285">     followupto: &quot;&quot;,</span>
<a href="#l15.286"></a><span id="l15.286">     organization: &quot;&quot;,</span>
<a href="#l15.287"></a><span id="l15.287">     replyto: &quot;&quot;,</span>
<a href="#l15.288"></a><span id="l15.288">     priority: &quot;&quot;,</span>
<a href="#l15.289"></a><span id="l15.289" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.290"></a><span id="l15.290" class="difflineminus">-  },</span>
<a href="#l15.291"></a><span id="l15.291" class="difflineminus">-  {</span>
<a href="#l15.292"></a><span id="l15.292" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.293"></a><span id="l15.293" class="difflineplus">+  }, {</span>
<a href="#l15.294"></a><span id="l15.294">     url: &quot;mailto:?body=one%20body&quot;,</span>
<a href="#l15.295"></a><span id="l15.295">     to: &quot;&quot;,</span>
<a href="#l15.296"></a><span id="l15.296">     cc: &quot;&quot;,</span>
<a href="#l15.297"></a><span id="l15.297">     bcc: &quot;&quot;,</span>
<a href="#l15.298"></a><span id="l15.298">     subject: &quot;&quot;,</span>
<a href="#l15.299"></a><span id="l15.299">     body: &quot;one body&quot;,</span>
<a href="#l15.300"></a><span id="l15.300">     html: &quot;&quot;,</span>
<a href="#l15.301"></a><span id="l15.301">     reference: &quot;&quot;,</span>
<a href="#l15.302"></a><span id="l15.302">     newsgroup: &quot;&quot;,</span>
<a href="#l15.303"></a><span id="l15.303">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.304"></a><span id="l15.304">     from: &quot;&quot;,</span>
<a href="#l15.305"></a><span id="l15.305">     followupto: &quot;&quot;,</span>
<a href="#l15.306"></a><span id="l15.306">     organization: &quot;&quot;,</span>
<a href="#l15.307"></a><span id="l15.307">     replyto: &quot;&quot;,</span>
<a href="#l15.308"></a><span id="l15.308">     priority: &quot;&quot;,</span>
<a href="#l15.309"></a><span id="l15.309" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.310"></a><span id="l15.310" class="difflineminus">-  },</span>
<a href="#l15.311"></a><span id="l15.311" class="difflineminus">-  {</span>
<a href="#l15.312"></a><span id="l15.312" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.313"></a><span id="l15.313" class="difflineplus">+  }, {</span>
<a href="#l15.314"></a><span id="l15.314">     url: &quot;mailto:?body=two%20bodies&amp;body=two%20lines&quot;,</span>
<a href="#l15.315"></a><span id="l15.315">     to: &quot;&quot;,</span>
<a href="#l15.316"></a><span id="l15.316">     cc: &quot;&quot;,</span>
<a href="#l15.317"></a><span id="l15.317">     bcc: &quot;&quot;,</span>
<a href="#l15.318"></a><span id="l15.318">     subject: &quot;&quot;,</span>
<a href="#l15.319"></a><span id="l15.319">     body: &quot;two bodies\ntwo lines&quot;,</span>
<a href="#l15.320"></a><span id="l15.320">     html: &quot;&quot;,</span>
<a href="#l15.321"></a><span id="l15.321">     reference: &quot;&quot;,</span>
<a href="#l15.322"></a><span id="l15.322">     newsgroup: &quot;&quot;,</span>
<a href="#l15.323"></a><span id="l15.323">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.324"></a><span id="l15.324">     from: &quot;&quot;,</span>
<a href="#l15.325"></a><span id="l15.325">     followupto: &quot;&quot;,</span>
<a href="#l15.326"></a><span id="l15.326">     organization: &quot;&quot;,</span>
<a href="#l15.327"></a><span id="l15.327">     replyto: &quot;&quot;,</span>
<a href="#l15.328"></a><span id="l15.328">     priority: &quot;&quot;,</span>
<a href="#l15.329"></a><span id="l15.329" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.330"></a><span id="l15.330" class="difflineminus">-  },</span>
<a href="#l15.331"></a><span id="l15.331" class="difflineminus">-  {</span>
<a href="#l15.332"></a><span id="l15.332" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.333"></a><span id="l15.333" class="difflineplus">+  }, {</span>
<a href="#l15.334"></a><span id="l15.334">     url: &quot;mailto:?html-part=html%20part&quot;,</span>
<a href="#l15.335"></a><span id="l15.335">     to: &quot;&quot;,</span>
<a href="#l15.336"></a><span id="l15.336">     cc: &quot;&quot;,</span>
<a href="#l15.337"></a><span id="l15.337">     bcc: &quot;&quot;,</span>
<a href="#l15.338"></a><span id="l15.338">     subject: &quot;&quot;,</span>
<a href="#l15.339"></a><span id="l15.339">     body: &quot;&quot;,</span>
<a href="#l15.340"></a><span id="l15.340">     html: &quot;html part&quot;,</span>
<a href="#l15.341"></a><span id="l15.341">     reference: &quot;&quot;,</span>
<a href="#l15.342"></a><span id="l15.342">     newsgroup: &quot;&quot;,</span>
<a href="#l15.343"></a><span id="l15.343">     composeformat: COMPOSE_HTML,</span>
<a href="#l15.344"></a><span id="l15.344">     from: &quot;&quot;,</span>
<a href="#l15.345"></a><span id="l15.345">     followupto: &quot;&quot;,</span>
<a href="#l15.346"></a><span id="l15.346">     organization: &quot;&quot;,</span>
<a href="#l15.347"></a><span id="l15.347">     replyto: &quot;&quot;,</span>
<a href="#l15.348"></a><span id="l15.348">     priority: &quot;&quot;,</span>
<a href="#l15.349"></a><span id="l15.349" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.350"></a><span id="l15.350" class="difflineminus">-  },</span>
<a href="#l15.351"></a><span id="l15.351" class="difflineminus">-  {</span>
<a href="#l15.352"></a><span id="l15.352" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.353"></a><span id="l15.353" class="difflineplus">+  }, {</span>
<a href="#l15.354"></a><span id="l15.354">     url: &quot;mailto:?html-body=html%20body&quot;,</span>
<a href="#l15.355"></a><span id="l15.355">     to: &quot;&quot;,</span>
<a href="#l15.356"></a><span id="l15.356">     cc: &quot;&quot;,</span>
<a href="#l15.357"></a><span id="l15.357">     bcc: &quot;&quot;,</span>
<a href="#l15.358"></a><span id="l15.358">     subject: &quot;&quot;,</span>
<a href="#l15.359"></a><span id="l15.359">     body: &quot;&quot;,</span>
<a href="#l15.360"></a><span id="l15.360">     html: &quot;html body&quot;,</span>
<a href="#l15.361"></a><span id="l15.361">     reference: &quot;&quot;,</span>
<a href="#l15.362"></a><span id="l15.362">     newsgroup: &quot;&quot;,</span>
<a href="#l15.363"></a><span id="l15.363">     composeformat: COMPOSE_HTML,</span>
<a href="#l15.364"></a><span id="l15.364">     from: &quot;&quot;,</span>
<a href="#l15.365"></a><span id="l15.365">     followupto: &quot;&quot;,</span>
<a href="#l15.366"></a><span id="l15.366">     organization: &quot;&quot;,</span>
<a href="#l15.367"></a><span id="l15.367">     replyto: &quot;&quot;,</span>
<a href="#l15.368"></a><span id="l15.368">     priority: &quot;&quot;,</span>
<a href="#l15.369"></a><span id="l15.369" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.370"></a><span id="l15.370" class="difflineminus">-  },</span>
<a href="#l15.371"></a><span id="l15.371" class="difflineminus">-  {</span>
<a href="#l15.372"></a><span id="l15.372" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.373"></a><span id="l15.373" class="difflineplus">+  }, {</span>
<a href="#l15.374"></a><span id="l15.374">     url: &quot;mailto:?html-part=html%20part&amp;html-body=html-body%20trumps%20earlier%20html-part&quot;,</span>
<a href="#l15.375"></a><span id="l15.375">     to: &quot;&quot;,</span>
<a href="#l15.376"></a><span id="l15.376">     cc: &quot;&quot;,</span>
<a href="#l15.377"></a><span id="l15.377">     bcc: &quot;&quot;,</span>
<a href="#l15.378"></a><span id="l15.378">     subject: &quot;&quot;,</span>
<a href="#l15.379"></a><span id="l15.379">     body: &quot;&quot;,</span>
<a href="#l15.380"></a><span id="l15.380">     html: &quot;html-body trumps earlier html-part&quot;,</span>
<a href="#l15.381"></a><span id="l15.381">     reference: &quot;&quot;,</span>
<a href="#l15.382"></a><span id="l15.382">     newsgroup: &quot;&quot;,</span>
<a href="#l15.383"></a><span id="l15.383">     composeformat: COMPOSE_HTML,</span>
<a href="#l15.384"></a><span id="l15.384">     from: &quot;&quot;,</span>
<a href="#l15.385"></a><span id="l15.385">     followupto: &quot;&quot;,</span>
<a href="#l15.386"></a><span id="l15.386">     organization: &quot;&quot;,</span>
<a href="#l15.387"></a><span id="l15.387">     replyto: &quot;&quot;,</span>
<a href="#l15.388"></a><span id="l15.388">     priority: &quot;&quot;,</span>
<a href="#l15.389"></a><span id="l15.389" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.390"></a><span id="l15.390" class="difflineminus">-  },</span>
<a href="#l15.391"></a><span id="l15.391" class="difflineminus">-  {</span>
<a href="#l15.392"></a><span id="l15.392" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.393"></a><span id="l15.393" class="difflineplus">+  }, {</span>
<a href="#l15.394"></a><span id="l15.394">     url: &quot;mailto:?references=%3Cref1%40example.com%3E&quot;,</span>
<a href="#l15.395"></a><span id="l15.395">     to: &quot;&quot;,</span>
<a href="#l15.396"></a><span id="l15.396">     cc: &quot;&quot;,</span>
<a href="#l15.397"></a><span id="l15.397">     bcc: &quot;&quot;,</span>
<a href="#l15.398"></a><span id="l15.398">     subject: &quot;&quot;,</span>
<a href="#l15.399"></a><span id="l15.399">     body: &quot;&quot;,</span>
<a href="#l15.400"></a><span id="l15.400">     html: &quot;&quot;,</span>
<a href="#l15.401"></a><span id="l15.401">     reference: &quot;&lt;ref1@example.com&gt;&quot;,</span>
<a href="#l15.402"></a><span id="l15.402">     newsgroup: &quot;&quot;,</span>
<a href="#l15.403"></a><span id="l15.403">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.404"></a><span id="l15.404">     from: &quot;&quot;,</span>
<a href="#l15.405"></a><span id="l15.405">     followupto: &quot;&quot;,</span>
<a href="#l15.406"></a><span id="l15.406">     organization: &quot;&quot;,</span>
<a href="#l15.407"></a><span id="l15.407">     replyto: &quot;&quot;,</span>
<a href="#l15.408"></a><span id="l15.408">     priority: &quot;&quot;,</span>
<a href="#l15.409"></a><span id="l15.409" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.410"></a><span id="l15.410" class="difflineminus">-  },</span>
<a href="#l15.411"></a><span id="l15.411" class="difflineminus">-  {</span>
<a href="#l15.412"></a><span id="l15.412" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.413"></a><span id="l15.413" class="difflineplus">+  }, {</span>
<a href="#l15.414"></a><span id="l15.414">     url: &quot;mailto:?in-reply-to=%3Crepl1%40example.com%3E&quot;,</span>
<a href="#l15.415"></a><span id="l15.415">     to: &quot;&quot;,</span>
<a href="#l15.416"></a><span id="l15.416">     cc: &quot;&quot;,</span>
<a href="#l15.417"></a><span id="l15.417">     bcc: &quot;&quot;,</span>
<a href="#l15.418"></a><span id="l15.418">     subject: &quot;&quot;,</span>
<a href="#l15.419"></a><span id="l15.419">     body: &quot;&quot;,</span>
<a href="#l15.420"></a><span id="l15.420">     html: &quot;&quot;,</span>
<a href="#l15.421"></a><span id="l15.421">     reference: &quot;&lt;repl1@example.com&gt;&quot;,</span>
<a href="#l15.422"></a><span id="l15.422">     newsgroup: &quot;&quot;,</span>
<a href="#l15.423"></a><span id="l15.423">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.424"></a><span id="l15.424">     from: &quot;&quot;,</span>
<a href="#l15.425"></a><span id="l15.425">     followupto: &quot;&quot;,</span>
<a href="#l15.426"></a><span id="l15.426">     organization: &quot;&quot;,</span>
<a href="#l15.427"></a><span id="l15.427">     replyto: &quot;&quot;,</span>
<a href="#l15.428"></a><span id="l15.428">     priority: &quot;&quot;,</span>
<a href="#l15.429"></a><span id="l15.429" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.430"></a><span id="l15.430" class="difflineminus">-  },</span>
<a href="#l15.431"></a><span id="l15.431" class="difflineminus">-  {</span>
<a href="#l15.432"></a><span id="l15.432" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.433"></a><span id="l15.433" class="difflineplus">+  }, {</span>
<a href="#l15.434"></a><span id="l15.434">     url: &quot;mailto:?references=%3Cref2%40example.com%3E&quot; +</span>
<a href="#l15.435"></a><span id="l15.435">          &quot;&amp;in-reply-to=%3Crepl2%40example.com%3E&quot;,</span>
<a href="#l15.436"></a><span id="l15.436">     to: &quot;&quot;,</span>
<a href="#l15.437"></a><span id="l15.437">     cc: &quot;&quot;,</span>
<a href="#l15.438"></a><span id="l15.438">     bcc: &quot;&quot;,</span>
<a href="#l15.439"></a><span id="l15.439">     subject: &quot;&quot;,</span>
<a href="#l15.440"></a><span id="l15.440">     body: &quot;&quot;,</span>
<a href="#l15.441"></a><span id="l15.441">     html: &quot;&quot;,</span>
<a href="#l15.442"></a><span id="l15.442">     reference: &quot;&lt;ref2@example.com&gt; &lt;repl2@example.com&gt;&quot;,</span>
<a href="#l15.443"></a><span id="l15.443">     newsgroup: &quot;&quot;,</span>
<a href="#l15.444"></a><span id="l15.444">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.445"></a><span id="l15.445">     from: &quot;&quot;,</span>
<a href="#l15.446"></a><span id="l15.446">     followupto: &quot;&quot;,</span>
<a href="#l15.447"></a><span id="l15.447">     organization: &quot;&quot;,</span>
<a href="#l15.448"></a><span id="l15.448">     replyto: &quot;&quot;,</span>
<a href="#l15.449"></a><span id="l15.449">     priority: &quot;&quot;,</span>
<a href="#l15.450"></a><span id="l15.450" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.451"></a><span id="l15.451" class="difflineminus">-  },</span>
<a href="#l15.452"></a><span id="l15.452" class="difflineminus">-  {</span>
<a href="#l15.453"></a><span id="l15.453" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.454"></a><span id="l15.454" class="difflineplus">+  }, {</span>
<a href="#l15.455"></a><span id="l15.455">     url: &quot;mailto:?references=%3Cref3%40example.com%3E%20%3Crepl3%40example.com%3E&quot; +</span>
<a href="#l15.456"></a><span id="l15.456">          &quot;&amp;in-reply-to=%3Crepl3%40example.com%3E&quot;,</span>
<a href="#l15.457"></a><span id="l15.457">     to: &quot;&quot;,</span>
<a href="#l15.458"></a><span id="l15.458">     cc: &quot;&quot;,</span>
<a href="#l15.459"></a><span id="l15.459">     bcc: &quot;&quot;,</span>
<a href="#l15.460"></a><span id="l15.460">     subject: &quot;&quot;,</span>
<a href="#l15.461"></a><span id="l15.461">     body: &quot;&quot;,</span>
<a href="#l15.462"></a><span id="l15.462">     html: &quot;&quot;,</span>
<a href="#l15.463"></a><span id="l15.463">     reference: &quot;&lt;ref3@example.com&gt; &lt;repl3@example.com&gt;&quot;,</span>
<a href="#l15.464"></a><span id="l15.464">     newsgroup: &quot;&quot;,</span>
<a href="#l15.465"></a><span id="l15.465">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.466"></a><span id="l15.466">     from: &quot;&quot;,</span>
<a href="#l15.467"></a><span id="l15.467">     followupto: &quot;&quot;,</span>
<a href="#l15.468"></a><span id="l15.468">     organization: &quot;&quot;,</span>
<a href="#l15.469"></a><span id="l15.469">     replyto: &quot;&quot;,</span>
<a href="#l15.470"></a><span id="l15.470">     priority: &quot;&quot;,</span>
<a href="#l15.471"></a><span id="l15.471" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.472"></a><span id="l15.472" class="difflineminus">-  },</span>
<a href="#l15.473"></a><span id="l15.473" class="difflineminus">-  {</span>
<a href="#l15.474"></a><span id="l15.474" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.475"></a><span id="l15.475" class="difflineplus">+  }, {</span>
<a href="#l15.476"></a><span id="l15.476">     url: &quot;mailto:?newsgroups=mozilla.dev.apps.thunderbird&quot;,</span>
<a href="#l15.477"></a><span id="l15.477">     to: &quot;&quot;,</span>
<a href="#l15.478"></a><span id="l15.478">     cc: &quot;&quot;,</span>
<a href="#l15.479"></a><span id="l15.479">     bcc: &quot;&quot;,</span>
<a href="#l15.480"></a><span id="l15.480">     subject: &quot;&quot;,</span>
<a href="#l15.481"></a><span id="l15.481">     body: &quot;&quot;,</span>
<a href="#l15.482"></a><span id="l15.482">     html: &quot;&quot;,</span>
<a href="#l15.483"></a><span id="l15.483">     reference: &quot;&quot;,</span>
<a href="#l15.484"></a><span id="l15.484">     newsgroup: &quot;mozilla.dev.apps.thunderbird&quot;,</span>
<a href="#l15.485"></a><span id="l15.485">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.486"></a><span id="l15.486">     from: &quot;&quot;,</span>
<a href="#l15.487"></a><span id="l15.487">     followupto: &quot;&quot;,</span>
<a href="#l15.488"></a><span id="l15.488">     organization: &quot;&quot;,</span>
<a href="#l15.489"></a><span id="l15.489">     replyto: &quot;&quot;,</span>
<a href="#l15.490"></a><span id="l15.490">     priority: &quot;&quot;,</span>
<a href="#l15.491"></a><span id="l15.491" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.492"></a><span id="l15.492" class="difflineminus">-  },</span>
<a href="#l15.493"></a><span id="l15.493" class="difflineminus">-  {</span>
<a href="#l15.494"></a><span id="l15.494" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.495"></a><span id="l15.495" class="difflineplus">+  }, {</span>
<a href="#l15.496"></a><span id="l15.496">     url: &quot;mailto:?newsgroups=%3D%3FUTF-8%3FQ%3Fmozilla.test.multimedia%3F%3D&quot;,</span>
<a href="#l15.497"></a><span id="l15.497">     to: &quot;&quot;,</span>
<a href="#l15.498"></a><span id="l15.498">     cc: &quot;&quot;,</span>
<a href="#l15.499"></a><span id="l15.499">     bcc: &quot;&quot;,</span>
<a href="#l15.500"></a><span id="l15.500">     subject: &quot;&quot;,</span>
<a href="#l15.501"></a><span id="l15.501">     body: &quot;&quot;,</span>
<a href="#l15.502"></a><span id="l15.502">     html: &quot;&quot;,</span>
<a href="#l15.503"></a><span id="l15.503">     reference: &quot;&quot;,</span>
<a href="#l15.504"></a><span id="l15.504">     newsgroup: &quot;mozilla.test.multimedia&quot;,</span>
<a href="#l15.505"></a><span id="l15.505">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.506"></a><span id="l15.506">     from: &quot;&quot;,</span>
<a href="#l15.507"></a><span id="l15.507">     followupto: &quot;&quot;,</span>
<a href="#l15.508"></a><span id="l15.508">     organization: &quot;&quot;,</span>
<a href="#l15.509"></a><span id="l15.509">     replyto: &quot;&quot;,</span>
<a href="#l15.510"></a><span id="l15.510">     priority: &quot;&quot;,</span>
<a href="#l15.511"></a><span id="l15.511" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.512"></a><span id="l15.512" class="difflineminus">-  },</span>
<a href="#l15.513"></a><span id="l15.513" class="difflineminus">-  {</span>
<a href="#l15.514"></a><span id="l15.514" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.515"></a><span id="l15.515" class="difflineplus">+  }, {</span>
<a href="#l15.516"></a><span id="l15.516">     url: &quot;mailto:?from=notlikely@example.com&quot;,</span>
<a href="#l15.517"></a><span id="l15.517">     to: &quot;&quot;,</span>
<a href="#l15.518"></a><span id="l15.518">     cc: &quot;&quot;,</span>
<a href="#l15.519"></a><span id="l15.519">     bcc: &quot;&quot;,</span>
<a href="#l15.520"></a><span id="l15.520">     subject: &quot;&quot;,</span>
<a href="#l15.521"></a><span id="l15.521">     body: &quot;&quot;,</span>
<a href="#l15.522"></a><span id="l15.522">     html: &quot;&quot;,</span>
<a href="#l15.523"></a><span id="l15.523">     reference: &quot;&quot;,</span>
<a href="#l15.524"></a><span id="l15.524">     newsgroup: &quot;&quot;,</span>
<a href="#l15.525"></a><span id="l15.525">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.526"></a><span id="l15.526">     from: &quot;notlikely@example.com&quot;,</span>
<a href="#l15.527"></a><span id="l15.527">     followupto: &quot;&quot;,</span>
<a href="#l15.528"></a><span id="l15.528">     organization: &quot;&quot;,</span>
<a href="#l15.529"></a><span id="l15.529">     replyto: &quot;&quot;,</span>
<a href="#l15.530"></a><span id="l15.530">     priority: &quot;&quot;,</span>
<a href="#l15.531"></a><span id="l15.531" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.532"></a><span id="l15.532" class="difflineminus">-  },</span>
<a href="#l15.533"></a><span id="l15.533" class="difflineminus">-  {</span>
<a href="#l15.534"></a><span id="l15.534" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.535"></a><span id="l15.535" class="difflineplus">+  }, {</span>
<a href="#l15.536"></a><span id="l15.536">     url: &quot;mailto:?from=%3D%3FUTF-8%3FQ%3Fme@example.com%3F%3D&quot;,</span>
<a href="#l15.537"></a><span id="l15.537">     to: &quot;&quot;,</span>
<a href="#l15.538"></a><span id="l15.538">     cc: &quot;&quot;,</span>
<a href="#l15.539"></a><span id="l15.539">     bcc: &quot;&quot;,</span>
<a href="#l15.540"></a><span id="l15.540">     subject: &quot;&quot;,</span>
<a href="#l15.541"></a><span id="l15.541">     body: &quot;&quot;,</span>
<a href="#l15.542"></a><span id="l15.542">     html: &quot;&quot;,</span>
<a href="#l15.543"></a><span id="l15.543">     reference: &quot;&quot;,</span>
<a href="#l15.544"></a><span id="l15.544">     newsgroup: &quot;&quot;,</span>
<a href="#l15.545"></a><span id="l15.545">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.546"></a><span id="l15.546">     from: &quot;me@example.com&quot;,</span>
<a href="#l15.547"></a><span id="l15.547">     followupto: &quot;&quot;,</span>
<a href="#l15.548"></a><span id="l15.548">     organization: &quot;&quot;,</span>
<a href="#l15.549"></a><span id="l15.549">     replyto: &quot;&quot;,</span>
<a href="#l15.550"></a><span id="l15.550">     priority: &quot;&quot;,</span>
<a href="#l15.551"></a><span id="l15.551" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.552"></a><span id="l15.552" class="difflineminus">-  },</span>
<a href="#l15.553"></a><span id="l15.553" class="difflineminus">-  {</span>
<a href="#l15.554"></a><span id="l15.554" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.555"></a><span id="l15.555" class="difflineplus">+  }, {</span>
<a href="#l15.556"></a><span id="l15.556">     url: &quot;mailto:?followup-to=mozilla.dev.planning&quot;,</span>
<a href="#l15.557"></a><span id="l15.557">     to: &quot;&quot;,</span>
<a href="#l15.558"></a><span id="l15.558">     cc: &quot;&quot;,</span>
<a href="#l15.559"></a><span id="l15.559">     bcc: &quot;&quot;,</span>
<a href="#l15.560"></a><span id="l15.560">     subject: &quot;&quot;,</span>
<a href="#l15.561"></a><span id="l15.561">     body: &quot;&quot;,</span>
<a href="#l15.562"></a><span id="l15.562">     html: &quot;&quot;,</span>
<a href="#l15.563"></a><span id="l15.563">     reference: &quot;&quot;,</span>
<a href="#l15.564"></a><span id="l15.564">     newsgroup: &quot;&quot;,</span>
<a href="#l15.565"></a><span id="l15.565">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.566"></a><span id="l15.566">     from: &quot;&quot;,</span>
<a href="#l15.567"></a><span id="l15.567">     followupto: &quot;mozilla.dev.planning&quot;,</span>
<a href="#l15.568"></a><span id="l15.568">     organization: &quot;&quot;,</span>
<a href="#l15.569"></a><span id="l15.569">     replyto: &quot;&quot;,</span>
<a href="#l15.570"></a><span id="l15.570">     priority: &quot;&quot;,</span>
<a href="#l15.571"></a><span id="l15.571" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.572"></a><span id="l15.572" class="difflineminus">-  },</span>
<a href="#l15.573"></a><span id="l15.573" class="difflineminus">-  {</span>
<a href="#l15.574"></a><span id="l15.574" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.575"></a><span id="l15.575" class="difflineplus">+  }, {</span>
<a href="#l15.576"></a><span id="l15.576">     url: &quot;mailto:?followup-to=%3D%3FUTF-8%3FQ%3Fmozilla.test%3F%3D&quot;,</span>
<a href="#l15.577"></a><span id="l15.577">     to: &quot;&quot;,</span>
<a href="#l15.578"></a><span id="l15.578">     cc: &quot;&quot;,</span>
<a href="#l15.579"></a><span id="l15.579">     bcc: &quot;&quot;,</span>
<a href="#l15.580"></a><span id="l15.580">     subject: &quot;&quot;,</span>
<a href="#l15.581"></a><span id="l15.581">     body: &quot;&quot;,</span>
<a href="#l15.582"></a><span id="l15.582">     html: &quot;&quot;,</span>
<a href="#l15.583"></a><span id="l15.583">     reference: &quot;&quot;,</span>
<a href="#l15.584"></a><span id="l15.584">     newsgroup: &quot;&quot;,</span>
<a href="#l15.585"></a><span id="l15.585">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.586"></a><span id="l15.586">     from: &quot;&quot;,</span>
<a href="#l15.587"></a><span id="l15.587">     followupto: &quot;mozilla.test&quot;,</span>
<a href="#l15.588"></a><span id="l15.588">     organization: &quot;&quot;,</span>
<a href="#l15.589"></a><span id="l15.589">     replyto: &quot;&quot;,</span>
<a href="#l15.590"></a><span id="l15.590">     priority: &quot;&quot;,</span>
<a href="#l15.591"></a><span id="l15.591" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.592"></a><span id="l15.592" class="difflineminus">-  },</span>
<a href="#l15.593"></a><span id="l15.593" class="difflineminus">-  {</span>
<a href="#l15.594"></a><span id="l15.594" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.595"></a><span id="l15.595" class="difflineplus">+  }, {</span>
<a href="#l15.596"></a><span id="l15.596">     url: &quot;mailto:?organization=very%20little&quot;,</span>
<a href="#l15.597"></a><span id="l15.597">     to: &quot;&quot;,</span>
<a href="#l15.598"></a><span id="l15.598">     cc: &quot;&quot;,</span>
<a href="#l15.599"></a><span id="l15.599">     bcc: &quot;&quot;,</span>
<a href="#l15.600"></a><span id="l15.600">     subject: &quot;&quot;,</span>
<a href="#l15.601"></a><span id="l15.601">     body: &quot;&quot;,</span>
<a href="#l15.602"></a><span id="l15.602">     html: &quot;&quot;,</span>
<a href="#l15.603"></a><span id="l15.603">     reference: &quot;&quot;,</span>
<a href="#l15.604"></a><span id="l15.604">     newsgroup: &quot;&quot;,</span>
<a href="#l15.605"></a><span id="l15.605">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.606"></a><span id="l15.606">     from: &quot;&quot;,</span>
<a href="#l15.607"></a><span id="l15.607">     followupto: &quot;&quot;,</span>
<a href="#l15.608"></a><span id="l15.608">     organization: &quot;very little&quot;,</span>
<a href="#l15.609"></a><span id="l15.609">     replyto: &quot;&quot;,</span>
<a href="#l15.610"></a><span id="l15.610">     priority: &quot;&quot;,</span>
<a href="#l15.611"></a><span id="l15.611" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.612"></a><span id="l15.612" class="difflineminus">-  },</span>
<a href="#l15.613"></a><span id="l15.613" class="difflineminus">-  {</span>
<a href="#l15.614"></a><span id="l15.614" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.615"></a><span id="l15.615" class="difflineplus">+  }, {</span>
<a href="#l15.616"></a><span id="l15.616">     url: &quot;mailto:?organization=%3D%3FUTF-8%3FQ%3Fmicroscopic%3F%3D&quot;,</span>
<a href="#l15.617"></a><span id="l15.617">     to: &quot;&quot;,</span>
<a href="#l15.618"></a><span id="l15.618">     cc: &quot;&quot;,</span>
<a href="#l15.619"></a><span id="l15.619">     bcc: &quot;&quot;,</span>
<a href="#l15.620"></a><span id="l15.620">     subject: &quot;&quot;,</span>
<a href="#l15.621"></a><span id="l15.621">     body: &quot;&quot;,</span>
<a href="#l15.622"></a><span id="l15.622">     html: &quot;&quot;,</span>
<a href="#l15.623"></a><span id="l15.623">     reference: &quot;&quot;,</span>
<a href="#l15.624"></a><span id="l15.624">     newsgroup: &quot;&quot;,</span>
<a href="#l15.625"></a><span id="l15.625">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.626"></a><span id="l15.626">     from: &quot;&quot;,</span>
<a href="#l15.627"></a><span id="l15.627">     followupto: &quot;&quot;,</span>
<a href="#l15.628"></a><span id="l15.628">     organization: &quot;microscopic&quot;,</span>
<a href="#l15.629"></a><span id="l15.629">     replyto: &quot;&quot;,</span>
<a href="#l15.630"></a><span id="l15.630">     priority: &quot;&quot;,</span>
<a href="#l15.631"></a><span id="l15.631" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.632"></a><span id="l15.632" class="difflineminus">-  },</span>
<a href="#l15.633"></a><span id="l15.633" class="difflineminus">-  {</span>
<a href="#l15.634"></a><span id="l15.634" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.635"></a><span id="l15.635" class="difflineplus">+  }, {</span>
<a href="#l15.636"></a><span id="l15.636">     url: &quot;mailto:?reply-to=notme@example.com&quot;,</span>
<a href="#l15.637"></a><span id="l15.637">     to: &quot;&quot;,</span>
<a href="#l15.638"></a><span id="l15.638">     cc: &quot;&quot;,</span>
<a href="#l15.639"></a><span id="l15.639">     bcc: &quot;&quot;,</span>
<a href="#l15.640"></a><span id="l15.640">     subject: &quot;&quot;,</span>
<a href="#l15.641"></a><span id="l15.641">     body: &quot;&quot;,</span>
<a href="#l15.642"></a><span id="l15.642">     html: &quot;&quot;,</span>
<a href="#l15.643"></a><span id="l15.643">     reference: &quot;&quot;,</span>
<a href="#l15.644"></a><span id="l15.644">     newsgroup: &quot;&quot;,</span>
<a href="#l15.645"></a><span id="l15.645">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.646"></a><span id="l15.646">     from: &quot;&quot;,</span>
<a href="#l15.647"></a><span id="l15.647">     followupto: &quot;&quot;,</span>
<a href="#l15.648"></a><span id="l15.648">     organization: &quot;&quot;,</span>
<a href="#l15.649"></a><span id="l15.649">     replyto: &quot;notme@example.com&quot;,</span>
<a href="#l15.650"></a><span id="l15.650">     priority: &quot;&quot;,</span>
<a href="#l15.651"></a><span id="l15.651" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.652"></a><span id="l15.652" class="difflineminus">-  },</span>
<a href="#l15.653"></a><span id="l15.653" class="difflineminus">-  {</span>
<a href="#l15.654"></a><span id="l15.654" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.655"></a><span id="l15.655" class="difflineplus">+  }, {</span>
<a href="#l15.656"></a><span id="l15.656">     url: &quot;mailto:?reply-to=%3D%3FUTF-8%3FB%3Fw4VrZQ%3D%3D%3F%3D%20%3Cake@example.org%3E&quot;,</span>
<a href="#l15.657"></a><span id="l15.657">     to: &quot;&quot;,</span>
<a href="#l15.658"></a><span id="l15.658">     cc: &quot;&quot;,</span>
<a href="#l15.659"></a><span id="l15.659">     bcc: &quot;&quot;,</span>
<a href="#l15.660"></a><span id="l15.660">     subject: &quot;&quot;,</span>
<a href="#l15.661"></a><span id="l15.661">     body: &quot;&quot;,</span>
<a href="#l15.662"></a><span id="l15.662">     html: &quot;&quot;,</span>
<a href="#l15.663"></a><span id="l15.663">     reference: &quot;&quot;,</span>
<a href="#l15.664"></a><span id="l15.664">     newsgroup: &quot;&quot;,</span>
<a href="#l15.665"></a><span id="l15.665">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.666"></a><span id="l15.666">     from: &quot;&quot;,</span>
<a href="#l15.667"></a><span id="l15.667">     followupto: &quot;&quot;,</span>
<a href="#l15.668"></a><span id="l15.668">     organization: &quot;&quot;,</span>
<a href="#l15.669"></a><span id="l15.669">     replyto: &quot;ke &lt;ake@example.org&gt;&quot;,</span>
<a href="#l15.670"></a><span id="l15.670">     priority: &quot;&quot;,</span>
<a href="#l15.671"></a><span id="l15.671" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.672"></a><span id="l15.672" class="difflineminus">-  },</span>
<a href="#l15.673"></a><span id="l15.673" class="difflineminus">-  {</span>
<a href="#l15.674"></a><span id="l15.674" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.675"></a><span id="l15.675" class="difflineplus">+  }, {</span>
<a href="#l15.676"></a><span id="l15.676">     url: &quot;mailto:?priority=1%20(People%20Are%20Dying!!1!)&quot;,</span>
<a href="#l15.677"></a><span id="l15.677">     to: &quot;&quot;,</span>
<a href="#l15.678"></a><span id="l15.678">     cc: &quot;&quot;,</span>
<a href="#l15.679"></a><span id="l15.679">     bcc: &quot;&quot;,</span>
<a href="#l15.680"></a><span id="l15.680">     subject: &quot;&quot;,</span>
<a href="#l15.681"></a><span id="l15.681">     body: &quot;&quot;,</span>
<a href="#l15.682"></a><span id="l15.682">     html: &quot;&quot;,</span>
<a href="#l15.683"></a><span id="l15.683">     reference: &quot;&quot;,</span>
<a href="#l15.684"></a><span id="l15.684">     newsgroup: &quot;&quot;,</span>
<a href="#l15.685"></a><span id="l15.685">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.686"></a><span id="l15.686">     from: &quot;&quot;,</span>
<a href="#l15.687"></a><span id="l15.687">     followupto: &quot;&quot;,</span>
<a href="#l15.688"></a><span id="l15.688">     organization: &quot;&quot;,</span>
<a href="#l15.689"></a><span id="l15.689">     replyto: &quot;&quot;,</span>
<a href="#l15.690"></a><span id="l15.690">     priority: &quot;1 (People Are Dying!!1!)&quot;,</span>
<a href="#l15.691"></a><span id="l15.691" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.692"></a><span id="l15.692" class="difflineminus">-  },</span>
<a href="#l15.693"></a><span id="l15.693" class="difflineminus">-  {</span>
<a href="#l15.694"></a><span id="l15.694" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.695"></a><span id="l15.695" class="difflineplus">+  }, {</span>
<a href="#l15.696"></a><span id="l15.696">     url: &quot;mailto:?priority=%3D%3FUTF-8%3FQ%3F4%3F%3D&quot;,</span>
<a href="#l15.697"></a><span id="l15.697">     to: &quot;&quot;,</span>
<a href="#l15.698"></a><span id="l15.698">     cc: &quot;&quot;,</span>
<a href="#l15.699"></a><span id="l15.699">     bcc: &quot;&quot;,</span>
<a href="#l15.700"></a><span id="l15.700">     subject: &quot;&quot;,</span>
<a href="#l15.701"></a><span id="l15.701">     body: &quot;&quot;,</span>
<a href="#l15.702"></a><span id="l15.702">     html: &quot;&quot;,</span>
<a href="#l15.703"></a><span id="l15.703">     reference: &quot;&quot;,</span>
<a href="#l15.704"></a><span id="l15.704">     newsgroup: &quot;&quot;,</span>
<a href="#l15.705"></a><span id="l15.705">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.706"></a><span id="l15.706">     from: &quot;&quot;,</span>
<a href="#l15.707"></a><span id="l15.707">     followupto: &quot;&quot;,</span>
<a href="#l15.708"></a><span id="l15.708">     organization: &quot;&quot;,</span>
<a href="#l15.709"></a><span id="l15.709">     replyto: &quot;&quot;,</span>
<a href="#l15.710"></a><span id="l15.710">     priority: &quot;4&quot;,</span>
<a href="#l15.711"></a><span id="l15.711" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.712"></a><span id="l15.712" class="difflineminus">-  },</span>
<a href="#l15.713"></a><span id="l15.713" class="difflineminus">-  {</span>
<a href="#l15.714"></a><span id="l15.714" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.715"></a><span id="l15.715" class="difflineplus">+  }, {</span>
<a href="#l15.716"></a><span id="l15.716">     url: &quot;mailto:?newshost=news.mozilla.org&quot;,</span>
<a href="#l15.717"></a><span id="l15.717">     to: &quot;&quot;,</span>
<a href="#l15.718"></a><span id="l15.718">     cc: &quot;&quot;,</span>
<a href="#l15.719"></a><span id="l15.719">     bcc: &quot;&quot;,</span>
<a href="#l15.720"></a><span id="l15.720">     subject: &quot;&quot;,</span>
<a href="#l15.721"></a><span id="l15.721">     body: &quot;&quot;,</span>
<a href="#l15.722"></a><span id="l15.722">     html: &quot;&quot;,</span>
<a href="#l15.723"></a><span id="l15.723">     reference: &quot;&quot;,</span>
<a href="#l15.724"></a><span id="l15.724">     newsgroup: &quot;&quot;,</span>
<a href="#l15.725"></a><span id="l15.725">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.726"></a><span id="l15.726">     from: &quot;&quot;,</span>
<a href="#l15.727"></a><span id="l15.727">     followupto: &quot;&quot;,</span>
<a href="#l15.728"></a><span id="l15.728">     organization: &quot;&quot;,</span>
<a href="#l15.729"></a><span id="l15.729">     replyto: &quot;&quot;,</span>
<a href="#l15.730"></a><span id="l15.730">     priority: &quot;&quot;,</span>
<a href="#l15.731"></a><span id="l15.731" class="difflineminus">-    newshost: &quot;news.mozilla.org&quot;</span>
<a href="#l15.732"></a><span id="l15.732" class="difflineminus">-  },</span>
<a href="#l15.733"></a><span id="l15.733" class="difflineminus">-  {</span>
<a href="#l15.734"></a><span id="l15.734" class="difflineplus">+    newshost: &quot;news.mozilla.org&quot;,</span>
<a href="#l15.735"></a><span id="l15.735" class="difflineplus">+  }, {</span>
<a href="#l15.736"></a><span id="l15.736">     url: &quot;mailto:?newshost=%3D%3FUTF-8%3FQ%3Fnews.example.org%3F%3D&quot;,</span>
<a href="#l15.737"></a><span id="l15.737">     to: &quot;&quot;,</span>
<a href="#l15.738"></a><span id="l15.738">     cc: &quot;&quot;,</span>
<a href="#l15.739"></a><span id="l15.739">     bcc: &quot;&quot;,</span>
<a href="#l15.740"></a><span id="l15.740">     subject: &quot;&quot;,</span>
<a href="#l15.741"></a><span id="l15.741">     body: &quot;&quot;,</span>
<a href="#l15.742"></a><span id="l15.742">     html: &quot;&quot;,</span>
<a href="#l15.743"></a><span id="l15.743">     reference: &quot;&quot;,</span>
<a href="#l15.744"></a><span id="l15.744">     newsgroup: &quot;&quot;,</span>
<a href="#l15.745"></a><span id="l15.745">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.746"></a><span id="l15.746">     from: &quot;&quot;,</span>
<a href="#l15.747"></a><span id="l15.747">     followupto: &quot;&quot;,</span>
<a href="#l15.748"></a><span id="l15.748">     organization: &quot;&quot;,</span>
<a href="#l15.749"></a><span id="l15.749">     replyto: &quot;&quot;,</span>
<a href="#l15.750"></a><span id="l15.750">     priority: &quot;&quot;,</span>
<a href="#l15.751"></a><span id="l15.751" class="difflineminus">-    newshost: &quot;news.example.org&quot;</span>
<a href="#l15.752"></a><span id="l15.752" class="difflineminus">-  },</span>
<a href="#l15.753"></a><span id="l15.753" class="difflineminus">-  {</span>
<a href="#l15.754"></a><span id="l15.754" class="difflineplus">+    newshost: &quot;news.example.org&quot;,</span>
<a href="#l15.755"></a><span id="l15.755" class="difflineplus">+  }, {</span>
<a href="#l15.756"></a><span id="l15.756">     url: &quot;mailto:?%74%4F=to&amp;%73%55%62%4A%65%43%74=subject&amp;%62%4F%64%59=body&amp;%63%43=cc&amp;%62%43%63=bcc&quot;,</span>
<a href="#l15.757"></a><span id="l15.757">     to: &quot;to&quot;,</span>
<a href="#l15.758"></a><span id="l15.758">     cc: &quot;cc&quot;,</span>
<a href="#l15.759"></a><span id="l15.759">     bcc: &quot;bcc&quot;,</span>
<a href="#l15.760"></a><span id="l15.760">     subject: &quot;subject&quot;,</span>
<a href="#l15.761"></a><span id="l15.761">     body: &quot;body&quot;,</span>
<a href="#l15.762"></a><span id="l15.762">     html: &quot;&quot;,</span>
<a href="#l15.763"></a><span id="l15.763">     reference: &quot;&quot;,</span>
<a href="#l15.764"></a><span id="l15.764">     newsgroup: &quot;&quot;,</span>
<a href="#l15.765"></a><span id="l15.765">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.766"></a><span id="l15.766">     from: &quot;&quot;,</span>
<a href="#l15.767"></a><span id="l15.767">     followupto: &quot;&quot;,</span>
<a href="#l15.768"></a><span id="l15.768">     organization: &quot;&quot;,</span>
<a href="#l15.769"></a><span id="l15.769">     replyto: &quot;&quot;,</span>
<a href="#l15.770"></a><span id="l15.770">     priority: &quot;&quot;,</span>
<a href="#l15.771"></a><span id="l15.771" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.772"></a><span id="l15.772" class="difflineminus">-  },</span>
<a href="#l15.773"></a><span id="l15.773" class="difflineminus">-  {</span>
<a href="#l15.774"></a><span id="l15.774" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.775"></a><span id="l15.775" class="difflineplus">+  }, {</span>
<a href="#l15.776"></a><span id="l15.776">     url: &quot;mailto:to1?%74%4F=to2&amp;to=to3&amp;subject=&amp;%73%55%62%4A%65%43%74=subject&amp;%62%4F%64%59=line1&amp;body=line2&amp;%63%43=cc1&amp;cc=cc2&amp;%62%43%63=bcc1&amp;bcc=bcc2&quot;,</span>
<a href="#l15.777"></a><span id="l15.777">     to: &quot;to1, to2, to3&quot;,</span>
<a href="#l15.778"></a><span id="l15.778">     cc: &quot;cc1, cc2&quot;,</span>
<a href="#l15.779"></a><span id="l15.779">     bcc: &quot;bcc1, bcc2&quot;,</span>
<a href="#l15.780"></a><span id="l15.780">     subject: &quot;subject&quot;,</span>
<a href="#l15.781"></a><span id="l15.781">     body: &quot;line1\nline2&quot;,</span>
<a href="#l15.782"></a><span id="l15.782">     html: &quot;&quot;,</span>
<a href="#l15.783"></a><span id="l15.783">     reference: &quot;&quot;,</span>
<a href="#l15.784"></a><span id="l15.784">     newsgroup: &quot;&quot;,</span>
<a href="#l15.785"></a><span id="l15.785">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.786"></a><span id="l15.786">     from: &quot;&quot;,</span>
<a href="#l15.787"></a><span id="l15.787">     followupto: &quot;&quot;,</span>
<a href="#l15.788"></a><span id="l15.788">     organization: &quot;&quot;,</span>
<a href="#l15.789"></a><span id="l15.789">     replyto: &quot;&quot;,</span>
<a href="#l15.790"></a><span id="l15.790">     priority: &quot;&quot;,</span>
<a href="#l15.791"></a><span id="l15.791" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.792"></a><span id="l15.792" class="difflineminus">-  },</span>
<a href="#l15.793"></a><span id="l15.793" class="difflineminus">-  {</span>
<a href="#l15.794"></a><span id="l15.794" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.795"></a><span id="l15.795" class="difflineplus">+  }, {</span>
<a href="#l15.796"></a><span id="l15.796">     url: &quot;mailto:?nto=1&amp;nsubject=2&amp;nbody=3&amp;ncc=4&amp;nbcc=5&quot;,</span>
<a href="#l15.797"></a><span id="l15.797">     to: &quot;&quot;,</span>
<a href="#l15.798"></a><span id="l15.798">     cc: &quot;&quot;,</span>
<a href="#l15.799"></a><span id="l15.799">     bcc: &quot;&quot;,</span>
<a href="#l15.800"></a><span id="l15.800">     subject: &quot;&quot;,</span>
<a href="#l15.801"></a><span id="l15.801">     body: &quot;&quot;,</span>
<a href="#l15.802"></a><span id="l15.802">     html: &quot;&quot;,</span>
<a href="#l15.803"></a><span id="l15.803">     reference: &quot;&quot;,</span>
<a href="#l15.804"></a><span id="l15.804">     newsgroup: &quot;&quot;,</span>
<a href="#l15.805"></a><span id="l15.805">     composeformat: COMPOSE_DEFAULT,</span>
<a href="#l15.806"></a><span id="l15.806">     from: &quot;&quot;,</span>
<a href="#l15.807"></a><span id="l15.807">     followupto: &quot;&quot;,</span>
<a href="#l15.808"></a><span id="l15.808">     organization: &quot;&quot;,</span>
<a href="#l15.809"></a><span id="l15.809">     replyto: &quot;&quot;,</span>
<a href="#l15.810"></a><span id="l15.810">     priority: &quot;&quot;,</span>
<a href="#l15.811"></a><span id="l15.811" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.812"></a><span id="l15.812" class="difflineminus">-  },</span>
<a href="#l15.813"></a><span id="l15.813" class="difflineminus">-  {</span>
<a href="#l15.814"></a><span id="l15.814" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.815"></a><span id="l15.815" class="difflineplus">+  }, {</span>
<a href="#l15.816"></a><span id="l15.816">     url: &quot;mailto:%CE%B1?cc=%CE%B2&amp;bcc=%CE%B3&amp;subject=%CE%B4&amp;body=%CE%B5&quot; +</span>
<a href="#l15.817"></a><span id="l15.817">          &quot;&amp;html-body=%CE%BE&amp;newsgroups=%CE%B6&amp;from=%CE%B7&amp;followup-to=%CE%B8&quot; +</span>
<a href="#l15.818"></a><span id="l15.818">          &quot;&amp;organization=%CE%B9&amp;reply-to=%CE%BA&amp;priority=%CE%BB&amp;newshost=%CE%BC&quot;,</span>
<a href="#l15.819"></a><span id="l15.819">     to: &quot;&quot;,</span>
<a href="#l15.820"></a><span id="l15.820">     cc: &quot;&quot;,</span>
<a href="#l15.821"></a><span id="l15.821">     bcc: &quot;&quot;,</span>
<a href="#l15.822"></a><span id="l15.822">     subject: &quot;&quot;,</span>
<a href="#l15.823"></a><span id="l15.823">     body: &quot;&quot;,</span>
<a href="#l15.824"></a><span id="l15.824" class="difflineat">@@ -767,11 +728,11 @@ var tests = [</span>
<a href="#l15.825"></a><span id="l15.825">     reference: &quot;&quot;, // we expect this field to be ASCII-only</span>
<a href="#l15.826"></a><span id="l15.826">     newsgroup: &quot;&quot;,</span>
<a href="#l15.827"></a><span id="l15.827">     composeformat: COMPOSE_HTML,</span>
<a href="#l15.828"></a><span id="l15.828">     from: &quot;&quot;,</span>
<a href="#l15.829"></a><span id="l15.829">     followupto: &quot;&quot;,</span>
<a href="#l15.830"></a><span id="l15.830">     organization: &quot;&quot;,</span>
<a href="#l15.831"></a><span id="l15.831">     replyto: &quot;&quot;,</span>
<a href="#l15.832"></a><span id="l15.832">     priority: &quot;&quot;,</span>
<a href="#l15.833"></a><span id="l15.833" class="difflineminus">-    newshost: &quot;&quot;</span>
<a href="#l15.834"></a><span id="l15.834" class="difflineplus">+    newshost: &quot;&quot;,</span>
<a href="#l15.835"></a><span id="l15.835">   },</span>
<a href="#l15.836"></a><span id="l15.836"> ];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_messageHeaders.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_messageHeaders.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -51,34 +51,38 @@ function checkDraftHeaders(expectedHeade</span>
<a href="#l16.4"></a><span id="l16.4">   let msgData = mailTestUtils</span>
<a href="#l16.5"></a><span id="l16.5">     .loadMessageToString(gDraftFolder, mailTestUtils.firstMsgHdr(gDraftFolder));</span>
<a href="#l16.6"></a><span id="l16.6">   checkMessageHeaders(msgData, expectedHeaders, partNum);</span>
<a href="#l16.7"></a><span id="l16.7"> }</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9"> function checkMessageHeaders(msgData, expectedHeaders, partNum = &quot;&quot;) {</span>
<a href="#l16.10"></a><span id="l16.10">   let seen = false;</span>
<a href="#l16.11"></a><span id="l16.11">   let handler = {</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    startPart: function (part, headers) {</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+    startPart(part, headers) {</span>
<a href="#l16.14"></a><span id="l16.14">       if (part != partNum)</span>
<a href="#l16.15"></a><span id="l16.15">         return;</span>
<a href="#l16.16"></a><span id="l16.16">       seen = true;</span>
<a href="#l16.17"></a><span id="l16.17">       for (let header in expectedHeaders) {</span>
<a href="#l16.18"></a><span id="l16.18">         let expected = expectedHeaders[header];</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-        if (expected === undefined)</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+        if (expected === undefined) {</span>
<a href="#l16.21"></a><span id="l16.21">           Assert.ok(!headers.has(header));</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-        else {</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+        } else {</span>
<a href="#l16.24"></a><span id="l16.24">           let value = headers.getRawHeader(header);</span>
<a href="#l16.25"></a><span id="l16.25">           Assert.equal(value.length, 1);</span>
<a href="#l16.26"></a><span id="l16.26">           value[0] = value[0].replace(/boundary=[^;]*(;|$)/, &quot;boundary=.&quot;);</span>
<a href="#l16.27"></a><span id="l16.27">           Assert.equal(value[0], expected);</span>
<a href="#l16.28"></a><span id="l16.28">         }</span>
<a href="#l16.29"></a><span id="l16.29">       }</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-    }</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+    },</span>
<a href="#l16.32"></a><span id="l16.32">   };</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-  MimeParser.parseSync(msgData, handler, {onerror: function (e) { throw e; }});</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+  MimeParser.parseSync(msgData, handler, {</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+    onerror(e) {</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+      throw e;</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+    },</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+  });</span>
<a href="#l16.39"></a><span id="l16.39">   Assert.ok(seen);</span>
<a href="#l16.40"></a><span id="l16.40"> }</span>
<a href="#l16.41"></a><span id="l16.41"> </span>
<a href="#l16.42"></a><span id="l16.42"> async function testEnvelope() {</span>
<a href="#l16.43"></a><span id="l16.43">   let fields = new CompFields();</span>
<a href="#l16.44"></a><span id="l16.44">   let identity = getSmtpIdentity(&quot;from@tinderbox.invalid&quot;,</span>
<a href="#l16.45"></a><span id="l16.45">     getBasicSmtpServer());</span>
<a href="#l16.46"></a><span id="l16.46">   identity.fullName = &quot;Me&quot;;</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineat">@@ -143,17 +147,17 @@ async function testIDNEnvelope() {</span>
<a href="#l16.48"></a><span id="l16.48">   fields.replyTo = &quot;Charles &lt;charles@&quot; + domain + &quot;&gt;&quot;;</span>
<a href="#l16.49"></a><span id="l16.49">   fields.subject = &quot;This is an obscure reference&quot;;</span>
<a href="#l16.50"></a><span id="l16.50">   await richCreateMessage(fields, [], identity);</span>
<a href="#l16.51"></a><span id="l16.51">   checkDraftHeaders({</span>
<a href="#l16.52"></a><span id="l16.52">     // The identity sets the from field here.</span>
<a href="#l16.53"></a><span id="l16.53">     &quot;From&quot;: &quot;from@tinderbox.invalid&quot;,</span>
<a href="#l16.54"></a><span id="l16.54">     &quot;To&quot;: &quot;Nobody &lt;nobody@&quot; + utf8Domain + &quot;&gt;&quot;,</span>
<a href="#l16.55"></a><span id="l16.55">     &quot;Cc&quot;: &quot;Alex &lt;alex@&quot; + utf8Domain + &quot;&gt;&quot;,</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-    &quot;Bcc&quot;: &quot;Boris &lt;boris@&quot; + utf8Domain +&quot;&gt;&quot;,</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+    &quot;Bcc&quot;: &quot;Boris &lt;boris@&quot; + utf8Domain + &quot;&gt;&quot;,</span>
<a href="#l16.58"></a><span id="l16.58">     &quot;Reply-To&quot;: &quot;Charles &lt;charles@&quot; + utf8Domain + &quot;&gt;&quot;,</span>
<a href="#l16.59"></a><span id="l16.59">     &quot;Subject&quot;: &quot;This is an obscure reference&quot;,</span>
<a href="#l16.60"></a><span id="l16.60">   });</span>
<a href="#l16.61"></a><span id="l16.61"> }</span>
<a href="#l16.62"></a><span id="l16.62"> </span>
<a href="#l16.63"></a><span id="l16.63"> async function testDraftInfo() {</span>
<a href="#l16.64"></a><span id="l16.64">   let fields = new CompFields();</span>
<a href="#l16.65"></a><span id="l16.65">   let identity = getSmtpIdentity(&quot;from@tinderbox.invalid&quot;,</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineat">@@ -319,51 +323,51 @@ async function testContentHeaders() {</span>
<a href="#l16.67"></a><span id="l16.67">   Services.prefs.setIntPref(&quot;mail.strictly_mime.parm_folding&quot;, 2);</span>
<a href="#l16.68"></a><span id="l16.68">   let fields = new CompFields();</span>
<a href="#l16.69"></a><span id="l16.69">   fields.body = &quot;A body&quot;;</span>
<a href="#l16.70"></a><span id="l16.70">   let identity = getSmtpIdentity(&quot;from@tinderbox.invalid&quot;,</span>
<a href="#l16.71"></a><span id="l16.71">     getBasicSmtpServer());</span>
<a href="#l16.72"></a><span id="l16.72">   await richCreateMessage(fields, [], identity);</span>
<a href="#l16.73"></a><span id="l16.73">   checkDraftHeaders({</span>
<a href="#l16.74"></a><span id="l16.74">     &quot;Content-Type&quot;: &quot;text/html; charset=UTF-8&quot;,</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-    &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+    &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;,</span>
<a href="#l16.77"></a><span id="l16.77">   });</span>
<a href="#l16.78"></a><span id="l16.78"> </span>
<a href="#l16.79"></a><span id="l16.79">   // non-ASCII body should be 8-bit...</span>
<a href="#l16.80"></a><span id="l16.80">   fields.body = &quot;Archologist&quot;;</span>
<a href="#l16.81"></a><span id="l16.81">   await richCreateMessage(fields, [], identity);</span>
<a href="#l16.82"></a><span id="l16.82">   checkDraftHeaders({</span>
<a href="#l16.83"></a><span id="l16.83">     &quot;Content-Type&quot;: &quot;text/html; charset=UTF-8&quot;,</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineminus">-    &quot;Content-Transfer-Encoding&quot;: &quot;8bit&quot;</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+    &quot;Content-Transfer-Encoding&quot;: &quot;8bit&quot;,</span>
<a href="#l16.86"></a><span id="l16.86">   });</span>
<a href="#l16.87"></a><span id="l16.87"> </span>
<a href="#l16.88"></a><span id="l16.88">   // What if we change the message charset?</span>
<a href="#l16.89"></a><span id="l16.89">   fields.characterSet = &quot;ISO-8859-1&quot;;</span>
<a href="#l16.90"></a><span id="l16.90">   fields.body = &quot;Archologist&quot;;</span>
<a href="#l16.91"></a><span id="l16.91">   await richCreateMessage(fields, [], identity);</span>
<a href="#l16.92"></a><span id="l16.92">   checkDraftHeaders({</span>
<a href="#l16.93"></a><span id="l16.93">     &quot;Content-Type&quot;: &quot;text/html; charset=ISO-8859-1&quot;,</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-    &quot;Content-Transfer-Encoding&quot;: &quot;8bit&quot;</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+    &quot;Content-Transfer-Encoding&quot;: &quot;8bit&quot;,</span>
<a href="#l16.96"></a><span id="l16.96">   });</span>
<a href="#l16.97"></a><span id="l16.97"> </span>
<a href="#l16.98"></a><span id="l16.98">   // Attachments</span>
<a href="#l16.99"></a><span id="l16.99">   fields.body = &quot;&quot;;</span>
<a href="#l16.100"></a><span id="l16.100">   let plainAttachment = makeAttachment({</span>
<a href="#l16.101"></a><span id="l16.101">     url: &quot;data:text/plain,ol&quot;,</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-    name: &quot;attachment.txt&quot;</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+    name: &quot;attachment.txt&quot;,</span>
<a href="#l16.104"></a><span id="l16.104">   });</span>
<a href="#l16.105"></a><span id="l16.105">   let plainAttachmentHeaders = {</span>
<a href="#l16.106"></a><span id="l16.106">     &quot;Content-Type&quot;: &quot;text/plain; charset=UTF-8&quot;,</span>
<a href="#l16.107"></a><span id="l16.107">     &quot;Content-Transfer-Encoding&quot;: &quot;base64&quot;,</span>
<a href="#l16.108"></a><span id="l16.108">     &quot;Content-Disposition&quot;: &quot;attachment; filename=\&quot;attachment.txt\&quot;&quot;,</span>
<a href="#l16.109"></a><span id="l16.109">   };</span>
<a href="#l16.110"></a><span id="l16.110">   await richCreateMessage(fields, [plainAttachment], identity);</span>
<a href="#l16.111"></a><span id="l16.111">   checkDraftHeaders({</span>
<a href="#l16.112"></a><span id="l16.112">     &quot;Content-Type&quot;: &quot;text/html; charset=ISO-8859-1&quot;,</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineminus">-    &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+    &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;,</span>
<a href="#l16.115"></a><span id="l16.115">   }, &quot;1&quot;);</span>
<a href="#l16.116"></a><span id="l16.116">   checkDraftHeaders(plainAttachmentHeaders, &quot;2&quot;);</span>
<a href="#l16.117"></a><span id="l16.117"> </span>
<a href="#l16.118"></a><span id="l16.118">   plainAttachment.name = &quot;ol.txt&quot;;</span>
<a href="#l16.119"></a><span id="l16.119">   plainAttachmentHeaders[&quot;Content-Disposition&quot;] =</span>
<a href="#l16.120"></a><span id="l16.120">     &quot;attachment; filename*=ISO-8859-1''%6F%EF%6C%2E%74%78%74&quot;;</span>
<a href="#l16.121"></a><span id="l16.121">   await richCreateMessage(fields, [plainAttachment], identity);</span>
<a href="#l16.122"></a><span id="l16.122">   checkDraftHeaders(plainAttachmentHeaders, &quot;2&quot;);</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineat">@@ -382,17 +386,17 @@ async function testContentHeaders() {</span>
<a href="#l16.124"></a><span id="l16.124">     &quot;Content-Type&quot;: &quot;text/html&quot;,</span>
<a href="#l16.125"></a><span id="l16.125">     &quot;Content-Disposition&quot;: &quot;attachment; filename=\&quot;attachment.html\&quot;&quot;,</span>
<a href="#l16.126"></a><span id="l16.126">     &quot;Content-Base&quot;: '&quot;data:text/html,&lt;html&gt;&lt;/html&gt;&quot;',</span>
<a href="#l16.127"></a><span id="l16.127">     &quot;Content-Location&quot;: '&quot;data:text/html,&lt;html&gt;&lt;/html&gt;&quot;',</span>
<a href="#l16.128"></a><span id="l16.128">   };</span>
<a href="#l16.129"></a><span id="l16.129">   await richCreateMessage(fields, [httpAttachment], identity);</span>
<a href="#l16.130"></a><span id="l16.130">   checkDraftHeaders({</span>
<a href="#l16.131"></a><span id="l16.131">     &quot;Content-Base&quot;: undefined,</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineminus">-    &quot;Content-Location&quot;: undefined</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+    &quot;Content-Location&quot;: undefined,</span>
<a href="#l16.134"></a><span id="l16.134">   }, &quot;1&quot;);</span>
<a href="#l16.135"></a><span id="l16.135">   checkDraftHeaders(httpAttachmentHeaders, &quot;2&quot;);</span>
<a href="#l16.136"></a><span id="l16.136"> </span>
<a href="#l16.137"></a><span id="l16.137">   fields.characterSet = &quot;UTF-8&quot;;</span>
<a href="#l16.138"></a><span id="l16.138">   let cloudAttachment = makeAttachment({</span>
<a href="#l16.139"></a><span id="l16.139">     url: Services.io.newFileURI(do_get_file(&quot;data/test-UTF-8.txt&quot;)).spec,</span>
<a href="#l16.140"></a><span id="l16.140">     sendViaCloud: true,</span>
<a href="#l16.141"></a><span id="l16.141">     cloudProviderKey: &quot;akey&quot;,</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineat">@@ -409,77 +413,77 @@ async function testContentHeaders() {</span>
<a href="#l16.143"></a><span id="l16.143">   checkDraftHeaders(cloudAttachmentHeaders, &quot;2&quot;);</span>
<a href="#l16.144"></a><span id="l16.144"> </span>
<a href="#l16.145"></a><span id="l16.145">   // Some multipart/alternative tests.</span>
<a href="#l16.146"></a><span id="l16.146">   fields.body = &quot;Some text&quot;;</span>
<a href="#l16.147"></a><span id="l16.147">   fields.forcePlainText = false;</span>
<a href="#l16.148"></a><span id="l16.148">   fields.useMultipartAlternative = true;</span>
<a href="#l16.149"></a><span id="l16.149">   await richCreateMessage(fields, [], identity);</span>
<a href="#l16.150"></a><span id="l16.150">   checkDraftHeaders({</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineminus">-    &quot;Content-Type&quot;: &quot;multipart/alternative; boundary=.&quot;</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineplus">+    &quot;Content-Type&quot;: &quot;multipart/alternative; boundary=.&quot;,</span>
<a href="#l16.153"></a><span id="l16.153">   });</span>
<a href="#l16.154"></a><span id="l16.154">   checkDraftHeaders({</span>
<a href="#l16.155"></a><span id="l16.155">     &quot;Content-Type&quot;: &quot;text/plain; charset=UTF-8; format=flowed&quot;,</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineminus">-    &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+    &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;,</span>
<a href="#l16.158"></a><span id="l16.158">   }, &quot;1&quot;);</span>
<a href="#l16.159"></a><span id="l16.159">   checkDraftHeaders({</span>
<a href="#l16.160"></a><span id="l16.160">     &quot;Content-Type&quot;: &quot;text/html; charset=UTF-8&quot;,</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineminus">-    &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineplus">+    &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;,</span>
<a href="#l16.163"></a><span id="l16.163">   }, &quot;2&quot;);</span>
<a href="#l16.164"></a><span id="l16.164"> </span>
<a href="#l16.165"></a><span id="l16.165">   // multipart/mixed</span>
<a href="#l16.166"></a><span id="l16.166">   // + multipart/alternative</span>
<a href="#l16.167"></a><span id="l16.167">   //   + text/plain</span>
<a href="#l16.168"></a><span id="l16.168">   //   + text/html</span>
<a href="#l16.169"></a><span id="l16.169">   // + text/plain attachment</span>
<a href="#l16.170"></a><span id="l16.170">   await richCreateMessage(fields, [plainAttachment], identity);</span>
<a href="#l16.171"></a><span id="l16.171">   checkDraftHeaders({</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineminus">-    &quot;Content-Type&quot;: &quot;multipart/mixed; boundary=.&quot;</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+    &quot;Content-Type&quot;: &quot;multipart/mixed; boundary=.&quot;,</span>
<a href="#l16.174"></a><span id="l16.174">   });</span>
<a href="#l16.175"></a><span id="l16.175">   checkDraftHeaders({</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineminus">-    &quot;Content-Type&quot;: &quot;multipart/alternative; boundary=.&quot;</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineplus">+    &quot;Content-Type&quot;: &quot;multipart/alternative; boundary=.&quot;,</span>
<a href="#l16.178"></a><span id="l16.178">   }, &quot;1&quot;);</span>
<a href="#l16.179"></a><span id="l16.179">   checkDraftHeaders({</span>
<a href="#l16.180"></a><span id="l16.180">     &quot;Content-Type&quot;: &quot;text/plain; charset=UTF-8; format=flowed&quot;,</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineminus">-    &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineplus">+    &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;,</span>
<a href="#l16.183"></a><span id="l16.183">   }, &quot;1.1&quot;);</span>
<a href="#l16.184"></a><span id="l16.184">   checkDraftHeaders({</span>
<a href="#l16.185"></a><span id="l16.185">     &quot;Content-Type&quot;: &quot;text/html; charset=UTF-8&quot;,</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineminus">-    &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineplus">+    &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;,</span>
<a href="#l16.188"></a><span id="l16.188">   }, &quot;1.2&quot;);</span>
<a href="#l16.189"></a><span id="l16.189">   checkDraftHeaders(plainAttachmentHeaders, &quot;2&quot;);</span>
<a href="#l16.190"></a><span id="l16.190"> </span>
<a href="#l16.191"></a><span id="l16.191">   // Three attachments, and a multipart/alternative. Oh the humanity!</span>
<a href="#l16.192"></a><span id="l16.192">   await richCreateMessage(fields,</span>
<a href="#l16.193"></a><span id="l16.193">     [plainAttachment, httpAttachment, cloudAttachment], identity);</span>
<a href="#l16.194"></a><span id="l16.194">   checkDraftHeaders({</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineminus">-    &quot;Content-Type&quot;: &quot;multipart/mixed; boundary=.&quot;</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineplus">+    &quot;Content-Type&quot;: &quot;multipart/mixed; boundary=.&quot;,</span>
<a href="#l16.197"></a><span id="l16.197">   });</span>
<a href="#l16.198"></a><span id="l16.198">   checkDraftHeaders({</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineminus">-    &quot;Content-Type&quot;: &quot;multipart/alternative; boundary=.&quot;</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineplus">+    &quot;Content-Type&quot;: &quot;multipart/alternative; boundary=.&quot;,</span>
<a href="#l16.201"></a><span id="l16.201">   }, &quot;1&quot;);</span>
<a href="#l16.202"></a><span id="l16.202">   checkDraftHeaders({</span>
<a href="#l16.203"></a><span id="l16.203">     &quot;Content-Type&quot;: &quot;text/plain; charset=UTF-8; format=flowed&quot;,</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineminus">-    &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineplus">+    &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;,</span>
<a href="#l16.206"></a><span id="l16.206">   }, &quot;1.1&quot;);</span>
<a href="#l16.207"></a><span id="l16.207">   checkDraftHeaders({</span>
<a href="#l16.208"></a><span id="l16.208">     &quot;Content-Type&quot;: &quot;text/html; charset=UTF-8&quot;,</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineminus">-    &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineplus">+    &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;,</span>
<a href="#l16.211"></a><span id="l16.211">   }, &quot;1.2&quot;);</span>
<a href="#l16.212"></a><span id="l16.212">   checkDraftHeaders(cloudAttachmentHeaders, &quot;2&quot;);</span>
<a href="#l16.213"></a><span id="l16.213">   checkDraftHeaders(plainAttachmentHeaders, &quot;3&quot;);</span>
<a href="#l16.214"></a><span id="l16.214">   checkDraftHeaders(httpAttachmentHeaders, &quot;4&quot;);</span>
<a href="#l16.215"></a><span id="l16.215"> </span>
<a href="#l16.216"></a><span id="l16.216">   // Test a request for plain text with text/html.</span>
<a href="#l16.217"></a><span id="l16.217">   fields.forcePlainText = true;</span>
<a href="#l16.218"></a><span id="l16.218">   fields.useMultipartAlternative = false;</span>
<a href="#l16.219"></a><span id="l16.219">   await richCreateMessage(fields, [], identity);</span>
<a href="#l16.220"></a><span id="l16.220">   checkDraftHeaders({</span>
<a href="#l16.221"></a><span id="l16.221">     &quot;Content-Type&quot;: &quot;text/plain; charset=UTF-8; format=flowed&quot;,</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineminus">-    &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineplus">+    &quot;Content-Transfer-Encoding&quot;: &quot;7bit&quot;,</span>
<a href="#l16.224"></a><span id="l16.224">   });</span>
<a href="#l16.225"></a><span id="l16.225"> }</span>
<a href="#l16.226"></a><span id="l16.226"> </span>
<a href="#l16.227"></a><span id="l16.227"> async function testSentMessage() {</span>
<a href="#l16.228"></a><span id="l16.228">   let server = setupServerDaemon();</span>
<a href="#l16.229"></a><span id="l16.229">   let daemon = server._daemon;</span>
<a href="#l16.230"></a><span id="l16.230">   server.start();</span>
<a href="#l16.231"></a><span id="l16.231">   try {</span>
<a href="#l16.232"></a><span id="l16.232" class="difflineat">@@ -495,21 +499,21 @@ async function testSentMessage() {</span>
<a href="#l16.233"></a><span id="l16.233">       &quot;From&quot;: &quot;test@tinderbox.invalid&quot;,</span>
<a href="#l16.234"></a><span id="l16.234">       &quot;To&quot;: &quot;Nobody &lt;nobody@tinderbox.invalid&gt;&quot;,</span>
<a href="#l16.235"></a><span id="l16.235">       &quot;Cc&quot;: &quot;Alex &lt;alex@tinderbox.invalid&gt;&quot;,</span>
<a href="#l16.236"></a><span id="l16.236">       &quot;Bcc&quot;: undefined,</span>
<a href="#l16.237"></a><span id="l16.237">       &quot;Reply-To&quot;: &quot;Charles &lt;charles@tinderbox.invalid&gt;&quot;,</span>
<a href="#l16.238"></a><span id="l16.238">       &quot;X-Mozilla-Status&quot;: undefined,</span>
<a href="#l16.239"></a><span id="l16.239">       &quot;X-Mozilla-Keys&quot;: undefined,</span>
<a href="#l16.240"></a><span id="l16.240">       &quot;X-Mozilla-Draft-Info&quot;: undefined,</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineminus">-      &quot;Fcc&quot;: undefined</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineplus">+      &quot;Fcc&quot;: undefined,</span>
<a href="#l16.243"></a><span id="l16.243">     });</span>
<a href="#l16.244"></a><span id="l16.244">     await sendMessage({&quot;bcc&quot;: &quot;Somebody &lt;test@tinderbox.invalid&quot;}, identity);</span>
<a href="#l16.245"></a><span id="l16.245">     checkMessageHeaders(daemon.post, {</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineminus">-      &quot;To&quot;: &quot;undisclosed-recipients: ;&quot;</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineplus">+      &quot;To&quot;: &quot;undisclosed-recipients: ;&quot;,</span>
<a href="#l16.248"></a><span id="l16.248">     });</span>
<a href="#l16.249"></a><span id="l16.249">     await sendMessage({</span>
<a href="#l16.250"></a><span id="l16.250">       &quot;to&quot;: &quot;Somebody &lt;test@tinderbox.invalid&gt;&quot;,</span>
<a href="#l16.251"></a><span id="l16.251">       &quot;returnReceipt&quot;: true,</span>
<a href="#l16.252"></a><span id="l16.252">       &quot;receiptHeaderType&quot;: Ci.nsIMsgMdnGenerator.eDntRrtType,</span>
<a href="#l16.253"></a><span id="l16.253">     }, identity);</span>
<a href="#l16.254"></a><span id="l16.254">     checkMessageHeaders(daemon.post, {</span>
<a href="#l16.255"></a><span id="l16.255">       &quot;Disposition-Notification-To&quot;: &quot;test@tinderbox.invalid&quot;,</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineat">@@ -539,16 +543,16 @@ var tests = [</span>
<a href="#l16.257"></a><span id="l16.257">   testI18NEnvelope,</span>
<a href="#l16.258"></a><span id="l16.258">   testIDNEnvelope,</span>
<a href="#l16.259"></a><span id="l16.259">   testDraftInfo,</span>
<a href="#l16.260"></a><span id="l16.260">   testOtherHeaders,</span>
<a href="#l16.261"></a><span id="l16.261">   testNewsgroups,</span>
<a href="#l16.262"></a><span id="l16.262">   testSendHeaders,</span>
<a href="#l16.263"></a><span id="l16.263">   testContentHeaders,</span>
<a href="#l16.264"></a><span id="l16.264">   testSentMessage,</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineminus">-]</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineplus">+];</span>
<a href="#l16.267"></a><span id="l16.267"> </span>
<a href="#l16.268"></a><span id="l16.268"> function run_test() {</span>
<a href="#l16.269"></a><span id="l16.269">   // Ensure we have at least one mail account</span>
<a href="#l16.270"></a><span id="l16.270">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l16.271"></a><span id="l16.271">   tests.forEach(x =&gt; add_task(x));</span>
<a href="#l16.272"></a><span id="l16.272">   run_next_test();</span>
<a href="#l16.273"></a><span id="l16.273"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_nsIMsgCompFields.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_nsIMsgCompFields.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1,13 +1,13 @@</span>
<a href="#l17.4"></a><span id="l17.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.5"></a><span id="l17.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.6"></a><span id="l17.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">-/// Test that nsIMsgCompFields works properly</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+// Test that nsIMsgCompFields works properly</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> var nsMsgCompFields = Components.Constructor(</span>
<a href="#l17.12"></a><span id="l17.12">   &quot;@mozilla.org/messengercompose/composefields;1&quot;,</span>
<a href="#l17.13"></a><span id="l17.13">   Ci.nsIMsgCompFields);</span>
<a href="#l17.14"></a><span id="l17.14"> </span>
<a href="#l17.15"></a><span id="l17.15"> function check_headers(enumerator, container) {</span>
<a href="#l17.16"></a><span id="l17.16">   let checkValues = new Set(container.map(header =&gt; header.toLowerCase()));</span>
<a href="#l17.17"></a><span id="l17.17">   for (let value of enumerator) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_nsMsgCompose1.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_nsMsgCompose1.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,42 +1,34 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6"> /**</span>
<a href="#l18.7"></a><span id="l18.7">  * Tests nsMsgCompose expandMailingLists.</span>
<a href="#l18.8"></a><span id="l18.8">  */</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10" class="difflineminus">-var MsgComposeContractID = &quot;@mozilla.org/messengercompose/compose;1&quot;;</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineminus">-var MsgComposeParamsContractID = &quot;@mozilla.org/messengercompose/composeparams;1&quot;;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-var MsgComposeFieldsContractID = &quot;@mozilla.org/messengercompose/composefields;1&quot;;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-var nsIMsgCompose = Ci.nsIMsgCompose;</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-var nsIMsgComposeParams = Ci.nsIMsgComposeParams;</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-var nsIMsgCompFields = Ci.nsIMsgCompFields;</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-</span>
<a href="#l18.17"></a><span id="l18.17"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19"> /**</span>
<a href="#l18.20"></a><span id="l18.20">  * Helper to check population worked as expected.</span>
<a href="#l18.21"></a><span id="l18.21">  * @param aTo - text in the To field</span>
<a href="#l18.22"></a><span id="l18.22">  * @param aCheckTo - the expected To addresses (after possible ist population)</span>
<a href="#l18.23"></a><span id="l18.23">  */</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-function checkPopulate(aTo, aCheckTo)</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-{</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-  var msgCompose = Cc[MsgComposeContractID]</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-                     .createInstance(nsIMsgCompose);</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+function checkPopulate(aTo, aCheckTo) {</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+  var msgCompose = Cc[&quot;@mozilla.org/messengercompose/compose;1&quot;]</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+                     .createInstance(Ci.nsIMsgCompose);</span>
<a href="#l18.31"></a><span id="l18.31"> </span>
<a href="#l18.32"></a><span id="l18.32">   // Set up some basic fields for compose.</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-  var fields = Cc[MsgComposeFieldsContractID]</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-                 .createInstance(nsIMsgCompFields);</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+  var fields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+                 .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l18.37"></a><span id="l18.37"> </span>
<a href="#l18.38"></a><span id="l18.38">   fields.to = aTo;</span>
<a href="#l18.39"></a><span id="l18.39"> </span>
<a href="#l18.40"></a><span id="l18.40">   // Set up some params</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-  var params = Cc[MsgComposeParamsContractID]</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-                 .createInstance(nsIMsgComposeParams);</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+  var params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+                 .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l18.45"></a><span id="l18.45"> </span>
<a href="#l18.46"></a><span id="l18.46">   params.composeFields = fields;</span>
<a href="#l18.47"></a><span id="l18.47"> </span>
<a href="#l18.48"></a><span id="l18.48">   msgCompose.initialize(params);</span>
<a href="#l18.49"></a><span id="l18.49"> </span>
<a href="#l18.50"></a><span id="l18.50">   msgCompose.expandMailingLists();</span>
<a href="#l18.51"></a><span id="l18.51">   let addresses = fields.getHeader(&quot;To&quot;);</span>
<a href="#l18.52"></a><span id="l18.52">   let checkEmails = MailServices.headerParser.parseDecodedHeader(aCheckTo);</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineat">@@ -57,44 +49,44 @@ function run_test() {</span>
<a href="#l18.54"></a><span id="l18.54">   testAB = do_get_file(&quot;../../../data/abLists2.mab&quot;);</span>
<a href="#l18.55"></a><span id="l18.55"> </span>
<a href="#l18.56"></a><span id="l18.56">   // Copy the file to the profile directory for a CAB</span>
<a href="#l18.57"></a><span id="l18.57">   testAB.copyTo(do_get_profile(), kCABData.fileName);</span>
<a href="#l18.58"></a><span id="l18.58"> </span>
<a href="#l18.59"></a><span id="l18.59">   // Test - Check we can initialize with fewest specified</span>
<a href="#l18.60"></a><span id="l18.60">   // parameters and don't fail/crash like we did in bug 411646.</span>
<a href="#l18.61"></a><span id="l18.61"> </span>
<a href="#l18.62"></a><span id="l18.62" class="difflineminus">-  var msgCompose = Cc[MsgComposeContractID]</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineminus">-                     .createInstance(nsIMsgCompose);</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+  var msgCompose = Cc[&quot;@mozilla.org/messengercompose/compose;1&quot;]</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+                     .createInstance(Ci.nsIMsgCompose);</span>
<a href="#l18.66"></a><span id="l18.66"> </span>
<a href="#l18.67"></a><span id="l18.67">   // Set up some params</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineminus">-  var params = Cc[MsgComposeParamsContractID]</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineminus">-                 .createInstance(nsIMsgComposeParams);</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+  var params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+                 .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l18.72"></a><span id="l18.72"> </span>
<a href="#l18.73"></a><span id="l18.73">   msgCompose.initialize(params);</span>
<a href="#l18.74"></a><span id="l18.74"> </span>
<a href="#l18.75"></a><span id="l18.75">   // Test - expandMailingLists basic functionality.</span>
<a href="#l18.76"></a><span id="l18.76"> </span>
<a href="#l18.77"></a><span id="l18.77">   // Re-initialize</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineminus">-  msgCompose = Cc[MsgComposeContractID]</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineminus">-                 .createInstance(nsIMsgCompose);</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+  msgCompose = Cc[&quot;@mozilla.org/messengercompose/compose;1&quot;]</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+                 .createInstance(Ci.nsIMsgCompose);</span>
<a href="#l18.82"></a><span id="l18.82"> </span>
<a href="#l18.83"></a><span id="l18.83">   // Set up some basic fields for compose.</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineminus">-  var fields = Cc[MsgComposeFieldsContractID]</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineminus">-                 .createInstance(nsIMsgCompFields);</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+  var fields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+                 .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l18.88"></a><span id="l18.88"> </span>
<a href="#l18.89"></a><span id="l18.89">   // These aren't in the address book copied above.</span>
<a href="#l18.90"></a><span id="l18.90">   fields.from = &quot;test1@foo1.invalid&quot;;</span>
<a href="#l18.91"></a><span id="l18.91">   fields.to = &quot;test2@foo1.invalid&quot;;</span>
<a href="#l18.92"></a><span id="l18.92">   fields.cc = &quot;test3@foo1.invalid&quot;;</span>
<a href="#l18.93"></a><span id="l18.93">   fields.bcc = &quot;test4@foo1.invalid&quot;;</span>
<a href="#l18.94"></a><span id="l18.94"> </span>
<a href="#l18.95"></a><span id="l18.95">   // Set up some params</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineminus">-  params = Cc[MsgComposeParamsContractID]</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineminus">-             .createInstance(nsIMsgComposeParams);</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+  params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+             .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l18.100"></a><span id="l18.100"> </span>
<a href="#l18.101"></a><span id="l18.101">   params.composeFields = fields;</span>
<a href="#l18.102"></a><span id="l18.102"> </span>
<a href="#l18.103"></a><span id="l18.103">   msgCompose.initialize(params);</span>
<a href="#l18.104"></a><span id="l18.104"> </span>
<a href="#l18.105"></a><span id="l18.105">   msgCompose.expandMailingLists();</span>
<a href="#l18.106"></a><span id="l18.106">   Assert.equal(fields.to, &quot;test2@foo1.invalid&quot;);</span>
<a href="#l18.107"></a><span id="l18.107">   Assert.equal(fields.cc, &quot;test3@foo1.invalid&quot;);</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineat">@@ -142,9 +134,9 @@ function run_test() {</span>
<a href="#l18.109"></a><span id="l18.109">                 &quot;test4@foo.invalid,test4@com.invalid&quot;);</span>
<a href="#l18.110"></a><span id="l18.110"> </span>
<a href="#l18.111"></a><span id="l18.111">   checkPopulate(&quot;TestList3 &lt;TestList3&gt;, ListTest1 &lt;ListTest1&gt;&quot;,</span>
<a href="#l18.112"></a><span id="l18.112">                 &quot;test5@foo.invalid,test1@com.invalid,test2@com.invalid,test3@com.invalid&quot;);</span>
<a href="#l18.113"></a><span id="l18.113"> </span>
<a href="#l18.114"></a><span id="l18.114">   // test bug 254519 rfc 2047 encoding</span>
<a href="#l18.115"></a><span id="l18.115">   checkPopulate(&quot;=?iso-8859-1?Q?Sure=F6name=2C_Forename_Dr=2E?= &lt;pb@bieringer.invalid&gt;&quot;,</span>
<a href="#l18.116"></a><span id="l18.116">                 &quot;\&quot;Sure\u00F6name, Forename Dr.\&quot; &lt;pb@bieringer.invalid&gt;&quot;);</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineminus">-};</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_nsMsgCompose2.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_nsMsgCompose2.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -1,59 +1,56 @@</span>
<a href="#l19.4"></a><span id="l19.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l19.5"></a><span id="l19.5"> /*</span>
<a href="#l19.6"></a><span id="l19.6">  * Test suite for nsMsgCompose functions relating to send listeners.</span>
<a href="#l19.7"></a><span id="l19.7">  */</span>
<a href="#l19.8"></a><span id="l19.8"> </span>
<a href="#l19.9"></a><span id="l19.9" class="difflineminus">-var MsgComposeContractID = &quot;@mozilla.org/messengercompose/compose;1&quot;;</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineminus">-var nsIMsgCompose = Ci.nsIMsgCompose;</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineminus">-</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-var gMsgCompose = Cc[MsgComposeContractID]</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-                    .createInstance(nsIMsgCompose);</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+var gMsgCompose = Cc[&quot;@mozilla.org/messengercompose/compose;1&quot;]</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+                    .createInstance(Ci.nsIMsgCompose);</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17"> var numSendListenerFunctions = 6;</span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19"> var gSLAll = new Array(numSendListenerFunctions + 1);</span>
<a href="#l19.20"></a><span id="l19.20"> </span>
<a href="#l19.21"></a><span id="l19.21"> function sendListener() {}</span>
<a href="#l19.22"></a><span id="l19.22"> </span>
<a href="#l19.23"></a><span id="l19.23"> sendListener.prototype = {</span>
<a href="#l19.24"></a><span id="l19.24">   mReceived: 0,</span>
<a href="#l19.25"></a><span id="l19.25">   mAutoRemoveItem: 0,</span>
<a href="#l19.26"></a><span id="l19.26"> </span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-  onStartSending: function (aMsgID, aMsgSize) {</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+  onStartSending(aMsgID, aMsgSize) {</span>
<a href="#l19.29"></a><span id="l19.29">     this.mReceived |= 0x01;</span>
<a href="#l19.30"></a><span id="l19.30">     if (this.mAutoRemoveItem == 0x01)</span>
<a href="#l19.31"></a><span id="l19.31">       gMsgCompose.removeMsgSendListener(this);</span>
<a href="#l19.32"></a><span id="l19.32">   },</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-  onProgress: function (aMsgID, aProgress, aProgressMax) {</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+  onProgress(aMsgID, aProgress, aProgressMax) {</span>
<a href="#l19.35"></a><span id="l19.35">     this.mReceived |= 0x02;</span>
<a href="#l19.36"></a><span id="l19.36">     if (this.mAutoRemoveItem == 0x02)</span>
<a href="#l19.37"></a><span id="l19.37">       gMsgCompose.removeMsgSendListener(this);</span>
<a href="#l19.38"></a><span id="l19.38">   },</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-  onStatus: function (aMsgID, aMsg) {</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+  onStatus(aMsgID, aMsg) {</span>
<a href="#l19.41"></a><span id="l19.41">     this.mReceived |= 0x04;</span>
<a href="#l19.42"></a><span id="l19.42">     if (this.mAutoRemoveItem == 0x04)</span>
<a href="#l19.43"></a><span id="l19.43">       gMsgCompose.removeMsgSendListener(this);</span>
<a href="#l19.44"></a><span id="l19.44">   },</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-  onStopSending: function (aMsgID, aStatus, aMsg, aReturnFile) {</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+  onStopSending(aMsgID, aStatus, aMsg, aReturnFile) {</span>
<a href="#l19.47"></a><span id="l19.47">     this.mReceived |= 0x08;</span>
<a href="#l19.48"></a><span id="l19.48">     if (this.mAutoRemoveItem == 0x08)</span>
<a href="#l19.49"></a><span id="l19.49">       gMsgCompose.removeMsgSendListener(this);</span>
<a href="#l19.50"></a><span id="l19.50">   },</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineminus">-  onGetDraftFolderURI: function (aFolderURI) {</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+  onGetDraftFolderURI(aFolderURI) {</span>
<a href="#l19.53"></a><span id="l19.53">     this.mReceived |= 0x10;</span>
<a href="#l19.54"></a><span id="l19.54">     if (this.mAutoRemoveItem == 0x10)</span>
<a href="#l19.55"></a><span id="l19.55">       gMsgCompose.removeMsgSendListener(this);</span>
<a href="#l19.56"></a><span id="l19.56">   },</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineminus">-  onSendNotPerformed: function (aMsgID, aStatus) {</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+  onSendNotPerformed(aMsgID, aStatus) {</span>
<a href="#l19.59"></a><span id="l19.59">     this.mReceived |= 0x20;</span>
<a href="#l19.60"></a><span id="l19.60">     if (this.mAutoRemoveItem == 0x20)</span>
<a href="#l19.61"></a><span id="l19.61">       gMsgCompose.removeMsgSendListener(this);</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-  }</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+  },</span>
<a href="#l19.64"></a><span id="l19.64"> };</span>
<a href="#l19.65"></a><span id="l19.65"> </span>
<a href="#l19.66"></a><span id="l19.66"> function NotifySendListeners() {</span>
<a href="#l19.67"></a><span id="l19.67">   gMsgCompose.onStartSending(null, null);</span>
<a href="#l19.68"></a><span id="l19.68">   gMsgCompose.onProgress(null, null, null);</span>
<a href="#l19.69"></a><span id="l19.69">   gMsgCompose.onStatus(null, null);</span>
<a href="#l19.70"></a><span id="l19.70">   gMsgCompose.onStopSending(null, null, null, null);</span>
<a href="#l19.71"></a><span id="l19.71">   gMsgCompose.onGetDraftFolderURI(null);</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineat">@@ -107,9 +104,9 @@ function run_test() {</span>
<a href="#l19.73"></a><span id="l19.73">       Assert.equal(gSLAll[i].mReceived, 0);</span>
<a href="#l19.74"></a><span id="l19.74">     else</span>
<a href="#l19.75"></a><span id="l19.75">       Assert.equal(gSLAll[i].mReceived, 0x3F);</span>
<a href="#l19.76"></a><span id="l19.76">   }</span>
<a href="#l19.77"></a><span id="l19.77"> </span>
<a href="#l19.78"></a><span id="l19.78">   // Test - Remove main listener</span>
<a href="#l19.79"></a><span id="l19.79"> </span>
<a href="#l19.80"></a><span id="l19.80">   gMsgCompose.removeMsgSendListener(gSLAll[numSendListenerFunctions]);</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineminus">-};</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_nsMsgCompose3.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_nsMsgCompose3.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,55 +1,52 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l20.5"></a><span id="l20.5"> /*</span>
<a href="#l20.6"></a><span id="l20.6">  * Test suite for increasing the popularity of contacts via</span>
<a href="#l20.7"></a><span id="l20.7">  * expandMailingLists.</span>
<a href="#l20.8"></a><span id="l20.8">  */</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-var MsgComposeContractID = &quot;@mozilla.org/messengercompose/compose;1&quot;;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-var MsgComposeParamsContractID = &quot;@mozilla.org/messengercompose/composeparams;1&quot;;</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-var MsgComposeFieldsContractID = &quot;@mozilla.org/messengercompose/composefields;1&quot;;</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-</span>
<a href="#l20.16"></a><span id="l20.16"> var TESTS = [</span>
<a href="#l20.17"></a><span id="l20.17">   {</span>
<a href="#l20.18"></a><span id="l20.18">     email: &quot;em@test.invalid&quot;,</span>
<a href="#l20.19"></a><span id="l20.19">     // TB 2 stored popularity as hex, so we need to check correct handling.</span>
<a href="#l20.20"></a><span id="l20.20">     prePopularity: &quot;a&quot;,</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-    postPopularity: &quot;11&quot;</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+    postPopularity: &quot;11&quot;,</span>
<a href="#l20.23"></a><span id="l20.23">   },</span>
<a href="#l20.24"></a><span id="l20.24">   {</span>
<a href="#l20.25"></a><span id="l20.25">     email: &quot;e@test.invalid&quot;,</span>
<a href="#l20.26"></a><span id="l20.26">     prePopularity: &quot;0&quot;,</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineminus">-    postPopularity: &quot;1&quot;</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineplus">+    postPopularity: &quot;1&quot;,</span>
<a href="#l20.29"></a><span id="l20.29">   },</span>
<a href="#l20.30"></a><span id="l20.30">   {</span>
<a href="#l20.31"></a><span id="l20.31">     email: &quot;e@test.invalid&quot;,</span>
<a href="#l20.32"></a><span id="l20.32">     prePopularity: &quot;1&quot;,</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-    postPopularity: &quot;2&quot;</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+    postPopularity: &quot;2&quot;,</span>
<a href="#l20.35"></a><span id="l20.35">   },</span>
<a href="#l20.36"></a><span id="l20.36">   {</span>
<a href="#l20.37"></a><span id="l20.37">     email: &quot;em@test.invalid&quot;,</span>
<a href="#l20.38"></a><span id="l20.38">     prePopularity: &quot;11&quot;,</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-    postPopularity: &quot;12&quot;</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-  }</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+    postPopularity: &quot;12&quot;,</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+  },</span>
<a href="#l20.43"></a><span id="l20.43"> ];</span>
<a href="#l20.44"></a><span id="l20.44"> </span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-function checkPopulate(aTo, aCheckTo)</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-{</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-  let msgCompose = Cc[MsgComposeContractID].createInstance(Ci.nsIMsgCompose);</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+function checkPopulate(aTo, aCheckTo) {</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+  let msgCompose = Cc[&quot;@mozilla.org/messengercompose/compose;1&quot;]</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+                     .createInstance(Ci.nsIMsgCompose);</span>
<a href="#l20.51"></a><span id="l20.51"> </span>
<a href="#l20.52"></a><span id="l20.52">   // Set up some basic fields for compose.</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-  let fields = Cc[MsgComposeFieldsContractID].createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+  let fields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+                 .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l20.56"></a><span id="l20.56"> </span>
<a href="#l20.57"></a><span id="l20.57">   fields.to = aTo;</span>
<a href="#l20.58"></a><span id="l20.58"> </span>
<a href="#l20.59"></a><span id="l20.59">   // Set up some params</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-  let params = Cc[MsgComposeParamsContractID]</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+  let params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l20.62"></a><span id="l20.62">                  .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l20.63"></a><span id="l20.63"> </span>
<a href="#l20.64"></a><span id="l20.64">   params.composeFields = fields;</span>
<a href="#l20.65"></a><span id="l20.65"> </span>
<a href="#l20.66"></a><span id="l20.66">   msgCompose.initialize(params);</span>
<a href="#l20.67"></a><span id="l20.67"> </span>
<a href="#l20.68"></a><span id="l20.68">   Assert.ok(!msgCompose.expandMailingLists());</span>
<a href="#l20.69"></a><span id="l20.69"> </span>
<a href="#l20.70"></a><span id="l20.70" class="difflineat">@@ -80,9 +77,9 @@ function run_test() {</span>
<a href="#l20.71"></a><span id="l20.71">     // Now we've run check populate, check the popularityIndex has increased.</span>
<a href="#l20.72"></a><span id="l20.72">     card = AB.cardForEmailAddress(TESTS[i].email);</span>
<a href="#l20.73"></a><span id="l20.73">     Assert.ok(!!card);</span>
<a href="#l20.74"></a><span id="l20.74"> </span>
<a href="#l20.75"></a><span id="l20.75">     // Thunderbird 2 stored its popularityIndexes as hex, hence when we read it</span>
<a href="#l20.76"></a><span id="l20.76">     // now we're going to get a hex value. The AB has a value of &quot;a&quot;.</span>
<a href="#l20.77"></a><span id="l20.77">     Assert.equal(card.getProperty(&quot;PopularityIndex&quot;, -1), TESTS[i].postPopularity);</span>
<a href="#l20.78"></a><span id="l20.78">   }</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-};</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_nsMsgCompose4.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_nsMsgCompose4.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,47 +1,37 @@</span>
<a href="#l21.4"></a><span id="l21.4"> /**</span>
<a href="#l21.5"></a><span id="l21.5">  * Tests nsMsgCompose determineHTMLAction.</span>
<a href="#l21.6"></a><span id="l21.6">  */</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8" class="difflineminus">-var MsgComposeContractID = &quot;@mozilla.org/messengercompose/compose;1&quot;;</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineminus">-var MsgComposeParamsContractID = &quot;@mozilla.org/messengercompose/composeparams;1&quot;;</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineminus">-var MsgComposeFieldsContractID = &quot;@mozilla.org/messengercompose/composefields;1&quot;;</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineminus">-var nsIMsgCompose = Ci.nsIMsgCompose;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-var nsIMsgComposeParams = Ci.nsIMsgComposeParams;</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-var nsIMsgCompConvertible = Ci.nsIMsgCompConvertible;</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-var nsIMsgCompFields = Ci.nsIMsgCompFields;</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-var SendFormat = Ci.nsIMsgCompSendFormat;</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-</span>
<a href="#l21.17"></a><span id="l21.17"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l21.18"></a><span id="l21.18"> </span>
<a href="#l21.19"></a><span id="l21.19"> /**</span>
<a href="#l21.20"></a><span id="l21.20">  * Helper to check population worked as expected.</span>
<a href="#l21.21"></a><span id="l21.21">  * @param aTo          text in the To field</span>
<a href="#l21.22"></a><span id="l21.22">  * @param aNewsgroups  text for the Newsgroups field</span>
<a href="#l21.23"></a><span id="l21.23">  * @param aSendFormat  |nsIMsgCompSendFormat| format to send</span>
<a href="#l21.24"></a><span id="l21.24">  * @param aConvertible |nsIMsgCompConvertible| parameter to check (defaults to</span>
<a href="#l21.25"></a><span id="l21.25">  *                     nsIMsgCompConvertible.No if undefined)</span>
<a href="#l21.26"></a><span id="l21.26">  */</span>
<a href="#l21.27"></a><span id="l21.27"> function checkPopulate(aTo, aNewsgroups, aSendFormat,</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-                       aConvertible=nsIMsgCompConvertible.No)</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-{</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-  var msgCompose = Cc[MsgComposeContractID]</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-                     .createInstance(nsIMsgCompose);</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+                       aConvertible = Ci.nsIMsgCompConvertible.No) {</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+  var msgCompose = Cc[&quot;@mozilla.org/messengercompose/compose;1&quot;]</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+                     .createInstance(Ci.nsIMsgCompose);</span>
<a href="#l21.35"></a><span id="l21.35"> </span>
<a href="#l21.36"></a><span id="l21.36">   // Set up some basic fields for compose.</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-  var fields = Cc[MsgComposeFieldsContractID]</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-                 .createInstance(nsIMsgCompFields);</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+  var fields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+                 .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l21.41"></a><span id="l21.41"> </span>
<a href="#l21.42"></a><span id="l21.42">   fields.to = aTo;</span>
<a href="#l21.43"></a><span id="l21.43">   fields.newsgroups = aNewsgroups;</span>
<a href="#l21.44"></a><span id="l21.44"> </span>
<a href="#l21.45"></a><span id="l21.45">   // Set up some params</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineminus">-  var params = Cc[MsgComposeParamsContractID]</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineminus">-                 .createInstance(nsIMsgComposeParams);</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+  var params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineplus">+                 .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l21.50"></a><span id="l21.50"> </span>
<a href="#l21.51"></a><span id="l21.51">   params.composeFields = fields;</span>
<a href="#l21.52"></a><span id="l21.52"> </span>
<a href="#l21.53"></a><span id="l21.53">   msgCompose.initialize(params);</span>
<a href="#l21.54"></a><span id="l21.54"> </span>
<a href="#l21.55"></a><span id="l21.55">   msgCompose.expandMailingLists();</span>
<a href="#l21.56"></a><span id="l21.56">   Assert.equal(msgCompose.determineHTMLAction(aConvertible), aSendFormat);</span>
<a href="#l21.57"></a><span id="l21.57"> }</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineat">@@ -56,105 +46,103 @@ function run_test() {</span>
<a href="#l21.59"></a><span id="l21.59">   testAB = do_get_file(&quot;../../../data/abLists2.mab&quot;);</span>
<a href="#l21.60"></a><span id="l21.60"> </span>
<a href="#l21.61"></a><span id="l21.61">   // Copy the file to the profile directory for a CAB</span>
<a href="#l21.62"></a><span id="l21.62">   testAB.copyTo(do_get_profile(), kCABData.fileName);</span>
<a href="#l21.63"></a><span id="l21.63"> </span>
<a href="#l21.64"></a><span id="l21.64">   // Test - Check we can initialize with fewest specified</span>
<a href="#l21.65"></a><span id="l21.65">   // parameters and don't fail/crash like we did in bug 411646.</span>
<a href="#l21.66"></a><span id="l21.66"> </span>
<a href="#l21.67"></a><span id="l21.67" class="difflineminus">-  var msgCompose = Cc[MsgComposeContractID]</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineminus">-                     .createInstance(nsIMsgCompose);</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineplus">+  var msgCompose = Cc[&quot;@mozilla.org/messengercompose/compose;1&quot;]</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineplus">+                     .createInstance(Ci.nsIMsgCompose);</span>
<a href="#l21.71"></a><span id="l21.71"> </span>
<a href="#l21.72"></a><span id="l21.72">   // Set up some params</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineminus">-  var params = Cc[MsgComposeParamsContractID]</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-                 .createInstance(nsIMsgComposeParams);</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+  var params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+                 .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l21.77"></a><span id="l21.77"> </span>
<a href="#l21.78"></a><span id="l21.78">   msgCompose.initialize(params);</span>
<a href="#l21.79"></a><span id="l21.79"> </span>
<a href="#l21.80"></a><span id="l21.80">   // Test - determineHTMLAction basic functionality.</span>
<a href="#l21.81"></a><span id="l21.81"> </span>
<a href="#l21.82"></a><span id="l21.82">   // Re-initialize</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineminus">-  msgCompose = Cc[MsgComposeContractID]</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineminus">-                 .createInstance(nsIMsgCompose);</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineplus">+  msgCompose = Cc[&quot;@mozilla.org/messengercompose/compose;1&quot;]</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineplus">+                 .createInstance(Ci.nsIMsgCompose);</span>
<a href="#l21.87"></a><span id="l21.87"> </span>
<a href="#l21.88"></a><span id="l21.88">   // Set up some basic fields for compose.</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineminus">-  var fields = Cc[MsgComposeFieldsContractID]</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineminus">-                 .createInstance(nsIMsgCompFields);</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineplus">+  var fields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineplus">+                 .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l21.93"></a><span id="l21.93"> </span>
<a href="#l21.94"></a><span id="l21.94">   // These aren't in the address book copied above.</span>
<a href="#l21.95"></a><span id="l21.95">   fields.from = &quot;test1@foo1.invalid&quot;;</span>
<a href="#l21.96"></a><span id="l21.96">   fields.to = &quot;test2@foo1.invalid&quot;;</span>
<a href="#l21.97"></a><span id="l21.97">   fields.cc = &quot;test3@foo1.invalid&quot;;</span>
<a href="#l21.98"></a><span id="l21.98">   fields.bcc = &quot;test4@foo1.invalid&quot;;</span>
<a href="#l21.99"></a><span id="l21.99"> </span>
<a href="#l21.100"></a><span id="l21.100">   // Set up some params</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineminus">-  params = Cc[MsgComposeParamsContractID]</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineminus">-             .createInstance(nsIMsgComposeParams);</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineplus">+  params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineplus">+             .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l21.105"></a><span id="l21.105"> </span>
<a href="#l21.106"></a><span id="l21.106">   params.composeFields = fields;</span>
<a href="#l21.107"></a><span id="l21.107"> </span>
<a href="#l21.108"></a><span id="l21.108">   msgCompose.initialize(params);</span>
<a href="#l21.109"></a><span id="l21.109"> </span>
<a href="#l21.110"></a><span id="l21.110" class="difflineminus">-  var nonHTMLRecipients = new Object();</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineminus">-</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineminus">-  Services.prefs.setIntPref(&quot;mail.default_html_action&quot;, SendFormat.AskUser);</span>
<a href="#l21.113"></a><span id="l21.113" class="difflineminus">-  Assert.equal(msgCompose.determineHTMLAction(nsIMsgCompConvertible.No),</span>
<a href="#l21.114"></a><span id="l21.114" class="difflineminus">-               SendFormat.AskUser);</span>
<a href="#l21.115"></a><span id="l21.115" class="difflineplus">+  Services.prefs.setIntPref(&quot;mail.default_html_action&quot;, Ci.nsIMsgCompSendFormat.AskUser);</span>
<a href="#l21.116"></a><span id="l21.116" class="difflineplus">+  Assert.equal(msgCompose.determineHTMLAction(Ci.nsIMsgCompConvertible.No),</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineplus">+               Ci.nsIMsgCompSendFormat.AskUser);</span>
<a href="#l21.118"></a><span id="l21.118"> </span>
<a href="#l21.119"></a><span id="l21.119">   Assert.equal(fields.to, &quot;test2@foo1.invalid&quot;);</span>
<a href="#l21.120"></a><span id="l21.120">   Assert.equal(fields.cc, &quot;test3@foo1.invalid&quot;);</span>
<a href="#l21.121"></a><span id="l21.121">   Assert.equal(fields.bcc, &quot;test4@foo1.invalid&quot;);</span>
<a href="#l21.122"></a><span id="l21.122"> </span>
<a href="#l21.123"></a><span id="l21.123">   // Test - determineHTMLAction with plain text.</span>
<a href="#l21.124"></a><span id="l21.124"> </span>
<a href="#l21.125"></a><span id="l21.125" class="difflineminus">-  checkPopulate(&quot;test4@foo.invalid&quot;, &quot;&quot;, SendFormat.PlainText);</span>
<a href="#l21.126"></a><span id="l21.126" class="difflineplus">+  checkPopulate(&quot;test4@foo.invalid&quot;, &quot;&quot;, Ci.nsIMsgCompSendFormat.PlainText);</span>
<a href="#l21.127"></a><span id="l21.127"> </span>
<a href="#l21.128"></a><span id="l21.128">   // Test - determineHTMLAction with html.</span>
<a href="#l21.129"></a><span id="l21.129"> </span>
<a href="#l21.130"></a><span id="l21.130" class="difflineminus">-  checkPopulate(&quot;test5@foo.invalid&quot;, &quot;&quot;, SendFormat.HTML);</span>
<a href="#l21.131"></a><span id="l21.131" class="difflineplus">+  checkPopulate(&quot;test5@foo.invalid&quot;, &quot;&quot;, Ci.nsIMsgCompSendFormat.HTML);</span>
<a href="#l21.132"></a><span id="l21.132"> </span>
<a href="#l21.133"></a><span id="l21.133">   // Test - determineHTMLAction with a list of three items.</span>
<a href="#l21.134"></a><span id="l21.134"> </span>
<a href="#l21.135"></a><span id="l21.135" class="difflineminus">-  checkPopulate(&quot;TestList1 &lt;TestList1&gt;&quot;, &quot;&quot;, SendFormat.AskUser);</span>
<a href="#l21.136"></a><span id="l21.136" class="difflineminus">-  checkPopulate(&quot;TestList1 &lt;TestList1&gt;&quot;, &quot;&quot;, SendFormat.PlainText,</span>
<a href="#l21.137"></a><span id="l21.137" class="difflineminus">-    nsIMsgCompConvertible.Plain);</span>
<a href="#l21.138"></a><span id="l21.138" class="difflineplus">+  checkPopulate(&quot;TestList1 &lt;TestList1&gt;&quot;, &quot;&quot;, Ci.nsIMsgCompSendFormat.AskUser);</span>
<a href="#l21.139"></a><span id="l21.139" class="difflineplus">+  checkPopulate(&quot;TestList1 &lt;TestList1&gt;&quot;, &quot;&quot;, Ci.nsIMsgCompSendFormat.PlainText,</span>
<a href="#l21.140"></a><span id="l21.140" class="difflineplus">+    Ci.nsIMsgCompConvertible.Plain);</span>
<a href="#l21.141"></a><span id="l21.141"> </span>
<a href="#l21.142"></a><span id="l21.142">   // Test - determineHTMLAction with a list of one item.</span>
<a href="#l21.143"></a><span id="l21.143"> </span>
<a href="#l21.144"></a><span id="l21.144" class="difflineminus">-  checkPopulate(&quot;TestList2 &lt;TestList2&gt;&quot;, &quot;&quot;, SendFormat.PlainText);</span>
<a href="#l21.145"></a><span id="l21.145" class="difflineplus">+  checkPopulate(&quot;TestList2 &lt;TestList2&gt;&quot;, &quot;&quot;, Ci.nsIMsgCompSendFormat.PlainText);</span>
<a href="#l21.146"></a><span id="l21.146"> </span>
<a href="#l21.147"></a><span id="l21.147" class="difflineminus">-  checkPopulate(&quot;TestList3 &lt;TestList3&gt;&quot;, &quot;&quot;, SendFormat.HTML);</span>
<a href="#l21.148"></a><span id="l21.148" class="difflineplus">+  checkPopulate(&quot;TestList3 &lt;TestList3&gt;&quot;, &quot;&quot;, Ci.nsIMsgCompSendFormat.HTML);</span>
<a href="#l21.149"></a><span id="l21.149"> </span>
<a href="#l21.150"></a><span id="l21.150">   // Test determineHTMLAction w/ mailnews.html_domains set.</span>
<a href="#l21.151"></a><span id="l21.151">   Services.prefs.setCharPref(&quot;mailnews.html_domains&quot;, &quot;foo.invalid,bar.invalid&quot;);</span>
<a href="#l21.152"></a><span id="l21.152">   checkPopulate(&quot;htmlformat@foo.invalid,unknownformat@nonfoo.invalid&quot;, &quot;&quot;,</span>
<a href="#l21.153"></a><span id="l21.153" class="difflineminus">-                SendFormat.AskUser);</span>
<a href="#l21.154"></a><span id="l21.154" class="difflineplus">+                Ci.nsIMsgCompSendFormat.AskUser);</span>
<a href="#l21.155"></a><span id="l21.155">   Services.prefs.clearUserPref(&quot;mailnews.html_domains&quot;);</span>
<a href="#l21.156"></a><span id="l21.156"> </span>
<a href="#l21.157"></a><span id="l21.157">   // Test determineHTMLAction w/ mailnews.plaintext_domains set.</span>
<a href="#l21.158"></a><span id="l21.158">   Services.prefs.setCharPref(&quot;mailnews.plaintext_domains&quot;, &quot;foo.invalid,bar.invalid&quot;);</span>
<a href="#l21.159"></a><span id="l21.159">   checkPopulate(&quot;plainformat@foo.invalid,unknownformat@nonfoo.invalid&quot;, &quot;&quot;,</span>
<a href="#l21.160"></a><span id="l21.160" class="difflineminus">-                SendFormat.AskUser);</span>
<a href="#l21.161"></a><span id="l21.161" class="difflineplus">+                Ci.nsIMsgCompSendFormat.AskUser);</span>
<a href="#l21.162"></a><span id="l21.162">   checkPopulate(&quot;plainformat@foo.invalid,plainformat@cc.bar.invalid&quot;, &quot;&quot;,</span>
<a href="#l21.163"></a><span id="l21.163" class="difflineminus">-                SendFormat.PlainText);</span>
<a href="#l21.164"></a><span id="l21.164" class="difflineplus">+                Ci.nsIMsgCompSendFormat.PlainText);</span>
<a href="#l21.165"></a><span id="l21.165">   Services.prefs.clearUserPref(&quot;mailnews.plaintext_domains&quot;);</span>
<a href="#l21.166"></a><span id="l21.166"> </span>
<a href="#l21.167"></a><span id="l21.167">   // Test - determineHTMLAction with items from multiple address books.</span>
<a href="#l21.168"></a><span id="l21.168"> </span>
<a href="#l21.169"></a><span id="l21.169">   checkPopulate(&quot;TestList1 &lt;TestList1&gt;, test3@com.invalid&quot;, &quot;&quot;,</span>
<a href="#l21.170"></a><span id="l21.170" class="difflineminus">-                SendFormat.AskUser);</span>
<a href="#l21.171"></a><span id="l21.171" class="difflineplus">+                Ci.nsIMsgCompSendFormat.AskUser);</span>
<a href="#l21.172"></a><span id="l21.172"> </span>
<a href="#l21.173"></a><span id="l21.173">   checkPopulate(&quot;TestList2 &lt;TestList2&gt;, ListTest2 &lt;ListTest2&gt;&quot;, &quot;&quot;,</span>
<a href="#l21.174"></a><span id="l21.174" class="difflineminus">-                SendFormat.PlainText);</span>
<a href="#l21.175"></a><span id="l21.175" class="difflineplus">+                Ci.nsIMsgCompSendFormat.PlainText);</span>
<a href="#l21.176"></a><span id="l21.176"> </span>
<a href="#l21.177"></a><span id="l21.177">   checkPopulate(&quot;TestList3 &lt;TestList3&gt;, ListTest1 &lt;ListTest1&gt;&quot;, &quot;&quot;,</span>
<a href="#l21.178"></a><span id="l21.178" class="difflineminus">-                SendFormat.AskUser);</span>
<a href="#l21.179"></a><span id="l21.179" class="difflineplus">+                Ci.nsIMsgCompSendFormat.AskUser);</span>
<a href="#l21.180"></a><span id="l21.180"> </span>
<a href="#l21.181"></a><span id="l21.181">   // test bug 254519 rfc 2047 encoding</span>
<a href="#l21.182"></a><span id="l21.182">   checkPopulate(&quot;=?iso-8859-1?Q?Sure=F6name=2C_Forename__Dr=2E?= &lt;pb@bieringer.invalid&gt;&quot;, &quot;&quot;,</span>
<a href="#l21.183"></a><span id="l21.183" class="difflineminus">-                SendFormat.AskUser);</span>
<a href="#l21.184"></a><span id="l21.184" class="difflineplus">+                Ci.nsIMsgCompSendFormat.AskUser);</span>
<a href="#l21.185"></a><span id="l21.185"> </span>
<a href="#l21.186"></a><span id="l21.186">   // Try some fields with newsgroups</span>
<a href="#l21.187"></a><span id="l21.187" class="difflineminus">-  checkPopulate(&quot;test4@foo.invalid&quot;, &quot;mozilla.test&quot;, SendFormat.AskUser);</span>
<a href="#l21.188"></a><span id="l21.188" class="difflineminus">-  checkPopulate(&quot;test5@foo.invalid&quot;, &quot;mozilla.test&quot;, SendFormat.AskUser);</span>
<a href="#l21.189"></a><span id="l21.189" class="difflineminus">-  checkPopulate(&quot;&quot;, &quot;mozilla.test&quot;, SendFormat.AskUser);</span>
<a href="#l21.190"></a><span id="l21.190" class="difflineminus">-};</span>
<a href="#l21.191"></a><span id="l21.191" class="difflineplus">+  checkPopulate(&quot;test4@foo.invalid&quot;, &quot;mozilla.test&quot;, Ci.nsIMsgCompSendFormat.AskUser);</span>
<a href="#l21.192"></a><span id="l21.192" class="difflineplus">+  checkPopulate(&quot;test5@foo.invalid&quot;, &quot;mozilla.test&quot;, Ci.nsIMsgCompSendFormat.AskUser);</span>
<a href="#l21.193"></a><span id="l21.193" class="difflineplus">+  checkPopulate(&quot;&quot;, &quot;mozilla.test&quot;, Ci.nsIMsgCompSendFormat.AskUser);</span>
<a href="#l21.194"></a><span id="l21.194" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_nsSmtpService1.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_nsSmtpService1.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -71,17 +71,17 @@ function run_test() {</span>
<a href="#l22.4"></a><span id="l22.4">   smtpServerArray[2].username = &quot;&quot;;</span>
<a href="#l22.5"></a><span id="l22.5"> </span>
<a href="#l22.6"></a><span id="l22.6">   // Now check them</span>
<a href="#l22.7"></a><span id="l22.7">   smtpServers = smtpService.servers;</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9">   var found = [false, false, false];</span>
<a href="#l22.10"></a><span id="l22.10"> </span>
<a href="#l22.11"></a><span id="l22.11">   while (smtpServers.hasMoreElements()) {</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-    var smtpServer = smtpServers.getNext();</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+    smtpServer = smtpServers.getNext();</span>
<a href="#l22.14"></a><span id="l22.14"> </span>
<a href="#l22.15"></a><span id="l22.15">     for (i = 0; i &lt; 3; ++i)</span>
<a href="#l22.16"></a><span id="l22.16">       if (smtpServer == smtpServerArray[i])</span>
<a href="#l22.17"></a><span id="l22.17">         found[i] = true;</span>
<a href="#l22.18"></a><span id="l22.18">   }</span>
<a href="#l22.19"></a><span id="l22.19"> </span>
<a href="#l22.20"></a><span id="l22.20">   Assert.equal(found, &quot;true,true,true&quot;);</span>
<a href="#l22.21"></a><span id="l22.21"> </span>
<a href="#l22.22"></a><span id="l22.22" class="difflineat">@@ -102,9 +102,9 @@ function run_test() {</span>
<a href="#l22.23"></a><span id="l22.23"> </span>
<a href="#l22.24"></a><span id="l22.24">   // Test - Delete the servers</span>
<a href="#l22.25"></a><span id="l22.25"> </span>
<a href="#l22.26"></a><span id="l22.26">   for (i = 0; i &lt; 3; ++i)</span>
<a href="#l22.27"></a><span id="l22.27">     smtpService.deleteServer(smtpServerArray[i]);</span>
<a href="#l22.28"></a><span id="l22.28"> </span>
<a href="#l22.29"></a><span id="l22.29">   smtpServers = smtpService.servers;</span>
<a href="#l22.30"></a><span id="l22.30">   Assert.ok(!smtpServers.hasMoreElements());</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-};</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendBackground.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendBackground.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -1,58 +1,52 @@</span>
<a href="#l23.4"></a><span id="l23.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l23.5"></a><span id="l23.5"> /**</span>
<a href="#l23.6"></a><span id="l23.6">  * Tests sending a message in the background (checks auto-send works).</span>
<a href="#l23.7"></a><span id="l23.7">  */</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l23.10"></a><span id="l23.10"> </span>
<a href="#l23.11"></a><span id="l23.11" class="difflineminus">-var type = null;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-var test = null;</span>
<a href="#l23.13"></a><span id="l23.13"> var server;</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-var sentFolder;</span>
<a href="#l23.15"></a><span id="l23.15"> var originalData;</span>
<a href="#l23.16"></a><span id="l23.16"> var finished = false;</span>
<a href="#l23.17"></a><span id="l23.17"> var identity = null;</span>
<a href="#l23.18"></a><span id="l23.18"> var testFile1 = do_get_file(&quot;data/429891_testcase.eml&quot;);</span>
<a href="#l23.19"></a><span id="l23.19"> var testFile2 = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21"> var kTestFile1Sender = &quot;from_A@foo.invalid&quot;;</span>
<a href="#l23.22"></a><span id="l23.22"> var kTestFile1Recipient = &quot;to_A@foo.invalid&quot;;</span>
<a href="#l23.23"></a><span id="l23.23"> </span>
<a href="#l23.24"></a><span id="l23.24"> var kIdentityMail = &quot;identity@foo.invalid&quot;;</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-var kTo = &quot;to@foo.invalid&quot;;</span>
<a href="#l23.26"></a><span id="l23.26"> </span>
<a href="#l23.27"></a><span id="l23.27"> var gMsgSendLater;</span>
<a href="#l23.28"></a><span id="l23.28"> </span>
<a href="#l23.29"></a><span id="l23.29"> // This listener handles the post-sending of the actual message and checks the</span>
<a href="#l23.30"></a><span id="l23.30"> // sequence and ensures the data is correct.</span>
<a href="#l23.31"></a><span id="l23.31"> function msll() {</span>
<a href="#l23.32"></a><span id="l23.32"> }</span>
<a href="#l23.33"></a><span id="l23.33"> </span>
<a href="#l23.34"></a><span id="l23.34"> msll.prototype = {</span>
<a href="#l23.35"></a><span id="l23.35">   _initialTotal: 0,</span>
<a href="#l23.36"></a><span id="l23.36"> </span>
<a href="#l23.37"></a><span id="l23.37">   // nsIMsgSendLaterListener</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineminus">-  onStartSending: function (aTotal) {</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineplus">+  onStartSending(aTotal) {</span>
<a href="#l23.40"></a><span id="l23.40">     this._initialTotal = 1;</span>
<a href="#l23.41"></a><span id="l23.41">     Assert.equal(gMsgSendLater.sendingMessages, true);</span>
<a href="#l23.42"></a><span id="l23.42">     Assert.equal(aTotal, 1);</span>
<a href="#l23.43"></a><span id="l23.43">   },</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-  onMessageStartSending: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineminus">-                                   aMessageHeader, aIdentity) {</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineplus">+  onMessageStartSending(aCurrentMessage, aTotalMessageCount, aMessageHeader, aIdentity) {</span>
<a href="#l23.47"></a><span id="l23.47">   },</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineminus">-  onMessageSendProgress: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-                                   aMessageSendPercent, aMessageCopyPercent) {</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+  onMessageSendProgress(aCurrentMessage, aTotalMessageCount,</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+                        aMessageSendPercent, aMessageCopyPercent) {</span>
<a href="#l23.52"></a><span id="l23.52">   },</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineminus">-  onMessageSendError: function (aCurrentMessage, aMessageHeader, aStatus,</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineminus">-                                aMsg) {</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineplus">+  onMessageSendError(aCurrentMessage, aMessageHeader, aStatus, aMsg) {</span>
<a href="#l23.56"></a><span id="l23.56">     do_throw(&quot;onMessageSendError should not have been called, status: &quot; + aStatus);</span>
<a href="#l23.57"></a><span id="l23.57">   },</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineminus">-  onStopSending: function (aStatus, aMsg, aTotalTried, aSuccessful) {</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineplus">+  onStopSending(aStatus, aMsg, aTotalTried, aSuccessful) {</span>
<a href="#l23.60"></a><span id="l23.60">     do_test_finished();</span>
<a href="#l23.61"></a><span id="l23.61">     print(&quot;msll onStopSending\n&quot;);</span>
<a href="#l23.62"></a><span id="l23.62">     try {</span>
<a href="#l23.63"></a><span id="l23.63">       Assert.equal(aStatus, 0);</span>
<a href="#l23.64"></a><span id="l23.64">       Assert.equal(aTotalTried, 1);</span>
<a href="#l23.65"></a><span id="l23.65">       Assert.equal(aSuccessful, 1);</span>
<a href="#l23.66"></a><span id="l23.66">       Assert.equal(this._initialTotal, 1);</span>
<a href="#l23.67"></a><span id="l23.67">       Assert.equal(gMsgSendLater.sendingMessages, false);</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineat">@@ -76,17 +70,17 @@ msll.prototype = {</span>
<a href="#l23.69"></a><span id="l23.69">       do_throw(e);</span>
<a href="#l23.70"></a><span id="l23.70">     } finally {</span>
<a href="#l23.71"></a><span id="l23.71">       server.stop();</span>
<a href="#l23.72"></a><span id="l23.72"> </span>
<a href="#l23.73"></a><span id="l23.73">       var thread = gThreadManager.currentThread;</span>
<a href="#l23.74"></a><span id="l23.74">       while (thread.hasPendingEvents())</span>
<a href="#l23.75"></a><span id="l23.75">         thread.processNextEvent(true);</span>
<a href="#l23.76"></a><span id="l23.76">     }</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineminus">-  }</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineplus">+  },</span>
<a href="#l23.79"></a><span id="l23.79"> };</span>
<a href="#l23.80"></a><span id="l23.80"> </span>
<a href="#l23.81"></a><span id="l23.81"> </span>
<a href="#l23.82"></a><span id="l23.82"> function run_test() {</span>
<a href="#l23.83"></a><span id="l23.83">   // The point of this test - send in background.</span>
<a href="#l23.84"></a><span id="l23.84">   Services.prefs.setBoolPref(&quot;mailnews.sendInBackground&quot;, true);</span>
<a href="#l23.85"></a><span id="l23.85"> </span>
<a href="#l23.86"></a><span id="l23.86">   // Ensure we have a local mail account, an normal account and appropriate</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineat">@@ -114,17 +108,17 @@ function run_test() {</span>
<a href="#l23.88"></a><span id="l23.88">   var smtpServer = getBasicSmtpServer(server.port);</span>
<a href="#l23.89"></a><span id="l23.89">   identity = getSmtpIdentity(kIdentityMail, smtpServer);</span>
<a href="#l23.90"></a><span id="l23.90"> </span>
<a href="#l23.91"></a><span id="l23.91">   account.addIdentity(identity);</span>
<a href="#l23.92"></a><span id="l23.92">   account.defaultIdentity = identity;</span>
<a href="#l23.93"></a><span id="l23.93">   account.incomingServer = incomingServer;</span>
<a href="#l23.94"></a><span id="l23.94">   MailServices.accounts.defaultAccount = account;</span>
<a href="#l23.95"></a><span id="l23.95"> </span>
<a href="#l23.96"></a><span id="l23.96" class="difflineminus">-  sentFolder = localAccountUtils.rootFolder.createLocalSubfolder(&quot;Sent&quot;);</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineplus">+  localAccountUtils.rootFolder.createLocalSubfolder(&quot;Sent&quot;);</span>
<a href="#l23.98"></a><span id="l23.98"> </span>
<a href="#l23.99"></a><span id="l23.99">   Assert.equal(identity.doFcc, true);</span>
<a href="#l23.100"></a><span id="l23.100"> </span>
<a href="#l23.101"></a><span id="l23.101">   // Now prepare to actually &quot;send&quot; the message later, i.e. dump it in the</span>
<a href="#l23.102"></a><span id="l23.102">   // unsent messages folder.</span>
<a href="#l23.103"></a><span id="l23.103"> </span>
<a href="#l23.104"></a><span id="l23.104">   var compFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l23.105"></a><span id="l23.105">                      .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineat">@@ -134,22 +128,19 @@ function run_test() {</span>
<a href="#l23.107"></a><span id="l23.107">   // Sender and recipient are required for sendMessageFile but SMTP</span>
<a href="#l23.108"></a><span id="l23.108">   // transaction values will be used directly from mail body.</span>
<a href="#l23.109"></a><span id="l23.109">   compFields.from = &quot;irrelevant@foo.invalid&quot;;</span>
<a href="#l23.110"></a><span id="l23.110">   compFields.to = &quot;irrelevant@foo.invalid&quot;;</span>
<a href="#l23.111"></a><span id="l23.111"> </span>
<a href="#l23.112"></a><span id="l23.112">   var msgSend = Cc[&quot;@mozilla.org/messengercompose/send;1&quot;]</span>
<a href="#l23.113"></a><span id="l23.113">                   .createInstance(Ci.nsIMsgSend);</span>
<a href="#l23.114"></a><span id="l23.114"> </span>
<a href="#l23.115"></a><span id="l23.115" class="difflineminus">-  type = &quot;sendMessageLater&quot;;</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineminus">-</span>
<a href="#l23.117"></a><span id="l23.117">   // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l23.118"></a><span id="l23.118">   // the server if something fails.</span>
<a href="#l23.119"></a><span id="l23.119">   try {</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineminus">-</span>
<a href="#l23.121"></a><span id="l23.121">     // A test to check that we are sending files correctly, including checking</span>
<a href="#l23.122"></a><span id="l23.122">     // what the server receives and what we output.</span>
<a href="#l23.123"></a><span id="l23.123">     test = &quot;sendMessageLater&quot;;</span>
<a href="#l23.124"></a><span id="l23.124"> </span>
<a href="#l23.125"></a><span id="l23.125">     var messageListener = new msll();</span>
<a href="#l23.126"></a><span id="l23.126"> </span>
<a href="#l23.127"></a><span id="l23.127">     gMsgSendLater.addListener(messageListener);</span>
<a href="#l23.128"></a><span id="l23.128"> </span>
<a href="#l23.129"></a><span id="l23.129" class="difflineat">@@ -162,22 +153,22 @@ function run_test() {</span>
<a href="#l23.130"></a><span id="l23.130">     // mailnews.sendInBackground set, nsMsgSendLater should just send it for</span>
<a href="#l23.131"></a><span id="l23.131">     // us.</span>
<a href="#l23.132"></a><span id="l23.132">     msgSend.sendMessageFile(identity, &quot;&quot;, compFields, testFile1,</span>
<a href="#l23.133"></a><span id="l23.133">                             false, false, Ci.nsIMsgSend.nsMsgDeliverBackground,</span>
<a href="#l23.134"></a><span id="l23.134">                             null, null, null, null);</span>
<a href="#l23.135"></a><span id="l23.135"> </span>
<a href="#l23.136"></a><span id="l23.136">     server.performTest();</span>
<a href="#l23.137"></a><span id="l23.137"> </span>
<a href="#l23.138"></a><span id="l23.138" class="difflineminus">-    do_timeout(10000, function()</span>
<a href="#l23.139"></a><span id="l23.139" class="difflineminus">-        {if (!finished) do_throw('Notifications of message send/copy not received');}</span>
<a href="#l23.140"></a><span id="l23.140" class="difflineminus">-      );</span>
<a href="#l23.141"></a><span id="l23.141" class="difflineplus">+    do_timeout(10000, function() {</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineplus">+      if (!finished)</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineplus">+        do_throw(&quot;Notifications of message send/copy not received&quot;);</span>
<a href="#l23.144"></a><span id="l23.144" class="difflineplus">+    });</span>
<a href="#l23.145"></a><span id="l23.145"> </span>
<a href="#l23.146"></a><span id="l23.146">     do_test_pending();</span>
<a href="#l23.147"></a><span id="l23.147" class="difflineminus">-</span>
<a href="#l23.148"></a><span id="l23.148">   } catch (e) {</span>
<a href="#l23.149"></a><span id="l23.149">     do_throw(e);</span>
<a href="#l23.150"></a><span id="l23.150">   } finally {</span>
<a href="#l23.151"></a><span id="l23.151">     server.stop();</span>
<a href="#l23.152"></a><span id="l23.152"> </span>
<a href="#l23.153"></a><span id="l23.153">     var thread = gThreadManager.currentThread;</span>
<a href="#l23.154"></a><span id="l23.154">     while (thread.hasPendingEvents())</span>
<a href="#l23.155"></a><span id="l23.155">       thread.processNextEvent(true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMailAddressIDN.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMailAddressIDN.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -1,174 +1,151 @@</span>
<a href="#l24.4"></a><span id="l24.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l24.5"></a><span id="l24.5"> /**</span>
<a href="#l24.6"></a><span id="l24.6">  * Tests sending messages to addresses with non-ASCII characters.</span>
<a href="#l24.7"></a><span id="l24.7">  */</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l24.9"></a><span id="l24.9"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l24.10"></a><span id="l24.10"> </span>
<a href="#l24.11"></a><span id="l24.11" class="difflineminus">-var type = null;</span>
<a href="#l24.12"></a><span id="l24.12"> var test = null;</span>
<a href="#l24.13"></a><span id="l24.13"> var server;</span>
<a href="#l24.14"></a><span id="l24.14"> var finished = false;</span>
<a href="#l24.15"></a><span id="l24.15"> </span>
<a href="#l24.16"></a><span id="l24.16"> var sentFolder;</span>
<a href="#l24.17"></a><span id="l24.17"> var originalData;</span>
<a href="#l24.18"></a><span id="l24.18"> var expectedAlertMessage;</span>
<a href="#l24.19"></a><span id="l24.19"> </span>
<a href="#l24.20"></a><span id="l24.20"> var kSender     = &quot;from@foo.invalid&quot;;</span>
<a href="#l24.21"></a><span id="l24.21"> var kToASCII    = &quot;to@foo.invalid&quot;;</span>
<a href="#l24.22"></a><span id="l24.22"> var kToValid    = &quot;to@v\u00E4lid.foo.invalid&quot;;</span>
<a href="#l24.23"></a><span id="l24.23"> var kToValidACE = &quot;to@xn--vlid-loa.foo.invalid&quot;;</span>
<a href="#l24.24"></a><span id="l24.24"> var kToInvalid  = &quot;b\u00F8rken.to@invalid.foo.invalid&quot;;</span>
<a href="#l24.25"></a><span id="l24.25"> var kToInvalidWithoutDomain = &quot;b\u00F8rken.to&quot;;</span>
<a href="#l24.26"></a><span id="l24.26"> var NS_ERROR_BUT_DONT_SHOW_ALERT = 0x805530ef;</span>
<a href="#l24.27"></a><span id="l24.27"> </span>
<a href="#l24.28"></a><span id="l24.28" class="difflineminus">-</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineminus">-// nsIPrompt</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineminus">-function alert(aDialogText, aText)</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-{</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+/* exported alert */// for alertTestUtils.js</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineplus">+function alert(aDialogText, aText) {</span>
<a href="#l24.34"></a><span id="l24.34">   // ignore without domain situation (this is crash test)</span>
<a href="#l24.35"></a><span id="l24.35">   if (test == kToInvalidWithoutDomain)</span>
<a href="#l24.36"></a><span id="l24.36">     return;</span>
<a href="#l24.37"></a><span id="l24.37"> </span>
<a href="#l24.38"></a><span id="l24.38">   // we should only get here for the kToInvalid test case</span>
<a href="#l24.39"></a><span id="l24.39">   Assert.equal(test, kToInvalid);</span>
<a href="#l24.40"></a><span id="l24.40">   Assert.equal(aText, expectedAlertMessage);</span>
<a href="#l24.41"></a><span id="l24.41"> }</span>
<a href="#l24.42"></a><span id="l24.42"> </span>
<a href="#l24.43"></a><span id="l24.43"> </span>
<a href="#l24.44"></a><span id="l24.44"> // message listener implementations</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineminus">-function msgListener(aRecipient)</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineminus">-{</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineplus">+function msgListener(aRecipient) {</span>
<a href="#l24.48"></a><span id="l24.48">   this.rcpt = aRecipient;</span>
<a href="#l24.49"></a><span id="l24.49"> }</span>
<a href="#l24.50"></a><span id="l24.50"> </span>
<a href="#l24.51"></a><span id="l24.51" class="difflineminus">-msgListener.prototype =</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineminus">-{</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineplus">+msgListener.prototype = {</span>
<a href="#l24.54"></a><span id="l24.54">   // nsIMsgSendListener</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineminus">-  onStartSending: function (aMsgID, aMsgSize) {},</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineminus">-  onProgress: function (aMsgID, aProgress, aProgressMax) {},</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineminus">-  onStatus: function (aMsgID, aMsg) {},</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineminus">-  onStopSending: function (aMsgID, aStatus, aMsg, aReturnFile)</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineminus">-  {</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineminus">-    try</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-    {</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineplus">+  onStartSending(aMsgID, aMsgSize) {},</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+  onProgress(aMsgID, aProgress, aProgressMax) {},</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineplus">+  onStatus(aMsgID, aMsg) {},</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineplus">+  onStopSending(aMsgID, aStatus, aMsg, aReturnFile) {</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineplus">+    try {</span>
<a href="#l24.67"></a><span id="l24.67">       Assert.equal(aStatus, 0);</span>
<a href="#l24.68"></a><span id="l24.68">       do_check_transaction(server.playTransaction(),</span>
<a href="#l24.69"></a><span id="l24.69">                            [&quot;EHLO test&quot;,</span>
<a href="#l24.70"></a><span id="l24.70">                             &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; BODY=8BITMIME SIZE=&quot; + originalData.length,</span>
<a href="#l24.71"></a><span id="l24.71">                             &quot;RCPT TO:&lt;&quot; + this.rcpt + &quot;&gt;&quot;,</span>
<a href="#l24.72"></a><span id="l24.72">                             &quot;DATA&quot;]);</span>
<a href="#l24.73"></a><span id="l24.73">       // Compare data file to what the server received</span>
<a href="#l24.74"></a><span id="l24.74">       Assert.equal(originalData, server._daemon.post);</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineminus">-    }</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineminus">-    catch (e)</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineminus">-    {</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineplus">+    } catch (e) {</span>
<a href="#l24.79"></a><span id="l24.79">       do_throw(e);</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineminus">-    }</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineminus">-    finally</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineminus">-    {</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineplus">+    } finally {</span>
<a href="#l24.84"></a><span id="l24.84">       server.stop();</span>
<a href="#l24.85"></a><span id="l24.85">       var thread = gThreadManager.currentThread;</span>
<a href="#l24.86"></a><span id="l24.86">       while (thread.hasPendingEvents())</span>
<a href="#l24.87"></a><span id="l24.87">         thread.processNextEvent(false);</span>
<a href="#l24.88"></a><span id="l24.88">     }</span>
<a href="#l24.89"></a><span id="l24.89">   },</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineminus">-  onGetDraftFolderURI: function (aFolderURI) {},</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineminus">-  onSendNotPerformed: function (aMsgID, aStatus) {},</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineplus">+  onGetDraftFolderURI(aFolderURI) {},</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineplus">+  onSendNotPerformed(aMsgID, aStatus) {},</span>
<a href="#l24.94"></a><span id="l24.94"> </span>
<a href="#l24.95"></a><span id="l24.95">   // nsIMsgCopyServiceListener</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineminus">-  OnStartCopy: function () {},</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineminus">-  OnProgress: function (aProgress, aProgressMax) {},</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineminus">-  SetMessageKey: function (aKey) {},</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineminus">-  GetMessageId: function (aMessageId) {},</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineminus">-  OnStopCopy: function (aStatus)</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineminus">-  {</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineplus">+  SetMessageKey(aKey) {},</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineplus">+  GetMessageId(aMessageId) {},</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l24.107"></a><span id="l24.107">     Assert.equal(aStatus, 0);</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineminus">-    try</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineminus">-    {</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineplus">+    try {</span>
<a href="#l24.111"></a><span id="l24.111">       // Now do a comparison of what is in the sent mail folder</span>
<a href="#l24.112"></a><span id="l24.112">       let msgData = mailTestUtils</span>
<a href="#l24.113"></a><span id="l24.113">         .loadMessageToString(sentFolder, mailTestUtils.firstMsgHdr(sentFolder));</span>
<a href="#l24.114"></a><span id="l24.114">       // Skip the headers etc that mailnews adds</span>
<a href="#l24.115"></a><span id="l24.115">       var pos = msgData.indexOf(&quot;From:&quot;);</span>
<a href="#l24.116"></a><span id="l24.116">       Assert.notEqual(pos, -1);</span>
<a href="#l24.117"></a><span id="l24.117">       msgData = msgData.substr(pos);</span>
<a href="#l24.118"></a><span id="l24.118">       Assert.equal(originalData, msgData);</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineminus">-    }</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineminus">-    catch (e)</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineminus">-    {</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineplus">+    } catch (e) {</span>
<a href="#l24.123"></a><span id="l24.123">       do_throw(e);</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineminus">-    }</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineminus">-    finally</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineminus">-    {</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineplus">+    } finally {</span>
<a href="#l24.128"></a><span id="l24.128">       finished = true;</span>
<a href="#l24.129"></a><span id="l24.129">       do_test_finished();</span>
<a href="#l24.130"></a><span id="l24.130">     }</span>
<a href="#l24.131"></a><span id="l24.131">   },</span>
<a href="#l24.132"></a><span id="l24.132"> </span>
<a href="#l24.133"></a><span id="l24.133">   // QueryInterface</span>
<a href="#l24.134"></a><span id="l24.134">   QueryInterface: ChromeUtils.generateQI([&quot;nsIMsgSendListener&quot;,</span>
<a href="#l24.135"></a><span id="l24.135">                                           &quot;nsIMsgCopyServiceListener&quot;]),</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineminus">-}</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineplus">+};</span>
<a href="#l24.138"></a><span id="l24.138"> </span>
<a href="#l24.139"></a><span id="l24.139"> </span>
<a href="#l24.140"></a><span id="l24.140" class="difflineminus">-function DoSendTest(aRecipient, aRecipientExpected, aExceptionExpected)</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineminus">-{</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineplus">+function DoSendTest(aRecipient, aRecipientExpected, aExceptionExpected) {</span>
<a href="#l24.143"></a><span id="l24.143">   server = setupServerDaemon();</span>
<a href="#l24.144"></a><span id="l24.144">   server.start();</span>
<a href="#l24.145"></a><span id="l24.145">   var smtpServer = getBasicSmtpServer(server.port);</span>
<a href="#l24.146"></a><span id="l24.146">   var identity = getSmtpIdentity(kSender, smtpServer);</span>
<a href="#l24.147"></a><span id="l24.147">   Assert.equal(identity.doFcc, true);</span>
<a href="#l24.148"></a><span id="l24.148"> </span>
<a href="#l24.149"></a><span id="l24.149">   // Random test file with data we don't actually care about. ;-)</span>
<a href="#l24.150"></a><span id="l24.150">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l24.151"></a><span id="l24.151">   originalData = IOUtils.loadFileToString(testFile);</span>
<a href="#l24.152"></a><span id="l24.152"> </span>
<a href="#l24.153"></a><span id="l24.153">   // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l24.154"></a><span id="l24.154">   // the server if something fails.</span>
<a href="#l24.155"></a><span id="l24.155">   var exceptionCaught = 0;</span>
<a href="#l24.156"></a><span id="l24.156" class="difflineminus">-  try</span>
<a href="#l24.157"></a><span id="l24.157" class="difflineminus">-  {</span>
<a href="#l24.158"></a><span id="l24.158" class="difflineplus">+  try {</span>
<a href="#l24.159"></a><span id="l24.159">     var compFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l24.160"></a><span id="l24.160">                        .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l24.161"></a><span id="l24.161">     compFields.from = identity.email;</span>
<a href="#l24.162"></a><span id="l24.162">     compFields.to = aRecipient;</span>
<a href="#l24.163"></a><span id="l24.163"> </span>
<a href="#l24.164"></a><span id="l24.164">     var msgSend = Cc[&quot;@mozilla.org/messengercompose/send;1&quot;]</span>
<a href="#l24.165"></a><span id="l24.165">                     .createInstance(Ci.nsIMsgSend);</span>
<a href="#l24.166"></a><span id="l24.166">     msgSend.sendMessageFile(identity, &quot;&quot;, compFields, testFile,</span>
<a href="#l24.167"></a><span id="l24.167">                             false, false, Ci.nsIMsgSend.nsMsgDeliverNow,</span>
<a href="#l24.168"></a><span id="l24.168">                             null, new msgListener(aRecipientExpected), null, null);</span>
<a href="#l24.169"></a><span id="l24.169"> </span>
<a href="#l24.170"></a><span id="l24.170">     server.performTest();</span>
<a href="#l24.171"></a><span id="l24.171"> </span>
<a href="#l24.172"></a><span id="l24.172" class="difflineminus">-    do_timeout(10000, function()</span>
<a href="#l24.173"></a><span id="l24.173" class="difflineminus">-        {if (!finished) do_throw('Notifications of message send/copy not received');}</span>
<a href="#l24.174"></a><span id="l24.174" class="difflineminus">-      );</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineplus">+    do_timeout(10000, function() {</span>
<a href="#l24.176"></a><span id="l24.176" class="difflineplus">+      if (!finished)</span>
<a href="#l24.177"></a><span id="l24.177" class="difflineplus">+        do_throw(&quot;Notifications of message send/copy not received&quot;);</span>
<a href="#l24.178"></a><span id="l24.178" class="difflineplus">+    });</span>
<a href="#l24.179"></a><span id="l24.179">     do_test_pending();</span>
<a href="#l24.180"></a><span id="l24.180" class="difflineminus">-  }</span>
<a href="#l24.181"></a><span id="l24.181" class="difflineminus">-  catch (e)</span>
<a href="#l24.182"></a><span id="l24.182" class="difflineminus">-  {</span>
<a href="#l24.183"></a><span id="l24.183" class="difflineplus">+  } catch (e) {</span>
<a href="#l24.184"></a><span id="l24.184">     exceptionCaught = e.result;</span>
<a href="#l24.185"></a><span id="l24.185" class="difflineminus">-  }</span>
<a href="#l24.186"></a><span id="l24.186" class="difflineminus">-  finally</span>
<a href="#l24.187"></a><span id="l24.187" class="difflineminus">-  {</span>
<a href="#l24.188"></a><span id="l24.188" class="difflineplus">+  } finally {</span>
<a href="#l24.189"></a><span id="l24.189">     server.stop();</span>
<a href="#l24.190"></a><span id="l24.190">     var thread = gThreadManager.currentThread;</span>
<a href="#l24.191"></a><span id="l24.191">     while (thread.hasPendingEvents())</span>
<a href="#l24.192"></a><span id="l24.192">       thread.processNextEvent(true);</span>
<a href="#l24.193"></a><span id="l24.193">   }</span>
<a href="#l24.194"></a><span id="l24.194">   Assert.equal(exceptionCaught, aExceptionExpected);</span>
<a href="#l24.195"></a><span id="l24.195"> }</span>
<a href="#l24.196"></a><span id="l24.196"> </span>
<a href="#l24.197"></a><span id="l24.197"> </span>
<a href="#l24.198"></a><span id="l24.198" class="difflineminus">-function run_test()</span>
<a href="#l24.199"></a><span id="l24.199" class="difflineminus">-{</span>
<a href="#l24.200"></a><span id="l24.200" class="difflineminus">-  type = &quot;sendMailAddressIDN&quot;;</span>
<a href="#l24.201"></a><span id="l24.201" class="difflineplus">+function run_test() {</span>
<a href="#l24.202"></a><span id="l24.202">   registerAlertTestUtils();</span>
<a href="#l24.203"></a><span id="l24.203">   var composeProps = Services.strings.createBundle(&quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;);</span>
<a href="#l24.204"></a><span id="l24.204">   expectedAlertMessage = composeProps.GetStringFromName(&quot;errorIllegalLocalPart&quot;)</span>
<a href="#l24.205"></a><span id="l24.205">                                      .replace(&quot;%s&quot;, kToInvalid);</span>
<a href="#l24.206"></a><span id="l24.206"> </span>
<a href="#l24.207"></a><span id="l24.207">   // Ensure we have at least one mail account</span>
<a href="#l24.208"></a><span id="l24.208">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l24.209"></a><span id="l24.209">   MailServices.accounts.setSpecialFolders();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMailMessage.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMailMessage.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -3,30 +3,25 @@</span>
<a href="#l25.4"></a><span id="l25.4">  * Protocol tests for SMTP.</span>
<a href="#l25.5"></a><span id="l25.5">  *</span>
<a href="#l25.6"></a><span id="l25.6">  * This test currently consists of verifying the correct protocol sequence</span>
<a href="#l25.7"></a><span id="l25.7">  * between mailnews and SMTP server. It does not check the data of the message</span>
<a href="#l25.8"></a><span id="l25.8">  * either side of the link, it will be extended later to do that.</span>
<a href="#l25.9"></a><span id="l25.9">  */</span>
<a href="#l25.10"></a><span id="l25.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-var test = null;</span>
<a href="#l25.13"></a><span id="l25.13"> var server;</span>
<a href="#l25.14"></a><span id="l25.14"> </span>
<a href="#l25.15"></a><span id="l25.15"> var kIdentityMail = &quot;identity@foo.invalid&quot;;</span>
<a href="#l25.16"></a><span id="l25.16"> var kSender = &quot;from@foo.invalid&quot;;</span>
<a href="#l25.17"></a><span id="l25.17"> var kTo = &quot;to@foo.invalid&quot;;</span>
<a href="#l25.18"></a><span id="l25.18"> var kUsername = &quot;testsmtp&quot;;</span>
<a href="#l25.19"></a><span id="l25.19"> var kPassword = &quot;smtptest&quot;;</span>
<a href="#l25.20"></a><span id="l25.20"> </span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-var kTestFileSender = &quot;from_B@foo.invalid&quot;;</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-var kTestFileRecipient = &quot;to_B@foo.invalid&quot;;</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-</span>
<a href="#l25.24"></a><span id="l25.24"> function test_RFC2821() {</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-</span>
<a href="#l25.26"></a><span id="l25.26">   // Test file</span>
<a href="#l25.27"></a><span id="l25.27">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l25.28"></a><span id="l25.28"> </span>
<a href="#l25.29"></a><span id="l25.29">   // Ensure we have at least one mail account</span>
<a href="#l25.30"></a><span id="l25.30">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l25.31"></a><span id="l25.31"> </span>
<a href="#l25.32"></a><span id="l25.32">   server.start();</span>
<a href="#l25.33"></a><span id="l25.33">   var smtpServer = getBasicSmtpServer(server.port);</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineat">@@ -59,17 +54,17 @@ function test_RFC2821() {</span>
<a href="#l25.35"></a><span id="l25.35">     Services.prefs.setBoolPref(&quot;mail.smtp.useSenderForSmtpMailFrom&quot;, true);</span>
<a href="#l25.36"></a><span id="l25.36"> </span>
<a href="#l25.37"></a><span id="l25.37">     MailServices.smtp.sendMailMessage(testFile, kTo, identity, kSender,</span>
<a href="#l25.38"></a><span id="l25.38">                                       null, null, null, null,</span>
<a href="#l25.39"></a><span id="l25.39">                                       false, {}, {});</span>
<a href="#l25.40"></a><span id="l25.40"> </span>
<a href="#l25.41"></a><span id="l25.41">     server.performTest();</span>
<a href="#l25.42"></a><span id="l25.42"> </span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-    var transaction = server.playTransaction();</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineplus">+    transaction = server.playTransaction();</span>
<a href="#l25.45"></a><span id="l25.45">     do_check_transaction(transaction, [&quot;EHLO test&quot;,</span>
<a href="#l25.46"></a><span id="l25.46">                                        &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; BODY=8BITMIME SIZE=159&quot;,</span>
<a href="#l25.47"></a><span id="l25.47">                                        &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l25.48"></a><span id="l25.48">                                        &quot;DATA&quot;]);</span>
<a href="#l25.49"></a><span id="l25.49"> </span>
<a href="#l25.50"></a><span id="l25.50">     server.resetTest();</span>
<a href="#l25.51"></a><span id="l25.51"> </span>
<a href="#l25.52"></a><span id="l25.52">     // This time with auth.</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineat">@@ -84,17 +79,17 @@ function test_RFC2821() {</span>
<a href="#l25.54"></a><span id="l25.54">     Services.prefs.setBoolPref(&quot;mail.smtp.useSenderForSmtpMailFrom&quot;, false);</span>
<a href="#l25.55"></a><span id="l25.55"> </span>
<a href="#l25.56"></a><span id="l25.56">     MailServices.smtp.sendMailMessage(testFile, kTo, identity, kSender,</span>
<a href="#l25.57"></a><span id="l25.57">                                       null, null, null, null,</span>
<a href="#l25.58"></a><span id="l25.58">                                       false, {}, {});</span>
<a href="#l25.59"></a><span id="l25.59"> </span>
<a href="#l25.60"></a><span id="l25.60">     server.performTest();</span>
<a href="#l25.61"></a><span id="l25.61"> </span>
<a href="#l25.62"></a><span id="l25.62" class="difflineminus">-    var transaction = server.playTransaction();</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineplus">+    transaction = server.playTransaction();</span>
<a href="#l25.64"></a><span id="l25.64">     do_check_transaction(transaction, [&quot;EHLO test&quot;,</span>
<a href="#l25.65"></a><span id="l25.65">                                        &quot;AUTH PLAIN &quot; + AuthPLAIN.encodeLine(kUsername, kPassword),</span>
<a href="#l25.66"></a><span id="l25.66">                                        &quot;MAIL FROM:&lt;&quot; + kIdentityMail + &quot;&gt; BODY=8BITMIME SIZE=159&quot;,</span>
<a href="#l25.67"></a><span id="l25.67">                                        &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l25.68"></a><span id="l25.68">                                        &quot;DATA&quot;]);</span>
<a href="#l25.69"></a><span id="l25.69"> </span>
<a href="#l25.70"></a><span id="l25.70">     server.resetTest();</span>
<a href="#l25.71"></a><span id="l25.71"> </span>
<a href="#l25.72"></a><span id="l25.72" class="difflineat">@@ -102,23 +97,22 @@ function test_RFC2821() {</span>
<a href="#l25.73"></a><span id="l25.73">     Services.prefs.setBoolPref(&quot;mail.smtp.useSenderForSmtpMailFrom&quot;, true);</span>
<a href="#l25.74"></a><span id="l25.74"> </span>
<a href="#l25.75"></a><span id="l25.75">     MailServices.smtp.sendMailMessage(testFile, kTo, identity, kSender,</span>
<a href="#l25.76"></a><span id="l25.76">                                       null, null, null, null,</span>
<a href="#l25.77"></a><span id="l25.77">                                       false, {}, {});</span>
<a href="#l25.78"></a><span id="l25.78"> </span>
<a href="#l25.79"></a><span id="l25.79">     server.performTest();</span>
<a href="#l25.80"></a><span id="l25.80"> </span>
<a href="#l25.81"></a><span id="l25.81" class="difflineminus">-    var transaction = server.playTransaction();</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineplus">+    transaction = server.playTransaction();</span>
<a href="#l25.83"></a><span id="l25.83">     do_check_transaction(transaction, [&quot;EHLO test&quot;,</span>
<a href="#l25.84"></a><span id="l25.84">                                        &quot;AUTH PLAIN &quot; + AuthPLAIN.encodeLine(kUsername, kPassword),</span>
<a href="#l25.85"></a><span id="l25.85">                                        &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; BODY=8BITMIME SIZE=159&quot;,</span>
<a href="#l25.86"></a><span id="l25.86">                                        &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l25.87"></a><span id="l25.87">                                        &quot;DATA&quot;]);</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineminus">-</span>
<a href="#l25.89"></a><span id="l25.89">   } catch (e) {</span>
<a href="#l25.90"></a><span id="l25.90">     do_throw(e);</span>
<a href="#l25.91"></a><span id="l25.91">   } finally {</span>
<a href="#l25.92"></a><span id="l25.92">     server.stop();</span>
<a href="#l25.93"></a><span id="l25.93"> </span>
<a href="#l25.94"></a><span id="l25.94">     var thread = gThreadManager.currentThread;</span>
<a href="#l25.95"></a><span id="l25.95">     while (thread.hasPendingEvents())</span>
<a href="#l25.96"></a><span id="l25.96">       thread.processNextEvent(true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMessageFile.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMessageFile.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -8,37 +8,35 @@</span>
<a href="#l26.4"></a><span id="l26.4">  * - Correct saving of the message to the sent folder.</span>
<a href="#l26.5"></a><span id="l26.5">  *</span>
<a href="#l26.6"></a><span id="l26.6">  * Originally written to test bug 429891 where saving to the sent folder was</span>
<a href="#l26.7"></a><span id="l26.7">  * mangling the message.</span>
<a href="#l26.8"></a><span id="l26.8">  */</span>
<a href="#l26.9"></a><span id="l26.9"> </span>
<a href="#l26.10"></a><span id="l26.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-var type = null;</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-var test = null;</span>
<a href="#l26.14"></a><span id="l26.14"> var server;</span>
<a href="#l26.15"></a><span id="l26.15"> var sentFolder;</span>
<a href="#l26.16"></a><span id="l26.16"> var originalData;</span>
<a href="#l26.17"></a><span id="l26.17"> var finished = false;</span>
<a href="#l26.18"></a><span id="l26.18"> </span>
<a href="#l26.19"></a><span id="l26.19"> var kSender = &quot;from@foo.invalid&quot;;</span>
<a href="#l26.20"></a><span id="l26.20"> var kTo = &quot;to@foo.invalid&quot;;</span>
<a href="#l26.21"></a><span id="l26.21"> </span>
<a href="#l26.22"></a><span id="l26.22"> function msl() {}</span>
<a href="#l26.23"></a><span id="l26.23"> </span>
<a href="#l26.24"></a><span id="l26.24"> msl.prototype = {</span>
<a href="#l26.25"></a><span id="l26.25">   // nsIMsgSendListener</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineminus">-  onStartSending: function (aMsgID, aMsgSize) {</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineplus">+  onStartSending(aMsgID, aMsgSize) {</span>
<a href="#l26.28"></a><span id="l26.28">   },</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineminus">-  onProgress: function (aMsgID, aProgress, aProgressMax) {</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineplus">+  onProgress(aMsgID, aProgress, aProgressMax) {</span>
<a href="#l26.31"></a><span id="l26.31">   },</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-  onStatus: function (aMsgID, aMsg) {</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+  onStatus(aMsgID, aMsg) {</span>
<a href="#l26.34"></a><span id="l26.34">   },</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineminus">-  onStopSending: function (aMsgID, aStatus, aMsg, aReturnFile) {</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineplus">+  onStopSending(aMsgID, aStatus, aMsg, aReturnFile) {</span>
<a href="#l26.37"></a><span id="l26.37">     try {</span>
<a href="#l26.38"></a><span id="l26.38">       Assert.equal(aStatus, 0);</span>
<a href="#l26.39"></a><span id="l26.39"> </span>
<a href="#l26.40"></a><span id="l26.40">       do_check_transaction(server.playTransaction(),</span>
<a href="#l26.41"></a><span id="l26.41">                            [&quot;EHLO test&quot;,</span>
<a href="#l26.42"></a><span id="l26.42">                             &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; BODY=8BITMIME SIZE=&quot; + originalData.length,</span>
<a href="#l26.43"></a><span id="l26.43">                             &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l26.44"></a><span id="l26.44">                             &quot;DATA&quot;]);</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineat">@@ -50,31 +48,31 @@ msl.prototype = {</span>
<a href="#l26.46"></a><span id="l26.46">     } finally {</span>
<a href="#l26.47"></a><span id="l26.47">       server.stop();</span>
<a href="#l26.48"></a><span id="l26.48"> </span>
<a href="#l26.49"></a><span id="l26.49">       var thread = gThreadManager.currentThread;</span>
<a href="#l26.50"></a><span id="l26.50">       while (thread.hasPendingEvents())</span>
<a href="#l26.51"></a><span id="l26.51">         thread.processNextEvent(false);</span>
<a href="#l26.52"></a><span id="l26.52">     }</span>
<a href="#l26.53"></a><span id="l26.53">   },</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineminus">-  onGetDraftFolderURI: function (aFolderURI) {</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineplus">+  onGetDraftFolderURI(aFolderURI) {</span>
<a href="#l26.56"></a><span id="l26.56">   },</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineminus">-  onSendNotPerformed: function (aMsgID, aStatus) {</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineplus">+  onSendNotPerformed(aMsgID, aStatus) {</span>
<a href="#l26.59"></a><span id="l26.59">   },</span>
<a href="#l26.60"></a><span id="l26.60"> </span>
<a href="#l26.61"></a><span id="l26.61">   // nsIMsgCopyServiceListener</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineminus">-  OnStartCopy: function () {</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineplus">+  OnStartCopy() {</span>
<a href="#l26.64"></a><span id="l26.64">   },</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineminus">-  OnProgress: function (aProgress, aProgressMax) {</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {</span>
<a href="#l26.67"></a><span id="l26.67">   },</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineminus">-  SetMessageKey: function (aKey) {</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineplus">+  SetMessageKey(aKey) {</span>
<a href="#l26.70"></a><span id="l26.70">   },</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineminus">-  GetMessageId: function (aMessageId) {</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineplus">+  GetMessageId(aMessageId) {</span>
<a href="#l26.73"></a><span id="l26.73">   },</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineminus">-  OnStopCopy: function (aStatus) {</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l26.76"></a><span id="l26.76">     Assert.equal(aStatus, 0);</span>
<a href="#l26.77"></a><span id="l26.77">     try {</span>
<a href="#l26.78"></a><span id="l26.78">       // Now do a comparison of what is in the sent mail folder</span>
<a href="#l26.79"></a><span id="l26.79">       let msgData = mailTestUtils</span>
<a href="#l26.80"></a><span id="l26.80">         .loadMessageToString(sentFolder, mailTestUtils.firstMsgHdr(sentFolder));</span>
<a href="#l26.81"></a><span id="l26.81"> </span>
<a href="#l26.82"></a><span id="l26.82">       // Skip the headers etc that mailnews adds</span>
<a href="#l26.83"></a><span id="l26.83">       var pos = msgData.indexOf(&quot;From:&quot;);</span>
<a href="#l26.84"></a><span id="l26.84" class="difflineat">@@ -89,23 +87,21 @@ msl.prototype = {</span>
<a href="#l26.85"></a><span id="l26.85">       finished = true;</span>
<a href="#l26.86"></a><span id="l26.86">       do_test_finished();</span>
<a href="#l26.87"></a><span id="l26.87">     }</span>
<a href="#l26.88"></a><span id="l26.88">   },</span>
<a href="#l26.89"></a><span id="l26.89"> </span>
<a href="#l26.90"></a><span id="l26.90">   // QueryInterface</span>
<a href="#l26.91"></a><span id="l26.91">   QueryInterface: ChromeUtils.generateQI([&quot;nsIMsgSendListener&quot;,</span>
<a href="#l26.92"></a><span id="l26.92">                                           &quot;nsIMsgCopyServiceListener&quot;]),</span>
<a href="#l26.93"></a><span id="l26.93" class="difflineminus">-}</span>
<a href="#l26.94"></a><span id="l26.94" class="difflineplus">+};</span>
<a href="#l26.95"></a><span id="l26.95"> </span>
<a href="#l26.96"></a><span id="l26.96"> function run_test() {</span>
<a href="#l26.97"></a><span id="l26.97">   server = setupServerDaemon();</span>
<a href="#l26.98"></a><span id="l26.98"> </span>
<a href="#l26.99"></a><span id="l26.99" class="difflineminus">-  type = &quot;sendMessageFile&quot;;</span>
<a href="#l26.100"></a><span id="l26.100" class="difflineminus">-</span>
<a href="#l26.101"></a><span id="l26.101">   // Test file - for bug 429891</span>
<a href="#l26.102"></a><span id="l26.102">   var testFile = do_get_file(&quot;data/429891_testcase.eml&quot;);</span>
<a href="#l26.103"></a><span id="l26.103">   originalData = IOUtils.loadFileToString(testFile);</span>
<a href="#l26.104"></a><span id="l26.104"> </span>
<a href="#l26.105"></a><span id="l26.105">   // Ensure we have at least one mail account</span>
<a href="#l26.106"></a><span id="l26.106">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l26.107"></a><span id="l26.107"> </span>
<a href="#l26.108"></a><span id="l26.108">   MailServices.accounts.setSpecialFolders();</span>
<a href="#l26.109"></a><span id="l26.109" class="difflineat">@@ -139,22 +135,22 @@ function run_test() {</span>
<a href="#l26.110"></a><span id="l26.110">     var messageListener = new msl();</span>
<a href="#l26.111"></a><span id="l26.111"> </span>
<a href="#l26.112"></a><span id="l26.112">     msgSend.sendMessageFile(identity, &quot;&quot;, compFields, testFile,</span>
<a href="#l26.113"></a><span id="l26.113">                             false, false, Ci.nsIMsgSend.nsMsgDeliverNow,</span>
<a href="#l26.114"></a><span id="l26.114">                             null, messageListener, null, null);</span>
<a href="#l26.115"></a><span id="l26.115"> </span>
<a href="#l26.116"></a><span id="l26.116">     server.performTest();</span>
<a href="#l26.117"></a><span id="l26.117"> </span>
<a href="#l26.118"></a><span id="l26.118" class="difflineminus">-    do_timeout(10000, function()</span>
<a href="#l26.119"></a><span id="l26.119" class="difflineminus">-        {if (!finished) do_throw('Notifications of message send/copy not received');}</span>
<a href="#l26.120"></a><span id="l26.120" class="difflineminus">-      );</span>
<a href="#l26.121"></a><span id="l26.121" class="difflineplus">+    do_timeout(10000, function() {</span>
<a href="#l26.122"></a><span id="l26.122" class="difflineplus">+      if (!finished)</span>
<a href="#l26.123"></a><span id="l26.123" class="difflineplus">+        do_throw(&quot;Notifications of message send/copy not received&quot;);</span>
<a href="#l26.124"></a><span id="l26.124" class="difflineplus">+    });</span>
<a href="#l26.125"></a><span id="l26.125"> </span>
<a href="#l26.126"></a><span id="l26.126">     do_test_pending();</span>
<a href="#l26.127"></a><span id="l26.127" class="difflineminus">-</span>
<a href="#l26.128"></a><span id="l26.128">   } catch (e) {</span>
<a href="#l26.129"></a><span id="l26.129">     do_throw(e);</span>
<a href="#l26.130"></a><span id="l26.130">   } finally {</span>
<a href="#l26.131"></a><span id="l26.131">     server.stop();</span>
<a href="#l26.132"></a><span id="l26.132"> </span>
<a href="#l26.133"></a><span id="l26.133">     var thread = gThreadManager.currentThread;</span>
<a href="#l26.134"></a><span id="l26.134">     while (thread.hasPendingEvents())</span>
<a href="#l26.135"></a><span id="l26.135">       thread.processNextEvent(true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMessageLater.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMessageLater.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -8,61 +8,55 @@</span>
<a href="#l27.4"></a><span id="l27.4">  * - Correct saving of the message to the sent folder.</span>
<a href="#l27.5"></a><span id="l27.5">  *</span>
<a href="#l27.6"></a><span id="l27.6">  * Originally written to test bug 429891 where saving to the sent folder was</span>
<a href="#l27.7"></a><span id="l27.7">  * mangling the message.</span>
<a href="#l27.8"></a><span id="l27.8">  */</span>
<a href="#l27.9"></a><span id="l27.9"> </span>
<a href="#l27.10"></a><span id="l27.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-var type = null;</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-var test = null;</span>
<a href="#l27.14"></a><span id="l27.14"> var server;</span>
<a href="#l27.15"></a><span id="l27.15"> var smtpServer;</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineminus">-var sentFolder;</span>
<a href="#l27.17"></a><span id="l27.17"> var originalData;</span>
<a href="#l27.18"></a><span id="l27.18"> var finished = false;</span>
<a href="#l27.19"></a><span id="l27.19"> var identity = null;</span>
<a href="#l27.20"></a><span id="l27.20"> var testFile = do_get_file(&quot;data/429891_testcase.eml&quot;);</span>
<a href="#l27.21"></a><span id="l27.21"> var kTestFileSender = &quot;from_A@foo.invalid&quot;;</span>
<a href="#l27.22"></a><span id="l27.22"> var kTestFileRecipient = &quot;to_A@foo.invalid&quot;;</span>
<a href="#l27.23"></a><span id="l27.23"> </span>
<a href="#l27.24"></a><span id="l27.24"> var kIdentityMail = &quot;identity@foo.invalid&quot;;</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineminus">-var kToEncodedDisplayName = &quot;=?UTF-8?B?RnLDqcOpZGxlLCBUZXN0?=&quot;; // &quot;Frdle, Test&quot;</span>
<a href="#l27.26"></a><span id="l27.26"> </span>
<a href="#l27.27"></a><span id="l27.27"> var msgSendLater = Cc[&quot;@mozilla.org/messengercompose/sendlater;1&quot;]</span>
<a href="#l27.28"></a><span id="l27.28">   .getService(Ci.nsIMsgSendLater);</span>
<a href="#l27.29"></a><span id="l27.29"> </span>
<a href="#l27.30"></a><span id="l27.30"> // This listener handles the post-sending of the actual message and checks the</span>
<a href="#l27.31"></a><span id="l27.31"> // sequence and ensures the data is correct.</span>
<a href="#l27.32"></a><span id="l27.32"> function msll() {</span>
<a href="#l27.33"></a><span id="l27.33"> }</span>
<a href="#l27.34"></a><span id="l27.34"> </span>
<a href="#l27.35"></a><span id="l27.35"> msll.prototype = {</span>
<a href="#l27.36"></a><span id="l27.36">   _initialTotal: 0,</span>
<a href="#l27.37"></a><span id="l27.37">   _startedSending: false,</span>
<a href="#l27.38"></a><span id="l27.38"> </span>
<a href="#l27.39"></a><span id="l27.39">   // nsIMsgSendLaterListener</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineminus">-  onStartSending: function (aTotalMessageCount) {</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineplus">+  onStartSending(aTotalMessageCount) {</span>
<a href="#l27.42"></a><span id="l27.42">     this._initialTotal = 1;</span>
<a href="#l27.43"></a><span id="l27.43">     Assert.equal(msgSendLater.sendingMessages, true);</span>
<a href="#l27.44"></a><span id="l27.44">   },</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineminus">-  onMessageStartSending: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineminus">-                                   aMessageHeader, aIdentity) {</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineplus">+  onMessageStartSending(aCurrentMessage, aTotalMessageCount, aMessageHeader, aIdentity) {</span>
<a href="#l27.48"></a><span id="l27.48">     this._startedSending = true;</span>
<a href="#l27.49"></a><span id="l27.49">   },</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineminus">-  onMessageSendProgress: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineminus">-                                   aMessageSendPercent, aMessageCopyPercent) {</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineplus">+  onMessageSendProgress(aCurrentMessage, aTotalMessageCount,</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineplus">+                        aMessageSendPercent, aMessageCopyPercent) {</span>
<a href="#l27.54"></a><span id="l27.54">     // XXX Enable this function</span>
<a href="#l27.55"></a><span id="l27.55">   },</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineminus">-  onMessageSendError: function (aCurrentMessage, aMessageHeader, aStatus,</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineminus">-                                aMsg) {</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineplus">+  onMessageSendError(aCurrentMessage, aMessageHeader, aStatus, aMsg) {</span>
<a href="#l27.59"></a><span id="l27.59">     do_throw(&quot;onMessageSendError should not have been called, status: &quot; + aStatus);</span>
<a href="#l27.60"></a><span id="l27.60">   },</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineminus">-  onStopSending: function (aStatus, aMsg, aTotalTried, aSuccessful) {</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineplus">+  onStopSending(aStatus, aMsg, aTotalTried, aSuccessful) {</span>
<a href="#l27.63"></a><span id="l27.63">     do_test_finished();</span>
<a href="#l27.64"></a><span id="l27.64">     print(&quot;msll onStopSending\n&quot;);</span>
<a href="#l27.65"></a><span id="l27.65">     try {</span>
<a href="#l27.66"></a><span id="l27.66">       Assert.equal(this._startedSending, true);</span>
<a href="#l27.67"></a><span id="l27.67">       Assert.equal(aStatus, 0);</span>
<a href="#l27.68"></a><span id="l27.68">       Assert.equal(aTotalTried, 1);</span>
<a href="#l27.69"></a><span id="l27.69">       Assert.equal(aSuccessful, 1);</span>
<a href="#l27.70"></a><span id="l27.70">       Assert.equal(this._initialTotal, 1);</span>
<a href="#l27.71"></a><span id="l27.71" class="difflineat">@@ -83,19 +77,20 @@ msll.prototype = {</span>
<a href="#l27.72"></a><span id="l27.72">       do_throw(e);</span>
<a href="#l27.73"></a><span id="l27.73">     } finally {</span>
<a href="#l27.74"></a><span id="l27.74">       server.stop();</span>
<a href="#l27.75"></a><span id="l27.75"> </span>
<a href="#l27.76"></a><span id="l27.76">       var thread = gThreadManager.currentThread;</span>
<a href="#l27.77"></a><span id="l27.77">       while (thread.hasPendingEvents())</span>
<a href="#l27.78"></a><span id="l27.78">         thread.processNextEvent(true);</span>
<a href="#l27.79"></a><span id="l27.79">     }</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineminus">-  }</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineplus">+  },</span>
<a href="#l27.82"></a><span id="l27.82"> };</span>
<a href="#l27.83"></a><span id="l27.83"> </span>
<a href="#l27.84"></a><span id="l27.84" class="difflineplus">+/* exported OnStopCopy */// for head_compose.js</span>
<a href="#l27.85"></a><span id="l27.85"> function OnStopCopy(aStatus) {</span>
<a href="#l27.86"></a><span id="l27.86">   dump(&quot;OnStopCopy()\n&quot;);</span>
<a href="#l27.87"></a><span id="l27.87"> </span>
<a href="#l27.88"></a><span id="l27.88">   try {</span>
<a href="#l27.89"></a><span id="l27.89">     Assert.equal(aStatus, 0);</span>
<a href="#l27.90"></a><span id="l27.90"> </span>
<a href="#l27.91"></a><span id="l27.91">     // Check this is false before we start sending</span>
<a href="#l27.92"></a><span id="l27.92">     Assert.equal(msgSendLater.sendingMessages, false);</span>
<a href="#l27.93"></a><span id="l27.93" class="difflineat">@@ -130,23 +125,20 @@ function OnStopCopy(aStatus) {</span>
<a href="#l27.94"></a><span id="l27.94">     while (thread.hasPendingEvents())</span>
<a href="#l27.95"></a><span id="l27.95">       thread.processNextEvent(true);</span>
<a href="#l27.96"></a><span id="l27.96"> </span>
<a href="#l27.97"></a><span id="l27.97">     finished = true;</span>
<a href="#l27.98"></a><span id="l27.98">   }</span>
<a href="#l27.99"></a><span id="l27.99"> }</span>
<a href="#l27.100"></a><span id="l27.100"> </span>
<a href="#l27.101"></a><span id="l27.101"> // This function does the actual send later</span>
<a href="#l27.102"></a><span id="l27.102" class="difflineminus">-function sendMessageLater()</span>
<a href="#l27.103"></a><span id="l27.103" class="difflineminus">-{</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineplus">+function sendMessageLater() {</span>
<a href="#l27.105"></a><span id="l27.105">   // Set up the SMTP server.</span>
<a href="#l27.106"></a><span id="l27.106">   server = setupServerDaemon();</span>
<a href="#l27.107"></a><span id="l27.107"> </span>
<a href="#l27.108"></a><span id="l27.108" class="difflineminus">-  type = &quot;sendMessageLater&quot;;</span>
<a href="#l27.109"></a><span id="l27.109" class="difflineminus">-</span>
<a href="#l27.110"></a><span id="l27.110">   // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l27.111"></a><span id="l27.111">   // the server if something fails.</span>
<a href="#l27.112"></a><span id="l27.112">   try {</span>
<a href="#l27.113"></a><span id="l27.113">     // Start the fake SMTP server</span>
<a href="#l27.114"></a><span id="l27.114">     server.start();</span>
<a href="#l27.115"></a><span id="l27.115">     smtpServer.port = server.port;</span>
<a href="#l27.116"></a><span id="l27.116"> </span>
<a href="#l27.117"></a><span id="l27.117">     // A test to check that we are sending files correctly, including checking</span>
<a href="#l27.118"></a><span id="l27.118" class="difflineat">@@ -157,19 +149,20 @@ function sendMessageLater()</span>
<a href="#l27.119"></a><span id="l27.119"> </span>
<a href="#l27.120"></a><span id="l27.120">     msgSendLater.addListener(messageListener);</span>
<a href="#l27.121"></a><span id="l27.121"> </span>
<a href="#l27.122"></a><span id="l27.122">     // Send the unsent message</span>
<a href="#l27.123"></a><span id="l27.123">     msgSendLater.sendUnsentMessages(identity);</span>
<a href="#l27.124"></a><span id="l27.124"> </span>
<a href="#l27.125"></a><span id="l27.125">     server.performTest();</span>
<a href="#l27.126"></a><span id="l27.126"> </span>
<a href="#l27.127"></a><span id="l27.127" class="difflineminus">-    do_timeout(10000, function()</span>
<a href="#l27.128"></a><span id="l27.128" class="difflineminus">-        {if (!finished) do_throw('Notifications of message send/copy not received');}</span>
<a href="#l27.129"></a><span id="l27.129" class="difflineminus">-      );</span>
<a href="#l27.130"></a><span id="l27.130" class="difflineplus">+    do_timeout(10000, function() {</span>
<a href="#l27.131"></a><span id="l27.131" class="difflineplus">+      if (!finished)</span>
<a href="#l27.132"></a><span id="l27.132" class="difflineplus">+        do_throw(&quot;Notifications of message send/copy not received&quot;);</span>
<a href="#l27.133"></a><span id="l27.133" class="difflineplus">+    });</span>
<a href="#l27.134"></a><span id="l27.134">   } catch (e) {</span>
<a href="#l27.135"></a><span id="l27.135">     do_throw(e);</span>
<a href="#l27.136"></a><span id="l27.136">   } finally {</span>
<a href="#l27.137"></a><span id="l27.137">     server.stop();</span>
<a href="#l27.138"></a><span id="l27.138"> </span>
<a href="#l27.139"></a><span id="l27.139">     var thread = gThreadManager.currentThread;</span>
<a href="#l27.140"></a><span id="l27.140">     while (thread.hasPendingEvents())</span>
<a href="#l27.141"></a><span id="l27.141">       thread.processNextEvent(true);</span>
<a href="#l27.142"></a><span id="l27.142" class="difflineat">@@ -195,17 +188,17 @@ function run_test() {</span>
<a href="#l27.143"></a><span id="l27.143">   smtpServer = getBasicSmtpServer(1);</span>
<a href="#l27.144"></a><span id="l27.144">   identity = getSmtpIdentity(kIdentityMail, smtpServer);</span>
<a href="#l27.145"></a><span id="l27.145"> </span>
<a href="#l27.146"></a><span id="l27.146">   account.addIdentity(identity);</span>
<a href="#l27.147"></a><span id="l27.147">   account.defaultIdentity = identity;</span>
<a href="#l27.148"></a><span id="l27.148">   account.incomingServer = incomingServer;</span>
<a href="#l27.149"></a><span id="l27.149">   MailServices.accounts.defaultAccount = account;</span>
<a href="#l27.150"></a><span id="l27.150"> </span>
<a href="#l27.151"></a><span id="l27.151" class="difflineminus">-  sentFolder = localAccountUtils.rootFolder.createLocalSubfolder(&quot;Sent&quot;);</span>
<a href="#l27.152"></a><span id="l27.152" class="difflineplus">+  localAccountUtils.rootFolder.createLocalSubfolder(&quot;Sent&quot;);</span>
<a href="#l27.153"></a><span id="l27.153"> </span>
<a href="#l27.154"></a><span id="l27.154">   Assert.equal(identity.doFcc, true);</span>
<a href="#l27.155"></a><span id="l27.155"> </span>
<a href="#l27.156"></a><span id="l27.156">   // Now prepare to actually &quot;send&quot; the message later, i.e. dump it in the</span>
<a href="#l27.157"></a><span id="l27.157">   // unsent messages folder.</span>
<a href="#l27.158"></a><span id="l27.158"> </span>
<a href="#l27.159"></a><span id="l27.159">   var compFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l27.160"></a><span id="l27.160">                      .createInstance(Ci.nsIMsgCompFields);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMessageLater2.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMessageLater2.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -7,99 +7,87 @@</span>
<a href="#l28.4"></a><span id="l28.4">  * from one send later instance, however due to the fact we use one connection</span>
<a href="#l28.5"></a><span id="l28.5">  * per message sent, it is very difficult to consistently get the fake server</span>
<a href="#l28.6"></a><span id="l28.6">  * reconected in time for the next connection. Thus, sending of multiple</span>
<a href="#l28.7"></a><span id="l28.7">  * messages is currently disabled (but commented out for local testing if</span>
<a href="#l28.8"></a><span id="l28.8">  * required), when we fix bug 136871 we should be able to enable the multiple</span>
<a href="#l28.9"></a><span id="l28.9">  * messages option.</span>
<a href="#l28.10"></a><span id="l28.10">  */</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l28.14"></a><span id="l28.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l28.15"></a><span id="l28.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l28.16"></a><span id="l28.16"> </span>
<a href="#l28.17"></a><span id="l28.17"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l28.18"></a><span id="l28.18"> </span>
<a href="#l28.19"></a><span id="l28.19" class="difflineminus">-var test = &quot;sendMessageLater&quot;;</span>
<a href="#l28.20"></a><span id="l28.20"> var server = null;</span>
<a href="#l28.21"></a><span id="l28.21"> var smtpServer;</span>
<a href="#l28.22"></a><span id="l28.22"> var gSentFolder;</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineminus">-var originalData;</span>
<a href="#l28.24"></a><span id="l28.24"> var identity = null;</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineminus">-var gMsgFile =</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineminus">-[</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineplus">+var gMsgFile = [</span>
<a href="#l28.28"></a><span id="l28.28">   do_get_file(&quot;data/message1.eml&quot;),</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineminus">-  do_get_file(&quot;data/429891_testcase.eml&quot;)</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineplus">+  do_get_file(&quot;data/429891_testcase.eml&quot;),</span>
<a href="#l28.31"></a><span id="l28.31"> ];</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineminus">-var kTestFileSender =</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineminus">-[</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineplus">+var kTestFileSender = [</span>
<a href="#l28.35"></a><span id="l28.35">   &quot;from_B@foo.invalid&quot;,</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineminus">-  &quot;from_A@foo.invalid&quot;</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineplus">+  &quot;from_A@foo.invalid&quot;,</span>
<a href="#l28.38"></a><span id="l28.38"> ];</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineminus">-var kTestFileRecipient =</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineminus">-[</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineplus">+var kTestFileRecipient = [</span>
<a href="#l28.42"></a><span id="l28.42">   &quot;to_B@foo.invalid&quot;,</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineminus">-  &quot;to_A@foo.invalid&quot;</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineplus">+  &quot;to_A@foo.invalid&quot;,</span>
<a href="#l28.45"></a><span id="l28.45"> ];</span>
<a href="#l28.46"></a><span id="l28.46"> </span>
<a href="#l28.47"></a><span id="l28.47"> var gMsgFileData = [];</span>
<a href="#l28.48"></a><span id="l28.48"> var gMsgOrder = [];</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineminus">-var gCurTestNum = 0;</span>
<a href="#l28.50"></a><span id="l28.50"> var gLastSentMessage = 0;</span>
<a href="#l28.51"></a><span id="l28.51"> </span>
<a href="#l28.52"></a><span id="l28.52" class="difflineminus">-// gMessageSendStatus</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineminus">-// 0 = initial value</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineminus">-// 1 = send completed before exiting sendUnsentMessages</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineminus">-// 2 = sendUnsentMessages has exited.</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineminus">-var gMessageSendStatus = 0;</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineminus">-</span>
<a href="#l28.58"></a><span id="l28.58"> var kIdentityMail = &quot;identity@foo.invalid&quot;;</span>
<a href="#l28.59"></a><span id="l28.59"> </span>
<a href="#l28.60"></a><span id="l28.60"> var msgSendLater = Cc[&quot;@mozilla.org/messengercompose/sendlater;1&quot;]</span>
<a href="#l28.61"></a><span id="l28.61">                      .getService(Ci.nsIMsgSendLater);</span>
<a href="#l28.62"></a><span id="l28.62"> </span>
<a href="#l28.63"></a><span id="l28.63"> // This listener handles the post-sending of the actual message and checks the</span>
<a href="#l28.64"></a><span id="l28.64"> // sequence and ensures the data is correct.</span>
<a href="#l28.65"></a><span id="l28.65"> function msll() {</span>
<a href="#l28.66"></a><span id="l28.66"> }</span>
<a href="#l28.67"></a><span id="l28.67"> </span>
<a href="#l28.68"></a><span id="l28.68"> msll.prototype = {</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineminus">-  checkMessageSend: function(aCurrentMessage) {</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineplus">+  checkMessageSend(aCurrentMessage) {</span>
<a href="#l28.71"></a><span id="l28.71">     do_check_transaction(server.playTransaction(),</span>
<a href="#l28.72"></a><span id="l28.72">                          [&quot;EHLO test&quot;,</span>
<a href="#l28.73"></a><span id="l28.73">                           &quot;MAIL FROM:&lt;&quot; + kTestFileSender[gMsgOrder[aCurrentMessage - 1]] + &quot;&gt; BODY=8BITMIME SIZE=&quot; + gMsgFileData[gMsgOrder[aCurrentMessage - 1]].length,</span>
<a href="#l28.74"></a><span id="l28.74">                           &quot;RCPT TO:&lt;&quot; + kTestFileRecipient[gMsgOrder[aCurrentMessage - 1]] + &quot;&gt;&quot;,</span>
<a href="#l28.75"></a><span id="l28.75">                           &quot;DATA&quot;]);</span>
<a href="#l28.76"></a><span id="l28.76"> </span>
<a href="#l28.77"></a><span id="l28.77">     // Compare data file to what the server received</span>
<a href="#l28.78"></a><span id="l28.78">     Assert.equal(gMsgFileData[gMsgOrder[aCurrentMessage - 1]], server._daemon.post);</span>
<a href="#l28.79"></a><span id="l28.79">   },</span>
<a href="#l28.80"></a><span id="l28.80"> </span>
<a href="#l28.81"></a><span id="l28.81">   // nsIMsgSendLaterListener</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineminus">-  onStartSending: function (aTotalMessageCount) {</span>
<a href="#l28.83"></a><span id="l28.83" class="difflineplus">+  onStartSending(aTotalMessageCount) {</span>
<a href="#l28.84"></a><span id="l28.84">     Assert.equal(aTotalMessageCount, gMsgOrder.length);</span>
<a href="#l28.85"></a><span id="l28.85">     Assert.equal(msgSendLater.sendingMessages, true);</span>
<a href="#l28.86"></a><span id="l28.86">   },</span>
<a href="#l28.87"></a><span id="l28.87" class="difflineminus">-  onMessageStartSending: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l28.88"></a><span id="l28.88" class="difflineminus">-                                   aMessageHeader, aIdentity) {</span>
<a href="#l28.89"></a><span id="l28.89" class="difflineplus">+  onMessageStartSending(aCurrentMessage, aTotalMessageCount, aMessageHeader, aIdentity) {</span>
<a href="#l28.90"></a><span id="l28.90">     if (gLastSentMessage &gt; 0)</span>
<a href="#l28.91"></a><span id="l28.91">       this.checkMessageSend(aCurrentMessage);</span>
<a href="#l28.92"></a><span id="l28.92">     Assert.equal(gLastSentMessage + 1, aCurrentMessage);</span>
<a href="#l28.93"></a><span id="l28.93">     gLastSentMessage = aCurrentMessage;</span>
<a href="#l28.94"></a><span id="l28.94">   },</span>
<a href="#l28.95"></a><span id="l28.95" class="difflineminus">-  onMessageSendProgress: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l28.96"></a><span id="l28.96" class="difflineminus">-                                   aMessageSendPercent, aMessageCopyPercent) {</span>
<a href="#l28.97"></a><span id="l28.97" class="difflineplus">+  onMessageSendProgress(aCurrentMessage, aTotalMessageCount,</span>
<a href="#l28.98"></a><span id="l28.98" class="difflineplus">+                        aMessageSendPercent, aMessageCopyPercent) {</span>
<a href="#l28.99"></a><span id="l28.99">     Assert.equal(aTotalMessageCount, gMsgOrder.length);</span>
<a href="#l28.100"></a><span id="l28.100">     Assert.equal(gLastSentMessage, aCurrentMessage);</span>
<a href="#l28.101"></a><span id="l28.101">     Assert.equal(msgSendLater.sendingMessages, true);</span>
<a href="#l28.102"></a><span id="l28.102">   },</span>
<a href="#l28.103"></a><span id="l28.103" class="difflineminus">-  onMessageSendError: function (aCurrentMessage, aMessageHeader, aStatus,</span>
<a href="#l28.104"></a><span id="l28.104" class="difflineminus">-                                aMsg) {</span>
<a href="#l28.105"></a><span id="l28.105" class="difflineplus">+  onMessageSendError(aCurrentMessage, aMessageHeader, aStatus, aMsg) {</span>
<a href="#l28.106"></a><span id="l28.106">     do_throw(&quot;onMessageSendError should not have been called, status: &quot; + aStatus);</span>
<a href="#l28.107"></a><span id="l28.107">   },</span>
<a href="#l28.108"></a><span id="l28.108" class="difflineminus">-  onStopSending: function (aStatus, aMsg, aTotalTried, aSuccessful) {</span>
<a href="#l28.109"></a><span id="l28.109" class="difflineplus">+  onStopSending(aStatus, aMsg, aTotalTried, aSuccessful) {</span>
<a href="#l28.110"></a><span id="l28.110">     try {</span>
<a href="#l28.111"></a><span id="l28.111">       Assert.equal(aStatus, 0);</span>
<a href="#l28.112"></a><span id="l28.112">       Assert.equal(aTotalTried, aSuccessful);</span>
<a href="#l28.113"></a><span id="l28.113">       Assert.equal(msgSendLater.sendingMessages, false);</span>
<a href="#l28.114"></a><span id="l28.114"> </span>
<a href="#l28.115"></a><span id="l28.115">       // Check that the send later service now thinks we don't have messages to</span>
<a href="#l28.116"></a><span id="l28.116">       // send.</span>
<a href="#l28.117"></a><span id="l28.117">       Assert.equal(msgSendLater.hasUnsentMessages(identity), false);</span>
<a href="#l28.118"></a><span id="l28.118" class="difflineat">@@ -110,42 +98,41 @@ msll.prototype = {</span>
<a href="#l28.119"></a><span id="l28.119">       do_throw(e);</span>
<a href="#l28.120"></a><span id="l28.120">     }</span>
<a href="#l28.121"></a><span id="l28.121">     // The extra timeout here is to work around an issue where sometimes</span>
<a href="#l28.122"></a><span id="l28.122">     // the sendUnsentMessages is completely synchronous up until onStopSending</span>
<a href="#l28.123"></a><span id="l28.123">     // and sometimes it isn't. This protects us for the synchronous case to</span>
<a href="#l28.124"></a><span id="l28.124">     // allow the sendUnsentMessages function to complete and exit before we</span>
<a href="#l28.125"></a><span id="l28.125">     // call async_driver.</span>
<a href="#l28.126"></a><span id="l28.126">     do_timeout(0, async_driver);</span>
<a href="#l28.127"></a><span id="l28.127" class="difflineminus">-  }</span>
<a href="#l28.128"></a><span id="l28.128" class="difflineplus">+  },</span>
<a href="#l28.129"></a><span id="l28.129"> };</span>
<a href="#l28.130"></a><span id="l28.130"> </span>
<a href="#l28.131"></a><span id="l28.131" class="difflineplus">+/* exported OnStopCopy */// for head_compose.js</span>
<a href="#l28.132"></a><span id="l28.132"> // This function is used to find out when the copying of the message to the</span>
<a href="#l28.133"></a><span id="l28.133"> // unsent message folder is completed, and hence can fire off the actual</span>
<a href="#l28.134"></a><span id="l28.134"> // sending of the message.</span>
<a href="#l28.135"></a><span id="l28.135" class="difflineminus">-function OnStopCopy(aStatus)</span>
<a href="#l28.136"></a><span id="l28.136" class="difflineminus">-{</span>
<a href="#l28.137"></a><span id="l28.137" class="difflineplus">+function OnStopCopy(aStatus) {</span>
<a href="#l28.138"></a><span id="l28.138">   Assert.equal(aStatus, 0);</span>
<a href="#l28.139"></a><span id="l28.139"> </span>
<a href="#l28.140"></a><span id="l28.140">   // Check this is false before we start sending</span>
<a href="#l28.141"></a><span id="l28.141">   Assert.equal(msgSendLater.sendingMessages, false);</span>
<a href="#l28.142"></a><span id="l28.142"> </span>
<a href="#l28.143"></a><span id="l28.143">   // Check that the send later service thinks we have messages to send.</span>
<a href="#l28.144"></a><span id="l28.144">   Assert.equal(msgSendLater.hasUnsentMessages(identity), true);</span>
<a href="#l28.145"></a><span id="l28.145"> </span>
<a href="#l28.146"></a><span id="l28.146">   // Check we have a message in the unsent message folder</span>
<a href="#l28.147"></a><span id="l28.147">   Assert.equal(gSentFolder.getTotalMessages(false), gMsgOrder.length);</span>
<a href="#l28.148"></a><span id="l28.148"> </span>
<a href="#l28.149"></a><span id="l28.149">   // Start the next step after a brief time so that functions can finish</span>
<a href="#l28.150"></a><span id="l28.150">   // properly</span>
<a href="#l28.151"></a><span id="l28.151">   async_driver();</span>
<a href="#l28.152"></a><span id="l28.152"> }</span>
<a href="#l28.153"></a><span id="l28.153"> </span>
<a href="#l28.154"></a><span id="l28.154" class="difflineminus">-function sendMessageLater(aTestFileIndex)</span>
<a href="#l28.155"></a><span id="l28.155" class="difflineminus">-{</span>
<a href="#l28.156"></a><span id="l28.156" class="difflineplus">+function sendMessageLater(aTestFileIndex) {</span>
<a href="#l28.157"></a><span id="l28.157">   gMsgOrder.push(aTestFileIndex);</span>
<a href="#l28.158"></a><span id="l28.158"> </span>
<a href="#l28.159"></a><span id="l28.159">   // Prepare to actually &quot;send&quot; the message later, i.e. dump it in the</span>
<a href="#l28.160"></a><span id="l28.160">   // unsent messages folder.</span>
<a href="#l28.161"></a><span id="l28.161"> </span>
<a href="#l28.162"></a><span id="l28.162">   var compFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l28.163"></a><span id="l28.163">                      .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l28.164"></a><span id="l28.164"> </span>
<a href="#l28.165"></a><span id="l28.165" class="difflineat">@@ -160,47 +147,39 @@ function sendMessageLater(aTestFileIndex</span>
<a href="#l28.166"></a><span id="l28.166">                   .createInstance(Ci.nsIMsgSend);</span>
<a href="#l28.167"></a><span id="l28.167"> </span>
<a href="#l28.168"></a><span id="l28.168">   msgSend.sendMessageFile(identity, &quot;&quot;, compFields, gMsgFile[aTestFileIndex],</span>
<a href="#l28.169"></a><span id="l28.169">                           false, false, Ci.nsIMsgSend.nsMsgQueueForLater,</span>
<a href="#l28.170"></a><span id="l28.170">                           null, copyListener, null, null);</span>
<a href="#l28.171"></a><span id="l28.171">   return false;</span>
<a href="#l28.172"></a><span id="l28.172"> }</span>
<a href="#l28.173"></a><span id="l28.173"> </span>
<a href="#l28.174"></a><span id="l28.174" class="difflineminus">-function resetCounts()</span>
<a href="#l28.175"></a><span id="l28.175" class="difflineminus">-{</span>
<a href="#l28.176"></a><span id="l28.176" class="difflineplus">+function resetCounts() {</span>
<a href="#l28.177"></a><span id="l28.177">   gMsgOrder = [];</span>
<a href="#l28.178"></a><span id="l28.178">   gLastSentMessage = 0;</span>
<a href="#l28.179"></a><span id="l28.179"> }</span>
<a href="#l28.180"></a><span id="l28.180"> </span>
<a href="#l28.181"></a><span id="l28.181"> // This function does the actual send later</span>
<a href="#l28.182"></a><span id="l28.182" class="difflineminus">-function sendUnsentMessages()</span>
<a href="#l28.183"></a><span id="l28.183" class="difflineminus">-{</span>
<a href="#l28.184"></a><span id="l28.184" class="difflineminus">-  gMessageSendStatus = 0;</span>
<a href="#l28.185"></a><span id="l28.185" class="difflineplus">+function sendUnsentMessages() {</span>
<a href="#l28.186"></a><span id="l28.186">   // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l28.187"></a><span id="l28.187">   // the server if something fails.</span>
<a href="#l28.188"></a><span id="l28.188">   try {</span>
<a href="#l28.189"></a><span id="l28.189">     // Start the fake SMTP server</span>
<a href="#l28.190"></a><span id="l28.190">     server.start();</span>
<a href="#l28.191"></a><span id="l28.191">     smtpServer.port = server.port;</span>
<a href="#l28.192"></a><span id="l28.192"> </span>
<a href="#l28.193"></a><span id="l28.193">     // Send the unsent message</span>
<a href="#l28.194"></a><span id="l28.194">     msgSendLater.sendUnsentMessages(identity);</span>
<a href="#l28.195"></a><span id="l28.195">     server.performTest();</span>
<a href="#l28.196"></a><span id="l28.196">   } catch (e) {</span>
<a href="#l28.197"></a><span id="l28.197">     do_throw(e);</span>
<a href="#l28.198"></a><span id="l28.198">   }</span>
<a href="#l28.199"></a><span id="l28.199">   return false;</span>
<a href="#l28.200"></a><span id="l28.200"> }</span>
<a href="#l28.201"></a><span id="l28.201"> </span>
<a href="#l28.202"></a><span id="l28.202" class="difflineminus">-function runServerTest()</span>
<a href="#l28.203"></a><span id="l28.203" class="difflineminus">-{</span>
<a href="#l28.204"></a><span id="l28.204" class="difflineminus">-  server.performTest();</span>
<a href="#l28.205"></a><span id="l28.205" class="difflineminus">-}</span>
<a href="#l28.206"></a><span id="l28.206" class="difflineminus">-</span>
<a href="#l28.207"></a><span id="l28.207"> function* actually_run_test() {</span>
<a href="#l28.208"></a><span id="l28.208">   dump(&quot;in actually_run_test\n&quot;);</span>
<a href="#l28.209"></a><span id="l28.209"> </span>
<a href="#l28.210"></a><span id="l28.210">   dump(&quot;Copy Message from file to folder\n&quot;);</span>
<a href="#l28.211"></a><span id="l28.211">   yield async_run({func: sendMessageLater, args: [0]});</span>
<a href="#l28.212"></a><span id="l28.212"> </span>
<a href="#l28.213"></a><span id="l28.213">   dump(&quot;Send unsent message\n&quot;);</span>
<a href="#l28.214"></a><span id="l28.214">   yield async_run({func: sendUnsentMessages});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMessageLater3.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMessageLater3.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -3,81 +3,76 @@</span>
<a href="#l29.4"></a><span id="l29.4">  * Protocol tests for SMTP.</span>
<a href="#l29.5"></a><span id="l29.5">  *</span>
<a href="#l29.6"></a><span id="l29.6">  * For trying to send a message later with no server connected, this test</span>
<a href="#l29.7"></a><span id="l29.7">  * verifies:</span>
<a href="#l29.8"></a><span id="l29.8">  *   - A correct status response.</span>
<a href="#l29.9"></a><span id="l29.9">  *   - A correct state at the end of attempting to send.</span>
<a href="#l29.10"></a><span id="l29.10">  */</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l29.13"></a><span id="l29.13"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l29.14"></a><span id="l29.14"> </span>
<a href="#l29.15"></a><span id="l29.15"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l29.16"></a><span id="l29.16"> </span>
<a href="#l29.17"></a><span id="l29.17" class="difflineminus">-var type = null;</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineminus">-var test = null;</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineminus">-var server;</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineminus">-var sentFolder;</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-var transaction;</span>
<a href="#l29.22"></a><span id="l29.22"> var originalData;</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineminus">-var finished = false;</span>
<a href="#l29.24"></a><span id="l29.24"> var identity = null;</span>
<a href="#l29.25"></a><span id="l29.25"> var testFile = do_get_file(&quot;data/429891_testcase.eml&quot;);</span>
<a href="#l29.26"></a><span id="l29.26"> </span>
<a href="#l29.27"></a><span id="l29.27"> var kSender = &quot;from@foo.invalid&quot;;</span>
<a href="#l29.28"></a><span id="l29.28"> var kTo = &quot;to@foo.invalid&quot;;</span>
<a href="#l29.29"></a><span id="l29.29"> </span>
<a href="#l29.30"></a><span id="l29.30"> var msgSendLater = Cc[&quot;@mozilla.org/messengercompose/sendlater;1&quot;]</span>
<a href="#l29.31"></a><span id="l29.31">   .getService(Ci.nsIMsgSendLater);</span>
<a href="#l29.32"></a><span id="l29.32"> </span>
<a href="#l29.33"></a><span id="l29.33" class="difflineplus">+/* exported alert */// for alertTestUtils.js</span>
<a href="#l29.34"></a><span id="l29.34"> function alert(aDialogTitle, aText) {</span>
<a href="#l29.35"></a><span id="l29.35">   dump(&quot;Hiding Alert {\n&quot; + aText + &quot;\n} End Alert\n&quot;);</span>
<a href="#l29.36"></a><span id="l29.36"> }</span>
<a href="#l29.37"></a><span id="l29.37"> </span>
<a href="#l29.38"></a><span id="l29.38"> // This listener handles the post-sending of the actual message and checks the</span>
<a href="#l29.39"></a><span id="l29.39"> // sequence and ensures the data is correct.</span>
<a href="#l29.40"></a><span id="l29.40"> function msll() {</span>
<a href="#l29.41"></a><span id="l29.41"> }</span>
<a href="#l29.42"></a><span id="l29.42"> </span>
<a href="#l29.43"></a><span id="l29.43"> msll.prototype = {</span>
<a href="#l29.44"></a><span id="l29.44">   _initialTotal: 0,</span>
<a href="#l29.45"></a><span id="l29.45">   _errorRaised: false,</span>
<a href="#l29.46"></a><span id="l29.46"> </span>
<a href="#l29.47"></a><span id="l29.47">   // nsIMsgSendLaterListener</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineminus">-  onStartSending: function (aTotal) {</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineplus">+  onStartSending(aTotal) {</span>
<a href="#l29.50"></a><span id="l29.50">     this._initialTotal = 1;</span>
<a href="#l29.51"></a><span id="l29.51">     Assert.equal(msgSendLater.sendingMessages, true);</span>
<a href="#l29.52"></a><span id="l29.52">   },</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineminus">-  onMessageStartSending: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineminus">-                                   aMessageHeader, aIdentity) {</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineplus">+  onMessageStartSending(aCurrentMessage, aTotalMessageCount, aMessageHeader, aIdentity) {</span>
<a href="#l29.56"></a><span id="l29.56">   },</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineminus">-  onMessageSendProgress: function (aCurrentMessage, aTotalMessageCount,</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineminus">-                                   aMessageSendPercent, aMessageCopyPercent) {</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineplus">+  onMessageSendProgress(aCurrentMessage, aTotalMessageCount,</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineplus">+                        aMessageSendPercent, aMessageCopyPercent) {</span>
<a href="#l29.61"></a><span id="l29.61">   },</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineminus">-  onMessageSendError: function (aCurrentMessage, aMessageHeader, aStatus,</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineminus">-                                aMsg) {</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineplus">+  onMessageSendError(aCurrentMessage, aMessageHeader, aStatus, aMsg) {</span>
<a href="#l29.65"></a><span id="l29.65">     this._errorRaised = true;</span>
<a href="#l29.66"></a><span id="l29.66">   },</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineminus">-  onStopSending: function (aStatus, aMsg, aTotal, aSuccessful) {</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineplus">+  onStopSending(aStatus, aMsg, aTotal, aSuccessful) {</span>
<a href="#l29.69"></a><span id="l29.69">     print(&quot;msll onStopSending\n&quot;);</span>
<a href="#l29.70"></a><span id="l29.70"> </span>
<a href="#l29.71"></a><span id="l29.71">     // NS_ERROR_SMTP_SEND_FAILED_REFUSED is 2153066798</span>
<a href="#l29.72"></a><span id="l29.72">     Assert.equal(aStatus, 2153066798);</span>
<a href="#l29.73"></a><span id="l29.73">     Assert.equal(aTotal, 1);</span>
<a href="#l29.74"></a><span id="l29.74">     Assert.equal(aSuccessful, 0);</span>
<a href="#l29.75"></a><span id="l29.75">     Assert.equal(this._initialTotal, 1);</span>
<a href="#l29.76"></a><span id="l29.76">     Assert.equal(this._errorRaised, true);</span>
<a href="#l29.77"></a><span id="l29.77">     Assert.equal(msgSendLater.sendingMessages, false);</span>
<a href="#l29.78"></a><span id="l29.78">     // Check that the send later service still thinks we have messages to send.</span>
<a href="#l29.79"></a><span id="l29.79">     Assert.equal(msgSendLater.hasUnsentMessages(identity), true);</span>
<a href="#l29.80"></a><span id="l29.80"> </span>
<a href="#l29.81"></a><span id="l29.81">     do_test_finished();</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineminus">-  }</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineplus">+  },</span>
<a href="#l29.84"></a><span id="l29.84"> };</span>
<a href="#l29.85"></a><span id="l29.85"> </span>
<a href="#l29.86"></a><span id="l29.86" class="difflineplus">+/* exported OnStopCopy */// for head_compose.js</span>
<a href="#l29.87"></a><span id="l29.87"> function OnStopCopy(aStatus) {</span>
<a href="#l29.88"></a><span id="l29.88">   Assert.equal(aStatus, 0);</span>
<a href="#l29.89"></a><span id="l29.89"> </span>
<a href="#l29.90"></a><span id="l29.90">   // Check this is false before we start sending</span>
<a href="#l29.91"></a><span id="l29.91">   Assert.equal(msgSendLater.sendingMessages, false);</span>
<a href="#l29.92"></a><span id="l29.92"> </span>
<a href="#l29.93"></a><span id="l29.93">   let folder = msgSendLater.getUnsentMessagesFolder(identity);</span>
<a href="#l29.94"></a><span id="l29.94"> </span>
<a href="#l29.95"></a><span id="l29.95" class="difflineat">@@ -100,18 +95,17 @@ function OnStopCopy(aStatus) {</span>
<a href="#l29.96"></a><span id="l29.96"> </span>
<a href="#l29.97"></a><span id="l29.97">   // Check the data is matching.</span>
<a href="#l29.98"></a><span id="l29.98">   Assert.equal(originalData, msgData);</span>
<a href="#l29.99"></a><span id="l29.99"> </span>
<a href="#l29.100"></a><span id="l29.100">   do_timeout(0, sendMessageLater);</span>
<a href="#l29.101"></a><span id="l29.101"> }</span>
<a href="#l29.102"></a><span id="l29.102"> </span>
<a href="#l29.103"></a><span id="l29.103"> // This function does the actual send later</span>
<a href="#l29.104"></a><span id="l29.104" class="difflineminus">-function sendMessageLater()</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineminus">-{</span>
<a href="#l29.106"></a><span id="l29.106" class="difflineplus">+function sendMessageLater() {</span>
<a href="#l29.107"></a><span id="l29.107">   // No server for this test, just attempt to send unsent and wait.</span>
<a href="#l29.108"></a><span id="l29.108">   var messageListener = new msll();</span>
<a href="#l29.109"></a><span id="l29.109"> </span>
<a href="#l29.110"></a><span id="l29.110">   msgSendLater.addListener(messageListener);</span>
<a href="#l29.111"></a><span id="l29.111"> </span>
<a href="#l29.112"></a><span id="l29.112">   // Send the unsent message</span>
<a href="#l29.113"></a><span id="l29.113">   msgSendLater.sendUnsentMessages(identity);</span>
<a href="#l29.114"></a><span id="l29.114"> }</span>
<a href="#l29.115"></a><span id="l29.115" class="difflineat">@@ -137,17 +131,17 @@ function run_test() {</span>
<a href="#l29.116"></a><span id="l29.116">   var smtpServer = getBasicSmtpServer();</span>
<a href="#l29.117"></a><span id="l29.117">   identity = getSmtpIdentity(kSender, smtpServer);</span>
<a href="#l29.118"></a><span id="l29.118"> </span>
<a href="#l29.119"></a><span id="l29.119">   account.addIdentity(identity);</span>
<a href="#l29.120"></a><span id="l29.120">   account.defaultIdentity = identity;</span>
<a href="#l29.121"></a><span id="l29.121">   account.incomingServer = incomingServer;</span>
<a href="#l29.122"></a><span id="l29.122">   MailServices.accounts.defaultAccount = account;</span>
<a href="#l29.123"></a><span id="l29.123"> </span>
<a href="#l29.124"></a><span id="l29.124" class="difflineminus">-  sentFolder = localAccountUtils.rootFolder.createLocalSubfolder(&quot;Sent&quot;);</span>
<a href="#l29.125"></a><span id="l29.125" class="difflineplus">+  localAccountUtils.rootFolder.createLocalSubfolder(&quot;Sent&quot;);</span>
<a href="#l29.126"></a><span id="l29.126"> </span>
<a href="#l29.127"></a><span id="l29.127">   identity.doFcc = false;</span>
<a href="#l29.128"></a><span id="l29.128"> </span>
<a href="#l29.129"></a><span id="l29.129">   // Now prepare to actually &quot;send&quot; the message later, i.e. dump it in the</span>
<a href="#l29.130"></a><span id="l29.130">   // unsent messages folder.</span>
<a href="#l29.131"></a><span id="l29.131"> </span>
<a href="#l29.132"></a><span id="l29.132">   var compFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l29.133"></a><span id="l29.133">                      .createInstance(Ci.nsIMsgCompFields);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendObserver.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendObserver.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -1,32 +1,30 @@</span>
<a href="#l30.4"></a><span id="l30.4"> /*</span>
<a href="#l30.5"></a><span id="l30.5">  * Tests that the mail-set-sender observer, used by extensions to modify the</span>
<a href="#l30.6"></a><span id="l30.6">  * outgoing server, works.</span>
<a href="#l30.7"></a><span id="l30.7">  *</span>
<a href="#l30.8"></a><span id="l30.8">  * This is adapted from test_messageHeaders.js</span>
<a href="#l30.9"></a><span id="l30.9">  */</span>
<a href="#l30.10"></a><span id="l30.10"> </span>
<a href="#l30.11"></a><span id="l30.11"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-var {MimeParser} = ChromeUtils.import(&quot;resource:///modules/mimeParser.jsm&quot;);</span>
<a href="#l30.14"></a><span id="l30.14"> </span>
<a href="#l30.15"></a><span id="l30.15"> var CompFields = CC(&quot;@mozilla.org/messengercompose/composefields;1&quot;,</span>
<a href="#l30.16"></a><span id="l30.16">                     Ci.nsIMsgCompFields);</span>
<a href="#l30.17"></a><span id="l30.17"> </span>
<a href="#l30.18"></a><span id="l30.18"> // nsIObserver implementation.</span>
<a href="#l30.19"></a><span id="l30.19"> var gData = &quot;&quot;;</span>
<a href="#l30.20"></a><span id="l30.20"> var observer = {</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineminus">-  observe: function (aSubject, aTopic, aData) {</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l30.23"></a><span id="l30.23">     if (aTopic == &quot;mail-set-sender&quot;) {</span>
<a href="#l30.24"></a><span id="l30.24">       Assert.ok(aSubject instanceof Ci.nsIMsgCompose);</span>
<a href="#l30.25"></a><span id="l30.25">       gData = aData;</span>
<a href="#l30.26"></a><span id="l30.26">     }</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineminus">-  }</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineminus">-}</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineplus">+  },</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+};</span>
<a href="#l30.31"></a><span id="l30.31"> </span>
<a href="#l30.32"></a><span id="l30.32"> add_task(async function testObserver() {</span>
<a href="#l30.33"></a><span id="l30.33">   let fields = new CompFields();</span>
<a href="#l30.34"></a><span id="l30.34">   let identity = getSmtpIdentity(&quot;from@tinderbox.invalid&quot;,</span>
<a href="#l30.35"></a><span id="l30.35">     getBasicSmtpServer());</span>
<a href="#l30.36"></a><span id="l30.36">   identity.fullName = &quot;Observer Tester&quot;;</span>
<a href="#l30.37"></a><span id="l30.37">   fields.to = &quot;Emile &lt;nobody@tinderbox.invalid&gt;&quot;;</span>
<a href="#l30.38"></a><span id="l30.38">   fields.cc = &quot;Alex &lt;alex@tinderbox.invalid&gt;&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtp8bitMime.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtp8bitMime.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -3,42 +3,39 @@</span>
<a href="#l31.4"></a><span id="l31.4">  * 8BITMIME tests for SMTP.</span>
<a href="#l31.5"></a><span id="l31.5">  *</span>
<a href="#l31.6"></a><span id="l31.6">  * This test verifies that 8BITMIME is sent to the server only if the server</span>
<a href="#l31.7"></a><span id="l31.7">  * advertises it AND if mail.strictly_mime doesn't force us to send 7bit.</span>
<a href="#l31.8"></a><span id="l31.8">  * It does not check the data of the message on either side of the link.</span>
<a href="#l31.9"></a><span id="l31.9">  */</span>
<a href="#l31.10"></a><span id="l31.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l31.11"></a><span id="l31.11"> </span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-var test = null;</span>
<a href="#l31.13"></a><span id="l31.13"> var server;</span>
<a href="#l31.14"></a><span id="l31.14"> </span>
<a href="#l31.15"></a><span id="l31.15"> var kIdentityMail = &quot;identity@foo.invalid&quot;;</span>
<a href="#l31.16"></a><span id="l31.16"> var kSender = &quot;from@foo.invalid&quot;;</span>
<a href="#l31.17"></a><span id="l31.17"> var kTo = &quot;to@foo.invalid&quot;;</span>
<a href="#l31.18"></a><span id="l31.18"> </span>
<a href="#l31.19"></a><span id="l31.19"> // aStrictMime: Test if mail.strictly_mime omits the BODY=8BITMIME attribute.</span>
<a href="#l31.20"></a><span id="l31.20"> // aServer8bit: Test if BODY=8BITMIME is only sent if advertised by the server.</span>
<a href="#l31.21"></a><span id="l31.21"> </span>
<a href="#l31.22"></a><span id="l31.22"> function test_8bitmime(aStrictMime, aServer8bit) {</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineminus">-</span>
<a href="#l31.24"></a><span id="l31.24">   // Test file</span>
<a href="#l31.25"></a><span id="l31.25">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l31.26"></a><span id="l31.26"> </span>
<a href="#l31.27"></a><span id="l31.27">   // Ensure we have at least one mail account</span>
<a href="#l31.28"></a><span id="l31.28">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l31.29"></a><span id="l31.29"> </span>
<a href="#l31.30"></a><span id="l31.30">   server.start();</span>
<a href="#l31.31"></a><span id="l31.31">   var smtpServer = getBasicSmtpServer(server.port);</span>
<a href="#l31.32"></a><span id="l31.32">   var identity = getSmtpIdentity(kIdentityMail, smtpServer);</span>
<a href="#l31.33"></a><span id="l31.33"> </span>
<a href="#l31.34"></a><span id="l31.34">   // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l31.35"></a><span id="l31.35">   // the server if something fails.</span>
<a href="#l31.36"></a><span id="l31.36">   try {</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineminus">-</span>
<a href="#l31.38"></a><span id="l31.38">     test = &quot;Strictly MIME&quot; + (aStrictMime ? &quot;on (7bit&quot; : &quot;off (8bit&quot;) +</span>
<a href="#l31.39"></a><span id="l31.39">              &quot;, 8BITMIME &quot; + (aServer8bit ? &quot;&quot; : &quot;not &quot;) + &quot;advertised)&quot;;</span>
<a href="#l31.40"></a><span id="l31.40"> </span>
<a href="#l31.41"></a><span id="l31.41">     Services.prefs.setBoolPref(&quot;mail.strictly_mime&quot;, aStrictMime);</span>
<a href="#l31.42"></a><span id="l31.42"> </span>
<a href="#l31.43"></a><span id="l31.43">     MailServices.smtp.sendMailMessage(testFile, kTo, identity, kSender,</span>
<a href="#l31.44"></a><span id="l31.44">                                       null, null, null, null,</span>
<a href="#l31.45"></a><span id="l31.45">                                       false, {}, {});</span>
<a href="#l31.46"></a><span id="l31.46" class="difflineat">@@ -49,18 +46,16 @@ function test_8bitmime(aStrictMime, aSer</span>
<a href="#l31.47"></a><span id="l31.47">     do_check_transaction(transaction, [&quot;EHLO test&quot;,</span>
<a href="#l31.48"></a><span id="l31.48">                                        &quot;MAIL FROM:&lt;&quot; + kSender +</span>
<a href="#l31.49"></a><span id="l31.49">                                          (!aStrictMime &amp;&amp; aServer8bit ?</span>
<a href="#l31.50"></a><span id="l31.50">                                            &quot;&gt; BODY=8BITMIME SIZE=159&quot; : &quot;&gt; SIZE=159&quot;),</span>
<a href="#l31.51"></a><span id="l31.51">                                        &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l31.52"></a><span id="l31.52">                                        &quot;DATA&quot;]);</span>
<a href="#l31.53"></a><span id="l31.53"> </span>
<a href="#l31.54"></a><span id="l31.54">     server.resetTest();</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineminus">-</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineminus">-</span>
<a href="#l31.57"></a><span id="l31.57">   } catch (e) {</span>
<a href="#l31.58"></a><span id="l31.58">     do_throw(e);</span>
<a href="#l31.59"></a><span id="l31.59">   } finally {</span>
<a href="#l31.60"></a><span id="l31.60">     server.stop();</span>
<a href="#l31.61"></a><span id="l31.61"> </span>
<a href="#l31.62"></a><span id="l31.62">     var thread = gThreadManager.currentThread;</span>
<a href="#l31.63"></a><span id="l31.63">     while (thread.hasPendingEvents())</span>
<a href="#l31.64"></a><span id="l31.64">       thread.processNextEvent(true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpAuthMethods.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpAuthMethods.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -18,53 +18,57 @@ var kPassword = &quot;wilma&quot;;</span>
<a href="#l32.4"></a><span id="l32.4"> var kIdentityMail = &quot;identity@foo.invalid&quot;;</span>
<a href="#l32.5"></a><span id="l32.5"> var kSender = &quot;from@foo.invalid&quot;;</span>
<a href="#l32.6"></a><span id="l32.6"> var kTo = &quot;to@foo.invalid&quot;;</span>
<a href="#l32.7"></a><span id="l32.7"> var MAILFROM = &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; BODY=8BITMIME SIZE=159&quot;;</span>
<a href="#l32.8"></a><span id="l32.8"> var RCPTTO = &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;;</span>
<a href="#l32.9"></a><span id="l32.9"> var AUTHPLAIN = &quot;AUTH PLAIN &quot; + AuthPLAIN.encodeLine(kUsername, kPassword);</span>
<a href="#l32.10"></a><span id="l32.10"> </span>
<a href="#l32.11"></a><span id="l32.11"> var tests = [</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-  { title: &quot;Cleartext password, with server supporting AUTH PLAIN, LOGIN, and CRAM&quot;,</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">-    serverAuthMethods : [ &quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineminus">-    expectSuccess : true,</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineminus">-    transaction: [ &quot;EHLO test&quot;, AUTHPLAIN, MAILFROM, RCPTTO, &quot;DATA&quot; ] },</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineminus">-  { title: &quot;Cleartext password, with server only supporting AUTH LOGIN&quot;,</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineminus">-    serverAuthMethods : [ &quot;LOGIN&quot; ],</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineminus">-    expectSuccess : true,</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineminus">-    transaction: [ &quot;EHLO test&quot;, &quot;AUTH LOGIN&quot;, MAILFROM, RCPTTO, &quot;DATA&quot; ] },</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineminus">-  { title: &quot;Encrypted password, with server supporting AUTH PLAIN, LOGIN and CRAM&quot;,</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineminus">-    serverAuthMethods : [ &quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineminus">-    expectSuccess : true,</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineminus">-    transaction: [ &quot;EHLO test&quot;, &quot;AUTH CRAM-MD5&quot;, MAILFROM, RCPTTO, &quot;DATA&quot; ] },</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineminus">-  { title: &quot;Encrypted password, with server only supporting AUTH PLAIN (must fail)&quot;,</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineminus">-    serverAuthMethods : [ &quot;PLAIN&quot; ],</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineminus">-    expectSuccess : false,</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-    transaction: [ &quot;EHLO test&quot;] },</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineminus">-  { title: &quot;Any secure method, with server supporting AUTH PLAIN, LOGIN and CRAM&quot;,</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.secure,</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineminus">-    serverAuthMethods : [ &quot;PLAIN&quot; , &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineminus">-    expectSuccess : true,</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineminus">-    transaction: [ &quot;EHLO test&quot;, &quot;AUTH CRAM-MD5&quot;, MAILFROM, RCPTTO, &quot;DATA&quot; ] },</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineminus">-  { title: &quot;Any secure method, with server only supporting AUTH PLAIN (must fail)&quot;,</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.secure,</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineminus">-    serverAuthMethods : [ &quot;PLAIN&quot; ],</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineminus">-    expectSuccess : false,</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineminus">-    transaction: [ &quot;EHLO test&quot; ] },</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineplus">+  {</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineplus">+    title: &quot;Cleartext password, with server supporting AUTH PLAIN, LOGIN, and CRAM&quot;,</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineplus">+    clientAuthMethod: Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineplus">+    serverAuthMethods: [ &quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineplus">+    expectSuccess: true,</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineplus">+    transaction: [ &quot;EHLO test&quot;, AUTHPLAIN, MAILFROM, RCPTTO, &quot;DATA&quot; ],</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineplus">+  }, {</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineplus">+    title: &quot;Cleartext password, with server only supporting AUTH LOGIN&quot;,</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+    clientAuthMethod: Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineplus">+    serverAuthMethods: [ &quot;LOGIN&quot; ],</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineplus">+    expectSuccess: true,</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineplus">+    transaction: [ &quot;EHLO test&quot;, &quot;AUTH LOGIN&quot;, MAILFROM, RCPTTO, &quot;DATA&quot; ],</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineplus">+  }, {</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineplus">+    title: &quot;Encrypted password, with server supporting AUTH PLAIN, LOGIN and CRAM&quot;,</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineplus">+    clientAuthMethod: Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineplus">+    serverAuthMethods: [ &quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineplus">+    expectSuccess: true,</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineplus">+    transaction: [ &quot;EHLO test&quot;, &quot;AUTH CRAM-MD5&quot;, MAILFROM, RCPTTO, &quot;DATA&quot; ],</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineplus">+  }, {</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineplus">+    title: &quot;Encrypted password, with server only supporting AUTH PLAIN (must fail)&quot;,</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineplus">+    clientAuthMethod: Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineplus">+    serverAuthMethods: [ &quot;PLAIN&quot; ],</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineplus">+    expectSuccess: false,</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineplus">+    transaction: [ &quot;EHLO test&quot;],</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineplus">+  }, {</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineplus">+    title: &quot;Any secure method, with server supporting AUTH PLAIN, LOGIN and CRAM&quot;,</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineplus">+    clientAuthMethod: Ci.nsMsgAuthMethod.secure,</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineplus">+    serverAuthMethods: [ &quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineplus">+    expectSuccess: true,</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineplus">+    transaction: [ &quot;EHLO test&quot;, &quot;AUTH CRAM-MD5&quot;, MAILFROM, RCPTTO, &quot;DATA&quot; ],</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineplus">+  }, {</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineplus">+    title: &quot;Any secure method, with server only supporting AUTH PLAIN (must fail)&quot;,</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineplus">+    clientAuthMethod: Ci.nsMsgAuthMethod.secure,</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineplus">+    serverAuthMethods: [ &quot;PLAIN&quot; ],</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineplus">+    expectSuccess: false,</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineplus">+    transaction: [ &quot;EHLO test&quot; ],</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineplus">+  },</span>
<a href="#l32.79"></a><span id="l32.79"> ];</span>
<a href="#l32.80"></a><span id="l32.80"> </span>
<a href="#l32.81"></a><span id="l32.81" class="difflineminus">-</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineminus">-</span>
<a href="#l32.83"></a><span id="l32.83"> function nextTest() {</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineminus">-  if (tests.length == 0)</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineminus">-  {</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineplus">+  if (tests.length == 0) {</span>
<a href="#l32.87"></a><span id="l32.87">     // this is sync, so we run into endTest() at the end of run_test() now</span>
<a href="#l32.88"></a><span id="l32.88">     return;</span>
<a href="#l32.89"></a><span id="l32.89">   }</span>
<a href="#l32.90"></a><span id="l32.90">   server.resetTest();</span>
<a href="#l32.91"></a><span id="l32.91"> </span>
<a href="#l32.92"></a><span id="l32.92">   var curTest = tests.shift();</span>
<a href="#l32.93"></a><span id="l32.93">   test = curTest.title;</span>
<a href="#l32.94"></a><span id="l32.94">   dump(&quot;NEXT test: &quot; + curTest.title + &quot;\n&quot;);</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineat">@@ -106,17 +110,16 @@ function run_test() {</span>
<a href="#l32.96"></a><span id="l32.96">     smtpServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l32.97"></a><span id="l32.97">     smtpServer.username = kUsername;</span>
<a href="#l32.98"></a><span id="l32.98">     smtpServer.password = kPassword;</span>
<a href="#l32.99"></a><span id="l32.99">     identity = getSmtpIdentity(kIdentityMail, smtpServer);</span>
<a href="#l32.100"></a><span id="l32.100"> </span>
<a href="#l32.101"></a><span id="l32.101">     testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l32.102"></a><span id="l32.102"> </span>
<a href="#l32.103"></a><span id="l32.103">     nextTest();</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineminus">-</span>
<a href="#l32.105"></a><span id="l32.105">   } catch (e) {</span>
<a href="#l32.106"></a><span id="l32.106">     do_throw(e);</span>
<a href="#l32.107"></a><span id="l32.107">   } finally {</span>
<a href="#l32.108"></a><span id="l32.108">     endTest();</span>
<a href="#l32.109"></a><span id="l32.109">   }</span>
<a href="#l32.110"></a><span id="l32.110"> }</span>
<a href="#l32.111"></a><span id="l32.111"> </span>
<a href="#l32.112"></a><span id="l32.112"> function endTest() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPassword.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPassword.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -1,41 +1,42 @@</span>
<a href="#l33.4"></a><span id="l33.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l33.5"></a><span id="l33.5"> /**</span>
<a href="#l33.6"></a><span id="l33.6">  * Authentication tests for SMTP.</span>
<a href="#l33.7"></a><span id="l33.7">  */</span>
<a href="#l33.8"></a><span id="l33.8"> </span>
<a href="#l33.9"></a><span id="l33.9"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l33.10"></a><span id="l33.10"> </span>
<a href="#l33.11"></a><span id="l33.11" class="difflineplus">+/* import-globals-from ../../../test/resources/passwordStorage.js */</span>
<a href="#l33.12"></a><span id="l33.12"> load(&quot;../../../resources/passwordStorage.js&quot;);</span>
<a href="#l33.13"></a><span id="l33.13"> </span>
<a href="#l33.14"></a><span id="l33.14"> var server;</span>
<a href="#l33.15"></a><span id="l33.15"> </span>
<a href="#l33.16"></a><span id="l33.16"> var kIdentityMail = &quot;identity@foo.invalid&quot;;</span>
<a href="#l33.17"></a><span id="l33.17"> var kSender = &quot;from@foo.invalid&quot;;</span>
<a href="#l33.18"></a><span id="l33.18"> var kTo = &quot;to@foo.invalid&quot;;</span>
<a href="#l33.19"></a><span id="l33.19"> var kUsername = &quot;testsmtp&quot;;</span>
<a href="#l33.20"></a><span id="l33.20"> // Password needs to match the login information stored in the signons json</span>
<a href="#l33.21"></a><span id="l33.21"> // file.</span>
<a href="#l33.22"></a><span id="l33.22"> var kPassword = &quot;smtptest&quot;;</span>
<a href="#l33.23"></a><span id="l33.23"> </span>
<a href="#l33.24"></a><span id="l33.24" class="difflineminus">-add_task(async function () {</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineplus">+add_task(async function() {</span>
<a href="#l33.26"></a><span id="l33.26">   function createHandler(d) {</span>
<a href="#l33.27"></a><span id="l33.27">     var handler = new SMTP_RFC2821_handler(d);</span>
<a href="#l33.28"></a><span id="l33.28">     // Username needs to match the login information stored in the signons json</span>
<a href="#l33.29"></a><span id="l33.29">     // file.</span>
<a href="#l33.30"></a><span id="l33.30">     handler.kUsername = kUsername;</span>
<a href="#l33.31"></a><span id="l33.31">     handler.kPassword = kPassword;</span>
<a href="#l33.32"></a><span id="l33.32">     handler.kAuthRequired = true;</span>
<a href="#l33.33"></a><span id="l33.33">     return handler;</span>
<a href="#l33.34"></a><span id="l33.34">   }</span>
<a href="#l33.35"></a><span id="l33.35">   server = setupServerDaemon(createHandler);</span>
<a href="#l33.36"></a><span id="l33.36"> </span>
<a href="#l33.37"></a><span id="l33.37">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineminus">-  await setupForPassword(&quot;signons-mailnews1.8.json&quot;)</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineplus">+  await setupForPassword(&quot;signons-mailnews1.8.json&quot;);</span>
<a href="#l33.40"></a><span id="l33.40"> </span>
<a href="#l33.41"></a><span id="l33.41">   // Test file</span>
<a href="#l33.42"></a><span id="l33.42">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l33.43"></a><span id="l33.43"> </span>
<a href="#l33.44"></a><span id="l33.44">   // Ensure we have at least one mail account</span>
<a href="#l33.45"></a><span id="l33.45">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l33.46"></a><span id="l33.46"> </span>
<a href="#l33.47"></a><span id="l33.47">   // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineat">@@ -60,23 +61,18 @@ add_task(async function () {</span>
<a href="#l33.49"></a><span id="l33.49">     server.performTest();</span>
<a href="#l33.50"></a><span id="l33.50"> </span>
<a href="#l33.51"></a><span id="l33.51">     var transaction = server.playTransaction();</span>
<a href="#l33.52"></a><span id="l33.52">     do_check_transaction(transaction, [&quot;EHLO test&quot;,</span>
<a href="#l33.53"></a><span id="l33.53">                                        &quot;AUTH PLAIN &quot; + AuthPLAIN.encodeLine(kUsername, kPassword),</span>
<a href="#l33.54"></a><span id="l33.54">                                        &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; BODY=8BITMIME SIZE=159&quot;,</span>
<a href="#l33.55"></a><span id="l33.55">                                        &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l33.56"></a><span id="l33.56">                                        &quot;DATA&quot;]);</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineminus">-</span>
<a href="#l33.58"></a><span id="l33.58">   } catch (e) {</span>
<a href="#l33.59"></a><span id="l33.59">     do_throw(e);</span>
<a href="#l33.60"></a><span id="l33.60">   } finally {</span>
<a href="#l33.61"></a><span id="l33.61">     server.stop();</span>
<a href="#l33.62"></a><span id="l33.62"> </span>
<a href="#l33.63"></a><span id="l33.63">     var thread = gThreadManager.currentThread;</span>
<a href="#l33.64"></a><span id="l33.64">     while (thread.hasPendingEvents())</span>
<a href="#l33.65"></a><span id="l33.65">       thread.processNextEvent(true);</span>
<a href="#l33.66"></a><span id="l33.66">   }</span>
<a href="#l33.67"></a><span id="l33.67"> });</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineminus">-</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineminus">-function run_test() {</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineminus">-  run_next_test();</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPassword2.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPassword2.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -1,39 +1,39 @@</span>
<a href="#l34.4"></a><span id="l34.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l34.5"></a><span id="l34.5"> /**</span>
<a href="#l34.6"></a><span id="l34.6">  * Extra tests for SMTP passwords (forgetPassword)</span>
<a href="#l34.7"></a><span id="l34.7">  */</span>
<a href="#l34.8"></a><span id="l34.8"> </span>
<a href="#l34.9"></a><span id="l34.9"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l34.10"></a><span id="l34.10"> </span>
<a href="#l34.11"></a><span id="l34.11" class="difflineplus">+/* import-globals-from ../../../test/resources/passwordStorage.js */</span>
<a href="#l34.12"></a><span id="l34.12"> load(&quot;../../../resources/passwordStorage.js&quot;);</span>
<a href="#l34.13"></a><span id="l34.13"> </span>
<a href="#l34.14"></a><span id="l34.14"> var kUser1 = &quot;testsmtp&quot;;</span>
<a href="#l34.15"></a><span id="l34.15"> var kUser2 = &quot;testsmtpa&quot;;</span>
<a href="#l34.16"></a><span id="l34.16"> var kProtocol = &quot;smtp&quot;;</span>
<a href="#l34.17"></a><span id="l34.17"> var kHostname = &quot;localhost&quot;;</span>
<a href="#l34.18"></a><span id="l34.18"> var kServerUrl = kProtocol + &quot;://&quot; + kHostname;</span>
<a href="#l34.19"></a><span id="l34.19"> </span>
<a href="#l34.20"></a><span id="l34.20" class="difflineminus">-add_task(async function () {</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineplus">+add_task(async function() {</span>
<a href="#l34.22"></a><span id="l34.22">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineminus">-  await setupForPassword(&quot;signons-mailnews1.8-multiple.json&quot;)</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineplus">+  await setupForPassword(&quot;signons-mailnews1.8-multiple.json&quot;);</span>
<a href="#l34.25"></a><span id="l34.25"> </span>
<a href="#l34.26"></a><span id="l34.26">   // Set up the basic accounts and folders.</span>
<a href="#l34.27"></a><span id="l34.27">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l34.28"></a><span id="l34.28"> </span>
<a href="#l34.29"></a><span id="l34.29">   var smtpServer1 = getBasicSmtpServer();</span>
<a href="#l34.30"></a><span id="l34.30">   var smtpServer2 = getBasicSmtpServer();</span>
<a href="#l34.31"></a><span id="l34.31"> </span>
<a href="#l34.32"></a><span id="l34.32">   smtpServer1.authMethod = 3;</span>
<a href="#l34.33"></a><span id="l34.33">   smtpServer1.username = kUser1;</span>
<a href="#l34.34"></a><span id="l34.34">   smtpServer2.authMethod = 3;</span>
<a href="#l34.35"></a><span id="l34.35">   smtpServer2.username = kUser2;</span>
<a href="#l34.36"></a><span id="l34.36"> </span>
<a href="#l34.37"></a><span id="l34.37" class="difflineminus">-  var i;</span>
<a href="#l34.38"></a><span id="l34.38">   var count = {};</span>
<a href="#l34.39"></a><span id="l34.39"> </span>
<a href="#l34.40"></a><span id="l34.40">   // Test - Check there are two logins to begin with.</span>
<a href="#l34.41"></a><span id="l34.41">   let logins = Services.logins.findLogins(count, kServerUrl, null, kServerUrl);</span>
<a href="#l34.42"></a><span id="l34.42"> </span>
<a href="#l34.43"></a><span id="l34.43">   Assert.equal(count.value, 2);</span>
<a href="#l34.44"></a><span id="l34.44"> </span>
<a href="#l34.45"></a><span id="l34.45">   // These will either be one way around or the other.</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineat">@@ -57,12 +57,8 @@ add_task(async function () {</span>
<a href="#l34.47"></a><span id="l34.47">   smtpServer2.forgetPassword();</span>
<a href="#l34.48"></a><span id="l34.48"> </span>
<a href="#l34.49"></a><span id="l34.49">   logins = Services.logins.findLogins(count, kServerUrl, null, kServerUrl);</span>
<a href="#l34.50"></a><span id="l34.50"> </span>
<a href="#l34.51"></a><span id="l34.51">   // There should be no login left.</span>
<a href="#l34.52"></a><span id="l34.52">   Assert.equal(count.value, 0);</span>
<a href="#l34.53"></a><span id="l34.53">   Assert.equal(logins.length, 0);</span>
<a href="#l34.54"></a><span id="l34.54"> });</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineminus">-</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineminus">-function run_test() {</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineminus">-  run_next_test();</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPasswordFailure1.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPasswordFailure1.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -7,35 +7,36 @@</span>
<a href="#l35.4"></a><span id="l35.4">  *   - Check cancel does what it should do.</span>
<a href="#l35.5"></a><span id="l35.5">  *</span>
<a href="#l35.6"></a><span id="l35.6">  * XXX Due to problems with the fakeserver + smtp not using one connection for</span>
<a href="#l35.7"></a><span id="l35.7">  * multiple sends, the rest of this test is in test_smtpPasswordFailure2.js.</span>
<a href="#l35.8"></a><span id="l35.8">  */</span>
<a href="#l35.9"></a><span id="l35.9"> </span>
<a href="#l35.10"></a><span id="l35.10"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l35.11"></a><span id="l35.11"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l35.13"></a><span id="l35.13"> </span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+/* import-globals-from ../../../test/resources/passwordStorage.js */</span>
<a href="#l35.16"></a><span id="l35.16"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l35.17"></a><span id="l35.17"> load(&quot;../../../resources/passwordStorage.js&quot;);</span>
<a href="#l35.18"></a><span id="l35.18"> </span>
<a href="#l35.19"></a><span id="l35.19"> var server;</span>
<a href="#l35.20"></a><span id="l35.20"> var attempt = 0;</span>
<a href="#l35.21"></a><span id="l35.21"> </span>
<a href="#l35.22"></a><span id="l35.22"> var kIdentityMail = &quot;identity@foo.invalid&quot;;</span>
<a href="#l35.23"></a><span id="l35.23"> var kSender = &quot;from@foo.invalid&quot;;</span>
<a href="#l35.24"></a><span id="l35.24"> var kTo = &quot;to@foo.invalid&quot;;</span>
<a href="#l35.25"></a><span id="l35.25"> var kUsername = &quot;testsmtp&quot;;</span>
<a href="#l35.26"></a><span id="l35.26"> // Login information needs to match the login information stored in the signons</span>
<a href="#l35.27"></a><span id="l35.27"> // json file.</span>
<a href="#l35.28"></a><span id="l35.28"> var kInvalidPassword = &quot;smtptest&quot;;</span>
<a href="#l35.29"></a><span id="l35.29"> var kValidPassword = &quot;smtptest1&quot;;</span>
<a href="#l35.30"></a><span id="l35.30"> </span>
<a href="#l35.31"></a><span id="l35.31" class="difflineminus">-function alert(aDialogText, aText)</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineminus">-{</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineplus">+/* exported alert, confirmEx */// for alertTestUtils.js</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+function alert(aDialogText, aText) {</span>
<a href="#l35.35"></a><span id="l35.35">   // The first few attempts may prompt about the password problem, the last</span>
<a href="#l35.36"></a><span id="l35.36">   // attempt shouldn't.</span>
<a href="#l35.37"></a><span id="l35.37">   Assert.ok(attempt &lt; 4);</span>
<a href="#l35.38"></a><span id="l35.38"> </span>
<a href="#l35.39"></a><span id="l35.39">   // Log the fact we've got an alert, but we don't need to test anything here.</span>
<a href="#l35.40"></a><span id="l35.40">   dump(&quot;Alert Title: &quot; + aDialogText + &quot;\nAlert Text: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l35.41"></a><span id="l35.41"> }</span>
<a href="#l35.42"></a><span id="l35.42"> </span>
<a href="#l35.43"></a><span id="l35.43" class="difflineat">@@ -51,30 +52,30 @@ function confirmEx(aDialogTitle, aText, </span>
<a href="#l35.44"></a><span id="l35.44">       dump(&quot;\nCancelling login attempt\n&quot;);</span>
<a href="#l35.45"></a><span id="l35.45">       return 1;</span>
<a href="#l35.46"></a><span id="l35.46">     default:</span>
<a href="#l35.47"></a><span id="l35.47">       do_throw(&quot;unexpected attempt number &quot; + attempt);</span>
<a href="#l35.48"></a><span id="l35.48">       return 1;</span>
<a href="#l35.49"></a><span id="l35.49">   }</span>
<a href="#l35.50"></a><span id="l35.50"> }</span>
<a href="#l35.51"></a><span id="l35.51"> </span>
<a href="#l35.52"></a><span id="l35.52" class="difflineminus">-add_task(async function () {</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineplus">+add_task(async function() {</span>
<a href="#l35.54"></a><span id="l35.54">   function createHandler(d) {</span>
<a href="#l35.55"></a><span id="l35.55">     var handler = new SMTP_RFC2821_handler(d);</span>
<a href="#l35.56"></a><span id="l35.56">     // Username needs to match the login information stored in the signons json</span>
<a href="#l35.57"></a><span id="l35.57">     // file.</span>
<a href="#l35.58"></a><span id="l35.58">     handler.kUsername = kUsername;</span>
<a href="#l35.59"></a><span id="l35.59">     handler.kPassword = kValidPassword;</span>
<a href="#l35.60"></a><span id="l35.60">     handler.kAuthRequired = true;</span>
<a href="#l35.61"></a><span id="l35.61">     return handler;</span>
<a href="#l35.62"></a><span id="l35.62">   }</span>
<a href="#l35.63"></a><span id="l35.63">   server = setupServerDaemon(createHandler);</span>
<a href="#l35.64"></a><span id="l35.64"> </span>
<a href="#l35.65"></a><span id="l35.65">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l35.66"></a><span id="l35.66" class="difflineminus">-  await setupForPassword(&quot;signons-mailnews1.8.json&quot;)</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineplus">+  await setupForPassword(&quot;signons-mailnews1.8.json&quot;);</span>
<a href="#l35.68"></a><span id="l35.68"> </span>
<a href="#l35.69"></a><span id="l35.69">   registerAlertTestUtils();</span>
<a href="#l35.70"></a><span id="l35.70"> </span>
<a href="#l35.71"></a><span id="l35.71">   // Test file</span>
<a href="#l35.72"></a><span id="l35.72">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l35.73"></a><span id="l35.73"> </span>
<a href="#l35.74"></a><span id="l35.74">   // Ensure we have at least one mail account</span>
<a href="#l35.75"></a><span id="l35.75">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l35.76"></a><span id="l35.76" class="difflineat">@@ -120,12 +121,8 @@ add_task(async function () {</span>
<a href="#l35.77"></a><span id="l35.77">   } finally {</span>
<a href="#l35.78"></a><span id="l35.78">     server.stop();</span>
<a href="#l35.79"></a><span id="l35.79"> </span>
<a href="#l35.80"></a><span id="l35.80">     var thread = gThreadManager.currentThread;</span>
<a href="#l35.81"></a><span id="l35.81">     while (thread.hasPendingEvents())</span>
<a href="#l35.82"></a><span id="l35.82">       thread.processNextEvent(true);</span>
<a href="#l35.83"></a><span id="l35.83">   }</span>
<a href="#l35.84"></a><span id="l35.84"> });</span>
<a href="#l35.85"></a><span id="l35.85" class="difflineminus">-</span>
<a href="#l35.86"></a><span id="l35.86" class="difflineminus">-function run_test() {</span>
<a href="#l35.87"></a><span id="l35.87" class="difflineminus">-  run_next_test();</span>
<a href="#l35.88"></a><span id="l35.88" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPasswordFailure2.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPasswordFailure2.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -7,35 +7,36 @@</span>
<a href="#l36.4"></a><span id="l36.4">  *</span>
<a href="#l36.5"></a><span id="l36.5">  * XXX Due to problems with the fakeserver + smtp not using one connection for</span>
<a href="#l36.6"></a><span id="l36.6">  * multiple sends, the first part of this test is in</span>
<a href="#l36.7"></a><span id="l36.7">  * test_smtpPasswordFailure2.js.</span>
<a href="#l36.8"></a><span id="l36.8">  */</span>
<a href="#l36.9"></a><span id="l36.9"> </span>
<a href="#l36.10"></a><span id="l36.10"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l36.11"></a><span id="l36.11"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l36.13"></a><span id="l36.13"> </span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+/* import-globals-from ../../../test/resources/passwordStorage.js */</span>
<a href="#l36.16"></a><span id="l36.16"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l36.17"></a><span id="l36.17"> load(&quot;../../../resources/passwordStorage.js&quot;);</span>
<a href="#l36.18"></a><span id="l36.18"> </span>
<a href="#l36.19"></a><span id="l36.19"> var server;</span>
<a href="#l36.20"></a><span id="l36.20"> var attempt = 0;</span>
<a href="#l36.21"></a><span id="l36.21"> </span>
<a href="#l36.22"></a><span id="l36.22"> var kIdentityMail = &quot;identity@foo.invalid&quot;;</span>
<a href="#l36.23"></a><span id="l36.23"> var kSender = &quot;from@foo.invalid&quot;;</span>
<a href="#l36.24"></a><span id="l36.24"> var kTo = &quot;to@foo.invalid&quot;;</span>
<a href="#l36.25"></a><span id="l36.25"> var kUsername = &quot;testsmtp&quot;;</span>
<a href="#l36.26"></a><span id="l36.26"> // Password needs to match the login information stored in the signons json</span>
<a href="#l36.27"></a><span id="l36.27"> // file.</span>
<a href="#l36.28"></a><span id="l36.28"> var kInvalidPassword = &quot;smtptest&quot;;</span>
<a href="#l36.29"></a><span id="l36.29"> var kValidPassword = &quot;smtptest1&quot;;</span>
<a href="#l36.30"></a><span id="l36.30"> </span>
<a href="#l36.31"></a><span id="l36.31" class="difflineminus">-function alert(aDialogText, aText)</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineminus">-{</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineplus">+/* exported alert, confirmEx, promptPasswordPS */// for alertTestUtils.js</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineplus">+function alert(aDialogText, aText) {</span>
<a href="#l36.35"></a><span id="l36.35">   // The first few attempts may prompt about the password problem, the last</span>
<a href="#l36.36"></a><span id="l36.36">   // attempt shouldn't.</span>
<a href="#l36.37"></a><span id="l36.37">   Assert.ok(attempt &lt; 4);</span>
<a href="#l36.38"></a><span id="l36.38"> </span>
<a href="#l36.39"></a><span id="l36.39">   // Log the fact we've got an alert, but we don't need to test anything here.</span>
<a href="#l36.40"></a><span id="l36.40">   dump(&quot;Alert Title: &quot; + aDialogText + &quot;\nAlert Text: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l36.41"></a><span id="l36.41"> }</span>
<a href="#l36.42"></a><span id="l36.42"> </span>
<a href="#l36.43"></a><span id="l36.43" class="difflineat">@@ -61,31 +62,31 @@ function promptPasswordPS(aParent, aDial</span>
<a href="#l36.44"></a><span id="l36.44">   if (attempt == 2) {</span>
<a href="#l36.45"></a><span id="l36.45">     aPassword.value = kValidPassword;</span>
<a href="#l36.46"></a><span id="l36.46">     aCheckState.value = true;</span>
<a href="#l36.47"></a><span id="l36.47">     return true;</span>
<a href="#l36.48"></a><span id="l36.48">   }</span>
<a href="#l36.49"></a><span id="l36.49">   return false;</span>
<a href="#l36.50"></a><span id="l36.50"> }</span>
<a href="#l36.51"></a><span id="l36.51"> </span>
<a href="#l36.52"></a><span id="l36.52" class="difflineminus">-add_task(async function () {</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineplus">+add_task(async function() {</span>
<a href="#l36.54"></a><span id="l36.54">   function createHandler(d) {</span>
<a href="#l36.55"></a><span id="l36.55">     var handler = new SMTP_RFC2821_handler(d);</span>
<a href="#l36.56"></a><span id="l36.56">     // Username needs to match the login information stored in the signons json</span>
<a href="#l36.57"></a><span id="l36.57">     // file.</span>
<a href="#l36.58"></a><span id="l36.58">     handler.kUsername = kUsername;</span>
<a href="#l36.59"></a><span id="l36.59">     handler.kPassword = kValidPassword;</span>
<a href="#l36.60"></a><span id="l36.60">     handler.kAuthRequired = true;</span>
<a href="#l36.61"></a><span id="l36.61">     handler.kAuthSchemes = [ &quot;PLAIN&quot;, &quot;LOGIN&quot; ]; // make match expected transaction below</span>
<a href="#l36.62"></a><span id="l36.62">     return handler;</span>
<a href="#l36.63"></a><span id="l36.63">   }</span>
<a href="#l36.64"></a><span id="l36.64">   server = setupServerDaemon(createHandler);</span>
<a href="#l36.65"></a><span id="l36.65"> </span>
<a href="#l36.66"></a><span id="l36.66">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l36.67"></a><span id="l36.67" class="difflineminus">-  await setupForPassword(&quot;signons-mailnews1.8.json&quot;)</span>
<a href="#l36.68"></a><span id="l36.68" class="difflineplus">+  await setupForPassword(&quot;signons-mailnews1.8.json&quot;);</span>
<a href="#l36.69"></a><span id="l36.69"> </span>
<a href="#l36.70"></a><span id="l36.70">   registerAlertTestUtils();</span>
<a href="#l36.71"></a><span id="l36.71"> </span>
<a href="#l36.72"></a><span id="l36.72">   // Test file</span>
<a href="#l36.73"></a><span id="l36.73">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l36.74"></a><span id="l36.74"> </span>
<a href="#l36.75"></a><span id="l36.75">   // Ensure we have at least one mail account</span>
<a href="#l36.76"></a><span id="l36.76">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l36.77"></a><span id="l36.77" class="difflineat">@@ -137,23 +138,18 @@ add_task(async function () {</span>
<a href="#l36.78"></a><span id="l36.78">       let logins = Services.logins</span>
<a href="#l36.79"></a><span id="l36.79">                            .findLogins(count, &quot;smtp://localhost&quot;, null,</span>
<a href="#l36.80"></a><span id="l36.80">                                        &quot;smtp://localhost&quot;);</span>
<a href="#l36.81"></a><span id="l36.81"> </span>
<a href="#l36.82"></a><span id="l36.82">     Assert.equal(count.value, 1);</span>
<a href="#l36.83"></a><span id="l36.83">     Assert.equal(logins[0].username, kUsername);</span>
<a href="#l36.84"></a><span id="l36.84">     Assert.equal(logins[0].password, kValidPassword);</span>
<a href="#l36.85"></a><span id="l36.85">     do_test_finished();</span>
<a href="#l36.86"></a><span id="l36.86" class="difflineminus">-</span>
<a href="#l36.87"></a><span id="l36.87">   } catch (e) {</span>
<a href="#l36.88"></a><span id="l36.88">     do_throw(e);</span>
<a href="#l36.89"></a><span id="l36.89">   } finally {</span>
<a href="#l36.90"></a><span id="l36.90">     server.stop();</span>
<a href="#l36.91"></a><span id="l36.91"> </span>
<a href="#l36.92"></a><span id="l36.92">     var thread = gThreadManager.currentThread;</span>
<a href="#l36.93"></a><span id="l36.93">     while (thread.hasPendingEvents())</span>
<a href="#l36.94"></a><span id="l36.94">       thread.processNextEvent(true);</span>
<a href="#l36.95"></a><span id="l36.95">   }</span>
<a href="#l36.96"></a><span id="l36.96"> });</span>
<a href="#l36.97"></a><span id="l36.97" class="difflineminus">-</span>
<a href="#l36.98"></a><span id="l36.98" class="difflineminus">-function run_test() {</span>
<a href="#l36.99"></a><span id="l36.99" class="difflineminus">-  run_next_test();</span>
<a href="#l36.100"></a><span id="l36.100" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPasswordFailure3.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPasswordFailure3.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -5,35 +5,35 @@</span>
<a href="#l37.4"></a><span id="l37.4">  *   - Have an invalid password in the password database.</span>
<a href="#l37.5"></a><span id="l37.5">  *   - Re-initiate connection, this time select enter new password, check that</span>
<a href="#l37.6"></a><span id="l37.6">  *     we get a new password prompt and can enter the password.</span>
<a href="#l37.7"></a><span id="l37.7">  *</span>
<a href="#l37.8"></a><span id="l37.8">  */</span>
<a href="#l37.9"></a><span id="l37.9"> </span>
<a href="#l37.10"></a><span id="l37.10"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l37.11"></a><span id="l37.11"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l37.13"></a><span id="l37.13"> </span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+/* import-globals-from ../../../test/resources/passwordStorage.js */</span>
<a href="#l37.16"></a><span id="l37.16"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l37.17"></a><span id="l37.17"> load(&quot;../../../resources/passwordStorage.js&quot;);</span>
<a href="#l37.18"></a><span id="l37.18"> </span>
<a href="#l37.19"></a><span id="l37.19"> var server;</span>
<a href="#l37.20"></a><span id="l37.20"> var attempt = 0;</span>
<a href="#l37.21"></a><span id="l37.21"> </span>
<a href="#l37.22"></a><span id="l37.22"> var kIdentityMail = &quot;identity@foo.invalid&quot;;</span>
<a href="#l37.23"></a><span id="l37.23"> var kSender = &quot;from@foo.invalid&quot;;</span>
<a href="#l37.24"></a><span id="l37.24"> var kTo = &quot;to@foo.invalid&quot;;</span>
<a href="#l37.25"></a><span id="l37.25"> var kUsername = &quot;testsmtp&quot;;</span>
<a href="#l37.26"></a><span id="l37.26"> // Password needs to match the login information stored in the signons json</span>
<a href="#l37.27"></a><span id="l37.27"> // file.</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineminus">-var kInvalidPassword = &quot;smtptest&quot;;</span>
<a href="#l37.29"></a><span id="l37.29"> var kValidPassword = &quot;smtptest1&quot;;</span>
<a href="#l37.30"></a><span id="l37.30"> </span>
<a href="#l37.31"></a><span id="l37.31" class="difflineminus">-function alert(aDialogText, aText)</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineminus">-{</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineplus">+/* exported alert, confirmEx, promptPasswordPS */// for alertTestUtils.js</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineplus">+function alert(aDialogText, aText) {</span>
<a href="#l37.35"></a><span id="l37.35">   // The first few attempts may prompt about the password problem, the last</span>
<a href="#l37.36"></a><span id="l37.36">   // attempt shouldn't.</span>
<a href="#l37.37"></a><span id="l37.37">   Assert.ok(attempt &lt; 4);</span>
<a href="#l37.38"></a><span id="l37.38"> </span>
<a href="#l37.39"></a><span id="l37.39">   // Log the fact we've got an alert, but we don't need to test anything here.</span>
<a href="#l37.40"></a><span id="l37.40">   dump(&quot;Alert Title: &quot; + aDialogText + &quot;\nAlert Text: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l37.41"></a><span id="l37.41"> }</span>
<a href="#l37.42"></a><span id="l37.42"> </span>
<a href="#l37.43"></a><span id="l37.43" class="difflineat">@@ -59,32 +59,32 @@ function promptPasswordPS(aParent, aDial</span>
<a href="#l37.44"></a><span id="l37.44">   if (attempt == 2) {</span>
<a href="#l37.45"></a><span id="l37.45">     aPassword.value = kValidPassword;</span>
<a href="#l37.46"></a><span id="l37.46">     aCheckState.value = true;</span>
<a href="#l37.47"></a><span id="l37.47">     return true;</span>
<a href="#l37.48"></a><span id="l37.48">   }</span>
<a href="#l37.49"></a><span id="l37.49">   return false;</span>
<a href="#l37.50"></a><span id="l37.50"> }</span>
<a href="#l37.51"></a><span id="l37.51"> </span>
<a href="#l37.52"></a><span id="l37.52" class="difflineminus">-add_task(async function () {</span>
<a href="#l37.53"></a><span id="l37.53" class="difflineplus">+add_task(async function() {</span>
<a href="#l37.54"></a><span id="l37.54">   function createHandler(d) {</span>
<a href="#l37.55"></a><span id="l37.55">     var handler = new SMTP_RFC2821_handler(d);</span>
<a href="#l37.56"></a><span id="l37.56">     handler.dropOnAuthFailure = true;</span>
<a href="#l37.57"></a><span id="l37.57">     // Username needs to match the login information stored in the signons json</span>
<a href="#l37.58"></a><span id="l37.58">     // file.</span>
<a href="#l37.59"></a><span id="l37.59">     handler.kUsername = kUsername;</span>
<a href="#l37.60"></a><span id="l37.60">     handler.kPassword = kValidPassword;</span>
<a href="#l37.61"></a><span id="l37.61">     handler.kAuthRequired = true;</span>
<a href="#l37.62"></a><span id="l37.62">     handler.kAuthSchemes = [ &quot;PLAIN&quot;, &quot;LOGIN&quot; ]; // make match expected transaction below</span>
<a href="#l37.63"></a><span id="l37.63">     return handler;</span>
<a href="#l37.64"></a><span id="l37.64">   }</span>
<a href="#l37.65"></a><span id="l37.65">   server = setupServerDaemon(createHandler);</span>
<a href="#l37.66"></a><span id="l37.66"> </span>
<a href="#l37.67"></a><span id="l37.67">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l37.68"></a><span id="l37.68" class="difflineminus">-  await setupForPassword(&quot;signons-mailnews1.8.json&quot;)</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineplus">+  await setupForPassword(&quot;signons-mailnews1.8.json&quot;);</span>
<a href="#l37.70"></a><span id="l37.70"> </span>
<a href="#l37.71"></a><span id="l37.71">   registerAlertTestUtils();</span>
<a href="#l37.72"></a><span id="l37.72"> </span>
<a href="#l37.73"></a><span id="l37.73">   // Test file</span>
<a href="#l37.74"></a><span id="l37.74">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l37.75"></a><span id="l37.75"> </span>
<a href="#l37.76"></a><span id="l37.76">   // Ensure we have at least one mail account</span>
<a href="#l37.77"></a><span id="l37.77">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l37.78"></a><span id="l37.78" class="difflineat">@@ -106,19 +106,18 @@ add_task(async function () {</span>
<a href="#l37.79"></a><span id="l37.79">   MailServices.smtp.sendMailMessage(testFile, kTo, identity, kSender,</span>
<a href="#l37.80"></a><span id="l37.80">                                     null, URLListener, null, null,</span>
<a href="#l37.81"></a><span id="l37.81">                                     false, {}, {});</span>
<a href="#l37.82"></a><span id="l37.82"> </span>
<a href="#l37.83"></a><span id="l37.83">   server.performTest();</span>
<a href="#l37.84"></a><span id="l37.84"> });</span>
<a href="#l37.85"></a><span id="l37.85"> </span>
<a href="#l37.86"></a><span id="l37.86"> var URLListener = {</span>
<a href="#l37.87"></a><span id="l37.87" class="difflineminus">-  OnStartRunningUrl: function(url) { },</span>
<a href="#l37.88"></a><span id="l37.88" class="difflineminus">-  OnStopRunningUrl: function(url, rc)</span>
<a href="#l37.89"></a><span id="l37.89" class="difflineminus">-  {</span>
<a href="#l37.90"></a><span id="l37.90" class="difflineplus">+  OnStartRunningUrl(url) {},</span>
<a href="#l37.91"></a><span id="l37.91" class="difflineplus">+  OnStopRunningUrl(url, rc) {</span>
<a href="#l37.92"></a><span id="l37.92">     // Check for ok status.</span>
<a href="#l37.93"></a><span id="l37.93">     Assert.equal(rc, 0);</span>
<a href="#l37.94"></a><span id="l37.94">     // Now check the new password has been saved.</span>
<a href="#l37.95"></a><span id="l37.95">     let count = {};</span>
<a href="#l37.96"></a><span id="l37.96">     let logins = Services.logins</span>
<a href="#l37.97"></a><span id="l37.97">                          .findLogins(count, &quot;smtp://localhost&quot;, null,</span>
<a href="#l37.98"></a><span id="l37.98">                                      &quot;smtp://localhost&quot;);</span>
<a href="#l37.99"></a><span id="l37.99"> </span>
<a href="#l37.100"></a><span id="l37.100" class="difflineat">@@ -128,15 +127,10 @@ var URLListener = {</span>
<a href="#l37.101"></a><span id="l37.101"> </span>
<a href="#l37.102"></a><span id="l37.102">     server.stop();</span>
<a href="#l37.103"></a><span id="l37.103"> </span>
<a href="#l37.104"></a><span id="l37.104">     var thread = gThreadManager.currentThread;</span>
<a href="#l37.105"></a><span id="l37.105">     while (thread.hasPendingEvents())</span>
<a href="#l37.106"></a><span id="l37.106">       thread.processNextEvent(true);</span>
<a href="#l37.107"></a><span id="l37.107"> </span>
<a href="#l37.108"></a><span id="l37.108">     do_test_finished();</span>
<a href="#l37.109"></a><span id="l37.109" class="difflineminus">-</span>
<a href="#l37.110"></a><span id="l37.110" class="difflineminus">-  }</span>
<a href="#l37.111"></a><span id="l37.111" class="difflineplus">+  },</span>
<a href="#l37.112"></a><span id="l37.112"> };</span>
<a href="#l37.113"></a><span id="l37.113" class="difflineminus">-</span>
<a href="#l37.114"></a><span id="l37.114" class="difflineminus">-function run_test() {</span>
<a href="#l37.115"></a><span id="l37.115" class="difflineminus">-  run_next_test();</span>
<a href="#l37.116"></a><span id="l37.116" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpProtocols.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpProtocols.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -5,25 +5,24 @@</span>
<a href="#l38.4"></a><span id="l38.4"> </span>
<a href="#l38.5"></a><span id="l38.5"> var defaultProtocolFlags =</span>
<a href="#l38.6"></a><span id="l38.6">   Ci.nsIProtocolHandler.URI_NORELATIVE |</span>
<a href="#l38.7"></a><span id="l38.7">   Ci.nsIProtocolHandler.URI_DANGEROUS_TO_LOAD |</span>
<a href="#l38.8"></a><span id="l38.8">   Ci.nsIProtocolHandler.URI_NON_PERSISTABLE |</span>
<a href="#l38.9"></a><span id="l38.9">   Ci.nsIProtocolHandler.ALLOWS_PROXY |</span>
<a href="#l38.10"></a><span id="l38.10">   Ci.nsIProtocolHandler.URI_FORBIDS_AUTOMATIC_DOCUMENT_REPLACEMENT;</span>
<a href="#l38.11"></a><span id="l38.11"> </span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-var protocols =</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineminus">-  [ { protocol: &quot;smtp&quot;,</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineminus">-      urlSpec: &quot;smtp://user@localhost/&quot;,</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineminus">-      defaultPort: Ci.nsISmtpUrl.DEFAULT_SMTP_PORT</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineminus">-    },</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineminus">-    { protocol: &quot;smtps&quot;,</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineminus">-      urlSpec: &quot;smtps://user@localhost/&quot;,</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineminus">-      defaultPort: Ci.nsISmtpUrl.DEFAULT_SMTPS_PORT</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineminus">-    } ];</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineplus">+var protocols = [{</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineplus">+  protocol: &quot;smtp&quot;, urlSpec: &quot;smtp://user@localhost/&quot;,</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineplus">+  defaultPort: Ci.nsISmtpUrl.DEFAULT_SMTP_PORT,</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineplus">+}, {</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineplus">+  protocol: &quot;smtps&quot;,</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineplus">+  urlSpec: &quot;smtps://user@localhost/&quot;,</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineplus">+  defaultPort: Ci.nsISmtpUrl.DEFAULT_SMTPS_PORT,</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineplus">+}];</span>
<a href="#l38.29"></a><span id="l38.29"> </span>
<a href="#l38.30"></a><span id="l38.30"> function run_test() {</span>
<a href="#l38.31"></a><span id="l38.31">   for (var part = 0; part &lt; protocols.length; ++part) {</span>
<a href="#l38.32"></a><span id="l38.32">     print(&quot;protocol: &quot; + protocols[part].protocol);</span>
<a href="#l38.33"></a><span id="l38.33"> </span>
<a href="#l38.34"></a><span id="l38.34">     var pH = Cc[&quot;@mozilla.org/network/protocol;1?name=&quot; +</span>
<a href="#l38.35"></a><span id="l38.35">                 protocols[part].protocol]</span>
<a href="#l38.36"></a><span id="l38.36">                .createInstance(Ci.nsIProtocolHandler);</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineat">@@ -44,14 +43,13 @@ function run_test() {</span>
<a href="#l38.38"></a><span id="l38.38">     Assert.equal(uri.spec, protocols[part].urlSpec);</span>
<a href="#l38.39"></a><span id="l38.39"> </span>
<a href="#l38.40"></a><span id="l38.40">     try {</span>
<a href="#l38.41"></a><span id="l38.41">       // This call should throw NS_ERROR_NOT_IMPLEMENTED. If it doesn't,</span>
<a href="#l38.42"></a><span id="l38.42">       // then we should implement a new test for it.</span>
<a href="#l38.43"></a><span id="l38.43">       pH.newChannel(uri, null);</span>
<a href="#l38.44"></a><span id="l38.44">       // If it didn't throw, then shout about it.</span>
<a href="#l38.45"></a><span id="l38.45">       do_throw(&quot;newChannel not throwing NS_ERROR_NOT_IMPLEMENTED.&quot;);</span>
<a href="#l38.46"></a><span id="l38.46" class="difflineminus">-    }</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineminus">-    catch (ex) {</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineplus">+    } catch (ex) {</span>
<a href="#l38.49"></a><span id="l38.49">       Assert.equal(ex.result, Cr.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l38.50"></a><span id="l38.50">     }</span>
<a href="#l38.51"></a><span id="l38.51">   }</span>
<a href="#l38.52"></a><span id="l38.52"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpProxy.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpProxy.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -11,19 +11,16 @@ var daemon, localserver, server;</span>
<a href="#l39.4"></a><span id="l39.4"> add_task(async function setup() {</span>
<a href="#l39.5"></a><span id="l39.5">   server = setupServerDaemon();</span>
<a href="#l39.6"></a><span id="l39.6">   daemon = server._daemon;</span>
<a href="#l39.7"></a><span id="l39.7">   server.start();</span>
<a href="#l39.8"></a><span id="l39.8">   NetworkTestUtils.configureProxy(&quot;smtp.tinderbox.invalid&quot;, PORT, server.port);</span>
<a href="#l39.9"></a><span id="l39.9">   localserver = getBasicSmtpServer(PORT, &quot;smtp.tinderbox.invalid&quot;);</span>
<a href="#l39.10"></a><span id="l39.10"> });</span>
<a href="#l39.11"></a><span id="l39.11"> </span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-let CompFields = CC(&quot;@mozilla.org/messengercompose/composefields;1&quot;,</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-                    Ci.nsIMsgCompFields);</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineminus">-</span>
<a href="#l39.15"></a><span id="l39.15"> add_task(async function sendMessage() {</span>
<a href="#l39.16"></a><span id="l39.16">   equal(daemon.post, undefined);</span>
<a href="#l39.17"></a><span id="l39.17">   let identity = getSmtpIdentity(&quot;test@tinderbox.invalid&quot;, localserver);</span>
<a href="#l39.18"></a><span id="l39.18">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l39.19"></a><span id="l39.19">   var urlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l39.20"></a><span id="l39.20">   MailServices.smtp.sendMailMessage(testFile, &quot;somebody@example.org&quot;, identity,</span>
<a href="#l39.21"></a><span id="l39.21">                                     &quot;me@example.org&quot;,</span>
<a href="#l39.22"></a><span id="l39.22">                                     null, urlListener, null, null,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpURL.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpURL.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -1,23 +1,23 @@</span>
<a href="#l40.4"></a><span id="l40.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l40.5"></a><span id="l40.5"> /*</span>
<a href="#l40.6"></a><span id="l40.6">  * Test suite for checking SMTP URLs are working as expected.</span>
<a href="#l40.7"></a><span id="l40.7">  * XXX this test needs extending as we fix up nsSmtpUrl.</span>
<a href="#l40.8"></a><span id="l40.8">  */</span>
<a href="#l40.9"></a><span id="l40.9"> </span>
<a href="#l40.10"></a><span id="l40.10" class="difflineminus">-var smtpURLs =</span>
<a href="#l40.11"></a><span id="l40.11" class="difflineminus">-  [ { url: &quot;smtp://user@localhost/&quot;,</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-      spec: &quot;smtp://user@localhost/&quot;,</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-      username: &quot;user&quot;</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineminus">-    },</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineminus">-    { url: &quot;smtps://user@localhost/&quot;,</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineminus">-      spec: &quot;smtps://user@localhost/&quot;,</span>
<a href="#l40.17"></a><span id="l40.17" class="difflineminus">-      username: &quot;user&quot;</span>
<a href="#l40.18"></a><span id="l40.18" class="difflineminus">-    } ];</span>
<a href="#l40.19"></a><span id="l40.19" class="difflineplus">+var smtpURLs = [{</span>
<a href="#l40.20"></a><span id="l40.20" class="difflineplus">+  url: &quot;smtp://user@localhost/&quot;,</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineplus">+  spec: &quot;smtp://user@localhost/&quot;,</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineplus">+  username: &quot;user&quot;,</span>
<a href="#l40.23"></a><span id="l40.23" class="difflineplus">+}, {</span>
<a href="#l40.24"></a><span id="l40.24" class="difflineplus">+  url: &quot;smtps://user@localhost/&quot;,</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineplus">+  spec: &quot;smtps://user@localhost/&quot;,</span>
<a href="#l40.26"></a><span id="l40.26" class="difflineplus">+  username: &quot;user&quot;,</span>
<a href="#l40.27"></a><span id="l40.27" class="difflineplus">+}];</span>
<a href="#l40.28"></a><span id="l40.28"> </span>
<a href="#l40.29"></a><span id="l40.29"> function run_test() {</span>
<a href="#l40.30"></a><span id="l40.30">   var url;</span>
<a href="#l40.31"></a><span id="l40.31">   for (var part = 0; part &lt; smtpURLs.length; ++part) {</span>
<a href="#l40.32"></a><span id="l40.32">     print(&quot;url: &quot; + smtpURLs[part].url);</span>
<a href="#l40.33"></a><span id="l40.33"> </span>
<a href="#l40.34"></a><span id="l40.34">     url = Services.io.newURI(smtpURLs[part].url);</span>
<a href="#l40.35"></a><span id="l40.35"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_splitRecipients.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_splitRecipients.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -1,105 +1,107 @@</span>
<a href="#l41.4"></a><span id="l41.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l41.5"></a><span id="l41.5"> /*</span>
<a href="#l41.6"></a><span id="l41.6">  * Test suite for nsMsgCompFields functions.</span>
<a href="#l41.7"></a><span id="l41.7">  * Currently only tests nsIMsgCompFields::SplitRecipients</span>
<a href="#l41.8"></a><span id="l41.8">  */</span>
<a href="#l41.9"></a><span id="l41.9"> </span>
<a href="#l41.10"></a><span id="l41.10" class="difflineminus">-var splitRecipientsTests =</span>
<a href="#l41.11"></a><span id="l41.11" class="difflineminus">-  [ { recipients: &quot;me@foo.invalid&quot;,</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-      emailAddressOnly: false,</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineminus">-      count: 1,</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineminus">-      result: [ &quot;me@foo.invalid&quot; ]</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineminus">-    },</span>
<a href="#l41.16"></a><span id="l41.16" class="difflineminus">-    { recipients: &quot;me@foo.invalid, me2@foo.invalid&quot;,</span>
<a href="#l41.17"></a><span id="l41.17" class="difflineminus">-      emailAddressOnly: false,</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineminus">-      count: 2,</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineminus">-      result: [ &quot;me@foo.invalid&quot;, &quot;me2@foo.invalid&quot; ]</span>
<a href="#l41.20"></a><span id="l41.20" class="difflineminus">-    },</span>
<a href="#l41.21"></a><span id="l41.21" class="difflineminus">-    { recipients: '&quot;foo bar&quot; &lt;me@foo.invalid&gt;',</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineminus">-      emailAddressOnly: false,</span>
<a href="#l41.23"></a><span id="l41.23" class="difflineminus">-      count: 1,</span>
<a href="#l41.24"></a><span id="l41.24" class="difflineminus">-      result: [ 'foo bar &lt;me@foo.invalid&gt;' ]</span>
<a href="#l41.25"></a><span id="l41.25" class="difflineminus">-    },</span>
<a href="#l41.26"></a><span id="l41.26" class="difflineminus">-    { recipients: '&quot;foo bar&quot; &lt;me@foo.invalid&gt;',</span>
<a href="#l41.27"></a><span id="l41.27" class="difflineminus">-      emailAddressOnly: true,</span>
<a href="#l41.28"></a><span id="l41.28" class="difflineminus">-      count: 1,</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineminus">-      result: [ 'me@foo.invalid' ]</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineminus">-    },</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineminus">-    { recipients: '&quot;foo bar&quot; &lt;me@foo.invalid&gt;, &quot;bar foo&quot; &lt;me2@foo.invalid&gt;',</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineminus">-      emailAddressOnly: false,</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineminus">-      count: 2,</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineminus">-      result: [ 'foo bar &lt;me@foo.invalid&gt;', 'bar foo &lt;me2@foo.invalid&gt;' ]</span>
<a href="#l41.35"></a><span id="l41.35" class="difflineminus">-    },</span>
<a href="#l41.36"></a><span id="l41.36" class="difflineminus">-    { recipients: '&quot;foo bar&quot; &lt;me@foo.invalid&gt;, &quot;bar foo&quot; &lt;me2@foo.invalid&gt;',</span>
<a href="#l41.37"></a><span id="l41.37" class="difflineminus">-      emailAddressOnly: true,</span>
<a href="#l41.38"></a><span id="l41.38" class="difflineminus">-      count: 2,</span>
<a href="#l41.39"></a><span id="l41.39" class="difflineminus">-      result: [ &quot;me@foo.invalid&quot;, &quot;me2@foo.invalid&quot; ]</span>
<a href="#l41.40"></a><span id="l41.40" class="difflineminus">-    },</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineminus">-    { recipients: &quot;A Group:Ed Jones &lt;c@a.invalid&gt;,joe@where.invalid,John &lt;jdoe@one.invalid&gt;;&quot;,</span>
<a href="#l41.42"></a><span id="l41.42" class="difflineminus">-      emailAddressOnly: false,</span>
<a href="#l41.43"></a><span id="l41.43" class="difflineminus">-      count: 3,</span>
<a href="#l41.44"></a><span id="l41.44" class="difflineminus">-      result: [ &quot;Ed Jones &lt;c@a.invalid&gt;&quot;, &quot;joe@where.invalid&quot;, &quot;John &lt;jdoe@one.invalid&gt;&quot; ]</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineminus">-    },</span>
<a href="#l41.46"></a><span id="l41.46" class="difflineminus">-    { recipients: 'mygroup:;, empty:;, foo@foo.invalid, othergroup:bar@foo.invalid, bar2@foo.invalid;,       y@y.invalid, empty:;',</span>
<a href="#l41.47"></a><span id="l41.47" class="difflineminus">-      emailAddressOnly: true,</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineminus">-      count: 4,</span>
<a href="#l41.49"></a><span id="l41.49" class="difflineminus">-      result: [ &quot;foo@foo.invalid&quot;, &quot;bar@foo.invalid&quot;, &quot;bar2@foo.invalid&quot;, &quot;y@y.invalid&quot; ]</span>
<a href="#l41.50"></a><span id="l41.50" class="difflineminus">-    },</span>
<a href="#l41.51"></a><span id="l41.51" class="difflineminus">-    { recipients: 'Undisclosed recipients:;;;;;;;;;;;;;;;;,,,,,,,,,,,,,,,,',</span>
<a href="#l41.52"></a><span id="l41.52" class="difflineminus">-      emailAddressOnly: true,</span>
<a href="#l41.53"></a><span id="l41.53" class="difflineminus">-      count: 0,</span>
<a href="#l41.54"></a><span id="l41.54" class="difflineminus">-      result: []</span>
<a href="#l41.55"></a><span id="l41.55" class="difflineminus">-    },</span>
<a href="#l41.56"></a><span id="l41.56" class="difflineminus">-    { recipients: 'a@xxx.invalid; b@xxx.invalid',</span>
<a href="#l41.57"></a><span id="l41.57" class="difflineminus">-      emailAddressOnly: true,</span>
<a href="#l41.58"></a><span id="l41.58" class="difflineminus">-      count: 2,</span>
<a href="#l41.59"></a><span id="l41.59" class="difflineminus">-      result: [ &quot;a@xxx.invalid&quot;, &quot;b@xxx.invalid&quot; ]</span>
<a href="#l41.60"></a><span id="l41.60" class="difflineminus">-    },</span>
<a href="#l41.61"></a><span id="l41.61" class="difflineminus">-    { recipients: 'a@xxx.invalid; B &lt;b@xxx.invalid&gt;',</span>
<a href="#l41.62"></a><span id="l41.62" class="difflineminus">-      emailAddressOnly: false,</span>
<a href="#l41.63"></a><span id="l41.63" class="difflineminus">-      count: 2,</span>
<a href="#l41.64"></a><span id="l41.64" class="difflineminus">-      result: [ &quot;a@xxx.invalid&quot;, 'B &lt;b@xxx.invalid&gt;' ]</span>
<a href="#l41.65"></a><span id="l41.65" class="difflineminus">-    },</span>
<a href="#l41.66"></a><span id="l41.66" class="difflineminus">-    { recipients: '&quot;A &quot; &lt;a@xxx.invalid&gt;; b@xxx.invalid',</span>
<a href="#l41.67"></a><span id="l41.67" class="difflineminus">-      emailAddressOnly: false,</span>
<a href="#l41.68"></a><span id="l41.68" class="difflineminus">-      count: 2,</span>
<a href="#l41.69"></a><span id="l41.69" class="difflineminus">-      result: [ 'A  &lt;a@xxx.invalid&gt;', &quot;b@xxx.invalid&quot; ]</span>
<a href="#l41.70"></a><span id="l41.70" class="difflineminus">-    },</span>
<a href="#l41.71"></a><span id="l41.71" class="difflineminus">-    { recipients: 'A &lt;a@xxx.invalid&gt;; B &lt;b@xxx.invalid&gt;',</span>
<a href="#l41.72"></a><span id="l41.72" class="difflineminus">-      emailAddressOnly: false,</span>
<a href="#l41.73"></a><span id="l41.73" class="difflineminus">-      count: 2,</span>
<a href="#l41.74"></a><span id="l41.74" class="difflineminus">-      result: [ &quot;A &lt;a@xxx.invalid&gt;&quot;, 'B &lt;b@xxx.invalid&gt;' ]</span>
<a href="#l41.75"></a><span id="l41.75" class="difflineminus">-    },</span>
<a href="#l41.76"></a><span id="l41.76" class="difflineminus">-    { recipients: &quot;A (this: is, a comment;) &lt;a.invalid&gt;; g:   (this: is, &lt;a&gt; comment;) C &lt;c.invalid&gt;, d.invalid;&quot;,</span>
<a href="#l41.77"></a><span id="l41.77" class="difflineminus">-      emailAddressOnly: false,</span>
<a href="#l41.78"></a><span id="l41.78" class="difflineminus">-      count: 3,</span>
<a href="#l41.79"></a><span id="l41.79" class="difflineminus">-      result: [ 'A (this: is, a comment;) &lt;a.invalid&gt;', '(this: is, &lt;a&gt; comment;) C &lt;c.invalid&gt;', &quot;d.invalid &lt;&gt;&quot; ]</span>
<a href="#l41.80"></a><span id="l41.80" class="difflineminus">-    },</span>
<a href="#l41.81"></a><span id="l41.81" class="difflineminus">-    { recipients: 'Mary Smith &lt;mary@x.invalid&gt;, extra:;, group:jdoe@example.invalid; Who? &lt;one@y.invalid&gt;; &lt;boss@nil.invalid&gt;, &quot;Giant; \\&quot;Big\\&quot; Box&quot; &lt;sysservices@example.invalid&gt;,         ',</span>
<a href="#l41.82"></a><span id="l41.82" class="difflineminus">-      emailAddressOnly: false,</span>
<a href="#l41.83"></a><span id="l41.83" class="difflineminus">-      count: 5,</span>
<a href="#l41.84"></a><span id="l41.84" class="difflineminus">-      result: [ &quot;Mary Smith &lt;mary@x.invalid&gt;&quot;, &quot;jdoe@example.invalid&quot;, &quot;Who? &lt;one@y.invalid&gt;&quot;, &quot;boss@nil.invalid&quot;, 'Giant; \&quot;Big\&quot; Box &lt;sysservices@example.invalid&gt;' ]</span>
<a href="#l41.85"></a><span id="l41.85" class="difflineminus">-      },</span>
<a href="#l41.86"></a><span id="l41.86" class="difflineminus">-    { recipients: 'Undisclosed recipients: a@foo.invalid ;;extra:;',</span>
<a href="#l41.87"></a><span id="l41.87" class="difflineminus">-      emailAddressOnly: true,</span>
<a href="#l41.88"></a><span id="l41.88" class="difflineminus">-      count: 1,</span>
<a href="#l41.89"></a><span id="l41.89" class="difflineminus">-      result: [ 'a@foo.invalid' ]</span>
<a href="#l41.90"></a><span id="l41.90" class="difflineminus">-    },</span>
<a href="#l41.91"></a><span id="l41.91" class="difflineminus">-    { recipients: 'Undisclosed recipients:;;extra:a@foo.invalid;',</span>
<a href="#l41.92"></a><span id="l41.92" class="difflineminus">-      emailAddressOnly: true,</span>
<a href="#l41.93"></a><span id="l41.93" class="difflineminus">-      count: 1,</span>
<a href="#l41.94"></a><span id="l41.94" class="difflineminus">-      result: [ 'a@foo.invalid' ]</span>
<a href="#l41.95"></a><span id="l41.95" class="difflineminus">-    },</span>
<a href="#l41.96"></a><span id="l41.96" class="difflineminus">-    { recipients: &quot;&quot;,</span>
<a href="#l41.97"></a><span id="l41.97" class="difflineminus">-      emailAddressOnly: false,</span>
<a href="#l41.98"></a><span id="l41.98" class="difflineminus">-      count: 0,</span>
<a href="#l41.99"></a><span id="l41.99" class="difflineminus">-      result: []</span>
<a href="#l41.100"></a><span id="l41.100" class="difflineminus">-    } ];</span>
<a href="#l41.101"></a><span id="l41.101" class="difflineplus">+var splitRecipientsTests = [</span>
<a href="#l41.102"></a><span id="l41.102" class="difflineplus">+  {</span>
<a href="#l41.103"></a><span id="l41.103" class="difflineplus">+    recipients: &quot;me@foo.invalid&quot;,</span>
<a href="#l41.104"></a><span id="l41.104" class="difflineplus">+    emailAddressOnly: false,</span>
<a href="#l41.105"></a><span id="l41.105" class="difflineplus">+    count: 1,</span>
<a href="#l41.106"></a><span id="l41.106" class="difflineplus">+    result: [ &quot;me@foo.invalid&quot; ],</span>
<a href="#l41.107"></a><span id="l41.107" class="difflineplus">+  }, {</span>
<a href="#l41.108"></a><span id="l41.108" class="difflineplus">+    recipients: &quot;me@foo.invalid, me2@foo.invalid&quot;,</span>
<a href="#l41.109"></a><span id="l41.109" class="difflineplus">+    emailAddressOnly: false,</span>
<a href="#l41.110"></a><span id="l41.110" class="difflineplus">+    count: 2,</span>
<a href="#l41.111"></a><span id="l41.111" class="difflineplus">+    result: [ &quot;me@foo.invalid&quot;, &quot;me2@foo.invalid&quot; ],</span>
<a href="#l41.112"></a><span id="l41.112" class="difflineplus">+  }, {</span>
<a href="#l41.113"></a><span id="l41.113" class="difflineplus">+    recipients: '&quot;foo bar&quot; &lt;me@foo.invalid&gt;',</span>
<a href="#l41.114"></a><span id="l41.114" class="difflineplus">+    emailAddressOnly: false,</span>
<a href="#l41.115"></a><span id="l41.115" class="difflineplus">+    count: 1,</span>
<a href="#l41.116"></a><span id="l41.116" class="difflineplus">+    result: [ &quot;foo bar &lt;me@foo.invalid&gt;&quot; ],</span>
<a href="#l41.117"></a><span id="l41.117" class="difflineplus">+  }, {</span>
<a href="#l41.118"></a><span id="l41.118" class="difflineplus">+    recipients: '&quot;foo bar&quot; &lt;me@foo.invalid&gt;',</span>
<a href="#l41.119"></a><span id="l41.119" class="difflineplus">+    emailAddressOnly: true,</span>
<a href="#l41.120"></a><span id="l41.120" class="difflineplus">+    count: 1,</span>
<a href="#l41.121"></a><span id="l41.121" class="difflineplus">+    result: [ &quot;me@foo.invalid&quot; ],</span>
<a href="#l41.122"></a><span id="l41.122" class="difflineplus">+  }, {</span>
<a href="#l41.123"></a><span id="l41.123" class="difflineplus">+    recipients: '&quot;foo bar&quot; &lt;me@foo.invalid&gt;, &quot;bar foo&quot; &lt;me2@foo.invalid&gt;',</span>
<a href="#l41.124"></a><span id="l41.124" class="difflineplus">+    emailAddressOnly: false,</span>
<a href="#l41.125"></a><span id="l41.125" class="difflineplus">+    count: 2,</span>
<a href="#l41.126"></a><span id="l41.126" class="difflineplus">+    result: [ &quot;foo bar &lt;me@foo.invalid&gt;&quot;, &quot;bar foo &lt;me2@foo.invalid&gt;&quot; ],</span>
<a href="#l41.127"></a><span id="l41.127" class="difflineplus">+  }, {</span>
<a href="#l41.128"></a><span id="l41.128" class="difflineplus">+    recipients: '&quot;foo bar&quot; &lt;me@foo.invalid&gt;, &quot;bar foo&quot; &lt;me2@foo.invalid&gt;',</span>
<a href="#l41.129"></a><span id="l41.129" class="difflineplus">+    emailAddressOnly: true,</span>
<a href="#l41.130"></a><span id="l41.130" class="difflineplus">+    count: 2,</span>
<a href="#l41.131"></a><span id="l41.131" class="difflineplus">+    result: [ &quot;me@foo.invalid&quot;, &quot;me2@foo.invalid&quot; ],</span>
<a href="#l41.132"></a><span id="l41.132" class="difflineplus">+  }, {</span>
<a href="#l41.133"></a><span id="l41.133" class="difflineplus">+    recipients: &quot;A Group:Ed Jones &lt;c@a.invalid&gt;,joe@where.invalid,John &lt;jdoe@one.invalid&gt;;&quot;,</span>
<a href="#l41.134"></a><span id="l41.134" class="difflineplus">+    emailAddressOnly: false,</span>
<a href="#l41.135"></a><span id="l41.135" class="difflineplus">+    count: 3,</span>
<a href="#l41.136"></a><span id="l41.136" class="difflineplus">+    result: [ &quot;Ed Jones &lt;c@a.invalid&gt;&quot;, &quot;joe@where.invalid&quot;, &quot;John &lt;jdoe@one.invalid&gt;&quot; ],</span>
<a href="#l41.137"></a><span id="l41.137" class="difflineplus">+  }, {</span>
<a href="#l41.138"></a><span id="l41.138" class="difflineplus">+    recipients: &quot;mygroup:;, empty:;, foo@foo.invalid, othergroup:bar@foo.invalid, bar2@foo.invalid;,       y@y.invalid, empty:;&quot;,</span>
<a href="#l41.139"></a><span id="l41.139" class="difflineplus">+    emailAddressOnly: true,</span>
<a href="#l41.140"></a><span id="l41.140" class="difflineplus">+    count: 4,</span>
<a href="#l41.141"></a><span id="l41.141" class="difflineplus">+    result: [ &quot;foo@foo.invalid&quot;, &quot;bar@foo.invalid&quot;, &quot;bar2@foo.invalid&quot;, &quot;y@y.invalid&quot; ],</span>
<a href="#l41.142"></a><span id="l41.142" class="difflineplus">+  }, {</span>
<a href="#l41.143"></a><span id="l41.143" class="difflineplus">+    recipients: &quot;Undisclosed recipients:;;;;;;;;;;;;;;;;,,,,,,,,,,,,,,,,&quot;,</span>
<a href="#l41.144"></a><span id="l41.144" class="difflineplus">+    emailAddressOnly: true,</span>
<a href="#l41.145"></a><span id="l41.145" class="difflineplus">+    count: 0,</span>
<a href="#l41.146"></a><span id="l41.146" class="difflineplus">+    result: [],</span>
<a href="#l41.147"></a><span id="l41.147" class="difflineplus">+  }, {</span>
<a href="#l41.148"></a><span id="l41.148" class="difflineplus">+    recipients: &quot;a@xxx.invalid; b@xxx.invalid&quot;,</span>
<a href="#l41.149"></a><span id="l41.149" class="difflineplus">+    emailAddressOnly: true,</span>
<a href="#l41.150"></a><span id="l41.150" class="difflineplus">+    count: 2,</span>
<a href="#l41.151"></a><span id="l41.151" class="difflineplus">+    result: [ &quot;a@xxx.invalid&quot;, &quot;b@xxx.invalid&quot; ],</span>
<a href="#l41.152"></a><span id="l41.152" class="difflineplus">+  }, {</span>
<a href="#l41.153"></a><span id="l41.153" class="difflineplus">+    recipients: &quot;a@xxx.invalid; B &lt;b@xxx.invalid&gt;&quot;,</span>
<a href="#l41.154"></a><span id="l41.154" class="difflineplus">+    emailAddressOnly: false,</span>
<a href="#l41.155"></a><span id="l41.155" class="difflineplus">+    count: 2,</span>
<a href="#l41.156"></a><span id="l41.156" class="difflineplus">+    result: [ &quot;a@xxx.invalid&quot;, &quot;B &lt;b@xxx.invalid&gt;&quot; ],</span>
<a href="#l41.157"></a><span id="l41.157" class="difflineplus">+  }, {</span>
<a href="#l41.158"></a><span id="l41.158" class="difflineplus">+    recipients: '&quot;A &quot; &lt;a@xxx.invalid&gt;; b@xxx.invalid',</span>
<a href="#l41.159"></a><span id="l41.159" class="difflineplus">+    emailAddressOnly: false,</span>
<a href="#l41.160"></a><span id="l41.160" class="difflineplus">+    count: 2,</span>
<a href="#l41.161"></a><span id="l41.161" class="difflineplus">+    result: [ &quot;A  &lt;a@xxx.invalid&gt;&quot;, &quot;b@xxx.invalid&quot; ],</span>
<a href="#l41.162"></a><span id="l41.162" class="difflineplus">+  }, {</span>
<a href="#l41.163"></a><span id="l41.163" class="difflineplus">+    recipients: &quot;A &lt;a@xxx.invalid&gt;; B &lt;b@xxx.invalid&gt;&quot;,</span>
<a href="#l41.164"></a><span id="l41.164" class="difflineplus">+    emailAddressOnly: false,</span>
<a href="#l41.165"></a><span id="l41.165" class="difflineplus">+    count: 2,</span>
<a href="#l41.166"></a><span id="l41.166" class="difflineplus">+    result: [ &quot;A &lt;a@xxx.invalid&gt;&quot;, &quot;B &lt;b@xxx.invalid&gt;&quot; ],</span>
<a href="#l41.167"></a><span id="l41.167" class="difflineplus">+  }, {</span>
<a href="#l41.168"></a><span id="l41.168" class="difflineplus">+    recipients: &quot;A (this: is, a comment;) &lt;a.invalid&gt;; g:   (this: is, &lt;a&gt; comment;) C &lt;c.invalid&gt;, d.invalid;&quot;,</span>
<a href="#l41.169"></a><span id="l41.169" class="difflineplus">+    emailAddressOnly: false,</span>
<a href="#l41.170"></a><span id="l41.170" class="difflineplus">+    count: 3,</span>
<a href="#l41.171"></a><span id="l41.171" class="difflineplus">+    result: [ &quot;A (this: is, a comment;) &lt;a.invalid&gt;&quot;, &quot;(this: is, &lt;a&gt; comment;) C &lt;c.invalid&gt;&quot;, &quot;d.invalid &lt;&gt;&quot; ],</span>
<a href="#l41.172"></a><span id="l41.172" class="difflineplus">+  }, {</span>
<a href="#l41.173"></a><span id="l41.173" class="difflineplus">+    recipients: 'Mary Smith &lt;mary@x.invalid&gt;, extra:;, group:jdoe@example.invalid; Who? &lt;one@y.invalid&gt;; &lt;boss@nil.invalid&gt;, &quot;Giant; \\&quot;Big\\&quot; Box&quot; &lt;sysservices@example.invalid&gt;,         ',</span>
<a href="#l41.174"></a><span id="l41.174" class="difflineplus">+    emailAddressOnly: false,</span>
<a href="#l41.175"></a><span id="l41.175" class="difflineplus">+    count: 5,</span>
<a href="#l41.176"></a><span id="l41.176" class="difflineplus">+    result: [ &quot;Mary Smith &lt;mary@x.invalid&gt;&quot;, &quot;jdoe@example.invalid&quot;, &quot;Who? &lt;one@y.invalid&gt;&quot;, &quot;boss@nil.invalid&quot;, 'Giant; \&quot;Big\&quot; Box &lt;sysservices@example.invalid&gt;' ],</span>
<a href="#l41.177"></a><span id="l41.177" class="difflineplus">+  }, {</span>
<a href="#l41.178"></a><span id="l41.178" class="difflineplus">+    recipients: &quot;Undisclosed recipients: a@foo.invalid ;;extra:;&quot;,</span>
<a href="#l41.179"></a><span id="l41.179" class="difflineplus">+    emailAddressOnly: true,</span>
<a href="#l41.180"></a><span id="l41.180" class="difflineplus">+    count: 1,</span>
<a href="#l41.181"></a><span id="l41.181" class="difflineplus">+    result: [ &quot;a@foo.invalid&quot; ],</span>
<a href="#l41.182"></a><span id="l41.182" class="difflineplus">+  }, {</span>
<a href="#l41.183"></a><span id="l41.183" class="difflineplus">+    recipients: &quot;Undisclosed recipients:;;extra:a@foo.invalid;&quot;,</span>
<a href="#l41.184"></a><span id="l41.184" class="difflineplus">+    emailAddressOnly: true,</span>
<a href="#l41.185"></a><span id="l41.185" class="difflineplus">+    count: 1,</span>
<a href="#l41.186"></a><span id="l41.186" class="difflineplus">+    result: [ &quot;a@foo.invalid&quot; ],</span>
<a href="#l41.187"></a><span id="l41.187" class="difflineplus">+  }, {</span>
<a href="#l41.188"></a><span id="l41.188" class="difflineplus">+    recipients: &quot;&quot;,</span>
<a href="#l41.189"></a><span id="l41.189" class="difflineplus">+    emailAddressOnly: false,</span>
<a href="#l41.190"></a><span id="l41.190" class="difflineplus">+    count: 0,</span>
<a href="#l41.191"></a><span id="l41.191" class="difflineplus">+    result: [],</span>
<a href="#l41.192"></a><span id="l41.192" class="difflineplus">+  },</span>
<a href="#l41.193"></a><span id="l41.193" class="difflineplus">+];</span>
<a href="#l41.194"></a><span id="l41.194"> </span>
<a href="#l41.195"></a><span id="l41.195"> function run_test() {</span>
<a href="#l41.196"></a><span id="l41.196">   var fields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l41.197"></a><span id="l41.197">                  .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l41.198"></a><span id="l41.198"> </span>
<a href="#l41.199"></a><span id="l41.199">   // As most of SplitRecipients functionality is in the nsIMsgHeaderParser</span>
<a href="#l41.200"></a><span id="l41.200">   // functionality, here (at least initially), we're just interested in checking</span>
<a href="#l41.201"></a><span id="l41.201">   // the basic argument/return combinations.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_staleTemporaryFileCleanup.js</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_staleTemporaryFileCleanup.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -45,15 +45,14 @@ function run_test() {</span>
<a href="#l42.4"></a><span id="l42.4">     gExpectedFiles.forEach(function(file) {</span>
<a href="#l42.5"></a><span id="l42.5">       if (file.exists())</span>
<a href="#l42.6"></a><span id="l42.6">         file.remove(false);</span>
<a href="#l42.7"></a><span id="l42.7">     });</span>
<a href="#l42.8"></a><span id="l42.8">   });</span>
<a href="#l42.9"></a><span id="l42.9"> </span>
<a href="#l42.10"></a><span id="l42.10">   // Ensure we have at least one mail account</span>
<a href="#l42.11"></a><span id="l42.11">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-  let composeService = MailServices.compose;</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+  MailServices.compose; // Initialise the compose service.</span>
<a href="#l42.14"></a><span id="l42.14">   do_test_pending();</span>
<a href="#l42.15"></a><span id="l42.15">   check_files_not_exist(gExpectedFiles);</span>
<a href="#l42.16"></a><span id="l42.16">   do_test_finished();</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineminus">-</span>
<a href="#l42.18"></a><span id="l42.18"> }</span>
<a href="#l42.19"></a><span id="l42.19"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_temporaryFilesRemoved.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_temporaryFilesRemoved.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -7,26 +7,26 @@</span>
<a href="#l43.4"></a><span id="l43.4">  */</span>
<a href="#l43.5"></a><span id="l43.5"> </span>
<a href="#l43.6"></a><span id="l43.6"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l43.7"></a><span id="l43.7"> </span>
<a href="#l43.8"></a><span id="l43.8"> var gMsgCompose;</span>
<a href="#l43.9"></a><span id="l43.9"> var gExpectedFiles;</span>
<a href="#l43.10"></a><span id="l43.10"> </span>
<a href="#l43.11"></a><span id="l43.11"> var progressListener = {</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-  onStateChange: function(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+  onStateChange(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l43.14"></a><span id="l43.14">     if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_STOP)</span>
<a href="#l43.15"></a><span id="l43.15">       do_timeout(0, check_result);</span>
<a href="#l43.16"></a><span id="l43.16">   },</span>
<a href="#l43.17"></a><span id="l43.17"> </span>
<a href="#l43.18"></a><span id="l43.18" class="difflineminus">-  onProgressChange: function(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress, aCurTotalProgress, aMaxTotalProgress) {},</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineminus">-  onLocationChange: function(aWebProgress, aRequest, aLocation, aFlags) {},</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineminus">-  onStatusChange: function(aWebProgress, aRequest, aStatus, aMessage) {},</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineminus">-  onSecurityChange: function(aWebProgress, aRequest, state) {},</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineminus">-  onContentBlockingEvent: function(aWebProgress, aRequest, aEvent) {},</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineplus">+  onProgressChange(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress, aCurTotalProgress, aMaxTotalProgress) {},</span>
<a href="#l43.24"></a><span id="l43.24" class="difflineplus">+  onLocationChange(aWebProgress, aRequest, aLocation, aFlags) {},</span>
<a href="#l43.25"></a><span id="l43.25" class="difflineplus">+  onStatusChange(aWebProgress, aRequest, aStatus, aMessage) {},</span>
<a href="#l43.26"></a><span id="l43.26" class="difflineplus">+  onSecurityChange(aWebProgress, aRequest, state) {},</span>
<a href="#l43.27"></a><span id="l43.27" class="difflineplus">+  onContentBlockingEvent(aWebProgress, aRequest, aEvent) {},</span>
<a href="#l43.28"></a><span id="l43.28"> </span>
<a href="#l43.29"></a><span id="l43.29">   QueryInterface: ChromeUtils.generateQI([&quot;nsIWebProgressListener&quot;,</span>
<a href="#l43.30"></a><span id="l43.30">                                           &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l43.31"></a><span id="l43.31"> };</span>
<a href="#l43.32"></a><span id="l43.32"> </span>
<a href="#l43.33"></a><span id="l43.33"> function get_temporary_files_for(name) {</span>
<a href="#l43.34"></a><span id="l43.34">   let file = Services.dirsvc.get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l43.35"></a><span id="l43.35">   file.append(name);</span>
<a href="#l43.36"></a><span id="l43.36" class="difflineat">@@ -85,17 +85,17 @@ function run_test() {</span>
<a href="#l43.37"></a><span id="l43.37"> </span>
<a href="#l43.38"></a><span id="l43.38">   params.composeFields = fields;</span>
<a href="#l43.39"></a><span id="l43.39">   params.format = Ci.nsIMsgCompFormat.HTML;</span>
<a href="#l43.40"></a><span id="l43.40"> </span>
<a href="#l43.41"></a><span id="l43.41">   gMsgCompose.initialize(params, null, null);</span>
<a href="#l43.42"></a><span id="l43.42"> </span>
<a href="#l43.43"></a><span id="l43.43">   let identity = getSmtpIdentity(null, getBasicSmtpServer());</span>
<a href="#l43.44"></a><span id="l43.44"> </span>
<a href="#l43.45"></a><span id="l43.45" class="difflineminus">-  let draftFolder = localAccountUtils.rootFolder.createLocalSubfolder(&quot;Drafts&quot;);</span>
<a href="#l43.46"></a><span id="l43.46" class="difflineplus">+  localAccountUtils.rootFolder.createLocalSubfolder(&quot;Drafts&quot;);</span>
<a href="#l43.47"></a><span id="l43.47"> </span>
<a href="#l43.48"></a><span id="l43.48">   let progress = Cc[&quot;@mozilla.org/messenger/progress;1&quot;]</span>
<a href="#l43.49"></a><span id="l43.49">                    .createInstance(Ci.nsIMsgProgress);</span>
<a href="#l43.50"></a><span id="l43.50">   progress.registerListener(progressListener);</span>
<a href="#l43.51"></a><span id="l43.51"> </span>
<a href="#l43.52"></a><span id="l43.52">   do_test_pending();</span>
<a href="#l43.53"></a><span id="l43.53"> </span>
<a href="#l43.54"></a><span id="l43.54">   gMsgCompose.SendMsg(Ci.nsIMsgSend.nsMsgSaveAsDraft, identity, &quot;&quot;, null,</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

