<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 27731:0d126d5453bda2506fb090bd96a89d2e49bf70a8</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 0d126d5453bda2506fb090bd96a89d2e49bf70a8" />
<meta property="og:url" content="/comm-central/rev/0d126d5453bda2506fb090bd96a89d2e49bf70a8" />
<meta property="og:description" content="Bug 1531597 - Add an API for the adding a button to the message display toolbar. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 0d126d5453bda2506fb090bd96a89d2e49bf70a8 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/0d126d5453bda2506fb090bd96a89d2e49bf70a8">shortlog</a> |
<a href="/comm-central/log/0d126d5453bda2506fb090bd96a89d2e49bf70a8">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/0d126d5453bda2506fb090bd96a89d2e49bf70a8">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/0d126d5453bda2506fb090bd96a89d2e49bf70a8">files</a> |
changeset |
<a href="/comm-central/raw-rev/0d126d5453bda2506fb090bd96a89d2e49bf70a8">raw</a>  | <a href="/comm-central/archive/0d126d5453bda2506fb090bd96a89d2e49bf70a8.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1531597">Bug 1531597</a> - Add an API for the adding a button to the message display toolbar. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 20 Sep 2019 15:54:46 +1200</td></tr>

<tr>
 <td>changeset 27731</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/0d126d5453bda2506fb090bd96a89d2e49bf70a8">0d126d5453bda2506fb090bd96a89d2e49bf70a8</a></td>
</tr>



<tr>
<td>parent 27730</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/580590b5d1b4f9e258c0c4a457a2cdd89233a3cf">580590b5d1b4f9e258c0c4a457a2cdd89233a3cf</a>
</td>
</tr>

<tr>
<td>child 27732</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/88a00eab31d4930cba2a0749932de1db5276e362">88a00eab31d4930cba2a0749932de1db5276e362</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=0d126d5453bda2506fb090bd96a89d2e49bf70a8">16466</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 26 Sep 2019 18:26:32 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0d126d5453bd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0d126d5453bda2506fb090bd96a89d2e49bf70a8">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0d126d5453bda2506fb090bd96a89d2e49bf70a8&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0d126d5453bda2506fb090bd96a89d2e49bf70a8&newProject=comm-central&newRevision=a3e31c684ffad09291eec7822ce797637807b452&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0d126d5453bda2506fb090bd96a89d2e49bf70a8&newProject=comm-central&newRevision=a3e31c684ffad09291eec7822ce797637807b452&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0d126d5453bda2506fb090bd96a89d2e49bf70a8&newProject=comm-central&newRevision=a3e31c684ffad09291eec7822ce797637807b452&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1531597">1531597</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1531597">Bug 1531597</a> - Add an API for the adding a button to the message display toolbar. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/ExtensionToolbarButtons.jsm">mail/components/extensions/ExtensionToolbarButtons.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/ExtensionToolbarButtons.jsm">file</a> |
<a href="/comm-central/annotate/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/ExtensionToolbarButtons.jsm">annotate</a> |
<a href="/comm-central/diff/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/ExtensionToolbarButtons.jsm">diff</a> |
<a href="/comm-central/comparison/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/ExtensionToolbarButtons.jsm">comparison</a> |
<a href="/comm-central/log/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/ExtensionToolbarButtons.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/ext-mail.json">mail/components/extensions/ext-mail.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/ext-mail.json">file</a> |
<a href="/comm-central/annotate/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/ext-mail.json">annotate</a> |
<a href="/comm-central/diff/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/ext-mail.json">diff</a> |
<a href="/comm-central/comparison/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/ext-mail.json">comparison</a> |
<a href="/comm-central/log/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/ext-mail.json">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/jar.mn">mail/components/extensions/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/jar.mn">file</a> |
<a href="/comm-central/annotate/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/jar.mn">annotate</a> |
<a href="/comm-central/diff/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/jar.mn">diff</a> |
<a href="/comm-central/comparison/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/jar.mn">comparison</a> |
<a href="/comm-central/log/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/parent/ext-messageDisplayAction.js">mail/components/extensions/parent/ext-messageDisplayAction.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/parent/ext-messageDisplayAction.js">file</a> |
<a href="/comm-central/annotate/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/parent/ext-messageDisplayAction.js">annotate</a> |
<a href="/comm-central/diff/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/parent/ext-messageDisplayAction.js">diff</a> |
<a href="/comm-central/comparison/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/parent/ext-messageDisplayAction.js">comparison</a> |
<a href="/comm-central/log/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/parent/ext-messageDisplayAction.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/schemas/messageDisplayAction.json">mail/components/extensions/schemas/messageDisplayAction.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/schemas/messageDisplayAction.json">file</a> |
<a href="/comm-central/annotate/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/schemas/messageDisplayAction.json">annotate</a> |
<a href="/comm-central/diff/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/schemas/messageDisplayAction.json">diff</a> |
<a href="/comm-central/comparison/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/schemas/messageDisplayAction.json">comparison</a> |
<a href="/comm-central/log/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/schemas/messageDisplayAction.json">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/test/browser/browser.ini">mail/components/extensions/test/browser/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/test/browser/browser.ini">file</a> |
<a href="/comm-central/annotate/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/test/browser/browser.ini">annotate</a> |
<a href="/comm-central/diff/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/test/browser/browser.ini">diff</a> |
<a href="/comm-central/comparison/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/test/browser/browser.ini">comparison</a> |
<a href="/comm-central/log/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/test/browser/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/test/browser/browser_ext_messageDisplayAction.js">mail/components/extensions/test/browser/browser_ext_messageDisplayAction.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/test/browser/browser_ext_messageDisplayAction.js">file</a> |
<a href="/comm-central/annotate/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/test/browser/browser_ext_messageDisplayAction.js">annotate</a> |
<a href="/comm-central/diff/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/test/browser/browser_ext_messageDisplayAction.js">diff</a> |
<a href="/comm-central/comparison/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/test/browser/browser_ext_messageDisplayAction.js">comparison</a> |
<a href="/comm-central/log/0d126d5453bda2506fb090bd96a89d2e49bf70a8/mail/components/extensions/test/browser/browser_ext_messageDisplayAction.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/extensions/ExtensionToolbarButtons.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/extensions/ExtensionToolbarButtons.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -239,17 +239,17 @@ this.ToolbarButtonAPI = class extends Ex</span>
<a href="#l1.4"></a><span id="l1.4">     let enabled = this.getProperty(this.globals, &quot;enabled&quot;);</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">     if (button &amp;&amp; popupURL &amp;&amp; enabled) {</span>
<a href="#l1.7"></a><span id="l1.7">       let popup =</span>
<a href="#l1.8"></a><span id="l1.8">         ViewPopup.for(this.extension, window) ||</span>
<a href="#l1.9"></a><span id="l1.9">         this.getPopup(window, popupURL);</span>
<a href="#l1.10"></a><span id="l1.10">       popup.viewNode.openPopup(button, &quot;bottomcenter topleft&quot;, 0, 0);</span>
<a href="#l1.11"></a><span id="l1.11">     } else {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-      this.emit(&quot;click&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+      this.emit(&quot;click&quot;, window);</span>
<a href="#l1.14"></a><span id="l1.14">     }</span>
<a href="#l1.15"></a><span id="l1.15">   }</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17">   /**</span>
<a href="#l1.18"></a><span id="l1.18">    * Event listener.</span>
<a href="#l1.19"></a><span id="l1.19">    *</span>
<a href="#l1.20"></a><span id="l1.20">    * @param {Event} event</span>
<a href="#l1.21"></a><span id="l1.21">    */</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -335,17 +335,19 @@ this.ToolbarButtonAPI = class extends Ex</span>
<a href="#l1.23"></a><span id="l1.23">       let { style, legacy } = this.iconData.get(tabData.icon);</span>
<a href="#l1.24"></a><span id="l1.24">       const LEGACY_CLASS = &quot;toolbarbutton-legacy-addon&quot;;</span>
<a href="#l1.25"></a><span id="l1.25">       if (legacy) {</span>
<a href="#l1.26"></a><span id="l1.26">         node.classList.add(LEGACY_CLASS);</span>
<a href="#l1.27"></a><span id="l1.27">       } else {</span>
<a href="#l1.28"></a><span id="l1.28">         node.classList.remove(LEGACY_CLASS);</span>
<a href="#l1.29"></a><span id="l1.29">       }</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-      node.setAttribute(&quot;style&quot;, style);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+      for (let [name, value] of style) {</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+        node.style.setProperty(name, value);</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+      }</span>
<a href="#l1.35"></a><span id="l1.35">     };</span>
<a href="#l1.36"></a><span id="l1.36">     if (sync) {</span>
<a href="#l1.37"></a><span id="l1.37">       callback();</span>
<a href="#l1.38"></a><span id="l1.38">     } else {</span>
<a href="#l1.39"></a><span id="l1.39">       node.ownerGlobal.requestAnimationFrame(callback);</span>
<a href="#l1.40"></a><span id="l1.40">     }</span>
<a href="#l1.41"></a><span id="l1.41">   }</span>
<a href="#l1.42"></a><span id="l1.42"> </span>
<a href="#l1.43"></a><span id="l1.43" class="difflineat">@@ -386,30 +388,36 @@ this.ToolbarButtonAPI = class extends Ex</span>
<a href="#l1.44"></a><span id="l1.44">         return IconDetails.escapeUrl(icon[theme]);</span>
<a href="#l1.45"></a><span id="l1.45">       }</span>
<a href="#l1.46"></a><span id="l1.46">       if (icon == IconDetails.DEFAULT_ICON) {</span>
<a href="#l1.47"></a><span id="l1.47">         return DEFAULT_ICON;</span>
<a href="#l1.48"></a><span id="l1.48">       }</span>
<a href="#l1.49"></a><span id="l1.49">       return IconDetails.escapeUrl(icon);</span>
<a href="#l1.50"></a><span id="l1.50">     };</span>
<a href="#l1.51"></a><span id="l1.51"> </span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+    let style = [];</span>
<a href="#l1.53"></a><span id="l1.53">     let getStyle = (name, size) =&gt; {</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-      return `</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-        --webextension-${name}: url(&quot;${getIcon(size, &quot;default&quot;)}&quot;);</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-        --webextension-${name}-light: url(&quot;${getIcon(size, &quot;light&quot;)}&quot;);</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-        --webextension-${name}-dark: url(&quot;${getIcon(size, &quot;dark&quot;)}&quot;);</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-      `;</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+      style.push([</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+        `--webextension-${name}`,</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+        `url(&quot;${getIcon(size, &quot;default&quot;)}&quot;)`,</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+      ]);</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+      style.push([</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+        `--webextension-${name}-light`,</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+        `url(&quot;${getIcon(size, &quot;light&quot;)}&quot;)`,</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+      ]);</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+      style.push([</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+        `--webextension-${name}-dark`,</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+        `url(&quot;${getIcon(size, &quot;dark&quot;)}&quot;)`,</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+      ]);</span>
<a href="#l1.71"></a><span id="l1.71">     };</span>
<a href="#l1.72"></a><span id="l1.72"> </span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-    let style = `</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-      ${getStyle(&quot;menupanel-image&quot;, 32)}</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-      ${getStyle(&quot;menupanel-image-2x&quot;, 64)}</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-      ${getStyle(&quot;toolbar-image&quot;, baseSize)}</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-      ${getStyle(&quot;toolbar-image-2x&quot;, baseSize * 2)}</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-    `;</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+    getStyle(&quot;menupanel-image&quot;, 32);</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+    getStyle(&quot;menupanel-image-2x&quot;, 64);</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+    getStyle(&quot;toolbar-image&quot;, baseSize);</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+    getStyle(&quot;toolbar-image-2x&quot;, baseSize * 2);</span>
<a href="#l1.83"></a><span id="l1.83"> </span>
<a href="#l1.84"></a><span id="l1.84">     let realIcon = getIcon(size, &quot;default&quot;);</span>
<a href="#l1.85"></a><span id="l1.85"> </span>
<a href="#l1.86"></a><span id="l1.86">     return { style, legacy, realIcon };</span>
<a href="#l1.87"></a><span id="l1.87">   }</span>
<a href="#l1.88"></a><span id="l1.88"> </span>
<a href="#l1.89"></a><span id="l1.89">   /**</span>
<a href="#l1.90"></a><span id="l1.90">    * Update the toolbar button for a given window.</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineat">@@ -535,18 +543,18 @@ this.ToolbarButtonAPI = class extends Ex</span>
<a href="#l1.92"></a><span id="l1.92"> </span>
<a href="#l1.93"></a><span id="l1.93">     return {</span>
<a href="#l1.94"></a><span id="l1.94">       [this.manifestName]: {</span>
<a href="#l1.95"></a><span id="l1.95">         onClicked: new EventManager({</span>
<a href="#l1.96"></a><span id="l1.96">           context,</span>
<a href="#l1.97"></a><span id="l1.97">           name: `${this.manifestName}.onClicked`,</span>
<a href="#l1.98"></a><span id="l1.98">           inputHandling: true,</span>
<a href="#l1.99"></a><span id="l1.99">           register: fire =&gt; {</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-            let listener = (event, browser) =&gt; {</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-              context.withPendingBrowser(browser, () =&gt; fire.sync());</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+            let listener = event =&gt; {</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+              fire.sync();</span>
<a href="#l1.104"></a><span id="l1.104">             };</span>
<a href="#l1.105"></a><span id="l1.105">             action.on(&quot;click&quot;, listener);</span>
<a href="#l1.106"></a><span id="l1.106">             return () =&gt; {</span>
<a href="#l1.107"></a><span id="l1.107">               action.off(&quot;click&quot;, listener);</span>
<a href="#l1.108"></a><span id="l1.108">             };</span>
<a href="#l1.109"></a><span id="l1.109">           },</span>
<a href="#l1.110"></a><span id="l1.110">         }).api(),</span>
<a href="#l1.111"></a><span id="l1.111"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/extensions/ext-mail.json</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/extensions/ext-mail.json</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -116,16 +116,25 @@</span>
<a href="#l2.4"></a><span id="l2.4">   &quot;messageDisplay&quot;: {</span>
<a href="#l2.5"></a><span id="l2.5">     &quot;url&quot;: &quot;chrome://messenger/content/parent/ext-messageDisplay.js&quot;,</span>
<a href="#l2.6"></a><span id="l2.6">     &quot;schema&quot;: &quot;chrome://messenger/content/schemas/messageDisplay.json&quot;,</span>
<a href="#l2.7"></a><span id="l2.7">     &quot;scopes&quot;: [&quot;addon_parent&quot;],</span>
<a href="#l2.8"></a><span id="l2.8">     &quot;paths&quot;: [</span>
<a href="#l2.9"></a><span id="l2.9">       [&quot;messageDisplay&quot;]</span>
<a href="#l2.10"></a><span id="l2.10">     ]</span>
<a href="#l2.11"></a><span id="l2.11">   },</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  &quot;messageDisplayAction&quot;: {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    &quot;url&quot;: &quot;chrome://messenger/content/parent/ext-messageDisplayAction.js&quot;,</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    &quot;schema&quot;: &quot;chrome://messenger/content/schemas/messageDisplayAction.json&quot;,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+    &quot;scopes&quot;: [&quot;addon_parent&quot;],</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    &quot;manifest&quot;: [&quot;message_display_action&quot;],</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+    &quot;paths&quot;: [</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+      [&quot;messageDisplayAction&quot;]</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+    ]</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+  },</span>
<a href="#l2.21"></a><span id="l2.21">   &quot;messages&quot;: {</span>
<a href="#l2.22"></a><span id="l2.22">     &quot;url&quot;: &quot;chrome://messenger/content/parent/ext-messages.js&quot;,</span>
<a href="#l2.23"></a><span id="l2.23">     &quot;schema&quot;: &quot;chrome://messenger/content/schemas/messages.json&quot;,</span>
<a href="#l2.24"></a><span id="l2.24">     &quot;scopes&quot;: [&quot;addon_parent&quot;],</span>
<a href="#l2.25"></a><span id="l2.25">     &quot;manifest&quot;: [&quot;messages&quot;],</span>
<a href="#l2.26"></a><span id="l2.26">     &quot;paths&quot;: [</span>
<a href="#l2.27"></a><span id="l2.27">       [&quot;messages&quot;]</span>
<a href="#l2.28"></a><span id="l2.28">     ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/extensions/jar.mn</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/extensions/jar.mn</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -20,16 +20,17 @@ messenger.jar:</span>
<a href="#l3.4"></a><span id="l3.4">     content/messenger/parent/ext-compose.js        (parent/ext-compose.js)</span>
<a href="#l3.5"></a><span id="l3.5">     content/messenger/parent/ext-composeAction.js  (parent/ext-composeAction.js)</span>
<a href="#l3.6"></a><span id="l3.6">     content/messenger/parent/ext-folders.js        (parent/ext-folders.js)</span>
<a href="#l3.7"></a><span id="l3.7">     content/messenger/parent/ext-legacy.js         (parent/ext-legacy.js)</span>
<a href="#l3.8"></a><span id="l3.8">     content/messenger/parent/ext-mail.js           (parent/ext-mail.js)</span>
<a href="#l3.9"></a><span id="l3.9">     content/messenger/parent/ext-mailTabs.js       (parent/ext-mailTabs.js)</span>
<a href="#l3.10"></a><span id="l3.10">     content/messenger/parent/ext-menus.js          (parent/ext-menus.js)</span>
<a href="#l3.11"></a><span id="l3.11">     content/messenger/parent/ext-messageDisplay.js (parent/ext-messageDisplay.js)</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    content/messenger/parent/ext-messageDisplayAction.js  (parent/ext-messageDisplayAction.js)</span>
<a href="#l3.13"></a><span id="l3.13">     content/messenger/parent/ext-messages.js       (parent/ext-messages.js)</span>
<a href="#l3.14"></a><span id="l3.14">     content/messenger/parent/ext-pkcs11.js         (../../../../browser/components/extensions/parent/ext-pkcs11.js)</span>
<a href="#l3.15"></a><span id="l3.15">     content/messenger/parent/ext-tabs.js           (parent/ext-tabs.js)</span>
<a href="#l3.16"></a><span id="l3.16">     content/messenger/parent/ext-windows.js        (parent/ext-windows.js)</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18">     content/messenger/schemas/accounts.json        (schemas/accounts.json)</span>
<a href="#l3.19"></a><span id="l3.19">     content/messenger/schemas/addressBook.json     (schemas/addressBook.json)</span>
<a href="#l3.20"></a><span id="l3.20">     content/messenger/schemas/browserAction.json   (schemas/browserAction.json)</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -39,12 +40,13 @@ messenger.jar:</span>
<a href="#l3.22"></a><span id="l3.22">     content/messenger/schemas/compose.json         (schemas/compose.json)</span>
<a href="#l3.23"></a><span id="l3.23">     content/messenger/schemas/composeAction.json   (schemas/composeAction.json)</span>
<a href="#l3.24"></a><span id="l3.24">     content/messenger/schemas/folders.json         (schemas/folders.json)</span>
<a href="#l3.25"></a><span id="l3.25">     content/messenger/schemas/legacy.json          (schemas/legacy.json)</span>
<a href="#l3.26"></a><span id="l3.26">     content/messenger/schemas/mailTabs.json        (schemas/mailTabs.json)</span>
<a href="#l3.27"></a><span id="l3.27">     content/messenger/schemas/menus.json           (schemas/menus.json)</span>
<a href="#l3.28"></a><span id="l3.28">     content/messenger/schemas/menus_child.json     (schemas/menus_child.json)</span>
<a href="#l3.29"></a><span id="l3.29">     content/messenger/schemas/messageDisplay.json  (schemas/messageDisplay.json)</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+    content/messenger/schemas/messageDisplayAction.json  (schemas/messageDisplayAction.json)</span>
<a href="#l3.31"></a><span id="l3.31">     content/messenger/schemas/messages.json        (schemas/messages.json)</span>
<a href="#l3.32"></a><span id="l3.32">     content/messenger/schemas/pkcs11.json          (../../../../browser/components/extensions/schemas/pkcs11.json)</span>
<a href="#l3.33"></a><span id="l3.33">     content/messenger/schemas/tabs.json            (schemas/tabs.json)</span>
<a href="#l3.34"></a><span id="l3.34">     content/messenger/schemas/windows.json         (schemas/windows.json)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mail/components/extensions/parent/ext-messageDisplayAction.js</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,74 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  this,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  &quot;ToolbarButtonAPI&quot;,</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  &quot;resource:///modules/ExtensionToolbarButtons.jsm&quot;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+);</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+const messageDisplayActionMap = new WeakMap();</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+this.messageDisplayAction = class extends ToolbarButtonAPI {</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+  static for(extension) {</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+    return messageDisplayActionMap.get(extension);</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+  }</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  async onManifestEntry(entryName) {</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+    await super.onManifestEntry(entryName);</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+    messageDisplayActionMap.set(this.extension, this);</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+  }</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+  close() {</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+    super.close();</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+    messageDisplayActionMap.delete(this.extension);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+  }</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+  constructor(extension) {</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+    super(extension);</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+    this.manifest_name = &quot;message_display_action&quot;;</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+    this.manifestName = &quot;messageDisplayAction&quot;;</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+    this.windowURLs = [</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+      &quot;chrome://messenger/content/messenger.xul&quot;,</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+      &quot;chrome://messenger/content/messageWindow.xul&quot;,</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+    ];</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+    this.toolboxId = &quot;header-view-toolbox&quot;;</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+    this.toolbarId = &quot;header-view-toolbar&quot;;</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+  }</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+  makeButton(window) {</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+    let button = super.makeButton(window);</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+    button.classList.add(&quot;msgHeaderView-button&quot;);</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+    button.style.listStyleImage = &quot;var(--webextension-menupanel-image)&quot;;</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+    return button;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+  }</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+  getAPI(context) {</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+    let { extension } = context;</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+    let { windowManager } = extension;</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+    let action = this;</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+    let api = super.getAPI(context);</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+    api[this.manifestName].onClicked = new EventManager({</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+      context,</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+      name: `${this.manifestName}.onClicked`,</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+      inputHandling: true,</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+      register: fire =&gt; {</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+        let listener = (event, window) =&gt; {</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+          let win = windowManager.wrapWindow(window);</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+          fire.sync(win.activeTab.id);</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+        };</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+        action.on(&quot;click&quot;, listener);</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+        return () =&gt; {</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+          action.off(&quot;click&quot;, listener);</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+        };</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+      },</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+    }).api();</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+    return api;</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+  }</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+};</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+global.messageDisplayActionFor = this.messageDisplayAction.for;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">copy from mail/components/extensions/schemas/browserAction.json</span>
<a href="#l5.2"></a><span id="l5.2">copy to mail/components/extensions/schemas/messageDisplayAction.json</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineminus">--- a/mail/components/extensions/schemas/browserAction.json</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineplus">+++ b/mail/components/extensions/schemas/messageDisplayAction.json</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l5.6"></a><span id="l5.6"> [</span>
<a href="#l5.7"></a><span id="l5.7">   {</span>
<a href="#l5.8"></a><span id="l5.8">     &quot;namespace&quot;: &quot;manifest&quot;,</span>
<a href="#l5.9"></a><span id="l5.9">     &quot;types&quot;: [</span>
<a href="#l5.10"></a><span id="l5.10">       {</span>
<a href="#l5.11"></a><span id="l5.11">         &quot;$extend&quot;: &quot;WebExtensionManifest&quot;,</span>
<a href="#l5.12"></a><span id="l5.12">         &quot;properties&quot;: {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-          &quot;browser_action&quot;: {</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+          &quot;message_display_action&quot;: {</span>
<a href="#l5.15"></a><span id="l5.15">             &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l5.16"></a><span id="l5.16">             &quot;additionalProperties&quot;: { &quot;$ref&quot;: &quot;UnrecognizedProperty&quot; },</span>
<a href="#l5.17"></a><span id="l5.17">             &quot;properties&quot;: {</span>
<a href="#l5.18"></a><span id="l5.18">               &quot;default_title&quot;: {</span>
<a href="#l5.19"></a><span id="l5.19">                 &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l5.20"></a><span id="l5.20">                 &quot;optional&quot;: true,</span>
<a href="#l5.21"></a><span id="l5.21">                 &quot;preprocess&quot;: &quot;localize&quot;</span>
<a href="#l5.22"></a><span id="l5.22">               },</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineat">@@ -44,19 +44,19 @@</span>
<a href="#l5.24"></a><span id="l5.24">             },</span>
<a href="#l5.25"></a><span id="l5.25">             &quot;optional&quot;: true</span>
<a href="#l5.26"></a><span id="l5.26">           }</span>
<a href="#l5.27"></a><span id="l5.27">         }</span>
<a href="#l5.28"></a><span id="l5.28">       }</span>
<a href="#l5.29"></a><span id="l5.29">     ]</span>
<a href="#l5.30"></a><span id="l5.30">   },</span>
<a href="#l5.31"></a><span id="l5.31">   {</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-    &quot;namespace&quot;: &quot;browserAction&quot;,</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+    &quot;namespace&quot;: &quot;messageDisplayAction&quot;,</span>
<a href="#l5.34"></a><span id="l5.34">     &quot;description&quot;: &quot;Use toolbar actions to put icons in the mail window toolbar. In addition to its icon, a toolbar action can also have a tooltip, a badge, and a popup. This namespace is called browserAction for compatibility with browser WebExtensions.&quot;,</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-    &quot;permissions&quot;: [&quot;manifest:browser_action&quot;],</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+    &quot;permissions&quot;: [&quot;manifest:message_display_action&quot;],</span>
<a href="#l5.37"></a><span id="l5.37">     &quot;types&quot;: [</span>
<a href="#l5.38"></a><span id="l5.38">       {</span>
<a href="#l5.39"></a><span id="l5.39">         &quot;id&quot;: &quot;Details&quot;,</span>
<a href="#l5.40"></a><span id="l5.40">         &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l5.41"></a><span id="l5.41">         &quot;description&quot;: &quot;Specifies to which tab or window the value should be set, or from which one it should be retrieved. If no tab nor window is specified, the global value is set or retrieved.&quot;,</span>
<a href="#l5.42"></a><span id="l5.42">         &quot;properties&quot;: {</span>
<a href="#l5.43"></a><span id="l5.43">           &quot;tabId&quot;: {</span>
<a href="#l5.44"></a><span id="l5.44">             &quot;type&quot;: &quot;integer&quot;,</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineat">@@ -405,13 +405,18 @@</span>
<a href="#l5.46"></a><span id="l5.46">       }</span>
<a href="#l5.47"></a><span id="l5.47">     ],</span>
<a href="#l5.48"></a><span id="l5.48">     &quot;events&quot;: [</span>
<a href="#l5.49"></a><span id="l5.49">       {</span>
<a href="#l5.50"></a><span id="l5.50">         &quot;name&quot;: &quot;onClicked&quot;,</span>
<a href="#l5.51"></a><span id="l5.51">         &quot;type&quot;: &quot;function&quot;,</span>
<a href="#l5.52"></a><span id="l5.52">         &quot;description&quot;: &quot;Fired when a toolbar action icon is clicked.  This event will not fire if the toolbar action has a popup.&quot;,</span>
<a href="#l5.53"></a><span id="l5.53">         &quot;parameters&quot;: [</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+          {</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+            &quot;name&quot;: &quot;tabId&quot;,</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+            &quot;type&quot;: &quot;integer&quot;,</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+            &quot;minimum&quot;: 1</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+          }</span>
<a href="#l5.59"></a><span id="l5.59">         ]</span>
<a href="#l5.60"></a><span id="l5.60">       }</span>
<a href="#l5.61"></a><span id="l5.61">     ]</span>
<a href="#l5.62"></a><span id="l5.62">   }</span>
<a href="#l5.63"></a><span id="l5.63"> ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/extensions/test/browser/browser.ini</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser.ini</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -18,11 +18,12 @@ tags = webextensions</span>
<a href="#l6.4"></a><span id="l6.4"> [browser_ext_commands_execute_browser_action.js]</span>
<a href="#l6.5"></a><span id="l6.5"> [browser_ext_commands_getAll.js]</span>
<a href="#l6.6"></a><span id="l6.6"> [browser_ext_commands_onCommand.js]</span>
<a href="#l6.7"></a><span id="l6.7"> [browser_ext_commands_update.js]</span>
<a href="#l6.8"></a><span id="l6.8"> [browser_ext_composeAction.js]</span>
<a href="#l6.9"></a><span id="l6.9"> [browser_ext_mailTabs.js]</span>
<a href="#l6.10"></a><span id="l6.10"> [browser_ext_menus.js]</span>
<a href="#l6.11"></a><span id="l6.11"> [browser_ext_messageDisplay.js]</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+[browser_ext_messageDisplayAction.js]</span>
<a href="#l6.13"></a><span id="l6.13"> [browser_ext_quickFilter.js]</span>
<a href="#l6.14"></a><span id="l6.14"> [browser_ext_windows.js]</span>
<a href="#l6.15"></a><span id="l6.15"> [browser_ext_windows_types.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser_ext_messageDisplayAction.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,169 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+/* globals gFolderDisplay, gFolderTreeView, MsgOpenNewWindowForMessage, MsgOpenSelectedMessages  */</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+let account;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  account = createAccount();</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  let rootFolder = account.incomingServer.rootFolder;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+  let subFolders = [...rootFolder.subFolders];</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+  createMessages(subFolders[0], 10);</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+  gFolderTreeView.selectFolder(subFolders[0]);</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+  gFolderDisplay.selectViewIndex(0);</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+  // For some unknown reason, this test doesn't like switching to the main</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+  // window if the thread tree has focus. Make sure it doesn't have focus.</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+  document.getElementById(&quot;folderTree&quot;).focus();</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+  await new Promise(resolve =&gt; executeSoon(resolve));</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+});</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+  async function test_it(extension, win) {</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+    let doc = win.document;</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+    await extension.startup();</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+    await promiseAnimationFrame(win);</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+    await new Promise(resolve =&gt; win.setTimeout(resolve));</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+    let buttonId = &quot;test1_mochi_test-messageDisplayAction-toolbarbutton&quot;;</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+    let toolbar = doc.getElementById(&quot;header-view-toolbar&quot;);</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+    let button = doc.getElementById(buttonId);</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+    ok(button, &quot;Button created&quot;);</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+    is(toolbar.id, button.parentNode.id, &quot;Button added to toolbar&quot;);</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+    ok(</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+      toolbar.currentSet.split(&quot;,&quot;).includes(buttonId),</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+      &quot;Button added to toolbar current set&quot;</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+    );</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+    ok(</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+      toolbar</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+        .getAttribute(&quot;currentset&quot;)</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+        .split(&quot;,&quot;)</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+        .includes(buttonId),</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+      &quot;Button added to toolbar current set attribute&quot;</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+    );</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+    let icon = button.querySelector(&quot;.toolbarbutton-icon&quot;);</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+    is(</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+      getComputedStyle(icon).listStyleImage,</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+      `url(&quot;chrome://messenger/content/extension.svg&quot;)`,</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+      &quot;Default icon&quot;</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+    );</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+    let label = button.querySelector(&quot;.toolbarbutton-text&quot;);</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+    is(label.value, &quot;This is a test&quot;, &quot;Correct label&quot;);</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+    EventUtils.synthesizeMouseAtCenter(button, { clickCount: 1 }, win);</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+    await extension.awaitMessage(&quot;messageDisplayAction&quot;);</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+    await promiseAnimationFrame(win);</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+    await new Promise(resolve =&gt; win.setTimeout(resolve));</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+    is(doc.getElementById(buttonId), button);</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+    label = button.querySelector(&quot;.toolbarbutton-text&quot;);</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+    is(label.value, &quot;New title&quot;, &quot;Correct label&quot;);</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+    await extension.unload();</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+    await promiseAnimationFrame(win);</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+    await new Promise(resolve =&gt; win.setTimeout(resolve));</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+    ok(!doc.getElementById(buttonId), &quot;Button destroyed&quot;);</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+  }</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+  async function background_nopopup() {</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+    browser.messageDisplayAction.onClicked.addListener(async tabId =&gt; {</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+      browser.test.log(`tabId is ${tabId}`);</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+      await browser.messageDisplayAction.setTitle({ title: &quot;New title&quot; });</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+      browser.test.sendMessage(&quot;messageDisplayAction&quot;);</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+    });</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+  }</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+  async function background_popup() {</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+    browser.runtime.onMessage.addListener(async msg =&gt; {</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+      browser.test.assertEq(&quot;popup.html&quot;, msg);</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+      await browser.messageDisplayAction.setTitle({ title: &quot;New title&quot; });</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+      browser.test.sendMessage(&quot;messageDisplayAction&quot;);</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+    });</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+  }</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+  let extensionDetails = {</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+    background: background_nopopup,</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+    files: {</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+      &quot;popup.html&quot;: `&lt;html&gt;</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+          &lt;head&gt;</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+            &lt;meta charset=&quot;utf-8&quot;&gt;</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+            &lt;script src=&quot;popup.js&quot;&gt;&lt;/script&gt;</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+          &lt;/head&gt;</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+          &lt;body&gt;popup.js&lt;/body&gt;</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+        &lt;/html&gt;`,</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+      &quot;popup.js&quot;: function() {</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+        window.onload = async () =&gt; {</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+          // eslint-disable-next-line mozilla/no-arbitrary-setTimeout</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+          await new Promise(resolve =&gt; setTimeout(resolve, 1000));</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+          await browser.runtime.sendMessage(&quot;popup.html&quot;);</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+          window.close();</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+        };</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+      },</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+    },</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+    manifest: {</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+      applications: {</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+        gecko: {</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+          id: &quot;test1@mochi.test&quot;,</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+        },</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+      },</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+      message_display_action: {</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+        default_title: &quot;This is a test&quot;,</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+      },</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+    },</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+    useAddonManager: &quot;temporary&quot;,</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+  };</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+  info(&quot;3-pane tab, no pop-up&quot;);</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+  let extension = ExtensionTestUtils.loadExtension(extensionDetails);</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+  await test_it(extension, window);</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+  info(&quot;Message tab, no pop-up&quot;);</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+  extension = ExtensionTestUtils.loadExtension(extensionDetails);</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+  MsgOpenSelectedMessages();</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+  await test_it(extension, window);</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+  document.getElementById(&quot;tabmail&quot;).closeTab();</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+  info(&quot;Message window, no pop-up&quot;);</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+  extension = ExtensionTestUtils.loadExtension(extensionDetails);</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+  let messageWindowPromise = BrowserTestUtils.domWindowOpened();</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+  MsgOpenNewWindowForMessage();</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+  let messageWindow = await messageWindowPromise;</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+  await new Promise(resolve =&gt; messageWindow.setTimeout(resolve));</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+  await new Promise(resolve =&gt; messageWindow.setTimeout(resolve));</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+  await test_it(extension, messageWindow);</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+  messageWindow.close();</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+  info(&quot;3-pane tab, with pop-up&quot;);</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+  extensionDetails.background = background_popup;</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+  extensionDetails.manifest.message_display_action.default_popup = &quot;popup.html&quot;;</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+  extension = ExtensionTestUtils.loadExtension(extensionDetails);</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+  await test_it(extension, window);</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+  info(&quot;Message tab, with pop-up&quot;);</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+  extension = ExtensionTestUtils.loadExtension(extensionDetails);</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+  MsgOpenSelectedMessages();</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+  await test_it(extension, window);</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+  document.getElementById(&quot;tabmail&quot;).closeTab();</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+  info(&quot;Message window, with pop-up&quot;);</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+  extension = ExtensionTestUtils.loadExtension(extensionDetails);</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+  messageWindowPromise = BrowserTestUtils.domWindowOpened();</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+  MsgOpenNewWindowForMessage();</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+  messageWindow = await messageWindowPromise;</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+  await new Promise(resolve =&gt; messageWindow.setTimeout(resolve));</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+  await new Promise(resolve =&gt; messageWindow.setTimeout(resolve));</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+  await test_it(extension, messageWindow);</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+  messageWindow.close();</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+});</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

