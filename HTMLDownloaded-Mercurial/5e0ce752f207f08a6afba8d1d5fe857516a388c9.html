<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 736:5e0ce752f207f08a6afba8d1d5fe857516a388c9</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 5e0ce752f207f08a6afba8d1d5fe857516a388c9" />
<meta property="og:url" content="/comm-central/rev/5e0ce752f207f08a6afba8d1d5fe857516a388c9" />
<meta property="og:description" content="Bug 326809 modernize nsIMsgHeaderParser - |string| and |wstring| vs AString and AUTF8String. Part 2 - fix extractHeaderAddreesName(s). r=Neil,sr=bienvenu" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 5e0ce752f207f08a6afba8d1d5fe857516a388c9 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/5e0ce752f207f08a6afba8d1d5fe857516a388c9">shortlog</a> |
<a href="/comm-central/log/5e0ce752f207f08a6afba8d1d5fe857516a388c9">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/5e0ce752f207f08a6afba8d1d5fe857516a388c9">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/5e0ce752f207f08a6afba8d1d5fe857516a388c9">files</a> |
changeset |
<a href="/comm-central/raw-rev/5e0ce752f207f08a6afba8d1d5fe857516a388c9">raw</a>  | <a href="/comm-central/archive/5e0ce752f207f08a6afba8d1d5fe857516a388c9.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=326809">Bug 326809</a> modernize nsIMsgHeaderParser - |string| and |wstring| vs AString and AUTF8String. Part 2 - fix extractHeaderAddreesName(s). r=Neil,sr=bienvenu
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#114;&#107;&#32;&#66;&#97;&#110;&#110;&#101;&#114;&#32;&#60;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#64;&#115;&#116;&#97;&#110;&#100;&#97;&#114;&#100;&#56;&#46;&#112;&#108;&#117;&#115;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 28 Oct 2008 09:49:23 +0000</td></tr>

<tr>
 <td>changeset 736</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/5e0ce752f207f08a6afba8d1d5fe857516a388c9">5e0ce752f207f08a6afba8d1d5fe857516a388c9</a></td>
</tr>



<tr>
<td>parent 735</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a51c25351cd48f65d47168bbe735b91ab98525f6">a51c25351cd48f65d47168bbe735b91ab98525f6</a>
</td>
</tr>

<tr>
<td>child 737</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a734a91a43f4f8802508852caa179a6e2587bd18">a734a91a43f4f8802508852caa179a6e2587bd18</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=5e0ce752f207f08a6afba8d1d5fe857516a388c9">663</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 28 Oct 2008 09:50:03 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@5e0ce752f207 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5e0ce752f207f08a6afba8d1d5fe857516a388c9">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5e0ce752f207f08a6afba8d1d5fe857516a388c9&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5e0ce752f207f08a6afba8d1d5fe857516a388c9&newProject=comm-central&newRevision=5e0ce752f207f08a6afba8d1d5fe857516a388c9&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5e0ce752f207f08a6afba8d1d5fe857516a388c9&newProject=comm-central&newRevision=5e0ce752f207f08a6afba8d1d5fe857516a388c9&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5e0ce752f207f08a6afba8d1d5fe857516a388c9&newProject=comm-central&newRevision=5e0ce752f207f08a6afba8d1d5fe857516a388c9&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a>, <a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=326809">326809</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=326809">Bug 326809</a> modernize nsIMsgHeaderParser - |string| and |wstring| vs AString and AUTF8String. Part 2 - fix extractHeaderAddreesName(s). r=Neil,sr=bienvenu</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/base/src/nsMsgDBView.cpp">mailnews/base/src/nsMsgDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/base/src/nsMsgDBView.cpp">file</a> |
<a href="/comm-central/annotate/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/base/src/nsMsgDBView.cpp">annotate</a> |
<a href="/comm-central/diff/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/base/src/nsMsgDBView.cpp">diff</a> |
<a href="/comm-central/comparison/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/base/src/nsMsgDBView.cpp">comparison</a> |
<a href="/comm-central/log/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/base/src/nsMsgDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/db/msgdb/src/nsMsgDatabase.cpp">mailnews/db/msgdb/src/nsMsgDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/db/msgdb/src/nsMsgDatabase.cpp">file</a> |
<a href="/comm-central/annotate/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/db/msgdb/src/nsMsgDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/db/msgdb/src/nsMsgDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/db/msgdb/src/nsMsgDatabase.cpp">comparison</a> |
<a href="/comm-central/log/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/db/msgdb/src/nsMsgDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/local/src/nsParseMailbox.cpp">mailnews/local/src/nsParseMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/local/src/nsParseMailbox.cpp">file</a> |
<a href="/comm-central/annotate/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/local/src/nsParseMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/local/src/nsParseMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/local/src/nsParseMailbox.cpp">comparison</a> |
<a href="/comm-central/log/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/local/src/nsParseMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/local/src/nsParseMailbox.h">mailnews/local/src/nsParseMailbox.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/local/src/nsParseMailbox.h">file</a> |
<a href="/comm-central/annotate/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/local/src/nsParseMailbox.h">annotate</a> |
<a href="/comm-central/diff/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/local/src/nsParseMailbox.h">diff</a> |
<a href="/comm-central/comparison/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/local/src/nsParseMailbox.h">comparison</a> |
<a href="/comm-central/log/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/local/src/nsParseMailbox.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/mime/public/nsIMsgHeaderParser.idl">mailnews/mime/public/nsIMsgHeaderParser.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/mime/public/nsIMsgHeaderParser.idl">file</a> |
<a href="/comm-central/annotate/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/mime/public/nsIMsgHeaderParser.idl">annotate</a> |
<a href="/comm-central/diff/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/mime/public/nsIMsgHeaderParser.idl">diff</a> |
<a href="/comm-central/comparison/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/mime/public/nsIMsgHeaderParser.idl">comparison</a> |
<a href="/comm-central/log/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/mime/public/nsIMsgHeaderParser.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/mime/src/nsMsgHeaderParser.cpp">mailnews/mime/src/nsMsgHeaderParser.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/mime/src/nsMsgHeaderParser.cpp">file</a> |
<a href="/comm-central/annotate/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/mime/src/nsMsgHeaderParser.cpp">annotate</a> |
<a href="/comm-central/diff/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/mime/src/nsMsgHeaderParser.cpp">diff</a> |
<a href="/comm-central/comparison/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/mime/src/nsMsgHeaderParser.cpp">comparison</a> |
<a href="/comm-central/log/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/mime/src/nsMsgHeaderParser.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/mime/test/unit/test_nsIMsgHeaderParser2.js">mailnews/mime/test/unit/test_nsIMsgHeaderParser2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/mime/test/unit/test_nsIMsgHeaderParser2.js">file</a> |
<a href="/comm-central/annotate/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/mime/test/unit/test_nsIMsgHeaderParser2.js">annotate</a> |
<a href="/comm-central/diff/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/mime/test/unit/test_nsIMsgHeaderParser2.js">diff</a> |
<a href="/comm-central/comparison/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/mime/test/unit/test_nsIMsgHeaderParser2.js">comparison</a> |
<a href="/comm-central/log/5e0ce752f207f08a6afba8d1d5fe857516a388c9/mailnews/mime/test/unit/test_nsIMsgHeaderParser2.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -380,17 +380,18 @@ nsresult nsMsgDBView::FetchAuthor(nsIMsg</span>
<a href="#l1.4"></a><span id="l1.4">   nsresult rv = aHdr-&gt;GetMime2DecodedAuthor(unparsedAuthor);</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">   // *sigh* how sad, we need to convert our beautiful unicode string to utf8</span>
<a href="#l1.7"></a><span id="l1.7">   // so we can extract the name part of the address...then convert it back to</span>
<a href="#l1.8"></a><span id="l1.8">   // unicode again.</span>
<a href="#l1.9"></a><span id="l1.9">   if (mHeaderParser)</span>
<a href="#l1.10"></a><span id="l1.10">   {</span>
<a href="#l1.11"></a><span id="l1.11">     nsCString name;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    rv = mHeaderParser-&gt;ExtractHeaderAddressName(NS_ConvertUTF16toUTF8(unparsedAuthor).get(), getter_Copies(name));</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    rv = mHeaderParser-&gt;ExtractHeaderAddressName(NS_ConvertUTF16toUTF8(unparsedAuthor),</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+                                                 name);</span>
<a href="#l1.15"></a><span id="l1.15">     if (NS_SUCCEEDED(rv) &amp;&amp; !name.IsEmpty())</span>
<a href="#l1.16"></a><span id="l1.16">     {</span>
<a href="#l1.17"></a><span id="l1.17">       CopyUTF8toUTF16(name, aSenderString);</span>
<a href="#l1.18"></a><span id="l1.18">       return NS_OK;</span>
<a href="#l1.19"></a><span id="l1.19">     }</span>
<a href="#l1.20"></a><span id="l1.20">   }</span>
<a href="#l1.21"></a><span id="l1.21">   // if we got here then just return the original string</span>
<a href="#l1.22"></a><span id="l1.22">   aSenderString = unparsedAuthor;</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineat">@@ -430,17 +431,18 @@ nsresult nsMsgDBView::FetchRecipients(ns</span>
<a href="#l1.24"></a><span id="l1.24">   nsresult rv = aHdr-&gt;GetMime2DecodedRecipients(unparsedRecipients);</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26">   // *sigh* how sad, we need to convert our beautiful unicode string to utf8</span>
<a href="#l1.27"></a><span id="l1.27">   // so we can extract the name part of the address...then convert it back to</span>
<a href="#l1.28"></a><span id="l1.28">   // unicode again.</span>
<a href="#l1.29"></a><span id="l1.29">   if (mHeaderParser)</span>
<a href="#l1.30"></a><span id="l1.30">   {</span>
<a href="#l1.31"></a><span id="l1.31">     nsCString names;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-    rv = mHeaderParser-&gt;ExtractHeaderAddressNames(NS_ConvertUTF16toUTF8(unparsedRecipients).get(), getter_Copies(names));</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+    rv = mHeaderParser-&gt;ExtractHeaderAddressNames(NS_ConvertUTF16toUTF8(unparsedRecipients),</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+                                                  names);</span>
<a href="#l1.35"></a><span id="l1.35">     if (NS_SUCCEEDED(rv) &amp;&amp; !names.IsEmpty())</span>
<a href="#l1.36"></a><span id="l1.36">     {</span>
<a href="#l1.37"></a><span id="l1.37">       CopyUTF8toUTF16(names, aRecipientsString);</span>
<a href="#l1.38"></a><span id="l1.38">       return NS_OK;</span>
<a href="#l1.39"></a><span id="l1.39">     }</span>
<a href="#l1.40"></a><span id="l1.40">   }</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42">   aRecipientsString = unparsedRecipients;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -2278,18 +2278,19 @@ QuotingOutputStreamListener::QuotingOutp</span>
<a href="#l2.4"></a><span id="l2.4">           mMimeConverter-&gt;DecodeMimeHeaderToCharPtr(author.get(), charset,</span>
<a href="#l2.5"></a><span id="l2.5">             charetOverride, PR_TRUE, getter_Copies(decodedCString));</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">         nsCOMPtr&lt;nsIMsgHeaderParser&gt; parser (do_GetService(NS_MAILNEWS_MIME_HEADER_PARSER_CONTRACTID));</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">         if (parser)</span>
<a href="#l2.10"></a><span id="l2.10">         {</span>
<a href="#l2.11"></a><span id="l2.11">           nsCString authorName;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-          rv = parser-&gt;ExtractHeaderAddressName(!decodedCString.IsEmpty() ? decodedCString.get() : author.get(),</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-                                                getter_Copies(authorName));</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+          rv = parser-&gt;ExtractHeaderAddressName(!decodedCString.IsEmpty() ?</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+                                                decodedCString : author,</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+                                                authorName);</span>
<a href="#l2.17"></a><span id="l2.17">           // take care &quot;%s wrote&quot;</span>
<a href="#l2.18"></a><span id="l2.18">           PRUnichar *formatedString = nsnull;</span>
<a href="#l2.19"></a><span id="l2.19">           if (NS_SUCCEEDED(rv) &amp;&amp; !authorName.IsEmpty())</span>
<a href="#l2.20"></a><span id="l2.20">             formatedString = nsTextFormatter::smprintf(replyHeaderAuthorwrote.get(), authorName.get());</span>
<a href="#l2.21"></a><span id="l2.21">           else</span>
<a href="#l2.22"></a><span id="l2.22">             formatedString = nsTextFormatter::smprintf(replyHeaderAuthorwrote.get(), author.get());</span>
<a href="#l2.23"></a><span id="l2.23">           if (formatedString)</span>
<a href="#l2.24"></a><span id="l2.24">           {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -3145,55 +3145,59 @@ nsresult nsMsgDatabase::RowCellColumnToM</span>
<a href="#l3.4"></a><span id="l3.4">         characterSetOverride, PR_TRUE, resultStr);</span>
<a href="#l3.5"></a><span id="l3.5">     }</span>
<a href="#l3.6"></a><span id="l3.6">   }</span>
<a href="#l3.7"></a><span id="l3.7">   return err;</span>
<a href="#l3.8"></a><span id="l3.8"> }</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> nsresult nsMsgDatabase::RowCellColumnToAddressCollationKey(nsIMdbRow *row, mdb_token colToken, PRUint8 **result, PRUint32 *len)</span>
<a href="#l3.11"></a><span id="l3.11"> {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  const char *cSender;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  const char *cSender = nsnull;</span>
<a href="#l3.14"></a><span id="l3.14">   nsCString name;</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-  nsresult ret = RowCellColumnToConstCharPtr(row, colToken, &amp;cSender);</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-  if (NS_SUCCEEDED(ret))</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+  nsresult rv = RowCellColumnToConstCharPtr(row, colToken, &amp;cSender);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+  // Just in case this is null</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+  if (!cSender)</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+  nsIMsgHeaderParser *headerParser = GetHeaderParser();</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+  if (!headerParser)</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  // apply mime decode</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  nsIMimeConverter *converter = GetMimeConverter();</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+  if (!converter)</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+  nsCString resultStr;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+  nsCString charset;</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  PRBool characterSetOverride;</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  m_dbFolderInfo-&gt;GetCharacterSetOverride(&amp;characterSetOverride);</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  rv = RowCellColumnToCharPtr(row, m_messageCharSetColumnToken, getter_Copies(charset));</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  if (NS_FAILED(rv) || charset.IsEmpty() || charset.Equals(&quot;us-ascii&quot;) ||</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+      characterSetOverride)</span>
<a href="#l3.41"></a><span id="l3.41">   {</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-    nsIMsgHeaderParser *headerParser = GetHeaderParser();</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-    if (headerParser)</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-    {</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-      // apply mime decode</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-      nsIMimeConverter *converter = GetMimeConverter();</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-      if (NS_SUCCEEDED(ret) &amp;&amp; nsnull != converter)</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-      {</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-        nsCString resultStr;</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-        nsCString charset;</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-        PRBool characterSetOverride;</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-        m_dbFolderInfo-&gt;GetCharacterSetOverride(&amp;characterSetOverride);</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-        ret = RowCellColumnToCharPtr(row, m_messageCharSetColumnToken, getter_Copies(charset));</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-        if (NS_FAILED(ret) || charset.IsEmpty() || charset.Equals(&quot;us-ascii&quot;) ||</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-            characterSetOverride)</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-        {</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-          m_dbFolderInfo-&gt;GetEffectiveCharacterSet(charset);</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-        }</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-        ret = converter-&gt;DecodeMimeHeaderToCharPtr(cSender, charset.get(),</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-          characterSetOverride, PR_TRUE, getter_Copies(resultStr));</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-        if (NS_SUCCEEDED(ret) &amp;&amp; !resultStr.IsEmpty())</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-          ret = headerParser-&gt;ExtractHeaderAddressName(resultStr.get(),</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-                                                       getter_Copies(name));</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-        else</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-          ret = headerParser-&gt;ExtractHeaderAddressName(cSender,</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-                                                       getter_Copies(name));</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-      }</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-    }</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+    m_dbFolderInfo-&gt;GetEffectiveCharacterSet(charset);</span>
<a href="#l3.72"></a><span id="l3.72">   }</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-  if (NS_SUCCEEDED(ret))</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-    ret = CreateCollationKey(NS_ConvertUTF8toUTF16(name), result, len);</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-  return ret;</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+  rv = converter-&gt;DecodeMimeHeaderToCharPtr(cSender, charset.get(),</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+                                            characterSetOverride, PR_TRUE,</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+                                            getter_Copies(resultStr));</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !resultStr.IsEmpty())</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+    rv = headerParser-&gt;ExtractHeaderAddressName(resultStr, name);</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+  else</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+    rv = headerParser-&gt;ExtractHeaderAddressName(nsDependentCString(cSender),</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+                                                     name);</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+    return CreateCollationKey(NS_ConvertUTF8toUTF16(name), result, len);</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+  return rv;</span>
<a href="#l3.90"></a><span id="l3.90"> }</span>
<a href="#l3.91"></a><span id="l3.91"> </span>
<a href="#l3.92"></a><span id="l3.92"> nsresult nsMsgDatabase::GetCollationKeyGenerator()</span>
<a href="#l3.93"></a><span id="l3.93"> {</span>
<a href="#l3.94"></a><span id="l3.94">   nsresult err = NS_OK;</span>
<a href="#l3.95"></a><span id="l3.95">   if (!m_collationKeyGenerator)</span>
<a href="#l3.96"></a><span id="l3.96">   {</span>
<a href="#l3.97"></a><span id="l3.97">     nsCOMPtr &lt;nsILocale&gt; locale;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1163,42 +1163,16 @@ int nsParseMailMessageState::InternSubje</span>
<a href="#l4.4"></a><span id="l4.4"> #endif</span>
<a href="#l4.5"></a><span id="l4.5">   m_newMsgHdr-&gt;SetSubject(condensedKey ? condensedKey :</span>
<a href="#l4.6"></a><span id="l4.6">   (modifiedSubject.IsEmpty() ? key : modifiedSubject.get()));</span>
<a href="#l4.7"></a><span id="l4.7">   PR_FREEIF(condensedKey);</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9">   return 0;</span>
<a href="#l4.10"></a><span id="l4.10"> }</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-/* Like mbox_intern() but for headers which contain email addresses:</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-we extract the &quot;name&quot; component of the first address, and discard</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-the rest. */</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-nsresult nsParseMailMessageState::InternRfc822 (struct message_header *header,</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-                                                char **ret_name)</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-{</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-  char  *s;</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-  nsresult ret=NS_OK;</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-  if (!header || header-&gt;length == 0)</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-  NS_ASSERTION (header-&gt;length == (short) strlen (header-&gt;value), &quot;invalid message_header&quot;);</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-  NS_ASSERTION (ret_name != nsnull, &quot;null ret_name&quot;);</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-  if (m_HeaderAddressParser)</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-  {</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-    ret = m_HeaderAddressParser-&gt;ExtractHeaderAddressName(header-&gt;value, &amp;s);</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-    if (! s)</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-    *ret_name = s;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-  }</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-  return ret;</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-}</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-</span>
<a href="#l4.38"></a><span id="l4.38"> // we've reached the end of the envelope, and need to turn all our accumulated message_headers</span>
<a href="#l4.39"></a><span id="l4.39"> // into a single nsIMsgDBHdr to store in a database.</span>
<a href="#l4.40"></a><span id="l4.40"> int nsParseMailMessageState::FinalizeHeaders()</span>
<a href="#l4.41"></a><span id="l4.41"> {</span>
<a href="#l4.42"></a><span id="l4.42">   int status = 0;</span>
<a href="#l4.43"></a><span id="l4.43">   struct message_header *sender;</span>
<a href="#l4.44"></a><span id="l4.44">   struct message_header *recipient;</span>
<a href="#l4.45"></a><span id="l4.45">   struct message_header *subject;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -88,17 +88,16 @@ public:</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5">   void                  Init(PRUint32 fileposition);</span>
<a href="#l5.6"></a><span id="l5.6">   virtual PRInt32       ParseFolderLine(const char *line, PRUint32 lineLength);</span>
<a href="#l5.7"></a><span id="l5.7">   virtual int           StartNewEnvelope(const char *line, PRUint32 lineLength);</span>
<a href="#l5.8"></a><span id="l5.8">   int                   ParseHeaders();</span>
<a href="#l5.9"></a><span id="l5.9">   int                   FinalizeHeaders();</span>
<a href="#l5.10"></a><span id="l5.10">   int                   ParseEnvelope (const char *line, PRUint32 line_size);</span>
<a href="#l5.11"></a><span id="l5.11">   int                   InternSubject (struct message_header *header);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  nsresult  InternRfc822 (struct message_header *header, char **ret_name);</span>
<a href="#l5.13"></a><span id="l5.13"> </span>
<a href="#l5.14"></a><span id="l5.14">   static PRBool  IsEnvelopeLine(const char *buf, PRInt32 buf_size);</span>
<a href="#l5.15"></a><span id="l5.15">   static int  msg_UnHex(char C);</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17">   nsCOMPtr&lt;nsIMsgHeaderParser&gt; m_HeaderAddressParser;</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19">   nsCOMPtr&lt;nsIMsgDBHdr&gt; m_newMsgHdr; /* current message header we're building */</span>
<a href="#l5.20"></a><span id="l5.20">   nsCOMPtr&lt;nsIMsgDatabase&gt;  m_mailDB;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/mime/public/nsIMsgHeaderParser.idl</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/mime/public/nsIMsgHeaderParser.idl</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -44,17 +44,17 @@ interface nsISimpleEnumerator;</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> #define NS_MAILNEWS_MIME_HEADER_PARSER_CONTRACTID \</span>
<a href="#l6.6"></a><span id="l6.6">   &quot;@mozilla.org/messenger/headerparser;1&quot;</span>
<a href="#l6.7"></a><span id="l6.7"> %}</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> /* </span>
<a href="#l6.10"></a><span id="l6.10">  * nsIMsgRFCParser Interface declaration </span>
<a href="#l6.11"></a><span id="l6.11">  */ </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-[scriptable, uuid(96502670-07dd-4dd3-987a-ee6cafa8afa3)]</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+[scriptable, uuid(392ba09d-5a3a-4f24-bd15-782cab25fdb2)]</span>
<a href="#l6.14"></a><span id="l6.14"> interface nsIMsgHeaderParser : nsISupports {</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16">   void parseHeadersWithArray(in wstring aLine, </span>
<a href="#l6.17"></a><span id="l6.17">                              [array, size_is(count)] out wstring aEmailAddresses,</span>
<a href="#l6.18"></a><span id="l6.18">                              [array, size_is(count)] out wstring aNames,</span>
<a href="#l6.19"></a><span id="l6.19">                              [array, size_is(count)] out wstring aFullNames,</span>
<a href="#l6.20"></a><span id="l6.20">                              [retval] out unsigned long count);</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -94,26 +94,27 @@ interface nsIMsgHeaderParser : nsISuppor</span>
<a href="#l6.23"></a><span id="l6.23">    * Given a string which contains a list of Header addresses, returns a</span>
<a href="#l6.24"></a><span id="l6.24">    * comma-separated list of just the `user name' portions.  If any of</span>
<a href="#l6.25"></a><span id="l6.25">    * the addresses doesn't have a name, then the mailbox is used instead.</span>
<a href="#l6.26"></a><span id="l6.26">    *</span>
<a href="#l6.27"></a><span id="l6.27">    * @param aLine          The header line to parse.</span>
<a href="#l6.28"></a><span id="l6.28">    * @return               A comma-separated list of just the name parts</span>
<a href="#l6.29"></a><span id="l6.29">    *                       of the addresses.</span>
<a href="#l6.30"></a><span id="l6.30">    */</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-  [noscript] string extractHeaderAddressNames(in string aLine);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  AUTF8String extractHeaderAddressNames(in AUTF8String aLine);</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34">   /*</span>
<a href="#l6.35"></a><span id="l6.35">    * Like extractHeaderAddressNames, but only returns the first name in the</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-   * header if there is one.</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+   * header if there is one. This function will return unquoted strings suitable</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+   * for display.</span>
<a href="#l6.39"></a><span id="l6.39">    *</span>
<a href="#l6.40"></a><span id="l6.40">    * @param aLine          The header line to parse.</span>
<a href="#l6.41"></a><span id="l6.41">    * @return               The first name found in the list.</span>
<a href="#l6.42"></a><span id="l6.42">    */</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-  [noscript] string extractHeaderAddressName(in string aLine);</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+  AUTF8String extractHeaderAddressName(in AUTF8String aLine);</span>
<a href="#l6.45"></a><span id="l6.45"> </span>
<a href="#l6.46"></a><span id="l6.46">   /**</span>
<a href="#l6.47"></a><span id="l6.47">    * Given a string which contains a list of Header addresses, returns a new</span>
<a href="#l6.48"></a><span id="l6.48">    * string with the same data, but inserts missing commas, parses and reformats</span>
<a href="#l6.49"></a><span id="l6.49">    * it, and wraps long lines with newline-tab.</span>
<a href="#l6.50"></a><span id="l6.50">    *</span>
<a href="#l6.51"></a><span id="l6.51">    * @param aLine          The header line to parse.</span>
<a href="#l6.52"></a><span id="l6.52">    * @return               The reformatted header line.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/mime/src/nsMsgHeaderParser.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/mime/src/nsMsgHeaderParser.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -65,18 +65,16 @@ nsresult FillResultsArray(const char * a</span>
<a href="#l7.4"></a><span id="l7.4">  * The following are prototypes for the old &quot;C&quot; functions used to support all of the RFC-822 parsing code</span>
<a href="#l7.5"></a><span id="l7.5">  * We could have made these private functions of nsMsgHeaderParser if we wanted...</span>
<a href="#l7.6"></a><span id="l7.6">  */</span>
<a href="#l7.7"></a><span id="l7.7"> static int msg_parse_Header_addresses(const char *line, char **names, char **addresses,</span>
<a href="#l7.8"></a><span id="l7.8">                                       PRBool quote_names_p = PR_TRUE, PRBool quote_addrs_p = PR_TRUE,</span>
<a href="#l7.9"></a><span id="l7.9">                                       PRBool first_only_p = PR_FALSE);</span>
<a href="#l7.10"></a><span id="l7.10"> static int msg_quote_phrase_or_addr(char *address, PRInt32 length, PRBool addr_p);</span>
<a href="#l7.11"></a><span id="l7.11"> static nsresult msg_unquote_phrase_or_addr(const char *line, PRBool strict, char **lineout);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-static char *msg_extract_Header_address_names(const char *line);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-static char *msg_extract_Header_address_name(const char *line);</span>
<a href="#l7.14"></a><span id="l7.14"> #if 0</span>
<a href="#l7.15"></a><span id="l7.15"> static char *msg_format_Header_addresses(const char *addrs, int count,</span>
<a href="#l7.16"></a><span id="l7.16">                                          PRBool wrap_lines_p);</span>
<a href="#l7.17"></a><span id="l7.17"> #endif</span>
<a href="#l7.18"></a><span id="l7.18"> static char *msg_reformat_Header_addresses(const char *line);</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20"> static char *msg_remove_duplicate_addresses(const char *addrs, const char *other_addrs,</span>
<a href="#l7.21"></a><span id="l7.21">                                             PRBool removeAliasesToMe);</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -195,32 +193,16 @@ nsMsgHeaderParser::ParseHeaderAddresses(</span>
<a href="#l7.23"></a><span id="l7.23">                                         PRUint32 *aNumAddresses)</span>
<a href="#l7.24"></a><span id="l7.24"> {</span>
<a href="#l7.25"></a><span id="l7.25">   NS_ENSURE_ARG_POINTER(aNumAddresses);</span>
<a href="#l7.26"></a><span id="l7.26">   *aNumAddresses = msg_parse_Header_addresses(aLine, aNames, aAddresses);</span>
<a href="#l7.27"></a><span id="l7.27">   return NS_OK;</span>
<a href="#l7.28"></a><span id="l7.28"> }</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30"> NS_IMETHODIMP</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-nsMsgHeaderParser::ExtractHeaderAddressNames(const char *aLine, char **aNames)</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-{</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aNames);</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-  *aNames = msg_extract_Header_address_names(aLine);</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-  return NS_OK;</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-}</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-nsMsgHeaderParser::ExtractHeaderAddressName(const char *aLine, char **aName)</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-{</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aName);</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-  *aName = msg_extract_Header_address_name(aLine);</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-  return NS_OK;</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-}</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.47"></a><span id="l7.47"> nsMsgHeaderParser::ReformatHeaderAddresses(const char *aLine,</span>
<a href="#l7.48"></a><span id="l7.48">                                            char **aReformattedAddress)</span>
<a href="#l7.49"></a><span id="l7.49"> {</span>
<a href="#l7.50"></a><span id="l7.50">   NS_ENSURE_ARG_POINTER(aReformattedAddress);</span>
<a href="#l7.51"></a><span id="l7.51">   *aReformattedAddress = msg_reformat_Header_addresses(aLine);</span>
<a href="#l7.52"></a><span id="l7.52">   return NS_OK;</span>
<a href="#l7.53"></a><span id="l7.53"> }</span>
<a href="#l7.54"></a><span id="l7.54"> </span>
<a href="#l7.55"></a><span id="l7.55" class="difflineat">@@ -1108,29 +1090,28 @@ nsMsgHeaderParser::ExtractHeaderAddressM</span>
<a href="#l7.56"></a><span id="l7.56">     aResult.Truncate();</span>
<a href="#l7.57"></a><span id="l7.57">     return NS_OK;</span>
<a href="#l7.58"></a><span id="l7.58">   }</span>
<a href="#l7.59"></a><span id="l7.59"> </span>
<a href="#l7.60"></a><span id="l7.60">   char *addrs = 0;</span>
<a href="#l7.61"></a><span id="l7.61">   int status = msg_parse_Header_addresses(PromiseFlatCString(aLine).get(),</span>
<a href="#l7.62"></a><span id="l7.62">                                           NULL, &amp;addrs);</span>
<a href="#l7.63"></a><span id="l7.63">   if (status &lt;= 0)</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.66"></a><span id="l7.66"> </span>
<a href="#l7.67"></a><span id="l7.67">   char *s = addrs;</span>
<a href="#l7.68"></a><span id="l7.68">   PRUint32 i, size = 0;</span>
<a href="#l7.69"></a><span id="l7.69"> </span>
<a href="#l7.70"></a><span id="l7.70">   for (i = 0; (int) i &lt; status; i++)</span>
<a href="#l7.71"></a><span id="l7.71">   {</span>
<a href="#l7.72"></a><span id="l7.72">     PRUint32 j = strlen(s);</span>
<a href="#l7.73"></a><span id="l7.73">     s += j + 1;</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+    size += j;</span>
<a href="#l7.75"></a><span id="l7.75">     if ((int)(i + 1) &lt; status)</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-      size += j + 2;</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-    else</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-      size += j;</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+      size += 2;</span>
<a href="#l7.80"></a><span id="l7.80">   }</span>
<a href="#l7.81"></a><span id="l7.81"> </span>
<a href="#l7.82"></a><span id="l7.82">   nsCString result;</span>
<a href="#l7.83"></a><span id="l7.83">   result.SetLength(size);</span>
<a href="#l7.84"></a><span id="l7.84">   s = addrs;</span>
<a href="#l7.85"></a><span id="l7.85">   char* out = result.BeginWriting();</span>
<a href="#l7.86"></a><span id="l7.86">   for (i = 0; (int)i &lt; status; i++)</span>
<a href="#l7.87"></a><span id="l7.87">   {</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineat">@@ -1146,57 +1127,62 @@ nsMsgHeaderParser::ExtractHeaderAddressM</span>
<a href="#l7.89"></a><span id="l7.89">   }</span>
<a href="#l7.90"></a><span id="l7.90"> </span>
<a href="#l7.91"></a><span id="l7.91">   PR_Free(addrs);</span>
<a href="#l7.92"></a><span id="l7.92">   aResult = result;</span>
<a href="#l7.93"></a><span id="l7.93">   return NS_OK;</span>
<a href="#l7.94"></a><span id="l7.94"> }</span>
<a href="#l7.95"></a><span id="l7.95"> </span>
<a href="#l7.96"></a><span id="l7.96"> </span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-/* msg_extract_Header_address_names</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">- *</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+/**</span>
<a href="#l7.100"></a><span id="l7.100">  * Given a string which contains a list of Header addresses, returns a</span>
<a href="#l7.101"></a><span id="l7.101">  * comma-separated list of just the `user name' portions.  If any of</span>
<a href="#l7.102"></a><span id="l7.102">  * the addresses doesn't have a name, then the mailbox is used instead.</span>
<a href="#l7.103"></a><span id="l7.103">  *</span>
<a href="#l7.104"></a><span id="l7.104">  * The names are *unquoted* and therefore cannot be re-parsed in any way.</span>
<a href="#l7.105"></a><span id="l7.105">  * They are, however, nice and human-readable.</span>
<a href="#l7.106"></a><span id="l7.106">  */</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-static char *</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-msg_extract_Header_address_names(const char *line)</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+nsMsgHeaderParser::ExtractHeaderAddressNames(const nsACString &amp;aLine,</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+                                             nsACString &amp;aResult)</span>
<a href="#l7.112"></a><span id="l7.112"> {</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+  if (aLine.IsEmpty())</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+  {</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+    aResult.Truncate();</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+    return NS_OK;</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+  }</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+</span>
<a href="#l7.119"></a><span id="l7.119">   char *names = 0;</span>
<a href="#l7.120"></a><span id="l7.120">   char *addrs = 0;</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-  char *result, *s1, *s2, *out;</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+  int status = msg_parse_Header_addresses(PromiseFlatCString(aLine).get(),</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+                                          &amp;names, &amp;addrs);</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+  if (status &lt;= 0)</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+  PRUint32 len1, len2;</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+  char *s1, *s2, *out;</span>
<a href="#l7.129"></a><span id="l7.129">   PRUint32 i, size = 0;</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-  int status = msg_parse_Header_addresses(line, &amp;names, &amp;addrs);</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-  if (status &lt;= 0)</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-    return 0;</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-  PRUint32 len1, len2;</span>
<a href="#l7.134"></a><span id="l7.134"> </span>
<a href="#l7.135"></a><span id="l7.135">   s1 = names;</span>
<a href="#l7.136"></a><span id="l7.136">   s2 = addrs;</span>
<a href="#l7.137"></a><span id="l7.137">   for (i = 0; (int)i &lt; status; i++)</span>
<a href="#l7.138"></a><span id="l7.138">   {</span>
<a href="#l7.139"></a><span id="l7.139">     len1 = strlen(s1);</span>
<a href="#l7.140"></a><span id="l7.140">     len2 = strlen(s2);</span>
<a href="#l7.141"></a><span id="l7.141">     s1 += len1 + 1;</span>
<a href="#l7.142"></a><span id="l7.142">     s2 += len2 + 1;</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-    size += (len1 ? len1 : len2) + 2;</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+    size += (len1 ? len1 : len2);</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+    if ((int)(i + 1) &lt; status)</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+      size += 2;</span>
<a href="#l7.147"></a><span id="l7.147">   }</span>
<a href="#l7.148"></a><span id="l7.148"> </span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-  result = (char *)PR_Malloc(size + 1);</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-  if (!result)</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-  {</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-    PR_Free(names);</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-    PR_Free(addrs);</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-    return 0;</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-  }</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+  nsCString result;</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+  result.SetLength(size);</span>
<a href="#l7.158"></a><span id="l7.158"> </span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-  out = result;</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+  out = result.BeginWriting();</span>
<a href="#l7.161"></a><span id="l7.161">   s1 = names;</span>
<a href="#l7.162"></a><span id="l7.162">   s2 = addrs;</span>
<a href="#l7.163"></a><span id="l7.163">   for (i = 0; (int)i &lt; status; i++)</span>
<a href="#l7.164"></a><span id="l7.164">   {</span>
<a href="#l7.165"></a><span id="l7.165">     len1 = strlen(s1);</span>
<a href="#l7.166"></a><span id="l7.166">     len2 = strlen(s2);</span>
<a href="#l7.167"></a><span id="l7.167"> </span>
<a href="#l7.168"></a><span id="l7.168">     if (len1)</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineat">@@ -1205,61 +1191,65 @@ msg_extract_Header_address_names(const c</span>
<a href="#l7.170"></a><span id="l7.170">       out += len1;</span>
<a href="#l7.171"></a><span id="l7.171">     }</span>
<a href="#l7.172"></a><span id="l7.172">     else</span>
<a href="#l7.173"></a><span id="l7.173">     {</span>
<a href="#l7.174"></a><span id="l7.174">       memcpy(out, s2, len2);</span>
<a href="#l7.175"></a><span id="l7.175">       out += len2;</span>
<a href="#l7.176"></a><span id="l7.176">     }</span>
<a href="#l7.177"></a><span id="l7.177"> </span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-    if ((int)(i+1) &lt; status)</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+    if ((int)(i + 1) &lt; status)</span>
<a href="#l7.180"></a><span id="l7.180">     {</span>
<a href="#l7.181"></a><span id="l7.181">       *out++ = ',';</span>
<a href="#l7.182"></a><span id="l7.182">       *out++ = ' ';</span>
<a href="#l7.183"></a><span id="l7.183">     }</span>
<a href="#l7.184"></a><span id="l7.184">     s1 += len1 + 1;</span>
<a href="#l7.185"></a><span id="l7.185">     s2 += len2 + 1;</span>
<a href="#l7.186"></a><span id="l7.186">   }</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-  *out = 0;</span>
<a href="#l7.188"></a><span id="l7.188"> </span>
<a href="#l7.189"></a><span id="l7.189">   PR_Free(names);</span>
<a href="#l7.190"></a><span id="l7.190">   PR_Free(addrs);</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-  return result;</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+  aResult = result;</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.194"></a><span id="l7.194"> }</span>
<a href="#l7.195"></a><span id="l7.195"> </span>
<a href="#l7.196"></a><span id="l7.196"> /* msg_extract_Header_address_name</span>
<a href="#l7.197"></a><span id="l7.197">  *</span>
<a href="#l7.198"></a><span id="l7.198">  * Like MSG_ExtractHeaderAddressNames(), but only returns the first name</span>
<a href="#l7.199"></a><span id="l7.199">  * in the list, if there is more than one.</span>
<a href="#l7.200"></a><span id="l7.200">  */</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineminus">-static char *</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineminus">-msg_extract_Header_address_name(const char *line)</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+nsMsgHeaderParser::ExtractHeaderAddressName(const nsACString &amp;aLine,</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+                                            nsACString &amp;aResult)</span>
<a href="#l7.206"></a><span id="l7.206"> {</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+  if (aLine.IsEmpty())</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+  {</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+    aResult.Truncate();</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+    return NS_OK;</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+  }</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+</span>
<a href="#l7.213"></a><span id="l7.213">   char *name = 0;</span>
<a href="#l7.214"></a><span id="l7.214">   char *addr = 0;</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineminus">-  int status = msg_parse_Header_addresses(line, &amp;name, &amp;addr, PR_FALSE, PR_FALSE, PR_TRUE);</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+  int status = msg_parse_Header_addresses(PromiseFlatCString(aLine).get(),</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+                                          &amp;name, &amp;addr, PR_FALSE, PR_FALSE,</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+                                          PR_TRUE);</span>
<a href="#l7.219"></a><span id="l7.219">   if (status &lt;= 0)</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineminus">-    return 0;</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l7.222"></a><span id="l7.222"> </span>
<a href="#l7.223"></a><span id="l7.223">   /* This can happen if there is an address like &quot;From: foo bar&quot; which</span>
<a href="#l7.224"></a><span id="l7.224">    * we parse as two addresses (that's a syntax error.)  In that case,</span>
<a href="#l7.225"></a><span id="l7.225">    * we'll return just the first one (the rest is after the NULL.)</span>
<a href="#l7.226"></a><span id="l7.226">    *</span>
<a href="#l7.227"></a><span id="l7.227">    * NS_ASSERTION(status == 1);</span>
<a href="#l7.228"></a><span id="l7.228">    */</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-  if (name &amp;&amp; *name)</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineminus">-  {</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-    FREEIF(addr);</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-    return name;</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-  }</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineminus">-  else</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineminus">-  {</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineminus">-    FREEIF(name);</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineminus">-    return addr;</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineminus">-  }</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+  aResult = (name &amp;&amp; *name) ? name : addr;</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+  PR_Free(name);</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+  PR_Free(addr);</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.244"></a><span id="l7.244"> }</span>
<a href="#l7.245"></a><span id="l7.245"> </span>
<a href="#l7.246"></a><span id="l7.246"> /* msg_format_Header_addresses</span>
<a href="#l7.247"></a><span id="l7.247">  */</span>
<a href="#l7.248"></a><span id="l7.248"> static char *</span>
<a href="#l7.249"></a><span id="l7.249"> msg_format_Header_addresses (const char *names, const char *addrs,</span>
<a href="#l7.250"></a><span id="l7.250">                int count, PRBool wrap_lines_p)</span>
<a href="#l7.251"></a><span id="l7.251"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_nsIMsgHeaderParser2.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_nsIMsgHeaderParser2.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,37 +1,68 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l8.5"></a><span id="l8.5"> /*</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">- * Test suite for nsIMsgHeaderParser functions.</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ * Test suite for nsIMsgHeaderParser functions:</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+ *   extractHeaderAddressMailboxes</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+ *   extractHeaderAddressNames</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+ *   extractHeaderAddressName</span>
<a href="#l8.11"></a><span id="l8.11">  */</span>
<a href="#l8.12"></a><span id="l8.12"> </span>
<a href="#l8.13"></a><span id="l8.13"> function run_test() {</span>
<a href="#l8.14"></a><span id="l8.14">   var i;</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16">   var parser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l8.17"></a><span id="l8.17">                          .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+  // In this array, the sub arrays consist of the following elements:</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+  // 0: input string</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+  // 1: expected output from extractHeaderAddressMailboxes</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+  // 2: expected output from extractHeaderAddressNames</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+  // 3: expected output from extractHeaderAddressName</span>
<a href="#l8.24"></a><span id="l8.24">   const checks =</span>
<a href="#l8.25"></a><span id="l8.25">   [</span>
<a href="#l8.26"></a><span id="l8.26">     [&quot;abc@invalid.com&quot;,</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+     &quot;abc@invalid.com&quot;,</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+     &quot;abc@invalid.com&quot;,</span>
<a href="#l8.29"></a><span id="l8.29">      &quot;abc@invalid.com&quot; ],</span>
<a href="#l8.30"></a><span id="l8.30">     [&quot;foo &lt;ghj@invalid.com&gt;&quot;,</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-     &quot;ghj@invalid.com&quot;],</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+     &quot;ghj@invalid.com&quot;,</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+     &quot;foo&quot;,</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+     &quot;foo&quot; ],</span>
<a href="#l8.35"></a><span id="l8.35">     [&quot;abc@invalid.com, foo &lt;ghj@invalid.com&gt;&quot;,</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-     &quot;abc@invalid.com, ghj@invalid.com&quot;],</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+     &quot;abc@invalid.com, ghj@invalid.com&quot;,</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+     &quot;abc@invalid.com, foo&quot;,</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+     &quot;abc@invalid.com&quot; ],</span>
<a href="#l8.40"></a><span id="l8.40">     [&quot;foo bar &lt;foo@bar.invalid&gt;&quot;,</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-     &quot;foo@bar.invalid&quot;],</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+     &quot;foo@bar.invalid&quot;,</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+     &quot;foo bar&quot;,</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+     &quot;foo bar&quot; ],</span>
<a href="#l8.45"></a><span id="l8.45">     [&quot;foo bar &lt;foo@bar.invalid&gt;, abc@invalid.com, foo &lt;ghj@invalid.com&gt;&quot;,</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-     &quot;foo@bar.invalid, abc@invalid.com, ghj@invalid.com&quot;],</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+     &quot;foo@bar.invalid, abc@invalid.com, ghj@invalid.com&quot;,</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+     &quot;foo bar, abc@invalid.com, foo&quot;,</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+     &quot;foo bar&quot; ],</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+    // UTF-8 names</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+    [&quot;foo\u00D0 bar &lt;foo@bar.invalid&gt;, \u00F6foo &lt;ghj@invalid.com&gt;&quot;,</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+     &quot;foo@bar.invalid, ghj@invalid.com&quot;,</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+     &quot;foo\u00D0 bar, \u00F6foo&quot;,</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+     &quot;foo\u00D0 bar&quot; ],</span>
<a href="#l8.55"></a><span id="l8.55">     // More complicated examples drawn from RFC 2822</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-    [&quot;Test &lt;\&quot;abc!x.yz\&quot;@invalid.com&gt;, Test &lt;test@[xyz!]&gt;,\&quot;Joe Q. Public\&quot; &lt;john.q.public@example.com&gt;,\&quot;Giant; \\\&quot;Big\\\&quot; Box\&quot; &lt;sysservices@example.net&gt;&quot;,</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-     &quot;\&quot;abc!x.yz\&quot;@invalid.com, test@[xyz!], john.q.public@example.com, sysservices@example.net&quot;],</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+    [&quot;\&quot;Joe Q. Public\&quot; &lt;john.q.public@example.com&gt;,Test &lt;\&quot;abc!x.yz\&quot;@invalid.com&gt;, Test &lt;test@[xyz!]&gt;,\&quot;Giant; \\\&quot;Big\\\&quot; Box\&quot; &lt;sysservices@example.net&gt;&quot;,</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+     &quot;john.q.public@example.com, \&quot;abc!x.yz\&quot;@invalid.com, test@[xyz!], sysservices@example.net&quot;,</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+     &quot;\&quot;Joe Q. Public\&quot;, Test, Test, \&quot;Giant; \\\&quot;Big\\\&quot; Box\&quot;&quot;,</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+     // extractHeaderAddressName returns unquoted names, hence the difference.</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+     &quot;Joe Q. Public&quot; ],</span>
<a href="#l8.63"></a><span id="l8.63">   ];</span>
<a href="#l8.64"></a><span id="l8.64"> </span>
<a href="#l8.65"></a><span id="l8.65">   // Test - empty strings</span>
<a href="#l8.66"></a><span id="l8.66"> </span>
<a href="#l8.67"></a><span id="l8.67">   do_check_eq(parser.extractHeaderAddressMailboxes(&quot;&quot;), &quot;&quot;);</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+  do_check_eq(parser.extractHeaderAddressNames(&quot;&quot;), &quot;&quot;);</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+  do_check_eq(parser.extractHeaderAddressName(&quot;&quot;), &quot;&quot;);</span>
<a href="#l8.70"></a><span id="l8.70"> </span>
<a href="#l8.71"></a><span id="l8.71">   // Test - extractHeaderAddressMailboxes</span>
<a href="#l8.72"></a><span id="l8.72"> </span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-  for (i = 0; i &lt; checks.length; ++i)</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+  for (i = 0; i &lt; checks.length; ++i) {</span>
<a href="#l8.75"></a><span id="l8.75">     do_check_eq(parser.extractHeaderAddressMailboxes(checks[i][0]), checks[i][1]);</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+    do_check_eq(parser.extractHeaderAddressNames(checks[i][0]), checks[i][2]);</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+    do_check_eq(parser.extractHeaderAddressName(checks[i][0]), checks[i][3]);</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+  }</span>
<a href="#l8.79"></a><span id="l8.79"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

