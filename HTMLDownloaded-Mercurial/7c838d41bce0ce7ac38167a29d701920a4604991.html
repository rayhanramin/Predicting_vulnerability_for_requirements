<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 16051:7c838d41bce0ce7ac38167a29d701920a4604991</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 7c838d41bce0ce7ac38167a29d701920a4604991" />
<meta property="og:url" content="/comm-central/rev/7c838d41bce0ce7ac38167a29d701920a4604991" />
<meta property="og:description" content="Bug 441437 - Enable folder lookup without directly using RDF, r=rkent" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 7c838d41bce0ce7ac38167a29d701920a4604991 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/7c838d41bce0ce7ac38167a29d701920a4604991">shortlog</a> |
<a href="/comm-central/log/7c838d41bce0ce7ac38167a29d701920a4604991">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/7c838d41bce0ce7ac38167a29d701920a4604991">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/7c838d41bce0ce7ac38167a29d701920a4604991">files</a> |
changeset |
<a href="/comm-central/raw-rev/7c838d41bce0ce7ac38167a29d701920a4604991">raw</a>  | <a href="/comm-central/archive/7c838d41bce0ce7ac38167a29d701920a4604991.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=441437">Bug 441437</a> - Enable folder lookup without directly using RDF, r=rkent
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#115;&#104;&#117;&#97;&#32;&#67;&#114;&#97;&#110;&#109;&#101;&#114;&#32;&#60;&#80;&#105;&#100;&#103;&#101;&#111;&#116;&#49;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 20 Apr 2014 12:38:54 -0500</td></tr>

<tr>
 <td>changeset 16051</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/7c838d41bce0ce7ac38167a29d701920a4604991">7c838d41bce0ce7ac38167a29d701920a4604991</a></td>
</tr>



<tr>
<td>parent 16050</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d3e56e118e43d5a1c676aadfa25d98915b6135f4">d3e56e118e43d5a1c676aadfa25d98915b6135f4</a>
</td>
</tr>

<tr>
<td>child 16052</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2fd4762ea2bb6ec40be6758812fd1044ccbcf232">2fd4762ea2bb6ec40be6758812fd1044ccbcf232</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=7c838d41bce0ce7ac38167a29d701920a4604991">10051</a></td></tr>
<tr><td>push user</td><td>Pidgeot18@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Sun, 20 Apr 2014 17:41:33 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@7c838d41bce0 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7c838d41bce0ce7ac38167a29d701920a4604991">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7c838d41bce0ce7ac38167a29d701920a4604991&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7c838d41bce0ce7ac38167a29d701920a4604991&newProject=comm-central&newRevision=7c838d41bce0ce7ac38167a29d701920a4604991&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7c838d41bce0ce7ac38167a29d701920a4604991&newProject=comm-central&newRevision=7c838d41bce0ce7ac38167a29d701920a4604991&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7c838d41bce0ce7ac38167a29d701920a4604991&newProject=comm-central&newRevision=7c838d41bce0ce7ac38167a29d701920a4604991&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28rkent%29&revcount=50">rkent</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=441437">441437</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=441437">Bug 441437</a> - Enable folder lookup without directly using RDF, r=rkent

While the folder lookup here still uses RDF internally to find folders in the
first place, this allows us to both hide RDF's idiosyncracies from most users
and replace the lookup mechanism with a more principled variant later without
needing to rewrite many callsites.

(CLOSED TREE for SeaMonkey's manifest)</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7c838d41bce0ce7ac38167a29d701920a4604991/mail/installer/package-manifest.in">mail/installer/package-manifest.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7c838d41bce0ce7ac38167a29d701920a4604991/mail/installer/package-manifest.in">file</a> |
<a href="/comm-central/annotate/7c838d41bce0ce7ac38167a29d701920a4604991/mail/installer/package-manifest.in">annotate</a> |
<a href="/comm-central/diff/7c838d41bce0ce7ac38167a29d701920a4604991/mail/installer/package-manifest.in">diff</a> |
<a href="/comm-central/comparison/7c838d41bce0ce7ac38167a29d701920a4604991/mail/installer/package-manifest.in">comparison</a> |
<a href="/comm-central/log/7c838d41bce0ce7ac38167a29d701920a4604991/mail/installer/package-manifest.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/public/nsIFolderLookupService.idl">mailnews/base/public/nsIFolderLookupService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/public/nsIFolderLookupService.idl">file</a> |
<a href="/comm-central/annotate/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/public/nsIFolderLookupService.idl">annotate</a> |
<a href="/comm-central/diff/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/public/nsIFolderLookupService.idl">diff</a> |
<a href="/comm-central/comparison/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/public/nsIFolderLookupService.idl">comparison</a> |
<a href="/comm-central/log/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/public/nsIFolderLookupService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/src/folderLookupService.js">mailnews/base/src/folderLookupService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/src/folderLookupService.js">file</a> |
<a href="/comm-central/annotate/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/src/folderLookupService.js">annotate</a> |
<a href="/comm-central/diff/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/src/folderLookupService.js">diff</a> |
<a href="/comm-central/comparison/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/src/folderLookupService.js">comparison</a> |
<a href="/comm-central/log/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/src/folderLookupService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/src/moz.build">mailnews/base/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/src/moz.build">file</a> |
<a href="/comm-central/annotate/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/src/moz.build">annotate</a> |
<a href="/comm-central/diff/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/src/moz.build">diff</a> |
<a href="/comm-central/comparison/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/src/moz.build">comparison</a> |
<a href="/comm-central/log/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/src/msgBase.manifest">mailnews/base/src/msgBase.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/src/msgBase.manifest">file</a> |
<a href="/comm-central/annotate/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/src/msgBase.manifest">annotate</a> |
<a href="/comm-central/diff/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/src/msgBase.manifest">diff</a> |
<a href="/comm-central/comparison/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/src/msgBase.manifest">comparison</a> |
<a href="/comm-central/log/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/src/msgBase.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/test/unit/test_folderLookupService.js">mailnews/base/test/unit/test_folderLookupService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/test/unit/test_folderLookupService.js">file</a> |
<a href="/comm-central/annotate/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/test/unit/test_folderLookupService.js">annotate</a> |
<a href="/comm-central/diff/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/test/unit/test_folderLookupService.js">diff</a> |
<a href="/comm-central/comparison/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/test/unit/test_folderLookupService.js">comparison</a> |
<a href="/comm-central/log/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/test/unit/test_folderLookupService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/test/unit/xpcshell.ini">mailnews/base/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/util/nsMsgUtils.cpp">mailnews/base/util/nsMsgUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/util/nsMsgUtils.cpp">file</a> |
<a href="/comm-central/annotate/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/util/nsMsgUtils.cpp">annotate</a> |
<a href="/comm-central/diff/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/util/nsMsgUtils.cpp">diff</a> |
<a href="/comm-central/comparison/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/util/nsMsgUtils.cpp">comparison</a> |
<a href="/comm-central/log/7c838d41bce0ce7ac38167a29d701920a4604991/mailnews/base/util/nsMsgUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7c838d41bce0ce7ac38167a29d701920a4604991/suite/installer/package-manifest.in">suite/installer/package-manifest.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7c838d41bce0ce7ac38167a29d701920a4604991/suite/installer/package-manifest.in">file</a> |
<a href="/comm-central/annotate/7c838d41bce0ce7ac38167a29d701920a4604991/suite/installer/package-manifest.in">annotate</a> |
<a href="/comm-central/diff/7c838d41bce0ce7ac38167a29d701920a4604991/suite/installer/package-manifest.in">diff</a> |
<a href="/comm-central/comparison/7c838d41bce0ce7ac38167a29d701920a4604991/suite/installer/package-manifest.in">comparison</a> |
<a href="/comm-central/log/7c838d41bce0ce7ac38167a29d701920a4604991/suite/installer/package-manifest.in">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/installer/package-manifest.in</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/installer/package-manifest.in</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -154,16 +154,17 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #endif</span>
<a href="#l1.5"></a><span id="l1.5"> @BINPATH@/components/aboutRedirector.js</span>
<a href="#l1.6"></a><span id="l1.6"> @BINPATH@/components/activity.xpt</span>
<a href="#l1.7"></a><span id="l1.7"> @BINPATH@/components/activityComponents.manifest</span>
<a href="#l1.8"></a><span id="l1.8"> @BINPATH@/components/cloudFileComponents.manifest</span>
<a href="#l1.9"></a><span id="l1.9"> @BINPATH@/components/cloudfile.xpt</span>
<a href="#l1.10"></a><span id="l1.10"> @BINPATH@/components/addrbook.xpt</span>
<a href="#l1.11"></a><span id="l1.11"> @BINPATH@/components/fts3tok.xpt</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+@BINPATH@/components/folderLookupService.js</span>
<a href="#l1.13"></a><span id="l1.13"> ; interfaces.manifest doesn't get packaged because it is dynamically</span>
<a href="#l1.14"></a><span id="l1.14"> ; re-created at packaging time when linking the xpts that will actually</span>
<a href="#l1.15"></a><span id="l1.15"> ; go into the package, so the test related interfaces aren't included.</span>
<a href="#l1.16"></a><span id="l1.16"> @BINPATH@/components/mime.xpt</span>
<a href="#l1.17"></a><span id="l1.17"> @BINPATH@/components/mimeJSComponents.js</span>
<a href="#l1.18"></a><span id="l1.18"> @BINPATH@/components/msgMime.manifest</span>
<a href="#l1.19"></a><span id="l1.19"> @BINPATH@/components/steel.xpt</span>
<a href="#l1.20"></a><span id="l1.20"> @BINPATH@/components/msgAsyncPrompter.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/public/nsIFolderLookupService.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/public/nsIFolderLookupService.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,22 +1,35 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.5"></a><span id="l2.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.6"></a><span id="l2.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> interface nsIMsgFolder;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-[scriptable,uuid(a1aaa404-9be7-461f-a715-e92512729923)]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+/**</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+ * This service provides a way to lookup any nsIMsgFolder.</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+ *</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+ * When looking up folders by URL, note that the URL must be encoded to be a</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+ * valid folder URL. Of particular note are the following requirements:</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+ * - invalid characters in paths must be percent-encoded</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+ * - the URL MUST NOT have a trailing slash (excepting root folders)</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+ * - the case must match the expected value exactly</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+ * An example of a valid URL is thus:</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+ * imap://someuser%40google.com@imap.google.com/INBOX</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+ *</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+ * The contractid for this service is &quot;@mozilla.org/mail/folder-lookup;1&quot;.</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+ */</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+[scriptable,uuid(f5ed5997-3945-48fc-a59d-d2191a94bb60)]</span>
<a href="#l2.27"></a><span id="l2.27"> interface nsIFolderLookupService : nsISupports</span>
<a href="#l2.28"></a><span id="l2.28"> {</span>
<a href="#l2.29"></a><span id="l2.29">   /**</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-   * Returns a folder with the given id. If the folder does not exist, but an</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-   * identifiable parent does, we'll create it and then return that folder. If</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-   * no parent exists, this will return null.</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+   * Returns a folder with the given URL or null if no such folder exists.</span>
<a href="#l2.34"></a><span id="l2.34">    *</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-   * @note For the moment, the id is the URI property of the folder.  This may</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-   *       change</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+   * @param aUrl The folder URL</span>
<a href="#l2.38"></a><span id="l2.38">    */</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-  nsIMsgFolder getFolderById(in ACString id);</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+  nsIMsgFolder getFolderForURL(in ACString aUrl);</span>
<a href="#l2.41"></a><span id="l2.41"> };</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+%{C++</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+#define NSIFLS_CONTRACTID &quot;@mozilla.org/mail/folder-lookup;1&quot;</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+%}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/mailnews/base/src/folderLookupService.js</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,96 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+/**</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+ * This module implements the folder lookup service. Presently, this uses RDF as</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+ * the backing store, but the intent is that this will eventually become the</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+ * authoritative map.</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ */</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+function isValidFolder(folder) {</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+  // RDF is liable to return folders that don't exist, and we may be working</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+  // with a deleted folder but we're still holding on to the reference. For</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+  // valid folders, one of two scenarios is true: either the folder has a parent</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+  // (the deletion code clears the parent to indicate its nonvalidity), or the</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+  // folder is a root folder of some server. Getting the root folder may throw</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+  // an exception if we attempted to create a server that doesn't exist, so we</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  // need to guard for that error.</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  try {</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+    return folder.parent != null || folder.rootFolder == folder;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  } catch (e) {</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+    return false;</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+  }</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+}</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+// This insures that the service is only created once</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+var gCreated = false;</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+function folderLookupService() {</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+  this._map = new Map();</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+  if (gCreated)</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+    throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+  gCreated = true;</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+}</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+folderLookupService.prototype = {</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+  // XPCOM registration stuff</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.nsIFolderLookupService]),</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+  classID: Components.ID(&quot;{a30be08c-afc8-4fed-9af7-79778a23db23}&quot;),</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+  // nsIFolderLookupService impl</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+  getFolderForURL: function (aUrl) {</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+    let folder = null;</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+    // First, see if the folder is in our cache.</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+    if (this._map.has(aUrl)) {</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+      let valid = false;</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+      try {</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+        folder = this._map.get(aUrl).QueryReferent(Ci.nsIMsgFolder);</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+        valid = isValidFolder(folder);</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+      } catch (e) {</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+        // The object was deleted, so it's not valid</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+      }</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+      if (!valid) {</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+        // Don't keep around invalid folders.</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+        this._map.delete(aUrl);</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+        folder = null;</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+      }</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+    }</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+    // If we get here, then the folder was not in our map. It could be that the</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+    // folder was created by somebody else, so try to find that folder.</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+    // For now, we use the RDF service, since it results in minimal changes. But</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+    // RDF has a tendency to create objects without checking to see if they</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+    // really exist---use the parent property to see if the folder is a real</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+    // folder.</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+    if (folder == null) {</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+      let rdf = Cc[&quot;@mozilla.org/rdf/rdf-service;1&quot;]</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+                  .getService(Ci.nsIRDFService);</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+      try {</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+        folder = rdf.GetResource(aUrl)</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+                    .QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+      } catch (e) {</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+        // If the QI fails, then we somehow picked up an RDF resource that isn't</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+        // a folder. Return null in this case.</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+        return null;</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+      }</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+    }</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+    if (!isValidFolder(folder))</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+      return null;</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+    // Add the new folder to our map. Store a weak reference instead, so that</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+    // the folder can be closed when necessary.</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+    let weakRef = folder.QueryInterface(Ci.nsISupportsWeakReference)</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+                        .GetWeakReference();</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+    this._map.set(aUrl, weakRef);</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+    return folder;</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+  },</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+};</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([folderLookupService]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/src/moz.build</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/src/moz.build</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -60,16 +60,17 @@ if CONFIG['OS_ARCH'] == 'WINNT':</span>
<a href="#l4.4"></a><span id="l4.4">     SOURCES += ['nsMessengerWinIntegration.cpp']</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> if CONFIG['MOZ_WIDGET_TOOLKIT'] == 'gtk2':</span>
<a href="#l4.7"></a><span id="l4.7">     SOURCES += ['nsMessengerUnixIntegration.cpp']</span>
<a href="#l4.8"></a><span id="l4.8"> elif CONFIG['MOZ_WIDGET_TOOLKIT'] == 'cocoa':</span>
<a href="#l4.9"></a><span id="l4.9">     SOURCES += ['nsMessengerOSXIntegration.mm']</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> EXTRA_COMPONENTS += [</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+    'folderLookupService.js',</span>
<a href="#l4.13"></a><span id="l4.13">     'msgAsyncPrompter.js',</span>
<a href="#l4.14"></a><span id="l4.14">     'msgBase.manifest',</span>
<a href="#l4.15"></a><span id="l4.15">     'newMailNotificationService.js',</span>
<a href="#l4.16"></a><span id="l4.16">     'nsMailNewsCommandLineHandler.js',</span>
<a href="#l4.17"></a><span id="l4.17"> ]</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> EXTRA_JS_MODULES += [</span>
<a href="#l4.20"></a><span id="l4.20">     'virtualFolderWrapper.js',</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/src/msgBase.manifest</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/src/msgBase.manifest</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,8 +1,10 @@</span>
<a href="#l5.4"></a><span id="l5.4"> component {49b04761-23dd-45d7-903d-619418a4d319} msgAsyncPrompter.js</span>
<a href="#l5.5"></a><span id="l5.5"> contract @mozilla.org/messenger/msgAsyncPrompter;1 {49b04761-23dd-45d7-903d-619418a4d319}</span>
<a href="#l5.6"></a><span id="l5.6"> component {2f86d554-f9d9-4e76-8eb7-243f047333ee} nsMailNewsCommandLineHandler.js</span>
<a href="#l5.7"></a><span id="l5.7"> contract @mozilla.org/commandlinehandler/general-startup;1?type=mail {2f86d554-f9d9-4e76-8eb7-243f047333ee}</span>
<a href="#l5.8"></a><span id="l5.8"> category command-line-handler m-mail @mozilla.org/commandlinehandler/general-startup;1?type=mail</span>
<a href="#l5.9"></a><span id="l5.9"> component {740880E6-E299-4165-B82F-DF1DCAB3AE22} newMailNotificationService.js</span>
<a href="#l5.10"></a><span id="l5.10"> contract @mozilla.org/newMailNotificationService;1 {740880E6-E299-4165-B82F-DF1DCAB3AE22}</span>
<a href="#l5.11"></a><span id="l5.11"> category profile-after-change NewMailNotificationService @mozilla.org/newMailNotificationService;1 </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+component {a30be08c-afc8-4fed-9af7-79778a23db23} folderLookupService.js</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+contract @mozilla.org/mail/folder-lookup;1 {a30be08c-afc8-4fed-9af7-79778a23db23}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/mailnews/base/test/unit/test_folderLookupService.js</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,47 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+/**</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+ * This tests that nsIFolderLookupService works acording to specification.</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+ */</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+const kRootURI = &quot;mailbox://nobody@Local%20Folders&quot;;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+function run_test() {</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+  let fls = Components.classes[&quot;@mozilla.org/mail/folder-lookup;1&quot;]</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+                      .getService(Components.interfaces.nsIFolderLookupService);</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+  // Make sure that the local mail account exists.</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+  localAccountUtils.loadLocalMailAccount();</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+  // There should exist an inbox.</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+  do_check_eq(fls.getFolderForURL(kRootURI + &quot;/Inbox&quot;),</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+    localAccountUtils.inboxFolder);</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+  // Can we get the root folder?</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+  let root = localAccountUtils.rootFolder;</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+  do_check_eq(fls.getFolderForURL(kRootURI), root);</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+  // The child folder Child doesn't exist yet... make sure that fls doesn't</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  // return it yet</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+  do_check_eq(fls.getFolderForURL(kRootURI + &quot;/Child&quot;), null);</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+  // Create the folder, and then it should exist.</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+  root.createSubfolder(&quot;Child&quot;, null);</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+  do_check_eq(fls.getFolderForURL(kRootURI + &quot;/Child&quot;),</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+    root.getChildNamed(&quot;Child&quot;));</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+  // Try it again... it should load from cache this time.</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+  do_check_eq(fls.getFolderForURL(kRootURI + &quot;/Child&quot;),</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+    root.getChildNamed(&quot;Child&quot;));</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+  // Now delete the folder; we should be unable to find it</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+  root.propagateDelete(root.getChildNamed(&quot;Child&quot;), true, null);</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+  do_check_eq(fls.getFolderForURL(kRootURI + &quot;/Child&quot;), null);</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+  do_check_eq(fls.getFolderForURL(kRootURI + &quot;/&quot;), null);</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+  do_check_eq(fls.getFolderForURL(&quot;mailbox://idonotexist@Local%20Folders&quot;),</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+    null);</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/test/unit/xpcshell.ini</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/test/unit/xpcshell.ini</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -23,16 +23,17 @@ support-files = nodelist_test.xml data/*</span>
<a href="#l7.4"></a><span id="l7.4"> [test_compactColumnSave.js]</span>
<a href="#l7.5"></a><span id="l7.5"> [test_copyChaining.js]</span>
<a href="#l7.6"></a><span id="l7.6"> [test_copyThenMoveManual.js]</span>
<a href="#l7.7"></a><span id="l7.7"> [test_copyToInvalidDB.js]</span>
<a href="#l7.8"></a><span id="l7.8"> [test_detachToFile.js]</span>
<a href="#l7.9"></a><span id="l7.9"> [test_emptyTrash.js]</span>
<a href="#l7.10"></a><span id="l7.10"> [test_fix_deferred_accounts.js]</span>
<a href="#l7.11"></a><span id="l7.11"> [test_folderCompact.js]</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+[test_folderLookupService.js]</span>
<a href="#l7.13"></a><span id="l7.13"> [test_getMsgTextFromStream.js]</span>
<a href="#l7.14"></a><span id="l7.14"> [test_hostnameUtils.js]</span>
<a href="#l7.15"></a><span id="l7.15"> [test_imapPump.js]</span>
<a href="#l7.16"></a><span id="l7.16"> [test_inheritedFolderProperties.js]</span>
<a href="#l7.17"></a><span id="l7.17"> [test_iteratorUtils.js]</span>
<a href="#l7.18"></a><span id="l7.18"> [test_jsTreeSelection.js]</span>
<a href="#l7.19"></a><span id="l7.19"> [test_junkingWhenDisabled.js]</span>
<a href="#l7.20"></a><span id="l7.20"> [test_junkWhitelisting.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -6,16 +6,17 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #include &quot;msgCore.h&quot;</span>
<a href="#l8.5"></a><span id="l8.5"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+#include &quot;nsIFolderLookupService.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13"> #include &quot;nsIImapUrl.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14"> #include &quot;nsIMailboxUrl.h&quot;</span>
<a href="#l8.15"></a><span id="l8.15"> #include &quot;nsINntpUrl.h&quot;</span>
<a href="#l8.16"></a><span id="l8.16"> #include &quot;nsMsgNewsCID.h&quot;</span>
<a href="#l8.17"></a><span id="l8.17"> #include &quot;nsMsgLocalCID.h&quot;</span>
<a href="#l8.18"></a><span id="l8.18"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l8.19"></a><span id="l8.19"> #include &quot;nsMsgImapCID.h&quot;</span>
<a href="#l8.20"></a><span id="l8.20"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -809,37 +810,23 @@ bool WeAreOffline()</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23"> nsresult GetExistingFolder(const nsCString&amp; aFolderURI, nsIMsgFolder **aFolder)</span>
<a href="#l8.24"></a><span id="l8.24"> {</span>
<a href="#l8.25"></a><span id="l8.25">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27">   *aFolder = nullptr;</span>
<a href="#l8.28"></a><span id="l8.28"> </span>
<a href="#l8.29"></a><span id="l8.29">   nsresult rv;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-  nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv));</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-  nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-  rv = rdf-&gt;GetResource(aFolderURI, getter_AddRefs(resource));</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; thisFolder;</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-  thisFolder = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+  nsCOMPtr&lt;nsIFolderLookupService&gt; fls(do_GetService(NSIFLS_CONTRACTID, &amp;rv));</span>
<a href="#l8.40"></a><span id="l8.40">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.41"></a><span id="l8.41"> </span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-  // Parent doesn't exist means that this folder doesn't exist.</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-  rv = thisFolder-&gt;GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-    // When parentFolder is null with NS_OK, we should return error.</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-    NS_ENSURE_TRUE(parentFolder, NS_ERROR_FAILURE);</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+  rv = fls-&gt;GetFolderForURL(aFolderURI, aFolder);</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.50"></a><span id="l8.50"> </span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-    NS_ADDREF(*aFolder = thisFolder);</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-  }</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-  return rv;</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+  return *aFolder ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l8.55"></a><span id="l8.55"> }</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57"> bool IsAFromSpaceLine(char *start, const char *end)</span>
<a href="#l8.58"></a><span id="l8.58"> {</span>
<a href="#l8.59"></a><span id="l8.59">   bool rv = false;</span>
<a href="#l8.60"></a><span id="l8.60">   while ((start &lt; end) &amp;&amp; (*start == '&gt;'))</span>
<a href="#l8.61"></a><span id="l8.61">     start++;</span>
<a href="#l8.62"></a><span id="l8.62">   // If the leading '&gt;'s are followed by an 'F' then we have a possible case here.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/suite/installer/package-manifest.in</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/suite/installer/package-manifest.in</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -359,16 +359,17 @@</span>
<a href="#l9.4"></a><span id="l9.4"> @BINPATH@/components/crypto-SDR.js</span>
<a href="#l9.5"></a><span id="l9.5"> @BINPATH@/components/cryptoComponents.manifest</span>
<a href="#l9.6"></a><span id="l9.6"> @BINPATH@/components/Downloads.manifest</span>
<a href="#l9.7"></a><span id="l9.7"> @BINPATH@/components/DownloadLegacy.js</span>
<a href="#l9.8"></a><span id="l9.8"> @BINPATH@/components/FeedConverter.js</span>
<a href="#l9.9"></a><span id="l9.9"> @BINPATH@/components/FeedProcessor.js</span>
<a href="#l9.10"></a><span id="l9.10"> @BINPATH@/components/FeedProcessor.manifest</span>
<a href="#l9.11"></a><span id="l9.11"> @BINPATH@/components/FeedWriter.js</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+@BINPATH@/components/folderLookupService.js</span>
<a href="#l9.13"></a><span id="l9.13"> @BINPATH@/components/Identity.manifest</span>
<a href="#l9.14"></a><span id="l9.14"> @BINPATH@/components/jsconsole-clhandler.js</span>
<a href="#l9.15"></a><span id="l9.15"> @BINPATH@/components/jsconsole-clhandler.manifest</span>
<a href="#l9.16"></a><span id="l9.16"> @BINPATH@/components/messageWakeupService.js</span>
<a href="#l9.17"></a><span id="l9.17"> @BINPATH@/components/messageWakeupService.manifest</span>
<a href="#l9.18"></a><span id="l9.18"> @BINPATH@/components/NetworkGeolocationProvider.js</span>
<a href="#l9.19"></a><span id="l9.19"> @BINPATH@/components/NetworkGeolocationProvider.manifest</span>
<a href="#l9.20"></a><span id="l9.20"> @BINPATH@/components/nsAbout.js</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

