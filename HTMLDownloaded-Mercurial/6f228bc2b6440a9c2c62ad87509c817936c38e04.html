<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 848:6f228bc2b6440a9c2c62ad87509c817936c38e04</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 6f228bc2b6440a9c2c62ad87509c817936c38e04" />
<meta property="og:url" content="/comm-central/rev/6f228bc2b6440a9c2c62ad87509c817936c38e04" />
<meta property="og:description" content="now msgAdded, msgsMoveCopyCompleted, folderDeleted," />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 6f228bc2b6440a9c2c62ad87509c817936c38e04 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/6f228bc2b6440a9c2c62ad87509c817936c38e04">shortlog</a> |
<a href="/comm-central/log/6f228bc2b6440a9c2c62ad87509c817936c38e04">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/6f228bc2b6440a9c2c62ad87509c817936c38e04">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/6f228bc2b6440a9c2c62ad87509c817936c38e04">files</a> |
changeset |
<a href="/comm-central/raw-rev/6f228bc2b6440a9c2c62ad87509c817936c38e04">raw</a>  | <a href="/comm-central/archive/6f228bc2b6440a9c2c62ad87509c817936c38e04.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
now msgAdded, msgsMoveCopyCompleted, folderDeleted,
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 17 Jul 2008 16:54:36 -0700</td></tr>

<tr>
 <td>changeset 848</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/6f228bc2b6440a9c2c62ad87509c817936c38e04">6f228bc2b6440a9c2c62ad87509c817936c38e04</a></td>
</tr>



<tr>
<td>parent 847</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c8defd267c7698566578b4536b40153af2cbd2f7">c8defd267c7698566578b4536b40153af2cbd2f7</a>
</td>
</tr>

<tr>
<td>child 849</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/06a587271bec60ac1991dffe8252de46910e5d37">06a587271bec60ac1991dffe8252de46910e5d37</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=6f228bc2b6440a9c2c62ad87509c817936c38e04">743</a></td></tr>
<tr><td>push user</td><td>dmosedale@mozilla.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 04 Nov 2008 20:01:44 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a79b923a9cba [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">now msgAdded, msgsMoveCopyCompleted, folderDeleted,
folderMoveCopyCompleted (for move), and folderRenamed are believed to work.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6f228bc2b6440a9c2c62ad87509c817936c38e04/modules/datastore.js">modules/datastore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6f228bc2b6440a9c2c62ad87509c817936c38e04/modules/datastore.js">file</a> |
<a href="/comm-central/annotate/6f228bc2b6440a9c2c62ad87509c817936c38e04/modules/datastore.js">annotate</a> |
<a href="/comm-central/diff/6f228bc2b6440a9c2c62ad87509c817936c38e04/modules/datastore.js">diff</a> |
<a href="/comm-central/comparison/6f228bc2b6440a9c2c62ad87509c817936c38e04/modules/datastore.js">comparison</a> |
<a href="/comm-central/log/6f228bc2b6440a9c2c62ad87509c817936c38e04/modules/datastore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6f228bc2b6440a9c2c62ad87509c817936c38e04/modules/indexer.js">modules/indexer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6f228bc2b6440a9c2c62ad87509c817936c38e04/modules/indexer.js">file</a> |
<a href="/comm-central/annotate/6f228bc2b6440a9c2c62ad87509c817936c38e04/modules/indexer.js">annotate</a> |
<a href="/comm-central/diff/6f228bc2b6440a9c2c62ad87509c817936c38e04/modules/indexer.js">diff</a> |
<a href="/comm-central/comparison/6f228bc2b6440a9c2c62ad87509c817936c38e04/modules/indexer.js">comparison</a> |
<a href="/comm-central/log/6f228bc2b6440a9c2c62ad87509c817936c38e04/modules/indexer.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/modules/datastore.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/modules/datastore.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -751,17 +751,17 @@ let GlodaDatastore = {</span>
<a href="#l1.4"></a><span id="l1.4">   getMessageIDsByFolderID:</span>
<a href="#l1.5"></a><span id="l1.5">       function gloda_ds_getMessageIDsFromFolderID(aFolderID) {</span>
<a href="#l1.6"></a><span id="l1.6">     let messageIDs = [];</span>
<a href="#l1.7"></a><span id="l1.7">     </span>
<a href="#l1.8"></a><span id="l1.8">     let smidbfs = this._selectMessageIDsByFolderStatement;</span>
<a href="#l1.9"></a><span id="l1.9">     smidbfs.params.folderID = aFolderID;</span>
<a href="#l1.10"></a><span id="l1.10">     </span>
<a href="#l1.11"></a><span id="l1.11">     while (smidbfs.step()) {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-      smidbfs.push(smidbfs.row[&quot;id&quot;]);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+      messageIDs.push(smidbfs.row[&quot;id&quot;]);</span>
<a href="#l1.14"></a><span id="l1.14">     }</span>
<a href="#l1.15"></a><span id="l1.15">     smidbfs.reset();</span>
<a href="#l1.16"></a><span id="l1.16">     </span>
<a href="#l1.17"></a><span id="l1.17">     return messageIDs;</span>
<a href="#l1.18"></a><span id="l1.18">   },</span>
<a href="#l1.19"></a><span id="l1.19">   </span>
<a href="#l1.20"></a><span id="l1.20">   /**</span>
<a href="#l1.21"></a><span id="l1.21">    * Given a list of Message-ID's, return a matching list of lists of messages</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/modules/indexer.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/modules/indexer.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -188,17 +188,17 @@ let GlodaIndexer = {</span>
<a href="#l2.4"></a><span id="l2.4">   },</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">   /** Track whether indexing is active (we have timers in-flight). */</span>
<a href="#l2.7"></a><span id="l2.7">   _indexingActive: false,</span>
<a href="#l2.8"></a><span id="l2.8">   get indexing() { return this._indexingActive; },</span>
<a href="#l2.9"></a><span id="l2.9">   /** You can turn on indexing, but you can't turn it off! */</span>
<a href="#l2.10"></a><span id="l2.10">   set indexing(aShouldIndex) {</span>
<a href="#l2.11"></a><span id="l2.11">     if (!this._indexingActive &amp;&amp; aShouldIndex) {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-      this._log.info(&quot;Indexing Queue Processing Commencing&quot;);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+      this._log.info(&quot;+++ Indexing Queue Processing Commencing&quot;);</span>
<a href="#l2.14"></a><span id="l2.14">       this._indexingActive = true;</span>
<a href="#l2.15"></a><span id="l2.15">       this._domWindow.setTimeout(this._wrapIncrementalIndex, this._indexInterval, this);</span>
<a href="#l2.16"></a><span id="l2.16">     }  </span>
<a href="#l2.17"></a><span id="l2.17">   },</span>
<a href="#l2.18"></a><span id="l2.18">   </span>
<a href="#l2.19"></a><span id="l2.19">   /**</span>
<a href="#l2.20"></a><span id="l2.20">    * Our current job number, out of _indexingJobGoal.  Although our jobs comes</span>
<a href="#l2.21"></a><span id="l2.21">    *  from _indexQueue, this is not an offset into that list because we forget</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -279,25 +279,22 @@ let GlodaIndexer = {</span>
<a href="#l2.23"></a><span id="l2.23">   },</span>
<a href="#l2.24"></a><span id="l2.24">   removeListener: function gloda_index_removeListener(aListener) {</span>
<a href="#l2.25"></a><span id="l2.25">     let index = this._indexListeners.indexOf(aListener);</span>
<a href="#l2.26"></a><span id="l2.26">     if (index != -1)</span>
<a href="#l2.27"></a><span id="l2.27">       this._indexListeners(index, 1);</span>
<a href="#l2.28"></a><span id="l2.28">   },</span>
<a href="#l2.29"></a><span id="l2.29">   _notifyListeners: function gloda_index_notifyListeners(aStatus, aFolderName,</span>
<a href="#l2.30"></a><span id="l2.30">       aFolderIndex, aFoldersTotal, aMessageIndex, aMessagesTotal) {</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-    this._log.debug(&quot;notifying listeners &gt;&gt;&gt;&quot;);</span>
<a href="#l2.32"></a><span id="l2.32">     for (let iListener=this._indexListeners.length-1; iListener &gt;= 0; </span>
<a href="#l2.33"></a><span id="l2.33">          iListener--) {</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-      this._log.debug(&quot;  listener &quot; + iListener);</span>
<a href="#l2.35"></a><span id="l2.35">       let listener = this._indexListeners[iListener];</span>
<a href="#l2.36"></a><span id="l2.36">       listener(aStatus, aFolderName, aFolderIndex, aFoldersTotal, aMessageIndex,</span>
<a href="#l2.37"></a><span id="l2.37">                aMessagesTotal);</span>
<a href="#l2.38"></a><span id="l2.38">     }</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-    this._log.debug(&quot;done notifying listeners &lt;&lt;&lt;&quot;);</span>
<a href="#l2.40"></a><span id="l2.40">   },</span>
<a href="#l2.41"></a><span id="l2.41">   </span>
<a href="#l2.42"></a><span id="l2.42">   _indexingFolderID: null,</span>
<a href="#l2.43"></a><span id="l2.43">   _indexingFolder: null,</span>
<a href="#l2.44"></a><span id="l2.44">   _indexingDatabase: null,</span>
<a href="#l2.45"></a><span id="l2.45">   _indexingIterator: null,</span>
<a href="#l2.46"></a><span id="l2.46">   </span>
<a href="#l2.47"></a><span id="l2.47">   /**</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineat">@@ -384,17 +381,17 @@ let GlodaIndexer = {</span>
<a href="#l2.49"></a><span id="l2.49">     GlodaDatastore._beginTransaction();</span>
<a href="#l2.50"></a><span id="l2.50">     try {</span>
<a href="#l2.51"></a><span id="l2.51">       let job = this._curIndexingJob;</span>
<a href="#l2.52"></a><span id="l2.52">       for (let tokensLeft=this._indexTokens; tokensLeft &gt; 0; tokensLeft--) {</span>
<a href="#l2.53"></a><span id="l2.53">         // --- Do we need a job?</span>
<a href="#l2.54"></a><span id="l2.54">         if (job === null) {</span>
<a href="#l2.55"></a><span id="l2.55">           // --- Are there any jobs left?</span>
<a href="#l2.56"></a><span id="l2.56">           if (this._indexQueue.length == 0) {</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-            this._log.info(&quot;Done indexing, disabling timer renewal.&quot;);</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+            this._log.info(&quot;--- Done indexing, disabling timer renewal.&quot;);</span>
<a href="#l2.59"></a><span id="l2.59">             this._indexingActive = false;</span>
<a href="#l2.60"></a><span id="l2.60">             this._indexingJobCount = 0;</span>
<a href="#l2.61"></a><span id="l2.61">             this._indexingJobGoal = 0;</span>
<a href="#l2.62"></a><span id="l2.62">             this._notifyListeners(this._strBundle.getString(&quot;actionIdle&quot;), null,</span>
<a href="#l2.63"></a><span id="l2.63">                                   0, 1, 0, 1);</span>
<a href="#l2.64"></a><span id="l2.64">             break;</span>
<a href="#l2.65"></a><span id="l2.65">           }</span>
<a href="#l2.66"></a><span id="l2.66">           </span>
<a href="#l2.67"></a><span id="l2.67" class="difflineat">@@ -450,22 +447,29 @@ let GlodaIndexer = {</span>
<a href="#l2.68"></a><span id="l2.68">                 job.offset++;</span>
<a href="#l2.69"></a><span id="l2.69">               }</span>
<a href="#l2.70"></a><span id="l2.70">               // there is no steady-state processing for folder deletion</span>
<a href="#l2.71"></a><span id="l2.71">             }</span>
<a href="#l2.72"></a><span id="l2.72">             else if (job.jobType == &quot;message&quot;) {</span>
<a href="#l2.73"></a><span id="l2.73">               let item = job.items[job.offset++];</span>
<a href="#l2.74"></a><span id="l2.74">               // -- MESSAGE ADD (batch steady state)</span>
<a href="#l2.75"></a><span id="l2.75">               if (job.deltaType &gt; 0) {</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-                // item must be [folder ID, message key]</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+                // item is either [folder ID, message key] or</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+                //                [folder ID, message ID]</span>
<a href="#l2.79"></a><span id="l2.79"> </span>
<a href="#l2.80"></a><span id="l2.80">                 // get in the folder</span>
<a href="#l2.81"></a><span id="l2.81">                 if (this._indexingFolderID != item[0])</span>
<a href="#l2.82"></a><span id="l2.82">                   this._indexerEnterFolder(item[0], false);</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-                let msgHdr = this._indexingFolder.GetMessageHeader(item[1]);</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+                let msgHdr;</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+                if (typeof item[1] == &quot;number&quot;)</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+                  msgHdr = this._indexingFolder.GetMessageHeader(item[1]);</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+                else</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+                  // same deal as in move processing.</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+                  // TODO fixme to not assume singular message-id's.</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+                  msgHdr = this._indexingDatabase.getMsgHdrForMessageID(item[1]);</span>
<a href="#l2.91"></a><span id="l2.91">                 if (msgHdr)</span>
<a href="#l2.92"></a><span id="l2.92">                   this._indexMessage(msgHdr);</span>
<a href="#l2.93"></a><span id="l2.93">               }</span>
<a href="#l2.94"></a><span id="l2.94">               // -- MESSAGE MOVE (batch steady state)</span>
<a href="#l2.95"></a><span id="l2.95">               else if (job.deltaType == 0) {</span>
<a href="#l2.96"></a><span id="l2.96">                 // item must be [folder ID, header message-id]</span>
<a href="#l2.97"></a><span id="l2.97">                 </span>
<a href="#l2.98"></a><span id="l2.98">                 // get in the folder</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineat">@@ -484,17 +488,17 @@ let GlodaIndexer = {</span>
<a href="#l2.100"></a><span id="l2.100">                     &quot;message-id &quot; + item[1] + &quot;. Folder is known to possess &quot; +</span>
<a href="#l2.101"></a><span id="l2.101">                     this._indexingFolder.getTotalMessages(false) +&quot; messages.&quot;);</span>
<a href="#l2.102"></a><span id="l2.102">                 }</span>
<a href="#l2.103"></a><span id="l2.103">                 // remember to eat extra tokens... when we get more than one...</span>
<a href="#l2.104"></a><span id="l2.104">               }</span>
<a href="#l2.105"></a><span id="l2.105">               // -- MESSAGE DELETE (batch steady state)</span>
<a href="#l2.106"></a><span id="l2.106">               else { // job.deltaType &lt; 0</span>
<a href="#l2.107"></a><span id="l2.107">                 // item must be a message id</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-                let message = GlodaDatastore.getMessageByID(messageID);</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+                let message = GlodaDatastore.getMessageByID(item);</span>
<a href="#l2.110"></a><span id="l2.110">                 // delete the message!</span>
<a href="#l2.111"></a><span id="l2.111">                 if (message !== null)</span>
<a href="#l2.112"></a><span id="l2.112">                   this._deleteMessage(message);</span>
<a href="#l2.113"></a><span id="l2.113">               }</span>
<a href="#l2.114"></a><span id="l2.114">               </span>
<a href="#l2.115"></a><span id="l2.115">               // we do need to kill the job when we hit the items.length</span>
<a href="#l2.116"></a><span id="l2.116">               if (job.offset == job.items.length)</span>
<a href="#l2.117"></a><span id="l2.117">                 job = this._curIndexingJob = null;</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineat">@@ -640,16 +644,17 @@ let GlodaIndexer = {</span>
<a href="#l2.119"></a><span id="l2.119">      *  going away, we need to either process things immediately or extract the</span>
<a href="#l2.120"></a><span id="l2.120">      *  information required to purge it later without the header.</span>
<a href="#l2.121"></a><span id="l2.121">      *</span>
<a href="#l2.122"></a><span id="l2.122">      * We opt to process all of the headers immediately, inside a transaction.</span>
<a href="#l2.123"></a><span id="l2.123">      *  We do this because deletions may actually be a batch deletion of many,</span>
<a href="#l2.124"></a><span id="l2.124">      *  many messages, which could be a lot to queue</span>
<a href="#l2.125"></a><span id="l2.125">      */</span>
<a href="#l2.126"></a><span id="l2.126">     msgsDeleted: function gloda_indexer_msgsDeleted(aMsgHdrs) {</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+      this.indexer._log.debug(&quot;msgsDeleted notification&quot;);</span>
<a href="#l2.128"></a><span id="l2.128">       let deleteJob = new IndexingJob(&quot;message&quot;, -1, null);</span>
<a href="#l2.129"></a><span id="l2.129">       for (let iMsgHdr=0; iMsgHdr &lt; aMsgHdrs.length; iMsgHdr++) {</span>
<a href="#l2.130"></a><span id="l2.130">         let msgHdr = aMsgHdrs.queryElementAt(iMsgHdr, Ci.nsIMsgDBHdr);</span>
<a href="#l2.131"></a><span id="l2.131">         deleteJob.items.push([GlodaDatastore._mapFolderURI(msgHdr.folder.URI),</span>
<a href="#l2.132"></a><span id="l2.132">                               msgHdr.messageKey]);</span>
<a href="#l2.133"></a><span id="l2.133">       }</span>
<a href="#l2.134"></a><span id="l2.134">       this.indexer._indexQueue.push(deleteJob);</span>
<a href="#l2.135"></a><span id="l2.135">       this.indexer._indexingJobGoal++;</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineat">@@ -697,75 +702,81 @@ let GlodaIndexer = {</span>
<a href="#l2.137"></a><span id="l2.137">         // and now let us queue the re-indexings...</span>
<a href="#l2.138"></a><span id="l2.138">         this.indexer._indexQueue.push(reindexJob);</span>
<a href="#l2.139"></a><span id="l2.139">         this.indexer.indexingJobGoal++;</span>
<a href="#l2.140"></a><span id="l2.140">         this.indexer.indexing = true;</span>
<a href="#l2.141"></a><span id="l2.141">       }</span>
<a href="#l2.142"></a><span id="l2.142">       else {</span>
<a href="#l2.143"></a><span id="l2.143">         let copyIndexJob = new IndexingJob(&quot;message&quot;, 1, null);</span>
<a href="#l2.144"></a><span id="l2.144"> </span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-        for (let iSrcMsgHdr=0; iSrcMsgHdrs &lt; aSrcMsgHdrs.length; iSrcMsgHdr++) {</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+        for (let iSrcMsgHdr=0; iSrcMsgHdr &lt; aSrcMsgHdrs.length; iSrcMsgHdr++) {</span>
<a href="#l2.147"></a><span id="l2.147">           let msgHdr = aSrcMsgHdrs.queryElementAt(iSrcMsgHdr, Ci.nsIMsgDBHdr);</span>
<a href="#l2.148"></a><span id="l2.148">           copyIndexJob.items.push([</span>
<a href="#l2.149"></a><span id="l2.149">             GlodaDatastore._mapFolderURI(aDestFolder.URI),</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-            msgHdr.messageKey]);</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+            msgHdr.messageId]);</span>
<a href="#l2.152"></a><span id="l2.152">         }</span>
<a href="#l2.153"></a><span id="l2.153"> </span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+        this.indexer._indexQueue.push(copyIndexJob);</span>
<a href="#l2.155"></a><span id="l2.155">         this.indexer._indexingJobGoal++;</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-        this.indexer._indexQueue.push(copyIndexJob);</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+        this.indexer.indexing = true;</span>
<a href="#l2.158"></a><span id="l2.158">       }</span>
<a href="#l2.159"></a><span id="l2.159">       } catch (ex) { this.indexer._log.error(&quot;SAD SAD: &quot; + ex); }</span>
<a href="#l2.160"></a><span id="l2.160">     },</span>
<a href="#l2.161"></a><span id="l2.161">     </span>
<a href="#l2.162"></a><span id="l2.162">     /**</span>
<a href="#l2.163"></a><span id="l2.163">      * Handles folder no-longer-exists-ence.  We want to delete all messages</span>
<a href="#l2.164"></a><span id="l2.164">      *  located in the folder and then kill the URI/id.  To this end we create</span>
<a href="#l2.165"></a><span id="l2.165">      *  two jobs.  One kills all the messages, and one actually deletes the</span>
<a href="#l2.166"></a><span id="l2.166">      *  URI/id.</span>
<a href="#l2.167"></a><span id="l2.167">      */</span>
<a href="#l2.168"></a><span id="l2.168">     folderDeleted: function gloda_indexer_folderDeleted(aFolder) {</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+      this.indexer._log.debug(&quot;folderDeleted notification&quot;);</span>
<a href="#l2.170"></a><span id="l2.170">       let folderID = GlodaDatastore._mapFolderURI(aFolder.URI);</span>
<a href="#l2.171"></a><span id="l2.171">       </span>
<a href="#l2.172"></a><span id="l2.172">       let messageJob = new IndexingJob(&quot;message&quot;, -1, null);</span>
<a href="#l2.173"></a><span id="l2.173">       messageJob.items = GlodaDatastore.getMessageIDsByFolderID(folderID);</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-      this.indexer._indexQueue.push(messageJob);</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+      if (messageJob.items.length &gt; 0)</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+        this.indexer._indexQueue.push(messageJob);</span>
<a href="#l2.177"></a><span id="l2.177">       </span>
<a href="#l2.178"></a><span id="l2.178">       let folderJob = new IndexingJob(&quot;folder&quot;, -1, folderID);</span>
<a href="#l2.179"></a><span id="l2.179">       this.indexer._indexQueue.push(folderJob);</span>
<a href="#l2.180"></a><span id="l2.180"> </span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">-      this._indexingJobGoal += 2;</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-      this.indexing = true;</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+      this.indexer._indexingJobGoal += 2;</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+      this.indexer.indexing = true;</span>
<a href="#l2.185"></a><span id="l2.185">     },</span>
<a href="#l2.186"></a><span id="l2.186">     </span>
<a href="#l2.187"></a><span id="l2.187">     /**</span>
<a href="#l2.188"></a><span id="l2.188">      * Handle a folder being copied.  I do not believe the MailNews code is</span>
<a href="#l2.189"></a><span id="l2.189">      *  capable of generating a case where aMove is true, but just in case we'll</span>
<a href="#l2.190"></a><span id="l2.190">      *  dispatch to our sibling method, folderRenamed.</span>
<a href="#l2.191"></a><span id="l2.191">      *</span>
<a href="#l2.192"></a><span id="l2.192">      * Folder copying is conceptually all kinds of annoying (I mean, why would</span>
<a href="#l2.193"></a><span id="l2.193">      *  you really need to duplicate all those messages?) but is easily dealt</span>
<a href="#l2.194"></a><span id="l2.194">      *  with by queueing the destination folder for initial indexing. </span>
<a href="#l2.195"></a><span id="l2.195">      */</span>
<a href="#l2.196"></a><span id="l2.196">     folderMoveCopyCompleted: function gloda_indexer_folderMoveCopyCompleted(</span>
<a href="#l2.197"></a><span id="l2.197">                                aMove, aSrcFolder, aDestFolder) {</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+      this.indexer._log.debug(&quot;folderMoveCopy notification (Move: &quot; + aMove</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+                              + &quot;)&quot;);</span>
<a href="#l2.200"></a><span id="l2.200">       if (aMove) {</span>
<a href="#l2.201"></a><span id="l2.201">         return this.folderRenamed(aSrcFolder, aDestFolder);</span>
<a href="#l2.202"></a><span id="l2.202">       }</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-      this._indexingFolderGoal++;</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineplus">+      this.indexer._indexingFolderGoal++;</span>
<a href="#l2.205"></a><span id="l2.205">       this.indexer._indexQueue.push([&quot;folder&quot;, 1,</span>
<a href="#l2.206"></a><span id="l2.206">         this._mapFolderURI(aDestFolder.URI)]);</span>
<a href="#l2.207"></a><span id="l2.207">       this.indexer.indexing = true;</span>
<a href="#l2.208"></a><span id="l2.208">     },</span>
<a href="#l2.209"></a><span id="l2.209">     </span>
<a href="#l2.210"></a><span id="l2.210">     /**</span>
<a href="#l2.211"></a><span id="l2.211">      * We just need to update the URI &lt;-&gt; ID maps and the row in the database,</span>
<a href="#l2.212"></a><span id="l2.212">      *  all of which is actually done by the datastore for us.</span>
<a href="#l2.213"></a><span id="l2.213">      */</span>
<a href="#l2.214"></a><span id="l2.214">     folderRenamed: function gloda_indexer_folderRenamed(aOrigFolder,</span>
<a href="#l2.215"></a><span id="l2.215">                                                         aNewFolder) {</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+      this.indexer._log.debug(&quot;folderRenamed notification&quot;);</span>
<a href="#l2.217"></a><span id="l2.217">       GlodaDatastore.renameFolder(aOrigFolder.URI, aNewFolder.URI);</span>
<a href="#l2.218"></a><span id="l2.218">     },</span>
<a href="#l2.219"></a><span id="l2.219">     </span>
<a href="#l2.220"></a><span id="l2.220">     itemEvent: function gloda_indexer_itemEvent(aItem, aEvent, aData) {</span>
<a href="#l2.221"></a><span id="l2.221">       // nop.  this is an expansion method on the part of the interface and has</span>
<a href="#l2.222"></a><span id="l2.222">       //  no known events that we need to handle.</span>
<a href="#l2.223"></a><span id="l2.223">     },</span>
<a href="#l2.224"></a><span id="l2.224">   },</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineat">@@ -1033,29 +1044,29 @@ let GlodaIndexer = {</span>
<a href="#l2.226"></a><span id="l2.226">       }</span>
<a href="#l2.227"></a><span id="l2.227">       else {</span>
<a href="#l2.228"></a><span id="l2.228">         ghosts.push(convMsg);</span>
<a href="#l2.229"></a><span id="l2.229">       }</span>
<a href="#l2.230"></a><span id="l2.230">     }</span>
<a href="#l2.231"></a><span id="l2.231">     </span>
<a href="#l2.232"></a><span id="l2.232">     // is everyone else a ghost? (note that conversationMsgs includes us, but</span>
<a href="#l2.233"></a><span id="l2.233">     //  ghosts cannot)</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-    if ((conversationsMsgs.length - 1) == ghosts.length) {</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+    if ((conversationMsgs.length - 1) == ghosts.length) {</span>
<a href="#l2.236"></a><span id="l2.236">       // obliterate the conversation including aMessage.</span>
<a href="#l2.237"></a><span id="l2.237">       // since everyone else is a ghost they have no attributes.  however, the</span>
<a href="#l2.238"></a><span id="l2.238">       //  conversation may some day have attributes targeted against it, so it</span>
<a href="#l2.239"></a><span id="l2.239">       //  gets a helper.</span>
<a href="#l2.240"></a><span id="l2.240">       this._deleteConversationOfMessage(aMessage);</span>
<a href="#l2.241"></a><span id="l2.241">       aMessage._nuke();</span>
<a href="#l2.242"></a><span id="l2.242">     }</span>
<a href="#l2.243"></a><span id="l2.243">     else { // there is at least one real message out there, so the only q is...</span>
<a href="#l2.244"></a><span id="l2.244">       // do we have a twin (so it's okay to delete us) or do we become a ghost?</span>
<a href="#l2.245"></a><span id="l2.245">       if (twinMessage !== null) { // just delete us</span>
<a href="#l2.246"></a><span id="l2.246">         aMessage._datastore.deleteMessageByID(aMessage.id);</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">-        aMesssage._nuke();</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+        aMessage._nuke();</span>
<a href="#l2.249"></a><span id="l2.249">       }</span>
<a href="#l2.250"></a><span id="l2.250">       else { // ghost us</span>
<a href="#l2.251"></a><span id="l2.251">         aMessage._ghost();</span>
<a href="#l2.252"></a><span id="l2.252">         aMessage._datastore.updateMessage(aMessage);</span>
<a href="#l2.253"></a><span id="l2.253">       }</span>
<a href="#l2.254"></a><span id="l2.254">     }</span>
<a href="#l2.255"></a><span id="l2.255">   },</span>
<a href="#l2.256"></a><span id="l2.256">   </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

