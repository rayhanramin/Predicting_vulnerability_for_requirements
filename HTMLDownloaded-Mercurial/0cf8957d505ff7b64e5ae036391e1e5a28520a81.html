<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 22221:0cf8957d505ff7b64e5ae036391e1e5a28520a81</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 0cf8957d505ff7b64e5ae036391e1e5a28520a81" />
<meta property="og:url" content="/comm-central/rev/0cf8957d505ff7b64e5ae036391e1e5a28520a81" />
<meta property="og:description" content="Bug 1385573 - whitespace only changes for nsMsgDBView.cpp. r=jorgk DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 0cf8957d505ff7b64e5ae036391e1e5a28520a81 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/0cf8957d505ff7b64e5ae036391e1e5a28520a81">shortlog</a> |
<a href="/comm-central/log/0cf8957d505ff7b64e5ae036391e1e5a28520a81">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/0cf8957d505ff7b64e5ae036391e1e5a28520a81">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/0cf8957d505ff7b64e5ae036391e1e5a28520a81">files</a> |
changeset |
<a href="/comm-central/raw-rev/0cf8957d505ff7b64e5ae036391e1e5a28520a81">raw</a>  | <a href="/comm-central/archive/0cf8957d505ff7b64e5ae036391e1e5a28520a81.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1385573">Bug 1385573</a> - whitespace only changes for nsMsgDBView.cpp. r=jorgk DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#108;&#116;&#97;&#56;&#56;&#32;&#60;&#97;&#108;&#116;&#97;&#56;&#56;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 26 Sep 2017 19:10:00 +0200</td></tr>

<tr>
 <td>changeset 22221</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/0cf8957d505ff7b64e5ae036391e1e5a28520a81">0cf8957d505ff7b64e5ae036391e1e5a28520a81</a></td>
</tr>



<tr>
<td>parent 22220</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5b7dc947139e10f256ae3ff40877bf6a67d37207">5b7dc947139e10f256ae3ff40877bf6a67d37207</a>
</td>
</tr>

<tr>
<td>child 22222</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fe2507d2cf409777ec5726487136d7302ee97656">fe2507d2cf409777ec5726487136d7302ee97656</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=0cf8957d505ff7b64e5ae036391e1e5a28520a81">13558</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 27 Sep 2017 19:07:15 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0cf8957d505f [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0cf8957d505ff7b64e5ae036391e1e5a28520a81">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0cf8957d505ff7b64e5ae036391e1e5a28520a81&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0cf8957d505ff7b64e5ae036391e1e5a28520a81&newProject=comm-central&newRevision=0cf8957d505ff7b64e5ae036391e1e5a28520a81&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0cf8957d505ff7b64e5ae036391e1e5a28520a81&newProject=comm-central&newRevision=0cf8957d505ff7b64e5ae036391e1e5a28520a81&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0cf8957d505ff7b64e5ae036391e1e5a28520a81&newProject=comm-central&newRevision=0cf8957d505ff7b64e5ae036391e1e5a28520a81&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1385573">1385573</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1385573">Bug 1385573</a> - whitespace only changes for nsMsgDBView.cpp. r=jorgk DONTBUILD</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0cf8957d505ff7b64e5ae036391e1e5a28520a81/mailnews/base/src/nsMsgDBView.cpp">mailnews/base/src/nsMsgDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0cf8957d505ff7b64e5ae036391e1e5a28520a81/mailnews/base/src/nsMsgDBView.cpp">file</a> |
<a href="/comm-central/annotate/0cf8957d505ff7b64e5ae036391e1e5a28520a81/mailnews/base/src/nsMsgDBView.cpp">annotate</a> |
<a href="/comm-central/diff/0cf8957d505ff7b64e5ae036391e1e5a28520a81/mailnews/base/src/nsMsgDBView.cpp">diff</a> |
<a href="/comm-central/comparison/0cf8957d505ff7b64e5ae036391e1e5a28520a81/mailnews/base/src/nsMsgDBView.cpp">comparison</a> |
<a href="/comm-central/log/0cf8957d505ff7b64e5ae036391e1e5a28520a81/mailnews/base/src/nsMsgDBView.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -67,22 +67,24 @@ char16_t * nsMsgDBView::kNewString = nul</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> mozilla::nsDateFormatSelector  nsMsgDBView::m_dateFormatDefault = mozilla::kDateFormatShort;</span>
<a href="#l1.6"></a><span id="l1.6"> mozilla::nsDateFormatSelector  nsMsgDBView::m_dateFormatThisWeek = mozilla::kDateFormatShort;</span>
<a href="#l1.7"></a><span id="l1.7"> mozilla::nsDateFormatSelector  nsMsgDBView::m_dateFormatToday = mozilla::kDateFormatNone;</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> static const uint32_t kMaxNumSortColumns = 2;</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> static void GetCachedName(const nsCString&amp; unparsedString,</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-                          int32_t displayVersion, nsACString&amp; cachedName);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-static void UpdateCachedName(nsIMsgDBHdr *aHdr, const char *header_field,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+                          int32_t displayVersion,</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+                          nsACString&amp; cachedName);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+static void UpdateCachedName(nsIMsgDBHdr *aHdr,</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+                             const char *header_field,</span>
<a href="#l1.20"></a><span id="l1.20">                              const nsAString&amp; newName);</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-// this is passed into NS_QuickSort as custom data.</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+// This is passed into NS_QuickSort as custom data.</span>
<a href="#l1.24"></a><span id="l1.24"> class viewSortInfo</span>
<a href="#l1.25"></a><span id="l1.25"> {</span>
<a href="#l1.26"></a><span id="l1.26"> public:</span>
<a href="#l1.27"></a><span id="l1.27">   nsMsgDBView *view;</span>
<a href="#l1.28"></a><span id="l1.28">   nsIMsgDatabase *db;</span>
<a href="#l1.29"></a><span id="l1.29">   bool isSecondarySort;</span>
<a href="#l1.30"></a><span id="l1.30">   bool ascendingSort;</span>
<a href="#l1.31"></a><span id="l1.31"> };</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineat">@@ -96,17 +98,17 @@ NS_INTERFACE_MAP_BEGIN(nsMsgDBView)</span>
<a href="#l1.33"></a><span id="l1.33">    NS_INTERFACE_MAP_ENTRY(nsIMsgDBView)</span>
<a href="#l1.34"></a><span id="l1.34">    NS_INTERFACE_MAP_ENTRY(nsIDBChangeListener)</span>
<a href="#l1.35"></a><span id="l1.35">    NS_INTERFACE_MAP_ENTRY(nsITreeView)</span>
<a href="#l1.36"></a><span id="l1.36">    NS_INTERFACE_MAP_ENTRY(nsIJunkMailClassificationListener)</span>
<a href="#l1.37"></a><span id="l1.37"> NS_INTERFACE_MAP_END</span>
<a href="#l1.38"></a><span id="l1.38"> </span>
<a href="#l1.39"></a><span id="l1.39"> nsMsgDBView::nsMsgDBView()</span>
<a href="#l1.40"></a><span id="l1.40"> {</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-  /* member initializers and constructor code */</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+  // Member initializers and constructor code.</span>
<a href="#l1.43"></a><span id="l1.43">   m_sortValid = false;</span>
<a href="#l1.44"></a><span id="l1.44">   m_checkedCustomColumns = false;</span>
<a href="#l1.45"></a><span id="l1.45">   m_sortOrder = nsMsgViewSortOrder::none;</span>
<a href="#l1.46"></a><span id="l1.46">   m_viewFlags = nsMsgViewFlagsType::kNone;</span>
<a href="#l1.47"></a><span id="l1.47">   m_secondarySort = nsMsgViewSortType::byId;</span>
<a href="#l1.48"></a><span id="l1.48">   m_secondarySortOrder = nsMsgViewSortOrder::ascending;</span>
<a href="#l1.49"></a><span id="l1.49">   m_cachedMsgKey = nsMsgKey_None;</span>
<a href="#l1.50"></a><span id="l1.50">   m_currentlyDisplayedMsgKey = nsMsgKey_None;</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineat">@@ -124,38 +126,38 @@ nsMsgDBView::nsMsgDBView()</span>
<a href="#l1.52"></a><span id="l1.52">   mIsRss = false;</span>
<a href="#l1.53"></a><span id="l1.53">   mIsXFVirtual = false;</span>
<a href="#l1.54"></a><span id="l1.54">   mDeleteModel = nsMsgImapDeleteModels::MoveToTrash;</span>
<a href="#l1.55"></a><span id="l1.55">   m_deletingRows = false;</span>
<a href="#l1.56"></a><span id="l1.56">   mNumMessagesRemainingInBatch = 0;</span>
<a href="#l1.57"></a><span id="l1.57">   mShowSizeInLines = false;</span>
<a href="#l1.58"></a><span id="l1.58">   mSortThreadsByRoot = false;</span>
<a href="#l1.59"></a><span id="l1.59"> </span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-  /* mCommandsNeedDisablingBecauseOfSelection - A boolean that tell us if we needed to disable commands because of what's selected.</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-    If we're offline w/o a downloaded msg selected, or a dummy message was selected.</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-  */</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+  // mCommandsNeedDisablingBecauseOfSelection - A boolean that tell us if we</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+  // needed to disable commands because of what's selected. If we're offline</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+  // w/o a downloaded msg selected, or a dummy message was selected.</span>
<a href="#l1.67"></a><span id="l1.67">   mCommandsNeedDisablingBecauseOfSelection = false;</span>
<a href="#l1.68"></a><span id="l1.68">   mRemovingRow = false;</span>
<a href="#l1.69"></a><span id="l1.69">   m_saveRestoreSelectionDepth = 0;</span>
<a href="#l1.70"></a><span id="l1.70">   mRecentlyDeletedArrayIndex = 0;</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-  // initialize any static atoms or unicode strings</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+  // Initialize any static atoms or unicode strings.</span>
<a href="#l1.73"></a><span id="l1.73">   if (gInstanceCount == 0)</span>
<a href="#l1.74"></a><span id="l1.74">   {</span>
<a href="#l1.75"></a><span id="l1.75">     InitializeLiterals();</span>
<a href="#l1.76"></a><span id="l1.76">     InitDisplayFormats();</span>
<a href="#l1.77"></a><span id="l1.77">   }</span>
<a href="#l1.78"></a><span id="l1.78"> </span>
<a href="#l1.79"></a><span id="l1.79">   InitLabelStrings();</span>
<a href="#l1.80"></a><span id="l1.80">   gInstanceCount++;</span>
<a href="#l1.81"></a><span id="l1.81"> }</span>
<a href="#l1.82"></a><span id="l1.82"> </span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-void nsMsgDBView::InitializeLiterals()</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-{</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-  // priority strings</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+void</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+nsMsgDBView::InitializeLiterals()</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+{</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+  // Priority strings.</span>
<a href="#l1.90"></a><span id="l1.90">   kHighestPriorityString = GetString(u&quot;priorityHighest&quot;);</span>
<a href="#l1.91"></a><span id="l1.91">   kHighPriorityString = GetString(u&quot;priorityHigh&quot;);</span>
<a href="#l1.92"></a><span id="l1.92">   kLowestPriorityString = GetString(u&quot;priorityLowest&quot;);</span>
<a href="#l1.93"></a><span id="l1.93">   kLowPriorityString = GetString(u&quot;priorityLow&quot;);</span>
<a href="#l1.94"></a><span id="l1.94">   kNormalPriorityString = GetString(u&quot;priorityNormal&quot;);</span>
<a href="#l1.95"></a><span id="l1.95"> </span>
<a href="#l1.96"></a><span id="l1.96">   kReadString = GetString(u&quot;read&quot;);</span>
<a href="#l1.97"></a><span id="l1.97">   kRepliedString = GetString(u&quot;replied&quot;);</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineat">@@ -179,75 +181,84 @@ nsMsgDBView::~nsMsgDBView()</span>
<a href="#l1.99"></a><span id="l1.99"> </span>
<a href="#l1.100"></a><span id="l1.100">     NS_Free(kReadString);</span>
<a href="#l1.101"></a><span id="l1.101">     NS_Free(kRepliedString);</span>
<a href="#l1.102"></a><span id="l1.102">     NS_Free(kForwardedString);</span>
<a href="#l1.103"></a><span id="l1.103">     NS_Free(kNewString);</span>
<a href="#l1.104"></a><span id="l1.104">   }</span>
<a href="#l1.105"></a><span id="l1.105"> }</span>
<a href="#l1.106"></a><span id="l1.106"> </span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-nsresult nsMsgDBView::InitLabelStrings()</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+nsresult</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+nsMsgDBView::InitLabelStrings()</span>
<a href="#l1.110"></a><span id="l1.110"> {</span>
<a href="#l1.111"></a><span id="l1.111">   nsresult rv = NS_OK;</span>
<a href="#l1.112"></a><span id="l1.112">   nsCString prefString;</span>
<a href="#l1.113"></a><span id="l1.113"> </span>
<a href="#l1.114"></a><span id="l1.114">   for(int32_t i = 0; i &lt; PREF_LABELS_MAX; i++)</span>
<a href="#l1.115"></a><span id="l1.115">   {</span>
<a href="#l1.116"></a><span id="l1.116">     prefString.Assign(PREF_LABELS_DESCRIPTION);</span>
<a href="#l1.117"></a><span id="l1.117">     prefString.AppendInt(i + 1);</span>
<a href="#l1.118"></a><span id="l1.118">     rv = GetPrefLocalizedString(prefString.get(), mLabelPrefDescriptions[i]);</span>
<a href="#l1.119"></a><span id="l1.119">   }</span>
<a href="#l1.120"></a><span id="l1.120">   return rv;</span>
<a href="#l1.121"></a><span id="l1.121"> }</span>
<a href="#l1.122"></a><span id="l1.122"> </span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-// helper function used to fetch strings from the messenger string bundle</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+// Helper function used to fetch strings from the messenger string bundle</span>
<a href="#l1.125"></a><span id="l1.125"> char16_t * nsMsgDBView::GetString(const char16_t *aStringName)</span>
<a href="#l1.126"></a><span id="l1.126"> {</span>
<a href="#l1.127"></a><span id="l1.127">   nsresult    res = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.128"></a><span id="l1.128">   nsAutoString str;</span>
<a href="#l1.129"></a><span id="l1.129"> </span>
<a href="#l1.130"></a><span id="l1.130">   if (!mMessengerStringBundle)</span>
<a href="#l1.131"></a><span id="l1.131">   {</span>
<a href="#l1.132"></a><span id="l1.132">     static const char propertyURL[] = MESSENGER_STRING_URL;</span>
<a href="#l1.133"></a><span id="l1.133">     nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l1.134"></a><span id="l1.134">       mozilla::services::GetStringBundleService();</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+</span>
<a href="#l1.136"></a><span id="l1.136">     if (sBundleService)</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-      res = sBundleService-&gt;CreateBundle(propertyURL, getter_AddRefs(mMessengerStringBundle));</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+      res = sBundleService-&gt;CreateBundle(propertyURL,</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+                                         getter_AddRefs(mMessengerStringBundle));</span>
<a href="#l1.140"></a><span id="l1.140">   }</span>
<a href="#l1.141"></a><span id="l1.141"> </span>
<a href="#l1.142"></a><span id="l1.142">   if (mMessengerStringBundle)</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-    res = mMessengerStringBundle-&gt;GetStringFromName(NS_ConvertUTF16toUTF8(aStringName).get(), str);</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+    res = mMessengerStringBundle-&gt;GetStringFromName(</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+                                    NS_ConvertUTF16toUTF8(aStringName).get(), str);</span>
<a href="#l1.146"></a><span id="l1.146"> </span>
<a href="#l1.147"></a><span id="l1.147">   if (NS_SUCCEEDED(res))</span>
<a href="#l1.148"></a><span id="l1.148">     return ToNewUnicode(str);</span>
<a href="#l1.149"></a><span id="l1.149">   else</span>
<a href="#l1.150"></a><span id="l1.150">     return NS_strdup(aStringName);</span>
<a href="#l1.151"></a><span id="l1.151"> }</span>
<a href="#l1.152"></a><span id="l1.152"> </span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-// helper function used to fetch localized strings from the prefs</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-nsresult nsMsgDBView::GetPrefLocalizedString(const char *aPrefName, nsString&amp; aResult)</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+// Helper function used to fetch localized strings from the prefs</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+nsresult</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+nsMsgDBView::GetPrefLocalizedString(const char *aPrefName,</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+                                    nsString&amp; aResult)</span>
<a href="#l1.159"></a><span id="l1.159"> {</span>
<a href="#l1.160"></a><span id="l1.160">   nsresult rv = NS_OK;</span>
<a href="#l1.161"></a><span id="l1.161">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l1.162"></a><span id="l1.162">   nsCOMPtr&lt;nsIPrefLocalizedString&gt; pls;</span>
<a href="#l1.163"></a><span id="l1.163">   nsString ucsval;</span>
<a href="#l1.164"></a><span id="l1.164"> </span>
<a href="#l1.165"></a><span id="l1.165">   prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.166"></a><span id="l1.166">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.167"></a><span id="l1.167"> </span>
<a href="#l1.168"></a><span id="l1.168">   rv = prefBranch-&gt;GetComplexValue(aPrefName, NS_GET_IID(nsIPrefLocalizedString), getter_AddRefs(pls));</span>
<a href="#l1.169"></a><span id="l1.169">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.170"></a><span id="l1.170">   pls-&gt;ToString(getter_Copies(ucsval));</span>
<a href="#l1.171"></a><span id="l1.171">   aResult = ucsval.get();</span>
<a href="#l1.172"></a><span id="l1.172">   return rv;</span>
<a href="#l1.173"></a><span id="l1.173"> }</span>
<a href="#l1.174"></a><span id="l1.174"> </span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-nsresult nsMsgDBView::AppendKeywordProperties(const nsACString&amp; keywords, nsAString&amp; properties, bool addSelectedTextProperty)</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-{</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineminus">-  // get the top most keyword's color and append that as a property.</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+nsresult</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+nsMsgDBView::AppendKeywordProperties(const nsACString&amp; keywords,</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+                                     nsAString&amp; properties,</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+                                     bool addSelectedTextProperty)</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+{</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+  // Get the top most keyword's color and append that as a property.</span>
<a href="#l1.184"></a><span id="l1.184">   nsresult rv;</span>
<a href="#l1.185"></a><span id="l1.185">   if (!mTagService)</span>
<a href="#l1.186"></a><span id="l1.186">   {</span>
<a href="#l1.187"></a><span id="l1.187">     mTagService = do_GetService(NS_MSGTAGSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.188"></a><span id="l1.188">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.189"></a><span id="l1.189">   }</span>
<a href="#l1.190"></a><span id="l1.190"> </span>
<a href="#l1.191"></a><span id="l1.191">   nsCString topKey;</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineat">@@ -265,213 +276,226 @@ nsresult nsMsgDBView::AppendKeywordPrope</span>
<a href="#l1.193"></a><span id="l1.193">       if (color.EqualsLiteral(LABEL_COLOR_WHITE_STRING))</span>
<a href="#l1.194"></a><span id="l1.194">         properties.AppendLiteral(&quot; lc-black&quot;);</span>
<a href="#l1.195"></a><span id="l1.195">       else</span>
<a href="#l1.196"></a><span id="l1.196">         properties.AppendLiteral(&quot; lc-white&quot;);</span>
<a href="#l1.197"></a><span id="l1.197">     }</span>
<a href="#l1.198"></a><span id="l1.198">     color.Replace(0, 1, NS_LITERAL_CSTRING(LABEL_COLOR_STRING));</span>
<a href="#l1.199"></a><span id="l1.199">     properties.AppendASCII(color.get());</span>
<a href="#l1.200"></a><span id="l1.200">   }</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+</span>
<a href="#l1.202"></a><span id="l1.202">   return rv;</span>
<a href="#l1.203"></a><span id="l1.203"> }</span>
<a href="#l1.204"></a><span id="l1.204"> </span>
<a href="#l1.205"></a><span id="l1.205"> ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.206"></a><span id="l1.206"> // nsITreeView Implementation Methods (and helper methods)</span>
<a href="#l1.207"></a><span id="l1.207"> ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.208"></a><span id="l1.208"> </span>
<a href="#l1.209"></a><span id="l1.209" class="difflineminus">-static nsresult GetDisplayNameInAddressBook(const nsACString&amp; emailAddress,</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineminus">-                                            nsAString&amp; displayName)</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+static nsresult</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+GetDisplayNameInAddressBook(const nsACString&amp; emailAddress,</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+                            nsAString&amp; displayName)</span>
<a href="#l1.214"></a><span id="l1.214"> {</span>
<a href="#l1.215"></a><span id="l1.215">   nsresult rv;</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(&quot;@mozilla.org/abmanager;1&quot;,</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-                                   &amp;rv));</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(&quot;@mozilla.org/abmanager;1&quot;, &amp;rv));</span>
<a href="#l1.219"></a><span id="l1.219">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.220"></a><span id="l1.220"> </span>
<a href="#l1.221"></a><span id="l1.221">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l1.222"></a><span id="l1.222">   rv = abManager-&gt;GetDirectories(getter_AddRefs(enumerator));</span>
<a href="#l1.223"></a><span id="l1.223">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.224"></a><span id="l1.224"> </span>
<a href="#l1.225"></a><span id="l1.225">   nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l1.226"></a><span id="l1.226">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l1.227"></a><span id="l1.227">   nsCOMPtr&lt;nsIAbCard&gt; cardForAddress;</span>
<a href="#l1.228"></a><span id="l1.228">   bool hasMore;</span>
<a href="#l1.229"></a><span id="l1.229"> </span>
<a href="#l1.230"></a><span id="l1.230">   // Scan the addressbook to find out the card of the email address</span>
<a href="#l1.231"></a><span id="l1.231">   while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-         hasMore &amp;&amp; !cardForAddress)</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineplus">+         hasMore &amp;&amp;</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+         !cardForAddress)</span>
<a href="#l1.235"></a><span id="l1.235">   {</span>
<a href="#l1.236"></a><span id="l1.236">     rv = enumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l1.237"></a><span id="l1.237">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.238"></a><span id="l1.238">     directory = do_QueryInterface(supports);</span>
<a href="#l1.239"></a><span id="l1.239">     if (directory)</span>
<a href="#l1.240"></a><span id="l1.240">     {</span>
<a href="#l1.241"></a><span id="l1.241">       rv = directory-&gt;CardForEmailAddress(emailAddress,</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineminus">-                        getter_AddRefs(cardForAddress));</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineminus">-</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineplus">+                                          getter_AddRefs(cardForAddress));</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineplus">+      // The card is found,so stop looping.</span>
<a href="#l1.246"></a><span id="l1.246">       if (NS_SUCCEEDED(rv) &amp;&amp; cardForAddress)</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-        break; // the card is found,so stop looping</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineplus">+        break;</span>
<a href="#l1.249"></a><span id="l1.249">     }</span>
<a href="#l1.250"></a><span id="l1.250">   }</span>
<a href="#l1.251"></a><span id="l1.251"> </span>
<a href="#l1.252"></a><span id="l1.252">   if (cardForAddress)</span>
<a href="#l1.253"></a><span id="l1.253">   {</span>
<a href="#l1.254"></a><span id="l1.254">     bool preferDisplayName = true;</span>
<a href="#l1.255"></a><span id="l1.255">     cardForAddress-&gt;GetPropertyAsBool(&quot;PreferDisplayName&quot;,&amp;preferDisplayName);</span>
<a href="#l1.256"></a><span id="l1.256"> </span>
<a href="#l1.257"></a><span id="l1.257">     if (preferDisplayName)</span>
<a href="#l1.258"></a><span id="l1.258">       rv = cardForAddress-&gt;GetDisplayName(displayName);</span>
<a href="#l1.259"></a><span id="l1.259">   }</span>
<a href="#l1.260"></a><span id="l1.260"> </span>
<a href="#l1.261"></a><span id="l1.261">   return rv;</span>
<a href="#l1.262"></a><span id="l1.262"> }</span>
<a href="#l1.263"></a><span id="l1.263"> </span>
<a href="#l1.264"></a><span id="l1.264" class="difflineminus">-/* The unparsedString has following format</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineplus">+/*</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineplus">+ * The unparsedString has following format:</span>
<a href="#l1.267"></a><span id="l1.267">  * &quot;version|displayname&quot;</span>
<a href="#l1.268"></a><span id="l1.268">  */</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineminus">-static void GetCachedName(const nsCString&amp; unparsedString,</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineminus">-                          int32_t displayVersion, nsACString&amp; cachedName)</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineplus">+static void</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineplus">+GetCachedName(const nsCString&amp; unparsedString,</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineplus">+              int32_t displayVersion,</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineplus">+              nsACString&amp; cachedName)</span>
<a href="#l1.275"></a><span id="l1.275"> {</span>
<a href="#l1.276"></a><span id="l1.276">   nsresult err;</span>
<a href="#l1.277"></a><span id="l1.277"> </span>
<a href="#l1.278"></a><span id="l1.278" class="difflineminus">-  //get verion #</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineplus">+  // Get verion #.</span>
<a href="#l1.280"></a><span id="l1.280">   int32_t cachedVersion = unparsedString.ToInteger(&amp;err);</span>
<a href="#l1.281"></a><span id="l1.281">   if (cachedVersion != displayVersion)</span>
<a href="#l1.282"></a><span id="l1.282">     return;</span>
<a href="#l1.283"></a><span id="l1.283"> </span>
<a href="#l1.284"></a><span id="l1.284" class="difflineminus">-  //get cached name</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineplus">+  // Get cached name.</span>
<a href="#l1.286"></a><span id="l1.286">   int32_t pos = unparsedString.FindChar('|');</span>
<a href="#l1.287"></a><span id="l1.287">   if (pos != kNotFound)</span>
<a href="#l1.288"></a><span id="l1.288">     cachedName = Substring(unparsedString, pos + 1);</span>
<a href="#l1.289"></a><span id="l1.289"> }</span>
<a href="#l1.290"></a><span id="l1.290"> </span>
<a href="#l1.291"></a><span id="l1.291" class="difflineminus">-static void UpdateCachedName(nsIMsgDBHdr *aHdr, const char *header_field,</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineminus">-                             const nsAString&amp; newName)</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineplus">+static void</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+UpdateCachedName(nsIMsgDBHdr *aHdr,</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+                 const char *header_field,</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineplus">+                 const nsAString&amp; newName)</span>
<a href="#l1.297"></a><span id="l1.297"> {</span>
<a href="#l1.298"></a><span id="l1.298">   nsCString newCachedName;</span>
<a href="#l1.299"></a><span id="l1.299">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineminus">-  int32_t  currentDisplayNameVersion = 0;</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineplus">+  int32_t currentDisplayNameVersion = 0;</span>
<a href="#l1.302"></a><span id="l1.302"> </span>
<a href="#l1.303"></a><span id="l1.303">   prefs-&gt;GetIntPref(&quot;mail.displayname.version&quot;, &amp;currentDisplayNameVersion);</span>
<a href="#l1.304"></a><span id="l1.304"> </span>
<a href="#l1.305"></a><span id="l1.305" class="difflineminus">-  // save version number</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineplus">+  // Save version number.</span>
<a href="#l1.307"></a><span id="l1.307">   newCachedName.AppendInt(currentDisplayNameVersion);</span>
<a href="#l1.308"></a><span id="l1.308">   newCachedName.Append('|');</span>
<a href="#l1.309"></a><span id="l1.309"> </span>
<a href="#l1.310"></a><span id="l1.310" class="difflineminus">-  // save name</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineplus">+  // Save name.</span>
<a href="#l1.312"></a><span id="l1.312">   newCachedName.Append(NS_ConvertUTF16toUTF8(newName));</span>
<a href="#l1.313"></a><span id="l1.313"> </span>
<a href="#l1.314"></a><span id="l1.314">   aHdr-&gt;SetStringProperty(header_field,newCachedName.get());</span>
<a href="#l1.315"></a><span id="l1.315"> }</span>
<a href="#l1.316"></a><span id="l1.316"> </span>
<a href="#l1.317"></a><span id="l1.317" class="difflineminus">-nsresult nsMsgDBView::FetchAuthor(nsIMsgDBHdr * aHdr, nsAString &amp;aSenderString)</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineplus">+nsresult</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineplus">+nsMsgDBView::FetchAuthor(nsIMsgDBHdr * aHdr,</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineplus">+                         nsAString &amp;aSenderString)</span>
<a href="#l1.321"></a><span id="l1.321"> {</span>
<a href="#l1.322"></a><span id="l1.322">   nsCString unparsedAuthor;</span>
<a href="#l1.323"></a><span id="l1.323">   bool showCondensedAddresses = false;</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineminus">-  int32_t  currentDisplayNameVersion = 0;</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineplus">+  int32_t currentDisplayNameVersion = 0;</span>
<a href="#l1.326"></a><span id="l1.326">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l1.327"></a><span id="l1.327"> </span>
<a href="#l1.328"></a><span id="l1.328">   prefs-&gt;GetIntPref(&quot;mail.displayname.version&quot;, &amp;currentDisplayNameVersion);</span>
<a href="#l1.329"></a><span id="l1.329">   prefs-&gt;GetBoolPref(&quot;mail.showCondensedAddresses&quot;, &amp;showCondensedAddresses);</span>
<a href="#l1.330"></a><span id="l1.330"> </span>
<a href="#l1.331"></a><span id="l1.331">   aHdr-&gt;GetStringProperty(&quot;sender_name&quot;, getter_Copies(unparsedAuthor));</span>
<a href="#l1.332"></a><span id="l1.332"> </span>
<a href="#l1.333"></a><span id="l1.333" class="difflineminus">-  // if the author is already computed, use it</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineplus">+  // If the author is already computed, use it.</span>
<a href="#l1.335"></a><span id="l1.335">   if (!unparsedAuthor.IsEmpty())</span>
<a href="#l1.336"></a><span id="l1.336">   {</span>
<a href="#l1.337"></a><span id="l1.337">     nsCString cachedDisplayName;</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineminus">-</span>
<a href="#l1.339"></a><span id="l1.339">     GetCachedName(unparsedAuthor, currentDisplayNameVersion, cachedDisplayName);</span>
<a href="#l1.340"></a><span id="l1.340">     if (!cachedDisplayName.IsEmpty())</span>
<a href="#l1.341"></a><span id="l1.341">     {</span>
<a href="#l1.342"></a><span id="l1.342">       CopyUTF8toUTF16(cachedDisplayName, aSenderString);</span>
<a href="#l1.343"></a><span id="l1.343">       return NS_OK;</span>
<a href="#l1.344"></a><span id="l1.344">     }</span>
<a href="#l1.345"></a><span id="l1.345">   }</span>
<a href="#l1.346"></a><span id="l1.346"> </span>
<a href="#l1.347"></a><span id="l1.347">   nsCString author;</span>
<a href="#l1.348"></a><span id="l1.348">   (void) aHdr-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l1.349"></a><span id="l1.349"> </span>
<a href="#l1.350"></a><span id="l1.350">   nsCString headerCharset;</span>
<a href="#l1.351"></a><span id="l1.351">   aHdr-&gt;GetEffectiveCharset(headerCharset);</span>
<a href="#l1.352"></a><span id="l1.352"> </span>
<a href="#l1.353"></a><span id="l1.353">   nsCString emailAddress;</span>
<a href="#l1.354"></a><span id="l1.354">   nsString name;</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineminus">-  ExtractFirstAddress(EncodedHeader(author, headerCharset.get()), name,</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineminus">-    emailAddress);</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineplus">+  ExtractFirstAddress(EncodedHeader(author, headerCharset.get()),</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineplus">+                      name,</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineplus">+                      emailAddress);</span>
<a href="#l1.360"></a><span id="l1.360"> </span>
<a href="#l1.361"></a><span id="l1.361">   if (showCondensedAddresses)</span>
<a href="#l1.362"></a><span id="l1.362">     GetDisplayNameInAddressBook(emailAddress, aSenderString);</span>
<a href="#l1.363"></a><span id="l1.363"> </span>
<a href="#l1.364"></a><span id="l1.364">   if (aSenderString.IsEmpty())</span>
<a href="#l1.365"></a><span id="l1.365">   {</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineminus">-    // we can't use the display name in the card,</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineminus">-    // use the name contained in the header or email address.</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineplus">+    // We can't use the display name in the card; use the name contained in</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineplus">+    // the header or email address.</span>
<a href="#l1.370"></a><span id="l1.370">     if (!name.IsEmpty())</span>
<a href="#l1.371"></a><span id="l1.371">       aSenderString = name;</span>
<a href="#l1.372"></a><span id="l1.372">     else</span>
<a href="#l1.373"></a><span id="l1.373">       CopyUTF8toUTF16(emailAddress, aSenderString);</span>
<a href="#l1.374"></a><span id="l1.374">   }</span>
<a href="#l1.375"></a><span id="l1.375"> </span>
<a href="#l1.376"></a><span id="l1.376">   UpdateCachedName(aHdr, &quot;sender_name&quot;, aSenderString);</span>
<a href="#l1.377"></a><span id="l1.377"> </span>
<a href="#l1.378"></a><span id="l1.378">   return NS_OK;</span>
<a href="#l1.379"></a><span id="l1.379"> }</span>
<a href="#l1.380"></a><span id="l1.380"> </span>
<a href="#l1.381"></a><span id="l1.381" class="difflineminus">-nsresult nsMsgDBView::FetchAccount(nsIMsgDBHdr * aHdr, nsAString&amp; aAccount)</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineplus">+nsresult</span>
<a href="#l1.383"></a><span id="l1.383" class="difflineplus">+nsMsgDBView::FetchAccount(nsIMsgDBHdr * aHdr, nsAString&amp; aAccount)</span>
<a href="#l1.384"></a><span id="l1.384"> {</span>
<a href="#l1.385"></a><span id="l1.385">   nsCString accountKey;</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineminus">-</span>
<a href="#l1.387"></a><span id="l1.387">   nsresult rv = aHdr-&gt;GetAccountKey(getter_Copies(accountKey));</span>
<a href="#l1.388"></a><span id="l1.388"> </span>
<a href="#l1.389"></a><span id="l1.389">   // Cache the account manager?</span>
<a href="#l1.390"></a><span id="l1.390">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager(</span>
<a href="#l1.391"></a><span id="l1.391">     do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l1.392"></a><span id="l1.392" class="difflineplus">+</span>
<a href="#l1.393"></a><span id="l1.393">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.394"></a><span id="l1.394">   nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l1.395"></a><span id="l1.395">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.396"></a><span id="l1.396">   if (!accountKey.IsEmpty())</span>
<a href="#l1.397"></a><span id="l1.397">     rv = accountManager-&gt;GetAccount(accountKey, getter_AddRefs(account));</span>
<a href="#l1.398"></a><span id="l1.398"> </span>
<a href="#l1.399"></a><span id="l1.399">   if (account)</span>
<a href="#l1.400"></a><span id="l1.400">   {</span>
<a href="#l1.401"></a><span id="l1.401">     account-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l1.402"></a><span id="l1.402">   }</span>
<a href="#l1.403"></a><span id="l1.403">   else</span>
<a href="#l1.404"></a><span id="l1.404">   {</span>
<a href="#l1.405"></a><span id="l1.405">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.406"></a><span id="l1.406">     aHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l1.407"></a><span id="l1.407">     if (folder)</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineminus">-     folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.409"></a><span id="l1.409" class="difflineminus">-  }</span>
<a href="#l1.410"></a><span id="l1.410" class="difflineplus">+      folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.411"></a><span id="l1.411" class="difflineplus">+  }</span>
<a href="#l1.412"></a><span id="l1.412" class="difflineplus">+</span>
<a href="#l1.413"></a><span id="l1.413">   if (server)</span>
<a href="#l1.414"></a><span id="l1.414">     server-&gt;GetPrettyName(aAccount);</span>
<a href="#l1.415"></a><span id="l1.415">   else</span>
<a href="#l1.416"></a><span id="l1.416">     CopyASCIItoUTF16(accountKey, aAccount);</span>
<a href="#l1.417"></a><span id="l1.417" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineminus">-}</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineminus">-</span>
<a href="#l1.420"></a><span id="l1.420" class="difflineminus">-nsresult nsMsgDBView::FetchRecipients(nsIMsgDBHdr * aHdr, nsAString &amp;aRecipientsString)</span>
<a href="#l1.421"></a><span id="l1.421" class="difflineplus">+</span>
<a href="#l1.422"></a><span id="l1.422" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.423"></a><span id="l1.423" class="difflineplus">+}</span>
<a href="#l1.424"></a><span id="l1.424" class="difflineplus">+</span>
<a href="#l1.425"></a><span id="l1.425" class="difflineplus">+nsresult</span>
<a href="#l1.426"></a><span id="l1.426" class="difflineplus">+nsMsgDBView::FetchRecipients(nsIMsgDBHdr * aHdr,</span>
<a href="#l1.427"></a><span id="l1.427" class="difflineplus">+                             nsAString &amp;aRecipientsString)</span>
<a href="#l1.428"></a><span id="l1.428"> {</span>
<a href="#l1.429"></a><span id="l1.429">   nsCString recipients;</span>
<a href="#l1.430"></a><span id="l1.430">   int32_t currentDisplayNameVersion = 0;</span>
<a href="#l1.431"></a><span id="l1.431">   bool showCondensedAddresses = false;</span>
<a href="#l1.432"></a><span id="l1.432">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l1.433"></a><span id="l1.433"> </span>
<a href="#l1.434"></a><span id="l1.434">   prefs-&gt;GetIntPref(&quot;mail.displayname.version&quot;, &amp;currentDisplayNameVersion);</span>
<a href="#l1.435"></a><span id="l1.435">   prefs-&gt;GetBoolPref(&quot;mail.showCondensedAddresses&quot;, &amp;showCondensedAddresses);</span>
<a href="#l1.436"></a><span id="l1.436"> </span>
<a href="#l1.437"></a><span id="l1.437">   aHdr-&gt;GetStringProperty(&quot;recipient_names&quot;, getter_Copies(recipients));</span>
<a href="#l1.438"></a><span id="l1.438"> </span>
<a href="#l1.439"></a><span id="l1.439">   if (!recipients.IsEmpty())</span>
<a href="#l1.440"></a><span id="l1.440">   {</span>
<a href="#l1.441"></a><span id="l1.441">     nsCString cachedRecipients;</span>
<a href="#l1.442"></a><span id="l1.442" class="difflineminus">-</span>
<a href="#l1.443"></a><span id="l1.443">     GetCachedName(recipients, currentDisplayNameVersion, cachedRecipients);</span>
<a href="#l1.444"></a><span id="l1.444"> </span>
<a href="#l1.445"></a><span id="l1.445" class="difflineminus">-    // recipients have already been cached,check if the addressbook</span>
<a href="#l1.446"></a><span id="l1.446" class="difflineplus">+    // Recipients have already been cached, check if the addressbook</span>
<a href="#l1.447"></a><span id="l1.447">     // was changed after cache.</span>
<a href="#l1.448"></a><span id="l1.448">     if (!cachedRecipients.IsEmpty())</span>
<a href="#l1.449"></a><span id="l1.449">     {</span>
<a href="#l1.450"></a><span id="l1.450">       CopyUTF8toUTF16(cachedRecipients, aRecipientsString);</span>
<a href="#l1.451"></a><span id="l1.451">       return NS_OK;</span>
<a href="#l1.452"></a><span id="l1.452">     }</span>
<a href="#l1.453"></a><span id="l1.453">   }</span>
<a href="#l1.454"></a><span id="l1.454"> </span>
<a href="#l1.455"></a><span id="l1.455" class="difflineat">@@ -479,47 +503,49 @@ nsresult nsMsgDBView::FetchRecipients(ns</span>
<a href="#l1.456"></a><span id="l1.456">   nsresult rv = aHdr-&gt;GetRecipients(getter_Copies(unparsedRecipients));</span>
<a href="#l1.457"></a><span id="l1.457"> </span>
<a href="#l1.458"></a><span id="l1.458">   nsCString headerCharset;</span>
<a href="#l1.459"></a><span id="l1.459">   aHdr-&gt;GetEffectiveCharset(headerCharset);</span>
<a href="#l1.460"></a><span id="l1.460"> </span>
<a href="#l1.461"></a><span id="l1.461">   nsTArray&lt;nsString&gt; names;</span>
<a href="#l1.462"></a><span id="l1.462">   nsTArray&lt;nsCString&gt; emails;</span>
<a href="#l1.463"></a><span id="l1.463">   ExtractAllAddresses(EncodedHeader(unparsedRecipients, headerCharset.get()),</span>
<a href="#l1.464"></a><span id="l1.464" class="difflineminus">-    names, UTF16ArrayAdapter&lt;&gt;(emails));</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineplus">+                      names,</span>
<a href="#l1.466"></a><span id="l1.466" class="difflineplus">+                      UTF16ArrayAdapter&lt;&gt;(emails));</span>
<a href="#l1.467"></a><span id="l1.467"> </span>
<a href="#l1.468"></a><span id="l1.468">   uint32_t numAddresses = names.Length();</span>
<a href="#l1.469"></a><span id="l1.469"> </span>
<a href="#l1.470"></a><span id="l1.470">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l1.471"></a><span id="l1.471">   nsCOMPtr&lt;nsIAbManager&gt;</span>
<a href="#l1.472"></a><span id="l1.472">     abManager(do_GetService(&quot;@mozilla.org/abmanager;1&quot;, &amp;rv));</span>
<a href="#l1.473"></a><span id="l1.473" class="difflineplus">+</span>
<a href="#l1.474"></a><span id="l1.474">   NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l1.475"></a><span id="l1.475"> </span>
<a href="#l1.476"></a><span id="l1.476" class="difflineminus">-  // go through each email address in the recipients and</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineminus">-  // compute its display name.</span>
<a href="#l1.478"></a><span id="l1.478" class="difflineplus">+  // Go through each email address in the recipients and compute its</span>
<a href="#l1.479"></a><span id="l1.479" class="difflineplus">+  // display name.</span>
<a href="#l1.480"></a><span id="l1.480">   for (uint32_t i = 0; i &lt; numAddresses; i++)</span>
<a href="#l1.481"></a><span id="l1.481">   {</span>
<a href="#l1.482"></a><span id="l1.482">     nsString recipient;</span>
<a href="#l1.483"></a><span id="l1.483">     nsCString &amp;curAddress = emails[i];</span>
<a href="#l1.484"></a><span id="l1.484">     nsString &amp;curName = names[i];</span>
<a href="#l1.485"></a><span id="l1.485"> </span>
<a href="#l1.486"></a><span id="l1.486">     if (showCondensedAddresses)</span>
<a href="#l1.487"></a><span id="l1.487">       GetDisplayNameInAddressBook(curAddress, recipient);</span>
<a href="#l1.488"></a><span id="l1.488"> </span>
<a href="#l1.489"></a><span id="l1.489">     if (recipient.IsEmpty())</span>
<a href="#l1.490"></a><span id="l1.490">     {</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineminus">-      // we can't use the display name in the card,</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineminus">-      // use the name contained in the header or email address.</span>
<a href="#l1.493"></a><span id="l1.493" class="difflineplus">+      // We can't use the display name in the card; use the name contained in</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineplus">+      // the header or email address.</span>
<a href="#l1.495"></a><span id="l1.495">       if (!curName.IsEmpty())</span>
<a href="#l1.496"></a><span id="l1.496">         recipient = curName;</span>
<a href="#l1.497"></a><span id="l1.497">       else</span>
<a href="#l1.498"></a><span id="l1.498">         CopyUTF8toUTF16(curAddress, recipient);</span>
<a href="#l1.499"></a><span id="l1.499">     }</span>
<a href="#l1.500"></a><span id="l1.500"> </span>
<a href="#l1.501"></a><span id="l1.501" class="difflineminus">-    // add ', ' between each recipient</span>
<a href="#l1.502"></a><span id="l1.502" class="difflineplus">+    // Add ', ' between each recipient.</span>
<a href="#l1.503"></a><span id="l1.503">     if (i != 0)</span>
<a href="#l1.504"></a><span id="l1.504">       aRecipientsString.AppendLiteral(u&quot;, &quot;);</span>
<a href="#l1.505"></a><span id="l1.505"> </span>
<a href="#l1.506"></a><span id="l1.506">     aRecipientsString.Append(recipient);</span>
<a href="#l1.507"></a><span id="l1.507">   }</span>
<a href="#l1.508"></a><span id="l1.508"> </span>
<a href="#l1.509"></a><span id="l1.509">   if (numAddresses == 0 &amp;&amp; unparsedRecipients.FindChar(':') != kNotFound) {</span>
<a href="#l1.510"></a><span id="l1.510">     // No addresses and a colon, so an empty group like &quot;undisclosed-recipients: ;&quot;.</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineat">@@ -529,124 +555,138 @@ nsresult nsMsgDBView::FetchRecipients(ns</span>
<a href="#l1.512"></a><span id="l1.512">     aRecipientsString.Assign(group);</span>
<a href="#l1.513"></a><span id="l1.513">   }</span>
<a href="#l1.514"></a><span id="l1.514"> </span>
<a href="#l1.515"></a><span id="l1.515">   UpdateCachedName(aHdr, &quot;recipient_names&quot;, aRecipientsString);</span>
<a href="#l1.516"></a><span id="l1.516"> </span>
<a href="#l1.517"></a><span id="l1.517">   return NS_OK;</span>
<a href="#l1.518"></a><span id="l1.518"> }</span>
<a href="#l1.519"></a><span id="l1.519"> </span>
<a href="#l1.520"></a><span id="l1.520" class="difflineminus">-nsresult nsMsgDBView::FetchSubject(nsIMsgDBHdr * aMsgHdr, uint32_t aFlags, nsAString &amp;aValue)</span>
<a href="#l1.521"></a><span id="l1.521" class="difflineplus">+nsresult</span>
<a href="#l1.522"></a><span id="l1.522" class="difflineplus">+nsMsgDBView::FetchSubject(nsIMsgDBHdr * aMsgHdr,</span>
<a href="#l1.523"></a><span id="l1.523" class="difflineplus">+                          uint32_t aFlags,</span>
<a href="#l1.524"></a><span id="l1.524" class="difflineplus">+                          nsAString &amp;aValue)</span>
<a href="#l1.525"></a><span id="l1.525"> {</span>
<a href="#l1.526"></a><span id="l1.526">   if (aFlags &amp; nsMsgMessageFlags::HasRe)</span>
<a href="#l1.527"></a><span id="l1.527">   {</span>
<a href="#l1.528"></a><span id="l1.528">     nsString subject;</span>
<a href="#l1.529"></a><span id="l1.529">     aMsgHdr-&gt;GetMime2DecodedSubject(subject);</span>
<a href="#l1.530"></a><span id="l1.530">     aValue.AssignLiteral(&quot;Re: &quot;);</span>
<a href="#l1.531"></a><span id="l1.531">     aValue.Append(subject);</span>
<a href="#l1.532"></a><span id="l1.532">   }</span>
<a href="#l1.533"></a><span id="l1.533">   else</span>
<a href="#l1.534"></a><span id="l1.534" class="difflineplus">+  {</span>
<a href="#l1.535"></a><span id="l1.535">     aMsgHdr-&gt;GetMime2DecodedSubject(aValue);</span>
<a href="#l1.536"></a><span id="l1.536" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.537"></a><span id="l1.537" class="difflineminus">-}</span>
<a href="#l1.538"></a><span id="l1.538" class="difflineminus">-</span>
<a href="#l1.539"></a><span id="l1.539" class="difflineminus">-// in case we want to play around with the date string, I've broken it out into</span>
<a href="#l1.540"></a><span id="l1.540" class="difflineplus">+  }</span>
<a href="#l1.541"></a><span id="l1.541" class="difflineplus">+</span>
<a href="#l1.542"></a><span id="l1.542" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.543"></a><span id="l1.543" class="difflineplus">+}</span>
<a href="#l1.544"></a><span id="l1.544" class="difflineplus">+</span>
<a href="#l1.545"></a><span id="l1.545" class="difflineplus">+// In case we want to play around with the date string, I've broken it out into</span>
<a href="#l1.546"></a><span id="l1.546"> // a separate routine.  Set rcvDate to true to get the Received: date instead</span>
<a href="#l1.547"></a><span id="l1.547"> // of the Date: date.</span>
<a href="#l1.548"></a><span id="l1.548" class="difflineminus">-nsresult nsMsgDBView::FetchDate(nsIMsgDBHdr * aHdr, nsAString &amp;aDateString, bool rcvDate)</span>
<a href="#l1.549"></a><span id="l1.549" class="difflineplus">+nsresult</span>
<a href="#l1.550"></a><span id="l1.550" class="difflineplus">+nsMsgDBView::FetchDate(nsIMsgDBHdr * aHdr,</span>
<a href="#l1.551"></a><span id="l1.551" class="difflineplus">+                       nsAString &amp;aDateString,</span>
<a href="#l1.552"></a><span id="l1.552" class="difflineplus">+                       bool rcvDate)</span>
<a href="#l1.553"></a><span id="l1.553"> {</span>
<a href="#l1.554"></a><span id="l1.554">   PRTime dateOfMsg;</span>
<a href="#l1.555"></a><span id="l1.555">   PRTime dateOfMsgLocal;</span>
<a href="#l1.556"></a><span id="l1.556">   uint32_t rcvDateSecs;</span>
<a href="#l1.557"></a><span id="l1.557">   nsresult rv;</span>
<a href="#l1.558"></a><span id="l1.558"> </span>
<a href="#l1.559"></a><span id="l1.559" class="difflineminus">-  // Silently return Date: instead if Received: is unavailable</span>
<a href="#l1.560"></a><span id="l1.560" class="difflineplus">+  // Silently return Date: instead if Received: is unavailable.</span>
<a href="#l1.561"></a><span id="l1.561">   if (rcvDate)</span>
<a href="#l1.562"></a><span id="l1.562">   {</span>
<a href="#l1.563"></a><span id="l1.563">     rv = aHdr-&gt;GetUint32Property(&quot;dateReceived&quot;, &amp;rcvDateSecs);</span>
<a href="#l1.564"></a><span id="l1.564">     if (rcvDateSecs != 0)</span>
<a href="#l1.565"></a><span id="l1.565">       Seconds2PRTime(rcvDateSecs, &amp;dateOfMsg);</span>
<a href="#l1.566"></a><span id="l1.566">   }</span>
<a href="#l1.567"></a><span id="l1.567" class="difflineplus">+</span>
<a href="#l1.568"></a><span id="l1.568">   if (!rcvDate || rcvDateSecs == 0)</span>
<a href="#l1.569"></a><span id="l1.569">     rv = aHdr-&gt;GetDate(&amp;dateOfMsg);</span>
<a href="#l1.570"></a><span id="l1.570"> </span>
<a href="#l1.571"></a><span id="l1.571">   PRTime currentTime = PR_Now();</span>
<a href="#l1.572"></a><span id="l1.572">   PRExplodedTime explodedCurrentTime;</span>
<a href="#l1.573"></a><span id="l1.573">   PR_ExplodeTime(currentTime, PR_LocalTimeParameters, &amp;explodedCurrentTime);</span>
<a href="#l1.574"></a><span id="l1.574">   PRExplodedTime explodedMsgTime;</span>
<a href="#l1.575"></a><span id="l1.575">   PR_ExplodeTime(dateOfMsg, PR_LocalTimeParameters, &amp;explodedMsgTime);</span>
<a href="#l1.576"></a><span id="l1.576"> </span>
<a href="#l1.577"></a><span id="l1.577" class="difflineminus">-  // if the message is from today, don't show the date, only the time. (i.e. 3:15 pm)</span>
<a href="#l1.578"></a><span id="l1.578" class="difflineminus">-  // if the message is from the last week, show the day of the week.   (i.e. Mon 3:15 pm)</span>
<a href="#l1.579"></a><span id="l1.579" class="difflineminus">-  // in all other cases, show the full date (03/19/01 3:15 pm)</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineplus">+  // If the message is from today, don't show the date, only the time (3:15 pm).</span>
<a href="#l1.581"></a><span id="l1.581" class="difflineplus">+  // if the message is from the last week, show the day of the week (Mon 3:15 pm).</span>
<a href="#l1.582"></a><span id="l1.582" class="difflineplus">+  // in all other cases, show the full date (03/19/01 3:15 pm).</span>
<a href="#l1.583"></a><span id="l1.583"> </span>
<a href="#l1.584"></a><span id="l1.584">   mozilla::nsDateFormatSelector dateFormat = m_dateFormatDefault;</span>
<a href="#l1.585"></a><span id="l1.585">   if (explodedCurrentTime.tm_year == explodedMsgTime.tm_year &amp;&amp;</span>
<a href="#l1.586"></a><span id="l1.586">       explodedCurrentTime.tm_month == explodedMsgTime.tm_month &amp;&amp;</span>
<a href="#l1.587"></a><span id="l1.587">       explodedCurrentTime.tm_mday == explodedMsgTime.tm_mday)</span>
<a href="#l1.588"></a><span id="l1.588">   {</span>
<a href="#l1.589"></a><span id="l1.589" class="difflineminus">-    // same day...</span>
<a href="#l1.590"></a><span id="l1.590" class="difflineplus">+    // Same day.</span>
<a href="#l1.591"></a><span id="l1.591">     dateFormat = m_dateFormatToday;</span>
<a href="#l1.592"></a><span id="l1.592">   }</span>
<a href="#l1.593"></a><span id="l1.593" class="difflineminus">-  // the following chunk of code allows us to show a day instead of a number if the message was received</span>
<a href="#l1.594"></a><span id="l1.594" class="difflineminus">-  // within the last 7 days. i.e. Mon 5:10pm. (depending on the mail.ui.display.dateformat.thisweek pref)</span>
<a href="#l1.595"></a><span id="l1.595" class="difflineminus">-  // The concrete format used is dependent on a preference setting (see InitDisplayFormats).</span>
<a href="#l1.596"></a><span id="l1.596">   else if (currentTime &gt; dateOfMsg)</span>
<a href="#l1.597"></a><span id="l1.597">   {</span>
<a href="#l1.598"></a><span id="l1.598" class="difflineplus">+    // The following chunk of code allows us to show a day instead of a number</span>
<a href="#l1.599"></a><span id="l1.599" class="difflineplus">+    // if the message was received within the last 7 days. i.e. Mon 5:10pm</span>
<a href="#l1.600"></a><span id="l1.600" class="difflineplus">+    // (depending on the mail.ui.display.dateformat.thisweek pref).</span>
<a href="#l1.601"></a><span id="l1.601" class="difflineplus">+    // The concrete format used is dependent on a preference setting</span>
<a href="#l1.602"></a><span id="l1.602" class="difflineplus">+    // (see InitDisplayFormats).</span>
<a href="#l1.603"></a><span id="l1.603">     // Convert the times from GMT to local time</span>
<a href="#l1.604"></a><span id="l1.604">     int64_t GMTLocalTimeShift = PR_USEC_PER_SEC *</span>
<a href="#l1.605"></a><span id="l1.605" class="difflineminus">-      int64_t(explodedCurrentTime.tm_params.tp_gmt_offset +</span>
<a href="#l1.606"></a><span id="l1.606" class="difflineminus">-       explodedCurrentTime.tm_params.tp_dst_offset);</span>
<a href="#l1.607"></a><span id="l1.607" class="difflineplus">+                                int64_t(explodedCurrentTime.tm_params.tp_gmt_offset +</span>
<a href="#l1.608"></a><span id="l1.608" class="difflineplus">+                                explodedCurrentTime.tm_params.tp_dst_offset);</span>
<a href="#l1.609"></a><span id="l1.609">     currentTime += GMTLocalTimeShift;</span>
<a href="#l1.610"></a><span id="l1.610">     dateOfMsgLocal = dateOfMsg + GMTLocalTimeShift;</span>
<a href="#l1.611"></a><span id="l1.611"> </span>
<a href="#l1.612"></a><span id="l1.612" class="difflineminus">-    // Find the most recent midnight</span>
<a href="#l1.613"></a><span id="l1.613" class="difflineplus">+    // Find the most recent midnight.</span>
<a href="#l1.614"></a><span id="l1.614">     int64_t todaysMicroSeconds = currentTime % PR_USEC_PER_DAY;</span>
<a href="#l1.615"></a><span id="l1.615">     int64_t mostRecentMidnight = currentTime - todaysMicroSeconds;</span>
<a href="#l1.616"></a><span id="l1.616"> </span>
<a href="#l1.617"></a><span id="l1.617" class="difflineminus">-    // most recent midnight minus 6 days</span>
<a href="#l1.618"></a><span id="l1.618" class="difflineplus">+    // Most recent midnight minus 6 days.</span>
<a href="#l1.619"></a><span id="l1.619">     int64_t mostRecentWeek = mostRecentMidnight - (PR_USEC_PER_DAY * 6);</span>
<a href="#l1.620"></a><span id="l1.620"> </span>
<a href="#l1.621"></a><span id="l1.621" class="difflineminus">-    // was the message sent during the last week?</span>
<a href="#l1.622"></a><span id="l1.622" class="difflineplus">+    // Was the message sent during the last week?</span>
<a href="#l1.623"></a><span id="l1.623">     if (dateOfMsgLocal &gt;= mostRecentWeek)</span>
<a href="#l1.624"></a><span id="l1.624" class="difflineminus">-    { // yes ....</span>
<a href="#l1.625"></a><span id="l1.625">       dateFormat = m_dateFormatThisWeek;</span>
<a href="#l1.626"></a><span id="l1.626" class="difflineminus">-    }</span>
<a href="#l1.627"></a><span id="l1.627">   }</span>
<a href="#l1.628"></a><span id="l1.628"> </span>
<a href="#l1.629"></a><span id="l1.629">   if (NS_SUCCEEDED(rv))</span>
<a href="#l1.630"></a><span id="l1.630">     rv = mozilla::DateTimeFormat::FormatPRTime(dateFormat,</span>
<a href="#l1.631"></a><span id="l1.631">                                                mozilla::kTimeFormatNoSeconds,</span>
<a href="#l1.632"></a><span id="l1.632">                                                dateOfMsg,</span>
<a href="#l1.633"></a><span id="l1.633">                                                aDateString);</span>
<a href="#l1.634"></a><span id="l1.634"> </span>
<a href="#l1.635"></a><span id="l1.635">   return rv;</span>
<a href="#l1.636"></a><span id="l1.636"> }</span>
<a href="#l1.637"></a><span id="l1.637"> </span>
<a href="#l1.638"></a><span id="l1.638" class="difflineminus">-nsresult nsMsgDBView::FetchStatus(uint32_t aFlags, nsAString &amp;aStatusString)</span>
<a href="#l1.639"></a><span id="l1.639" class="difflineplus">+nsresult</span>
<a href="#l1.640"></a><span id="l1.640" class="difflineplus">+nsMsgDBView::FetchStatus(uint32_t aFlags,</span>
<a href="#l1.641"></a><span id="l1.641" class="difflineplus">+                         nsAString &amp;aStatusString)</span>
<a href="#l1.642"></a><span id="l1.642"> {</span>
<a href="#l1.643"></a><span id="l1.643">   if (aFlags &amp; nsMsgMessageFlags::Replied)</span>
<a href="#l1.644"></a><span id="l1.644">     aStatusString = kRepliedString;</span>
<a href="#l1.645"></a><span id="l1.645">   else if (aFlags &amp; nsMsgMessageFlags::Forwarded)</span>
<a href="#l1.646"></a><span id="l1.646">     aStatusString = kForwardedString;</span>
<a href="#l1.647"></a><span id="l1.647">   else if (aFlags &amp; nsMsgMessageFlags::New)</span>
<a href="#l1.648"></a><span id="l1.648">     aStatusString = kNewString;</span>
<a href="#l1.649"></a><span id="l1.649">   else if (aFlags &amp; nsMsgMessageFlags::Read)</span>
<a href="#l1.650"></a><span id="l1.650">     aStatusString = kReadString;</span>
<a href="#l1.651"></a><span id="l1.651"> </span>
<a href="#l1.652"></a><span id="l1.652">   return NS_OK;</span>
<a href="#l1.653"></a><span id="l1.653"> }</span>
<a href="#l1.654"></a><span id="l1.654"> </span>
<a href="#l1.655"></a><span id="l1.655" class="difflineminus">-nsresult nsMsgDBView::FetchSize(nsIMsgDBHdr * aHdr, nsAString &amp;aSizeString)</span>
<a href="#l1.656"></a><span id="l1.656" class="difflineplus">+nsresult</span>
<a href="#l1.657"></a><span id="l1.657" class="difflineplus">+nsMsgDBView::FetchSize(nsIMsgDBHdr * aHdr,</span>
<a href="#l1.658"></a><span id="l1.658" class="difflineplus">+                       nsAString &amp;aSizeString)</span>
<a href="#l1.659"></a><span id="l1.659"> {</span>
<a href="#l1.660"></a><span id="l1.660">   nsresult rv;</span>
<a href="#l1.661"></a><span id="l1.661">   nsAutoString formattedSizeString;</span>
<a href="#l1.662"></a><span id="l1.662">   uint32_t msgSize = 0;</span>
<a href="#l1.663"></a><span id="l1.663"> </span>
<a href="#l1.664"></a><span id="l1.664" class="difflineminus">-  // for news, show the line count, not the size if the user wants so</span>
<a href="#l1.665"></a><span id="l1.665" class="difflineplus">+  // For news, show the line count, not the size if the user wants so.</span>
<a href="#l1.666"></a><span id="l1.666">   if (mShowSizeInLines)</span>
<a href="#l1.667"></a><span id="l1.667">   {</span>
<a href="#l1.668"></a><span id="l1.668">     aHdr-&gt;GetLineCount(&amp;msgSize);</span>
<a href="#l1.669"></a><span id="l1.669">     formattedSizeString.AppendInt(msgSize);</span>
<a href="#l1.670"></a><span id="l1.670">   }</span>
<a href="#l1.671"></a><span id="l1.671">   else</span>
<a href="#l1.672"></a><span id="l1.672">   {</span>
<a href="#l1.673"></a><span id="l1.673">     uint32_t flags = 0;</span>
<a href="#l1.674"></a><span id="l1.674" class="difflineat">@@ -658,52 +698,57 @@ nsresult nsMsgDBView::FetchSize(nsIMsgDB</span>
<a href="#l1.675"></a><span id="l1.675">     if (msgSize == 0)</span>
<a href="#l1.676"></a><span id="l1.676">       aHdr-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l1.677"></a><span id="l1.677"> </span>
<a href="#l1.678"></a><span id="l1.678">     rv = FormatFileSize(msgSize, true, formattedSizeString);</span>
<a href="#l1.679"></a><span id="l1.679">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.680"></a><span id="l1.680">   }</span>
<a href="#l1.681"></a><span id="l1.681"> </span>
<a href="#l1.682"></a><span id="l1.682">   aSizeString = formattedSizeString;</span>
<a href="#l1.683"></a><span id="l1.683" class="difflineminus">-  // the formattingString Length includes the null terminator byte!</span>
<a href="#l1.684"></a><span id="l1.684" class="difflineplus">+  // The formattingString Length includes the null terminator byte!</span>
<a href="#l1.685"></a><span id="l1.685">   if (!formattedSizeString.Last())</span>
<a href="#l1.686"></a><span id="l1.686">     aSizeString.SetLength(formattedSizeString.Length() - 1);</span>
<a href="#l1.687"></a><span id="l1.687" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.688"></a><span id="l1.688" class="difflineminus">-}</span>
<a href="#l1.689"></a><span id="l1.689" class="difflineminus">-</span>
<a href="#l1.690"></a><span id="l1.690" class="difflineminus">-nsresult nsMsgDBView::FetchPriority(nsIMsgDBHdr *aHdr, nsAString &amp; aPriorityString)</span>
<a href="#l1.691"></a><span id="l1.691" class="difflineplus">+</span>
<a href="#l1.692"></a><span id="l1.692" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.693"></a><span id="l1.693" class="difflineplus">+}</span>
<a href="#l1.694"></a><span id="l1.694" class="difflineplus">+</span>
<a href="#l1.695"></a><span id="l1.695" class="difflineplus">+nsresult</span>
<a href="#l1.696"></a><span id="l1.696" class="difflineplus">+nsMsgDBView::FetchPriority(nsIMsgDBHdr *aHdr,</span>
<a href="#l1.697"></a><span id="l1.697" class="difflineplus">+                           nsAString &amp; aPriorityString)</span>
<a href="#l1.698"></a><span id="l1.698"> {</span>
<a href="#l1.699"></a><span id="l1.699">   nsMsgPriorityValue priority = nsMsgPriority::notSet;</span>
<a href="#l1.700"></a><span id="l1.700">   aHdr-&gt;GetPriority(&amp;priority);</span>
<a href="#l1.701"></a><span id="l1.701"> </span>
<a href="#l1.702"></a><span id="l1.702">   switch (priority)</span>
<a href="#l1.703"></a><span id="l1.703">   {</span>
<a href="#l1.704"></a><span id="l1.704" class="difflineminus">-  case nsMsgPriority::highest:</span>
<a href="#l1.705"></a><span id="l1.705" class="difflineminus">-    aPriorityString = kHighestPriorityString;</span>
<a href="#l1.706"></a><span id="l1.706" class="difflineminus">-    break;</span>
<a href="#l1.707"></a><span id="l1.707" class="difflineminus">-  case nsMsgPriority::high:</span>
<a href="#l1.708"></a><span id="l1.708" class="difflineminus">-    aPriorityString = kHighPriorityString;</span>
<a href="#l1.709"></a><span id="l1.709" class="difflineminus">-    break;</span>
<a href="#l1.710"></a><span id="l1.710" class="difflineminus">-  case nsMsgPriority::low:</span>
<a href="#l1.711"></a><span id="l1.711" class="difflineminus">-    aPriorityString = kLowPriorityString;</span>
<a href="#l1.712"></a><span id="l1.712" class="difflineminus">-    break;</span>
<a href="#l1.713"></a><span id="l1.713" class="difflineminus">-  case nsMsgPriority::lowest:</span>
<a href="#l1.714"></a><span id="l1.714" class="difflineminus">-    aPriorityString = kLowestPriorityString;</span>
<a href="#l1.715"></a><span id="l1.715" class="difflineminus">-    break;</span>
<a href="#l1.716"></a><span id="l1.716" class="difflineminus">-  case nsMsgPriority::normal:</span>
<a href="#l1.717"></a><span id="l1.717" class="difflineminus">-    aPriorityString = kNormalPriorityString;</span>
<a href="#l1.718"></a><span id="l1.718" class="difflineminus">-    break;</span>
<a href="#l1.719"></a><span id="l1.719" class="difflineminus">-  default:</span>
<a href="#l1.720"></a><span id="l1.720" class="difflineminus">-    break;</span>
<a href="#l1.721"></a><span id="l1.721" class="difflineminus">-  }</span>
<a href="#l1.722"></a><span id="l1.722" class="difflineminus">-</span>
<a href="#l1.723"></a><span id="l1.723" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.724"></a><span id="l1.724" class="difflineminus">-}</span>
<a href="#l1.725"></a><span id="l1.725" class="difflineminus">-</span>
<a href="#l1.726"></a><span id="l1.726" class="difflineminus">-nsresult nsMsgDBView::FetchKeywords(nsIMsgDBHdr *aHdr, nsACString &amp;keywordString)</span>
<a href="#l1.727"></a><span id="l1.727" class="difflineplus">+    case nsMsgPriority::highest:</span>
<a href="#l1.728"></a><span id="l1.728" class="difflineplus">+      aPriorityString = kHighestPriorityString;</span>
<a href="#l1.729"></a><span id="l1.729" class="difflineplus">+      break;</span>
<a href="#l1.730"></a><span id="l1.730" class="difflineplus">+    case nsMsgPriority::high:</span>
<a href="#l1.731"></a><span id="l1.731" class="difflineplus">+      aPriorityString = kHighPriorityString;</span>
<a href="#l1.732"></a><span id="l1.732" class="difflineplus">+      break;</span>
<a href="#l1.733"></a><span id="l1.733" class="difflineplus">+    case nsMsgPriority::low:</span>
<a href="#l1.734"></a><span id="l1.734" class="difflineplus">+      aPriorityString = kLowPriorityString;</span>
<a href="#l1.735"></a><span id="l1.735" class="difflineplus">+      break;</span>
<a href="#l1.736"></a><span id="l1.736" class="difflineplus">+    case nsMsgPriority::lowest:</span>
<a href="#l1.737"></a><span id="l1.737" class="difflineplus">+      aPriorityString = kLowestPriorityString;</span>
<a href="#l1.738"></a><span id="l1.738" class="difflineplus">+      break;</span>
<a href="#l1.739"></a><span id="l1.739" class="difflineplus">+    case nsMsgPriority::normal:</span>
<a href="#l1.740"></a><span id="l1.740" class="difflineplus">+      aPriorityString = kNormalPriorityString;</span>
<a href="#l1.741"></a><span id="l1.741" class="difflineplus">+      break;</span>
<a href="#l1.742"></a><span id="l1.742" class="difflineplus">+    default:</span>
<a href="#l1.743"></a><span id="l1.743" class="difflineplus">+      break;</span>
<a href="#l1.744"></a><span id="l1.744" class="difflineplus">+  }</span>
<a href="#l1.745"></a><span id="l1.745" class="difflineplus">+</span>
<a href="#l1.746"></a><span id="l1.746" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.747"></a><span id="l1.747" class="difflineplus">+}</span>
<a href="#l1.748"></a><span id="l1.748" class="difflineplus">+</span>
<a href="#l1.749"></a><span id="l1.749" class="difflineplus">+nsresult</span>
<a href="#l1.750"></a><span id="l1.750" class="difflineplus">+nsMsgDBView::FetchKeywords(nsIMsgDBHdr *aHdr,</span>
<a href="#l1.751"></a><span id="l1.751" class="difflineplus">+                           nsACString &amp;keywordString)</span>
<a href="#l1.752"></a><span id="l1.752"> {</span>
<a href="#l1.753"></a><span id="l1.753">   NS_ENSURE_ARG_POINTER(aHdr);</span>
<a href="#l1.754"></a><span id="l1.754">   nsresult rv = NS_OK;</span>
<a href="#l1.755"></a><span id="l1.755">   if (!mTagService)</span>
<a href="#l1.756"></a><span id="l1.756">   {</span>
<a href="#l1.757"></a><span id="l1.757">     mTagService = do_GetService(NS_MSGTAGSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.758"></a><span id="l1.758">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.759"></a><span id="l1.759">   }</span>
<a href="#l1.760"></a><span id="l1.760" class="difflineat">@@ -715,41 +760,45 @@ nsresult nsMsgDBView::FetchKeywords(nsIM</span>
<a href="#l1.761"></a><span id="l1.761">   if (label &gt; 0)</span>
<a href="#l1.762"></a><span id="l1.762">   {</span>
<a href="#l1.763"></a><span id="l1.763">     nsAutoCString labelStr(&quot;$label&quot;);</span>
<a href="#l1.764"></a><span id="l1.764">     labelStr.Append((char) (label + '0'));</span>
<a href="#l1.765"></a><span id="l1.765">     if (keywords.Find(labelStr, /* ignoreCase = */ true) == -1)</span>
<a href="#l1.766"></a><span id="l1.766">     {</span>
<a href="#l1.767"></a><span id="l1.767">       if (!keywords.IsEmpty())</span>
<a href="#l1.768"></a><span id="l1.768">         keywords.Append(' ');</span>
<a href="#l1.769"></a><span id="l1.769" class="difflineplus">+</span>
<a href="#l1.770"></a><span id="l1.770">       keywords.Append(labelStr);</span>
<a href="#l1.771"></a><span id="l1.771">     }</span>
<a href="#l1.772"></a><span id="l1.772">   }</span>
<a href="#l1.773"></a><span id="l1.773" class="difflineplus">+</span>
<a href="#l1.774"></a><span id="l1.774">   keywordString = keywords;</span>
<a href="#l1.775"></a><span id="l1.775">   return NS_OK;</span>
<a href="#l1.776"></a><span id="l1.776"> }</span>
<a href="#l1.777"></a><span id="l1.777"> </span>
<a href="#l1.778"></a><span id="l1.778"> // If the row is a collapsed thread, we optionally roll-up the keywords in all</span>
<a href="#l1.779"></a><span id="l1.779"> // the messages in the thread, otherwise, return just the keywords for the row.</span>
<a href="#l1.780"></a><span id="l1.780" class="difflineminus">-nsresult nsMsgDBView::FetchRowKeywords(nsMsgViewIndex aRow, nsIMsgDBHdr *aHdr,</span>
<a href="#l1.781"></a><span id="l1.781" class="difflineminus">-                                       nsACString &amp;keywordString)</span>
<a href="#l1.782"></a><span id="l1.782" class="difflineplus">+nsresult</span>
<a href="#l1.783"></a><span id="l1.783" class="difflineplus">+nsMsgDBView::FetchRowKeywords(nsMsgViewIndex aRow,</span>
<a href="#l1.784"></a><span id="l1.784" class="difflineplus">+                              nsIMsgDBHdr *aHdr,</span>
<a href="#l1.785"></a><span id="l1.785" class="difflineplus">+                              nsACString &amp;keywordString)</span>
<a href="#l1.786"></a><span id="l1.786"> {</span>
<a href="#l1.787"></a><span id="l1.787">   nsresult rv = FetchKeywords(aHdr,keywordString);</span>
<a href="#l1.788"></a><span id="l1.788">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.789"></a><span id="l1.789"> </span>
<a href="#l1.790"></a><span id="l1.790">   bool cascadeKeywordsUp = true;</span>
<a href="#l1.791"></a><span id="l1.791">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l1.792"></a><span id="l1.792">   prefs-&gt;GetBoolPref(&quot;mailnews.display_reply_tag_colors_for_collapsed_threads&quot;,</span>
<a href="#l1.793"></a><span id="l1.793">                      &amp;cascadeKeywordsUp);</span>
<a href="#l1.794"></a><span id="l1.794"> </span>
<a href="#l1.795"></a><span id="l1.795">   if ((m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) &amp;&amp;</span>
<a href="#l1.796"></a><span id="l1.796">       cascadeKeywordsUp)</span>
<a href="#l1.797"></a><span id="l1.797">   {</span>
<a href="#l1.798"></a><span id="l1.798" class="difflineminus">-    if ((m_flags[aRow] &amp; MSG_VIEW_FLAG_ISTHREAD)</span>
<a href="#l1.799"></a><span id="l1.799" class="difflineminus">-        &amp;&amp; (m_flags[aRow] &amp; nsMsgMessageFlags::Elided))</span>
<a href="#l1.800"></a><span id="l1.800" class="difflineplus">+    if ((m_flags[aRow] &amp; MSG_VIEW_FLAG_ISTHREAD) &amp;&amp;</span>
<a href="#l1.801"></a><span id="l1.801" class="difflineplus">+        (m_flags[aRow] &amp; nsMsgMessageFlags::Elided))</span>
<a href="#l1.802"></a><span id="l1.802">     {</span>
<a href="#l1.803"></a><span id="l1.803">       nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.804"></a><span id="l1.804">       rv = GetThreadContainingIndex(aRow, getter_AddRefs(thread));</span>
<a href="#l1.805"></a><span id="l1.805">       if (NS_SUCCEEDED(rv) &amp;&amp; thread)</span>
<a href="#l1.806"></a><span id="l1.806">       {</span>
<a href="#l1.807"></a><span id="l1.807">         uint32_t numChildren;</span>
<a href="#l1.808"></a><span id="l1.808">         thread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l1.809"></a><span id="l1.809">         nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.810"></a><span id="l1.810" class="difflineat">@@ -757,25 +806,29 @@ nsresult nsMsgDBView::FetchRowKeywords(n</span>
<a href="#l1.811"></a><span id="l1.811">         for (uint32_t index = 0; index &lt; numChildren; index++)</span>
<a href="#l1.812"></a><span id="l1.812">         {</span>
<a href="#l1.813"></a><span id="l1.813">           thread-&gt;GetChildHdrAt(index, getter_AddRefs(msgHdr));</span>
<a href="#l1.814"></a><span id="l1.814">           rv = FetchKeywords(msgHdr, moreKeywords);</span>
<a href="#l1.815"></a><span id="l1.815">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.816"></a><span id="l1.816"> </span>
<a href="#l1.817"></a><span id="l1.817">           if (!keywordString.IsEmpty() &amp;&amp; !moreKeywords.IsEmpty())</span>
<a href="#l1.818"></a><span id="l1.818">             keywordString.Append(' ');</span>
<a href="#l1.819"></a><span id="l1.819" class="difflineplus">+</span>
<a href="#l1.820"></a><span id="l1.820">           keywordString.Append(moreKeywords);</span>
<a href="#l1.821"></a><span id="l1.821">         }</span>
<a href="#l1.822"></a><span id="l1.822">       }</span>
<a href="#l1.823"></a><span id="l1.823">     }</span>
<a href="#l1.824"></a><span id="l1.824">   }</span>
<a href="#l1.825"></a><span id="l1.825" class="difflineplus">+</span>
<a href="#l1.826"></a><span id="l1.826">   return rv;</span>
<a href="#l1.827"></a><span id="l1.827"> }</span>
<a href="#l1.828"></a><span id="l1.828"> </span>
<a href="#l1.829"></a><span id="l1.829" class="difflineminus">-nsresult nsMsgDBView::FetchTags(nsIMsgDBHdr *aHdr, nsAString &amp;aTagString)</span>
<a href="#l1.830"></a><span id="l1.830" class="difflineplus">+nsresult</span>
<a href="#l1.831"></a><span id="l1.831" class="difflineplus">+nsMsgDBView::FetchTags(nsIMsgDBHdr *aHdr,</span>
<a href="#l1.832"></a><span id="l1.832" class="difflineplus">+                       nsAString &amp;aTagString)</span>
<a href="#l1.833"></a><span id="l1.833"> {</span>
<a href="#l1.834"></a><span id="l1.834">   NS_ENSURE_ARG_POINTER(aHdr);</span>
<a href="#l1.835"></a><span id="l1.835">   nsresult rv = NS_OK;</span>
<a href="#l1.836"></a><span id="l1.836">   if (!mTagService)</span>
<a href="#l1.837"></a><span id="l1.837">   {</span>
<a href="#l1.838"></a><span id="l1.838">     mTagService = do_GetService(NS_MSGTAGSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.839"></a><span id="l1.839">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.840"></a><span id="l1.840">   }</span>
<a href="#l1.841"></a><span id="l1.841" class="difflineat">@@ -800,240 +853,271 @@ nsresult nsMsgDBView::FetchTags(nsIMsgDB</span>
<a href="#l1.842"></a><span id="l1.842"> </span>
<a href="#l1.843"></a><span id="l1.843">   for (uint32_t i = 0; i &lt; keywordsArray.Length(); i++)</span>
<a href="#l1.844"></a><span id="l1.844">   {</span>
<a href="#l1.845"></a><span id="l1.845">     rv = mTagService-&gt;GetTagForKey(keywordsArray[i], tag);</span>
<a href="#l1.846"></a><span id="l1.846">     if (NS_SUCCEEDED(rv) &amp;&amp; !tag.IsEmpty())</span>
<a href="#l1.847"></a><span id="l1.847">     {</span>
<a href="#l1.848"></a><span id="l1.848">       if (!tags.IsEmpty())</span>
<a href="#l1.849"></a><span id="l1.849">         tags.Append((char16_t) ' ');</span>
<a href="#l1.850"></a><span id="l1.850" class="difflineplus">+</span>
<a href="#l1.851"></a><span id="l1.851">       tags.Append(tag);</span>
<a href="#l1.852"></a><span id="l1.852">     }</span>
<a href="#l1.853"></a><span id="l1.853">   }</span>
<a href="#l1.854"></a><span id="l1.854"> </span>
<a href="#l1.855"></a><span id="l1.855">   aTagString = tags;</span>
<a href="#l1.856"></a><span id="l1.856">   return NS_OK;</span>
<a href="#l1.857"></a><span id="l1.857"> }</span>
<a href="#l1.858"></a><span id="l1.858"> </span>
<a href="#l1.859"></a><span id="l1.859" class="difflineminus">-nsresult nsMsgDBView::FetchLabel(nsIMsgDBHdr *aHdr, nsAString &amp;aLabelString)</span>
<a href="#l1.860"></a><span id="l1.860" class="difflineplus">+nsresult</span>
<a href="#l1.861"></a><span id="l1.861" class="difflineplus">+nsMsgDBView::FetchLabel(nsIMsgDBHdr *aHdr,</span>
<a href="#l1.862"></a><span id="l1.862" class="difflineplus">+                        nsAString &amp;aLabelString)</span>
<a href="#l1.863"></a><span id="l1.863"> {</span>
<a href="#l1.864"></a><span id="l1.864">   nsresult rv = NS_OK;</span>
<a href="#l1.865"></a><span id="l1.865">   nsMsgLabelValue label = 0;</span>
<a href="#l1.866"></a><span id="l1.866"> </span>
<a href="#l1.867"></a><span id="l1.867">   NS_ENSURE_ARG_POINTER(aHdr);</span>
<a href="#l1.868"></a><span id="l1.868"> </span>
<a href="#l1.869"></a><span id="l1.869">   rv = aHdr-&gt;GetLabel(&amp;label);</span>
<a href="#l1.870"></a><span id="l1.870">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.871"></a><span id="l1.871"> </span>
<a href="#l1.872"></a><span id="l1.872" class="difflineminus">-  // we don't care if label is not between 1 and PREF_LABELS_MAX inclusive.</span>
<a href="#l1.873"></a><span id="l1.873" class="difflineplus">+  // We don't care if label is not between 1 and PREF_LABELS_MAX inclusive.</span>
<a href="#l1.874"></a><span id="l1.874">   if ((label &lt; 1) || (label &gt; PREF_LABELS_MAX))</span>
<a href="#l1.875"></a><span id="l1.875">   {</span>
<a href="#l1.876"></a><span id="l1.876">     aLabelString.Truncate();</span>
<a href="#l1.877"></a><span id="l1.877">     return NS_OK;</span>
<a href="#l1.878"></a><span id="l1.878">   }</span>
<a href="#l1.879"></a><span id="l1.879"> </span>
<a href="#l1.880"></a><span id="l1.880">   // We need to subtract 1 because mLabelPrefDescriptions is 0 based.</span>
<a href="#l1.881"></a><span id="l1.881">   aLabelString = mLabelPrefDescriptions[label - 1];</span>
<a href="#l1.882"></a><span id="l1.882">   return NS_OK;</span>
<a href="#l1.883"></a><span id="l1.883"> }</span>
<a href="#l1.884"></a><span id="l1.884"> </span>
<a href="#l1.885"></a><span id="l1.885" class="difflineminus">-bool nsMsgDBView::IsOutgoingMsg(nsIMsgDBHdr* aHdr)</span>
<a href="#l1.886"></a><span id="l1.886" class="difflineplus">+bool</span>
<a href="#l1.887"></a><span id="l1.887" class="difflineplus">+nsMsgDBView::IsOutgoingMsg(nsIMsgDBHdr* aHdr)</span>
<a href="#l1.888"></a><span id="l1.888"> {</span>
<a href="#l1.889"></a><span id="l1.889">   nsString author;</span>
<a href="#l1.890"></a><span id="l1.890">   aHdr-&gt;GetMime2DecodedAuthor(author);</span>
<a href="#l1.891"></a><span id="l1.891"> </span>
<a href="#l1.892"></a><span id="l1.892">   nsCString emailAddress;</span>
<a href="#l1.893"></a><span id="l1.893">   nsString name;</span>
<a href="#l1.894"></a><span id="l1.894">   ExtractFirstAddress(DecodedHeader(author), name, emailAddress);</span>
<a href="#l1.895"></a><span id="l1.895"> </span>
<a href="#l1.896"></a><span id="l1.896">   return mEmails.Contains(emailAddress);</span>
<a href="#l1.897"></a><span id="l1.897"> }</span>
<a href="#l1.898"></a><span id="l1.898"> </span>
<a href="#l1.899"></a><span id="l1.899"> </span>
<a href="#l1.900"></a><span id="l1.900" class="difflineminus">-/*if you call SaveAndClearSelection make sure to call RestoreSelection otherwise</span>
<a href="#l1.901"></a><span id="l1.901" class="difflineminus">-m_saveRestoreSelectionDepth will be incorrect and will lead to selection msg problems*/</span>
<a href="#l1.902"></a><span id="l1.902" class="difflineminus">-</span>
<a href="#l1.903"></a><span id="l1.903" class="difflineminus">-nsresult nsMsgDBView::SaveAndClearSelection(nsMsgKey *aCurrentMsgKey, nsTArray&lt;nsMsgKey&gt; &amp;aMsgKeyArray)</span>
<a href="#l1.904"></a><span id="l1.904" class="difflineminus">-{</span>
<a href="#l1.905"></a><span id="l1.905" class="difflineminus">-  // we don't do anything on nested Save / Restore calls.</span>
<a href="#l1.906"></a><span id="l1.906" class="difflineplus">+// If you call SaveAndClearSelection make sure to call RestoreSelection(),</span>
<a href="#l1.907"></a><span id="l1.907" class="difflineplus">+// otherwise m_saveRestoreSelectionDepth will be incorrect and will lead to</span>
<a href="#l1.908"></a><span id="l1.908" class="difflineplus">+// selection msg problems.</span>
<a href="#l1.909"></a><span id="l1.909" class="difflineplus">+nsresult</span>
<a href="#l1.910"></a><span id="l1.910" class="difflineplus">+nsMsgDBView::SaveAndClearSelection(nsMsgKey *aCurrentMsgKey,</span>
<a href="#l1.911"></a><span id="l1.911" class="difflineplus">+                                   nsTArray&lt;nsMsgKey&gt; &amp;aMsgKeyArray)</span>
<a href="#l1.912"></a><span id="l1.912" class="difflineplus">+{</span>
<a href="#l1.913"></a><span id="l1.913" class="difflineplus">+  // We don't do anything on nested Save / Restore calls.</span>
<a href="#l1.914"></a><span id="l1.914">   m_saveRestoreSelectionDepth++;</span>
<a href="#l1.915"></a><span id="l1.915">   if (m_saveRestoreSelectionDepth != 1)</span>
<a href="#l1.916"></a><span id="l1.916">     return NS_OK;</span>
<a href="#l1.917"></a><span id="l1.917"> </span>
<a href="#l1.918"></a><span id="l1.918">   if (!mTreeSelection || !mTree)</span>
<a href="#l1.919"></a><span id="l1.919">     return NS_OK;</span>
<a href="#l1.920"></a><span id="l1.920"> </span>
<a href="#l1.921"></a><span id="l1.921" class="difflineminus">-  // first, freeze selection.</span>
<a href="#l1.922"></a><span id="l1.922" class="difflineplus">+  // First, freeze selection.</span>
<a href="#l1.923"></a><span id="l1.923">   mTreeSelection-&gt;SetSelectEventsSuppressed(true);</span>
<a href="#l1.924"></a><span id="l1.924"> </span>
<a href="#l1.925"></a><span id="l1.925" class="difflineminus">-  // second, save the current index.</span>
<a href="#l1.926"></a><span id="l1.926" class="difflineplus">+  // Second, save the current index.</span>
<a href="#l1.927"></a><span id="l1.927">   if (aCurrentMsgKey)</span>
<a href="#l1.928"></a><span id="l1.928">   {</span>
<a href="#l1.929"></a><span id="l1.929">     int32_t currentIndex;</span>
<a href="#l1.930"></a><span id="l1.930">     if (NS_SUCCEEDED(mTreeSelection-&gt;GetCurrentIndex(&amp;currentIndex)) &amp;&amp;</span>
<a href="#l1.931"></a><span id="l1.931">         currentIndex &gt;= 0 &amp;&amp; uint32_t(currentIndex) &lt; GetSize())</span>
<a href="#l1.932"></a><span id="l1.932">       *aCurrentMsgKey = m_keys[currentIndex];</span>
<a href="#l1.933"></a><span id="l1.933">     else</span>
<a href="#l1.934"></a><span id="l1.934">       *aCurrentMsgKey = nsMsgKey_None;</span>
<a href="#l1.935"></a><span id="l1.935">   }</span>
<a href="#l1.936"></a><span id="l1.936"> </span>
<a href="#l1.937"></a><span id="l1.937" class="difflineminus">-  // third, get an array of view indices for the selection.</span>
<a href="#l1.938"></a><span id="l1.938" class="difflineplus">+  // Third, get an array of view indices for the selection.</span>
<a href="#l1.939"></a><span id="l1.939">   nsMsgViewIndexArray selection;</span>
<a href="#l1.940"></a><span id="l1.940">   GetSelectedIndices(selection);</span>
<a href="#l1.941"></a><span id="l1.941">   int32_t numIndices = selection.Length();</span>
<a href="#l1.942"></a><span id="l1.942">   aMsgKeyArray.SetLength(numIndices);</span>
<a href="#l1.943"></a><span id="l1.943"> </span>
<a href="#l1.944"></a><span id="l1.944" class="difflineminus">-  // now store the msg key for each selected item.</span>
<a href="#l1.945"></a><span id="l1.945" class="difflineplus">+  // Now store the msg key for each selected item.</span>
<a href="#l1.946"></a><span id="l1.946">   nsMsgKey msgKey;</span>
<a href="#l1.947"></a><span id="l1.947">   for (int32_t index = 0; index &lt; numIndices; index++)</span>
<a href="#l1.948"></a><span id="l1.948">   {</span>
<a href="#l1.949"></a><span id="l1.949">     msgKey = m_keys[selection[index]];</span>
<a href="#l1.950"></a><span id="l1.950">     aMsgKeyArray[index] = msgKey;</span>
<a href="#l1.951"></a><span id="l1.951">   }</span>
<a href="#l1.952"></a><span id="l1.952"> </span>
<a href="#l1.953"></a><span id="l1.953" class="difflineminus">-  // clear the selection, we'll manually restore it later.</span>
<a href="#l1.954"></a><span id="l1.954" class="difflineplus">+  // Clear the selection, we'll manually restore it later.</span>
<a href="#l1.955"></a><span id="l1.955">   if (mTreeSelection)</span>
<a href="#l1.956"></a><span id="l1.956">     mTreeSelection-&gt;ClearSelection();</span>
<a href="#l1.957"></a><span id="l1.957"> </span>
<a href="#l1.958"></a><span id="l1.958">   return NS_OK;</span>
<a href="#l1.959"></a><span id="l1.959"> }</span>
<a href="#l1.960"></a><span id="l1.960"> </span>
<a href="#l1.961"></a><span id="l1.961" class="difflineminus">-nsresult nsMsgDBView::RestoreSelection(nsMsgKey aCurrentMsgKey, nsTArray&lt;nsMsgKey&gt; &amp;aMsgKeyArray)</span>
<a href="#l1.962"></a><span id="l1.962" class="difflineminus">-{</span>
<a href="#l1.963"></a><span id="l1.963" class="difflineminus">-  // we don't do anything on nested Save / Restore calls.</span>
<a href="#l1.964"></a><span id="l1.964" class="difflineplus">+nsresult</span>
<a href="#l1.965"></a><span id="l1.965" class="difflineplus">+nsMsgDBView::RestoreSelection(nsMsgKey aCurrentMsgKey,</span>
<a href="#l1.966"></a><span id="l1.966" class="difflineplus">+                              nsTArray&lt;nsMsgKey&gt; &amp;aMsgKeyArray)</span>
<a href="#l1.967"></a><span id="l1.967" class="difflineplus">+{</span>
<a href="#l1.968"></a><span id="l1.968" class="difflineplus">+  // We don't do anything on nested Save / Restore calls.</span>
<a href="#l1.969"></a><span id="l1.969">   m_saveRestoreSelectionDepth--;</span>
<a href="#l1.970"></a><span id="l1.970">   if (m_saveRestoreSelectionDepth)</span>
<a href="#l1.971"></a><span id="l1.971">     return NS_OK;</span>
<a href="#l1.972"></a><span id="l1.972"> </span>
<a href="#l1.973"></a><span id="l1.973" class="difflineminus">-  if (!mTreeSelection)  // don't assert.</span>
<a href="#l1.974"></a><span id="l1.974" class="difflineplus">+  // Don't assert.</span>
<a href="#l1.975"></a><span id="l1.975" class="difflineplus">+  if (!mTreeSelection)</span>
<a href="#l1.976"></a><span id="l1.976">     return NS_OK;</span>
<a href="#l1.977"></a><span id="l1.977"> </span>
<a href="#l1.978"></a><span id="l1.978" class="difflineminus">-  // turn our message keys into corresponding view indices</span>
<a href="#l1.979"></a><span id="l1.979" class="difflineplus">+  // Turn our message keys into corresponding view indices.</span>
<a href="#l1.980"></a><span id="l1.980">   int32_t arraySize = aMsgKeyArray.Length();</span>
<a href="#l1.981"></a><span id="l1.981">   nsMsgViewIndex  currentViewPosition = nsMsgViewIndex_None;</span>
<a href="#l1.982"></a><span id="l1.982">   nsMsgViewIndex  newViewPosition = nsMsgViewIndex_None;</span>
<a href="#l1.983"></a><span id="l1.983"> </span>
<a href="#l1.984"></a><span id="l1.984" class="difflineminus">-  // if we are threaded, we need to do a little more work</span>
<a href="#l1.985"></a><span id="l1.985" class="difflineplus">+  // If we are threaded, we need to do a little more work</span>
<a href="#l1.986"></a><span id="l1.986">   // we need to find (and expand) all the threads that contain messages</span>
<a href="#l1.987"></a><span id="l1.987">   // that we had selected before.</span>
<a href="#l1.988"></a><span id="l1.988">   if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.989"></a><span id="l1.989">   {</span>
<a href="#l1.990"></a><span id="l1.990">     for (int32_t index = 0; index &lt; arraySize; index ++)</span>
<a href="#l1.991"></a><span id="l1.991" class="difflineminus">-    {</span>
<a href="#l1.992"></a><span id="l1.992">       FindKey(aMsgKeyArray[index], true /* expand */);</span>
<a href="#l1.993"></a><span id="l1.993" class="difflineminus">-    }</span>
<a href="#l1.994"></a><span id="l1.994">   }</span>
<a href="#l1.995"></a><span id="l1.995"> </span>
<a href="#l1.996"></a><span id="l1.996">   for (int32_t index = 0; index &lt; arraySize; index ++)</span>
<a href="#l1.997"></a><span id="l1.997">   {</span>
<a href="#l1.998"></a><span id="l1.998">     newViewPosition = FindKey(aMsgKeyArray[index], false);</span>
<a href="#l1.999"></a><span id="l1.999" class="difflineminus">-    // add the index back to the selection.</span>
<a href="#l1.1000"></a><span id="l1.1000" class="difflineplus">+    // Add the index back to the selection.</span>
<a href="#l1.1001"></a><span id="l1.1001">     if (newViewPosition != nsMsgViewIndex_None)</span>
<a href="#l1.1002"></a><span id="l1.1002">       mTreeSelection-&gt;ToggleSelect(newViewPosition);</span>
<a href="#l1.1003"></a><span id="l1.1003">   }</span>
<a href="#l1.1004"></a><span id="l1.1004"> </span>
<a href="#l1.1005"></a><span id="l1.1005" class="difflineminus">-  // make sure the currentView was preserved....</span>
<a href="#l1.1006"></a><span id="l1.1006" class="difflineplus">+  // Make sure the currentView was preserved.</span>
<a href="#l1.1007"></a><span id="l1.1007">   if (aCurrentMsgKey != nsMsgKey_None)</span>
<a href="#l1.1008"></a><span id="l1.1008">     currentViewPosition = FindKey(aCurrentMsgKey, true);</span>
<a href="#l1.1009"></a><span id="l1.1009"> </span>
<a href="#l1.1010"></a><span id="l1.1010">   if (mTree)</span>
<a href="#l1.1011"></a><span id="l1.1011">     mTreeSelection-&gt;SetCurrentIndex(currentViewPosition);</span>
<a href="#l1.1012"></a><span id="l1.1012"> </span>
<a href="#l1.1013"></a><span id="l1.1013" class="difflineminus">-  // make sure the current message is once again visible in the thread pane</span>
<a href="#l1.1014"></a><span id="l1.1014" class="difflineplus">+  // Make sure the current message is once again visible in the thread pane</span>
<a href="#l1.1015"></a><span id="l1.1015">   // so we don't have to go search for it in the thread pane</span>
<a href="#l1.1016"></a><span id="l1.1016">   if (mTree &amp;&amp; currentViewPosition != nsMsgViewIndex_None)</span>
<a href="#l1.1017"></a><span id="l1.1017">     mTree-&gt;EnsureRowIsVisible(currentViewPosition);</span>
<a href="#l1.1018"></a><span id="l1.1018"> </span>
<a href="#l1.1019"></a><span id="l1.1019" class="difflineminus">-  // unfreeze selection.</span>
<a href="#l1.1020"></a><span id="l1.1020" class="difflineplus">+  // Unfreeze selection.</span>
<a href="#l1.1021"></a><span id="l1.1021">   mTreeSelection-&gt;SetSelectEventsSuppressed(false);</span>
<a href="#l1.1022"></a><span id="l1.1022">   return NS_OK;</span>
<a href="#l1.1023"></a><span id="l1.1023"> }</span>
<a href="#l1.1024"></a><span id="l1.1024"> </span>
<a href="#l1.1025"></a><span id="l1.1025" class="difflineminus">-nsresult nsMsgDBView::GenerateURIForMsgKey(nsMsgKey aMsgKey, nsIMsgFolder *folder, nsACString &amp; aURI)</span>
<a href="#l1.1026"></a><span id="l1.1026" class="difflineplus">+nsresult</span>
<a href="#l1.1027"></a><span id="l1.1027" class="difflineplus">+nsMsgDBView::GenerateURIForMsgKey(nsMsgKey aMsgKey,</span>
<a href="#l1.1028"></a><span id="l1.1028" class="difflineplus">+                                  nsIMsgFolder *folder,</span>
<a href="#l1.1029"></a><span id="l1.1029" class="difflineplus">+                                  nsACString &amp; aURI)</span>
<a href="#l1.1030"></a><span id="l1.1030"> {</span>
<a href="#l1.1031"></a><span id="l1.1031">   NS_ENSURE_ARG(folder);</span>
<a href="#l1.1032"></a><span id="l1.1032">   return folder-&gt;GenerateMessageURI(aMsgKey, aURI);</span>
<a href="#l1.1033"></a><span id="l1.1033"> }</span>
<a href="#l1.1034"></a><span id="l1.1034"> </span>
<a href="#l1.1035"></a><span id="l1.1035" class="difflineminus">-nsresult nsMsgDBView::GetMessageEnumerator(nsISimpleEnumerator **enumerator)</span>
<a href="#l1.1036"></a><span id="l1.1036" class="difflineplus">+nsresult</span>
<a href="#l1.1037"></a><span id="l1.1037" class="difflineplus">+nsMsgDBView::GetMessageEnumerator(nsISimpleEnumerator **enumerator)</span>
<a href="#l1.1038"></a><span id="l1.1038"> {</span>
<a href="#l1.1039"></a><span id="l1.1039">   return m_db-&gt;EnumerateMessages(enumerator);</span>
<a href="#l1.1040"></a><span id="l1.1040"> }</span>
<a href="#l1.1041"></a><span id="l1.1041"> </span>
<a href="#l1.1042"></a><span id="l1.1042" class="difflineminus">-nsresult nsMsgDBView::CycleThreadedColumn(nsIDOMElement * aElement)</span>
<a href="#l1.1043"></a><span id="l1.1043" class="difflineplus">+nsresult</span>
<a href="#l1.1044"></a><span id="l1.1044" class="difflineplus">+nsMsgDBView::CycleThreadedColumn(nsIDOMElement * aElement)</span>
<a href="#l1.1045"></a><span id="l1.1045"> {</span>
<a href="#l1.1046"></a><span id="l1.1046">   nsAutoString currentView;</span>
<a href="#l1.1047"></a><span id="l1.1047"> </span>
<a href="#l1.1048"></a><span id="l1.1048" class="difflineminus">-  // toggle threaded/unthreaded mode</span>
<a href="#l1.1049"></a><span id="l1.1049" class="difflineplus">+  // Toggle threaded/unthreaded mode.</span>
<a href="#l1.1050"></a><span id="l1.1050">   aElement-&gt;GetAttribute(NS_LITERAL_STRING(&quot;currentView&quot;), currentView);</span>
<a href="#l1.1051"></a><span id="l1.1051">   if (currentView.EqualsLiteral(&quot;threaded&quot;))</span>
<a href="#l1.1052"></a><span id="l1.1052" class="difflineminus">-    aElement-&gt;SetAttribute(NS_LITERAL_STRING(&quot;currentView&quot;), NS_LITERAL_STRING(&quot;unthreaded&quot;));</span>
<a href="#l1.1053"></a><span id="l1.1053" class="difflineplus">+    aElement-&gt;SetAttribute(NS_LITERAL_STRING(&quot;currentView&quot;),</span>
<a href="#l1.1054"></a><span id="l1.1054" class="difflineplus">+                           NS_LITERAL_STRING(&quot;unthreaded&quot;));</span>
<a href="#l1.1055"></a><span id="l1.1055">   else</span>
<a href="#l1.1056"></a><span id="l1.1056" class="difflineminus">-     aElement-&gt;SetAttribute(NS_LITERAL_STRING(&quot;currentView&quot;), NS_LITERAL_STRING(&quot;threaded&quot;));</span>
<a href="#l1.1057"></a><span id="l1.1057" class="difflineminus">-</span>
<a href="#l1.1058"></a><span id="l1.1058" class="difflineminus">-  // i think we need to create a new view and switch it in this circumstance since</span>
<a href="#l1.1059"></a><span id="l1.1059" class="difflineminus">-  // we are toggline between threaded and non threaded mode.</span>
<a href="#l1.1060"></a><span id="l1.1060" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.1061"></a><span id="l1.1061" class="difflineminus">-}</span>
<a href="#l1.1062"></a><span id="l1.1062" class="difflineminus">-</span>
<a href="#l1.1063"></a><span id="l1.1063" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::IsEditable(int32_t row, nsITreeColumn* col, bool* _retval)</span>
<a href="#l1.1064"></a><span id="l1.1064" class="difflineplus">+    aElement-&gt;SetAttribute(NS_LITERAL_STRING(&quot;currentView&quot;),</span>
<a href="#l1.1065"></a><span id="l1.1065" class="difflineplus">+                           NS_LITERAL_STRING(&quot;threaded&quot;));</span>
<a href="#l1.1066"></a><span id="l1.1066" class="difflineplus">+</span>
<a href="#l1.1067"></a><span id="l1.1067" class="difflineplus">+  // I think we need to create a new view and switch it in this circumstance</span>
<a href="#l1.1068"></a><span id="l1.1068" class="difflineplus">+  // since we are toggline between threaded and non threaded mode.</span>
<a href="#l1.1069"></a><span id="l1.1069" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.1070"></a><span id="l1.1070" class="difflineplus">+}</span>
<a href="#l1.1071"></a><span id="l1.1071" class="difflineplus">+</span>
<a href="#l1.1072"></a><span id="l1.1072" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1073"></a><span id="l1.1073" class="difflineplus">+nsMsgDBView::IsEditable(int32_t row,</span>
<a href="#l1.1074"></a><span id="l1.1074" class="difflineplus">+                        nsITreeColumn* col,</span>
<a href="#l1.1075"></a><span id="l1.1075" class="difflineplus">+                        bool* _retval)</span>
<a href="#l1.1076"></a><span id="l1.1076"> {</span>
<a href="#l1.1077"></a><span id="l1.1077">   NS_ENSURE_ARG_POINTER(col);</span>
<a href="#l1.1078"></a><span id="l1.1078">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l1.1079"></a><span id="l1.1079" class="difflineminus">-  //attempt to retreive a custom column handler. If it exists call it and return</span>
<a href="#l1.1080"></a><span id="l1.1080" class="difflineplus">+  // Attempt to retreive a custom column handler. If it exists call it and</span>
<a href="#l1.1081"></a><span id="l1.1081" class="difflineplus">+  // return.</span>
<a href="#l1.1082"></a><span id="l1.1082">   const char16_t* colID;</span>
<a href="#l1.1083"></a><span id="l1.1083">   col-&gt;GetIdConst(&amp;colID);</span>
<a href="#l1.1084"></a><span id="l1.1084"> </span>
<a href="#l1.1085"></a><span id="l1.1085">   nsIMsgCustomColumnHandler* colHandler = GetColumnHandler(colID);</span>
<a href="#l1.1086"></a><span id="l1.1086"> </span>
<a href="#l1.1087"></a><span id="l1.1087">   if (colHandler)</span>
<a href="#l1.1088"></a><span id="l1.1088">   {</span>
<a href="#l1.1089"></a><span id="l1.1089">     colHandler-&gt;IsEditable(row, col, _retval);</span>
<a href="#l1.1090"></a><span id="l1.1090">     return NS_OK;</span>
<a href="#l1.1091"></a><span id="l1.1091">   }</span>
<a href="#l1.1092"></a><span id="l1.1092"> </span>
<a href="#l1.1093"></a><span id="l1.1093">   *_retval = false;</span>
<a href="#l1.1094"></a><span id="l1.1094">   return NS_OK;</span>
<a href="#l1.1095"></a><span id="l1.1095"> }</span>
<a href="#l1.1096"></a><span id="l1.1096"> </span>
<a href="#l1.1097"></a><span id="l1.1097" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::IsSelectable(int32_t row, nsITreeColumn* col, bool* _retval)</span>
<a href="#l1.1098"></a><span id="l1.1098" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1099"></a><span id="l1.1099" class="difflineplus">+nsMsgDBView::IsSelectable(int32_t row,</span>
<a href="#l1.1100"></a><span id="l1.1100" class="difflineplus">+                          nsITreeColumn* col,</span>
<a href="#l1.1101"></a><span id="l1.1101" class="difflineplus">+                          bool* _retval)</span>
<a href="#l1.1102"></a><span id="l1.1102"> {</span>
<a href="#l1.1103"></a><span id="l1.1103">   *_retval = false;</span>
<a href="#l1.1104"></a><span id="l1.1104">   return NS_OK;</span>
<a href="#l1.1105"></a><span id="l1.1105"> }</span>
<a href="#l1.1106"></a><span id="l1.1106"> </span>
<a href="#l1.1107"></a><span id="l1.1107" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::SetCellValue(int32_t row, nsITreeColumn* col, const nsAString&amp; value)</span>
<a href="#l1.1108"></a><span id="l1.1108" class="difflineminus">-{</span>
<a href="#l1.1109"></a><span id="l1.1109" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.1110"></a><span id="l1.1110" class="difflineminus">-}</span>
<a href="#l1.1111"></a><span id="l1.1111" class="difflineminus">-</span>
<a href="#l1.1112"></a><span id="l1.1112" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::SetCellText(int32_t row, nsITreeColumn* col, const nsAString&amp; value)</span>
<a href="#l1.1113"></a><span id="l1.1113" class="difflineminus">-{</span>
<a href="#l1.1114"></a><span id="l1.1114" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.1115"></a><span id="l1.1115" class="difflineminus">-}</span>
<a href="#l1.1116"></a><span id="l1.1116" class="difflineminus">-</span>
<a href="#l1.1117"></a><span id="l1.1117" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetRowCount(int32_t *aRowCount)</span>
<a href="#l1.1118"></a><span id="l1.1118" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1119"></a><span id="l1.1119" class="difflineplus">+nsMsgDBView::SetCellValue(int32_t row,</span>
<a href="#l1.1120"></a><span id="l1.1120" class="difflineplus">+                          nsITreeColumn* col,</span>
<a href="#l1.1121"></a><span id="l1.1121" class="difflineplus">+                          const nsAString&amp; value)</span>
<a href="#l1.1122"></a><span id="l1.1122" class="difflineplus">+{</span>
<a href="#l1.1123"></a><span id="l1.1123" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.1124"></a><span id="l1.1124" class="difflineplus">+}</span>
<a href="#l1.1125"></a><span id="l1.1125" class="difflineplus">+</span>
<a href="#l1.1126"></a><span id="l1.1126" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1127"></a><span id="l1.1127" class="difflineplus">+nsMsgDBView::SetCellText(int32_t row,</span>
<a href="#l1.1128"></a><span id="l1.1128" class="difflineplus">+                         nsITreeColumn* col,</span>
<a href="#l1.1129"></a><span id="l1.1129" class="difflineplus">+                         const nsAString&amp; value)</span>
<a href="#l1.1130"></a><span id="l1.1130" class="difflineplus">+{</span>
<a href="#l1.1131"></a><span id="l1.1131" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.1132"></a><span id="l1.1132" class="difflineplus">+}</span>
<a href="#l1.1133"></a><span id="l1.1133" class="difflineplus">+</span>
<a href="#l1.1134"></a><span id="l1.1134" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1135"></a><span id="l1.1135" class="difflineplus">+nsMsgDBView::GetRowCount(int32_t *aRowCount)</span>
<a href="#l1.1136"></a><span id="l1.1136"> {</span>
<a href="#l1.1137"></a><span id="l1.1137">   *aRowCount = GetSize();</span>
<a href="#l1.1138"></a><span id="l1.1138">   return NS_OK;</span>
<a href="#l1.1139"></a><span id="l1.1139"> }</span>
<a href="#l1.1140"></a><span id="l1.1140"> </span>
<a href="#l1.1141"></a><span id="l1.1141" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetSelection(nsITreeSelection * *aSelection)</span>
<a href="#l1.1142"></a><span id="l1.1142" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1143"></a><span id="l1.1143" class="difflineplus">+nsMsgDBView::GetSelection(nsITreeSelection * *aSelection)</span>
<a href="#l1.1144"></a><span id="l1.1144"> {</span>
<a href="#l1.1145"></a><span id="l1.1145">   NS_IF_ADDREF(*aSelection = mTreeSelection);</span>
<a href="#l1.1146"></a><span id="l1.1146">   return NS_OK;</span>
<a href="#l1.1147"></a><span id="l1.1147"> }</span>
<a href="#l1.1148"></a><span id="l1.1148"> </span>
<a href="#l1.1149"></a><span id="l1.1149" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::SetSelection(nsITreeSelection * aSelection)</span>
<a href="#l1.1150"></a><span id="l1.1150" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1151"></a><span id="l1.1151" class="difflineplus">+nsMsgDBView::SetSelection(nsITreeSelection * aSelection)</span>
<a href="#l1.1152"></a><span id="l1.1152"> {</span>
<a href="#l1.1153"></a><span id="l1.1153">   mTreeSelection = aSelection;</span>
<a href="#l1.1154"></a><span id="l1.1154">   return NS_OK;</span>
<a href="#l1.1155"></a><span id="l1.1155"> }</span>
<a href="#l1.1156"></a><span id="l1.1156"> </span>
<a href="#l1.1157"></a><span id="l1.1157" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::ReloadMessageWithAllParts()</span>
<a href="#l1.1158"></a><span id="l1.1158" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1159"></a><span id="l1.1159" class="difflineplus">+nsMsgDBView::ReloadMessageWithAllParts()</span>
<a href="#l1.1160"></a><span id="l1.1160"> {</span>
<a href="#l1.1161"></a><span id="l1.1161">   if (m_currentlyDisplayedMsgUri.IsEmpty() || mSuppressMsgDisplay)</span>
<a href="#l1.1162"></a><span id="l1.1162">     return NS_OK;</span>
<a href="#l1.1163"></a><span id="l1.1163"> </span>
<a href="#l1.1164"></a><span id="l1.1164">   nsAutoCString forceAllParts(m_currentlyDisplayedMsgUri);</span>
<a href="#l1.1165"></a><span id="l1.1165">   forceAllParts += (forceAllParts.FindChar('?') == kNotFound) ? '?' : '&amp;';</span>
<a href="#l1.1166"></a><span id="l1.1166">   forceAllParts.AppendLiteral(&quot;fetchCompleteMessage=true&quot;);</span>
<a href="#l1.1167"></a><span id="l1.1167">   nsCOMPtr&lt;nsIMessenger&gt; messenger (do_QueryReferent(mMessengerWeak));</span>
<a href="#l1.1168"></a><span id="l1.1168" class="difflineat">@@ -1041,37 +1125,40 @@ NS_IMETHODIMP nsMsgDBView::ReloadMessage</span>
<a href="#l1.1169"></a><span id="l1.1169"> </span>
<a href="#l1.1170"></a><span id="l1.1170">   nsresult rv = messenger-&gt;OpenURL(forceAllParts);</span>
<a href="#l1.1171"></a><span id="l1.1171">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1172"></a><span id="l1.1172"> </span>
<a href="#l1.1173"></a><span id="l1.1173">   UpdateDisplayMessage(m_currentlyDisplayedViewIndex);</span>
<a href="#l1.1174"></a><span id="l1.1174">   return NS_OK;</span>
<a href="#l1.1175"></a><span id="l1.1175"> }</span>
<a href="#l1.1176"></a><span id="l1.1176"> </span>
<a href="#l1.1177"></a><span id="l1.1177" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::ReloadMessage()</span>
<a href="#l1.1178"></a><span id="l1.1178" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1179"></a><span id="l1.1179" class="difflineplus">+nsMsgDBView::ReloadMessage()</span>
<a href="#l1.1180"></a><span id="l1.1180"> {</span>
<a href="#l1.1181"></a><span id="l1.1181">   if (m_currentlyDisplayedMsgUri.IsEmpty() || mSuppressMsgDisplay)</span>
<a href="#l1.1182"></a><span id="l1.1182">     return NS_OK;</span>
<a href="#l1.1183"></a><span id="l1.1183" class="difflineplus">+</span>
<a href="#l1.1184"></a><span id="l1.1184">   nsCOMPtr&lt;nsIMessenger&gt; messenger (do_QueryReferent(mMessengerWeak));</span>
<a href="#l1.1185"></a><span id="l1.1185">   NS_ENSURE_TRUE(messenger, NS_ERROR_FAILURE);</span>
<a href="#l1.1186"></a><span id="l1.1186"> </span>
<a href="#l1.1187"></a><span id="l1.1187">   nsresult rv = messenger-&gt;OpenURL(m_currentlyDisplayedMsgUri);</span>
<a href="#l1.1188"></a><span id="l1.1188">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1189"></a><span id="l1.1189"> </span>
<a href="#l1.1190"></a><span id="l1.1190">   UpdateDisplayMessage(m_currentlyDisplayedViewIndex);</span>
<a href="#l1.1191"></a><span id="l1.1191">   return NS_OK;</span>
<a href="#l1.1192"></a><span id="l1.1192"> }</span>
<a href="#l1.1193"></a><span id="l1.1193"> </span>
<a href="#l1.1194"></a><span id="l1.1194" class="difflineminus">-nsresult nsMsgDBView::UpdateDisplayMessage(nsMsgViewIndex viewPosition)</span>
<a href="#l1.1195"></a><span id="l1.1195" class="difflineplus">+nsresult</span>
<a href="#l1.1196"></a><span id="l1.1196" class="difflineplus">+nsMsgDBView::UpdateDisplayMessage(nsMsgViewIndex viewPosition)</span>
<a href="#l1.1197"></a><span id="l1.1197"> {</span>
<a href="#l1.1198"></a><span id="l1.1198">   nsresult rv;</span>
<a href="#l1.1199"></a><span id="l1.1199">   if (mCommandUpdater)</span>
<a href="#l1.1200"></a><span id="l1.1200">   {</span>
<a href="#l1.1201"></a><span id="l1.1201" class="difflineminus">-    // get the subject and the folder for the message and inform the front end that</span>
<a href="#l1.1202"></a><span id="l1.1202" class="difflineminus">-    // we changed the message we are currently displaying.</span>
<a href="#l1.1203"></a><span id="l1.1203" class="difflineplus">+    // Get the subject and the folder for the message and inform the front</span>
<a href="#l1.1204"></a><span id="l1.1204" class="difflineplus">+    // end that we changed the message we are currently displaying.</span>
<a href="#l1.1205"></a><span id="l1.1205">     if (viewPosition != nsMsgViewIndex_None)</span>
<a href="#l1.1206"></a><span id="l1.1206">     {</span>
<a href="#l1.1207"></a><span id="l1.1207">       nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.1208"></a><span id="l1.1208">       rv = GetMsgHdrForViewIndex(viewPosition, getter_AddRefs(msgHdr));</span>
<a href="#l1.1209"></a><span id="l1.1209">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.1210"></a><span id="l1.1210"> </span>
<a href="#l1.1211"></a><span id="l1.1211">       nsString subject;</span>
<a href="#l1.1212"></a><span id="l1.1212">       FetchSubject(msgHdr, m_flags[viewPosition], subject);</span>
<a href="#l1.1213"></a><span id="l1.1213" class="difflineat">@@ -1086,172 +1173,199 @@ nsresult nsMsgDBView::UpdateDisplayMessa</span>
<a href="#l1.1214"></a><span id="l1.1214"> </span>
<a href="#l1.1215"></a><span id="l1.1215">       if (folder)</span>
<a href="#l1.1216"></a><span id="l1.1216">       {</span>
<a href="#l1.1217"></a><span id="l1.1217">         rv = folder-&gt;SetLastMessageLoaded(m_keys[viewPosition]);</span>
<a href="#l1.1218"></a><span id="l1.1218">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.1219"></a><span id="l1.1219">       }</span>
<a href="#l1.1220"></a><span id="l1.1220">     } // if view position is valid</span>
<a href="#l1.1221"></a><span id="l1.1221">   } // if we have an updater</span>
<a href="#l1.1222"></a><span id="l1.1222" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.1223"></a><span id="l1.1223" class="difflineminus">-}</span>
<a href="#l1.1224"></a><span id="l1.1224" class="difflineminus">-</span>
<a href="#l1.1225"></a><span id="l1.1225" class="difflineminus">-// given a msg key, we will load the message for it.</span>
<a href="#l1.1226"></a><span id="l1.1226" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::LoadMessageByMsgKey(nsMsgKey aMsgKey)</span>
<a href="#l1.1227"></a><span id="l1.1227" class="difflineplus">+</span>
<a href="#l1.1228"></a><span id="l1.1228" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.1229"></a><span id="l1.1229" class="difflineplus">+}</span>
<a href="#l1.1230"></a><span id="l1.1230" class="difflineplus">+</span>
<a href="#l1.1231"></a><span id="l1.1231" class="difflineplus">+// Given a msg key, we will load the message for it.</span>
<a href="#l1.1232"></a><span id="l1.1232" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1233"></a><span id="l1.1233" class="difflineplus">+nsMsgDBView::LoadMessageByMsgKey(nsMsgKey aMsgKey)</span>
<a href="#l1.1234"></a><span id="l1.1234"> {</span>
<a href="#l1.1235"></a><span id="l1.1235">   return LoadMessageByViewIndex(FindKey(aMsgKey, false));</span>
<a href="#l1.1236"></a><span id="l1.1236"> }</span>
<a href="#l1.1237"></a><span id="l1.1237"> </span>
<a href="#l1.1238"></a><span id="l1.1238" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::LoadMessageByViewIndex(nsMsgViewIndex aViewIndex)</span>
<a href="#l1.1239"></a><span id="l1.1239" class="difflineminus">-{</span>
<a href="#l1.1240"></a><span id="l1.1240" class="difflineminus">-  NS_ASSERTION(aViewIndex != nsMsgViewIndex_None,&quot;trying to load nsMsgViewIndex_None&quot;);</span>
<a href="#l1.1241"></a><span id="l1.1241" class="difflineminus">-  if (aViewIndex == nsMsgViewIndex_None) return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.1242"></a><span id="l1.1242" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1243"></a><span id="l1.1243" class="difflineplus">+nsMsgDBView::LoadMessageByViewIndex(nsMsgViewIndex aViewIndex)</span>
<a href="#l1.1244"></a><span id="l1.1244" class="difflineplus">+{</span>
<a href="#l1.1245"></a><span id="l1.1245" class="difflineplus">+  NS_ASSERTION(aViewIndex != nsMsgViewIndex_None,</span>
<a href="#l1.1246"></a><span id="l1.1246" class="difflineplus">+               &quot;trying to load nsMsgViewIndex_None&quot;);</span>
<a href="#l1.1247"></a><span id="l1.1247" class="difflineplus">+  if (aViewIndex == nsMsgViewIndex_None)</span>
<a href="#l1.1248"></a><span id="l1.1248" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.1249"></a><span id="l1.1249"> </span>
<a href="#l1.1250"></a><span id="l1.1250">   nsCString uri;</span>
<a href="#l1.1251"></a><span id="l1.1251">   nsresult rv = GetURIForViewIndex(aViewIndex, uri);</span>
<a href="#l1.1252"></a><span id="l1.1252">   if (!mSuppressMsgDisplay &amp;&amp; !m_currentlyDisplayedMsgUri.Equals(uri))</span>
<a href="#l1.1253"></a><span id="l1.1253">   {</span>
<a href="#l1.1254"></a><span id="l1.1254">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.1255"></a><span id="l1.1255">     nsCOMPtr&lt;nsIMessenger&gt; messenger (do_QueryReferent(mMessengerWeak));</span>
<a href="#l1.1256"></a><span id="l1.1256">     NS_ENSURE_TRUE(messenger, NS_ERROR_FAILURE);</span>
<a href="#l1.1257"></a><span id="l1.1257">     messenger-&gt;OpenURL(uri);</span>
<a href="#l1.1258"></a><span id="l1.1258">     m_currentlyDisplayedMsgKey = m_keys[aViewIndex];</span>
<a href="#l1.1259"></a><span id="l1.1259">     m_currentlyDisplayedMsgUri = uri;</span>
<a href="#l1.1260"></a><span id="l1.1260">     m_currentlyDisplayedViewIndex = aViewIndex;</span>
<a href="#l1.1261"></a><span id="l1.1261">     UpdateDisplayMessage(m_currentlyDisplayedViewIndex);</span>
<a href="#l1.1262"></a><span id="l1.1262">   }</span>
<a href="#l1.1263"></a><span id="l1.1263" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.1264"></a><span id="l1.1264" class="difflineminus">-}</span>
<a href="#l1.1265"></a><span id="l1.1265" class="difflineminus">-</span>
<a href="#l1.1266"></a><span id="l1.1266" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::LoadMessageByUrl(const char *aUrl)</span>
<a href="#l1.1267"></a><span id="l1.1267" class="difflineplus">+</span>
<a href="#l1.1268"></a><span id="l1.1268" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.1269"></a><span id="l1.1269" class="difflineplus">+}</span>
<a href="#l1.1270"></a><span id="l1.1270" class="difflineplus">+</span>
<a href="#l1.1271"></a><span id="l1.1271" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1272"></a><span id="l1.1272" class="difflineplus">+nsMsgDBView::LoadMessageByUrl(const char *aUrl)</span>
<a href="#l1.1273"></a><span id="l1.1273"> {</span>
<a href="#l1.1274"></a><span id="l1.1274">   NS_ASSERTION(aUrl, &quot;trying to load a null url&quot;);</span>
<a href="#l1.1275"></a><span id="l1.1275">   if (!mSuppressMsgDisplay)</span>
<a href="#l1.1276"></a><span id="l1.1276">   {</span>
<a href="#l1.1277"></a><span id="l1.1277">     nsresult rv;</span>
<a href="#l1.1278"></a><span id="l1.1278">     nsCOMPtr&lt;nsIMessenger&gt; messenger (do_QueryReferent(mMessengerWeak, &amp;rv));</span>
<a href="#l1.1279"></a><span id="l1.1279">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1280"></a><span id="l1.1280">     messenger-&gt;LoadURL(NULL, nsDependentCString(aUrl));</span>
<a href="#l1.1281"></a><span id="l1.1281">     m_currentlyDisplayedMsgKey = nsMsgKey_None;</span>
<a href="#l1.1282"></a><span id="l1.1282">     m_currentlyDisplayedMsgUri = aUrl;</span>
<a href="#l1.1283"></a><span id="l1.1283">     m_currentlyDisplayedViewIndex = nsMsgViewIndex_None;</span>
<a href="#l1.1284"></a><span id="l1.1284">   }</span>
<a href="#l1.1285"></a><span id="l1.1285" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.1286"></a><span id="l1.1286" class="difflineminus">-}</span>
<a href="#l1.1287"></a><span id="l1.1287" class="difflineminus">-</span>
<a href="#l1.1288"></a><span id="l1.1288" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::SelectionChanged()</span>
<a href="#l1.1289"></a><span id="l1.1289" class="difflineminus">-{</span>
<a href="#l1.1290"></a><span id="l1.1290" class="difflineminus">-  // if the currentSelection changed then we have a message to display - not if we are in the middle of deleting rows</span>
<a href="#l1.1291"></a><span id="l1.1291" class="difflineplus">+</span>
<a href="#l1.1292"></a><span id="l1.1292" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.1293"></a><span id="l1.1293" class="difflineplus">+}</span>
<a href="#l1.1294"></a><span id="l1.1294" class="difflineplus">+</span>
<a href="#l1.1295"></a><span id="l1.1295" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1296"></a><span id="l1.1296" class="difflineplus">+nsMsgDBView::SelectionChanged()</span>
<a href="#l1.1297"></a><span id="l1.1297" class="difflineplus">+{</span>
<a href="#l1.1298"></a><span id="l1.1298" class="difflineplus">+  // If the currentSelection changed then we have a message to display -</span>
<a href="#l1.1299"></a><span id="l1.1299" class="difflineplus">+  // not if we are in the middle of deleting rows.</span>
<a href="#l1.1300"></a><span id="l1.1300">   if (m_deletingRows)</span>
<a href="#l1.1301"></a><span id="l1.1301">     return NS_OK;</span>
<a href="#l1.1302"></a><span id="l1.1302"> </span>
<a href="#l1.1303"></a><span id="l1.1303">   uint32_t numSelected = 0;</span>
<a href="#l1.1304"></a><span id="l1.1304"> </span>
<a href="#l1.1305"></a><span id="l1.1305">   nsMsgViewIndexArray selection;</span>
<a href="#l1.1306"></a><span id="l1.1306">   GetSelectedIndices(selection);</span>
<a href="#l1.1307"></a><span id="l1.1307">   nsMsgViewIndex *indices = selection.Elements();</span>
<a href="#l1.1308"></a><span id="l1.1308">   numSelected = selection.Length();</span>
<a href="#l1.1309"></a><span id="l1.1309"> </span>
<a href="#l1.1310"></a><span id="l1.1310">   bool commandsNeedDisablingBecauseOfSelection = false;</span>
<a href="#l1.1311"></a><span id="l1.1311"> </span>
<a href="#l1.1312"></a><span id="l1.1312">   if(indices)</span>
<a href="#l1.1313"></a><span id="l1.1313">   {</span>
<a href="#l1.1314"></a><span id="l1.1314">     if (WeAreOffline())</span>
<a href="#l1.1315"></a><span id="l1.1315">       commandsNeedDisablingBecauseOfSelection = !OfflineMsgSelected(indices, numSelected);</span>
<a href="#l1.1316"></a><span id="l1.1316" class="difflineplus">+</span>
<a href="#l1.1317"></a><span id="l1.1317">     if (!NonDummyMsgSelected(indices, numSelected))</span>
<a href="#l1.1318"></a><span id="l1.1318">       commandsNeedDisablingBecauseOfSelection = true;</span>
<a href="#l1.1319"></a><span id="l1.1319">   }</span>
<a href="#l1.1320"></a><span id="l1.1320" class="difflineplus">+</span>
<a href="#l1.1321"></a><span id="l1.1321">   bool selectionSummarized = false;</span>
<a href="#l1.1322"></a><span id="l1.1322">   mSummarizeFailed = false;</span>
<a href="#l1.1323"></a><span id="l1.1323" class="difflineminus">-  // let the front-end adjust the message pane appropriately with either</span>
<a href="#l1.1324"></a><span id="l1.1324" class="difflineminus">-  // the message body, or a summary of the selection</span>
<a href="#l1.1325"></a><span id="l1.1325" class="difflineplus">+  // Let the front-end adjust the message pane appropriately with either</span>
<a href="#l1.1326"></a><span id="l1.1326" class="difflineplus">+  // the message body, or a summary of the selection.</span>
<a href="#l1.1327"></a><span id="l1.1327">   if (mCommandUpdater)</span>
<a href="#l1.1328"></a><span id="l1.1328">   {</span>
<a href="#l1.1329"></a><span id="l1.1329">     mCommandUpdater-&gt;SummarizeSelection(&amp;selectionSummarized);</span>
<a href="#l1.1330"></a><span id="l1.1330" class="difflineminus">-    // check if the selection was not summarized, but we expected it to be,</span>
<a href="#l1.1331"></a><span id="l1.1331" class="difflineplus">+    // Check if the selection was not summarized, but we expected it to be,</span>
<a href="#l1.1332"></a><span id="l1.1332">     // and if so, remember it so GetHeadersFromSelection won't include</span>
<a href="#l1.1333"></a><span id="l1.1333">     // the messages in collapsed threads.</span>
<a href="#l1.1334"></a><span id="l1.1334">     if (!selectionSummarized &amp;&amp;</span>
<a href="#l1.1335"></a><span id="l1.1335">         (numSelected &gt; 1 || (numSelected == 1 &amp;&amp;</span>
<a href="#l1.1336"></a><span id="l1.1336" class="difflineminus">-                              m_flags[indices[0]] &amp; nsMsgMessageFlags::Elided &amp;&amp;</span>
<a href="#l1.1337"></a><span id="l1.1337" class="difflineminus">-                              OperateOnMsgsInCollapsedThreads())))</span>
<a href="#l1.1338"></a><span id="l1.1338" class="difflineplus">+                             m_flags[indices[0]] &amp; nsMsgMessageFlags::Elided &amp;&amp;</span>
<a href="#l1.1339"></a><span id="l1.1339" class="difflineplus">+                             OperateOnMsgsInCollapsedThreads())))</span>
<a href="#l1.1340"></a><span id="l1.1340" class="difflineplus">+    {</span>
<a href="#l1.1341"></a><span id="l1.1341">       mSummarizeFailed = true;</span>
<a href="#l1.1342"></a><span id="l1.1342" class="difflineplus">+    }</span>
<a href="#l1.1343"></a><span id="l1.1343">   }</span>
<a href="#l1.1344"></a><span id="l1.1344"> </span>
<a href="#l1.1345"></a><span id="l1.1345">   bool summaryStateChanged = selectionSummarized != mSelectionSummarized;</span>
<a href="#l1.1346"></a><span id="l1.1346" class="difflineminus">-</span>
<a href="#l1.1347"></a><span id="l1.1347">   mSelectionSummarized = selectionSummarized;</span>
<a href="#l1.1348"></a><span id="l1.1348" class="difflineminus">-  // if only one item is selected then we want to display a message</span>
<a href="#l1.1349"></a><span id="l1.1349" class="difflineplus">+</span>
<a href="#l1.1350"></a><span id="l1.1350" class="difflineplus">+  // If only one item is selected then we want to display a message.</span>
<a href="#l1.1351"></a><span id="l1.1351">   if (mTreeSelection &amp;&amp; numSelected == 1 &amp;&amp; !selectionSummarized)</span>
<a href="#l1.1352"></a><span id="l1.1352">   {</span>
<a href="#l1.1353"></a><span id="l1.1353">     int32_t startRange;</span>
<a href="#l1.1354"></a><span id="l1.1354">     int32_t endRange;</span>
<a href="#l1.1355"></a><span id="l1.1355">     nsresult rv = mTreeSelection-&gt;GetRangeAt(0, &amp;startRange, &amp;endRange);</span>
<a href="#l1.1356"></a><span id="l1.1356" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, NS_OK); // tree doesn't care if we failed</span>
<a href="#l1.1357"></a><span id="l1.1357" class="difflineplus">+    // Tree doesn't care if we failed.</span>
<a href="#l1.1358"></a><span id="l1.1358" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l1.1359"></a><span id="l1.1359"> </span>
<a href="#l1.1360"></a><span id="l1.1360">     if (startRange &gt;= 0 &amp;&amp; startRange == endRange &amp;&amp;</span>
<a href="#l1.1361"></a><span id="l1.1361">         uint32_t(startRange) &lt; GetSize())</span>
<a href="#l1.1362"></a><span id="l1.1362">     {</span>
<a href="#l1.1363"></a><span id="l1.1363">       if (!mRemovingRow)</span>
<a href="#l1.1364"></a><span id="l1.1364">       {</span>
<a href="#l1.1365"></a><span id="l1.1365">         if (!mSuppressMsgDisplay)</span>
<a href="#l1.1366"></a><span id="l1.1366">           LoadMessageByViewIndex(startRange);</span>
<a href="#l1.1367"></a><span id="l1.1367">         else</span>
<a href="#l1.1368"></a><span id="l1.1368">           UpdateDisplayMessage(startRange);</span>
<a href="#l1.1369"></a><span id="l1.1369">       }</span>
<a href="#l1.1370"></a><span id="l1.1370">     }</span>
<a href="#l1.1371"></a><span id="l1.1371">     else</span>
<a href="#l1.1372"></a><span id="l1.1372" class="difflineminus">-      numSelected = 0; // selection seems bogus, so set to 0.</span>
<a href="#l1.1373"></a><span id="l1.1373" class="difflineplus">+    {</span>
<a href="#l1.1374"></a><span id="l1.1374" class="difflineplus">+      // Selection seems bogus, so set to 0.</span>
<a href="#l1.1375"></a><span id="l1.1375" class="difflineplus">+      numSelected = 0;</span>
<a href="#l1.1376"></a><span id="l1.1376" class="difflineplus">+    }</span>
<a href="#l1.1377"></a><span id="l1.1377">   }</span>
<a href="#l1.1378"></a><span id="l1.1378">   else {</span>
<a href="#l1.1379"></a><span id="l1.1379" class="difflineminus">-    // if we have zero or multiple items selected, we shouldn't be displaying any message</span>
<a href="#l1.1380"></a><span id="l1.1380" class="difflineplus">+    // If we have zero or multiple items selected, we shouldn't be displaying</span>
<a href="#l1.1381"></a><span id="l1.1381" class="difflineplus">+    // any message.</span>
<a href="#l1.1382"></a><span id="l1.1382">     m_currentlyDisplayedMsgKey = nsMsgKey_None;</span>
<a href="#l1.1383"></a><span id="l1.1383">     m_currentlyDisplayedMsgUri.Truncate();</span>
<a href="#l1.1384"></a><span id="l1.1384">     m_currentlyDisplayedViewIndex = nsMsgViewIndex_None;</span>
<a href="#l1.1385"></a><span id="l1.1385">   }</span>
<a href="#l1.1386"></a><span id="l1.1386"> </span>
<a href="#l1.1387"></a><span id="l1.1387" class="difflineminus">-  // determine if we need to push command update notifications out to the UI or not.</span>
<a href="#l1.1388"></a><span id="l1.1388" class="difflineminus">-</span>
<a href="#l1.1389"></a><span id="l1.1389" class="difflineminus">-  // we need to push a command update notification iff, one of the following conditions are met</span>
<a href="#l1.1390"></a><span id="l1.1390" class="difflineplus">+  // Determine if we need to push command update notifications out to the UI.</span>
<a href="#l1.1391"></a><span id="l1.1391" class="difflineplus">+  // We need to push a command update notification iff, one of the following</span>
<a href="#l1.1392"></a><span id="l1.1392" class="difflineplus">+  // conditions are met</span>
<a href="#l1.1393"></a><span id="l1.1393">   // (1) the selection went from 0 to 1</span>
<a href="#l1.1394"></a><span id="l1.1394">   // (2) it went from 1 to 0</span>
<a href="#l1.1395"></a><span id="l1.1395">   // (3) it went from 1 to many</span>
<a href="#l1.1396"></a><span id="l1.1396">   // (4) it went from many to 1 or 0</span>
<a href="#l1.1397"></a><span id="l1.1397" class="difflineminus">-  // (5) a different msg was selected - perhaps it was offline or not...matters only when we are offline</span>
<a href="#l1.1398"></a><span id="l1.1398" class="difflineminus">-  // (6) we did a forward/back, or went from having no history to having history - not sure how to tell this.</span>
<a href="#l1.1399"></a><span id="l1.1399" class="difflineplus">+  // (5) a different msg was selected - perhaps it was offline or not,</span>
<a href="#l1.1400"></a><span id="l1.1400" class="difflineplus">+  //     matters only when we are offline</span>
<a href="#l1.1401"></a><span id="l1.1401" class="difflineplus">+  // (6) we did a forward/back, or went from having no history to having</span>
<a href="#l1.1402"></a><span id="l1.1402" class="difflineplus">+  //     history - not sure how to tell this.</span>
<a href="#l1.1403"></a><span id="l1.1403">   // (7) whether the selection was summarized or not changed.</span>
<a href="#l1.1404"></a><span id="l1.1404"> </span>
<a href="#l1.1405"></a><span id="l1.1405" class="difflineminus">-  // I think we're going to need to keep track of whether forward/back were enabled/should be enabled,</span>
<a href="#l1.1406"></a><span id="l1.1406" class="difflineminus">-  // and when this changes, force a command update.</span>
<a href="#l1.1407"></a><span id="l1.1407" class="difflineplus">+  // I think we're going to need to keep track of whether forward/back were</span>
<a href="#l1.1408"></a><span id="l1.1408" class="difflineplus">+  // enabled/should be enabled, and when this changes, force a command update.</span>
<a href="#l1.1409"></a><span id="l1.1409"> </span>
<a href="#l1.1410"></a><span id="l1.1410">   bool enableGoForward = false;</span>
<a href="#l1.1411"></a><span id="l1.1411">   bool enableGoBack = false;</span>
<a href="#l1.1412"></a><span id="l1.1412"> </span>
<a href="#l1.1413"></a><span id="l1.1413">   NavigateStatus(nsMsgNavigationType::forward, &amp;enableGoForward);</span>
<a href="#l1.1414"></a><span id="l1.1414">   NavigateStatus(nsMsgNavigationType::back, &amp;enableGoBack);</span>
<a href="#l1.1415"></a><span id="l1.1415">   if (!summaryStateChanged &amp;&amp;</span>
<a href="#l1.1416"></a><span id="l1.1416">       (numSelected == mNumSelectedRows ||</span>
<a href="#l1.1417"></a><span id="l1.1417" class="difflineminus">-      (numSelected &gt; 1 &amp;&amp; mNumSelectedRows &gt; 1)) &amp;&amp; (commandsNeedDisablingBecauseOfSelection == mCommandsNeedDisablingBecauseOfSelection)</span>
<a href="#l1.1418"></a><span id="l1.1418" class="difflineminus">-      &amp;&amp; enableGoForward == mGoForwardEnabled &amp;&amp; enableGoBack == mGoBackEnabled)</span>
<a href="#l1.1419"></a><span id="l1.1419" class="difflineminus">-  {</span>
<a href="#l1.1420"></a><span id="l1.1420" class="difflineminus">-  }</span>
<a href="#l1.1421"></a><span id="l1.1421" class="difflineminus">-  // don't update commands if we're suppressing them, or if we're removing rows, unless it was the last row.</span>
<a href="#l1.1422"></a><span id="l1.1422" class="difflineminus">-  else if (!mSuppressCommandUpdating &amp;&amp; mCommandUpdater &amp;&amp; (!mRemovingRow || GetSize() == 0)) // o.t. push an updated</span>
<a href="#l1.1423"></a><span id="l1.1423" class="difflineplus">+       (numSelected &gt; 1 &amp;&amp; mNumSelectedRows &gt; 1)) &amp;&amp;</span>
<a href="#l1.1424"></a><span id="l1.1424" class="difflineplus">+      commandsNeedDisablingBecauseOfSelection == mCommandsNeedDisablingBecauseOfSelection &amp;&amp;</span>
<a href="#l1.1425"></a><span id="l1.1425" class="difflineplus">+      enableGoForward == mGoForwardEnabled &amp;&amp;</span>
<a href="#l1.1426"></a><span id="l1.1426" class="difflineplus">+      enableGoBack == mGoBackEnabled)</span>
<a href="#l1.1427"></a><span id="l1.1427" class="difflineplus">+  {</span>
<a href="#l1.1428"></a><span id="l1.1428" class="difflineplus">+    // Don't update commands if we're suppressing them, or if we're removing</span>
<a href="#l1.1429"></a><span id="l1.1429" class="difflineplus">+    // rows, unless it was the last row.</span>
<a href="#l1.1430"></a><span id="l1.1430" class="difflineplus">+  }</span>
<a href="#l1.1431"></a><span id="l1.1431" class="difflineplus">+  else if (!mSuppressCommandUpdating &amp;&amp;</span>
<a href="#l1.1432"></a><span id="l1.1432" class="difflineplus">+           mCommandUpdater &amp;&amp;</span>
<a href="#l1.1433"></a><span id="l1.1433" class="difflineplus">+           (!mRemovingRow || GetSize() == 0))</span>
<a href="#l1.1434"></a><span id="l1.1434">   {</span>
<a href="#l1.1435"></a><span id="l1.1435">     mCommandUpdater-&gt;UpdateCommandStatus();</span>
<a href="#l1.1436"></a><span id="l1.1436">   }</span>
<a href="#l1.1437"></a><span id="l1.1437"> </span>
<a href="#l1.1438"></a><span id="l1.1438">   mCommandsNeedDisablingBecauseOfSelection = commandsNeedDisablingBecauseOfSelection;</span>
<a href="#l1.1439"></a><span id="l1.1439">   mGoForwardEnabled = enableGoForward;</span>
<a href="#l1.1440"></a><span id="l1.1440">   mGoBackEnabled = enableGoBack;</span>
<a href="#l1.1441"></a><span id="l1.1441">   mNumSelectedRows = numSelected;</span>
<a href="#l1.1442"></a><span id="l1.1442">   return NS_OK;</span>
<a href="#l1.1443"></a><span id="l1.1443"> }</span>
<a href="#l1.1444"></a><span id="l1.1444"> </span>
<a href="#l1.1445"></a><span id="l1.1445" class="difflineminus">-nsresult nsMsgDBView::GetSelectedIndices(nsMsgViewIndexArray&amp; selection)</span>
<a href="#l1.1446"></a><span id="l1.1446" class="difflineplus">+nsresult</span>
<a href="#l1.1447"></a><span id="l1.1447" class="difflineplus">+nsMsgDBView::GetSelectedIndices(nsMsgViewIndexArray&amp; selection)</span>
<a href="#l1.1448"></a><span id="l1.1448"> {</span>
<a href="#l1.1449"></a><span id="l1.1449">   if (mTreeSelection)</span>
<a href="#l1.1450"></a><span id="l1.1450">   {</span>
<a href="#l1.1451"></a><span id="l1.1451">     int32_t viewSize = GetSize();</span>
<a href="#l1.1452"></a><span id="l1.1452">     int32_t count;</span>
<a href="#l1.1453"></a><span id="l1.1453">     mTreeSelection-&gt;GetCount(&amp;count);</span>
<a href="#l1.1454"></a><span id="l1.1454">     selection.SetLength(count);</span>
<a href="#l1.1455"></a><span id="l1.1455">     count = 0;</span>
<a href="#l1.1456"></a><span id="l1.1456" class="difflineat">@@ -1259,81 +1373,96 @@ nsresult nsMsgDBView::GetSelectedIndices</span>
<a href="#l1.1457"></a><span id="l1.1457">     mTreeSelection-&gt;GetRangeCount(&amp;selectionCount);</span>
<a href="#l1.1458"></a><span id="l1.1458">     for (int32_t i = 0; i &lt; selectionCount; i++)</span>
<a href="#l1.1459"></a><span id="l1.1459">     {</span>
<a href="#l1.1460"></a><span id="l1.1460">       int32_t startRange = -1;</span>
<a href="#l1.1461"></a><span id="l1.1461">       int32_t endRange = -1;</span>
<a href="#l1.1462"></a><span id="l1.1462">       mTreeSelection-&gt;GetRangeAt(i, &amp;startRange, &amp;endRange);</span>
<a href="#l1.1463"></a><span id="l1.1463">       if (startRange &gt;= 0 &amp;&amp; startRange &lt; viewSize)</span>
<a href="#l1.1464"></a><span id="l1.1464">       {</span>
<a href="#l1.1465"></a><span id="l1.1465" class="difflineminus">-        for (int32_t rangeIndex = startRange; rangeIndex &lt;= endRange &amp;&amp; rangeIndex &lt; viewSize; rangeIndex++)</span>
<a href="#l1.1466"></a><span id="l1.1466" class="difflineplus">+        for (int32_t rangeIndex = startRange;</span>
<a href="#l1.1467"></a><span id="l1.1467" class="difflineplus">+             rangeIndex &lt;= endRange &amp;&amp; rangeIndex &lt; viewSize;</span>
<a href="#l1.1468"></a><span id="l1.1468" class="difflineplus">+             rangeIndex++)</span>
<a href="#l1.1469"></a><span id="l1.1469" class="difflineplus">+        {</span>
<a href="#l1.1470"></a><span id="l1.1470">           selection[count++] = rangeIndex;</span>
<a href="#l1.1471"></a><span id="l1.1471" class="difflineplus">+        }</span>
<a href="#l1.1472"></a><span id="l1.1472">       }</span>
<a href="#l1.1473"></a><span id="l1.1473">     }</span>
<a href="#l1.1474"></a><span id="l1.1474" class="difflineminus">-    NS_ASSERTION(selection.Length() == uint32_t(count), &quot;selection count is wrong&quot;);</span>
<a href="#l1.1475"></a><span id="l1.1475" class="difflineplus">+</span>
<a href="#l1.1476"></a><span id="l1.1476" class="difflineplus">+    NS_ASSERTION(selection.Length() == uint32_t(count),</span>
<a href="#l1.1477"></a><span id="l1.1477" class="difflineplus">+                 &quot;selection count is wrong&quot;);</span>
<a href="#l1.1478"></a><span id="l1.1478">     selection.SetLength(count);</span>
<a href="#l1.1479"></a><span id="l1.1479">   }</span>
<a href="#l1.1480"></a><span id="l1.1480">   else</span>
<a href="#l1.1481"></a><span id="l1.1481">   {</span>
<a href="#l1.1482"></a><span id="l1.1482" class="difflineminus">-    // if there is no tree selection object then we must be in stand alone message mode.</span>
<a href="#l1.1483"></a><span id="l1.1483" class="difflineminus">-    // in that case the selected indices are really just the current message key.</span>
<a href="#l1.1484"></a><span id="l1.1484" class="difflineplus">+    // If there is no tree selection object then we must be in stand alone</span>
<a href="#l1.1485"></a><span id="l1.1485" class="difflineplus">+    // message mode. In that case the selected indices are really just the</span>
<a href="#l1.1486"></a><span id="l1.1486" class="difflineplus">+    // current message key.</span>
<a href="#l1.1487"></a><span id="l1.1487">     nsMsgViewIndex viewIndex = FindViewIndex(m_currentlyDisplayedMsgKey);</span>
<a href="#l1.1488"></a><span id="l1.1488">     if (viewIndex != nsMsgViewIndex_None)</span>
<a href="#l1.1489"></a><span id="l1.1489">       selection.AppendElement(viewIndex);</span>
<a href="#l1.1490"></a><span id="l1.1490">   }</span>
<a href="#l1.1491"></a><span id="l1.1491" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.1492"></a><span id="l1.1492" class="difflineminus">-}</span>
<a href="#l1.1493"></a><span id="l1.1493" class="difflineminus">-</span>
<a href="#l1.1494"></a><span id="l1.1494" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetRowProperties(int32_t index, nsAString&amp; properties)</span>
<a href="#l1.1495"></a><span id="l1.1495" class="difflineplus">+</span>
<a href="#l1.1496"></a><span id="l1.1496" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.1497"></a><span id="l1.1497" class="difflineplus">+}</span>
<a href="#l1.1498"></a><span id="l1.1498" class="difflineplus">+</span>
<a href="#l1.1499"></a><span id="l1.1499" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1500"></a><span id="l1.1500" class="difflineplus">+nsMsgDBView::GetRowProperties(int32_t index,</span>
<a href="#l1.1501"></a><span id="l1.1501" class="difflineplus">+                              nsAString&amp; properties)</span>
<a href="#l1.1502"></a><span id="l1.1502"> {</span>
<a href="#l1.1503"></a><span id="l1.1503">   if (!IsValidIndex(index))</span>
<a href="#l1.1504"></a><span id="l1.1504">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1505"></a><span id="l1.1505"> </span>
<a href="#l1.1506"></a><span id="l1.1506" class="difflineminus">-  // this is where we tell the tree to apply styles to a particular row</span>
<a href="#l1.1507"></a><span id="l1.1507" class="difflineplus">+  // This is where we tell the tree to apply styles to a particular row.</span>
<a href="#l1.1508"></a><span id="l1.1508">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.1509"></a><span id="l1.1509">   nsresult rv = NS_OK;</span>
<a href="#l1.1510"></a><span id="l1.1510"> </span>
<a href="#l1.1511"></a><span id="l1.1511">   rv = GetMsgHdrForViewIndex(index, getter_AddRefs(msgHdr));</span>
<a href="#l1.1512"></a><span id="l1.1512"> </span>
<a href="#l1.1513"></a><span id="l1.1513" class="difflineminus">-  if (NS_FAILED(rv) || !msgHdr) {</span>
<a href="#l1.1514"></a><span id="l1.1514" class="difflineplus">+  if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l1.1515"></a><span id="l1.1515" class="difflineplus">+  {</span>
<a href="#l1.1516"></a><span id="l1.1516">     ClearHdrCache();</span>
<a href="#l1.1517"></a><span id="l1.1517">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1518"></a><span id="l1.1518">   }</span>
<a href="#l1.1519"></a><span id="l1.1519"> </span>
<a href="#l1.1520"></a><span id="l1.1520">   nsCString keywordProperty;</span>
<a href="#l1.1521"></a><span id="l1.1521">   FetchRowKeywords(index, msgHdr, keywordProperty);</span>
<a href="#l1.1522"></a><span id="l1.1522">   if (!keywordProperty.IsEmpty())</span>
<a href="#l1.1523"></a><span id="l1.1523">     AppendKeywordProperties(keywordProperty, properties, false);</span>
<a href="#l1.1524"></a><span id="l1.1524"> </span>
<a href="#l1.1525"></a><span id="l1.1525" class="difflineminus">-  // give the custom column handlers a chance to style the row.</span>
<a href="#l1.1526"></a><span id="l1.1526" class="difflineplus">+  // Give the custom column handlers a chance to style the row.</span>
<a href="#l1.1527"></a><span id="l1.1527">   for (int i = 0; i &lt; m_customColumnHandlers.Count(); i++)</span>
<a href="#l1.1528"></a><span id="l1.1528">   {</span>
<a href="#l1.1529"></a><span id="l1.1529">     nsString extra;</span>
<a href="#l1.1530"></a><span id="l1.1530">     m_customColumnHandlers[i]-&gt;GetRowProperties(index, extra);</span>
<a href="#l1.1531"></a><span id="l1.1531">     if (!extra.IsEmpty())</span>
<a href="#l1.1532"></a><span id="l1.1532">     {</span>
<a href="#l1.1533"></a><span id="l1.1533">       properties.Append(' ');</span>
<a href="#l1.1534"></a><span id="l1.1534">       properties.Append(extra);</span>
<a href="#l1.1535"></a><span id="l1.1535">     }</span>
<a href="#l1.1536"></a><span id="l1.1536">   }</span>
<a href="#l1.1537"></a><span id="l1.1537"> </span>
<a href="#l1.1538"></a><span id="l1.1538">   return NS_OK;</span>
<a href="#l1.1539"></a><span id="l1.1539"> }</span>
<a href="#l1.1540"></a><span id="l1.1540"> </span>
<a href="#l1.1541"></a><span id="l1.1541" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetColumnProperties(nsITreeColumn* col, nsAString&amp; properties)</span>
<a href="#l1.1542"></a><span id="l1.1542" class="difflineminus">-{</span>
<a href="#l1.1543"></a><span id="l1.1543" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.1544"></a><span id="l1.1544" class="difflineminus">-}</span>
<a href="#l1.1545"></a><span id="l1.1545" class="difflineminus">-</span>
<a href="#l1.1546"></a><span id="l1.1546" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetCellProperties(int32_t aRow, nsITreeColumn *col, nsAString&amp; properties)</span>
<a href="#l1.1547"></a><span id="l1.1547" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1548"></a><span id="l1.1548" class="difflineplus">+nsMsgDBView::GetColumnProperties(nsITreeColumn* col, nsAString&amp; properties)</span>
<a href="#l1.1549"></a><span id="l1.1549" class="difflineplus">+{</span>
<a href="#l1.1550"></a><span id="l1.1550" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.1551"></a><span id="l1.1551" class="difflineplus">+}</span>
<a href="#l1.1552"></a><span id="l1.1552" class="difflineplus">+</span>
<a href="#l1.1553"></a><span id="l1.1553" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1554"></a><span id="l1.1554" class="difflineplus">+nsMsgDBView::GetCellProperties(int32_t aRow,</span>
<a href="#l1.1555"></a><span id="l1.1555" class="difflineplus">+                               nsITreeColumn *col,</span>
<a href="#l1.1556"></a><span id="l1.1556" class="difflineplus">+                               nsAString&amp; properties)</span>
<a href="#l1.1557"></a><span id="l1.1557"> {</span>
<a href="#l1.1558"></a><span id="l1.1558">   if (!IsValidIndex(aRow))</span>
<a href="#l1.1559"></a><span id="l1.1559">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1560"></a><span id="l1.1560"> </span>
<a href="#l1.1561"></a><span id="l1.1561" class="difflineminus">-  // this is where we tell the tree to apply styles to a particular row</span>
<a href="#l1.1562"></a><span id="l1.1562" class="difflineplus">+  // This is where we tell the tree to apply styles to a particular row</span>
<a href="#l1.1563"></a><span id="l1.1563">   // i.e. if the row is an unread message...</span>
<a href="#l1.1564"></a><span id="l1.1564"> </span>
<a href="#l1.1565"></a><span id="l1.1565">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.1566"></a><span id="l1.1566">   nsresult rv = NS_OK;</span>
<a href="#l1.1567"></a><span id="l1.1567"> </span>
<a href="#l1.1568"></a><span id="l1.1568">   rv = GetMsgHdrForViewIndex(aRow, getter_AddRefs(msgHdr));</span>
<a href="#l1.1569"></a><span id="l1.1569"> </span>
<a href="#l1.1570"></a><span id="l1.1570">   if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l1.1571"></a><span id="l1.1571" class="difflineat">@@ -1341,19 +1470,22 @@ NS_IMETHODIMP nsMsgDBView::GetCellProper</span>
<a href="#l1.1572"></a><span id="l1.1572">     ClearHdrCache();</span>
<a href="#l1.1573"></a><span id="l1.1573">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1574"></a><span id="l1.1574">   }</span>
<a href="#l1.1575"></a><span id="l1.1575"> </span>
<a href="#l1.1576"></a><span id="l1.1576">   const char16_t* colID;</span>
<a href="#l1.1577"></a><span id="l1.1577">   col-&gt;GetIdConst(&amp;colID);</span>
<a href="#l1.1578"></a><span id="l1.1578">   nsIMsgCustomColumnHandler* colHandler = GetColumnHandler(colID);</span>
<a href="#l1.1579"></a><span id="l1.1579">   if (colHandler != nullptr)</span>
<a href="#l1.1580"></a><span id="l1.1580" class="difflineplus">+  {</span>
<a href="#l1.1581"></a><span id="l1.1581">     colHandler-&gt;GetCellProperties(aRow, col, properties);</span>
<a href="#l1.1582"></a><span id="l1.1582" class="difflineminus">-  else if (colID[0] == 'c') // correspondent</span>
<a href="#l1.1583"></a><span id="l1.1583" class="difflineminus">-  {</span>
<a href="#l1.1584"></a><span id="l1.1584" class="difflineplus">+  }</span>
<a href="#l1.1585"></a><span id="l1.1585" class="difflineplus">+  else if (colID[0] == 'c')</span>
<a href="#l1.1586"></a><span id="l1.1586" class="difflineplus">+  {</span>
<a href="#l1.1587"></a><span id="l1.1587" class="difflineplus">+    // Correspondent.</span>
<a href="#l1.1588"></a><span id="l1.1588">     if (IsOutgoingMsg(msgHdr))</span>
<a href="#l1.1589"></a><span id="l1.1589">       properties.AssignLiteral(&quot;outgoing&quot;);</span>
<a href="#l1.1590"></a><span id="l1.1590">     else</span>
<a href="#l1.1591"></a><span id="l1.1591">       properties.AssignLiteral(&quot;incoming&quot;);</span>
<a href="#l1.1592"></a><span id="l1.1592">   }</span>
<a href="#l1.1593"></a><span id="l1.1593"> </span>
<a href="#l1.1594"></a><span id="l1.1594">   if (!properties.IsEmpty())</span>
<a href="#l1.1595"></a><span id="l1.1595">     properties.Append(' ');</span>
<a href="#l1.1596"></a><span id="l1.1596" class="difflineat">@@ -1378,58 +1510,62 @@ NS_IMETHODIMP nsMsgDBView::GetCellProper</span>
<a href="#l1.1597"></a><span id="l1.1597">     properties.AppendLiteral(&quot; new&quot;);</span>
<a href="#l1.1598"></a><span id="l1.1598"> </span>
<a href="#l1.1599"></a><span id="l1.1599">   if (m_flags[aRow] &amp; nsMsgMessageFlags::Marked)</span>
<a href="#l1.1600"></a><span id="l1.1600">     properties.AppendLiteral(&quot; flagged&quot;);</span>
<a href="#l1.1601"></a><span id="l1.1601"> </span>
<a href="#l1.1602"></a><span id="l1.1602">   // For threaded display add the ignoreSubthread property to the</span>
<a href="#l1.1603"></a><span id="l1.1603">   // subthread top row (this row). For non-threaded add it to all rows.</span>
<a href="#l1.1604"></a><span id="l1.1604">   if (!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) &amp;&amp;</span>
<a href="#l1.1605"></a><span id="l1.1605" class="difflineminus">-      (flags &amp; nsMsgMessageFlags::Ignored)) {</span>
<a href="#l1.1606"></a><span id="l1.1606" class="difflineplus">+      (flags &amp; nsMsgMessageFlags::Ignored))</span>
<a href="#l1.1607"></a><span id="l1.1607" class="difflineplus">+  {</span>
<a href="#l1.1608"></a><span id="l1.1608">     properties.AppendLiteral(&quot; ignoreSubthread&quot;);</span>
<a href="#l1.1609"></a><span id="l1.1609">   }</span>
<a href="#l1.1610"></a><span id="l1.1610">   else {</span>
<a href="#l1.1611"></a><span id="l1.1611">     bool ignored;</span>
<a href="#l1.1612"></a><span id="l1.1612">     msgHdr-&gt;GetIsKilled(&amp;ignored);</span>
<a href="#l1.1613"></a><span id="l1.1613">     if (ignored)</span>
<a href="#l1.1614"></a><span id="l1.1614">       properties.AppendLiteral(&quot; ignoreSubthread&quot;);</span>
<a href="#l1.1615"></a><span id="l1.1615">   }</span>
<a href="#l1.1616"></a><span id="l1.1616"> </span>
<a href="#l1.1617"></a><span id="l1.1617">   nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(m_folder);</span>
<a href="#l1.1618"></a><span id="l1.1618"> </span>
<a href="#l1.1619"></a><span id="l1.1619" class="difflineminus">-  if ((flags &amp; nsMsgMessageFlags::Offline) || (localFolder &amp;&amp; !(flags &amp; nsMsgMessageFlags::Partial)))</span>
<a href="#l1.1620"></a><span id="l1.1620" class="difflineplus">+  if ((flags &amp; nsMsgMessageFlags::Offline) ||</span>
<a href="#l1.1621"></a><span id="l1.1621" class="difflineplus">+      (localFolder &amp;&amp; !(flags &amp; nsMsgMessageFlags::Partial)))</span>
<a href="#l1.1622"></a><span id="l1.1622">     properties.AppendLiteral(&quot; offline&quot;);</span>
<a href="#l1.1623"></a><span id="l1.1623"> </span>
<a href="#l1.1624"></a><span id="l1.1624">   if (flags &amp; nsMsgMessageFlags::Attachment)</span>
<a href="#l1.1625"></a><span id="l1.1625">     properties.AppendLiteral(&quot; attach&quot;);</span>
<a href="#l1.1626"></a><span id="l1.1626"> </span>
<a href="#l1.1627"></a><span id="l1.1627" class="difflineminus">-  if ((mDeleteModel == nsMsgImapDeleteModels::IMAPDelete) &amp;&amp; (flags &amp; nsMsgMessageFlags::IMAPDeleted))</span>
<a href="#l1.1628"></a><span id="l1.1628" class="difflineplus">+  if ((mDeleteModel == nsMsgImapDeleteModels::IMAPDelete) &amp;&amp;</span>
<a href="#l1.1629"></a><span id="l1.1629" class="difflineplus">+      (flags &amp; nsMsgMessageFlags::IMAPDeleted))</span>
<a href="#l1.1630"></a><span id="l1.1630">     properties.AppendLiteral(&quot; imapdeleted&quot;);</span>
<a href="#l1.1631"></a><span id="l1.1631"> </span>
<a href="#l1.1632"></a><span id="l1.1632">   nsCString imageSize;</span>
<a href="#l1.1633"></a><span id="l1.1633">   msgHdr-&gt;GetStringProperty(&quot;imageSize&quot;, getter_Copies(imageSize));</span>
<a href="#l1.1634"></a><span id="l1.1634">   if (!imageSize.IsEmpty())</span>
<a href="#l1.1635"></a><span id="l1.1635">     properties.AppendLiteral(&quot; hasimage&quot;);</span>
<a href="#l1.1636"></a><span id="l1.1636"> </span>
<a href="#l1.1637"></a><span id="l1.1637">   nsCString junkScoreStr;</span>
<a href="#l1.1638"></a><span id="l1.1638">   msgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l1.1639"></a><span id="l1.1639">   if (!junkScoreStr.IsEmpty()) {</span>
<a href="#l1.1640"></a><span id="l1.1640">     if (junkScoreStr.ToInteger(&amp;rv) == nsIJunkMailPlugin::IS_SPAM_SCORE)</span>
<a href="#l1.1641"></a><span id="l1.1641">       properties.AppendLiteral(&quot; junk&quot;);</span>
<a href="#l1.1642"></a><span id="l1.1642">     else</span>
<a href="#l1.1643"></a><span id="l1.1643">       properties.AppendLiteral(&quot; notjunk&quot;);</span>
<a href="#l1.1644"></a><span id="l1.1644" class="difflineplus">+</span>
<a href="#l1.1645"></a><span id="l1.1645">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Converting junkScore to integer failed.&quot;);</span>
<a href="#l1.1646"></a><span id="l1.1646">   }</span>
<a href="#l1.1647"></a><span id="l1.1647"> </span>
<a href="#l1.1648"></a><span id="l1.1648">   nsCString keywords;</span>
<a href="#l1.1649"></a><span id="l1.1649">   FetchRowKeywords(aRow, msgHdr, keywords);</span>
<a href="#l1.1650"></a><span id="l1.1650">   if (!keywords.IsEmpty())</span>
<a href="#l1.1651"></a><span id="l1.1651">     AppendKeywordProperties(keywords, properties, true);</span>
<a href="#l1.1652"></a><span id="l1.1652"> </span>
<a href="#l1.1653"></a><span id="l1.1653" class="difflineminus">-  // this is a double fetch of the keywords property since we also fetch</span>
<a href="#l1.1654"></a><span id="l1.1654" class="difflineplus">+  // This is a double fetch of the keywords property since we also fetch</span>
<a href="#l1.1655"></a><span id="l1.1655">   // it for the tags - do we want to do this?</span>
<a href="#l1.1656"></a><span id="l1.1656">   // I'm not sure anyone uses the kw- property, though it could be nice</span>
<a href="#l1.1657"></a><span id="l1.1657">   // for people wanting to extend the thread pane.</span>
<a href="#l1.1658"></a><span id="l1.1658">   nsCString keywordProperty;</span>
<a href="#l1.1659"></a><span id="l1.1659">   msgHdr-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(keywordProperty));</span>
<a href="#l1.1660"></a><span id="l1.1660">   if (!keywordProperty.IsEmpty())</span>
<a href="#l1.1661"></a><span id="l1.1661">   {</span>
<a href="#l1.1662"></a><span id="l1.1662">     NS_ConvertUTF8toUTF16 keywords(keywordProperty);</span>
<a href="#l1.1663"></a><span id="l1.1663" class="difflineat">@@ -1442,119 +1578,140 @@ NS_IMETHODIMP nsMsgDBView::GetCellProper</span>
<a href="#l1.1664"></a><span id="l1.1664">       properties.Append(StringHead(keywords, endOfKeyword));</span>
<a href="#l1.1665"></a><span id="l1.1665">       if (spaceIndex &gt; 0)</span>
<a href="#l1.1666"></a><span id="l1.1666">         keywords.Cut(0, endOfKeyword + 1);</span>
<a href="#l1.1667"></a><span id="l1.1667">     }</span>
<a href="#l1.1668"></a><span id="l1.1668">     while (spaceIndex &gt; 0);</span>
<a href="#l1.1669"></a><span id="l1.1669">   }</span>
<a href="#l1.1670"></a><span id="l1.1670"> </span>
<a href="#l1.1671"></a><span id="l1.1671"> #ifdef SUPPORT_PRIORITY_COLORS</span>
<a href="#l1.1672"></a><span id="l1.1672" class="difflineminus">-  // add special styles for priority</span>
<a href="#l1.1673"></a><span id="l1.1673" class="difflineplus">+  // Add special styles for priority.</span>
<a href="#l1.1674"></a><span id="l1.1674">   nsMsgPriorityValue priority;</span>
<a href="#l1.1675"></a><span id="l1.1675">   msgHdr-&gt;GetPriority(&amp;priority);</span>
<a href="#l1.1676"></a><span id="l1.1676">   switch (priority)</span>
<a href="#l1.1677"></a><span id="l1.1677">   {</span>
<a href="#l1.1678"></a><span id="l1.1678" class="difflineminus">-  case nsMsgPriority::highest:</span>
<a href="#l1.1679"></a><span id="l1.1679" class="difflineminus">-    properties.append(&quot; priority-highest&quot;);</span>
<a href="#l1.1680"></a><span id="l1.1680" class="difflineminus">-    break;</span>
<a href="#l1.1681"></a><span id="l1.1681" class="difflineminus">-  case nsMsgPriority::high:</span>
<a href="#l1.1682"></a><span id="l1.1682" class="difflineminus">-    properties.append(&quot; priority-high&quot;);</span>
<a href="#l1.1683"></a><span id="l1.1683" class="difflineminus">-    break;</span>
<a href="#l1.1684"></a><span id="l1.1684" class="difflineminus">-  case nsMsgPriority::low:</span>
<a href="#l1.1685"></a><span id="l1.1685" class="difflineminus">-    properties.append(&quot; priority-low&quot;);</span>
<a href="#l1.1686"></a><span id="l1.1686" class="difflineminus">-    break;</span>
<a href="#l1.1687"></a><span id="l1.1687" class="difflineminus">-  case nsMsgPriority::lowest:</span>
<a href="#l1.1688"></a><span id="l1.1688" class="difflineminus">-    properties.append(&quot; priority-lowest&quot;);</span>
<a href="#l1.1689"></a><span id="l1.1689" class="difflineminus">-    break;</span>
<a href="#l1.1690"></a><span id="l1.1690" class="difflineminus">-  default:</span>
<a href="#l1.1691"></a><span id="l1.1691" class="difflineminus">-    break;</span>
<a href="#l1.1692"></a><span id="l1.1692" class="difflineplus">+    case nsMsgPriority::highest:</span>
<a href="#l1.1693"></a><span id="l1.1693" class="difflineplus">+      properties.append(&quot; priority-highest&quot;);</span>
<a href="#l1.1694"></a><span id="l1.1694" class="difflineplus">+      break;</span>
<a href="#l1.1695"></a><span id="l1.1695" class="difflineplus">+    case nsMsgPriority::high:</span>
<a href="#l1.1696"></a><span id="l1.1696" class="difflineplus">+      properties.append(&quot; priority-high&quot;);</span>
<a href="#l1.1697"></a><span id="l1.1697" class="difflineplus">+      break;</span>
<a href="#l1.1698"></a><span id="l1.1698" class="difflineplus">+    case nsMsgPriority::low:</span>
<a href="#l1.1699"></a><span id="l1.1699" class="difflineplus">+      properties.append(&quot; priority-low&quot;);</span>
<a href="#l1.1700"></a><span id="l1.1700" class="difflineplus">+      break;</span>
<a href="#l1.1701"></a><span id="l1.1701" class="difflineplus">+    case nsMsgPriority::lowest:</span>
<a href="#l1.1702"></a><span id="l1.1702" class="difflineplus">+      properties.append(&quot; priority-lowest&quot;);</span>
<a href="#l1.1703"></a><span id="l1.1703" class="difflineplus">+      break;</span>
<a href="#l1.1704"></a><span id="l1.1704" class="difflineplus">+    default:</span>
<a href="#l1.1705"></a><span id="l1.1705" class="difflineplus">+      break;</span>
<a href="#l1.1706"></a><span id="l1.1706">   }</span>
<a href="#l1.1707"></a><span id="l1.1707"> #endif</span>
<a href="#l1.1708"></a><span id="l1.1708"> </span>
<a href="#l1.1709"></a><span id="l1.1709"> </span>
<a href="#l1.1710"></a><span id="l1.1710">   nsCOMPtr &lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.1711"></a><span id="l1.1711">   rv = GetThreadContainingIndex(aRow, getter_AddRefs(thread));</span>
<a href="#l1.1712"></a><span id="l1.1712">   if (NS_SUCCEEDED(rv) &amp;&amp; thread)</span>
<a href="#l1.1713"></a><span id="l1.1713">   {</span>
<a href="#l1.1714"></a><span id="l1.1714">     uint32_t numUnreadChildren;</span>
<a href="#l1.1715"></a><span id="l1.1715">     thread-&gt;GetNumUnreadChildren(&amp;numUnreadChildren);</span>
<a href="#l1.1716"></a><span id="l1.1716">     if (numUnreadChildren &gt; 0)</span>
<a href="#l1.1717"></a><span id="l1.1717">       properties.AppendLiteral(&quot; hasUnread&quot;);</span>
<a href="#l1.1718"></a><span id="l1.1718"> </span>
<a href="#l1.1719"></a><span id="l1.1719">     // For threaded display add the ignore/watch properties to the</span>
<a href="#l1.1720"></a><span id="l1.1720">     // thread top row. For non-threaded add it to all rows.</span>
<a href="#l1.1721"></a><span id="l1.1721">     if (!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) ||</span>
<a href="#l1.1722"></a><span id="l1.1722" class="difflineminus">-         ((m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) &amp;&amp;</span>
<a href="#l1.1723"></a><span id="l1.1723" class="difflineminus">-        (m_flags[aRow] &amp; MSG_VIEW_FLAG_ISTHREAD))) {</span>
<a href="#l1.1724"></a><span id="l1.1724" class="difflineplus">+        ((m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) &amp;&amp;</span>
<a href="#l1.1725"></a><span id="l1.1725" class="difflineplus">+         (m_flags[aRow] &amp; MSG_VIEW_FLAG_ISTHREAD)))</span>
<a href="#l1.1726"></a><span id="l1.1726" class="difflineplus">+    {</span>
<a href="#l1.1727"></a><span id="l1.1727">       thread-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.1728"></a><span id="l1.1728">       if (flags &amp; nsMsgMessageFlags::Watched)</span>
<a href="#l1.1729"></a><span id="l1.1729">         properties.AppendLiteral(&quot; watch&quot;);</span>
<a href="#l1.1730"></a><span id="l1.1730">       if (flags &amp; nsMsgMessageFlags::Ignored)</span>
<a href="#l1.1731"></a><span id="l1.1731">         properties.AppendLiteral(&quot; ignore&quot;);</span>
<a href="#l1.1732"></a><span id="l1.1732">     }</span>
<a href="#l1.1733"></a><span id="l1.1733">   }</span>
<a href="#l1.1734"></a><span id="l1.1734" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.1735"></a><span id="l1.1735" class="difflineminus">-}</span>
<a href="#l1.1736"></a><span id="l1.1736" class="difflineminus">-</span>
<a href="#l1.1737"></a><span id="l1.1737" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::IsContainer(int32_t index, bool *_retval)</span>
<a href="#l1.1738"></a><span id="l1.1738" class="difflineplus">+</span>
<a href="#l1.1739"></a><span id="l1.1739" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.1740"></a><span id="l1.1740" class="difflineplus">+}</span>
<a href="#l1.1741"></a><span id="l1.1741" class="difflineplus">+</span>
<a href="#l1.1742"></a><span id="l1.1742" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1743"></a><span id="l1.1743" class="difflineplus">+nsMsgDBView::IsContainer(int32_t index,</span>
<a href="#l1.1744"></a><span id="l1.1744" class="difflineplus">+                         bool *_retval)</span>
<a href="#l1.1745"></a><span id="l1.1745"> {</span>
<a href="#l1.1746"></a><span id="l1.1746">   if (!IsValidIndex(index))</span>
<a href="#l1.1747"></a><span id="l1.1747" class="difflineminus">-      return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1748"></a><span id="l1.1748" class="difflineplus">+    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1749"></a><span id="l1.1749"> </span>
<a href="#l1.1750"></a><span id="l1.1750">   if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.1751"></a><span id="l1.1751">   {</span>
<a href="#l1.1752"></a><span id="l1.1752">     uint32_t flags = m_flags[index];</span>
<a href="#l1.1753"></a><span id="l1.1753">     *_retval = !!(flags &amp; MSG_VIEW_FLAG_HASCHILDREN);</span>
<a href="#l1.1754"></a><span id="l1.1754">   }</span>
<a href="#l1.1755"></a><span id="l1.1755">   else</span>
<a href="#l1.1756"></a><span id="l1.1756" class="difflineplus">+  {</span>
<a href="#l1.1757"></a><span id="l1.1757">     *_retval = false;</span>
<a href="#l1.1758"></a><span id="l1.1758" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.1759"></a><span id="l1.1759" class="difflineminus">-}</span>
<a href="#l1.1760"></a><span id="l1.1760" class="difflineminus">-</span>
<a href="#l1.1761"></a><span id="l1.1761" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::IsContainerOpen(int32_t index, bool *_retval)</span>
<a href="#l1.1762"></a><span id="l1.1762" class="difflineplus">+  }</span>
<a href="#l1.1763"></a><span id="l1.1763" class="difflineplus">+</span>
<a href="#l1.1764"></a><span id="l1.1764" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.1765"></a><span id="l1.1765" class="difflineplus">+}</span>
<a href="#l1.1766"></a><span id="l1.1766" class="difflineplus">+</span>
<a href="#l1.1767"></a><span id="l1.1767" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1768"></a><span id="l1.1768" class="difflineplus">+nsMsgDBView::IsContainerOpen(int32_t index,</span>
<a href="#l1.1769"></a><span id="l1.1769" class="difflineplus">+                             bool *_retval)</span>
<a href="#l1.1770"></a><span id="l1.1770"> {</span>
<a href="#l1.1771"></a><span id="l1.1771">   if (!IsValidIndex(index))</span>
<a href="#l1.1772"></a><span id="l1.1772" class="difflineminus">-      return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1773"></a><span id="l1.1773" class="difflineplus">+    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1774"></a><span id="l1.1774"> </span>
<a href="#l1.1775"></a><span id="l1.1775">   if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.1776"></a><span id="l1.1776">   {</span>
<a href="#l1.1777"></a><span id="l1.1777">     uint32_t flags = m_flags[index];</span>
<a href="#l1.1778"></a><span id="l1.1778">     *_retval = (flags &amp; MSG_VIEW_FLAG_HASCHILDREN) &amp;&amp; !(flags &amp; nsMsgMessageFlags::Elided);</span>
<a href="#l1.1779"></a><span id="l1.1779">   }</span>
<a href="#l1.1780"></a><span id="l1.1780">   else</span>
<a href="#l1.1781"></a><span id="l1.1781" class="difflineplus">+  {</span>
<a href="#l1.1782"></a><span id="l1.1782">     *_retval = false;</span>
<a href="#l1.1783"></a><span id="l1.1783" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.1784"></a><span id="l1.1784" class="difflineminus">-}</span>
<a href="#l1.1785"></a><span id="l1.1785" class="difflineminus">-</span>
<a href="#l1.1786"></a><span id="l1.1786" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::IsContainerEmpty(int32_t index, bool *_retval)</span>
<a href="#l1.1787"></a><span id="l1.1787" class="difflineplus">+  }</span>
<a href="#l1.1788"></a><span id="l1.1788" class="difflineplus">+</span>
<a href="#l1.1789"></a><span id="l1.1789" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.1790"></a><span id="l1.1790" class="difflineplus">+}</span>
<a href="#l1.1791"></a><span id="l1.1791" class="difflineplus">+</span>
<a href="#l1.1792"></a><span id="l1.1792" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1793"></a><span id="l1.1793" class="difflineplus">+nsMsgDBView::IsContainerEmpty(int32_t index,</span>
<a href="#l1.1794"></a><span id="l1.1794" class="difflineplus">+                              bool *_retval)</span>
<a href="#l1.1795"></a><span id="l1.1795"> {</span>
<a href="#l1.1796"></a><span id="l1.1796">   if (!IsValidIndex(index))</span>
<a href="#l1.1797"></a><span id="l1.1797">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1798"></a><span id="l1.1798"> </span>
<a href="#l1.1799"></a><span id="l1.1799">   if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.1800"></a><span id="l1.1800">   {</span>
<a href="#l1.1801"></a><span id="l1.1801">     uint32_t flags = m_flags[index];</span>
<a href="#l1.1802"></a><span id="l1.1802">     *_retval = !(flags &amp; MSG_VIEW_FLAG_HASCHILDREN);</span>
<a href="#l1.1803"></a><span id="l1.1803">   }</span>
<a href="#l1.1804"></a><span id="l1.1804">   else</span>
<a href="#l1.1805"></a><span id="l1.1805" class="difflineplus">+  {</span>
<a href="#l1.1806"></a><span id="l1.1806">     *_retval = false;</span>
<a href="#l1.1807"></a><span id="l1.1807" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.1808"></a><span id="l1.1808" class="difflineminus">-}</span>
<a href="#l1.1809"></a><span id="l1.1809" class="difflineminus">-</span>
<a href="#l1.1810"></a><span id="l1.1810" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::IsSeparator(int32_t index, bool *_retval)</span>
<a href="#l1.1811"></a><span id="l1.1811" class="difflineplus">+  }</span>
<a href="#l1.1812"></a><span id="l1.1812" class="difflineplus">+</span>
<a href="#l1.1813"></a><span id="l1.1813" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.1814"></a><span id="l1.1814" class="difflineplus">+}</span>
<a href="#l1.1815"></a><span id="l1.1815" class="difflineplus">+</span>
<a href="#l1.1816"></a><span id="l1.1816" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1817"></a><span id="l1.1817" class="difflineplus">+nsMsgDBView::IsSeparator(int32_t index,</span>
<a href="#l1.1818"></a><span id="l1.1818" class="difflineplus">+                         bool *_retval)</span>
<a href="#l1.1819"></a><span id="l1.1819"> {</span>
<a href="#l1.1820"></a><span id="l1.1820">   if (!IsValidIndex(index))</span>
<a href="#l1.1821"></a><span id="l1.1821">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1822"></a><span id="l1.1822"> </span>
<a href="#l1.1823"></a><span id="l1.1823">   *_retval = false;</span>
<a href="#l1.1824"></a><span id="l1.1824"> </span>
<a href="#l1.1825"></a><span id="l1.1825">   return NS_OK;</span>
<a href="#l1.1826"></a><span id="l1.1826"> }</span>
<a href="#l1.1827"></a><span id="l1.1827"> </span>
<a href="#l1.1828"></a><span id="l1.1828" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetParentIndex(int32_t rowIndex, int32_t *_retval)</span>
<a href="#l1.1829"></a><span id="l1.1829" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1830"></a><span id="l1.1830" class="difflineplus">+nsMsgDBView::GetParentIndex(int32_t rowIndex,</span>
<a href="#l1.1831"></a><span id="l1.1831" class="difflineplus">+                            int32_t *_retval)</span>
<a href="#l1.1832"></a><span id="l1.1832"> {</span>
<a href="#l1.1833"></a><span id="l1.1833">   *_retval = -1;</span>
<a href="#l1.1834"></a><span id="l1.1834"> </span>
<a href="#l1.1835"></a><span id="l1.1835">   int32_t rowIndexLevel;</span>
<a href="#l1.1836"></a><span id="l1.1836">   nsresult rv = GetLevel(rowIndex, &amp;rowIndexLevel);</span>
<a href="#l1.1837"></a><span id="l1.1837">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1838"></a><span id="l1.1838"> </span>
<a href="#l1.1839"></a><span id="l1.1839">   int32_t i;</span>
<a href="#l1.1840"></a><span id="l1.1840" class="difflineat">@@ -1567,56 +1724,65 @@ NS_IMETHODIMP nsMsgDBView::GetParentInde</span>
<a href="#l1.1841"></a><span id="l1.1841">       *_retval = i;</span>
<a href="#l1.1842"></a><span id="l1.1842">       break;</span>
<a href="#l1.1843"></a><span id="l1.1843">     }</span>
<a href="#l1.1844"></a><span id="l1.1844">   }</span>
<a href="#l1.1845"></a><span id="l1.1845"> </span>
<a href="#l1.1846"></a><span id="l1.1846">   return NS_OK;</span>
<a href="#l1.1847"></a><span id="l1.1847"> }</span>
<a href="#l1.1848"></a><span id="l1.1848"> </span>
<a href="#l1.1849"></a><span id="l1.1849" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::HasNextSibling(int32_t rowIndex, int32_t afterIndex, bool *_retval)</span>
<a href="#l1.1850"></a><span id="l1.1850" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1851"></a><span id="l1.1851" class="difflineplus">+nsMsgDBView::HasNextSibling(int32_t rowIndex,</span>
<a href="#l1.1852"></a><span id="l1.1852" class="difflineplus">+                            int32_t afterIndex,</span>
<a href="#l1.1853"></a><span id="l1.1853" class="difflineplus">+                            bool *_retval)</span>
<a href="#l1.1854"></a><span id="l1.1854"> {</span>
<a href="#l1.1855"></a><span id="l1.1855">   *_retval = false;</span>
<a href="#l1.1856"></a><span id="l1.1856"> </span>
<a href="#l1.1857"></a><span id="l1.1857">   int32_t rowIndexLevel;</span>
<a href="#l1.1858"></a><span id="l1.1858">   GetLevel(rowIndex, &amp;rowIndexLevel);</span>
<a href="#l1.1859"></a><span id="l1.1859"> </span>
<a href="#l1.1860"></a><span id="l1.1860">   int32_t i;</span>
<a href="#l1.1861"></a><span id="l1.1861">   int32_t count;</span>
<a href="#l1.1862"></a><span id="l1.1862">   GetRowCount(&amp;count);</span>
<a href="#l1.1863"></a><span id="l1.1863">   for(i = afterIndex + 1; i &lt; count; i++)</span>
<a href="#l1.1864"></a><span id="l1.1864">   {</span>
<a href="#l1.1865"></a><span id="l1.1865">     int32_t l;</span>
<a href="#l1.1866"></a><span id="l1.1866">     GetLevel(i, &amp;l);</span>
<a href="#l1.1867"></a><span id="l1.1867">     if (l &lt; rowIndexLevel)</span>
<a href="#l1.1868"></a><span id="l1.1868">       break;</span>
<a href="#l1.1869"></a><span id="l1.1869" class="difflineplus">+</span>
<a href="#l1.1870"></a><span id="l1.1870">     if (l == rowIndexLevel)</span>
<a href="#l1.1871"></a><span id="l1.1871">     {</span>
<a href="#l1.1872"></a><span id="l1.1872">       *_retval = true;</span>
<a href="#l1.1873"></a><span id="l1.1873">       break;</span>
<a href="#l1.1874"></a><span id="l1.1874">     }</span>
<a href="#l1.1875"></a><span id="l1.1875">   }</span>
<a href="#l1.1876"></a><span id="l1.1876"> </span>
<a href="#l1.1877"></a><span id="l1.1877">   return NS_OK;</span>
<a href="#l1.1878"></a><span id="l1.1878"> }</span>
<a href="#l1.1879"></a><span id="l1.1879"> </span>
<a href="#l1.1880"></a><span id="l1.1880" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetLevel(int32_t index, int32_t *_retval)</span>
<a href="#l1.1881"></a><span id="l1.1881" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1882"></a><span id="l1.1882" class="difflineplus">+nsMsgDBView::GetLevel(int32_t index,</span>
<a href="#l1.1883"></a><span id="l1.1883" class="difflineplus">+                      int32_t *_retval)</span>
<a href="#l1.1884"></a><span id="l1.1884"> {</span>
<a href="#l1.1885"></a><span id="l1.1885">   if (!IsValidIndex(index))</span>
<a href="#l1.1886"></a><span id="l1.1886">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1887"></a><span id="l1.1887"> </span>
<a href="#l1.1888"></a><span id="l1.1888">   if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.1889"></a><span id="l1.1889">     *_retval = m_levels[index];</span>
<a href="#l1.1890"></a><span id="l1.1890">   else</span>
<a href="#l1.1891"></a><span id="l1.1891">     *_retval = 0;</span>
<a href="#l1.1892"></a><span id="l1.1892" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.1893"></a><span id="l1.1893" class="difflineminus">-}</span>
<a href="#l1.1894"></a><span id="l1.1894" class="difflineminus">-</span>
<a href="#l1.1895"></a><span id="l1.1895" class="difflineminus">-// search view will override this since headers can span db's</span>
<a href="#l1.1896"></a><span id="l1.1896" class="difflineminus">-nsresult nsMsgDBView::GetMsgHdrForViewIndex(nsMsgViewIndex index, nsIMsgDBHdr **msgHdr)</span>
<a href="#l1.1897"></a><span id="l1.1897" class="difflineplus">+</span>
<a href="#l1.1898"></a><span id="l1.1898" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.1899"></a><span id="l1.1899" class="difflineplus">+}</span>
<a href="#l1.1900"></a><span id="l1.1900" class="difflineplus">+</span>
<a href="#l1.1901"></a><span id="l1.1901" class="difflineplus">+// Search view will override this since headers can span db's.</span>
<a href="#l1.1902"></a><span id="l1.1902" class="difflineplus">+nsresult</span>
<a href="#l1.1903"></a><span id="l1.1903" class="difflineplus">+nsMsgDBView::GetMsgHdrForViewIndex(nsMsgViewIndex index,</span>
<a href="#l1.1904"></a><span id="l1.1904" class="difflineplus">+                                   nsIMsgDBHdr **msgHdr)</span>
<a href="#l1.1905"></a><span id="l1.1905"> {</span>
<a href="#l1.1906"></a><span id="l1.1906">   nsresult rv = NS_OK;</span>
<a href="#l1.1907"></a><span id="l1.1907">   if (!IsValidIndex(index))</span>
<a href="#l1.1908"></a><span id="l1.1908">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1909"></a><span id="l1.1909"> </span>
<a href="#l1.1910"></a><span id="l1.1910">   nsMsgKey key = m_keys[index];</span>
<a href="#l1.1911"></a><span id="l1.1911">   if (key == nsMsgKey_None || !m_db)</span>
<a href="#l1.1912"></a><span id="l1.1912">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1913"></a><span id="l1.1913" class="difflineat">@@ -1633,76 +1799,98 @@ nsresult nsMsgDBView::GetMsgHdrForViewIn</span>
<a href="#l1.1914"></a><span id="l1.1914">       m_cachedHdr = *msgHdr;</span>
<a href="#l1.1915"></a><span id="l1.1915">       m_cachedMsgKey = key;</span>
<a href="#l1.1916"></a><span id="l1.1916">     }</span>
<a href="#l1.1917"></a><span id="l1.1917">   }</span>
<a href="#l1.1918"></a><span id="l1.1918"> </span>
<a href="#l1.1919"></a><span id="l1.1919">   return rv;</span>
<a href="#l1.1920"></a><span id="l1.1920"> }</span>
<a href="#l1.1921"></a><span id="l1.1921"> </span>
<a href="#l1.1922"></a><span id="l1.1922" class="difflineminus">-void nsMsgDBView::InsertMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr,</span>
<a href="#l1.1923"></a><span id="l1.1923" class="difflineminus">-                                 nsMsgKey msgKey, uint32_t flags, uint32_t level)</span>
<a href="#l1.1924"></a><span id="l1.1924" class="difflineplus">+void</span>
<a href="#l1.1925"></a><span id="l1.1925" class="difflineplus">+nsMsgDBView::InsertMsgHdrAt(nsMsgViewIndex index,</span>
<a href="#l1.1926"></a><span id="l1.1926" class="difflineplus">+                            nsIMsgDBHdr *hdr,</span>
<a href="#l1.1927"></a><span id="l1.1927" class="difflineplus">+                            nsMsgKey msgKey,</span>
<a href="#l1.1928"></a><span id="l1.1928" class="difflineplus">+                            uint32_t flags,</span>
<a href="#l1.1929"></a><span id="l1.1929" class="difflineplus">+                            uint32_t level)</span>
<a href="#l1.1930"></a><span id="l1.1930"> {</span>
<a href="#l1.1931"></a><span id="l1.1931">   if ((int32_t) index &lt; 0 || index &gt; m_keys.Length())</span>
<a href="#l1.1932"></a><span id="l1.1932">   {</span>
<a href="#l1.1933"></a><span id="l1.1933" class="difflineminus">-    // Something's gone wrong in a caller, but we have no clue why</span>
<a href="#l1.1934"></a><span id="l1.1934" class="difflineminus">-    // Return without adding the header to the view</span>
<a href="#l1.1935"></a><span id="l1.1935" class="difflineplus">+    // Something's gone wrong in a caller, but we have no clue why.</span>
<a href="#l1.1936"></a><span id="l1.1936" class="difflineplus">+    // Return without adding the header to the view.</span>
<a href="#l1.1937"></a><span id="l1.1937">     NS_ERROR(&quot;Index for message header insertion out of array range!&quot;);</span>
<a href="#l1.1938"></a><span id="l1.1938">     return;</span>
<a href="#l1.1939"></a><span id="l1.1939">   }</span>
<a href="#l1.1940"></a><span id="l1.1940" class="difflineplus">+</span>
<a href="#l1.1941"></a><span id="l1.1941">   m_keys.InsertElementAt(index, msgKey);</span>
<a href="#l1.1942"></a><span id="l1.1942">   m_flags.InsertElementAt(index, flags);</span>
<a href="#l1.1943"></a><span id="l1.1943">   m_levels.InsertElementAt(index, level);</span>
<a href="#l1.1944"></a><span id="l1.1944"> }</span>
<a href="#l1.1945"></a><span id="l1.1945"> </span>
<a href="#l1.1946"></a><span id="l1.1946" class="difflineminus">-void nsMsgDBView::SetMsgHdrAt(nsIMsgDBHdr *hdr, nsMsgViewIndex index,</span>
<a href="#l1.1947"></a><span id="l1.1947" class="difflineminus">-                              nsMsgKey msgKey, uint32_t flags, uint32_t level)</span>
<a href="#l1.1948"></a><span id="l1.1948" class="difflineplus">+void</span>
<a href="#l1.1949"></a><span id="l1.1949" class="difflineplus">+nsMsgDBView::SetMsgHdrAt(nsIMsgDBHdr *hdr,</span>
<a href="#l1.1950"></a><span id="l1.1950" class="difflineplus">+                         nsMsgViewIndex index,</span>
<a href="#l1.1951"></a><span id="l1.1951" class="difflineplus">+                         nsMsgKey msgKey,</span>
<a href="#l1.1952"></a><span id="l1.1952" class="difflineplus">+                         uint32_t flags,</span>
<a href="#l1.1953"></a><span id="l1.1953" class="difflineplus">+                         uint32_t level)</span>
<a href="#l1.1954"></a><span id="l1.1954"> {</span>
<a href="#l1.1955"></a><span id="l1.1955">   m_keys[index] = msgKey;</span>
<a href="#l1.1956"></a><span id="l1.1956">   m_flags[index] = flags;</span>
<a href="#l1.1957"></a><span id="l1.1957">   m_levels[index] = level;</span>
<a href="#l1.1958"></a><span id="l1.1958"> }</span>
<a href="#l1.1959"></a><span id="l1.1959"> </span>
<a href="#l1.1960"></a><span id="l1.1960" class="difflineminus">-nsresult nsMsgDBView::GetFolderForViewIndex(nsMsgViewIndex index, nsIMsgFolder **aFolder)</span>
<a href="#l1.1961"></a><span id="l1.1961" class="difflineplus">+nsresult</span>
<a href="#l1.1962"></a><span id="l1.1962" class="difflineplus">+nsMsgDBView::GetFolderForViewIndex(nsMsgViewIndex index,</span>
<a href="#l1.1963"></a><span id="l1.1963" class="difflineplus">+                                   nsIMsgFolder **aFolder)</span>
<a href="#l1.1964"></a><span id="l1.1964"> {</span>
<a href="#l1.1965"></a><span id="l1.1965">   NS_IF_ADDREF(*aFolder = m_folder);</span>
<a href="#l1.1966"></a><span id="l1.1966">   return NS_OK;</span>
<a href="#l1.1967"></a><span id="l1.1967"> }</span>
<a href="#l1.1968"></a><span id="l1.1968"> </span>
<a href="#l1.1969"></a><span id="l1.1969" class="difflineminus">-nsresult nsMsgDBView::GetDBForViewIndex(nsMsgViewIndex index, nsIMsgDatabase **db)</span>
<a href="#l1.1970"></a><span id="l1.1970" class="difflineplus">+nsresult</span>
<a href="#l1.1971"></a><span id="l1.1971" class="difflineplus">+nsMsgDBView::GetDBForViewIndex(nsMsgViewIndex index,</span>
<a href="#l1.1972"></a><span id="l1.1972" class="difflineplus">+                               nsIMsgDatabase **db)</span>
<a href="#l1.1973"></a><span id="l1.1973"> {</span>
<a href="#l1.1974"></a><span id="l1.1974">   NS_IF_ADDREF(*db = m_db);</span>
<a href="#l1.1975"></a><span id="l1.1975">   return NS_OK;</span>
<a href="#l1.1976"></a><span id="l1.1976"> }</span>
<a href="#l1.1977"></a><span id="l1.1977"> </span>
<a href="#l1.1978"></a><span id="l1.1978" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetImageSrc(int32_t aRow, nsITreeColumn* aCol, nsAString&amp; aValue)</span>
<a href="#l1.1979"></a><span id="l1.1979" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.1980"></a><span id="l1.1980" class="difflineplus">+nsMsgDBView::GetImageSrc(int32_t aRow,</span>
<a href="#l1.1981"></a><span id="l1.1981" class="difflineplus">+                         nsITreeColumn* aCol,</span>
<a href="#l1.1982"></a><span id="l1.1982" class="difflineplus">+                         nsAString&amp; aValue)</span>
<a href="#l1.1983"></a><span id="l1.1983"> {</span>
<a href="#l1.1984"></a><span id="l1.1984">   NS_ENSURE_ARG_POINTER(aCol);</span>
<a href="#l1.1985"></a><span id="l1.1985" class="difflineminus">-  //attempt to retreive a custom column handler. If it exists call it and return</span>
<a href="#l1.1986"></a><span id="l1.1986" class="difflineplus">+  // Attempt to retrieve a custom column handler. If it exists call it and</span>
<a href="#l1.1987"></a><span id="l1.1987" class="difflineplus">+  // return.</span>
<a href="#l1.1988"></a><span id="l1.1988">   const char16_t* colID;</span>
<a href="#l1.1989"></a><span id="l1.1989">   aCol-&gt;GetIdConst(&amp;colID);</span>
<a href="#l1.1990"></a><span id="l1.1990"> </span>
<a href="#l1.1991"></a><span id="l1.1991">   nsIMsgCustomColumnHandler* colHandler = GetColumnHandler(colID);</span>
<a href="#l1.1992"></a><span id="l1.1992"> </span>
<a href="#l1.1993"></a><span id="l1.1993">   if (colHandler)</span>
<a href="#l1.1994"></a><span id="l1.1994">   {</span>
<a href="#l1.1995"></a><span id="l1.1995">     colHandler-&gt;GetImageSrc(aRow, aCol, aValue);</span>
<a href="#l1.1996"></a><span id="l1.1996">     return NS_OK;</span>
<a href="#l1.1997"></a><span id="l1.1997">   }</span>
<a href="#l1.1998"></a><span id="l1.1998"> </span>
<a href="#l1.1999"></a><span id="l1.1999">   return NS_OK;</span>
<a href="#l1.2000"></a><span id="l1.2000"> }</span>
<a href="#l1.2001"></a><span id="l1.2001"> </span>
<a href="#l1.2002"></a><span id="l1.2002"> NS_IMETHODIMP</span>
<a href="#l1.2003"></a><span id="l1.2003" class="difflineminus">-nsMsgDBView::GetProgressMode(int32_t aRow, nsITreeColumn* aCol, int32_t* _retval)</span>
<a href="#l1.2004"></a><span id="l1.2004" class="difflineminus">-{</span>
<a href="#l1.2005"></a><span id="l1.2005" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.2006"></a><span id="l1.2006" class="difflineminus">-}</span>
<a href="#l1.2007"></a><span id="l1.2007" class="difflineminus">-</span>
<a href="#l1.2008"></a><span id="l1.2008" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetCellValue(int32_t aRow, nsITreeColumn* aCol, nsAString&amp; aValue)</span>
<a href="#l1.2009"></a><span id="l1.2009" class="difflineplus">+nsMsgDBView::GetProgressMode(int32_t aRow,</span>
<a href="#l1.2010"></a><span id="l1.2010" class="difflineplus">+                             nsITreeColumn* aCol,</span>
<a href="#l1.2011"></a><span id="l1.2011" class="difflineplus">+                             int32_t* _retval)</span>
<a href="#l1.2012"></a><span id="l1.2012" class="difflineplus">+{</span>
<a href="#l1.2013"></a><span id="l1.2013" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.2014"></a><span id="l1.2014" class="difflineplus">+}</span>
<a href="#l1.2015"></a><span id="l1.2015" class="difflineplus">+</span>
<a href="#l1.2016"></a><span id="l1.2016" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2017"></a><span id="l1.2017" class="difflineplus">+nsMsgDBView::GetCellValue(int32_t aRow,</span>
<a href="#l1.2018"></a><span id="l1.2018" class="difflineplus">+                          nsITreeColumn* aCol,</span>
<a href="#l1.2019"></a><span id="l1.2019" class="difflineplus">+                          nsAString&amp; aValue)</span>
<a href="#l1.2020"></a><span id="l1.2020"> {</span>
<a href="#l1.2021"></a><span id="l1.2021">   if (!IsValidIndex(aRow))</span>
<a href="#l1.2022"></a><span id="l1.2022">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.2023"></a><span id="l1.2023"> </span>
<a href="#l1.2024"></a><span id="l1.2024">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.2025"></a><span id="l1.2025">   nsresult rv = GetMsgHdrForViewIndex(aRow, getter_AddRefs(msgHdr));</span>
<a href="#l1.2026"></a><span id="l1.2026"> </span>
<a href="#l1.2027"></a><span id="l1.2027">   if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l1.2028"></a><span id="l1.2028" class="difflineat">@@ -1713,29 +1901,32 @@ NS_IMETHODIMP nsMsgDBView::GetCellValue(</span>
<a href="#l1.2029"></a><span id="l1.2029"> </span>
<a href="#l1.2030"></a><span id="l1.2030">   const char16_t* colID;</span>
<a href="#l1.2031"></a><span id="l1.2031">   aCol-&gt;GetIdConst(&amp;colID);</span>
<a href="#l1.2032"></a><span id="l1.2032"> </span>
<a href="#l1.2033"></a><span id="l1.2033">   uint32_t flags;</span>
<a href="#l1.2034"></a><span id="l1.2034">   msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.2035"></a><span id="l1.2035"> </span>
<a href="#l1.2036"></a><span id="l1.2036">   aValue.Truncate();</span>
<a href="#l1.2037"></a><span id="l1.2037" class="difflineminus">-  // provide a string &quot;value&quot; for cells that do not normally have text.</span>
<a href="#l1.2038"></a><span id="l1.2038" class="difflineminus">-  // use empty string for the normal states &quot;Read&quot;, &quot;Not Starred&quot;, &quot;No Attachment&quot; and &quot;Not Junk&quot;</span>
<a href="#l1.2039"></a><span id="l1.2039" class="difflineplus">+  // Provide a string &quot;value&quot; for cells that do not normally have text.</span>
<a href="#l1.2040"></a><span id="l1.2040" class="difflineplus">+  // Use empty string for the normal states &quot;Read&quot;, &quot;Not Starred&quot;,</span>
<a href="#l1.2041"></a><span id="l1.2041" class="difflineplus">+  // &quot;No Attachment&quot; and &quot;Not Junk&quot;.</span>
<a href="#l1.2042"></a><span id="l1.2042">   switch (colID[0])</span>
<a href="#l1.2043"></a><span id="l1.2043">   {</span>
<a href="#l1.2044"></a><span id="l1.2044">     case 'a': // attachment column</span>
<a href="#l1.2045"></a><span id="l1.2045" class="difflineminus">-      if (flags &amp; nsMsgMessageFlags::Attachment) {</span>
<a href="#l1.2046"></a><span id="l1.2046" class="difflineplus">+      if (flags &amp; nsMsgMessageFlags::Attachment)</span>
<a href="#l1.2047"></a><span id="l1.2047" class="difflineplus">+      {</span>
<a href="#l1.2048"></a><span id="l1.2048">         nsString tmp_str;</span>
<a href="#l1.2049"></a><span id="l1.2049">         tmp_str.Adopt(GetString(u&quot;messageHasAttachment&quot;));</span>
<a href="#l1.2050"></a><span id="l1.2050">         aValue.Assign(tmp_str);</span>
<a href="#l1.2051"></a><span id="l1.2051">       }</span>
<a href="#l1.2052"></a><span id="l1.2052">       break;</span>
<a href="#l1.2053"></a><span id="l1.2053">     case 'f': // flagged (starred) column</span>
<a href="#l1.2054"></a><span id="l1.2054" class="difflineminus">-      if (flags &amp; nsMsgMessageFlags::Marked) {</span>
<a href="#l1.2055"></a><span id="l1.2055" class="difflineplus">+      if (flags &amp; nsMsgMessageFlags::Marked)</span>
<a href="#l1.2056"></a><span id="l1.2056" class="difflineplus">+      {</span>
<a href="#l1.2057"></a><span id="l1.2057">         nsString tmp_str;</span>
<a href="#l1.2058"></a><span id="l1.2058">         tmp_str.Adopt(GetString(u&quot;messageHasFlag&quot;));</span>
<a href="#l1.2059"></a><span id="l1.2059">         aValue.Assign(tmp_str);</span>
<a href="#l1.2060"></a><span id="l1.2060">       }</span>
<a href="#l1.2061"></a><span id="l1.2061">       break;</span>
<a href="#l1.2062"></a><span id="l1.2062">     case 'j': // junk column</span>
<a href="#l1.2063"></a><span id="l1.2063">       if (JunkControlsEnabled(aRow))</span>
<a href="#l1.2064"></a><span id="l1.2064">       {</span>
<a href="#l1.2065"></a><span id="l1.2065" class="difflineat">@@ -1747,89 +1938,100 @@ NS_IMETHODIMP nsMsgDBView::GetCellValue(</span>
<a href="#l1.2066"></a><span id="l1.2066">             (junkScoreStr.ToInteger(&amp;rv) == nsIJunkMailPlugin::IS_SPAM_SCORE))</span>
<a href="#l1.2067"></a><span id="l1.2067">           aValue.AssignLiteral(&quot;messageJunk&quot;);</span>
<a href="#l1.2068"></a><span id="l1.2068"> </span>
<a href="#l1.2069"></a><span id="l1.2069">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Converting junkScore to integer failed.&quot;);</span>
<a href="#l1.2070"></a><span id="l1.2070">       }</span>
<a href="#l1.2071"></a><span id="l1.2071">       break;</span>
<a href="#l1.2072"></a><span id="l1.2072">     case 't':</span>
<a href="#l1.2073"></a><span id="l1.2073">       if (colID[1] == 'h' &amp;&amp; (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.2074"></a><span id="l1.2074" class="difflineminus">-      {       // thread column</span>
<a href="#l1.2075"></a><span id="l1.2075" class="difflineplus">+      {</span>
<a href="#l1.2076"></a><span id="l1.2076" class="difflineplus">+        // thread column</span>
<a href="#l1.2077"></a><span id="l1.2077">         bool isContainer, isContainerEmpty, isContainerOpen;</span>
<a href="#l1.2078"></a><span id="l1.2078">         IsContainer(aRow, &amp;isContainer);</span>
<a href="#l1.2079"></a><span id="l1.2079">         if (isContainer)</span>
<a href="#l1.2080"></a><span id="l1.2080">         {</span>
<a href="#l1.2081"></a><span id="l1.2081">           IsContainerEmpty(aRow, &amp;isContainerEmpty);</span>
<a href="#l1.2082"></a><span id="l1.2082">           if (!isContainerEmpty)</span>
<a href="#l1.2083"></a><span id="l1.2083">           {</span>
<a href="#l1.2084"></a><span id="l1.2084">             nsString tmp_str;</span>
<a href="#l1.2085"></a><span id="l1.2085" class="difflineminus">-</span>
<a href="#l1.2086"></a><span id="l1.2086">             IsContainerOpen(aRow, &amp;isContainerOpen);</span>
<a href="#l1.2087"></a><span id="l1.2087">             tmp_str.Adopt(GetString(isContainerOpen ?</span>
<a href="#l1.2088"></a><span id="l1.2088">                             u&quot;messageExpanded&quot; :</span>
<a href="#l1.2089"></a><span id="l1.2089">                             u&quot;messageCollapsed&quot;));</span>
<a href="#l1.2090"></a><span id="l1.2090">             aValue.Assign(tmp_str);</span>
<a href="#l1.2091"></a><span id="l1.2091">           }</span>
<a href="#l1.2092"></a><span id="l1.2092">         }</span>
<a href="#l1.2093"></a><span id="l1.2093">       }</span>
<a href="#l1.2094"></a><span id="l1.2094">       break;</span>
<a href="#l1.2095"></a><span id="l1.2095">     case 'u': // read/unread column</span>
<a href="#l1.2096"></a><span id="l1.2096" class="difflineminus">-      if (!(flags &amp; nsMsgMessageFlags::Read)) {</span>
<a href="#l1.2097"></a><span id="l1.2097" class="difflineplus">+      if (!(flags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l1.2098"></a><span id="l1.2098" class="difflineplus">+      {</span>
<a href="#l1.2099"></a><span id="l1.2099">         nsString tmp_str;</span>
<a href="#l1.2100"></a><span id="l1.2100">         tmp_str.Adopt(GetString(u&quot;messageUnread&quot;));</span>
<a href="#l1.2101"></a><span id="l1.2101">         aValue.Assign(tmp_str);</span>
<a href="#l1.2102"></a><span id="l1.2102">       }</span>
<a href="#l1.2103"></a><span id="l1.2103">       break;</span>
<a href="#l1.2104"></a><span id="l1.2104">     default:</span>
<a href="#l1.2105"></a><span id="l1.2105">       aValue.Assign(colID);</span>
<a href="#l1.2106"></a><span id="l1.2106">       break;</span>
<a href="#l1.2107"></a><span id="l1.2107">   }</span>
<a href="#l1.2108"></a><span id="l1.2108" class="difflineplus">+</span>
<a href="#l1.2109"></a><span id="l1.2109">   return rv;</span>
<a href="#l1.2110"></a><span id="l1.2110"> }</span>
<a href="#l1.2111"></a><span id="l1.2111"> </span>
<a href="#l1.2112"></a><span id="l1.2112" class="difflineminus">-void nsMsgDBView::RememberDeletedMsgHdr(nsIMsgDBHdr *msgHdr)</span>
<a href="#l1.2113"></a><span id="l1.2113" class="difflineplus">+void</span>
<a href="#l1.2114"></a><span id="l1.2114" class="difflineplus">+nsMsgDBView::RememberDeletedMsgHdr(nsIMsgDBHdr *msgHdr)</span>
<a href="#l1.2115"></a><span id="l1.2115"> {</span>
<a href="#l1.2116"></a><span id="l1.2116">   nsCString messageId;</span>
<a href="#l1.2117"></a><span id="l1.2117">   msgHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l1.2118"></a><span id="l1.2118">   if (mRecentlyDeletedArrayIndex &gt;= mRecentlyDeletedMsgIds.Length())</span>
<a href="#l1.2119"></a><span id="l1.2119">     mRecentlyDeletedMsgIds.AppendElement(messageId);</span>
<a href="#l1.2120"></a><span id="l1.2120">   else</span>
<a href="#l1.2121"></a><span id="l1.2121">     mRecentlyDeletedMsgIds[mRecentlyDeletedArrayIndex] = messageId;</span>
<a href="#l1.2122"></a><span id="l1.2122" class="difflineminus">-  // only remember last 20 deleted msgs.</span>
<a href="#l1.2123"></a><span id="l1.2123" class="difflineplus">+</span>
<a href="#l1.2124"></a><span id="l1.2124" class="difflineplus">+  // Only remember last 20 deleted msgs.</span>
<a href="#l1.2125"></a><span id="l1.2125">   mRecentlyDeletedArrayIndex = (mRecentlyDeletedArrayIndex + 1) % 20;</span>
<a href="#l1.2126"></a><span id="l1.2126"> }</span>
<a href="#l1.2127"></a><span id="l1.2127"> </span>
<a href="#l1.2128"></a><span id="l1.2128" class="difflineminus">-bool nsMsgDBView::WasHdrRecentlyDeleted(nsIMsgDBHdr *msgHdr)</span>
<a href="#l1.2129"></a><span id="l1.2129" class="difflineplus">+bool</span>
<a href="#l1.2130"></a><span id="l1.2130" class="difflineplus">+nsMsgDBView::WasHdrRecentlyDeleted(nsIMsgDBHdr *msgHdr)</span>
<a href="#l1.2131"></a><span id="l1.2131"> {</span>
<a href="#l1.2132"></a><span id="l1.2132">   nsCString messageId;</span>
<a href="#l1.2133"></a><span id="l1.2133">   msgHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l1.2134"></a><span id="l1.2134">   return mRecentlyDeletedMsgIds.Contains(messageId);</span>
<a href="#l1.2135"></a><span id="l1.2135"> }</span>
<a href="#l1.2136"></a><span id="l1.2136"> </span>
<a href="#l1.2137"></a><span id="l1.2137" class="difflineminus">-//add a custom column handler</span>
<a href="#l1.2138"></a><span id="l1.2138" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::AddColumnHandler(const nsAString&amp; column, nsIMsgCustomColumnHandler* handler)</span>
<a href="#l1.2139"></a><span id="l1.2139" class="difflineplus">+/**</span>
<a href="#l1.2140"></a><span id="l1.2140" class="difflineplus">+ * CUSTOM COLUMNS.</span>
<a href="#l1.2141"></a><span id="l1.2141" class="difflineplus">+ */</span>
<a href="#l1.2142"></a><span id="l1.2142" class="difflineplus">+</span>
<a href="#l1.2143"></a><span id="l1.2143" class="difflineplus">+// Add a custom column handler.</span>
<a href="#l1.2144"></a><span id="l1.2144" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2145"></a><span id="l1.2145" class="difflineplus">+nsMsgDBView::AddColumnHandler(const nsAString&amp; column,</span>
<a href="#l1.2146"></a><span id="l1.2146" class="difflineplus">+                              nsIMsgCustomColumnHandler* handler)</span>
<a href="#l1.2147"></a><span id="l1.2147"> {</span>
<a href="#l1.2148"></a><span id="l1.2148">   bool custColInSort = false;</span>
<a href="#l1.2149"></a><span id="l1.2149">   size_t index = m_customColumnHandlerIDs.IndexOf(column);</span>
<a href="#l1.2150"></a><span id="l1.2150"> </span>
<a href="#l1.2151"></a><span id="l1.2151">   nsAutoString strColID(column);</span>
<a href="#l1.2152"></a><span id="l1.2152"> </span>
<a href="#l1.2153"></a><span id="l1.2153" class="difflineminus">-  //does not exist</span>
<a href="#l1.2154"></a><span id="l1.2154" class="difflineplus">+  // Does not exist.</span>
<a href="#l1.2155"></a><span id="l1.2155">   if (index == m_customColumnHandlerIDs.NoIndex)</span>
<a href="#l1.2156"></a><span id="l1.2156">   {</span>
<a href="#l1.2157"></a><span id="l1.2157">     m_customColumnHandlerIDs.AppendElement(strColID);</span>
<a href="#l1.2158"></a><span id="l1.2158">     m_customColumnHandlers.AppendObject(handler);</span>
<a href="#l1.2159"></a><span id="l1.2159">   }</span>
<a href="#l1.2160"></a><span id="l1.2160">   else</span>
<a href="#l1.2161"></a><span id="l1.2161">   {</span>
<a href="#l1.2162"></a><span id="l1.2162" class="difflineminus">-    //insert new handler into the appropriate place in the COMPtr array</span>
<a href="#l1.2163"></a><span id="l1.2163" class="difflineminus">-    //no need to replace the column ID (it's the same)</span>
<a href="#l1.2164"></a><span id="l1.2164" class="difflineplus">+    // Insert new handler into the appropriate place in the COMPtr array;</span>
<a href="#l1.2165"></a><span id="l1.2165" class="difflineplus">+    // no need to replace the column ID (it's the same).</span>
<a href="#l1.2166"></a><span id="l1.2166">     m_customColumnHandlers.ReplaceObjectAt(handler, index);</span>
<a href="#l1.2167"></a><span id="l1.2167" class="difflineminus">-</span>
<a href="#l1.2168"></a><span id="l1.2168" class="difflineminus">-  }</span>
<a href="#l1.2169"></a><span id="l1.2169" class="difflineplus">+  }</span>
<a href="#l1.2170"></a><span id="l1.2170" class="difflineplus">+</span>
<a href="#l1.2171"></a><span id="l1.2171">   // Check if the column name matches any of the columns in</span>
<a href="#l1.2172"></a><span id="l1.2172">   // m_sortColumns, and if so, set m_sortColumns[i].mColHandler</span>
<a href="#l1.2173"></a><span id="l1.2173">   for (uint32_t i = 0; i &lt; m_sortColumns.Length(); i++)</span>
<a href="#l1.2174"></a><span id="l1.2174">   {</span>
<a href="#l1.2175"></a><span id="l1.2175">     MsgViewSortColumnInfo &amp;sortInfo = m_sortColumns[i];</span>
<a href="#l1.2176"></a><span id="l1.2176">     if (sortInfo.mSortType == nsMsgViewSortType::byCustom &amp;&amp;</span>
<a href="#l1.2177"></a><span id="l1.2177">         sortInfo.mCustomColumnName.Equals(column))</span>
<a href="#l1.2178"></a><span id="l1.2178">     {</span>
<a href="#l1.2179"></a><span id="l1.2179" class="difflineat">@@ -1844,86 +2046,91 @@ NS_IMETHODIMP nsMsgDBView::AddColumnHand</span>
<a href="#l1.2180"></a><span id="l1.2180"> </span>
<a href="#l1.2181"></a><span id="l1.2181">   // This cust col is in sort columns, and all are now registered, so sort.</span>
<a href="#l1.2182"></a><span id="l1.2182">   if (custColInSort &amp;&amp; !CustomColumnsInSortAndNotRegistered())</span>
<a href="#l1.2183"></a><span id="l1.2183">     Sort(m_sortType, m_sortOrder);</span>
<a href="#l1.2184"></a><span id="l1.2184"> </span>
<a href="#l1.2185"></a><span id="l1.2185">   return NS_OK;</span>
<a href="#l1.2186"></a><span id="l1.2186"> }</span>
<a href="#l1.2187"></a><span id="l1.2187"> </span>
<a href="#l1.2188"></a><span id="l1.2188" class="difflineminus">-//remove a custom column handler</span>
<a href="#l1.2189"></a><span id="l1.2189" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::RemoveColumnHandler(const nsAString&amp; aColID)</span>
<a href="#l1.2190"></a><span id="l1.2190" class="difflineminus">-{</span>
<a href="#l1.2191"></a><span id="l1.2191" class="difflineminus">-</span>
<a href="#l1.2192"></a><span id="l1.2192" class="difflineminus">-  // here we should check if the column name matches any of the columns in</span>
<a href="#l1.2193"></a><span id="l1.2193" class="difflineminus">-  // m_sortColumns, and if so, clear m_sortColumns[i].mColHandler</span>
<a href="#l1.2194"></a><span id="l1.2194" class="difflineplus">+// Remove a custom column handler.</span>
<a href="#l1.2195"></a><span id="l1.2195" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2196"></a><span id="l1.2196" class="difflineplus">+nsMsgDBView::RemoveColumnHandler(const nsAString&amp; aColID)</span>
<a href="#l1.2197"></a><span id="l1.2197" class="difflineplus">+{</span>
<a href="#l1.2198"></a><span id="l1.2198" class="difflineplus">+  // Here we should check if the column name matches any of the columns in</span>
<a href="#l1.2199"></a><span id="l1.2199" class="difflineplus">+  // m_sortColumns, and if so, clear m_sortColumns[i].mColHandler.</span>
<a href="#l1.2200"></a><span id="l1.2200">   size_t index = m_customColumnHandlerIDs.IndexOf(aColID);</span>
<a href="#l1.2201"></a><span id="l1.2201"> </span>
<a href="#l1.2202"></a><span id="l1.2202">   if (index != m_customColumnHandlerIDs.NoIndex)</span>
<a href="#l1.2203"></a><span id="l1.2203">   {</span>
<a href="#l1.2204"></a><span id="l1.2204">     m_customColumnHandlerIDs.RemoveElementAt(index);</span>
<a href="#l1.2205"></a><span id="l1.2205">     m_customColumnHandlers.RemoveObjectAt(index);</span>
<a href="#l1.2206"></a><span id="l1.2206">     // Check if the column name matches any of the columns in</span>
<a href="#l1.2207"></a><span id="l1.2207" class="difflineminus">-    // m_sortColumns, and if so, clear m_sortColumns[i].mColHandler</span>
<a href="#l1.2208"></a><span id="l1.2208" class="difflineplus">+    // m_sortColumns, and if so, clear m_sortColumns[i].mColHandler.</span>
<a href="#l1.2209"></a><span id="l1.2209">     for (uint32_t i = 0; i &lt; m_sortColumns.Length(); i++)</span>
<a href="#l1.2210"></a><span id="l1.2210">     {</span>
<a href="#l1.2211"></a><span id="l1.2211">       MsgViewSortColumnInfo &amp;sortInfo = m_sortColumns[i];</span>
<a href="#l1.2212"></a><span id="l1.2212">       if (sortInfo.mSortType == nsMsgViewSortType::byCustom &amp;&amp;</span>
<a href="#l1.2213"></a><span id="l1.2213" class="difflineminus">-            sortInfo.mCustomColumnName.Equals(aColID))</span>
<a href="#l1.2214"></a><span id="l1.2214" class="difflineplus">+          sortInfo.mCustomColumnName.Equals(aColID))</span>
<a href="#l1.2215"></a><span id="l1.2215">         sortInfo.mColHandler = nullptr;</span>
<a href="#l1.2216"></a><span id="l1.2216">     }</span>
<a href="#l1.2217"></a><span id="l1.2217"> </span>
<a href="#l1.2218"></a><span id="l1.2218">     return NS_OK;</span>
<a href="#l1.2219"></a><span id="l1.2219">   }</span>
<a href="#l1.2220"></a><span id="l1.2220"> </span>
<a href="#l1.2221"></a><span id="l1.2221" class="difflineminus">-  return NS_ERROR_FAILURE; //can't remove a column that isn't currently custom handled</span>
<a href="#l1.2222"></a><span id="l1.2222" class="difflineplus">+  // Can't remove a column that isn't currently custom handled.</span>
<a href="#l1.2223"></a><span id="l1.2223" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l1.2224"></a><span id="l1.2224"> }</span>
<a href="#l1.2225"></a><span id="l1.2225"> </span>
<a href="#l1.2226"></a><span id="l1.2226"> //TODO: NS_ENSURE_SUCCESS</span>
<a href="#l1.2227"></a><span id="l1.2227"> nsIMsgCustomColumnHandler* nsMsgDBView::GetCurColumnHandler()</span>
<a href="#l1.2228"></a><span id="l1.2228"> {</span>
<a href="#l1.2229"></a><span id="l1.2229">   return GetColumnHandler(m_curCustomColumn.get());</span>
<a href="#l1.2230"></a><span id="l1.2230"> }</span>
<a href="#l1.2231"></a><span id="l1.2231"> </span>
<a href="#l1.2232"></a><span id="l1.2232" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::SetCurCustomColumn(const nsAString&amp; aColID)</span>
<a href="#l1.2233"></a><span id="l1.2233" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2234"></a><span id="l1.2234" class="difflineplus">+nsMsgDBView::SetCurCustomColumn(const nsAString&amp; aColID)</span>
<a href="#l1.2235"></a><span id="l1.2235"> {</span>
<a href="#l1.2236"></a><span id="l1.2236">   m_curCustomColumn = aColID;</span>
<a href="#l1.2237"></a><span id="l1.2237" class="difflineminus">-</span>
<a href="#l1.2238"></a><span id="l1.2238">   if (m_viewFolder)</span>
<a href="#l1.2239"></a><span id="l1.2239">   {</span>
<a href="#l1.2240"></a><span id="l1.2240">     nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.2241"></a><span id="l1.2241">     nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l1.2242"></a><span id="l1.2242">     nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l1.2243"></a><span id="l1.2243">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.2244"></a><span id="l1.2244">     folderInfo-&gt;SetProperty(&quot;customSortCol&quot;, aColID);</span>
<a href="#l1.2245"></a><span id="l1.2245">   }</span>
<a href="#l1.2246"></a><span id="l1.2246"> </span>
<a href="#l1.2247"></a><span id="l1.2247">   return NS_OK;</span>
<a href="#l1.2248"></a><span id="l1.2248"> }</span>
<a href="#l1.2249"></a><span id="l1.2249"> </span>
<a href="#l1.2250"></a><span id="l1.2250" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetCurCustomColumn(nsAString &amp;result)</span>
<a href="#l1.2251"></a><span id="l1.2251" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2252"></a><span id="l1.2252" class="difflineplus">+nsMsgDBView::GetCurCustomColumn(nsAString &amp;result)</span>
<a href="#l1.2253"></a><span id="l1.2253"> {</span>
<a href="#l1.2254"></a><span id="l1.2254">   result = m_curCustomColumn;</span>
<a href="#l1.2255"></a><span id="l1.2255">   return NS_OK;</span>
<a href="#l1.2256"></a><span id="l1.2256"> }</span>
<a href="#l1.2257"></a><span id="l1.2257"> </span>
<a href="#l1.2258"></a><span id="l1.2258" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetSecondaryCustomColumn(nsAString &amp;result)</span>
<a href="#l1.2259"></a><span id="l1.2259" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2260"></a><span id="l1.2260" class="difflineplus">+nsMsgDBView::GetSecondaryCustomColumn(nsAString &amp;result)</span>
<a href="#l1.2261"></a><span id="l1.2261"> {</span>
<a href="#l1.2262"></a><span id="l1.2262">   result = m_secondaryCustomColumn;</span>
<a href="#l1.2263"></a><span id="l1.2263">   return NS_OK;</span>
<a href="#l1.2264"></a><span id="l1.2264"> }</span>
<a href="#l1.2265"></a><span id="l1.2265"> </span>
<a href="#l1.2266"></a><span id="l1.2266"> nsIMsgCustomColumnHandler* nsMsgDBView::GetColumnHandler(const char16_t *colID)</span>
<a href="#l1.2267"></a><span id="l1.2267"> {</span>
<a href="#l1.2268"></a><span id="l1.2268">   size_t index = m_customColumnHandlerIDs.IndexOf(nsDependentString(colID));</span>
<a href="#l1.2269"></a><span id="l1.2269">   return (index != m_customColumnHandlerIDs.NoIndex) ?</span>
<a href="#l1.2270"></a><span id="l1.2270">     m_customColumnHandlers[index] : nullptr;</span>
<a href="#l1.2271"></a><span id="l1.2271"> }</span>
<a href="#l1.2272"></a><span id="l1.2272"> </span>
<a href="#l1.2273"></a><span id="l1.2273" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetColumnHandler(const nsAString&amp; aColID, nsIMsgCustomColumnHandler** aHandler)</span>
<a href="#l1.2274"></a><span id="l1.2274" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2275"></a><span id="l1.2275" class="difflineplus">+nsMsgDBView::GetColumnHandler(const nsAString&amp; aColID,</span>
<a href="#l1.2276"></a><span id="l1.2276" class="difflineplus">+                              nsIMsgCustomColumnHandler** aHandler)</span>
<a href="#l1.2277"></a><span id="l1.2277"> {</span>
<a href="#l1.2278"></a><span id="l1.2278">   NS_ENSURE_ARG_POINTER(aHandler);</span>
<a href="#l1.2279"></a><span id="l1.2279">   nsAutoString column(aColID);</span>
<a href="#l1.2280"></a><span id="l1.2280">   NS_IF_ADDREF(*aHandler = GetColumnHandler(column.get()));</span>
<a href="#l1.2281"></a><span id="l1.2281">   return (*aHandler) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l1.2282"></a><span id="l1.2282"> }</span>
<a href="#l1.2283"></a><span id="l1.2283"> </span>
<a href="#l1.2284"></a><span id="l1.2284"> // Check if any active sort columns are custom. If none are custom, return false</span>
<a href="#l1.2285"></a><span id="l1.2285" class="difflineat">@@ -1947,347 +2154,381 @@ bool nsMsgDBView::CustomColumnsInSortAnd</span>
<a href="#l1.2286"></a><span id="l1.2286">   {</span>
<a href="#l1.2287"></a><span id="l1.2287">     if (m_sortColumns[i].mSortType == nsMsgViewSortType::byCustom &amp;&amp;</span>
<a href="#l1.2288"></a><span id="l1.2288">         m_sortColumns[i].mColHandler == nullptr)</span>
<a href="#l1.2289"></a><span id="l1.2289">       custColNotRegistered = true;</span>
<a href="#l1.2290"></a><span id="l1.2290">   }</span>
<a href="#l1.2291"></a><span id="l1.2291"> </span>
<a href="#l1.2292"></a><span id="l1.2292">   return custColNotRegistered;</span>
<a href="#l1.2293"></a><span id="l1.2293"> }</span>
<a href="#l1.2294"></a><span id="l1.2294" class="difflineminus">-</span>
<a href="#l1.2295"></a><span id="l1.2295" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetCellText(int32_t aRow, nsITreeColumn* aCol, nsAString&amp; aValue)</span>
<a href="#l1.2296"></a><span id="l1.2296" class="difflineplus">+// END CUSTOM COLUMNS.</span>
<a href="#l1.2297"></a><span id="l1.2297" class="difflineplus">+</span>
<a href="#l1.2298"></a><span id="l1.2298" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2299"></a><span id="l1.2299" class="difflineplus">+nsMsgDBView::GetCellText(int32_t aRow,</span>
<a href="#l1.2300"></a><span id="l1.2300" class="difflineplus">+                         nsITreeColumn* aCol,</span>
<a href="#l1.2301"></a><span id="l1.2301" class="difflineplus">+                         nsAString&amp; aValue)</span>
<a href="#l1.2302"></a><span id="l1.2302"> {</span>
<a href="#l1.2303"></a><span id="l1.2303">   const char16_t* colID;</span>
<a href="#l1.2304"></a><span id="l1.2304">   aCol-&gt;GetIdConst(&amp;colID);</span>
<a href="#l1.2305"></a><span id="l1.2305"> </span>
<a href="#l1.2306"></a><span id="l1.2306">   if (!IsValidIndex(aRow))</span>
<a href="#l1.2307"></a><span id="l1.2307">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.2308"></a><span id="l1.2308"> </span>
<a href="#l1.2309"></a><span id="l1.2309">   aValue.Truncate();</span>
<a href="#l1.2310"></a><span id="l1.2310"> </span>
<a href="#l1.2311"></a><span id="l1.2311" class="difflineminus">-  //attempt to retreive a custom column handler. If it exists call it and return</span>
<a href="#l1.2312"></a><span id="l1.2312" class="difflineplus">+  // Attempt to retreive a custom column handler. If it exists call it and</span>
<a href="#l1.2313"></a><span id="l1.2313" class="difflineplus">+  // return.</span>
<a href="#l1.2314"></a><span id="l1.2314">   nsIMsgCustomColumnHandler* colHandler = GetColumnHandler(colID);</span>
<a href="#l1.2315"></a><span id="l1.2315"> </span>
<a href="#l1.2316"></a><span id="l1.2316">   if (colHandler)</span>
<a href="#l1.2317"></a><span id="l1.2317">   {</span>
<a href="#l1.2318"></a><span id="l1.2318">     colHandler-&gt;GetCellText(aRow, aCol, aValue);</span>
<a href="#l1.2319"></a><span id="l1.2319">     return NS_OK;</span>
<a href="#l1.2320"></a><span id="l1.2320">   }</span>
<a href="#l1.2321"></a><span id="l1.2321"> </span>
<a href="#l1.2322"></a><span id="l1.2322">   return CellTextForColumn(aRow, colID, aValue);</span>
<a href="#l1.2323"></a><span id="l1.2323"> }</span>
<a href="#l1.2324"></a><span id="l1.2324"> </span>
<a href="#l1.2325"></a><span id="l1.2325" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::CellTextForColumn(int32_t aRow,</span>
<a href="#l1.2326"></a><span id="l1.2326" class="difflineminus">-                                             const char16_t *aColumnName,</span>
<a href="#l1.2327"></a><span id="l1.2327" class="difflineminus">-                                             nsAString &amp;aValue)</span>
<a href="#l1.2328"></a><span id="l1.2328" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2329"></a><span id="l1.2329" class="difflineplus">+nsMsgDBView::CellTextForColumn(int32_t aRow,</span>
<a href="#l1.2330"></a><span id="l1.2330" class="difflineplus">+                               const char16_t *aColumnName,</span>
<a href="#l1.2331"></a><span id="l1.2331" class="difflineplus">+                               nsAString &amp;aValue)</span>
<a href="#l1.2332"></a><span id="l1.2332"> {</span>
<a href="#l1.2333"></a><span id="l1.2333">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.2334"></a><span id="l1.2334">   nsresult rv = GetMsgHdrForViewIndex(aRow, getter_AddRefs(msgHdr));</span>
<a href="#l1.2335"></a><span id="l1.2335"> </span>
<a href="#l1.2336"></a><span id="l1.2336">   if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l1.2337"></a><span id="l1.2337">   {</span>
<a href="#l1.2338"></a><span id="l1.2338">     ClearHdrCache();</span>
<a href="#l1.2339"></a><span id="l1.2339">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.2340"></a><span id="l1.2340">   }</span>
<a href="#l1.2341"></a><span id="l1.2341"> </span>
<a href="#l1.2342"></a><span id="l1.2342">   nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.2343"></a><span id="l1.2343"> </span>
<a href="#l1.2344"></a><span id="l1.2344">   switch (aColumnName[0])</span>
<a href="#l1.2345"></a><span id="l1.2345">   {</span>
<a href="#l1.2346"></a><span id="l1.2346" class="difflineminus">-  case 's':</span>
<a href="#l1.2347"></a><span id="l1.2347" class="difflineminus">-    if (aColumnName[1] == 'u') // subject</span>
<a href="#l1.2348"></a><span id="l1.2348" class="difflineminus">-      rv = FetchSubject(msgHdr, m_flags[aRow], aValue);</span>
<a href="#l1.2349"></a><span id="l1.2349" class="difflineminus">-    else if (aColumnName[1] == 'e') // sender</span>
<a href="#l1.2350"></a><span id="l1.2350" class="difflineminus">-      rv = FetchAuthor(msgHdr, aValue);</span>
<a href="#l1.2351"></a><span id="l1.2351" class="difflineminus">-    else if (aColumnName[1] == 'i') // size</span>
<a href="#l1.2352"></a><span id="l1.2352" class="difflineminus">-      rv = FetchSize(msgHdr, aValue);</span>
<a href="#l1.2353"></a><span id="l1.2353" class="difflineminus">-    else if (aColumnName[1] == 't') // status</span>
<a href="#l1.2354"></a><span id="l1.2354" class="difflineminus">-    {</span>
<a href="#l1.2355"></a><span id="l1.2355" class="difflineminus">-      uint32_t flags;</span>
<a href="#l1.2356"></a><span id="l1.2356" class="difflineminus">-      msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.2357"></a><span id="l1.2357" class="difflineminus">-      rv = FetchStatus(flags, aValue);</span>
<a href="#l1.2358"></a><span id="l1.2358" class="difflineminus">-    }</span>
<a href="#l1.2359"></a><span id="l1.2359" class="difflineminus">-    break;</span>
<a href="#l1.2360"></a><span id="l1.2360" class="difflineminus">-  case 'r':</span>
<a href="#l1.2361"></a><span id="l1.2361" class="difflineminus">-    if (aColumnName[3] == 'i') // recipient</span>
<a href="#l1.2362"></a><span id="l1.2362" class="difflineminus">-      rv = FetchRecipients(msgHdr, aValue);</span>
<a href="#l1.2363"></a><span id="l1.2363" class="difflineminus">-    else if (aColumnName[3] == 'e') // received</span>
<a href="#l1.2364"></a><span id="l1.2364" class="difflineminus">-      rv = FetchDate(msgHdr, aValue, true);</span>
<a href="#l1.2365"></a><span id="l1.2365" class="difflineminus">-    break;</span>
<a href="#l1.2366"></a><span id="l1.2366" class="difflineminus">-  case 'd':  // date</span>
<a href="#l1.2367"></a><span id="l1.2367" class="difflineminus">-    rv = FetchDate(msgHdr, aValue);</span>
<a href="#l1.2368"></a><span id="l1.2368" class="difflineminus">-    break;</span>
<a href="#l1.2369"></a><span id="l1.2369" class="difflineminus">-  case 'c': // correspondent</span>
<a href="#l1.2370"></a><span id="l1.2370" class="difflineminus">-    if (IsOutgoingMsg(msgHdr))</span>
<a href="#l1.2371"></a><span id="l1.2371" class="difflineminus">-      rv = FetchRecipients(msgHdr, aValue);</span>
<a href="#l1.2372"></a><span id="l1.2372" class="difflineminus">-    else</span>
<a href="#l1.2373"></a><span id="l1.2373" class="difflineminus">-      rv = FetchAuthor(msgHdr, aValue);</span>
<a href="#l1.2374"></a><span id="l1.2374" class="difflineminus">-    break;</span>
<a href="#l1.2375"></a><span id="l1.2375" class="difflineminus">-  case 'p': // priority</span>
<a href="#l1.2376"></a><span id="l1.2376" class="difflineminus">-    rv = FetchPriority(msgHdr, aValue);</span>
<a href="#l1.2377"></a><span id="l1.2377" class="difflineminus">-    break;</span>
<a href="#l1.2378"></a><span id="l1.2378" class="difflineminus">-  case 'a': // account</span>
<a href="#l1.2379"></a><span id="l1.2379" class="difflineminus">-    if (aColumnName[1] == 'c') // account</span>
<a href="#l1.2380"></a><span id="l1.2380" class="difflineminus">-      rv = FetchAccount(msgHdr, aValue);</span>
<a href="#l1.2381"></a><span id="l1.2381" class="difflineminus">-    break;</span>
<a href="#l1.2382"></a><span id="l1.2382" class="difflineminus">-  case 't':</span>
<a href="#l1.2383"></a><span id="l1.2383" class="difflineminus">-    // total msgs in thread column</span>
<a href="#l1.2384"></a><span id="l1.2384" class="difflineminus">-    if (aColumnName[1] == 'o' &amp;&amp; (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.2385"></a><span id="l1.2385" class="difflineminus">-    {</span>
<a href="#l1.2386"></a><span id="l1.2386" class="difflineminus">-      if (m_flags[aRow] &amp; MSG_VIEW_FLAG_ISTHREAD)</span>
<a href="#l1.2387"></a><span id="l1.2387" class="difflineplus">+    case 's':</span>
<a href="#l1.2388"></a><span id="l1.2388" class="difflineplus">+      if (aColumnName[1] == 'u') // subject</span>
<a href="#l1.2389"></a><span id="l1.2389" class="difflineplus">+        rv = FetchSubject(msgHdr, m_flags[aRow], aValue);</span>
<a href="#l1.2390"></a><span id="l1.2390" class="difflineplus">+      else if (aColumnName[1] == 'e') // sender</span>
<a href="#l1.2391"></a><span id="l1.2391" class="difflineplus">+        rv = FetchAuthor(msgHdr, aValue);</span>
<a href="#l1.2392"></a><span id="l1.2392" class="difflineplus">+      else if (aColumnName[1] == 'i') // size</span>
<a href="#l1.2393"></a><span id="l1.2393" class="difflineplus">+        rv = FetchSize(msgHdr, aValue);</span>
<a href="#l1.2394"></a><span id="l1.2394" class="difflineplus">+      else if (aColumnName[1] == 't') // status</span>
<a href="#l1.2395"></a><span id="l1.2395">       {</span>
<a href="#l1.2396"></a><span id="l1.2396" class="difflineminus">-        rv = GetThreadContainingIndex(aRow, getter_AddRefs(thread));</span>
<a href="#l1.2397"></a><span id="l1.2397" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; thread)</span>
<a href="#l1.2398"></a><span id="l1.2398" class="difflineminus">-        {</span>
<a href="#l1.2399"></a><span id="l1.2399" class="difflineminus">-          nsAutoString formattedCountString;</span>
<a href="#l1.2400"></a><span id="l1.2400" class="difflineminus">-          uint32_t numChildren;</span>
<a href="#l1.2401"></a><span id="l1.2401" class="difflineminus">-          thread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l1.2402"></a><span id="l1.2402" class="difflineminus">-          formattedCountString.AppendInt(numChildren);</span>
<a href="#l1.2403"></a><span id="l1.2403" class="difflineminus">-          aValue.Assign(formattedCountString);</span>
<a href="#l1.2404"></a><span id="l1.2404" class="difflineminus">-        }</span>
<a href="#l1.2405"></a><span id="l1.2405" class="difflineplus">+        uint32_t flags;</span>
<a href="#l1.2406"></a><span id="l1.2406" class="difflineplus">+        msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.2407"></a><span id="l1.2407" class="difflineplus">+        rv = FetchStatus(flags, aValue);</span>
<a href="#l1.2408"></a><span id="l1.2408">       }</span>
<a href="#l1.2409"></a><span id="l1.2409" class="difflineminus">-    }</span>
<a href="#l1.2410"></a><span id="l1.2410" class="difflineminus">-    else if (aColumnName[1] == 'a') // tags</span>
<a href="#l1.2411"></a><span id="l1.2411" class="difflineminus">-    {</span>
<a href="#l1.2412"></a><span id="l1.2412" class="difflineminus">-      rv = FetchTags(msgHdr, aValue);</span>
<a href="#l1.2413"></a><span id="l1.2413" class="difflineminus">-    }</span>
<a href="#l1.2414"></a><span id="l1.2414" class="difflineminus">-    break;</span>
<a href="#l1.2415"></a><span id="l1.2415" class="difflineminus">-  case 'u':</span>
<a href="#l1.2416"></a><span id="l1.2416" class="difflineminus">-    // unread msgs in thread col</span>
<a href="#l1.2417"></a><span id="l1.2417" class="difflineminus">-    if (aColumnName[6] == 'C' &amp;&amp; (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.2418"></a><span id="l1.2418" class="difflineminus">-    {</span>
<a href="#l1.2419"></a><span id="l1.2419" class="difflineminus">-      if (m_flags[aRow] &amp; MSG_VIEW_FLAG_ISTHREAD)</span>
<a href="#l1.2420"></a><span id="l1.2420" class="difflineplus">+      break;</span>
<a href="#l1.2421"></a><span id="l1.2421" class="difflineplus">+    case 'r':</span>
<a href="#l1.2422"></a><span id="l1.2422" class="difflineplus">+      if (aColumnName[3] == 'i') // recipient</span>
<a href="#l1.2423"></a><span id="l1.2423" class="difflineplus">+        rv = FetchRecipients(msgHdr, aValue);</span>
<a href="#l1.2424"></a><span id="l1.2424" class="difflineplus">+      else if (aColumnName[3] == 'e') // received</span>
<a href="#l1.2425"></a><span id="l1.2425" class="difflineplus">+        rv = FetchDate(msgHdr, aValue, true);</span>
<a href="#l1.2426"></a><span id="l1.2426" class="difflineplus">+      break;</span>
<a href="#l1.2427"></a><span id="l1.2427" class="difflineplus">+    case 'd':  // date</span>
<a href="#l1.2428"></a><span id="l1.2428" class="difflineplus">+      rv = FetchDate(msgHdr, aValue);</span>
<a href="#l1.2429"></a><span id="l1.2429" class="difflineplus">+      break;</span>
<a href="#l1.2430"></a><span id="l1.2430" class="difflineplus">+    case 'c': // correspondent</span>
<a href="#l1.2431"></a><span id="l1.2431" class="difflineplus">+      if (IsOutgoingMsg(msgHdr))</span>
<a href="#l1.2432"></a><span id="l1.2432" class="difflineplus">+        rv = FetchRecipients(msgHdr, aValue);</span>
<a href="#l1.2433"></a><span id="l1.2433" class="difflineplus">+      else</span>
<a href="#l1.2434"></a><span id="l1.2434" class="difflineplus">+        rv = FetchAuthor(msgHdr, aValue);</span>
<a href="#l1.2435"></a><span id="l1.2435" class="difflineplus">+      break;</span>
<a href="#l1.2436"></a><span id="l1.2436" class="difflineplus">+    case 'p': // priority</span>
<a href="#l1.2437"></a><span id="l1.2437" class="difflineplus">+      rv = FetchPriority(msgHdr, aValue);</span>
<a href="#l1.2438"></a><span id="l1.2438" class="difflineplus">+      break;</span>
<a href="#l1.2439"></a><span id="l1.2439" class="difflineplus">+    case 'a': // account</span>
<a href="#l1.2440"></a><span id="l1.2440" class="difflineplus">+      if (aColumnName[1] == 'c') // account</span>
<a href="#l1.2441"></a><span id="l1.2441" class="difflineplus">+        rv = FetchAccount(msgHdr, aValue);</span>
<a href="#l1.2442"></a><span id="l1.2442" class="difflineplus">+      break;</span>
<a href="#l1.2443"></a><span id="l1.2443" class="difflineplus">+    case 't':</span>
<a href="#l1.2444"></a><span id="l1.2444" class="difflineplus">+      // total msgs in thread column</span>
<a href="#l1.2445"></a><span id="l1.2445" class="difflineplus">+      if (aColumnName[1] == 'o' &amp;&amp;</span>
<a href="#l1.2446"></a><span id="l1.2446" class="difflineplus">+          m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.2447"></a><span id="l1.2447">       {</span>
<a href="#l1.2448"></a><span id="l1.2448" class="difflineminus">-        rv = GetThreadContainingIndex(aRow, getter_AddRefs(thread));</span>
<a href="#l1.2449"></a><span id="l1.2449" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; thread)</span>
<a href="#l1.2450"></a><span id="l1.2450" class="difflineplus">+        if (m_flags[aRow] &amp; MSG_VIEW_FLAG_ISTHREAD)</span>
<a href="#l1.2451"></a><span id="l1.2451">         {</span>
<a href="#l1.2452"></a><span id="l1.2452" class="difflineminus">-          nsAutoString formattedCountString;</span>
<a href="#l1.2453"></a><span id="l1.2453" class="difflineminus">-          uint32_t numUnreadChildren;</span>
<a href="#l1.2454"></a><span id="l1.2454" class="difflineminus">-          thread-&gt;GetNumUnreadChildren(&amp;numUnreadChildren);</span>
<a href="#l1.2455"></a><span id="l1.2455" class="difflineminus">-          if (numUnreadChildren &gt; 0)</span>
<a href="#l1.2456"></a><span id="l1.2456" class="difflineplus">+          rv = GetThreadContainingIndex(aRow, getter_AddRefs(thread));</span>
<a href="#l1.2457"></a><span id="l1.2457" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; thread)</span>
<a href="#l1.2458"></a><span id="l1.2458">           {</span>
<a href="#l1.2459"></a><span id="l1.2459" class="difflineminus">-            formattedCountString.AppendInt(numUnreadChildren);</span>
<a href="#l1.2460"></a><span id="l1.2460" class="difflineplus">+            nsAutoString formattedCountString;</span>
<a href="#l1.2461"></a><span id="l1.2461" class="difflineplus">+            uint32_t numChildren;</span>
<a href="#l1.2462"></a><span id="l1.2462" class="difflineplus">+            thread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l1.2463"></a><span id="l1.2463" class="difflineplus">+            formattedCountString.AppendInt(numChildren);</span>
<a href="#l1.2464"></a><span id="l1.2464">             aValue.Assign(formattedCountString);</span>
<a href="#l1.2465"></a><span id="l1.2465">           }</span>
<a href="#l1.2466"></a><span id="l1.2466">         }</span>
<a href="#l1.2467"></a><span id="l1.2467">       }</span>
<a href="#l1.2468"></a><span id="l1.2468" class="difflineminus">-    }</span>
<a href="#l1.2469"></a><span id="l1.2469" class="difflineminus">-    break;</span>
<a href="#l1.2470"></a><span id="l1.2470" class="difflineminus">-  case 'j':</span>
<a href="#l1.2471"></a><span id="l1.2471" class="difflineplus">+      else if (aColumnName[1] == 'a') // tags</span>
<a href="#l1.2472"></a><span id="l1.2472" class="difflineplus">+      {</span>
<a href="#l1.2473"></a><span id="l1.2473" class="difflineplus">+        rv = FetchTags(msgHdr, aValue);</span>
<a href="#l1.2474"></a><span id="l1.2474" class="difflineplus">+      }</span>
<a href="#l1.2475"></a><span id="l1.2475" class="difflineplus">+      break;</span>
<a href="#l1.2476"></a><span id="l1.2476" class="difflineplus">+    case 'u':</span>
<a href="#l1.2477"></a><span id="l1.2477" class="difflineplus">+      // unread msgs in thread col</span>
<a href="#l1.2478"></a><span id="l1.2478" class="difflineplus">+      if (aColumnName[6] == 'C' &amp;&amp;</span>
<a href="#l1.2479"></a><span id="l1.2479" class="difflineplus">+          m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.2480"></a><span id="l1.2480" class="difflineplus">+      {</span>
<a href="#l1.2481"></a><span id="l1.2481" class="difflineplus">+        if (m_flags[aRow] &amp; MSG_VIEW_FLAG_ISTHREAD)</span>
<a href="#l1.2482"></a><span id="l1.2482" class="difflineplus">+        {</span>
<a href="#l1.2483"></a><span id="l1.2483" class="difflineplus">+          rv = GetThreadContainingIndex(aRow, getter_AddRefs(thread));</span>
<a href="#l1.2484"></a><span id="l1.2484" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; thread)</span>
<a href="#l1.2485"></a><span id="l1.2485" class="difflineplus">+          {</span>
<a href="#l1.2486"></a><span id="l1.2486" class="difflineplus">+            nsAutoString formattedCountString;</span>
<a href="#l1.2487"></a><span id="l1.2487" class="difflineplus">+            uint32_t numUnreadChildren;</span>
<a href="#l1.2488"></a><span id="l1.2488" class="difflineplus">+            thread-&gt;GetNumUnreadChildren(&amp;numUnreadChildren);</span>
<a href="#l1.2489"></a><span id="l1.2489" class="difflineplus">+            if (numUnreadChildren &gt; 0)</span>
<a href="#l1.2490"></a><span id="l1.2490" class="difflineplus">+            {</span>
<a href="#l1.2491"></a><span id="l1.2491" class="difflineplus">+              formattedCountString.AppendInt(numUnreadChildren);</span>
<a href="#l1.2492"></a><span id="l1.2492" class="difflineplus">+              aValue.Assign(formattedCountString);</span>
<a href="#l1.2493"></a><span id="l1.2493" class="difflineplus">+            }</span>
<a href="#l1.2494"></a><span id="l1.2494" class="difflineplus">+          }</span>
<a href="#l1.2495"></a><span id="l1.2495" class="difflineplus">+        }</span>
<a href="#l1.2496"></a><span id="l1.2496" class="difflineplus">+      }</span>
<a href="#l1.2497"></a><span id="l1.2497" class="difflineplus">+      break;</span>
<a href="#l1.2498"></a><span id="l1.2498" class="difflineplus">+    case 'j':</span>
<a href="#l1.2499"></a><span id="l1.2499">     {</span>
<a href="#l1.2500"></a><span id="l1.2500">       nsCString junkScoreStr;</span>
<a href="#l1.2501"></a><span id="l1.2501">       msgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l1.2502"></a><span id="l1.2502">       CopyASCIItoUTF16(junkScoreStr, aValue);</span>
<a href="#l1.2503"></a><span id="l1.2503" class="difflineminus">-    }</span>
<a href="#l1.2504"></a><span id="l1.2504" class="difflineminus">-    break;</span>
<a href="#l1.2505"></a><span id="l1.2505" class="difflineminus">-  case 'i': // id</span>
<a href="#l1.2506"></a><span id="l1.2506" class="difflineplus">+      break;</span>
<a href="#l1.2507"></a><span id="l1.2507" class="difflineplus">+    }</span>
<a href="#l1.2508"></a><span id="l1.2508" class="difflineplus">+    case 'i': // id</span>
<a href="#l1.2509"></a><span id="l1.2509">     {</span>
<a href="#l1.2510"></a><span id="l1.2510">       nsAutoString keyString;</span>
<a href="#l1.2511"></a><span id="l1.2511">       nsMsgKey key;</span>
<a href="#l1.2512"></a><span id="l1.2512">       msgHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l1.2513"></a><span id="l1.2513">       keyString.AppendInt((int64_t)key);</span>
<a href="#l1.2514"></a><span id="l1.2514">       aValue.Assign(keyString);</span>
<a href="#l1.2515"></a><span id="l1.2515" class="difflineminus">-    }</span>
<a href="#l1.2516"></a><span id="l1.2516" class="difflineminus">-    break;</span>
<a href="#l1.2517"></a><span id="l1.2517" class="difflineminus">-  default:</span>
<a href="#l1.2518"></a><span id="l1.2518" class="difflineminus">-    break;</span>
<a href="#l1.2519"></a><span id="l1.2519" class="difflineminus">-  }</span>
<a href="#l1.2520"></a><span id="l1.2520" class="difflineminus">-</span>
<a href="#l1.2521"></a><span id="l1.2521" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.2522"></a><span id="l1.2522" class="difflineminus">-}</span>
<a href="#l1.2523"></a><span id="l1.2523" class="difflineminus">-</span>
<a href="#l1.2524"></a><span id="l1.2524" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::SetTree(nsITreeBoxObject *tree)</span>
<a href="#l1.2525"></a><span id="l1.2525" class="difflineplus">+      break;</span>
<a href="#l1.2526"></a><span id="l1.2526" class="difflineplus">+    }</span>
<a href="#l1.2527"></a><span id="l1.2527" class="difflineplus">+    default:</span>
<a href="#l1.2528"></a><span id="l1.2528" class="difflineplus">+      break;</span>
<a href="#l1.2529"></a><span id="l1.2529" class="difflineplus">+  }</span>
<a href="#l1.2530"></a><span id="l1.2530" class="difflineplus">+</span>
<a href="#l1.2531"></a><span id="l1.2531" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.2532"></a><span id="l1.2532" class="difflineplus">+}</span>
<a href="#l1.2533"></a><span id="l1.2533" class="difflineplus">+</span>
<a href="#l1.2534"></a><span id="l1.2534" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2535"></a><span id="l1.2535" class="difflineplus">+nsMsgDBView::SetTree(nsITreeBoxObject *tree)</span>
<a href="#l1.2536"></a><span id="l1.2536"> {</span>
<a href="#l1.2537"></a><span id="l1.2537">   mTree = tree;</span>
<a href="#l1.2538"></a><span id="l1.2538">   return NS_OK;</span>
<a href="#l1.2539"></a><span id="l1.2539"> }</span>
<a href="#l1.2540"></a><span id="l1.2540"> </span>
<a href="#l1.2541"></a><span id="l1.2541" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::ToggleOpenState(int32_t index)</span>
<a href="#l1.2542"></a><span id="l1.2542" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2543"></a><span id="l1.2543" class="difflineplus">+nsMsgDBView::ToggleOpenState(int32_t index)</span>
<a href="#l1.2544"></a><span id="l1.2544"> {</span>
<a href="#l1.2545"></a><span id="l1.2545">   uint32_t numChanged;</span>
<a href="#l1.2546"></a><span id="l1.2546">   nsresult rv = ToggleExpansion(index, &amp;numChanged);</span>
<a href="#l1.2547"></a><span id="l1.2547">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.2548"></a><span id="l1.2548">   return NS_OK;</span>
<a href="#l1.2549"></a><span id="l1.2549"> }</span>
<a href="#l1.2550"></a><span id="l1.2550"> </span>
<a href="#l1.2551"></a><span id="l1.2551" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::CycleHeader(nsITreeColumn* aCol)</span>
<a href="#l1.2552"></a><span id="l1.2552" class="difflineminus">-{</span>
<a href="#l1.2553"></a><span id="l1.2553" class="difflineminus">-    // let HandleColumnClick() in threadPane.js handle it</span>
<a href="#l1.2554"></a><span id="l1.2554" class="difflineminus">-    // since it will set / clear the sort indicators.</span>
<a href="#l1.2555"></a><span id="l1.2555" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.2556"></a><span id="l1.2556" class="difflineminus">-}</span>
<a href="#l1.2557"></a><span id="l1.2557" class="difflineminus">-</span>
<a href="#l1.2558"></a><span id="l1.2558" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::CycleCell(int32_t row, nsITreeColumn* col)</span>
<a href="#l1.2559"></a><span id="l1.2559" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2560"></a><span id="l1.2560" class="difflineplus">+nsMsgDBView::CycleHeader(nsITreeColumn* aCol)</span>
<a href="#l1.2561"></a><span id="l1.2561" class="difflineplus">+{</span>
<a href="#l1.2562"></a><span id="l1.2562" class="difflineplus">+  // Let HandleColumnClick() in threadPane.js handle it</span>
<a href="#l1.2563"></a><span id="l1.2563" class="difflineplus">+  // since it will set / clear the sort indicators.</span>
<a href="#l1.2564"></a><span id="l1.2564" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.2565"></a><span id="l1.2565" class="difflineplus">+}</span>
<a href="#l1.2566"></a><span id="l1.2566" class="difflineplus">+</span>
<a href="#l1.2567"></a><span id="l1.2567" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2568"></a><span id="l1.2568" class="difflineplus">+nsMsgDBView::CycleCell(int32_t row,</span>
<a href="#l1.2569"></a><span id="l1.2569" class="difflineplus">+                       nsITreeColumn* col)</span>
<a href="#l1.2570"></a><span id="l1.2570"> {</span>
<a href="#l1.2571"></a><span id="l1.2571">   if (!IsValidIndex(row))</span>
<a href="#l1.2572"></a><span id="l1.2572">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.2573"></a><span id="l1.2573"> </span>
<a href="#l1.2574"></a><span id="l1.2574">   const char16_t* colID;</span>
<a href="#l1.2575"></a><span id="l1.2575">   col-&gt;GetIdConst(&amp;colID);</span>
<a href="#l1.2576"></a><span id="l1.2576"> </span>
<a href="#l1.2577"></a><span id="l1.2577" class="difflineminus">-  //attempt to retreive a custom column handler. If it exists call it and return</span>
<a href="#l1.2578"></a><span id="l1.2578" class="difflineplus">+  // Attempt to retreive a custom column handler. If it exists call it and</span>
<a href="#l1.2579"></a><span id="l1.2579" class="difflineplus">+  // return.</span>
<a href="#l1.2580"></a><span id="l1.2580">   nsIMsgCustomColumnHandler* colHandler = GetColumnHandler(colID);</span>
<a href="#l1.2581"></a><span id="l1.2581"> </span>
<a href="#l1.2582"></a><span id="l1.2582">   if (colHandler)</span>
<a href="#l1.2583"></a><span id="l1.2583">   {</span>
<a href="#l1.2584"></a><span id="l1.2584">     colHandler-&gt;CycleCell(row, col);</span>
<a href="#l1.2585"></a><span id="l1.2585">     return NS_OK;</span>
<a href="#l1.2586"></a><span id="l1.2586">   }</span>
<a href="#l1.2587"></a><span id="l1.2587"> </span>
<a href="#l1.2588"></a><span id="l1.2588">   // The cyclers below don't work for the grouped header dummy row, currently.</span>
<a href="#l1.2589"></a><span id="l1.2589">   // A future implementation should consider both collapsed and expanded state.</span>
<a href="#l1.2590"></a><span id="l1.2590">   if (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort &amp;&amp;</span>
<a href="#l1.2591"></a><span id="l1.2591">       m_flags[row] &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l1.2592"></a><span id="l1.2592">     return NS_OK;</span>
<a href="#l1.2593"></a><span id="l1.2593"> </span>
<a href="#l1.2594"></a><span id="l1.2594">   switch (colID[0])</span>
<a href="#l1.2595"></a><span id="l1.2595">   {</span>
<a href="#l1.2596"></a><span id="l1.2596" class="difflineminus">-  case 'u': // unreadButtonColHeader</span>
<a href="#l1.2597"></a><span id="l1.2597" class="difflineminus">-    if (colID[6] == 'B')</span>
<a href="#l1.2598"></a><span id="l1.2598" class="difflineminus">-      ApplyCommandToIndices(nsMsgViewCommandType::toggleMessageRead, (nsMsgViewIndex *) &amp;row, 1);</span>
<a href="#l1.2599"></a><span id="l1.2599" class="difflineminus">-   break;</span>
<a href="#l1.2600"></a><span id="l1.2600" class="difflineminus">-  case 't': // tag cell, threaded cell or total cell</span>
<a href="#l1.2601"></a><span id="l1.2601" class="difflineminus">-    if (colID[1] == 'h')</span>
<a href="#l1.2602"></a><span id="l1.2602" class="difflineminus">-    {</span>
<a href="#l1.2603"></a><span id="l1.2603" class="difflineminus">-      ExpandAndSelectThreadByIndex(row, false);</span>
<a href="#l1.2604"></a><span id="l1.2604" class="difflineminus">-    }</span>
<a href="#l1.2605"></a><span id="l1.2605" class="difflineminus">-    else if (colID[1] == 'a')</span>
<a href="#l1.2606"></a><span id="l1.2606" class="difflineminus">-    {</span>
<a href="#l1.2607"></a><span id="l1.2607" class="difflineminus">-      // ### Do we want to keep this behaviour but switch it to tags?</span>
<a href="#l1.2608"></a><span id="l1.2608" class="difflineminus">-      // We could enumerate over the tags and go to the next one - it looks</span>
<a href="#l1.2609"></a><span id="l1.2609" class="difflineminus">-      // to me like this wasn't working before tags landed, so maybe not</span>
<a href="#l1.2610"></a><span id="l1.2610" class="difflineminus">-      // worth bothering with.</span>
<a href="#l1.2611"></a><span id="l1.2611" class="difflineminus">-    }</span>
<a href="#l1.2612"></a><span id="l1.2612" class="difflineminus">-    break;</span>
<a href="#l1.2613"></a><span id="l1.2613" class="difflineminus">-  case 'f': // flagged column</span>
<a href="#l1.2614"></a><span id="l1.2614" class="difflineminus">-    // toggle the flagged status of the element at row.</span>
<a href="#l1.2615"></a><span id="l1.2615" class="difflineminus">-    if (m_flags[row] &amp; nsMsgMessageFlags::Marked)</span>
<a href="#l1.2616"></a><span id="l1.2616" class="difflineminus">-      ApplyCommandToIndices(nsMsgViewCommandType::unflagMessages, (nsMsgViewIndex *) &amp;row, 1);</span>
<a href="#l1.2617"></a><span id="l1.2617" class="difflineminus">-    else</span>
<a href="#l1.2618"></a><span id="l1.2618" class="difflineminus">-      ApplyCommandToIndices(nsMsgViewCommandType::flagMessages, (nsMsgViewIndex *) &amp;row, 1);</span>
<a href="#l1.2619"></a><span id="l1.2619" class="difflineminus">-    break;</span>
<a href="#l1.2620"></a><span id="l1.2620" class="difflineminus">-  case 'j': // junkStatus column</span>
<a href="#l1.2621"></a><span id="l1.2621" class="difflineplus">+    case 'u': // unreadButtonColHeader</span>
<a href="#l1.2622"></a><span id="l1.2622" class="difflineplus">+      if (colID[6] == 'B')</span>
<a href="#l1.2623"></a><span id="l1.2623" class="difflineplus">+        ApplyCommandToIndices(nsMsgViewCommandType::toggleMessageRead,</span>
<a href="#l1.2624"></a><span id="l1.2624" class="difflineplus">+                              (nsMsgViewIndex *) &amp;row, 1);</span>
<a href="#l1.2625"></a><span id="l1.2625" class="difflineplus">+     break;</span>
<a href="#l1.2626"></a><span id="l1.2626" class="difflineplus">+    case 't': // tag cell, threaded cell or total cell</span>
<a href="#l1.2627"></a><span id="l1.2627" class="difflineplus">+      if (colID[1] == 'h')</span>
<a href="#l1.2628"></a><span id="l1.2628" class="difflineplus">+      {</span>
<a href="#l1.2629"></a><span id="l1.2629" class="difflineplus">+        ExpandAndSelectThreadByIndex(row, false);</span>
<a href="#l1.2630"></a><span id="l1.2630" class="difflineplus">+      }</span>
<a href="#l1.2631"></a><span id="l1.2631" class="difflineplus">+      else if (colID[1] == 'a')</span>
<a href="#l1.2632"></a><span id="l1.2632" class="difflineplus">+      {</span>
<a href="#l1.2633"></a><span id="l1.2633" class="difflineplus">+        // XXX Do we want to keep this behaviour but switch it to tags?</span>
<a href="#l1.2634"></a><span id="l1.2634" class="difflineplus">+        // We could enumerate over the tags and go to the next one - it looks</span>
<a href="#l1.2635"></a><span id="l1.2635" class="difflineplus">+        // to me like this wasn't working before tags landed, so maybe not</span>
<a href="#l1.2636"></a><span id="l1.2636" class="difflineplus">+        // worth bothering with.</span>
<a href="#l1.2637"></a><span id="l1.2637" class="difflineplus">+      }</span>
<a href="#l1.2638"></a><span id="l1.2638" class="difflineplus">+      break;</span>
<a href="#l1.2639"></a><span id="l1.2639" class="difflineplus">+    case 'f': // flagged column</span>
<a href="#l1.2640"></a><span id="l1.2640" class="difflineplus">+      // toggle the flagged status of the element at row.</span>
<a href="#l1.2641"></a><span id="l1.2641" class="difflineplus">+      if (m_flags[row] &amp; nsMsgMessageFlags::Marked)</span>
<a href="#l1.2642"></a><span id="l1.2642" class="difflineplus">+        ApplyCommandToIndices(nsMsgViewCommandType::unflagMessages,</span>
<a href="#l1.2643"></a><span id="l1.2643" class="difflineplus">+                              (nsMsgViewIndex *) &amp;row, 1);</span>
<a href="#l1.2644"></a><span id="l1.2644" class="difflineplus">+      else</span>
<a href="#l1.2645"></a><span id="l1.2645" class="difflineplus">+        ApplyCommandToIndices(nsMsgViewCommandType::flagMessages,</span>
<a href="#l1.2646"></a><span id="l1.2646" class="difflineplus">+                              (nsMsgViewIndex *) &amp;row, 1);</span>
<a href="#l1.2647"></a><span id="l1.2647" class="difflineplus">+      break;</span>
<a href="#l1.2648"></a><span id="l1.2648" class="difflineplus">+    case 'j': // junkStatus column</span>
<a href="#l1.2649"></a><span id="l1.2649">     {</span>
<a href="#l1.2650"></a><span id="l1.2650">       if (!JunkControlsEnabled(row))</span>
<a href="#l1.2651"></a><span id="l1.2651">         return NS_OK;</span>
<a href="#l1.2652"></a><span id="l1.2652"> </span>
<a href="#l1.2653"></a><span id="l1.2653">       nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.2654"></a><span id="l1.2654" class="difflineminus">-</span>
<a href="#l1.2655"></a><span id="l1.2655">       nsresult rv = GetMsgHdrForViewIndex(row, getter_AddRefs(msgHdr));</span>
<a href="#l1.2656"></a><span id="l1.2656">       if (NS_SUCCEEDED(rv) &amp;&amp; msgHdr)</span>
<a href="#l1.2657"></a><span id="l1.2657">       {</span>
<a href="#l1.2658"></a><span id="l1.2658">         nsCString junkScoreStr;</span>
<a href="#l1.2659"></a><span id="l1.2659">         rv = msgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l1.2660"></a><span id="l1.2660" class="difflineminus">-        if (junkScoreStr.IsEmpty() || (junkScoreStr.ToInteger(&amp;rv) == nsIJunkMailPlugin::IS_HAM_SCORE))</span>
<a href="#l1.2661"></a><span id="l1.2661" class="difflineminus">-          ApplyCommandToIndices(nsMsgViewCommandType::junk, (nsMsgViewIndex *) &amp;row, 1);</span>
<a href="#l1.2662"></a><span id="l1.2662" class="difflineplus">+        if (junkScoreStr.IsEmpty() ||</span>
<a href="#l1.2663"></a><span id="l1.2663" class="difflineplus">+            (junkScoreStr.ToInteger(&amp;rv) == nsIJunkMailPlugin::IS_HAM_SCORE))</span>
<a href="#l1.2664"></a><span id="l1.2664" class="difflineplus">+          ApplyCommandToIndices(nsMsgViewCommandType::junk,</span>
<a href="#l1.2665"></a><span id="l1.2665" class="difflineplus">+                                (nsMsgViewIndex *) &amp;row, 1);</span>
<a href="#l1.2666"></a><span id="l1.2666">         else</span>
<a href="#l1.2667"></a><span id="l1.2667" class="difflineminus">-          ApplyCommandToIndices(nsMsgViewCommandType::unjunk, (nsMsgViewIndex *) &amp;row, 1);</span>
<a href="#l1.2668"></a><span id="l1.2668" class="difflineplus">+          ApplyCommandToIndices(nsMsgViewCommandType::unjunk,</span>
<a href="#l1.2669"></a><span id="l1.2669" class="difflineplus">+                                (nsMsgViewIndex *) &amp;row, 1);</span>
<a href="#l1.2670"></a><span id="l1.2670"> </span>
<a href="#l1.2671"></a><span id="l1.2671">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Converting junkScore to integer failed.&quot;);</span>
<a href="#l1.2672"></a><span id="l1.2672">       }</span>
<a href="#l1.2673"></a><span id="l1.2673" class="difflineminus">-    }</span>
<a href="#l1.2674"></a><span id="l1.2674" class="difflineminus">-    break;</span>
<a href="#l1.2675"></a><span id="l1.2675" class="difflineminus">-  default:</span>
<a href="#l1.2676"></a><span id="l1.2676" class="difflineminus">-    break;</span>
<a href="#l1.2677"></a><span id="l1.2677" class="difflineminus">-</span>
<a href="#l1.2678"></a><span id="l1.2678" class="difflineminus">-  }</span>
<a href="#l1.2679"></a><span id="l1.2679" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.2680"></a><span id="l1.2680" class="difflineminus">-}</span>
<a href="#l1.2681"></a><span id="l1.2681" class="difflineminus">-</span>
<a href="#l1.2682"></a><span id="l1.2682" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::PerformAction(const char16_t *action)</span>
<a href="#l1.2683"></a><span id="l1.2683" class="difflineminus">-{</span>
<a href="#l1.2684"></a><span id="l1.2684" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.2685"></a><span id="l1.2685" class="difflineminus">-}</span>
<a href="#l1.2686"></a><span id="l1.2686" class="difflineminus">-</span>
<a href="#l1.2687"></a><span id="l1.2687" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::PerformActionOnRow(const char16_t *action, int32_t row)</span>
<a href="#l1.2688"></a><span id="l1.2688" class="difflineminus">-{</span>
<a href="#l1.2689"></a><span id="l1.2689" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.2690"></a><span id="l1.2690" class="difflineminus">-}</span>
<a href="#l1.2691"></a><span id="l1.2691" class="difflineminus">-</span>
<a href="#l1.2692"></a><span id="l1.2692" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::PerformActionOnCell(const char16_t *action, int32_t row, nsITreeColumn* col)</span>
<a href="#l1.2693"></a><span id="l1.2693" class="difflineplus">+      break;</span>
<a href="#l1.2694"></a><span id="l1.2694" class="difflineplus">+    }</span>
<a href="#l1.2695"></a><span id="l1.2695" class="difflineplus">+    default:</span>
<a href="#l1.2696"></a><span id="l1.2696" class="difflineplus">+      break;</span>
<a href="#l1.2697"></a><span id="l1.2697" class="difflineplus">+  }</span>
<a href="#l1.2698"></a><span id="l1.2698" class="difflineplus">+</span>
<a href="#l1.2699"></a><span id="l1.2699" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.2700"></a><span id="l1.2700" class="difflineplus">+}</span>
<a href="#l1.2701"></a><span id="l1.2701" class="difflineplus">+</span>
<a href="#l1.2702"></a><span id="l1.2702" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2703"></a><span id="l1.2703" class="difflineplus">+nsMsgDBView::PerformAction(const char16_t *action)</span>
<a href="#l1.2704"></a><span id="l1.2704" class="difflineplus">+{</span>
<a href="#l1.2705"></a><span id="l1.2705" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.2706"></a><span id="l1.2706" class="difflineplus">+}</span>
<a href="#l1.2707"></a><span id="l1.2707" class="difflineplus">+</span>
<a href="#l1.2708"></a><span id="l1.2708" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2709"></a><span id="l1.2709" class="difflineplus">+nsMsgDBView::PerformActionOnRow(const char16_t *action, int32_t row)</span>
<a href="#l1.2710"></a><span id="l1.2710" class="difflineplus">+{</span>
<a href="#l1.2711"></a><span id="l1.2711" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.2712"></a><span id="l1.2712" class="difflineplus">+}</span>
<a href="#l1.2713"></a><span id="l1.2713" class="difflineplus">+</span>
<a href="#l1.2714"></a><span id="l1.2714" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2715"></a><span id="l1.2715" class="difflineplus">+nsMsgDBView::PerformActionOnCell(const char16_t *action,</span>
<a href="#l1.2716"></a><span id="l1.2716" class="difflineplus">+                                 int32_t row,</span>
<a href="#l1.2717"></a><span id="l1.2717" class="difflineplus">+                                 nsITreeColumn* col)</span>
<a href="#l1.2718"></a><span id="l1.2718"> {</span>
<a href="#l1.2719"></a><span id="l1.2719">   return NS_OK;</span>
<a href="#l1.2720"></a><span id="l1.2720"> }</span>
<a href="#l1.2721"></a><span id="l1.2721"> </span>
<a href="#l1.2722"></a><span id="l1.2722"> ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.2723"></a><span id="l1.2723"> // end nsITreeView Implementation Methods</span>
<a href="#l1.2724"></a><span id="l1.2724"> ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.2725"></a><span id="l1.2725"> </span>
<a href="#l1.2726"></a><span id="l1.2726" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder, nsMsgViewFlagsTypeValue viewFlags, int32_t *pCount)</span>
<a href="#l1.2727"></a><span id="l1.2727" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2728"></a><span id="l1.2728" class="difflineplus">+nsMsgDBView::Open(nsIMsgFolder *folder,</span>
<a href="#l1.2729"></a><span id="l1.2729" class="difflineplus">+                  nsMsgViewSortTypeValue sortType,</span>
<a href="#l1.2730"></a><span id="l1.2730" class="difflineplus">+                  nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l1.2731"></a><span id="l1.2731" class="difflineplus">+                  nsMsgViewFlagsTypeValue viewFlags,</span>
<a href="#l1.2732"></a><span id="l1.2732" class="difflineplus">+                  int32_t *pCount)</span>
<a href="#l1.2733"></a><span id="l1.2733"> {</span>
<a href="#l1.2734"></a><span id="l1.2734">   m_viewFlags = viewFlags;</span>
<a href="#l1.2735"></a><span id="l1.2735">   m_sortOrder = sortOrder;</span>
<a href="#l1.2736"></a><span id="l1.2736">   m_sortType = sortType;</span>
<a href="#l1.2737"></a><span id="l1.2737"> </span>
<a href="#l1.2738"></a><span id="l1.2738">   nsresult rv;</span>
<a href="#l1.2739"></a><span id="l1.2739">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l1.2740"></a><span id="l1.2740" class="difflineminus">-           do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l1.2741"></a><span id="l1.2741" class="difflineplus">+    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l1.2742"></a><span id="l1.2742" class="difflineplus">+</span>
<a href="#l1.2743"></a><span id="l1.2743">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.2744"></a><span id="l1.2744">   bool userNeedsToAuthenticate = false;</span>
<a href="#l1.2745"></a><span id="l1.2745" class="difflineminus">-  // if we're PasswordProtectLocalCache, then we need to find out if the server is authenticated.</span>
<a href="#l1.2746"></a><span id="l1.2746" class="difflineplus">+  // If we're PasswordProtectLocalCache, then we need to find out if the</span>
<a href="#l1.2747"></a><span id="l1.2747" class="difflineplus">+  // server is authenticated.</span>
<a href="#l1.2748"></a><span id="l1.2748">   (void) accountManager-&gt;GetUserNeedsToAuthenticate(&amp;userNeedsToAuthenticate);</span>
<a href="#l1.2749"></a><span id="l1.2749">   if (userNeedsToAuthenticate)</span>
<a href="#l1.2750"></a><span id="l1.2750">     return NS_MSG_USER_NOT_AUTHENTICATED;</span>
<a href="#l1.2751"></a><span id="l1.2751"> </span>
<a href="#l1.2752"></a><span id="l1.2752" class="difflineminus">-  if (folder) // search view will have a null folder</span>
<a href="#l1.2753"></a><span id="l1.2753" class="difflineminus">-  {</span>
<a href="#l1.2754"></a><span id="l1.2754" class="difflineplus">+  if (folder)</span>
<a href="#l1.2755"></a><span id="l1.2755" class="difflineplus">+  {</span>
<a href="#l1.2756"></a><span id="l1.2756" class="difflineplus">+    // Search view will have a null folder.</span>
<a href="#l1.2757"></a><span id="l1.2757">     nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l1.2758"></a><span id="l1.2758">     rv = folder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(m_db));</span>
<a href="#l1.2759"></a><span id="l1.2759">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.2760"></a><span id="l1.2760">     nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.2761"></a><span id="l1.2761">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.2762"></a><span id="l1.2762">     msgDBService-&gt;RegisterPendingListener(folder, this);</span>
<a href="#l1.2763"></a><span id="l1.2763">     m_folder = folder;</span>
<a href="#l1.2764"></a><span id="l1.2764"> </span>
<a href="#l1.2765"></a><span id="l1.2765">     if (!m_viewFolder)</span>
<a href="#l1.2766"></a><span id="l1.2766" class="difflineplus">+    {</span>
<a href="#l1.2767"></a><span id="l1.2767">       // There is never a viewFolder already set except for the single folder</span>
<a href="#l1.2768"></a><span id="l1.2768">       // saved search case, where the backing folder m_folder is different from</span>
<a href="#l1.2769"></a><span id="l1.2769">       // the m_viewFolder with its own dbFolderInfo state.</span>
<a href="#l1.2770"></a><span id="l1.2770">       m_viewFolder = folder;</span>
<a href="#l1.2771"></a><span id="l1.2771" class="difflineplus">+    }</span>
<a href="#l1.2772"></a><span id="l1.2772"> </span>
<a href="#l1.2773"></a><span id="l1.2773">     SetMRUTimeForFolder(m_viewFolder);</span>
<a href="#l1.2774"></a><span id="l1.2774"> </span>
<a href="#l1.2775"></a><span id="l1.2775">     RestoreSortInfo();</span>
<a href="#l1.2776"></a><span id="l1.2776"> </span>
<a href="#l1.2777"></a><span id="l1.2777" class="difflineminus">-    // determine if we are in a news folder or not.</span>
<a href="#l1.2778"></a><span id="l1.2778" class="difflineminus">-    // if yes, we'll show lines instead of size, and special icons in the thread pane</span>
<a href="#l1.2779"></a><span id="l1.2779" class="difflineplus">+    // Determine if we are in a news folder or not. If yes, we'll show lines</span>
<a href="#l1.2780"></a><span id="l1.2780" class="difflineplus">+    // instead of size, and special icons in the thread pane.</span>
<a href="#l1.2781"></a><span id="l1.2781">     nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.2782"></a><span id="l1.2782">     rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.2783"></a><span id="l1.2783">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.2784"></a><span id="l1.2784">     nsCString type;</span>
<a href="#l1.2785"></a><span id="l1.2785">     rv = server-&gt;GetType(type);</span>
<a href="#l1.2786"></a><span id="l1.2786">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.2787"></a><span id="l1.2787"> </span>
<a href="#l1.2788"></a><span id="l1.2788">     // I'm not sure this is correct, because XF virtual folders with mixed news</span>
<a href="#l1.2789"></a><span id="l1.2789">     // and mail can have this set.</span>
<a href="#l1.2790"></a><span id="l1.2790">     mIsNews = MsgLowerCaseEqualsLiteral(type, &quot;nntp&quot;);</span>
<a href="#l1.2791"></a><span id="l1.2791"> </span>
<a href="#l1.2792"></a><span id="l1.2792">     // Default to a virtual folder if folder not set, since synthetic search</span>
<a href="#l1.2793"></a><span id="l1.2793">     // views may not have a folder.</span>
<a href="#l1.2794"></a><span id="l1.2794">     uint32_t folderFlags = nsMsgFolderFlags::Virtual;</span>
<a href="#l1.2795"></a><span id="l1.2795">     if (folder)</span>
<a href="#l1.2796"></a><span id="l1.2796">       folder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l1.2797"></a><span id="l1.2797" class="difflineplus">+</span>
<a href="#l1.2798"></a><span id="l1.2798">     mIsXFVirtual = folderFlags &amp; nsMsgFolderFlags::Virtual;</span>
<a href="#l1.2799"></a><span id="l1.2799" class="difflineminus">-</span>
<a href="#l1.2800"></a><span id="l1.2800">     if (!mIsXFVirtual &amp;&amp; MsgLowerCaseEqualsLiteral(type, &quot;rss&quot;))</span>
<a href="#l1.2801"></a><span id="l1.2801">       mIsRss = true;</span>
<a href="#l1.2802"></a><span id="l1.2802"> </span>
<a href="#l1.2803"></a><span id="l1.2803" class="difflineminus">-    // special case nntp --&gt; news since we'll break themes if we try to be consistent</span>
<a href="#l1.2804"></a><span id="l1.2804" class="difflineplus">+    // Special case nntp --&gt; news since we'll break themes if we try to be</span>
<a href="#l1.2805"></a><span id="l1.2805" class="difflineplus">+    // consistent.</span>
<a href="#l1.2806"></a><span id="l1.2806">     if (mIsNews)</span>
<a href="#l1.2807"></a><span id="l1.2807">       mMessageType.AssignLiteral(&quot;news&quot;);</span>
<a href="#l1.2808"></a><span id="l1.2808">     else</span>
<a href="#l1.2809"></a><span id="l1.2809">       CopyUTF8toUTF16(type, mMessageType);</span>
<a href="#l1.2810"></a><span id="l1.2810"> </span>
<a href="#l1.2811"></a><span id="l1.2811">     GetImapDeleteModel(nullptr);</span>
<a href="#l1.2812"></a><span id="l1.2812"> </span>
<a href="#l1.2813"></a><span id="l1.2813">     nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l1.2814"></a><span id="l1.2814">     if (prefs)</span>
<a href="#l1.2815"></a><span id="l1.2815">     {</span>
<a href="#l1.2816"></a><span id="l1.2816">       prefs-&gt;GetBoolPref(&quot;mailnews.sort_threads_by_root&quot;, &amp;mSortThreadsByRoot);</span>
<a href="#l1.2817"></a><span id="l1.2817" class="difflineminus">-</span>
<a href="#l1.2818"></a><span id="l1.2818">       if (mIsNews)</span>
<a href="#l1.2819"></a><span id="l1.2819">         prefs-&gt;GetBoolPref(&quot;news.show_size_in_lines&quot;, &amp;mShowSizeInLines);</span>
<a href="#l1.2820"></a><span id="l1.2820">     }</span>
<a href="#l1.2821"></a><span id="l1.2821">   }</span>
<a href="#l1.2822"></a><span id="l1.2822"> </span>
<a href="#l1.2823"></a><span id="l1.2823">   nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l1.2824"></a><span id="l1.2824">   rv = accountManager-&gt;GetAllIdentities(getter_AddRefs(identities));</span>
<a href="#l1.2825"></a><span id="l1.2825">   if (!identities)</span>
<a href="#l1.2826"></a><span id="l1.2826" class="difflineat">@@ -2305,218 +2546,252 @@ NS_IMETHODIMP nsMsgDBView::Open(nsIMsgFo</span>
<a href="#l1.2827"></a><span id="l1.2827">     identity-&gt;GetEmail(email);</span>
<a href="#l1.2828"></a><span id="l1.2828">     if (!email.IsEmpty())</span>
<a href="#l1.2829"></a><span id="l1.2829">       mEmails.PutEntry(email);</span>
<a href="#l1.2830"></a><span id="l1.2830"> </span>
<a href="#l1.2831"></a><span id="l1.2831">     identity-&gt;GetReplyTo(email);</span>
<a href="#l1.2832"></a><span id="l1.2832">     if (!email.IsEmpty())</span>
<a href="#l1.2833"></a><span id="l1.2833">       mEmails.PutEntry(email);</span>
<a href="#l1.2834"></a><span id="l1.2834">   }</span>
<a href="#l1.2835"></a><span id="l1.2835" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.2836"></a><span id="l1.2836" class="difflineminus">-}</span>
<a href="#l1.2837"></a><span id="l1.2837" class="difflineminus">-</span>
<a href="#l1.2838"></a><span id="l1.2838" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::Close()</span>
<a href="#l1.2839"></a><span id="l1.2839" class="difflineplus">+</span>
<a href="#l1.2840"></a><span id="l1.2840" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.2841"></a><span id="l1.2841" class="difflineplus">+}</span>
<a href="#l1.2842"></a><span id="l1.2842" class="difflineplus">+</span>
<a href="#l1.2843"></a><span id="l1.2843" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2844"></a><span id="l1.2844" class="difflineplus">+nsMsgDBView::Close()</span>
<a href="#l1.2845"></a><span id="l1.2845"> {</span>
<a href="#l1.2846"></a><span id="l1.2846">   int32_t oldSize = GetSize();</span>
<a href="#l1.2847"></a><span id="l1.2847" class="difflineminus">-  // this is important, because the tree will ask us for our</span>
<a href="#l1.2848"></a><span id="l1.2848" class="difflineminus">-  // row count, which get determine from the number of keys.</span>
<a href="#l1.2849"></a><span id="l1.2849" class="difflineplus">+  // This is important, because the tree will ask us for our row count, which</span>
<a href="#l1.2850"></a><span id="l1.2850" class="difflineplus">+  // gets determined from the number of keys.</span>
<a href="#l1.2851"></a><span id="l1.2851">   m_keys.Clear();</span>
<a href="#l1.2852"></a><span id="l1.2852" class="difflineminus">-  // be consistent</span>
<a href="#l1.2853"></a><span id="l1.2853" class="difflineplus">+  // Be consistent.</span>
<a href="#l1.2854"></a><span id="l1.2854">   m_flags.Clear();</span>
<a href="#l1.2855"></a><span id="l1.2855">   m_levels.Clear();</span>
<a href="#l1.2856"></a><span id="l1.2856"> </span>
<a href="#l1.2857"></a><span id="l1.2857" class="difflineminus">-  // clear these out since they no longer apply if we're switching a folder</span>
<a href="#l1.2858"></a><span id="l1.2858" class="difflineplus">+  // Clear these out since they no longer apply if we're switching a folder</span>
<a href="#l1.2859"></a><span id="l1.2859">   if (mJunkHdrs)</span>
<a href="#l1.2860"></a><span id="l1.2860">     mJunkHdrs-&gt;Clear();</span>
<a href="#l1.2861"></a><span id="l1.2861"> </span>
<a href="#l1.2862"></a><span id="l1.2862" class="difflineminus">-  // this needs to happen after we remove all the keys, since RowCountChanged() will call our GetRowCount()</span>
<a href="#l1.2863"></a><span id="l1.2863" class="difflineplus">+  // This needs to happen after we remove all the keys, since RowCountChanged()</span>
<a href="#l1.2864"></a><span id="l1.2864" class="difflineplus">+  // will call our GetRowCount().</span>
<a href="#l1.2865"></a><span id="l1.2865">   if (mTree)</span>
<a href="#l1.2866"></a><span id="l1.2866">     mTree-&gt;RowCountChanged(0, -oldSize);</span>
<a href="#l1.2867"></a><span id="l1.2867"> </span>
<a href="#l1.2868"></a><span id="l1.2868">   ClearHdrCache();</span>
<a href="#l1.2869"></a><span id="l1.2869">   if (m_db)</span>
<a href="#l1.2870"></a><span id="l1.2870">   {</span>
<a href="#l1.2871"></a><span id="l1.2871">     m_db-&gt;RemoveListener(this);</span>
<a href="#l1.2872"></a><span id="l1.2872">     m_db = nullptr;</span>
<a href="#l1.2873"></a><span id="l1.2873">   }</span>
<a href="#l1.2874"></a><span id="l1.2874">   if (m_folder)</span>
<a href="#l1.2875"></a><span id="l1.2875">   {</span>
<a href="#l1.2876"></a><span id="l1.2876">     nsresult rv;</span>
<a href="#l1.2877"></a><span id="l1.2877">     nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.2878"></a><span id="l1.2878">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.2879"></a><span id="l1.2879">     msgDBService-&gt;UnregisterPendingListener(this);</span>
<a href="#l1.2880"></a><span id="l1.2880">   }</span>
<a href="#l1.2881"></a><span id="l1.2881" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.2882"></a><span id="l1.2882" class="difflineminus">-}</span>
<a href="#l1.2883"></a><span id="l1.2883" class="difflineminus">-</span>
<a href="#l1.2884"></a><span id="l1.2884" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::OpenWithHdrs(nsISimpleEnumerator *aHeaders, nsMsgViewSortTypeValue aSortType,</span>
<a href="#l1.2885"></a><span id="l1.2885" class="difflineminus">-                                        nsMsgViewSortOrderValue aSortOrder, nsMsgViewFlagsTypeValue aViewFlags,</span>
<a href="#l1.2886"></a><span id="l1.2886" class="difflineminus">-                                        int32_t *aCount)</span>
<a href="#l1.2887"></a><span id="l1.2887" class="difflineplus">+</span>
<a href="#l1.2888"></a><span id="l1.2888" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.2889"></a><span id="l1.2889" class="difflineplus">+}</span>
<a href="#l1.2890"></a><span id="l1.2890" class="difflineplus">+</span>
<a href="#l1.2891"></a><span id="l1.2891" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2892"></a><span id="l1.2892" class="difflineplus">+nsMsgDBView::OpenWithHdrs(nsISimpleEnumerator *aHeaders,</span>
<a href="#l1.2893"></a><span id="l1.2893" class="difflineplus">+                          nsMsgViewSortTypeValue aSortType,</span>
<a href="#l1.2894"></a><span id="l1.2894" class="difflineplus">+                          nsMsgViewSortOrderValue aSortOrder,</span>
<a href="#l1.2895"></a><span id="l1.2895" class="difflineplus">+                          nsMsgViewFlagsTypeValue aViewFlags,</span>
<a href="#l1.2896"></a><span id="l1.2896" class="difflineplus">+                          int32_t *aCount)</span>
<a href="#l1.2897"></a><span id="l1.2897"> {</span>
<a href="#l1.2898"></a><span id="l1.2898">   NS_ASSERTION(false, &quot;not implemented&quot;);</span>
<a href="#l1.2899"></a><span id="l1.2899">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.2900"></a><span id="l1.2900"> }</span>
<a href="#l1.2901"></a><span id="l1.2901"> </span>
<a href="#l1.2902"></a><span id="l1.2902" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::Init(nsIMessenger * aMessengerInstance, nsIMsgWindow * aMsgWindow, nsIMsgDBViewCommandUpdater *aCmdUpdater)</span>
<a href="#l1.2903"></a><span id="l1.2903" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2904"></a><span id="l1.2904" class="difflineplus">+nsMsgDBView::Init(nsIMessenger * aMessengerInstance,</span>
<a href="#l1.2905"></a><span id="l1.2905" class="difflineplus">+                  nsIMsgWindow * aMsgWindow,</span>
<a href="#l1.2906"></a><span id="l1.2906" class="difflineplus">+                  nsIMsgDBViewCommandUpdater *aCmdUpdater)</span>
<a href="#l1.2907"></a><span id="l1.2907"> {</span>
<a href="#l1.2908"></a><span id="l1.2908">   mMessengerWeak = do_GetWeakReference(aMessengerInstance);</span>
<a href="#l1.2909"></a><span id="l1.2909">   mMsgWindowWeak = do_GetWeakReference(aMsgWindow);</span>
<a href="#l1.2910"></a><span id="l1.2910">   mCommandUpdater = aCmdUpdater;</span>
<a href="#l1.2911"></a><span id="l1.2911">   return NS_OK;</span>
<a href="#l1.2912"></a><span id="l1.2912"> }</span>
<a href="#l1.2913"></a><span id="l1.2913"> </span>
<a href="#l1.2914"></a><span id="l1.2914" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::SetSuppressCommandUpdating(bool aSuppressCommandUpdating)</span>
<a href="#l1.2915"></a><span id="l1.2915" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2916"></a><span id="l1.2916" class="difflineplus">+nsMsgDBView::SetSuppressCommandUpdating(bool aSuppressCommandUpdating)</span>
<a href="#l1.2917"></a><span id="l1.2917"> {</span>
<a href="#l1.2918"></a><span id="l1.2918">   mSuppressCommandUpdating = aSuppressCommandUpdating;</span>
<a href="#l1.2919"></a><span id="l1.2919">   return NS_OK;</span>
<a href="#l1.2920"></a><span id="l1.2920"> }</span>
<a href="#l1.2921"></a><span id="l1.2921"> </span>
<a href="#l1.2922"></a><span id="l1.2922" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetSuppressCommandUpdating(bool * aSuppressCommandUpdating)</span>
<a href="#l1.2923"></a><span id="l1.2923" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2924"></a><span id="l1.2924" class="difflineplus">+nsMsgDBView::GetSuppressCommandUpdating(bool * aSuppressCommandUpdating)</span>
<a href="#l1.2925"></a><span id="l1.2925"> {</span>
<a href="#l1.2926"></a><span id="l1.2926">   *aSuppressCommandUpdating = mSuppressCommandUpdating;</span>
<a href="#l1.2927"></a><span id="l1.2927">   return NS_OK;</span>
<a href="#l1.2928"></a><span id="l1.2928"> }</span>
<a href="#l1.2929"></a><span id="l1.2929"> </span>
<a href="#l1.2930"></a><span id="l1.2930" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::SetSuppressMsgDisplay(bool aSuppressDisplay)</span>
<a href="#l1.2931"></a><span id="l1.2931" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2932"></a><span id="l1.2932" class="difflineplus">+nsMsgDBView::SetSuppressMsgDisplay(bool aSuppressDisplay)</span>
<a href="#l1.2933"></a><span id="l1.2933"> {</span>
<a href="#l1.2934"></a><span id="l1.2934">   uint32_t numSelected = 0;</span>
<a href="#l1.2935"></a><span id="l1.2935">   GetNumSelected(&amp;numSelected);</span>
<a href="#l1.2936"></a><span id="l1.2936"> </span>
<a href="#l1.2937"></a><span id="l1.2937">   bool forceDisplay = false;</span>
<a href="#l1.2938"></a><span id="l1.2938">   if (mSuppressMsgDisplay &amp;&amp; !aSuppressDisplay &amp;&amp; numSelected == 1)</span>
<a href="#l1.2939"></a><span id="l1.2939">     forceDisplay = true;</span>
<a href="#l1.2940"></a><span id="l1.2940"> </span>
<a href="#l1.2941"></a><span id="l1.2941">   mSuppressMsgDisplay = aSuppressDisplay;</span>
<a href="#l1.2942"></a><span id="l1.2942">   if (forceDisplay)</span>
<a href="#l1.2943"></a><span id="l1.2943">   {</span>
<a href="#l1.2944"></a><span id="l1.2944" class="difflineminus">-    // get the view indexfor the currently selected message</span>
<a href="#l1.2945"></a><span id="l1.2945" class="difflineplus">+    // Get the view indexfor the currently selected message.</span>
<a href="#l1.2946"></a><span id="l1.2946">     nsMsgViewIndex viewIndex;</span>
<a href="#l1.2947"></a><span id="l1.2947">     nsresult rv = GetViewIndexForFirstSelectedMsg(&amp;viewIndex);</span>
<a href="#l1.2948"></a><span id="l1.2948">     if (NS_SUCCEEDED(rv) &amp;&amp; viewIndex != nsMsgViewIndex_None)</span>
<a href="#l1.2949"></a><span id="l1.2949" class="difflineminus">-       LoadMessageByViewIndex(viewIndex);</span>
<a href="#l1.2950"></a><span id="l1.2950" class="difflineminus">-  }</span>
<a href="#l1.2951"></a><span id="l1.2951" class="difflineminus">-</span>
<a href="#l1.2952"></a><span id="l1.2952" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.2953"></a><span id="l1.2953" class="difflineminus">-}</span>
<a href="#l1.2954"></a><span id="l1.2954" class="difflineminus">-</span>
<a href="#l1.2955"></a><span id="l1.2955" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetSuppressMsgDisplay(bool * aSuppressDisplay)</span>
<a href="#l1.2956"></a><span id="l1.2956" class="difflineplus">+      LoadMessageByViewIndex(viewIndex);</span>
<a href="#l1.2957"></a><span id="l1.2957" class="difflineplus">+  }</span>
<a href="#l1.2958"></a><span id="l1.2958" class="difflineplus">+</span>
<a href="#l1.2959"></a><span id="l1.2959" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.2960"></a><span id="l1.2960" class="difflineplus">+}</span>
<a href="#l1.2961"></a><span id="l1.2961" class="difflineplus">+</span>
<a href="#l1.2962"></a><span id="l1.2962" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2963"></a><span id="l1.2963" class="difflineplus">+nsMsgDBView::GetSuppressMsgDisplay(bool * aSuppressDisplay)</span>
<a href="#l1.2964"></a><span id="l1.2964"> {</span>
<a href="#l1.2965"></a><span id="l1.2965">   *aSuppressDisplay = mSuppressMsgDisplay;</span>
<a href="#l1.2966"></a><span id="l1.2966">   return NS_OK;</span>
<a href="#l1.2967"></a><span id="l1.2967"> }</span>
<a href="#l1.2968"></a><span id="l1.2968"> </span>
<a href="#l1.2969"></a><span id="l1.2969" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetUsingLines(bool * aUsingLines)</span>
<a href="#l1.2970"></a><span id="l1.2970" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2971"></a><span id="l1.2971" class="difflineplus">+nsMsgDBView::GetUsingLines(bool * aUsingLines)</span>
<a href="#l1.2972"></a><span id="l1.2972"> {</span>
<a href="#l1.2973"></a><span id="l1.2973">   *aUsingLines = mShowSizeInLines;</span>
<a href="#l1.2974"></a><span id="l1.2974">   return NS_OK;</span>
<a href="#l1.2975"></a><span id="l1.2975"> }</span>
<a href="#l1.2976"></a><span id="l1.2976"> </span>
<a href="#l1.2977"></a><span id="l1.2977" class="difflineminus">-int CompareViewIndices (const void *v1, const void *v2, void *)</span>
<a href="#l1.2978"></a><span id="l1.2978" class="difflineplus">+int</span>
<a href="#l1.2979"></a><span id="l1.2979" class="difflineplus">+CompareViewIndices (const void *v1,</span>
<a href="#l1.2980"></a><span id="l1.2980" class="difflineplus">+                    const void *v2,</span>
<a href="#l1.2981"></a><span id="l1.2981" class="difflineplus">+                    void *)</span>
<a href="#l1.2982"></a><span id="l1.2982"> {</span>
<a href="#l1.2983"></a><span id="l1.2983">   nsMsgViewIndex i1 = *(nsMsgViewIndex*) v1;</span>
<a href="#l1.2984"></a><span id="l1.2984">   nsMsgViewIndex i2 = *(nsMsgViewIndex*) v2;</span>
<a href="#l1.2985"></a><span id="l1.2985">   return i1 - i2;</span>
<a href="#l1.2986"></a><span id="l1.2986"> }</span>
<a href="#l1.2987"></a><span id="l1.2987"> </span>
<a href="#l1.2988"></a><span id="l1.2988" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetIndicesForSelection(uint32_t *length, nsMsgViewIndex **indices)</span>
<a href="#l1.2989"></a><span id="l1.2989" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2990"></a><span id="l1.2990" class="difflineplus">+nsMsgDBView::GetIndicesForSelection(uint32_t *length,</span>
<a href="#l1.2991"></a><span id="l1.2991" class="difflineplus">+                                    nsMsgViewIndex **indices)</span>
<a href="#l1.2992"></a><span id="l1.2992"> {</span>
<a href="#l1.2993"></a><span id="l1.2993">   NS_ENSURE_ARG_POINTER(length);</span>
<a href="#l1.2994"></a><span id="l1.2994">   *length = 0;</span>
<a href="#l1.2995"></a><span id="l1.2995">   NS_ENSURE_ARG_POINTER(indices);</span>
<a href="#l1.2996"></a><span id="l1.2996">   *indices = nullptr;</span>
<a href="#l1.2997"></a><span id="l1.2997"> </span>
<a href="#l1.2998"></a><span id="l1.2998">   nsMsgViewIndexArray selection;</span>
<a href="#l1.2999"></a><span id="l1.2999">   GetSelectedIndices(selection);</span>
<a href="#l1.3000"></a><span id="l1.3000">   uint32_t numIndices = selection.Length();</span>
<a href="#l1.3001"></a><span id="l1.3001" class="difflineminus">-  if (!numIndices) return NS_OK;</span>
<a href="#l1.3002"></a><span id="l1.3002" class="difflineplus">+  if (!numIndices)</span>
<a href="#l1.3003"></a><span id="l1.3003" class="difflineplus">+    return NS_OK;</span>
<a href="#l1.3004"></a><span id="l1.3004" class="difflineplus">+</span>
<a href="#l1.3005"></a><span id="l1.3005">   *length = numIndices;</span>
<a href="#l1.3006"></a><span id="l1.3006" class="difflineminus">-</span>
<a href="#l1.3007"></a><span id="l1.3007">   uint32_t datalen = numIndices * sizeof(nsMsgViewIndex);</span>
<a href="#l1.3008"></a><span id="l1.3008">   *indices = (nsMsgViewIndex *)NS_Alloc(datalen);</span>
<a href="#l1.3009"></a><span id="l1.3009" class="difflineminus">-  if (!*indices) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.3010"></a><span id="l1.3010" class="difflineplus">+  if (!*indices)</span>
<a href="#l1.3011"></a><span id="l1.3011" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.3012"></a><span id="l1.3012" class="difflineplus">+</span>
<a href="#l1.3013"></a><span id="l1.3013">   memcpy(*indices, selection.Elements(), datalen);</span>
<a href="#l1.3014"></a><span id="l1.3014">   return NS_OK;</span>
<a href="#l1.3015"></a><span id="l1.3015"> }</span>
<a href="#l1.3016"></a><span id="l1.3016"> </span>
<a href="#l1.3017"></a><span id="l1.3017" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetSelectedMsgHdrs(uint32_t *aLength, nsIMsgDBHdr ***aResult)</span>
<a href="#l1.3018"></a><span id="l1.3018" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.3019"></a><span id="l1.3019" class="difflineplus">+nsMsgDBView::GetSelectedMsgHdrs(uint32_t *aLength,</span>
<a href="#l1.3020"></a><span id="l1.3020" class="difflineplus">+                                nsIMsgDBHdr ***aResult)</span>
<a href="#l1.3021"></a><span id="l1.3021"> {</span>
<a href="#l1.3022"></a><span id="l1.3022">   nsresult rv;</span>
<a href="#l1.3023"></a><span id="l1.3023"> </span>
<a href="#l1.3024"></a><span id="l1.3024">   NS_ENSURE_ARG_POINTER(aLength);</span>
<a href="#l1.3025"></a><span id="l1.3025">   *aLength = 0;</span>
<a href="#l1.3026"></a><span id="l1.3026"> </span>
<a href="#l1.3027"></a><span id="l1.3027">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l1.3028"></a><span id="l1.3028">   *aResult = nullptr;</span>
<a href="#l1.3029"></a><span id="l1.3029"> </span>
<a href="#l1.3030"></a><span id="l1.3030">   nsMsgViewIndexArray selection;</span>
<a href="#l1.3031"></a><span id="l1.3031">   GetSelectedIndices(selection);</span>
<a href="#l1.3032"></a><span id="l1.3032">   uint32_t numIndices = selection.Length();</span>
<a href="#l1.3033"></a><span id="l1.3033" class="difflineminus">-  if (!numIndices) return NS_OK;</span>
<a href="#l1.3034"></a><span id="l1.3034" class="difflineplus">+  if (!numIndices)</span>
<a href="#l1.3035"></a><span id="l1.3035" class="difflineplus">+    return NS_OK;</span>
<a href="#l1.3036"></a><span id="l1.3036"> </span>
<a href="#l1.3037"></a><span id="l1.3037">   nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.3038"></a><span id="l1.3038">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3039"></a><span id="l1.3039">   rv = GetHeadersFromSelection(selection.Elements(), numIndices, messages);</span>
<a href="#l1.3040"></a><span id="l1.3040">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3041"></a><span id="l1.3041">   uint32_t numMsgsSelected;</span>
<a href="#l1.3042"></a><span id="l1.3042">   messages-&gt;GetLength(&amp;numMsgsSelected);</span>
<a href="#l1.3043"></a><span id="l1.3043"> </span>
<a href="#l1.3044"></a><span id="l1.3044" class="difflineminus">-  nsIMsgDBHdr **headers = static_cast&lt;nsIMsgDBHdr**&gt;(NS_Alloc(</span>
<a href="#l1.3045"></a><span id="l1.3045" class="difflineminus">-    sizeof(nsIMsgDBHdr*) * numMsgsSelected));</span>
<a href="#l1.3046"></a><span id="l1.3046" class="difflineplus">+  nsIMsgDBHdr **headers =</span>
<a href="#l1.3047"></a><span id="l1.3047" class="difflineplus">+    static_cast&lt;nsIMsgDBHdr**&gt;(NS_Alloc(sizeof(nsIMsgDBHdr*) * numMsgsSelected));</span>
<a href="#l1.3048"></a><span id="l1.3048" class="difflineplus">+</span>
<a href="#l1.3049"></a><span id="l1.3049">   for (uint32_t i = 0; i &lt; numMsgsSelected; i++)</span>
<a href="#l1.3050"></a><span id="l1.3050">   {</span>
<a href="#l1.3051"></a><span id="l1.3051">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l1.3052"></a><span id="l1.3052">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3053"></a><span id="l1.3053" class="difflineminus">-    msgHdr.forget(&amp;headers[i]); // Already AddRefed</span>
<a href="#l1.3054"></a><span id="l1.3054" class="difflineplus">+    // Already AddRefed.</span>
<a href="#l1.3055"></a><span id="l1.3055" class="difflineplus">+    msgHdr.forget(&amp;headers[i]);</span>
<a href="#l1.3056"></a><span id="l1.3056">   }</span>
<a href="#l1.3057"></a><span id="l1.3057"> </span>
<a href="#l1.3058"></a><span id="l1.3058">   *aLength = numMsgsSelected;</span>
<a href="#l1.3059"></a><span id="l1.3059">   *aResult = headers;</span>
<a href="#l1.3060"></a><span id="l1.3060">   return NS_OK;</span>
<a href="#l1.3061"></a><span id="l1.3061"> }</span>
<a href="#l1.3062"></a><span id="l1.3062"> </span>
<a href="#l1.3063"></a><span id="l1.3063" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetMsgHdrsForSelection(nsIMutableArray **aResult)</span>
<a href="#l1.3064"></a><span id="l1.3064" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.3065"></a><span id="l1.3065" class="difflineplus">+nsMsgDBView::GetMsgHdrsForSelection(nsIMutableArray **aResult)</span>
<a href="#l1.3066"></a><span id="l1.3066"> {</span>
<a href="#l1.3067"></a><span id="l1.3067">   nsMsgViewIndexArray selection;</span>
<a href="#l1.3068"></a><span id="l1.3068">   GetSelectedIndices(selection);</span>
<a href="#l1.3069"></a><span id="l1.3069">   uint32_t numIndices = selection.Length();</span>
<a href="#l1.3070"></a><span id="l1.3070"> </span>
<a href="#l1.3071"></a><span id="l1.3071">   nsresult rv;</span>
<a href="#l1.3072"></a><span id="l1.3072">   nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.3073"></a><span id="l1.3073">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3074"></a><span id="l1.3074">   rv = GetHeadersFromSelection(selection.Elements(), numIndices, messages);</span>
<a href="#l1.3075"></a><span id="l1.3075">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3076"></a><span id="l1.3076">   messages.forget(aResult);</span>
<a href="#l1.3077"></a><span id="l1.3077">   return rv;</span>
<a href="#l1.3078"></a><span id="l1.3078"> }</span>
<a href="#l1.3079"></a><span id="l1.3079"> </span>
<a href="#l1.3080"></a><span id="l1.3080" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetURIsForSelection(uint32_t *length, char ***uris)</span>
<a href="#l1.3081"></a><span id="l1.3081" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.3082"></a><span id="l1.3082" class="difflineplus">+nsMsgDBView::GetURIsForSelection(uint32_t *length,</span>
<a href="#l1.3083"></a><span id="l1.3083" class="difflineplus">+                                 char ***uris)</span>
<a href="#l1.3084"></a><span id="l1.3084"> {</span>
<a href="#l1.3085"></a><span id="l1.3085">   nsresult rv = NS_OK;</span>
<a href="#l1.3086"></a><span id="l1.3086"> </span>
<a href="#l1.3087"></a><span id="l1.3087">   NS_ENSURE_ARG_POINTER(length);</span>
<a href="#l1.3088"></a><span id="l1.3088">   *length = 0;</span>
<a href="#l1.3089"></a><span id="l1.3089"> </span>
<a href="#l1.3090"></a><span id="l1.3090">   NS_ENSURE_ARG_POINTER(uris);</span>
<a href="#l1.3091"></a><span id="l1.3091">   *uris = nullptr;</span>
<a href="#l1.3092"></a><span id="l1.3092"> </span>
<a href="#l1.3093"></a><span id="l1.3093">   nsMsgViewIndexArray selection;</span>
<a href="#l1.3094"></a><span id="l1.3094">   GetSelectedIndices(selection);</span>
<a href="#l1.3095"></a><span id="l1.3095">   uint32_t numIndices = selection.Length();</span>
<a href="#l1.3096"></a><span id="l1.3096" class="difflineminus">-  if (!numIndices) return NS_OK;</span>
<a href="#l1.3097"></a><span id="l1.3097" class="difflineplus">+  if (!numIndices)</span>
<a href="#l1.3098"></a><span id="l1.3098" class="difflineplus">+    return NS_OK;</span>
<a href="#l1.3099"></a><span id="l1.3099"> </span>
<a href="#l1.3100"></a><span id="l1.3100">   nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.3101"></a><span id="l1.3101">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3102"></a><span id="l1.3102">   rv = GetHeadersFromSelection(selection.Elements(), numIndices, messages);</span>
<a href="#l1.3103"></a><span id="l1.3103">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3104"></a><span id="l1.3104">   messages-&gt;GetLength(length);</span>
<a href="#l1.3105"></a><span id="l1.3105">   uint32_t numMsgsSelected = *length;</span>
<a href="#l1.3106"></a><span id="l1.3106"> </span>
<a href="#l1.3107"></a><span id="l1.3107">   char **outArray, **next;</span>
<a href="#l1.3108"></a><span id="l1.3108">   next = outArray = (char **)moz_xmalloc(numMsgsSelected * sizeof(char *));</span>
<a href="#l1.3109"></a><span id="l1.3109" class="difflineminus">-  if (!outArray) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.3110"></a><span id="l1.3110" class="difflineplus">+  if (!outArray)</span>
<a href="#l1.3111"></a><span id="l1.3111" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.3112"></a><span id="l1.3112" class="difflineplus">+</span>
<a href="#l1.3113"></a><span id="l1.3113">   for (uint32_t i = 0; i &lt; numMsgsSelected; i++)</span>
<a href="#l1.3114"></a><span id="l1.3114">   {</span>
<a href="#l1.3115"></a><span id="l1.3115">     nsCString tmpUri;</span>
<a href="#l1.3116"></a><span id="l1.3116">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l1.3117"></a><span id="l1.3117">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3118"></a><span id="l1.3118">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.3119"></a><span id="l1.3119">     nsMsgKey msgKey;</span>
<a href="#l1.3120"></a><span id="l1.3120">     msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.3121"></a><span id="l1.3121" class="difflineat">@@ -2529,350 +2804,409 @@ NS_IMETHODIMP nsMsgDBView::GetURIsForSel</span>
<a href="#l1.3122"></a><span id="l1.3122"> </span>
<a href="#l1.3123"></a><span id="l1.3123">     next++;</span>
<a href="#l1.3124"></a><span id="l1.3124">   }</span>
<a href="#l1.3125"></a><span id="l1.3125"> </span>
<a href="#l1.3126"></a><span id="l1.3126">   *uris = outArray;</span>
<a href="#l1.3127"></a><span id="l1.3127">   return NS_OK;</span>
<a href="#l1.3128"></a><span id="l1.3128"> }</span>
<a href="#l1.3129"></a><span id="l1.3129"> </span>
<a href="#l1.3130"></a><span id="l1.3130" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetURIForViewIndex(nsMsgViewIndex index, nsACString &amp;result)</span>
<a href="#l1.3131"></a><span id="l1.3131" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.3132"></a><span id="l1.3132" class="difflineplus">+nsMsgDBView::GetURIForViewIndex(nsMsgViewIndex index,</span>
<a href="#l1.3133"></a><span id="l1.3133" class="difflineplus">+                                nsACString &amp;result)</span>
<a href="#l1.3134"></a><span id="l1.3134"> {</span>
<a href="#l1.3135"></a><span id="l1.3135">   nsresult rv;</span>
<a href="#l1.3136"></a><span id="l1.3136">   nsCOMPtr &lt;nsIMsgFolder&gt; folder = m_folder;</span>
<a href="#l1.3137"></a><span id="l1.3137">   if (!folder)</span>
<a href="#l1.3138"></a><span id="l1.3138">   {</span>
<a href="#l1.3139"></a><span id="l1.3139">     rv = GetFolderForViewIndex(index, getter_AddRefs(folder));</span>
<a href="#l1.3140"></a><span id="l1.3140">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.3141"></a><span id="l1.3141">   }</span>
<a href="#l1.3142"></a><span id="l1.3142" class="difflineminus">-  if (index == nsMsgViewIndex_None || index &gt;= m_flags.Length() ||</span>
<a href="#l1.3143"></a><span id="l1.3143" class="difflineplus">+</span>
<a href="#l1.3144"></a><span id="l1.3144" class="difflineplus">+  if (index == nsMsgViewIndex_None ||</span>
<a href="#l1.3145"></a><span id="l1.3145" class="difflineplus">+      index &gt;= m_flags.Length() ||</span>
<a href="#l1.3146"></a><span id="l1.3146">       m_flags[index] &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l1.3147"></a><span id="l1.3147" class="difflineplus">+  {</span>
<a href="#l1.3148"></a><span id="l1.3148">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.3149"></a><span id="l1.3149" class="difflineplus">+  }</span>
<a href="#l1.3150"></a><span id="l1.3150" class="difflineplus">+</span>
<a href="#l1.3151"></a><span id="l1.3151">   return GenerateURIForMsgKey(m_keys[index], folder, result);</span>
<a href="#l1.3152"></a><span id="l1.3152"> }</span>
<a href="#l1.3153"></a><span id="l1.3153"> </span>
<a href="#l1.3154"></a><span id="l1.3154" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::DoCommandWithFolder(nsMsgViewCommandTypeValue command, nsIMsgFolder *destFolder)</span>
<a href="#l1.3155"></a><span id="l1.3155" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.3156"></a><span id="l1.3156" class="difflineplus">+nsMsgDBView::DoCommandWithFolder(nsMsgViewCommandTypeValue command,</span>
<a href="#l1.3157"></a><span id="l1.3157" class="difflineplus">+                                 nsIMsgFolder *destFolder)</span>
<a href="#l1.3158"></a><span id="l1.3158"> {</span>
<a href="#l1.3159"></a><span id="l1.3159">   NS_ENSURE_ARG_POINTER(destFolder);</span>
<a href="#l1.3160"></a><span id="l1.3160"> </span>
<a href="#l1.3161"></a><span id="l1.3161">   nsMsgViewIndexArray selection;</span>
<a href="#l1.3162"></a><span id="l1.3162"> </span>
<a href="#l1.3163"></a><span id="l1.3163">   GetSelectedIndices(selection);</span>
<a href="#l1.3164"></a><span id="l1.3164"> </span>
<a href="#l1.3165"></a><span id="l1.3165">   nsMsgViewIndex *indices = selection.Elements();</span>
<a href="#l1.3166"></a><span id="l1.3166">   int32_t numIndices = selection.Length();</span>
<a href="#l1.3167"></a><span id="l1.3167"> </span>
<a href="#l1.3168"></a><span id="l1.3168">   nsresult rv = NS_OK;</span>
<a href="#l1.3169"></a><span id="l1.3169" class="difflineminus">-  switch (command) {</span>
<a href="#l1.3170"></a><span id="l1.3170" class="difflineplus">+  switch (command)</span>
<a href="#l1.3171"></a><span id="l1.3171" class="difflineplus">+  {</span>
<a href="#l1.3172"></a><span id="l1.3172">     case nsMsgViewCommandType::copyMessages:</span>
<a href="#l1.3173"></a><span id="l1.3173">     case nsMsgViewCommandType::moveMessages:</span>
<a href="#l1.3174"></a><span id="l1.3174" class="difflineminus">-        NoteStartChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.3175"></a><span id="l1.3175" class="difflineminus">-        rv = ApplyCommandToIndicesWithFolder(command, indices, numIndices, destFolder);</span>
<a href="#l1.3176"></a><span id="l1.3176" class="difflineminus">-        NoteEndChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.3177"></a><span id="l1.3177" class="difflineminus">-        break;</span>
<a href="#l1.3178"></a><span id="l1.3178" class="difflineplus">+      NoteStartChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.3179"></a><span id="l1.3179" class="difflineplus">+      rv = ApplyCommandToIndicesWithFolder(command, indices, numIndices, destFolder);</span>
<a href="#l1.3180"></a><span id="l1.3180" class="difflineplus">+      NoteEndChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.3181"></a><span id="l1.3181" class="difflineplus">+      break;</span>
<a href="#l1.3182"></a><span id="l1.3182">     default:</span>
<a href="#l1.3183"></a><span id="l1.3183" class="difflineminus">-        NS_ASSERTION(false, &quot;invalid command type&quot;);</span>
<a href="#l1.3184"></a><span id="l1.3184" class="difflineminus">-        rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.3185"></a><span id="l1.3185" class="difflineminus">-        break;</span>
<a href="#l1.3186"></a><span id="l1.3186" class="difflineminus">-  }</span>
<a href="#l1.3187"></a><span id="l1.3187" class="difflineplus">+      NS_ASSERTION(false, &quot;invalid command type&quot;);</span>
<a href="#l1.3188"></a><span id="l1.3188" class="difflineplus">+      rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.3189"></a><span id="l1.3189" class="difflineplus">+      break;</span>
<a href="#l1.3190"></a><span id="l1.3190" class="difflineplus">+  }</span>
<a href="#l1.3191"></a><span id="l1.3191" class="difflineplus">+</span>
<a href="#l1.3192"></a><span id="l1.3192">   return rv;</span>
<a href="#l1.3193"></a><span id="l1.3193" class="difflineminus">-</span>
<a href="#l1.3194"></a><span id="l1.3194" class="difflineminus">-}</span>
<a href="#l1.3195"></a><span id="l1.3195" class="difflineminus">-</span>
<a href="#l1.3196"></a><span id="l1.3196" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::DoCommand(nsMsgViewCommandTypeValue command)</span>
<a href="#l1.3197"></a><span id="l1.3197" class="difflineplus">+}</span>
<a href="#l1.3198"></a><span id="l1.3198" class="difflineplus">+</span>
<a href="#l1.3199"></a><span id="l1.3199" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.3200"></a><span id="l1.3200" class="difflineplus">+nsMsgDBView::DoCommand(nsMsgViewCommandTypeValue command)</span>
<a href="#l1.3201"></a><span id="l1.3201"> {</span>
<a href="#l1.3202"></a><span id="l1.3202">   nsMsgViewIndexArray selection;</span>
<a href="#l1.3203"></a><span id="l1.3203"> </span>
<a href="#l1.3204"></a><span id="l1.3204">   GetSelectedIndices(selection);</span>
<a href="#l1.3205"></a><span id="l1.3205"> </span>
<a href="#l1.3206"></a><span id="l1.3206">   nsMsgViewIndex *indices = selection.Elements();</span>
<a href="#l1.3207"></a><span id="l1.3207">   int32_t numIndices = selection.Length();</span>
<a href="#l1.3208"></a><span id="l1.3208">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l1.3209"></a><span id="l1.3209"> </span>
<a href="#l1.3210"></a><span id="l1.3210">   nsresult rv = NS_OK;</span>
<a href="#l1.3211"></a><span id="l1.3211">   switch (command)</span>
<a href="#l1.3212"></a><span id="l1.3212">   {</span>
<a href="#l1.3213"></a><span id="l1.3213" class="difflineminus">-  case nsMsgViewCommandType::downloadSelectedForOffline:</span>
<a href="#l1.3214"></a><span id="l1.3214" class="difflineminus">-    return DownloadForOffline(msgWindow, indices, numIndices);</span>
<a href="#l1.3215"></a><span id="l1.3215" class="difflineminus">-  case nsMsgViewCommandType::downloadFlaggedForOffline:</span>
<a href="#l1.3216"></a><span id="l1.3216" class="difflineminus">-    return DownloadFlaggedForOffline(msgWindow);</span>
<a href="#l1.3217"></a><span id="l1.3217" class="difflineminus">-  case nsMsgViewCommandType::markMessagesRead:</span>
<a href="#l1.3218"></a><span id="l1.3218" class="difflineminus">-  case nsMsgViewCommandType::markMessagesUnread:</span>
<a href="#l1.3219"></a><span id="l1.3219" class="difflineminus">-  case nsMsgViewCommandType::toggleMessageRead:</span>
<a href="#l1.3220"></a><span id="l1.3220" class="difflineminus">-  case nsMsgViewCommandType::flagMessages:</span>
<a href="#l1.3221"></a><span id="l1.3221" class="difflineminus">-  case nsMsgViewCommandType::unflagMessages:</span>
<a href="#l1.3222"></a><span id="l1.3222" class="difflineminus">-  case nsMsgViewCommandType::deleteMsg:</span>
<a href="#l1.3223"></a><span id="l1.3223" class="difflineminus">-  case nsMsgViewCommandType::undeleteMsg:</span>
<a href="#l1.3224"></a><span id="l1.3224" class="difflineminus">-  case nsMsgViewCommandType::deleteNoTrash:</span>
<a href="#l1.3225"></a><span id="l1.3225" class="difflineminus">-  case nsMsgViewCommandType::markThreadRead:</span>
<a href="#l1.3226"></a><span id="l1.3226" class="difflineminus">-  case nsMsgViewCommandType::junk:</span>
<a href="#l1.3227"></a><span id="l1.3227" class="difflineminus">-  case nsMsgViewCommandType::unjunk:</span>
<a href="#l1.3228"></a><span id="l1.3228" class="difflineminus">-    NoteStartChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.3229"></a><span id="l1.3229" class="difflineminus">-    rv = ApplyCommandToIndices(command, indices, numIndices);</span>
<a href="#l1.3230"></a><span id="l1.3230" class="difflineminus">-    NoteEndChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.3231"></a><span id="l1.3231" class="difflineminus">-    break;</span>
<a href="#l1.3232"></a><span id="l1.3232" class="difflineminus">-  case nsMsgViewCommandType::selectAll:</span>
<a href="#l1.3233"></a><span id="l1.3233" class="difflineminus">-    if (mTreeSelection)</span>
<a href="#l1.3234"></a><span id="l1.3234" class="difflineminus">-    {</span>
<a href="#l1.3235"></a><span id="l1.3235" class="difflineminus">-      // if in threaded mode, we need to expand all before selecting</span>
<a href="#l1.3236"></a><span id="l1.3236" class="difflineminus">-      if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.3237"></a><span id="l1.3237" class="difflineplus">+    case nsMsgViewCommandType::downloadSelectedForOffline:</span>
<a href="#l1.3238"></a><span id="l1.3238" class="difflineplus">+      return DownloadForOffline(msgWindow, indices, numIndices);</span>
<a href="#l1.3239"></a><span id="l1.3239" class="difflineplus">+    case nsMsgViewCommandType::downloadFlaggedForOffline:</span>
<a href="#l1.3240"></a><span id="l1.3240" class="difflineplus">+      return DownloadFlaggedForOffline(msgWindow);</span>
<a href="#l1.3241"></a><span id="l1.3241" class="difflineplus">+    case nsMsgViewCommandType::markMessagesRead:</span>
<a href="#l1.3242"></a><span id="l1.3242" class="difflineplus">+    case nsMsgViewCommandType::markMessagesUnread:</span>
<a href="#l1.3243"></a><span id="l1.3243" class="difflineplus">+    case nsMsgViewCommandType::toggleMessageRead:</span>
<a href="#l1.3244"></a><span id="l1.3244" class="difflineplus">+    case nsMsgViewCommandType::flagMessages:</span>
<a href="#l1.3245"></a><span id="l1.3245" class="difflineplus">+    case nsMsgViewCommandType::unflagMessages:</span>
<a href="#l1.3246"></a><span id="l1.3246" class="difflineplus">+    case nsMsgViewCommandType::deleteMsg:</span>
<a href="#l1.3247"></a><span id="l1.3247" class="difflineplus">+    case nsMsgViewCommandType::undeleteMsg:</span>
<a href="#l1.3248"></a><span id="l1.3248" class="difflineplus">+    case nsMsgViewCommandType::deleteNoTrash:</span>
<a href="#l1.3249"></a><span id="l1.3249" class="difflineplus">+    case nsMsgViewCommandType::markThreadRead:</span>
<a href="#l1.3250"></a><span id="l1.3250" class="difflineplus">+    case nsMsgViewCommandType::junk:</span>
<a href="#l1.3251"></a><span id="l1.3251" class="difflineplus">+    case nsMsgViewCommandType::unjunk:</span>
<a href="#l1.3252"></a><span id="l1.3252" class="difflineplus">+      NoteStartChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.3253"></a><span id="l1.3253" class="difflineplus">+      rv = ApplyCommandToIndices(command, indices, numIndices);</span>
<a href="#l1.3254"></a><span id="l1.3254" class="difflineplus">+      NoteEndChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.3255"></a><span id="l1.3255" class="difflineplus">+      break;</span>
<a href="#l1.3256"></a><span id="l1.3256" class="difflineplus">+    case nsMsgViewCommandType::selectAll:</span>
<a href="#l1.3257"></a><span id="l1.3257" class="difflineplus">+      if (mTreeSelection)</span>
<a href="#l1.3258"></a><span id="l1.3258" class="difflineplus">+      {</span>
<a href="#l1.3259"></a><span id="l1.3259" class="difflineplus">+        // If in threaded mode, we need to expand all before selecting.</span>
<a href="#l1.3260"></a><span id="l1.3260" class="difflineplus">+        if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.3261"></a><span id="l1.3261">           rv = ExpandAll();</span>
<a href="#l1.3262"></a><span id="l1.3262" class="difflineminus">-      mTreeSelection-&gt;SelectAll();</span>
<a href="#l1.3263"></a><span id="l1.3263" class="difflineplus">+</span>
<a href="#l1.3264"></a><span id="l1.3264" class="difflineplus">+        mTreeSelection-&gt;SelectAll();</span>
<a href="#l1.3265"></a><span id="l1.3265" class="difflineplus">+        if (mTree)</span>
<a href="#l1.3266"></a><span id="l1.3266" class="difflineplus">+          mTree-&gt;Invalidate();</span>
<a href="#l1.3267"></a><span id="l1.3267" class="difflineplus">+      }</span>
<a href="#l1.3268"></a><span id="l1.3268" class="difflineplus">+      break;</span>
<a href="#l1.3269"></a><span id="l1.3269" class="difflineplus">+    case nsMsgViewCommandType::selectThread:</span>
<a href="#l1.3270"></a><span id="l1.3270" class="difflineplus">+      rv = ExpandAndSelectThread();</span>
<a href="#l1.3271"></a><span id="l1.3271" class="difflineplus">+      break;</span>
<a href="#l1.3272"></a><span id="l1.3272" class="difflineplus">+    case nsMsgViewCommandType::selectFlagged:</span>
<a href="#l1.3273"></a><span id="l1.3273" class="difflineplus">+      if (!mTreeSelection)</span>
<a href="#l1.3274"></a><span id="l1.3274" class="difflineplus">+      {</span>
<a href="#l1.3275"></a><span id="l1.3275" class="difflineplus">+        rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.3276"></a><span id="l1.3276" class="difflineplus">+      }</span>
<a href="#l1.3277"></a><span id="l1.3277" class="difflineplus">+      else</span>
<a href="#l1.3278"></a><span id="l1.3278" class="difflineplus">+      {</span>
<a href="#l1.3279"></a><span id="l1.3279" class="difflineplus">+        mTreeSelection-&gt;SetSelectEventsSuppressed(true);</span>
<a href="#l1.3280"></a><span id="l1.3280" class="difflineplus">+        mTreeSelection-&gt;ClearSelection();</span>
<a href="#l1.3281"></a><span id="l1.3281" class="difflineplus">+        // XXX ExpandAll?</span>
<a href="#l1.3282"></a><span id="l1.3282" class="difflineplus">+        nsMsgViewIndex numIndices = GetSize();</span>
<a href="#l1.3283"></a><span id="l1.3283" class="difflineplus">+        for (nsMsgViewIndex curIndex = 0; curIndex &lt; numIndices; curIndex++)</span>
<a href="#l1.3284"></a><span id="l1.3284" class="difflineplus">+        {</span>
<a href="#l1.3285"></a><span id="l1.3285" class="difflineplus">+          if (m_flags[curIndex] &amp; nsMsgMessageFlags::Marked)</span>
<a href="#l1.3286"></a><span id="l1.3286" class="difflineplus">+            mTreeSelection-&gt;ToggleSelect(curIndex);</span>
<a href="#l1.3287"></a><span id="l1.3287" class="difflineplus">+        }</span>
<a href="#l1.3288"></a><span id="l1.3288" class="difflineplus">+</span>
<a href="#l1.3289"></a><span id="l1.3289" class="difflineplus">+        mTreeSelection-&gt;SetSelectEventsSuppressed(false);</span>
<a href="#l1.3290"></a><span id="l1.3290" class="difflineplus">+      }</span>
<a href="#l1.3291"></a><span id="l1.3291" class="difflineplus">+      break;</span>
<a href="#l1.3292"></a><span id="l1.3292" class="difflineplus">+    case nsMsgViewCommandType::markAllRead:</span>
<a href="#l1.3293"></a><span id="l1.3293" class="difflineplus">+      if (m_folder)</span>
<a href="#l1.3294"></a><span id="l1.3294" class="difflineplus">+      {</span>
<a href="#l1.3295"></a><span id="l1.3295" class="difflineplus">+        SetSuppressChangeNotifications(true);</span>
<a href="#l1.3296"></a><span id="l1.3296" class="difflineplus">+        rv = m_folder-&gt;MarkAllMessagesRead(msgWindow);</span>
<a href="#l1.3297"></a><span id="l1.3297" class="difflineplus">+        SetSuppressChangeNotifications(false);</span>
<a href="#l1.3298"></a><span id="l1.3298" class="difflineplus">+        if (mTree)</span>
<a href="#l1.3299"></a><span id="l1.3299" class="difflineplus">+          mTree-&gt;Invalidate();</span>
<a href="#l1.3300"></a><span id="l1.3300" class="difflineplus">+      }</span>
<a href="#l1.3301"></a><span id="l1.3301" class="difflineplus">+      break;</span>
<a href="#l1.3302"></a><span id="l1.3302" class="difflineplus">+    case nsMsgViewCommandType::toggleThreadWatched:</span>
<a href="#l1.3303"></a><span id="l1.3303" class="difflineplus">+      rv = ToggleWatched(indices,  numIndices);</span>
<a href="#l1.3304"></a><span id="l1.3304" class="difflineplus">+      break;</span>
<a href="#l1.3305"></a><span id="l1.3305" class="difflineplus">+    case nsMsgViewCommandType::expandAll:</span>
<a href="#l1.3306"></a><span id="l1.3306" class="difflineplus">+      rv = ExpandAll();</span>
<a href="#l1.3307"></a><span id="l1.3307" class="difflineplus">+      m_viewFlags |= nsMsgViewFlagsType::kExpandAll;</span>
<a href="#l1.3308"></a><span id="l1.3308" class="difflineplus">+      SetViewFlags(m_viewFlags);</span>
<a href="#l1.3309"></a><span id="l1.3309">       if (mTree)</span>
<a href="#l1.3310"></a><span id="l1.3310">         mTree-&gt;Invalidate();</span>
<a href="#l1.3311"></a><span id="l1.3311" class="difflineminus">-    }</span>
<a href="#l1.3312"></a><span id="l1.3312" class="difflineminus">-    break;</span>
<a href="#l1.3313"></a><span id="l1.3313" class="difflineminus">-  case nsMsgViewCommandType::selectThread:</span>
<a href="#l1.3314"></a><span id="l1.3314" class="difflineminus">-    rv = ExpandAndSelectThread();</span>
<a href="#l1.3315"></a><span id="l1.3315" class="difflineminus">-    break;</span>
<a href="#l1.3316"></a><span id="l1.3316" class="difflineminus">-  case nsMsgViewCommandType::selectFlagged:</span>
<a href="#l1.3317"></a><span id="l1.3317" class="difflineminus">-    if (!mTreeSelection)</span>
<a href="#l1.3318"></a><span id="l1.3318" class="difflineminus">-      rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.3319"></a><span id="l1.3319" class="difflineminus">-    else</span>
<a href="#l1.3320"></a><span id="l1.3320" class="difflineminus">-    {</span>
<a href="#l1.3321"></a><span id="l1.3321" class="difflineminus">-      mTreeSelection-&gt;SetSelectEventsSuppressed(true);</span>
<a href="#l1.3322"></a><span id="l1.3322" class="difflineminus">-      mTreeSelection-&gt;ClearSelection();</span>
<a href="#l1.3323"></a><span id="l1.3323" class="difflineminus">-      // XXX ExpandAll?</span>
<a href="#l1.3324"></a><span id="l1.3324" class="difflineminus">-      nsMsgViewIndex numIndices = GetSize();</span>
<a href="#l1.3325"></a><span id="l1.3325" class="difflineminus">-      for (nsMsgViewIndex curIndex = 0; curIndex &lt; numIndices; curIndex++)</span>
<a href="#l1.3326"></a><span id="l1.3326" class="difflineminus">-      {</span>
<a href="#l1.3327"></a><span id="l1.3327" class="difflineminus">-        if (m_flags[curIndex] &amp; nsMsgMessageFlags::Marked)</span>
<a href="#l1.3328"></a><span id="l1.3328" class="difflineminus">-          mTreeSelection-&gt;ToggleSelect(curIndex);</span>
<a href="#l1.3329"></a><span id="l1.3329" class="difflineminus">-      }</span>
<a href="#l1.3330"></a><span id="l1.3330" class="difflineminus">-      mTreeSelection-&gt;SetSelectEventsSuppressed(false);</span>
<a href="#l1.3331"></a><span id="l1.3331" class="difflineminus">-    }</span>
<a href="#l1.3332"></a><span id="l1.3332" class="difflineminus">-    break;</span>
<a href="#l1.3333"></a><span id="l1.3333" class="difflineminus">-  case nsMsgViewCommandType::markAllRead:</span>
<a href="#l1.3334"></a><span id="l1.3334" class="difflineminus">-    if (m_folder)</span>
<a href="#l1.3335"></a><span id="l1.3335" class="difflineminus">-    {</span>
<a href="#l1.3336"></a><span id="l1.3336" class="difflineminus">-      SetSuppressChangeNotifications(true);</span>
<a href="#l1.3337"></a><span id="l1.3337" class="difflineminus">-      rv = m_folder-&gt;MarkAllMessagesRead(msgWindow);</span>
<a href="#l1.3338"></a><span id="l1.3338" class="difflineminus">-      SetSuppressChangeNotifications(false);</span>
<a href="#l1.3339"></a><span id="l1.3339" class="difflineminus">-      if (mTree)</span>
<a href="#l1.3340"></a><span id="l1.3340" class="difflineplus">+</span>
<a href="#l1.3341"></a><span id="l1.3341" class="difflineplus">+      break;</span>
<a href="#l1.3342"></a><span id="l1.3342" class="difflineplus">+    case nsMsgViewCommandType::collapseAll:</span>
<a href="#l1.3343"></a><span id="l1.3343" class="difflineplus">+      rv = CollapseAll();</span>
<a href="#l1.3344"></a><span id="l1.3344" class="difflineplus">+      m_viewFlags &amp;= ~nsMsgViewFlagsType::kExpandAll;</span>
<a href="#l1.3345"></a><span id="l1.3345" class="difflineplus">+      SetViewFlags(m_viewFlags);</span>
<a href="#l1.3346"></a><span id="l1.3346" class="difflineplus">+      if(mTree)</span>
<a href="#l1.3347"></a><span id="l1.3347">         mTree-&gt;Invalidate();</span>
<a href="#l1.3348"></a><span id="l1.3348" class="difflineminus">-    }</span>
<a href="#l1.3349"></a><span id="l1.3349" class="difflineminus">-    break;</span>
<a href="#l1.3350"></a><span id="l1.3350" class="difflineminus">-  case nsMsgViewCommandType::toggleThreadWatched:</span>
<a href="#l1.3351"></a><span id="l1.3351" class="difflineminus">-    rv = ToggleWatched(indices,  numIndices);</span>
<a href="#l1.3352"></a><span id="l1.3352" class="difflineminus">-    break;</span>
<a href="#l1.3353"></a><span id="l1.3353" class="difflineminus">-  case nsMsgViewCommandType::expandAll:</span>
<a href="#l1.3354"></a><span id="l1.3354" class="difflineminus">-    rv = ExpandAll();</span>
<a href="#l1.3355"></a><span id="l1.3355" class="difflineminus">-    m_viewFlags |= nsMsgViewFlagsType::kExpandAll;</span>
<a href="#l1.3356"></a><span id="l1.3356" class="difflineminus">-    SetViewFlags(m_viewFlags);</span>
<a href="#l1.3357"></a><span id="l1.3357" class="difflineminus">-    if (mTree)</span>
<a href="#l1.3358"></a><span id="l1.3358" class="difflineminus">-      mTree-&gt;Invalidate();</span>
<a href="#l1.3359"></a><span id="l1.3359" class="difflineminus">-    break;</span>
<a href="#l1.3360"></a><span id="l1.3360" class="difflineminus">-  case nsMsgViewCommandType::collapseAll:</span>
<a href="#l1.3361"></a><span id="l1.3361" class="difflineminus">-    rv = CollapseAll();</span>
<a href="#l1.3362"></a><span id="l1.3362" class="difflineminus">-    m_viewFlags &amp;= ~nsMsgViewFlagsType::kExpandAll;</span>
<a href="#l1.3363"></a><span id="l1.3363" class="difflineminus">-    SetViewFlags(m_viewFlags);</span>
<a href="#l1.3364"></a><span id="l1.3364" class="difflineminus">-    if(mTree)</span>
<a href="#l1.3365"></a><span id="l1.3365" class="difflineminus">-      mTree-&gt;Invalidate();</span>
<a href="#l1.3366"></a><span id="l1.3366" class="difflineminus">-    break;</span>
<a href="#l1.3367"></a><span id="l1.3367" class="difflineminus">-  default:</span>
<a href="#l1.3368"></a><span id="l1.3368" class="difflineminus">-    NS_ASSERTION(false, &quot;invalid command type&quot;);</span>
<a href="#l1.3369"></a><span id="l1.3369" class="difflineminus">-    rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.3370"></a><span id="l1.3370" class="difflineminus">-    break;</span>
<a href="#l1.3371"></a><span id="l1.3371" class="difflineminus">-  }</span>
<a href="#l1.3372"></a><span id="l1.3372" class="difflineplus">+</span>
<a href="#l1.3373"></a><span id="l1.3373" class="difflineplus">+      break;</span>
<a href="#l1.3374"></a><span id="l1.3374" class="difflineplus">+    default:</span>
<a href="#l1.3375"></a><span id="l1.3375" class="difflineplus">+      NS_ASSERTION(false, &quot;invalid command type&quot;);</span>
<a href="#l1.3376"></a><span id="l1.3376" class="difflineplus">+      rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.3377"></a><span id="l1.3377" class="difflineplus">+      break;</span>
<a href="#l1.3378"></a><span id="l1.3378" class="difflineplus">+  }</span>
<a href="#l1.3379"></a><span id="l1.3379" class="difflineplus">+</span>
<a href="#l1.3380"></a><span id="l1.3380">   return rv;</span>
<a href="#l1.3381"></a><span id="l1.3381"> }</span>
<a href="#l1.3382"></a><span id="l1.3382"> </span>
<a href="#l1.3383"></a><span id="l1.3383" class="difflineminus">-bool nsMsgDBView::ServerSupportsFilterAfterTheFact()</span>
<a href="#l1.3384"></a><span id="l1.3384" class="difflineminus">-{</span>
<a href="#l1.3385"></a><span id="l1.3385" class="difflineminus">-  if (!m_folder)  // cross folder virtual folders might not have a folder set.</span>
<a href="#l1.3386"></a><span id="l1.3386" class="difflineplus">+bool</span>
<a href="#l1.3387"></a><span id="l1.3387" class="difflineplus">+nsMsgDBView::ServerSupportsFilterAfterTheFact()</span>
<a href="#l1.3388"></a><span id="l1.3388" class="difflineplus">+{</span>
<a href="#l1.3389"></a><span id="l1.3389" class="difflineplus">+  // Cross folder virtual folders might not have a folder set.</span>
<a href="#l1.3390"></a><span id="l1.3390" class="difflineplus">+  if (!m_folder)</span>
<a href="#l1.3391"></a><span id="l1.3391">     return false;</span>
<a href="#l1.3392"></a><span id="l1.3392"> </span>
<a href="#l1.3393"></a><span id="l1.3393">   nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.3394"></a><span id="l1.3394">   nsresult rv = m_folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.3395"></a><span id="l1.3395" class="difflineplus">+  // Unexpected.</span>
<a href="#l1.3396"></a><span id="l1.3396">   if (NS_FAILED(rv))</span>
<a href="#l1.3397"></a><span id="l1.3397" class="difflineminus">-    return false; // unexpected</span>
<a href="#l1.3398"></a><span id="l1.3398" class="difflineminus">-</span>
<a href="#l1.3399"></a><span id="l1.3399" class="difflineminus">-  // filter after the fact is implement using search</span>
<a href="#l1.3400"></a><span id="l1.3400" class="difflineminus">-  // so if you can't search, you can't filter after the fact</span>
<a href="#l1.3401"></a><span id="l1.3401" class="difflineplus">+    return false;</span>
<a href="#l1.3402"></a><span id="l1.3402" class="difflineplus">+</span>
<a href="#l1.3403"></a><span id="l1.3403" class="difflineplus">+  // Filter after the fact is implement using search so if you can't search,</span>
<a href="#l1.3404"></a><span id="l1.3404" class="difflineplus">+  // you can't filter after the fact.</span>
<a href="#l1.3405"></a><span id="l1.3405">   bool canSearch;</span>
<a href="#l1.3406"></a><span id="l1.3406">   rv = server-&gt;GetCanSearchMessages(&amp;canSearch);</span>
<a href="#l1.3407"></a><span id="l1.3407" class="difflineplus">+  // Unexpected.</span>
<a href="#l1.3408"></a><span id="l1.3408">   if (NS_FAILED(rv))</span>
<a href="#l1.3409"></a><span id="l1.3409" class="difflineminus">-    return false; // unexpected</span>
<a href="#l1.3410"></a><span id="l1.3410" class="difflineplus">+    return false;</span>
<a href="#l1.3411"></a><span id="l1.3411"> </span>
<a href="#l1.3412"></a><span id="l1.3412">   return canSearch;</span>
<a href="#l1.3413"></a><span id="l1.3413"> }</span>
<a href="#l1.3414"></a><span id="l1.3414"> </span>
<a href="#l1.3415"></a><span id="l1.3415" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetCommandStatus(nsMsgViewCommandTypeValue command, bool *selectable_p, nsMsgViewCommandCheckStateValue *selected_p)</span>
<a href="#l1.3416"></a><span id="l1.3416" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.3417"></a><span id="l1.3417" class="difflineplus">+nsMsgDBView::GetCommandStatus(nsMsgViewCommandTypeValue command,</span>
<a href="#l1.3418"></a><span id="l1.3418" class="difflineplus">+                              bool *selectable_p,</span>
<a href="#l1.3419"></a><span id="l1.3419" class="difflineplus">+                              nsMsgViewCommandCheckStateValue *selected_p)</span>
<a href="#l1.3420"></a><span id="l1.3420"> {</span>
<a href="#l1.3421"></a><span id="l1.3421">   nsresult rv = NS_OK;</span>
<a href="#l1.3422"></a><span id="l1.3422"> </span>
<a href="#l1.3423"></a><span id="l1.3423">   bool haveSelection;</span>
<a href="#l1.3424"></a><span id="l1.3424">   int32_t rangeCount;</span>
<a href="#l1.3425"></a><span id="l1.3425">   nsMsgViewIndexArray selection;</span>
<a href="#l1.3426"></a><span id="l1.3426">   GetSelectedIndices(selection);</span>
<a href="#l1.3427"></a><span id="l1.3427">   int32_t numIndices = selection.Length();</span>
<a href="#l1.3428"></a><span id="l1.3428">   nsMsgViewIndex *indices = selection.Elements();</span>
<a href="#l1.3429"></a><span id="l1.3429" class="difflineminus">-  // if range count is non-zero, we have at least one item selected, so we have a selection</span>
<a href="#l1.3430"></a><span id="l1.3430" class="difflineminus">-  if (mTreeSelection &amp;&amp; NS_SUCCEEDED(mTreeSelection-&gt;GetRangeCount(&amp;rangeCount)) &amp;&amp; rangeCount &gt; 0)</span>
<a href="#l1.3431"></a><span id="l1.3431" class="difflineplus">+  // If range count is non-zero, we have at least one item selected, so we</span>
<a href="#l1.3432"></a><span id="l1.3432" class="difflineplus">+  // have a selection.</span>
<a href="#l1.3433"></a><span id="l1.3433" class="difflineplus">+  if (mTreeSelection &amp;&amp;</span>
<a href="#l1.3434"></a><span id="l1.3434" class="difflineplus">+      NS_SUCCEEDED(mTreeSelection-&gt;GetRangeCount(&amp;rangeCount)) &amp;&amp;</span>
<a href="#l1.3435"></a><span id="l1.3435" class="difflineplus">+      rangeCount &gt; 0)</span>
<a href="#l1.3436"></a><span id="l1.3436" class="difflineplus">+  {</span>
<a href="#l1.3437"></a><span id="l1.3437">     haveSelection = NonDummyMsgSelected(indices, numIndices);</span>
<a href="#l1.3438"></a><span id="l1.3438" class="difflineplus">+  }</span>
<a href="#l1.3439"></a><span id="l1.3439">   else</span>
<a href="#l1.3440"></a><span id="l1.3440" class="difflineminus">-  // If we don't have a tree selection we must be in stand alone mode.</span>
<a href="#l1.3441"></a><span id="l1.3441" class="difflineplus">+  {</span>
<a href="#l1.3442"></a><span id="l1.3442" class="difflineplus">+    // If we don't have a tree selection we must be in stand alone mode.</span>
<a href="#l1.3443"></a><span id="l1.3443">     haveSelection = IsValidIndex(m_currentlyDisplayedViewIndex);</span>
<a href="#l1.3444"></a><span id="l1.3444" class="difflineplus">+  }</span>
<a href="#l1.3445"></a><span id="l1.3445"> </span>
<a href="#l1.3446"></a><span id="l1.3446">   switch (command)</span>
<a href="#l1.3447"></a><span id="l1.3447">   {</span>
<a href="#l1.3448"></a><span id="l1.3448" class="difflineminus">-  case nsMsgViewCommandType::deleteMsg:</span>
<a href="#l1.3449"></a><span id="l1.3449" class="difflineminus">-  case nsMsgViewCommandType::deleteNoTrash:</span>
<a href="#l1.3450"></a><span id="l1.3450" class="difflineplus">+    case nsMsgViewCommandType::deleteMsg:</span>
<a href="#l1.3451"></a><span id="l1.3451" class="difflineplus">+    case nsMsgViewCommandType::deleteNoTrash:</span>
<a href="#l1.3452"></a><span id="l1.3452">     {</span>
<a href="#l1.3453"></a><span id="l1.3453">       bool canDelete;</span>
<a href="#l1.3454"></a><span id="l1.3454" class="difflineminus">-      if (m_folder &amp;&amp; NS_SUCCEEDED(m_folder-&gt;GetCanDeleteMessages(&amp;canDelete)) &amp;&amp; !canDelete)</span>
<a href="#l1.3455"></a><span id="l1.3455" class="difflineplus">+      if (m_folder &amp;&amp;</span>
<a href="#l1.3456"></a><span id="l1.3456" class="difflineplus">+          NS_SUCCEEDED(m_folder-&gt;GetCanDeleteMessages(&amp;canDelete)) &amp;&amp;</span>
<a href="#l1.3457"></a><span id="l1.3457" class="difflineplus">+          !canDelete)</span>
<a href="#l1.3458"></a><span id="l1.3458" class="difflineplus">+      {</span>
<a href="#l1.3459"></a><span id="l1.3459">         *selectable_p = false;</span>
<a href="#l1.3460"></a><span id="l1.3460" class="difflineplus">+      }</span>
<a href="#l1.3461"></a><span id="l1.3461">       else</span>
<a href="#l1.3462"></a><span id="l1.3462" class="difflineplus">+      {</span>
<a href="#l1.3463"></a><span id="l1.3463">         *selectable_p = haveSelection;</span>
<a href="#l1.3464"></a><span id="l1.3464" class="difflineminus">-    }</span>
<a href="#l1.3465"></a><span id="l1.3465" class="difflineminus">-    break;</span>
<a href="#l1.3466"></a><span id="l1.3466" class="difflineminus">-  case nsMsgViewCommandType::applyFilters:</span>
<a href="#l1.3467"></a><span id="l1.3467" class="difflineminus">-    // disable if no messages</span>
<a href="#l1.3468"></a><span id="l1.3468" class="difflineminus">-    // XXX todo, check that we have filters, and at least one is enabled</span>
<a href="#l1.3469"></a><span id="l1.3469" class="difflineminus">-    *selectable_p = GetSize();</span>
<a href="#l1.3470"></a><span id="l1.3470" class="difflineminus">-    if (*selectable_p)</span>
<a href="#l1.3471"></a><span id="l1.3471" class="difflineminus">-      *selectable_p = ServerSupportsFilterAfterTheFact();</span>
<a href="#l1.3472"></a><span id="l1.3472" class="difflineminus">-    break;</span>
<a href="#l1.3473"></a><span id="l1.3473" class="difflineminus">-  case nsMsgViewCommandType::runJunkControls:</span>
<a href="#l1.3474"></a><span id="l1.3474" class="difflineminus">-    // disable if no messages</span>
<a href="#l1.3475"></a><span id="l1.3475" class="difflineminus">-    // XXX todo, check that we have JMC enabled?</span>
<a href="#l1.3476"></a><span id="l1.3476" class="difflineminus">-    *selectable_p = GetSize() &amp;&amp; JunkControlsEnabled(nsMsgViewIndex_None);</span>
<a href="#l1.3477"></a><span id="l1.3477" class="difflineminus">-    break;</span>
<a href="#l1.3478"></a><span id="l1.3478" class="difflineminus">-  case nsMsgViewCommandType::deleteJunk:</span>
<a href="#l1.3479"></a><span id="l1.3479" class="difflineminus">-    {</span>
<a href="#l1.3480"></a><span id="l1.3480" class="difflineminus">-      // disable if no messages, or if we can't delete (like news and certain imap folders)</span>
<a href="#l1.3481"></a><span id="l1.3481" class="difflineplus">+      }</span>
<a href="#l1.3482"></a><span id="l1.3482" class="difflineplus">+      break;</span>
<a href="#l1.3483"></a><span id="l1.3483" class="difflineplus">+    }</span>
<a href="#l1.3484"></a><span id="l1.3484" class="difflineplus">+    case nsMsgViewCommandType::applyFilters:</span>
<a href="#l1.3485"></a><span id="l1.3485" class="difflineplus">+      // Disable if no messages.</span>
<a href="#l1.3486"></a><span id="l1.3486" class="difflineplus">+      // XXX todo, check that we have filters, and at least one is enabled.</span>
<a href="#l1.3487"></a><span id="l1.3487" class="difflineplus">+      *selectable_p = GetSize();</span>
<a href="#l1.3488"></a><span id="l1.3488" class="difflineplus">+      if (*selectable_p)</span>
<a href="#l1.3489"></a><span id="l1.3489" class="difflineplus">+        *selectable_p = ServerSupportsFilterAfterTheFact();</span>
<a href="#l1.3490"></a><span id="l1.3490" class="difflineplus">+</span>
<a href="#l1.3491"></a><span id="l1.3491" class="difflineplus">+      break;</span>
<a href="#l1.3492"></a><span id="l1.3492" class="difflineplus">+    case nsMsgViewCommandType::runJunkControls:</span>
<a href="#l1.3493"></a><span id="l1.3493" class="difflineplus">+      // Disable if no messages.</span>
<a href="#l1.3494"></a><span id="l1.3494" class="difflineplus">+      // XXX todo, check that we have JMC enabled?</span>
<a href="#l1.3495"></a><span id="l1.3495" class="difflineplus">+      *selectable_p = GetSize() &amp;&amp; JunkControlsEnabled(nsMsgViewIndex_None);</span>
<a href="#l1.3496"></a><span id="l1.3496" class="difflineplus">+      break;</span>
<a href="#l1.3497"></a><span id="l1.3497" class="difflineplus">+    case nsMsgViewCommandType::deleteJunk:</span>
<a href="#l1.3498"></a><span id="l1.3498" class="difflineplus">+    {</span>
<a href="#l1.3499"></a><span id="l1.3499" class="difflineplus">+      // Disable if no messages, or if we can't delete (like news and</span>
<a href="#l1.3500"></a><span id="l1.3500" class="difflineplus">+      // certain imap folders).</span>
<a href="#l1.3501"></a><span id="l1.3501">       bool canDelete;</span>
<a href="#l1.3502"></a><span id="l1.3502" class="difflineminus">-      *selectable_p = GetSize() &amp;&amp; (m_folder &amp;&amp; NS_SUCCEEDED(m_folder-&gt;GetCanDeleteMessages(&amp;canDelete)) &amp;&amp; canDelete);</span>
<a href="#l1.3503"></a><span id="l1.3503" class="difflineminus">-    }</span>
<a href="#l1.3504"></a><span id="l1.3504" class="difflineminus">-    break;</span>
<a href="#l1.3505"></a><span id="l1.3505" class="difflineminus">-  case nsMsgViewCommandType::markMessagesRead:</span>
<a href="#l1.3506"></a><span id="l1.3506" class="difflineminus">-  case nsMsgViewCommandType::markMessagesUnread:</span>
<a href="#l1.3507"></a><span id="l1.3507" class="difflineminus">-  case nsMsgViewCommandType::toggleMessageRead:</span>
<a href="#l1.3508"></a><span id="l1.3508" class="difflineminus">-  case nsMsgViewCommandType::flagMessages:</span>
<a href="#l1.3509"></a><span id="l1.3509" class="difflineminus">-  case nsMsgViewCommandType::unflagMessages:</span>
<a href="#l1.3510"></a><span id="l1.3510" class="difflineminus">-  case nsMsgViewCommandType::toggleThreadWatched:</span>
<a href="#l1.3511"></a><span id="l1.3511" class="difflineminus">-  case nsMsgViewCommandType::markThreadRead:</span>
<a href="#l1.3512"></a><span id="l1.3512" class="difflineminus">-  case nsMsgViewCommandType::downloadSelectedForOffline:</span>
<a href="#l1.3513"></a><span id="l1.3513" class="difflineminus">-    *selectable_p = haveSelection;</span>
<a href="#l1.3514"></a><span id="l1.3514" class="difflineminus">-    break;</span>
<a href="#l1.3515"></a><span id="l1.3515" class="difflineminus">-  case nsMsgViewCommandType::junk:</span>
<a href="#l1.3516"></a><span id="l1.3516" class="difflineminus">-  case nsMsgViewCommandType::unjunk:</span>
<a href="#l1.3517"></a><span id="l1.3517" class="difflineminus">-    *selectable_p = haveSelection &amp;&amp; numIndices &amp;&amp; JunkControlsEnabled(selection[0]);</span>
<a href="#l1.3518"></a><span id="l1.3518" class="difflineminus">-    break;</span>
<a href="#l1.3519"></a><span id="l1.3519" class="difflineminus">-  case nsMsgViewCommandType::cmdRequiringMsgBody:</span>
<a href="#l1.3520"></a><span id="l1.3520" class="difflineminus">-    *selectable_p = haveSelection &amp;&amp; (!WeAreOffline() || OfflineMsgSelected(indices, numIndices));</span>
<a href="#l1.3521"></a><span id="l1.3521" class="difflineminus">-    break;</span>
<a href="#l1.3522"></a><span id="l1.3522" class="difflineminus">-  case nsMsgViewCommandType::downloadFlaggedForOffline:</span>
<a href="#l1.3523"></a><span id="l1.3523" class="difflineminus">-  case nsMsgViewCommandType::markAllRead:</span>
<a href="#l1.3524"></a><span id="l1.3524" class="difflineminus">-    *selectable_p = true;</span>
<a href="#l1.3525"></a><span id="l1.3525" class="difflineminus">-    break;</span>
<a href="#l1.3526"></a><span id="l1.3526" class="difflineminus">-  default:</span>
<a href="#l1.3527"></a><span id="l1.3527" class="difflineminus">-    NS_ASSERTION(false, &quot;invalid command type&quot;);</span>
<a href="#l1.3528"></a><span id="l1.3528" class="difflineminus">-    rv = NS_ERROR_FAILURE;</span>
<a href="#l1.3529"></a><span id="l1.3529" class="difflineminus">-  }</span>
<a href="#l1.3530"></a><span id="l1.3530" class="difflineplus">+      *selectable_p = GetSize() &amp;&amp; m_folder &amp;&amp;</span>
<a href="#l1.3531"></a><span id="l1.3531" class="difflineplus">+                      NS_SUCCEEDED(m_folder-&gt;GetCanDeleteMessages(&amp;canDelete)) &amp;&amp;</span>
<a href="#l1.3532"></a><span id="l1.3532" class="difflineplus">+                      canDelete;</span>
<a href="#l1.3533"></a><span id="l1.3533" class="difflineplus">+      break;</span>
<a href="#l1.3534"></a><span id="l1.3534" class="difflineplus">+    }</span>
<a href="#l1.3535"></a><span id="l1.3535" class="difflineplus">+    case nsMsgViewCommandType::markMessagesRead:</span>
<a href="#l1.3536"></a><span id="l1.3536" class="difflineplus">+    case nsMsgViewCommandType::markMessagesUnread:</span>
<a href="#l1.3537"></a><span id="l1.3537" class="difflineplus">+    case nsMsgViewCommandType::toggleMessageRead:</span>
<a href="#l1.3538"></a><span id="l1.3538" class="difflineplus">+    case nsMsgViewCommandType::flagMessages:</span>
<a href="#l1.3539"></a><span id="l1.3539" class="difflineplus">+    case nsMsgViewCommandType::unflagMessages:</span>
<a href="#l1.3540"></a><span id="l1.3540" class="difflineplus">+    case nsMsgViewCommandType::toggleThreadWatched:</span>
<a href="#l1.3541"></a><span id="l1.3541" class="difflineplus">+    case nsMsgViewCommandType::markThreadRead:</span>
<a href="#l1.3542"></a><span id="l1.3542" class="difflineplus">+    case nsMsgViewCommandType::downloadSelectedForOffline:</span>
<a href="#l1.3543"></a><span id="l1.3543" class="difflineplus">+      *selectable_p = haveSelection;</span>
<a href="#l1.3544"></a><span id="l1.3544" class="difflineplus">+      break;</span>
<a href="#l1.3545"></a><span id="l1.3545" class="difflineplus">+    case nsMsgViewCommandType::junk:</span>
<a href="#l1.3546"></a><span id="l1.3546" class="difflineplus">+    case nsMsgViewCommandType::unjunk:</span>
<a href="#l1.3547"></a><span id="l1.3547" class="difflineplus">+      *selectable_p = haveSelection &amp;&amp; numIndices &amp;&amp; JunkControlsEnabled(selection[0]);</span>
<a href="#l1.3548"></a><span id="l1.3548" class="difflineplus">+      break;</span>
<a href="#l1.3549"></a><span id="l1.3549" class="difflineplus">+    case nsMsgViewCommandType::cmdRequiringMsgBody:</span>
<a href="#l1.3550"></a><span id="l1.3550" class="difflineplus">+      *selectable_p = haveSelection &amp;&amp; (!WeAreOffline() || OfflineMsgSelected(indices, numIndices));</span>
<a href="#l1.3551"></a><span id="l1.3551" class="difflineplus">+      break;</span>
<a href="#l1.3552"></a><span id="l1.3552" class="difflineplus">+    case nsMsgViewCommandType::downloadFlaggedForOffline:</span>
<a href="#l1.3553"></a><span id="l1.3553" class="difflineplus">+    case nsMsgViewCommandType::markAllRead:</span>
<a href="#l1.3554"></a><span id="l1.3554" class="difflineplus">+      *selectable_p = true;</span>
<a href="#l1.3555"></a><span id="l1.3555" class="difflineplus">+      break;</span>
<a href="#l1.3556"></a><span id="l1.3556" class="difflineplus">+    default:</span>
<a href="#l1.3557"></a><span id="l1.3557" class="difflineplus">+      NS_ASSERTION(false, &quot;invalid command type&quot;);</span>
<a href="#l1.3558"></a><span id="l1.3558" class="difflineplus">+      rv = NS_ERROR_FAILURE;</span>
<a href="#l1.3559"></a><span id="l1.3559" class="difflineplus">+  }</span>
<a href="#l1.3560"></a><span id="l1.3560" class="difflineplus">+</span>
<a href="#l1.3561"></a><span id="l1.3561">   return rv;</span>
<a href="#l1.3562"></a><span id="l1.3562"> }</span>
<a href="#l1.3563"></a><span id="l1.3563"> </span>
<a href="#l1.3564"></a><span id="l1.3564"> // This method needs to be overridden by the various view classes</span>
<a href="#l1.3565"></a><span id="l1.3565"> // that have different kinds of threads. For example, in a</span>
<a href="#l1.3566"></a><span id="l1.3566"> // threaded quick search db view, we'd only want to include children</span>
<a href="#l1.3567"></a><span id="l1.3567"> // of the thread that fit the view (IMO). And when we have threaded</span>
<a href="#l1.3568"></a><span id="l1.3568"> // cross folder views, we would include all the children of the</span>
<a href="#l1.3569"></a><span id="l1.3569"> // cross-folder thread.</span>
<a href="#l1.3570"></a><span id="l1.3570" class="difflineminus">-nsresult nsMsgDBView::ListCollapsedChildren(nsMsgViewIndex viewIndex,</span>
<a href="#l1.3571"></a><span id="l1.3571" class="difflineminus">-                                            nsIMutableArray *messageArray)</span>
<a href="#l1.3572"></a><span id="l1.3572" class="difflineplus">+nsresult</span>
<a href="#l1.3573"></a><span id="l1.3573" class="difflineplus">+nsMsgDBView::ListCollapsedChildren(nsMsgViewIndex viewIndex,</span>
<a href="#l1.3574"></a><span id="l1.3574" class="difflineplus">+                                   nsIMutableArray *messageArray)</span>
<a href="#l1.3575"></a><span id="l1.3575"> {</span>
<a href="#l1.3576"></a><span id="l1.3576">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.3577"></a><span id="l1.3577">   nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.3578"></a><span id="l1.3578">   GetMsgHdrForViewIndex(viewIndex, getter_AddRefs(msgHdr));</span>
<a href="#l1.3579"></a><span id="l1.3579">   if (!msgHdr)</span>
<a href="#l1.3580"></a><span id="l1.3580">   {</span>
<a href="#l1.3581"></a><span id="l1.3581">     NS_ASSERTION(false, &quot;couldn't find message to expand&quot;);</span>
<a href="#l1.3582"></a><span id="l1.3582">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.3583"></a><span id="l1.3583">   }</span>
<a href="#l1.3584"></a><span id="l1.3584" class="difflineplus">+</span>
<a href="#l1.3585"></a><span id="l1.3585">   nsresult rv = GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(thread));</span>
<a href="#l1.3586"></a><span id="l1.3586">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3587"></a><span id="l1.3587">   uint32_t numChildren;</span>
<a href="#l1.3588"></a><span id="l1.3588">   thread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l1.3589"></a><span id="l1.3589">   for (uint32_t i = 1; i &lt; numChildren &amp;&amp; NS_SUCCEEDED(rv); i++)</span>
<a href="#l1.3590"></a><span id="l1.3590">   {</span>
<a href="#l1.3591"></a><span id="l1.3591">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.3592"></a><span id="l1.3592">     rv = thread-&gt;GetChildHdrAt(i, getter_AddRefs(msgHdr));</span>
<a href="#l1.3593"></a><span id="l1.3593">     if (!msgHdr)</span>
<a href="#l1.3594"></a><span id="l1.3594">       continue;</span>
<a href="#l1.3595"></a><span id="l1.3595" class="difflineplus">+</span>
<a href="#l1.3596"></a><span id="l1.3596">     rv = messageArray-&gt;AppendElement(msgHdr, false);</span>
<a href="#l1.3597"></a><span id="l1.3597">   }</span>
<a href="#l1.3598"></a><span id="l1.3598" class="difflineplus">+</span>
<a href="#l1.3599"></a><span id="l1.3599">   return rv;</span>
<a href="#l1.3600"></a><span id="l1.3600"> }</span>
<a href="#l1.3601"></a><span id="l1.3601"> </span>
<a href="#l1.3602"></a><span id="l1.3602" class="difflineminus">-bool nsMsgDBView::OperateOnMsgsInCollapsedThreads()</span>
<a href="#l1.3603"></a><span id="l1.3603" class="difflineplus">+bool</span>
<a href="#l1.3604"></a><span id="l1.3604" class="difflineplus">+nsMsgDBView::OperateOnMsgsInCollapsedThreads()</span>
<a href="#l1.3605"></a><span id="l1.3605"> {</span>
<a href="#l1.3606"></a><span id="l1.3606">   if (mTreeSelection)</span>
<a href="#l1.3607"></a><span id="l1.3607">   {</span>
<a href="#l1.3608"></a><span id="l1.3608">     nsCOMPtr&lt;nsITreeBoxObject&gt; selTree;</span>
<a href="#l1.3609"></a><span id="l1.3609">     mTreeSelection-&gt;GetTree(getter_AddRefs(selTree));</span>
<a href="#l1.3610"></a><span id="l1.3610" class="difflineminus">-    // no tree means stand-alone message window</span>
<a href="#l1.3611"></a><span id="l1.3611" class="difflineplus">+    // No tree means stand-alone message window.</span>
<a href="#l1.3612"></a><span id="l1.3612">     if (!selTree)</span>
<a href="#l1.3613"></a><span id="l1.3613">       return false;</span>
<a href="#l1.3614"></a><span id="l1.3614">   }</span>
<a href="#l1.3615"></a><span id="l1.3615"> </span>
<a href="#l1.3616"></a><span id="l1.3616">   nsresult rv = NS_OK;</span>
<a href="#l1.3617"></a><span id="l1.3617">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch (do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.3618"></a><span id="l1.3618">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l1.3619"></a><span id="l1.3619"> </span>
<a href="#l1.3620"></a><span id="l1.3620">   bool includeCollapsedMsgs = false;</span>
<a href="#l1.3621"></a><span id="l1.3621" class="difflineminus">-  prefBranch-&gt;GetBoolPref(&quot;mail.operate_on_msgs_in_collapsed_threads&quot;, &amp;includeCollapsedMsgs);</span>
<a href="#l1.3622"></a><span id="l1.3622" class="difflineplus">+  prefBranch-&gt;GetBoolPref(&quot;mail.operate_on_msgs_in_collapsed_threads&quot;,</span>
<a href="#l1.3623"></a><span id="l1.3623" class="difflineplus">+                          &amp;includeCollapsedMsgs);</span>
<a href="#l1.3624"></a><span id="l1.3624">   return includeCollapsedMsgs;</span>
<a href="#l1.3625"></a><span id="l1.3625"> }</span>
<a href="#l1.3626"></a><span id="l1.3626"> </span>
<a href="#l1.3627"></a><span id="l1.3627" class="difflineminus">-nsresult nsMsgDBView::GetHeadersFromSelection(uint32_t *indices,</span>
<a href="#l1.3628"></a><span id="l1.3628" class="difflineminus">-                                              uint32_t numIndices,</span>
<a href="#l1.3629"></a><span id="l1.3629" class="difflineminus">-                                              nsIMutableArray *messageArray)</span>
<a href="#l1.3630"></a><span id="l1.3630" class="difflineplus">+nsresult</span>
<a href="#l1.3631"></a><span id="l1.3631" class="difflineplus">+nsMsgDBView::GetHeadersFromSelection(uint32_t *indices,</span>
<a href="#l1.3632"></a><span id="l1.3632" class="difflineplus">+                                     uint32_t numIndices,</span>
<a href="#l1.3633"></a><span id="l1.3633" class="difflineplus">+                                     nsIMutableArray *messageArray)</span>
<a href="#l1.3634"></a><span id="l1.3634"> {</span>
<a href="#l1.3635"></a><span id="l1.3635">   nsresult rv = NS_OK;</span>
<a href="#l1.3636"></a><span id="l1.3636"> </span>
<a href="#l1.3637"></a><span id="l1.3637">   // Don't include collapsed messages if the front end failed to summarize</span>
<a href="#l1.3638"></a><span id="l1.3638">   // the selection.</span>
<a href="#l1.3639"></a><span id="l1.3639">   bool includeCollapsedMsgs = OperateOnMsgsInCollapsedThreads() &amp;&amp;</span>
<a href="#l1.3640"></a><span id="l1.3640" class="difflineminus">-                                !mSummarizeFailed;</span>
<a href="#l1.3641"></a><span id="l1.3641" class="difflineplus">+                              !mSummarizeFailed;</span>
<a href="#l1.3642"></a><span id="l1.3642"> </span>
<a href="#l1.3643"></a><span id="l1.3643">   for (uint32_t index = 0;</span>
<a href="#l1.3644"></a><span id="l1.3644" class="difflineminus">-       index &lt; (nsMsgViewIndex) numIndices &amp;&amp; NS_SUCCEEDED(rv); index++)</span>
<a href="#l1.3645"></a><span id="l1.3645" class="difflineplus">+       index &lt; (nsMsgViewIndex) numIndices &amp;&amp; NS_SUCCEEDED(rv);</span>
<a href="#l1.3646"></a><span id="l1.3646" class="difflineplus">+       index++)</span>
<a href="#l1.3647"></a><span id="l1.3647">   {</span>
<a href="#l1.3648"></a><span id="l1.3648">     nsMsgViewIndex viewIndex = indices[index];</span>
<a href="#l1.3649"></a><span id="l1.3649">     if (viewIndex == nsMsgViewIndex_None)</span>
<a href="#l1.3650"></a><span id="l1.3650">       continue;</span>
<a href="#l1.3651"></a><span id="l1.3651" class="difflineplus">+</span>
<a href="#l1.3652"></a><span id="l1.3652">     uint32_t viewIndexFlags = m_flags[viewIndex];</span>
<a href="#l1.3653"></a><span id="l1.3653">     if (viewIndexFlags &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l1.3654"></a><span id="l1.3654">     {</span>
<a href="#l1.3655"></a><span id="l1.3655" class="difflineminus">-      // if collapsed dummy header selected, list its children</span>
<a href="#l1.3656"></a><span id="l1.3656" class="difflineplus">+      // If collapsed dummy header selected, list its children.</span>
<a href="#l1.3657"></a><span id="l1.3657">       if (includeCollapsedMsgs &amp;&amp; viewIndexFlags &amp; nsMsgMessageFlags::Elided &amp;&amp;</span>
<a href="#l1.3658"></a><span id="l1.3658">           m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.3659"></a><span id="l1.3659">         rv = ListCollapsedChildren(viewIndex, messageArray);</span>
<a href="#l1.3660"></a><span id="l1.3660" class="difflineplus">+</span>
<a href="#l1.3661"></a><span id="l1.3661">       continue;</span>
<a href="#l1.3662"></a><span id="l1.3662">     }</span>
<a href="#l1.3663"></a><span id="l1.3663" class="difflineplus">+</span>
<a href="#l1.3664"></a><span id="l1.3664">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.3665"></a><span id="l1.3665">     rv = GetMsgHdrForViewIndex(viewIndex, getter_AddRefs(msgHdr));</span>
<a href="#l1.3666"></a><span id="l1.3666">     if (NS_SUCCEEDED(rv) &amp;&amp; msgHdr)</span>
<a href="#l1.3667"></a><span id="l1.3667">     {</span>
<a href="#l1.3668"></a><span id="l1.3668">       rv = messageArray-&gt;AppendElement(msgHdr, false);</span>
<a href="#l1.3669"></a><span id="l1.3669">       if (NS_SUCCEEDED(rv) &amp;&amp; includeCollapsedMsgs &amp;&amp;</span>
<a href="#l1.3670"></a><span id="l1.3670">           viewIndexFlags &amp; nsMsgMessageFlags::Elided &amp;&amp;</span>
<a href="#l1.3671"></a><span id="l1.3671">           viewIndexFlags &amp; MSG_VIEW_FLAG_HASCHILDREN &amp;&amp;</span>
<a href="#l1.3672"></a><span id="l1.3672">           m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.3673"></a><span id="l1.3673">       {</span>
<a href="#l1.3674"></a><span id="l1.3674">         rv = ListCollapsedChildren(viewIndex, messageArray);</span>
<a href="#l1.3675"></a><span id="l1.3675">       }</span>
<a href="#l1.3676"></a><span id="l1.3676">     }</span>
<a href="#l1.3677"></a><span id="l1.3677">   }</span>
<a href="#l1.3678"></a><span id="l1.3678" class="difflineplus">+</span>
<a href="#l1.3679"></a><span id="l1.3679">   return rv;</span>
<a href="#l1.3680"></a><span id="l1.3680"> }</span>
<a href="#l1.3681"></a><span id="l1.3681"> </span>
<a href="#l1.3682"></a><span id="l1.3682"> nsresult</span>
<a href="#l1.3683"></a><span id="l1.3683" class="difflineminus">-nsMsgDBView::CopyMessages(nsIMsgWindow *window, nsMsgViewIndex *indices, int32_t numIndices, bool isMove, nsIMsgFolder *destFolder)</span>
<a href="#l1.3684"></a><span id="l1.3684" class="difflineplus">+nsMsgDBView::CopyMessages(nsIMsgWindow *window,</span>
<a href="#l1.3685"></a><span id="l1.3685" class="difflineplus">+                          nsMsgViewIndex *indices,</span>
<a href="#l1.3686"></a><span id="l1.3686" class="difflineplus">+                          int32_t numIndices,</span>
<a href="#l1.3687"></a><span id="l1.3687" class="difflineplus">+                          bool isMove,</span>
<a href="#l1.3688"></a><span id="l1.3688" class="difflineplus">+                          nsIMsgFolder *destFolder)</span>
<a href="#l1.3689"></a><span id="l1.3689"> {</span>
<a href="#l1.3690"></a><span id="l1.3690">   if (m_deletingRows)</span>
<a href="#l1.3691"></a><span id="l1.3691">   {</span>
<a href="#l1.3692"></a><span id="l1.3692">     NS_ASSERTION(false, &quot;Last move did not complete&quot;);</span>
<a href="#l1.3693"></a><span id="l1.3693">     return NS_OK;</span>
<a href="#l1.3694"></a><span id="l1.3694">   }</span>
<a href="#l1.3695"></a><span id="l1.3695"> </span>
<a href="#l1.3696"></a><span id="l1.3696">   nsresult rv;</span>
<a href="#l1.3697"></a><span id="l1.3697" class="difflineat">@@ -2883,98 +3217,114 @@ nsMsgDBView::CopyMessages(nsIMsgWindow *</span>
<a href="#l1.3698"></a><span id="l1.3698">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3699"></a><span id="l1.3699"> </span>
<a href="#l1.3700"></a><span id="l1.3700">   m_deletingRows = isMove &amp;&amp; mDeleteModel != nsMsgImapDeleteModels::IMAPDelete;</span>
<a href="#l1.3701"></a><span id="l1.3701">   if (m_deletingRows)</span>
<a href="#l1.3702"></a><span id="l1.3702">     mIndicesToNoteChange.AppendElements(indices, numIndices);</span>
<a href="#l1.3703"></a><span id="l1.3703"> </span>
<a href="#l1.3704"></a><span id="l1.3704">   nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.3705"></a><span id="l1.3705">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3706"></a><span id="l1.3706" class="difflineminus">-  return copyService-&gt;CopyMessages(m_folder /* source folder */, messageArray, destFolder, isMove, nullptr /* listener */, window, true /*allowUndo*/);</span>
<a href="#l1.3707"></a><span id="l1.3707" class="difflineplus">+</span>
<a href="#l1.3708"></a><span id="l1.3708" class="difflineplus">+  return copyService-&gt;CopyMessages(m_folder /* source folder */,</span>
<a href="#l1.3709"></a><span id="l1.3709" class="difflineplus">+                                   messageArray,</span>
<a href="#l1.3710"></a><span id="l1.3710" class="difflineplus">+                                   destFolder,</span>
<a href="#l1.3711"></a><span id="l1.3711" class="difflineplus">+                                   isMove,</span>
<a href="#l1.3712"></a><span id="l1.3712" class="difflineplus">+                                   nullptr /* listener */,</span>
<a href="#l1.3713"></a><span id="l1.3713" class="difflineplus">+                                   window, true /* allow Undo */);</span>
<a href="#l1.3714"></a><span id="l1.3714"> }</span>
<a href="#l1.3715"></a><span id="l1.3715"> </span>
<a href="#l1.3716"></a><span id="l1.3716"> nsresult</span>
<a href="#l1.3717"></a><span id="l1.3717" class="difflineminus">-nsMsgDBView::ApplyCommandToIndicesWithFolder(nsMsgViewCommandTypeValue command, nsMsgViewIndex* indices,</span>
<a href="#l1.3718"></a><span id="l1.3718" class="difflineminus">-                    int32_t numIndices, nsIMsgFolder *destFolder)</span>
<a href="#l1.3719"></a><span id="l1.3719" class="difflineplus">+nsMsgDBView::ApplyCommandToIndicesWithFolder(nsMsgViewCommandTypeValue command,</span>
<a href="#l1.3720"></a><span id="l1.3720" class="difflineplus">+                                             nsMsgViewIndex* indices,</span>
<a href="#l1.3721"></a><span id="l1.3721" class="difflineplus">+                                             int32_t numIndices,</span>
<a href="#l1.3722"></a><span id="l1.3722" class="difflineplus">+                                             nsIMsgFolder *destFolder)</span>
<a href="#l1.3723"></a><span id="l1.3723"> {</span>
<a href="#l1.3724"></a><span id="l1.3724">   nsresult rv = NS_OK;</span>
<a href="#l1.3725"></a><span id="l1.3725">   NS_ENSURE_ARG_POINTER(destFolder);</span>
<a href="#l1.3726"></a><span id="l1.3726"> </span>
<a href="#l1.3727"></a><span id="l1.3727">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l1.3728"></a><span id="l1.3728" class="difflineminus">-  switch (command) {</span>
<a href="#l1.3729"></a><span id="l1.3729" class="difflineplus">+  switch (command)</span>
<a href="#l1.3730"></a><span id="l1.3730" class="difflineplus">+  {</span>
<a href="#l1.3731"></a><span id="l1.3731">     case nsMsgViewCommandType::copyMessages:</span>
<a href="#l1.3732"></a><span id="l1.3732" class="difflineminus">-        NS_ASSERTION(!(m_folder == destFolder), &quot;The source folder and the destination folder are the same&quot;);</span>
<a href="#l1.3733"></a><span id="l1.3733" class="difflineminus">-        if (m_folder != destFolder)</span>
<a href="#l1.3734"></a><span id="l1.3734" class="difflineminus">-          rv = CopyMessages(msgWindow, indices, numIndices, false /* isMove */, destFolder);</span>
<a href="#l1.3735"></a><span id="l1.3735" class="difflineminus">-        break;</span>
<a href="#l1.3736"></a><span id="l1.3736" class="difflineplus">+      NS_ASSERTION(!(m_folder == destFolder),</span>
<a href="#l1.3737"></a><span id="l1.3737" class="difflineplus">+                   &quot;The source folder and the destination folder are the same&quot;);</span>
<a href="#l1.3738"></a><span id="l1.3738" class="difflineplus">+      if (m_folder != destFolder)</span>
<a href="#l1.3739"></a><span id="l1.3739" class="difflineplus">+        rv = CopyMessages(msgWindow, indices, numIndices, false /* isMove */, destFolder);</span>
<a href="#l1.3740"></a><span id="l1.3740" class="difflineplus">+</span>
<a href="#l1.3741"></a><span id="l1.3741" class="difflineplus">+      break;</span>
<a href="#l1.3742"></a><span id="l1.3742">     case nsMsgViewCommandType::moveMessages:</span>
<a href="#l1.3743"></a><span id="l1.3743" class="difflineminus">-        NS_ASSERTION(!(m_folder == destFolder), &quot;The source folder and the destination folder are the same&quot;);</span>
<a href="#l1.3744"></a><span id="l1.3744" class="difflineminus">-        if (m_folder != destFolder)</span>
<a href="#l1.3745"></a><span id="l1.3745" class="difflineminus">-          rv = CopyMessages(msgWindow, indices, numIndices, true     /* isMove */, destFolder);</span>
<a href="#l1.3746"></a><span id="l1.3746" class="difflineminus">-        break;</span>
<a href="#l1.3747"></a><span id="l1.3747" class="difflineplus">+      NS_ASSERTION(!(m_folder == destFolder),</span>
<a href="#l1.3748"></a><span id="l1.3748" class="difflineplus">+                   &quot;The source folder and the destination folder are the same&quot;);</span>
<a href="#l1.3749"></a><span id="l1.3749" class="difflineplus">+      if (m_folder != destFolder)</span>
<a href="#l1.3750"></a><span id="l1.3750" class="difflineplus">+        rv = CopyMessages(msgWindow, indices, numIndices, true /* isMove */, destFolder);</span>
<a href="#l1.3751"></a><span id="l1.3751" class="difflineplus">+</span>
<a href="#l1.3752"></a><span id="l1.3752" class="difflineplus">+      break;</span>
<a href="#l1.3753"></a><span id="l1.3753">     default:</span>
<a href="#l1.3754"></a><span id="l1.3754" class="difflineminus">-        NS_ASSERTION(false, &quot;unhandled command&quot;);</span>
<a href="#l1.3755"></a><span id="l1.3755" class="difflineminus">-        rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.3756"></a><span id="l1.3756" class="difflineminus">-        break;</span>
<a href="#l1.3757"></a><span id="l1.3757" class="difflineminus">-    }</span>
<a href="#l1.3758"></a><span id="l1.3758" class="difflineminus">-    return rv;</span>
<a href="#l1.3759"></a><span id="l1.3759" class="difflineplus">+      NS_ASSERTION(false, &quot;unhandled command&quot;);</span>
<a href="#l1.3760"></a><span id="l1.3760" class="difflineplus">+      rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.3761"></a><span id="l1.3761" class="difflineplus">+      break;</span>
<a href="#l1.3762"></a><span id="l1.3762" class="difflineplus">+  }</span>
<a href="#l1.3763"></a><span id="l1.3763" class="difflineplus">+</span>
<a href="#l1.3764"></a><span id="l1.3764" class="difflineplus">+  return rv;</span>
<a href="#l1.3765"></a><span id="l1.3765"> }</span>
<a href="#l1.3766"></a><span id="l1.3766"> </span>
<a href="#l1.3767"></a><span id="l1.3767"> nsresult</span>
<a href="#l1.3768"></a><span id="l1.3768" class="difflineminus">-nsMsgDBView::ApplyCommandToIndices(nsMsgViewCommandTypeValue command, nsMsgViewIndex* indices,</span>
<a href="#l1.3769"></a><span id="l1.3769" class="difflineminus">-          int32_t numIndices)</span>
<a href="#l1.3770"></a><span id="l1.3770" class="difflineminus">-{</span>
<a href="#l1.3771"></a><span id="l1.3771" class="difflineminus">-  NS_ASSERTION(numIndices &gt;= 0, &quot;nsMsgDBView::ApplyCommandToIndices(): &quot;</span>
<a href="#l1.3772"></a><span id="l1.3772" class="difflineminus">-               &quot;numIndices is negative!&quot;);</span>
<a href="#l1.3773"></a><span id="l1.3773" class="difflineminus">-</span>
<a href="#l1.3774"></a><span id="l1.3774" class="difflineplus">+nsMsgDBView::ApplyCommandToIndices(nsMsgViewCommandTypeValue command,</span>
<a href="#l1.3775"></a><span id="l1.3775" class="difflineplus">+                                   nsMsgViewIndex* indices,</span>
<a href="#l1.3776"></a><span id="l1.3776" class="difflineplus">+                                   int32_t numIndices)</span>
<a href="#l1.3777"></a><span id="l1.3777" class="difflineplus">+{</span>
<a href="#l1.3778"></a><span id="l1.3778" class="difflineplus">+  NS_ASSERTION(numIndices &gt;= 0,</span>
<a href="#l1.3779"></a><span id="l1.3779" class="difflineplus">+               &quot;nsMsgDBView::ApplyCommandToIndices(): numIndices is negative!&quot;);</span>
<a href="#l1.3780"></a><span id="l1.3780" class="difflineplus">+</span>
<a href="#l1.3781"></a><span id="l1.3781" class="difflineplus">+  // Return quietly, just in case/</span>
<a href="#l1.3782"></a><span id="l1.3782">   if (numIndices == 0)</span>
<a href="#l1.3783"></a><span id="l1.3783" class="difflineminus">-    return NS_OK; // return quietly, just in case</span>
<a href="#l1.3784"></a><span id="l1.3784" class="difflineplus">+    return NS_OK;</span>
<a href="#l1.3785"></a><span id="l1.3785"> </span>
<a href="#l1.3786"></a><span id="l1.3786">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.3787"></a><span id="l1.3787">   nsresult rv = GetFolderForViewIndex(indices[0], getter_AddRefs(folder));</span>
<a href="#l1.3788"></a><span id="l1.3788">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l1.3789"></a><span id="l1.3789">   if (command == nsMsgViewCommandType::deleteMsg)</span>
<a href="#l1.3790"></a><span id="l1.3790">     return DeleteMessages(msgWindow, indices, numIndices, false);</span>
<a href="#l1.3791"></a><span id="l1.3791" class="difflineplus">+</span>
<a href="#l1.3792"></a><span id="l1.3792">   if (command == nsMsgViewCommandType::deleteNoTrash)</span>
<a href="#l1.3793"></a><span id="l1.3793">     return DeleteMessages(msgWindow, indices, numIndices, true);</span>
<a href="#l1.3794"></a><span id="l1.3794"> </span>
<a href="#l1.3795"></a><span id="l1.3795">   nsTArray&lt;nsMsgKey&gt; imapUids;</span>
<a href="#l1.3796"></a><span id="l1.3796">   nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(folder);</span>
<a href="#l1.3797"></a><span id="l1.3797">   bool thisIsImapFolder = (imapFolder != nullptr);</span>
<a href="#l1.3798"></a><span id="l1.3798">   nsCOMPtr&lt;nsIJunkMailPlugin&gt; junkPlugin;</span>
<a href="#l1.3799"></a><span id="l1.3799"> </span>
<a href="#l1.3800"></a><span id="l1.3800" class="difflineminus">-  // if this is a junk command, get the junk plugin.</span>
<a href="#l1.3801"></a><span id="l1.3801" class="difflineplus">+  // If this is a junk command, get the junk plugin.</span>
<a href="#l1.3802"></a><span id="l1.3802">   if (command == nsMsgViewCommandType::junk ||</span>
<a href="#l1.3803"></a><span id="l1.3803">       command == nsMsgViewCommandType::unjunk)</span>
<a href="#l1.3804"></a><span id="l1.3804">   {</span>
<a href="#l1.3805"></a><span id="l1.3805" class="difflineminus">-    // get the folder from the first item; we assume that</span>
<a href="#l1.3806"></a><span id="l1.3806" class="difflineplus">+    // Get the folder from the first item; we assume that</span>
<a href="#l1.3807"></a><span id="l1.3807">     // all messages in the view are from the same folder (no</span>
<a href="#l1.3808"></a><span id="l1.3808">     // more junk status column in the 'search messages' dialog</span>
<a href="#l1.3809"></a><span id="l1.3809" class="difflineminus">-    // like in earlier versions...)</span>
<a href="#l1.3810"></a><span id="l1.3810" class="difflineminus">-</span>
<a href="#l1.3811"></a><span id="l1.3811" class="difflineminus">-     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.3812"></a><span id="l1.3812" class="difflineminus">-     rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.3813"></a><span id="l1.3813" class="difflineminus">-     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3814"></a><span id="l1.3814" class="difflineplus">+    // like in earlier versions...).</span>
<a href="#l1.3815"></a><span id="l1.3815" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.3816"></a><span id="l1.3816" class="difflineplus">+    rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.3817"></a><span id="l1.3817" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3818"></a><span id="l1.3818"> </span>
<a href="#l1.3819"></a><span id="l1.3819">     nsCOMPtr&lt;nsIMsgFilterPlugin&gt; filterPlugin;</span>
<a href="#l1.3820"></a><span id="l1.3820">     rv = server-&gt;GetSpamFilterPlugin(getter_AddRefs(filterPlugin));</span>
<a href="#l1.3821"></a><span id="l1.3821">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3822"></a><span id="l1.3822"> </span>
<a href="#l1.3823"></a><span id="l1.3823">     junkPlugin = do_QueryInterface(filterPlugin, &amp;rv);</span>
<a href="#l1.3824"></a><span id="l1.3824">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3825"></a><span id="l1.3825">     if (!mJunkHdrs)</span>
<a href="#l1.3826"></a><span id="l1.3826">     {</span>
<a href="#l1.3827"></a><span id="l1.3827">       mJunkHdrs = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l1.3828"></a><span id="l1.3828">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.3829"></a><span id="l1.3829">     }</span>
<a href="#l1.3830"></a><span id="l1.3830">   }</span>
<a href="#l1.3831"></a><span id="l1.3831"> </span>
<a href="#l1.3832"></a><span id="l1.3832">   folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, false);</span>
<a href="#l1.3833"></a><span id="l1.3833"> </span>
<a href="#l1.3834"></a><span id="l1.3834" class="difflineminus">-  // no sense going through the code that handles messages in collasped threads</span>
<a href="#l1.3835"></a><span id="l1.3835" class="difflineplus">+  // No sense going through the code that handles messages in collasped threads</span>
<a href="#l1.3836"></a><span id="l1.3836">   // for mark thread read.</span>
<a href="#l1.3837"></a><span id="l1.3837">   if (command == nsMsgViewCommandType::markThreadRead)</span>
<a href="#l1.3838"></a><span id="l1.3838">   {</span>
<a href="#l1.3839"></a><span id="l1.3839">     for (int32_t index = 0; index &lt; numIndices; index++)</span>
<a href="#l1.3840"></a><span id="l1.3840">       SetThreadOfMsgReadByIndex(indices[index], imapUids, true);</span>
<a href="#l1.3841"></a><span id="l1.3841">   }</span>
<a href="#l1.3842"></a><span id="l1.3842">   else</span>
<a href="#l1.3843"></a><span id="l1.3843">   {</span>
<a href="#l1.3844"></a><span id="l1.3844" class="difflineat">@@ -2995,73 +3345,78 @@ nsMsgDBView::ApplyCommandToIndices(nsMsg</span>
<a href="#l1.3845"></a><span id="l1.3845">       nsMsgKey msgKey;</span>
<a href="#l1.3846"></a><span id="l1.3846">       nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(messages, i);</span>
<a href="#l1.3847"></a><span id="l1.3847">       msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.3848"></a><span id="l1.3848">       if (thisIsImapFolder)</span>
<a href="#l1.3849"></a><span id="l1.3849">         imapUids[i] = msgKey;</span>
<a href="#l1.3850"></a><span id="l1.3850"> </span>
<a href="#l1.3851"></a><span id="l1.3851">       switch (command)</span>
<a href="#l1.3852"></a><span id="l1.3852">       {</span>
<a href="#l1.3853"></a><span id="l1.3853" class="difflineminus">-      case nsMsgViewCommandType::junk:</span>
<a href="#l1.3854"></a><span id="l1.3854" class="difflineminus">-        mNumMessagesRemainingInBatch++;</span>
<a href="#l1.3855"></a><span id="l1.3855" class="difflineminus">-        mJunkHdrs-&gt;AppendElement(msgHdr, false);</span>
<a href="#l1.3856"></a><span id="l1.3856" class="difflineminus">-        rv = SetMsgHdrJunkStatus(junkPlugin.get(), msgHdr,</span>
<a href="#l1.3857"></a><span id="l1.3857" class="difflineminus">-                                 nsIJunkMailPlugin::JUNK);</span>
<a href="#l1.3858"></a><span id="l1.3858" class="difflineminus">-        break;</span>
<a href="#l1.3859"></a><span id="l1.3859" class="difflineminus">-      case nsMsgViewCommandType::unjunk:</span>
<a href="#l1.3860"></a><span id="l1.3860" class="difflineminus">-        mNumMessagesRemainingInBatch++;</span>
<a href="#l1.3861"></a><span id="l1.3861" class="difflineminus">-        mJunkHdrs-&gt;AppendElement(msgHdr, false);</span>
<a href="#l1.3862"></a><span id="l1.3862" class="difflineminus">-        rv = SetMsgHdrJunkStatus(junkPlugin.get(), msgHdr,</span>
<a href="#l1.3863"></a><span id="l1.3863" class="difflineminus">-                                 nsIJunkMailPlugin::GOOD);</span>
<a href="#l1.3864"></a><span id="l1.3864" class="difflineminus">-        break;</span>
<a href="#l1.3865"></a><span id="l1.3865" class="difflineminus">-      case nsMsgViewCommandType::toggleMessageRead:</span>
<a href="#l1.3866"></a><span id="l1.3866" class="difflineminus">-      case nsMsgViewCommandType::undeleteMsg:</span>
<a href="#l1.3867"></a><span id="l1.3867" class="difflineminus">-      case nsMsgViewCommandType::markMessagesRead:</span>
<a href="#l1.3868"></a><span id="l1.3868" class="difflineminus">-      case nsMsgViewCommandType::markMessagesUnread:</span>
<a href="#l1.3869"></a><span id="l1.3869" class="difflineminus">-      case nsMsgViewCommandType::unflagMessages:</span>
<a href="#l1.3870"></a><span id="l1.3870" class="difflineminus">-      case nsMsgViewCommandType::flagMessages:</span>
<a href="#l1.3871"></a><span id="l1.3871" class="difflineminus">-        break; // this is completely handled in the code below.</span>
<a href="#l1.3872"></a><span id="l1.3872" class="difflineminus">-      default:</span>
<a href="#l1.3873"></a><span id="l1.3873" class="difflineminus">-        NS_ERROR(&quot;unhandled command&quot;);</span>
<a href="#l1.3874"></a><span id="l1.3874" class="difflineminus">-        break;</span>
<a href="#l1.3875"></a><span id="l1.3875" class="difflineplus">+        case nsMsgViewCommandType::junk:</span>
<a href="#l1.3876"></a><span id="l1.3876" class="difflineplus">+          mNumMessagesRemainingInBatch++;</span>
<a href="#l1.3877"></a><span id="l1.3877" class="difflineplus">+          mJunkHdrs-&gt;AppendElement(msgHdr, false);</span>
<a href="#l1.3878"></a><span id="l1.3878" class="difflineplus">+          rv = SetMsgHdrJunkStatus(junkPlugin.get(), msgHdr,</span>
<a href="#l1.3879"></a><span id="l1.3879" class="difflineplus">+                                   nsIJunkMailPlugin::JUNK);</span>
<a href="#l1.3880"></a><span id="l1.3880" class="difflineplus">+          break;</span>
<a href="#l1.3881"></a><span id="l1.3881" class="difflineplus">+        case nsMsgViewCommandType::unjunk:</span>
<a href="#l1.3882"></a><span id="l1.3882" class="difflineplus">+          mNumMessagesRemainingInBatch++;</span>
<a href="#l1.3883"></a><span id="l1.3883" class="difflineplus">+          mJunkHdrs-&gt;AppendElement(msgHdr, false);</span>
<a href="#l1.3884"></a><span id="l1.3884" class="difflineplus">+          rv = SetMsgHdrJunkStatus(junkPlugin.get(), msgHdr,</span>
<a href="#l1.3885"></a><span id="l1.3885" class="difflineplus">+                                   nsIJunkMailPlugin::GOOD);</span>
<a href="#l1.3886"></a><span id="l1.3886" class="difflineplus">+          break;</span>
<a href="#l1.3887"></a><span id="l1.3887" class="difflineplus">+        case nsMsgViewCommandType::toggleMessageRead:</span>
<a href="#l1.3888"></a><span id="l1.3888" class="difflineplus">+        case nsMsgViewCommandType::undeleteMsg:</span>
<a href="#l1.3889"></a><span id="l1.3889" class="difflineplus">+        case nsMsgViewCommandType::markMessagesRead:</span>
<a href="#l1.3890"></a><span id="l1.3890" class="difflineplus">+        case nsMsgViewCommandType::markMessagesUnread:</span>
<a href="#l1.3891"></a><span id="l1.3891" class="difflineplus">+        case nsMsgViewCommandType::unflagMessages:</span>
<a href="#l1.3892"></a><span id="l1.3892" class="difflineplus">+        case nsMsgViewCommandType::flagMessages:</span>
<a href="#l1.3893"></a><span id="l1.3893" class="difflineplus">+          // This is completely handled in the code below.</span>
<a href="#l1.3894"></a><span id="l1.3894" class="difflineplus">+          break;</span>
<a href="#l1.3895"></a><span id="l1.3895" class="difflineplus">+        default:</span>
<a href="#l1.3896"></a><span id="l1.3896" class="difflineplus">+          NS_ERROR(&quot;unhandled command&quot;);</span>
<a href="#l1.3897"></a><span id="l1.3897" class="difflineplus">+          break;</span>
<a href="#l1.3898"></a><span id="l1.3898">       }</span>
<a href="#l1.3899"></a><span id="l1.3899">     }</span>
<a href="#l1.3900"></a><span id="l1.3900"> </span>
<a href="#l1.3901"></a><span id="l1.3901">     switch (command)</span>
<a href="#l1.3902"></a><span id="l1.3902">     {</span>
<a href="#l1.3903"></a><span id="l1.3903">       case nsMsgViewCommandType::toggleMessageRead:</span>
<a href="#l1.3904"></a><span id="l1.3904">       {</span>
<a href="#l1.3905"></a><span id="l1.3905">         nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(messages, 0);</span>
<a href="#l1.3906"></a><span id="l1.3906">         if (!msgHdr)</span>
<a href="#l1.3907"></a><span id="l1.3907">           break;</span>
<a href="#l1.3908"></a><span id="l1.3908" class="difflineplus">+</span>
<a href="#l1.3909"></a><span id="l1.3909">         uint32_t msgFlags;</span>
<a href="#l1.3910"></a><span id="l1.3910">         msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.3911"></a><span id="l1.3911">         folder-&gt;MarkMessagesRead(messages,</span>
<a href="#l1.3912"></a><span id="l1.3912">                                  !(msgFlags &amp; nsMsgMessageFlags::Read));</span>
<a href="#l1.3913"></a><span id="l1.3913" class="difflineplus">+        break;</span>
<a href="#l1.3914"></a><span id="l1.3914">       }</span>
<a href="#l1.3915"></a><span id="l1.3915" class="difflineminus">-        break;</span>
<a href="#l1.3916"></a><span id="l1.3916">       case nsMsgViewCommandType::markMessagesRead:</span>
<a href="#l1.3917"></a><span id="l1.3917">       case nsMsgViewCommandType::markMessagesUnread:</span>
<a href="#l1.3918"></a><span id="l1.3918">         folder-&gt;MarkMessagesRead(messages,</span>
<a href="#l1.3919"></a><span id="l1.3919">                                  command == nsMsgViewCommandType::markMessagesRead);</span>
<a href="#l1.3920"></a><span id="l1.3920">         break;</span>
<a href="#l1.3921"></a><span id="l1.3921">       case nsMsgViewCommandType::unflagMessages:</span>
<a href="#l1.3922"></a><span id="l1.3922">       case nsMsgViewCommandType::flagMessages:</span>
<a href="#l1.3923"></a><span id="l1.3923">         folder-&gt;MarkMessagesFlagged(messages,</span>
<a href="#l1.3924"></a><span id="l1.3924">                                     command == nsMsgViewCommandType::flagMessages);</span>
<a href="#l1.3925"></a><span id="l1.3925">         break;</span>
<a href="#l1.3926"></a><span id="l1.3926">       default:</span>
<a href="#l1.3927"></a><span id="l1.3927">         break;</span>
<a href="#l1.3928"></a><span id="l1.3928"> </span>
<a href="#l1.3929"></a><span id="l1.3929">     }</span>
<a href="#l1.3930"></a><span id="l1.3930" class="difflineminus">-    // Provide junk-related batch notifications</span>
<a href="#l1.3931"></a><span id="l1.3931" class="difflineminus">-    if ((command == nsMsgViewCommandType::junk) ||</span>
<a href="#l1.3932"></a><span id="l1.3932" class="difflineminus">-        (command == nsMsgViewCommandType::unjunk)) {</span>
<a href="#l1.3933"></a><span id="l1.3933" class="difflineplus">+</span>
<a href="#l1.3934"></a><span id="l1.3934" class="difflineplus">+    // Provide junk-related batch notifications.</span>
<a href="#l1.3935"></a><span id="l1.3935" class="difflineplus">+    if (command == nsMsgViewCommandType::junk ||</span>
<a href="#l1.3936"></a><span id="l1.3936" class="difflineplus">+        command == nsMsgViewCommandType::unjunk)</span>
<a href="#l1.3937"></a><span id="l1.3937" class="difflineplus">+    {</span>
<a href="#l1.3938"></a><span id="l1.3938">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt;</span>
<a href="#l1.3939"></a><span id="l1.3939">         notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l1.3940"></a><span id="l1.3940" class="difflineplus">+</span>
<a href="#l1.3941"></a><span id="l1.3941">       if (notifier)</span>
<a href="#l1.3942"></a><span id="l1.3942">         notifier-&gt;NotifyItemEvent(messages,</span>
<a href="#l1.3943"></a><span id="l1.3943">                                   NS_LITERAL_CSTRING(&quot;JunkStatusChanged&quot;),</span>
<a href="#l1.3944"></a><span id="l1.3944">                                   nullptr,</span>
<a href="#l1.3945"></a><span id="l1.3945">                                   (command == nsMsgViewCommandType::junk)</span>
<a href="#l1.3946"></a><span id="l1.3946">                                   ? NS_LITERAL_CSTRING(&quot;junk&quot;)</span>
<a href="#l1.3947"></a><span id="l1.3947">                                   : NS_LITERAL_CSTRING(&quot;notjunk&quot;));</span>
<a href="#l1.3948"></a><span id="l1.3948">     }</span>
<a href="#l1.3949"></a><span id="l1.3949" class="difflineat">@@ -3071,87 +3426,108 @@ nsMsgDBView::ApplyCommandToIndices(nsMsg</span>
<a href="#l1.3950"></a><span id="l1.3950"> </span>
<a href="#l1.3951"></a><span id="l1.3951">   if (thisIsImapFolder)</span>
<a href="#l1.3952"></a><span id="l1.3952">   {</span>
<a href="#l1.3953"></a><span id="l1.3953">     imapMessageFlagsType flags = kNoImapMsgFlag;</span>
<a href="#l1.3954"></a><span id="l1.3954">     bool addFlags = false;</span>
<a href="#l1.3955"></a><span id="l1.3955">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l1.3956"></a><span id="l1.3956">     switch (command)</span>
<a href="#l1.3957"></a><span id="l1.3957">     {</span>
<a href="#l1.3958"></a><span id="l1.3958" class="difflineminus">-    case nsMsgViewCommandType::markThreadRead:</span>
<a href="#l1.3959"></a><span id="l1.3959" class="difflineminus">-      flags |= kImapMsgSeenFlag;</span>
<a href="#l1.3960"></a><span id="l1.3960" class="difflineminus">-      addFlags = true;</span>
<a href="#l1.3961"></a><span id="l1.3961" class="difflineminus">-      break;</span>
<a href="#l1.3962"></a><span id="l1.3962" class="difflineminus">-    case nsMsgViewCommandType::undeleteMsg:</span>
<a href="#l1.3963"></a><span id="l1.3963" class="difflineminus">-      flags = kImapMsgDeletedFlag;</span>
<a href="#l1.3964"></a><span id="l1.3964" class="difflineminus">-      addFlags = false;</span>
<a href="#l1.3965"></a><span id="l1.3965" class="difflineminus">-      break;</span>
<a href="#l1.3966"></a><span id="l1.3966" class="difflineminus">-    case nsMsgViewCommandType::junk:</span>
<a href="#l1.3967"></a><span id="l1.3967" class="difflineplus">+      case nsMsgViewCommandType::markThreadRead:</span>
<a href="#l1.3968"></a><span id="l1.3968" class="difflineplus">+        flags |= kImapMsgSeenFlag;</span>
<a href="#l1.3969"></a><span id="l1.3969" class="difflineplus">+        addFlags = true;</span>
<a href="#l1.3970"></a><span id="l1.3970" class="difflineplus">+        break;</span>
<a href="#l1.3971"></a><span id="l1.3971" class="difflineplus">+      case nsMsgViewCommandType::undeleteMsg:</span>
<a href="#l1.3972"></a><span id="l1.3972" class="difflineplus">+        flags = kImapMsgDeletedFlag;</span>
<a href="#l1.3973"></a><span id="l1.3973" class="difflineplus">+        addFlags = false;</span>
<a href="#l1.3974"></a><span id="l1.3974" class="difflineplus">+        break;</span>
<a href="#l1.3975"></a><span id="l1.3975" class="difflineplus">+      case nsMsgViewCommandType::junk:</span>
<a href="#l1.3976"></a><span id="l1.3976">         return imapFolder-&gt;StoreCustomKeywords(msgWindow,</span>
<a href="#l1.3977"></a><span id="l1.3977" class="difflineminus">-                    NS_LITERAL_CSTRING(&quot;Junk&quot;),</span>
<a href="#l1.3978"></a><span id="l1.3978" class="difflineminus">-                    NS_LITERAL_CSTRING(&quot;NonJunk&quot;),</span>
<a href="#l1.3979"></a><span id="l1.3979" class="difflineminus">-                    imapUids.Elements(), imapUids.Length(),</span>
<a href="#l1.3980"></a><span id="l1.3980" class="difflineminus">-                    nullptr);</span>
<a href="#l1.3981"></a><span id="l1.3981" class="difflineminus">-    case nsMsgViewCommandType::unjunk:</span>
<a href="#l1.3982"></a><span id="l1.3982" class="difflineplus">+                                               NS_LITERAL_CSTRING(&quot;Junk&quot;),</span>
<a href="#l1.3983"></a><span id="l1.3983" class="difflineplus">+                                               NS_LITERAL_CSTRING(&quot;NonJunk&quot;),</span>
<a href="#l1.3984"></a><span id="l1.3984" class="difflineplus">+                                               imapUids.Elements(),</span>
<a href="#l1.3985"></a><span id="l1.3985" class="difflineplus">+                                               imapUids.Length(),</span>
<a href="#l1.3986"></a><span id="l1.3986" class="difflineplus">+                                               nullptr);</span>
<a href="#l1.3987"></a><span id="l1.3987" class="difflineplus">+      case nsMsgViewCommandType::unjunk:</span>
<a href="#l1.3988"></a><span id="l1.3988">       {</span>
<a href="#l1.3989"></a><span id="l1.3989">         nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.3990"></a><span id="l1.3990">         GetHdrForFirstSelectedMessage(getter_AddRefs(msgHdr));</span>
<a href="#l1.3991"></a><span id="l1.3991">         uint32_t msgFlags = 0;</span>
<a href="#l1.3992"></a><span id="l1.3992">         if (msgHdr)</span>
<a href="#l1.3993"></a><span id="l1.3993">           msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.3994"></a><span id="l1.3994" class="difflineplus">+</span>
<a href="#l1.3995"></a><span id="l1.3995">         if (msgFlags &amp; nsMsgMessageFlags::IMAPDeleted)</span>
<a href="#l1.3996"></a><span id="l1.3996" class="difflineminus">-          imapFolder-&gt;StoreImapFlags(kImapMsgDeletedFlag, false,</span>
<a href="#l1.3997"></a><span id="l1.3997" class="difflineplus">+          imapFolder-&gt;StoreImapFlags(kImapMsgDeletedFlag,</span>
<a href="#l1.3998"></a><span id="l1.3998" class="difflineplus">+                                     false,</span>
<a href="#l1.3999"></a><span id="l1.3999">                                      imapUids.Elements(),</span>
<a href="#l1.4000"></a><span id="l1.4000" class="difflineminus">-                                     imapUids.Length(), nullptr);</span>
<a href="#l1.4001"></a><span id="l1.4001" class="difflineminus">-        return imapFolder-&gt;StoreCustomKeywords(msgWindow,</span>
<a href="#l1.4002"></a><span id="l1.4002" class="difflineminus">-                    NS_LITERAL_CSTRING(&quot;NonJunk&quot;),</span>
<a href="#l1.4003"></a><span id="l1.4003" class="difflineminus">-                    NS_LITERAL_CSTRING(&quot;Junk&quot;),</span>
<a href="#l1.4004"></a><span id="l1.4004" class="difflineminus">-                    imapUids.Elements(), imapUids.Length(),</span>
<a href="#l1.4005"></a><span id="l1.4005" class="difflineminus">-                    nullptr);</span>
<a href="#l1.4006"></a><span id="l1.4006" class="difflineplus">+                                     imapUids.Length(),</span>
<a href="#l1.4007"></a><span id="l1.4007" class="difflineplus">+                                     nullptr);</span>
<a href="#l1.4008"></a><span id="l1.4008" class="difflineplus">+</span>
<a href="#l1.4009"></a><span id="l1.4009" class="difflineplus">+          return imapFolder-&gt;StoreCustomKeywords(msgWindow,</span>
<a href="#l1.4010"></a><span id="l1.4010" class="difflineplus">+                                                 NS_LITERAL_CSTRING(&quot;NonJunk&quot;),</span>
<a href="#l1.4011"></a><span id="l1.4011" class="difflineplus">+                                                 NS_LITERAL_CSTRING(&quot;Junk&quot;),</span>
<a href="#l1.4012"></a><span id="l1.4012" class="difflineplus">+                                                 imapUids.Elements(),</span>
<a href="#l1.4013"></a><span id="l1.4013" class="difflineplus">+                                                 imapUids.Length(),</span>
<a href="#l1.4014"></a><span id="l1.4014" class="difflineplus">+                                                 nullptr);</span>
<a href="#l1.4015"></a><span id="l1.4015">       }</span>
<a href="#l1.4016"></a><span id="l1.4016" class="difflineminus">-</span>
<a href="#l1.4017"></a><span id="l1.4017" class="difflineminus">-    default:</span>
<a href="#l1.4018"></a><span id="l1.4018" class="difflineminus">-      break;</span>
<a href="#l1.4019"></a><span id="l1.4019" class="difflineminus">-    }</span>
<a href="#l1.4020"></a><span id="l1.4020" class="difflineminus">-</span>
<a href="#l1.4021"></a><span id="l1.4021" class="difflineminus">-    if (flags != kNoImapMsgFlag)  // can't get here without thisIsImapThreadPane == TRUE</span>
<a href="#l1.4022"></a><span id="l1.4022" class="difflineminus">-      imapFolder-&gt;StoreImapFlags(flags, addFlags, imapUids.Elements(), imapUids.Length(), nullptr);</span>
<a href="#l1.4023"></a><span id="l1.4023" class="difflineminus">-</span>
<a href="#l1.4024"></a><span id="l1.4024" class="difflineplus">+      default:</span>
<a href="#l1.4025"></a><span id="l1.4025" class="difflineplus">+        break;</span>
<a href="#l1.4026"></a><span id="l1.4026" class="difflineplus">+    }</span>
<a href="#l1.4027"></a><span id="l1.4027" class="difflineplus">+</span>
<a href="#l1.4028"></a><span id="l1.4028" class="difflineplus">+    // Can't get here without thisIsImapThreadPane == TRUE.</span>
<a href="#l1.4029"></a><span id="l1.4029" class="difflineplus">+    if (flags != kNoImapMsgFlag)</span>
<a href="#l1.4030"></a><span id="l1.4030" class="difflineplus">+    {</span>
<a href="#l1.4031"></a><span id="l1.4031" class="difflineplus">+      imapFolder-&gt;StoreImapFlags(flags,</span>
<a href="#l1.4032"></a><span id="l1.4032" class="difflineplus">+                                 addFlags,</span>
<a href="#l1.4033"></a><span id="l1.4033" class="difflineplus">+                                 imapUids.Elements(),</span>
<a href="#l1.4034"></a><span id="l1.4034" class="difflineplus">+                                 imapUids.Length(),</span>
<a href="#l1.4035"></a><span id="l1.4035" class="difflineplus">+                                 nullptr);</span>
<a href="#l1.4036"></a><span id="l1.4036" class="difflineplus">+    }</span>
<a href="#l1.4037"></a><span id="l1.4037">   }</span>
<a href="#l1.4038"></a><span id="l1.4038"> </span>
<a href="#l1.4039"></a><span id="l1.4039">   return rv;</span>
<a href="#l1.4040"></a><span id="l1.4040"> }</span>
<a href="#l1.4041"></a><span id="l1.4041"> </span>
<a href="#l1.4042"></a><span id="l1.4042" class="difflineminus">-// view modifications methods by index</span>
<a href="#l1.4043"></a><span id="l1.4043" class="difflineplus">+/**</span>
<a href="#l1.4044"></a><span id="l1.4044" class="difflineplus">+ * View modifications methods by index.</span>
<a href="#l1.4045"></a><span id="l1.4045" class="difflineplus">+ */</span>
<a href="#l1.4046"></a><span id="l1.4046"> </span>
<a href="#l1.4047"></a><span id="l1.4047"> // This method just removes the specified line from the view. It does</span>
<a href="#l1.4048"></a><span id="l1.4048"> // NOT delete it from the database.</span>
<a href="#l1.4049"></a><span id="l1.4049" class="difflineminus">-nsresult nsMsgDBView::RemoveByIndex(nsMsgViewIndex index)</span>
<a href="#l1.4050"></a><span id="l1.4050" class="difflineplus">+nsresult</span>
<a href="#l1.4051"></a><span id="l1.4051" class="difflineplus">+nsMsgDBView::RemoveByIndex(nsMsgViewIndex index)</span>
<a href="#l1.4052"></a><span id="l1.4052"> {</span>
<a href="#l1.4053"></a><span id="l1.4053">   if (!IsValidIndex(index))</span>
<a href="#l1.4054"></a><span id="l1.4054">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.4055"></a><span id="l1.4055" class="difflineplus">+</span>
<a href="#l1.4056"></a><span id="l1.4056">   m_keys.RemoveElementAt(index);</span>
<a href="#l1.4057"></a><span id="l1.4057">   m_flags.RemoveElementAt(index);</span>
<a href="#l1.4058"></a><span id="l1.4058">   m_levels.RemoveElementAt(index);</span>
<a href="#l1.4059"></a><span id="l1.4059"> </span>
<a href="#l1.4060"></a><span id="l1.4060" class="difflineminus">-  // the call to NoteChange() has to happen after we remove the key</span>
<a href="#l1.4061"></a><span id="l1.4061" class="difflineminus">-  // as NoteChange() will call RowCountChanged() which will call our GetRowCount()</span>
<a href="#l1.4062"></a><span id="l1.4062" class="difflineplus">+  // The call to NoteChange() has to happen after we remove the key as</span>
<a href="#l1.4063"></a><span id="l1.4063" class="difflineplus">+  // NoteChange() will call RowCountChanged() which will call our GetRowCount().</span>
<a href="#l1.4064"></a><span id="l1.4064" class="difflineplus">+  // An example where view is not the listener - D&amp;D messages.</span>
<a href="#l1.4065"></a><span id="l1.4065">   if (!m_deletingRows)</span>
<a href="#l1.4066"></a><span id="l1.4066" class="difflineminus">-    NoteChange(index, -1, nsMsgViewNotificationCode::insertOrDelete); // an example where view is not the listener - D&amp;D messages</span>
<a href="#l1.4067"></a><span id="l1.4067" class="difflineminus">-</span>
<a href="#l1.4068"></a><span id="l1.4068" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.4069"></a><span id="l1.4069" class="difflineminus">-}</span>
<a href="#l1.4070"></a><span id="l1.4070" class="difflineminus">-</span>
<a href="#l1.4071"></a><span id="l1.4071" class="difflineminus">-nsresult nsMsgDBView::DeleteMessages(nsIMsgWindow *window, nsMsgViewIndex *indices, int32_t numIndices, bool deleteStorage)</span>
<a href="#l1.4072"></a><span id="l1.4072" class="difflineplus">+    NoteChange(index, -1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.4073"></a><span id="l1.4073" class="difflineplus">+</span>
<a href="#l1.4074"></a><span id="l1.4074" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.4075"></a><span id="l1.4075" class="difflineplus">+}</span>
<a href="#l1.4076"></a><span id="l1.4076" class="difflineplus">+</span>
<a href="#l1.4077"></a><span id="l1.4077" class="difflineplus">+nsresult</span>
<a href="#l1.4078"></a><span id="l1.4078" class="difflineplus">+nsMsgDBView::DeleteMessages(nsIMsgWindow *window,</span>
<a href="#l1.4079"></a><span id="l1.4079" class="difflineplus">+                            nsMsgViewIndex *indices,</span>
<a href="#l1.4080"></a><span id="l1.4080" class="difflineplus">+                            int32_t numIndices,</span>
<a href="#l1.4081"></a><span id="l1.4081" class="difflineplus">+                            bool deleteStorage)</span>
<a href="#l1.4082"></a><span id="l1.4082"> {</span>
<a href="#l1.4083"></a><span id="l1.4083">   if (m_deletingRows)</span>
<a href="#l1.4084"></a><span id="l1.4084">   {</span>
<a href="#l1.4085"></a><span id="l1.4085">     NS_WARNING(&quot;Last delete did not complete&quot;);</span>
<a href="#l1.4086"></a><span id="l1.4086">     return NS_OK;</span>
<a href="#l1.4087"></a><span id="l1.4087">   }</span>
<a href="#l1.4088"></a><span id="l1.4088" class="difflineplus">+</span>
<a href="#l1.4089"></a><span id="l1.4089">   nsresult rv;</span>
<a href="#l1.4090"></a><span id="l1.4090">   nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.4091"></a><span id="l1.4091">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4092"></a><span id="l1.4092">   rv = GetHeadersFromSelection(indices, numIndices, messageArray);</span>
<a href="#l1.4093"></a><span id="l1.4093">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4094"></a><span id="l1.4094">   uint32_t numMsgs;</span>
<a href="#l1.4095"></a><span id="l1.4095">   messageArray-&gt;GetLength(&amp;numMsgs);</span>
<a href="#l1.4096"></a><span id="l1.4096"> </span>
<a href="#l1.4097"></a><span id="l1.4097" class="difflineat">@@ -3216,129 +3592,141 @@ nsresult nsMsgDBView::DeleteMessages(nsI</span>
<a href="#l1.4098"></a><span id="l1.4098">   {</span>
<a href="#l1.4099"></a><span id="l1.4099">     nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l1.4100"></a><span id="l1.4100"> </span>
<a href="#l1.4101"></a><span id="l1.4101">     nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv));</span>
<a href="#l1.4102"></a><span id="l1.4102">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4103"></a><span id="l1.4103"> </span>
<a href="#l1.4104"></a><span id="l1.4104">     rv = wwatch-&gt;GetNewPrompter(0, getter_AddRefs(dialog));</span>
<a href="#l1.4105"></a><span id="l1.4105">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4106"></a><span id="l1.4106" class="difflineminus">-    bool dontAsk = false; // &quot;Don't ask...&quot; - unchecked by default.</span>
<a href="#l1.4107"></a><span id="l1.4107" class="difflineplus">+    // &quot;Don't ask...&quot; - unchecked by default.</span>
<a href="#l1.4108"></a><span id="l1.4108" class="difflineplus">+    bool dontAsk = false;</span>
<a href="#l1.4109"></a><span id="l1.4109">     int32_t buttonPressed = 0;</span>
<a href="#l1.4110"></a><span id="l1.4110"> </span>
<a href="#l1.4111"></a><span id="l1.4111">     nsString dialogTitle;</span>
<a href="#l1.4112"></a><span id="l1.4112">     nsString confirmString;</span>
<a href="#l1.4113"></a><span id="l1.4113">     nsString checkboxText;</span>
<a href="#l1.4114"></a><span id="l1.4114">     nsString buttonApplyNowText;</span>
<a href="#l1.4115"></a><span id="l1.4115">     dialogTitle.Adopt(GetString(u&quot;confirmMsgDelete.title&quot;));</span>
<a href="#l1.4116"></a><span id="l1.4116">     checkboxText.Adopt(GetString(u&quot;confirmMsgDelete.dontAsk.label&quot;));</span>
<a href="#l1.4117"></a><span id="l1.4117">     buttonApplyNowText.Adopt(GetString(u&quot;confirmMsgDelete.delete.label&quot;));</span>
<a href="#l1.4118"></a><span id="l1.4118"> </span>
<a href="#l1.4119"></a><span id="l1.4119">     confirmString.Adopt(GetString(warningName.get()));</span>
<a href="#l1.4120"></a><span id="l1.4120"> </span>
<a href="#l1.4121"></a><span id="l1.4121">     const uint32_t buttonFlags =</span>
<a href="#l1.4122"></a><span id="l1.4122">       (nsIPrompt::BUTTON_TITLE_IS_STRING * nsIPrompt::BUTTON_POS_0) +</span>
<a href="#l1.4123"></a><span id="l1.4123">       (nsIPrompt::BUTTON_TITLE_CANCEL * nsIPrompt::BUTTON_POS_1);</span>
<a href="#l1.4124"></a><span id="l1.4124" class="difflineplus">+</span>
<a href="#l1.4125"></a><span id="l1.4125">     rv = dialog-&gt;ConfirmEx(dialogTitle.get(), confirmString.get(), buttonFlags,</span>
<a href="#l1.4126"></a><span id="l1.4126">                            buttonApplyNowText.get(), nullptr, nullptr,</span>
<a href="#l1.4127"></a><span id="l1.4127">                            checkboxText.get(), &amp;dontAsk, &amp;buttonPressed);</span>
<a href="#l1.4128"></a><span id="l1.4128">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4129"></a><span id="l1.4129">     if (buttonPressed)</span>
<a href="#l1.4130"></a><span id="l1.4130">       return NS_ERROR_FAILURE;</span>
<a href="#l1.4131"></a><span id="l1.4131" class="difflineplus">+</span>
<a href="#l1.4132"></a><span id="l1.4132">     if (dontAsk)</span>
<a href="#l1.4133"></a><span id="l1.4133">       prefBranch-&gt;SetBoolPref(activePref, false);</span>
<a href="#l1.4134"></a><span id="l1.4134">   }</span>
<a href="#l1.4135"></a><span id="l1.4135"> </span>
<a href="#l1.4136"></a><span id="l1.4136">   if (mDeleteModel != nsMsgImapDeleteModels::IMAPDelete)</span>
<a href="#l1.4137"></a><span id="l1.4137">     m_deletingRows = true;</span>
<a href="#l1.4138"></a><span id="l1.4138"> </span>
<a href="#l1.4139"></a><span id="l1.4139">   if (m_deletingRows)</span>
<a href="#l1.4140"></a><span id="l1.4140">     mIndicesToNoteChange.AppendElements(indices, numIndices);</span>
<a href="#l1.4141"></a><span id="l1.4141"> </span>
<a href="#l1.4142"></a><span id="l1.4142" class="difflineminus">-  rv = m_folder-&gt;DeleteMessages(messageArray, window, deleteStorage, false, nullptr, true /*allow Undo*/ );</span>
<a href="#l1.4143"></a><span id="l1.4143" class="difflineplus">+  rv = m_folder-&gt;DeleteMessages(messageArray, window, deleteStorage,</span>
<a href="#l1.4144"></a><span id="l1.4144" class="difflineplus">+                                false, nullptr, true /* allow Undo */);</span>
<a href="#l1.4145"></a><span id="l1.4145">   if (NS_FAILED(rv))</span>
<a href="#l1.4146"></a><span id="l1.4146">     m_deletingRows = false;</span>
<a href="#l1.4147"></a><span id="l1.4147" class="difflineplus">+</span>
<a href="#l1.4148"></a><span id="l1.4148">   return rv;</span>
<a href="#l1.4149"></a><span id="l1.4149"> }</span>
<a href="#l1.4150"></a><span id="l1.4150"> </span>
<a href="#l1.4151"></a><span id="l1.4151" class="difflineminus">-nsresult nsMsgDBView::DownloadForOffline(nsIMsgWindow *window, nsMsgViewIndex *indices, int32_t numIndices)</span>
<a href="#l1.4152"></a><span id="l1.4152" class="difflineplus">+nsresult</span>
<a href="#l1.4153"></a><span id="l1.4153" class="difflineplus">+nsMsgDBView::DownloadForOffline(nsIMsgWindow *window,</span>
<a href="#l1.4154"></a><span id="l1.4154" class="difflineplus">+                                nsMsgViewIndex *indices,</span>
<a href="#l1.4155"></a><span id="l1.4155" class="difflineplus">+                                int32_t numIndices)</span>
<a href="#l1.4156"></a><span id="l1.4156"> {</span>
<a href="#l1.4157"></a><span id="l1.4157">   nsresult rv = NS_OK;</span>
<a href="#l1.4158"></a><span id="l1.4158">   nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l1.4159"></a><span id="l1.4159" class="difflineminus">-  for (nsMsgViewIndex index = 0; index &lt; (nsMsgViewIndex) numIndices; index++)</span>
<a href="#l1.4160"></a><span id="l1.4160" class="difflineplus">+  for (nsMsgViewIndex index = 0;</span>
<a href="#l1.4161"></a><span id="l1.4161" class="difflineplus">+       index &lt; (nsMsgViewIndex) numIndices;</span>
<a href="#l1.4162"></a><span id="l1.4162" class="difflineplus">+       index++)</span>
<a href="#l1.4163"></a><span id="l1.4163">   {</span>
<a href="#l1.4164"></a><span id="l1.4164">     nsMsgKey key = m_keys[indices[index]];</span>
<a href="#l1.4165"></a><span id="l1.4165">     nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.4166"></a><span id="l1.4166">     rv = m_db-&gt;GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l1.4167"></a><span id="l1.4167">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.4168"></a><span id="l1.4168">     if (msgHdr)</span>
<a href="#l1.4169"></a><span id="l1.4169">     {</span>
<a href="#l1.4170"></a><span id="l1.4170">       uint32_t flags;</span>
<a href="#l1.4171"></a><span id="l1.4171">       msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.4172"></a><span id="l1.4172">       if (!(flags &amp; nsMsgMessageFlags::Offline))</span>
<a href="#l1.4173"></a><span id="l1.4173">         messageArray-&gt;AppendElement(msgHdr, false);</span>
<a href="#l1.4174"></a><span id="l1.4174">     }</span>
<a href="#l1.4175"></a><span id="l1.4175">   }</span>
<a href="#l1.4176"></a><span id="l1.4176" class="difflineplus">+</span>
<a href="#l1.4177"></a><span id="l1.4177">   m_folder-&gt;DownloadMessagesForOffline(messageArray, window);</span>
<a href="#l1.4178"></a><span id="l1.4178">   return rv;</span>
<a href="#l1.4179"></a><span id="l1.4179"> }</span>
<a href="#l1.4180"></a><span id="l1.4180"> </span>
<a href="#l1.4181"></a><span id="l1.4181" class="difflineminus">-nsresult nsMsgDBView::DownloadFlaggedForOffline(nsIMsgWindow *window)</span>
<a href="#l1.4182"></a><span id="l1.4182" class="difflineplus">+nsresult</span>
<a href="#l1.4183"></a><span id="l1.4183" class="difflineplus">+nsMsgDBView::DownloadFlaggedForOffline(nsIMsgWindow *window)</span>
<a href="#l1.4184"></a><span id="l1.4184"> {</span>
<a href="#l1.4185"></a><span id="l1.4185">   nsresult rv = NS_OK;</span>
<a href="#l1.4186"></a><span id="l1.4186">   nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l1.4187"></a><span id="l1.4187">   nsCOMPtr &lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l1.4188"></a><span id="l1.4188">   rv = GetMessageEnumerator(getter_AddRefs(enumerator));</span>
<a href="#l1.4189"></a><span id="l1.4189">   if (NS_SUCCEEDED(rv) &amp;&amp; enumerator)</span>
<a href="#l1.4190"></a><span id="l1.4190">   {</span>
<a href="#l1.4191"></a><span id="l1.4191">     bool hasMore;</span>
<a href="#l1.4192"></a><span id="l1.4192" class="difflineminus">-</span>
<a href="#l1.4193"></a><span id="l1.4193">     while (NS_SUCCEEDED(rv = enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l1.4194"></a><span id="l1.4194">     {</span>
<a href="#l1.4195"></a><span id="l1.4195">       nsCOMPtr &lt;nsISupports&gt; supports;</span>
<a href="#l1.4196"></a><span id="l1.4196">       rv = enumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l1.4197"></a><span id="l1.4197">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;nsMsgDBEnumerator broken&quot;);</span>
<a href="#l1.4198"></a><span id="l1.4198">       nsCOMPtr &lt;nsIMsgDBHdr&gt; pHeader = do_QueryInterface(supports);</span>
<a href="#l1.4199"></a><span id="l1.4199">       if (pHeader &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l1.4200"></a><span id="l1.4200">       {</span>
<a href="#l1.4201"></a><span id="l1.4201">         uint32_t flags;</span>
<a href="#l1.4202"></a><span id="l1.4202">         pHeader-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.4203"></a><span id="l1.4203">         if ((flags &amp; nsMsgMessageFlags::Marked) &amp;&amp; !(flags &amp; nsMsgMessageFlags::Offline))</span>
<a href="#l1.4204"></a><span id="l1.4204">           messageArray-&gt;AppendElement(pHeader, false);</span>
<a href="#l1.4205"></a><span id="l1.4205">       }</span>
<a href="#l1.4206"></a><span id="l1.4206">     }</span>
<a href="#l1.4207"></a><span id="l1.4207">   }</span>
<a href="#l1.4208"></a><span id="l1.4208" class="difflineplus">+</span>
<a href="#l1.4209"></a><span id="l1.4209">   m_folder-&gt;DownloadMessagesForOffline(messageArray, window);</span>
<a href="#l1.4210"></a><span id="l1.4210">   return rv;</span>
<a href="#l1.4211"></a><span id="l1.4211"> }</span>
<a href="#l1.4212"></a><span id="l1.4212"> </span>
<a href="#l1.4213"></a><span id="l1.4213" class="difflineminus">-// read/unread handling.</span>
<a href="#l1.4214"></a><span id="l1.4214" class="difflineminus">-nsresult nsMsgDBView::ToggleReadByIndex(nsMsgViewIndex index)</span>
<a href="#l1.4215"></a><span id="l1.4215" class="difflineplus">+// Read/unread handling.</span>
<a href="#l1.4216"></a><span id="l1.4216" class="difflineplus">+nsresult</span>
<a href="#l1.4217"></a><span id="l1.4217" class="difflineplus">+nsMsgDBView::ToggleReadByIndex(nsMsgViewIndex index)</span>
<a href="#l1.4218"></a><span id="l1.4218"> {</span>
<a href="#l1.4219"></a><span id="l1.4219">   if (!IsValidIndex(index))</span>
<a href="#l1.4220"></a><span id="l1.4220">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.4221"></a><span id="l1.4221" class="difflineplus">+</span>
<a href="#l1.4222"></a><span id="l1.4222">   return SetReadByIndex(index, !(m_flags[index] &amp; nsMsgMessageFlags::Read));</span>
<a href="#l1.4223"></a><span id="l1.4223"> }</span>
<a href="#l1.4224"></a><span id="l1.4224"> </span>
<a href="#l1.4225"></a><span id="l1.4225" class="difflineminus">-nsresult nsMsgDBView::SetReadByIndex(nsMsgViewIndex index, bool read)</span>
<a href="#l1.4226"></a><span id="l1.4226" class="difflineplus">+nsresult</span>
<a href="#l1.4227"></a><span id="l1.4227" class="difflineplus">+nsMsgDBView::SetReadByIndex(nsMsgViewIndex index, bool read)</span>
<a href="#l1.4228"></a><span id="l1.4228"> {</span>
<a href="#l1.4229"></a><span id="l1.4229">   nsresult rv;</span>
<a href="#l1.4230"></a><span id="l1.4230"> </span>
<a href="#l1.4231"></a><span id="l1.4231">   if (!IsValidIndex(index))</span>
<a href="#l1.4232"></a><span id="l1.4232">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.4233"></a><span id="l1.4233" class="difflineplus">+</span>
<a href="#l1.4234"></a><span id="l1.4234">   if (read)</span>
<a href="#l1.4235"></a><span id="l1.4235">   {</span>
<a href="#l1.4236"></a><span id="l1.4236">     OrExtraFlag(index, nsMsgMessageFlags::Read);</span>
<a href="#l1.4237"></a><span id="l1.4237" class="difflineminus">-    // MarkRead() will clear this flag in the db</span>
<a href="#l1.4238"></a><span id="l1.4238" class="difflineminus">-    // and then call OnKeyChange(), but</span>
<a href="#l1.4239"></a><span id="l1.4239" class="difflineminus">-    // because we are the instigator of the change</span>
<a href="#l1.4240"></a><span id="l1.4240" class="difflineminus">-    // we'll ignore the change.</span>
<a href="#l1.4241"></a><span id="l1.4241" class="difflineminus">-    //</span>
<a href="#l1.4242"></a><span id="l1.4242" class="difflineminus">-    // so we need to clear it in m_flags</span>
<a href="#l1.4243"></a><span id="l1.4243" class="difflineminus">-    // to keep the db and m_flags in sync</span>
<a href="#l1.4244"></a><span id="l1.4244" class="difflineplus">+    // MarkRead() will clear this flag in the db and then call OnKeyChange(),</span>
<a href="#l1.4245"></a><span id="l1.4245" class="difflineplus">+    // but because we are the instigator of the change we'll ignore the change.</span>
<a href="#l1.4246"></a><span id="l1.4246" class="difflineplus">+    // So we need to clear it in m_flags to keep the db and m_flags in sync.</span>
<a href="#l1.4247"></a><span id="l1.4247">     AndExtraFlag(index, ~nsMsgMessageFlags::New);</span>
<a href="#l1.4248"></a><span id="l1.4248">   }</span>
<a href="#l1.4249"></a><span id="l1.4249">   else</span>
<a href="#l1.4250"></a><span id="l1.4250">   {</span>
<a href="#l1.4251"></a><span id="l1.4251">     AndExtraFlag(index, ~nsMsgMessageFlags::Read);</span>
<a href="#l1.4252"></a><span id="l1.4252">   }</span>
<a href="#l1.4253"></a><span id="l1.4253"> </span>
<a href="#l1.4254"></a><span id="l1.4254">   nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse;</span>
<a href="#l1.4255"></a><span id="l1.4255" class="difflineat">@@ -3348,30 +3736,37 @@ nsresult nsMsgDBView::SetReadByIndex(nsM</span>
<a href="#l1.4256"></a><span id="l1.4256">   rv = dbToUse-&gt;MarkRead(m_keys[index], read, this);</span>
<a href="#l1.4257"></a><span id="l1.4257">   NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.4258"></a><span id="l1.4258">   if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.4259"></a><span id="l1.4259">   {</span>
<a href="#l1.4260"></a><span id="l1.4260">     nsMsgViewIndex threadIndex = GetThreadIndex(index);</span>
<a href="#l1.4261"></a><span id="l1.4261">     if (threadIndex != index)</span>
<a href="#l1.4262"></a><span id="l1.4262">       NoteChange(threadIndex, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.4263"></a><span id="l1.4263">   }</span>
<a href="#l1.4264"></a><span id="l1.4264" class="difflineplus">+</span>
<a href="#l1.4265"></a><span id="l1.4265">   return rv;</span>
<a href="#l1.4266"></a><span id="l1.4266"> }</span>
<a href="#l1.4267"></a><span id="l1.4267"> </span>
<a href="#l1.4268"></a><span id="l1.4268" class="difflineminus">-nsresult nsMsgDBView::SetThreadOfMsgReadByIndex(nsMsgViewIndex index, nsTArray&lt;nsMsgKey&gt; &amp;keysMarkedRead, bool /*read*/)</span>
<a href="#l1.4269"></a><span id="l1.4269" class="difflineplus">+nsresult</span>
<a href="#l1.4270"></a><span id="l1.4270" class="difflineplus">+nsMsgDBView::SetThreadOfMsgReadByIndex(nsMsgViewIndex index,</span>
<a href="#l1.4271"></a><span id="l1.4271" class="difflineplus">+                                       nsTArray&lt;nsMsgKey&gt; &amp;keysMarkedRead,</span>
<a href="#l1.4272"></a><span id="l1.4272" class="difflineplus">+                                       bool /*read*/)</span>
<a href="#l1.4273"></a><span id="l1.4273"> {</span>
<a href="#l1.4274"></a><span id="l1.4274">   nsresult rv;</span>
<a href="#l1.4275"></a><span id="l1.4275"> </span>
<a href="#l1.4276"></a><span id="l1.4276">   if (!IsValidIndex(index))</span>
<a href="#l1.4277"></a><span id="l1.4277">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.4278"></a><span id="l1.4278" class="difflineplus">+</span>
<a href="#l1.4279"></a><span id="l1.4279">   rv = MarkThreadOfMsgRead(m_keys[index], index, keysMarkedRead, true);</span>
<a href="#l1.4280"></a><span id="l1.4280">   return rv;</span>
<a href="#l1.4281"></a><span id="l1.4281"> }</span>
<a href="#l1.4282"></a><span id="l1.4282"> </span>
<a href="#l1.4283"></a><span id="l1.4283" class="difflineminus">-nsresult nsMsgDBView::SetFlaggedByIndex(nsMsgViewIndex index, bool mark)</span>
<a href="#l1.4284"></a><span id="l1.4284" class="difflineplus">+nsresult</span>
<a href="#l1.4285"></a><span id="l1.4285" class="difflineplus">+nsMsgDBView::SetFlaggedByIndex(nsMsgViewIndex index,</span>
<a href="#l1.4286"></a><span id="l1.4286" class="difflineplus">+                               bool mark)</span>
<a href="#l1.4287"></a><span id="l1.4287"> {</span>
<a href="#l1.4288"></a><span id="l1.4288">   nsresult rv;</span>
<a href="#l1.4289"></a><span id="l1.4289"> </span>
<a href="#l1.4290"></a><span id="l1.4290">   if (!IsValidIndex(index))</span>
<a href="#l1.4291"></a><span id="l1.4291">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.4292"></a><span id="l1.4292"> </span>
<a href="#l1.4293"></a><span id="l1.4293">   nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse;</span>
<a href="#l1.4294"></a><span id="l1.4294">   rv = GetDBForViewIndex(index, getter_AddRefs(dbToUse));</span>
<a href="#l1.4295"></a><span id="l1.4295" class="difflineat">@@ -3382,91 +3777,92 @@ nsresult nsMsgDBView::SetFlaggedByIndex(</span>
<a href="#l1.4296"></a><span id="l1.4296">   else</span>
<a href="#l1.4297"></a><span id="l1.4297">     AndExtraFlag(index, ~nsMsgMessageFlags::Marked);</span>
<a href="#l1.4298"></a><span id="l1.4298"> </span>
<a href="#l1.4299"></a><span id="l1.4299">   rv = dbToUse-&gt;MarkMarked(m_keys[index], mark, this);</span>
<a href="#l1.4300"></a><span id="l1.4300">   NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.4301"></a><span id="l1.4301">   return rv;</span>
<a href="#l1.4302"></a><span id="l1.4302"> }</span>
<a href="#l1.4303"></a><span id="l1.4303"> </span>
<a href="#l1.4304"></a><span id="l1.4304" class="difflineminus">-nsresult nsMsgDBView::SetMsgHdrJunkStatus(nsIJunkMailPlugin *aJunkPlugin,</span>
<a href="#l1.4305"></a><span id="l1.4305" class="difflineminus">-                                          nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l1.4306"></a><span id="l1.4306" class="difflineminus">-                                          nsMsgJunkStatus aNewClassification)</span>
<a href="#l1.4307"></a><span id="l1.4307" class="difflineminus">-{</span>
<a href="#l1.4308"></a><span id="l1.4308" class="difflineminus">-    // get the old junk score</span>
<a href="#l1.4309"></a><span id="l1.4309" class="difflineminus">-    //</span>
<a href="#l1.4310"></a><span id="l1.4310" class="difflineplus">+nsresult</span>
<a href="#l1.4311"></a><span id="l1.4311" class="difflineplus">+nsMsgDBView::SetMsgHdrJunkStatus(nsIJunkMailPlugin *aJunkPlugin,</span>
<a href="#l1.4312"></a><span id="l1.4312" class="difflineplus">+                                 nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l1.4313"></a><span id="l1.4313" class="difflineplus">+                                 nsMsgJunkStatus aNewClassification)</span>
<a href="#l1.4314"></a><span id="l1.4314" class="difflineplus">+{</span>
<a href="#l1.4315"></a><span id="l1.4315" class="difflineplus">+    // Get the old junk score.</span>
<a href="#l1.4316"></a><span id="l1.4316">     nsCString junkScoreStr;</span>
<a href="#l1.4317"></a><span id="l1.4317">     nsresult rv = aMsgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l1.4318"></a><span id="l1.4318"> </span>
<a href="#l1.4319"></a><span id="l1.4319" class="difflineminus">-    // and the old origin</span>
<a href="#l1.4320"></a><span id="l1.4320" class="difflineminus">-    //</span>
<a href="#l1.4321"></a><span id="l1.4321" class="difflineplus">+    // And the old origin.</span>
<a href="#l1.4322"></a><span id="l1.4322">     nsCString oldOriginStr;</span>
<a href="#l1.4323"></a><span id="l1.4323" class="difflineminus">-    rv = aMsgHdr-&gt;GetStringProperty(&quot;junkscoreorigin&quot;,</span>
<a href="#l1.4324"></a><span id="l1.4324" class="difflineminus">-                                   getter_Copies(oldOriginStr));</span>
<a href="#l1.4325"></a><span id="l1.4325" class="difflineminus">-</span>
<a href="#l1.4326"></a><span id="l1.4326" class="difflineminus">-    // if this was not classified by the user, say so</span>
<a href="#l1.4327"></a><span id="l1.4327" class="difflineminus">-    //</span>
<a href="#l1.4328"></a><span id="l1.4328" class="difflineplus">+    rv = aMsgHdr-&gt;GetStringProperty(&quot;junkscoreorigin&quot;, getter_Copies(oldOriginStr));</span>
<a href="#l1.4329"></a><span id="l1.4329" class="difflineplus">+</span>
<a href="#l1.4330"></a><span id="l1.4330" class="difflineplus">+    // If this was not classified by the user, say so.</span>
<a href="#l1.4331"></a><span id="l1.4331">     nsMsgJunkStatus oldUserClassification;</span>
<a href="#l1.4332"></a><span id="l1.4332" class="difflineminus">-    if (oldOriginStr.get()[0] != 'u') {</span>
<a href="#l1.4333"></a><span id="l1.4333" class="difflineplus">+    if (oldOriginStr.get()[0] != 'u')</span>
<a href="#l1.4334"></a><span id="l1.4334" class="difflineplus">+    {</span>
<a href="#l1.4335"></a><span id="l1.4335" class="difflineplus">+      oldUserClassification = nsIJunkMailPlugin::UNCLASSIFIED;</span>
<a href="#l1.4336"></a><span id="l1.4336" class="difflineplus">+    }</span>
<a href="#l1.4337"></a><span id="l1.4337" class="difflineplus">+    else</span>
<a href="#l1.4338"></a><span id="l1.4338" class="difflineplus">+    {</span>
<a href="#l1.4339"></a><span id="l1.4339" class="difflineplus">+      // Otherwise, pass the actual user classification.</span>
<a href="#l1.4340"></a><span id="l1.4340" class="difflineplus">+      if (junkScoreStr.IsEmpty())</span>
<a href="#l1.4341"></a><span id="l1.4341">         oldUserClassification = nsIJunkMailPlugin::UNCLASSIFIED;</span>
<a href="#l1.4342"></a><span id="l1.4342" class="difflineminus">-    }</span>
<a href="#l1.4343"></a><span id="l1.4343" class="difflineminus">-    else {</span>
<a href="#l1.4344"></a><span id="l1.4344" class="difflineminus">-        // otherwise, pass the actual user classification</span>
<a href="#l1.4345"></a><span id="l1.4345" class="difflineminus">-        if (junkScoreStr.IsEmpty())</span>
<a href="#l1.4346"></a><span id="l1.4346" class="difflineminus">-          oldUserClassification = nsIJunkMailPlugin::UNCLASSIFIED;</span>
<a href="#l1.4347"></a><span id="l1.4347" class="difflineminus">-        else if (junkScoreStr.ToInteger(&amp;rv) == nsIJunkMailPlugin::IS_SPAM_SCORE)</span>
<a href="#l1.4348"></a><span id="l1.4348" class="difflineminus">-          oldUserClassification = nsIJunkMailPlugin::JUNK;</span>
<a href="#l1.4349"></a><span id="l1.4349" class="difflineminus">-        else</span>
<a href="#l1.4350"></a><span id="l1.4350" class="difflineminus">-          oldUserClassification = nsIJunkMailPlugin::GOOD;</span>
<a href="#l1.4351"></a><span id="l1.4351" class="difflineminus">-</span>
<a href="#l1.4352"></a><span id="l1.4352" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Converting junkScore to integer failed.&quot;);</span>
<a href="#l1.4353"></a><span id="l1.4353" class="difflineminus">-    }</span>
<a href="#l1.4354"></a><span id="l1.4354" class="difflineminus">-</span>
<a href="#l1.4355"></a><span id="l1.4355" class="difflineminus">-    // get the URI for this message so we can pass it to the plugin</span>
<a href="#l1.4356"></a><span id="l1.4356" class="difflineminus">-    //</span>
<a href="#l1.4357"></a><span id="l1.4357" class="difflineplus">+      else if (junkScoreStr.ToInteger(&amp;rv) == nsIJunkMailPlugin::IS_SPAM_SCORE)</span>
<a href="#l1.4358"></a><span id="l1.4358" class="difflineplus">+        oldUserClassification = nsIJunkMailPlugin::JUNK;</span>
<a href="#l1.4359"></a><span id="l1.4359" class="difflineplus">+      else</span>
<a href="#l1.4360"></a><span id="l1.4360" class="difflineplus">+        oldUserClassification = nsIJunkMailPlugin::GOOD;</span>
<a href="#l1.4361"></a><span id="l1.4361" class="difflineplus">+</span>
<a href="#l1.4362"></a><span id="l1.4362" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Converting junkScore to integer failed.&quot;);</span>
<a href="#l1.4363"></a><span id="l1.4363" class="difflineplus">+    }</span>
<a href="#l1.4364"></a><span id="l1.4364" class="difflineplus">+</span>
<a href="#l1.4365"></a><span id="l1.4365" class="difflineplus">+    // Get the URI for this message so we can pass it to the plugin.</span>
<a href="#l1.4366"></a><span id="l1.4366">     nsCString uri;</span>
<a href="#l1.4367"></a><span id="l1.4367">     nsMsgKey msgKey;</span>
<a href="#l1.4368"></a><span id="l1.4368">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.4369"></a><span id="l1.4369">     nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.4370"></a><span id="l1.4370">     aMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.4371"></a><span id="l1.4371">     rv = aMsgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l1.4372"></a><span id="l1.4372">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4373"></a><span id="l1.4373">     GenerateURIForMsgKey(msgKey, folder, uri);</span>
<a href="#l1.4374"></a><span id="l1.4374">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4375"></a><span id="l1.4375">     rv = folder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l1.4376"></a><span id="l1.4376">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4377"></a><span id="l1.4377"> </span>
<a href="#l1.4378"></a><span id="l1.4378" class="difflineminus">-    // tell the plugin about this change, so that it can (potentially)</span>
<a href="#l1.4379"></a><span id="l1.4379" class="difflineminus">-    // adjust its database appropriately</span>
<a href="#l1.4380"></a><span id="l1.4380" class="difflineplus">+    // Tell the plugin about this change, so that it can (potentially)</span>
<a href="#l1.4381"></a><span id="l1.4381" class="difflineplus">+    // adjust its database appropriately.</span>
<a href="#l1.4382"></a><span id="l1.4382">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l1.4383"></a><span id="l1.4383" class="difflineminus">-    rv = aJunkPlugin-&gt;SetMessageClassification(</span>
<a href="#l1.4384"></a><span id="l1.4384" class="difflineminus">-        uri.get(), oldUserClassification, aNewClassification, msgWindow, this);</span>
<a href="#l1.4385"></a><span id="l1.4385" class="difflineplus">+    rv = aJunkPlugin-&gt;SetMessageClassification(uri.get(),</span>
<a href="#l1.4386"></a><span id="l1.4386" class="difflineplus">+                                               oldUserClassification,</span>
<a href="#l1.4387"></a><span id="l1.4387" class="difflineplus">+                                               aNewClassification,</span>
<a href="#l1.4388"></a><span id="l1.4388" class="difflineplus">+                                               msgWindow,</span>
<a href="#l1.4389"></a><span id="l1.4389" class="difflineplus">+                                               this);</span>
<a href="#l1.4390"></a><span id="l1.4390">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4391"></a><span id="l1.4391"> </span>
<a href="#l1.4392"></a><span id="l1.4392" class="difflineminus">-    // this routine is only reached if the user someone touched the UI</span>
<a href="#l1.4393"></a><span id="l1.4393" class="difflineplus">+    // This routine is only reached if the user someone touched the UI</span>
<a href="#l1.4394"></a><span id="l1.4394">     // and told us the junk status of this message.</span>
<a href="#l1.4395"></a><span id="l1.4395">     // Set origin first so that listeners on the junkscore will</span>
<a href="#l1.4396"></a><span id="l1.4396">     // know the correct origin.</span>
<a href="#l1.4397"></a><span id="l1.4397">     rv = db-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;user&quot;);</span>
<a href="#l1.4398"></a><span id="l1.4398">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;SetStringPropertyByIndex failed&quot;);</span>
<a href="#l1.4399"></a><span id="l1.4399"> </span>
<a href="#l1.4400"></a><span id="l1.4400" class="difflineminus">-    // set the junk score on the message itself</span>
<a href="#l1.4401"></a><span id="l1.4401" class="difflineminus">-</span>
<a href="#l1.4402"></a><span id="l1.4402" class="difflineplus">+    // Set the junk score on the message itself.</span>
<a href="#l1.4403"></a><span id="l1.4403">     nsAutoCString msgJunkScore;</span>
<a href="#l1.4404"></a><span id="l1.4404">     msgJunkScore.AppendInt(aNewClassification == nsIJunkMailPlugin::JUNK ?</span>
<a href="#l1.4405"></a><span id="l1.4405" class="difflineminus">-          nsIJunkMailPlugin::IS_SPAM_SCORE:</span>
<a href="#l1.4406"></a><span id="l1.4406" class="difflineminus">-          nsIJunkMailPlugin::IS_HAM_SCORE);</span>
<a href="#l1.4407"></a><span id="l1.4407" class="difflineplus">+                             nsIJunkMailPlugin::IS_SPAM_SCORE :</span>
<a href="#l1.4408"></a><span id="l1.4408" class="difflineplus">+                             nsIJunkMailPlugin::IS_HAM_SCORE);</span>
<a href="#l1.4409"></a><span id="l1.4409">     db-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, msgJunkScore.get());</span>
<a href="#l1.4410"></a><span id="l1.4410">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4411"></a><span id="l1.4411"> </span>
<a href="#l1.4412"></a><span id="l1.4412">     return rv;</span>
<a href="#l1.4413"></a><span id="l1.4413"> }</span>
<a href="#l1.4414"></a><span id="l1.4414"> </span>
<a href="#l1.4415"></a><span id="l1.4415"> nsresult</span>
<a href="#l1.4416"></a><span id="l1.4416" class="difflineminus">-nsMsgDBView::GetFolderFromMsgURI(const char *aMsgURI, nsIMsgFolder **aFolder)</span>
<a href="#l1.4417"></a><span id="l1.4417" class="difflineplus">+nsMsgDBView::GetFolderFromMsgURI(const char *aMsgURI,</span>
<a href="#l1.4418"></a><span id="l1.4418" class="difflineplus">+                                 nsIMsgFolder **aFolder)</span>
<a href="#l1.4419"></a><span id="l1.4419"> {</span>
<a href="#l1.4420"></a><span id="l1.4420">   NS_IF_ADDREF(*aFolder = m_folder);</span>
<a href="#l1.4421"></a><span id="l1.4421">   return NS_OK;</span>
<a href="#l1.4422"></a><span id="l1.4422"> }</span>
<a href="#l1.4423"></a><span id="l1.4423"> </span>
<a href="#l1.4424"></a><span id="l1.4424"> NS_IMETHODIMP</span>
<a href="#l1.4425"></a><span id="l1.4425"> nsMsgDBView::OnMessageClassified(const char *aMsgURI,</span>
<a href="#l1.4426"></a><span id="l1.4426">                                  nsMsgJunkStatus aClassification,</span>
<a href="#l1.4427"></a><span id="l1.4427" class="difflineat">@@ -3477,34 +3873,33 @@ nsMsgDBView::OnMessageClassified(const c</span>
<a href="#l1.4428"></a><span id="l1.4428">   // classification, since unlike OnMessageClassified</span>
<a href="#l1.4429"></a><span id="l1.4429">   // methods in other classes (such as nsLocalMailFolder</span>
<a href="#l1.4430"></a><span id="l1.4430">   // and nsImapMailFolder), this class, nsMsgDBView, currently</span>
<a href="#l1.4431"></a><span id="l1.4431">   // only triggers message classifications due to a command to</span>
<a href="#l1.4432"></a><span id="l1.4432">   // mark some of the messages in the view as junk, or as not</span>
<a href="#l1.4433"></a><span id="l1.4433">   // junk - so the classification is dictated to the filter,</span>
<a href="#l1.4434"></a><span id="l1.4434">   // not suggested by it.</span>
<a href="#l1.4435"></a><span id="l1.4435">   //</span>
<a href="#l1.4436"></a><span id="l1.4436" class="difflineminus">-  // for this reason the only thing we (may) have to do is</span>
<a href="#l1.4437"></a><span id="l1.4437" class="difflineminus">-  // perform the action on all of the junk messages</span>
<a href="#l1.4438"></a><span id="l1.4438" class="difflineminus">-  //</span>
<a href="#l1.4439"></a><span id="l1.4439" class="difflineplus">+  // For this reason the only thing we (may) have to do is</span>
<a href="#l1.4440"></a><span id="l1.4440" class="difflineplus">+  // perform the action on all of the junk messages.</span>
<a href="#l1.4441"></a><span id="l1.4441"> </span>
<a href="#l1.4442"></a><span id="l1.4442">   uint32_t numJunk;</span>
<a href="#l1.4443"></a><span id="l1.4443">   mJunkHdrs-&gt;GetLength(&amp;numJunk);</span>
<a href="#l1.4444"></a><span id="l1.4444" class="difflineminus">-  NS_ASSERTION((aClassification == nsIJunkMailPlugin::GOOD) ||</span>
<a href="#l1.4445"></a><span id="l1.4445" class="difflineminus">-                numJunk,</span>
<a href="#l1.4446"></a><span id="l1.4446" class="difflineminus">-                &quot;the classification of a manually-marked junk message has&quot;</span>
<a href="#l1.4447"></a><span id="l1.4447" class="difflineminus">-                &quot;been classified as junk, yet there seem to be no such outstanding messages&quot;);</span>
<a href="#l1.4448"></a><span id="l1.4448" class="difflineminus">-</span>
<a href="#l1.4449"></a><span id="l1.4449" class="difflineminus">-  // is this the last message in the batch?</span>
<a href="#l1.4450"></a><span id="l1.4450" class="difflineminus">-</span>
<a href="#l1.4451"></a><span id="l1.4451" class="difflineplus">+  NS_ASSERTION(aClassification == nsIJunkMailPlugin::GOOD || numJunk,</span>
<a href="#l1.4452"></a><span id="l1.4452" class="difflineplus">+               &quot;the classification of a manually-marked junk message has &quot;</span>
<a href="#l1.4453"></a><span id="l1.4453" class="difflineplus">+               &quot;been classified as junk, yet there seem to be no such &quot;</span>
<a href="#l1.4454"></a><span id="l1.4454" class="difflineplus">+               &quot;outstanding messages&quot;);</span>
<a href="#l1.4455"></a><span id="l1.4455" class="difflineplus">+</span>
<a href="#l1.4456"></a><span id="l1.4456" class="difflineplus">+  // Is this the last message in the batch?</span>
<a href="#l1.4457"></a><span id="l1.4457">   if (--mNumMessagesRemainingInBatch == 0 &amp;&amp; numJunk &gt; 0)</span>
<a href="#l1.4458"></a><span id="l1.4458">   {</span>
<a href="#l1.4459"></a><span id="l1.4459">     PerformActionsOnJunkMsgs(aClassification == nsIJunkMailPlugin::JUNK);</span>
<a href="#l1.4460"></a><span id="l1.4460">     mJunkHdrs-&gt;Clear();</span>
<a href="#l1.4461"></a><span id="l1.4461">   }</span>
<a href="#l1.4462"></a><span id="l1.4462" class="difflineplus">+</span>
<a href="#l1.4463"></a><span id="l1.4463">   return NS_OK;</span>
<a href="#l1.4464"></a><span id="l1.4464"> }</span>
<a href="#l1.4465"></a><span id="l1.4465"> </span>
<a href="#l1.4466"></a><span id="l1.4466"> nsresult</span>
<a href="#l1.4467"></a><span id="l1.4467"> nsMsgDBView::PerformActionsOnJunkMsgs(bool msgsAreJunk)</span>
<a href="#l1.4468"></a><span id="l1.4468"> {</span>
<a href="#l1.4469"></a><span id="l1.4469">   uint32_t numJunkHdrs;</span>
<a href="#l1.4470"></a><span id="l1.4470">   mJunkHdrs-&gt;GetLength(&amp;numJunkHdrs);</span>
<a href="#l1.4471"></a><span id="l1.4471" class="difflineat">@@ -3521,200 +3916,210 @@ nsMsgDBView::PerformActionsOnJunkMsgs(bo</span>
<a href="#l1.4472"></a><span id="l1.4472">   bool moveMessages, changeReadState;</span>
<a href="#l1.4473"></a><span id="l1.4473">   nsCOMPtr&lt;nsIMsgFolder&gt; targetFolder;</span>
<a href="#l1.4474"></a><span id="l1.4474"> </span>
<a href="#l1.4475"></a><span id="l1.4475">   nsresult rv = DetermineActionsForJunkChange(msgsAreJunk, srcFolder,</span>
<a href="#l1.4476"></a><span id="l1.4476">                                               moveMessages, changeReadState,</span>
<a href="#l1.4477"></a><span id="l1.4477">                                               getter_AddRefs(targetFolder));</span>
<a href="#l1.4478"></a><span id="l1.4478">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.4479"></a><span id="l1.4479"> </span>
<a href="#l1.4480"></a><span id="l1.4480" class="difflineminus">-  // nothing to do, bail out</span>
<a href="#l1.4481"></a><span id="l1.4481" class="difflineplus">+  // Nothing to do, bail out.</span>
<a href="#l1.4482"></a><span id="l1.4482">   if (!(moveMessages || changeReadState))</span>
<a href="#l1.4483"></a><span id="l1.4483">     return NS_OK;</span>
<a href="#l1.4484"></a><span id="l1.4484" class="difflineplus">+</span>
<a href="#l1.4485"></a><span id="l1.4485">   if (changeReadState)</span>
<a href="#l1.4486"></a><span id="l1.4486">   {</span>
<a href="#l1.4487"></a><span id="l1.4487" class="difflineminus">-    // notes on marking junk as read:</span>
<a href="#l1.4488"></a><span id="l1.4488" class="difflineminus">-    // 1. there are 2 occasions on which junk messages are marked as</span>
<a href="#l1.4489"></a><span id="l1.4489" class="difflineplus">+    // Notes on marking junk as read:</span>
<a href="#l1.4490"></a><span id="l1.4490" class="difflineplus">+    // 1. There are 2 occasions on which junk messages are marked as</span>
<a href="#l1.4491"></a><span id="l1.4491">     //    read: after a manual marking (here and in the front end) and after</span>
<a href="#l1.4492"></a><span id="l1.4492">     //    automatic classification by the bayesian filter (see code for local</span>
<a href="#l1.4493"></a><span id="l1.4493">     //    mail folders and for imap mail folders). The server-specific</span>
<a href="#l1.4494"></a><span id="l1.4494">     //    markAsReadOnSpam pref only applies to the latter, the former is</span>
<a href="#l1.4495"></a><span id="l1.4495">     //    controlled by &quot;mailnews.ui.junk.manualMarkAsJunkMarksRead&quot;.</span>
<a href="#l1.4496"></a><span id="l1.4496" class="difflineminus">-    // 2. even though move/delete on manual mark may be</span>
<a href="#l1.4497"></a><span id="l1.4497" class="difflineminus">-    //    turned off, we might still need to mark as read</span>
<a href="#l1.4498"></a><span id="l1.4498" class="difflineplus">+    // 2. Even though move/delete on manual mark may be</span>
<a href="#l1.4499"></a><span id="l1.4499" class="difflineplus">+    //    turned off, we might still need to mark as read.</span>
<a href="#l1.4500"></a><span id="l1.4500"> </span>
<a href="#l1.4501"></a><span id="l1.4501">     NoteStartChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.4502"></a><span id="l1.4502">     rv = srcFolder-&gt;MarkMessagesRead(mJunkHdrs, msgsAreJunk);</span>
<a href="#l1.4503"></a><span id="l1.4503">     NoteEndChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.4504"></a><span id="l1.4504">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;marking marked-as-junk messages as read failed&quot;);</span>
<a href="#l1.4505"></a><span id="l1.4505">   }</span>
<a href="#l1.4506"></a><span id="l1.4506" class="difflineplus">+</span>
<a href="#l1.4507"></a><span id="l1.4507">   if (moveMessages)</span>
<a href="#l1.4508"></a><span id="l1.4508">   {</span>
<a href="#l1.4509"></a><span id="l1.4509" class="difflineminus">-    // check if one of the messages to be junked is actually selected</span>
<a href="#l1.4510"></a><span id="l1.4510" class="difflineminus">-    // if more than one message being junked, one must be selected.</span>
<a href="#l1.4511"></a><span id="l1.4511" class="difflineminus">-    // if no tree selection at all, must be in stand-alone message window.</span>
<a href="#l1.4512"></a><span id="l1.4512" class="difflineplus">+    // Check if one of the messages to be junked is actually selected.</span>
<a href="#l1.4513"></a><span id="l1.4513" class="difflineplus">+    // If more than one message being junked, one must be selected.</span>
<a href="#l1.4514"></a><span id="l1.4514" class="difflineplus">+    // If no tree selection at all, must be in stand-alone message window.</span>
<a href="#l1.4515"></a><span id="l1.4515">     bool junkedMsgSelected = numJunkHdrs &gt; 1 || !mTreeSelection;</span>
<a href="#l1.4516"></a><span id="l1.4516" class="difflineminus">-    for (nsMsgViewIndex junkIndex = 0; !junkedMsgSelected &amp;&amp; junkIndex &lt; numJunkHdrs; junkIndex++)</span>
<a href="#l1.4517"></a><span id="l1.4517" class="difflineplus">+    for (nsMsgViewIndex junkIndex = 0;</span>
<a href="#l1.4518"></a><span id="l1.4518" class="difflineplus">+         !junkedMsgSelected &amp;&amp; junkIndex &lt; numJunkHdrs;</span>
<a href="#l1.4519"></a><span id="l1.4519" class="difflineplus">+         junkIndex++)</span>
<a href="#l1.4520"></a><span id="l1.4520">     {</span>
<a href="#l1.4521"></a><span id="l1.4521">       nsCOMPtr&lt;nsIMsgDBHdr&gt; junkHdr(do_QueryElementAt(mJunkHdrs, junkIndex, &amp;rv));</span>
<a href="#l1.4522"></a><span id="l1.4522">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4523"></a><span id="l1.4523">       nsMsgViewIndex hdrIndex = FindHdr(junkHdr);</span>
<a href="#l1.4524"></a><span id="l1.4524">       if (hdrIndex != nsMsgViewIndex_None)</span>
<a href="#l1.4525"></a><span id="l1.4525">         mTreeSelection-&gt;IsSelected(hdrIndex, &amp;junkedMsgSelected);</span>
<a href="#l1.4526"></a><span id="l1.4526">     }</span>
<a href="#l1.4527"></a><span id="l1.4527"> </span>
<a href="#l1.4528"></a><span id="l1.4528" class="difflineminus">-    // if a junked msg is selected, tell the FE to call SetNextMessageAfterDelete() because a delete is coming</span>
<a href="#l1.4529"></a><span id="l1.4529" class="difflineplus">+    // If a junked msg is selected, tell the FE to call</span>
<a href="#l1.4530"></a><span id="l1.4530" class="difflineplus">+    // SetNextMessageAfterDelete() because a delete is coming.</span>
<a href="#l1.4531"></a><span id="l1.4531">     if (junkedMsgSelected &amp;&amp; mCommandUpdater)</span>
<a href="#l1.4532"></a><span id="l1.4532">     {</span>
<a href="#l1.4533"></a><span id="l1.4533">       rv = mCommandUpdater-&gt;UpdateNextMessageAfterDelete();</span>
<a href="#l1.4534"></a><span id="l1.4534">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.4535"></a><span id="l1.4535">     }</span>
<a href="#l1.4536"></a><span id="l1.4536"> </span>
<a href="#l1.4537"></a><span id="l1.4537">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l1.4538"></a><span id="l1.4538">     NoteStartChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.4539"></a><span id="l1.4539">     if (targetFolder)</span>
<a href="#l1.4540"></a><span id="l1.4540">     {</span>
<a href="#l1.4541"></a><span id="l1.4541" class="difflineminus">-      nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.4542"></a><span id="l1.4542" class="difflineplus">+      nsCOMPtr&lt;nsIMsgCopyService&gt; copyService =</span>
<a href="#l1.4543"></a><span id="l1.4543" class="difflineplus">+        do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.4544"></a><span id="l1.4544" class="difflineplus">+</span>
<a href="#l1.4545"></a><span id="l1.4545">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4546"></a><span id="l1.4546"> </span>
<a href="#l1.4547"></a><span id="l1.4547">       rv = copyService-&gt;CopyMessages(srcFolder , mJunkHdrs, targetFolder,</span>
<a href="#l1.4548"></a><span id="l1.4548">                                      true, nullptr, msgWindow, true);</span>
<a href="#l1.4549"></a><span id="l1.4549">     }</span>
<a href="#l1.4550"></a><span id="l1.4550">     else if (msgsAreJunk)</span>
<a href="#l1.4551"></a><span id="l1.4551">     {</span>
<a href="#l1.4552"></a><span id="l1.4552">       if (mDeleteModel == nsMsgImapDeleteModels::IMAPDelete)</span>
<a href="#l1.4553"></a><span id="l1.4553">       {</span>
<a href="#l1.4554"></a><span id="l1.4554" class="difflineminus">-        // Unfortunately the DeleteMessages in this case is interpreted by IMAP as</span>
<a href="#l1.4555"></a><span id="l1.4555" class="difflineminus">-        //  a delete toggle. So what we have to do is to assemble a new delete</span>
<a href="#l1.4556"></a><span id="l1.4556" class="difflineminus">-        //  array, keeping only those that are not deleted.</span>
<a href="#l1.4557"></a><span id="l1.4557" class="difflineminus">-        //</span>
<a href="#l1.4558"></a><span id="l1.4558" class="difflineminus">-        nsCOMPtr&lt;nsIMutableArray&gt; hdrsToDelete = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l1.4559"></a><span id="l1.4559" class="difflineplus">+        // Unfortunately the DeleteMessages in this case is interpreted by</span>
<a href="#l1.4560"></a><span id="l1.4560" class="difflineplus">+        // IMAP as a delete toggle. So what we have to do is to assemble a</span>
<a href="#l1.4561"></a><span id="l1.4561" class="difflineplus">+        // new delete array, keeping only those that are not deleted.</span>
<a href="#l1.4562"></a><span id="l1.4562" class="difflineplus">+        nsCOMPtr&lt;nsIMutableArray&gt; hdrsToDelete =</span>
<a href="#l1.4563"></a><span id="l1.4563" class="difflineplus">+          do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l1.4564"></a><span id="l1.4564" class="difflineplus">+</span>
<a href="#l1.4565"></a><span id="l1.4565">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4566"></a><span id="l1.4566">         uint32_t cnt;</span>
<a href="#l1.4567"></a><span id="l1.4567">         rv = mJunkHdrs-&gt;GetLength(&amp;cnt);</span>
<a href="#l1.4568"></a><span id="l1.4568">         for (uint32_t i = 0; i &lt; cnt; i++)</span>
<a href="#l1.4569"></a><span id="l1.4569">         {</span>
<a href="#l1.4570"></a><span id="l1.4570">           nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(mJunkHdrs, i);</span>
<a href="#l1.4571"></a><span id="l1.4571">           if (msgHdr)</span>
<a href="#l1.4572"></a><span id="l1.4572">           {</span>
<a href="#l1.4573"></a><span id="l1.4573">             uint32_t flags;</span>
<a href="#l1.4574"></a><span id="l1.4574">             msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.4575"></a><span id="l1.4575">             if (!(flags &amp; nsMsgMessageFlags::IMAPDeleted))</span>
<a href="#l1.4576"></a><span id="l1.4576">               hdrsToDelete-&gt;AppendElement(msgHdr, false);</span>
<a href="#l1.4577"></a><span id="l1.4577">           }</span>
<a href="#l1.4578"></a><span id="l1.4578">         }</span>
<a href="#l1.4579"></a><span id="l1.4579" class="difflineplus">+</span>
<a href="#l1.4580"></a><span id="l1.4580">         hdrsToDelete-&gt;GetLength(&amp;cnt);</span>
<a href="#l1.4581"></a><span id="l1.4581">         if (cnt)</span>
<a href="#l1.4582"></a><span id="l1.4582">           rv = srcFolder-&gt;DeleteMessages(hdrsToDelete, msgWindow, false, false,</span>
<a href="#l1.4583"></a><span id="l1.4583">                                          nullptr, true);</span>
<a href="#l1.4584"></a><span id="l1.4584">       }</span>
<a href="#l1.4585"></a><span id="l1.4585">       else</span>
<a href="#l1.4586"></a><span id="l1.4586" class="difflineplus">+      {</span>
<a href="#l1.4587"></a><span id="l1.4587">         rv = srcFolder-&gt;DeleteMessages(mJunkHdrs, msgWindow, false, false,</span>
<a href="#l1.4588"></a><span id="l1.4588">                                        nullptr, true);</span>
<a href="#l1.4589"></a><span id="l1.4589" class="difflineminus">-</span>
<a href="#l1.4590"></a><span id="l1.4590" class="difflineplus">+      }</span>
<a href="#l1.4591"></a><span id="l1.4591">     }</span>
<a href="#l1.4592"></a><span id="l1.4592">     else if (mDeleteModel == nsMsgImapDeleteModels::IMAPDelete)</span>
<a href="#l1.4593"></a><span id="l1.4593">     {</span>
<a href="#l1.4594"></a><span id="l1.4594">       nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder(do_QueryInterface(srcFolder));</span>
<a href="#l1.4595"></a><span id="l1.4595">       nsTArray&lt;nsMsgKey&gt; imapUids;</span>
<a href="#l1.4596"></a><span id="l1.4596">       imapUids.SetLength(numJunkHdrs);</span>
<a href="#l1.4597"></a><span id="l1.4597">       for (uint32_t i = 0; i &lt; numJunkHdrs; i++)</span>
<a href="#l1.4598"></a><span id="l1.4598">       {</span>
<a href="#l1.4599"></a><span id="l1.4599">         nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(mJunkHdrs, i);</span>
<a href="#l1.4600"></a><span id="l1.4600">         msgHdr-&gt;GetMessageKey(&amp;imapUids[i]);</span>
<a href="#l1.4601"></a><span id="l1.4601">       }</span>
<a href="#l1.4602"></a><span id="l1.4602"> </span>
<a href="#l1.4603"></a><span id="l1.4603">       imapFolder-&gt;StoreImapFlags(kImapMsgDeletedFlag, false, imapUids.Elements(),</span>
<a href="#l1.4604"></a><span id="l1.4604">                                  imapUids.Length(), nullptr);</span>
<a href="#l1.4605"></a><span id="l1.4605">     }</span>
<a href="#l1.4606"></a><span id="l1.4606" class="difflineplus">+</span>
<a href="#l1.4607"></a><span id="l1.4607">     NoteEndChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.4608"></a><span id="l1.4608"> </span>
<a href="#l1.4609"></a><span id="l1.4609" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;move or deletion of message marked-as-junk/non junk failed&quot;);</span>
<a href="#l1.4610"></a><span id="l1.4610" class="difflineminus">-  }</span>
<a href="#l1.4611"></a><span id="l1.4611" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l1.4612"></a><span id="l1.4612" class="difflineplus">+                 &quot;move or deletion of message marked-as-junk/non junk failed&quot;);</span>
<a href="#l1.4613"></a><span id="l1.4613" class="difflineplus">+  }</span>
<a href="#l1.4614"></a><span id="l1.4614" class="difflineplus">+</span>
<a href="#l1.4615"></a><span id="l1.4615">   return rv;</span>
<a href="#l1.4616"></a><span id="l1.4616"> }</span>
<a href="#l1.4617"></a><span id="l1.4617"> </span>
<a href="#l1.4618"></a><span id="l1.4618"> nsresult</span>
<a href="#l1.4619"></a><span id="l1.4619"> nsMsgDBView::DetermineActionsForJunkChange(bool msgsAreJunk,</span>
<a href="#l1.4620"></a><span id="l1.4620">                                            nsIMsgFolder *srcFolder,</span>
<a href="#l1.4621"></a><span id="l1.4621">                                            bool &amp;moveMessages,</span>
<a href="#l1.4622"></a><span id="l1.4622">                                            bool &amp;changeReadState,</span>
<a href="#l1.4623"></a><span id="l1.4623">                                            nsIMsgFolder** targetFolder)</span>
<a href="#l1.4624"></a><span id="l1.4624"> {</span>
<a href="#l1.4625"></a><span id="l1.4625" class="difflineminus">-  // there are two possible actions which may be performed</span>
<a href="#l1.4626"></a><span id="l1.4626" class="difflineplus">+  // There are two possible actions which may be performed</span>
<a href="#l1.4627"></a><span id="l1.4627">   // on messages marked as spam: marking as read and moving</span>
<a href="#l1.4628"></a><span id="l1.4628" class="difflineminus">-  // somewhere...When a message is marked as non junk,</span>
<a href="#l1.4629"></a><span id="l1.4629" class="difflineplus">+  // somewhere. When a message is marked as non junk,</span>
<a href="#l1.4630"></a><span id="l1.4630">   // it may be moved to the inbox, and marked unread.</span>
<a href="#l1.4631"></a><span id="l1.4631" class="difflineminus">-</span>
<a href="#l1.4632"></a><span id="l1.4632">   moveMessages = false;</span>
<a href="#l1.4633"></a><span id="l1.4633">   changeReadState = false;</span>
<a href="#l1.4634"></a><span id="l1.4634"> </span>
<a href="#l1.4635"></a><span id="l1.4635" class="difflineminus">-  // ... the 'somewhere', junkTargetFolder, can be a folder,</span>
<a href="#l1.4636"></a><span id="l1.4636" class="difflineminus">-  // but if it remains null we'll delete the messages</span>
<a href="#l1.4637"></a><span id="l1.4637" class="difflineminus">-</span>
<a href="#l1.4638"></a><span id="l1.4638" class="difflineplus">+  // The 'somewhere', junkTargetFolder, can be a folder,</span>
<a href="#l1.4639"></a><span id="l1.4639" class="difflineplus">+  // but if it remains null we'll delete the messages.</span>
<a href="#l1.4640"></a><span id="l1.4640">   *targetFolder = nullptr;</span>
<a href="#l1.4641"></a><span id="l1.4641"> </span>
<a href="#l1.4642"></a><span id="l1.4642">   uint32_t folderFlags;</span>
<a href="#l1.4643"></a><span id="l1.4643">   srcFolder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l1.4644"></a><span id="l1.4644"> </span>
<a href="#l1.4645"></a><span id="l1.4645">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.4646"></a><span id="l1.4646">   nsresult rv = srcFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.4647"></a><span id="l1.4647">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4648"></a><span id="l1.4648"> </span>
<a href="#l1.4649"></a><span id="l1.4649">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.4650"></a><span id="l1.4650">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4651"></a><span id="l1.4651"> </span>
<a href="#l1.4652"></a><span id="l1.4652" class="difflineminus">-  // handle the easy case of marking a junk message as good first...</span>
<a href="#l1.4653"></a><span id="l1.4653" class="difflineminus">-  // set the move target folder to the inbox, if any.</span>
<a href="#l1.4654"></a><span id="l1.4654" class="difflineplus">+  // Handle the easy case of marking a junk message as good first.</span>
<a href="#l1.4655"></a><span id="l1.4655" class="difflineplus">+  // Set the move target folder to the inbox, if any.</span>
<a href="#l1.4656"></a><span id="l1.4656">   if (!msgsAreJunk)</span>
<a href="#l1.4657"></a><span id="l1.4657">   {</span>
<a href="#l1.4658"></a><span id="l1.4658">     if (folderFlags &amp; nsMsgFolderFlags::Junk)</span>
<a href="#l1.4659"></a><span id="l1.4659">     {</span>
<a href="#l1.4660"></a><span id="l1.4660">       prefBranch-&gt;GetBoolPref(&quot;mail.spam.markAsNotJunkMarksUnRead&quot;,</span>
<a href="#l1.4661"></a><span id="l1.4661">                               &amp;changeReadState);</span>
<a href="#l1.4662"></a><span id="l1.4662">       nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l1.4663"></a><span id="l1.4663">       rv = server-&gt;GetRootMsgFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l1.4664"></a><span id="l1.4664">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.4665"></a><span id="l1.4665">       rootMsgFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox, targetFolder);</span>
<a href="#l1.4666"></a><span id="l1.4666">       moveMessages = targetFolder != nullptr;</span>
<a href="#l1.4667"></a><span id="l1.4667">     }</span>
<a href="#l1.4668"></a><span id="l1.4668" class="difflineplus">+</span>
<a href="#l1.4669"></a><span id="l1.4669">     return NS_OK;</span>
<a href="#l1.4670"></a><span id="l1.4670">   }</span>
<a href="#l1.4671"></a><span id="l1.4671"> </span>
<a href="#l1.4672"></a><span id="l1.4672">   nsCOMPtr &lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l1.4673"></a><span id="l1.4673">   rv = server-&gt;GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l1.4674"></a><span id="l1.4674">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4675"></a><span id="l1.4675"> </span>
<a href="#l1.4676"></a><span id="l1.4676">   // When the user explicitly marks a message as junk, we can mark it as read,</span>
<a href="#l1.4677"></a><span id="l1.4677">   // too. This is independent of the &quot;markAsReadOnSpam&quot; pref, which applies</span>
<a href="#l1.4678"></a><span id="l1.4678">   // only to automatically-classified messages.</span>
<a href="#l1.4679"></a><span id="l1.4679">   // Note that this behaviour should match the one in the front end for marking</span>
<a href="#l1.4680"></a><span id="l1.4680">   // as junk via toolbar/context menu.</span>
<a href="#l1.4681"></a><span id="l1.4681">   prefBranch-&gt;GetBoolPref(&quot;mailnews.ui.junk.manualMarkAsJunkMarksRead&quot;,</span>
<a href="#l1.4682"></a><span id="l1.4682">                           &amp;changeReadState);</span>
<a href="#l1.4683"></a><span id="l1.4683"> </span>
<a href="#l1.4684"></a><span id="l1.4684" class="difflineminus">-  // now let's determine whether we'll be taking the second action,</span>
<a href="#l1.4685"></a><span id="l1.4685" class="difflineminus">-  // the move / deletion (and also determine which of these two)</span>
<a href="#l1.4686"></a><span id="l1.4686" class="difflineminus">-</span>
<a href="#l1.4687"></a><span id="l1.4687" class="difflineplus">+  // Now let's determine whether we'll be taking the second action,</span>
<a href="#l1.4688"></a><span id="l1.4688" class="difflineplus">+  // the move / deletion (and also determine which of these two).</span>
<a href="#l1.4689"></a><span id="l1.4689">   bool manualMark;</span>
<a href="#l1.4690"></a><span id="l1.4690">   (void)spamSettings-&gt;GetManualMark(&amp;manualMark);</span>
<a href="#l1.4691"></a><span id="l1.4691">   if (!manualMark)</span>
<a href="#l1.4692"></a><span id="l1.4692">     return NS_OK;</span>
<a href="#l1.4693"></a><span id="l1.4693"> </span>
<a href="#l1.4694"></a><span id="l1.4694">   int32_t manualMarkMode;</span>
<a href="#l1.4695"></a><span id="l1.4695">   (void)spamSettings-&gt;GetManualMarkMode(&amp;manualMarkMode);</span>
<a href="#l1.4696"></a><span id="l1.4696" class="difflineminus">-  NS_ASSERTION(manualMarkMode == nsISpamSettings::MANUAL_MARK_MODE_MOVE</span>
<a href="#l1.4697"></a><span id="l1.4697" class="difflineminus">-            || manualMarkMode == nsISpamSettings::MANUAL_MARK_MODE_DELETE,</span>
<a href="#l1.4698"></a><span id="l1.4698" class="difflineminus">-            &quot;bad manual mark mode&quot;);</span>
<a href="#l1.4699"></a><span id="l1.4699" class="difflineplus">+  NS_ASSERTION(manualMarkMode == nsISpamSettings::MANUAL_MARK_MODE_MOVE ||</span>
<a href="#l1.4700"></a><span id="l1.4700" class="difflineplus">+               manualMarkMode == nsISpamSettings::MANUAL_MARK_MODE_DELETE,</span>
<a href="#l1.4701"></a><span id="l1.4701" class="difflineplus">+               &quot;bad manual mark mode&quot;);</span>
<a href="#l1.4702"></a><span id="l1.4702"> </span>
<a href="#l1.4703"></a><span id="l1.4703">   if (manualMarkMode == nsISpamSettings::MANUAL_MARK_MODE_MOVE)</span>
<a href="#l1.4704"></a><span id="l1.4704">   {</span>
<a href="#l1.4705"></a><span id="l1.4705" class="difflineminus">-    // if this is a junk folder</span>
<a href="#l1.4706"></a><span id="l1.4706" class="difflineminus">-    // (not only &quot;the&quot; junk folder for this account)</span>
<a href="#l1.4707"></a><span id="l1.4707" class="difflineminus">-    // don't do the move</span>
<a href="#l1.4708"></a><span id="l1.4708" class="difflineplus">+    // If this is a junk folder (not only &quot;the&quot; junk folder for this account)</span>
<a href="#l1.4709"></a><span id="l1.4709" class="difflineplus">+    // don't do the move.</span>
<a href="#l1.4710"></a><span id="l1.4710">     if (folderFlags &amp; nsMsgFolderFlags::Junk)</span>
<a href="#l1.4711"></a><span id="l1.4711">       return NS_OK;</span>
<a href="#l1.4712"></a><span id="l1.4712"> </span>
<a href="#l1.4713"></a><span id="l1.4713">     nsCString spamFolderURI;</span>
<a href="#l1.4714"></a><span id="l1.4714">     rv = spamSettings-&gt;GetSpamFolderURI(getter_Copies(spamFolderURI));</span>
<a href="#l1.4715"></a><span id="l1.4715">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.4716"></a><span id="l1.4716"> </span>
<a href="#l1.4717"></a><span id="l1.4717">     NS_ASSERTION(!spamFolderURI.IsEmpty(), &quot;spam folder URI is empty, can't move&quot;);</span>
<a href="#l1.4718"></a><span id="l1.4718" class="difflineat">@@ -3730,417 +4135,453 @@ nsMsgDBView::DetermineActionsForJunkChan</span>
<a href="#l1.4719"></a><span id="l1.4719">         // XXX ToDo: GetOrCreateFolder will only create a folder with localized</span>
<a href="#l1.4720"></a><span id="l1.4720">         //           name &quot;Junk&quot; regardless of spamFolderURI. So if someone</span>
<a href="#l1.4721"></a><span id="l1.4721">         //           sets the junk folder to an existing folder of a different</span>
<a href="#l1.4722"></a><span id="l1.4722">         //           name, then deletes that folder, this will fail to create</span>
<a href="#l1.4723"></a><span id="l1.4723">         //           the correct folder.</span>
<a href="#l1.4724"></a><span id="l1.4724">         rv = GetOrCreateFolder(spamFolderURI, nullptr /* aListener */);</span>
<a href="#l1.4725"></a><span id="l1.4725">         if (NS_SUCCEEDED(rv))</span>
<a href="#l1.4726"></a><span id="l1.4726">           rv = GetExistingFolder(spamFolderURI, targetFolder);</span>
<a href="#l1.4727"></a><span id="l1.4727" class="difflineplus">+</span>
<a href="#l1.4728"></a><span id="l1.4728">         NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; *targetFolder, &quot;GetOrCreateFolder failed&quot;);</span>
<a href="#l1.4729"></a><span id="l1.4729">       }</span>
<a href="#l1.4730"></a><span id="l1.4730">     }</span>
<a href="#l1.4731"></a><span id="l1.4731" class="difflineplus">+</span>
<a href="#l1.4732"></a><span id="l1.4732">     return NS_OK;</span>
<a href="#l1.4733"></a><span id="l1.4733">   }</span>
<a href="#l1.4734"></a><span id="l1.4734"> </span>
<a href="#l1.4735"></a><span id="l1.4735" class="difflineminus">-  // at this point manualMarkMode == nsISpamSettings::MANUAL_MARK_MODE_DELETE)</span>
<a href="#l1.4736"></a><span id="l1.4736" class="difflineminus">-</span>
<a href="#l1.4737"></a><span id="l1.4737" class="difflineminus">-  // if this is in the trash, let's not delete</span>
<a href="#l1.4738"></a><span id="l1.4738" class="difflineplus">+  // At this point manualMarkMode == nsISpamSettings::MANUAL_MARK_MODE_DELETE).</span>
<a href="#l1.4739"></a><span id="l1.4739" class="difflineplus">+</span>
<a href="#l1.4740"></a><span id="l1.4740" class="difflineplus">+  // If this is in the trash, let's not delete.</span>
<a href="#l1.4741"></a><span id="l1.4741">   if (folderFlags &amp; nsMsgFolderFlags::Trash)</span>
<a href="#l1.4742"></a><span id="l1.4742">     return NS_OK;</span>
<a href="#l1.4743"></a><span id="l1.4743"> </span>
<a href="#l1.4744"></a><span id="l1.4744">   return srcFolder-&gt;GetCanDeleteMessages(&amp;moveMessages);</span>
<a href="#l1.4745"></a><span id="l1.4745"> }</span>
<a href="#l1.4746"></a><span id="l1.4746"> </span>
<a href="#l1.4747"></a><span id="l1.4747" class="difflineminus">-// reversing threads involves reversing the threads but leaving the</span>
<a href="#l1.4748"></a><span id="l1.4748" class="difflineplus">+// Reversing threads involves reversing the threads but leaving the</span>
<a href="#l1.4749"></a><span id="l1.4749"> // expanded messages ordered relative to the thread, so we</span>
<a href="#l1.4750"></a><span id="l1.4750"> // make a copy of each array and copy them over.</span>
<a href="#l1.4751"></a><span id="l1.4751"> void nsMsgDBView::ReverseThreads()</span>
<a href="#l1.4752"></a><span id="l1.4752"> {</span>
<a href="#l1.4753"></a><span id="l1.4753" class="difflineminus">-    nsTArray&lt;uint32_t&gt; newFlagArray;</span>
<a href="#l1.4754"></a><span id="l1.4754" class="difflineminus">-    nsTArray&lt;nsMsgKey&gt; newKeyArray;</span>
<a href="#l1.4755"></a><span id="l1.4755" class="difflineminus">-    nsTArray&lt;uint8_t&gt; newLevelArray;</span>
<a href="#l1.4756"></a><span id="l1.4756" class="difflineminus">-</span>
<a href="#l1.4757"></a><span id="l1.4757" class="difflineminus">-    uint32_t viewSize = GetSize();</span>
<a href="#l1.4758"></a><span id="l1.4758" class="difflineminus">-    uint32_t startThread = viewSize;</span>
<a href="#l1.4759"></a><span id="l1.4759" class="difflineminus">-    uint32_t nextThread = viewSize;</span>
<a href="#l1.4760"></a><span id="l1.4760" class="difflineminus">-    uint32_t destIndex = 0;</span>
<a href="#l1.4761"></a><span id="l1.4761" class="difflineminus">-</span>
<a href="#l1.4762"></a><span id="l1.4762" class="difflineminus">-    newKeyArray.SetLength(m_keys.Length());</span>
<a href="#l1.4763"></a><span id="l1.4763" class="difflineminus">-    newFlagArray.SetLength(m_flags.Length());</span>
<a href="#l1.4764"></a><span id="l1.4764" class="difflineminus">-    newLevelArray.SetLength(m_levels.Length());</span>
<a href="#l1.4765"></a><span id="l1.4765" class="difflineminus">-</span>
<a href="#l1.4766"></a><span id="l1.4766" class="difflineminus">-    while (startThread)</span>
<a href="#l1.4767"></a><span id="l1.4767" class="difflineminus">-    {</span>
<a href="#l1.4768"></a><span id="l1.4768" class="difflineminus">-        startThread--;</span>
<a href="#l1.4769"></a><span id="l1.4769" class="difflineminus">-</span>
<a href="#l1.4770"></a><span id="l1.4770" class="difflineminus">-        if (m_flags[startThread] &amp; MSG_VIEW_FLAG_ISTHREAD)</span>
<a href="#l1.4771"></a><span id="l1.4771" class="difflineminus">-        {</span>
<a href="#l1.4772"></a><span id="l1.4772" class="difflineminus">-            for (uint32_t sourceIndex = startThread; sourceIndex &lt; nextThread; sourceIndex++)</span>
<a href="#l1.4773"></a><span id="l1.4773" class="difflineminus">-            {</span>
<a href="#l1.4774"></a><span id="l1.4774" class="difflineminus">-                newKeyArray[destIndex] = m_keys[sourceIndex];</span>
<a href="#l1.4775"></a><span id="l1.4775" class="difflineminus">-                newFlagArray[destIndex] = m_flags[sourceIndex];</span>
<a href="#l1.4776"></a><span id="l1.4776" class="difflineminus">-                newLevelArray[destIndex] = m_levels[sourceIndex];</span>
<a href="#l1.4777"></a><span id="l1.4777" class="difflineminus">-                destIndex++;</span>
<a href="#l1.4778"></a><span id="l1.4778" class="difflineminus">-            }</span>
<a href="#l1.4779"></a><span id="l1.4779" class="difflineminus">-            nextThread = startThread; // because we're copying in reverse order</span>
<a href="#l1.4780"></a><span id="l1.4780" class="difflineminus">-        }</span>
<a href="#l1.4781"></a><span id="l1.4781" class="difflineminus">-    }</span>
<a href="#l1.4782"></a><span id="l1.4782" class="difflineminus">-    m_keys.SwapElements(newKeyArray);</span>
<a href="#l1.4783"></a><span id="l1.4783" class="difflineminus">-    m_flags.SwapElements(newFlagArray);</span>
<a href="#l1.4784"></a><span id="l1.4784" class="difflineminus">-    m_levels.SwapElements(newLevelArray);</span>
<a href="#l1.4785"></a><span id="l1.4785" class="difflineplus">+  nsTArray&lt;uint32_t&gt; newFlagArray;</span>
<a href="#l1.4786"></a><span id="l1.4786" class="difflineplus">+  nsTArray&lt;nsMsgKey&gt; newKeyArray;</span>
<a href="#l1.4787"></a><span id="l1.4787" class="difflineplus">+  nsTArray&lt;uint8_t&gt; newLevelArray;</span>
<a href="#l1.4788"></a><span id="l1.4788" class="difflineplus">+</span>
<a href="#l1.4789"></a><span id="l1.4789" class="difflineplus">+  uint32_t viewSize = GetSize();</span>
<a href="#l1.4790"></a><span id="l1.4790" class="difflineplus">+  uint32_t startThread = viewSize;</span>
<a href="#l1.4791"></a><span id="l1.4791" class="difflineplus">+  uint32_t nextThread = viewSize;</span>
<a href="#l1.4792"></a><span id="l1.4792" class="difflineplus">+  uint32_t destIndex = 0;</span>
<a href="#l1.4793"></a><span id="l1.4793" class="difflineplus">+</span>
<a href="#l1.4794"></a><span id="l1.4794" class="difflineplus">+  newKeyArray.SetLength(m_keys.Length());</span>
<a href="#l1.4795"></a><span id="l1.4795" class="difflineplus">+  newFlagArray.SetLength(m_flags.Length());</span>
<a href="#l1.4796"></a><span id="l1.4796" class="difflineplus">+  newLevelArray.SetLength(m_levels.Length());</span>
<a href="#l1.4797"></a><span id="l1.4797" class="difflineplus">+</span>
<a href="#l1.4798"></a><span id="l1.4798" class="difflineplus">+  while (startThread)</span>
<a href="#l1.4799"></a><span id="l1.4799" class="difflineplus">+  {</span>
<a href="#l1.4800"></a><span id="l1.4800" class="difflineplus">+    startThread--;</span>
<a href="#l1.4801"></a><span id="l1.4801" class="difflineplus">+</span>
<a href="#l1.4802"></a><span id="l1.4802" class="difflineplus">+    if (m_flags[startThread] &amp; MSG_VIEW_FLAG_ISTHREAD)</span>
<a href="#l1.4803"></a><span id="l1.4803" class="difflineplus">+    {</span>
<a href="#l1.4804"></a><span id="l1.4804" class="difflineplus">+      for (uint32_t sourceIndex = startThread; sourceIndex &lt; nextThread; sourceIndex++)</span>
<a href="#l1.4805"></a><span id="l1.4805" class="difflineplus">+      {</span>
<a href="#l1.4806"></a><span id="l1.4806" class="difflineplus">+        newKeyArray[destIndex] = m_keys[sourceIndex];</span>
<a href="#l1.4807"></a><span id="l1.4807" class="difflineplus">+        newFlagArray[destIndex] = m_flags[sourceIndex];</span>
<a href="#l1.4808"></a><span id="l1.4808" class="difflineplus">+        newLevelArray[destIndex] = m_levels[sourceIndex];</span>
<a href="#l1.4809"></a><span id="l1.4809" class="difflineplus">+        destIndex++;</span>
<a href="#l1.4810"></a><span id="l1.4810" class="difflineplus">+      }</span>
<a href="#l1.4811"></a><span id="l1.4811" class="difflineplus">+      // Because we're copying in reverse order.</span>
<a href="#l1.4812"></a><span id="l1.4812" class="difflineplus">+      nextThread = startThread;</span>
<a href="#l1.4813"></a><span id="l1.4813" class="difflineplus">+    }</span>
<a href="#l1.4814"></a><span id="l1.4814" class="difflineplus">+  }</span>
<a href="#l1.4815"></a><span id="l1.4815" class="difflineplus">+</span>
<a href="#l1.4816"></a><span id="l1.4816" class="difflineplus">+  m_keys.SwapElements(newKeyArray);</span>
<a href="#l1.4817"></a><span id="l1.4817" class="difflineplus">+  m_flags.SwapElements(newFlagArray);</span>
<a href="#l1.4818"></a><span id="l1.4818" class="difflineplus">+  m_levels.SwapElements(newLevelArray);</span>
<a href="#l1.4819"></a><span id="l1.4819"> }</span>
<a href="#l1.4820"></a><span id="l1.4820"> </span>
<a href="#l1.4821"></a><span id="l1.4821"> void nsMsgDBView::ReverseSort()</span>
<a href="#l1.4822"></a><span id="l1.4822"> {</span>
<a href="#l1.4823"></a><span id="l1.4823" class="difflineminus">-    uint32_t topIndex = GetSize();</span>
<a href="#l1.4824"></a><span id="l1.4824" class="difflineminus">-</span>
<a href="#l1.4825"></a><span id="l1.4825" class="difflineminus">-    nsCOMArray&lt;nsIMsgFolder&gt; *folders = GetFolders();</span>
<a href="#l1.4826"></a><span id="l1.4826" class="difflineminus">-</span>
<a href="#l1.4827"></a><span id="l1.4827" class="difflineminus">-    // go up half the array swapping values</span>
<a href="#l1.4828"></a><span id="l1.4828" class="difflineminus">-    for (uint32_t bottomIndex = 0; bottomIndex &lt; --topIndex; bottomIndex++)</span>
<a href="#l1.4829"></a><span id="l1.4829" class="difflineminus">-    {</span>
<a href="#l1.4830"></a><span id="l1.4830" class="difflineminus">-        // swap flags</span>
<a href="#l1.4831"></a><span id="l1.4831" class="difflineminus">-        uint32_t tempFlags = m_flags[bottomIndex];</span>
<a href="#l1.4832"></a><span id="l1.4832" class="difflineminus">-        m_flags[bottomIndex] = m_flags[topIndex];</span>
<a href="#l1.4833"></a><span id="l1.4833" class="difflineminus">-        m_flags[topIndex] = tempFlags;</span>
<a href="#l1.4834"></a><span id="l1.4834" class="difflineminus">-</span>
<a href="#l1.4835"></a><span id="l1.4835" class="difflineminus">-        // swap keys</span>
<a href="#l1.4836"></a><span id="l1.4836" class="difflineminus">-        nsMsgKey tempKey = m_keys[bottomIndex];</span>
<a href="#l1.4837"></a><span id="l1.4837" class="difflineminus">-        m_keys[bottomIndex] = m_keys[topIndex];</span>
<a href="#l1.4838"></a><span id="l1.4838" class="difflineminus">-        m_keys[topIndex] = tempKey;</span>
<a href="#l1.4839"></a><span id="l1.4839" class="difflineminus">-</span>
<a href="#l1.4840"></a><span id="l1.4840" class="difflineminus">-        if (folders)</span>
<a href="#l1.4841"></a><span id="l1.4841" class="difflineminus">-        {</span>
<a href="#l1.4842"></a><span id="l1.4842" class="difflineminus">-            // swap folders --</span>
<a href="#l1.4843"></a><span id="l1.4843" class="difflineminus">-            // needed when search is done across multiple folders</span>
<a href="#l1.4844"></a><span id="l1.4844" class="difflineminus">-            nsIMsgFolder *bottomFolder = folders-&gt;ObjectAt(bottomIndex);</span>
<a href="#l1.4845"></a><span id="l1.4845" class="difflineminus">-            nsIMsgFolder *topFolder = folders-&gt;ObjectAt(topIndex);</span>
<a href="#l1.4846"></a><span id="l1.4846" class="difflineminus">-            folders-&gt;ReplaceObjectAt(topFolder, bottomIndex);</span>
<a href="#l1.4847"></a><span id="l1.4847" class="difflineminus">-            folders-&gt;ReplaceObjectAt(bottomFolder, topIndex);</span>
<a href="#l1.4848"></a><span id="l1.4848" class="difflineminus">-        }</span>
<a href="#l1.4849"></a><span id="l1.4849" class="difflineminus">-        // no need to swap elements in m_levels; since we only call</span>
<a href="#l1.4850"></a><span id="l1.4850" class="difflineminus">-        // ReverseSort in non-threaded mode, m_levels are all the same.</span>
<a href="#l1.4851"></a><span id="l1.4851" class="difflineminus">-    }</span>
<a href="#l1.4852"></a><span id="l1.4852" class="difflineminus">-}</span>
<a href="#l1.4853"></a><span id="l1.4853" class="difflineminus">-int</span>
<a href="#l1.4854"></a><span id="l1.4854" class="difflineminus">-nsMsgDBView::FnSortIdKey(const void *pItem1, const void *pItem2, void *privateData)</span>
<a href="#l1.4855"></a><span id="l1.4855" class="difflineminus">-{</span>
<a href="#l1.4856"></a><span id="l1.4856" class="difflineminus">-    int32_t retVal = 0;</span>
<a href="#l1.4857"></a><span id="l1.4857" class="difflineminus">-</span>
<a href="#l1.4858"></a><span id="l1.4858" class="difflineminus">-    IdKey** p1 = (IdKey**)pItem1;</span>
<a href="#l1.4859"></a><span id="l1.4859" class="difflineminus">-    IdKey** p2 = (IdKey**)pItem2;</span>
<a href="#l1.4860"></a><span id="l1.4860" class="difflineminus">-    viewSortInfo* sortInfo = (viewSortInfo *) privateData;</span>
<a href="#l1.4861"></a><span id="l1.4861" class="difflineminus">-</span>
<a href="#l1.4862"></a><span id="l1.4862" class="difflineminus">-    nsIMsgDatabase *db = sortInfo-&gt;db;</span>
<a href="#l1.4863"></a><span id="l1.4863" class="difflineminus">-</span>
<a href="#l1.4864"></a><span id="l1.4864" class="difflineminus">-    mozilla::DebugOnly&lt;nsresult&gt; rv = db-&gt;CompareCollationKeys((*p1)-&gt;dword, (*p1)-&gt;key,</span>
<a href="#l1.4865"></a><span id="l1.4865" class="difflineminus">-                                                               (*p2)-&gt;dword, (*p2)-&gt;key,</span>
<a href="#l1.4866"></a><span id="l1.4866" class="difflineminus">-                                                               &amp;retVal);</span>
<a href="#l1.4867"></a><span id="l1.4867" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;compare failed&quot;);</span>
<a href="#l1.4868"></a><span id="l1.4868" class="difflineminus">-</span>
<a href="#l1.4869"></a><span id="l1.4869" class="difflineminus">-    if (retVal)</span>
<a href="#l1.4870"></a><span id="l1.4870" class="difflineminus">-      return sortInfo-&gt;ascendingSort ? retVal : -retVal;</span>
<a href="#l1.4871"></a><span id="l1.4871" class="difflineminus">-    if (sortInfo-&gt;view-&gt;m_secondarySort == nsMsgViewSortType::byId)</span>
<a href="#l1.4872"></a><span id="l1.4872" class="difflineminus">-      return (sortInfo-&gt;view-&gt;m_secondarySortOrder == nsMsgViewSortOrder::ascending &amp;&amp;</span>
<a href="#l1.4873"></a><span id="l1.4873" class="difflineminus">-              (*p1)-&gt;id &gt;= (*p2)-&gt;id) ? 1 : -1;</span>
<a href="#l1.4874"></a><span id="l1.4874" class="difflineminus">-    else</span>
<a href="#l1.4875"></a><span id="l1.4875" class="difflineminus">-      return sortInfo-&gt;view-&gt;SecondarySort((*p1)-&gt;id, (*p1)-&gt;folder, (*p2)-&gt;id, (*p2)-&gt;folder, sortInfo);</span>
<a href="#l1.4876"></a><span id="l1.4876" class="difflineminus">-    // here we'd use the secondary sort</span>
<a href="#l1.4877"></a><span id="l1.4877" class="difflineplus">+  uint32_t topIndex = GetSize();</span>
<a href="#l1.4878"></a><span id="l1.4878" class="difflineplus">+</span>
<a href="#l1.4879"></a><span id="l1.4879" class="difflineplus">+  nsCOMArray&lt;nsIMsgFolder&gt; *folders = GetFolders();</span>
<a href="#l1.4880"></a><span id="l1.4880" class="difflineplus">+</span>
<a href="#l1.4881"></a><span id="l1.4881" class="difflineplus">+  // Go up half the array swapping values.</span>
<a href="#l1.4882"></a><span id="l1.4882" class="difflineplus">+  for (uint32_t bottomIndex = 0; bottomIndex &lt; --topIndex; bottomIndex++)</span>
<a href="#l1.4883"></a><span id="l1.4883" class="difflineplus">+  {</span>
<a href="#l1.4884"></a><span id="l1.4884" class="difflineplus">+    // Swap flags.</span>
<a href="#l1.4885"></a><span id="l1.4885" class="difflineplus">+    uint32_t tempFlags = m_flags[bottomIndex];</span>
<a href="#l1.4886"></a><span id="l1.4886" class="difflineplus">+    m_flags[bottomIndex] = m_flags[topIndex];</span>
<a href="#l1.4887"></a><span id="l1.4887" class="difflineplus">+    m_flags[topIndex] = tempFlags;</span>
<a href="#l1.4888"></a><span id="l1.4888" class="difflineplus">+</span>
<a href="#l1.4889"></a><span id="l1.4889" class="difflineplus">+    // Swap keys.</span>
<a href="#l1.4890"></a><span id="l1.4890" class="difflineplus">+    nsMsgKey tempKey = m_keys[bottomIndex];</span>
<a href="#l1.4891"></a><span id="l1.4891" class="difflineplus">+    m_keys[bottomIndex] = m_keys[topIndex];</span>
<a href="#l1.4892"></a><span id="l1.4892" class="difflineplus">+    m_keys[topIndex] = tempKey;</span>
<a href="#l1.4893"></a><span id="l1.4893" class="difflineplus">+</span>
<a href="#l1.4894"></a><span id="l1.4894" class="difflineplus">+    if (folders)</span>
<a href="#l1.4895"></a><span id="l1.4895" class="difflineplus">+    {</span>
<a href="#l1.4896"></a><span id="l1.4896" class="difflineplus">+      // Swap folders -- needed when search is done across multiple folders.</span>
<a href="#l1.4897"></a><span id="l1.4897" class="difflineplus">+      nsIMsgFolder *bottomFolder = folders-&gt;ObjectAt(bottomIndex);</span>
<a href="#l1.4898"></a><span id="l1.4898" class="difflineplus">+      nsIMsgFolder *topFolder = folders-&gt;ObjectAt(topIndex);</span>
<a href="#l1.4899"></a><span id="l1.4899" class="difflineplus">+      folders-&gt;ReplaceObjectAt(topFolder, bottomIndex);</span>
<a href="#l1.4900"></a><span id="l1.4900" class="difflineplus">+      folders-&gt;ReplaceObjectAt(bottomFolder, topIndex);</span>
<a href="#l1.4901"></a><span id="l1.4901" class="difflineplus">+    }</span>
<a href="#l1.4902"></a><span id="l1.4902" class="difflineplus">+</span>
<a href="#l1.4903"></a><span id="l1.4903" class="difflineplus">+    // No need to swap elements in m_levels; since we only call</span>
<a href="#l1.4904"></a><span id="l1.4904" class="difflineplus">+    // ReverseSort in non-threaded mode, m_levels are all the same.</span>
<a href="#l1.4905"></a><span id="l1.4905" class="difflineplus">+  }</span>
<a href="#l1.4906"></a><span id="l1.4906"> }</span>
<a href="#l1.4907"></a><span id="l1.4907"> </span>
<a href="#l1.4908"></a><span id="l1.4908"> int</span>
<a href="#l1.4909"></a><span id="l1.4909" class="difflineminus">-nsMsgDBView::FnSortIdKeyPtr(const void *pItem1, const void *pItem2, void *privateData)</span>
<a href="#l1.4910"></a><span id="l1.4910" class="difflineplus">+nsMsgDBView::FnSortIdKey(const void *pItem1,</span>
<a href="#l1.4911"></a><span id="l1.4911" class="difflineplus">+                         const void *pItem2,</span>
<a href="#l1.4912"></a><span id="l1.4912" class="difflineplus">+                         void *privateData)</span>
<a href="#l1.4913"></a><span id="l1.4913" class="difflineplus">+{</span>
<a href="#l1.4914"></a><span id="l1.4914" class="difflineplus">+  int32_t retVal = 0;</span>
<a href="#l1.4915"></a><span id="l1.4915" class="difflineplus">+</span>
<a href="#l1.4916"></a><span id="l1.4916" class="difflineplus">+  IdKey** p1 = (IdKey**)pItem1;</span>
<a href="#l1.4917"></a><span id="l1.4917" class="difflineplus">+  IdKey** p2 = (IdKey**)pItem2;</span>
<a href="#l1.4918"></a><span id="l1.4918" class="difflineplus">+  viewSortInfo* sortInfo = (viewSortInfo *) privateData;</span>
<a href="#l1.4919"></a><span id="l1.4919" class="difflineplus">+</span>
<a href="#l1.4920"></a><span id="l1.4920" class="difflineplus">+  nsIMsgDatabase *db = sortInfo-&gt;db;</span>
<a href="#l1.4921"></a><span id="l1.4921" class="difflineplus">+</span>
<a href="#l1.4922"></a><span id="l1.4922" class="difflineplus">+  mozilla::DebugOnly&lt;nsresult&gt; rv = db-&gt;CompareCollationKeys((*p1)-&gt;dword,</span>
<a href="#l1.4923"></a><span id="l1.4923" class="difflineplus">+                                                             (*p1)-&gt;key,</span>
<a href="#l1.4924"></a><span id="l1.4924" class="difflineplus">+                                                             (*p2)-&gt;dword,</span>
<a href="#l1.4925"></a><span id="l1.4925" class="difflineplus">+                                                             (*p2)-&gt;key,</span>
<a href="#l1.4926"></a><span id="l1.4926" class="difflineplus">+                                                             &amp;retVal);</span>
<a href="#l1.4927"></a><span id="l1.4927" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;compare failed&quot;);</span>
<a href="#l1.4928"></a><span id="l1.4928" class="difflineplus">+</span>
<a href="#l1.4929"></a><span id="l1.4929" class="difflineplus">+  if (retVal)</span>
<a href="#l1.4930"></a><span id="l1.4930" class="difflineplus">+    return sortInfo-&gt;ascendingSort ? retVal : -retVal;</span>
<a href="#l1.4931"></a><span id="l1.4931" class="difflineplus">+</span>
<a href="#l1.4932"></a><span id="l1.4932" class="difflineplus">+  if (sortInfo-&gt;view-&gt;m_secondarySort == nsMsgViewSortType::byId)</span>
<a href="#l1.4933"></a><span id="l1.4933" class="difflineplus">+    return (sortInfo-&gt;view-&gt;m_secondarySortOrder == nsMsgViewSortOrder::ascending &amp;&amp;</span>
<a href="#l1.4934"></a><span id="l1.4934" class="difflineplus">+            (*p1)-&gt;id &gt;= (*p2)-&gt;id) ? 1 : -1;</span>
<a href="#l1.4935"></a><span id="l1.4935" class="difflineplus">+  else</span>
<a href="#l1.4936"></a><span id="l1.4936" class="difflineplus">+    return sortInfo-&gt;view-&gt;SecondarySort((*p1)-&gt;id,</span>
<a href="#l1.4937"></a><span id="l1.4937" class="difflineplus">+                                         (*p1)-&gt;folder,</span>
<a href="#l1.4938"></a><span id="l1.4938" class="difflineplus">+                                         (*p2)-&gt;id,</span>
<a href="#l1.4939"></a><span id="l1.4939" class="difflineplus">+                                         (*p2)-&gt;folder,</span>
<a href="#l1.4940"></a><span id="l1.4940" class="difflineplus">+                                         sortInfo);</span>
<a href="#l1.4941"></a><span id="l1.4941" class="difflineplus">+  // Here we'd use the secondary sort.</span>
<a href="#l1.4942"></a><span id="l1.4942" class="difflineplus">+}</span>
<a href="#l1.4943"></a><span id="l1.4943" class="difflineplus">+</span>
<a href="#l1.4944"></a><span id="l1.4944" class="difflineplus">+int</span>
<a href="#l1.4945"></a><span id="l1.4945" class="difflineplus">+nsMsgDBView::FnSortIdKeyPtr(const void *pItem1,</span>
<a href="#l1.4946"></a><span id="l1.4946" class="difflineplus">+                            const void *pItem2,</span>
<a href="#l1.4947"></a><span id="l1.4947" class="difflineplus">+                            void *privateData)</span>
<a href="#l1.4948"></a><span id="l1.4948"> {</span>
<a href="#l1.4949"></a><span id="l1.4949">   int32_t retVal = 0;</span>
<a href="#l1.4950"></a><span id="l1.4950"> </span>
<a href="#l1.4951"></a><span id="l1.4951">   IdKeyPtr** p1 = (IdKeyPtr**)pItem1;</span>
<a href="#l1.4952"></a><span id="l1.4952">   IdKeyPtr** p2 = (IdKeyPtr**)pItem2;</span>
<a href="#l1.4953"></a><span id="l1.4953">   viewSortInfo* sortInfo = (viewSortInfo *) privateData;</span>
<a href="#l1.4954"></a><span id="l1.4954"> </span>
<a href="#l1.4955"></a><span id="l1.4955">   nsIMsgDatabase *db = sortInfo-&gt;db;</span>
<a href="#l1.4956"></a><span id="l1.4956"> </span>
<a href="#l1.4957"></a><span id="l1.4957" class="difflineminus">-  mozilla::DebugOnly&lt;nsresult&gt; rv = db-&gt;CompareCollationKeys((*p1)-&gt;dword, (*p1)-&gt;key,</span>
<a href="#l1.4958"></a><span id="l1.4958" class="difflineminus">-                                                             (*p2)-&gt;dword, (*p2)-&gt;key,</span>
<a href="#l1.4959"></a><span id="l1.4959" class="difflineplus">+  mozilla::DebugOnly&lt;nsresult&gt; rv = db-&gt;CompareCollationKeys((*p1)-&gt;dword,</span>
<a href="#l1.4960"></a><span id="l1.4960" class="difflineplus">+                                                             (*p1)-&gt;key,</span>
<a href="#l1.4961"></a><span id="l1.4961" class="difflineplus">+                                                             (*p2)-&gt;dword,</span>
<a href="#l1.4962"></a><span id="l1.4962" class="difflineplus">+                                                             (*p2)-&gt;key,</span>
<a href="#l1.4963"></a><span id="l1.4963">                                                              &amp;retVal);</span>
<a href="#l1.4964"></a><span id="l1.4964">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;compare failed&quot;);</span>
<a href="#l1.4965"></a><span id="l1.4965"> </span>
<a href="#l1.4966"></a><span id="l1.4966">   if (retVal)</span>
<a href="#l1.4967"></a><span id="l1.4967">     return sortInfo-&gt;ascendingSort ? retVal : -retVal;</span>
<a href="#l1.4968"></a><span id="l1.4968"> </span>
<a href="#l1.4969"></a><span id="l1.4969">   if (sortInfo-&gt;view-&gt;m_secondarySort == nsMsgViewSortType::byId)</span>
<a href="#l1.4970"></a><span id="l1.4970">     return (sortInfo-&gt;view-&gt;m_secondarySortOrder == nsMsgViewSortOrder::ascending &amp;&amp;</span>
<a href="#l1.4971"></a><span id="l1.4971">             (*p1)-&gt;id &gt;= (*p2)-&gt;id) ? 1 : -1;</span>
<a href="#l1.4972"></a><span id="l1.4972">   else</span>
<a href="#l1.4973"></a><span id="l1.4973" class="difflineminus">-    return sortInfo-&gt;view-&gt;SecondarySort((*p1)-&gt;id, (*p1)-&gt;folder, (*p2)-&gt;id, (*p2)-&gt;folder, sortInfo);</span>
<a href="#l1.4974"></a><span id="l1.4974" class="difflineplus">+    return sortInfo-&gt;view-&gt;SecondarySort((*p1)-&gt;id,</span>
<a href="#l1.4975"></a><span id="l1.4975" class="difflineplus">+                                         (*p1)-&gt;folder,</span>
<a href="#l1.4976"></a><span id="l1.4976" class="difflineplus">+                                         (*p2)-&gt;id,</span>
<a href="#l1.4977"></a><span id="l1.4977" class="difflineplus">+                                         (*p2)-&gt;folder,</span>
<a href="#l1.4978"></a><span id="l1.4978" class="difflineplus">+                                         sortInfo);</span>
<a href="#l1.4979"></a><span id="l1.4979"> }</span>
<a href="#l1.4980"></a><span id="l1.4980"> </span>
<a href="#l1.4981"></a><span id="l1.4981"> int</span>
<a href="#l1.4982"></a><span id="l1.4982" class="difflineminus">-nsMsgDBView::FnSortIdUint32(const void *pItem1, const void *pItem2, void *privateData)</span>
<a href="#l1.4983"></a><span id="l1.4983" class="difflineplus">+nsMsgDBView::FnSortIdUint32(const void *pItem1,</span>
<a href="#l1.4984"></a><span id="l1.4984" class="difflineplus">+                            const void *pItem2,</span>
<a href="#l1.4985"></a><span id="l1.4985" class="difflineplus">+                            void *privateData)</span>
<a href="#l1.4986"></a><span id="l1.4986"> {</span>
<a href="#l1.4987"></a><span id="l1.4987">   IdUint32** p1 = (IdUint32**)pItem1;</span>
<a href="#l1.4988"></a><span id="l1.4988">   IdUint32** p2 = (IdUint32**)pItem2;</span>
<a href="#l1.4989"></a><span id="l1.4989">   viewSortInfo* sortInfo = (viewSortInfo *) privateData;</span>
<a href="#l1.4990"></a><span id="l1.4990"> </span>
<a href="#l1.4991"></a><span id="l1.4991">   if ((*p1)-&gt;dword &gt; (*p2)-&gt;dword)</span>
<a href="#l1.4992"></a><span id="l1.4992">     return (sortInfo-&gt;ascendingSort) ? 1 : -1;</span>
<a href="#l1.4993"></a><span id="l1.4993">   else if ((*p1)-&gt;dword &lt; (*p2)-&gt;dword)</span>
<a href="#l1.4994"></a><span id="l1.4994" class="difflineminus">-      return (sortInfo-&gt;ascendingSort) ? -1 : 1;</span>
<a href="#l1.4995"></a><span id="l1.4995" class="difflineplus">+    return (sortInfo-&gt;ascendingSort) ? -1 : 1;</span>
<a href="#l1.4996"></a><span id="l1.4996" class="difflineplus">+</span>
<a href="#l1.4997"></a><span id="l1.4997">   if (sortInfo-&gt;view-&gt;m_secondarySort == nsMsgViewSortType::byId)</span>
<a href="#l1.4998"></a><span id="l1.4998">     return (sortInfo-&gt;view-&gt;m_secondarySortOrder == nsMsgViewSortOrder::ascending &amp;&amp;</span>
<a href="#l1.4999"></a><span id="l1.4999">             (*p1)-&gt;id &gt;= (*p2)-&gt;id) ? 1 : -1;</span>
<a href="#l1.5000"></a><span id="l1.5000">   else</span>
<a href="#l1.5001"></a><span id="l1.5001" class="difflineminus">-    return sortInfo-&gt;view-&gt;SecondarySort((*p1)-&gt;id, (*p1)-&gt;folder, (*p2)-&gt;id, (*p2)-&gt;folder, sortInfo);</span>
<a href="#l1.5002"></a><span id="l1.5002" class="difflineminus">-}</span>
<a href="#l1.5003"></a><span id="l1.5003" class="difflineminus">-</span>
<a href="#l1.5004"></a><span id="l1.5004" class="difflineplus">+    return sortInfo-&gt;view-&gt;SecondarySort((*p1)-&gt;id,</span>
<a href="#l1.5005"></a><span id="l1.5005" class="difflineplus">+                                         (*p1)-&gt;folder,</span>
<a href="#l1.5006"></a><span id="l1.5006" class="difflineplus">+                                         (*p2)-&gt;id,</span>
<a href="#l1.5007"></a><span id="l1.5007" class="difflineplus">+                                         (*p2)-&gt;folder,</span>
<a href="#l1.5008"></a><span id="l1.5008" class="difflineplus">+                                         sortInfo);</span>
<a href="#l1.5009"></a><span id="l1.5009" class="difflineplus">+}</span>
<a href="#l1.5010"></a><span id="l1.5010"> </span>
<a href="#l1.5011"></a><span id="l1.5011"> // XXX are these still correct?</span>
<a href="#l1.5012"></a><span id="l1.5012" class="difflineminus">-//To compensate for memory alignment required for</span>
<a href="#l1.5013"></a><span id="l1.5013" class="difflineminus">-//systems such as HP-UX these values must be 4 bytes</span>
<a href="#l1.5014"></a><span id="l1.5014" class="difflineminus">-//aligned.  Don't break this when modify the constants</span>
<a href="#l1.5015"></a><span id="l1.5015" class="difflineplus">+// To compensate for memory alignment required for systems such as HP-UX, these</span>
<a href="#l1.5016"></a><span id="l1.5016" class="difflineplus">+// values must be 4 bytes aligned. Don't break this when modifying the constants.</span>
<a href="#l1.5017"></a><span id="l1.5017"> const int kMaxSubjectKey = 160;</span>
<a href="#l1.5018"></a><span id="l1.5018" class="difflineminus">-const int kMaxLocationKey = 160;  // also used for account</span>
<a href="#l1.5019"></a><span id="l1.5019" class="difflineplus">+const int kMaxLocationKey = 160; // Also used for account.</span>
<a href="#l1.5020"></a><span id="l1.5020"> const int kMaxAuthorKey = 160;</span>
<a href="#l1.5021"></a><span id="l1.5021"> const int kMaxRecipientKey = 80;</span>
<a href="#l1.5022"></a><span id="l1.5022"> </span>
<a href="#l1.5023"></a><span id="l1.5023" class="difflineminus">-//</span>
<a href="#l1.5024"></a><span id="l1.5024"> // There are cases when pFieldType is not set:</span>
<a href="#l1.5025"></a><span id="l1.5025"> // one case returns NS_ERROR_UNEXPECTED;</span>
<a href="#l1.5026"></a><span id="l1.5026"> // the other case now return NS_ERROR_NULL_POINTER (this is only when</span>
<a href="#l1.5027"></a><span id="l1.5027"> // colHandler below is null, but is very unlikely).</span>
<a href="#l1.5028"></a><span id="l1.5028"> // The latter case used to return NS_OK, which was incorrect.</span>
<a href="#l1.5029"></a><span id="l1.5029" class="difflineminus">-//</span>
<a href="#l1.5030"></a><span id="l1.5030"> nsresult nsMsgDBView::GetFieldTypeAndLenForSort(nsMsgViewSortTypeValue sortType,</span>
<a href="#l1.5031"></a><span id="l1.5031">                                                 uint16_t *pMaxLen,</span>
<a href="#l1.5032"></a><span id="l1.5032">                                                 eFieldType *pFieldType,</span>
<a href="#l1.5033"></a><span id="l1.5033">                                                 nsIMsgCustomColumnHandler* colHandler)</span>
<a href="#l1.5034"></a><span id="l1.5034"> {</span>
<a href="#l1.5035"></a><span id="l1.5035" class="difflineminus">-    NS_ENSURE_ARG_POINTER(pMaxLen);</span>
<a href="#l1.5036"></a><span id="l1.5036" class="difflineminus">-    NS_ENSURE_ARG_POINTER(pFieldType);</span>
<a href="#l1.5037"></a><span id="l1.5037" class="difflineminus">-</span>
<a href="#l1.5038"></a><span id="l1.5038" class="difflineminus">-    switch (sortType)</span>
<a href="#l1.5039"></a><span id="l1.5039" class="difflineminus">-    {</span>
<a href="#l1.5040"></a><span id="l1.5040" class="difflineminus">-        case nsMsgViewSortType::bySubject:</span>
<a href="#l1.5041"></a><span id="l1.5041" class="difflineminus">-            *pFieldType = kCollationKey;</span>
<a href="#l1.5042"></a><span id="l1.5042" class="difflineminus">-            *pMaxLen = kMaxSubjectKey;</span>
<a href="#l1.5043"></a><span id="l1.5043" class="difflineminus">-            break;</span>
<a href="#l1.5044"></a><span id="l1.5044" class="difflineminus">-        case nsMsgViewSortType::byAccount:</span>
<a href="#l1.5045"></a><span id="l1.5045" class="difflineminus">-        case nsMsgViewSortType::byTags:</span>
<a href="#l1.5046"></a><span id="l1.5046" class="difflineminus">-        case nsMsgViewSortType::byLocation:</span>
<a href="#l1.5047"></a><span id="l1.5047" class="difflineminus">-            *pFieldType = kCollationKey;</span>
<a href="#l1.5048"></a><span id="l1.5048" class="difflineminus">-            *pMaxLen = kMaxLocationKey;</span>
<a href="#l1.5049"></a><span id="l1.5049" class="difflineminus">-            break;</span>
<a href="#l1.5050"></a><span id="l1.5050" class="difflineminus">-        case nsMsgViewSortType::byRecipient:</span>
<a href="#l1.5051"></a><span id="l1.5051" class="difflineminus">-        case nsMsgViewSortType::byCorrespondent:</span>
<a href="#l1.5052"></a><span id="l1.5052" class="difflineminus">-            *pFieldType = kCollationKey;</span>
<a href="#l1.5053"></a><span id="l1.5053" class="difflineminus">-            *pMaxLen = kMaxRecipientKey;</span>
<a href="#l1.5054"></a><span id="l1.5054" class="difflineminus">-            break;</span>
<a href="#l1.5055"></a><span id="l1.5055" class="difflineminus">-        case nsMsgViewSortType::byAuthor:</span>
<a href="#l1.5056"></a><span id="l1.5056" class="difflineminus">-            *pFieldType = kCollationKey;</span>
<a href="#l1.5057"></a><span id="l1.5057" class="difflineminus">-            *pMaxLen = kMaxAuthorKey;</span>
<a href="#l1.5058"></a><span id="l1.5058" class="difflineminus">-            break;</span>
<a href="#l1.5059"></a><span id="l1.5059" class="difflineminus">-        case nsMsgViewSortType::byDate:</span>
<a href="#l1.5060"></a><span id="l1.5060" class="difflineminus">-        case nsMsgViewSortType::byReceived:</span>
<a href="#l1.5061"></a><span id="l1.5061" class="difflineminus">-        case nsMsgViewSortType::byPriority:</span>
<a href="#l1.5062"></a><span id="l1.5062" class="difflineminus">-        case nsMsgViewSortType::byThread:</span>
<a href="#l1.5063"></a><span id="l1.5063" class="difflineminus">-        case nsMsgViewSortType::byId:</span>
<a href="#l1.5064"></a><span id="l1.5064" class="difflineminus">-        case nsMsgViewSortType::bySize:</span>
<a href="#l1.5065"></a><span id="l1.5065" class="difflineminus">-        case nsMsgViewSortType::byFlagged:</span>
<a href="#l1.5066"></a><span id="l1.5066" class="difflineminus">-        case nsMsgViewSortType::byUnread:</span>
<a href="#l1.5067"></a><span id="l1.5067" class="difflineminus">-        case nsMsgViewSortType::byStatus:</span>
<a href="#l1.5068"></a><span id="l1.5068" class="difflineminus">-        case nsMsgViewSortType::byJunkStatus:</span>
<a href="#l1.5069"></a><span id="l1.5069" class="difflineminus">-        case nsMsgViewSortType::byAttachments:</span>
<a href="#l1.5070"></a><span id="l1.5070" class="difflineminus">-            *pFieldType = kU32;</span>
<a href="#l1.5071"></a><span id="l1.5071" class="difflineminus">-            *pMaxLen = 0;</span>
<a href="#l1.5072"></a><span id="l1.5072" class="difflineminus">-            break;</span>
<a href="#l1.5073"></a><span id="l1.5073" class="difflineminus">-        case nsMsgViewSortType::byCustom:</span>
<a href="#l1.5074"></a><span id="l1.5074" class="difflineminus">-        {</span>
<a href="#l1.5075"></a><span id="l1.5075" class="difflineminus">-          if (colHandler == nullptr)</span>
<a href="#l1.5076"></a><span id="l1.5076" class="difflineminus">-          {</span>
<a href="#l1.5077"></a><span id="l1.5077" class="difflineminus">-            NS_WARNING(&quot;colHandler is null. *pFieldType is not set.&quot;);</span>
<a href="#l1.5078"></a><span id="l1.5078" class="difflineminus">-            return NS_ERROR_NULL_POINTER;</span>
<a href="#l1.5079"></a><span id="l1.5079" class="difflineminus">-          }</span>
<a href="#l1.5080"></a><span id="l1.5080" class="difflineminus">-</span>
<a href="#l1.5081"></a><span id="l1.5081" class="difflineminus">-          bool isString;</span>
<a href="#l1.5082"></a><span id="l1.5082" class="difflineminus">-          colHandler-&gt;IsString(&amp;isString);</span>
<a href="#l1.5083"></a><span id="l1.5083" class="difflineminus">-</span>
<a href="#l1.5084"></a><span id="l1.5084" class="difflineminus">-          if (isString)</span>
<a href="#l1.5085"></a><span id="l1.5085" class="difflineminus">-          {</span>
<a href="#l1.5086"></a><span id="l1.5086" class="difflineminus">-            *pFieldType = kCollationKey;</span>
<a href="#l1.5087"></a><span id="l1.5087" class="difflineminus">-            *pMaxLen = kMaxRecipientKey; //80 - do we need a seperate k?</span>
<a href="#l1.5088"></a><span id="l1.5088" class="difflineminus">-          }</span>
<a href="#l1.5089"></a><span id="l1.5089" class="difflineminus">-          else</span>
<a href="#l1.5090"></a><span id="l1.5090" class="difflineminus">-          {</span>
<a href="#l1.5091"></a><span id="l1.5091" class="difflineminus">-            *pFieldType = kU32;</span>
<a href="#l1.5092"></a><span id="l1.5092" class="difflineminus">-            *pMaxLen = 0;</span>
<a href="#l1.5093"></a><span id="l1.5093" class="difflineminus">-          }</span>
<a href="#l1.5094"></a><span id="l1.5094" class="difflineminus">-          break;</span>
<a href="#l1.5095"></a><span id="l1.5095" class="difflineminus">-        }</span>
<a href="#l1.5096"></a><span id="l1.5096" class="difflineminus">-        case nsMsgViewSortType::byNone: // bug 901948</span>
<a href="#l1.5097"></a><span id="l1.5097" class="difflineminus">-          return NS_ERROR_INVALID_ARG;</span>
<a href="#l1.5098"></a><span id="l1.5098" class="difflineminus">-        default:</span>
<a href="#l1.5099"></a><span id="l1.5099" class="difflineminus">-        {</span>
<a href="#l1.5100"></a><span id="l1.5100" class="difflineminus">-           nsAutoCString message(&quot;unexpected switch value: sortType=&quot;);</span>
<a href="#l1.5101"></a><span id="l1.5101" class="difflineminus">-           message.AppendInt(sortType);</span>
<a href="#l1.5102"></a><span id="l1.5102" class="difflineminus">-           NS_WARNING(message.get());</span>
<a href="#l1.5103"></a><span id="l1.5103" class="difflineminus">-           return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.5104"></a><span id="l1.5104" class="difflineminus">-        }</span>
<a href="#l1.5105"></a><span id="l1.5105" class="difflineminus">-    }</span>
<a href="#l1.5106"></a><span id="l1.5106" class="difflineminus">-</span>
<a href="#l1.5107"></a><span id="l1.5107" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.5108"></a><span id="l1.5108" class="difflineplus">+  NS_ENSURE_ARG_POINTER(pMaxLen);</span>
<a href="#l1.5109"></a><span id="l1.5109" class="difflineplus">+  NS_ENSURE_ARG_POINTER(pFieldType);</span>
<a href="#l1.5110"></a><span id="l1.5110" class="difflineplus">+</span>
<a href="#l1.5111"></a><span id="l1.5111" class="difflineplus">+  switch (sortType)</span>
<a href="#l1.5112"></a><span id="l1.5112" class="difflineplus">+  {</span>
<a href="#l1.5113"></a><span id="l1.5113" class="difflineplus">+    case nsMsgViewSortType::bySubject:</span>
<a href="#l1.5114"></a><span id="l1.5114" class="difflineplus">+      *pFieldType = kCollationKey;</span>
<a href="#l1.5115"></a><span id="l1.5115" class="difflineplus">+      *pMaxLen = kMaxSubjectKey;</span>
<a href="#l1.5116"></a><span id="l1.5116" class="difflineplus">+      break;</span>
<a href="#l1.5117"></a><span id="l1.5117" class="difflineplus">+    case nsMsgViewSortType::byAccount:</span>
<a href="#l1.5118"></a><span id="l1.5118" class="difflineplus">+    case nsMsgViewSortType::byTags:</span>
<a href="#l1.5119"></a><span id="l1.5119" class="difflineplus">+    case nsMsgViewSortType::byLocation:</span>
<a href="#l1.5120"></a><span id="l1.5120" class="difflineplus">+      *pFieldType = kCollationKey;</span>
<a href="#l1.5121"></a><span id="l1.5121" class="difflineplus">+      *pMaxLen = kMaxLocationKey;</span>
<a href="#l1.5122"></a><span id="l1.5122" class="difflineplus">+      break;</span>
<a href="#l1.5123"></a><span id="l1.5123" class="difflineplus">+    case nsMsgViewSortType::byRecipient:</span>
<a href="#l1.5124"></a><span id="l1.5124" class="difflineplus">+    case nsMsgViewSortType::byCorrespondent:</span>
<a href="#l1.5125"></a><span id="l1.5125" class="difflineplus">+      *pFieldType = kCollationKey;</span>
<a href="#l1.5126"></a><span id="l1.5126" class="difflineplus">+      *pMaxLen = kMaxRecipientKey;</span>
<a href="#l1.5127"></a><span id="l1.5127" class="difflineplus">+      break;</span>
<a href="#l1.5128"></a><span id="l1.5128" class="difflineplus">+    case nsMsgViewSortType::byAuthor:</span>
<a href="#l1.5129"></a><span id="l1.5129" class="difflineplus">+      *pFieldType = kCollationKey;</span>
<a href="#l1.5130"></a><span id="l1.5130" class="difflineplus">+      *pMaxLen = kMaxAuthorKey;</span>
<a href="#l1.5131"></a><span id="l1.5131" class="difflineplus">+      break;</span>
<a href="#l1.5132"></a><span id="l1.5132" class="difflineplus">+    case nsMsgViewSortType::byDate:</span>
<a href="#l1.5133"></a><span id="l1.5133" class="difflineplus">+    case nsMsgViewSortType::byReceived:</span>
<a href="#l1.5134"></a><span id="l1.5134" class="difflineplus">+    case nsMsgViewSortType::byPriority:</span>
<a href="#l1.5135"></a><span id="l1.5135" class="difflineplus">+    case nsMsgViewSortType::byThread:</span>
<a href="#l1.5136"></a><span id="l1.5136" class="difflineplus">+    case nsMsgViewSortType::byId:</span>
<a href="#l1.5137"></a><span id="l1.5137" class="difflineplus">+    case nsMsgViewSortType::bySize:</span>
<a href="#l1.5138"></a><span id="l1.5138" class="difflineplus">+    case nsMsgViewSortType::byFlagged:</span>
<a href="#l1.5139"></a><span id="l1.5139" class="difflineplus">+    case nsMsgViewSortType::byUnread:</span>
<a href="#l1.5140"></a><span id="l1.5140" class="difflineplus">+    case nsMsgViewSortType::byStatus:</span>
<a href="#l1.5141"></a><span id="l1.5141" class="difflineplus">+    case nsMsgViewSortType::byJunkStatus:</span>
<a href="#l1.5142"></a><span id="l1.5142" class="difflineplus">+    case nsMsgViewSortType::byAttachments:</span>
<a href="#l1.5143"></a><span id="l1.5143" class="difflineplus">+      *pFieldType = kU32;</span>
<a href="#l1.5144"></a><span id="l1.5144" class="difflineplus">+      *pMaxLen = 0;</span>
<a href="#l1.5145"></a><span id="l1.5145" class="difflineplus">+      break;</span>
<a href="#l1.5146"></a><span id="l1.5146" class="difflineplus">+    case nsMsgViewSortType::byCustom:</span>
<a href="#l1.5147"></a><span id="l1.5147" class="difflineplus">+    {</span>
<a href="#l1.5148"></a><span id="l1.5148" class="difflineplus">+      if (colHandler == nullptr)</span>
<a href="#l1.5149"></a><span id="l1.5149" class="difflineplus">+      {</span>
<a href="#l1.5150"></a><span id="l1.5150" class="difflineplus">+        NS_WARNING(&quot;colHandler is null. *pFieldType is not set.&quot;);</span>
<a href="#l1.5151"></a><span id="l1.5151" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l1.5152"></a><span id="l1.5152" class="difflineplus">+      }</span>
<a href="#l1.5153"></a><span id="l1.5153" class="difflineplus">+</span>
<a href="#l1.5154"></a><span id="l1.5154" class="difflineplus">+      bool isString;</span>
<a href="#l1.5155"></a><span id="l1.5155" class="difflineplus">+      colHandler-&gt;IsString(&amp;isString);</span>
<a href="#l1.5156"></a><span id="l1.5156" class="difflineplus">+</span>
<a href="#l1.5157"></a><span id="l1.5157" class="difflineplus">+      if (isString)</span>
<a href="#l1.5158"></a><span id="l1.5158" class="difflineplus">+      {</span>
<a href="#l1.5159"></a><span id="l1.5159" class="difflineplus">+        *pFieldType = kCollationKey;</span>
<a href="#l1.5160"></a><span id="l1.5160" class="difflineplus">+        // 80 - do we need a seperate k?</span>
<a href="#l1.5161"></a><span id="l1.5161" class="difflineplus">+        *pMaxLen = kMaxRecipientKey;</span>
<a href="#l1.5162"></a><span id="l1.5162" class="difflineplus">+      }</span>
<a href="#l1.5163"></a><span id="l1.5163" class="difflineplus">+      else</span>
<a href="#l1.5164"></a><span id="l1.5164" class="difflineplus">+      {</span>
<a href="#l1.5165"></a><span id="l1.5165" class="difflineplus">+        *pFieldType = kU32;</span>
<a href="#l1.5166"></a><span id="l1.5166" class="difflineplus">+        *pMaxLen = 0;</span>
<a href="#l1.5167"></a><span id="l1.5167" class="difflineplus">+      }</span>
<a href="#l1.5168"></a><span id="l1.5168" class="difflineplus">+      break;</span>
<a href="#l1.5169"></a><span id="l1.5169" class="difflineplus">+    }</span>
<a href="#l1.5170"></a><span id="l1.5170" class="difflineplus">+    case nsMsgViewSortType::byNone:</span>
<a href="#l1.5171"></a><span id="l1.5171" class="difflineplus">+      // Bug 901948.</span>
<a href="#l1.5172"></a><span id="l1.5172" class="difflineplus">+      return NS_ERROR_INVALID_ARG;</span>
<a href="#l1.5173"></a><span id="l1.5173" class="difflineplus">+    default:</span>
<a href="#l1.5174"></a><span id="l1.5174" class="difflineplus">+    {</span>
<a href="#l1.5175"></a><span id="l1.5175" class="difflineplus">+      nsAutoCString message(&quot;unexpected switch value: sortType=&quot;);</span>
<a href="#l1.5176"></a><span id="l1.5176" class="difflineplus">+      message.AppendInt(sortType);</span>
<a href="#l1.5177"></a><span id="l1.5177" class="difflineplus">+      NS_WARNING(message.get());</span>
<a href="#l1.5178"></a><span id="l1.5178" class="difflineplus">+      return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.5179"></a><span id="l1.5179" class="difflineplus">+    }</span>
<a href="#l1.5180"></a><span id="l1.5180" class="difflineplus">+  }</span>
<a href="#l1.5181"></a><span id="l1.5181" class="difflineplus">+</span>
<a href="#l1.5182"></a><span id="l1.5182" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.5183"></a><span id="l1.5183"> }</span>
<a href="#l1.5184"></a><span id="l1.5184"> </span>
<a href="#l1.5185"></a><span id="l1.5185"> #define MSG_STATUS_MASK (nsMsgMessageFlags::Replied | nsMsgMessageFlags::Forwarded)</span>
<a href="#l1.5186"></a><span id="l1.5186"> </span>
<a href="#l1.5187"></a><span id="l1.5187" class="difflineminus">-nsresult nsMsgDBView::GetStatusSortValue(nsIMsgDBHdr *msgHdr, uint32_t *result)</span>
<a href="#l1.5188"></a><span id="l1.5188" class="difflineplus">+nsresult</span>
<a href="#l1.5189"></a><span id="l1.5189" class="difflineplus">+nsMsgDBView::GetStatusSortValue(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.5190"></a><span id="l1.5190" class="difflineplus">+                                uint32_t *result)</span>
<a href="#l1.5191"></a><span id="l1.5191"> {</span>
<a href="#l1.5192"></a><span id="l1.5192">   NS_ENSURE_ARG_POINTER(msgHdr);</span>
<a href="#l1.5193"></a><span id="l1.5193">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l1.5194"></a><span id="l1.5194"> </span>
<a href="#l1.5195"></a><span id="l1.5195">   uint32_t messageFlags;</span>
<a href="#l1.5196"></a><span id="l1.5196">   nsresult rv = msgHdr-&gt;GetFlags(&amp;messageFlags);</span>
<a href="#l1.5197"></a><span id="l1.5197">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5198"></a><span id="l1.5198"> </span>
<a href="#l1.5199"></a><span id="l1.5199">   if (messageFlags &amp; nsMsgMessageFlags::New)</span>
<a href="#l1.5200"></a><span id="l1.5200">   {</span>
<a href="#l1.5201"></a><span id="l1.5201" class="difflineminus">-    // happily, new by definition stands alone</span>
<a href="#l1.5202"></a><span id="l1.5202" class="difflineplus">+    // Happily, new by definition stands alone.</span>
<a href="#l1.5203"></a><span id="l1.5203">     *result = 0;</span>
<a href="#l1.5204"></a><span id="l1.5204">     return NS_OK;</span>
<a href="#l1.5205"></a><span id="l1.5205">   }</span>
<a href="#l1.5206"></a><span id="l1.5206"> </span>
<a href="#l1.5207"></a><span id="l1.5207">   switch (messageFlags &amp; MSG_STATUS_MASK)</span>
<a href="#l1.5208"></a><span id="l1.5208">   {</span>
<a href="#l1.5209"></a><span id="l1.5209">     case nsMsgMessageFlags::Replied:</span>
<a href="#l1.5210"></a><span id="l1.5210" class="difflineminus">-        *result = 2;</span>
<a href="#l1.5211"></a><span id="l1.5211" class="difflineminus">-        break;</span>
<a href="#l1.5212"></a><span id="l1.5212" class="difflineplus">+      *result = 2;</span>
<a href="#l1.5213"></a><span id="l1.5213" class="difflineplus">+      break;</span>
<a href="#l1.5214"></a><span id="l1.5214">     case nsMsgMessageFlags::Forwarded | nsMsgMessageFlags::Replied:</span>
<a href="#l1.5215"></a><span id="l1.5215" class="difflineminus">-        *result = 1;</span>
<a href="#l1.5216"></a><span id="l1.5216" class="difflineminus">-        break;</span>
<a href="#l1.5217"></a><span id="l1.5217" class="difflineplus">+      *result = 1;</span>
<a href="#l1.5218"></a><span id="l1.5218" class="difflineplus">+      break;</span>
<a href="#l1.5219"></a><span id="l1.5219">     case nsMsgMessageFlags::Forwarded:</span>
<a href="#l1.5220"></a><span id="l1.5220" class="difflineminus">-        *result = 3;</span>
<a href="#l1.5221"></a><span id="l1.5221" class="difflineminus">-        break;</span>
<a href="#l1.5222"></a><span id="l1.5222" class="difflineplus">+      *result = 3;</span>
<a href="#l1.5223"></a><span id="l1.5223" class="difflineplus">+      break;</span>
<a href="#l1.5224"></a><span id="l1.5224">     default:</span>
<a href="#l1.5225"></a><span id="l1.5225" class="difflineminus">-        *result = (messageFlags &amp; nsMsgMessageFlags::Read) ? 4 : 5;</span>
<a href="#l1.5226"></a><span id="l1.5226" class="difflineminus">-        break;</span>
<a href="#l1.5227"></a><span id="l1.5227" class="difflineminus">-    }</span>
<a href="#l1.5228"></a><span id="l1.5228" class="difflineminus">-</span>
<a href="#l1.5229"></a><span id="l1.5229" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.5230"></a><span id="l1.5230" class="difflineminus">-}</span>
<a href="#l1.5231"></a><span id="l1.5231" class="difflineminus">-</span>
<a href="#l1.5232"></a><span id="l1.5232" class="difflineminus">-nsresult nsMsgDBView::GetLongField(nsIMsgDBHdr *msgHdr, nsMsgViewSortTypeValue sortType, uint32_t *result, nsIMsgCustomColumnHandler* colHandler)</span>
<a href="#l1.5233"></a><span id="l1.5233" class="difflineplus">+      *result = (messageFlags &amp; nsMsgMessageFlags::Read) ? 4 : 5;</span>
<a href="#l1.5234"></a><span id="l1.5234" class="difflineplus">+      break;</span>
<a href="#l1.5235"></a><span id="l1.5235" class="difflineplus">+  }</span>
<a href="#l1.5236"></a><span id="l1.5236" class="difflineplus">+</span>
<a href="#l1.5237"></a><span id="l1.5237" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.5238"></a><span id="l1.5238" class="difflineplus">+}</span>
<a href="#l1.5239"></a><span id="l1.5239" class="difflineplus">+</span>
<a href="#l1.5240"></a><span id="l1.5240" class="difflineplus">+nsresult nsMsgDBView::GetLongField(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.5241"></a><span id="l1.5241" class="difflineplus">+                                   nsMsgViewSortTypeValue sortType,</span>
<a href="#l1.5242"></a><span id="l1.5242" class="difflineplus">+                                   uint32_t *result,</span>
<a href="#l1.5243"></a><span id="l1.5243" class="difflineplus">+                                   nsIMsgCustomColumnHandler* colHandler)</span>
<a href="#l1.5244"></a><span id="l1.5244"> {</span>
<a href="#l1.5245"></a><span id="l1.5245">   nsresult rv;</span>
<a href="#l1.5246"></a><span id="l1.5246">   NS_ENSURE_ARG_POINTER(msgHdr);</span>
<a href="#l1.5247"></a><span id="l1.5247">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l1.5248"></a><span id="l1.5248"> </span>
<a href="#l1.5249"></a><span id="l1.5249">   bool isRead;</span>
<a href="#l1.5250"></a><span id="l1.5250">   uint32_t bits;</span>
<a href="#l1.5251"></a><span id="l1.5251"> </span>
<a href="#l1.5252"></a><span id="l1.5252">   switch (sortType)</span>
<a href="#l1.5253"></a><span id="l1.5253">   {</span>
<a href="#l1.5254"></a><span id="l1.5254">     case nsMsgViewSortType::bySize:</span>
<a href="#l1.5255"></a><span id="l1.5255" class="difflineminus">-      rv = (mShowSizeInLines) ? msgHdr-&gt;GetLineCount(result) : msgHdr-&gt;GetMessageSize(result);</span>
<a href="#l1.5256"></a><span id="l1.5256" class="difflineplus">+      rv = (mShowSizeInLines) ? msgHdr-&gt;GetLineCount(result) :</span>
<a href="#l1.5257"></a><span id="l1.5257" class="difflineplus">+                                msgHdr-&gt;GetMessageSize(result);</span>
<a href="#l1.5258"></a><span id="l1.5258">       break;</span>
<a href="#l1.5259"></a><span id="l1.5259">     case nsMsgViewSortType::byPriority:</span>
<a href="#l1.5260"></a><span id="l1.5260" class="difflineminus">-        nsMsgPriorityValue priority;</span>
<a href="#l1.5261"></a><span id="l1.5261" class="difflineminus">-        rv = msgHdr-&gt;GetPriority(&amp;priority);</span>
<a href="#l1.5262"></a><span id="l1.5262" class="difflineminus">-</span>
<a href="#l1.5263"></a><span id="l1.5263" class="difflineminus">-        // treat &quot;none&quot; as &quot;normal&quot; when sorting.</span>
<a href="#l1.5264"></a><span id="l1.5264" class="difflineminus">-        if (priority == nsMsgPriority::none)</span>
<a href="#l1.5265"></a><span id="l1.5265" class="difflineminus">-            priority = nsMsgPriority::normal;</span>
<a href="#l1.5266"></a><span id="l1.5266" class="difflineminus">-</span>
<a href="#l1.5267"></a><span id="l1.5267" class="difflineminus">-        // we want highest priority to have lowest value</span>
<a href="#l1.5268"></a><span id="l1.5268" class="difflineminus">-        // so ascending sort will have highest priority first.</span>
<a href="#l1.5269"></a><span id="l1.5269" class="difflineminus">-        *result = nsMsgPriority::highest - priority;</span>
<a href="#l1.5270"></a><span id="l1.5270" class="difflineminus">-        break;</span>
<a href="#l1.5271"></a><span id="l1.5271" class="difflineplus">+      nsMsgPriorityValue priority;</span>
<a href="#l1.5272"></a><span id="l1.5272" class="difflineplus">+      rv = msgHdr-&gt;GetPriority(&amp;priority);</span>
<a href="#l1.5273"></a><span id="l1.5273" class="difflineplus">+      // Treat &quot;none&quot; as &quot;normal&quot; when sorting.</span>
<a href="#l1.5274"></a><span id="l1.5274" class="difflineplus">+      if (priority == nsMsgPriority::none)</span>
<a href="#l1.5275"></a><span id="l1.5275" class="difflineplus">+        priority = nsMsgPriority::normal;</span>
<a href="#l1.5276"></a><span id="l1.5276" class="difflineplus">+</span>
<a href="#l1.5277"></a><span id="l1.5277" class="difflineplus">+      // We want highest priority to have lowest value</span>
<a href="#l1.5278"></a><span id="l1.5278" class="difflineplus">+      // so ascending sort will have highest priority first.</span>
<a href="#l1.5279"></a><span id="l1.5279" class="difflineplus">+      *result = nsMsgPriority::highest - priority;</span>
<a href="#l1.5280"></a><span id="l1.5280" class="difflineplus">+      break;</span>
<a href="#l1.5281"></a><span id="l1.5281">     case nsMsgViewSortType::byStatus:</span>
<a href="#l1.5282"></a><span id="l1.5282" class="difflineminus">-        rv = GetStatusSortValue(msgHdr,result);</span>
<a href="#l1.5283"></a><span id="l1.5283" class="difflineminus">-        break;</span>
<a href="#l1.5284"></a><span id="l1.5284" class="difflineplus">+      rv = GetStatusSortValue(msgHdr,result);</span>
<a href="#l1.5285"></a><span id="l1.5285" class="difflineplus">+      break;</span>
<a href="#l1.5286"></a><span id="l1.5286">     case nsMsgViewSortType::byFlagged:</span>
<a href="#l1.5287"></a><span id="l1.5287" class="difflineminus">-        bits = 0;</span>
<a href="#l1.5288"></a><span id="l1.5288" class="difflineminus">-        rv = msgHdr-&gt;GetFlags(&amp;bits);</span>
<a href="#l1.5289"></a><span id="l1.5289" class="difflineminus">-        *result = !(bits &amp; nsMsgMessageFlags::Marked);  //make flagged come out on top.</span>
<a href="#l1.5290"></a><span id="l1.5290" class="difflineminus">-        break;</span>
<a href="#l1.5291"></a><span id="l1.5291" class="difflineplus">+      bits = 0;</span>
<a href="#l1.5292"></a><span id="l1.5292" class="difflineplus">+      rv = msgHdr-&gt;GetFlags(&amp;bits);</span>
<a href="#l1.5293"></a><span id="l1.5293" class="difflineplus">+      // Make flagged come out on top.</span>
<a href="#l1.5294"></a><span id="l1.5294" class="difflineplus">+      *result = !(bits &amp; nsMsgMessageFlags::Marked);</span>
<a href="#l1.5295"></a><span id="l1.5295" class="difflineplus">+      break;</span>
<a href="#l1.5296"></a><span id="l1.5296">     case nsMsgViewSortType::byUnread:</span>
<a href="#l1.5297"></a><span id="l1.5297" class="difflineminus">-        rv = msgHdr-&gt;GetIsRead(&amp;isRead);</span>
<a href="#l1.5298"></a><span id="l1.5298" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l1.5299"></a><span id="l1.5299" class="difflineminus">-            *result = !isRead;</span>
<a href="#l1.5300"></a><span id="l1.5300" class="difflineminus">-        break;</span>
<a href="#l1.5301"></a><span id="l1.5301" class="difflineplus">+      rv = msgHdr-&gt;GetIsRead(&amp;isRead);</span>
<a href="#l1.5302"></a><span id="l1.5302" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l1.5303"></a><span id="l1.5303" class="difflineplus">+        *result = !isRead;</span>
<a href="#l1.5304"></a><span id="l1.5304" class="difflineplus">+</span>
<a href="#l1.5305"></a><span id="l1.5305" class="difflineplus">+      break;</span>
<a href="#l1.5306"></a><span id="l1.5306">     case nsMsgViewSortType::byJunkStatus:</span>
<a href="#l1.5307"></a><span id="l1.5307" class="difflineminus">-      {</span>
<a href="#l1.5308"></a><span id="l1.5308" class="difflineminus">-        nsCString junkScoreStr;</span>
<a href="#l1.5309"></a><span id="l1.5309" class="difflineminus">-        rv = msgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l1.5310"></a><span id="l1.5310" class="difflineminus">-        // unscored messages should come before messages that are scored</span>
<a href="#l1.5311"></a><span id="l1.5311" class="difflineminus">-        // junkScoreStr is &quot;&quot;, and &quot;0&quot; - &quot;100&quot;</span>
<a href="#l1.5312"></a><span id="l1.5312" class="difflineminus">-        // normalize to 0 - 101</span>
<a href="#l1.5313"></a><span id="l1.5313" class="difflineminus">-        *result = junkScoreStr.IsEmpty() ? (0) : atoi(junkScoreStr.get()) + 1;</span>
<a href="#l1.5314"></a><span id="l1.5314" class="difflineminus">-      }</span>
<a href="#l1.5315"></a><span id="l1.5315" class="difflineminus">-      break;</span>
<a href="#l1.5316"></a><span id="l1.5316" class="difflineminus">-     case nsMsgViewSortType::byAttachments:</span>
<a href="#l1.5317"></a><span id="l1.5317" class="difflineminus">-        bits = 0;</span>
<a href="#l1.5318"></a><span id="l1.5318" class="difflineminus">-        rv = msgHdr-&gt;GetFlags(&amp;bits);</span>
<a href="#l1.5319"></a><span id="l1.5319" class="difflineminus">-        *result = !(bits &amp; nsMsgMessageFlags::Attachment);</span>
<a href="#l1.5320"></a><span id="l1.5320" class="difflineplus">+    {</span>
<a href="#l1.5321"></a><span id="l1.5321" class="difflineplus">+      nsCString junkScoreStr;</span>
<a href="#l1.5322"></a><span id="l1.5322" class="difflineplus">+      rv = msgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l1.5323"></a><span id="l1.5323" class="difflineplus">+      // Unscored messages should come before messages that are scored</span>
<a href="#l1.5324"></a><span id="l1.5324" class="difflineplus">+      // junkScoreStr is &quot;&quot;, and &quot;0&quot; - &quot;100&quot;; normalize to 0 - 101.</span>
<a href="#l1.5325"></a><span id="l1.5325" class="difflineplus">+      *result = junkScoreStr.IsEmpty() ? (0) : atoi(junkScoreStr.get()) + 1;</span>
<a href="#l1.5326"></a><span id="l1.5326" class="difflineplus">+      break;</span>
<a href="#l1.5327"></a><span id="l1.5327" class="difflineplus">+    }</span>
<a href="#l1.5328"></a><span id="l1.5328" class="difflineplus">+    case nsMsgViewSortType::byAttachments:</span>
<a href="#l1.5329"></a><span id="l1.5329" class="difflineplus">+      bits = 0;</span>
<a href="#l1.5330"></a><span id="l1.5330" class="difflineplus">+      rv = msgHdr-&gt;GetFlags(&amp;bits);</span>
<a href="#l1.5331"></a><span id="l1.5331" class="difflineplus">+      *result = !(bits &amp; nsMsgMessageFlags::Attachment);</span>
<a href="#l1.5332"></a><span id="l1.5332">       break;</span>
<a href="#l1.5333"></a><span id="l1.5333">     case nsMsgViewSortType::byDate:</span>
<a href="#l1.5334"></a><span id="l1.5334" class="difflineminus">-      // when sorting threads by date, we may want the date of the newest msg</span>
<a href="#l1.5335"></a><span id="l1.5335" class="difflineminus">-      // in the thread</span>
<a href="#l1.5336"></a><span id="l1.5336" class="difflineminus">-      if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay</span>
<a href="#l1.5337"></a><span id="l1.5337" class="difflineminus">-        &amp;&amp; ! (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort)</span>
<a href="#l1.5338"></a><span id="l1.5338" class="difflineminus">-        &amp;&amp; ! mSortThreadsByRoot)</span>
<a href="#l1.5339"></a><span id="l1.5339" class="difflineplus">+      // When sorting threads by date, we may want the date of the newest msg</span>
<a href="#l1.5340"></a><span id="l1.5340" class="difflineplus">+      // in the thread.</span>
<a href="#l1.5341"></a><span id="l1.5341" class="difflineplus">+      if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay &amp;&amp;</span>
<a href="#l1.5342"></a><span id="l1.5342" class="difflineplus">+          !(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort) &amp;&amp;</span>
<a href="#l1.5343"></a><span id="l1.5343" class="difflineplus">+          !mSortThreadsByRoot)</span>
<a href="#l1.5344"></a><span id="l1.5344">       {</span>
<a href="#l1.5345"></a><span id="l1.5345">         nsCOMPtr &lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.5346"></a><span id="l1.5346">         rv = GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(thread));</span>
<a href="#l1.5347"></a><span id="l1.5347">         if (NS_SUCCEEDED(rv))</span>
<a href="#l1.5348"></a><span id="l1.5348">         {</span>
<a href="#l1.5349"></a><span id="l1.5349">           thread-&gt;GetNewestMsgDate(result);</span>
<a href="#l1.5350"></a><span id="l1.5350">           break;</span>
<a href="#l1.5351"></a><span id="l1.5351">         }</span>
<a href="#l1.5352"></a><span id="l1.5352">       }</span>
<a href="#l1.5353"></a><span id="l1.5353">       rv = msgHdr-&gt;GetDateInSeconds(result);</span>
<a href="#l1.5354"></a><span id="l1.5354">       break;</span>
<a href="#l1.5355"></a><span id="l1.5355">     case nsMsgViewSortType::byReceived:</span>
<a href="#l1.5356"></a><span id="l1.5356" class="difflineminus">-      // when sorting threads by received date, we may want the received date</span>
<a href="#l1.5357"></a><span id="l1.5357" class="difflineminus">-      // of the newest msg in the thread</span>
<a href="#l1.5358"></a><span id="l1.5358" class="difflineminus">-      if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay</span>
<a href="#l1.5359"></a><span id="l1.5359" class="difflineminus">-        &amp;&amp; ! (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort)</span>
<a href="#l1.5360"></a><span id="l1.5360" class="difflineminus">-        &amp;&amp; ! mSortThreadsByRoot)</span>
<a href="#l1.5361"></a><span id="l1.5361" class="difflineplus">+      // When sorting threads by received date, we may want the received date</span>
<a href="#l1.5362"></a><span id="l1.5362" class="difflineplus">+      // of the newest msg in the thread.</span>
<a href="#l1.5363"></a><span id="l1.5363" class="difflineplus">+      if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay &amp;&amp;</span>
<a href="#l1.5364"></a><span id="l1.5364" class="difflineplus">+          !(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort) &amp;&amp;</span>
<a href="#l1.5365"></a><span id="l1.5365" class="difflineplus">+          !mSortThreadsByRoot)</span>
<a href="#l1.5366"></a><span id="l1.5366">       {</span>
<a href="#l1.5367"></a><span id="l1.5367">         nsCOMPtr &lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.5368"></a><span id="l1.5368">         rv = GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(thread));</span>
<a href="#l1.5369"></a><span id="l1.5369">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.5370"></a><span id="l1.5370">         thread-&gt;GetNewestMsgDate(result);</span>
<a href="#l1.5371"></a><span id="l1.5371">       }</span>
<a href="#l1.5372"></a><span id="l1.5372">       else</span>
<a href="#l1.5373"></a><span id="l1.5373">       {</span>
<a href="#l1.5374"></a><span id="l1.5374" class="difflineminus">-        rv = msgHdr-&gt;GetUint32Property(&quot;dateReceived&quot;, result);  // Already in seconds...</span>
<a href="#l1.5375"></a><span id="l1.5375" class="difflineminus">-        if (*result == 0)  // Use Date instead, we have no Received property</span>
<a href="#l1.5376"></a><span id="l1.5376" class="difflineplus">+        // Already in seconds.</span>
<a href="#l1.5377"></a><span id="l1.5377" class="difflineplus">+        rv = msgHdr-&gt;GetUint32Property(&quot;dateReceived&quot;, result);</span>
<a href="#l1.5378"></a><span id="l1.5378" class="difflineplus">+        if (*result == 0)</span>
<a href="#l1.5379"></a><span id="l1.5379" class="difflineplus">+          // Use Date instead, we have no Received property</span>
<a href="#l1.5380"></a><span id="l1.5380">           rv = msgHdr-&gt;GetDateInSeconds(result);</span>
<a href="#l1.5381"></a><span id="l1.5381">       }</span>
<a href="#l1.5382"></a><span id="l1.5382">       break;</span>
<a href="#l1.5383"></a><span id="l1.5383">     case nsMsgViewSortType::byCustom:</span>
<a href="#l1.5384"></a><span id="l1.5384">       if (colHandler != nullptr)</span>
<a href="#l1.5385"></a><span id="l1.5385">       {</span>
<a href="#l1.5386"></a><span id="l1.5386">         colHandler-&gt;GetSortLongForRow(msgHdr, result);</span>
<a href="#l1.5387"></a><span id="l1.5387">         rv = NS_OK;</span>
<a href="#l1.5388"></a><span id="l1.5388">       }</span>
<a href="#l1.5389"></a><span id="l1.5389">       else</span>
<a href="#l1.5390"></a><span id="l1.5390">       {</span>
<a href="#l1.5391"></a><span id="l1.5391">         NS_ASSERTION(false, &quot;should not be here (Sort Type: byCustom (Long), but no custom handler)&quot;);</span>
<a href="#l1.5392"></a><span id="l1.5392">         rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.5393"></a><span id="l1.5393">       }</span>
<a href="#l1.5394"></a><span id="l1.5394">       break;</span>
<a href="#l1.5395"></a><span id="l1.5395" class="difflineminus">-    case nsMsgViewSortType::byNone: // Bug 901948</span>
<a href="#l1.5396"></a><span id="l1.5396" class="difflineplus">+    case nsMsgViewSortType::byNone:</span>
<a href="#l1.5397"></a><span id="l1.5397" class="difflineplus">+      // Bug 901948.</span>
<a href="#l1.5398"></a><span id="l1.5398">       return NS_ERROR_INVALID_ARG;</span>
<a href="#l1.5399"></a><span id="l1.5399"> </span>
<a href="#l1.5400"></a><span id="l1.5400">     case nsMsgViewSortType::byId:</span>
<a href="#l1.5401"></a><span id="l1.5401" class="difflineminus">-        // handled by caller, since caller knows the key</span>
<a href="#l1.5402"></a><span id="l1.5402" class="difflineplus">+      // Handled by caller, since caller knows the key.</span>
<a href="#l1.5403"></a><span id="l1.5403">     default:</span>
<a href="#l1.5404"></a><span id="l1.5404" class="difflineminus">-        NS_ERROR(&quot;should not be here&quot;);</span>
<a href="#l1.5405"></a><span id="l1.5405" class="difflineminus">-        rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.5406"></a><span id="l1.5406" class="difflineminus">-        break;</span>
<a href="#l1.5407"></a><span id="l1.5407" class="difflineplus">+      NS_ERROR(&quot;should not be here&quot;);</span>
<a href="#l1.5408"></a><span id="l1.5408" class="difflineplus">+      rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.5409"></a><span id="l1.5409" class="difflineplus">+      break;</span>
<a href="#l1.5410"></a><span id="l1.5410">     }</span>
<a href="#l1.5411"></a><span id="l1.5411"> </span>
<a href="#l1.5412"></a><span id="l1.5412">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5413"></a><span id="l1.5413">     return NS_OK;</span>
<a href="#l1.5414"></a><span id="l1.5414"> }</span>
<a href="#l1.5415"></a><span id="l1.5415"> </span>
<a href="#l1.5416"></a><span id="l1.5416"> MsgViewSortColumnInfo::MsgViewSortColumnInfo(const MsgViewSortColumnInfo &amp;other)</span>
<a href="#l1.5417"></a><span id="l1.5417"> {</span>
<a href="#l1.5418"></a><span id="l1.5418" class="difflineat">@@ -4151,256 +4592,286 @@ MsgViewSortColumnInfo::MsgViewSortColumn</span>
<a href="#l1.5419"></a><span id="l1.5419"> }</span>
<a href="#l1.5420"></a><span id="l1.5420"> </span>
<a href="#l1.5421"></a><span id="l1.5421"> bool MsgViewSortColumnInfo::operator== (const MsgViewSortColumnInfo&amp; other) const</span>
<a href="#l1.5422"></a><span id="l1.5422"> {</span>
<a href="#l1.5423"></a><span id="l1.5423">   return (mSortType == nsMsgViewSortType::byCustom) ?</span>
<a href="#l1.5424"></a><span id="l1.5424">     mCustomColumnName.Equals(other.mCustomColumnName) : mSortType == other.mSortType;</span>
<a href="#l1.5425"></a><span id="l1.5425"> }</span>
<a href="#l1.5426"></a><span id="l1.5426"> </span>
<a href="#l1.5427"></a><span id="l1.5427" class="difflineminus">-nsresult nsMsgDBView::EncodeColumnSort(nsString &amp;columnSortString)</span>
<a href="#l1.5428"></a><span id="l1.5428" class="difflineplus">+nsresult</span>
<a href="#l1.5429"></a><span id="l1.5429" class="difflineplus">+nsMsgDBView::EncodeColumnSort(nsString &amp;columnSortString)</span>
<a href="#l1.5430"></a><span id="l1.5430"> {</span>
<a href="#l1.5431"></a><span id="l1.5431">   for (uint32_t i = 0; i &lt; m_sortColumns.Length(); i++)</span>
<a href="#l1.5432"></a><span id="l1.5432">   {</span>
<a href="#l1.5433"></a><span id="l1.5433">     MsgViewSortColumnInfo &amp;sortInfo = m_sortColumns[i];</span>
<a href="#l1.5434"></a><span id="l1.5434">     columnSortString.Append((char) sortInfo.mSortType);</span>
<a href="#l1.5435"></a><span id="l1.5435">     columnSortString.Append((char) sortInfo.mSortOrder + '0');</span>
<a href="#l1.5436"></a><span id="l1.5436">     if (sortInfo.mSortType == nsMsgViewSortType::byCustom)</span>
<a href="#l1.5437"></a><span id="l1.5437">     {</span>
<a href="#l1.5438"></a><span id="l1.5438">       columnSortString.Append(sortInfo.mCustomColumnName);</span>
<a href="#l1.5439"></a><span id="l1.5439">       columnSortString.Append((char16_t) '\r');</span>
<a href="#l1.5440"></a><span id="l1.5440">     }</span>
<a href="#l1.5441"></a><span id="l1.5441">   }</span>
<a href="#l1.5442"></a><span id="l1.5442" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.5443"></a><span id="l1.5443" class="difflineminus">-}</span>
<a href="#l1.5444"></a><span id="l1.5444" class="difflineminus">-</span>
<a href="#l1.5445"></a><span id="l1.5445" class="difflineminus">-nsresult nsMsgDBView::DecodeColumnSort(nsString &amp;columnSortString)</span>
<a href="#l1.5446"></a><span id="l1.5446" class="difflineplus">+</span>
<a href="#l1.5447"></a><span id="l1.5447" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.5448"></a><span id="l1.5448" class="difflineplus">+}</span>
<a href="#l1.5449"></a><span id="l1.5449" class="difflineplus">+</span>
<a href="#l1.5450"></a><span id="l1.5450" class="difflineplus">+nsresult</span>
<a href="#l1.5451"></a><span id="l1.5451" class="difflineplus">+nsMsgDBView::DecodeColumnSort(nsString &amp;columnSortString)</span>
<a href="#l1.5452"></a><span id="l1.5452"> {</span>
<a href="#l1.5453"></a><span id="l1.5453">   const char16_t *stringPtr = columnSortString.BeginReading();</span>
<a href="#l1.5454"></a><span id="l1.5454">   while (*stringPtr)</span>
<a href="#l1.5455"></a><span id="l1.5455">   {</span>
<a href="#l1.5456"></a><span id="l1.5456">     MsgViewSortColumnInfo sortColumnInfo;</span>
<a href="#l1.5457"></a><span id="l1.5457">     sortColumnInfo.mSortType = (nsMsgViewSortTypeValue) *stringPtr++;</span>
<a href="#l1.5458"></a><span id="l1.5458">     sortColumnInfo.mSortOrder = (nsMsgViewSortOrderValue) (*stringPtr++) - '0';</span>
<a href="#l1.5459"></a><span id="l1.5459">     if (sortColumnInfo.mSortType == nsMsgViewSortType::byCustom)</span>
<a href="#l1.5460"></a><span id="l1.5460">     {</span>
<a href="#l1.5461"></a><span id="l1.5461">       while (*stringPtr &amp;&amp; *stringPtr != '\r')</span>
<a href="#l1.5462"></a><span id="l1.5462">         sortColumnInfo.mCustomColumnName.Append(*stringPtr++);</span>
<a href="#l1.5463"></a><span id="l1.5463" class="difflineminus">-      sortColumnInfo.mColHandler = GetColumnHandler(sortColumnInfo.mCustomColumnName.get());</span>
<a href="#l1.5464"></a><span id="l1.5464" class="difflineminus">-      if (*stringPtr) // advance past '\r'</span>
<a href="#l1.5465"></a><span id="l1.5465" class="difflineplus">+</span>
<a href="#l1.5466"></a><span id="l1.5466" class="difflineplus">+      sortColumnInfo.mColHandler =</span>
<a href="#l1.5467"></a><span id="l1.5467" class="difflineplus">+        GetColumnHandler(sortColumnInfo.mCustomColumnName.get());</span>
<a href="#l1.5468"></a><span id="l1.5468" class="difflineplus">+</span>
<a href="#l1.5469"></a><span id="l1.5469" class="difflineplus">+      // Advance past '\r'.</span>
<a href="#l1.5470"></a><span id="l1.5470" class="difflineplus">+      if (*stringPtr)</span>
<a href="#l1.5471"></a><span id="l1.5471">         stringPtr++;</span>
<a href="#l1.5472"></a><span id="l1.5472">     }</span>
<a href="#l1.5473"></a><span id="l1.5473" class="difflineplus">+</span>
<a href="#l1.5474"></a><span id="l1.5474">     m_sortColumns.AppendElement(sortColumnInfo);</span>
<a href="#l1.5475"></a><span id="l1.5475">   }</span>
<a href="#l1.5476"></a><span id="l1.5476" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.5477"></a><span id="l1.5477" class="difflineminus">-}</span>
<a href="#l1.5478"></a><span id="l1.5478" class="difflineminus">-</span>
<a href="#l1.5479"></a><span id="l1.5479" class="difflineminus">-//  cf. Secondary Sort Key: when you select a column to sort, that</span>
<a href="#l1.5480"></a><span id="l1.5480" class="difflineplus">+</span>
<a href="#l1.5481"></a><span id="l1.5481" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.5482"></a><span id="l1.5482" class="difflineplus">+}</span>
<a href="#l1.5483"></a><span id="l1.5483" class="difflineplus">+</span>
<a href="#l1.5484"></a><span id="l1.5484" class="difflineplus">+//  Secondary Sort Key: when you select a column to sort, that</span>
<a href="#l1.5485"></a><span id="l1.5485"> //  becomes the new Primary sort key, and all previous sort keys</span>
<a href="#l1.5486"></a><span id="l1.5486"> //  become secondary. For example, if you first click on Date,</span>
<a href="#l1.5487"></a><span id="l1.5487"> //  the messages are sorted by Date; then click on From, and now the</span>
<a href="#l1.5488"></a><span id="l1.5488"> //  messages are sorted by From, and for each value of From the</span>
<a href="#l1.5489"></a><span id="l1.5489"> //  messages are in Date order.</span>
<a href="#l1.5490"></a><span id="l1.5490"> </span>
<a href="#l1.5491"></a><span id="l1.5491" class="difflineminus">-void nsMsgDBView::PushSort(const MsgViewSortColumnInfo &amp;newSort)</span>
<a href="#l1.5492"></a><span id="l1.5492" class="difflineminus">-{</span>
<a href="#l1.5493"></a><span id="l1.5493" class="difflineminus">-  // DONE</span>
<a href="#l1.5494"></a><span id="l1.5494" class="difflineminus">-  //  Handle byNone (bug 901948) ala a mail/base/modules/dbViewerWrapper.js</span>
<a href="#l1.5495"></a><span id="l1.5495" class="difflineminus">-  //  where we don't push the secondary sort type if it's ::byNone;</span>
<a href="#l1.5496"></a><span id="l1.5496" class="difflineminus">-  //  (and secondary sort type is NOT the same as the first sort type</span>
<a href="#l1.5497"></a><span id="l1.5497" class="difflineminus">-  //  there.). This code should behave the same way.</span>
<a href="#l1.5498"></a><span id="l1.5498" class="difflineplus">+void</span>
<a href="#l1.5499"></a><span id="l1.5499" class="difflineplus">+nsMsgDBView::PushSort(const MsgViewSortColumnInfo &amp;newSort)</span>
<a href="#l1.5500"></a><span id="l1.5500" class="difflineplus">+{</span>
<a href="#l1.5501"></a><span id="l1.5501" class="difflineplus">+  // Handle byNone (bug 901948) ala a mail/base/modules/dbViewerWrapper.js</span>
<a href="#l1.5502"></a><span id="l1.5502" class="difflineplus">+  // where we don't push the secondary sort type if it's ::byNone;</span>
<a href="#l1.5503"></a><span id="l1.5503" class="difflineplus">+  // (and secondary sort type is NOT the same as the first sort type</span>
<a href="#l1.5504"></a><span id="l1.5504" class="difflineplus">+  // there). This code should behave the same way.</span>
<a href="#l1.5505"></a><span id="l1.5505"> </span>
<a href="#l1.5506"></a><span id="l1.5506">   // We don't expect to be passed sort type ::byNone,</span>
<a href="#l1.5507"></a><span id="l1.5507">   // but if we are it's safe to ignore it.</span>
<a href="#l1.5508"></a><span id="l1.5508">   if (newSort.mSortType == nsMsgViewSortType::byNone)</span>
<a href="#l1.5509"></a><span id="l1.5509">     return;</span>
<a href="#l1.5510"></a><span id="l1.5510"> </span>
<a href="#l1.5511"></a><span id="l1.5511">   // Date and ID are unique keys, so if we are sorting by them we don't</span>
<a href="#l1.5512"></a><span id="l1.5512">   // need to keep any secondary sort keys</span>
<a href="#l1.5513"></a><span id="l1.5513">   if (newSort.mSortType == nsMsgViewSortType::byDate ||</span>
<a href="#l1.5514"></a><span id="l1.5514" class="difflineminus">-      newSort.mSortType == nsMsgViewSortType::byId   )</span>
<a href="#l1.5515"></a><span id="l1.5515" class="difflineplus">+      newSort.mSortType == nsMsgViewSortType::byId)</span>
<a href="#l1.5516"></a><span id="l1.5516">     m_sortColumns.Clear();</span>
<a href="#l1.5517"></a><span id="l1.5517" class="difflineplus">+</span>
<a href="#l1.5518"></a><span id="l1.5518">   m_sortColumns.RemoveElement(newSort);</span>
<a href="#l1.5519"></a><span id="l1.5519">   m_sortColumns.InsertElementAt(0, newSort);</span>
<a href="#l1.5520"></a><span id="l1.5520">   if (m_sortColumns.Length() &gt; kMaxNumSortColumns)</span>
<a href="#l1.5521"></a><span id="l1.5521">     m_sortColumns.RemoveElementAt(kMaxNumSortColumns);</span>
<a href="#l1.5522"></a><span id="l1.5522"> }</span>
<a href="#l1.5523"></a><span id="l1.5523"> </span>
<a href="#l1.5524"></a><span id="l1.5524"> nsresult</span>
<a href="#l1.5525"></a><span id="l1.5525" class="difflineminus">-nsMsgDBView::GetCollationKey(nsIMsgDBHdr *msgHdr, nsMsgViewSortTypeValue sortType, uint8_t **result, uint32_t *len, nsIMsgCustomColumnHandler* colHandler)</span>
<a href="#l1.5526"></a><span id="l1.5526" class="difflineplus">+nsMsgDBView::GetCollationKey(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.5527"></a><span id="l1.5527" class="difflineplus">+                             nsMsgViewSortTypeValue sortType,</span>
<a href="#l1.5528"></a><span id="l1.5528" class="difflineplus">+                             uint8_t **result,</span>
<a href="#l1.5529"></a><span id="l1.5529" class="difflineplus">+                             uint32_t *len,</span>
<a href="#l1.5530"></a><span id="l1.5530" class="difflineplus">+                             nsIMsgCustomColumnHandler* colHandler)</span>
<a href="#l1.5531"></a><span id="l1.5531"> {</span>
<a href="#l1.5532"></a><span id="l1.5532">   nsresult rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.5533"></a><span id="l1.5533">   NS_ENSURE_ARG_POINTER(msgHdr);</span>
<a href="#l1.5534"></a><span id="l1.5534">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l1.5535"></a><span id="l1.5535"> </span>
<a href="#l1.5536"></a><span id="l1.5536">   switch (sortType)</span>
<a href="#l1.5537"></a><span id="l1.5537">   {</span>
<a href="#l1.5538"></a><span id="l1.5538">     case nsMsgViewSortType::bySubject:</span>
<a href="#l1.5539"></a><span id="l1.5539" class="difflineminus">-        rv = msgHdr-&gt;GetSubjectCollationKey(len, result);</span>
<a href="#l1.5540"></a><span id="l1.5540" class="difflineminus">-        break;</span>
<a href="#l1.5541"></a><span id="l1.5541" class="difflineplus">+      rv = msgHdr-&gt;GetSubjectCollationKey(len, result);</span>
<a href="#l1.5542"></a><span id="l1.5542" class="difflineplus">+      break;</span>
<a href="#l1.5543"></a><span id="l1.5543">     case nsMsgViewSortType::byLocation:</span>
<a href="#l1.5544"></a><span id="l1.5544" class="difflineminus">-        rv = GetLocationCollationKey(msgHdr, result, len);</span>
<a href="#l1.5545"></a><span id="l1.5545" class="difflineminus">-        break;</span>
<a href="#l1.5546"></a><span id="l1.5546" class="difflineplus">+      rv = GetLocationCollationKey(msgHdr, result, len);</span>
<a href="#l1.5547"></a><span id="l1.5547" class="difflineplus">+      break;</span>
<a href="#l1.5548"></a><span id="l1.5548">     case nsMsgViewSortType::byRecipient:</span>
<a href="#l1.5549"></a><span id="l1.5549" class="difflineplus">+    {</span>
<a href="#l1.5550"></a><span id="l1.5550" class="difflineplus">+      nsString recipients;</span>
<a href="#l1.5551"></a><span id="l1.5551" class="difflineplus">+      rv = FetchRecipients(msgHdr, recipients);</span>
<a href="#l1.5552"></a><span id="l1.5552" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l1.5553"></a><span id="l1.5553">       {</span>
<a href="#l1.5554"></a><span id="l1.5554" class="difflineminus">-        nsString recipients;</span>
<a href="#l1.5555"></a><span id="l1.5555" class="difflineminus">-        rv = FetchRecipients(msgHdr, recipients);</span>
<a href="#l1.5556"></a><span id="l1.5556" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l1.5557"></a><span id="l1.5557" class="difflineplus">+        nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.5558"></a><span id="l1.5558" class="difflineplus">+        // Probably a search view.</span>
<a href="#l1.5559"></a><span id="l1.5559" class="difflineplus">+        if (!dbToUse)</span>
<a href="#l1.5560"></a><span id="l1.5560">         {</span>
<a href="#l1.5561"></a><span id="l1.5561" class="difflineminus">-          nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.5562"></a><span id="l1.5562" class="difflineminus">-          if (!dbToUse) // probably search view</span>
<a href="#l1.5563"></a><span id="l1.5563" class="difflineminus">-          {</span>
<a href="#l1.5564"></a><span id="l1.5564" class="difflineminus">-            rv = GetDBForHeader(msgHdr, getter_AddRefs(dbToUse));</span>
<a href="#l1.5565"></a><span id="l1.5565" class="difflineminus">-            NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5566"></a><span id="l1.5566" class="difflineminus">-          }</span>
<a href="#l1.5567"></a><span id="l1.5567" class="difflineminus">-          rv = dbToUse-&gt;CreateCollationKey(recipients, len, result);</span>
<a href="#l1.5568"></a><span id="l1.5568" class="difflineplus">+          rv = GetDBForHeader(msgHdr, getter_AddRefs(dbToUse));</span>
<a href="#l1.5569"></a><span id="l1.5569" class="difflineplus">+          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5570"></a><span id="l1.5570">         }</span>
<a href="#l1.5571"></a><span id="l1.5571" class="difflineplus">+</span>
<a href="#l1.5572"></a><span id="l1.5572" class="difflineplus">+        rv = dbToUse-&gt;CreateCollationKey(recipients, len, result);</span>
<a href="#l1.5573"></a><span id="l1.5573">       }</span>
<a href="#l1.5574"></a><span id="l1.5574">       break;</span>
<a href="#l1.5575"></a><span id="l1.5575" class="difflineplus">+    }</span>
<a href="#l1.5576"></a><span id="l1.5576">     case nsMsgViewSortType::byAuthor:</span>
<a href="#l1.5577"></a><span id="l1.5577" class="difflineplus">+    {</span>
<a href="#l1.5578"></a><span id="l1.5578" class="difflineplus">+      rv = msgHdr-&gt;GetAuthorCollationKey(len, result);</span>
<a href="#l1.5579"></a><span id="l1.5579" class="difflineplus">+      nsString author;</span>
<a href="#l1.5580"></a><span id="l1.5580" class="difflineplus">+      rv = FetchAuthor(msgHdr, author);</span>
<a href="#l1.5581"></a><span id="l1.5581" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l1.5582"></a><span id="l1.5582">       {</span>
<a href="#l1.5583"></a><span id="l1.5583" class="difflineminus">-        rv = msgHdr-&gt;GetAuthorCollationKey(len, result);</span>
<a href="#l1.5584"></a><span id="l1.5584" class="difflineminus">-        nsString author;</span>
<a href="#l1.5585"></a><span id="l1.5585" class="difflineminus">-        rv = FetchAuthor(msgHdr, author);</span>
<a href="#l1.5586"></a><span id="l1.5586" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l1.5587"></a><span id="l1.5587" class="difflineplus">+        nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.5588"></a><span id="l1.5588" class="difflineplus">+        // Probably a search view.</span>
<a href="#l1.5589"></a><span id="l1.5589" class="difflineplus">+        if (!dbToUse)</span>
<a href="#l1.5590"></a><span id="l1.5590">         {</span>
<a href="#l1.5591"></a><span id="l1.5591" class="difflineminus">-          nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.5592"></a><span id="l1.5592" class="difflineminus">-          if (!dbToUse) // probably search view</span>
<a href="#l1.5593"></a><span id="l1.5593" class="difflineminus">-          {</span>
<a href="#l1.5594"></a><span id="l1.5594" class="difflineminus">-            rv = GetDBForHeader(msgHdr, getter_AddRefs(dbToUse));</span>
<a href="#l1.5595"></a><span id="l1.5595" class="difflineminus">-            NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5596"></a><span id="l1.5596" class="difflineminus">-          }</span>
<a href="#l1.5597"></a><span id="l1.5597" class="difflineminus">-          rv = dbToUse-&gt;CreateCollationKey(author, len, result);</span>
<a href="#l1.5598"></a><span id="l1.5598" class="difflineplus">+          rv = GetDBForHeader(msgHdr, getter_AddRefs(dbToUse));</span>
<a href="#l1.5599"></a><span id="l1.5599" class="difflineplus">+          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5600"></a><span id="l1.5600">         }</span>
<a href="#l1.5601"></a><span id="l1.5601" class="difflineplus">+</span>
<a href="#l1.5602"></a><span id="l1.5602" class="difflineplus">+        rv = dbToUse-&gt;CreateCollationKey(author, len, result);</span>
<a href="#l1.5603"></a><span id="l1.5603">       }</span>
<a href="#l1.5604"></a><span id="l1.5604">       break;</span>
<a href="#l1.5605"></a><span id="l1.5605" class="difflineplus">+    }</span>
<a href="#l1.5606"></a><span id="l1.5606">     case nsMsgViewSortType::byAccount:</span>
<a href="#l1.5607"></a><span id="l1.5607">     case nsMsgViewSortType::byTags:</span>
<a href="#l1.5608"></a><span id="l1.5608" class="difflineminus">-      {</span>
<a href="#l1.5609"></a><span id="l1.5609" class="difflineminus">-        nsString str;</span>
<a href="#l1.5610"></a><span id="l1.5610" class="difflineminus">-        nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.5611"></a><span id="l1.5611" class="difflineminus">-</span>
<a href="#l1.5612"></a><span id="l1.5612" class="difflineminus">-        if (!dbToUse) // probably search view</span>
<a href="#l1.5613"></a><span id="l1.5613" class="difflineminus">-          GetDBForViewIndex(0, getter_AddRefs(dbToUse));</span>
<a href="#l1.5614"></a><span id="l1.5614" class="difflineminus">-</span>
<a href="#l1.5615"></a><span id="l1.5615" class="difflineminus">-        rv = (sortType == nsMsgViewSortType::byAccount)</span>
<a href="#l1.5616"></a><span id="l1.5616" class="difflineminus">-            ? FetchAccount(msgHdr, str)</span>
<a href="#l1.5617"></a><span id="l1.5617" class="difflineminus">-            : FetchTags(msgHdr, str);</span>
<a href="#l1.5618"></a><span id="l1.5618" class="difflineminus">-</span>
<a href="#l1.5619"></a><span id="l1.5619" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; dbToUse)</span>
<a href="#l1.5620"></a><span id="l1.5620" class="difflineminus">-          rv = dbToUse-&gt;CreateCollationKey(str, len, result);</span>
<a href="#l1.5621"></a><span id="l1.5621" class="difflineminus">-      }</span>
<a href="#l1.5622"></a><span id="l1.5622" class="difflineminus">-      break;</span>
<a href="#l1.5623"></a><span id="l1.5623" class="difflineplus">+    {</span>
<a href="#l1.5624"></a><span id="l1.5624" class="difflineplus">+      nsString str;</span>
<a href="#l1.5625"></a><span id="l1.5625" class="difflineplus">+      nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.5626"></a><span id="l1.5626" class="difflineplus">+</span>
<a href="#l1.5627"></a><span id="l1.5627" class="difflineplus">+      if (!dbToUse)</span>
<a href="#l1.5628"></a><span id="l1.5628" class="difflineplus">+        // Probably a search view.</span>
<a href="#l1.5629"></a><span id="l1.5629" class="difflineplus">+        GetDBForViewIndex(0, getter_AddRefs(dbToUse));</span>
<a href="#l1.5630"></a><span id="l1.5630" class="difflineplus">+</span>
<a href="#l1.5631"></a><span id="l1.5631" class="difflineplus">+      rv = (sortType == nsMsgViewSortType::byAccount) ? FetchAccount(msgHdr, str) :</span>
<a href="#l1.5632"></a><span id="l1.5632" class="difflineplus">+                                                        FetchTags(msgHdr, str);</span>
<a href="#l1.5633"></a><span id="l1.5633" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; dbToUse)</span>
<a href="#l1.5634"></a><span id="l1.5634" class="difflineplus">+        rv = dbToUse-&gt;CreateCollationKey(str, len, result);</span>
<a href="#l1.5635"></a><span id="l1.5635" class="difflineplus">+</span>
<a href="#l1.5636"></a><span id="l1.5636" class="difflineplus">+      break;</span>
<a href="#l1.5637"></a><span id="l1.5637" class="difflineplus">+    }</span>
<a href="#l1.5638"></a><span id="l1.5638">     case nsMsgViewSortType::byCustom:</span>
<a href="#l1.5639"></a><span id="l1.5639">       if (colHandler != nullptr)</span>
<a href="#l1.5640"></a><span id="l1.5640">       {</span>
<a href="#l1.5641"></a><span id="l1.5641">         nsAutoString strKey;</span>
<a href="#l1.5642"></a><span id="l1.5642">         rv = colHandler-&gt;GetSortStringForRow(msgHdr, strKey);</span>
<a href="#l1.5643"></a><span id="l1.5643">         NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to get sort string for custom row&quot;);</span>
<a href="#l1.5644"></a><span id="l1.5644">         nsAutoString strTemp(strKey);</span>
<a href="#l1.5645"></a><span id="l1.5645"> </span>
<a href="#l1.5646"></a><span id="l1.5646">         nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.5647"></a><span id="l1.5647" class="difflineminus">-        if (!dbToUse) // probably search view</span>
<a href="#l1.5648"></a><span id="l1.5648" class="difflineplus">+        // Probably a search view.</span>
<a href="#l1.5649"></a><span id="l1.5649" class="difflineplus">+        if (!dbToUse)</span>
<a href="#l1.5650"></a><span id="l1.5650">         {</span>
<a href="#l1.5651"></a><span id="l1.5651">           rv = GetDBForHeader(msgHdr, getter_AddRefs(dbToUse));</span>
<a href="#l1.5652"></a><span id="l1.5652">           NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5653"></a><span id="l1.5653">         }</span>
<a href="#l1.5654"></a><span id="l1.5654">         rv = dbToUse-&gt;CreateCollationKey(strKey, len, result);</span>
<a href="#l1.5655"></a><span id="l1.5655">       }</span>
<a href="#l1.5656"></a><span id="l1.5656">       else</span>
<a href="#l1.5657"></a><span id="l1.5657">       {</span>
<a href="#l1.5658"></a><span id="l1.5658">         NS_ERROR(&quot;should not be here (Sort Type: byCustom (String), but no custom handler)&quot;);</span>
<a href="#l1.5659"></a><span id="l1.5659">         rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.5660"></a><span id="l1.5660">       }</span>
<a href="#l1.5661"></a><span id="l1.5661">       break;</span>
<a href="#l1.5662"></a><span id="l1.5662">     case nsMsgViewSortType::byCorrespondent:</span>
<a href="#l1.5663"></a><span id="l1.5663" class="difflineplus">+    {</span>
<a href="#l1.5664"></a><span id="l1.5664" class="difflineplus">+      nsString value;</span>
<a href="#l1.5665"></a><span id="l1.5665" class="difflineplus">+      if (IsOutgoingMsg(msgHdr))</span>
<a href="#l1.5666"></a><span id="l1.5666" class="difflineplus">+        rv = FetchRecipients(msgHdr, value);</span>
<a href="#l1.5667"></a><span id="l1.5667" class="difflineplus">+      else</span>
<a href="#l1.5668"></a><span id="l1.5668" class="difflineplus">+        rv = FetchAuthor(msgHdr, value);</span>
<a href="#l1.5669"></a><span id="l1.5669" class="difflineplus">+</span>
<a href="#l1.5670"></a><span id="l1.5670" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l1.5671"></a><span id="l1.5671">       {</span>
<a href="#l1.5672"></a><span id="l1.5672" class="difflineminus">-        nsString value;</span>
<a href="#l1.5673"></a><span id="l1.5673" class="difflineminus">-        if (IsOutgoingMsg(msgHdr))</span>
<a href="#l1.5674"></a><span id="l1.5674" class="difflineminus">-          rv = FetchRecipients(msgHdr, value);</span>
<a href="#l1.5675"></a><span id="l1.5675" class="difflineminus">-        else</span>
<a href="#l1.5676"></a><span id="l1.5676" class="difflineminus">-          rv = FetchAuthor(msgHdr, value);</span>
<a href="#l1.5677"></a><span id="l1.5677" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l1.5678"></a><span id="l1.5678" class="difflineplus">+        nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.5679"></a><span id="l1.5679" class="difflineplus">+        // Probably a search view.</span>
<a href="#l1.5680"></a><span id="l1.5680" class="difflineplus">+        if (!dbToUse)</span>
<a href="#l1.5681"></a><span id="l1.5681">         {</span>
<a href="#l1.5682"></a><span id="l1.5682" class="difflineminus">-          nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.5683"></a><span id="l1.5683" class="difflineminus">-          if (!dbToUse) // probably search view</span>
<a href="#l1.5684"></a><span id="l1.5684" class="difflineminus">-          {</span>
<a href="#l1.5685"></a><span id="l1.5685" class="difflineminus">-            rv = GetDBForHeader(msgHdr, getter_AddRefs(dbToUse));</span>
<a href="#l1.5686"></a><span id="l1.5686" class="difflineminus">-            NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5687"></a><span id="l1.5687" class="difflineminus">-          }</span>
<a href="#l1.5688"></a><span id="l1.5688" class="difflineminus">-          rv = dbToUse-&gt;CreateCollationKey(value, len, result);</span>
<a href="#l1.5689"></a><span id="l1.5689" class="difflineplus">+          rv = GetDBForHeader(msgHdr, getter_AddRefs(dbToUse));</span>
<a href="#l1.5690"></a><span id="l1.5690" class="difflineplus">+          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5691"></a><span id="l1.5691">         }</span>
<a href="#l1.5692"></a><span id="l1.5692" class="difflineplus">+</span>
<a href="#l1.5693"></a><span id="l1.5693" class="difflineplus">+        rv = dbToUse-&gt;CreateCollationKey(value, len, result);</span>
<a href="#l1.5694"></a><span id="l1.5694">       }</span>
<a href="#l1.5695"></a><span id="l1.5695">       break;</span>
<a href="#l1.5696"></a><span id="l1.5696" class="difflineplus">+    }</span>
<a href="#l1.5697"></a><span id="l1.5697">     default:</span>
<a href="#l1.5698"></a><span id="l1.5698" class="difflineminus">-        rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.5699"></a><span id="l1.5699" class="difflineminus">-        break;</span>
<a href="#l1.5700"></a><span id="l1.5700" class="difflineminus">-    }</span>
<a href="#l1.5701"></a><span id="l1.5701" class="difflineminus">-</span>
<a href="#l1.5702"></a><span id="l1.5702" class="difflineminus">-    // bailing out with failure will stop the sort and leave us in</span>
<a href="#l1.5703"></a><span id="l1.5703" class="difflineminus">-    // a bad state.  try to continue on, instead</span>
<a href="#l1.5704"></a><span id="l1.5704" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to get the collation key&quot;);</span>
<a href="#l1.5705"></a><span id="l1.5705" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l1.5706"></a><span id="l1.5706" class="difflineminus">-    {</span>
<a href="#l1.5707"></a><span id="l1.5707" class="difflineminus">-        *result = nullptr;</span>
<a href="#l1.5708"></a><span id="l1.5708" class="difflineminus">-        *len = 0;</span>
<a href="#l1.5709"></a><span id="l1.5709" class="difflineminus">-    }</span>
<a href="#l1.5710"></a><span id="l1.5710" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.5711"></a><span id="l1.5711" class="difflineplus">+      rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.5712"></a><span id="l1.5712" class="difflineplus">+      break;</span>
<a href="#l1.5713"></a><span id="l1.5713" class="difflineplus">+  }</span>
<a href="#l1.5714"></a><span id="l1.5714" class="difflineplus">+</span>
<a href="#l1.5715"></a><span id="l1.5715" class="difflineplus">+  // Bailing out with failure will stop the sort and leave us in</span>
<a href="#l1.5716"></a><span id="l1.5716" class="difflineplus">+  // a bad state. Try to continue on, instead.</span>
<a href="#l1.5717"></a><span id="l1.5717" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to get the collation key&quot;);</span>
<a href="#l1.5718"></a><span id="l1.5718" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l1.5719"></a><span id="l1.5719" class="difflineplus">+  {</span>
<a href="#l1.5720"></a><span id="l1.5720" class="difflineplus">+    *result = nullptr;</span>
<a href="#l1.5721"></a><span id="l1.5721" class="difflineplus">+    *len = 0;</span>
<a href="#l1.5722"></a><span id="l1.5722" class="difflineplus">+  }</span>
<a href="#l1.5723"></a><span id="l1.5723" class="difflineplus">+</span>
<a href="#l1.5724"></a><span id="l1.5724" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.5725"></a><span id="l1.5725"> }</span>
<a href="#l1.5726"></a><span id="l1.5726"> </span>
<a href="#l1.5727"></a><span id="l1.5727"> // As the location collation key is created getting folder from the msgHdr,</span>
<a href="#l1.5728"></a><span id="l1.5728"> // it is defined in this file and not from the db.</span>
<a href="#l1.5729"></a><span id="l1.5729"> nsresult</span>
<a href="#l1.5730"></a><span id="l1.5730" class="difflineminus">-nsMsgDBView::GetLocationCollationKey(nsIMsgDBHdr *msgHdr, uint8_t **result, uint32_t *len)</span>
<a href="#l1.5731"></a><span id="l1.5731" class="difflineplus">+nsMsgDBView::GetLocationCollationKey(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.5732"></a><span id="l1.5732" class="difflineplus">+                                     uint8_t **result,</span>
<a href="#l1.5733"></a><span id="l1.5733" class="difflineplus">+                                     uint32_t *len)</span>
<a href="#l1.5734"></a><span id="l1.5734"> {</span>
<a href="#l1.5735"></a><span id="l1.5735">   nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.5736"></a><span id="l1.5736"> </span>
<a href="#l1.5737"></a><span id="l1.5737">   nsresult rv = msgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l1.5738"></a><span id="l1.5738">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5739"></a><span id="l1.5739">   nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse;</span>
<a href="#l1.5740"></a><span id="l1.5740">   rv = folder-&gt;GetMsgDatabase(getter_AddRefs(dbToUse));</span>
<a href="#l1.5741"></a><span id="l1.5741">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5742"></a><span id="l1.5742"> </span>
<a href="#l1.5743"></a><span id="l1.5743">   nsString locationString;</span>
<a href="#l1.5744"></a><span id="l1.5744">   rv = folder-&gt;GetPrettyName(locationString);</span>
<a href="#l1.5745"></a><span id="l1.5745">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5746"></a><span id="l1.5746"> </span>
<a href="#l1.5747"></a><span id="l1.5747">   return dbToUse-&gt;CreateCollationKey(locationString, len, result);</span>
<a href="#l1.5748"></a><span id="l1.5748"> }</span>
<a href="#l1.5749"></a><span id="l1.5749"> </span>
<a href="#l1.5750"></a><span id="l1.5750" class="difflineminus">-nsresult nsMsgDBView::SaveSortInfo(nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder)</span>
<a href="#l1.5751"></a><span id="l1.5751" class="difflineplus">+nsresult</span>
<a href="#l1.5752"></a><span id="l1.5752" class="difflineplus">+nsMsgDBView::SaveSortInfo(nsMsgViewSortTypeValue sortType,</span>
<a href="#l1.5753"></a><span id="l1.5753" class="difflineplus">+                          nsMsgViewSortOrderValue sortOrder)</span>
<a href="#l1.5754"></a><span id="l1.5754"> {</span>
<a href="#l1.5755"></a><span id="l1.5755">   if (m_viewFolder)</span>
<a href="#l1.5756"></a><span id="l1.5756">   {</span>
<a href="#l1.5757"></a><span id="l1.5757">     nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l1.5758"></a><span id="l1.5758">     nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.5759"></a><span id="l1.5759">     nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l1.5760"></a><span id="l1.5760">     if (NS_SUCCEEDED(rv) &amp;&amp; folderInfo)</span>
<a href="#l1.5761"></a><span id="l1.5761">     {</span>
<a href="#l1.5762"></a><span id="l1.5762" class="difflineminus">-      // save off sort type and order, view type and flags</span>
<a href="#l1.5763"></a><span id="l1.5763" class="difflineplus">+      // Save off sort type and order, view type and flags.</span>
<a href="#l1.5764"></a><span id="l1.5764">       folderInfo-&gt;SetSortType(sortType);</span>
<a href="#l1.5765"></a><span id="l1.5765">       folderInfo-&gt;SetSortOrder(sortOrder);</span>
<a href="#l1.5766"></a><span id="l1.5766"> </span>
<a href="#l1.5767"></a><span id="l1.5767">       nsString sortColumnsString;</span>
<a href="#l1.5768"></a><span id="l1.5768">       rv = EncodeColumnSort(sortColumnsString);</span>
<a href="#l1.5769"></a><span id="l1.5769">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.5770"></a><span id="l1.5770">       folderInfo-&gt;SetProperty(&quot;sortColumns&quot;, sortColumnsString);</span>
<a href="#l1.5771"></a><span id="l1.5771">     }</span>
<a href="#l1.5772"></a><span id="l1.5772">   }</span>
<a href="#l1.5773"></a><span id="l1.5773" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.5774"></a><span id="l1.5774" class="difflineminus">-}</span>
<a href="#l1.5775"></a><span id="l1.5775" class="difflineminus">-</span>
<a href="#l1.5776"></a><span id="l1.5776" class="difflineminus">-nsresult nsMsgDBView::RestoreSortInfo()</span>
<a href="#l1.5777"></a><span id="l1.5777" class="difflineplus">+</span>
<a href="#l1.5778"></a><span id="l1.5778" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.5779"></a><span id="l1.5779" class="difflineplus">+}</span>
<a href="#l1.5780"></a><span id="l1.5780" class="difflineplus">+</span>
<a href="#l1.5781"></a><span id="l1.5781" class="difflineplus">+nsresult</span>
<a href="#l1.5782"></a><span id="l1.5782" class="difflineplus">+nsMsgDBView::RestoreSortInfo()</span>
<a href="#l1.5783"></a><span id="l1.5783"> {</span>
<a href="#l1.5784"></a><span id="l1.5784">   if (!m_viewFolder)</span>
<a href="#l1.5785"></a><span id="l1.5785">     return NS_OK;</span>
<a href="#l1.5786"></a><span id="l1.5786"> </span>
<a href="#l1.5787"></a><span id="l1.5787">   nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l1.5788"></a><span id="l1.5788">   nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.5789"></a><span id="l1.5789" class="difflineminus">-  nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l1.5790"></a><span id="l1.5790" class="difflineplus">+  nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo),</span>
<a href="#l1.5791"></a><span id="l1.5791" class="difflineplus">+                                                   getter_AddRefs(db));</span>
<a href="#l1.5792"></a><span id="l1.5792">   if (NS_SUCCEEDED(rv) &amp;&amp; folderInfo)</span>
<a href="#l1.5793"></a><span id="l1.5793">   {</span>
<a href="#l1.5794"></a><span id="l1.5794">     // Restore m_sortColumns from db.</span>
<a href="#l1.5795"></a><span id="l1.5795">     nsString sortColumnsString;</span>
<a href="#l1.5796"></a><span id="l1.5796">     folderInfo-&gt;GetProperty(&quot;sortColumns&quot;, sortColumnsString);</span>
<a href="#l1.5797"></a><span id="l1.5797">     DecodeColumnSort(sortColumnsString);</span>
<a href="#l1.5798"></a><span id="l1.5798">     if (m_sortColumns.Length() &gt; 1)</span>
<a href="#l1.5799"></a><span id="l1.5799">     {</span>
<a href="#l1.5800"></a><span id="l1.5800" class="difflineat">@@ -4414,17 +4885,18 @@ nsresult nsMsgDBView::RestoreSortInfo()</span>
<a href="#l1.5801"></a><span id="l1.5801">   }</span>
<a href="#l1.5802"></a><span id="l1.5802"> </span>
<a href="#l1.5803"></a><span id="l1.5803">   return NS_OK;</span>
<a href="#l1.5804"></a><span id="l1.5804"> }</span>
<a href="#l1.5805"></a><span id="l1.5805"> </span>
<a href="#l1.5806"></a><span id="l1.5806"> // Called by msgDBView::Sort, at which point any persisted active custom</span>
<a href="#l1.5807"></a><span id="l1.5807"> // columns must be registered. If not, reset their m_sortColumns entries</span>
<a href="#l1.5808"></a><span id="l1.5808"> // to byDate; Sort will fill in values if necessary based on new user sort.</span>
<a href="#l1.5809"></a><span id="l1.5809" class="difflineminus">-void nsMsgDBView::EnsureCustomColumnsValid()</span>
<a href="#l1.5810"></a><span id="l1.5810" class="difflineplus">+void</span>
<a href="#l1.5811"></a><span id="l1.5811" class="difflineplus">+nsMsgDBView::EnsureCustomColumnsValid()</span>
<a href="#l1.5812"></a><span id="l1.5812"> {</span>
<a href="#l1.5813"></a><span id="l1.5813">   if (!m_sortColumns.Length())</span>
<a href="#l1.5814"></a><span id="l1.5814">     return;</span>
<a href="#l1.5815"></a><span id="l1.5815"> </span>
<a href="#l1.5816"></a><span id="l1.5816">   for (uint32_t i = 0; i &lt; m_sortColumns.Length(); i++)</span>
<a href="#l1.5817"></a><span id="l1.5817">   {</span>
<a href="#l1.5818"></a><span id="l1.5818">     if (m_sortColumns[i].mSortType == nsMsgViewSortType::byCustom &amp;&amp;</span>
<a href="#l1.5819"></a><span id="l1.5819">         m_sortColumns[i].mColHandler == nullptr)</span>
<a href="#l1.5820"></a><span id="l1.5820" class="difflineat">@@ -4435,18 +4907,20 @@ void nsMsgDBView::EnsureCustomColumnsVal</span>
<a href="#l1.5821"></a><span id="l1.5821">       if (i == 0 &amp;&amp; m_sortType != nsMsgViewSortType::byCustom)</span>
<a href="#l1.5822"></a><span id="l1.5822">         SetCurCustomColumn(EmptyString());</span>
<a href="#l1.5823"></a><span id="l1.5823">       if (i == 1)</span>
<a href="#l1.5824"></a><span id="l1.5824">         m_secondaryCustomColumn.Truncate();</span>
<a href="#l1.5825"></a><span id="l1.5825">     }</span>
<a href="#l1.5826"></a><span id="l1.5826">   }</span>
<a href="#l1.5827"></a><span id="l1.5827"> }</span>
<a href="#l1.5828"></a><span id="l1.5828"> </span>
<a href="#l1.5829"></a><span id="l1.5829" class="difflineminus">-int32_t  nsMsgDBView::SecondarySort(nsMsgKey key1, nsISupports *supports1,</span>
<a href="#l1.5830"></a><span id="l1.5830" class="difflineminus">-                                    nsMsgKey key2, nsISupports *supports2,</span>
<a href="#l1.5831"></a><span id="l1.5831" class="difflineplus">+int32_t  nsMsgDBView::SecondarySort(nsMsgKey key1,</span>
<a href="#l1.5832"></a><span id="l1.5832" class="difflineplus">+                                    nsISupports *supports1,</span>
<a href="#l1.5833"></a><span id="l1.5833" class="difflineplus">+                                    nsMsgKey key2,</span>
<a href="#l1.5834"></a><span id="l1.5834" class="difflineplus">+                                    nsISupports *supports2,</span>
<a href="#l1.5835"></a><span id="l1.5835">                                     viewSortInfo *comparisonContext)</span>
<a href="#l1.5836"></a><span id="l1.5836"> {</span>
<a href="#l1.5837"></a><span id="l1.5837">   // We need to make sure that in the case of the secondary sort field also</span>
<a href="#l1.5838"></a><span id="l1.5838">   // matching, we don't recurse.</span>
<a href="#l1.5839"></a><span id="l1.5839">   if (comparisonContext-&gt;isSecondarySort)</span>
<a href="#l1.5840"></a><span id="l1.5840">     return key1 &gt; key2;</span>
<a href="#l1.5841"></a><span id="l1.5841"> </span>
<a href="#l1.5842"></a><span id="l1.5842">   nsCOMPtr&lt;nsIMsgFolder&gt; folder1, folder2;</span>
<a href="#l1.5843"></a><span id="l1.5843" class="difflineat">@@ -4495,37 +4969,40 @@ int32_t  nsMsgDBView::SecondarySort(nsMs</span>
<a href="#l1.5844"></a><span id="l1.5844">       NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.5845"></a><span id="l1.5845">       comparisonFun = FnSortIdKeyPtr;</span>
<a href="#l1.5846"></a><span id="l1.5846">       break;</span>
<a href="#l1.5847"></a><span id="l1.5847">     case kU32:</span>
<a href="#l1.5848"></a><span id="l1.5848">       if (sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.5849"></a><span id="l1.5849">         EntryInfo1.dword = EntryInfo1.id;</span>
<a href="#l1.5850"></a><span id="l1.5850">       else</span>
<a href="#l1.5851"></a><span id="l1.5851">         GetLongField(hdr1, sortType, &amp;EntryInfo1.dword, colHandler);</span>
<a href="#l1.5852"></a><span id="l1.5852" class="difflineplus">+</span>
<a href="#l1.5853"></a><span id="l1.5853">       comparisonFun = FnSortIdUint32;</span>
<a href="#l1.5854"></a><span id="l1.5854">       break;</span>
<a href="#l1.5855"></a><span id="l1.5855">     default:</span>
<a href="#l1.5856"></a><span id="l1.5856">       return 0;</span>
<a href="#l1.5857"></a><span id="l1.5857">   }</span>
<a href="#l1.5858"></a><span id="l1.5858" class="difflineplus">+</span>
<a href="#l1.5859"></a><span id="l1.5859">   bool saveAscendingSort = comparisonContext-&gt;ascendingSort;</span>
<a href="#l1.5860"></a><span id="l1.5860">   comparisonContext-&gt;isSecondarySort = true;</span>
<a href="#l1.5861"></a><span id="l1.5861">   comparisonContext-&gt;ascendingSort = (sortOrder == nsMsgViewSortOrder::ascending);</span>
<a href="#l1.5862"></a><span id="l1.5862">   if (fieldType == kCollationKey)</span>
<a href="#l1.5863"></a><span id="l1.5863">   {</span>
<a href="#l1.5864"></a><span id="l1.5864">     PR_FREEIF(EntryInfo2.key);</span>
<a href="#l1.5865"></a><span id="l1.5865">     rv = GetCollationKey(hdr2, sortType, &amp;EntryInfo2.key, &amp;EntryInfo2.dword, colHandler);</span>
<a href="#l1.5866"></a><span id="l1.5866">     NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.5867"></a><span id="l1.5867">   }</span>
<a href="#l1.5868"></a><span id="l1.5868">   else if (fieldType == kU32)</span>
<a href="#l1.5869"></a><span id="l1.5869">   {</span>
<a href="#l1.5870"></a><span id="l1.5870">     if (sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.5871"></a><span id="l1.5871">       EntryInfo2.dword = EntryInfo2.id;</span>
<a href="#l1.5872"></a><span id="l1.5872">     else</span>
<a href="#l1.5873"></a><span id="l1.5873">       GetLongField(hdr2, sortType, &amp;EntryInfo2.dword, colHandler);</span>
<a href="#l1.5874"></a><span id="l1.5874">   }</span>
<a href="#l1.5875"></a><span id="l1.5875" class="difflineplus">+</span>
<a href="#l1.5876"></a><span id="l1.5876">   retStatus = (*comparisonFun)(&amp;pValue1, &amp;pValue2, comparisonContext);</span>
<a href="#l1.5877"></a><span id="l1.5877"> </span>
<a href="#l1.5878"></a><span id="l1.5878">   comparisonContext-&gt;isSecondarySort = false;</span>
<a href="#l1.5879"></a><span id="l1.5879">   comparisonContext-&gt;ascendingSort = saveAscendingSort;</span>
<a href="#l1.5880"></a><span id="l1.5880"> </span>
<a href="#l1.5881"></a><span id="l1.5881">   return retStatus;</span>
<a href="#l1.5882"></a><span id="l1.5882"> }</span>
<a href="#l1.5883"></a><span id="l1.5883"> </span>
<a href="#l1.5884"></a><span id="l1.5884" class="difflineat">@@ -4542,31 +5019,32 @@ NS_IMETHODIMP nsMsgDBView::Sort(nsMsgVie</span>
<a href="#l1.5885"></a><span id="l1.5885">   // while m_sortColumns[0].mCustomColumnName is the name for the last completed</span>
<a href="#l1.5886"></a><span id="l1.5886">   // sort, since these are persisted after each sort.</span>
<a href="#l1.5887"></a><span id="l1.5887">   if (m_sortType == sortType &amp;&amp; m_sortValid &amp;&amp;</span>
<a href="#l1.5888"></a><span id="l1.5888">       (sortType != nsMsgViewSortType::byCustom ||</span>
<a href="#l1.5889"></a><span id="l1.5889">        (sortType == nsMsgViewSortType::byCustom &amp;&amp; m_sortColumns.Length() &amp;&amp;</span>
<a href="#l1.5890"></a><span id="l1.5890">         m_sortColumns[0].mCustomColumnName.Equals(m_curCustomColumn))) &amp;&amp;</span>
<a href="#l1.5891"></a><span id="l1.5891">       m_sortColumns.Length() &lt; 2)</span>
<a href="#l1.5892"></a><span id="l1.5892">   {</span>
<a href="#l1.5893"></a><span id="l1.5893" class="difflineminus">-    // same as it ever was.  do nothing</span>
<a href="#l1.5894"></a><span id="l1.5894" class="difflineplus">+    // Same as it ever was. Do nothing.</span>
<a href="#l1.5895"></a><span id="l1.5895">     if (m_sortOrder == sortOrder)</span>
<a href="#l1.5896"></a><span id="l1.5896">       return NS_OK;</span>
<a href="#l1.5897"></a><span id="l1.5897"> </span>
<a href="#l1.5898"></a><span id="l1.5898" class="difflineminus">-    // for secondary sort, remember the sort order on a per column basis.</span>
<a href="#l1.5899"></a><span id="l1.5899" class="difflineplus">+    // For secondary sort, remember the sort order on a per column basis.</span>
<a href="#l1.5900"></a><span id="l1.5900">     if (m_sortColumns.Length())</span>
<a href="#l1.5901"></a><span id="l1.5901">       m_sortColumns[0].mSortOrder = sortOrder;</span>
<a href="#l1.5902"></a><span id="l1.5902" class="difflineplus">+</span>
<a href="#l1.5903"></a><span id="l1.5903">     SaveSortInfo(sortType, sortOrder);</span>
<a href="#l1.5904"></a><span id="l1.5904">     if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.5905"></a><span id="l1.5905">       ReverseThreads();</span>
<a href="#l1.5906"></a><span id="l1.5906">     else</span>
<a href="#l1.5907"></a><span id="l1.5907">       ReverseSort();</span>
<a href="#l1.5908"></a><span id="l1.5908"> </span>
<a href="#l1.5909"></a><span id="l1.5909">     m_sortOrder = sortOrder;</span>
<a href="#l1.5910"></a><span id="l1.5910" class="difflineminus">-    // we just reversed the sort order...we still need to invalidate the view</span>
<a href="#l1.5911"></a><span id="l1.5911" class="difflineplus">+    // We just reversed the sort order, we still need to invalidate the view.</span>
<a href="#l1.5912"></a><span id="l1.5912">     return NS_OK;</span>
<a href="#l1.5913"></a><span id="l1.5913">   }</span>
<a href="#l1.5914"></a><span id="l1.5914"> </span>
<a href="#l1.5915"></a><span id="l1.5915">   if (sortType == nsMsgViewSortType::byThread)</span>
<a href="#l1.5916"></a><span id="l1.5916">     return NS_OK;</span>
<a href="#l1.5917"></a><span id="l1.5917"> </span>
<a href="#l1.5918"></a><span id="l1.5918">   // If a sortType has changed, or the sortType is byCustom and a column has</span>
<a href="#l1.5919"></a><span id="l1.5919">   // changed, this is the new primary sortColumnInfo.</span>
<a href="#l1.5920"></a><span id="l1.5920" class="difflineat">@@ -4600,64 +5078,69 @@ NS_IMETHODIMP nsMsgDBView::Sort(nsMsgVie</span>
<a href="#l1.5921"></a><span id="l1.5921">   }</span>
<a href="#l1.5922"></a><span id="l1.5922"> </span>
<a href="#l1.5923"></a><span id="l1.5923">   if (m_sortColumns.Length() &gt; 1)</span>
<a href="#l1.5924"></a><span id="l1.5924">   {</span>
<a href="#l1.5925"></a><span id="l1.5925">     m_secondarySort = m_sortColumns[1].mSortType;</span>
<a href="#l1.5926"></a><span id="l1.5926">     m_secondarySortOrder = m_sortColumns[1].mSortOrder;</span>
<a href="#l1.5927"></a><span id="l1.5927">     m_secondaryCustomColumn = m_sortColumns[1].mCustomColumnName;</span>
<a href="#l1.5928"></a><span id="l1.5928">   }</span>
<a href="#l1.5929"></a><span id="l1.5929" class="difflineplus">+</span>
<a href="#l1.5930"></a><span id="l1.5930">   SaveSortInfo(sortType, sortOrder);</span>
<a href="#l1.5931"></a><span id="l1.5931" class="difflineminus">-  // figure out how much memory we'll need, and the malloc it</span>
<a href="#l1.5932"></a><span id="l1.5932" class="difflineplus">+  // Figure out how much memory we'll need, and then malloc it.</span>
<a href="#l1.5933"></a><span id="l1.5933">   uint16_t maxLen;</span>
<a href="#l1.5934"></a><span id="l1.5934">   eFieldType fieldType;</span>
<a href="#l1.5935"></a><span id="l1.5935"> </span>
<a href="#l1.5936"></a><span id="l1.5936">   // Get the custom column handler for the primary sort and pass it first</span>
<a href="#l1.5937"></a><span id="l1.5937">   // to GetFieldTypeAndLenForSort to get the fieldType and then either</span>
<a href="#l1.5938"></a><span id="l1.5938">   // GetCollationKey or GetLongField.</span>
<a href="#l1.5939"></a><span id="l1.5939">   nsIMsgCustomColumnHandler* colHandler = GetCurColumnHandler();</span>
<a href="#l1.5940"></a><span id="l1.5940"> </span>
<a href="#l1.5941"></a><span id="l1.5941">   // If we did not obtain proper fieldType, it needs to be checked</span>
<a href="#l1.5942"></a><span id="l1.5942">   // because the subsequent code does not handle it very well.</span>
<a href="#l1.5943"></a><span id="l1.5943">   nsresult rv = GetFieldTypeAndLenForSort(sortType, &amp;maxLen, &amp;fieldType, colHandler);</span>
<a href="#l1.5944"></a><span id="l1.5944"> </span>
<a href="#l1.5945"></a><span id="l1.5945" class="difflineminus">-  // Don't sort if the field type is not supported: Bug 901948</span>
<a href="#l1.5946"></a><span id="l1.5946" class="difflineplus">+  // Don't sort if the field type is not supported: Bug 901948.</span>
<a href="#l1.5947"></a><span id="l1.5947">   if (NS_FAILED(rv))</span>
<a href="#l1.5948"></a><span id="l1.5948">     return NS_OK;</span>
<a href="#l1.5949"></a><span id="l1.5949"> </span>
<a href="#l1.5950"></a><span id="l1.5950">   nsTArray&lt;void*&gt; ptrs;</span>
<a href="#l1.5951"></a><span id="l1.5951">   uint32_t arraySize = GetSize();</span>
<a href="#l1.5952"></a><span id="l1.5952"> </span>
<a href="#l1.5953"></a><span id="l1.5953">   if (!arraySize)</span>
<a href="#l1.5954"></a><span id="l1.5954">     return NS_OK;</span>
<a href="#l1.5955"></a><span id="l1.5955"> </span>
<a href="#l1.5956"></a><span id="l1.5956">   nsCOMArray&lt;nsIMsgFolder&gt; *folders = GetFolders();</span>
<a href="#l1.5957"></a><span id="l1.5957"> </span>
<a href="#l1.5958"></a><span id="l1.5958">   IdKey** pPtrBase = (IdKey**)PR_Malloc(arraySize * sizeof(IdKey*));</span>
<a href="#l1.5959"></a><span id="l1.5959">   NS_ASSERTION(pPtrBase, &quot;out of memory, can't sort&quot;);</span>
<a href="#l1.5960"></a><span id="l1.5960" class="difflineminus">-  if (!pPtrBase) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.5961"></a><span id="l1.5961" class="difflineminus">-  ptrs.AppendElement((void *)pPtrBase); // remember this pointer so we can free it later</span>
<a href="#l1.5962"></a><span id="l1.5962" class="difflineminus">-</span>
<a href="#l1.5963"></a><span id="l1.5963" class="difflineminus">-  // build up the beast, so we can sort it.</span>
<a href="#l1.5964"></a><span id="l1.5964" class="difflineplus">+  if (!pPtrBase)</span>
<a href="#l1.5965"></a><span id="l1.5965" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.5966"></a><span id="l1.5966" class="difflineplus">+</span>
<a href="#l1.5967"></a><span id="l1.5967" class="difflineplus">+  // Remember this pointer so we can free it later.</span>
<a href="#l1.5968"></a><span id="l1.5968" class="difflineplus">+  ptrs.AppendElement((void *)pPtrBase);</span>
<a href="#l1.5969"></a><span id="l1.5969" class="difflineplus">+</span>
<a href="#l1.5970"></a><span id="l1.5970" class="difflineplus">+  // Build up the beast, so we can sort it.</span>
<a href="#l1.5971"></a><span id="l1.5971">   uint32_t numSoFar = 0;</span>
<a href="#l1.5972"></a><span id="l1.5972">   const uint32_t keyOffset = offsetof(IdKey, key);</span>
<a href="#l1.5973"></a><span id="l1.5973" class="difflineminus">-  // calc max possible size needed for all the rest</span>
<a href="#l1.5974"></a><span id="l1.5974" class="difflineplus">+  // Calc max possible size needed for all the rest.</span>
<a href="#l1.5975"></a><span id="l1.5975">   uint32_t maxSize = (keyOffset + maxLen) * (arraySize - numSoFar);</span>
<a href="#l1.5976"></a><span id="l1.5976"> </span>
<a href="#l1.5977"></a><span id="l1.5977">   const uint32_t maxBlockSize = (uint32_t) 0xf000L;</span>
<a href="#l1.5978"></a><span id="l1.5978">   uint32_t allocSize = std::min(maxBlockSize, maxSize);</span>
<a href="#l1.5979"></a><span id="l1.5979">   char *pTemp = (char *) PR_Malloc(allocSize);</span>
<a href="#l1.5980"></a><span id="l1.5980">   NS_ASSERTION(pTemp, &quot;out of memory, can't sort&quot;);</span>
<a href="#l1.5981"></a><span id="l1.5981">   if (!pTemp)</span>
<a href="#l1.5982"></a><span id="l1.5982">   {</span>
<a href="#l1.5983"></a><span id="l1.5983">     FreeAll(&amp;ptrs);</span>
<a href="#l1.5984"></a><span id="l1.5984">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.5985"></a><span id="l1.5985">   }</span>
<a href="#l1.5986"></a><span id="l1.5986"> </span>
<a href="#l1.5987"></a><span id="l1.5987" class="difflineminus">-  ptrs.AppendElement(pTemp); // remember this pointer so we can free it later</span>
<a href="#l1.5988"></a><span id="l1.5988" class="difflineplus">+  // Remember this pointer so we can free it later.</span>
<a href="#l1.5989"></a><span id="l1.5989" class="difflineplus">+  ptrs.AppendElement(pTemp);</span>
<a href="#l1.5990"></a><span id="l1.5990"> </span>
<a href="#l1.5991"></a><span id="l1.5991">   char *pBase = pTemp;</span>
<a href="#l1.5992"></a><span id="l1.5992">   bool more = true;</span>
<a href="#l1.5993"></a><span id="l1.5993"> </span>
<a href="#l1.5994"></a><span id="l1.5994">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.5995"></a><span id="l1.5995">   uint8_t *keyValue = nullptr;</span>
<a href="#l1.5996"></a><span id="l1.5996">   uint32_t longValue;</span>
<a href="#l1.5997"></a><span id="l1.5997">   while (more &amp;&amp; numSoFar &lt; arraySize)</span>
<a href="#l1.5998"></a><span id="l1.5998" class="difflineat">@@ -4697,176 +5180,190 @@ NS_IMETHODIMP nsMsgDBView::Sort(nsMsgVie</span>
<a href="#l1.5999"></a><span id="l1.5999">       }</span>
<a href="#l1.6000"></a><span id="l1.6000">       else</span>
<a href="#l1.6001"></a><span id="l1.6001">       {</span>
<a href="#l1.6002"></a><span id="l1.6002">         rv = GetLongField(msgHdr, sortType, &amp;longValue, colHandler);</span>
<a href="#l1.6003"></a><span id="l1.6003">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.6004"></a><span id="l1.6004">       }</span>
<a href="#l1.6005"></a><span id="l1.6005">     }</span>
<a href="#l1.6006"></a><span id="l1.6006"> </span>
<a href="#l1.6007"></a><span id="l1.6007" class="difflineminus">-    // check to see if this entry fits into the block we have allocated so far</span>
<a href="#l1.6008"></a><span id="l1.6008" class="difflineminus">-    // pTemp - pBase = the space we have used so far</span>
<a href="#l1.6009"></a><span id="l1.6009" class="difflineminus">-    // sizeof(EntryInfo) + fieldLen = space we need for this entry</span>
<a href="#l1.6010"></a><span id="l1.6010" class="difflineminus">-    // allocSize = size of the current block</span>
<a href="#l1.6011"></a><span id="l1.6011" class="difflineplus">+    // Check to see if this entry fits into the block we have allocated so far.</span>
<a href="#l1.6012"></a><span id="l1.6012" class="difflineplus">+    // pTemp - pBase = the space we have used so far.</span>
<a href="#l1.6013"></a><span id="l1.6013" class="difflineplus">+    // sizeof(EntryInfo) + fieldLen = space we need for this entry.</span>
<a href="#l1.6014"></a><span id="l1.6014" class="difflineplus">+    // allocSize = size of the current block.</span>
<a href="#l1.6015"></a><span id="l1.6015">     if ((uint32_t)(pTemp - pBase) + (keyOffset + actualFieldLen) &gt;= allocSize)</span>
<a href="#l1.6016"></a><span id="l1.6016">     {</span>
<a href="#l1.6017"></a><span id="l1.6017">       maxSize = (keyOffset + maxLen) * (arraySize - numSoFar);</span>
<a href="#l1.6018"></a><span id="l1.6018">       allocSize = std::min(maxBlockSize, maxSize);</span>
<a href="#l1.6019"></a><span id="l1.6019" class="difflineminus">-      // make sure allocSize is big enough for the current value</span>
<a href="#l1.6020"></a><span id="l1.6020" class="difflineplus">+      // Make sure allocSize is big enough for the current value.</span>
<a href="#l1.6021"></a><span id="l1.6021">       allocSize = std::max(allocSize, keyOffset + actualFieldLen);</span>
<a href="#l1.6022"></a><span id="l1.6022">       pTemp = (char *) PR_Malloc(allocSize);</span>
<a href="#l1.6023"></a><span id="l1.6023">       NS_ASSERTION(pTemp, &quot;out of memory, can't sort&quot;);</span>
<a href="#l1.6024"></a><span id="l1.6024">       if (!pTemp)</span>
<a href="#l1.6025"></a><span id="l1.6025">       {</span>
<a href="#l1.6026"></a><span id="l1.6026">         FreeAll(&amp;ptrs);</span>
<a href="#l1.6027"></a><span id="l1.6027">         return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.6028"></a><span id="l1.6028">       }</span>
<a href="#l1.6029"></a><span id="l1.6029">       pBase = pTemp;</span>
<a href="#l1.6030"></a><span id="l1.6030" class="difflineminus">-      ptrs.AppendElement(pTemp); // remember this pointer so we can free it later</span>
<a href="#l1.6031"></a><span id="l1.6031" class="difflineminus">-    }</span>
<a href="#l1.6032"></a><span id="l1.6032" class="difflineminus">-</span>
<a href="#l1.6033"></a><span id="l1.6033" class="difflineminus">-    // now store this entry away in the allocated memory</span>
<a href="#l1.6034"></a><span id="l1.6034" class="difflineplus">+      // Remember this pointer so we can free it later.</span>
<a href="#l1.6035"></a><span id="l1.6035" class="difflineplus">+      ptrs.AppendElement(pTemp);</span>
<a href="#l1.6036"></a><span id="l1.6036" class="difflineplus">+    }</span>
<a href="#l1.6037"></a><span id="l1.6037" class="difflineplus">+</span>
<a href="#l1.6038"></a><span id="l1.6038" class="difflineplus">+    // Now store this entry away in the allocated memory.</span>
<a href="#l1.6039"></a><span id="l1.6039">     IdKey *info = (IdKey*)pTemp;</span>
<a href="#l1.6040"></a><span id="l1.6040">     pPtrBase[numSoFar] = info;</span>
<a href="#l1.6041"></a><span id="l1.6041">     info-&gt;id = thisKey;</span>
<a href="#l1.6042"></a><span id="l1.6042">     info-&gt;bits = m_flags[numSoFar];</span>
<a href="#l1.6043"></a><span id="l1.6043">     info-&gt;dword = longValue;</span>
<a href="#l1.6044"></a><span id="l1.6044">     //info-&gt;pad = 0;</span>
<a href="#l1.6045"></a><span id="l1.6045">     info-&gt;folder = folders ? folders-&gt;ObjectAt(numSoFar) : m_folder.get();</span>
<a href="#l1.6046"></a><span id="l1.6046"> </span>
<a href="#l1.6047"></a><span id="l1.6047">     memcpy(info-&gt;key, keyValue, actualFieldLen);</span>
<a href="#l1.6048"></a><span id="l1.6048" class="difflineminus">-    //In order to align memory for systems that require it, such as HP-UX</span>
<a href="#l1.6049"></a><span id="l1.6049" class="difflineminus">-    //calculate the correct value to pad the actualFieldLen value</span>
<a href="#l1.6050"></a><span id="l1.6050" class="difflineplus">+    // In order to align memory for systems that require it, such as HP-UX,</span>
<a href="#l1.6051"></a><span id="l1.6051" class="difflineplus">+    // calculate the correct value to pad the actualFieldLen value.</span>
<a href="#l1.6052"></a><span id="l1.6052">     const uint32_t align = sizeof(IdKey) - sizeof(IdUint32) - 1;</span>
<a href="#l1.6053"></a><span id="l1.6053">     actualFieldLen = (actualFieldLen + align) &amp; ~align;</span>
<a href="#l1.6054"></a><span id="l1.6054"> </span>
<a href="#l1.6055"></a><span id="l1.6055">     pTemp += keyOffset + actualFieldLen;</span>
<a href="#l1.6056"></a><span id="l1.6056">     ++numSoFar;</span>
<a href="#l1.6057"></a><span id="l1.6057">     PR_Free(keyValue);</span>
<a href="#l1.6058"></a><span id="l1.6058">   }</span>
<a href="#l1.6059"></a><span id="l1.6059"> </span>
<a href="#l1.6060"></a><span id="l1.6060">   viewSortInfo qsPrivateData;</span>
<a href="#l1.6061"></a><span id="l1.6061">   qsPrivateData.view = this;</span>
<a href="#l1.6062"></a><span id="l1.6062">   qsPrivateData.isSecondarySort = false;</span>
<a href="#l1.6063"></a><span id="l1.6063">   qsPrivateData.ascendingSort = (sortOrder == nsMsgViewSortOrder::ascending);</span>
<a href="#l1.6064"></a><span id="l1.6064"> </span>
<a href="#l1.6065"></a><span id="l1.6065">   nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.6066"></a><span id="l1.6066"> </span>
<a href="#l1.6067"></a><span id="l1.6067" class="difflineminus">-  if (!dbToUse) // probably search view</span>
<a href="#l1.6068"></a><span id="l1.6068" class="difflineplus">+  // Probably a search view.</span>
<a href="#l1.6069"></a><span id="l1.6069" class="difflineplus">+  if (!dbToUse)</span>
<a href="#l1.6070"></a><span id="l1.6070">     GetDBForViewIndex(0, getter_AddRefs(dbToUse));</span>
<a href="#l1.6071"></a><span id="l1.6071" class="difflineplus">+</span>
<a href="#l1.6072"></a><span id="l1.6072">   qsPrivateData.db = dbToUse;</span>
<a href="#l1.6073"></a><span id="l1.6073">   if (dbToUse)</span>
<a href="#l1.6074"></a><span id="l1.6074">   {</span>
<a href="#l1.6075"></a><span id="l1.6075" class="difflineminus">-    // do the sort</span>
<a href="#l1.6076"></a><span id="l1.6076" class="difflineplus">+    // Do the sort.</span>
<a href="#l1.6077"></a><span id="l1.6077">     switch (fieldType)</span>
<a href="#l1.6078"></a><span id="l1.6078">     {</span>
<a href="#l1.6079"></a><span id="l1.6079">       case kCollationKey:</span>
<a href="#l1.6080"></a><span id="l1.6080">         NS_QuickSort(pPtrBase, numSoFar, sizeof(IdKey*), FnSortIdKey, &amp;qsPrivateData);</span>
<a href="#l1.6081"></a><span id="l1.6081">         break;</span>
<a href="#l1.6082"></a><span id="l1.6082">       case kU32:</span>
<a href="#l1.6083"></a><span id="l1.6083">         NS_QuickSort(pPtrBase, numSoFar, sizeof(IdKey*), FnSortIdUint32, &amp;qsPrivateData);</span>
<a href="#l1.6084"></a><span id="l1.6084">         break;</span>
<a href="#l1.6085"></a><span id="l1.6085">       default:</span>
<a href="#l1.6086"></a><span id="l1.6086">         NS_ERROR(&quot;not supposed to get here&quot;);</span>
<a href="#l1.6087"></a><span id="l1.6087">         break;</span>
<a href="#l1.6088"></a><span id="l1.6088">     }</span>
<a href="#l1.6089"></a><span id="l1.6089">   }</span>
<a href="#l1.6090"></a><span id="l1.6090"> </span>
<a href="#l1.6091"></a><span id="l1.6091" class="difflineminus">-  // now put the IDs into the array in proper order</span>
<a href="#l1.6092"></a><span id="l1.6092" class="difflineplus">+  // Now put the IDs into the array in proper order.</span>
<a href="#l1.6093"></a><span id="l1.6093">   for (uint32_t i = 0; i &lt; numSoFar; i++)</span>
<a href="#l1.6094"></a><span id="l1.6094">   {</span>
<a href="#l1.6095"></a><span id="l1.6095">     m_keys[i] = pPtrBase[i]-&gt;id;</span>
<a href="#l1.6096"></a><span id="l1.6096">     m_flags[i] = pPtrBase[i]-&gt;bits;</span>
<a href="#l1.6097"></a><span id="l1.6097"> </span>
<a href="#l1.6098"></a><span id="l1.6098">     if (folders)</span>
<a href="#l1.6099"></a><span id="l1.6099">       folders-&gt;ReplaceObjectAt(pPtrBase[i]-&gt;folder, i);</span>
<a href="#l1.6100"></a><span id="l1.6100">   }</span>
<a href="#l1.6101"></a><span id="l1.6101"> </span>
<a href="#l1.6102"></a><span id="l1.6102">   m_sortType = sortType;</span>
<a href="#l1.6103"></a><span id="l1.6103">   m_sortOrder = sortOrder;</span>
<a href="#l1.6104"></a><span id="l1.6104"> </span>
<a href="#l1.6105"></a><span id="l1.6105" class="difflineminus">-  // free all the memory we allocated</span>
<a href="#l1.6106"></a><span id="l1.6106" class="difflineplus">+  // Free all the memory we allocated.</span>
<a href="#l1.6107"></a><span id="l1.6107">   FreeAll(&amp;ptrs);</span>
<a href="#l1.6108"></a><span id="l1.6108"> </span>
<a href="#l1.6109"></a><span id="l1.6109">   m_sortValid = true;</span>
<a href="#l1.6110"></a><span id="l1.6110">   //m_db-&gt;SetSortInfo(sortType, sortOrder);</span>
<a href="#l1.6111"></a><span id="l1.6111"> </span>
<a href="#l1.6112"></a><span id="l1.6112">   return NS_OK;</span>
<a href="#l1.6113"></a><span id="l1.6113"> }</span>
<a href="#l1.6114"></a><span id="l1.6114"> </span>
<a href="#l1.6115"></a><span id="l1.6115" class="difflineminus">-void nsMsgDBView::FreeAll(nsTArray&lt;void*&gt; *ptrs)</span>
<a href="#l1.6116"></a><span id="l1.6116" class="difflineplus">+void</span>
<a href="#l1.6117"></a><span id="l1.6117" class="difflineplus">+nsMsgDBView::FreeAll(nsTArray&lt;void*&gt; *ptrs)</span>
<a href="#l1.6118"></a><span id="l1.6118"> {</span>
<a href="#l1.6119"></a><span id="l1.6119">   int32_t i;</span>
<a href="#l1.6120"></a><span id="l1.6120">   int32_t count = (int32_t) ptrs-&gt;Length();</span>
<a href="#l1.6121"></a><span id="l1.6121">   if (count == 0)</span>
<a href="#l1.6122"></a><span id="l1.6122">     return;</span>
<a href="#l1.6123"></a><span id="l1.6123"> </span>
<a href="#l1.6124"></a><span id="l1.6124">   for (i=(count - 1);i&gt;=0;i--)</span>
<a href="#l1.6125"></a><span id="l1.6125">     PR_Free((void *) ptrs-&gt;ElementAt(i));</span>
<a href="#l1.6126"></a><span id="l1.6126" class="difflineplus">+</span>
<a href="#l1.6127"></a><span id="l1.6127">   ptrs-&gt;Clear();</span>
<a href="#l1.6128"></a><span id="l1.6128"> }</span>
<a href="#l1.6129"></a><span id="l1.6129"> </span>
<a href="#l1.6130"></a><span id="l1.6130" class="difflineminus">-nsMsgViewIndex nsMsgDBView::GetIndexOfFirstDisplayedKeyInThread(</span>
<a href="#l1.6131"></a><span id="l1.6131" class="difflineminus">-    nsIMsgThread *threadHdr, bool allowDummy)</span>
<a href="#l1.6132"></a><span id="l1.6132" class="difflineminus">-{</span>
<a href="#l1.6133"></a><span id="l1.6133" class="difflineminus">-  nsMsgViewIndex  retIndex = nsMsgViewIndex_None;</span>
<a href="#l1.6134"></a><span id="l1.6134" class="difflineminus">-  uint32_t        childIndex = 0;</span>
<a href="#l1.6135"></a><span id="l1.6135" class="difflineplus">+nsMsgViewIndex</span>
<a href="#l1.6136"></a><span id="l1.6136" class="difflineplus">+nsMsgDBView::GetIndexOfFirstDisplayedKeyInThread(nsIMsgThread *threadHdr,</span>
<a href="#l1.6137"></a><span id="l1.6137" class="difflineplus">+                                                 bool allowDummy)</span>
<a href="#l1.6138"></a><span id="l1.6138" class="difflineplus">+{</span>
<a href="#l1.6139"></a><span id="l1.6139" class="difflineplus">+  nsMsgViewIndex retIndex = nsMsgViewIndex_None;</span>
<a href="#l1.6140"></a><span id="l1.6140" class="difflineplus">+  uint32_t childIndex = 0;</span>
<a href="#l1.6141"></a><span id="l1.6141">   // We could speed up the unreadOnly view by starting our search with the first</span>
<a href="#l1.6142"></a><span id="l1.6142">   // unread message in the thread. Sometimes, that will be wrong, however, so</span>
<a href="#l1.6143"></a><span id="l1.6143">   // let's skip it until we're sure it's necessary.</span>
<a href="#l1.6144"></a><span id="l1.6144">   //  (m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly)</span>
<a href="#l1.6145"></a><span id="l1.6145">   //    ? threadHdr-&gt;GetFirstUnreadKey(m_db) : threadHdr-&gt;GetChildAt(0);</span>
<a href="#l1.6146"></a><span id="l1.6146">   uint32_t numThreadChildren;</span>
<a href="#l1.6147"></a><span id="l1.6147">   threadHdr-&gt;GetNumChildren(&amp;numThreadChildren);</span>
<a href="#l1.6148"></a><span id="l1.6148">   while (retIndex == nsMsgViewIndex_None &amp;&amp; childIndex &lt; numThreadChildren)</span>
<a href="#l1.6149"></a><span id="l1.6149">   {</span>
<a href="#l1.6150"></a><span id="l1.6150">     nsCOMPtr&lt;nsIMsgDBHdr&gt; childHdr;</span>
<a href="#l1.6151"></a><span id="l1.6151">     threadHdr-&gt;GetChildHdrAt(childIndex++, getter_AddRefs(childHdr));</span>
<a href="#l1.6152"></a><span id="l1.6152">     if (childHdr)</span>
<a href="#l1.6153"></a><span id="l1.6153">       retIndex = FindHdr(childHdr, 0, allowDummy);</span>
<a href="#l1.6154"></a><span id="l1.6154">   }</span>
<a href="#l1.6155"></a><span id="l1.6155" class="difflineplus">+</span>
<a href="#l1.6156"></a><span id="l1.6156">   return retIndex;</span>
<a href="#l1.6157"></a><span id="l1.6157"> }</span>
<a href="#l1.6158"></a><span id="l1.6158"> </span>
<a href="#l1.6159"></a><span id="l1.6159" class="difflineminus">-nsresult nsMsgDBView::GetFirstMessageHdrToDisplayInThread(nsIMsgThread *threadHdr, nsIMsgDBHdr **result)</span>
<a href="#l1.6160"></a><span id="l1.6160" class="difflineplus">+nsresult</span>
<a href="#l1.6161"></a><span id="l1.6161" class="difflineplus">+nsMsgDBView::GetFirstMessageHdrToDisplayInThread(nsIMsgThread *threadHdr,</span>
<a href="#l1.6162"></a><span id="l1.6162" class="difflineplus">+                                                 nsIMsgDBHdr **result)</span>
<a href="#l1.6163"></a><span id="l1.6163"> {</span>
<a href="#l1.6164"></a><span id="l1.6164">   nsresult rv;</span>
<a href="#l1.6165"></a><span id="l1.6165"> </span>
<a href="#l1.6166"></a><span id="l1.6166">   if (m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly)</span>
<a href="#l1.6167"></a><span id="l1.6167">     rv = threadHdr-&gt;GetFirstUnreadChild(result);</span>
<a href="#l1.6168"></a><span id="l1.6168">   else</span>
<a href="#l1.6169"></a><span id="l1.6169">     rv = threadHdr-&gt;GetChildHdrAt(0, result);</span>
<a href="#l1.6170"></a><span id="l1.6170" class="difflineplus">+</span>
<a href="#l1.6171"></a><span id="l1.6171">   return rv;</span>
<a href="#l1.6172"></a><span id="l1.6172"> }</span>
<a href="#l1.6173"></a><span id="l1.6173"> </span>
<a href="#l1.6174"></a><span id="l1.6174"> // Find the view index of the thread containing the passed msgKey, if</span>
<a href="#l1.6175"></a><span id="l1.6175"> // the thread is in the view. MsgIndex is passed in as a shortcut if</span>
<a href="#l1.6176"></a><span id="l1.6176"> // it turns out the msgKey is the first message in the thread,</span>
<a href="#l1.6177"></a><span id="l1.6177"> // then we can avoid looking for the msgKey.</span>
<a href="#l1.6178"></a><span id="l1.6178" class="difflineminus">-nsMsgViewIndex nsMsgDBView::ThreadIndexOfMsg(nsMsgKey msgKey,</span>
<a href="#l1.6179"></a><span id="l1.6179" class="difflineminus">-                                            nsMsgViewIndex msgIndex /* = nsMsgViewIndex_None */,</span>
<a href="#l1.6180"></a><span id="l1.6180" class="difflineminus">-                                            int32_t *pThreadCount /* = NULL */,</span>
<a href="#l1.6181"></a><span id="l1.6181" class="difflineminus">-                                            uint32_t *pFlags /* = NULL */)</span>
<a href="#l1.6182"></a><span id="l1.6182" class="difflineplus">+nsMsgViewIndex</span>
<a href="#l1.6183"></a><span id="l1.6183" class="difflineplus">+nsMsgDBView::ThreadIndexOfMsg(nsMsgKey msgKey,</span>
<a href="#l1.6184"></a><span id="l1.6184" class="difflineplus">+                              nsMsgViewIndex msgIndex /* = nsMsgViewIndex_None */,</span>
<a href="#l1.6185"></a><span id="l1.6185" class="difflineplus">+                              int32_t *pThreadCount /* = NULL */,</span>
<a href="#l1.6186"></a><span id="l1.6186" class="difflineplus">+                              uint32_t *pFlags /* = NULL */)</span>
<a href="#l1.6187"></a><span id="l1.6187"> {</span>
<a href="#l1.6188"></a><span id="l1.6188">   if (! (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.6189"></a><span id="l1.6189">     return nsMsgViewIndex_None;</span>
<a href="#l1.6190"></a><span id="l1.6190" class="difflineplus">+</span>
<a href="#l1.6191"></a><span id="l1.6191">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.6192"></a><span id="l1.6192">   nsresult rv = m_db-&gt;GetMsgHdrForKey(msgKey, getter_AddRefs(msgHdr));</span>
<a href="#l1.6193"></a><span id="l1.6193">   NS_ENSURE_SUCCESS(rv, nsMsgViewIndex_None);</span>
<a href="#l1.6194"></a><span id="l1.6194">   return ThreadIndexOfMsgHdr(msgHdr, msgIndex, pThreadCount, pFlags);</span>
<a href="#l1.6195"></a><span id="l1.6195"> }</span>
<a href="#l1.6196"></a><span id="l1.6196"> </span>
<a href="#l1.6197"></a><span id="l1.6197" class="difflineminus">-nsMsgViewIndex nsMsgDBView::GetThreadIndex(nsMsgViewIndex msgIndex)</span>
<a href="#l1.6198"></a><span id="l1.6198" class="difflineplus">+nsMsgViewIndex</span>
<a href="#l1.6199"></a><span id="l1.6199" class="difflineplus">+nsMsgDBView::GetThreadIndex(nsMsgViewIndex msgIndex)</span>
<a href="#l1.6200"></a><span id="l1.6200"> {</span>
<a href="#l1.6201"></a><span id="l1.6201">   if (!IsValidIndex(msgIndex))</span>
<a href="#l1.6202"></a><span id="l1.6202">     return nsMsgViewIndex_None;</span>
<a href="#l1.6203"></a><span id="l1.6203"> </span>
<a href="#l1.6204"></a><span id="l1.6204" class="difflineminus">-  // scan up looking for level 0 message.</span>
<a href="#l1.6205"></a><span id="l1.6205" class="difflineplus">+  // Scan up looking for level 0 message.</span>
<a href="#l1.6206"></a><span id="l1.6206">   while (m_levels[msgIndex] &amp;&amp; msgIndex)</span>
<a href="#l1.6207"></a><span id="l1.6207">     --msgIndex;</span>
<a href="#l1.6208"></a><span id="l1.6208" class="difflineplus">+</span>
<a href="#l1.6209"></a><span id="l1.6209">   return msgIndex;</span>
<a href="#l1.6210"></a><span id="l1.6210"> }</span>
<a href="#l1.6211"></a><span id="l1.6211"> </span>
<a href="#l1.6212"></a><span id="l1.6212"> nsMsgViewIndex</span>
<a href="#l1.6213"></a><span id="l1.6213"> nsMsgDBView::ThreadIndexOfMsgHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.6214"></a><span id="l1.6214">                                  nsMsgViewIndex msgIndex,</span>
<a href="#l1.6215"></a><span id="l1.6215">                                  int32_t *pThreadCount,</span>
<a href="#l1.6216"></a><span id="l1.6216">                                  uint32_t *pFlags)</span>
<a href="#l1.6217"></a><span id="l1.6217" class="difflineat">@@ -4877,182 +5374,224 @@ nsMsgDBView::ThreadIndexOfMsgHdr(nsIMsgD</span>
<a href="#l1.6218"></a><span id="l1.6218"> </span>
<a href="#l1.6219"></a><span id="l1.6219">   nsMsgViewIndex retIndex = nsMsgViewIndex_None;</span>
<a href="#l1.6220"></a><span id="l1.6220"> </span>
<a href="#l1.6221"></a><span id="l1.6221">   if (threadHdr != nullptr)</span>
<a href="#l1.6222"></a><span id="l1.6222">   {</span>
<a href="#l1.6223"></a><span id="l1.6223">     if (msgIndex == nsMsgViewIndex_None)</span>
<a href="#l1.6224"></a><span id="l1.6224">       msgIndex = FindHdr(msgHdr, 0, true);</span>
<a href="#l1.6225"></a><span id="l1.6225"> </span>
<a href="#l1.6226"></a><span id="l1.6226" class="difflineminus">-    if (msgIndex == nsMsgViewIndex_None)  // hdr is not in view, need to find by thread</span>
<a href="#l1.6227"></a><span id="l1.6227" class="difflineplus">+    // Hdr is not in view, need to find by thread.</span>
<a href="#l1.6228"></a><span id="l1.6228" class="difflineplus">+    if (msgIndex == nsMsgViewIndex_None)</span>
<a href="#l1.6229"></a><span id="l1.6229">     {</span>
<a href="#l1.6230"></a><span id="l1.6230">       msgIndex = GetIndexOfFirstDisplayedKeyInThread(threadHdr, true);</span>
<a href="#l1.6231"></a><span id="l1.6231" class="difflineminus">-      //nsMsgKey    threadKey = (msgIndex == nsMsgViewIndex_None) ? nsMsgKey_None : GetAt(msgIndex);</span>
<a href="#l1.6232"></a><span id="l1.6232" class="difflineplus">+      // nsMsgKey threadKey = (msgIndex == nsMsgViewIndex_None) ? nsMsgKey_None :</span>
<a href="#l1.6233"></a><span id="l1.6233" class="difflineplus">+      //                                                          GetAt(msgIndex);</span>
<a href="#l1.6234"></a><span id="l1.6234">       if (pFlags)</span>
<a href="#l1.6235"></a><span id="l1.6235">         threadHdr-&gt;GetFlags(pFlags);</span>
<a href="#l1.6236"></a><span id="l1.6236">     }</span>
<a href="#l1.6237"></a><span id="l1.6237" class="difflineplus">+</span>
<a href="#l1.6238"></a><span id="l1.6238">     nsMsgViewIndex startOfThread = msgIndex;</span>
<a href="#l1.6239"></a><span id="l1.6239">     while ((int32_t) startOfThread &gt;= 0 &amp;&amp; m_levels[startOfThread] != 0)</span>
<a href="#l1.6240"></a><span id="l1.6240">       startOfThread--;</span>
<a href="#l1.6241"></a><span id="l1.6241" class="difflineplus">+</span>
<a href="#l1.6242"></a><span id="l1.6242">     retIndex = startOfThread;</span>
<a href="#l1.6243"></a><span id="l1.6243">     if (pThreadCount)</span>
<a href="#l1.6244"></a><span id="l1.6244">     {</span>
<a href="#l1.6245"></a><span id="l1.6245">       int32_t numChildren = 0;</span>
<a href="#l1.6246"></a><span id="l1.6246">       nsMsgViewIndex threadIndex = startOfThread;</span>
<a href="#l1.6247"></a><span id="l1.6247">       do</span>
<a href="#l1.6248"></a><span id="l1.6248">       {</span>
<a href="#l1.6249"></a><span id="l1.6249">         threadIndex++;</span>
<a href="#l1.6250"></a><span id="l1.6250">         numChildren++;</span>
<a href="#l1.6251"></a><span id="l1.6251">       }</span>
<a href="#l1.6252"></a><span id="l1.6252">       while (threadIndex &lt; m_levels.Length() &amp;&amp; m_levels[threadIndex] != 0);</span>
<a href="#l1.6253"></a><span id="l1.6253" class="difflineplus">+</span>
<a href="#l1.6254"></a><span id="l1.6254">       *pThreadCount = numChildren;</span>
<a href="#l1.6255"></a><span id="l1.6255">     }</span>
<a href="#l1.6256"></a><span id="l1.6256">   }</span>
<a href="#l1.6257"></a><span id="l1.6257" class="difflineplus">+</span>
<a href="#l1.6258"></a><span id="l1.6258">   return retIndex;</span>
<a href="#l1.6259"></a><span id="l1.6259"> }</span>
<a href="#l1.6260"></a><span id="l1.6260"> </span>
<a href="#l1.6261"></a><span id="l1.6261" class="difflineminus">-nsMsgKey nsMsgDBView::GetKeyOfFirstMsgInThread(nsMsgKey key)</span>
<a href="#l1.6262"></a><span id="l1.6262" class="difflineplus">+nsMsgKey</span>
<a href="#l1.6263"></a><span id="l1.6263" class="difflineplus">+nsMsgDBView::GetKeyOfFirstMsgInThread(nsMsgKey key)</span>
<a href="#l1.6264"></a><span id="l1.6264"> {</span>
<a href="#l1.6265"></a><span id="l1.6265">   // Just report no key for any failure. This can occur when a</span>
<a href="#l1.6266"></a><span id="l1.6266" class="difflineminus">-  // message is deleted from a threaded view</span>
<a href="#l1.6267"></a><span id="l1.6267" class="difflineplus">+  // message is deleted from a threaded view.</span>
<a href="#l1.6268"></a><span id="l1.6268">   nsCOMPtr &lt;nsIMsgThread&gt; pThread;</span>
<a href="#l1.6269"></a><span id="l1.6269">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.6270"></a><span id="l1.6270">   nsresult rv = m_db-&gt;GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l1.6271"></a><span id="l1.6271">   if (NS_FAILED(rv))</span>
<a href="#l1.6272"></a><span id="l1.6272">     return nsMsgKey_None;</span>
<a href="#l1.6273"></a><span id="l1.6273" class="difflineplus">+</span>
<a href="#l1.6274"></a><span id="l1.6274">   rv = GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(pThread));</span>
<a href="#l1.6275"></a><span id="l1.6275">   if (NS_FAILED(rv))</span>
<a href="#l1.6276"></a><span id="l1.6276">     return nsMsgKey_None;</span>
<a href="#l1.6277"></a><span id="l1.6277" class="difflineplus">+</span>
<a href="#l1.6278"></a><span id="l1.6278">   nsMsgKey  firstKeyInThread = nsMsgKey_None;</span>
<a href="#l1.6279"></a><span id="l1.6279"> </span>
<a href="#l1.6280"></a><span id="l1.6280">   if (!pThread)</span>
<a href="#l1.6281"></a><span id="l1.6281">     return firstKeyInThread;</span>
<a href="#l1.6282"></a><span id="l1.6282"> </span>
<a href="#l1.6283"></a><span id="l1.6283">   // ### dmb UnreadOnly - this is wrong. But didn't seem to matter in 4.x</span>
<a href="#l1.6284"></a><span id="l1.6284">   pThread-&gt;GetChildKeyAt(0, &amp;firstKeyInThread);</span>
<a href="#l1.6285"></a><span id="l1.6285">   return firstKeyInThread;</span>
<a href="#l1.6286"></a><span id="l1.6286"> }</span>
<a href="#l1.6287"></a><span id="l1.6287"> </span>
<a href="#l1.6288"></a><span id="l1.6288" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetKeyAt(nsMsgViewIndex index, nsMsgKey *result)</span>
<a href="#l1.6289"></a><span id="l1.6289" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.6290"></a><span id="l1.6290" class="difflineplus">+nsMsgDBView::GetKeyAt(nsMsgViewIndex index,</span>
<a href="#l1.6291"></a><span id="l1.6291" class="difflineplus">+                      nsMsgKey *result)</span>
<a href="#l1.6292"></a><span id="l1.6292"> {</span>
<a href="#l1.6293"></a><span id="l1.6293">   NS_ENSURE_ARG(result);</span>
<a href="#l1.6294"></a><span id="l1.6294">   *result = GetAt(index);</span>
<a href="#l1.6295"></a><span id="l1.6295">   return NS_OK;</span>
<a href="#l1.6296"></a><span id="l1.6296"> }</span>
<a href="#l1.6297"></a><span id="l1.6297"> </span>
<a href="#l1.6298"></a><span id="l1.6298" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetFlagsAt(nsMsgViewIndex aIndex, uint32_t *aResult)</span>
<a href="#l1.6299"></a><span id="l1.6299" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.6300"></a><span id="l1.6300" class="difflineplus">+nsMsgDBView::GetFlagsAt(nsMsgViewIndex aIndex,</span>
<a href="#l1.6301"></a><span id="l1.6301" class="difflineplus">+                        uint32_t *aResult)</span>
<a href="#l1.6302"></a><span id="l1.6302"> {</span>
<a href="#l1.6303"></a><span id="l1.6303">   NS_ENSURE_ARG(aResult);</span>
<a href="#l1.6304"></a><span id="l1.6304">   if (!IsValidIndex(aIndex))</span>
<a href="#l1.6305"></a><span id="l1.6305">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.6306"></a><span id="l1.6306"> </span>
<a href="#l1.6307"></a><span id="l1.6307">   *aResult = m_flags[aIndex];</span>
<a href="#l1.6308"></a><span id="l1.6308">   return NS_OK;</span>
<a href="#l1.6309"></a><span id="l1.6309"> }</span>
<a href="#l1.6310"></a><span id="l1.6310"> </span>
<a href="#l1.6311"></a><span id="l1.6311" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetMsgHdrAt(nsMsgViewIndex aIndex, nsIMsgDBHdr **aResult)</span>
<a href="#l1.6312"></a><span id="l1.6312" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.6313"></a><span id="l1.6313" class="difflineplus">+nsMsgDBView::GetMsgHdrAt(nsMsgViewIndex aIndex,</span>
<a href="#l1.6314"></a><span id="l1.6314" class="difflineplus">+                         nsIMsgDBHdr **aResult)</span>
<a href="#l1.6315"></a><span id="l1.6315"> {</span>
<a href="#l1.6316"></a><span id="l1.6316">   NS_ENSURE_ARG(aResult);</span>
<a href="#l1.6317"></a><span id="l1.6317">   if (!IsValidIndex(aIndex))</span>
<a href="#l1.6318"></a><span id="l1.6318">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.6319"></a><span id="l1.6319"> </span>
<a href="#l1.6320"></a><span id="l1.6320">   return GetMsgHdrForViewIndex(aIndex, aResult);</span>
<a href="#l1.6321"></a><span id="l1.6321"> }</span>
<a href="#l1.6322"></a><span id="l1.6322"> </span>
<a href="#l1.6323"></a><span id="l1.6323" class="difflineminus">-nsMsgViewIndex nsMsgDBView::FindHdr(nsIMsgDBHdr *msgHdr, nsMsgViewIndex startIndex,</span>
<a href="#l1.6324"></a><span id="l1.6324" class="difflineminus">-                                    bool allowDummy)</span>
<a href="#l1.6325"></a><span id="l1.6325" class="difflineplus">+nsMsgViewIndex</span>
<a href="#l1.6326"></a><span id="l1.6326" class="difflineplus">+nsMsgDBView::FindHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.6327"></a><span id="l1.6327" class="difflineplus">+                     nsMsgViewIndex startIndex,</span>
<a href="#l1.6328"></a><span id="l1.6328" class="difflineplus">+                     bool allowDummy)</span>
<a href="#l1.6329"></a><span id="l1.6329"> {</span>
<a href="#l1.6330"></a><span id="l1.6330">   nsMsgKey msgKey;</span>
<a href="#l1.6331"></a><span id="l1.6331">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.6332"></a><span id="l1.6332">   nsMsgViewIndex viewIndex = m_keys.IndexOf(msgKey, startIndex);</span>
<a href="#l1.6333"></a><span id="l1.6333">   if (viewIndex == nsMsgViewIndex_None)</span>
<a href="#l1.6334"></a><span id="l1.6334">     return viewIndex;</span>
<a href="#l1.6335"></a><span id="l1.6335" class="difflineminus">-  // if we're supposed to allow dummies, and the previous index is a dummy that</span>
<a href="#l1.6336"></a><span id="l1.6336" class="difflineminus">-  //  is not elided, then it must be the dummy corresponding to our node and</span>
<a href="#l1.6337"></a><span id="l1.6337" class="difflineminus">-  //  we should return that instead.</span>
<a href="#l1.6338"></a><span id="l1.6338" class="difflineminus">-  if (allowDummy &amp;&amp; viewIndex</span>
<a href="#l1.6339"></a><span id="l1.6339" class="difflineminus">-      &amp;&amp; (m_flags[viewIndex-1] &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l1.6340"></a><span id="l1.6340" class="difflineminus">-      &amp;&amp; !(m_flags[viewIndex-1] &amp; nsMsgMessageFlags::Elided))</span>
<a href="#l1.6341"></a><span id="l1.6341" class="difflineplus">+</span>
<a href="#l1.6342"></a><span id="l1.6342" class="difflineplus">+  // If we're supposed to allow dummies, and the previous index is a dummy that</span>
<a href="#l1.6343"></a><span id="l1.6343" class="difflineplus">+  // is not elided, then it must be the dummy corresponding to our node and</span>
<a href="#l1.6344"></a><span id="l1.6344" class="difflineplus">+  // we should return that instead.</span>
<a href="#l1.6345"></a><span id="l1.6345" class="difflineplus">+  if (allowDummy &amp;&amp; viewIndex &amp;&amp;</span>
<a href="#l1.6346"></a><span id="l1.6346" class="difflineplus">+      (m_flags[viewIndex-1] &amp; MSG_VIEW_FLAG_DUMMY) &amp;&amp;</span>
<a href="#l1.6347"></a><span id="l1.6347" class="difflineplus">+      !(m_flags[viewIndex-1] &amp; nsMsgMessageFlags::Elided))</span>
<a href="#l1.6348"></a><span id="l1.6348" class="difflineplus">+  {</span>
<a href="#l1.6349"></a><span id="l1.6349">     viewIndex--;</span>
<a href="#l1.6350"></a><span id="l1.6350" class="difflineminus">-  // else if we're not allowing dummies, and we found a dummy, look again</span>
<a href="#l1.6351"></a><span id="l1.6351" class="difflineminus">-  // one past the dummy.</span>
<a href="#l1.6352"></a><span id="l1.6352" class="difflineplus">+  }</span>
<a href="#l1.6353"></a><span id="l1.6353">   else if (!allowDummy &amp;&amp; m_flags[viewIndex] &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l1.6354"></a><span id="l1.6354" class="difflineplus">+  {</span>
<a href="#l1.6355"></a><span id="l1.6355" class="difflineplus">+    // We're not allowing dummies, and we found a dummy, look again</span>
<a href="#l1.6356"></a><span id="l1.6356" class="difflineplus">+    // one past the dummy.</span>
<a href="#l1.6357"></a><span id="l1.6357">     return m_keys.IndexOf(msgKey, viewIndex + 1);</span>
<a href="#l1.6358"></a><span id="l1.6358" class="difflineplus">+  }</span>
<a href="#l1.6359"></a><span id="l1.6359" class="difflineplus">+</span>
<a href="#l1.6360"></a><span id="l1.6360">   return viewIndex;</span>
<a href="#l1.6361"></a><span id="l1.6361"> }</span>
<a href="#l1.6362"></a><span id="l1.6362"> </span>
<a href="#l1.6363"></a><span id="l1.6363" class="difflineminus">-nsMsgViewIndex nsMsgDBView::FindKey(nsMsgKey key, bool expand)</span>
<a href="#l1.6364"></a><span id="l1.6364" class="difflineplus">+nsMsgViewIndex</span>
<a href="#l1.6365"></a><span id="l1.6365" class="difflineplus">+nsMsgDBView::FindKey(nsMsgKey key,</span>
<a href="#l1.6366"></a><span id="l1.6366" class="difflineplus">+                     bool expand)</span>
<a href="#l1.6367"></a><span id="l1.6367"> {</span>
<a href="#l1.6368"></a><span id="l1.6368">   nsMsgViewIndex retIndex = nsMsgViewIndex_None;</span>
<a href="#l1.6369"></a><span id="l1.6369">   retIndex = (nsMsgViewIndex) (m_keys.IndexOf(key));</span>
<a href="#l1.6370"></a><span id="l1.6370" class="difflineminus">-  // for dummy headers, try to expand if the caller says so. And if the thread is</span>
<a href="#l1.6371"></a><span id="l1.6371" class="difflineminus">-  // expanded, ignore the dummy header and return the real header index.</span>
<a href="#l1.6372"></a><span id="l1.6372" class="difflineminus">-  if (retIndex != nsMsgViewIndex_None &amp;&amp; m_flags[retIndex] &amp; MSG_VIEW_FLAG_DUMMY &amp;&amp;  !(m_flags[retIndex] &amp; nsMsgMessageFlags::Elided))</span>
<a href="#l1.6373"></a><span id="l1.6373" class="difflineplus">+  // For dummy headers, try to expand if the caller says so. And if the thread</span>
<a href="#l1.6374"></a><span id="l1.6374" class="difflineplus">+  // is expanded, ignore the dummy header and return the real header index.</span>
<a href="#l1.6375"></a><span id="l1.6375" class="difflineplus">+  if (retIndex != nsMsgViewIndex_None &amp;&amp;</span>
<a href="#l1.6376"></a><span id="l1.6376" class="difflineplus">+      m_flags[retIndex] &amp; MSG_VIEW_FLAG_DUMMY &amp;&amp;</span>
<a href="#l1.6377"></a><span id="l1.6377" class="difflineplus">+      !(m_flags[retIndex] &amp; nsMsgMessageFlags::Elided))</span>
<a href="#l1.6378"></a><span id="l1.6378" class="difflineplus">+  {</span>
<a href="#l1.6379"></a><span id="l1.6379">     return (nsMsgViewIndex) m_keys.IndexOf(key, retIndex + 1);</span>
<a href="#l1.6380"></a><span id="l1.6380" class="difflineminus">-  if (key != nsMsgKey_None &amp;&amp; (retIndex == nsMsgViewIndex_None || m_flags[retIndex] &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l1.6381"></a><span id="l1.6381" class="difflineminus">-    &amp;&amp; expand &amp;&amp; m_db)</span>
<a href="#l1.6382"></a><span id="l1.6382" class="difflineplus">+  }</span>
<a href="#l1.6383"></a><span id="l1.6383" class="difflineplus">+</span>
<a href="#l1.6384"></a><span id="l1.6384" class="difflineplus">+  if (key != nsMsgKey_None &amp;&amp;</span>
<a href="#l1.6385"></a><span id="l1.6385" class="difflineplus">+      (retIndex == nsMsgViewIndex_None || m_flags[retIndex] &amp; MSG_VIEW_FLAG_DUMMY) &amp;&amp;</span>
<a href="#l1.6386"></a><span id="l1.6386" class="difflineplus">+      expand &amp;&amp; m_db)</span>
<a href="#l1.6387"></a><span id="l1.6387">   {</span>
<a href="#l1.6388"></a><span id="l1.6388">     nsMsgKey threadKey = GetKeyOfFirstMsgInThread(key);</span>
<a href="#l1.6389"></a><span id="l1.6389">     if (threadKey != nsMsgKey_None)</span>
<a href="#l1.6390"></a><span id="l1.6390">     {</span>
<a href="#l1.6391"></a><span id="l1.6391">       nsMsgViewIndex threadIndex = FindKey(threadKey, false);</span>
<a href="#l1.6392"></a><span id="l1.6392">       if (threadIndex != nsMsgViewIndex_None)</span>
<a href="#l1.6393"></a><span id="l1.6393">       {</span>
<a href="#l1.6394"></a><span id="l1.6394">         uint32_t flags = m_flags[threadIndex];</span>
<a href="#l1.6395"></a><span id="l1.6395" class="difflineminus">-        if (((flags &amp; nsMsgMessageFlags::Elided) &amp;&amp;</span>
<a href="#l1.6396"></a><span id="l1.6396" class="difflineminus">-             NS_SUCCEEDED(ExpandByIndex(threadIndex, nullptr)))</span>
<a href="#l1.6397"></a><span id="l1.6397" class="difflineminus">-            || (flags &amp; MSG_VIEW_FLAG_DUMMY))</span>
<a href="#l1.6398"></a><span id="l1.6398" class="difflineplus">+        if ((flags &amp; nsMsgMessageFlags::Elided &amp;&amp;</span>
<a href="#l1.6399"></a><span id="l1.6399" class="difflineplus">+             NS_SUCCEEDED(ExpandByIndex(threadIndex, nullptr))) ||</span>
<a href="#l1.6400"></a><span id="l1.6400" class="difflineplus">+            flags &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l1.6401"></a><span id="l1.6401" class="difflineplus">+        {</span>
<a href="#l1.6402"></a><span id="l1.6402">           retIndex = (nsMsgViewIndex) m_keys.IndexOf(key, threadIndex + 1);</span>
<a href="#l1.6403"></a><span id="l1.6403" class="difflineplus">+        }</span>
<a href="#l1.6404"></a><span id="l1.6404">       }</span>
<a href="#l1.6405"></a><span id="l1.6405">     }</span>
<a href="#l1.6406"></a><span id="l1.6406">   }</span>
<a href="#l1.6407"></a><span id="l1.6407" class="difflineplus">+</span>
<a href="#l1.6408"></a><span id="l1.6408">   return retIndex;</span>
<a href="#l1.6409"></a><span id="l1.6409"> }</span>
<a href="#l1.6410"></a><span id="l1.6410"> </span>
<a href="#l1.6411"></a><span id="l1.6411" class="difflineminus">-nsresult nsMsgDBView::GetThreadCount(nsMsgViewIndex index, uint32_t *pThreadCount)</span>
<a href="#l1.6412"></a><span id="l1.6412" class="difflineplus">+nsresult</span>
<a href="#l1.6413"></a><span id="l1.6413" class="difflineplus">+nsMsgDBView::GetThreadCount(nsMsgViewIndex index,</span>
<a href="#l1.6414"></a><span id="l1.6414" class="difflineplus">+                            uint32_t *pThreadCount)</span>
<a href="#l1.6415"></a><span id="l1.6415"> {</span>
<a href="#l1.6416"></a><span id="l1.6416">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.6417"></a><span id="l1.6417">   nsresult rv = GetMsgHdrForViewIndex(index, getter_AddRefs(msgHdr));</span>
<a href="#l1.6418"></a><span id="l1.6418">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.6419"></a><span id="l1.6419">   nsCOMPtr &lt;nsIMsgThread&gt; pThread;</span>
<a href="#l1.6420"></a><span id="l1.6420">   rv = GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(pThread));</span>
<a href="#l1.6421"></a><span id="l1.6421">   if (NS_SUCCEEDED(rv) &amp;&amp; pThread != nullptr)</span>
<a href="#l1.6422"></a><span id="l1.6422">     rv = pThread-&gt;GetNumChildren(pThreadCount);</span>
<a href="#l1.6423"></a><span id="l1.6423" class="difflineplus">+</span>
<a href="#l1.6424"></a><span id="l1.6424">   return rv;</span>
<a href="#l1.6425"></a><span id="l1.6425"> }</span>
<a href="#l1.6426"></a><span id="l1.6426"> </span>
<a href="#l1.6427"></a><span id="l1.6427"> // This counts the number of messages in an expanded thread, given the</span>
<a href="#l1.6428"></a><span id="l1.6428"> // index of the first message in the thread.</span>
<a href="#l1.6429"></a><span id="l1.6429" class="difflineminus">-int32_t nsMsgDBView::CountExpandedThread(nsMsgViewIndex index)</span>
<a href="#l1.6430"></a><span id="l1.6430" class="difflineplus">+int32_t</span>
<a href="#l1.6431"></a><span id="l1.6431" class="difflineplus">+nsMsgDBView::CountExpandedThread(nsMsgViewIndex index)</span>
<a href="#l1.6432"></a><span id="l1.6432"> {</span>
<a href="#l1.6433"></a><span id="l1.6433">   int32_t numInThread = 0;</span>
<a href="#l1.6434"></a><span id="l1.6434">   nsMsgViewIndex startOfThread = index;</span>
<a href="#l1.6435"></a><span id="l1.6435">   while ((int32_t) startOfThread &gt;= 0 &amp;&amp; m_levels[startOfThread] != 0)</span>
<a href="#l1.6436"></a><span id="l1.6436">     startOfThread--;</span>
<a href="#l1.6437"></a><span id="l1.6437" class="difflineplus">+</span>
<a href="#l1.6438"></a><span id="l1.6438">   nsMsgViewIndex threadIndex = startOfThread;</span>
<a href="#l1.6439"></a><span id="l1.6439">   do</span>
<a href="#l1.6440"></a><span id="l1.6440">   {</span>
<a href="#l1.6441"></a><span id="l1.6441">     threadIndex++;</span>
<a href="#l1.6442"></a><span id="l1.6442">     numInThread++;</span>
<a href="#l1.6443"></a><span id="l1.6443">   }</span>
<a href="#l1.6444"></a><span id="l1.6444">   while (threadIndex &lt; m_levels.Length() &amp;&amp; m_levels[threadIndex] != 0);</span>
<a href="#l1.6445"></a><span id="l1.6445"> </span>
<a href="#l1.6446"></a><span id="l1.6446">   return numInThread;</span>
<a href="#l1.6447"></a><span id="l1.6447"> }</span>
<a href="#l1.6448"></a><span id="l1.6448"> </span>
<a href="#l1.6449"></a><span id="l1.6449" class="difflineminus">-// returns the number of lines that would be added (&gt; 0) or removed (&lt; 0)</span>
<a href="#l1.6450"></a><span id="l1.6450" class="difflineplus">+// Returns the number of lines that would be added (&gt; 0) or removed (&lt; 0)</span>
<a href="#l1.6451"></a><span id="l1.6451"> // if we were to try to expand/collapse the passed index.</span>
<a href="#l1.6452"></a><span id="l1.6452" class="difflineminus">-nsresult nsMsgDBView::ExpansionDelta(nsMsgViewIndex index, int32_t *expansionDelta)</span>
<a href="#l1.6453"></a><span id="l1.6453" class="difflineplus">+nsresult</span>
<a href="#l1.6454"></a><span id="l1.6454" class="difflineplus">+nsMsgDBView::ExpansionDelta(nsMsgViewIndex index,</span>
<a href="#l1.6455"></a><span id="l1.6455" class="difflineplus">+                            int32_t *expansionDelta)</span>
<a href="#l1.6456"></a><span id="l1.6456"> {</span>
<a href="#l1.6457"></a><span id="l1.6457">   uint32_t numChildren;</span>
<a href="#l1.6458"></a><span id="l1.6458">   nsresult  rv;</span>
<a href="#l1.6459"></a><span id="l1.6459"> </span>
<a href="#l1.6460"></a><span id="l1.6460">   *expansionDelta = 0;</span>
<a href="#l1.6461"></a><span id="l1.6461">   if (index &gt;= ((nsMsgViewIndex) m_keys.Length()))</span>
<a href="#l1.6462"></a><span id="l1.6462">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.6463"></a><span id="l1.6463" class="difflineplus">+</span>
<a href="#l1.6464"></a><span id="l1.6464">   char  flags = m_flags[index];</span>
<a href="#l1.6465"></a><span id="l1.6465"> </span>
<a href="#l1.6466"></a><span id="l1.6466">   if (!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.6467"></a><span id="l1.6467">     return NS_OK;</span>
<a href="#l1.6468"></a><span id="l1.6468"> </span>
<a href="#l1.6469"></a><span id="l1.6469">   // The client can pass in the key of any message</span>
<a href="#l1.6470"></a><span id="l1.6470">   // in a thread and get the expansion delta for the thread.</span>
<a href="#l1.6471"></a><span id="l1.6471"> </span>
<a href="#l1.6472"></a><span id="l1.6472" class="difflineat">@@ -5066,60 +5605,67 @@ nsresult nsMsgDBView::ExpansionDelta(nsM</span>
<a href="#l1.6473"></a><span id="l1.6473">   {</span>
<a href="#l1.6474"></a><span id="l1.6474">     numChildren = CountExpandedThread(index);</span>
<a href="#l1.6475"></a><span id="l1.6475">     *expansionDelta = - (int32_t) (numChildren - 1);</span>
<a href="#l1.6476"></a><span id="l1.6476">   }</span>
<a href="#l1.6477"></a><span id="l1.6477"> </span>
<a href="#l1.6478"></a><span id="l1.6478">   return NS_OK;</span>
<a href="#l1.6479"></a><span id="l1.6479"> }</span>
<a href="#l1.6480"></a><span id="l1.6480"> </span>
<a href="#l1.6481"></a><span id="l1.6481" class="difflineminus">-nsresult nsMsgDBView::ToggleExpansion(nsMsgViewIndex index, uint32_t *numChanged)</span>
<a href="#l1.6482"></a><span id="l1.6482" class="difflineplus">+nsresult</span>
<a href="#l1.6483"></a><span id="l1.6483" class="difflineplus">+nsMsgDBView::ToggleExpansion(nsMsgViewIndex index,</span>
<a href="#l1.6484"></a><span id="l1.6484" class="difflineplus">+                             uint32_t *numChanged)</span>
<a href="#l1.6485"></a><span id="l1.6485"> {</span>
<a href="#l1.6486"></a><span id="l1.6486">   nsresult rv;</span>
<a href="#l1.6487"></a><span id="l1.6487">   NS_ENSURE_ARG(numChanged);</span>
<a href="#l1.6488"></a><span id="l1.6488">   *numChanged = 0;</span>
<a href="#l1.6489"></a><span id="l1.6489">   nsMsgViewIndex threadIndex = GetThreadIndex(index);</span>
<a href="#l1.6490"></a><span id="l1.6490">   if (threadIndex == nsMsgViewIndex_None)</span>
<a href="#l1.6491"></a><span id="l1.6491">   {</span>
<a href="#l1.6492"></a><span id="l1.6492">     NS_ASSERTION(false, &quot;couldn't find thread&quot;);</span>
<a href="#l1.6493"></a><span id="l1.6493">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.6494"></a><span id="l1.6494">   }</span>
<a href="#l1.6495"></a><span id="l1.6495" class="difflineplus">+</span>
<a href="#l1.6496"></a><span id="l1.6496">   int32_t  flags = m_flags[threadIndex];</span>
<a href="#l1.6497"></a><span id="l1.6497"> </span>
<a href="#l1.6498"></a><span id="l1.6498" class="difflineminus">-  // if not a thread, or doesn't have children, no expand/collapse</span>
<a href="#l1.6499"></a><span id="l1.6499" class="difflineminus">-  // If we add sub-thread expand collapse, this will need to be relaxed</span>
<a href="#l1.6500"></a><span id="l1.6500" class="difflineplus">+  // If not a thread, or doesn't have children, no expand/collapse.</span>
<a href="#l1.6501"></a><span id="l1.6501" class="difflineplus">+  // If we add sub-thread expand collapse, this will need to be relaxed.</span>
<a href="#l1.6502"></a><span id="l1.6502">   if (!(flags &amp; MSG_VIEW_FLAG_ISTHREAD) || !(flags &amp; MSG_VIEW_FLAG_HASCHILDREN))</span>
<a href="#l1.6503"></a><span id="l1.6503">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.6504"></a><span id="l1.6504" class="difflineplus">+</span>
<a href="#l1.6505"></a><span id="l1.6505">   if (flags &amp; nsMsgMessageFlags::Elided)</span>
<a href="#l1.6506"></a><span id="l1.6506">     rv = ExpandByIndex(threadIndex, numChanged);</span>
<a href="#l1.6507"></a><span id="l1.6507">   else</span>
<a href="#l1.6508"></a><span id="l1.6508">     rv = CollapseByIndex(threadIndex, numChanged);</span>
<a href="#l1.6509"></a><span id="l1.6509"> </span>
<a href="#l1.6510"></a><span id="l1.6510" class="difflineminus">-  // if we collaps/uncollapse a thread, this changes the selected URIs</span>
<a href="#l1.6511"></a><span id="l1.6511" class="difflineplus">+  // If we collaps/uncollapse a thread, this changes the selected URIs.</span>
<a href="#l1.6512"></a><span id="l1.6512">   SelectionChanged();</span>
<a href="#l1.6513"></a><span id="l1.6513">   return rv;</span>
<a href="#l1.6514"></a><span id="l1.6514"> }</span>
<a href="#l1.6515"></a><span id="l1.6515"> </span>
<a href="#l1.6516"></a><span id="l1.6516" class="difflineminus">-nsresult nsMsgDBView::ExpandAndSelectThread()</span>
<a href="#l1.6517"></a><span id="l1.6517" class="difflineminus">-{</span>
<a href="#l1.6518"></a><span id="l1.6518" class="difflineminus">-    nsresult rv;</span>
<a href="#l1.6519"></a><span id="l1.6519" class="difflineminus">-</span>
<a href="#l1.6520"></a><span id="l1.6520" class="difflineminus">-    NS_ASSERTION(mTreeSelection, &quot;no tree selection&quot;);</span>
<a href="#l1.6521"></a><span id="l1.6521" class="difflineminus">-    if (!mTreeSelection) return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.6522"></a><span id="l1.6522" class="difflineminus">-</span>
<a href="#l1.6523"></a><span id="l1.6523" class="difflineminus">-    int32_t index;</span>
<a href="#l1.6524"></a><span id="l1.6524" class="difflineminus">-    rv = mTreeSelection-&gt;GetCurrentIndex(&amp;index);</span>
<a href="#l1.6525"></a><span id="l1.6525" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.6526"></a><span id="l1.6526" class="difflineminus">-</span>
<a href="#l1.6527"></a><span id="l1.6527" class="difflineminus">-    rv = ExpandAndSelectThreadByIndex(index, false);</span>
<a href="#l1.6528"></a><span id="l1.6528" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.6529"></a><span id="l1.6529" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.6530"></a><span id="l1.6530" class="difflineminus">-}</span>
<a href="#l1.6531"></a><span id="l1.6531" class="difflineminus">-</span>
<a href="#l1.6532"></a><span id="l1.6532" class="difflineminus">-nsresult nsMsgDBView::ExpandAndSelectThreadByIndex(nsMsgViewIndex index, bool augment)</span>
<a href="#l1.6533"></a><span id="l1.6533" class="difflineplus">+nsresult</span>
<a href="#l1.6534"></a><span id="l1.6534" class="difflineplus">+nsMsgDBView::ExpandAndSelectThread()</span>
<a href="#l1.6535"></a><span id="l1.6535" class="difflineplus">+{</span>
<a href="#l1.6536"></a><span id="l1.6536" class="difflineplus">+  nsresult rv;</span>
<a href="#l1.6537"></a><span id="l1.6537" class="difflineplus">+</span>
<a href="#l1.6538"></a><span id="l1.6538" class="difflineplus">+  NS_ASSERTION(mTreeSelection, &quot;no tree selection&quot;);</span>
<a href="#l1.6539"></a><span id="l1.6539" class="difflineplus">+  if (!mTreeSelection) return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.6540"></a><span id="l1.6540" class="difflineplus">+</span>
<a href="#l1.6541"></a><span id="l1.6541" class="difflineplus">+  int32_t index;</span>
<a href="#l1.6542"></a><span id="l1.6542" class="difflineplus">+  rv = mTreeSelection-&gt;GetCurrentIndex(&amp;index);</span>
<a href="#l1.6543"></a><span id="l1.6543" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.6544"></a><span id="l1.6544" class="difflineplus">+</span>
<a href="#l1.6545"></a><span id="l1.6545" class="difflineplus">+  rv = ExpandAndSelectThreadByIndex(index, false);</span>
<a href="#l1.6546"></a><span id="l1.6546" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.6547"></a><span id="l1.6547" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.6548"></a><span id="l1.6548" class="difflineplus">+}</span>
<a href="#l1.6549"></a><span id="l1.6549" class="difflineplus">+</span>
<a href="#l1.6550"></a><span id="l1.6550" class="difflineplus">+nsresult</span>
<a href="#l1.6551"></a><span id="l1.6551" class="difflineplus">+nsMsgDBView::ExpandAndSelectThreadByIndex(nsMsgViewIndex index,</span>
<a href="#l1.6552"></a><span id="l1.6552" class="difflineplus">+                                          bool augment)</span>
<a href="#l1.6553"></a><span id="l1.6553"> {</span>
<a href="#l1.6554"></a><span id="l1.6554">   nsresult rv;</span>
<a href="#l1.6555"></a><span id="l1.6555"> </span>
<a href="#l1.6556"></a><span id="l1.6556">   nsMsgViewIndex threadIndex;</span>
<a href="#l1.6557"></a><span id="l1.6557">   bool inThreadedMode = (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay);</span>
<a href="#l1.6558"></a><span id="l1.6558"> </span>
<a href="#l1.6559"></a><span id="l1.6559">   if (inThreadedMode)</span>
<a href="#l1.6560"></a><span id="l1.6560">   {</span>
<a href="#l1.6561"></a><span id="l1.6561" class="difflineat">@@ -5135,168 +5681,205 @@ nsresult nsMsgDBView::ExpandAndSelectThr</span>
<a href="#l1.6562"></a><span id="l1.6562">   else</span>
<a href="#l1.6563"></a><span id="l1.6563">   {</span>
<a href="#l1.6564"></a><span id="l1.6564">     threadIndex = index;</span>
<a href="#l1.6565"></a><span id="l1.6565">   }</span>
<a href="#l1.6566"></a><span id="l1.6566"> </span>
<a href="#l1.6567"></a><span id="l1.6567">   int32_t flags = m_flags[threadIndex];</span>
<a href="#l1.6568"></a><span id="l1.6568">   int32_t count = 0;</span>
<a href="#l1.6569"></a><span id="l1.6569"> </span>
<a href="#l1.6570"></a><span id="l1.6570" class="difflineminus">-  if (inThreadedMode &amp;&amp; (flags &amp; MSG_VIEW_FLAG_ISTHREAD) &amp;&amp; (flags &amp; MSG_VIEW_FLAG_HASCHILDREN))</span>
<a href="#l1.6571"></a><span id="l1.6571" class="difflineminus">-  {</span>
<a href="#l1.6572"></a><span id="l1.6572" class="difflineminus">-    // if closed, expand this thread.</span>
<a href="#l1.6573"></a><span id="l1.6573" class="difflineplus">+  if (inThreadedMode &amp;&amp;</span>
<a href="#l1.6574"></a><span id="l1.6574" class="difflineplus">+      flags &amp; MSG_VIEW_FLAG_ISTHREAD &amp;&amp;</span>
<a href="#l1.6575"></a><span id="l1.6575" class="difflineplus">+      flags &amp; MSG_VIEW_FLAG_HASCHILDREN)</span>
<a href="#l1.6576"></a><span id="l1.6576" class="difflineplus">+  {</span>
<a href="#l1.6577"></a><span id="l1.6577" class="difflineplus">+    // If closed, expand this thread.</span>
<a href="#l1.6578"></a><span id="l1.6578">     if (flags &amp; nsMsgMessageFlags::Elided)</span>
<a href="#l1.6579"></a><span id="l1.6579">     {</span>
<a href="#l1.6580"></a><span id="l1.6580">       uint32_t numExpanded;</span>
<a href="#l1.6581"></a><span id="l1.6581">       rv = ExpandByIndex(threadIndex, &amp;numExpanded);</span>
<a href="#l1.6582"></a><span id="l1.6582">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.6583"></a><span id="l1.6583">     }</span>
<a href="#l1.6584"></a><span id="l1.6584"> </span>
<a href="#l1.6585"></a><span id="l1.6585" class="difflineminus">-    // get the number of messages in the expanded thread</span>
<a href="#l1.6586"></a><span id="l1.6586" class="difflineminus">-    // so we know how many to select</span>
<a href="#l1.6587"></a><span id="l1.6587" class="difflineplus">+    // Get the number of messages in the expanded thread so we know how many</span>
<a href="#l1.6588"></a><span id="l1.6588" class="difflineplus">+    // to select.</span>
<a href="#l1.6589"></a><span id="l1.6589">     count = CountExpandedThread(threadIndex);</span>
<a href="#l1.6590"></a><span id="l1.6590">   }</span>
<a href="#l1.6591"></a><span id="l1.6591">   else</span>
<a href="#l1.6592"></a><span id="l1.6592">   {</span>
<a href="#l1.6593"></a><span id="l1.6593">     count = 1;</span>
<a href="#l1.6594"></a><span id="l1.6594">   }</span>
<a href="#l1.6595"></a><span id="l1.6595" class="difflineplus">+</span>
<a href="#l1.6596"></a><span id="l1.6596">   NS_ASSERTION(count &gt; 0, &quot;bad count&quot;);</span>
<a href="#l1.6597"></a><span id="l1.6597"> </span>
<a href="#l1.6598"></a><span id="l1.6598" class="difflineminus">-  // update the selection</span>
<a href="#l1.6599"></a><span id="l1.6599" class="difflineplus">+  // Update the selection.</span>
<a href="#l1.6600"></a><span id="l1.6600"> </span>
<a href="#l1.6601"></a><span id="l1.6601">   NS_ASSERTION(mTreeSelection, &quot;no tree selection&quot;);</span>
<a href="#l1.6602"></a><span id="l1.6602" class="difflineminus">-  if (!mTreeSelection) return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.6603"></a><span id="l1.6603" class="difflineminus">-</span>
<a href="#l1.6604"></a><span id="l1.6604" class="difflineminus">-  // the count should be 1 or greater. if there was only one message in the thread, we just select it.</span>
<a href="#l1.6605"></a><span id="l1.6605" class="difflineminus">-  // if more, we select all of them.</span>
<a href="#l1.6606"></a><span id="l1.6606" class="difflineplus">+  if (!mTreeSelection)</span>
<a href="#l1.6607"></a><span id="l1.6607" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.6608"></a><span id="l1.6608" class="difflineplus">+</span>
<a href="#l1.6609"></a><span id="l1.6609" class="difflineplus">+  // The count should be 1 or greater. If there was only one message in the</span>
<a href="#l1.6610"></a><span id="l1.6610" class="difflineplus">+  // thread, we just select it. If more, we select all of them.</span>
<a href="#l1.6611"></a><span id="l1.6611">   mTreeSelection-&gt;RangedSelect(threadIndex + count - 1, threadIndex, augment);</span>
<a href="#l1.6612"></a><span id="l1.6612">   return NS_OK;</span>
<a href="#l1.6613"></a><span id="l1.6613"> }</span>
<a href="#l1.6614"></a><span id="l1.6614"> </span>
<a href="#l1.6615"></a><span id="l1.6615" class="difflineminus">-nsresult nsMsgDBView::ExpandAll()</span>
<a href="#l1.6616"></a><span id="l1.6616" class="difflineplus">+nsresult</span>
<a href="#l1.6617"></a><span id="l1.6617" class="difflineplus">+nsMsgDBView::ExpandAll()</span>
<a href="#l1.6618"></a><span id="l1.6618"> {</span>
<a href="#l1.6619"></a><span id="l1.6619">   if (mTree)</span>
<a href="#l1.6620"></a><span id="l1.6620">     mTree-&gt;BeginUpdateBatch();</span>
<a href="#l1.6621"></a><span id="l1.6621" class="difflineplus">+</span>
<a href="#l1.6622"></a><span id="l1.6622">   for (int32_t i = GetSize() - 1; i &gt;= 0; i--)</span>
<a href="#l1.6623"></a><span id="l1.6623">   {</span>
<a href="#l1.6624"></a><span id="l1.6624">     uint32_t numExpanded;</span>
<a href="#l1.6625"></a><span id="l1.6625">     uint32_t flags = m_flags[i];</span>
<a href="#l1.6626"></a><span id="l1.6626">     if (flags &amp; nsMsgMessageFlags::Elided)</span>
<a href="#l1.6627"></a><span id="l1.6627">       ExpandByIndex(i, &amp;numExpanded);</span>
<a href="#l1.6628"></a><span id="l1.6628">   }</span>
<a href="#l1.6629"></a><span id="l1.6629" class="difflineplus">+</span>
<a href="#l1.6630"></a><span id="l1.6630">   if (mTree)</span>
<a href="#l1.6631"></a><span id="l1.6631">     mTree-&gt;EndUpdateBatch();</span>
<a href="#l1.6632"></a><span id="l1.6632" class="difflineplus">+</span>
<a href="#l1.6633"></a><span id="l1.6633">   SelectionChanged();</span>
<a href="#l1.6634"></a><span id="l1.6634">   return NS_OK;</span>
<a href="#l1.6635"></a><span id="l1.6635"> }</span>
<a href="#l1.6636"></a><span id="l1.6636"> </span>
<a href="#l1.6637"></a><span id="l1.6637" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetThreadContainingMsgHdr(nsIMsgDBHdr *msgHdr, nsIMsgThread **pThread)</span>
<a href="#l1.6638"></a><span id="l1.6638" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.6639"></a><span id="l1.6639" class="difflineplus">+nsMsgDBView::GetThreadContainingMsgHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.6640"></a><span id="l1.6640" class="difflineplus">+                                       nsIMsgThread **pThread)</span>
<a href="#l1.6641"></a><span id="l1.6641"> {</span>
<a href="#l1.6642"></a><span id="l1.6642">   return m_db-&gt;GetThreadContainingMsgHdr(msgHdr, pThread);</span>
<a href="#l1.6643"></a><span id="l1.6643"> }</span>
<a href="#l1.6644"></a><span id="l1.6644"> </span>
<a href="#l1.6645"></a><span id="l1.6645" class="difflineminus">-nsresult nsMsgDBView::ExpandByIndex(nsMsgViewIndex index, uint32_t *pNumExpanded)</span>
<a href="#l1.6646"></a><span id="l1.6646" class="difflineplus">+nsresult</span>
<a href="#l1.6647"></a><span id="l1.6647" class="difflineplus">+nsMsgDBView::ExpandByIndex(nsMsgViewIndex index,</span>
<a href="#l1.6648"></a><span id="l1.6648" class="difflineplus">+                           uint32_t *pNumExpanded)</span>
<a href="#l1.6649"></a><span id="l1.6649"> {</span>
<a href="#l1.6650"></a><span id="l1.6650">   if ((uint32_t) index &gt;= m_keys.Length())</span>
<a href="#l1.6651"></a><span id="l1.6651">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.6652"></a><span id="l1.6652"> </span>
<a href="#l1.6653"></a><span id="l1.6653" class="difflineminus">-  uint32_t      flags = m_flags[index];</span>
<a href="#l1.6654"></a><span id="l1.6654" class="difflineminus">-  uint32_t      numExpanded = 0;</span>
<a href="#l1.6655"></a><span id="l1.6655" class="difflineminus">-</span>
<a href="#l1.6656"></a><span id="l1.6656" class="difflineminus">-  NS_ASSERTION(flags &amp; nsMsgMessageFlags::Elided, &quot;can't expand an already expanded thread&quot;);</span>
<a href="#l1.6657"></a><span id="l1.6657" class="difflineplus">+  uint32_t flags = m_flags[index];</span>
<a href="#l1.6658"></a><span id="l1.6658" class="difflineplus">+  uint32_t numExpanded = 0;</span>
<a href="#l1.6659"></a><span id="l1.6659" class="difflineplus">+</span>
<a href="#l1.6660"></a><span id="l1.6660" class="difflineplus">+  NS_ASSERTION(flags &amp; nsMsgMessageFlags::Elided,</span>
<a href="#l1.6661"></a><span id="l1.6661" class="difflineplus">+               &quot;can't expand an already expanded thread&quot;);</span>
<a href="#l1.6662"></a><span id="l1.6662">   flags &amp;= ~nsMsgMessageFlags::Elided;</span>
<a href="#l1.6663"></a><span id="l1.6663"> </span>
<a href="#l1.6664"></a><span id="l1.6664">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.6665"></a><span id="l1.6665">   nsCOMPtr &lt;nsIMsgThread&gt; pThread;</span>
<a href="#l1.6666"></a><span id="l1.6666">   nsresult rv = GetThreadContainingIndex(index, getter_AddRefs(pThread));</span>
<a href="#l1.6667"></a><span id="l1.6667">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.6668"></a><span id="l1.6668">   if (m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly)</span>
<a href="#l1.6669"></a><span id="l1.6669">   {</span>
<a href="#l1.6670"></a><span id="l1.6670" class="difflineplus">+    // Keep top level hdr in thread, even though read.</span>
<a href="#l1.6671"></a><span id="l1.6671">     if (flags &amp; nsMsgMessageFlags::Read)</span>
<a href="#l1.6672"></a><span id="l1.6672" class="difflineminus">-      m_levels.AppendElement(0);  // keep top level hdr in thread, even though read.</span>
<a href="#l1.6673"></a><span id="l1.6673" class="difflineplus">+      m_levels.AppendElement(0);</span>
<a href="#l1.6674"></a><span id="l1.6674" class="difflineplus">+</span>
<a href="#l1.6675"></a><span id="l1.6675">     rv = ListUnreadIdsInThread(pThread,  index, &amp;numExpanded);</span>
<a href="#l1.6676"></a><span id="l1.6676">   }</span>
<a href="#l1.6677"></a><span id="l1.6677">   else</span>
<a href="#l1.6678"></a><span id="l1.6678" class="difflineplus">+  {</span>
<a href="#l1.6679"></a><span id="l1.6679">     rv = ListIdsInThread(pThread,  index, &amp;numExpanded);</span>
<a href="#l1.6680"></a><span id="l1.6680" class="difflineplus">+  }</span>
<a href="#l1.6681"></a><span id="l1.6681"> </span>
<a href="#l1.6682"></a><span id="l1.6682">   if (numExpanded &gt; 0)</span>
<a href="#l1.6683"></a><span id="l1.6683">   {</span>
<a href="#l1.6684"></a><span id="l1.6684">     m_flags[index] = flags;</span>
<a href="#l1.6685"></a><span id="l1.6685">     NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.6686"></a><span id="l1.6686">   }</span>
<a href="#l1.6687"></a><span id="l1.6687" class="difflineplus">+</span>
<a href="#l1.6688"></a><span id="l1.6688">   NoteStartChange(index + 1, numExpanded, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.6689"></a><span id="l1.6689">   NoteEndChange(index + 1, numExpanded, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.6690"></a><span id="l1.6690" class="difflineplus">+</span>
<a href="#l1.6691"></a><span id="l1.6691">   if (pNumExpanded != nullptr)</span>
<a href="#l1.6692"></a><span id="l1.6692">     *pNumExpanded = numExpanded;</span>
<a href="#l1.6693"></a><span id="l1.6693" class="difflineplus">+</span>
<a href="#l1.6694"></a><span id="l1.6694">   return rv;</span>
<a href="#l1.6695"></a><span id="l1.6695"> }</span>
<a href="#l1.6696"></a><span id="l1.6696"> </span>
<a href="#l1.6697"></a><span id="l1.6697" class="difflineminus">-nsresult nsMsgDBView::CollapseAll()</span>
<a href="#l1.6698"></a><span id="l1.6698" class="difflineplus">+nsresult</span>
<a href="#l1.6699"></a><span id="l1.6699" class="difflineplus">+nsMsgDBView::CollapseAll()</span>
<a href="#l1.6700"></a><span id="l1.6700"> {</span>
<a href="#l1.6701"></a><span id="l1.6701">   for (uint32_t i = 0; i &lt; GetSize(); i++)</span>
<a href="#l1.6702"></a><span id="l1.6702">   {</span>
<a href="#l1.6703"></a><span id="l1.6703">     uint32_t numExpanded;</span>
<a href="#l1.6704"></a><span id="l1.6704">     uint32_t flags = m_flags[i];</span>
<a href="#l1.6705"></a><span id="l1.6705">     if (!(flags &amp; nsMsgMessageFlags::Elided) &amp;&amp; (flags &amp; MSG_VIEW_FLAG_HASCHILDREN))</span>
<a href="#l1.6706"></a><span id="l1.6706">       CollapseByIndex(i, &amp;numExpanded);</span>
<a href="#l1.6707"></a><span id="l1.6707">   }</span>
<a href="#l1.6708"></a><span id="l1.6708" class="difflineplus">+</span>
<a href="#l1.6709"></a><span id="l1.6709">   SelectionChanged();</span>
<a href="#l1.6710"></a><span id="l1.6710">   return NS_OK;</span>
<a href="#l1.6711"></a><span id="l1.6711"> }</span>
<a href="#l1.6712"></a><span id="l1.6712"> </span>
<a href="#l1.6713"></a><span id="l1.6713" class="difflineminus">-nsresult nsMsgDBView::CollapseByIndex(nsMsgViewIndex index, uint32_t *pNumCollapsed)</span>
<a href="#l1.6714"></a><span id="l1.6714" class="difflineplus">+nsresult</span>
<a href="#l1.6715"></a><span id="l1.6715" class="difflineplus">+nsMsgDBView::CollapseByIndex(nsMsgViewIndex index,</span>
<a href="#l1.6716"></a><span id="l1.6716" class="difflineplus">+                             uint32_t *pNumCollapsed)</span>
<a href="#l1.6717"></a><span id="l1.6717"> {</span>
<a href="#l1.6718"></a><span id="l1.6718">   nsresult  rv;</span>
<a href="#l1.6719"></a><span id="l1.6719">   int32_t  flags = m_flags[index];</span>
<a href="#l1.6720"></a><span id="l1.6720">   int32_t  rowDelta = 0;</span>
<a href="#l1.6721"></a><span id="l1.6721"> </span>
<a href="#l1.6722"></a><span id="l1.6722" class="difflineminus">-  if (flags &amp; nsMsgMessageFlags::Elided || !(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) || !(flags &amp; MSG_VIEW_FLAG_HASCHILDREN))</span>
<a href="#l1.6723"></a><span id="l1.6723" class="difflineplus">+  if (flags &amp; nsMsgMessageFlags::Elided ||</span>
<a href="#l1.6724"></a><span id="l1.6724" class="difflineplus">+      !(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) ||</span>
<a href="#l1.6725"></a><span id="l1.6725" class="difflineplus">+      !(flags &amp; MSG_VIEW_FLAG_HASCHILDREN))</span>
<a href="#l1.6726"></a><span id="l1.6726" class="difflineplus">+  {</span>
<a href="#l1.6727"></a><span id="l1.6727">     return NS_OK;</span>
<a href="#l1.6728"></a><span id="l1.6728" class="difflineplus">+  }</span>
<a href="#l1.6729"></a><span id="l1.6729"> </span>
<a href="#l1.6730"></a><span id="l1.6730">   if (index &gt; m_keys.Length())</span>
<a href="#l1.6731"></a><span id="l1.6731">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.6732"></a><span id="l1.6732"> </span>
<a href="#l1.6733"></a><span id="l1.6733">   rv = ExpansionDelta(index, &amp;rowDelta);</span>
<a href="#l1.6734"></a><span id="l1.6734">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.6735"></a><span id="l1.6735"> </span>
<a href="#l1.6736"></a><span id="l1.6736">   flags |= nsMsgMessageFlags::Elided;</span>
<a href="#l1.6737"></a><span id="l1.6737"> </span>
<a href="#l1.6738"></a><span id="l1.6738">   m_flags[index] = flags;</span>
<a href="#l1.6739"></a><span id="l1.6739">   NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.6740"></a><span id="l1.6740"> </span>
<a href="#l1.6741"></a><span id="l1.6741" class="difflineminus">-  int32_t numRemoved = -rowDelta; // don't count first header in thread</span>
<a href="#l1.6742"></a><span id="l1.6742" class="difflineplus">+  // Don't count first header in thread.</span>
<a href="#l1.6743"></a><span id="l1.6743" class="difflineplus">+  int32_t numRemoved = -rowDelta;</span>
<a href="#l1.6744"></a><span id="l1.6744">   if (index + 1 + numRemoved &gt; m_keys.Length())</span>
<a href="#l1.6745"></a><span id="l1.6745">   {</span>
<a href="#l1.6746"></a><span id="l1.6746">     NS_ERROR(&quot;trying to remove too many rows&quot;);</span>
<a href="#l1.6747"></a><span id="l1.6747">     numRemoved -= (index + 1 + numRemoved) - m_keys.Length();</span>
<a href="#l1.6748"></a><span id="l1.6748">     if (numRemoved &lt;= 0)</span>
<a href="#l1.6749"></a><span id="l1.6749">       return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.6750"></a><span id="l1.6750">   }</span>
<a href="#l1.6751"></a><span id="l1.6751" class="difflineplus">+</span>
<a href="#l1.6752"></a><span id="l1.6752">   NoteStartChange(index + 1, rowDelta, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.6753"></a><span id="l1.6753" class="difflineminus">-  // start at first id after thread.</span>
<a href="#l1.6754"></a><span id="l1.6754" class="difflineplus">+  // Start at first id after thread.</span>
<a href="#l1.6755"></a><span id="l1.6755">   RemoveRows(index + 1, numRemoved);</span>
<a href="#l1.6756"></a><span id="l1.6756">   if (pNumCollapsed != nullptr)</span>
<a href="#l1.6757"></a><span id="l1.6757">     *pNumCollapsed = numRemoved;</span>
<a href="#l1.6758"></a><span id="l1.6758" class="difflineplus">+</span>
<a href="#l1.6759"></a><span id="l1.6759">   NoteEndChange(index + 1, rowDelta, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.6760"></a><span id="l1.6760"> </span>
<a href="#l1.6761"></a><span id="l1.6761">   return rv;</span>
<a href="#l1.6762"></a><span id="l1.6762"> }</span>
<a href="#l1.6763"></a><span id="l1.6763"> </span>
<a href="#l1.6764"></a><span id="l1.6764" class="difflineminus">-nsresult nsMsgDBView::OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey aParentKey, bool /*ensureListed*/)</span>
<a href="#l1.6765"></a><span id="l1.6765" class="difflineminus">-{</span>
<a href="#l1.6766"></a><span id="l1.6766" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l1.6767"></a><span id="l1.6767" class="difflineminus">-    // views can override this behaviour, which is to append to view.</span>
<a href="#l1.6768"></a><span id="l1.6768" class="difflineminus">-    // This is the mail behaviour, but threaded views will want</span>
<a href="#l1.6769"></a><span id="l1.6769" class="difflineminus">-    // to insert in order...</span>
<a href="#l1.6770"></a><span id="l1.6770" class="difflineminus">-    if (newHdr)</span>
<a href="#l1.6771"></a><span id="l1.6771" class="difflineminus">-  rv = AddHdr(newHdr);</span>
<a href="#l1.6772"></a><span id="l1.6772" class="difflineminus">-    return rv;</span>
<a href="#l1.6773"></a><span id="l1.6773" class="difflineminus">-}</span>
<a href="#l1.6774"></a><span id="l1.6774" class="difflineminus">-</span>
<a href="#l1.6775"></a><span id="l1.6775" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetThreadContainingIndex(nsMsgViewIndex index, nsIMsgThread **resultThread)</span>
<a href="#l1.6776"></a><span id="l1.6776" class="difflineplus">+nsresult</span>
<a href="#l1.6777"></a><span id="l1.6777" class="difflineplus">+nsMsgDBView::OnNewHeader(nsIMsgDBHdr *newHdr,</span>
<a href="#l1.6778"></a><span id="l1.6778" class="difflineplus">+                         nsMsgKey aParentKey,</span>
<a href="#l1.6779"></a><span id="l1.6779" class="difflineplus">+                         bool /*ensureListed*/)</span>
<a href="#l1.6780"></a><span id="l1.6780" class="difflineplus">+{</span>
<a href="#l1.6781"></a><span id="l1.6781" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l1.6782"></a><span id="l1.6782" class="difflineplus">+  // Views can override this behaviour, which is to append to view.</span>
<a href="#l1.6783"></a><span id="l1.6783" class="difflineplus">+  // This is the mail behaviour, but threaded views will want</span>
<a href="#l1.6784"></a><span id="l1.6784" class="difflineplus">+  // to insert in order...</span>
<a href="#l1.6785"></a><span id="l1.6785" class="difflineplus">+  if (newHdr)</span>
<a href="#l1.6786"></a><span id="l1.6786" class="difflineplus">+    rv = AddHdr(newHdr);</span>
<a href="#l1.6787"></a><span id="l1.6787" class="difflineplus">+</span>
<a href="#l1.6788"></a><span id="l1.6788" class="difflineplus">+  return rv;</span>
<a href="#l1.6789"></a><span id="l1.6789" class="difflineplus">+}</span>
<a href="#l1.6790"></a><span id="l1.6790" class="difflineplus">+</span>
<a href="#l1.6791"></a><span id="l1.6791" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.6792"></a><span id="l1.6792" class="difflineplus">+nsMsgDBView::GetThreadContainingIndex(nsMsgViewIndex index,</span>
<a href="#l1.6793"></a><span id="l1.6793" class="difflineplus">+                                      nsIMsgThread **resultThread)</span>
<a href="#l1.6794"></a><span id="l1.6794"> {</span>
<a href="#l1.6795"></a><span id="l1.6795">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.6796"></a><span id="l1.6796">   nsresult rv = GetMsgHdrForViewIndex(index, getter_AddRefs(msgHdr));</span>
<a href="#l1.6797"></a><span id="l1.6797">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.6798"></a><span id="l1.6798">   return GetThreadContainingMsgHdr(msgHdr, resultThread);</span>
<a href="#l1.6799"></a><span id="l1.6799"> }</span>
<a href="#l1.6800"></a><span id="l1.6800"> </span>
<a href="#l1.6801"></a><span id="l1.6801"> nsMsgViewIndex</span>
<a href="#l1.6802"></a><span id="l1.6802" class="difflineat">@@ -5348,92 +5931,103 @@ nsMsgDBView::GetIndexForThread(nsIMsgDBH</span>
<a href="#l1.6803"></a><span id="l1.6803">       rv = GetCollationKey(msgHdr, m_sortType, &amp;EntryInfo1.key, &amp;EntryInfo1.dword, colHandler);</span>
<a href="#l1.6804"></a><span id="l1.6804">       NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.6805"></a><span id="l1.6805">       break;</span>
<a href="#l1.6806"></a><span id="l1.6806">     case kU32:</span>
<a href="#l1.6807"></a><span id="l1.6807">       if (m_sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.6808"></a><span id="l1.6808">         EntryInfo1.dword = EntryInfo1.id;</span>
<a href="#l1.6809"></a><span id="l1.6809">       else</span>
<a href="#l1.6810"></a><span id="l1.6810">         GetLongField(msgHdr, m_sortType, &amp;EntryInfo1.dword, colHandler);</span>
<a href="#l1.6811"></a><span id="l1.6811" class="difflineplus">+</span>
<a href="#l1.6812"></a><span id="l1.6812">       break;</span>
<a href="#l1.6813"></a><span id="l1.6813">     default:</span>
<a href="#l1.6814"></a><span id="l1.6814">       return highIndex;</span>
<a href="#l1.6815"></a><span id="l1.6815">   }</span>
<a href="#l1.6816"></a><span id="l1.6816" class="difflineplus">+</span>
<a href="#l1.6817"></a><span id="l1.6817">   while (highIndex &gt; lowIndex)</span>
<a href="#l1.6818"></a><span id="l1.6818">   {</span>
<a href="#l1.6819"></a><span id="l1.6819">     nsMsgViewIndex tryIndex = (lowIndex + highIndex) / 2;</span>
<a href="#l1.6820"></a><span id="l1.6820" class="difflineminus">-    // need to adjust tryIndex if it's not a thread.</span>
<a href="#l1.6821"></a><span id="l1.6821" class="difflineplus">+    // Need to adjust tryIndex if it's not a thread.</span>
<a href="#l1.6822"></a><span id="l1.6822">     while (m_levels[tryIndex] &amp;&amp; tryIndex)</span>
<a href="#l1.6823"></a><span id="l1.6823">       tryIndex--;</span>
<a href="#l1.6824"></a><span id="l1.6824"> </span>
<a href="#l1.6825"></a><span id="l1.6825">     if (tryIndex &lt; lowIndex)</span>
<a href="#l1.6826"></a><span id="l1.6826">     {</span>
<a href="#l1.6827"></a><span id="l1.6827">       NS_ERROR(&quot;try index shouldn't be less than low index&quot;);</span>
<a href="#l1.6828"></a><span id="l1.6828">       break;</span>
<a href="#l1.6829"></a><span id="l1.6829">     }</span>
<a href="#l1.6830"></a><span id="l1.6830" class="difflineplus">+</span>
<a href="#l1.6831"></a><span id="l1.6831">     EntryInfo2.id = m_keys[tryIndex];</span>
<a href="#l1.6832"></a><span id="l1.6832">     GetFolderForViewIndex(tryIndex, &amp;EntryInfo2.folder);</span>
<a href="#l1.6833"></a><span id="l1.6833">     EntryInfo2.folder-&gt;Release();</span>
<a href="#l1.6834"></a><span id="l1.6834"> </span>
<a href="#l1.6835"></a><span id="l1.6835">     nsCOMPtr &lt;nsIMsgDBHdr&gt; tryHdr;</span>
<a href="#l1.6836"></a><span id="l1.6836">     nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.6837"></a><span id="l1.6837">     // ### this should get the db from the folder...</span>
<a href="#l1.6838"></a><span id="l1.6838">     GetDBForViewIndex(tryIndex, getter_AddRefs(db));</span>
<a href="#l1.6839"></a><span id="l1.6839">     if (db)</span>
<a href="#l1.6840"></a><span id="l1.6840">       rv = db-&gt;GetMsgHdrForKey(EntryInfo2.id, getter_AddRefs(tryHdr));</span>
<a href="#l1.6841"></a><span id="l1.6841" class="difflineplus">+</span>
<a href="#l1.6842"></a><span id="l1.6842">     if (!tryHdr)</span>
<a href="#l1.6843"></a><span id="l1.6843">       break;</span>
<a href="#l1.6844"></a><span id="l1.6844" class="difflineplus">+</span>
<a href="#l1.6845"></a><span id="l1.6845">     if (tryHdr == msgHdr)</span>
<a href="#l1.6846"></a><span id="l1.6846">     {</span>
<a href="#l1.6847"></a><span id="l1.6847">       NS_WARNING(&quot;didn't expect header to already be in view&quot;);</span>
<a href="#l1.6848"></a><span id="l1.6848">       highIndex = tryIndex;</span>
<a href="#l1.6849"></a><span id="l1.6849">       break;</span>
<a href="#l1.6850"></a><span id="l1.6850">     }</span>
<a href="#l1.6851"></a><span id="l1.6851" class="difflineplus">+</span>
<a href="#l1.6852"></a><span id="l1.6852">     if (fieldType == kCollationKey)</span>
<a href="#l1.6853"></a><span id="l1.6853">     {</span>
<a href="#l1.6854"></a><span id="l1.6854">       PR_FREEIF(EntryInfo2.key);</span>
<a href="#l1.6855"></a><span id="l1.6855">       rv = GetCollationKey(tryHdr, m_sortType, &amp;EntryInfo2.key, &amp;EntryInfo2.dword, colHandler);</span>
<a href="#l1.6856"></a><span id="l1.6856">       NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.6857"></a><span id="l1.6857">       retStatus = FnSortIdKeyPtr(&amp;pValue1, &amp;pValue2, &amp;comparisonContext);</span>
<a href="#l1.6858"></a><span id="l1.6858">     }</span>
<a href="#l1.6859"></a><span id="l1.6859">     else if (fieldType == kU32)</span>
<a href="#l1.6860"></a><span id="l1.6860">     {</span>
<a href="#l1.6861"></a><span id="l1.6861">       if (m_sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.6862"></a><span id="l1.6862">         EntryInfo2.dword = EntryInfo2.id;</span>
<a href="#l1.6863"></a><span id="l1.6863">       else</span>
<a href="#l1.6864"></a><span id="l1.6864">         GetLongField(tryHdr, m_sortType, &amp;EntryInfo2.dword, colHandler);</span>
<a href="#l1.6865"></a><span id="l1.6865" class="difflineplus">+</span>
<a href="#l1.6866"></a><span id="l1.6866">       retStatus = FnSortIdUint32(&amp;pValue1, &amp;pValue2, &amp;comparisonContext);</span>
<a href="#l1.6867"></a><span id="l1.6867">     }</span>
<a href="#l1.6868"></a><span id="l1.6868" class="difflineplus">+</span>
<a href="#l1.6869"></a><span id="l1.6869">     if (retStatus == 0)</span>
<a href="#l1.6870"></a><span id="l1.6870">     {</span>
<a href="#l1.6871"></a><span id="l1.6871">       highIndex = tryIndex;</span>
<a href="#l1.6872"></a><span id="l1.6872">       break;</span>
<a href="#l1.6873"></a><span id="l1.6873">     }</span>
<a href="#l1.6874"></a><span id="l1.6874"> </span>
<a href="#l1.6875"></a><span id="l1.6875">     if (retStatus &lt; 0)</span>
<a href="#l1.6876"></a><span id="l1.6876">     {</span>
<a href="#l1.6877"></a><span id="l1.6877">       highIndex = tryIndex;</span>
<a href="#l1.6878"></a><span id="l1.6878" class="difflineminus">-      // we already made sure tryIndex was at a thread at the top of the loop.</span>
<a href="#l1.6879"></a><span id="l1.6879" class="difflineplus">+      // We already made sure tryIndex was at a thread at the top of the loop.</span>
<a href="#l1.6880"></a><span id="l1.6880">     }</span>
<a href="#l1.6881"></a><span id="l1.6881">     else</span>
<a href="#l1.6882"></a><span id="l1.6882">     {</span>
<a href="#l1.6883"></a><span id="l1.6883">       lowIndex = tryIndex + 1;</span>
<a href="#l1.6884"></a><span id="l1.6884">       while (lowIndex &lt; GetSize() &amp;&amp; m_levels[lowIndex])</span>
<a href="#l1.6885"></a><span id="l1.6885">         lowIndex++;</span>
<a href="#l1.6886"></a><span id="l1.6886">     }</span>
<a href="#l1.6887"></a><span id="l1.6887">   }</span>
<a href="#l1.6888"></a><span id="l1.6888"> </span>
<a href="#l1.6889"></a><span id="l1.6889">   PR_Free(EntryInfo1.key);</span>
<a href="#l1.6890"></a><span id="l1.6890">   PR_Free(EntryInfo2.key);</span>
<a href="#l1.6891"></a><span id="l1.6891">   return highIndex;</span>
<a href="#l1.6892"></a><span id="l1.6892"> }</span>
<a href="#l1.6893"></a><span id="l1.6893"> </span>
<a href="#l1.6894"></a><span id="l1.6894" class="difflineminus">-nsMsgViewIndex nsMsgDBView::GetInsertIndexHelper(nsIMsgDBHdr *msgHdr, nsTArray&lt;nsMsgKey&gt; &amp;keys,</span>
<a href="#l1.6895"></a><span id="l1.6895" class="difflineminus">-                                                 nsCOMArray&lt;nsIMsgFolder&gt; *folders,</span>
<a href="#l1.6896"></a><span id="l1.6896" class="difflineminus">-                                                 nsMsgViewSortOrderValue sortOrder, nsMsgViewSortTypeValue sortType)</span>
<a href="#l1.6897"></a><span id="l1.6897" class="difflineplus">+nsMsgViewIndex</span>
<a href="#l1.6898"></a><span id="l1.6898" class="difflineplus">+nsMsgDBView::GetInsertIndexHelper(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.6899"></a><span id="l1.6899" class="difflineplus">+                                  nsTArray&lt;nsMsgKey&gt; &amp;keys,</span>
<a href="#l1.6900"></a><span id="l1.6900" class="difflineplus">+                                  nsCOMArray&lt;nsIMsgFolder&gt; *folders,</span>
<a href="#l1.6901"></a><span id="l1.6901" class="difflineplus">+                                  nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l1.6902"></a><span id="l1.6902" class="difflineplus">+                                  nsMsgViewSortTypeValue sortType)</span>
<a href="#l1.6903"></a><span id="l1.6903"> {</span>
<a href="#l1.6904"></a><span id="l1.6904">   nsMsgViewIndex highIndex = keys.Length();</span>
<a href="#l1.6905"></a><span id="l1.6905">   nsMsgViewIndex lowIndex = 0;</span>
<a href="#l1.6906"></a><span id="l1.6906">   IdKeyPtr EntryInfo1, EntryInfo2;</span>
<a href="#l1.6907"></a><span id="l1.6907">   EntryInfo1.key = nullptr;</span>
<a href="#l1.6908"></a><span id="l1.6908">   EntryInfo2.key = nullptr;</span>
<a href="#l1.6909"></a><span id="l1.6909"> </span>
<a href="#l1.6910"></a><span id="l1.6910">   nsresult rv;</span>
<a href="#l1.6911"></a><span id="l1.6911" class="difflineat">@@ -5462,58 +6056,63 @@ nsMsgViewIndex nsMsgDBView::GetInsertInd</span>
<a href="#l1.6912"></a><span id="l1.6912"> </span>
<a href="#l1.6913"></a><span id="l1.6913">   viewSortInfo comparisonContext;</span>
<a href="#l1.6914"></a><span id="l1.6914">   comparisonContext.view = this;</span>
<a href="#l1.6915"></a><span id="l1.6915">   comparisonContext.isSecondarySort = false;</span>
<a href="#l1.6916"></a><span id="l1.6916">   comparisonContext.ascendingSort = (sortOrder == nsMsgViewSortOrder::ascending);</span>
<a href="#l1.6917"></a><span id="l1.6917">   rv = EntryInfo1.folder-&gt;GetMsgDatabase(&amp;comparisonContext.db);</span>
<a href="#l1.6918"></a><span id="l1.6918">   NS_ENSURE_SUCCESS(rv, highIndex);</span>
<a href="#l1.6919"></a><span id="l1.6919">   comparisonContext.db-&gt;Release();</span>
<a href="#l1.6920"></a><span id="l1.6920" class="difflineplus">+</span>
<a href="#l1.6921"></a><span id="l1.6921">   switch (fieldType)</span>
<a href="#l1.6922"></a><span id="l1.6922">   {</span>
<a href="#l1.6923"></a><span id="l1.6923">     case kCollationKey:</span>
<a href="#l1.6924"></a><span id="l1.6924">       rv = GetCollationKey(msgHdr, sortType, &amp;EntryInfo1.key, &amp;EntryInfo1.dword, colHandler);</span>
<a href="#l1.6925"></a><span id="l1.6925">       NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.6926"></a><span id="l1.6926">       comparisonFun = FnSortIdKeyPtr;</span>
<a href="#l1.6927"></a><span id="l1.6927">       break;</span>
<a href="#l1.6928"></a><span id="l1.6928">     case kU32:</span>
<a href="#l1.6929"></a><span id="l1.6929">       if (sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.6930"></a><span id="l1.6930">         EntryInfo1.dword = EntryInfo1.id;</span>
<a href="#l1.6931"></a><span id="l1.6931">       else</span>
<a href="#l1.6932"></a><span id="l1.6932">         GetLongField(msgHdr, sortType, &amp;EntryInfo1.dword, colHandler);</span>
<a href="#l1.6933"></a><span id="l1.6933" class="difflineplus">+</span>
<a href="#l1.6934"></a><span id="l1.6934">       comparisonFun = FnSortIdUint32;</span>
<a href="#l1.6935"></a><span id="l1.6935">       break;</span>
<a href="#l1.6936"></a><span id="l1.6936">     default:</span>
<a href="#l1.6937"></a><span id="l1.6937">       return highIndex;</span>
<a href="#l1.6938"></a><span id="l1.6938">   }</span>
<a href="#l1.6939"></a><span id="l1.6939" class="difflineplus">+</span>
<a href="#l1.6940"></a><span id="l1.6940">   while (highIndex &gt; lowIndex)</span>
<a href="#l1.6941"></a><span id="l1.6941">   {</span>
<a href="#l1.6942"></a><span id="l1.6942">     nsMsgViewIndex tryIndex = (lowIndex + highIndex - 1) / 2;</span>
<a href="#l1.6943"></a><span id="l1.6943">     EntryInfo2.id = keys[tryIndex];</span>
<a href="#l1.6944"></a><span id="l1.6944">     EntryInfo2.folder = folders ? folders-&gt;ObjectAt(tryIndex) : m_folder.get();</span>
<a href="#l1.6945"></a><span id="l1.6945"> </span>
<a href="#l1.6946"></a><span id="l1.6946">     nsCOMPtr &lt;nsIMsgDBHdr&gt; tryHdr;</span>
<a href="#l1.6947"></a><span id="l1.6947">     EntryInfo2.folder-&gt;GetMessageHeader(EntryInfo2.id, getter_AddRefs(tryHdr));</span>
<a href="#l1.6948"></a><span id="l1.6948">     if (!tryHdr)</span>
<a href="#l1.6949"></a><span id="l1.6949">       break;</span>
<a href="#l1.6950"></a><span id="l1.6950" class="difflineplus">+</span>
<a href="#l1.6951"></a><span id="l1.6951">     if (fieldType == kCollationKey)</span>
<a href="#l1.6952"></a><span id="l1.6952">     {</span>
<a href="#l1.6953"></a><span id="l1.6953">       PR_FREEIF(EntryInfo2.key);</span>
<a href="#l1.6954"></a><span id="l1.6954">       rv = GetCollationKey(tryHdr, sortType, &amp;EntryInfo2.key, &amp;EntryInfo2.dword, colHandler);</span>
<a href="#l1.6955"></a><span id="l1.6955">       NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.6956"></a><span id="l1.6956">     }</span>
<a href="#l1.6957"></a><span id="l1.6957">     else if (fieldType == kU32)</span>
<a href="#l1.6958"></a><span id="l1.6958">     {</span>
<a href="#l1.6959"></a><span id="l1.6959">       if (sortType == nsMsgViewSortType::byId) {</span>
<a href="#l1.6960"></a><span id="l1.6960">         EntryInfo2.dword = EntryInfo2.id;</span>
<a href="#l1.6961"></a><span id="l1.6961">       }</span>
<a href="#l1.6962"></a><span id="l1.6962">       else {</span>
<a href="#l1.6963"></a><span id="l1.6963">         GetLongField(tryHdr, sortType, &amp;EntryInfo2.dword, colHandler);</span>
<a href="#l1.6964"></a><span id="l1.6964">       }</span>
<a href="#l1.6965"></a><span id="l1.6965">     }</span>
<a href="#l1.6966"></a><span id="l1.6966" class="difflineplus">+</span>
<a href="#l1.6967"></a><span id="l1.6967">     retStatus = (*comparisonFun)(&amp;pValue1, &amp;pValue2, &amp;comparisonContext);</span>
<a href="#l1.6968"></a><span id="l1.6968">     if (retStatus == 0)</span>
<a href="#l1.6969"></a><span id="l1.6969">     {</span>
<a href="#l1.6970"></a><span id="l1.6970">       highIndex = tryIndex;</span>
<a href="#l1.6971"></a><span id="l1.6971">       break;</span>
<a href="#l1.6972"></a><span id="l1.6972">     }</span>
<a href="#l1.6973"></a><span id="l1.6973"> </span>
<a href="#l1.6974"></a><span id="l1.6974">     if (retStatus &lt; 0)</span>
<a href="#l1.6975"></a><span id="l1.6975" class="difflineat">@@ -5526,30 +6125,35 @@ nsMsgViewIndex nsMsgDBView::GetInsertInd</span>
<a href="#l1.6976"></a><span id="l1.6976">     }</span>
<a href="#l1.6977"></a><span id="l1.6977">   }</span>
<a href="#l1.6978"></a><span id="l1.6978"> </span>
<a href="#l1.6979"></a><span id="l1.6979">   PR_Free(EntryInfo1.key);</span>
<a href="#l1.6980"></a><span id="l1.6980">   PR_Free(EntryInfo2.key);</span>
<a href="#l1.6981"></a><span id="l1.6981">   return highIndex;</span>
<a href="#l1.6982"></a><span id="l1.6982"> }</span>
<a href="#l1.6983"></a><span id="l1.6983"> </span>
<a href="#l1.6984"></a><span id="l1.6984" class="difflineminus">-nsMsgViewIndex nsMsgDBView::GetInsertIndex(nsIMsgDBHdr *msgHdr)</span>
<a href="#l1.6985"></a><span id="l1.6985" class="difflineplus">+nsMsgViewIndex</span>
<a href="#l1.6986"></a><span id="l1.6986" class="difflineplus">+nsMsgDBView::GetInsertIndex(nsIMsgDBHdr *msgHdr)</span>
<a href="#l1.6987"></a><span id="l1.6987"> {</span>
<a href="#l1.6988"></a><span id="l1.6988">   if (!GetSize())</span>
<a href="#l1.6989"></a><span id="l1.6989">     return 0;</span>
<a href="#l1.6990"></a><span id="l1.6990"> </span>
<a href="#l1.6991"></a><span id="l1.6991" class="difflineminus">-  if ((m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) != 0</span>
<a href="#l1.6992"></a><span id="l1.6992" class="difflineminus">-        &amp;&amp; !(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort)</span>
<a href="#l1.6993"></a><span id="l1.6993" class="difflineminus">-        &amp;&amp; m_sortOrder != nsMsgViewSortType::byId)</span>
<a href="#l1.6994"></a><span id="l1.6994" class="difflineplus">+  if ((m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) != 0 &amp;&amp;</span>
<a href="#l1.6995"></a><span id="l1.6995" class="difflineplus">+      !(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort) &amp;&amp;</span>
<a href="#l1.6996"></a><span id="l1.6996" class="difflineplus">+      m_sortOrder != nsMsgViewSortType::byId)</span>
<a href="#l1.6997"></a><span id="l1.6997" class="difflineplus">+  {</span>
<a href="#l1.6998"></a><span id="l1.6998">     return GetIndexForThread(msgHdr);</span>
<a href="#l1.6999"></a><span id="l1.6999" class="difflineplus">+  }</span>
<a href="#l1.7000"></a><span id="l1.7000"> </span>
<a href="#l1.7001"></a><span id="l1.7001">   return GetInsertIndexHelper(msgHdr, m_keys, GetFolders(), m_sortOrder, m_sortType);</span>
<a href="#l1.7002"></a><span id="l1.7002"> }</span>
<a href="#l1.7003"></a><span id="l1.7003"> </span>
<a href="#l1.7004"></a><span id="l1.7004" class="difflineminus">-nsresult  nsMsgDBView::AddHdr(nsIMsgDBHdr *msgHdr, nsMsgViewIndex *resultIndex)</span>
<a href="#l1.7005"></a><span id="l1.7005" class="difflineplus">+nsresult</span>
<a href="#l1.7006"></a><span id="l1.7006" class="difflineplus">+nsMsgDBView::AddHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.7007"></a><span id="l1.7007" class="difflineplus">+                    nsMsgViewIndex *resultIndex)</span>
<a href="#l1.7008"></a><span id="l1.7008"> {</span>
<a href="#l1.7009"></a><span id="l1.7009">   uint32_t  flags = 0;</span>
<a href="#l1.7010"></a><span id="l1.7010"> #ifdef DEBUG_bienvenu</span>
<a href="#l1.7011"></a><span id="l1.7011">   NS_ASSERTION(m_keys.Length() == m_flags.Length() &amp;&amp; (int) m_keys.Length() == m_levels.Length(), &quot;view arrays out of sync!&quot;);</span>
<a href="#l1.7012"></a><span id="l1.7012"> #endif</span>
<a href="#l1.7013"></a><span id="l1.7013"> </span>
<a href="#l1.7014"></a><span id="l1.7014">   if (resultIndex)</span>
<a href="#l1.7015"></a><span id="l1.7015">     *resultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.7016"></a><span id="l1.7016" class="difflineat">@@ -5573,66 +6177,78 @@ nsresult  nsMsgDBView::AddHdr(nsIMsgDBHd</span>
<a href="#l1.7017"></a><span id="l1.7017"> </span>
<a href="#l1.7018"></a><span id="l1.7018">   nsMsgKey msgKey, threadId;</span>
<a href="#l1.7019"></a><span id="l1.7019">   nsMsgKey threadParent;</span>
<a href="#l1.7020"></a><span id="l1.7020">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.7021"></a><span id="l1.7021">   msgHdr-&gt;GetThreadId(&amp;threadId);</span>
<a href="#l1.7022"></a><span id="l1.7022">   msgHdr-&gt;GetThreadParent(&amp;threadParent);</span>
<a href="#l1.7023"></a><span id="l1.7023"> </span>
<a href="#l1.7024"></a><span id="l1.7024">   msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.7025"></a><span id="l1.7025" class="difflineminus">-  // ### this isn't quite right, is it? Should be checking that our thread parent key is none?</span>
<a href="#l1.7026"></a><span id="l1.7026" class="difflineplus">+  // XXX this isn't quite right, is it?</span>
<a href="#l1.7027"></a><span id="l1.7027" class="difflineplus">+  // Should be checking that our thread parent key is none?</span>
<a href="#l1.7028"></a><span id="l1.7028">   if (threadParent == nsMsgKey_None)</span>
<a href="#l1.7029"></a><span id="l1.7029">     flags |= MSG_VIEW_FLAG_ISTHREAD;</span>
<a href="#l1.7030"></a><span id="l1.7030" class="difflineplus">+</span>
<a href="#l1.7031"></a><span id="l1.7031">   nsMsgViewIndex insertIndex = GetInsertIndex(msgHdr);</span>
<a href="#l1.7032"></a><span id="l1.7032">   if (insertIndex == nsMsgViewIndex_None)</span>
<a href="#l1.7033"></a><span id="l1.7033">   {</span>
<a href="#l1.7034"></a><span id="l1.7034" class="difflineminus">-    // if unreadonly, level is 0 because we must be the only msg in the thread.</span>
<a href="#l1.7035"></a><span id="l1.7035" class="difflineplus">+    // If unreadonly, level is 0 because we must be the only msg in the thread.</span>
<a href="#l1.7036"></a><span id="l1.7036">     int32_t levelToAdd = 0;</span>
<a href="#l1.7037"></a><span id="l1.7037"> </span>
<a href="#l1.7038"></a><span id="l1.7038">     if (m_sortOrder == nsMsgViewSortOrder::ascending)</span>
<a href="#l1.7039"></a><span id="l1.7039">     {</span>
<a href="#l1.7040"></a><span id="l1.7040">       InsertMsgHdrAt(GetSize(), msgHdr, msgKey, flags, levelToAdd);</span>
<a href="#l1.7041"></a><span id="l1.7041">       if (resultIndex)</span>
<a href="#l1.7042"></a><span id="l1.7042">         *resultIndex = GetSize() - 1;</span>
<a href="#l1.7043"></a><span id="l1.7043"> </span>
<a href="#l1.7044"></a><span id="l1.7044" class="difflineminus">-      // the call to NoteChange() has to happen after we add the key</span>
<a href="#l1.7045"></a><span id="l1.7045" class="difflineminus">-      // as NoteChange() will call RowCountChanged() which will call our GetRowCount()</span>
<a href="#l1.7046"></a><span id="l1.7046" class="difflineplus">+      // The call to NoteChange() has to happen after we add the key as</span>
<a href="#l1.7047"></a><span id="l1.7047" class="difflineplus">+      // NoteChange() will call RowCountChanged() which will call our</span>
<a href="#l1.7048"></a><span id="l1.7048" class="difflineplus">+      // GetRowCount().</span>
<a href="#l1.7049"></a><span id="l1.7049">       NoteChange(GetSize() - 1, 1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.7050"></a><span id="l1.7050">     }</span>
<a href="#l1.7051"></a><span id="l1.7051">     else</span>
<a href="#l1.7052"></a><span id="l1.7052">     {</span>
<a href="#l1.7053"></a><span id="l1.7053">       InsertMsgHdrAt(0, msgHdr, msgKey, flags, levelToAdd);</span>
<a href="#l1.7054"></a><span id="l1.7054">       if (resultIndex)</span>
<a href="#l1.7055"></a><span id="l1.7055">         *resultIndex = 0;</span>
<a href="#l1.7056"></a><span id="l1.7056"> </span>
<a href="#l1.7057"></a><span id="l1.7057" class="difflineminus">-      // the call to NoteChange() has to happen after we insert the key</span>
<a href="#l1.7058"></a><span id="l1.7058" class="difflineminus">-      // as NoteChange() will call RowCountChanged() which will call our GetRowCount()</span>
<a href="#l1.7059"></a><span id="l1.7059" class="difflineplus">+      // The call to NoteChange() has to happen after we insert the key as</span>
<a href="#l1.7060"></a><span id="l1.7060" class="difflineplus">+      // NoteChange() will call RowCountChanged() which will call our</span>
<a href="#l1.7061"></a><span id="l1.7061" class="difflineplus">+      // GetRowCount().</span>
<a href="#l1.7062"></a><span id="l1.7062">       NoteChange(0, 1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.7063"></a><span id="l1.7063">     }</span>
<a href="#l1.7064"></a><span id="l1.7064" class="difflineplus">+</span>
<a href="#l1.7065"></a><span id="l1.7065">     m_sortValid = false;</span>
<a href="#l1.7066"></a><span id="l1.7066">   }</span>
<a href="#l1.7067"></a><span id="l1.7067">   else</span>
<a href="#l1.7068"></a><span id="l1.7068">   {</span>
<a href="#l1.7069"></a><span id="l1.7069">     InsertMsgHdrAt(insertIndex, msgHdr, msgKey, flags, 0);</span>
<a href="#l1.7070"></a><span id="l1.7070">     if (resultIndex)</span>
<a href="#l1.7071"></a><span id="l1.7071">       *resultIndex = insertIndex;</span>
<a href="#l1.7072"></a><span id="l1.7072" class="difflineminus">-    // the call to NoteChange() has to happen after we add the key</span>
<a href="#l1.7073"></a><span id="l1.7073" class="difflineminus">-    // as NoteChange() will call RowCountChanged() which will call our GetRowCount()</span>
<a href="#l1.7074"></a><span id="l1.7074" class="difflineplus">+</span>
<a href="#l1.7075"></a><span id="l1.7075" class="difflineplus">+    // The call to NoteChange() has to happen after we add the key as</span>
<a href="#l1.7076"></a><span id="l1.7076" class="difflineplus">+    // NoteChange() will call RowCountChanged() which will call our</span>
<a href="#l1.7077"></a><span id="l1.7077" class="difflineplus">+    // GetRowCount().</span>
<a href="#l1.7078"></a><span id="l1.7078">     NoteChange(insertIndex, 1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.7079"></a><span id="l1.7079">   }</span>
<a href="#l1.7080"></a><span id="l1.7080" class="difflineplus">+</span>
<a href="#l1.7081"></a><span id="l1.7081">   OnHeaderAddedOrDeleted();</span>
<a href="#l1.7082"></a><span id="l1.7082">   return NS_OK;</span>
<a href="#l1.7083"></a><span id="l1.7083"> }</span>
<a href="#l1.7084"></a><span id="l1.7084"> </span>
<a href="#l1.7085"></a><span id="l1.7085" class="difflineminus">-bool nsMsgDBView::WantsThisThread(nsIMsgThread * /*threadHdr*/)</span>
<a href="#l1.7086"></a><span id="l1.7086" class="difflineminus">-{</span>
<a href="#l1.7087"></a><span id="l1.7087" class="difflineminus">-  return true; // default is to want all threads.</span>
<a href="#l1.7088"></a><span id="l1.7088" class="difflineminus">-}</span>
<a href="#l1.7089"></a><span id="l1.7089" class="difflineminus">-</span>
<a href="#l1.7090"></a><span id="l1.7090" class="difflineminus">-nsMsgViewIndex nsMsgDBView::FindParentInThread(nsMsgKey parentKey, nsMsgViewIndex startOfThreadViewIndex)</span>
<a href="#l1.7091"></a><span id="l1.7091" class="difflineplus">+bool</span>
<a href="#l1.7092"></a><span id="l1.7092" class="difflineplus">+nsMsgDBView::WantsThisThread(nsIMsgThread * /*threadHdr*/)</span>
<a href="#l1.7093"></a><span id="l1.7093" class="difflineplus">+{</span>
<a href="#l1.7094"></a><span id="l1.7094" class="difflineplus">+  // Default is to want all threads.</span>
<a href="#l1.7095"></a><span id="l1.7095" class="difflineplus">+  return true;</span>
<a href="#l1.7096"></a><span id="l1.7096" class="difflineplus">+}</span>
<a href="#l1.7097"></a><span id="l1.7097" class="difflineplus">+</span>
<a href="#l1.7098"></a><span id="l1.7098" class="difflineplus">+nsMsgViewIndex</span>
<a href="#l1.7099"></a><span id="l1.7099" class="difflineplus">+nsMsgDBView::FindParentInThread(nsMsgKey parentKey,</span>
<a href="#l1.7100"></a><span id="l1.7100" class="difflineplus">+                                nsMsgViewIndex startOfThreadViewIndex)</span>
<a href="#l1.7101"></a><span id="l1.7101"> {</span>
<a href="#l1.7102"></a><span id="l1.7102">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.7103"></a><span id="l1.7103">   while (parentKey != nsMsgKey_None)</span>
<a href="#l1.7104"></a><span id="l1.7104">   {</span>
<a href="#l1.7105"></a><span id="l1.7105">     nsMsgViewIndex parentIndex = m_keys.IndexOf(parentKey, startOfThreadViewIndex);</span>
<a href="#l1.7106"></a><span id="l1.7106">     if (parentIndex != nsMsgViewIndex_None)</span>
<a href="#l1.7107"></a><span id="l1.7107">       return parentIndex;</span>
<a href="#l1.7108"></a><span id="l1.7108"> </span>
<a href="#l1.7109"></a><span id="l1.7109" class="difflineat">@@ -5640,99 +6256,116 @@ nsMsgViewIndex nsMsgDBView::FindParentIn</span>
<a href="#l1.7110"></a><span id="l1.7110">       break;</span>
<a href="#l1.7111"></a><span id="l1.7111"> </span>
<a href="#l1.7112"></a><span id="l1.7112">     msgHdr-&gt;GetThreadParent(&amp;parentKey);</span>
<a href="#l1.7113"></a><span id="l1.7113">   }</span>
<a href="#l1.7114"></a><span id="l1.7114"> </span>
<a href="#l1.7115"></a><span id="l1.7115">   return startOfThreadViewIndex;</span>
<a href="#l1.7116"></a><span id="l1.7116"> }</span>
<a href="#l1.7117"></a><span id="l1.7117"> </span>
<a href="#l1.7118"></a><span id="l1.7118" class="difflineminus">-nsresult nsMsgDBView::ListIdsInThreadOrder(nsIMsgThread *threadHdr, nsMsgKey parentKey,</span>
<a href="#l1.7119"></a><span id="l1.7119" class="difflineminus">-                                           uint32_t level, nsMsgViewIndex *viewIndex,</span>
<a href="#l1.7120"></a><span id="l1.7120" class="difflineminus">-                                           uint32_t *pNumListed)</span>
<a href="#l1.7121"></a><span id="l1.7121" class="difflineplus">+nsresult</span>
<a href="#l1.7122"></a><span id="l1.7122" class="difflineplus">+nsMsgDBView::ListIdsInThreadOrder(nsIMsgThread *threadHdr,</span>
<a href="#l1.7123"></a><span id="l1.7123" class="difflineplus">+                                  nsMsgKey parentKey,</span>
<a href="#l1.7124"></a><span id="l1.7124" class="difflineplus">+                                  uint32_t level,</span>
<a href="#l1.7125"></a><span id="l1.7125" class="difflineplus">+                                  nsMsgViewIndex *viewIndex,</span>
<a href="#l1.7126"></a><span id="l1.7126" class="difflineplus">+                                  uint32_t *pNumListed)</span>
<a href="#l1.7127"></a><span id="l1.7127"> {</span>
<a href="#l1.7128"></a><span id="l1.7128">   nsresult rv = NS_OK;</span>
<a href="#l1.7129"></a><span id="l1.7129">   nsCOMPtr &lt;nsISimpleEnumerator&gt; msgEnumerator;</span>
<a href="#l1.7130"></a><span id="l1.7130">   threadHdr-&gt;EnumerateMessages(parentKey, getter_AddRefs(msgEnumerator));</span>
<a href="#l1.7131"></a><span id="l1.7131">   uint32_t numChildren;</span>
<a href="#l1.7132"></a><span id="l1.7132">   (void) threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l1.7133"></a><span id="l1.7133">   NS_ASSERTION(numChildren, &quot;Empty thread in view/db&quot;);</span>
<a href="#l1.7134"></a><span id="l1.7134" class="difflineplus">+  // Bogus, but harmless.</span>
<a href="#l1.7135"></a><span id="l1.7135">   if (!numChildren)</span>
<a href="#l1.7136"></a><span id="l1.7136" class="difflineminus">-    return NS_OK;  // bogus, but harmless.</span>
<a href="#l1.7137"></a><span id="l1.7137" class="difflineminus">-</span>
<a href="#l1.7138"></a><span id="l1.7138" class="difflineminus">-  numChildren--; // account for the existing thread root</span>
<a href="#l1.7139"></a><span id="l1.7139" class="difflineminus">-</span>
<a href="#l1.7140"></a><span id="l1.7140" class="difflineminus">-  // skip the first one.</span>
<a href="#l1.7141"></a><span id="l1.7141" class="difflineplus">+    return NS_OK;</span>
<a href="#l1.7142"></a><span id="l1.7142" class="difflineplus">+</span>
<a href="#l1.7143"></a><span id="l1.7143" class="difflineplus">+  // Account for the existing thread root.</span>
<a href="#l1.7144"></a><span id="l1.7144" class="difflineplus">+  numChildren--;</span>
<a href="#l1.7145"></a><span id="l1.7145" class="difflineplus">+</span>
<a href="#l1.7146"></a><span id="l1.7146" class="difflineplus">+  // Skip the first one.</span>
<a href="#l1.7147"></a><span id="l1.7147">   bool hasMore;</span>
<a href="#l1.7148"></a><span id="l1.7148">   nsCOMPtr &lt;nsISupports&gt; supports;</span>
<a href="#l1.7149"></a><span id="l1.7149">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.7150"></a><span id="l1.7150" class="difflineminus">-  while (NS_SUCCEEDED(rv) &amp;&amp; NS_SUCCEEDED(rv = msgEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l1.7151"></a><span id="l1.7151" class="difflineplus">+  while (NS_SUCCEEDED(rv) &amp;&amp;</span>
<a href="#l1.7152"></a><span id="l1.7152" class="difflineplus">+         NS_SUCCEEDED(rv = msgEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l1.7153"></a><span id="l1.7153" class="difflineplus">+         hasMore)</span>
<a href="#l1.7154"></a><span id="l1.7154">   {</span>
<a href="#l1.7155"></a><span id="l1.7155">     rv = msgEnumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l1.7156"></a><span id="l1.7156">     if (NS_SUCCEEDED(rv) &amp;&amp; supports)</span>
<a href="#l1.7157"></a><span id="l1.7157">     {</span>
<a href="#l1.7158"></a><span id="l1.7158">       if (*pNumListed == numChildren)</span>
<a href="#l1.7159"></a><span id="l1.7159">       {</span>
<a href="#l1.7160"></a><span id="l1.7160">         NS_NOTREACHED(&quot;thread corrupt in db&quot;);</span>
<a href="#l1.7161"></a><span id="l1.7161" class="difflineminus">-        // if we've listed more messages than are in the thread, then the db</span>
<a href="#l1.7162"></a><span id="l1.7162" class="difflineplus">+        // If we've listed more messages than are in the thread, then the db</span>
<a href="#l1.7163"></a><span id="l1.7163">         // is corrupt, and we should invalidate it.</span>
<a href="#l1.7164"></a><span id="l1.7164" class="difflineminus">-        // we'll use this rv to indicate there's something wrong with the db</span>
<a href="#l1.7165"></a><span id="l1.7165" class="difflineplus">+        // We'll use this rv to indicate there's something wrong with the db</span>
<a href="#l1.7166"></a><span id="l1.7166">         // though for now it probably won't get paid attention to.</span>
<a href="#l1.7167"></a><span id="l1.7167">         m_db-&gt;SetSummaryValid(false);</span>
<a href="#l1.7168"></a><span id="l1.7168">         rv = NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE;</span>
<a href="#l1.7169"></a><span id="l1.7169">         break;</span>
<a href="#l1.7170"></a><span id="l1.7170">       }</span>
<a href="#l1.7171"></a><span id="l1.7171"> </span>
<a href="#l1.7172"></a><span id="l1.7172">       msgHdr = do_QueryInterface(supports);</span>
<a href="#l1.7173"></a><span id="l1.7173">       if (!(m_viewFlags &amp; nsMsgViewFlagsType::kShowIgnored))</span>
<a href="#l1.7174"></a><span id="l1.7174">       {</span>
<a href="#l1.7175"></a><span id="l1.7175">         bool ignored;</span>
<a href="#l1.7176"></a><span id="l1.7176">         msgHdr-&gt;GetIsKilled(&amp;ignored);</span>
<a href="#l1.7177"></a><span id="l1.7177">         // We are not going to process subthreads, horribly invalidating the</span>
<a href="#l1.7178"></a><span id="l1.7178" class="difflineminus">-        // numChildren characteristic</span>
<a href="#l1.7179"></a><span id="l1.7179" class="difflineplus">+        // numChildren characteristic.</span>
<a href="#l1.7180"></a><span id="l1.7180">         if (ignored)</span>
<a href="#l1.7181"></a><span id="l1.7181">           continue;</span>
<a href="#l1.7182"></a><span id="l1.7182">       }</span>
<a href="#l1.7183"></a><span id="l1.7183"> </span>
<a href="#l1.7184"></a><span id="l1.7184">       nsMsgKey msgKey;</span>
<a href="#l1.7185"></a><span id="l1.7185">       uint32_t msgFlags, newFlags;</span>
<a href="#l1.7186"></a><span id="l1.7186">       msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.7187"></a><span id="l1.7187">       msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.7188"></a><span id="l1.7188">       AdjustReadFlag(msgHdr, &amp;msgFlags);</span>
<a href="#l1.7189"></a><span id="l1.7189">       SetMsgHdrAt(msgHdr, *viewIndex, msgKey, msgFlags &amp; ~MSG_VIEW_FLAGS, level);</span>
<a href="#l1.7190"></a><span id="l1.7190" class="difflineminus">-      // turn off thread or elided bit if they got turned on (maybe from new only view?)</span>
<a href="#l1.7191"></a><span id="l1.7191" class="difflineminus">-      msgHdr-&gt;AndFlags(~(MSG_VIEW_FLAG_ISTHREAD | nsMsgMessageFlags::Elided), &amp;newFlags);</span>
<a href="#l1.7192"></a><span id="l1.7192" class="difflineplus">+      // Turn off thread or elided bit if they got turned on (maybe from new</span>
<a href="#l1.7193"></a><span id="l1.7193" class="difflineplus">+      // only view?)</span>
<a href="#l1.7194"></a><span id="l1.7194" class="difflineplus">+      msgHdr-&gt;AndFlags(~(MSG_VIEW_FLAG_ISTHREAD | nsMsgMessageFlags::Elided),</span>
<a href="#l1.7195"></a><span id="l1.7195" class="difflineplus">+                       &amp;newFlags);</span>
<a href="#l1.7196"></a><span id="l1.7196">       (*pNumListed)++;</span>
<a href="#l1.7197"></a><span id="l1.7197">       (*viewIndex)++;</span>
<a href="#l1.7198"></a><span id="l1.7198">       rv = ListIdsInThreadOrder(threadHdr, msgKey, level + 1, viewIndex, pNumListed);</span>
<a href="#l1.7199"></a><span id="l1.7199">     }</span>
<a href="#l1.7200"></a><span id="l1.7200">   }</span>
<a href="#l1.7201"></a><span id="l1.7201" class="difflineminus">-  return rv; // we don't want to return the rv from the enumerator when it reaches the end, do we?</span>
<a href="#l1.7202"></a><span id="l1.7202" class="difflineminus">-}</span>
<a href="#l1.7203"></a><span id="l1.7203" class="difflineminus">-</span>
<a href="#l1.7204"></a><span id="l1.7204" class="difflineminus">-bool nsMsgDBView::InsertEmptyRows(nsMsgViewIndex viewIndex, int32_t numRows)</span>
<a href="#l1.7205"></a><span id="l1.7205" class="difflineplus">+</span>
<a href="#l1.7206"></a><span id="l1.7206" class="difflineplus">+  // We don't want to return the rv from the enumerator when it reaches the</span>
<a href="#l1.7207"></a><span id="l1.7207" class="difflineplus">+  // end, do we?</span>
<a href="#l1.7208"></a><span id="l1.7208" class="difflineplus">+  return rv;</span>
<a href="#l1.7209"></a><span id="l1.7209" class="difflineplus">+}</span>
<a href="#l1.7210"></a><span id="l1.7210" class="difflineplus">+</span>
<a href="#l1.7211"></a><span id="l1.7211" class="difflineplus">+bool</span>
<a href="#l1.7212"></a><span id="l1.7212" class="difflineplus">+nsMsgDBView::InsertEmptyRows(nsMsgViewIndex viewIndex,</span>
<a href="#l1.7213"></a><span id="l1.7213" class="difflineplus">+                             int32_t numRows)</span>
<a href="#l1.7214"></a><span id="l1.7214"> {</span>
<a href="#l1.7215"></a><span id="l1.7215">   return m_keys.InsertElementsAt(viewIndex, numRows, 0) &amp;&amp;</span>
<a href="#l1.7216"></a><span id="l1.7216">          m_flags.InsertElementsAt(viewIndex, numRows, 0) &amp;&amp;</span>
<a href="#l1.7217"></a><span id="l1.7217">          m_levels.InsertElementsAt(viewIndex, numRows, 1);</span>
<a href="#l1.7218"></a><span id="l1.7218"> }</span>
<a href="#l1.7219"></a><span id="l1.7219"> </span>
<a href="#l1.7220"></a><span id="l1.7220" class="difflineminus">-void nsMsgDBView::RemoveRows(nsMsgViewIndex viewIndex, int32_t numRows)</span>
<a href="#l1.7221"></a><span id="l1.7221" class="difflineplus">+void</span>
<a href="#l1.7222"></a><span id="l1.7222" class="difflineplus">+nsMsgDBView::RemoveRows(nsMsgViewIndex viewIndex,</span>
<a href="#l1.7223"></a><span id="l1.7223" class="difflineplus">+                        int32_t numRows)</span>
<a href="#l1.7224"></a><span id="l1.7224"> {</span>
<a href="#l1.7225"></a><span id="l1.7225">   m_keys.RemoveElementsAt(viewIndex, numRows);</span>
<a href="#l1.7226"></a><span id="l1.7226">   m_flags.RemoveElementsAt(viewIndex, numRows);</span>
<a href="#l1.7227"></a><span id="l1.7227">   m_levels.RemoveElementsAt(viewIndex, numRows);</span>
<a href="#l1.7228"></a><span id="l1.7228"> }</span>
<a href="#l1.7229"></a><span id="l1.7229"> </span>
<a href="#l1.7230"></a><span id="l1.7230" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::InsertTreeRows(nsMsgViewIndex aIndex,</span>
<a href="#l1.7231"></a><span id="l1.7231" class="difflineminus">-                                          uint32_t aNumRows,</span>
<a href="#l1.7232"></a><span id="l1.7232" class="difflineminus">-                                          nsMsgKey aKey,</span>
<a href="#l1.7233"></a><span id="l1.7233" class="difflineminus">-                                          nsMsgViewFlagsTypeValue aFlags,</span>
<a href="#l1.7234"></a><span id="l1.7234" class="difflineminus">-                                          uint32_t aLevel,</span>
<a href="#l1.7235"></a><span id="l1.7235" class="difflineminus">-                                          nsIMsgFolder *aFolder)</span>
<a href="#l1.7236"></a><span id="l1.7236" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.7237"></a><span id="l1.7237" class="difflineplus">+nsMsgDBView::InsertTreeRows(nsMsgViewIndex aIndex,</span>
<a href="#l1.7238"></a><span id="l1.7238" class="difflineplus">+                            uint32_t aNumRows,</span>
<a href="#l1.7239"></a><span id="l1.7239" class="difflineplus">+                            nsMsgKey aKey,</span>
<a href="#l1.7240"></a><span id="l1.7240" class="difflineplus">+                            nsMsgViewFlagsTypeValue aFlags,</span>
<a href="#l1.7241"></a><span id="l1.7241" class="difflineplus">+                            uint32_t aLevel,</span>
<a href="#l1.7242"></a><span id="l1.7242" class="difflineplus">+                            nsIMsgFolder *aFolder)</span>
<a href="#l1.7243"></a><span id="l1.7243"> {</span>
<a href="#l1.7244"></a><span id="l1.7244">   if (GetSize() &lt; aIndex)</span>
<a href="#l1.7245"></a><span id="l1.7245">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.7246"></a><span id="l1.7246"> </span>
<a href="#l1.7247"></a><span id="l1.7247">   nsCOMArray&lt;nsIMsgFolder&gt; *folders = GetFolders();</span>
<a href="#l1.7248"></a><span id="l1.7248">   if (folders)</span>
<a href="#l1.7249"></a><span id="l1.7249">   {</span>
<a href="#l1.7250"></a><span id="l1.7250">     // In a search/xfvf view only, a folder is required.</span>
<a href="#l1.7251"></a><span id="l1.7251" class="difflineat">@@ -5746,73 +6379,81 @@ NS_IMETHODIMP nsMsgDBView::InsertTreeRow</span>
<a href="#l1.7252"></a><span id="l1.7252">   if (m_keys.InsertElementsAt(aIndex, aNumRows, aKey) &amp;&amp;</span>
<a href="#l1.7253"></a><span id="l1.7253">       m_flags.InsertElementsAt(aIndex, aNumRows, aFlags) &amp;&amp;</span>
<a href="#l1.7254"></a><span id="l1.7254">       m_levels.InsertElementsAt(aIndex, aNumRows, aLevel))</span>
<a href="#l1.7255"></a><span id="l1.7255">     return NS_OK;</span>
<a href="#l1.7256"></a><span id="l1.7256"> </span>
<a href="#l1.7257"></a><span id="l1.7257">   return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.7258"></a><span id="l1.7258"> }</span>
<a href="#l1.7259"></a><span id="l1.7259"> </span>
<a href="#l1.7260"></a><span id="l1.7260" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::RemoveTreeRows(nsMsgViewIndex aIndex,</span>
<a href="#l1.7261"></a><span id="l1.7261" class="difflineminus">-                                          uint32_t aNumRows)</span>
<a href="#l1.7262"></a><span id="l1.7262" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.7263"></a><span id="l1.7263" class="difflineplus">+nsMsgDBView::RemoveTreeRows(nsMsgViewIndex aIndex,</span>
<a href="#l1.7264"></a><span id="l1.7264" class="difflineplus">+                            uint32_t aNumRows)</span>
<a href="#l1.7265"></a><span id="l1.7265"> {</span>
<a href="#l1.7266"></a><span id="l1.7266">   // Prevent a crash if attempting to remove rows which don't exist.</span>
<a href="#l1.7267"></a><span id="l1.7267">   if (GetSize() &lt; aIndex + aNumRows)</span>
<a href="#l1.7268"></a><span id="l1.7268">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.7269"></a><span id="l1.7269"> </span>
<a href="#l1.7270"></a><span id="l1.7270">   nsMsgDBView::RemoveRows(aIndex, aNumRows);</span>
<a href="#l1.7271"></a><span id="l1.7271"> </span>
<a href="#l1.7272"></a><span id="l1.7272">   nsCOMArray&lt;nsIMsgFolder&gt; *folders = GetFolders();</span>
<a href="#l1.7273"></a><span id="l1.7273">   if (folders)</span>
<a href="#l1.7274"></a><span id="l1.7274">     // In a search/xfvf view only, remove from m_folders.</span>
<a href="#l1.7275"></a><span id="l1.7275">     if (!folders-&gt;RemoveObjectsAt(aIndex, aNumRows))</span>
<a href="#l1.7276"></a><span id="l1.7276">       return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.7277"></a><span id="l1.7277"> </span>
<a href="#l1.7278"></a><span id="l1.7278">   return NS_OK;</span>
<a href="#l1.7279"></a><span id="l1.7279"> }</span>
<a href="#l1.7280"></a><span id="l1.7280"> </span>
<a href="#l1.7281"></a><span id="l1.7281" class="difflineminus">-nsresult nsMsgDBView::ListIdsInThread(nsIMsgThread *threadHdr, nsMsgViewIndex startOfThreadViewIndex, uint32_t *pNumListed)</span>
<a href="#l1.7282"></a><span id="l1.7282" class="difflineplus">+nsresult</span>
<a href="#l1.7283"></a><span id="l1.7283" class="difflineplus">+nsMsgDBView::ListIdsInThread(nsIMsgThread *threadHdr,</span>
<a href="#l1.7284"></a><span id="l1.7284" class="difflineplus">+                             nsMsgViewIndex startOfThreadViewIndex,</span>
<a href="#l1.7285"></a><span id="l1.7285" class="difflineplus">+                             uint32_t *pNumListed)</span>
<a href="#l1.7286"></a><span id="l1.7286"> {</span>
<a href="#l1.7287"></a><span id="l1.7287">   NS_ENSURE_ARG(threadHdr);</span>
<a href="#l1.7288"></a><span id="l1.7288" class="difflineminus">-  // these children ids should be in thread order.</span>
<a href="#l1.7289"></a><span id="l1.7289" class="difflineplus">+  // These children ids should be in thread order.</span>
<a href="#l1.7290"></a><span id="l1.7290">   nsresult rv = NS_OK;</span>
<a href="#l1.7291"></a><span id="l1.7291">   uint32_t i;</span>
<a href="#l1.7292"></a><span id="l1.7292">   nsMsgViewIndex viewIndex = startOfThreadViewIndex + 1;</span>
<a href="#l1.7293"></a><span id="l1.7293">   *pNumListed = 0;</span>
<a href="#l1.7294"></a><span id="l1.7294"> </span>
<a href="#l1.7295"></a><span id="l1.7295">   uint32_t numChildren;</span>
<a href="#l1.7296"></a><span id="l1.7296">   threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l1.7297"></a><span id="l1.7297">   NS_ASSERTION(numChildren, &quot;Empty thread in view/db&quot;);</span>
<a href="#l1.7298"></a><span id="l1.7298">   if (!numChildren)</span>
<a href="#l1.7299"></a><span id="l1.7299">     return NS_OK;</span>
<a href="#l1.7300"></a><span id="l1.7300"> </span>
<a href="#l1.7301"></a><span id="l1.7301" class="difflineminus">-  numChildren--; // account for the existing thread root</span>
<a href="#l1.7302"></a><span id="l1.7302" class="difflineplus">+  // Account for the existing thread root.</span>
<a href="#l1.7303"></a><span id="l1.7303" class="difflineplus">+  numChildren--;</span>
<a href="#l1.7304"></a><span id="l1.7304">   if (!InsertEmptyRows(viewIndex, numChildren))</span>
<a href="#l1.7305"></a><span id="l1.7305">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.7306"></a><span id="l1.7306"> </span>
<a href="#l1.7307"></a><span id="l1.7307">   // ### need to rework this when we implemented threading in group views.</span>
<a href="#l1.7308"></a><span id="l1.7308" class="difflineminus">-  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay &amp;&amp; ! (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort))</span>
<a href="#l1.7309"></a><span id="l1.7309" class="difflineplus">+  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay &amp;&amp;</span>
<a href="#l1.7310"></a><span id="l1.7310" class="difflineplus">+      !(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort))</span>
<a href="#l1.7311"></a><span id="l1.7311">   {</span>
<a href="#l1.7312"></a><span id="l1.7312">     nsMsgKey parentKey = m_keys[startOfThreadViewIndex];</span>
<a href="#l1.7313"></a><span id="l1.7313">     // If the thread is bigger than the hdr cache, expanding the thread</span>
<a href="#l1.7314"></a><span id="l1.7314">     // can be slow. Increasing the hdr cache size will help a fair amount.</span>
<a href="#l1.7315"></a><span id="l1.7315">     uint32_t hdrCacheSize;</span>
<a href="#l1.7316"></a><span id="l1.7316">     m_db-&gt;GetMsgHdrCacheSize(&amp;hdrCacheSize);</span>
<a href="#l1.7317"></a><span id="l1.7317">     if (numChildren &gt; hdrCacheSize)</span>
<a href="#l1.7318"></a><span id="l1.7318">       m_db-&gt;SetMsgHdrCacheSize(numChildren);</span>
<a href="#l1.7319"></a><span id="l1.7319" class="difflineplus">+</span>
<a href="#l1.7320"></a><span id="l1.7320">     // If this fails, *pNumListed will be 0, and we'll fall back to just</span>
<a href="#l1.7321"></a><span id="l1.7321">     // enumerating the messages in the thread below.</span>
<a href="#l1.7322"></a><span id="l1.7322">     rv = ListIdsInThreadOrder(threadHdr, parentKey, 1, &amp;viewIndex, pNumListed);</span>
<a href="#l1.7323"></a><span id="l1.7323">     if (numChildren &gt; hdrCacheSize)</span>
<a href="#l1.7324"></a><span id="l1.7324">       m_db-&gt;SetMsgHdrCacheSize(hdrCacheSize);</span>
<a href="#l1.7325"></a><span id="l1.7325">   }</span>
<a href="#l1.7326"></a><span id="l1.7326" class="difflineplus">+</span>
<a href="#l1.7327"></a><span id="l1.7327">   if (! *pNumListed)</span>
<a href="#l1.7328"></a><span id="l1.7328">   {</span>
<a href="#l1.7329"></a><span id="l1.7329">     uint32_t ignoredHeaders = 0;</span>
<a href="#l1.7330"></a><span id="l1.7330" class="difflineminus">-    // if we're not threaded, just list em out in db order</span>
<a href="#l1.7331"></a><span id="l1.7331" class="difflineplus">+    // If we're not threaded, just list em out in db order.</span>
<a href="#l1.7332"></a><span id="l1.7332">     for (i = 1; i &lt;= numChildren; i++)</span>
<a href="#l1.7333"></a><span id="l1.7333">     {</span>
<a href="#l1.7334"></a><span id="l1.7334">       nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.7335"></a><span id="l1.7335">       threadHdr-&gt;GetChildHdrAt(i, getter_AddRefs(msgHdr));</span>
<a href="#l1.7336"></a><span id="l1.7336"> </span>
<a href="#l1.7337"></a><span id="l1.7337">       if (msgHdr != nullptr)</span>
<a href="#l1.7338"></a><span id="l1.7338">       {</span>
<a href="#l1.7339"></a><span id="l1.7339">         if (!(m_viewFlags &amp; nsMsgViewFlagsType::kShowIgnored))</span>
<a href="#l1.7340"></a><span id="l1.7340" class="difflineat">@@ -5827,83 +6468,95 @@ nsresult nsMsgDBView::ListIdsInThread(ns</span>
<a href="#l1.7341"></a><span id="l1.7341">         }</span>
<a href="#l1.7342"></a><span id="l1.7342"> </span>
<a href="#l1.7343"></a><span id="l1.7343">         nsMsgKey msgKey;</span>
<a href="#l1.7344"></a><span id="l1.7344">         uint32_t msgFlags, newFlags;</span>
<a href="#l1.7345"></a><span id="l1.7345">         msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.7346"></a><span id="l1.7346">         msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.7347"></a><span id="l1.7347">         AdjustReadFlag(msgHdr, &amp;msgFlags);</span>
<a href="#l1.7348"></a><span id="l1.7348">         SetMsgHdrAt(msgHdr, viewIndex, msgKey, msgFlags &amp; ~MSG_VIEW_FLAGS, 1);</span>
<a href="#l1.7349"></a><span id="l1.7349" class="difflineminus">-        // here, we're either flat, or we're grouped - in either case, level is 1</span>
<a href="#l1.7350"></a><span id="l1.7350" class="difflineminus">-        // turn off thread or elided bit if they got turned on (maybe from new only view?)</span>
<a href="#l1.7351"></a><span id="l1.7351" class="difflineplus">+        // Here, we're either flat, or we're grouped - in either case,</span>
<a href="#l1.7352"></a><span id="l1.7352" class="difflineplus">+        // level is 1. Turn off thread or elided bit if they got turned on</span>
<a href="#l1.7353"></a><span id="l1.7353" class="difflineplus">+        // (maybe from new only view?).</span>
<a href="#l1.7354"></a><span id="l1.7354">         if (i &gt; 0)</span>
<a href="#l1.7355"></a><span id="l1.7355" class="difflineminus">-          msgHdr-&gt;AndFlags(~(MSG_VIEW_FLAG_ISTHREAD | nsMsgMessageFlags::Elided), &amp;newFlags);</span>
<a href="#l1.7356"></a><span id="l1.7356" class="difflineplus">+          msgHdr-&gt;AndFlags(~(MSG_VIEW_FLAG_ISTHREAD | nsMsgMessageFlags::Elided),</span>
<a href="#l1.7357"></a><span id="l1.7357" class="difflineplus">+                           &amp;newFlags);</span>
<a href="#l1.7358"></a><span id="l1.7358" class="difflineplus">+</span>
<a href="#l1.7359"></a><span id="l1.7359">         (*pNumListed)++;</span>
<a href="#l1.7360"></a><span id="l1.7360">         viewIndex++;</span>
<a href="#l1.7361"></a><span id="l1.7361">       }</span>
<a href="#l1.7362"></a><span id="l1.7362">     }</span>
<a href="#l1.7363"></a><span id="l1.7363" class="difflineplus">+</span>
<a href="#l1.7364"></a><span id="l1.7364">     if (ignoredHeaders + *pNumListed &lt; numChildren)</span>
<a href="#l1.7365"></a><span id="l1.7365">     {</span>
<a href="#l1.7366"></a><span id="l1.7366">       NS_NOTREACHED(&quot;thread corrupt in db&quot;);</span>
<a href="#l1.7367"></a><span id="l1.7367" class="difflineminus">-      // if we've listed fewer messages than are in the thread, then the db</span>
<a href="#l1.7368"></a><span id="l1.7368" class="difflineplus">+      // If we've listed fewer messages than are in the thread, then the db</span>
<a href="#l1.7369"></a><span id="l1.7369">       // is corrupt, and we should invalidate it.</span>
<a href="#l1.7370"></a><span id="l1.7370" class="difflineminus">-      // we'll use this rv to indicate there's something wrong with the db</span>
<a href="#l1.7371"></a><span id="l1.7371" class="difflineplus">+      // We'll use this rv to indicate there's something wrong with the db</span>
<a href="#l1.7372"></a><span id="l1.7372">       // though for now it probably won't get paid attention to.</span>
<a href="#l1.7373"></a><span id="l1.7373">       m_db-&gt;SetSummaryValid(false);</span>
<a href="#l1.7374"></a><span id="l1.7374">       rv = NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE;</span>
<a href="#l1.7375"></a><span id="l1.7375">     }</span>
<a href="#l1.7376"></a><span id="l1.7376">   }</span>
<a href="#l1.7377"></a><span id="l1.7377"> </span>
<a href="#l1.7378"></a><span id="l1.7378" class="difflineminus">-  // We may have added too many elements (i.e., subthreads were cut)</span>
<a href="#l1.7379"></a><span id="l1.7379" class="difflineminus">-  // ### fix for cross folder view case.</span>
<a href="#l1.7380"></a><span id="l1.7380" class="difflineplus">+  // We may have added too many elements (i.e., subthreads were cut).</span>
<a href="#l1.7381"></a><span id="l1.7381" class="difflineplus">+  // XXX Fix for cross folder view case.</span>
<a href="#l1.7382"></a><span id="l1.7382">   if (*pNumListed &lt; numChildren)</span>
<a href="#l1.7383"></a><span id="l1.7383">     RemoveRows(viewIndex, numChildren - *pNumListed);</span>
<a href="#l1.7384"></a><span id="l1.7384" class="difflineplus">+</span>
<a href="#l1.7385"></a><span id="l1.7385">   return rv;</span>
<a href="#l1.7386"></a><span id="l1.7386"> }</span>
<a href="#l1.7387"></a><span id="l1.7387"> </span>
<a href="#l1.7388"></a><span id="l1.7388" class="difflineminus">-int32_t nsMsgDBView::FindLevelInThread(nsIMsgDBHdr *msgHdr, nsMsgViewIndex startOfThread, nsMsgViewIndex viewIndex)</span>
<a href="#l1.7389"></a><span id="l1.7389" class="difflineplus">+int32_t</span>
<a href="#l1.7390"></a><span id="l1.7390" class="difflineplus">+nsMsgDBView::FindLevelInThread(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.7391"></a><span id="l1.7391" class="difflineplus">+                               nsMsgViewIndex startOfThread,</span>
<a href="#l1.7392"></a><span id="l1.7392" class="difflineplus">+                               nsMsgViewIndex viewIndex)</span>
<a href="#l1.7393"></a><span id="l1.7393"> {</span>
<a href="#l1.7394"></a><span id="l1.7394">   nsCOMPtr &lt;nsIMsgDBHdr&gt; curMsgHdr = msgHdr;</span>
<a href="#l1.7395"></a><span id="l1.7395">   nsMsgKey msgKey;</span>
<a href="#l1.7396"></a><span id="l1.7396">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.7397"></a><span id="l1.7397"> </span>
<a href="#l1.7398"></a><span id="l1.7398" class="difflineminus">-  // look through the ancestors of the passed in msgHdr in turn, looking for them in the view, up to the start of</span>
<a href="#l1.7399"></a><span id="l1.7399" class="difflineminus">-  // the thread. If we find an ancestor, then our level is one greater than the level of the ancestor.</span>
<a href="#l1.7400"></a><span id="l1.7400" class="difflineplus">+  // Look through the ancestors of the passed in msgHdr in turn, looking for</span>
<a href="#l1.7401"></a><span id="l1.7401" class="difflineplus">+  // them in the view, up to the start of the thread. If we find an ancestor,</span>
<a href="#l1.7402"></a><span id="l1.7402" class="difflineplus">+  // then our level is one greater than the level of the ancestor.</span>
<a href="#l1.7403"></a><span id="l1.7403">   while (curMsgHdr)</span>
<a href="#l1.7404"></a><span id="l1.7404">   {</span>
<a href="#l1.7405"></a><span id="l1.7405">     nsMsgKey parentKey;</span>
<a href="#l1.7406"></a><span id="l1.7406">     curMsgHdr-&gt;GetThreadParent(&amp;parentKey);</span>
<a href="#l1.7407"></a><span id="l1.7407">     if (parentKey == nsMsgKey_None)</span>
<a href="#l1.7408"></a><span id="l1.7408">       break;</span>
<a href="#l1.7409"></a><span id="l1.7409"> </span>
<a href="#l1.7410"></a><span id="l1.7410" class="difflineminus">-    // scan up to find view index of ancestor, if any</span>
<a href="#l1.7411"></a><span id="l1.7411" class="difflineminus">-    for (nsMsgViewIndex indexToTry = viewIndex; indexToTry &amp;&amp; indexToTry-- &gt;= startOfThread;)</span>
<a href="#l1.7412"></a><span id="l1.7412" class="difflineplus">+    // Scan up to find view index of ancestor, if any.</span>
<a href="#l1.7413"></a><span id="l1.7413" class="difflineplus">+    for (nsMsgViewIndex indexToTry = viewIndex;</span>
<a href="#l1.7414"></a><span id="l1.7414" class="difflineplus">+         indexToTry &amp;&amp; indexToTry-- &gt;= startOfThread; )</span>
<a href="#l1.7415"></a><span id="l1.7415">     {</span>
<a href="#l1.7416"></a><span id="l1.7416">       if (m_keys[indexToTry] == parentKey)</span>
<a href="#l1.7417"></a><span id="l1.7417">         return m_levels[indexToTry] + 1;</span>
<a href="#l1.7418"></a><span id="l1.7418">     }</span>
<a href="#l1.7419"></a><span id="l1.7419"> </span>
<a href="#l1.7420"></a><span id="l1.7420" class="difflineminus">-    // if msgHdr's key is its parentKey, we'll loop forever, so protect</span>
<a href="#l1.7421"></a><span id="l1.7421" class="difflineplus">+    // If msgHdr's key is its parentKey, we'll loop forever, so protect</span>
<a href="#l1.7422"></a><span id="l1.7422">     // against that corruption.</span>
<a href="#l1.7423"></a><span id="l1.7423" class="difflineminus">-    if (msgKey == parentKey || NS_FAILED(m_db-&gt;GetMsgHdrForKey(parentKey, getter_AddRefs(curMsgHdr))))</span>
<a href="#l1.7424"></a><span id="l1.7424" class="difflineplus">+    if (msgKey == parentKey ||</span>
<a href="#l1.7425"></a><span id="l1.7425" class="difflineplus">+        NS_FAILED(m_db-&gt;GetMsgHdrForKey(parentKey, getter_AddRefs(curMsgHdr))))</span>
<a href="#l1.7426"></a><span id="l1.7426">     {</span>
<a href="#l1.7427"></a><span id="l1.7427">       NS_ERROR(&quot;msgKey == parentKey, or GetMsgHdrForKey failed, this used to be an infinte loop condition&quot;);</span>
<a href="#l1.7428"></a><span id="l1.7428">       curMsgHdr = nullptr;</span>
<a href="#l1.7429"></a><span id="l1.7429">     }</span>
<a href="#l1.7430"></a><span id="l1.7430">     else</span>
<a href="#l1.7431"></a><span id="l1.7431">     {</span>
<a href="#l1.7432"></a><span id="l1.7432" class="difflineminus">-      // need to update msgKey so the check for a msgHdr with matching</span>
<a href="#l1.7433"></a><span id="l1.7433" class="difflineminus">-      // key+parentKey will work after first time through loop</span>
<a href="#l1.7434"></a><span id="l1.7434" class="difflineplus">+      // Need to update msgKey so the check for a msgHdr with matching</span>
<a href="#l1.7435"></a><span id="l1.7435" class="difflineplus">+      // key+parentKey will work after first time through loop.</span>
<a href="#l1.7436"></a><span id="l1.7436">       curMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.7437"></a><span id="l1.7437">     }</span>
<a href="#l1.7438"></a><span id="l1.7438">   }</span>
<a href="#l1.7439"></a><span id="l1.7439" class="difflineplus">+</span>
<a href="#l1.7440"></a><span id="l1.7440">   return 1;</span>
<a href="#l1.7441"></a><span id="l1.7441"> }</span>
<a href="#l1.7442"></a><span id="l1.7442"> </span>
<a href="#l1.7443"></a><span id="l1.7443" class="difflineminus">-// ### Can this be combined with GetIndexForThread??</span>
<a href="#l1.7444"></a><span id="l1.7444" class="difflineplus">+// XXX Can this be combined with GetIndexForThread??</span>
<a href="#l1.7445"></a><span id="l1.7445"> nsMsgViewIndex</span>
<a href="#l1.7446"></a><span id="l1.7446"> nsMsgDBView::GetThreadRootIndex(nsIMsgDBHdr *msgHdr)</span>
<a href="#l1.7447"></a><span id="l1.7447"> {</span>
<a href="#l1.7448"></a><span id="l1.7448">   if (!msgHdr)</span>
<a href="#l1.7449"></a><span id="l1.7449">   {</span>
<a href="#l1.7450"></a><span id="l1.7450">     NS_WARNING(&quot;null msgHdr parameter&quot;);</span>
<a href="#l1.7451"></a><span id="l1.7451">     return nsMsgViewIndex_None;</span>
<a href="#l1.7452"></a><span id="l1.7452">   }</span>
<a href="#l1.7453"></a><span id="l1.7453" class="difflineat">@@ -5942,85 +6595,94 @@ nsMsgDBView::GetThreadRootIndex(nsIMsgDB</span>
<a href="#l1.7454"></a><span id="l1.7454"> </span>
<a href="#l1.7455"></a><span id="l1.7455">   viewSortInfo comparisonContext;</span>
<a href="#l1.7456"></a><span id="l1.7456">   comparisonContext.view = this;</span>
<a href="#l1.7457"></a><span id="l1.7457">   comparisonContext.isSecondarySort = false;</span>
<a href="#l1.7458"></a><span id="l1.7458">   comparisonContext.ascendingSort = (m_sortOrder == nsMsgViewSortOrder::ascending);</span>
<a href="#l1.7459"></a><span id="l1.7459">   nsCOMPtr&lt;nsIMsgDatabase&gt; hdrDB;</span>
<a href="#l1.7460"></a><span id="l1.7460">   EntryInfo1.folder-&gt;GetMsgDatabase(getter_AddRefs(hdrDB));</span>
<a href="#l1.7461"></a><span id="l1.7461">   comparisonContext.db = hdrDB.get();</span>
<a href="#l1.7462"></a><span id="l1.7462" class="difflineplus">+</span>
<a href="#l1.7463"></a><span id="l1.7463">   switch (fieldType)</span>
<a href="#l1.7464"></a><span id="l1.7464">   {</span>
<a href="#l1.7465"></a><span id="l1.7465">     case kCollationKey:</span>
<a href="#l1.7466"></a><span id="l1.7466">       rv = GetCollationKey(msgHdr, m_sortType, &amp;EntryInfo1.key, &amp;EntryInfo1.dword, colHandler);</span>
<a href="#l1.7467"></a><span id="l1.7467">       NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.7468"></a><span id="l1.7468">       break;</span>
<a href="#l1.7469"></a><span id="l1.7469">     case kU32:</span>
<a href="#l1.7470"></a><span id="l1.7470">       if (m_sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.7471"></a><span id="l1.7471">         EntryInfo1.dword = EntryInfo1.id;</span>
<a href="#l1.7472"></a><span id="l1.7472">       else</span>
<a href="#l1.7473"></a><span id="l1.7473">         GetLongField(msgHdr, m_sortType, &amp;EntryInfo1.dword, colHandler);</span>
<a href="#l1.7474"></a><span id="l1.7474" class="difflineplus">+</span>
<a href="#l1.7475"></a><span id="l1.7475">       break;</span>
<a href="#l1.7476"></a><span id="l1.7476">     default:</span>
<a href="#l1.7477"></a><span id="l1.7477">       return highIndex;</span>
<a href="#l1.7478"></a><span id="l1.7478">   }</span>
<a href="#l1.7479"></a><span id="l1.7479" class="difflineplus">+</span>
<a href="#l1.7480"></a><span id="l1.7480">   while (highIndex &gt; lowIndex)</span>
<a href="#l1.7481"></a><span id="l1.7481">   {</span>
<a href="#l1.7482"></a><span id="l1.7482">     nsMsgViewIndex tryIndex = (lowIndex + highIndex) / 2;</span>
<a href="#l1.7483"></a><span id="l1.7483" class="difflineminus">-    // need to adjust tryIndex if it's not a thread.</span>
<a href="#l1.7484"></a><span id="l1.7484" class="difflineplus">+    // Need to adjust tryIndex if it's not a thread.</span>
<a href="#l1.7485"></a><span id="l1.7485">     while (m_levels[tryIndex] &amp;&amp; tryIndex)</span>
<a href="#l1.7486"></a><span id="l1.7486">       tryIndex--;</span>
<a href="#l1.7487"></a><span id="l1.7487"> </span>
<a href="#l1.7488"></a><span id="l1.7488">     if (tryIndex &lt; lowIndex)</span>
<a href="#l1.7489"></a><span id="l1.7489">     {</span>
<a href="#l1.7490"></a><span id="l1.7490">       NS_ERROR(&quot;try index shouldn't be less than low index&quot;);</span>
<a href="#l1.7491"></a><span id="l1.7491">       break;</span>
<a href="#l1.7492"></a><span id="l1.7492">     }</span>
<a href="#l1.7493"></a><span id="l1.7493" class="difflineplus">+</span>
<a href="#l1.7494"></a><span id="l1.7494">     EntryInfo2.id = m_keys[tryIndex];</span>
<a href="#l1.7495"></a><span id="l1.7495">     GetFolderForViewIndex(tryIndex, &amp;EntryInfo2.folder);</span>
<a href="#l1.7496"></a><span id="l1.7496">     EntryInfo2.folder-&gt;Release();</span>
<a href="#l1.7497"></a><span id="l1.7497"> </span>
<a href="#l1.7498"></a><span id="l1.7498">     nsCOMPtr&lt;nsIMsgDBHdr&gt; tryHdr;</span>
<a href="#l1.7499"></a><span id="l1.7499">     nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.7500"></a><span id="l1.7500">     // ### this should get the db from the folder...</span>
<a href="#l1.7501"></a><span id="l1.7501">     GetDBForViewIndex(tryIndex, getter_AddRefs(db));</span>
<a href="#l1.7502"></a><span id="l1.7502">     if (db)</span>
<a href="#l1.7503"></a><span id="l1.7503">       rv = db-&gt;GetMsgHdrForKey(EntryInfo2.id, getter_AddRefs(tryHdr));</span>
<a href="#l1.7504"></a><span id="l1.7504" class="difflineplus">+</span>
<a href="#l1.7505"></a><span id="l1.7505">     if (!tryHdr)</span>
<a href="#l1.7506"></a><span id="l1.7506">       break;</span>
<a href="#l1.7507"></a><span id="l1.7507" class="difflineplus">+</span>
<a href="#l1.7508"></a><span id="l1.7508">     if (tryHdr == msgHdr)</span>
<a href="#l1.7509"></a><span id="l1.7509">     {</span>
<a href="#l1.7510"></a><span id="l1.7510">       highIndex = tryIndex;</span>
<a href="#l1.7511"></a><span id="l1.7511">       break;</span>
<a href="#l1.7512"></a><span id="l1.7512">     }</span>
<a href="#l1.7513"></a><span id="l1.7513" class="difflineplus">+</span>
<a href="#l1.7514"></a><span id="l1.7514">     if (fieldType == kCollationKey)</span>
<a href="#l1.7515"></a><span id="l1.7515">     {</span>
<a href="#l1.7516"></a><span id="l1.7516">       PR_FREEIF(EntryInfo2.key);</span>
<a href="#l1.7517"></a><span id="l1.7517">       rv = GetCollationKey(tryHdr, m_sortType, &amp;EntryInfo2.key, &amp;EntryInfo2.dword, colHandler);</span>
<a href="#l1.7518"></a><span id="l1.7518">       NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.7519"></a><span id="l1.7519">       retStatus = FnSortIdKeyPtr(&amp;pValue1, &amp;pValue2, &amp;comparisonContext);</span>
<a href="#l1.7520"></a><span id="l1.7520">     }</span>
<a href="#l1.7521"></a><span id="l1.7521">     else if (fieldType == kU32)</span>
<a href="#l1.7522"></a><span id="l1.7522">     {</span>
<a href="#l1.7523"></a><span id="l1.7523">       if (m_sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.7524"></a><span id="l1.7524">         EntryInfo2.dword = EntryInfo2.id;</span>
<a href="#l1.7525"></a><span id="l1.7525">       else</span>
<a href="#l1.7526"></a><span id="l1.7526">         GetLongField(tryHdr, m_sortType, &amp;EntryInfo2.dword, colHandler);</span>
<a href="#l1.7527"></a><span id="l1.7527" class="difflineplus">+</span>
<a href="#l1.7528"></a><span id="l1.7528">       retStatus = FnSortIdUint32(&amp;pValue1, &amp;pValue2, &amp;comparisonContext);</span>
<a href="#l1.7529"></a><span id="l1.7529">     }</span>
<a href="#l1.7530"></a><span id="l1.7530" class="difflineplus">+</span>
<a href="#l1.7531"></a><span id="l1.7531">     if (retStatus == 0)</span>
<a href="#l1.7532"></a><span id="l1.7532">     {</span>
<a href="#l1.7533"></a><span id="l1.7533">       highIndex = tryIndex;</span>
<a href="#l1.7534"></a><span id="l1.7534">       break;</span>
<a href="#l1.7535"></a><span id="l1.7535">     }</span>
<a href="#l1.7536"></a><span id="l1.7536"> </span>
<a href="#l1.7537"></a><span id="l1.7537">     if (retStatus &lt; 0)</span>
<a href="#l1.7538"></a><span id="l1.7538">     {</span>
<a href="#l1.7539"></a><span id="l1.7539">       highIndex = tryIndex;</span>
<a href="#l1.7540"></a><span id="l1.7540" class="difflineminus">-      // we already made sure tryIndex was at a thread at the top of the loop.</span>
<a href="#l1.7541"></a><span id="l1.7541" class="difflineplus">+      // We already made sure tryIndex was at a thread at the top of the loop.</span>
<a href="#l1.7542"></a><span id="l1.7542">     }</span>
<a href="#l1.7543"></a><span id="l1.7543">     else</span>
<a href="#l1.7544"></a><span id="l1.7544">     {</span>
<a href="#l1.7545"></a><span id="l1.7545">       lowIndex = tryIndex + 1;</span>
<a href="#l1.7546"></a><span id="l1.7546">       while (lowIndex &lt; GetSize() &amp;&amp; m_levels[lowIndex])</span>
<a href="#l1.7547"></a><span id="l1.7547">         lowIndex++;</span>
<a href="#l1.7548"></a><span id="l1.7548">     }</span>
<a href="#l1.7549"></a><span id="l1.7549">   }</span>
<a href="#l1.7550"></a><span id="l1.7550" class="difflineat">@@ -6037,24 +6699,27 @@ nsMsgDBView::GetThreadRootIndex(nsIMsgDB</span>
<a href="#l1.7551"></a><span id="l1.7551">     {</span>
<a href="#l1.7552"></a><span id="l1.7552">       NS_WARNING(&quot;but find hdr did&quot;);</span>
<a href="#l1.7553"></a><span id="l1.7553">       printf(&quot;level of found hdr = %d\n&quot;, m_levels[highIndex]);</span>
<a href="#l1.7554"></a><span id="l1.7554">       ValidateSort();</span>
<a href="#l1.7555"></a><span id="l1.7555">     }</span>
<a href="#l1.7556"></a><span id="l1.7556"> #endif</span>
<a href="#l1.7557"></a><span id="l1.7557">     return highIndex;</span>
<a href="#l1.7558"></a><span id="l1.7558">   }</span>
<a href="#l1.7559"></a><span id="l1.7559" class="difflineplus">+</span>
<a href="#l1.7560"></a><span id="l1.7560">   PR_Free(EntryInfo1.key);</span>
<a href="#l1.7561"></a><span id="l1.7561">   PR_Free(EntryInfo2.key);</span>
<a href="#l1.7562"></a><span id="l1.7562">   return msgHdr == resultHdr ? highIndex : nsMsgViewIndex_None;</span>
<a href="#l1.7563"></a><span id="l1.7563"> }</span>
<a href="#l1.7564"></a><span id="l1.7564"> </span>
<a href="#l1.7565"></a><span id="l1.7565"> #ifdef DEBUG_David_Bienvenu</span>
<a href="#l1.7566"></a><span id="l1.7566"> </span>
<a href="#l1.7567"></a><span id="l1.7567" class="difflineminus">-void nsMsgDBView::InitEntryInfoForIndex(nsMsgViewIndex i, IdKeyPtr &amp;EntryInfo)</span>
<a href="#l1.7568"></a><span id="l1.7568" class="difflineplus">+void</span>
<a href="#l1.7569"></a><span id="l1.7569" class="difflineplus">+nsMsgDBView::InitEntryInfoForIndex(nsMsgViewIndex i,</span>
<a href="#l1.7570"></a><span id="l1.7570" class="difflineplus">+                                   IdKeyPtr &amp;EntryInfo)</span>
<a href="#l1.7571"></a><span id="l1.7571"> {</span>
<a href="#l1.7572"></a><span id="l1.7572">   EntryInfo.key = nullptr;</span>
<a href="#l1.7573"></a><span id="l1.7573"> </span>
<a href="#l1.7574"></a><span id="l1.7574">   nsresult rv;</span>
<a href="#l1.7575"></a><span id="l1.7575">   uint16_t maxLen;</span>
<a href="#l1.7576"></a><span id="l1.7576">   eFieldType fieldType;</span>
<a href="#l1.7577"></a><span id="l1.7577"> </span>
<a href="#l1.7578"></a><span id="l1.7578">   // Get the custom column handler for the primary sort and pass it first</span>
<a href="#l1.7579"></a><span id="l1.7579" class="difflineat">@@ -6082,23 +6747,25 @@ void nsMsgDBView::InitEntryInfoForIndex(</span>
<a href="#l1.7580"></a><span id="l1.7580">       rv = GetCollationKey(msgHdr, m_sortType, &amp;EntryInfo.key, &amp;EntryInfo.dword, colHandler);</span>
<a href="#l1.7581"></a><span id="l1.7581">       NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.7582"></a><span id="l1.7582">       break;</span>
<a href="#l1.7583"></a><span id="l1.7583">     case kU32:</span>
<a href="#l1.7584"></a><span id="l1.7584">       if (m_sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.7585"></a><span id="l1.7585">         EntryInfo.dword = EntryInfo.id;</span>
<a href="#l1.7586"></a><span id="l1.7586">       else</span>
<a href="#l1.7587"></a><span id="l1.7587">         GetLongField(msgHdr, m_sortType, &amp;EntryInfo.dword, colHandler);</span>
<a href="#l1.7588"></a><span id="l1.7588" class="difflineplus">+</span>
<a href="#l1.7589"></a><span id="l1.7589">       break;</span>
<a href="#l1.7590"></a><span id="l1.7590">     default:</span>
<a href="#l1.7591"></a><span id="l1.7591">       NS_ERROR(&quot;invalid field type&quot;);</span>
<a href="#l1.7592"></a><span id="l1.7592">   }</span>
<a href="#l1.7593"></a><span id="l1.7593"> }</span>
<a href="#l1.7594"></a><span id="l1.7594"> </span>
<a href="#l1.7595"></a><span id="l1.7595" class="difflineminus">-void nsMsgDBView::ValidateSort()</span>
<a href="#l1.7596"></a><span id="l1.7596" class="difflineplus">+void</span>
<a href="#l1.7597"></a><span id="l1.7597" class="difflineplus">+nsMsgDBView::ValidateSort()</span>
<a href="#l1.7598"></a><span id="l1.7598"> {</span>
<a href="#l1.7599"></a><span id="l1.7599">   IdKeyPtr EntryInfo1, EntryInfo2;</span>
<a href="#l1.7600"></a><span id="l1.7600">   nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr1, hdr2;</span>
<a href="#l1.7601"></a><span id="l1.7601"> </span>
<a href="#l1.7602"></a><span id="l1.7602">   uint16_t  maxLen;</span>
<a href="#l1.7603"></a><span id="l1.7603">   eFieldType fieldType;</span>
<a href="#l1.7604"></a><span id="l1.7604"> </span>
<a href="#l1.7605"></a><span id="l1.7605">   // Get the custom column handler for the primary sort and pass it first</span>
<a href="#l1.7606"></a><span id="l1.7606" class="difflineat">@@ -6115,32 +6782,33 @@ void nsMsgDBView::ValidateSort()</span>
<a href="#l1.7607"></a><span id="l1.7607">   NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to obtain fieldType&quot;);</span>
<a href="#l1.7608"></a><span id="l1.7608"> </span>
<a href="#l1.7609"></a><span id="l1.7609">   viewSortInfo comparisonContext;</span>
<a href="#l1.7610"></a><span id="l1.7610">   comparisonContext.view = this;</span>
<a href="#l1.7611"></a><span id="l1.7611">   comparisonContext.isSecondarySort = false;</span>
<a href="#l1.7612"></a><span id="l1.7612">   comparisonContext.ascendingSort = (m_sortOrder == nsMsgViewSortOrder::ascending);</span>
<a href="#l1.7613"></a><span id="l1.7613">   nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.7614"></a><span id="l1.7614">   GetDBForViewIndex(0, getter_AddRefs(db));</span>
<a href="#l1.7615"></a><span id="l1.7615" class="difflineminus">-  // this is only for comparing collation keys - it could be any db.</span>
<a href="#l1.7616"></a><span id="l1.7616" class="difflineplus">+  // This is only for comparing collation keys - it could be any db.</span>
<a href="#l1.7617"></a><span id="l1.7617">   comparisonContext.db = db.get();</span>
<a href="#l1.7618"></a><span id="l1.7618"> </span>
<a href="#l1.7619"></a><span id="l1.7619">   for (nsMsgViewIndex i = 0; i &lt; m_keys.Length();)</span>
<a href="#l1.7620"></a><span id="l1.7620">   {</span>
<a href="#l1.7621"></a><span id="l1.7621" class="difflineminus">-    // ignore non threads</span>
<a href="#l1.7622"></a><span id="l1.7622" class="difflineplus">+    // Ignore non threads.</span>
<a href="#l1.7623"></a><span id="l1.7623">     if (m_levels[i])</span>
<a href="#l1.7624"></a><span id="l1.7624">     {</span>
<a href="#l1.7625"></a><span id="l1.7625">       i++;</span>
<a href="#l1.7626"></a><span id="l1.7626">       continue;</span>
<a href="#l1.7627"></a><span id="l1.7627">     }</span>
<a href="#l1.7628"></a><span id="l1.7628"> </span>
<a href="#l1.7629"></a><span id="l1.7629" class="difflineminus">-    // find next header.</span>
<a href="#l1.7630"></a><span id="l1.7630" class="difflineplus">+    // Find next header.</span>
<a href="#l1.7631"></a><span id="l1.7631">     nsMsgViewIndex j = i + 1;</span>
<a href="#l1.7632"></a><span id="l1.7632">     while (j &lt; m_keys.Length() &amp;&amp; m_levels[j])</span>
<a href="#l1.7633"></a><span id="l1.7633">       j++;</span>
<a href="#l1.7634"></a><span id="l1.7634" class="difflineplus">+</span>
<a href="#l1.7635"></a><span id="l1.7635">     if (j == m_keys.Length())</span>
<a href="#l1.7636"></a><span id="l1.7636">       break;</span>
<a href="#l1.7637"></a><span id="l1.7637"> </span>
<a href="#l1.7638"></a><span id="l1.7638">     InitEntryInfoForIndex(i, EntryInfo1);</span>
<a href="#l1.7639"></a><span id="l1.7639">     InitEntryInfoForIndex(j, EntryInfo2);</span>
<a href="#l1.7640"></a><span id="l1.7640">     const void *pValue1 = &amp;EntryInfo1, *pValue2 = &amp;EntryInfo2;</span>
<a href="#l1.7641"></a><span id="l1.7641">     int retStatus = 0;</span>
<a href="#l1.7642"></a><span id="l1.7642">     if (fieldType == kCollationKey)</span>
<a href="#l1.7643"></a><span id="l1.7643" class="difflineat">@@ -6155,20 +6823,23 @@ void nsMsgDBView::ValidateSort()</span>
<a href="#l1.7644"></a><span id="l1.7644">     }</span>
<a href="#l1.7645"></a><span id="l1.7645">     // j is the new i.</span>
<a href="#l1.7646"></a><span id="l1.7646">     i = j;</span>
<a href="#l1.7647"></a><span id="l1.7647">   }</span>
<a href="#l1.7648"></a><span id="l1.7648"> }</span>
<a href="#l1.7649"></a><span id="l1.7649"> </span>
<a href="#l1.7650"></a><span id="l1.7650"> #endif</span>
<a href="#l1.7651"></a><span id="l1.7651"> </span>
<a href="#l1.7652"></a><span id="l1.7652" class="difflineminus">-nsresult nsMsgDBView::ListUnreadIdsInThread(nsIMsgThread *threadHdr, nsMsgViewIndex startOfThreadViewIndex, uint32_t *pNumListed)</span>
<a href="#l1.7653"></a><span id="l1.7653" class="difflineplus">+nsresult</span>
<a href="#l1.7654"></a><span id="l1.7654" class="difflineplus">+nsMsgDBView::ListUnreadIdsInThread(nsIMsgThread *threadHdr,</span>
<a href="#l1.7655"></a><span id="l1.7655" class="difflineplus">+                                   nsMsgViewIndex startOfThreadViewIndex,</span>
<a href="#l1.7656"></a><span id="l1.7656" class="difflineplus">+                                   uint32_t *pNumListed)</span>
<a href="#l1.7657"></a><span id="l1.7657"> {</span>
<a href="#l1.7658"></a><span id="l1.7658">   NS_ENSURE_ARG(threadHdr);</span>
<a href="#l1.7659"></a><span id="l1.7659" class="difflineminus">-  // these children ids should be in thread order.</span>
<a href="#l1.7660"></a><span id="l1.7660" class="difflineplus">+  // These children ids should be in thread order.</span>
<a href="#l1.7661"></a><span id="l1.7661">   nsMsgViewIndex viewIndex = startOfThreadViewIndex + 1;</span>
<a href="#l1.7662"></a><span id="l1.7662">   *pNumListed = 0;</span>
<a href="#l1.7663"></a><span id="l1.7663">   nsMsgKey topLevelMsgKey = m_keys[startOfThreadViewIndex];</span>
<a href="#l1.7664"></a><span id="l1.7664"> </span>
<a href="#l1.7665"></a><span id="l1.7665">   uint32_t numChildren;</span>
<a href="#l1.7666"></a><span id="l1.7666">   threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l1.7667"></a><span id="l1.7667">   uint32_t i;</span>
<a href="#l1.7668"></a><span id="l1.7668">   for (i = 0; i &lt; numChildren; i++)</span>
<a href="#l1.7669"></a><span id="l1.7669" class="difflineat">@@ -6187,72 +6858,81 @@ nsresult nsMsgDBView::ListUnreadIdsInThr</span>
<a href="#l1.7670"></a><span id="l1.7670"> </span>
<a href="#l1.7671"></a><span id="l1.7671">       nsMsgKey msgKey;</span>
<a href="#l1.7672"></a><span id="l1.7672">       uint32_t msgFlags;</span>
<a href="#l1.7673"></a><span id="l1.7673">       msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.7674"></a><span id="l1.7674">       msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.7675"></a><span id="l1.7675">       bool isRead = AdjustReadFlag(msgHdr, &amp;msgFlags);</span>
<a href="#l1.7676"></a><span id="l1.7676">       if (!isRead)</span>
<a href="#l1.7677"></a><span id="l1.7677">       {</span>
<a href="#l1.7678"></a><span id="l1.7678" class="difflineminus">-        // just make sure flag is right in db.</span>
<a href="#l1.7679"></a><span id="l1.7679" class="difflineplus">+        // Just make sure flag is right in db.</span>
<a href="#l1.7680"></a><span id="l1.7680">         m_db-&gt;MarkHdrRead(msgHdr, false, nullptr);</span>
<a href="#l1.7681"></a><span id="l1.7681">         if (msgKey != topLevelMsgKey)</span>
<a href="#l1.7682"></a><span id="l1.7682">         {</span>
<a href="#l1.7683"></a><span id="l1.7683">           InsertMsgHdrAt(viewIndex, msgHdr, msgKey, msgFlags,</span>
<a href="#l1.7684"></a><span id="l1.7684" class="difflineminus">-                FindLevelInThread(msgHdr, startOfThreadViewIndex, viewIndex));</span>
<a href="#l1.7685"></a><span id="l1.7685" class="difflineplus">+                         FindLevelInThread(msgHdr, startOfThreadViewIndex, viewIndex));</span>
<a href="#l1.7686"></a><span id="l1.7686">           viewIndex++;</span>
<a href="#l1.7687"></a><span id="l1.7687">           (*pNumListed)++;</span>
<a href="#l1.7688"></a><span id="l1.7688">         }</span>
<a href="#l1.7689"></a><span id="l1.7689">       }</span>
<a href="#l1.7690"></a><span id="l1.7690">     }</span>
<a href="#l1.7691"></a><span id="l1.7691">   }</span>
<a href="#l1.7692"></a><span id="l1.7692" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.7693"></a><span id="l1.7693" class="difflineminus">-}</span>
<a href="#l1.7694"></a><span id="l1.7694" class="difflineminus">-</span>
<a href="#l1.7695"></a><span id="l1.7695" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags,</span>
<a href="#l1.7696"></a><span id="l1.7696" class="difflineminus">-                                       uint32_t aNewFlags, nsIDBChangeListener *aInstigator)</span>
<a href="#l1.7697"></a><span id="l1.7697" class="difflineminus">-{</span>
<a href="#l1.7698"></a><span id="l1.7698" class="difflineminus">-  // if we're not the instigator, update flags if this key is in our view</span>
<a href="#l1.7699"></a><span id="l1.7699" class="difflineplus">+</span>
<a href="#l1.7700"></a><span id="l1.7700" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.7701"></a><span id="l1.7701" class="difflineplus">+}</span>
<a href="#l1.7702"></a><span id="l1.7702" class="difflineplus">+</span>
<a href="#l1.7703"></a><span id="l1.7703" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.7704"></a><span id="l1.7704" class="difflineplus">+nsMsgDBView::OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged,</span>
<a href="#l1.7705"></a><span id="l1.7705" class="difflineplus">+                               uint32_t aOldFlags,</span>
<a href="#l1.7706"></a><span id="l1.7706" class="difflineplus">+                               uint32_t aNewFlags,</span>
<a href="#l1.7707"></a><span id="l1.7707" class="difflineplus">+                               nsIDBChangeListener *aInstigator)</span>
<a href="#l1.7708"></a><span id="l1.7708" class="difflineplus">+{</span>
<a href="#l1.7709"></a><span id="l1.7709" class="difflineplus">+  // If we're not the instigator, update flags if this key is in our view.</span>
<a href="#l1.7710"></a><span id="l1.7710">   if (aInstigator != this)</span>
<a href="#l1.7711"></a><span id="l1.7711">   {</span>
<a href="#l1.7712"></a><span id="l1.7712">     NS_ENSURE_ARG_POINTER(aHdrChanged);</span>
<a href="#l1.7713"></a><span id="l1.7713">     nsMsgKey msgKey;</span>
<a href="#l1.7714"></a><span id="l1.7714">     aHdrChanged-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.7715"></a><span id="l1.7715">     nsMsgViewIndex index = FindHdr(aHdrChanged);</span>
<a href="#l1.7716"></a><span id="l1.7716">     if (index != nsMsgViewIndex_None)</span>
<a href="#l1.7717"></a><span id="l1.7717">     {</span>
<a href="#l1.7718"></a><span id="l1.7718" class="difflineminus">-      uint32_t viewOnlyFlags = m_flags[index] &amp; (MSG_VIEW_FLAGS | nsMsgMessageFlags::Elided);</span>
<a href="#l1.7719"></a><span id="l1.7719" class="difflineminus">-</span>
<a href="#l1.7720"></a><span id="l1.7720" class="difflineminus">-      // ### what about saving the old view only flags, like IsThread and HasChildren?</span>
<a href="#l1.7721"></a><span id="l1.7721" class="difflineplus">+      uint32_t viewOnlyFlags =</span>
<a href="#l1.7722"></a><span id="l1.7722" class="difflineplus">+        m_flags[index] &amp; (MSG_VIEW_FLAGS | nsMsgMessageFlags::Elided);</span>
<a href="#l1.7723"></a><span id="l1.7723" class="difflineplus">+</span>
<a href="#l1.7724"></a><span id="l1.7724" class="difflineplus">+      // XXX what about saving the old view only flags, like IsThread and</span>
<a href="#l1.7725"></a><span id="l1.7725" class="difflineplus">+      // HasChildren?</span>
<a href="#l1.7726"></a><span id="l1.7726">       // I think we'll want to save those away.</span>
<a href="#l1.7727"></a><span id="l1.7727">       m_flags[index] = aNewFlags | viewOnlyFlags;</span>
<a href="#l1.7728"></a><span id="l1.7728" class="difflineminus">-      // tell the view the extra flag changed, so it can</span>
<a href="#l1.7729"></a><span id="l1.7729" class="difflineplus">+      // Tell the view the extra flag changed, so it can</span>
<a href="#l1.7730"></a><span id="l1.7730">       // update the previous view, if any.</span>
<a href="#l1.7731"></a><span id="l1.7731">       OnExtraFlagChanged(index, aNewFlags);</span>
<a href="#l1.7732"></a><span id="l1.7732">       NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.7733"></a><span id="l1.7733">     }</span>
<a href="#l1.7734"></a><span id="l1.7734"> </span>
<a href="#l1.7735"></a><span id="l1.7735">     uint32_t deltaFlags = (aOldFlags ^ aNewFlags);</span>
<a href="#l1.7736"></a><span id="l1.7736">     if (deltaFlags &amp; (nsMsgMessageFlags::Read | nsMsgMessageFlags::New))</span>
<a href="#l1.7737"></a><span id="l1.7737">     {</span>
<a href="#l1.7738"></a><span id="l1.7738">       nsMsgViewIndex threadIndex =</span>
<a href="#l1.7739"></a><span id="l1.7739" class="difflineminus">-            ThreadIndexOfMsgHdr(aHdrChanged, index, nullptr, nullptr);</span>
<a href="#l1.7740"></a><span id="l1.7740" class="difflineminus">-      // may need to fix thread counts</span>
<a href="#l1.7741"></a><span id="l1.7741" class="difflineplus">+        ThreadIndexOfMsgHdr(aHdrChanged, index, nullptr, nullptr);</span>
<a href="#l1.7742"></a><span id="l1.7742" class="difflineplus">+</span>
<a href="#l1.7743"></a><span id="l1.7743" class="difflineplus">+      // May need to fix thread counts.</span>
<a href="#l1.7744"></a><span id="l1.7744">       if (threadIndex != nsMsgViewIndex_None &amp;&amp; threadIndex != index)</span>
<a href="#l1.7745"></a><span id="l1.7745">         NoteChange(threadIndex, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.7746"></a><span id="l1.7746">     }</span>
<a href="#l1.7747"></a><span id="l1.7747">  }</span>
<a href="#l1.7748"></a><span id="l1.7748" class="difflineminus">-  // don't need to propagate notifications, right?</span>
<a href="#l1.7749"></a><span id="l1.7749" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.7750"></a><span id="l1.7750" class="difflineminus">-}</span>
<a href="#l1.7751"></a><span id="l1.7751" class="difflineminus">-</span>
<a href="#l1.7752"></a><span id="l1.7752" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::OnHdrDeleted(nsIMsgDBHdr *aHdrChanged,</span>
<a href="#l1.7753"></a><span id="l1.7753" class="difflineminus">-                                        nsMsgKey aParentKey,</span>
<a href="#l1.7754"></a><span id="l1.7754" class="difflineminus">-                                        int32_t aFlags,</span>
<a href="#l1.7755"></a><span id="l1.7755" class="difflineminus">-                                        nsIDBChangeListener *aInstigator)</span>
<a href="#l1.7756"></a><span id="l1.7756" class="difflineplus">+</span>
<a href="#l1.7757"></a><span id="l1.7757" class="difflineplus">+  // Don't need to propagate notifications, right?</span>
<a href="#l1.7758"></a><span id="l1.7758" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.7759"></a><span id="l1.7759" class="difflineplus">+}</span>
<a href="#l1.7760"></a><span id="l1.7760" class="difflineplus">+</span>
<a href="#l1.7761"></a><span id="l1.7761" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.7762"></a><span id="l1.7762" class="difflineplus">+nsMsgDBView::OnHdrDeleted(nsIMsgDBHdr *aHdrChanged,</span>
<a href="#l1.7763"></a><span id="l1.7763" class="difflineplus">+                          nsMsgKey aParentKey,</span>
<a href="#l1.7764"></a><span id="l1.7764" class="difflineplus">+                          int32_t aFlags,</span>
<a href="#l1.7765"></a><span id="l1.7765" class="difflineplus">+                          nsIDBChangeListener *aInstigator)</span>
<a href="#l1.7766"></a><span id="l1.7766"> {</span>
<a href="#l1.7767"></a><span id="l1.7767">   nsMsgViewIndex deletedIndex = FindHdr(aHdrChanged);</span>
<a href="#l1.7768"></a><span id="l1.7768">   if (IsValidIndex(deletedIndex))</span>
<a href="#l1.7769"></a><span id="l1.7769">   {</span>
<a href="#l1.7770"></a><span id="l1.7770">     // Check if this message is currently selected. If it is, tell the frontend</span>
<a href="#l1.7771"></a><span id="l1.7771">     // to be prepared for a delete.</span>
<a href="#l1.7772"></a><span id="l1.7772">     if (mTreeSelection &amp;&amp; mCommandUpdater)</span>
<a href="#l1.7773"></a><span id="l1.7773">     {</span>
<a href="#l1.7774"></a><span id="l1.7774" class="difflineat">@@ -6263,881 +6943,1031 @@ NS_IMETHODIMP nsMsgDBView::OnHdrDeleted(</span>
<a href="#l1.7775"></a><span id="l1.7775">     }</span>
<a href="#l1.7776"></a><span id="l1.7776"> </span>
<a href="#l1.7777"></a><span id="l1.7777">     RemoveByIndex(deletedIndex);</span>
<a href="#l1.7778"></a><span id="l1.7778">   }</span>
<a href="#l1.7779"></a><span id="l1.7779"> </span>
<a href="#l1.7780"></a><span id="l1.7780">   return NS_OK;</span>
<a href="#l1.7781"></a><span id="l1.7781"> }</span>
<a href="#l1.7782"></a><span id="l1.7782"> </span>
<a href="#l1.7783"></a><span id="l1.7783" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::OnHdrAdded(nsIMsgDBHdr *aHdrChanged, nsMsgKey aParentKey, int32_t aFlags,</span>
<a href="#l1.7784"></a><span id="l1.7784" class="difflineminus">-                          nsIDBChangeListener *aInstigator)</span>
<a href="#l1.7785"></a><span id="l1.7785" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.7786"></a><span id="l1.7786" class="difflineplus">+nsMsgDBView::OnHdrAdded(nsIMsgDBHdr *aHdrChanged,</span>
<a href="#l1.7787"></a><span id="l1.7787" class="difflineplus">+                        nsMsgKey aParentKey,</span>
<a href="#l1.7788"></a><span id="l1.7788" class="difflineplus">+                        int32_t aFlags,</span>
<a href="#l1.7789"></a><span id="l1.7789" class="difflineplus">+                        nsIDBChangeListener *aInstigator)</span>
<a href="#l1.7790"></a><span id="l1.7790"> {</span>
<a href="#l1.7791"></a><span id="l1.7791">   return OnNewHeader(aHdrChanged, aParentKey, false);</span>
<a href="#l1.7792"></a><span id="l1.7792" class="difflineminus">-  // probably also want to pass that parent key in, since we went to the trouble</span>
<a href="#l1.7793"></a><span id="l1.7793" class="difflineminus">-  // of figuring out what it is.</span>
<a href="#l1.7794"></a><span id="l1.7794" class="difflineminus">-}</span>
<a href="#l1.7795"></a><span id="l1.7795" class="difflineminus">-</span>
<a href="#l1.7796"></a><span id="l1.7796" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l1.7797"></a><span id="l1.7797" class="difflineminus">-nsMsgDBView::OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange, bool aPreChange, uint32_t *aStatus,</span>
<a href="#l1.7798"></a><span id="l1.7798" class="difflineminus">-                                 nsIDBChangeListener * aInstigator)</span>
<a href="#l1.7799"></a><span id="l1.7799" class="difflineplus">+  // Probably also want to pass that parent key in, since we went to the</span>
<a href="#l1.7800"></a><span id="l1.7800" class="difflineplus">+  // trouble of figuring out what it is.</span>
<a href="#l1.7801"></a><span id="l1.7801" class="difflineplus">+}</span>
<a href="#l1.7802"></a><span id="l1.7802" class="difflineplus">+</span>
<a href="#l1.7803"></a><span id="l1.7803" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.7804"></a><span id="l1.7804" class="difflineplus">+nsMsgDBView::OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange,</span>
<a href="#l1.7805"></a><span id="l1.7805" class="difflineplus">+                                  bool aPreChange,</span>
<a href="#l1.7806"></a><span id="l1.7806" class="difflineplus">+                                  uint32_t *aStatus,</span>
<a href="#l1.7807"></a><span id="l1.7807" class="difflineplus">+                                  nsIDBChangeListener * aInstigator)</span>
<a href="#l1.7808"></a><span id="l1.7808"> {</span>
<a href="#l1.7809"></a><span id="l1.7809">   if (aPreChange)</span>
<a href="#l1.7810"></a><span id="l1.7810">     return NS_OK;</span>
<a href="#l1.7811"></a><span id="l1.7811"> </span>
<a href="#l1.7812"></a><span id="l1.7812">   if (aHdrToChange)</span>
<a href="#l1.7813"></a><span id="l1.7813">   {</span>
<a href="#l1.7814"></a><span id="l1.7814">     nsMsgViewIndex index = FindHdr(aHdrToChange);</span>
<a href="#l1.7815"></a><span id="l1.7815">     if (index != nsMsgViewIndex_None)</span>
<a href="#l1.7816"></a><span id="l1.7816">       NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.7817"></a><span id="l1.7817">   }</span>
<a href="#l1.7818"></a><span id="l1.7818" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.7819"></a><span id="l1.7819" class="difflineminus">-}</span>
<a href="#l1.7820"></a><span id="l1.7820" class="difflineminus">-</span>
<a href="#l1.7821"></a><span id="l1.7821" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::OnParentChanged (nsMsgKey aKeyChanged, nsMsgKey oldParent, nsMsgKey newParent, nsIDBChangeListener *aInstigator)</span>
<a href="#l1.7822"></a><span id="l1.7822" class="difflineminus">-{</span>
<a href="#l1.7823"></a><span id="l1.7823" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.7824"></a><span id="l1.7824" class="difflineminus">-}</span>
<a href="#l1.7825"></a><span id="l1.7825" class="difflineminus">-</span>
<a href="#l1.7826"></a><span id="l1.7826" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::OnAnnouncerGoingAway(nsIDBChangeAnnouncer *instigator)</span>
<a href="#l1.7827"></a><span id="l1.7827" class="difflineplus">+</span>
<a href="#l1.7828"></a><span id="l1.7828" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.7829"></a><span id="l1.7829" class="difflineplus">+}</span>
<a href="#l1.7830"></a><span id="l1.7830" class="difflineplus">+</span>
<a href="#l1.7831"></a><span id="l1.7831" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.7832"></a><span id="l1.7832" class="difflineplus">+nsMsgDBView::OnParentChanged (nsMsgKey aKeyChanged,</span>
<a href="#l1.7833"></a><span id="l1.7833" class="difflineplus">+                              nsMsgKey oldParent,</span>
<a href="#l1.7834"></a><span id="l1.7834" class="difflineplus">+                              nsMsgKey newParent,</span>
<a href="#l1.7835"></a><span id="l1.7835" class="difflineplus">+                              nsIDBChangeListener *aInstigator)</span>
<a href="#l1.7836"></a><span id="l1.7836" class="difflineplus">+{</span>
<a href="#l1.7837"></a><span id="l1.7837" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.7838"></a><span id="l1.7838" class="difflineplus">+}</span>
<a href="#l1.7839"></a><span id="l1.7839" class="difflineplus">+</span>
<a href="#l1.7840"></a><span id="l1.7840" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.7841"></a><span id="l1.7841" class="difflineplus">+nsMsgDBView::OnAnnouncerGoingAway(nsIDBChangeAnnouncer *instigator)</span>
<a href="#l1.7842"></a><span id="l1.7842"> {</span>
<a href="#l1.7843"></a><span id="l1.7843">   if (m_db)</span>
<a href="#l1.7844"></a><span id="l1.7844">   {</span>
<a href="#l1.7845"></a><span id="l1.7845">     m_db-&gt;RemoveListener(this);</span>
<a href="#l1.7846"></a><span id="l1.7846">     m_db = nullptr;</span>
<a href="#l1.7847"></a><span id="l1.7847">   }</span>
<a href="#l1.7848"></a><span id="l1.7848"> </span>
<a href="#l1.7849"></a><span id="l1.7849">   int32_t saveSize = GetSize();</span>
<a href="#l1.7850"></a><span id="l1.7850">   ClearHdrCache();</span>
<a href="#l1.7851"></a><span id="l1.7851"> </span>
<a href="#l1.7852"></a><span id="l1.7852" class="difflineminus">-  // this is important, because the tree will ask us for our</span>
<a href="#l1.7853"></a><span id="l1.7853" class="difflineplus">+  // This is important, because the tree will ask us for our</span>
<a href="#l1.7854"></a><span id="l1.7854">   // row count, which get determine from the number of keys.</span>
<a href="#l1.7855"></a><span id="l1.7855">   m_keys.Clear();</span>
<a href="#l1.7856"></a><span id="l1.7856" class="difflineminus">-  // be consistent</span>
<a href="#l1.7857"></a><span id="l1.7857" class="difflineplus">+  // Be consistent.</span>
<a href="#l1.7858"></a><span id="l1.7858">   m_flags.Clear();</span>
<a href="#l1.7859"></a><span id="l1.7859">   m_levels.Clear();</span>
<a href="#l1.7860"></a><span id="l1.7860"> </span>
<a href="#l1.7861"></a><span id="l1.7861" class="difflineminus">-  // tell the tree all the rows have gone away</span>
<a href="#l1.7862"></a><span id="l1.7862" class="difflineplus">+  // Tell the tree all the rows have gone away.</span>
<a href="#l1.7863"></a><span id="l1.7863">   if (mTree)</span>
<a href="#l1.7864"></a><span id="l1.7864">     mTree-&gt;RowCountChanged(0, -saveSize);</span>
<a href="#l1.7865"></a><span id="l1.7865"> </span>
<a href="#l1.7866"></a><span id="l1.7866">   return NS_OK;</span>
<a href="#l1.7867"></a><span id="l1.7867"> }</span>
<a href="#l1.7868"></a><span id="l1.7868"> </span>
<a href="#l1.7869"></a><span id="l1.7869"> NS_IMETHODIMP</span>
<a href="#l1.7870"></a><span id="l1.7870" class="difflineminus">-nsMsgDBView::OnEvent(nsIMsgDatabase *aDB, const char *aEvent)</span>
<a href="#l1.7871"></a><span id="l1.7871" class="difflineplus">+nsMsgDBView::OnEvent(nsIMsgDatabase *aDB,</span>
<a href="#l1.7872"></a><span id="l1.7872" class="difflineplus">+                     const char *aEvent)</span>
<a href="#l1.7873"></a><span id="l1.7873"> {</span>
<a href="#l1.7874"></a><span id="l1.7874">   if (!strcmp(aEvent, &quot;DBOpened&quot;))</span>
<a href="#l1.7875"></a><span id="l1.7875">     m_db = aDB;</span>
<a href="#l1.7876"></a><span id="l1.7876" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.7877"></a><span id="l1.7877" class="difflineminus">-}</span>
<a href="#l1.7878"></a><span id="l1.7878" class="difflineminus">-</span>
<a href="#l1.7879"></a><span id="l1.7879" class="difflineminus">-</span>
<a href="#l1.7880"></a><span id="l1.7880" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::OnReadChanged(nsIDBChangeListener *aInstigator)</span>
<a href="#l1.7881"></a><span id="l1.7881" class="difflineminus">-{</span>
<a href="#l1.7882"></a><span id="l1.7882" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.7883"></a><span id="l1.7883" class="difflineminus">-}</span>
<a href="#l1.7884"></a><span id="l1.7884" class="difflineminus">-</span>
<a href="#l1.7885"></a><span id="l1.7885" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::OnJunkScoreChanged(nsIDBChangeListener *aInstigator)</span>
<a href="#l1.7886"></a><span id="l1.7886" class="difflineminus">-{</span>
<a href="#l1.7887"></a><span id="l1.7887" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.7888"></a><span id="l1.7888" class="difflineminus">-}</span>
<a href="#l1.7889"></a><span id="l1.7889" class="difflineminus">-</span>
<a href="#l1.7890"></a><span id="l1.7890" class="difflineminus">-void nsMsgDBView::ClearHdrCache()</span>
<a href="#l1.7891"></a><span id="l1.7891" class="difflineplus">+</span>
<a href="#l1.7892"></a><span id="l1.7892" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.7893"></a><span id="l1.7893" class="difflineplus">+}</span>
<a href="#l1.7894"></a><span id="l1.7894" class="difflineplus">+</span>
<a href="#l1.7895"></a><span id="l1.7895" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.7896"></a><span id="l1.7896" class="difflineplus">+nsMsgDBView::OnReadChanged(nsIDBChangeListener *aInstigator)</span>
<a href="#l1.7897"></a><span id="l1.7897" class="difflineplus">+{</span>
<a href="#l1.7898"></a><span id="l1.7898" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.7899"></a><span id="l1.7899" class="difflineplus">+}</span>
<a href="#l1.7900"></a><span id="l1.7900" class="difflineplus">+</span>
<a href="#l1.7901"></a><span id="l1.7901" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.7902"></a><span id="l1.7902" class="difflineplus">+nsMsgDBView::OnJunkScoreChanged(nsIDBChangeListener *aInstigator)</span>
<a href="#l1.7903"></a><span id="l1.7903" class="difflineplus">+{</span>
<a href="#l1.7904"></a><span id="l1.7904" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.7905"></a><span id="l1.7905" class="difflineplus">+}</span>
<a href="#l1.7906"></a><span id="l1.7906" class="difflineplus">+</span>
<a href="#l1.7907"></a><span id="l1.7907" class="difflineplus">+void</span>
<a href="#l1.7908"></a><span id="l1.7908" class="difflineplus">+nsMsgDBView::ClearHdrCache()</span>
<a href="#l1.7909"></a><span id="l1.7909"> {</span>
<a href="#l1.7910"></a><span id="l1.7910">   m_cachedHdr = nullptr;</span>
<a href="#l1.7911"></a><span id="l1.7911">   m_cachedMsgKey = nsMsgKey_None;</span>
<a href="#l1.7912"></a><span id="l1.7912"> }</span>
<a href="#l1.7913"></a><span id="l1.7913"> </span>
<a href="#l1.7914"></a><span id="l1.7914" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::SetSuppressChangeNotifications(bool aSuppressChangeNotifications)</span>
<a href="#l1.7915"></a><span id="l1.7915" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.7916"></a><span id="l1.7916" class="difflineplus">+nsMsgDBView::SetSuppressChangeNotifications(bool aSuppressChangeNotifications)</span>
<a href="#l1.7917"></a><span id="l1.7917"> {</span>
<a href="#l1.7918"></a><span id="l1.7918">   mSuppressChangeNotification = aSuppressChangeNotifications;</span>
<a href="#l1.7919"></a><span id="l1.7919">   return NS_OK;</span>
<a href="#l1.7920"></a><span id="l1.7920"> }</span>
<a href="#l1.7921"></a><span id="l1.7921"> </span>
<a href="#l1.7922"></a><span id="l1.7922" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetSuppressChangeNotifications(bool * aSuppressChangeNotifications)</span>
<a href="#l1.7923"></a><span id="l1.7923" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.7924"></a><span id="l1.7924" class="difflineplus">+nsMsgDBView::GetSuppressChangeNotifications(bool * aSuppressChangeNotifications)</span>
<a href="#l1.7925"></a><span id="l1.7925"> {</span>
<a href="#l1.7926"></a><span id="l1.7926">   NS_ENSURE_ARG_POINTER(aSuppressChangeNotifications);</span>
<a href="#l1.7927"></a><span id="l1.7927">   *aSuppressChangeNotifications = mSuppressChangeNotification;</span>
<a href="#l1.7928"></a><span id="l1.7928">   return NS_OK;</span>
<a href="#l1.7929"></a><span id="l1.7929"> }</span>
<a href="#l1.7930"></a><span id="l1.7930"> </span>
<a href="#l1.7931"></a><span id="l1.7931" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::NoteChange(nsMsgViewIndex firstLineChanged,</span>
<a href="#l1.7932"></a><span id="l1.7932" class="difflineminus">-                                      int32_t numChanged,</span>
<a href="#l1.7933"></a><span id="l1.7933" class="difflineminus">-                                      nsMsgViewNotificationCodeValue changeType)</span>
<a href="#l1.7934"></a><span id="l1.7934" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.7935"></a><span id="l1.7935" class="difflineplus">+nsMsgDBView::NoteChange(nsMsgViewIndex firstLineChanged,</span>
<a href="#l1.7936"></a><span id="l1.7936" class="difflineplus">+                        int32_t numChanged,</span>
<a href="#l1.7937"></a><span id="l1.7937" class="difflineplus">+                        nsMsgViewNotificationCodeValue changeType)</span>
<a href="#l1.7938"></a><span id="l1.7938"> {</span>
<a href="#l1.7939"></a><span id="l1.7939">   if (mTree &amp;&amp; !mSuppressChangeNotification)</span>
<a href="#l1.7940"></a><span id="l1.7940">   {</span>
<a href="#l1.7941"></a><span id="l1.7941">     switch (changeType)</span>
<a href="#l1.7942"></a><span id="l1.7942">     {</span>
<a href="#l1.7943"></a><span id="l1.7943" class="difflineminus">-    case nsMsgViewNotificationCode::changed:</span>
<a href="#l1.7944"></a><span id="l1.7944" class="difflineminus">-      mTree-&gt;InvalidateRange(firstLineChanged, firstLineChanged + numChanged - 1);</span>
<a href="#l1.7945"></a><span id="l1.7945" class="difflineminus">-      break;</span>
<a href="#l1.7946"></a><span id="l1.7946" class="difflineminus">-    case nsMsgViewNotificationCode::insertOrDelete:</span>
<a href="#l1.7947"></a><span id="l1.7947" class="difflineminus">-      if (numChanged &lt; 0)</span>
<a href="#l1.7948"></a><span id="l1.7948" class="difflineminus">-        mRemovingRow = true;</span>
<a href="#l1.7949"></a><span id="l1.7949" class="difflineminus">-      // the caller needs to have adjusted m_keys before getting here, since</span>
<a href="#l1.7950"></a><span id="l1.7950" class="difflineminus">-      // RowCountChanged() will call our GetRowCount()</span>
<a href="#l1.7951"></a><span id="l1.7951" class="difflineminus">-      mTree-&gt;RowCountChanged(firstLineChanged, numChanged);</span>
<a href="#l1.7952"></a><span id="l1.7952" class="difflineminus">-      mRemovingRow = false;</span>
<a href="#l1.7953"></a><span id="l1.7953" class="difflineminus">-      MOZ_FALLTHROUGH;</span>
<a href="#l1.7954"></a><span id="l1.7954" class="difflineminus">-    case nsMsgViewNotificationCode::all:</span>
<a href="#l1.7955"></a><span id="l1.7955" class="difflineminus">-      ClearHdrCache();</span>
<a href="#l1.7956"></a><span id="l1.7956" class="difflineminus">-      break;</span>
<a href="#l1.7957"></a><span id="l1.7957" class="difflineminus">-    }</span>
<a href="#l1.7958"></a><span id="l1.7958" class="difflineminus">-  }</span>
<a href="#l1.7959"></a><span id="l1.7959" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.7960"></a><span id="l1.7960" class="difflineminus">-}</span>
<a href="#l1.7961"></a><span id="l1.7961" class="difflineminus">-</span>
<a href="#l1.7962"></a><span id="l1.7962" class="difflineminus">-void nsMsgDBView::NoteStartChange(nsMsgViewIndex firstlineChanged, int32_t numChanged,</span>
<a href="#l1.7963"></a><span id="l1.7963" class="difflineminus">-                                  nsMsgViewNotificationCodeValue changeType)</span>
<a href="#l1.7964"></a><span id="l1.7964" class="difflineminus">-{</span>
<a href="#l1.7965"></a><span id="l1.7965" class="difflineminus">-}</span>
<a href="#l1.7966"></a><span id="l1.7966" class="difflineminus">-void nsMsgDBView::NoteEndChange(nsMsgViewIndex firstlineChanged, int32_t numChanged,</span>
<a href="#l1.7967"></a><span id="l1.7967" class="difflineminus">-                                nsMsgViewNotificationCodeValue changeType)</span>
<a href="#l1.7968"></a><span id="l1.7968" class="difflineminus">-{</span>
<a href="#l1.7969"></a><span id="l1.7969" class="difflineminus">-  // send the notification now.</span>
<a href="#l1.7970"></a><span id="l1.7970" class="difflineplus">+      case nsMsgViewNotificationCode::changed:</span>
<a href="#l1.7971"></a><span id="l1.7971" class="difflineplus">+        mTree-&gt;InvalidateRange(firstLineChanged, firstLineChanged + numChanged - 1);</span>
<a href="#l1.7972"></a><span id="l1.7972" class="difflineplus">+        break;</span>
<a href="#l1.7973"></a><span id="l1.7973" class="difflineplus">+      case nsMsgViewNotificationCode::insertOrDelete:</span>
<a href="#l1.7974"></a><span id="l1.7974" class="difflineplus">+        if (numChanged &lt; 0)</span>
<a href="#l1.7975"></a><span id="l1.7975" class="difflineplus">+          mRemovingRow = true;</span>
<a href="#l1.7976"></a><span id="l1.7976" class="difflineplus">+</span>
<a href="#l1.7977"></a><span id="l1.7977" class="difflineplus">+        // The caller needs to have adjusted m_keys before getting here, since</span>
<a href="#l1.7978"></a><span id="l1.7978" class="difflineplus">+        // RowCountChanged() will call our GetRowCount().</span>
<a href="#l1.7979"></a><span id="l1.7979" class="difflineplus">+        mTree-&gt;RowCountChanged(firstLineChanged, numChanged);</span>
<a href="#l1.7980"></a><span id="l1.7980" class="difflineplus">+        mRemovingRow = false;</span>
<a href="#l1.7981"></a><span id="l1.7981" class="difflineplus">+        MOZ_FALLTHROUGH;</span>
<a href="#l1.7982"></a><span id="l1.7982" class="difflineplus">+      case nsMsgViewNotificationCode::all:</span>
<a href="#l1.7983"></a><span id="l1.7983" class="difflineplus">+        ClearHdrCache();</span>
<a href="#l1.7984"></a><span id="l1.7984" class="difflineplus">+        break;</span>
<a href="#l1.7985"></a><span id="l1.7985" class="difflineplus">+    }</span>
<a href="#l1.7986"></a><span id="l1.7986" class="difflineplus">+  }</span>
<a href="#l1.7987"></a><span id="l1.7987" class="difflineplus">+</span>
<a href="#l1.7988"></a><span id="l1.7988" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.7989"></a><span id="l1.7989" class="difflineplus">+}</span>
<a href="#l1.7990"></a><span id="l1.7990" class="difflineplus">+</span>
<a href="#l1.7991"></a><span id="l1.7991" class="difflineplus">+void</span>
<a href="#l1.7992"></a><span id="l1.7992" class="difflineplus">+nsMsgDBView::NoteStartChange(nsMsgViewIndex firstlineChanged,</span>
<a href="#l1.7993"></a><span id="l1.7993" class="difflineplus">+                             int32_t numChanged,</span>
<a href="#l1.7994"></a><span id="l1.7994" class="difflineplus">+                             nsMsgViewNotificationCodeValue changeType)</span>
<a href="#l1.7995"></a><span id="l1.7995" class="difflineplus">+{</span>
<a href="#l1.7996"></a><span id="l1.7996" class="difflineplus">+}</span>
<a href="#l1.7997"></a><span id="l1.7997" class="difflineplus">+</span>
<a href="#l1.7998"></a><span id="l1.7998" class="difflineplus">+void</span>
<a href="#l1.7999"></a><span id="l1.7999" class="difflineplus">+nsMsgDBView::NoteEndChange(nsMsgViewIndex firstlineChanged,</span>
<a href="#l1.8000"></a><span id="l1.8000" class="difflineplus">+                           int32_t numChanged,</span>
<a href="#l1.8001"></a><span id="l1.8001" class="difflineplus">+                           nsMsgViewNotificationCodeValue changeType)</span>
<a href="#l1.8002"></a><span id="l1.8002" class="difflineplus">+{</span>
<a href="#l1.8003"></a><span id="l1.8003" class="difflineplus">+  // Send the notification now.</span>
<a href="#l1.8004"></a><span id="l1.8004">   NoteChange(firstlineChanged, numChanged, changeType);</span>
<a href="#l1.8005"></a><span id="l1.8005"> }</span>
<a href="#l1.8006"></a><span id="l1.8006"> </span>
<a href="#l1.8007"></a><span id="l1.8007" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetSortOrder(nsMsgViewSortOrderValue *aSortOrder)</span>
<a href="#l1.8008"></a><span id="l1.8008" class="difflineminus">-{</span>
<a href="#l1.8009"></a><span id="l1.8009" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aSortOrder);</span>
<a href="#l1.8010"></a><span id="l1.8010" class="difflineminus">-    *aSortOrder = m_sortOrder;</span>
<a href="#l1.8011"></a><span id="l1.8011" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.8012"></a><span id="l1.8012" class="difflineminus">-}</span>
<a href="#l1.8013"></a><span id="l1.8013" class="difflineminus">-</span>
<a href="#l1.8014"></a><span id="l1.8014" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetSortType(nsMsgViewSortTypeValue *aSortType)</span>
<a href="#l1.8015"></a><span id="l1.8015" class="difflineminus">-{</span>
<a href="#l1.8016"></a><span id="l1.8016" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aSortType);</span>
<a href="#l1.8017"></a><span id="l1.8017" class="difflineminus">-    *aSortType = m_sortType;</span>
<a href="#l1.8018"></a><span id="l1.8018" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.8019"></a><span id="l1.8019" class="difflineminus">-}</span>
<a href="#l1.8020"></a><span id="l1.8020" class="difflineminus">-</span>
<a href="#l1.8021"></a><span id="l1.8021" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::SetSortType(nsMsgViewSortTypeValue aSortType)</span>
<a href="#l1.8022"></a><span id="l1.8022" class="difflineminus">-{</span>
<a href="#l1.8023"></a><span id="l1.8023" class="difflineminus">-    m_sortType = aSortType;</span>
<a href="#l1.8024"></a><span id="l1.8024" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.8025"></a><span id="l1.8025" class="difflineminus">-}</span>
<a href="#l1.8026"></a><span id="l1.8026" class="difflineminus">-</span>
<a href="#l1.8027"></a><span id="l1.8027" class="difflineminus">-</span>
<a href="#l1.8028"></a><span id="l1.8028" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetViewType(nsMsgViewTypeValue *aViewType)</span>
<a href="#l1.8029"></a><span id="l1.8029" class="difflineminus">-{</span>
<a href="#l1.8030"></a><span id="l1.8030" class="difflineminus">-    NS_ERROR(&quot;you should be overriding this&quot;);</span>
<a href="#l1.8031"></a><span id="l1.8031" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.8032"></a><span id="l1.8032" class="difflineminus">-}</span>
<a href="#l1.8033"></a><span id="l1.8033" class="difflineminus">-</span>
<a href="#l1.8034"></a><span id="l1.8034" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetSecondarySortOrder(nsMsgViewSortOrderValue *aSortOrder)</span>
<a href="#l1.8035"></a><span id="l1.8035" class="difflineminus">-{</span>
<a href="#l1.8036"></a><span id="l1.8036" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aSortOrder);</span>
<a href="#l1.8037"></a><span id="l1.8037" class="difflineminus">-    *aSortOrder = m_secondarySortOrder;</span>
<a href="#l1.8038"></a><span id="l1.8038" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.8039"></a><span id="l1.8039" class="difflineminus">-}</span>
<a href="#l1.8040"></a><span id="l1.8040" class="difflineminus">-</span>
<a href="#l1.8041"></a><span id="l1.8041" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::SetSecondarySortOrder(nsMsgViewSortOrderValue aSortOrder)</span>
<a href="#l1.8042"></a><span id="l1.8042" class="difflineminus">-{</span>
<a href="#l1.8043"></a><span id="l1.8043" class="difflineminus">-    m_secondarySortOrder = aSortOrder;</span>
<a href="#l1.8044"></a><span id="l1.8044" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.8045"></a><span id="l1.8045" class="difflineminus">-}</span>
<a href="#l1.8046"></a><span id="l1.8046" class="difflineminus">-</span>
<a href="#l1.8047"></a><span id="l1.8047" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetSecondarySortType(nsMsgViewSortTypeValue *aSortType)</span>
<a href="#l1.8048"></a><span id="l1.8048" class="difflineminus">-{</span>
<a href="#l1.8049"></a><span id="l1.8049" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aSortType);</span>
<a href="#l1.8050"></a><span id="l1.8050" class="difflineminus">-    *aSortType = m_secondarySort;</span>
<a href="#l1.8051"></a><span id="l1.8051" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.8052"></a><span id="l1.8052" class="difflineminus">-}</span>
<a href="#l1.8053"></a><span id="l1.8053" class="difflineminus">-</span>
<a href="#l1.8054"></a><span id="l1.8054" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::SetSecondarySortType(nsMsgViewSortTypeValue aSortType)</span>
<a href="#l1.8055"></a><span id="l1.8055" class="difflineminus">-{</span>
<a href="#l1.8056"></a><span id="l1.8056" class="difflineminus">-    m_secondarySort = aSortType;</span>
<a href="#l1.8057"></a><span id="l1.8057" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.8058"></a><span id="l1.8058" class="difflineminus">-}</span>
<a href="#l1.8059"></a><span id="l1.8059" class="difflineminus">-</span>
<a href="#l1.8060"></a><span id="l1.8060" class="difflineminus">-nsresult nsMsgDBView::PersistFolderInfo(nsIDBFolderInfo **dbFolderInfo)</span>
<a href="#l1.8061"></a><span id="l1.8061" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.8062"></a><span id="l1.8062" class="difflineplus">+nsMsgDBView::GetSortOrder(nsMsgViewSortOrderValue *aSortOrder)</span>
<a href="#l1.8063"></a><span id="l1.8063" class="difflineplus">+{</span>
<a href="#l1.8064"></a><span id="l1.8064" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSortOrder);</span>
<a href="#l1.8065"></a><span id="l1.8065" class="difflineplus">+  *aSortOrder = m_sortOrder;</span>
<a href="#l1.8066"></a><span id="l1.8066" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.8067"></a><span id="l1.8067" class="difflineplus">+}</span>
<a href="#l1.8068"></a><span id="l1.8068" class="difflineplus">+</span>
<a href="#l1.8069"></a><span id="l1.8069" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.8070"></a><span id="l1.8070" class="difflineplus">+nsMsgDBView::GetSortType(nsMsgViewSortTypeValue *aSortType)</span>
<a href="#l1.8071"></a><span id="l1.8071" class="difflineplus">+{</span>
<a href="#l1.8072"></a><span id="l1.8072" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSortType);</span>
<a href="#l1.8073"></a><span id="l1.8073" class="difflineplus">+  *aSortType = m_sortType;</span>
<a href="#l1.8074"></a><span id="l1.8074" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.8075"></a><span id="l1.8075" class="difflineplus">+}</span>
<a href="#l1.8076"></a><span id="l1.8076" class="difflineplus">+</span>
<a href="#l1.8077"></a><span id="l1.8077" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.8078"></a><span id="l1.8078" class="difflineplus">+nsMsgDBView::SetSortType(nsMsgViewSortTypeValue aSortType)</span>
<a href="#l1.8079"></a><span id="l1.8079" class="difflineplus">+{</span>
<a href="#l1.8080"></a><span id="l1.8080" class="difflineplus">+  m_sortType = aSortType;</span>
<a href="#l1.8081"></a><span id="l1.8081" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.8082"></a><span id="l1.8082" class="difflineplus">+}</span>
<a href="#l1.8083"></a><span id="l1.8083" class="difflineplus">+</span>
<a href="#l1.8084"></a><span id="l1.8084" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.8085"></a><span id="l1.8085" class="difflineplus">+nsMsgDBView::GetViewType(nsMsgViewTypeValue *aViewType)</span>
<a href="#l1.8086"></a><span id="l1.8086" class="difflineplus">+{</span>
<a href="#l1.8087"></a><span id="l1.8087" class="difflineplus">+  NS_ERROR(&quot;you should be overriding this&quot;);</span>
<a href="#l1.8088"></a><span id="l1.8088" class="difflineplus">+  return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.8089"></a><span id="l1.8089" class="difflineplus">+}</span>
<a href="#l1.8090"></a><span id="l1.8090" class="difflineplus">+</span>
<a href="#l1.8091"></a><span id="l1.8091" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.8092"></a><span id="l1.8092" class="difflineplus">+nsMsgDBView::GetSecondarySortOrder(nsMsgViewSortOrderValue *aSortOrder)</span>
<a href="#l1.8093"></a><span id="l1.8093" class="difflineplus">+{</span>
<a href="#l1.8094"></a><span id="l1.8094" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSortOrder);</span>
<a href="#l1.8095"></a><span id="l1.8095" class="difflineplus">+  *aSortOrder = m_secondarySortOrder;</span>
<a href="#l1.8096"></a><span id="l1.8096" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.8097"></a><span id="l1.8097" class="difflineplus">+}</span>
<a href="#l1.8098"></a><span id="l1.8098" class="difflineplus">+</span>
<a href="#l1.8099"></a><span id="l1.8099" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.8100"></a><span id="l1.8100" class="difflineplus">+nsMsgDBView::SetSecondarySortOrder(nsMsgViewSortOrderValue aSortOrder)</span>
<a href="#l1.8101"></a><span id="l1.8101" class="difflineplus">+{</span>
<a href="#l1.8102"></a><span id="l1.8102" class="difflineplus">+  m_secondarySortOrder = aSortOrder;</span>
<a href="#l1.8103"></a><span id="l1.8103" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.8104"></a><span id="l1.8104" class="difflineplus">+}</span>
<a href="#l1.8105"></a><span id="l1.8105" class="difflineplus">+</span>
<a href="#l1.8106"></a><span id="l1.8106" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.8107"></a><span id="l1.8107" class="difflineplus">+nsMsgDBView::GetSecondarySortType(nsMsgViewSortTypeValue *aSortType)</span>
<a href="#l1.8108"></a><span id="l1.8108" class="difflineplus">+{</span>
<a href="#l1.8109"></a><span id="l1.8109" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSortType);</span>
<a href="#l1.8110"></a><span id="l1.8110" class="difflineplus">+  *aSortType = m_secondarySort;</span>
<a href="#l1.8111"></a><span id="l1.8111" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.8112"></a><span id="l1.8112" class="difflineplus">+}</span>
<a href="#l1.8113"></a><span id="l1.8113" class="difflineplus">+</span>
<a href="#l1.8114"></a><span id="l1.8114" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.8115"></a><span id="l1.8115" class="difflineplus">+nsMsgDBView::SetSecondarySortType(nsMsgViewSortTypeValue aSortType)</span>
<a href="#l1.8116"></a><span id="l1.8116" class="difflineplus">+{</span>
<a href="#l1.8117"></a><span id="l1.8117" class="difflineplus">+  m_secondarySort = aSortType;</span>
<a href="#l1.8118"></a><span id="l1.8118" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.8119"></a><span id="l1.8119" class="difflineplus">+}</span>
<a href="#l1.8120"></a><span id="l1.8120" class="difflineplus">+</span>
<a href="#l1.8121"></a><span id="l1.8121" class="difflineplus">+nsresult</span>
<a href="#l1.8122"></a><span id="l1.8122" class="difflineplus">+nsMsgDBView::PersistFolderInfo(nsIDBFolderInfo **dbFolderInfo)</span>
<a href="#l1.8123"></a><span id="l1.8123"> {</span>
<a href="#l1.8124"></a><span id="l1.8124">   nsresult rv = m_db-&gt;GetDBFolderInfo(dbFolderInfo);</span>
<a href="#l1.8125"></a><span id="l1.8125">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8126"></a><span id="l1.8126" class="difflineminus">-  // save off sort type and order, view type and flags</span>
<a href="#l1.8127"></a><span id="l1.8127" class="difflineplus">+  // Save off sort type and order, view type and flags.</span>
<a href="#l1.8128"></a><span id="l1.8128">   (*dbFolderInfo)-&gt;SetSortType(m_sortType);</span>
<a href="#l1.8129"></a><span id="l1.8129">   (*dbFolderInfo)-&gt;SetSortOrder(m_sortOrder);</span>
<a href="#l1.8130"></a><span id="l1.8130">   (*dbFolderInfo)-&gt;SetViewFlags(m_viewFlags);</span>
<a href="#l1.8131"></a><span id="l1.8131">   nsMsgViewTypeValue viewType;</span>
<a href="#l1.8132"></a><span id="l1.8132">   GetViewType(&amp;viewType);</span>
<a href="#l1.8133"></a><span id="l1.8133">   (*dbFolderInfo)-&gt;SetViewType(viewType);</span>
<a href="#l1.8134"></a><span id="l1.8134">   return rv;</span>
<a href="#l1.8135"></a><span id="l1.8135"> }</span>
<a href="#l1.8136"></a><span id="l1.8136"> </span>
<a href="#l1.8137"></a><span id="l1.8137" class="difflineminus">-</span>
<a href="#l1.8138"></a><span id="l1.8138" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetViewFlags(nsMsgViewFlagsTypeValue *aViewFlags)</span>
<a href="#l1.8139"></a><span id="l1.8139" class="difflineminus">-{</span>
<a href="#l1.8140"></a><span id="l1.8140" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aViewFlags);</span>
<a href="#l1.8141"></a><span id="l1.8141" class="difflineminus">-    *aViewFlags = m_viewFlags;</span>
<a href="#l1.8142"></a><span id="l1.8142" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.8143"></a><span id="l1.8143" class="difflineminus">-}</span>
<a href="#l1.8144"></a><span id="l1.8144" class="difflineminus">-</span>
<a href="#l1.8145"></a><span id="l1.8145" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::SetViewFlags(nsMsgViewFlagsTypeValue aViewFlags)</span>
<a href="#l1.8146"></a><span id="l1.8146" class="difflineminus">-{</span>
<a href="#l1.8147"></a><span id="l1.8147" class="difflineminus">-  // if we're turning off threaded display, we need to expand all so that all</span>
<a href="#l1.8148"></a><span id="l1.8148" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.8149"></a><span id="l1.8149" class="difflineplus">+nsMsgDBView::GetViewFlags(nsMsgViewFlagsTypeValue *aViewFlags)</span>
<a href="#l1.8150"></a><span id="l1.8150" class="difflineplus">+{</span>
<a href="#l1.8151"></a><span id="l1.8151" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aViewFlags);</span>
<a href="#l1.8152"></a><span id="l1.8152" class="difflineplus">+  *aViewFlags = m_viewFlags;</span>
<a href="#l1.8153"></a><span id="l1.8153" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.8154"></a><span id="l1.8154" class="difflineplus">+}</span>
<a href="#l1.8155"></a><span id="l1.8155" class="difflineplus">+</span>
<a href="#l1.8156"></a><span id="l1.8156" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.8157"></a><span id="l1.8157" class="difflineplus">+nsMsgDBView::SetViewFlags(nsMsgViewFlagsTypeValue aViewFlags)</span>
<a href="#l1.8158"></a><span id="l1.8158" class="difflineplus">+{</span>
<a href="#l1.8159"></a><span id="l1.8159" class="difflineplus">+  // If we're turning off threaded display, we need to expand all so that all</span>
<a href="#l1.8160"></a><span id="l1.8160">   // messages will be displayed.</span>
<a href="#l1.8161"></a><span id="l1.8161" class="difflineminus">-  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay &amp;&amp; ! (aViewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.8162"></a><span id="l1.8162" class="difflineplus">+  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay &amp;&amp;</span>
<a href="#l1.8163"></a><span id="l1.8163" class="difflineplus">+      !(aViewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.8164"></a><span id="l1.8164">   {</span>
<a href="#l1.8165"></a><span id="l1.8165">     ExpandAll();</span>
<a href="#l1.8166"></a><span id="l1.8166" class="difflineminus">-    m_sortValid = false; // invalidate the sort so sorting will do something</span>
<a href="#l1.8167"></a><span id="l1.8167" class="difflineminus">-  }</span>
<a href="#l1.8168"></a><span id="l1.8168" class="difflineplus">+    // Invalidate the sort so sorting will do something.</span>
<a href="#l1.8169"></a><span id="l1.8169" class="difflineplus">+    m_sortValid = false;</span>
<a href="#l1.8170"></a><span id="l1.8170" class="difflineplus">+  }</span>
<a href="#l1.8171"></a><span id="l1.8171" class="difflineplus">+</span>
<a href="#l1.8172"></a><span id="l1.8172">   m_viewFlags = aViewFlags;</span>
<a href="#l1.8173"></a><span id="l1.8173"> </span>
<a href="#l1.8174"></a><span id="l1.8174">   if (m_viewFolder)</span>
<a href="#l1.8175"></a><span id="l1.8175">   {</span>
<a href="#l1.8176"></a><span id="l1.8176">     nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.8177"></a><span id="l1.8177">     nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l1.8178"></a><span id="l1.8178" class="difflineminus">-    nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l1.8179"></a><span id="l1.8179" class="difflineplus">+    nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo),</span>
<a href="#l1.8180"></a><span id="l1.8180" class="difflineplus">+                                                     getter_AddRefs(db));</span>
<a href="#l1.8181"></a><span id="l1.8181">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.8182"></a><span id="l1.8182">     return folderInfo-&gt;SetViewFlags(aViewFlags);</span>
<a href="#l1.8183"></a><span id="l1.8183">   }</span>
<a href="#l1.8184"></a><span id="l1.8184">   else</span>
<a href="#l1.8185"></a><span id="l1.8185">     return NS_OK;</span>
<a href="#l1.8186"></a><span id="l1.8186"> }</span>
<a href="#l1.8187"></a><span id="l1.8187"> </span>
<a href="#l1.8188"></a><span id="l1.8188" class="difflineminus">-nsresult nsMsgDBView::MarkThreadOfMsgRead(nsMsgKey msgId, nsMsgViewIndex msgIndex, nsTArray&lt;nsMsgKey&gt; &amp;idsMarkedRead, bool bRead)</span>
<a href="#l1.8189"></a><span id="l1.8189" class="difflineminus">-{</span>
<a href="#l1.8190"></a><span id="l1.8190" class="difflineminus">-    nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l1.8191"></a><span id="l1.8191" class="difflineminus">-    nsresult rv = GetThreadContainingIndex(msgIndex, getter_AddRefs(threadHdr));</span>
<a href="#l1.8192"></a><span id="l1.8192" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8193"></a><span id="l1.8193" class="difflineminus">-</span>
<a href="#l1.8194"></a><span id="l1.8194" class="difflineminus">-    nsMsgViewIndex threadIndex;</span>
<a href="#l1.8195"></a><span id="l1.8195" class="difflineminus">-</span>
<a href="#l1.8196"></a><span id="l1.8196" class="difflineminus">-    NS_ASSERTION(threadHdr, &quot;threadHdr is null&quot;);</span>
<a href="#l1.8197"></a><span id="l1.8197" class="difflineminus">-    if (!threadHdr)</span>
<a href="#l1.8198"></a><span id="l1.8198" class="difflineminus">-        return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.8199"></a><span id="l1.8199" class="difflineminus">-</span>
<a href="#l1.8200"></a><span id="l1.8200" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBHdr&gt; firstHdr;</span>
<a href="#l1.8201"></a><span id="l1.8201" class="difflineminus">-    rv = threadHdr-&gt;GetChildHdrAt(0, getter_AddRefs(firstHdr));</span>
<a href="#l1.8202"></a><span id="l1.8202" class="difflineplus">+nsresult</span>
<a href="#l1.8203"></a><span id="l1.8203" class="difflineplus">+nsMsgDBView::MarkThreadOfMsgRead(nsMsgKey msgId,</span>
<a href="#l1.8204"></a><span id="l1.8204" class="difflineplus">+                                 nsMsgViewIndex msgIndex,</span>
<a href="#l1.8205"></a><span id="l1.8205" class="difflineplus">+                                 nsTArray&lt;nsMsgKey&gt; &amp;idsMarkedRead,</span>
<a href="#l1.8206"></a><span id="l1.8206" class="difflineplus">+                                 bool bRead)</span>
<a href="#l1.8207"></a><span id="l1.8207" class="difflineplus">+{</span>
<a href="#l1.8208"></a><span id="l1.8208" class="difflineplus">+  nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l1.8209"></a><span id="l1.8209" class="difflineplus">+  nsresult rv = GetThreadContainingIndex(msgIndex, getter_AddRefs(threadHdr));</span>
<a href="#l1.8210"></a><span id="l1.8210" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8211"></a><span id="l1.8211" class="difflineplus">+</span>
<a href="#l1.8212"></a><span id="l1.8212" class="difflineplus">+  nsMsgViewIndex threadIndex;</span>
<a href="#l1.8213"></a><span id="l1.8213" class="difflineplus">+</span>
<a href="#l1.8214"></a><span id="l1.8214" class="difflineplus">+  NS_ASSERTION(threadHdr, &quot;threadHdr is null&quot;);</span>
<a href="#l1.8215"></a><span id="l1.8215" class="difflineplus">+  if (!threadHdr)</span>
<a href="#l1.8216"></a><span id="l1.8216" class="difflineplus">+    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.8217"></a><span id="l1.8217" class="difflineplus">+</span>
<a href="#l1.8218"></a><span id="l1.8218" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; firstHdr;</span>
<a href="#l1.8219"></a><span id="l1.8219" class="difflineplus">+  rv = threadHdr-&gt;GetChildHdrAt(0, getter_AddRefs(firstHdr));</span>
<a href="#l1.8220"></a><span id="l1.8220" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8221"></a><span id="l1.8221" class="difflineplus">+  nsMsgKey firstHdrId;</span>
<a href="#l1.8222"></a><span id="l1.8222" class="difflineplus">+  firstHdr-&gt;GetMessageKey(&amp;firstHdrId);</span>
<a href="#l1.8223"></a><span id="l1.8223" class="difflineplus">+  if (msgId != firstHdrId)</span>
<a href="#l1.8224"></a><span id="l1.8224" class="difflineplus">+    threadIndex = GetIndexOfFirstDisplayedKeyInThread(threadHdr);</span>
<a href="#l1.8225"></a><span id="l1.8225" class="difflineplus">+  else</span>
<a href="#l1.8226"></a><span id="l1.8226" class="difflineplus">+    threadIndex = msgIndex;</span>
<a href="#l1.8227"></a><span id="l1.8227" class="difflineplus">+</span>
<a href="#l1.8228"></a><span id="l1.8228" class="difflineplus">+  return MarkThreadRead(threadHdr, threadIndex, idsMarkedRead, bRead);</span>
<a href="#l1.8229"></a><span id="l1.8229" class="difflineplus">+}</span>
<a href="#l1.8230"></a><span id="l1.8230" class="difflineplus">+</span>
<a href="#l1.8231"></a><span id="l1.8231" class="difflineplus">+nsresult</span>
<a href="#l1.8232"></a><span id="l1.8232" class="difflineplus">+nsMsgDBView::MarkThreadRead(nsIMsgThread *threadHdr,</span>
<a href="#l1.8233"></a><span id="l1.8233" class="difflineplus">+                            nsMsgViewIndex threadIndex,</span>
<a href="#l1.8234"></a><span id="l1.8234" class="difflineplus">+                            nsTArray&lt;nsMsgKey&gt; &amp;idsMarkedRead,</span>
<a href="#l1.8235"></a><span id="l1.8235" class="difflineplus">+                            bool bRead)</span>
<a href="#l1.8236"></a><span id="l1.8236" class="difflineplus">+{</span>
<a href="#l1.8237"></a><span id="l1.8237" class="difflineplus">+  uint32_t numChildren;</span>
<a href="#l1.8238"></a><span id="l1.8238" class="difflineplus">+  threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l1.8239"></a><span id="l1.8239" class="difflineplus">+  idsMarkedRead.SetCapacity(numChildren);</span>
<a href="#l1.8240"></a><span id="l1.8240" class="difflineplus">+  for (int32_t childIndex = 0; childIndex &lt; (int32_t) numChildren ; childIndex++)</span>
<a href="#l1.8241"></a><span id="l1.8241" class="difflineplus">+  {</span>
<a href="#l1.8242"></a><span id="l1.8242" class="difflineplus">+    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.8243"></a><span id="l1.8243" class="difflineplus">+    threadHdr-&gt;GetChildHdrAt(childIndex, getter_AddRefs(msgHdr));</span>
<a href="#l1.8244"></a><span id="l1.8244" class="difflineplus">+    NS_ASSERTION(msgHdr, &quot;msgHdr is null&quot;);</span>
<a href="#l1.8245"></a><span id="l1.8245" class="difflineplus">+    if (!msgHdr)</span>
<a href="#l1.8246"></a><span id="l1.8246" class="difflineplus">+      continue;</span>
<a href="#l1.8247"></a><span id="l1.8247" class="difflineplus">+</span>
<a href="#l1.8248"></a><span id="l1.8248" class="difflineplus">+    bool isRead;</span>
<a href="#l1.8249"></a><span id="l1.8249" class="difflineplus">+    nsMsgKey hdrMsgId;</span>
<a href="#l1.8250"></a><span id="l1.8250" class="difflineplus">+    msgHdr-&gt;GetMessageKey(&amp;hdrMsgId);</span>
<a href="#l1.8251"></a><span id="l1.8251" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.8252"></a><span id="l1.8252" class="difflineplus">+    nsresult rv = GetDBForHeader(msgHdr, getter_AddRefs(db));</span>
<a href="#l1.8253"></a><span id="l1.8253">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8254"></a><span id="l1.8254" class="difflineminus">-    nsMsgKey firstHdrId;</span>
<a href="#l1.8255"></a><span id="l1.8255" class="difflineminus">-    firstHdr-&gt;GetMessageKey(&amp;firstHdrId);</span>
<a href="#l1.8256"></a><span id="l1.8256" class="difflineminus">-    if (msgId != firstHdrId)</span>
<a href="#l1.8257"></a><span id="l1.8257" class="difflineminus">-        threadIndex = GetIndexOfFirstDisplayedKeyInThread(threadHdr);</span>
<a href="#l1.8258"></a><span id="l1.8258" class="difflineminus">-    else</span>
<a href="#l1.8259"></a><span id="l1.8259" class="difflineminus">-        threadIndex = msgIndex;</span>
<a href="#l1.8260"></a><span id="l1.8260" class="difflineminus">-    return MarkThreadRead(threadHdr, threadIndex, idsMarkedRead, bRead);</span>
<a href="#l1.8261"></a><span id="l1.8261" class="difflineminus">-}</span>
<a href="#l1.8262"></a><span id="l1.8262" class="difflineminus">-</span>
<a href="#l1.8263"></a><span id="l1.8263" class="difflineminus">-nsresult nsMsgDBView::MarkThreadRead(nsIMsgThread *threadHdr, nsMsgViewIndex threadIndex, nsTArray&lt;nsMsgKey&gt; &amp;idsMarkedRead, bool bRead)</span>
<a href="#l1.8264"></a><span id="l1.8264" class="difflineminus">-{</span>
<a href="#l1.8265"></a><span id="l1.8265" class="difflineminus">-    uint32_t numChildren;</span>
<a href="#l1.8266"></a><span id="l1.8266" class="difflineminus">-    threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l1.8267"></a><span id="l1.8267" class="difflineminus">-    idsMarkedRead.SetCapacity(numChildren);</span>
<a href="#l1.8268"></a><span id="l1.8268" class="difflineminus">-    for (int32_t childIndex = 0; childIndex &lt; (int32_t) numChildren ; childIndex++)</span>
<a href="#l1.8269"></a><span id="l1.8269" class="difflineminus">-    {</span>
<a href="#l1.8270"></a><span id="l1.8270" class="difflineminus">-        nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.8271"></a><span id="l1.8271" class="difflineminus">-        threadHdr-&gt;GetChildHdrAt(childIndex, getter_AddRefs(msgHdr));</span>
<a href="#l1.8272"></a><span id="l1.8272" class="difflineminus">-        NS_ASSERTION(msgHdr, &quot;msgHdr is null&quot;);</span>
<a href="#l1.8273"></a><span id="l1.8273" class="difflineminus">-        if (!msgHdr)</span>
<a href="#l1.8274"></a><span id="l1.8274" class="difflineminus">-            continue;</span>
<a href="#l1.8275"></a><span id="l1.8275" class="difflineminus">-</span>
<a href="#l1.8276"></a><span id="l1.8276" class="difflineminus">-        bool isRead;</span>
<a href="#l1.8277"></a><span id="l1.8277" class="difflineminus">-</span>
<a href="#l1.8278"></a><span id="l1.8278" class="difflineminus">-        nsMsgKey hdrMsgId;</span>
<a href="#l1.8279"></a><span id="l1.8279" class="difflineminus">-        msgHdr-&gt;GetMessageKey(&amp;hdrMsgId);</span>
<a href="#l1.8280"></a><span id="l1.8280" class="difflineminus">-        nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.8281"></a><span id="l1.8281" class="difflineminus">-        nsresult rv = GetDBForHeader(msgHdr, getter_AddRefs(db));</span>
<a href="#l1.8282"></a><span id="l1.8282" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8283"></a><span id="l1.8283" class="difflineminus">-        db-&gt;IsRead(hdrMsgId, &amp;isRead);</span>
<a href="#l1.8284"></a><span id="l1.8284" class="difflineminus">-</span>
<a href="#l1.8285"></a><span id="l1.8285" class="difflineminus">-        if (isRead != bRead)</span>
<a href="#l1.8286"></a><span id="l1.8286" class="difflineminus">-        {</span>
<a href="#l1.8287"></a><span id="l1.8287" class="difflineminus">-            // MarkHdrRead will change the unread count on the thread</span>
<a href="#l1.8288"></a><span id="l1.8288" class="difflineminus">-            db-&gt;MarkHdrRead(msgHdr, bRead, nullptr);</span>
<a href="#l1.8289"></a><span id="l1.8289" class="difflineminus">-            // insert at the front.  should we insert at the end?</span>
<a href="#l1.8290"></a><span id="l1.8290" class="difflineminus">-            idsMarkedRead.InsertElementAt(0, hdrMsgId);</span>
<a href="#l1.8291"></a><span id="l1.8291" class="difflineminus">-        }</span>
<a href="#l1.8292"></a><span id="l1.8292" class="difflineminus">-    }</span>
<a href="#l1.8293"></a><span id="l1.8293" class="difflineminus">-</span>
<a href="#l1.8294"></a><span id="l1.8294" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.8295"></a><span id="l1.8295" class="difflineminus">-}</span>
<a href="#l1.8296"></a><span id="l1.8296" class="difflineminus">-</span>
<a href="#l1.8297"></a><span id="l1.8297" class="difflineminus">-bool nsMsgDBView::AdjustReadFlag(nsIMsgDBHdr *msgHdr, uint32_t *msgFlags)</span>
<a href="#l1.8298"></a><span id="l1.8298" class="difflineminus">-{</span>
<a href="#l1.8299"></a><span id="l1.8299" class="difflineminus">-  // if we're a cross-folder view, just bail on this.</span>
<a href="#l1.8300"></a><span id="l1.8300" class="difflineplus">+    db-&gt;IsRead(hdrMsgId, &amp;isRead);</span>
<a href="#l1.8301"></a><span id="l1.8301" class="difflineplus">+</span>
<a href="#l1.8302"></a><span id="l1.8302" class="difflineplus">+    if (isRead != bRead)</span>
<a href="#l1.8303"></a><span id="l1.8303" class="difflineplus">+    {</span>
<a href="#l1.8304"></a><span id="l1.8304" class="difflineplus">+      // MarkHdrRead will change the unread count on the thread.</span>
<a href="#l1.8305"></a><span id="l1.8305" class="difflineplus">+      db-&gt;MarkHdrRead(msgHdr, bRead, nullptr);</span>
<a href="#l1.8306"></a><span id="l1.8306" class="difflineplus">+      // Insert at the front. Should we insert at the end?</span>
<a href="#l1.8307"></a><span id="l1.8307" class="difflineplus">+      idsMarkedRead.InsertElementAt(0, hdrMsgId);</span>
<a href="#l1.8308"></a><span id="l1.8308" class="difflineplus">+    }</span>
<a href="#l1.8309"></a><span id="l1.8309" class="difflineplus">+  }</span>
<a href="#l1.8310"></a><span id="l1.8310" class="difflineplus">+</span>
<a href="#l1.8311"></a><span id="l1.8311" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.8312"></a><span id="l1.8312" class="difflineplus">+}</span>
<a href="#l1.8313"></a><span id="l1.8313" class="difflineplus">+</span>
<a href="#l1.8314"></a><span id="l1.8314" class="difflineplus">+bool</span>
<a href="#l1.8315"></a><span id="l1.8315" class="difflineplus">+nsMsgDBView::AdjustReadFlag(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.8316"></a><span id="l1.8316" class="difflineplus">+                            uint32_t *msgFlags)</span>
<a href="#l1.8317"></a><span id="l1.8317" class="difflineplus">+{</span>
<a href="#l1.8318"></a><span id="l1.8318" class="difflineplus">+  // If we're a cross-folder view, just bail on this.</span>
<a href="#l1.8319"></a><span id="l1.8319">   if (GetFolders())</span>
<a href="#l1.8320"></a><span id="l1.8320">     return *msgFlags &amp; nsMsgMessageFlags::Read;</span>
<a href="#l1.8321"></a><span id="l1.8321" class="difflineplus">+</span>
<a href="#l1.8322"></a><span id="l1.8322">   bool isRead = false;</span>
<a href="#l1.8323"></a><span id="l1.8323">   nsMsgKey msgKey;</span>
<a href="#l1.8324"></a><span id="l1.8324">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.8325"></a><span id="l1.8325">   m_db-&gt;IsRead(msgKey, &amp;isRead);</span>
<a href="#l1.8326"></a><span id="l1.8326" class="difflineminus">-    // just make sure flag is right in db.</span>
<a href="#l1.8327"></a><span id="l1.8327" class="difflineplus">+  // Just make sure flag is right in db.</span>
<a href="#l1.8328"></a><span id="l1.8328"> #ifdef DEBUG_David_Bienvenu</span>
<a href="#l1.8329"></a><span id="l1.8329" class="difflineminus">-  NS_ASSERTION(isRead == ((*msgFlags &amp; nsMsgMessageFlags::Read) != 0), &quot;msgFlags out of sync&quot;);</span>
<a href="#l1.8330"></a><span id="l1.8330" class="difflineplus">+  NS_ASSERTION(isRead == ((*msgFlags &amp; nsMsgMessageFlags::Read) != 0),</span>
<a href="#l1.8331"></a><span id="l1.8331" class="difflineplus">+               &quot;msgFlags out of sync&quot;);</span>
<a href="#l1.8332"></a><span id="l1.8332"> #endif</span>
<a href="#l1.8333"></a><span id="l1.8333">   if (isRead)</span>
<a href="#l1.8334"></a><span id="l1.8334">     *msgFlags |= nsMsgMessageFlags::Read;</span>
<a href="#l1.8335"></a><span id="l1.8335">   else</span>
<a href="#l1.8336"></a><span id="l1.8336">     *msgFlags &amp;= ~nsMsgMessageFlags::Read;</span>
<a href="#l1.8337"></a><span id="l1.8337" class="difflineplus">+</span>
<a href="#l1.8338"></a><span id="l1.8338">   m_db-&gt;MarkHdrRead(msgHdr, isRead, nullptr);</span>
<a href="#l1.8339"></a><span id="l1.8339">   return isRead;</span>
<a href="#l1.8340"></a><span id="l1.8340"> }</span>
<a href="#l1.8341"></a><span id="l1.8341"> </span>
<a href="#l1.8342"></a><span id="l1.8342"> // Starting from startIndex, performs the passed in navigation, including</span>
<a href="#l1.8343"></a><span id="l1.8343"> // any marking read needed, and returns the resultId and resultIndex of the</span>
<a href="#l1.8344"></a><span id="l1.8344"> // destination of the navigation.  If no message is found in the view,</span>
<a href="#l1.8345"></a><span id="l1.8345"> // it returns a resultId of nsMsgKey_None and an resultIndex of nsMsgViewIndex_None.</span>
<a href="#l1.8346"></a><span id="l1.8346" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::ViewNavigate(nsMsgNavigationTypeValue motion, nsMsgKey *pResultKey, nsMsgViewIndex *pResultIndex, nsMsgViewIndex *pThreadIndex, bool wrap)</span>
<a href="#l1.8347"></a><span id="l1.8347" class="difflineminus">-{</span>
<a href="#l1.8348"></a><span id="l1.8348" class="difflineminus">-    NS_ENSURE_ARG_POINTER(pResultKey);</span>
<a href="#l1.8349"></a><span id="l1.8349" class="difflineminus">-    NS_ENSURE_ARG_POINTER(pResultIndex);</span>
<a href="#l1.8350"></a><span id="l1.8350" class="difflineminus">-    NS_ENSURE_ARG_POINTER(pThreadIndex);</span>
<a href="#l1.8351"></a><span id="l1.8351" class="difflineminus">-</span>
<a href="#l1.8352"></a><span id="l1.8352" class="difflineminus">-    int32_t currentIndex;</span>
<a href="#l1.8353"></a><span id="l1.8353" class="difflineminus">-    nsMsgViewIndex startIndex;</span>
<a href="#l1.8354"></a><span id="l1.8354" class="difflineminus">-</span>
<a href="#l1.8355"></a><span id="l1.8355" class="difflineminus">-    if (!mTreeSelection) // we must be in stand alone message mode</span>
<a href="#l1.8356"></a><span id="l1.8356" class="difflineminus">-    {</span>
<a href="#l1.8357"></a><span id="l1.8357" class="difflineminus">-      currentIndex = FindViewIndex(m_currentlyDisplayedMsgKey);</span>
<a href="#l1.8358"></a><span id="l1.8358" class="difflineminus">-    }</span>
<a href="#l1.8359"></a><span id="l1.8359" class="difflineminus">-    else</span>
<a href="#l1.8360"></a><span id="l1.8360" class="difflineminus">-    {</span>
<a href="#l1.8361"></a><span id="l1.8361" class="difflineminus">-      nsresult rv = mTreeSelection-&gt;GetCurrentIndex(&amp;currentIndex);</span>
<a href="#l1.8362"></a><span id="l1.8362" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.8363"></a><span id="l1.8363" class="difflineplus">+nsMsgDBView::ViewNavigate(nsMsgNavigationTypeValue motion,</span>
<a href="#l1.8364"></a><span id="l1.8364" class="difflineplus">+                          nsMsgKey *pResultKey,</span>
<a href="#l1.8365"></a><span id="l1.8365" class="difflineplus">+                          nsMsgViewIndex *pResultIndex,</span>
<a href="#l1.8366"></a><span id="l1.8366" class="difflineplus">+                          nsMsgViewIndex *pThreadIndex,</span>
<a href="#l1.8367"></a><span id="l1.8367" class="difflineplus">+                          bool wrap)</span>
<a href="#l1.8368"></a><span id="l1.8368" class="difflineplus">+{</span>
<a href="#l1.8369"></a><span id="l1.8369" class="difflineplus">+  NS_ENSURE_ARG_POINTER(pResultKey);</span>
<a href="#l1.8370"></a><span id="l1.8370" class="difflineplus">+  NS_ENSURE_ARG_POINTER(pResultIndex);</span>
<a href="#l1.8371"></a><span id="l1.8371" class="difflineplus">+  NS_ENSURE_ARG_POINTER(pThreadIndex);</span>
<a href="#l1.8372"></a><span id="l1.8372" class="difflineplus">+</span>
<a href="#l1.8373"></a><span id="l1.8373" class="difflineplus">+  int32_t currentIndex;</span>
<a href="#l1.8374"></a><span id="l1.8374" class="difflineplus">+  nsMsgViewIndex startIndex;</span>
<a href="#l1.8375"></a><span id="l1.8375" class="difflineplus">+</span>
<a href="#l1.8376"></a><span id="l1.8376" class="difflineplus">+  if (!mTreeSelection)</span>
<a href="#l1.8377"></a><span id="l1.8377" class="difflineplus">+  {</span>
<a href="#l1.8378"></a><span id="l1.8378" class="difflineplus">+    // We must be in stand alone message mode.</span>
<a href="#l1.8379"></a><span id="l1.8379" class="difflineplus">+    currentIndex = FindViewIndex(m_currentlyDisplayedMsgKey);</span>
<a href="#l1.8380"></a><span id="l1.8380" class="difflineplus">+  }</span>
<a href="#l1.8381"></a><span id="l1.8381" class="difflineplus">+  else</span>
<a href="#l1.8382"></a><span id="l1.8382" class="difflineplus">+  {</span>
<a href="#l1.8383"></a><span id="l1.8383" class="difflineplus">+    nsresult rv = mTreeSelection-&gt;GetCurrentIndex(&amp;currentIndex);</span>
<a href="#l1.8384"></a><span id="l1.8384" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8385"></a><span id="l1.8385" class="difflineplus">+  }</span>
<a href="#l1.8386"></a><span id="l1.8386" class="difflineplus">+</span>
<a href="#l1.8387"></a><span id="l1.8387" class="difflineplus">+  startIndex = currentIndex;</span>
<a href="#l1.8388"></a><span id="l1.8388" class="difflineplus">+  return nsMsgDBView::NavigateFromPos(motion,</span>
<a href="#l1.8389"></a><span id="l1.8389" class="difflineplus">+                                      startIndex,</span>
<a href="#l1.8390"></a><span id="l1.8390" class="difflineplus">+                                      pResultKey,</span>
<a href="#l1.8391"></a><span id="l1.8391" class="difflineplus">+                                      pResultIndex,</span>
<a href="#l1.8392"></a><span id="l1.8392" class="difflineplus">+                                      pThreadIndex,</span>
<a href="#l1.8393"></a><span id="l1.8393" class="difflineplus">+                                      wrap);</span>
<a href="#l1.8394"></a><span id="l1.8394" class="difflineplus">+}</span>
<a href="#l1.8395"></a><span id="l1.8395" class="difflineplus">+</span>
<a href="#l1.8396"></a><span id="l1.8396" class="difflineplus">+nsresult</span>
<a href="#l1.8397"></a><span id="l1.8397" class="difflineplus">+nsMsgDBView::NavigateFromPos(nsMsgNavigationTypeValue motion,</span>
<a href="#l1.8398"></a><span id="l1.8398" class="difflineplus">+                             nsMsgViewIndex startIndex,</span>
<a href="#l1.8399"></a><span id="l1.8399" class="difflineplus">+                             nsMsgKey *pResultKey,</span>
<a href="#l1.8400"></a><span id="l1.8400" class="difflineplus">+                             nsMsgViewIndex *pResultIndex,</span>
<a href="#l1.8401"></a><span id="l1.8401" class="difflineplus">+                             nsMsgViewIndex *pThreadIndex,</span>
<a href="#l1.8402"></a><span id="l1.8402" class="difflineplus">+                             bool wrap)</span>
<a href="#l1.8403"></a><span id="l1.8403" class="difflineplus">+{</span>
<a href="#l1.8404"></a><span id="l1.8404" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l1.8405"></a><span id="l1.8405" class="difflineplus">+  nsMsgKey resultThreadKey;</span>
<a href="#l1.8406"></a><span id="l1.8406" class="difflineplus">+  nsMsgViewIndex curIndex;</span>
<a href="#l1.8407"></a><span id="l1.8407" class="difflineplus">+  nsMsgViewIndex lastIndex =</span>
<a href="#l1.8408"></a><span id="l1.8408" class="difflineplus">+    (GetSize() &gt; 0) ? (nsMsgViewIndex) GetSize() - 1 : nsMsgViewIndex_None;</span>
<a href="#l1.8409"></a><span id="l1.8409" class="difflineplus">+  nsMsgViewIndex threadIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8410"></a><span id="l1.8410" class="difflineplus">+</span>
<a href="#l1.8411"></a><span id="l1.8411" class="difflineplus">+  // If there aren't any messages in the view, bail out.</span>
<a href="#l1.8412"></a><span id="l1.8412" class="difflineplus">+  if (GetSize() &lt;= 0)</span>
<a href="#l1.8413"></a><span id="l1.8413" class="difflineplus">+  {</span>
<a href="#l1.8414"></a><span id="l1.8414" class="difflineplus">+    *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8415"></a><span id="l1.8415" class="difflineplus">+    *pResultKey = nsMsgKey_None;</span>
<a href="#l1.8416"></a><span id="l1.8416" class="difflineplus">+    return NS_OK;</span>
<a href="#l1.8417"></a><span id="l1.8417" class="difflineplus">+  }</span>
<a href="#l1.8418"></a><span id="l1.8418" class="difflineplus">+</span>
<a href="#l1.8419"></a><span id="l1.8419" class="difflineplus">+  switch (motion)</span>
<a href="#l1.8420"></a><span id="l1.8420" class="difflineplus">+  {</span>
<a href="#l1.8421"></a><span id="l1.8421" class="difflineplus">+    case nsMsgNavigationType::firstMessage:</span>
<a href="#l1.8422"></a><span id="l1.8422" class="difflineplus">+      *pResultIndex = 0;</span>
<a href="#l1.8423"></a><span id="l1.8423" class="difflineplus">+      *pResultKey = m_keys[0];</span>
<a href="#l1.8424"></a><span id="l1.8424" class="difflineplus">+      break;</span>
<a href="#l1.8425"></a><span id="l1.8425" class="difflineplus">+    case nsMsgNavigationType::nextMessage:</span>
<a href="#l1.8426"></a><span id="l1.8426" class="difflineplus">+      // Return same index and id on next on last message.</span>
<a href="#l1.8427"></a><span id="l1.8427" class="difflineplus">+      *pResultIndex = std::min(startIndex + 1, lastIndex);</span>
<a href="#l1.8428"></a><span id="l1.8428" class="difflineplus">+      *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8429"></a><span id="l1.8429" class="difflineplus">+      break;</span>
<a href="#l1.8430"></a><span id="l1.8430" class="difflineplus">+    case nsMsgNavigationType::previousMessage:</span>
<a href="#l1.8431"></a><span id="l1.8431" class="difflineplus">+      *pResultIndex =</span>
<a href="#l1.8432"></a><span id="l1.8432" class="difflineplus">+        (startIndex != nsMsgViewIndex_None &amp;&amp; startIndex &gt; 0) ? startIndex - 1 : 0;</span>
<a href="#l1.8433"></a><span id="l1.8433" class="difflineplus">+      *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8434"></a><span id="l1.8434" class="difflineplus">+      break;</span>
<a href="#l1.8435"></a><span id="l1.8435" class="difflineplus">+    case nsMsgNavigationType::lastMessage:</span>
<a href="#l1.8436"></a><span id="l1.8436" class="difflineplus">+      *pResultIndex = lastIndex;</span>
<a href="#l1.8437"></a><span id="l1.8437" class="difflineplus">+      *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8438"></a><span id="l1.8438" class="difflineplus">+      break;</span>
<a href="#l1.8439"></a><span id="l1.8439" class="difflineplus">+    case nsMsgNavigationType::firstFlagged:</span>
<a href="#l1.8440"></a><span id="l1.8440" class="difflineplus">+      rv = FindFirstFlagged(pResultIndex);</span>
<a href="#l1.8441"></a><span id="l1.8441" class="difflineplus">+      if (IsValidIndex(*pResultIndex))</span>
<a href="#l1.8442"></a><span id="l1.8442" class="difflineplus">+        *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8443"></a><span id="l1.8443" class="difflineplus">+</span>
<a href="#l1.8444"></a><span id="l1.8444" class="difflineplus">+      break;</span>
<a href="#l1.8445"></a><span id="l1.8445" class="difflineplus">+    case nsMsgNavigationType::nextFlagged:</span>
<a href="#l1.8446"></a><span id="l1.8446" class="difflineplus">+      rv = FindNextFlagged(startIndex + 1, pResultIndex);</span>
<a href="#l1.8447"></a><span id="l1.8447" class="difflineplus">+      if (IsValidIndex(*pResultIndex))</span>
<a href="#l1.8448"></a><span id="l1.8448" class="difflineplus">+        *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8449"></a><span id="l1.8449" class="difflineplus">+</span>
<a href="#l1.8450"></a><span id="l1.8450" class="difflineplus">+      break;</span>
<a href="#l1.8451"></a><span id="l1.8451" class="difflineplus">+    case nsMsgNavigationType::previousFlagged:</span>
<a href="#l1.8452"></a><span id="l1.8452" class="difflineplus">+      rv = FindPrevFlagged(startIndex, pResultIndex);</span>
<a href="#l1.8453"></a><span id="l1.8453" class="difflineplus">+      if (IsValidIndex(*pResultIndex))</span>
<a href="#l1.8454"></a><span id="l1.8454" class="difflineplus">+        *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8455"></a><span id="l1.8455" class="difflineplus">+</span>
<a href="#l1.8456"></a><span id="l1.8456" class="difflineplus">+      break;</span>
<a href="#l1.8457"></a><span id="l1.8457" class="difflineplus">+    case nsMsgNavigationType::firstNew:</span>
<a href="#l1.8458"></a><span id="l1.8458" class="difflineplus">+      rv = FindFirstNew(pResultIndex);</span>
<a href="#l1.8459"></a><span id="l1.8459" class="difflineplus">+      if (IsValidIndex(*pResultIndex))</span>
<a href="#l1.8460"></a><span id="l1.8460" class="difflineplus">+        *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8461"></a><span id="l1.8461" class="difflineplus">+</span>
<a href="#l1.8462"></a><span id="l1.8462" class="difflineplus">+      break;</span>
<a href="#l1.8463"></a><span id="l1.8463" class="difflineplus">+    case nsMsgNavigationType::firstUnreadMessage:</span>
<a href="#l1.8464"></a><span id="l1.8464" class="difflineplus">+      startIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8465"></a><span id="l1.8465" class="difflineplus">+      // Note fall thru - is this motion ever used?</span>
<a href="#l1.8466"></a><span id="l1.8466" class="difflineplus">+      MOZ_FALLTHROUGH;</span>
<a href="#l1.8467"></a><span id="l1.8467" class="difflineplus">+    case nsMsgNavigationType::nextUnreadMessage:</span>
<a href="#l1.8468"></a><span id="l1.8468" class="difflineplus">+      for (curIndex = (startIndex == nsMsgViewIndex_None) ? 0 : startIndex;</span>
<a href="#l1.8469"></a><span id="l1.8469" class="difflineplus">+           curIndex &lt;= lastIndex &amp;&amp; lastIndex != nsMsgViewIndex_None;</span>
<a href="#l1.8470"></a><span id="l1.8470" class="difflineplus">+           curIndex++)</span>
<a href="#l1.8471"></a><span id="l1.8471" class="difflineplus">+      {</span>
<a href="#l1.8472"></a><span id="l1.8472" class="difflineplus">+        uint32_t flags = m_flags[curIndex];</span>
<a href="#l1.8473"></a><span id="l1.8473" class="difflineplus">+        // Don't return start index since navigate should move.</span>
<a href="#l1.8474"></a><span id="l1.8474" class="difflineplus">+        if (!(flags &amp; (nsMsgMessageFlags::Read | MSG_VIEW_FLAG_DUMMY)) &amp;&amp;</span>
<a href="#l1.8475"></a><span id="l1.8475" class="difflineplus">+            (curIndex != startIndex))</span>
<a href="#l1.8476"></a><span id="l1.8476" class="difflineplus">+        {</span>
<a href="#l1.8477"></a><span id="l1.8477" class="difflineplus">+          *pResultIndex = curIndex;</span>
<a href="#l1.8478"></a><span id="l1.8478" class="difflineplus">+          *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8479"></a><span id="l1.8479" class="difflineplus">+          break;</span>
<a href="#l1.8480"></a><span id="l1.8480" class="difflineplus">+        }</span>
<a href="#l1.8481"></a><span id="l1.8481" class="difflineplus">+</span>
<a href="#l1.8482"></a><span id="l1.8482" class="difflineplus">+        // Check for collapsed thread with new children.</span>
<a href="#l1.8483"></a><span id="l1.8483" class="difflineplus">+        if ((m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) &amp;&amp;</span>
<a href="#l1.8484"></a><span id="l1.8484" class="difflineplus">+            flags &amp; MSG_VIEW_FLAG_ISTHREAD &amp;&amp;</span>
<a href="#l1.8485"></a><span id="l1.8485" class="difflineplus">+            flags &amp; nsMsgMessageFlags::Elided)</span>
<a href="#l1.8486"></a><span id="l1.8486" class="difflineplus">+        {</span>
<a href="#l1.8487"></a><span id="l1.8487" class="difflineplus">+          nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l1.8488"></a><span id="l1.8488" class="difflineplus">+          GetThreadContainingIndex(curIndex, getter_AddRefs(threadHdr));</span>
<a href="#l1.8489"></a><span id="l1.8489" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8490"></a><span id="l1.8490" class="difflineplus">+</span>
<a href="#l1.8491"></a><span id="l1.8491" class="difflineplus">+          NS_ASSERTION(threadHdr, &quot;threadHdr is null&quot;);</span>
<a href="#l1.8492"></a><span id="l1.8492" class="difflineplus">+          if (!threadHdr)</span>
<a href="#l1.8493"></a><span id="l1.8493" class="difflineplus">+            continue;</span>
<a href="#l1.8494"></a><span id="l1.8494" class="difflineplus">+</span>
<a href="#l1.8495"></a><span id="l1.8495" class="difflineplus">+          uint32_t numUnreadChildren;</span>
<a href="#l1.8496"></a><span id="l1.8496" class="difflineplus">+          threadHdr-&gt;GetNumUnreadChildren(&amp;numUnreadChildren);</span>
<a href="#l1.8497"></a><span id="l1.8497" class="difflineplus">+          if (numUnreadChildren &gt; 0)</span>
<a href="#l1.8498"></a><span id="l1.8498" class="difflineplus">+          {</span>
<a href="#l1.8499"></a><span id="l1.8499" class="difflineplus">+            uint32_t numExpanded;</span>
<a href="#l1.8500"></a><span id="l1.8500" class="difflineplus">+            ExpandByIndex(curIndex, &amp;numExpanded);</span>
<a href="#l1.8501"></a><span id="l1.8501" class="difflineplus">+            lastIndex += numExpanded;</span>
<a href="#l1.8502"></a><span id="l1.8502" class="difflineplus">+            if (pThreadIndex)</span>
<a href="#l1.8503"></a><span id="l1.8503" class="difflineplus">+              *pThreadIndex = curIndex;</span>
<a href="#l1.8504"></a><span id="l1.8504" class="difflineplus">+          }</span>
<a href="#l1.8505"></a><span id="l1.8505" class="difflineplus">+        }</span>
<a href="#l1.8506"></a><span id="l1.8506" class="difflineplus">+      }</span>
<a href="#l1.8507"></a><span id="l1.8507" class="difflineplus">+</span>
<a href="#l1.8508"></a><span id="l1.8508" class="difflineplus">+      if (curIndex &gt; lastIndex)</span>
<a href="#l1.8509"></a><span id="l1.8509" class="difflineplus">+      {</span>
<a href="#l1.8510"></a><span id="l1.8510" class="difflineplus">+        // Wrap around by starting at index 0.</span>
<a href="#l1.8511"></a><span id="l1.8511" class="difflineplus">+        if (wrap)</span>
<a href="#l1.8512"></a><span id="l1.8512" class="difflineplus">+        {</span>
<a href="#l1.8513"></a><span id="l1.8513" class="difflineplus">+          nsMsgKey startKey = GetAt(startIndex);</span>
<a href="#l1.8514"></a><span id="l1.8514" class="difflineplus">+          rv = NavigateFromPos(nsMsgNavigationType::nextUnreadMessage,</span>
<a href="#l1.8515"></a><span id="l1.8515" class="difflineplus">+                               nsMsgViewIndex_None,</span>
<a href="#l1.8516"></a><span id="l1.8516" class="difflineplus">+                               pResultKey,</span>
<a href="#l1.8517"></a><span id="l1.8517" class="difflineplus">+                               pResultIndex,</span>
<a href="#l1.8518"></a><span id="l1.8518" class="difflineplus">+                               pThreadIndex,</span>
<a href="#l1.8519"></a><span id="l1.8519" class="difflineplus">+                               false);</span>
<a href="#l1.8520"></a><span id="l1.8520" class="difflineplus">+</span>
<a href="#l1.8521"></a><span id="l1.8521" class="difflineplus">+          if (*pResultKey == startKey)</span>
<a href="#l1.8522"></a><span id="l1.8522" class="difflineplus">+          {</span>
<a href="#l1.8523"></a><span id="l1.8523" class="difflineplus">+            // wrapped around and found start message!</span>
<a href="#l1.8524"></a><span id="l1.8524" class="difflineplus">+            *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8525"></a><span id="l1.8525" class="difflineplus">+            *pResultKey = nsMsgKey_None;</span>
<a href="#l1.8526"></a><span id="l1.8526" class="difflineplus">+          }</span>
<a href="#l1.8527"></a><span id="l1.8527" class="difflineplus">+        }</span>
<a href="#l1.8528"></a><span id="l1.8528" class="difflineplus">+        else</span>
<a href="#l1.8529"></a><span id="l1.8529" class="difflineplus">+        {</span>
<a href="#l1.8530"></a><span id="l1.8530" class="difflineplus">+          *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8531"></a><span id="l1.8531" class="difflineplus">+          *pResultKey = nsMsgKey_None;</span>
<a href="#l1.8532"></a><span id="l1.8532" class="difflineplus">+        }</span>
<a href="#l1.8533"></a><span id="l1.8533" class="difflineplus">+      }</span>
<a href="#l1.8534"></a><span id="l1.8534" class="difflineplus">+      break;</span>
<a href="#l1.8535"></a><span id="l1.8535" class="difflineplus">+    case nsMsgNavigationType::previousUnreadMessage:</span>
<a href="#l1.8536"></a><span id="l1.8536" class="difflineplus">+      if (startIndex == nsMsgViewIndex_None)</span>
<a href="#l1.8537"></a><span id="l1.8537" class="difflineplus">+        break;</span>
<a href="#l1.8538"></a><span id="l1.8538" class="difflineplus">+</span>
<a href="#l1.8539"></a><span id="l1.8539" class="difflineplus">+      rv = FindPrevUnread(m_keys[startIndex], pResultKey, &amp;resultThreadKey);</span>
<a href="#l1.8540"></a><span id="l1.8540" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l1.8541"></a><span id="l1.8541" class="difflineplus">+      {</span>
<a href="#l1.8542"></a><span id="l1.8542" class="difflineplus">+        *pResultIndex = FindViewIndex(*pResultKey);</span>
<a href="#l1.8543"></a><span id="l1.8543" class="difflineplus">+        if (*pResultKey != resultThreadKey &amp;&amp;</span>
<a href="#l1.8544"></a><span id="l1.8544" class="difflineplus">+            (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.8545"></a><span id="l1.8545" class="difflineplus">+        {</span>
<a href="#l1.8546"></a><span id="l1.8546" class="difflineplus">+          threadIndex  = GetThreadIndex(*pResultIndex);</span>
<a href="#l1.8547"></a><span id="l1.8547" class="difflineplus">+          if (*pResultIndex == nsMsgViewIndex_None)</span>
<a href="#l1.8548"></a><span id="l1.8548" class="difflineplus">+          {</span>
<a href="#l1.8549"></a><span id="l1.8549" class="difflineplus">+            nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l1.8550"></a><span id="l1.8550" class="difflineplus">+            nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.8551"></a><span id="l1.8551" class="difflineplus">+            rv = m_db-&gt;GetMsgHdrForKey(*pResultKey, getter_AddRefs(msgHdr));</span>
<a href="#l1.8552"></a><span id="l1.8552" class="difflineplus">+            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8553"></a><span id="l1.8553" class="difflineplus">+            rv = GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(threadHdr));</span>
<a href="#l1.8554"></a><span id="l1.8554" class="difflineplus">+            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8555"></a><span id="l1.8555" class="difflineplus">+</span>
<a href="#l1.8556"></a><span id="l1.8556" class="difflineplus">+            NS_ASSERTION(threadHdr, &quot;threadHdr is null&quot;);</span>
<a href="#l1.8557"></a><span id="l1.8557" class="difflineplus">+            if (threadHdr)</span>
<a href="#l1.8558"></a><span id="l1.8558" class="difflineplus">+              break;</span>
<a href="#l1.8559"></a><span id="l1.8559" class="difflineplus">+</span>
<a href="#l1.8560"></a><span id="l1.8560" class="difflineplus">+            uint32_t numUnreadChildren;</span>
<a href="#l1.8561"></a><span id="l1.8561" class="difflineplus">+            threadHdr-&gt;GetNumUnreadChildren(&amp;numUnreadChildren);</span>
<a href="#l1.8562"></a><span id="l1.8562" class="difflineplus">+            if (numUnreadChildren &gt; 0)</span>
<a href="#l1.8563"></a><span id="l1.8563" class="difflineplus">+            {</span>
<a href="#l1.8564"></a><span id="l1.8564" class="difflineplus">+              uint32_t numExpanded;</span>
<a href="#l1.8565"></a><span id="l1.8565" class="difflineplus">+              ExpandByIndex(threadIndex, &amp;numExpanded);</span>
<a href="#l1.8566"></a><span id="l1.8566" class="difflineplus">+            }</span>
<a href="#l1.8567"></a><span id="l1.8567" class="difflineplus">+</span>
<a href="#l1.8568"></a><span id="l1.8568" class="difflineplus">+            *pResultIndex = FindViewIndex(*pResultKey);</span>
<a href="#l1.8569"></a><span id="l1.8569" class="difflineplus">+          }</span>
<a href="#l1.8570"></a><span id="l1.8570" class="difflineplus">+        }</span>
<a href="#l1.8571"></a><span id="l1.8571" class="difflineplus">+</span>
<a href="#l1.8572"></a><span id="l1.8572" class="difflineplus">+        if (pThreadIndex)</span>
<a href="#l1.8573"></a><span id="l1.8573" class="difflineplus">+          *pThreadIndex = threadIndex;</span>
<a href="#l1.8574"></a><span id="l1.8574" class="difflineplus">+      }</span>
<a href="#l1.8575"></a><span id="l1.8575" class="difflineplus">+      break;</span>
<a href="#l1.8576"></a><span id="l1.8576" class="difflineplus">+    case nsMsgNavigationType::lastUnreadMessage:</span>
<a href="#l1.8577"></a><span id="l1.8577" class="difflineplus">+      break;</span>
<a href="#l1.8578"></a><span id="l1.8578" class="difflineplus">+    case nsMsgNavigationType::nextUnreadThread:</span>
<a href="#l1.8579"></a><span id="l1.8579" class="difflineplus">+      if (startIndex != nsMsgViewIndex_None)</span>
<a href="#l1.8580"></a><span id="l1.8580" class="difflineplus">+        ApplyCommandToIndices(nsMsgViewCommandType::markThreadRead, &amp;startIndex, 1);</span>
<a href="#l1.8581"></a><span id="l1.8581" class="difflineplus">+</span>
<a href="#l1.8582"></a><span id="l1.8582" class="difflineplus">+      return NavigateFromPos(nsMsgNavigationType::nextUnreadMessage,</span>
<a href="#l1.8583"></a><span id="l1.8583" class="difflineplus">+                             startIndex,</span>
<a href="#l1.8584"></a><span id="l1.8584" class="difflineplus">+                             pResultKey,</span>
<a href="#l1.8585"></a><span id="l1.8585" class="difflineplus">+                             pResultIndex,</span>
<a href="#l1.8586"></a><span id="l1.8586" class="difflineplus">+                             pThreadIndex,</span>
<a href="#l1.8587"></a><span id="l1.8587" class="difflineplus">+                             true);</span>
<a href="#l1.8588"></a><span id="l1.8588" class="difflineplus">+    case nsMsgNavigationType::toggleThreadKilled:</span>
<a href="#l1.8589"></a><span id="l1.8589" class="difflineplus">+    {</span>
<a href="#l1.8590"></a><span id="l1.8590" class="difflineplus">+      bool resultKilled;</span>
<a href="#l1.8591"></a><span id="l1.8591" class="difflineplus">+      nsMsgViewIndexArray selection;</span>
<a href="#l1.8592"></a><span id="l1.8592" class="difflineplus">+      GetSelectedIndices(selection);</span>
<a href="#l1.8593"></a><span id="l1.8593" class="difflineplus">+      ToggleIgnored(selection.Elements(), selection.Length(), &amp;threadIndex, &amp;resultKilled);</span>
<a href="#l1.8594"></a><span id="l1.8594" class="difflineplus">+      if (resultKilled)</span>
<a href="#l1.8595"></a><span id="l1.8595" class="difflineplus">+      {</span>
<a href="#l1.8596"></a><span id="l1.8596" class="difflineplus">+        return NavigateFromPos(nsMsgNavigationType::nextUnreadThread,</span>
<a href="#l1.8597"></a><span id="l1.8597" class="difflineplus">+                               threadIndex,</span>
<a href="#l1.8598"></a><span id="l1.8598" class="difflineplus">+                               pResultKey,</span>
<a href="#l1.8599"></a><span id="l1.8599" class="difflineplus">+                               pResultIndex,</span>
<a href="#l1.8600"></a><span id="l1.8600" class="difflineplus">+                               pThreadIndex,</span>
<a href="#l1.8601"></a><span id="l1.8601" class="difflineplus">+                               true);</span>
<a href="#l1.8602"></a><span id="l1.8602" class="difflineplus">+      }</span>
<a href="#l1.8603"></a><span id="l1.8603" class="difflineplus">+      else</span>
<a href="#l1.8604"></a><span id="l1.8604" class="difflineplus">+      {</span>
<a href="#l1.8605"></a><span id="l1.8605" class="difflineplus">+        *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8606"></a><span id="l1.8606" class="difflineplus">+        *pResultKey = nsMsgKey_None;</span>
<a href="#l1.8607"></a><span id="l1.8607" class="difflineplus">+        return NS_OK;</span>
<a href="#l1.8608"></a><span id="l1.8608" class="difflineplus">+      }</span>
<a href="#l1.8609"></a><span id="l1.8609" class="difflineplus">+    }</span>
<a href="#l1.8610"></a><span id="l1.8610" class="difflineplus">+    case nsMsgNavigationType::toggleSubthreadKilled:</span>
<a href="#l1.8611"></a><span id="l1.8611" class="difflineplus">+    {</span>
<a href="#l1.8612"></a><span id="l1.8612" class="difflineplus">+      bool resultKilled;</span>
<a href="#l1.8613"></a><span id="l1.8613" class="difflineplus">+      nsMsgViewIndexArray selection;</span>
<a href="#l1.8614"></a><span id="l1.8614" class="difflineplus">+      GetSelectedIndices(selection);</span>
<a href="#l1.8615"></a><span id="l1.8615" class="difflineplus">+      ToggleMessageKilled(selection.Elements(), selection.Length(),</span>
<a href="#l1.8616"></a><span id="l1.8616" class="difflineplus">+                          &amp;threadIndex, &amp;resultKilled);</span>
<a href="#l1.8617"></a><span id="l1.8617" class="difflineplus">+      if (resultKilled)</span>
<a href="#l1.8618"></a><span id="l1.8618" class="difflineplus">+      {</span>
<a href="#l1.8619"></a><span id="l1.8619" class="difflineplus">+        return NavigateFromPos(nsMsgNavigationType::nextUnreadMessage,</span>
<a href="#l1.8620"></a><span id="l1.8620" class="difflineplus">+                               threadIndex,</span>
<a href="#l1.8621"></a><span id="l1.8621" class="difflineplus">+                               pResultKey,</span>
<a href="#l1.8622"></a><span id="l1.8622" class="difflineplus">+                               pResultIndex,</span>
<a href="#l1.8623"></a><span id="l1.8623" class="difflineplus">+                               pThreadIndex,</span>
<a href="#l1.8624"></a><span id="l1.8624" class="difflineplus">+                               true);</span>
<a href="#l1.8625"></a><span id="l1.8625" class="difflineplus">+      }</span>
<a href="#l1.8626"></a><span id="l1.8626" class="difflineplus">+      else</span>
<a href="#l1.8627"></a><span id="l1.8627" class="difflineplus">+      {</span>
<a href="#l1.8628"></a><span id="l1.8628" class="difflineplus">+        *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8629"></a><span id="l1.8629" class="difflineplus">+        *pResultKey = nsMsgKey_None;</span>
<a href="#l1.8630"></a><span id="l1.8630" class="difflineplus">+        return NS_OK;</span>
<a href="#l1.8631"></a><span id="l1.8631" class="difflineplus">+      }</span>
<a href="#l1.8632"></a><span id="l1.8632" class="difflineplus">+    }</span>
<a href="#l1.8633"></a><span id="l1.8633" class="difflineplus">+    // Check where navigate says this will take us. If we have the message</span>
<a href="#l1.8634"></a><span id="l1.8634" class="difflineplus">+    // in the view, return it. Otherwise, return an error.</span>
<a href="#l1.8635"></a><span id="l1.8635" class="difflineplus">+    case nsMsgNavigationType::back:</span>
<a href="#l1.8636"></a><span id="l1.8636" class="difflineplus">+    case nsMsgNavigationType::forward:</span>
<a href="#l1.8637"></a><span id="l1.8637" class="difflineplus">+    {</span>
<a href="#l1.8638"></a><span id="l1.8638" class="difflineplus">+      nsCString folderUri, msgUri;</span>
<a href="#l1.8639"></a><span id="l1.8639" class="difflineplus">+      nsCString viewFolderUri;</span>
<a href="#l1.8640"></a><span id="l1.8640" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; curFolder = m_viewFolder ? m_viewFolder : m_folder;</span>
<a href="#l1.8641"></a><span id="l1.8641" class="difflineplus">+      if (curFolder)</span>
<a href="#l1.8642"></a><span id="l1.8642" class="difflineplus">+        curFolder-&gt;GetURI(viewFolderUri);</span>
<a href="#l1.8643"></a><span id="l1.8643" class="difflineplus">+</span>
<a href="#l1.8644"></a><span id="l1.8644" class="difflineplus">+      int32_t relPos = (motion == nsMsgNavigationType::forward) ?</span>
<a href="#l1.8645"></a><span id="l1.8645" class="difflineplus">+                         1 :</span>
<a href="#l1.8646"></a><span id="l1.8646" class="difflineplus">+                         (m_currentlyDisplayedMsgKey != nsMsgKey_None) ? -1 : 0;</span>
<a href="#l1.8647"></a><span id="l1.8647" class="difflineplus">+      int32_t curPos;</span>
<a href="#l1.8648"></a><span id="l1.8648" class="difflineplus">+      nsresult rv;</span>
<a href="#l1.8649"></a><span id="l1.8649" class="difflineplus">+      nsCOMPtr&lt;nsIMessenger&gt; messenger(do_QueryReferent(mMessengerWeak, &amp;rv));</span>
<a href="#l1.8650"></a><span id="l1.8650">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8651"></a><span id="l1.8651" class="difflineminus">-    }</span>
<a href="#l1.8652"></a><span id="l1.8652" class="difflineminus">-    startIndex = currentIndex;</span>
<a href="#l1.8653"></a><span id="l1.8653" class="difflineminus">-    return nsMsgDBView::NavigateFromPos(motion, startIndex, pResultKey, pResultIndex, pThreadIndex, wrap);</span>
<a href="#l1.8654"></a><span id="l1.8654" class="difflineminus">-}</span>
<a href="#l1.8655"></a><span id="l1.8655" class="difflineminus">-</span>
<a href="#l1.8656"></a><span id="l1.8656" class="difflineminus">-nsresult nsMsgDBView::NavigateFromPos(nsMsgNavigationTypeValue motion, nsMsgViewIndex startIndex, nsMsgKey *pResultKey, nsMsgViewIndex *pResultIndex, nsMsgViewIndex *pThreadIndex, bool wrap)</span>
<a href="#l1.8657"></a><span id="l1.8657" class="difflineminus">-{</span>
<a href="#l1.8658"></a><span id="l1.8658" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l1.8659"></a><span id="l1.8659" class="difflineminus">-    nsMsgKey resultThreadKey;</span>
<a href="#l1.8660"></a><span id="l1.8660" class="difflineminus">-    nsMsgViewIndex curIndex;</span>
<a href="#l1.8661"></a><span id="l1.8661" class="difflineminus">-    nsMsgViewIndex lastIndex = (GetSize() &gt; 0) ? (nsMsgViewIndex) GetSize() - 1 : nsMsgViewIndex_None;</span>
<a href="#l1.8662"></a><span id="l1.8662" class="difflineminus">-    nsMsgViewIndex threadIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8663"></a><span id="l1.8663" class="difflineminus">-</span>
<a href="#l1.8664"></a><span id="l1.8664" class="difflineminus">-    // if there aren't any messages in the view, bail out.</span>
<a href="#l1.8665"></a><span id="l1.8665" class="difflineminus">-    if (GetSize() &lt;= 0)</span>
<a href="#l1.8666"></a><span id="l1.8666" class="difflineminus">-    {</span>
<a href="#l1.8667"></a><span id="l1.8667" class="difflineplus">+      rv = messenger-&gt;GetFolderUriAtNavigatePos(relPos, folderUri);</span>
<a href="#l1.8668"></a><span id="l1.8668" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8669"></a><span id="l1.8669" class="difflineplus">+      // Empty viewFolderUri means we're in a search results view.</span>
<a href="#l1.8670"></a><span id="l1.8670" class="difflineplus">+      if (viewFolderUri.IsEmpty() || folderUri.Equals(viewFolderUri))</span>
<a href="#l1.8671"></a><span id="l1.8671" class="difflineplus">+      {</span>
<a href="#l1.8672"></a><span id="l1.8672" class="difflineplus">+        nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.8673"></a><span id="l1.8673" class="difflineplus">+        rv = messenger-&gt;GetMsgUriAtNavigatePos(relPos, msgUri);</span>
<a href="#l1.8674"></a><span id="l1.8674" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8675"></a><span id="l1.8675" class="difflineplus">+        messenger-&gt;MsgHdrFromURI(msgUri, getter_AddRefs(msgHdr));</span>
<a href="#l1.8676"></a><span id="l1.8676" class="difflineplus">+        if (msgHdr)</span>
<a href="#l1.8677"></a><span id="l1.8677" class="difflineplus">+        {</span>
<a href="#l1.8678"></a><span id="l1.8678" class="difflineplus">+          messenger-&gt;GetNavigatePos(&amp;curPos);</span>
<a href="#l1.8679"></a><span id="l1.8679" class="difflineplus">+          curPos += relPos;</span>
<a href="#l1.8680"></a><span id="l1.8680" class="difflineplus">+          *pResultIndex = FindHdr(msgHdr);</span>
<a href="#l1.8681"></a><span id="l1.8681" class="difflineplus">+          messenger-&gt;SetNavigatePos(curPos);</span>
<a href="#l1.8682"></a><span id="l1.8682" class="difflineplus">+          msgHdr-&gt;GetMessageKey(pResultKey);</span>
<a href="#l1.8683"></a><span id="l1.8683" class="difflineplus">+          return NS_OK;</span>
<a href="#l1.8684"></a><span id="l1.8684" class="difflineplus">+        }</span>
<a href="#l1.8685"></a><span id="l1.8685" class="difflineplus">+      }</span>
<a href="#l1.8686"></a><span id="l1.8686" class="difflineplus">+</span>
<a href="#l1.8687"></a><span id="l1.8687">       *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8688"></a><span id="l1.8688">       *pResultKey = nsMsgKey_None;</span>
<a href="#l1.8689"></a><span id="l1.8689" class="difflineminus">-      return NS_OK;</span>
<a href="#l1.8690"></a><span id="l1.8690" class="difflineminus">-    }</span>
<a href="#l1.8691"></a><span id="l1.8691" class="difflineminus">-</span>
<a href="#l1.8692"></a><span id="l1.8692" class="difflineminus">-    switch (motion)</span>
<a href="#l1.8693"></a><span id="l1.8693" class="difflineminus">-    {</span>
<a href="#l1.8694"></a><span id="l1.8694" class="difflineminus">-        case nsMsgNavigationType::firstMessage:</span>
<a href="#l1.8695"></a><span id="l1.8695" class="difflineminus">-            *pResultIndex = 0;</span>
<a href="#l1.8696"></a><span id="l1.8696" class="difflineminus">-            *pResultKey = m_keys[0];</span>
<a href="#l1.8697"></a><span id="l1.8697" class="difflineminus">-            break;</span>
<a href="#l1.8698"></a><span id="l1.8698" class="difflineminus">-        case nsMsgNavigationType::nextMessage:</span>
<a href="#l1.8699"></a><span id="l1.8699" class="difflineminus">-            // return same index and id on next on last message</span>
<a href="#l1.8700"></a><span id="l1.8700" class="difflineminus">-            *pResultIndex = std::min(startIndex + 1, lastIndex);</span>
<a href="#l1.8701"></a><span id="l1.8701" class="difflineminus">-            *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8702"></a><span id="l1.8702" class="difflineminus">-            break;</span>
<a href="#l1.8703"></a><span id="l1.8703" class="difflineminus">-        case nsMsgNavigationType::previousMessage:</span>
<a href="#l1.8704"></a><span id="l1.8704" class="difflineminus">-            *pResultIndex = (startIndex != nsMsgViewIndex_None &amp;&amp; startIndex &gt; 0) ? startIndex - 1 : 0;</span>
<a href="#l1.8705"></a><span id="l1.8705" class="difflineminus">-            *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8706"></a><span id="l1.8706" class="difflineminus">-            break;</span>
<a href="#l1.8707"></a><span id="l1.8707" class="difflineminus">-        case nsMsgNavigationType::lastMessage:</span>
<a href="#l1.8708"></a><span id="l1.8708" class="difflineminus">-            *pResultIndex = lastIndex;</span>
<a href="#l1.8709"></a><span id="l1.8709" class="difflineminus">-            *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8710"></a><span id="l1.8710" class="difflineminus">-            break;</span>
<a href="#l1.8711"></a><span id="l1.8711" class="difflineminus">-        case nsMsgNavigationType::firstFlagged:</span>
<a href="#l1.8712"></a><span id="l1.8712" class="difflineminus">-            rv = FindFirstFlagged(pResultIndex);</span>
<a href="#l1.8713"></a><span id="l1.8713" class="difflineminus">-            if (IsValidIndex(*pResultIndex))</span>
<a href="#l1.8714"></a><span id="l1.8714" class="difflineminus">-                *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8715"></a><span id="l1.8715" class="difflineminus">-            break;</span>
<a href="#l1.8716"></a><span id="l1.8716" class="difflineminus">-        case nsMsgNavigationType::nextFlagged:</span>
<a href="#l1.8717"></a><span id="l1.8717" class="difflineminus">-            rv = FindNextFlagged(startIndex + 1, pResultIndex);</span>
<a href="#l1.8718"></a><span id="l1.8718" class="difflineminus">-            if (IsValidIndex(*pResultIndex))</span>
<a href="#l1.8719"></a><span id="l1.8719" class="difflineminus">-                *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8720"></a><span id="l1.8720" class="difflineminus">-            break;</span>
<a href="#l1.8721"></a><span id="l1.8721" class="difflineminus">-        case nsMsgNavigationType::previousFlagged:</span>
<a href="#l1.8722"></a><span id="l1.8722" class="difflineminus">-            rv = FindPrevFlagged(startIndex, pResultIndex);</span>
<a href="#l1.8723"></a><span id="l1.8723" class="difflineminus">-            if (IsValidIndex(*pResultIndex))</span>
<a href="#l1.8724"></a><span id="l1.8724" class="difflineminus">-                *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8725"></a><span id="l1.8725" class="difflineminus">-            break;</span>
<a href="#l1.8726"></a><span id="l1.8726" class="difflineminus">-        case nsMsgNavigationType::firstNew:</span>
<a href="#l1.8727"></a><span id="l1.8727" class="difflineminus">-            rv = FindFirstNew(pResultIndex);</span>
<a href="#l1.8728"></a><span id="l1.8728" class="difflineminus">-            if (IsValidIndex(*pResultIndex))</span>
<a href="#l1.8729"></a><span id="l1.8729" class="difflineminus">-                *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8730"></a><span id="l1.8730" class="difflineminus">-            break;</span>
<a href="#l1.8731"></a><span id="l1.8731" class="difflineminus">-        case nsMsgNavigationType::firstUnreadMessage:</span>
<a href="#l1.8732"></a><span id="l1.8732" class="difflineminus">-            startIndex = nsMsgViewIndex_None;        // note fall thru - is this motion ever used?</span>
<a href="#l1.8733"></a><span id="l1.8733" class="difflineminus">-            MOZ_FALLTHROUGH;</span>
<a href="#l1.8734"></a><span id="l1.8734" class="difflineminus">-        case nsMsgNavigationType::nextUnreadMessage:</span>
<a href="#l1.8735"></a><span id="l1.8735" class="difflineminus">-            for (curIndex = (startIndex == nsMsgViewIndex_None) ? 0 : startIndex; curIndex &lt;= lastIndex &amp;&amp; lastIndex != nsMsgViewIndex_None; curIndex++) {</span>
<a href="#l1.8736"></a><span id="l1.8736" class="difflineminus">-                uint32_t flags = m_flags[curIndex];</span>
<a href="#l1.8737"></a><span id="l1.8737" class="difflineminus">-</span>
<a href="#l1.8738"></a><span id="l1.8738" class="difflineminus">-                // don't return start index since navigate should move</span>
<a href="#l1.8739"></a><span id="l1.8739" class="difflineminus">-                if (!(flags &amp; (nsMsgMessageFlags::Read | MSG_VIEW_FLAG_DUMMY)) &amp;&amp; (curIndex != startIndex))</span>
<a href="#l1.8740"></a><span id="l1.8740" class="difflineminus">-                {</span>
<a href="#l1.8741"></a><span id="l1.8741" class="difflineminus">-                    *pResultIndex = curIndex;</span>
<a href="#l1.8742"></a><span id="l1.8742" class="difflineminus">-                    *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8743"></a><span id="l1.8743" class="difflineminus">-                    break;</span>
<a href="#l1.8744"></a><span id="l1.8744" class="difflineminus">-                }</span>
<a href="#l1.8745"></a><span id="l1.8745" class="difflineminus">-                // check for collapsed thread with new children</span>
<a href="#l1.8746"></a><span id="l1.8746" class="difflineminus">-                if ((m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) &amp;&amp; flags &amp; MSG_VIEW_FLAG_ISTHREAD &amp;&amp; flags &amp; nsMsgMessageFlags::Elided) {</span>
<a href="#l1.8747"></a><span id="l1.8747" class="difflineminus">-                    nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l1.8748"></a><span id="l1.8748" class="difflineminus">-                    GetThreadContainingIndex(curIndex, getter_AddRefs(threadHdr));</span>
<a href="#l1.8749"></a><span id="l1.8749" class="difflineminus">-                    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8750"></a><span id="l1.8750" class="difflineminus">-</span>
<a href="#l1.8751"></a><span id="l1.8751" class="difflineminus">-                    NS_ASSERTION(threadHdr, &quot;threadHdr is null&quot;);</span>
<a href="#l1.8752"></a><span id="l1.8752" class="difflineminus">-                    if (!threadHdr)</span>
<a href="#l1.8753"></a><span id="l1.8753" class="difflineminus">-                        continue;</span>
<a href="#l1.8754"></a><span id="l1.8754" class="difflineminus">-                    uint32_t numUnreadChildren;</span>
<a href="#l1.8755"></a><span id="l1.8755" class="difflineminus">-                    threadHdr-&gt;GetNumUnreadChildren(&amp;numUnreadChildren);</span>
<a href="#l1.8756"></a><span id="l1.8756" class="difflineminus">-                    if (numUnreadChildren &gt; 0)</span>
<a href="#l1.8757"></a><span id="l1.8757" class="difflineminus">-                    {</span>
<a href="#l1.8758"></a><span id="l1.8758" class="difflineminus">-                        uint32_t numExpanded;</span>
<a href="#l1.8759"></a><span id="l1.8759" class="difflineminus">-                        ExpandByIndex(curIndex, &amp;numExpanded);</span>
<a href="#l1.8760"></a><span id="l1.8760" class="difflineminus">-                        lastIndex += numExpanded;</span>
<a href="#l1.8761"></a><span id="l1.8761" class="difflineminus">-                        if (pThreadIndex)</span>
<a href="#l1.8762"></a><span id="l1.8762" class="difflineminus">-                            *pThreadIndex = curIndex;</span>
<a href="#l1.8763"></a><span id="l1.8763" class="difflineminus">-                    }</span>
<a href="#l1.8764"></a><span id="l1.8764" class="difflineminus">-                }</span>
<a href="#l1.8765"></a><span id="l1.8765" class="difflineminus">-            }</span>
<a href="#l1.8766"></a><span id="l1.8766" class="difflineminus">-            if (curIndex &gt; lastIndex)</span>
<a href="#l1.8767"></a><span id="l1.8767" class="difflineminus">-            {</span>
<a href="#l1.8768"></a><span id="l1.8768" class="difflineminus">-                // wrap around by starting at index 0.</span>
<a href="#l1.8769"></a><span id="l1.8769" class="difflineminus">-                if (wrap)</span>
<a href="#l1.8770"></a><span id="l1.8770" class="difflineminus">-                {</span>
<a href="#l1.8771"></a><span id="l1.8771" class="difflineminus">-                    nsMsgKey startKey = GetAt(startIndex);</span>
<a href="#l1.8772"></a><span id="l1.8772" class="difflineminus">-</span>
<a href="#l1.8773"></a><span id="l1.8773" class="difflineminus">-                    rv = NavigateFromPos(nsMsgNavigationType::nextUnreadMessage, nsMsgViewIndex_None, pResultKey, pResultIndex, pThreadIndex, false);</span>
<a href="#l1.8774"></a><span id="l1.8774" class="difflineminus">-</span>
<a href="#l1.8775"></a><span id="l1.8775" class="difflineminus">-                    if (*pResultKey == startKey)</span>
<a href="#l1.8776"></a><span id="l1.8776" class="difflineminus">-                    {</span>
<a href="#l1.8777"></a><span id="l1.8777" class="difflineminus">-                        // wrapped around and found start message!</span>
<a href="#l1.8778"></a><span id="l1.8778" class="difflineminus">-                        *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8779"></a><span id="l1.8779" class="difflineminus">-                        *pResultKey = nsMsgKey_None;</span>
<a href="#l1.8780"></a><span id="l1.8780" class="difflineminus">-                    }</span>
<a href="#l1.8781"></a><span id="l1.8781" class="difflineminus">-                }</span>
<a href="#l1.8782"></a><span id="l1.8782" class="difflineminus">-                else</span>
<a href="#l1.8783"></a><span id="l1.8783" class="difflineminus">-                {</span>
<a href="#l1.8784"></a><span id="l1.8784" class="difflineminus">-                    *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8785"></a><span id="l1.8785" class="difflineminus">-                    *pResultKey = nsMsgKey_None;</span>
<a href="#l1.8786"></a><span id="l1.8786" class="difflineminus">-                }</span>
<a href="#l1.8787"></a><span id="l1.8787" class="difflineminus">-            }</span>
<a href="#l1.8788"></a><span id="l1.8788" class="difflineminus">-            break;</span>
<a href="#l1.8789"></a><span id="l1.8789" class="difflineminus">-        case nsMsgNavigationType::previousUnreadMessage:</span>
<a href="#l1.8790"></a><span id="l1.8790" class="difflineminus">-            if (startIndex == nsMsgViewIndex_None)</span>
<a href="#l1.8791"></a><span id="l1.8791" class="difflineminus">-              break;</span>
<a href="#l1.8792"></a><span id="l1.8792" class="difflineminus">-            rv = FindPrevUnread(m_keys[startIndex], pResultKey,</span>
<a href="#l1.8793"></a><span id="l1.8793" class="difflineminus">-                                &amp;resultThreadKey);</span>
<a href="#l1.8794"></a><span id="l1.8794" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l1.8795"></a><span id="l1.8795" class="difflineminus">-            {</span>
<a href="#l1.8796"></a><span id="l1.8796" class="difflineminus">-                *pResultIndex = FindViewIndex(*pResultKey);</span>
<a href="#l1.8797"></a><span id="l1.8797" class="difflineminus">-                if (*pResultKey != resultThreadKey &amp;&amp; (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.8798"></a><span id="l1.8798" class="difflineminus">-                {</span>
<a href="#l1.8799"></a><span id="l1.8799" class="difflineminus">-                    threadIndex  = GetThreadIndex(*pResultIndex);</span>
<a href="#l1.8800"></a><span id="l1.8800" class="difflineminus">-                    if (*pResultIndex == nsMsgViewIndex_None)</span>
<a href="#l1.8801"></a><span id="l1.8801" class="difflineminus">-                    {</span>
<a href="#l1.8802"></a><span id="l1.8802" class="difflineminus">-                        nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l1.8803"></a><span id="l1.8803" class="difflineminus">-                        nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.8804"></a><span id="l1.8804" class="difflineminus">-                        rv = m_db-&gt;GetMsgHdrForKey(*pResultKey, getter_AddRefs(msgHdr));</span>
<a href="#l1.8805"></a><span id="l1.8805" class="difflineminus">-                        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8806"></a><span id="l1.8806" class="difflineminus">-                        rv = GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(threadHdr));</span>
<a href="#l1.8807"></a><span id="l1.8807" class="difflineminus">-                        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8808"></a><span id="l1.8808" class="difflineminus">-</span>
<a href="#l1.8809"></a><span id="l1.8809" class="difflineminus">-                        NS_ASSERTION(threadHdr, &quot;threadHdr is null&quot;);</span>
<a href="#l1.8810"></a><span id="l1.8810" class="difflineminus">-                        if (threadHdr)</span>
<a href="#l1.8811"></a><span id="l1.8811" class="difflineminus">-                            break;</span>
<a href="#l1.8812"></a><span id="l1.8812" class="difflineminus">-                        uint32_t numUnreadChildren;</span>
<a href="#l1.8813"></a><span id="l1.8813" class="difflineminus">-                        threadHdr-&gt;GetNumUnreadChildren(&amp;numUnreadChildren);</span>
<a href="#l1.8814"></a><span id="l1.8814" class="difflineminus">-                        if (numUnreadChildren &gt; 0)</span>
<a href="#l1.8815"></a><span id="l1.8815" class="difflineminus">-                        {</span>
<a href="#l1.8816"></a><span id="l1.8816" class="difflineminus">-                            uint32_t numExpanded;</span>
<a href="#l1.8817"></a><span id="l1.8817" class="difflineminus">-                            ExpandByIndex(threadIndex, &amp;numExpanded);</span>
<a href="#l1.8818"></a><span id="l1.8818" class="difflineminus">-                        }</span>
<a href="#l1.8819"></a><span id="l1.8819" class="difflineminus">-                        *pResultIndex = FindViewIndex(*pResultKey);</span>
<a href="#l1.8820"></a><span id="l1.8820" class="difflineminus">-                    }</span>
<a href="#l1.8821"></a><span id="l1.8821" class="difflineminus">-                }</span>
<a href="#l1.8822"></a><span id="l1.8822" class="difflineminus">-                if (pThreadIndex)</span>
<a href="#l1.8823"></a><span id="l1.8823" class="difflineminus">-                    *pThreadIndex = threadIndex;</span>
<a href="#l1.8824"></a><span id="l1.8824" class="difflineminus">-            }</span>
<a href="#l1.8825"></a><span id="l1.8825" class="difflineminus">-            break;</span>
<a href="#l1.8826"></a><span id="l1.8826" class="difflineminus">-        case nsMsgNavigationType::lastUnreadMessage:</span>
<a href="#l1.8827"></a><span id="l1.8827" class="difflineminus">-            break;</span>
<a href="#l1.8828"></a><span id="l1.8828" class="difflineminus">-        case nsMsgNavigationType::nextUnreadThread:</span>
<a href="#l1.8829"></a><span id="l1.8829" class="difflineminus">-            if (startIndex != nsMsgViewIndex_None)</span>
<a href="#l1.8830"></a><span id="l1.8830" class="difflineminus">-              ApplyCommandToIndices(nsMsgViewCommandType::markThreadRead, &amp;startIndex, 1);</span>
<a href="#l1.8831"></a><span id="l1.8831" class="difflineminus">-</span>
<a href="#l1.8832"></a><span id="l1.8832" class="difflineminus">-            return NavigateFromPos(nsMsgNavigationType::nextUnreadMessage, startIndex, pResultKey, pResultIndex, pThreadIndex, true);</span>
<a href="#l1.8833"></a><span id="l1.8833" class="difflineminus">-        case nsMsgNavigationType::toggleThreadKilled:</span>
<a href="#l1.8834"></a><span id="l1.8834" class="difflineminus">-            {</span>
<a href="#l1.8835"></a><span id="l1.8835" class="difflineminus">-                bool resultKilled;</span>
<a href="#l1.8836"></a><span id="l1.8836" class="difflineminus">-                nsMsgViewIndexArray selection;</span>
<a href="#l1.8837"></a><span id="l1.8837" class="difflineminus">-                GetSelectedIndices(selection);</span>
<a href="#l1.8838"></a><span id="l1.8838" class="difflineminus">-                ToggleIgnored(selection.Elements(), selection.Length(), &amp;threadIndex, &amp;resultKilled);</span>
<a href="#l1.8839"></a><span id="l1.8839" class="difflineminus">-                if (resultKilled)</span>
<a href="#l1.8840"></a><span id="l1.8840" class="difflineminus">-                {</span>
<a href="#l1.8841"></a><span id="l1.8841" class="difflineminus">-                    return NavigateFromPos(nsMsgNavigationType::nextUnreadThread, threadIndex, pResultKey, pResultIndex, pThreadIndex, true);</span>
<a href="#l1.8842"></a><span id="l1.8842" class="difflineminus">-                }</span>
<a href="#l1.8843"></a><span id="l1.8843" class="difflineminus">-                else</span>
<a href="#l1.8844"></a><span id="l1.8844" class="difflineminus">-                {</span>
<a href="#l1.8845"></a><span id="l1.8845" class="difflineminus">-                    *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8846"></a><span id="l1.8846" class="difflineminus">-                    *pResultKey = nsMsgKey_None;</span>
<a href="#l1.8847"></a><span id="l1.8847" class="difflineminus">-                    return NS_OK;</span>
<a href="#l1.8848"></a><span id="l1.8848" class="difflineminus">-                }</span>
<a href="#l1.8849"></a><span id="l1.8849" class="difflineminus">-            }</span>
<a href="#l1.8850"></a><span id="l1.8850" class="difflineminus">-        case nsMsgNavigationType::toggleSubthreadKilled:</span>
<a href="#l1.8851"></a><span id="l1.8851" class="difflineminus">-            {</span>
<a href="#l1.8852"></a><span id="l1.8852" class="difflineminus">-                bool resultKilled;</span>
<a href="#l1.8853"></a><span id="l1.8853" class="difflineminus">-                nsMsgViewIndexArray selection;</span>
<a href="#l1.8854"></a><span id="l1.8854" class="difflineminus">-                GetSelectedIndices(selection);</span>
<a href="#l1.8855"></a><span id="l1.8855" class="difflineminus">-                ToggleMessageKilled(selection.Elements(), selection.Length(),</span>
<a href="#l1.8856"></a><span id="l1.8856" class="difflineminus">-                    &amp;threadIndex, &amp;resultKilled);</span>
<a href="#l1.8857"></a><span id="l1.8857" class="difflineminus">-                if (resultKilled)</span>
<a href="#l1.8858"></a><span id="l1.8858" class="difflineminus">-                {</span>
<a href="#l1.8859"></a><span id="l1.8859" class="difflineminus">-                    return NavigateFromPos(nsMsgNavigationType::nextUnreadMessage, threadIndex, pResultKey, pResultIndex, pThreadIndex, true);</span>
<a href="#l1.8860"></a><span id="l1.8860" class="difflineminus">-                }</span>
<a href="#l1.8861"></a><span id="l1.8861" class="difflineminus">-                else</span>
<a href="#l1.8862"></a><span id="l1.8862" class="difflineminus">-                {</span>
<a href="#l1.8863"></a><span id="l1.8863" class="difflineminus">-                    *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8864"></a><span id="l1.8864" class="difflineminus">-                    *pResultKey = nsMsgKey_None;</span>
<a href="#l1.8865"></a><span id="l1.8865" class="difflineminus">-                    return NS_OK;</span>
<a href="#l1.8866"></a><span id="l1.8866" class="difflineminus">-                }</span>
<a href="#l1.8867"></a><span id="l1.8867" class="difflineminus">-            }</span>
<a href="#l1.8868"></a><span id="l1.8868" class="difflineminus">-          // check where navigate says this will take us. If we have the message in the view,</span>
<a href="#l1.8869"></a><span id="l1.8869" class="difflineminus">-          // return it. Otherwise, return an error.</span>
<a href="#l1.8870"></a><span id="l1.8870" class="difflineminus">-      case nsMsgNavigationType::back:</span>
<a href="#l1.8871"></a><span id="l1.8871" class="difflineminus">-      case nsMsgNavigationType::forward:</span>
<a href="#l1.8872"></a><span id="l1.8872" class="difflineminus">-        {</span>
<a href="#l1.8873"></a><span id="l1.8873" class="difflineminus">-          nsCString folderUri, msgUri;</span>
<a href="#l1.8874"></a><span id="l1.8874" class="difflineminus">-          nsCString viewFolderUri;</span>
<a href="#l1.8875"></a><span id="l1.8875" class="difflineminus">-          nsCOMPtr&lt;nsIMsgFolder&gt; curFolder = m_viewFolder ? m_viewFolder : m_folder;</span>
<a href="#l1.8876"></a><span id="l1.8876" class="difflineminus">-          if (curFolder)</span>
<a href="#l1.8877"></a><span id="l1.8877" class="difflineminus">-            curFolder-&gt;GetURI(viewFolderUri);</span>
<a href="#l1.8878"></a><span id="l1.8878" class="difflineminus">-          int32_t relPos = (motion == nsMsgNavigationType::forward)</span>
<a href="#l1.8879"></a><span id="l1.8879" class="difflineminus">-            ? 1 : (m_currentlyDisplayedMsgKey != nsMsgKey_None) ? -1 : 0;</span>
<a href="#l1.8880"></a><span id="l1.8880" class="difflineminus">-          int32_t curPos;</span>
<a href="#l1.8881"></a><span id="l1.8881" class="difflineminus">-          nsresult rv;</span>
<a href="#l1.8882"></a><span id="l1.8882" class="difflineminus">-          nsCOMPtr&lt;nsIMessenger&gt; messenger (do_QueryReferent(mMessengerWeak, &amp;rv));</span>
<a href="#l1.8883"></a><span id="l1.8883" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8884"></a><span id="l1.8884" class="difflineminus">-          rv = messenger-&gt;GetFolderUriAtNavigatePos(relPos, folderUri);</span>
<a href="#l1.8885"></a><span id="l1.8885" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8886"></a><span id="l1.8886" class="difflineminus">-          // Empty viewFolderUri means we're in a search results view.</span>
<a href="#l1.8887"></a><span id="l1.8887" class="difflineminus">-          if (viewFolderUri.IsEmpty() || folderUri.Equals(viewFolderUri))</span>
<a href="#l1.8888"></a><span id="l1.8888" class="difflineminus">-          {</span>
<a href="#l1.8889"></a><span id="l1.8889" class="difflineminus">-            nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.8890"></a><span id="l1.8890" class="difflineminus">-            rv = messenger-&gt;GetMsgUriAtNavigatePos(relPos, msgUri);</span>
<a href="#l1.8891"></a><span id="l1.8891" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8892"></a><span id="l1.8892" class="difflineminus">-            messenger-&gt;MsgHdrFromURI(msgUri, getter_AddRefs(msgHdr));</span>
<a href="#l1.8893"></a><span id="l1.8893" class="difflineminus">-            if (msgHdr)</span>
<a href="#l1.8894"></a><span id="l1.8894" class="difflineminus">-            {</span>
<a href="#l1.8895"></a><span id="l1.8895" class="difflineminus">-              messenger-&gt;GetNavigatePos(&amp;curPos);</span>
<a href="#l1.8896"></a><span id="l1.8896" class="difflineminus">-              curPos += relPos;</span>
<a href="#l1.8897"></a><span id="l1.8897" class="difflineminus">-              *pResultIndex = FindHdr(msgHdr);</span>
<a href="#l1.8898"></a><span id="l1.8898" class="difflineminus">-              messenger-&gt;SetNavigatePos(curPos);</span>
<a href="#l1.8899"></a><span id="l1.8899" class="difflineminus">-              msgHdr-&gt;GetMessageKey(pResultKey);</span>
<a href="#l1.8900"></a><span id="l1.8900" class="difflineminus">-              return NS_OK;</span>
<a href="#l1.8901"></a><span id="l1.8901" class="difflineminus">-            }</span>
<a href="#l1.8902"></a><span id="l1.8902" class="difflineminus">-          }</span>
<a href="#l1.8903"></a><span id="l1.8903" class="difflineminus">-          *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8904"></a><span id="l1.8904" class="difflineminus">-          *pResultKey = nsMsgKey_None;</span>
<a href="#l1.8905"></a><span id="l1.8905" class="difflineminus">-          break;</span>
<a href="#l1.8906"></a><span id="l1.8906" class="difflineminus">-</span>
<a href="#l1.8907"></a><span id="l1.8907" class="difflineminus">-        }</span>
<a href="#l1.8908"></a><span id="l1.8908" class="difflineminus">-        default:</span>
<a href="#l1.8909"></a><span id="l1.8909" class="difflineminus">-            NS_ERROR(&quot;unsupported motion&quot;);</span>
<a href="#l1.8910"></a><span id="l1.8910" class="difflineminus">-            break;</span>
<a href="#l1.8911"></a><span id="l1.8911" class="difflineminus">-    }</span>
<a href="#l1.8912"></a><span id="l1.8912" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.8913"></a><span id="l1.8913" class="difflineminus">-}</span>
<a href="#l1.8914"></a><span id="l1.8914" class="difflineminus">-</span>
<a href="#l1.8915"></a><span id="l1.8915" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::NavigateStatus(nsMsgNavigationTypeValue motion, bool *_retval)</span>
<a href="#l1.8916"></a><span id="l1.8916" class="difflineminus">-{</span>
<a href="#l1.8917"></a><span id="l1.8917" class="difflineminus">-    NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l1.8918"></a><span id="l1.8918" class="difflineminus">-</span>
<a href="#l1.8919"></a><span id="l1.8919" class="difflineminus">-    bool enable = false;</span>
<a href="#l1.8920"></a><span id="l1.8920" class="difflineminus">-    nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l1.8921"></a><span id="l1.8921" class="difflineminus">-    nsMsgKey resultKey = nsMsgKey_None;</span>
<a href="#l1.8922"></a><span id="l1.8922" class="difflineminus">-    int32_t index = nsMsgKey_None;</span>
<a href="#l1.8923"></a><span id="l1.8923" class="difflineminus">-    nsMsgViewIndex resultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8924"></a><span id="l1.8924" class="difflineminus">-    if (mTreeSelection)</span>
<a href="#l1.8925"></a><span id="l1.8925" class="difflineminus">-      (void) mTreeSelection-&gt;GetCurrentIndex(&amp;index);</span>
<a href="#l1.8926"></a><span id="l1.8926" class="difflineminus">-    else</span>
<a href="#l1.8927"></a><span id="l1.8927" class="difflineminus">-      index = FindViewIndex(m_currentlyDisplayedMsgKey);</span>
<a href="#l1.8928"></a><span id="l1.8928" class="difflineminus">-    nsCOMPtr&lt;nsIMessenger&gt; messenger (do_QueryReferent(mMessengerWeak));</span>
<a href="#l1.8929"></a><span id="l1.8929" class="difflineminus">-    // warning - we no longer validate index up front because fe passes in -1 for no</span>
<a href="#l1.8930"></a><span id="l1.8930" class="difflineminus">-    // selection, so if you use index, be sure to validate it before using it</span>
<a href="#l1.8931"></a><span id="l1.8931" class="difflineminus">-    // as an array index.</span>
<a href="#l1.8932"></a><span id="l1.8932" class="difflineminus">-    switch (motion)</span>
<a href="#l1.8933"></a><span id="l1.8933" class="difflineminus">-    {</span>
<a href="#l1.8934"></a><span id="l1.8934" class="difflineminus">-        case nsMsgNavigationType::firstMessage:</span>
<a href="#l1.8935"></a><span id="l1.8935" class="difflineminus">-        case nsMsgNavigationType::lastMessage:</span>
<a href="#l1.8936"></a><span id="l1.8936" class="difflineminus">-            if (GetSize() &gt; 0)</span>
<a href="#l1.8937"></a><span id="l1.8937" class="difflineminus">-                enable = true;</span>
<a href="#l1.8938"></a><span id="l1.8938" class="difflineminus">-            break;</span>
<a href="#l1.8939"></a><span id="l1.8939" class="difflineminus">-        case nsMsgNavigationType::nextMessage:</span>
<a href="#l1.8940"></a><span id="l1.8940" class="difflineminus">-            if (IsValidIndex(index) &amp;&amp; uint32_t(index) &lt; GetSize() - 1)</span>
<a href="#l1.8941"></a><span id="l1.8941" class="difflineminus">-                enable = true;</span>
<a href="#l1.8942"></a><span id="l1.8942" class="difflineminus">-            break;</span>
<a href="#l1.8943"></a><span id="l1.8943" class="difflineminus">-        case nsMsgNavigationType::previousMessage:</span>
<a href="#l1.8944"></a><span id="l1.8944" class="difflineminus">-            if (IsValidIndex(index) &amp;&amp; index != 0 &amp;&amp; GetSize() &gt; 1)</span>
<a href="#l1.8945"></a><span id="l1.8945" class="difflineminus">-                enable = true;</span>
<a href="#l1.8946"></a><span id="l1.8946" class="difflineminus">-            break;</span>
<a href="#l1.8947"></a><span id="l1.8947" class="difflineminus">-        case nsMsgNavigationType::firstFlagged:</span>
<a href="#l1.8948"></a><span id="l1.8948" class="difflineminus">-            rv = FindFirstFlagged(&amp;resultIndex);</span>
<a href="#l1.8949"></a><span id="l1.8949" class="difflineminus">-            enable = (NS_SUCCEEDED(rv) &amp;&amp; resultIndex != nsMsgViewIndex_None);</span>
<a href="#l1.8950"></a><span id="l1.8950" class="difflineminus">-            break;</span>
<a href="#l1.8951"></a><span id="l1.8951" class="difflineminus">-        case nsMsgNavigationType::nextFlagged:</span>
<a href="#l1.8952"></a><span id="l1.8952" class="difflineminus">-            rv = FindNextFlagged(index + 1, &amp;resultIndex);</span>
<a href="#l1.8953"></a><span id="l1.8953" class="difflineminus">-            enable = (NS_SUCCEEDED(rv) &amp;&amp; resultIndex != nsMsgViewIndex_None);</span>
<a href="#l1.8954"></a><span id="l1.8954" class="difflineminus">-            break;</span>
<a href="#l1.8955"></a><span id="l1.8955" class="difflineminus">-        case nsMsgNavigationType::previousFlagged:</span>
<a href="#l1.8956"></a><span id="l1.8956" class="difflineminus">-            if (IsValidIndex(index) &amp;&amp; index != 0)</span>
<a href="#l1.8957"></a><span id="l1.8957" class="difflineminus">-                rv = FindPrevFlagged(index, &amp;resultIndex);</span>
<a href="#l1.8958"></a><span id="l1.8958" class="difflineminus">-            enable = (NS_SUCCEEDED(rv) &amp;&amp; resultIndex != nsMsgViewIndex_None);</span>
<a href="#l1.8959"></a><span id="l1.8959" class="difflineminus">-            break;</span>
<a href="#l1.8960"></a><span id="l1.8960" class="difflineminus">-        case nsMsgNavigationType::firstNew:</span>
<a href="#l1.8961"></a><span id="l1.8961" class="difflineminus">-            rv = FindFirstNew(&amp;resultIndex);</span>
<a href="#l1.8962"></a><span id="l1.8962" class="difflineminus">-            enable = (NS_SUCCEEDED(rv) &amp;&amp; resultIndex != nsMsgViewIndex_None);</span>
<a href="#l1.8963"></a><span id="l1.8963" class="difflineminus">-            break;</span>
<a href="#l1.8964"></a><span id="l1.8964" class="difflineminus">-        case nsMsgNavigationType::readMore:</span>
<a href="#l1.8965"></a><span id="l1.8965" class="difflineminus">-            enable = true;  // for now, always true.</span>
<a href="#l1.8966"></a><span id="l1.8966" class="difflineminus">-            break;</span>
<a href="#l1.8967"></a><span id="l1.8967" class="difflineminus">-        case nsMsgNavigationType::nextFolder:</span>
<a href="#l1.8968"></a><span id="l1.8968" class="difflineminus">-        case nsMsgNavigationType::nextUnreadThread:</span>
<a href="#l1.8969"></a><span id="l1.8969" class="difflineminus">-        case nsMsgNavigationType::nextUnreadMessage:</span>
<a href="#l1.8970"></a><span id="l1.8970" class="difflineminus">-        case nsMsgNavigationType::toggleThreadKilled:</span>
<a href="#l1.8971"></a><span id="l1.8971" class="difflineminus">-            enable = true;  // always enabled</span>
<a href="#l1.8972"></a><span id="l1.8972" class="difflineminus">-            break;</span>
<a href="#l1.8973"></a><span id="l1.8973" class="difflineminus">-        case nsMsgNavigationType::previousUnreadMessage:</span>
<a href="#l1.8974"></a><span id="l1.8974" class="difflineminus">-            if (IsValidIndex(index))</span>
<a href="#l1.8975"></a><span id="l1.8975" class="difflineminus">-            {</span>
<a href="#l1.8976"></a><span id="l1.8976" class="difflineminus">-                nsMsgKey threadId;</span>
<a href="#l1.8977"></a><span id="l1.8977" class="difflineminus">-                rv = FindPrevUnread(m_keys[index], &amp;resultKey, &amp;threadId);</span>
<a href="#l1.8978"></a><span id="l1.8978" class="difflineminus">-                enable = (resultKey != nsMsgKey_None);</span>
<a href="#l1.8979"></a><span id="l1.8979" class="difflineminus">-            }</span>
<a href="#l1.8980"></a><span id="l1.8980" class="difflineminus">-            break;</span>
<a href="#l1.8981"></a><span id="l1.8981" class="difflineminus">-        case nsMsgNavigationType::forward:</span>
<a href="#l1.8982"></a><span id="l1.8982" class="difflineminus">-        case nsMsgNavigationType::back:</span>
<a href="#l1.8983"></a><span id="l1.8983" class="difflineminus">-        {</span>
<a href="#l1.8984"></a><span id="l1.8984" class="difflineminus">-          uint32_t curPos;</span>
<a href="#l1.8985"></a><span id="l1.8985" class="difflineminus">-          uint32_t historyCount;</span>
<a href="#l1.8986"></a><span id="l1.8986" class="difflineminus">-</span>
<a href="#l1.8987"></a><span id="l1.8987" class="difflineminus">-          if (messenger)</span>
<a href="#l1.8988"></a><span id="l1.8988" class="difflineminus">-          {</span>
<a href="#l1.8989"></a><span id="l1.8989" class="difflineminus">-            messenger-&gt;GetNavigateHistory(&amp;curPos, &amp;historyCount, nullptr);</span>
<a href="#l1.8990"></a><span id="l1.8990" class="difflineminus">-            int32_t desiredPos = (int32_t) curPos;</span>
<a href="#l1.8991"></a><span id="l1.8991" class="difflineminus">-            if (motion == nsMsgNavigationType::forward)</span>
<a href="#l1.8992"></a><span id="l1.8992" class="difflineminus">-              desiredPos++;</span>
<a href="#l1.8993"></a><span id="l1.8993" class="difflineminus">-            else</span>
<a href="#l1.8994"></a><span id="l1.8994" class="difflineminus">-              desiredPos--; //? operator code didn't work for me</span>
<a href="#l1.8995"></a><span id="l1.8995" class="difflineminus">-            enable = (desiredPos &gt;= 0 &amp;&amp; desiredPos &lt; (int32_t) historyCount / 2);</span>
<a href="#l1.8996"></a><span id="l1.8996" class="difflineminus">-          }</span>
<a href="#l1.8997"></a><span id="l1.8997" class="difflineminus">-        }</span>
<a href="#l1.8998"></a><span id="l1.8998" class="difflineminus">-          break;</span>
<a href="#l1.8999"></a><span id="l1.8999" class="difflineminus">-</span>
<a href="#l1.9000"></a><span id="l1.9000" class="difflineminus">-        default:</span>
<a href="#l1.9001"></a><span id="l1.9001" class="difflineminus">-            NS_ERROR(&quot;unexpected&quot;);</span>
<a href="#l1.9002"></a><span id="l1.9002" class="difflineminus">-            break;</span>
<a href="#l1.9003"></a><span id="l1.9003" class="difflineminus">-    }</span>
<a href="#l1.9004"></a><span id="l1.9004" class="difflineminus">-</span>
<a href="#l1.9005"></a><span id="l1.9005" class="difflineminus">-    *_retval = enable;</span>
<a href="#l1.9006"></a><span id="l1.9006" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.9007"></a><span id="l1.9007" class="difflineminus">-}</span>
<a href="#l1.9008"></a><span id="l1.9008" class="difflineminus">-</span>
<a href="#l1.9009"></a><span id="l1.9009" class="difflineminus">-// Note that these routines do NOT expand collapsed threads! This mimics the old behaviour,</span>
<a href="#l1.9010"></a><span id="l1.9010" class="difflineminus">-// but it's also because we don't remember whether a thread contains a flagged message the</span>
<a href="#l1.9011"></a><span id="l1.9011" class="difflineminus">-// same way we remember if a thread contains new messages. It would be painful to dive down</span>
<a href="#l1.9012"></a><span id="l1.9012" class="difflineminus">-// into each collapsed thread to update navigate status.</span>
<a href="#l1.9013"></a><span id="l1.9013" class="difflineminus">-// We could cache this info, but it would still be expensive the first time this status needs</span>
<a href="#l1.9014"></a><span id="l1.9014" class="difflineminus">-// to get updated.</span>
<a href="#l1.9015"></a><span id="l1.9015" class="difflineminus">-nsresult nsMsgDBView::FindNextFlagged(nsMsgViewIndex startIndex, nsMsgViewIndex *pResultIndex)</span>
<a href="#l1.9016"></a><span id="l1.9016" class="difflineminus">-{</span>
<a href="#l1.9017"></a><span id="l1.9017" class="difflineminus">-    nsMsgViewIndex lastIndex = (nsMsgViewIndex) GetSize() - 1;</span>
<a href="#l1.9018"></a><span id="l1.9018" class="difflineminus">-    nsMsgViewIndex curIndex;</span>
<a href="#l1.9019"></a><span id="l1.9019" class="difflineminus">-</span>
<a href="#l1.9020"></a><span id="l1.9020" class="difflineminus">-    *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.9021"></a><span id="l1.9021" class="difflineminus">-</span>
<a href="#l1.9022"></a><span id="l1.9022" class="difflineminus">-    if (GetSize() &gt; 0)</span>
<a href="#l1.9023"></a><span id="l1.9023" class="difflineminus">-    {</span>
<a href="#l1.9024"></a><span id="l1.9024" class="difflineminus">-        for (curIndex = startIndex; curIndex &lt;= lastIndex; curIndex++)</span>
<a href="#l1.9025"></a><span id="l1.9025" class="difflineminus">-        {</span>
<a href="#l1.9026"></a><span id="l1.9026" class="difflineminus">-            uint32_t flags = m_flags[curIndex];</span>
<a href="#l1.9027"></a><span id="l1.9027" class="difflineminus">-            if (flags &amp; nsMsgMessageFlags::Marked)</span>
<a href="#l1.9028"></a><span id="l1.9028" class="difflineminus">-            {</span>
<a href="#l1.9029"></a><span id="l1.9029" class="difflineminus">-                *pResultIndex = curIndex;</span>
<a href="#l1.9030"></a><span id="l1.9030" class="difflineminus">-                break;</span>
<a href="#l1.9031"></a><span id="l1.9031" class="difflineminus">-            }</span>
<a href="#l1.9032"></a><span id="l1.9032" class="difflineminus">-        }</span>
<a href="#l1.9033"></a><span id="l1.9033" class="difflineminus">-    }</span>
<a href="#l1.9034"></a><span id="l1.9034" class="difflineminus">-</span>
<a href="#l1.9035"></a><span id="l1.9035" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.9036"></a><span id="l1.9036" class="difflineminus">-}</span>
<a href="#l1.9037"></a><span id="l1.9037" class="difflineminus">-</span>
<a href="#l1.9038"></a><span id="l1.9038" class="difflineminus">-nsresult nsMsgDBView::FindFirstNew(nsMsgViewIndex *pResultIndex)</span>
<a href="#l1.9039"></a><span id="l1.9039" class="difflineplus">+      break;</span>
<a href="#l1.9040"></a><span id="l1.9040" class="difflineplus">+    }</span>
<a href="#l1.9041"></a><span id="l1.9041" class="difflineplus">+    default:</span>
<a href="#l1.9042"></a><span id="l1.9042" class="difflineplus">+      NS_ERROR(&quot;unsupported motion&quot;);</span>
<a href="#l1.9043"></a><span id="l1.9043" class="difflineplus">+      break;</span>
<a href="#l1.9044"></a><span id="l1.9044" class="difflineplus">+  }</span>
<a href="#l1.9045"></a><span id="l1.9045" class="difflineplus">+</span>
<a href="#l1.9046"></a><span id="l1.9046" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.9047"></a><span id="l1.9047" class="difflineplus">+}</span>
<a href="#l1.9048"></a><span id="l1.9048" class="difflineplus">+</span>
<a href="#l1.9049"></a><span id="l1.9049" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.9050"></a><span id="l1.9050" class="difflineplus">+nsMsgDBView::NavigateStatus(nsMsgNavigationTypeValue motion,</span>
<a href="#l1.9051"></a><span id="l1.9051" class="difflineplus">+                            bool *_retval)</span>
<a href="#l1.9052"></a><span id="l1.9052" class="difflineplus">+{</span>
<a href="#l1.9053"></a><span id="l1.9053" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l1.9054"></a><span id="l1.9054" class="difflineplus">+</span>
<a href="#l1.9055"></a><span id="l1.9055" class="difflineplus">+  bool enable = false;</span>
<a href="#l1.9056"></a><span id="l1.9056" class="difflineplus">+  nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l1.9057"></a><span id="l1.9057" class="difflineplus">+  nsMsgKey resultKey = nsMsgKey_None;</span>
<a href="#l1.9058"></a><span id="l1.9058" class="difflineplus">+  int32_t index = nsMsgKey_None;</span>
<a href="#l1.9059"></a><span id="l1.9059" class="difflineplus">+  nsMsgViewIndex resultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.9060"></a><span id="l1.9060" class="difflineplus">+  if (mTreeSelection)</span>
<a href="#l1.9061"></a><span id="l1.9061" class="difflineplus">+    (void) mTreeSelection-&gt;GetCurrentIndex(&amp;index);</span>
<a href="#l1.9062"></a><span id="l1.9062" class="difflineplus">+  else</span>
<a href="#l1.9063"></a><span id="l1.9063" class="difflineplus">+    index = FindViewIndex(m_currentlyDisplayedMsgKey);</span>
<a href="#l1.9064"></a><span id="l1.9064" class="difflineplus">+</span>
<a href="#l1.9065"></a><span id="l1.9065" class="difflineplus">+  nsCOMPtr&lt;nsIMessenger&gt; messenger(do_QueryReferent(mMessengerWeak));</span>
<a href="#l1.9066"></a><span id="l1.9066" class="difflineplus">+  // Warning - we no longer validate index up front because fe passes in -1</span>
<a href="#l1.9067"></a><span id="l1.9067" class="difflineplus">+  // for no selection, so if you use index, be sure to validate it before</span>
<a href="#l1.9068"></a><span id="l1.9068" class="difflineplus">+  // using it as an array index.</span>
<a href="#l1.9069"></a><span id="l1.9069" class="difflineplus">+  switch (motion)</span>
<a href="#l1.9070"></a><span id="l1.9070" class="difflineplus">+  {</span>
<a href="#l1.9071"></a><span id="l1.9071" class="difflineplus">+    case nsMsgNavigationType::firstMessage:</span>
<a href="#l1.9072"></a><span id="l1.9072" class="difflineplus">+    case nsMsgNavigationType::lastMessage:</span>
<a href="#l1.9073"></a><span id="l1.9073" class="difflineplus">+      if (GetSize() &gt; 0)</span>
<a href="#l1.9074"></a><span id="l1.9074" class="difflineplus">+        enable = true;</span>
<a href="#l1.9075"></a><span id="l1.9075" class="difflineplus">+</span>
<a href="#l1.9076"></a><span id="l1.9076" class="difflineplus">+      break;</span>
<a href="#l1.9077"></a><span id="l1.9077" class="difflineplus">+    case nsMsgNavigationType::nextMessage:</span>
<a href="#l1.9078"></a><span id="l1.9078" class="difflineplus">+      if (IsValidIndex(index) &amp;&amp; uint32_t(index) &lt; GetSize() - 1)</span>
<a href="#l1.9079"></a><span id="l1.9079" class="difflineplus">+        enable = true;</span>
<a href="#l1.9080"></a><span id="l1.9080" class="difflineplus">+</span>
<a href="#l1.9081"></a><span id="l1.9081" class="difflineplus">+      break;</span>
<a href="#l1.9082"></a><span id="l1.9082" class="difflineplus">+    case nsMsgNavigationType::previousMessage:</span>
<a href="#l1.9083"></a><span id="l1.9083" class="difflineplus">+      if (IsValidIndex(index) &amp;&amp; index != 0 &amp;&amp; GetSize() &gt; 1)</span>
<a href="#l1.9084"></a><span id="l1.9084" class="difflineplus">+        enable = true;</span>
<a href="#l1.9085"></a><span id="l1.9085" class="difflineplus">+</span>
<a href="#l1.9086"></a><span id="l1.9086" class="difflineplus">+      break;</span>
<a href="#l1.9087"></a><span id="l1.9087" class="difflineplus">+    case nsMsgNavigationType::firstFlagged:</span>
<a href="#l1.9088"></a><span id="l1.9088" class="difflineplus">+      rv = FindFirstFlagged(&amp;resultIndex);</span>
<a href="#l1.9089"></a><span id="l1.9089" class="difflineplus">+      enable = (NS_SUCCEEDED(rv) &amp;&amp; resultIndex != nsMsgViewIndex_None);</span>
<a href="#l1.9090"></a><span id="l1.9090" class="difflineplus">+      break;</span>
<a href="#l1.9091"></a><span id="l1.9091" class="difflineplus">+    case nsMsgNavigationType::nextFlagged:</span>
<a href="#l1.9092"></a><span id="l1.9092" class="difflineplus">+      rv = FindNextFlagged(index + 1, &amp;resultIndex);</span>
<a href="#l1.9093"></a><span id="l1.9093" class="difflineplus">+      enable = (NS_SUCCEEDED(rv) &amp;&amp; resultIndex != nsMsgViewIndex_None);</span>
<a href="#l1.9094"></a><span id="l1.9094" class="difflineplus">+      break;</span>
<a href="#l1.9095"></a><span id="l1.9095" class="difflineplus">+    case nsMsgNavigationType::previousFlagged:</span>
<a href="#l1.9096"></a><span id="l1.9096" class="difflineplus">+      if (IsValidIndex(index) &amp;&amp; index != 0)</span>
<a href="#l1.9097"></a><span id="l1.9097" class="difflineplus">+        rv = FindPrevFlagged(index, &amp;resultIndex);</span>
<a href="#l1.9098"></a><span id="l1.9098" class="difflineplus">+</span>
<a href="#l1.9099"></a><span id="l1.9099" class="difflineplus">+      enable = (NS_SUCCEEDED(rv) &amp;&amp; resultIndex != nsMsgViewIndex_None);</span>
<a href="#l1.9100"></a><span id="l1.9100" class="difflineplus">+      break;</span>
<a href="#l1.9101"></a><span id="l1.9101" class="difflineplus">+    case nsMsgNavigationType::firstNew:</span>
<a href="#l1.9102"></a><span id="l1.9102" class="difflineplus">+      rv = FindFirstNew(&amp;resultIndex);</span>
<a href="#l1.9103"></a><span id="l1.9103" class="difflineplus">+      enable = (NS_SUCCEEDED(rv) &amp;&amp; resultIndex != nsMsgViewIndex_None);</span>
<a href="#l1.9104"></a><span id="l1.9104" class="difflineplus">+      break;</span>
<a href="#l1.9105"></a><span id="l1.9105" class="difflineplus">+    case nsMsgNavigationType::readMore:</span>
<a href="#l1.9106"></a><span id="l1.9106" class="difflineplus">+      // For now, always true.</span>
<a href="#l1.9107"></a><span id="l1.9107" class="difflineplus">+      enable = true;</span>
<a href="#l1.9108"></a><span id="l1.9108" class="difflineplus">+      break;</span>
<a href="#l1.9109"></a><span id="l1.9109" class="difflineplus">+    case nsMsgNavigationType::nextFolder:</span>
<a href="#l1.9110"></a><span id="l1.9110" class="difflineplus">+    case nsMsgNavigationType::nextUnreadThread:</span>
<a href="#l1.9111"></a><span id="l1.9111" class="difflineplus">+    case nsMsgNavigationType::nextUnreadMessage:</span>
<a href="#l1.9112"></a><span id="l1.9112" class="difflineplus">+    case nsMsgNavigationType::toggleThreadKilled:</span>
<a href="#l1.9113"></a><span id="l1.9113" class="difflineplus">+      // Always enabled.</span>
<a href="#l1.9114"></a><span id="l1.9114" class="difflineplus">+      enable = true;</span>
<a href="#l1.9115"></a><span id="l1.9115" class="difflineplus">+      break;</span>
<a href="#l1.9116"></a><span id="l1.9116" class="difflineplus">+    case nsMsgNavigationType::previousUnreadMessage:</span>
<a href="#l1.9117"></a><span id="l1.9117" class="difflineplus">+      if (IsValidIndex(index))</span>
<a href="#l1.9118"></a><span id="l1.9118" class="difflineplus">+      {</span>
<a href="#l1.9119"></a><span id="l1.9119" class="difflineplus">+        nsMsgKey threadId;</span>
<a href="#l1.9120"></a><span id="l1.9120" class="difflineplus">+        rv = FindPrevUnread(m_keys[index], &amp;resultKey, &amp;threadId);</span>
<a href="#l1.9121"></a><span id="l1.9121" class="difflineplus">+        enable = (resultKey != nsMsgKey_None);</span>
<a href="#l1.9122"></a><span id="l1.9122" class="difflineplus">+      }</span>
<a href="#l1.9123"></a><span id="l1.9123" class="difflineplus">+      break;</span>
<a href="#l1.9124"></a><span id="l1.9124" class="difflineplus">+    case nsMsgNavigationType::forward:</span>
<a href="#l1.9125"></a><span id="l1.9125" class="difflineplus">+    case nsMsgNavigationType::back:</span>
<a href="#l1.9126"></a><span id="l1.9126" class="difflineplus">+      uint32_t curPos;</span>
<a href="#l1.9127"></a><span id="l1.9127" class="difflineplus">+      uint32_t historyCount;</span>
<a href="#l1.9128"></a><span id="l1.9128" class="difflineplus">+      if (messenger)</span>
<a href="#l1.9129"></a><span id="l1.9129" class="difflineplus">+      {</span>
<a href="#l1.9130"></a><span id="l1.9130" class="difflineplus">+        messenger-&gt;GetNavigateHistory(&amp;curPos, &amp;historyCount, nullptr);</span>
<a href="#l1.9131"></a><span id="l1.9131" class="difflineplus">+        int32_t desiredPos = (int32_t) curPos;</span>
<a href="#l1.9132"></a><span id="l1.9132" class="difflineplus">+        if (motion == nsMsgNavigationType::forward)</span>
<a href="#l1.9133"></a><span id="l1.9133" class="difflineplus">+          desiredPos++;</span>
<a href="#l1.9134"></a><span id="l1.9134" class="difflineplus">+        else</span>
<a href="#l1.9135"></a><span id="l1.9135" class="difflineplus">+          //? operator code didn't work for me.</span>
<a href="#l1.9136"></a><span id="l1.9136" class="difflineplus">+          desiredPos--;</span>
<a href="#l1.9137"></a><span id="l1.9137" class="difflineplus">+</span>
<a href="#l1.9138"></a><span id="l1.9138" class="difflineplus">+        enable = (desiredPos &gt;= 0 &amp;&amp; desiredPos &lt; (int32_t) historyCount / 2);</span>
<a href="#l1.9139"></a><span id="l1.9139" class="difflineplus">+      }</span>
<a href="#l1.9140"></a><span id="l1.9140" class="difflineplus">+      break;</span>
<a href="#l1.9141"></a><span id="l1.9141" class="difflineplus">+    default:</span>
<a href="#l1.9142"></a><span id="l1.9142" class="difflineplus">+      NS_ERROR(&quot;unexpected&quot;);</span>
<a href="#l1.9143"></a><span id="l1.9143" class="difflineplus">+      break;</span>
<a href="#l1.9144"></a><span id="l1.9144" class="difflineplus">+  }</span>
<a href="#l1.9145"></a><span id="l1.9145" class="difflineplus">+</span>
<a href="#l1.9146"></a><span id="l1.9146" class="difflineplus">+  *_retval = enable;</span>
<a href="#l1.9147"></a><span id="l1.9147" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.9148"></a><span id="l1.9148" class="difflineplus">+}</span>
<a href="#l1.9149"></a><span id="l1.9149" class="difflineplus">+</span>
<a href="#l1.9150"></a><span id="l1.9150" class="difflineplus">+// Note that these routines do NOT expand collapsed threads! This mimics the</span>
<a href="#l1.9151"></a><span id="l1.9151" class="difflineplus">+// old behaviour, but it's also because we don't remember whether a thread</span>
<a href="#l1.9152"></a><span id="l1.9152" class="difflineplus">+// contains a flagged message the same way we remember if a thread contains</span>
<a href="#l1.9153"></a><span id="l1.9153" class="difflineplus">+// new messages. It would be painful to dive down into each collapsed thread</span>
<a href="#l1.9154"></a><span id="l1.9154" class="difflineplus">+// to update navigate status. We could cache this info, but it would still be</span>
<a href="#l1.9155"></a><span id="l1.9155" class="difflineplus">+// expensive the first time this status needs to get updated.</span>
<a href="#l1.9156"></a><span id="l1.9156" class="difflineplus">+nsresult</span>
<a href="#l1.9157"></a><span id="l1.9157" class="difflineplus">+nsMsgDBView::FindNextFlagged(nsMsgViewIndex startIndex,</span>
<a href="#l1.9158"></a><span id="l1.9158" class="difflineplus">+                             nsMsgViewIndex *pResultIndex)</span>
<a href="#l1.9159"></a><span id="l1.9159" class="difflineplus">+{</span>
<a href="#l1.9160"></a><span id="l1.9160" class="difflineplus">+  nsMsgViewIndex lastIndex = (nsMsgViewIndex) GetSize() - 1;</span>
<a href="#l1.9161"></a><span id="l1.9161" class="difflineplus">+  nsMsgViewIndex curIndex;</span>
<a href="#l1.9162"></a><span id="l1.9162" class="difflineplus">+</span>
<a href="#l1.9163"></a><span id="l1.9163" class="difflineplus">+  *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.9164"></a><span id="l1.9164" class="difflineplus">+</span>
<a href="#l1.9165"></a><span id="l1.9165" class="difflineplus">+  if (GetSize() &gt; 0)</span>
<a href="#l1.9166"></a><span id="l1.9166" class="difflineplus">+  {</span>
<a href="#l1.9167"></a><span id="l1.9167" class="difflineplus">+    for (curIndex = startIndex; curIndex &lt;= lastIndex; curIndex++)</span>
<a href="#l1.9168"></a><span id="l1.9168" class="difflineplus">+    {</span>
<a href="#l1.9169"></a><span id="l1.9169" class="difflineplus">+      uint32_t flags = m_flags[curIndex];</span>
<a href="#l1.9170"></a><span id="l1.9170" class="difflineplus">+      if (flags &amp; nsMsgMessageFlags::Marked)</span>
<a href="#l1.9171"></a><span id="l1.9171" class="difflineplus">+      {</span>
<a href="#l1.9172"></a><span id="l1.9172" class="difflineplus">+        *pResultIndex = curIndex;</span>
<a href="#l1.9173"></a><span id="l1.9173" class="difflineplus">+        break;</span>
<a href="#l1.9174"></a><span id="l1.9174" class="difflineplus">+      }</span>
<a href="#l1.9175"></a><span id="l1.9175" class="difflineplus">+    }</span>
<a href="#l1.9176"></a><span id="l1.9176" class="difflineplus">+  }</span>
<a href="#l1.9177"></a><span id="l1.9177" class="difflineplus">+</span>
<a href="#l1.9178"></a><span id="l1.9178" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.9179"></a><span id="l1.9179" class="difflineplus">+}</span>
<a href="#l1.9180"></a><span id="l1.9180" class="difflineplus">+</span>
<a href="#l1.9181"></a><span id="l1.9181" class="difflineplus">+nsresult</span>
<a href="#l1.9182"></a><span id="l1.9182" class="difflineplus">+nsMsgDBView::FindFirstNew(nsMsgViewIndex *pResultIndex)</span>
<a href="#l1.9183"></a><span id="l1.9183"> {</span>
<a href="#l1.9184"></a><span id="l1.9184">   if (m_db)</span>
<a href="#l1.9185"></a><span id="l1.9185">   {</span>
<a href="#l1.9186"></a><span id="l1.9186">     nsMsgKey firstNewKey = nsMsgKey_None;</span>
<a href="#l1.9187"></a><span id="l1.9187">     m_db-&gt;GetFirstNew(&amp;firstNewKey);</span>
<a href="#l1.9188"></a><span id="l1.9188" class="difflineminus">-    *pResultIndex = (firstNewKey != nsMsgKey_None)</span>
<a href="#l1.9189"></a><span id="l1.9189" class="difflineminus">-        ? FindKey(firstNewKey, true) : nsMsgViewIndex_None;</span>
<a href="#l1.9190"></a><span id="l1.9190" class="difflineminus">-  }</span>
<a href="#l1.9191"></a><span id="l1.9191" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.9192"></a><span id="l1.9192" class="difflineminus">-}</span>
<a href="#l1.9193"></a><span id="l1.9193" class="difflineminus">-</span>
<a href="#l1.9194"></a><span id="l1.9194" class="difflineminus">-nsresult nsMsgDBView::FindPrevUnread(nsMsgKey startKey, nsMsgKey *pResultKey,</span>
<a href="#l1.9195"></a><span id="l1.9195" class="difflineminus">-                                     nsMsgKey *resultThreadId)</span>
<a href="#l1.9196"></a><span id="l1.9196" class="difflineminus">-{</span>
<a href="#l1.9197"></a><span id="l1.9197" class="difflineminus">-    nsMsgViewIndex startIndex = FindViewIndex(startKey);</span>
<a href="#l1.9198"></a><span id="l1.9198" class="difflineminus">-    nsMsgViewIndex curIndex = startIndex;</span>
<a href="#l1.9199"></a><span id="l1.9199" class="difflineminus">-    nsresult rv = NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.9200"></a><span id="l1.9200" class="difflineminus">-</span>
<a href="#l1.9201"></a><span id="l1.9201" class="difflineminus">-    if (startIndex == nsMsgViewIndex_None)</span>
<a href="#l1.9202"></a><span id="l1.9202" class="difflineminus">-        return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.9203"></a><span id="l1.9203" class="difflineminus">-</span>
<a href="#l1.9204"></a><span id="l1.9204" class="difflineminus">-    *pResultKey = nsMsgKey_None;</span>
<a href="#l1.9205"></a><span id="l1.9205" class="difflineminus">-    if (resultThreadId)</span>
<a href="#l1.9206"></a><span id="l1.9206" class="difflineminus">-        *resultThreadId = nsMsgKey_None;</span>
<a href="#l1.9207"></a><span id="l1.9207" class="difflineminus">-</span>
<a href="#l1.9208"></a><span id="l1.9208" class="difflineminus">-    for (; (int) curIndex &gt;= 0 &amp;&amp; (*pResultKey == nsMsgKey_None); curIndex--)</span>
<a href="#l1.9209"></a><span id="l1.9209" class="difflineminus">-    {</span>
<a href="#l1.9210"></a><span id="l1.9210" class="difflineminus">-        uint32_t flags = m_flags[curIndex];</span>
<a href="#l1.9211"></a><span id="l1.9211" class="difflineminus">-</span>
<a href="#l1.9212"></a><span id="l1.9212" class="difflineminus">-        if (curIndex != startIndex &amp;&amp; flags &amp; MSG_VIEW_FLAG_ISTHREAD &amp;&amp; flags &amp; nsMsgMessageFlags::Elided)</span>
<a href="#l1.9213"></a><span id="l1.9213" class="difflineminus">-        {</span>
<a href="#l1.9214"></a><span id="l1.9214" class="difflineminus">-            NS_ERROR(&quot;fix this&quot;);</span>
<a href="#l1.9215"></a><span id="l1.9215" class="difflineminus">-            //nsMsgKey threadId = m_keys[curIndex];</span>
<a href="#l1.9216"></a><span id="l1.9216" class="difflineminus">-            //rv = m_db-&gt;GetUnreadKeyInThread(threadId, pResultKey, resultThreadId);</span>
<a href="#l1.9217"></a><span id="l1.9217" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; (*pResultKey != nsMsgKey_None))</span>
<a href="#l1.9218"></a><span id="l1.9218" class="difflineminus">-                break;</span>
<a href="#l1.9219"></a><span id="l1.9219" class="difflineminus">-        }</span>
<a href="#l1.9220"></a><span id="l1.9220" class="difflineminus">-        if (!(flags &amp; (nsMsgMessageFlags::Read | MSG_VIEW_FLAG_DUMMY)) &amp;&amp; (curIndex != startIndex))</span>
<a href="#l1.9221"></a><span id="l1.9221" class="difflineminus">-        {</span>
<a href="#l1.9222"></a><span id="l1.9222" class="difflineminus">-            *pResultKey = m_keys[curIndex];</span>
<a href="#l1.9223"></a><span id="l1.9223" class="difflineminus">-            rv = NS_OK;</span>
<a href="#l1.9224"></a><span id="l1.9224" class="difflineminus">-            break;</span>
<a href="#l1.9225"></a><span id="l1.9225" class="difflineminus">-        }</span>
<a href="#l1.9226"></a><span id="l1.9226" class="difflineminus">-    }</span>
<a href="#l1.9227"></a><span id="l1.9227" class="difflineminus">-    // found unread message but we don't know the thread</span>
<a href="#l1.9228"></a><span id="l1.9228" class="difflineminus">-    NS_ASSERTION(!(*pResultKey != nsMsgKey_None &amp;&amp; resultThreadId &amp;&amp; *resultThreadId == nsMsgKey_None),</span>
<a href="#l1.9229"></a><span id="l1.9229" class="difflineminus">-      &quot;fix this&quot;);</span>
<a href="#l1.9230"></a><span id="l1.9230" class="difflineminus">-    return rv;</span>
<a href="#l1.9231"></a><span id="l1.9231" class="difflineminus">-}</span>
<a href="#l1.9232"></a><span id="l1.9232" class="difflineminus">-</span>
<a href="#l1.9233"></a><span id="l1.9233" class="difflineminus">-nsresult nsMsgDBView::FindFirstFlagged(nsMsgViewIndex *pResultIndex)</span>
<a href="#l1.9234"></a><span id="l1.9234" class="difflineminus">-{</span>
<a href="#l1.9235"></a><span id="l1.9235" class="difflineminus">-    return FindNextFlagged(0, pResultIndex);</span>
<a href="#l1.9236"></a><span id="l1.9236" class="difflineminus">-}</span>
<a href="#l1.9237"></a><span id="l1.9237" class="difflineminus">-</span>
<a href="#l1.9238"></a><span id="l1.9238" class="difflineminus">-nsresult nsMsgDBView::FindPrevFlagged(nsMsgViewIndex startIndex, nsMsgViewIndex *pResultIndex)</span>
<a href="#l1.9239"></a><span id="l1.9239" class="difflineminus">-{</span>
<a href="#l1.9240"></a><span id="l1.9240" class="difflineminus">-    nsMsgViewIndex curIndex;</span>
<a href="#l1.9241"></a><span id="l1.9241" class="difflineminus">-</span>
<a href="#l1.9242"></a><span id="l1.9242" class="difflineminus">-    *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.9243"></a><span id="l1.9243" class="difflineminus">-</span>
<a href="#l1.9244"></a><span id="l1.9244" class="difflineminus">-    if (GetSize() &gt; 0 &amp;&amp; IsValidIndex(startIndex))</span>
<a href="#l1.9245"></a><span id="l1.9245" class="difflineminus">-    {</span>
<a href="#l1.9246"></a><span id="l1.9246" class="difflineminus">-        curIndex = startIndex;</span>
<a href="#l1.9247"></a><span id="l1.9247" class="difflineminus">-        do</span>
<a href="#l1.9248"></a><span id="l1.9248" class="difflineminus">-        {</span>
<a href="#l1.9249"></a><span id="l1.9249" class="difflineminus">-            if (curIndex != 0)</span>
<a href="#l1.9250"></a><span id="l1.9250" class="difflineminus">-                curIndex--;</span>
<a href="#l1.9251"></a><span id="l1.9251" class="difflineminus">-</span>
<a href="#l1.9252"></a><span id="l1.9252" class="difflineminus">-            uint32_t flags = m_flags[curIndex];</span>
<a href="#l1.9253"></a><span id="l1.9253" class="difflineminus">-            if (flags &amp; nsMsgMessageFlags::Marked)</span>
<a href="#l1.9254"></a><span id="l1.9254" class="difflineminus">-            {</span>
<a href="#l1.9255"></a><span id="l1.9255" class="difflineminus">-                *pResultIndex = curIndex;</span>
<a href="#l1.9256"></a><span id="l1.9256" class="difflineminus">-                break;</span>
<a href="#l1.9257"></a><span id="l1.9257" class="difflineminus">-            }</span>
<a href="#l1.9258"></a><span id="l1.9258" class="difflineminus">-        }</span>
<a href="#l1.9259"></a><span id="l1.9259" class="difflineminus">-        while (curIndex != 0);</span>
<a href="#l1.9260"></a><span id="l1.9260" class="difflineminus">-    }</span>
<a href="#l1.9261"></a><span id="l1.9261" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.9262"></a><span id="l1.9262" class="difflineminus">-}</span>
<a href="#l1.9263"></a><span id="l1.9263" class="difflineminus">-</span>
<a href="#l1.9264"></a><span id="l1.9264" class="difflineminus">-bool nsMsgDBView::IsValidIndex(nsMsgViewIndex index)</span>
<a href="#l1.9265"></a><span id="l1.9265" class="difflineminus">-{</span>
<a href="#l1.9266"></a><span id="l1.9266" class="difflineminus">-    return index != nsMsgViewIndex_None &amp;&amp;</span>
<a href="#l1.9267"></a><span id="l1.9267" class="difflineminus">-           (index &lt; (nsMsgViewIndex) m_keys.Length());</span>
<a href="#l1.9268"></a><span id="l1.9268" class="difflineminus">-}</span>
<a href="#l1.9269"></a><span id="l1.9269" class="difflineminus">-</span>
<a href="#l1.9270"></a><span id="l1.9270" class="difflineminus">-nsresult nsMsgDBView::OrExtraFlag(nsMsgViewIndex index, uint32_t orflag)</span>
<a href="#l1.9271"></a><span id="l1.9271" class="difflineplus">+    *pResultIndex = (firstNewKey != nsMsgKey_None) ?</span>
<a href="#l1.9272"></a><span id="l1.9272" class="difflineplus">+                      FindKey(firstNewKey, true) : nsMsgViewIndex_None;</span>
<a href="#l1.9273"></a><span id="l1.9273" class="difflineplus">+  }</span>
<a href="#l1.9274"></a><span id="l1.9274" class="difflineplus">+</span>
<a href="#l1.9275"></a><span id="l1.9275" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.9276"></a><span id="l1.9276" class="difflineplus">+}</span>
<a href="#l1.9277"></a><span id="l1.9277" class="difflineplus">+</span>
<a href="#l1.9278"></a><span id="l1.9278" class="difflineplus">+nsresult</span>
<a href="#l1.9279"></a><span id="l1.9279" class="difflineplus">+nsMsgDBView::FindPrevUnread(nsMsgKey startKey,</span>
<a href="#l1.9280"></a><span id="l1.9280" class="difflineplus">+                            nsMsgKey *pResultKey,</span>
<a href="#l1.9281"></a><span id="l1.9281" class="difflineplus">+                            nsMsgKey *resultThreadId)</span>
<a href="#l1.9282"></a><span id="l1.9282" class="difflineplus">+{</span>
<a href="#l1.9283"></a><span id="l1.9283" class="difflineplus">+  nsMsgViewIndex startIndex = FindViewIndex(startKey);</span>
<a href="#l1.9284"></a><span id="l1.9284" class="difflineplus">+  nsMsgViewIndex curIndex = startIndex;</span>
<a href="#l1.9285"></a><span id="l1.9285" class="difflineplus">+  nsresult rv = NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.9286"></a><span id="l1.9286" class="difflineplus">+</span>
<a href="#l1.9287"></a><span id="l1.9287" class="difflineplus">+  if (startIndex == nsMsgViewIndex_None)</span>
<a href="#l1.9288"></a><span id="l1.9288" class="difflineplus">+    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.9289"></a><span id="l1.9289" class="difflineplus">+</span>
<a href="#l1.9290"></a><span id="l1.9290" class="difflineplus">+  *pResultKey = nsMsgKey_None;</span>
<a href="#l1.9291"></a><span id="l1.9291" class="difflineplus">+  if (resultThreadId)</span>
<a href="#l1.9292"></a><span id="l1.9292" class="difflineplus">+    *resultThreadId = nsMsgKey_None;</span>
<a href="#l1.9293"></a><span id="l1.9293" class="difflineplus">+</span>
<a href="#l1.9294"></a><span id="l1.9294" class="difflineplus">+  for (; (int) curIndex &gt;= 0 &amp;&amp; (*pResultKey == nsMsgKey_None); curIndex--)</span>
<a href="#l1.9295"></a><span id="l1.9295" class="difflineplus">+  {</span>
<a href="#l1.9296"></a><span id="l1.9296" class="difflineplus">+    uint32_t flags = m_flags[curIndex];</span>
<a href="#l1.9297"></a><span id="l1.9297" class="difflineplus">+    if (curIndex != startIndex &amp;&amp;</span>
<a href="#l1.9298"></a><span id="l1.9298" class="difflineplus">+        flags &amp; MSG_VIEW_FLAG_ISTHREAD &amp;&amp;</span>
<a href="#l1.9299"></a><span id="l1.9299" class="difflineplus">+        flags &amp; nsMsgMessageFlags::Elided)</span>
<a href="#l1.9300"></a><span id="l1.9300" class="difflineplus">+    {</span>
<a href="#l1.9301"></a><span id="l1.9301" class="difflineplus">+      NS_ERROR(&quot;fix this&quot;);</span>
<a href="#l1.9302"></a><span id="l1.9302" class="difflineplus">+      // nsMsgKey threadId = m_keys[curIndex];</span>
<a href="#l1.9303"></a><span id="l1.9303" class="difflineplus">+      // rv = m_db-&gt;GetUnreadKeyInThread(threadId, pResultKey, resultThreadId);</span>
<a href="#l1.9304"></a><span id="l1.9304" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; (*pResultKey != nsMsgKey_None))</span>
<a href="#l1.9305"></a><span id="l1.9305" class="difflineplus">+        break;</span>
<a href="#l1.9306"></a><span id="l1.9306" class="difflineplus">+    }</span>
<a href="#l1.9307"></a><span id="l1.9307" class="difflineplus">+</span>
<a href="#l1.9308"></a><span id="l1.9308" class="difflineplus">+    if (!(flags &amp; (nsMsgMessageFlags::Read | MSG_VIEW_FLAG_DUMMY)) &amp;&amp;</span>
<a href="#l1.9309"></a><span id="l1.9309" class="difflineplus">+        (curIndex != startIndex))</span>
<a href="#l1.9310"></a><span id="l1.9310" class="difflineplus">+    {</span>
<a href="#l1.9311"></a><span id="l1.9311" class="difflineplus">+      *pResultKey = m_keys[curIndex];</span>
<a href="#l1.9312"></a><span id="l1.9312" class="difflineplus">+      rv = NS_OK;</span>
<a href="#l1.9313"></a><span id="l1.9313" class="difflineplus">+      break;</span>
<a href="#l1.9314"></a><span id="l1.9314" class="difflineplus">+    }</span>
<a href="#l1.9315"></a><span id="l1.9315" class="difflineplus">+  }</span>
<a href="#l1.9316"></a><span id="l1.9316" class="difflineplus">+</span>
<a href="#l1.9317"></a><span id="l1.9317" class="difflineplus">+  // Found unread message but we don't know the thread.</span>
<a href="#l1.9318"></a><span id="l1.9318" class="difflineplus">+  NS_ASSERTION(!(*pResultKey != nsMsgKey_None &amp;&amp;</span>
<a href="#l1.9319"></a><span id="l1.9319" class="difflineplus">+               resultThreadId &amp;&amp;</span>
<a href="#l1.9320"></a><span id="l1.9320" class="difflineplus">+               *resultThreadId == nsMsgKey_None), &quot;fix this&quot;);</span>
<a href="#l1.9321"></a><span id="l1.9321" class="difflineplus">+  return rv;</span>
<a href="#l1.9322"></a><span id="l1.9322" class="difflineplus">+}</span>
<a href="#l1.9323"></a><span id="l1.9323" class="difflineplus">+</span>
<a href="#l1.9324"></a><span id="l1.9324" class="difflineplus">+nsresult</span>
<a href="#l1.9325"></a><span id="l1.9325" class="difflineplus">+nsMsgDBView::FindFirstFlagged(nsMsgViewIndex *pResultIndex)</span>
<a href="#l1.9326"></a><span id="l1.9326" class="difflineplus">+{</span>
<a href="#l1.9327"></a><span id="l1.9327" class="difflineplus">+  return FindNextFlagged(0, pResultIndex);</span>
<a href="#l1.9328"></a><span id="l1.9328" class="difflineplus">+}</span>
<a href="#l1.9329"></a><span id="l1.9329" class="difflineplus">+</span>
<a href="#l1.9330"></a><span id="l1.9330" class="difflineplus">+nsresult</span>
<a href="#l1.9331"></a><span id="l1.9331" class="difflineplus">+nsMsgDBView::FindPrevFlagged(nsMsgViewIndex startIndex,</span>
<a href="#l1.9332"></a><span id="l1.9332" class="difflineplus">+                             nsMsgViewIndex *pResultIndex)</span>
<a href="#l1.9333"></a><span id="l1.9333" class="difflineplus">+{</span>
<a href="#l1.9334"></a><span id="l1.9334" class="difflineplus">+  nsMsgViewIndex curIndex;</span>
<a href="#l1.9335"></a><span id="l1.9335" class="difflineplus">+</span>
<a href="#l1.9336"></a><span id="l1.9336" class="difflineplus">+  *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.9337"></a><span id="l1.9337" class="difflineplus">+</span>
<a href="#l1.9338"></a><span id="l1.9338" class="difflineplus">+  if (GetSize() &gt; 0 &amp;&amp; IsValidIndex(startIndex))</span>
<a href="#l1.9339"></a><span id="l1.9339" class="difflineplus">+  {</span>
<a href="#l1.9340"></a><span id="l1.9340" class="difflineplus">+    curIndex = startIndex;</span>
<a href="#l1.9341"></a><span id="l1.9341" class="difflineplus">+    do</span>
<a href="#l1.9342"></a><span id="l1.9342" class="difflineplus">+    {</span>
<a href="#l1.9343"></a><span id="l1.9343" class="difflineplus">+      if (curIndex != 0)</span>
<a href="#l1.9344"></a><span id="l1.9344" class="difflineplus">+        curIndex--;</span>
<a href="#l1.9345"></a><span id="l1.9345" class="difflineplus">+</span>
<a href="#l1.9346"></a><span id="l1.9346" class="difflineplus">+      uint32_t flags = m_flags[curIndex];</span>
<a href="#l1.9347"></a><span id="l1.9347" class="difflineplus">+      if (flags &amp; nsMsgMessageFlags::Marked)</span>
<a href="#l1.9348"></a><span id="l1.9348" class="difflineplus">+      {</span>
<a href="#l1.9349"></a><span id="l1.9349" class="difflineplus">+        *pResultIndex = curIndex;</span>
<a href="#l1.9350"></a><span id="l1.9350" class="difflineplus">+        break;</span>
<a href="#l1.9351"></a><span id="l1.9351" class="difflineplus">+      }</span>
<a href="#l1.9352"></a><span id="l1.9352" class="difflineplus">+    } while (curIndex != 0);</span>
<a href="#l1.9353"></a><span id="l1.9353" class="difflineplus">+  }</span>
<a href="#l1.9354"></a><span id="l1.9354" class="difflineplus">+</span>
<a href="#l1.9355"></a><span id="l1.9355" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.9356"></a><span id="l1.9356" class="difflineplus">+}</span>
<a href="#l1.9357"></a><span id="l1.9357" class="difflineplus">+</span>
<a href="#l1.9358"></a><span id="l1.9358" class="difflineplus">+bool</span>
<a href="#l1.9359"></a><span id="l1.9359" class="difflineplus">+nsMsgDBView::IsValidIndex(nsMsgViewIndex index)</span>
<a href="#l1.9360"></a><span id="l1.9360" class="difflineplus">+{</span>
<a href="#l1.9361"></a><span id="l1.9361" class="difflineplus">+  return index != nsMsgViewIndex_None &amp;&amp;</span>
<a href="#l1.9362"></a><span id="l1.9362" class="difflineplus">+         (index &lt; (nsMsgViewIndex) m_keys.Length());</span>
<a href="#l1.9363"></a><span id="l1.9363" class="difflineplus">+}</span>
<a href="#l1.9364"></a><span id="l1.9364" class="difflineplus">+</span>
<a href="#l1.9365"></a><span id="l1.9365" class="difflineplus">+nsresult</span>
<a href="#l1.9366"></a><span id="l1.9366" class="difflineplus">+nsMsgDBView::OrExtraFlag(nsMsgViewIndex index,</span>
<a href="#l1.9367"></a><span id="l1.9367" class="difflineplus">+                         uint32_t orflag)</span>
<a href="#l1.9368"></a><span id="l1.9368"> {</span>
<a href="#l1.9369"></a><span id="l1.9369">   uint32_t  flag;</span>
<a href="#l1.9370"></a><span id="l1.9370">   if (!IsValidIndex(index))</span>
<a href="#l1.9371"></a><span id="l1.9371">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.9372"></a><span id="l1.9372" class="difflineplus">+</span>
<a href="#l1.9373"></a><span id="l1.9373">   flag = m_flags[index];</span>
<a href="#l1.9374"></a><span id="l1.9374">   flag |= orflag;</span>
<a href="#l1.9375"></a><span id="l1.9375">   m_flags[index] = flag;</span>
<a href="#l1.9376"></a><span id="l1.9376">   OnExtraFlagChanged(index, flag);</span>
<a href="#l1.9377"></a><span id="l1.9377">   return NS_OK;</span>
<a href="#l1.9378"></a><span id="l1.9378"> }</span>
<a href="#l1.9379"></a><span id="l1.9379"> </span>
<a href="#l1.9380"></a><span id="l1.9380" class="difflineminus">-nsresult nsMsgDBView::AndExtraFlag(nsMsgViewIndex index, uint32_t andflag)</span>
<a href="#l1.9381"></a><span id="l1.9381" class="difflineplus">+nsresult</span>
<a href="#l1.9382"></a><span id="l1.9382" class="difflineplus">+nsMsgDBView::AndExtraFlag(nsMsgViewIndex index,</span>
<a href="#l1.9383"></a><span id="l1.9383" class="difflineplus">+                          uint32_t andflag)</span>
<a href="#l1.9384"></a><span id="l1.9384"> {</span>
<a href="#l1.9385"></a><span id="l1.9385">   uint32_t  flag;</span>
<a href="#l1.9386"></a><span id="l1.9386">   if (!IsValidIndex(index))</span>
<a href="#l1.9387"></a><span id="l1.9387">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.9388"></a><span id="l1.9388" class="difflineplus">+</span>
<a href="#l1.9389"></a><span id="l1.9389">   flag = m_flags[index];</span>
<a href="#l1.9390"></a><span id="l1.9390">   flag &amp;= andflag;</span>
<a href="#l1.9391"></a><span id="l1.9391">   m_flags[index] = flag;</span>
<a href="#l1.9392"></a><span id="l1.9392">   OnExtraFlagChanged(index, flag);</span>
<a href="#l1.9393"></a><span id="l1.9393">   return NS_OK;</span>
<a href="#l1.9394"></a><span id="l1.9394"> }</span>
<a href="#l1.9395"></a><span id="l1.9395"> </span>
<a href="#l1.9396"></a><span id="l1.9396" class="difflineminus">-nsresult nsMsgDBView::SetExtraFlag(nsMsgViewIndex index, uint32_t extraflag)</span>
<a href="#l1.9397"></a><span id="l1.9397" class="difflineplus">+nsresult</span>
<a href="#l1.9398"></a><span id="l1.9398" class="difflineplus">+nsMsgDBView::SetExtraFlag(nsMsgViewIndex index,</span>
<a href="#l1.9399"></a><span id="l1.9399" class="difflineplus">+                          uint32_t extraflag)</span>
<a href="#l1.9400"></a><span id="l1.9400"> {</span>
<a href="#l1.9401"></a><span id="l1.9401">   if (!IsValidIndex(index))</span>
<a href="#l1.9402"></a><span id="l1.9402">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.9403"></a><span id="l1.9403" class="difflineplus">+</span>
<a href="#l1.9404"></a><span id="l1.9404">   m_flags[index] = extraflag;</span>
<a href="#l1.9405"></a><span id="l1.9405">   OnExtraFlagChanged(index, extraflag);</span>
<a href="#l1.9406"></a><span id="l1.9406">   return NS_OK;</span>
<a href="#l1.9407"></a><span id="l1.9407"> }</span>
<a href="#l1.9408"></a><span id="l1.9408"> </span>
<a href="#l1.9409"></a><span id="l1.9409" class="difflineminus">-</span>
<a href="#l1.9410"></a><span id="l1.9410" class="difflineminus">-nsresult nsMsgDBView::ToggleIgnored(nsMsgViewIndex * indices, int32_t numIndices, nsMsgViewIndex *resultIndex, bool *resultToggleState)</span>
<a href="#l1.9411"></a><span id="l1.9411" class="difflineplus">+nsresult</span>
<a href="#l1.9412"></a><span id="l1.9412" class="difflineplus">+nsMsgDBView::ToggleIgnored(nsMsgViewIndex * indices,</span>
<a href="#l1.9413"></a><span id="l1.9413" class="difflineplus">+                           int32_t numIndices,</span>
<a href="#l1.9414"></a><span id="l1.9414" class="difflineplus">+                           nsMsgViewIndex *resultIndex,</span>
<a href="#l1.9415"></a><span id="l1.9415" class="difflineplus">+                           bool *resultToggleState)</span>
<a href="#l1.9416"></a><span id="l1.9416"> {</span>
<a href="#l1.9417"></a><span id="l1.9417">   nsCOMPtr &lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.9418"></a><span id="l1.9418"> </span>
<a href="#l1.9419"></a><span id="l1.9419" class="difflineminus">-  // Ignored state is toggled based on the first selected thread</span>
<a href="#l1.9420"></a><span id="l1.9420" class="difflineplus">+  // Ignored state is toggled based on the first selected thread.</span>
<a href="#l1.9421"></a><span id="l1.9421">   nsMsgViewIndex threadIndex = GetThreadFromMsgIndex(indices[0], getter_AddRefs(thread));</span>
<a href="#l1.9422"></a><span id="l1.9422">   uint32_t threadFlags;</span>
<a href="#l1.9423"></a><span id="l1.9423">   thread-&gt;GetFlags(&amp;threadFlags);</span>
<a href="#l1.9424"></a><span id="l1.9424">   uint32_t ignored = threadFlags &amp; nsMsgMessageFlags::Ignored;</span>
<a href="#l1.9425"></a><span id="l1.9425"> </span>
<a href="#l1.9426"></a><span id="l1.9426" class="difflineminus">-  // Process threads in reverse order</span>
<a href="#l1.9427"></a><span id="l1.9427" class="difflineminus">-  // Otherwise collapsing the threads will invalidate the indices</span>
<a href="#l1.9428"></a><span id="l1.9428" class="difflineplus">+  // Process threads in reverse order.</span>
<a href="#l1.9429"></a><span id="l1.9429" class="difflineplus">+  // Otherwise collapsing the threads will invalidate the indices.</span>
<a href="#l1.9430"></a><span id="l1.9430">   threadIndex = nsMsgViewIndex_None;</span>
<a href="#l1.9431"></a><span id="l1.9431">   while (numIndices)</span>
<a href="#l1.9432"></a><span id="l1.9432">   {</span>
<a href="#l1.9433"></a><span id="l1.9433">     numIndices--;</span>
<a href="#l1.9434"></a><span id="l1.9434">     if (indices[numIndices] &lt; threadIndex)</span>
<a href="#l1.9435"></a><span id="l1.9435">     {</span>
<a href="#l1.9436"></a><span id="l1.9436">       threadIndex = GetThreadFromMsgIndex(indices[numIndices], getter_AddRefs(thread));</span>
<a href="#l1.9437"></a><span id="l1.9437">       thread-&gt;GetFlags(&amp;threadFlags);</span>
<a href="#l1.9438"></a><span id="l1.9438">       if ((threadFlags &amp; nsMsgMessageFlags::Ignored) == ignored)</span>
<a href="#l1.9439"></a><span id="l1.9439">         SetThreadIgnored(thread, threadIndex, !ignored);</span>
<a href="#l1.9440"></a><span id="l1.9440">     }</span>
<a href="#l1.9441"></a><span id="l1.9441">   }</span>
<a href="#l1.9442"></a><span id="l1.9442"> </span>
<a href="#l1.9443"></a><span id="l1.9443">   if (resultIndex)</span>
<a href="#l1.9444"></a><span id="l1.9444">     *resultIndex = threadIndex;</span>
<a href="#l1.9445"></a><span id="l1.9445" class="difflineplus">+</span>
<a href="#l1.9446"></a><span id="l1.9446">   if (resultToggleState)</span>
<a href="#l1.9447"></a><span id="l1.9447">     *resultToggleState = !ignored;</span>
<a href="#l1.9448"></a><span id="l1.9448"> </span>
<a href="#l1.9449"></a><span id="l1.9449">   return NS_OK;</span>
<a href="#l1.9450"></a><span id="l1.9450"> }</span>
<a href="#l1.9451"></a><span id="l1.9451"> </span>
<a href="#l1.9452"></a><span id="l1.9452" class="difflineminus">-nsresult nsMsgDBView::ToggleMessageKilled(nsMsgViewIndex * indices, int32_t numIndices, nsMsgViewIndex *resultIndex, bool *resultToggleState)</span>
<a href="#l1.9453"></a><span id="l1.9453" class="difflineplus">+nsresult</span>
<a href="#l1.9454"></a><span id="l1.9454" class="difflineplus">+nsMsgDBView::ToggleMessageKilled(nsMsgViewIndex * indices,</span>
<a href="#l1.9455"></a><span id="l1.9455" class="difflineplus">+                                 int32_t numIndices,</span>
<a href="#l1.9456"></a><span id="l1.9456" class="difflineplus">+                                 nsMsgViewIndex *resultIndex,</span>
<a href="#l1.9457"></a><span id="l1.9457" class="difflineplus">+                                 bool *resultToggleState)</span>
<a href="#l1.9458"></a><span id="l1.9458"> {</span>
<a href="#l1.9459"></a><span id="l1.9459">   NS_ENSURE_ARG_POINTER(resultToggleState);</span>
<a href="#l1.9460"></a><span id="l1.9460"> </span>
<a href="#l1.9461"></a><span id="l1.9461">   nsCOMPtr &lt;nsIMsgDBHdr&gt; header;</span>
<a href="#l1.9462"></a><span id="l1.9462" class="difflineminus">-  // Ignored state is toggled based on the first selected message</span>
<a href="#l1.9463"></a><span id="l1.9463" class="difflineplus">+  // Ignored state is toggled based on the first selected message.</span>
<a href="#l1.9464"></a><span id="l1.9464">   nsresult rv = GetMsgHdrForViewIndex(indices[0], getter_AddRefs(header));</span>
<a href="#l1.9465"></a><span id="l1.9465">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.9466"></a><span id="l1.9466"> </span>
<a href="#l1.9467"></a><span id="l1.9467">   uint32_t msgFlags;</span>
<a href="#l1.9468"></a><span id="l1.9468">   header-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.9469"></a><span id="l1.9469">   uint32_t ignored = msgFlags &amp; nsMsgMessageFlags::Ignored;</span>
<a href="#l1.9470"></a><span id="l1.9470"> </span>
<a href="#l1.9471"></a><span id="l1.9471" class="difflineminus">-  // Process messages in reverse order</span>
<a href="#l1.9472"></a><span id="l1.9472" class="difflineminus">-  // Otherwise the indices may be invalidated...</span>
<a href="#l1.9473"></a><span id="l1.9473" class="difflineplus">+  // Process messages in reverse order.</span>
<a href="#l1.9474"></a><span id="l1.9474" class="difflineplus">+  // Otherwise the indices may be invalidated.</span>
<a href="#l1.9475"></a><span id="l1.9475">   nsMsgViewIndex msgIndex = nsMsgViewIndex_None;</span>
<a href="#l1.9476"></a><span id="l1.9476">   while (numIndices)</span>
<a href="#l1.9477"></a><span id="l1.9477">   {</span>
<a href="#l1.9478"></a><span id="l1.9478">     numIndices--;</span>
<a href="#l1.9479"></a><span id="l1.9479">     if (indices[numIndices] &lt; msgIndex)</span>
<a href="#l1.9480"></a><span id="l1.9480">     {</span>
<a href="#l1.9481"></a><span id="l1.9481">       msgIndex = indices[numIndices];</span>
<a href="#l1.9482"></a><span id="l1.9482">       rv = GetMsgHdrForViewIndex(msgIndex, getter_AddRefs(header));</span>
<a href="#l1.9483"></a><span id="l1.9483" class="difflineat">@@ -7145,175 +7975,193 @@ nsresult nsMsgDBView::ToggleMessageKille</span>
<a href="#l1.9484"></a><span id="l1.9484">       header-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.9485"></a><span id="l1.9485">       if ((msgFlags &amp; nsMsgMessageFlags::Ignored) == ignored)</span>
<a href="#l1.9486"></a><span id="l1.9486">         SetSubthreadKilled(header, msgIndex, !ignored);</span>
<a href="#l1.9487"></a><span id="l1.9487">     }</span>
<a href="#l1.9488"></a><span id="l1.9488">   }</span>
<a href="#l1.9489"></a><span id="l1.9489"> </span>
<a href="#l1.9490"></a><span id="l1.9490">   if (resultIndex)</span>
<a href="#l1.9491"></a><span id="l1.9491">     *resultIndex = msgIndex;</span>
<a href="#l1.9492"></a><span id="l1.9492" class="difflineplus">+</span>
<a href="#l1.9493"></a><span id="l1.9493">   if (resultToggleState)</span>
<a href="#l1.9494"></a><span id="l1.9494">     *resultToggleState = !ignored;</span>
<a href="#l1.9495"></a><span id="l1.9495"> </span>
<a href="#l1.9496"></a><span id="l1.9496">   return NS_OK;</span>
<a href="#l1.9497"></a><span id="l1.9497"> }</span>
<a href="#l1.9498"></a><span id="l1.9498"> </span>
<a href="#l1.9499"></a><span id="l1.9499" class="difflineminus">-nsMsgViewIndex  nsMsgDBView::GetThreadFromMsgIndex(nsMsgViewIndex index,</span>
<a href="#l1.9500"></a><span id="l1.9500" class="difflineminus">-                                                   nsIMsgThread **threadHdr)</span>
<a href="#l1.9501"></a><span id="l1.9501" class="difflineminus">-{</span>
<a href="#l1.9502"></a><span id="l1.9502" class="difflineminus">-  nsMsgKey        msgKey = GetAt(index);</span>
<a href="#l1.9503"></a><span id="l1.9503" class="difflineminus">-  nsMsgViewIndex  threadIndex;</span>
<a href="#l1.9504"></a><span id="l1.9504" class="difflineplus">+nsMsgViewIndex</span>
<a href="#l1.9505"></a><span id="l1.9505" class="difflineplus">+nsMsgDBView::GetThreadFromMsgIndex(nsMsgViewIndex index,</span>
<a href="#l1.9506"></a><span id="l1.9506" class="difflineplus">+                                   nsIMsgThread **threadHdr)</span>
<a href="#l1.9507"></a><span id="l1.9507" class="difflineplus">+{</span>
<a href="#l1.9508"></a><span id="l1.9508" class="difflineplus">+  nsMsgKey msgKey = GetAt(index);</span>
<a href="#l1.9509"></a><span id="l1.9509" class="difflineplus">+  nsMsgViewIndex threadIndex;</span>
<a href="#l1.9510"></a><span id="l1.9510"> </span>
<a href="#l1.9511"></a><span id="l1.9511">   if (threadHdr == nullptr)</span>
<a href="#l1.9512"></a><span id="l1.9512">     return nsMsgViewIndex_None;</span>
<a href="#l1.9513"></a><span id="l1.9513"> </span>
<a href="#l1.9514"></a><span id="l1.9514">   nsresult rv = GetThreadContainingIndex(index, threadHdr);</span>
<a href="#l1.9515"></a><span id="l1.9515">   NS_ENSURE_SUCCESS(rv,nsMsgViewIndex_None);</span>
<a href="#l1.9516"></a><span id="l1.9516"> </span>
<a href="#l1.9517"></a><span id="l1.9517">   if (*threadHdr == nullptr)</span>
<a href="#l1.9518"></a><span id="l1.9518">     return nsMsgViewIndex_None;</span>
<a href="#l1.9519"></a><span id="l1.9519"> </span>
<a href="#l1.9520"></a><span id="l1.9520">   nsMsgKey threadKey;</span>
<a href="#l1.9521"></a><span id="l1.9521">   (*threadHdr)-&gt;GetThreadKey(&amp;threadKey);</span>
<a href="#l1.9522"></a><span id="l1.9522">   if (msgKey !=threadKey)</span>
<a href="#l1.9523"></a><span id="l1.9523">     threadIndex = GetIndexOfFirstDisplayedKeyInThread(*threadHdr);</span>
<a href="#l1.9524"></a><span id="l1.9524">   else</span>
<a href="#l1.9525"></a><span id="l1.9525">     threadIndex = index;</span>
<a href="#l1.9526"></a><span id="l1.9526" class="difflineplus">+</span>
<a href="#l1.9527"></a><span id="l1.9527">   return threadIndex;</span>
<a href="#l1.9528"></a><span id="l1.9528"> }</span>
<a href="#l1.9529"></a><span id="l1.9529"> </span>
<a href="#l1.9530"></a><span id="l1.9530" class="difflineminus">-nsresult nsMsgDBView::ToggleWatched( nsMsgViewIndex* indices,  int32_t numIndices)</span>
<a href="#l1.9531"></a><span id="l1.9531" class="difflineplus">+nsresult</span>
<a href="#l1.9532"></a><span id="l1.9532" class="difflineplus">+nsMsgDBView::ToggleWatched(nsMsgViewIndex* indices,</span>
<a href="#l1.9533"></a><span id="l1.9533" class="difflineplus">+                           int32_t numIndices)</span>
<a href="#l1.9534"></a><span id="l1.9534"> {</span>
<a href="#l1.9535"></a><span id="l1.9535">   nsCOMPtr &lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.9536"></a><span id="l1.9536"> </span>
<a href="#l1.9537"></a><span id="l1.9537" class="difflineminus">-  // Watched state is toggled based on the first selected thread</span>
<a href="#l1.9538"></a><span id="l1.9538" class="difflineplus">+  // Watched state is toggled based on the first selected thread.</span>
<a href="#l1.9539"></a><span id="l1.9539">   nsMsgViewIndex threadIndex = GetThreadFromMsgIndex(indices[0], getter_AddRefs(thread));</span>
<a href="#l1.9540"></a><span id="l1.9540">   uint32_t threadFlags;</span>
<a href="#l1.9541"></a><span id="l1.9541">   thread-&gt;GetFlags(&amp;threadFlags);</span>
<a href="#l1.9542"></a><span id="l1.9542">   uint32_t watched = threadFlags &amp; nsMsgMessageFlags::Watched;</span>
<a href="#l1.9543"></a><span id="l1.9543"> </span>
<a href="#l1.9544"></a><span id="l1.9544" class="difflineminus">-  // Process threads in reverse order</span>
<a href="#l1.9545"></a><span id="l1.9545" class="difflineminus">-  // for consistency with ToggleIgnored</span>
<a href="#l1.9546"></a><span id="l1.9546" class="difflineplus">+  // Process threads in reverse order for consistency with ToggleIgnored.</span>
<a href="#l1.9547"></a><span id="l1.9547">   threadIndex = nsMsgViewIndex_None;</span>
<a href="#l1.9548"></a><span id="l1.9548">   while (numIndices)</span>
<a href="#l1.9549"></a><span id="l1.9549">   {</span>
<a href="#l1.9550"></a><span id="l1.9550">     numIndices--;</span>
<a href="#l1.9551"></a><span id="l1.9551">     if (indices[numIndices] &lt; threadIndex)</span>
<a href="#l1.9552"></a><span id="l1.9552">     {</span>
<a href="#l1.9553"></a><span id="l1.9553">       threadIndex = GetThreadFromMsgIndex(indices[numIndices], getter_AddRefs(thread));</span>
<a href="#l1.9554"></a><span id="l1.9554">       thread-&gt;GetFlags(&amp;threadFlags);</span>
<a href="#l1.9555"></a><span id="l1.9555">       if ((threadFlags &amp; nsMsgMessageFlags::Watched) == watched)</span>
<a href="#l1.9556"></a><span id="l1.9556">         SetThreadWatched(thread, threadIndex, !watched);</span>
<a href="#l1.9557"></a><span id="l1.9557">     }</span>
<a href="#l1.9558"></a><span id="l1.9558">   }</span>
<a href="#l1.9559"></a><span id="l1.9559"> </span>
<a href="#l1.9560"></a><span id="l1.9560">   return NS_OK;</span>
<a href="#l1.9561"></a><span id="l1.9561"> }</span>
<a href="#l1.9562"></a><span id="l1.9562"> </span>
<a href="#l1.9563"></a><span id="l1.9563" class="difflineminus">-nsresult nsMsgDBView::SetThreadIgnored(nsIMsgThread *thread, nsMsgViewIndex threadIndex, bool ignored)</span>
<a href="#l1.9564"></a><span id="l1.9564" class="difflineplus">+nsresult</span>
<a href="#l1.9565"></a><span id="l1.9565" class="difflineplus">+nsMsgDBView::SetThreadIgnored(nsIMsgThread *thread,</span>
<a href="#l1.9566"></a><span id="l1.9566" class="difflineplus">+                              nsMsgViewIndex threadIndex,</span>
<a href="#l1.9567"></a><span id="l1.9567" class="difflineplus">+                              bool ignored)</span>
<a href="#l1.9568"></a><span id="l1.9568"> {</span>
<a href="#l1.9569"></a><span id="l1.9569">   if (!IsValidIndex(threadIndex))</span>
<a href="#l1.9570"></a><span id="l1.9570">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.9571"></a><span id="l1.9571"> </span>
<a href="#l1.9572"></a><span id="l1.9572">   NoteChange(threadIndex, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.9573"></a><span id="l1.9573">   if (ignored)</span>
<a href="#l1.9574"></a><span id="l1.9574">   {</span>
<a href="#l1.9575"></a><span id="l1.9575">     nsTArray&lt;nsMsgKey&gt; idsMarkedRead;</span>
<a href="#l1.9576"></a><span id="l1.9576" class="difflineminus">-</span>
<a href="#l1.9577"></a><span id="l1.9577">     MarkThreadRead(thread, threadIndex, idsMarkedRead, true);</span>
<a href="#l1.9578"></a><span id="l1.9578">     CollapseByIndex(threadIndex, nullptr);</span>
<a href="#l1.9579"></a><span id="l1.9579">   }</span>
<a href="#l1.9580"></a><span id="l1.9580"> </span>
<a href="#l1.9581"></a><span id="l1.9581">   if (!m_db)</span>
<a href="#l1.9582"></a><span id="l1.9582">     return NS_ERROR_FAILURE;</span>
<a href="#l1.9583"></a><span id="l1.9583" class="difflineplus">+</span>
<a href="#l1.9584"></a><span id="l1.9584">   return m_db-&gt;MarkThreadIgnored(thread, m_keys[threadIndex], ignored, this);</span>
<a href="#l1.9585"></a><span id="l1.9585"> }</span>
<a href="#l1.9586"></a><span id="l1.9586"> </span>
<a href="#l1.9587"></a><span id="l1.9587" class="difflineminus">-nsresult nsMsgDBView::SetSubthreadKilled(nsIMsgDBHdr *header, nsMsgViewIndex msgIndex, bool ignored)</span>
<a href="#l1.9588"></a><span id="l1.9588" class="difflineplus">+nsresult</span>
<a href="#l1.9589"></a><span id="l1.9589" class="difflineplus">+nsMsgDBView::SetSubthreadKilled(nsIMsgDBHdr *header,</span>
<a href="#l1.9590"></a><span id="l1.9590" class="difflineplus">+                                nsMsgViewIndex msgIndex,</span>
<a href="#l1.9591"></a><span id="l1.9591" class="difflineplus">+                                bool ignored)</span>
<a href="#l1.9592"></a><span id="l1.9592"> {</span>
<a href="#l1.9593"></a><span id="l1.9593">   if (!IsValidIndex(msgIndex))</span>
<a href="#l1.9594"></a><span id="l1.9594">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.9595"></a><span id="l1.9595"> </span>
<a href="#l1.9596"></a><span id="l1.9596">   NoteChange(msgIndex, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.9597"></a><span id="l1.9597"> </span>
<a href="#l1.9598"></a><span id="l1.9598">   if (!m_db)</span>
<a href="#l1.9599"></a><span id="l1.9599">     return NS_ERROR_FAILURE;</span>
<a href="#l1.9600"></a><span id="l1.9600" class="difflineplus">+</span>
<a href="#l1.9601"></a><span id="l1.9601">   nsresult rv = m_db-&gt;MarkHeaderKilled(header, ignored, this);</span>
<a href="#l1.9602"></a><span id="l1.9602">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.9603"></a><span id="l1.9603"> </span>
<a href="#l1.9604"></a><span id="l1.9604">   if (ignored)</span>
<a href="#l1.9605"></a><span id="l1.9605">   {</span>
<a href="#l1.9606"></a><span id="l1.9606">     nsCOMPtr &lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.9607"></a><span id="l1.9607">     nsresult rv;</span>
<a href="#l1.9608"></a><span id="l1.9608">     rv = GetThreadContainingMsgHdr(header, getter_AddRefs(thread));</span>
<a href="#l1.9609"></a><span id="l1.9609" class="difflineplus">+    // So we didn't mark threads read.</span>
<a href="#l1.9610"></a><span id="l1.9610">     if (NS_FAILED(rv))</span>
<a href="#l1.9611"></a><span id="l1.9611" class="difflineminus">-      return NS_OK; // So we didn't mark threads read</span>
<a href="#l1.9612"></a><span id="l1.9612" class="difflineplus">+      return NS_OK;</span>
<a href="#l1.9613"></a><span id="l1.9613"> </span>
<a href="#l1.9614"></a><span id="l1.9614">     uint32_t children, current;</span>
<a href="#l1.9615"></a><span id="l1.9615">     thread-&gt;GetNumChildren(&amp;children);</span>
<a href="#l1.9616"></a><span id="l1.9616"> </span>
<a href="#l1.9617"></a><span id="l1.9617">     nsMsgKey headKey;</span>
<a href="#l1.9618"></a><span id="l1.9618">     header-&gt;GetMessageKey(&amp;headKey);</span>
<a href="#l1.9619"></a><span id="l1.9619"> </span>
<a href="#l1.9620"></a><span id="l1.9620">     for (current = 0; current &lt; children; current++)</span>
<a href="#l1.9621"></a><span id="l1.9621">     {</span>
<a href="#l1.9622"></a><span id="l1.9622" class="difflineminus">-       nsMsgKey newKey;</span>
<a href="#l1.9623"></a><span id="l1.9623" class="difflineminus">-       thread-&gt;GetChildKeyAt(current, &amp;newKey);</span>
<a href="#l1.9624"></a><span id="l1.9624" class="difflineminus">-       if (newKey == headKey)</span>
<a href="#l1.9625"></a><span id="l1.9625" class="difflineminus">-         break;</span>
<a href="#l1.9626"></a><span id="l1.9626" class="difflineplus">+      nsMsgKey newKey;</span>
<a href="#l1.9627"></a><span id="l1.9627" class="difflineplus">+      thread-&gt;GetChildKeyAt(current, &amp;newKey);</span>
<a href="#l1.9628"></a><span id="l1.9628" class="difflineplus">+      if (newKey == headKey)</span>
<a href="#l1.9629"></a><span id="l1.9629" class="difflineplus">+        break;</span>
<a href="#l1.9630"></a><span id="l1.9630">     }</span>
<a href="#l1.9631"></a><span id="l1.9631"> </span>
<a href="#l1.9632"></a><span id="l1.9632">     // Process all messages, starting with this message.</span>
<a href="#l1.9633"></a><span id="l1.9633">     for (; current &lt; children; current++)</span>
<a href="#l1.9634"></a><span id="l1.9634">     {</span>
<a href="#l1.9635"></a><span id="l1.9635" class="difflineminus">-       nsCOMPtr &lt;nsIMsgDBHdr&gt; nextHdr;</span>
<a href="#l1.9636"></a><span id="l1.9636" class="difflineminus">-       bool isKilled;</span>
<a href="#l1.9637"></a><span id="l1.9637" class="difflineminus">-</span>
<a href="#l1.9638"></a><span id="l1.9638" class="difflineminus">-       thread-&gt;GetChildHdrAt(current, getter_AddRefs(nextHdr));</span>
<a href="#l1.9639"></a><span id="l1.9639" class="difflineminus">-       nextHdr-&gt;GetIsKilled(&amp;isKilled);</span>
<a href="#l1.9640"></a><span id="l1.9640" class="difflineminus">-</span>
<a href="#l1.9641"></a><span id="l1.9641" class="difflineminus">-       // Ideally, the messages should stop processing here.</span>
<a href="#l1.9642"></a><span id="l1.9642" class="difflineminus">-       // However, the children are ordered not by thread...</span>
<a href="#l1.9643"></a><span id="l1.9643" class="difflineminus">-       if (isKilled)</span>
<a href="#l1.9644"></a><span id="l1.9644" class="difflineminus">-         nextHdr-&gt;MarkRead(true);</span>
<a href="#l1.9645"></a><span id="l1.9645" class="difflineminus">-    }</span>
<a href="#l1.9646"></a><span id="l1.9646" class="difflineminus">-  }</span>
<a href="#l1.9647"></a><span id="l1.9647" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.9648"></a><span id="l1.9648" class="difflineminus">-}</span>
<a href="#l1.9649"></a><span id="l1.9649" class="difflineminus">-</span>
<a href="#l1.9650"></a><span id="l1.9650" class="difflineminus">-nsresult nsMsgDBView::SetThreadWatched(nsIMsgThread *thread, nsMsgViewIndex index, bool watched)</span>
<a href="#l1.9651"></a><span id="l1.9651" class="difflineplus">+      nsCOMPtr &lt;nsIMsgDBHdr&gt; nextHdr;</span>
<a href="#l1.9652"></a><span id="l1.9652" class="difflineplus">+      bool isKilled;</span>
<a href="#l1.9653"></a><span id="l1.9653" class="difflineplus">+</span>
<a href="#l1.9654"></a><span id="l1.9654" class="difflineplus">+      thread-&gt;GetChildHdrAt(current, getter_AddRefs(nextHdr));</span>
<a href="#l1.9655"></a><span id="l1.9655" class="difflineplus">+      nextHdr-&gt;GetIsKilled(&amp;isKilled);</span>
<a href="#l1.9656"></a><span id="l1.9656" class="difflineplus">+</span>
<a href="#l1.9657"></a><span id="l1.9657" class="difflineplus">+      // Ideally, the messages should stop processing here.</span>
<a href="#l1.9658"></a><span id="l1.9658" class="difflineplus">+      // However, the children are ordered not by thread...</span>
<a href="#l1.9659"></a><span id="l1.9659" class="difflineplus">+      if (isKilled)</span>
<a href="#l1.9660"></a><span id="l1.9660" class="difflineplus">+        nextHdr-&gt;MarkRead(true);</span>
<a href="#l1.9661"></a><span id="l1.9661" class="difflineplus">+    }</span>
<a href="#l1.9662"></a><span id="l1.9662" class="difflineplus">+  }</span>
<a href="#l1.9663"></a><span id="l1.9663" class="difflineplus">+</span>
<a href="#l1.9664"></a><span id="l1.9664" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.9665"></a><span id="l1.9665" class="difflineplus">+}</span>
<a href="#l1.9666"></a><span id="l1.9666" class="difflineplus">+</span>
<a href="#l1.9667"></a><span id="l1.9667" class="difflineplus">+nsresult</span>
<a href="#l1.9668"></a><span id="l1.9668" class="difflineplus">+nsMsgDBView::SetThreadWatched(nsIMsgThread *thread,</span>
<a href="#l1.9669"></a><span id="l1.9669" class="difflineplus">+                              nsMsgViewIndex index,</span>
<a href="#l1.9670"></a><span id="l1.9670" class="difflineplus">+                              bool watched)</span>
<a href="#l1.9671"></a><span id="l1.9671"> {</span>
<a href="#l1.9672"></a><span id="l1.9672">   if (!IsValidIndex(index))</span>
<a href="#l1.9673"></a><span id="l1.9673">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.9674"></a><span id="l1.9674"> </span>
<a href="#l1.9675"></a><span id="l1.9675">   NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.9676"></a><span id="l1.9676">   return m_db-&gt;MarkThreadWatched(thread, m_keys[index], watched, this);</span>
<a href="#l1.9677"></a><span id="l1.9677"> }</span>
<a href="#l1.9678"></a><span id="l1.9678"> </span>
<a href="#l1.9679"></a><span id="l1.9679" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetMsgFolder(nsIMsgFolder **aMsgFolder)</span>
<a href="#l1.9680"></a><span id="l1.9680" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.9681"></a><span id="l1.9681" class="difflineplus">+nsMsgDBView::GetMsgFolder(nsIMsgFolder **aMsgFolder)</span>
<a href="#l1.9682"></a><span id="l1.9682"> {</span>
<a href="#l1.9683"></a><span id="l1.9683">   NS_ENSURE_ARG_POINTER(aMsgFolder);</span>
<a href="#l1.9684"></a><span id="l1.9684">   NS_IF_ADDREF(*aMsgFolder = m_folder);</span>
<a href="#l1.9685"></a><span id="l1.9685">   return NS_OK;</span>
<a href="#l1.9686"></a><span id="l1.9686"> }</span>
<a href="#l1.9687"></a><span id="l1.9687"> </span>
<a href="#l1.9688"></a><span id="l1.9688" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::SetViewFolder(nsIMsgFolder *aMsgFolder)</span>
<a href="#l1.9689"></a><span id="l1.9689" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.9690"></a><span id="l1.9690" class="difflineplus">+nsMsgDBView::SetViewFolder(nsIMsgFolder *aMsgFolder)</span>
<a href="#l1.9691"></a><span id="l1.9691"> {</span>
<a href="#l1.9692"></a><span id="l1.9692">   m_viewFolder = aMsgFolder;</span>
<a href="#l1.9693"></a><span id="l1.9693">   return NS_OK;</span>
<a href="#l1.9694"></a><span id="l1.9694"> }</span>
<a href="#l1.9695"></a><span id="l1.9695"> </span>
<a href="#l1.9696"></a><span id="l1.9696" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetViewFolder(nsIMsgFolder **aMsgFolder)</span>
<a href="#l1.9697"></a><span id="l1.9697" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.9698"></a><span id="l1.9698" class="difflineplus">+nsMsgDBView::GetViewFolder(nsIMsgFolder **aMsgFolder)</span>
<a href="#l1.9699"></a><span id="l1.9699"> {</span>
<a href="#l1.9700"></a><span id="l1.9700">   NS_ENSURE_ARG_POINTER(aMsgFolder);</span>
<a href="#l1.9701"></a><span id="l1.9701">   NS_IF_ADDREF(*aMsgFolder = m_viewFolder);</span>
<a href="#l1.9702"></a><span id="l1.9702">   return NS_OK;</span>
<a href="#l1.9703"></a><span id="l1.9703"> }</span>
<a href="#l1.9704"></a><span id="l1.9704"> </span>
<a href="#l1.9705"></a><span id="l1.9705" class="difflineminus">-</span>
<a href="#l1.9706"></a><span id="l1.9706"> NS_IMETHODIMP</span>
<a href="#l1.9707"></a><span id="l1.9707"> nsMsgDBView::GetNumSelected(uint32_t *aNumSelected)</span>
<a href="#l1.9708"></a><span id="l1.9708"> {</span>
<a href="#l1.9709"></a><span id="l1.9709">   NS_ENSURE_ARG_POINTER(aNumSelected);</span>
<a href="#l1.9710"></a><span id="l1.9710"> </span>
<a href="#l1.9711"></a><span id="l1.9711">   if (!mTreeSelection)</span>
<a href="#l1.9712"></a><span id="l1.9712">   {</span>
<a href="#l1.9713"></a><span id="l1.9713">     // No tree selection can mean we're in the stand alone mode.</span>
<a href="#l1.9714"></a><span id="l1.9714" class="difflineat">@@ -7321,44 +8169,47 @@ nsMsgDBView::GetNumSelected(uint32_t *aN</span>
<a href="#l1.9715"></a><span id="l1.9715">     return NS_OK;</span>
<a href="#l1.9716"></a><span id="l1.9716">   }</span>
<a href="#l1.9717"></a><span id="l1.9717"> </span>
<a href="#l1.9718"></a><span id="l1.9718">   bool includeCollapsedMsgs = OperateOnMsgsInCollapsedThreads();</span>
<a href="#l1.9719"></a><span id="l1.9719"> </span>
<a href="#l1.9720"></a><span id="l1.9720">   // We call this a lot from the front end JS, so make it fast.</span>
<a href="#l1.9721"></a><span id="l1.9721">   nsresult rv = mTreeSelection-&gt;GetCount((int32_t*)aNumSelected);</span>
<a href="#l1.9722"></a><span id="l1.9722">   if (!*aNumSelected || !includeCollapsedMsgs ||</span>
<a href="#l1.9723"></a><span id="l1.9723" class="difflineminus">-       !(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.9724"></a><span id="l1.9724" class="difflineplus">+      !(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.9725"></a><span id="l1.9725">     return rv;</span>
<a href="#l1.9726"></a><span id="l1.9726"> </span>
<a href="#l1.9727"></a><span id="l1.9727">   int32_t numSelectedIncludingCollapsed = *aNumSelected;</span>
<a href="#l1.9728"></a><span id="l1.9728">   nsMsgViewIndexArray selection;</span>
<a href="#l1.9729"></a><span id="l1.9729">   GetSelectedIndices(selection);</span>
<a href="#l1.9730"></a><span id="l1.9730">   int32_t numIndices = selection.Length();</span>
<a href="#l1.9731"></a><span id="l1.9731" class="difflineminus">-  // iterate over the selection, counting up the messages in collapsed</span>
<a href="#l1.9732"></a><span id="l1.9732" class="difflineplus">+  // Iterate over the selection, counting up the messages in collapsed</span>
<a href="#l1.9733"></a><span id="l1.9733">   // threads.</span>
<a href="#l1.9734"></a><span id="l1.9734">   for (int32_t i = 0; i &lt; numIndices; i++)</span>
<a href="#l1.9735"></a><span id="l1.9735">   {</span>
<a href="#l1.9736"></a><span id="l1.9736">     if (m_flags[selection[i]] &amp; nsMsgMessageFlags::Elided)</span>
<a href="#l1.9737"></a><span id="l1.9737">     {</span>
<a href="#l1.9738"></a><span id="l1.9738">       int32_t collapsedCount;</span>
<a href="#l1.9739"></a><span id="l1.9739">       ExpansionDelta(selection[i], &amp;collapsedCount);</span>
<a href="#l1.9740"></a><span id="l1.9740">       numSelectedIncludingCollapsed += collapsedCount;</span>
<a href="#l1.9741"></a><span id="l1.9741">     }</span>
<a href="#l1.9742"></a><span id="l1.9742">   }</span>
<a href="#l1.9743"></a><span id="l1.9743" class="difflineplus">+</span>
<a href="#l1.9744"></a><span id="l1.9744">   *aNumSelected = numSelectedIncludingCollapsed;</span>
<a href="#l1.9745"></a><span id="l1.9745">   return rv;</span>
<a href="#l1.9746"></a><span id="l1.9746"> }</span>
<a href="#l1.9747"></a><span id="l1.9747"> </span>
<a href="#l1.9748"></a><span id="l1.9748" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetNumMsgsInView(int32_t *aNumMsgs)</span>
<a href="#l1.9749"></a><span id="l1.9749" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.9750"></a><span id="l1.9750" class="difflineplus">+nsMsgDBView::GetNumMsgsInView(int32_t *aNumMsgs)</span>
<a href="#l1.9751"></a><span id="l1.9751"> {</span>
<a href="#l1.9752"></a><span id="l1.9752">   NS_ENSURE_ARG_POINTER(aNumMsgs);</span>
<a href="#l1.9753"></a><span id="l1.9753">   return (m_folder) ? m_folder-&gt;GetTotalMessages(false, aNumMsgs) :</span>
<a href="#l1.9754"></a><span id="l1.9754" class="difflineminus">-                    NS_ERROR_FAILURE;</span>
<a href="#l1.9755"></a><span id="l1.9755" class="difflineminus">-}</span>
<a href="#l1.9756"></a><span id="l1.9756" class="difflineplus">+                      NS_ERROR_FAILURE;</span>
<a href="#l1.9757"></a><span id="l1.9757" class="difflineplus">+}</span>
<a href="#l1.9758"></a><span id="l1.9758" class="difflineplus">+</span>
<a href="#l1.9759"></a><span id="l1.9759"> /**</span>
<a href="#l1.9760"></a><span id="l1.9760">  * @note For the IMAP delete model, this applies to both deleting and</span>
<a href="#l1.9761"></a><span id="l1.9761">  *       undeleting a message.</span>
<a href="#l1.9762"></a><span id="l1.9762">  */</span>
<a href="#l1.9763"></a><span id="l1.9763"> NS_IMETHODIMP</span>
<a href="#l1.9764"></a><span id="l1.9764"> nsMsgDBView::GetMsgToSelectAfterDelete(nsMsgViewIndex *msgToSelectAfterDelete)</span>
<a href="#l1.9765"></a><span id="l1.9765"> {</span>
<a href="#l1.9766"></a><span id="l1.9766">   NS_ENSURE_ARG_POINTER(msgToSelectAfterDelete);</span>
<a href="#l1.9767"></a><span id="l1.9767" class="difflineat">@@ -7380,50 +8231,55 @@ nsMsgDBView::GetMsgToSelectAfterDelete(n</span>
<a href="#l1.9768"></a><span id="l1.9768">     int32_t endRange;</span>
<a href="#l1.9769"></a><span id="l1.9769">     nsresult rv = mTreeSelection-&gt;GetRangeCount(&amp;selectionCount);</span>
<a href="#l1.9770"></a><span id="l1.9770">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.9771"></a><span id="l1.9771">     for (int32_t i = 0; i &lt; selectionCount; i++)</span>
<a href="#l1.9772"></a><span id="l1.9772">     {</span>
<a href="#l1.9773"></a><span id="l1.9773">       rv = mTreeSelection-&gt;GetRangeAt(i, &amp;startRange, &amp;endRange);</span>
<a href="#l1.9774"></a><span id="l1.9774">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.9775"></a><span id="l1.9775"> </span>
<a href="#l1.9776"></a><span id="l1.9776" class="difflineminus">-      // save off the first range in case we need it later</span>
<a href="#l1.9777"></a><span id="l1.9777" class="difflineminus">-      if (i == 0) {</span>
<a href="#l1.9778"></a><span id="l1.9778" class="difflineplus">+      // Save off the first range in case we need it later.</span>
<a href="#l1.9779"></a><span id="l1.9779" class="difflineplus">+      if (i == 0)</span>
<a href="#l1.9780"></a><span id="l1.9780" class="difflineplus">+      {</span>
<a href="#l1.9781"></a><span id="l1.9781">         startFirstRange = startRange;</span>
<a href="#l1.9782"></a><span id="l1.9782">         endFirstRange = endRange;</span>
<a href="#l1.9783"></a><span id="l1.9783" class="difflineminus">-      } else {</span>
<a href="#l1.9784"></a><span id="l1.9784" class="difflineplus">+      }</span>
<a href="#l1.9785"></a><span id="l1.9785" class="difflineplus">+      else</span>
<a href="#l1.9786"></a><span id="l1.9786" class="difflineplus">+      {</span>
<a href="#l1.9787"></a><span id="l1.9787">         // If the tree selection is goofy (eg adjacent or overlapping ranges),</span>
<a href="#l1.9788"></a><span id="l1.9788">         // complain about it, but don't try and cope.  Just live with the fact</span>
<a href="#l1.9789"></a><span id="l1.9789">         // that one of the deleted messages is going to end up selected.</span>
<a href="#l1.9790"></a><span id="l1.9790">         NS_WARNING_ASSERTION(endFirstRange != startRange,</span>
<a href="#l1.9791"></a><span id="l1.9791">                              &quot;goofy tree selection state: two ranges are adjacent!&quot;);</span>
<a href="#l1.9792"></a><span id="l1.9792">       }</span>
<a href="#l1.9793"></a><span id="l1.9793" class="difflineplus">+</span>
<a href="#l1.9794"></a><span id="l1.9794">       *msgToSelectAfterDelete = std::min(*msgToSelectAfterDelete,</span>
<a href="#l1.9795"></a><span id="l1.9795" class="difflineminus">-                                       (nsMsgViewIndex)startRange);</span>
<a href="#l1.9796"></a><span id="l1.9796" class="difflineplus">+                                         (nsMsgViewIndex)startRange);</span>
<a href="#l1.9797"></a><span id="l1.9797">     }</span>
<a href="#l1.9798"></a><span id="l1.9798"> </span>
<a href="#l1.9799"></a><span id="l1.9799">     // Multiple selection either using Ctrl, Shift, or one of the affordances</span>
<a href="#l1.9800"></a><span id="l1.9800">     // to select an entire thread.</span>
<a href="#l1.9801"></a><span id="l1.9801">     isMultiSelect = (selectionCount &gt; 1 || (endRange-startRange) &gt; 0);</span>
<a href="#l1.9802"></a><span id="l1.9802">   }</span>
<a href="#l1.9803"></a><span id="l1.9803"> </span>
<a href="#l1.9804"></a><span id="l1.9804">   if (*msgToSelectAfterDelete == nsMsgViewIndex_None)</span>
<a href="#l1.9805"></a><span id="l1.9805">     return NS_OK;</span>
<a href="#l1.9806"></a><span id="l1.9806"> </span>
<a href="#l1.9807"></a><span id="l1.9807">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.9808"></a><span id="l1.9808">   GetMsgFolder(getter_AddRefs(folder));</span>
<a href="#l1.9809"></a><span id="l1.9809">   nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(folder);</span>
<a href="#l1.9810"></a><span id="l1.9810">   bool thisIsImapFolder = (imapFolder != nullptr);</span>
<a href="#l1.9811"></a><span id="l1.9811" class="difflineminus">-  // Need to update the imap-delete model, can change more than once in a session.</span>
<a href="#l1.9812"></a><span id="l1.9812" class="difflineplus">+  // Need to update the imap-delete model, can change more than once in a</span>
<a href="#l1.9813"></a><span id="l1.9813" class="difflineplus">+  // session.</span>
<a href="#l1.9814"></a><span id="l1.9814">   if (thisIsImapFolder)</span>
<a href="#l1.9815"></a><span id="l1.9815">     GetImapDeleteModel(nullptr);</span>
<a href="#l1.9816"></a><span id="l1.9816"> </span>
<a href="#l1.9817"></a><span id="l1.9817">   // If mail.delete_matches_sort_order is true,</span>
<a href="#l1.9818"></a><span id="l1.9818" class="difflineminus">-  // for views sorted in descending order (newest at the top), make msgToSelectAfterDelete</span>
<a href="#l1.9819"></a><span id="l1.9819" class="difflineminus">-  // advance in the same direction as the sort order.</span>
<a href="#l1.9820"></a><span id="l1.9820" class="difflineplus">+  // for views sorted in descending order (newest at the top), make</span>
<a href="#l1.9821"></a><span id="l1.9821" class="difflineplus">+  // msgToSelectAfterDelete advance in the same direction as the sort order.</span>
<a href="#l1.9822"></a><span id="l1.9822">   bool deleteMatchesSort = false;</span>
<a href="#l1.9823"></a><span id="l1.9823">   if (m_sortOrder == nsMsgViewSortOrder::descending &amp;&amp; *msgToSelectAfterDelete)</span>
<a href="#l1.9824"></a><span id="l1.9824">   {</span>
<a href="#l1.9825"></a><span id="l1.9825">     nsresult rv;</span>
<a href="#l1.9826"></a><span id="l1.9826">     nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch (do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.9827"></a><span id="l1.9827">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.9828"></a><span id="l1.9828">     prefBranch-&gt;GetBoolPref(&quot;mail.delete_matches_sort_order&quot;, &amp;deleteMatchesSort);</span>
<a href="#l1.9829"></a><span id="l1.9829">   }</span>
<a href="#l1.9830"></a><span id="l1.9830" class="difflineat">@@ -7459,101 +8315,112 @@ nsMsgDBView::GetRemoveRowOnMoveOrDelete(</span>
<a href="#l1.9831"></a><span id="l1.9831">   NS_ENSURE_ARG_POINTER(aRemoveRowOnMoveOrDelete);</span>
<a href="#l1.9832"></a><span id="l1.9832">   nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(m_folder);</span>
<a href="#l1.9833"></a><span id="l1.9833">   if (!imapFolder)</span>
<a href="#l1.9834"></a><span id="l1.9834">   {</span>
<a href="#l1.9835"></a><span id="l1.9835">     *aRemoveRowOnMoveOrDelete = true;</span>
<a href="#l1.9836"></a><span id="l1.9836">     return NS_OK;</span>
<a href="#l1.9837"></a><span id="l1.9837">   }</span>
<a href="#l1.9838"></a><span id="l1.9838"> </span>
<a href="#l1.9839"></a><span id="l1.9839" class="difflineminus">-  // need to update the imap-delete model, can change more than once in a session.</span>
<a href="#l1.9840"></a><span id="l1.9840" class="difflineplus">+  // Need to update the imap-delete model, can change more than once in a</span>
<a href="#l1.9841"></a><span id="l1.9841" class="difflineplus">+  // session.</span>
<a href="#l1.9842"></a><span id="l1.9842">   GetImapDeleteModel(nullptr);</span>
<a href="#l1.9843"></a><span id="l1.9843"> </span>
<a href="#l1.9844"></a><span id="l1.9844" class="difflineminus">-  // unlike the other imap delete models, &quot;mark as deleted&quot; does not remove rows on delete (or move)</span>
<a href="#l1.9845"></a><span id="l1.9845" class="difflineplus">+  // Unlike the other imap delete models, &quot;mark as deleted&quot; does not remove</span>
<a href="#l1.9846"></a><span id="l1.9846" class="difflineplus">+  // rows on delete (or move).</span>
<a href="#l1.9847"></a><span id="l1.9847">   *aRemoveRowOnMoveOrDelete = (mDeleteModel != nsMsgImapDeleteModels::IMAPDelete);</span>
<a href="#l1.9848"></a><span id="l1.9848">   return NS_OK;</span>
<a href="#l1.9849"></a><span id="l1.9849"> }</span>
<a href="#l1.9850"></a><span id="l1.9850"> </span>
<a href="#l1.9851"></a><span id="l1.9851"> </span>
<a href="#l1.9852"></a><span id="l1.9852"> NS_IMETHODIMP</span>
<a href="#l1.9853"></a><span id="l1.9853"> nsMsgDBView::GetCurrentlyDisplayedMessage(nsMsgViewIndex *currentlyDisplayedMessage)</span>
<a href="#l1.9854"></a><span id="l1.9854"> {</span>
<a href="#l1.9855"></a><span id="l1.9855">   NS_ENSURE_ARG_POINTER(currentlyDisplayedMessage);</span>
<a href="#l1.9856"></a><span id="l1.9856">   *currentlyDisplayedMessage = FindViewIndex(m_currentlyDisplayedMsgKey);</span>
<a href="#l1.9857"></a><span id="l1.9857">   return NS_OK;</span>
<a href="#l1.9858"></a><span id="l1.9858"> }</span>
<a href="#l1.9859"></a><span id="l1.9859"> </span>
<a href="#l1.9860"></a><span id="l1.9860" class="difflineminus">-// if nothing selected, return an NS_ERROR</span>
<a href="#l1.9861"></a><span id="l1.9861" class="difflineplus">+// If nothing selected, return an NS_ERROR.</span>
<a href="#l1.9862"></a><span id="l1.9862"> NS_IMETHODIMP</span>
<a href="#l1.9863"></a><span id="l1.9863"> nsMsgDBView::GetHdrForFirstSelectedMessage(nsIMsgDBHdr **hdr)</span>
<a href="#l1.9864"></a><span id="l1.9864"> {</span>
<a href="#l1.9865"></a><span id="l1.9865">   NS_ENSURE_ARG_POINTER(hdr);</span>
<a href="#l1.9866"></a><span id="l1.9866"> </span>
<a href="#l1.9867"></a><span id="l1.9867">   nsresult rv;</span>
<a href="#l1.9868"></a><span id="l1.9868">   nsMsgKey key;</span>
<a href="#l1.9869"></a><span id="l1.9869">   rv = GetKeyForFirstSelectedMessage(&amp;key);</span>
<a href="#l1.9870"></a><span id="l1.9870" class="difflineminus">-  // don't assert, it is legal for nothing to be selected</span>
<a href="#l1.9871"></a><span id="l1.9871" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l1.9872"></a><span id="l1.9872" class="difflineplus">+  // Don't assert, it is legal for nothing to be selected.</span>
<a href="#l1.9873"></a><span id="l1.9873" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l1.9874"></a><span id="l1.9874" class="difflineplus">+    return rv;</span>
<a href="#l1.9875"></a><span id="l1.9875"> </span>
<a href="#l1.9876"></a><span id="l1.9876">   if (!m_db)</span>
<a href="#l1.9877"></a><span id="l1.9877">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.9878"></a><span id="l1.9878"> </span>
<a href="#l1.9879"></a><span id="l1.9879">   rv = m_db-&gt;GetMsgHdrForKey(key, hdr);</span>
<a href="#l1.9880"></a><span id="l1.9880">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.9881"></a><span id="l1.9881">   return NS_OK;</span>
<a href="#l1.9882"></a><span id="l1.9882"> }</span>
<a href="#l1.9883"></a><span id="l1.9883"> </span>
<a href="#l1.9884"></a><span id="l1.9884" class="difflineminus">-// if nothing selected, return an NS_ERROR</span>
<a href="#l1.9885"></a><span id="l1.9885" class="difflineplus">+// If nothing selected, return an NS_ERROR.</span>
<a href="#l1.9886"></a><span id="l1.9886"> NS_IMETHODIMP</span>
<a href="#l1.9887"></a><span id="l1.9887"> nsMsgDBView::GetURIForFirstSelectedMessage(nsACString &amp;uri)</span>
<a href="#l1.9888"></a><span id="l1.9888"> {</span>
<a href="#l1.9889"></a><span id="l1.9889">   nsresult rv;</span>
<a href="#l1.9890"></a><span id="l1.9890">   nsMsgViewIndex viewIndex;</span>
<a href="#l1.9891"></a><span id="l1.9891">   rv = GetViewIndexForFirstSelectedMsg(&amp;viewIndex);</span>
<a href="#l1.9892"></a><span id="l1.9892" class="difflineminus">-  // don't assert, it is legal for nothing to be selected</span>
<a href="#l1.9893"></a><span id="l1.9893" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l1.9894"></a><span id="l1.9894" class="difflineplus">+  // Don't assert, it is legal for nothing to be selected.</span>
<a href="#l1.9895"></a><span id="l1.9895" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l1.9896"></a><span id="l1.9896" class="difflineplus">+    return rv;</span>
<a href="#l1.9897"></a><span id="l1.9897"> </span>
<a href="#l1.9898"></a><span id="l1.9898">   return GetURIForViewIndex(viewIndex, uri);</span>
<a href="#l1.9899"></a><span id="l1.9899"> }</span>
<a href="#l1.9900"></a><span id="l1.9900"> </span>
<a href="#l1.9901"></a><span id="l1.9901"> NS_IMETHODIMP</span>
<a href="#l1.9902"></a><span id="l1.9902"> nsMsgDBView::OnDeleteCompleted(bool aSucceeded)</span>
<a href="#l1.9903"></a><span id="l1.9903"> {</span>
<a href="#l1.9904"></a><span id="l1.9904">   if (m_deletingRows &amp;&amp; aSucceeded)</span>
<a href="#l1.9905"></a><span id="l1.9905">   {</span>
<a href="#l1.9906"></a><span id="l1.9906">     uint32_t numIndices = mIndicesToNoteChange.Length();</span>
<a href="#l1.9907"></a><span id="l1.9907">     if (numIndices &amp;&amp; mTree)</span>
<a href="#l1.9908"></a><span id="l1.9908">     {</span>
<a href="#l1.9909"></a><span id="l1.9909">       if (numIndices &gt; 1)</span>
<a href="#l1.9910"></a><span id="l1.9910">         mIndicesToNoteChange.Sort();</span>
<a href="#l1.9911"></a><span id="l1.9911"> </span>
<a href="#l1.9912"></a><span id="l1.9912" class="difflineminus">-      // the call to NoteChange() has to happen after we are done removing the keys</span>
<a href="#l1.9913"></a><span id="l1.9913" class="difflineminus">-      // as NoteChange() will call RowCountChanged() which will call our GetRowCount()</span>
<a href="#l1.9914"></a><span id="l1.9914" class="difflineplus">+      // The call to NoteChange() has to happen after we are done removing the</span>
<a href="#l1.9915"></a><span id="l1.9915" class="difflineplus">+      // keys as NoteChange() will call RowCountChanged() which will call our</span>
<a href="#l1.9916"></a><span id="l1.9916" class="difflineplus">+      // GetRowCount().</span>
<a href="#l1.9917"></a><span id="l1.9917">       if (numIndices &gt; 1)</span>
<a href="#l1.9918"></a><span id="l1.9918">         mTree-&gt;BeginUpdateBatch();</span>
<a href="#l1.9919"></a><span id="l1.9919" class="difflineplus">+</span>
<a href="#l1.9920"></a><span id="l1.9920">       for (uint32_t i = 0; i &lt; numIndices; i++)</span>
<a href="#l1.9921"></a><span id="l1.9921">         NoteChange(mIndicesToNoteChange[i], -1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.9922"></a><span id="l1.9922" class="difflineplus">+</span>
<a href="#l1.9923"></a><span id="l1.9923">       if (numIndices &gt; 1)</span>
<a href="#l1.9924"></a><span id="l1.9924">         mTree-&gt;EndUpdateBatch();</span>
<a href="#l1.9925"></a><span id="l1.9925">     }</span>
<a href="#l1.9926"></a><span id="l1.9926" class="difflineplus">+</span>
<a href="#l1.9927"></a><span id="l1.9927">     mIndicesToNoteChange.Clear();</span>
<a href="#l1.9928"></a><span id="l1.9928">   }</span>
<a href="#l1.9929"></a><span id="l1.9929"> </span>
<a href="#l1.9930"></a><span id="l1.9930">  m_deletingRows = false;</span>
<a href="#l1.9931"></a><span id="l1.9931">  return NS_OK;</span>
<a href="#l1.9932"></a><span id="l1.9932"> }</span>
<a href="#l1.9933"></a><span id="l1.9933"> </span>
<a href="#l1.9934"></a><span id="l1.9934" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetDb(nsIMsgDatabase **aDB)</span>
<a href="#l1.9935"></a><span id="l1.9935" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.9936"></a><span id="l1.9936" class="difflineplus">+nsMsgDBView::GetDb(nsIMsgDatabase **aDB)</span>
<a href="#l1.9937"></a><span id="l1.9937"> {</span>
<a href="#l1.9938"></a><span id="l1.9938">   NS_ENSURE_ARG_POINTER(aDB);</span>
<a href="#l1.9939"></a><span id="l1.9939">   NS_IF_ADDREF(*aDB = m_db);</span>
<a href="#l1.9940"></a><span id="l1.9940">   return NS_OK;</span>
<a href="#l1.9941"></a><span id="l1.9941"> }</span>
<a href="#l1.9942"></a><span id="l1.9942"> </span>
<a href="#l1.9943"></a><span id="l1.9943" class="difflineminus">-bool nsMsgDBView::OfflineMsgSelected(nsMsgViewIndex * indices, int32_t numIndices)</span>
<a href="#l1.9944"></a><span id="l1.9944" class="difflineplus">+bool</span>
<a href="#l1.9945"></a><span id="l1.9945" class="difflineplus">+nsMsgDBView::OfflineMsgSelected(nsMsgViewIndex * indices,</span>
<a href="#l1.9946"></a><span id="l1.9946" class="difflineplus">+                                int32_t numIndices)</span>
<a href="#l1.9947"></a><span id="l1.9947"> {</span>
<a href="#l1.9948"></a><span id="l1.9948">   nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(m_folder);</span>
<a href="#l1.9949"></a><span id="l1.9949">   if (localFolder)</span>
<a href="#l1.9950"></a><span id="l1.9950">     return true;</span>
<a href="#l1.9951"></a><span id="l1.9951"> </span>
<a href="#l1.9952"></a><span id="l1.9952">   for (nsMsgViewIndex index = 0; index &lt; (nsMsgViewIndex) numIndices; index++)</span>
<a href="#l1.9953"></a><span id="l1.9953">   {</span>
<a href="#l1.9954"></a><span id="l1.9954">     // For cross-folder saved searches, we need to check if any message</span>
<a href="#l1.9955"></a><span id="l1.9955" class="difflineat">@@ -7566,53 +8433,58 @@ bool nsMsgDBView::OfflineMsgSelected(nsM</span>
<a href="#l1.9956"></a><span id="l1.9956">       if (localFolder)</span>
<a href="#l1.9957"></a><span id="l1.9957">         return true;</span>
<a href="#l1.9958"></a><span id="l1.9958">     }</span>
<a href="#l1.9959"></a><span id="l1.9959"> </span>
<a href="#l1.9960"></a><span id="l1.9960">     uint32_t flags = m_flags[indices[index]];</span>
<a href="#l1.9961"></a><span id="l1.9961">     if ((flags &amp; nsMsgMessageFlags::Offline))</span>
<a href="#l1.9962"></a><span id="l1.9962">       return true;</span>
<a href="#l1.9963"></a><span id="l1.9963">   }</span>
<a href="#l1.9964"></a><span id="l1.9964" class="difflineplus">+</span>
<a href="#l1.9965"></a><span id="l1.9965">   return false;</span>
<a href="#l1.9966"></a><span id="l1.9966"> }</span>
<a href="#l1.9967"></a><span id="l1.9967"> </span>
<a href="#l1.9968"></a><span id="l1.9968" class="difflineminus">-bool nsMsgDBView::NonDummyMsgSelected(nsMsgViewIndex * indices, int32_t numIndices)</span>
<a href="#l1.9969"></a><span id="l1.9969" class="difflineplus">+bool</span>
<a href="#l1.9970"></a><span id="l1.9970" class="difflineplus">+nsMsgDBView::NonDummyMsgSelected(nsMsgViewIndex * indices,</span>
<a href="#l1.9971"></a><span id="l1.9971" class="difflineplus">+                                 int32_t numIndices)</span>
<a href="#l1.9972"></a><span id="l1.9972"> {</span>
<a href="#l1.9973"></a><span id="l1.9973">   bool includeCollapsedMsgs = OperateOnMsgsInCollapsedThreads();</span>
<a href="#l1.9974"></a><span id="l1.9974"> </span>
<a href="#l1.9975"></a><span id="l1.9975">   for (nsMsgViewIndex index = 0; index &lt; (nsMsgViewIndex) numIndices; index++)</span>
<a href="#l1.9976"></a><span id="l1.9976">   {</span>
<a href="#l1.9977"></a><span id="l1.9977">     uint32_t flags = m_flags[indices[index]];</span>
<a href="#l1.9978"></a><span id="l1.9978">     // We now treat having a collapsed dummy message selected as if</span>
<a href="#l1.9979"></a><span id="l1.9979">     // the whole group was selected so we can apply commands to the group.</span>
<a href="#l1.9980"></a><span id="l1.9980">     if (!(flags &amp; MSG_VIEW_FLAG_DUMMY) ||</span>
<a href="#l1.9981"></a><span id="l1.9981">         (flags &amp; nsMsgMessageFlags::Elided &amp;&amp; includeCollapsedMsgs))</span>
<a href="#l1.9982"></a><span id="l1.9982">       return true;</span>
<a href="#l1.9983"></a><span id="l1.9983">   }</span>
<a href="#l1.9984"></a><span id="l1.9984" class="difflineplus">+</span>
<a href="#l1.9985"></a><span id="l1.9985">   return false;</span>
<a href="#l1.9986"></a><span id="l1.9986"> }</span>
<a href="#l1.9987"></a><span id="l1.9987"> </span>
<a href="#l1.9988"></a><span id="l1.9988" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::GetViewIndexForFirstSelectedMsg(nsMsgViewIndex *aViewIndex)</span>
<a href="#l1.9989"></a><span id="l1.9989" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.9990"></a><span id="l1.9990" class="difflineplus">+nsMsgDBView::GetViewIndexForFirstSelectedMsg(nsMsgViewIndex *aViewIndex)</span>
<a href="#l1.9991"></a><span id="l1.9991"> {</span>
<a href="#l1.9992"></a><span id="l1.9992">   NS_ENSURE_ARG_POINTER(aViewIndex);</span>
<a href="#l1.9993"></a><span id="l1.9993">   // If we don't have a tree selection we must be in stand alone mode...</span>
<a href="#l1.9994"></a><span id="l1.9994">   if (!mTreeSelection)</span>
<a href="#l1.9995"></a><span id="l1.9995">   {</span>
<a href="#l1.9996"></a><span id="l1.9996">     *aViewIndex = m_currentlyDisplayedViewIndex;</span>
<a href="#l1.9997"></a><span id="l1.9997">     return NS_OK;</span>
<a href="#l1.9998"></a><span id="l1.9998">   }</span>
<a href="#l1.9999"></a><span id="l1.9999"> </span>
<a href="#l1.10000"></a><span id="l1.10000">   int32_t startRange;</span>
<a href="#l1.10001"></a><span id="l1.10001">   int32_t endRange;</span>
<a href="#l1.10002"></a><span id="l1.10002">   nsresult rv = mTreeSelection-&gt;GetRangeAt(0, &amp;startRange, &amp;endRange);</span>
<a href="#l1.10003"></a><span id="l1.10003" class="difflineminus">-  // don't assert, it is legal for nothing to be selected</span>
<a href="#l1.10004"></a><span id="l1.10004" class="difflineplus">+  // Don't assert, it is legal for nothing to be selected.</span>
<a href="#l1.10005"></a><span id="l1.10005">   if (NS_FAILED(rv))</span>
<a href="#l1.10006"></a><span id="l1.10006">     return rv;</span>
<a href="#l1.10007"></a><span id="l1.10007"> </span>
<a href="#l1.10008"></a><span id="l1.10008" class="difflineminus">-  // check that the first index is valid, it may not be if nothing is selected</span>
<a href="#l1.10009"></a><span id="l1.10009" class="difflineplus">+  // Check that the first index is valid, it may not be if nothing is selected.</span>
<a href="#l1.10010"></a><span id="l1.10010">   if (startRange &lt; 0 || uint32_t(startRange) &gt;= GetSize())</span>
<a href="#l1.10011"></a><span id="l1.10011">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.10012"></a><span id="l1.10012"> </span>
<a href="#l1.10013"></a><span id="l1.10013">   *aViewIndex = startRange;</span>
<a href="#l1.10014"></a><span id="l1.10014">   return NS_OK;</span>
<a href="#l1.10015"></a><span id="l1.10015"> }</span>
<a href="#l1.10016"></a><span id="l1.10016"> </span>
<a href="#l1.10017"></a><span id="l1.10017"> NS_IMETHODIMP</span>
<a href="#l1.10018"></a><span id="l1.10018" class="difflineat">@@ -7624,193 +8496,214 @@ nsMsgDBView::GetKeyForFirstSelectedMessa</span>
<a href="#l1.10019"></a><span id="l1.10019">   {</span>
<a href="#l1.10020"></a><span id="l1.10020">     *key = m_currentlyDisplayedMsgKey;</span>
<a href="#l1.10021"></a><span id="l1.10021">     return NS_OK;</span>
<a href="#l1.10022"></a><span id="l1.10022">   }</span>
<a href="#l1.10023"></a><span id="l1.10023"> </span>
<a href="#l1.10024"></a><span id="l1.10024">   int32_t startRange;</span>
<a href="#l1.10025"></a><span id="l1.10025">   int32_t endRange;</span>
<a href="#l1.10026"></a><span id="l1.10026">   nsresult rv = mTreeSelection-&gt;GetRangeAt(0, &amp;startRange, &amp;endRange);</span>
<a href="#l1.10027"></a><span id="l1.10027" class="difflineminus">-  // don't assert, it is legal for nothing to be selected</span>
<a href="#l1.10028"></a><span id="l1.10028" class="difflineplus">+  // Don't assert, it is legal for nothing to be selected.</span>
<a href="#l1.10029"></a><span id="l1.10029">   if (NS_FAILED(rv))</span>
<a href="#l1.10030"></a><span id="l1.10030">     return rv;</span>
<a href="#l1.10031"></a><span id="l1.10031"> </span>
<a href="#l1.10032"></a><span id="l1.10032" class="difflineminus">-  // check that the first index is valid, it may not be if nothing is selected</span>
<a href="#l1.10033"></a><span id="l1.10033" class="difflineplus">+  // Check that the first index is valid, it may not be if nothing is selected.</span>
<a href="#l1.10034"></a><span id="l1.10034">   if (startRange &lt; 0 || uint32_t(startRange) &gt;= GetSize())</span>
<a href="#l1.10035"></a><span id="l1.10035">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.10036"></a><span id="l1.10036"> </span>
<a href="#l1.10037"></a><span id="l1.10037">   if (m_flags[startRange] &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l1.10038"></a><span id="l1.10038">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.10039"></a><span id="l1.10039"> </span>
<a href="#l1.10040"></a><span id="l1.10040">   *key = m_keys[startRange];</span>
<a href="#l1.10041"></a><span id="l1.10041">   return NS_OK;</span>
<a href="#l1.10042"></a><span id="l1.10042"> }</span>
<a href="#l1.10043"></a><span id="l1.10043"> </span>
<a href="#l1.10044"></a><span id="l1.10044"> nsCOMArray&lt;nsIMsgFolder&gt;* nsMsgDBView::GetFolders()</span>
<a href="#l1.10045"></a><span id="l1.10045"> {</span>
<a href="#l1.10046"></a><span id="l1.10046">   return nullptr;</span>
<a href="#l1.10047"></a><span id="l1.10047"> }</span>
<a href="#l1.10048"></a><span id="l1.10048"> </span>
<a href="#l1.10049"></a><span id="l1.10049" class="difflineminus">-nsresult nsMsgDBView::AdjustRowCount(int32_t rowCountBeforeSort, int32_t rowCountAfterSort)</span>
<a href="#l1.10050"></a><span id="l1.10050" class="difflineplus">+nsresult</span>
<a href="#l1.10051"></a><span id="l1.10051" class="difflineplus">+nsMsgDBView::AdjustRowCount(int32_t rowCountBeforeSort,</span>
<a href="#l1.10052"></a><span id="l1.10052" class="difflineplus">+                            int32_t rowCountAfterSort)</span>
<a href="#l1.10053"></a><span id="l1.10053"> {</span>
<a href="#l1.10054"></a><span id="l1.10054">   int32_t rowChange = rowCountAfterSort - rowCountBeforeSort;</span>
<a href="#l1.10055"></a><span id="l1.10055"> </span>
<a href="#l1.10056"></a><span id="l1.10056">   if (rowChange)</span>
<a href="#l1.10057"></a><span id="l1.10057">   {</span>
<a href="#l1.10058"></a><span id="l1.10058" class="difflineminus">-    // this is not safe to use when you have a selection</span>
<a href="#l1.10059"></a><span id="l1.10059" class="difflineminus">-    // RowCountChanged() will call AdjustSelection()</span>
<a href="#l1.10060"></a><span id="l1.10060" class="difflineplus">+    // This is not safe to use when you have a selection.</span>
<a href="#l1.10061"></a><span id="l1.10061" class="difflineplus">+    // RowCountChanged() will call AdjustSelection().</span>
<a href="#l1.10062"></a><span id="l1.10062">     uint32_t numSelected = 0;</span>
<a href="#l1.10063"></a><span id="l1.10063">     GetNumSelected(&amp;numSelected);</span>
<a href="#l1.10064"></a><span id="l1.10064" class="difflineminus">-    NS_ASSERTION(numSelected == 0, &quot;it is not save to call AdjustRowCount() when you have a selection&quot;);</span>
<a href="#l1.10065"></a><span id="l1.10065" class="difflineplus">+    NS_ASSERTION(numSelected == 0,</span>
<a href="#l1.10066"></a><span id="l1.10066" class="difflineplus">+                 &quot;it is not save to call AdjustRowCount() when you have a selection&quot;);</span>
<a href="#l1.10067"></a><span id="l1.10067"> </span>
<a href="#l1.10068"></a><span id="l1.10068">     if (mTree)</span>
<a href="#l1.10069"></a><span id="l1.10069">       mTree-&gt;RowCountChanged(0, rowChange);</span>
<a href="#l1.10070"></a><span id="l1.10070">   }</span>
<a href="#l1.10071"></a><span id="l1.10071" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.10072"></a><span id="l1.10072" class="difflineminus">-}</span>
<a href="#l1.10073"></a><span id="l1.10073" class="difflineminus">-</span>
<a href="#l1.10074"></a><span id="l1.10074" class="difflineminus">-nsresult nsMsgDBView::GetImapDeleteModel(nsIMsgFolder *folder)</span>
<a href="#l1.10075"></a><span id="l1.10075" class="difflineplus">+</span>
<a href="#l1.10076"></a><span id="l1.10076" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.10077"></a><span id="l1.10077" class="difflineplus">+}</span>
<a href="#l1.10078"></a><span id="l1.10078" class="difflineplus">+</span>
<a href="#l1.10079"></a><span id="l1.10079" class="difflineplus">+nsresult</span>
<a href="#l1.10080"></a><span id="l1.10080" class="difflineplus">+nsMsgDBView::GetImapDeleteModel(nsIMsgFolder *folder)</span>
<a href="#l1.10081"></a><span id="l1.10081"> {</span>
<a href="#l1.10082"></a><span id="l1.10082">    nsresult rv = NS_OK;</span>
<a href="#l1.10083"></a><span id="l1.10083">    nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.10084"></a><span id="l1.10084" class="difflineminus">-   if (folder) //for the search view</span>
<a href="#l1.10085"></a><span id="l1.10085" class="difflineplus">+   // For the search view.</span>
<a href="#l1.10086"></a><span id="l1.10086" class="difflineplus">+   if (folder)</span>
<a href="#l1.10087"></a><span id="l1.10087">      folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.10088"></a><span id="l1.10088">    else if (m_folder)</span>
<a href="#l1.10089"></a><span id="l1.10089">      m_folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.10090"></a><span id="l1.10090" class="difflineplus">+</span>
<a href="#l1.10091"></a><span id="l1.10091">    nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer = do_QueryInterface(server, &amp;rv);</span>
<a href="#l1.10092"></a><span id="l1.10092">    if (NS_SUCCEEDED(rv) &amp;&amp; imapServer )</span>
<a href="#l1.10093"></a><span id="l1.10093">      imapServer-&gt;GetDeleteModel(&amp;mDeleteModel);</span>
<a href="#l1.10094"></a><span id="l1.10094" class="difflineplus">+</span>
<a href="#l1.10095"></a><span id="l1.10095">    return rv;</span>
<a href="#l1.10096"></a><span id="l1.10096"> }</span>
<a href="#l1.10097"></a><span id="l1.10097"> </span>
<a href="#l1.10098"></a><span id="l1.10098" class="difflineminus">-</span>
<a href="#l1.10099"></a><span id="l1.10099"> //</span>
<a href="#l1.10100"></a><span id="l1.10100"> // CanDrop</span>
<a href="#l1.10101"></a><span id="l1.10101"> //</span>
<a href="#l1.10102"></a><span id="l1.10102"> // Can't drop on the thread pane.</span>
<a href="#l1.10103"></a><span id="l1.10103"> //</span>
<a href="#l1.10104"></a><span id="l1.10104" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::CanDrop(int32_t index,</span>
<a href="#l1.10105"></a><span id="l1.10105" class="difflineminus">-                                   int32_t orient,</span>
<a href="#l1.10106"></a><span id="l1.10106" class="difflineminus">-                                   nsIDOMDataTransfer *dataTransfer,</span>
<a href="#l1.10107"></a><span id="l1.10107" class="difflineminus">-                                   bool *_retval)</span>
<a href="#l1.10108"></a><span id="l1.10108" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.10109"></a><span id="l1.10109" class="difflineplus">+nsMsgDBView::CanDrop(int32_t index,</span>
<a href="#l1.10110"></a><span id="l1.10110" class="difflineplus">+                     int32_t orient,</span>
<a href="#l1.10111"></a><span id="l1.10111" class="difflineplus">+                     nsIDOMDataTransfer *dataTransfer,</span>
<a href="#l1.10112"></a><span id="l1.10112" class="difflineplus">+                     bool *_retval)</span>
<a href="#l1.10113"></a><span id="l1.10113"> {</span>
<a href="#l1.10114"></a><span id="l1.10114">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l1.10115"></a><span id="l1.10115">   *_retval = false;</span>
<a href="#l1.10116"></a><span id="l1.10116"> </span>
<a href="#l1.10117"></a><span id="l1.10117">   return NS_OK;</span>
<a href="#l1.10118"></a><span id="l1.10118"> }</span>
<a href="#l1.10119"></a><span id="l1.10119"> </span>
<a href="#l1.10120"></a><span id="l1.10120" class="difflineminus">-</span>
<a href="#l1.10121"></a><span id="l1.10121"> //</span>
<a href="#l1.10122"></a><span id="l1.10122"> // Drop</span>
<a href="#l1.10123"></a><span id="l1.10123"> //</span>
<a href="#l1.10124"></a><span id="l1.10124"> // Can't drop on the thread pane.</span>
<a href="#l1.10125"></a><span id="l1.10125"> //</span>
<a href="#l1.10126"></a><span id="l1.10126" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::Drop(int32_t row,</span>
<a href="#l1.10127"></a><span id="l1.10127" class="difflineminus">-                                int32_t orient,</span>
<a href="#l1.10128"></a><span id="l1.10128" class="difflineminus">-                                nsIDOMDataTransfer *dataTransfer)</span>
<a href="#l1.10129"></a><span id="l1.10129" class="difflineminus">-{</span>
<a href="#l1.10130"></a><span id="l1.10130" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.10131"></a><span id="l1.10131" class="difflineminus">-}</span>
<a href="#l1.10132"></a><span id="l1.10132" class="difflineminus">-</span>
<a href="#l1.10133"></a><span id="l1.10133" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.10134"></a><span id="l1.10134" class="difflineplus">+nsMsgDBView::Drop(int32_t row,</span>
<a href="#l1.10135"></a><span id="l1.10135" class="difflineplus">+                  int32_t orient,</span>
<a href="#l1.10136"></a><span id="l1.10136" class="difflineplus">+                  nsIDOMDataTransfer *dataTransfer)</span>
<a href="#l1.10137"></a><span id="l1.10137" class="difflineplus">+{</span>
<a href="#l1.10138"></a><span id="l1.10138" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.10139"></a><span id="l1.10139" class="difflineplus">+}</span>
<a href="#l1.10140"></a><span id="l1.10140"> </span>
<a href="#l1.10141"></a><span id="l1.10141"> //</span>
<a href="#l1.10142"></a><span id="l1.10142"> // IsSorted</span>
<a href="#l1.10143"></a><span id="l1.10143"> //</span>
<a href="#l1.10144"></a><span id="l1.10144"> // ...</span>
<a href="#l1.10145"></a><span id="l1.10145"> //</span>
<a href="#l1.10146"></a><span id="l1.10146" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::IsSorted(bool *_retval)</span>
<a href="#l1.10147"></a><span id="l1.10147" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.10148"></a><span id="l1.10148" class="difflineplus">+nsMsgDBView::IsSorted(bool *_retval)</span>
<a href="#l1.10149"></a><span id="l1.10149"> {</span>
<a href="#l1.10150"></a><span id="l1.10150">   *_retval = false;</span>
<a href="#l1.10151"></a><span id="l1.10151">   return NS_OK;</span>
<a href="#l1.10152"></a><span id="l1.10152"> }</span>
<a href="#l1.10153"></a><span id="l1.10153"> </span>
<a href="#l1.10154"></a><span id="l1.10154" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::SelectFolderMsgByKey(nsIMsgFolder *aFolder, nsMsgKey aKey)</span>
<a href="#l1.10155"></a><span id="l1.10155" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.10156"></a><span id="l1.10156" class="difflineplus">+nsMsgDBView::SelectFolderMsgByKey(nsIMsgFolder *aFolder,</span>
<a href="#l1.10157"></a><span id="l1.10157" class="difflineplus">+                                  nsMsgKey aKey)</span>
<a href="#l1.10158"></a><span id="l1.10158"> {</span>
<a href="#l1.10159"></a><span id="l1.10159">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l1.10160"></a><span id="l1.10160">   if (aKey == nsMsgKey_None)</span>
<a href="#l1.10161"></a><span id="l1.10161">     return NS_ERROR_FAILURE;</span>
<a href="#l1.10162"></a><span id="l1.10162"> </span>
<a href="#l1.10163"></a><span id="l1.10163" class="difflineminus">-  // this is OK for non search views.</span>
<a href="#l1.10164"></a><span id="l1.10164" class="difflineplus">+  // This is OK for non search views.</span>
<a href="#l1.10165"></a><span id="l1.10165"> </span>
<a href="#l1.10166"></a><span id="l1.10166">   nsMsgViewIndex viewIndex = FindKey(aKey, true /* expand */);</span>
<a href="#l1.10167"></a><span id="l1.10167"> </span>
<a href="#l1.10168"></a><span id="l1.10168">   if (mTree)</span>
<a href="#l1.10169"></a><span id="l1.10169">     mTreeSelection-&gt;SetCurrentIndex(viewIndex);</span>
<a href="#l1.10170"></a><span id="l1.10170"> </span>
<a href="#l1.10171"></a><span id="l1.10171" class="difflineminus">-  // make sure the current message is once again visible in the thread pane</span>
<a href="#l1.10172"></a><span id="l1.10172" class="difflineminus">-  // so we don't have to go search for it in the thread pane</span>
<a href="#l1.10173"></a><span id="l1.10173" class="difflineplus">+  // Make sure the current message is once again visible in the thread pane</span>
<a href="#l1.10174"></a><span id="l1.10174" class="difflineplus">+  // so we don't have to go search for it in the thread pane.</span>
<a href="#l1.10175"></a><span id="l1.10175">   if (mTree &amp;&amp; viewIndex != nsMsgViewIndex_None)</span>
<a href="#l1.10176"></a><span id="l1.10176">   {</span>
<a href="#l1.10177"></a><span id="l1.10177">     mTreeSelection-&gt;Select(viewIndex);</span>
<a href="#l1.10178"></a><span id="l1.10178">     mTree-&gt;EnsureRowIsVisible(viewIndex);</span>
<a href="#l1.10179"></a><span id="l1.10179">   }</span>
<a href="#l1.10180"></a><span id="l1.10180" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.10181"></a><span id="l1.10181" class="difflineminus">-}</span>
<a href="#l1.10182"></a><span id="l1.10182" class="difflineminus">-</span>
<a href="#l1.10183"></a><span id="l1.10183" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::SelectMsgByKey(nsMsgKey aKey)</span>
<a href="#l1.10184"></a><span id="l1.10184" class="difflineplus">+</span>
<a href="#l1.10185"></a><span id="l1.10185" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.10186"></a><span id="l1.10186" class="difflineplus">+}</span>
<a href="#l1.10187"></a><span id="l1.10187" class="difflineplus">+</span>
<a href="#l1.10188"></a><span id="l1.10188" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.10189"></a><span id="l1.10189" class="difflineplus">+nsMsgDBView::SelectMsgByKey(nsMsgKey aKey)</span>
<a href="#l1.10190"></a><span id="l1.10190"> {</span>
<a href="#l1.10191"></a><span id="l1.10191">   NS_ASSERTION(aKey != nsMsgKey_None, &quot;bad key&quot;);</span>
<a href="#l1.10192"></a><span id="l1.10192">   if (aKey == nsMsgKey_None)</span>
<a href="#l1.10193"></a><span id="l1.10193">     return NS_OK;</span>
<a href="#l1.10194"></a><span id="l1.10194"> </span>
<a href="#l1.10195"></a><span id="l1.10195" class="difflineminus">-  // use SaveAndClearSelection()</span>
<a href="#l1.10196"></a><span id="l1.10196" class="difflineplus">+  // Use SaveAndClearSelection()</span>
<a href="#l1.10197"></a><span id="l1.10197">   // and RestoreSelection() so that we'll clear the current selection</span>
<a href="#l1.10198"></a><span id="l1.10198">   // but pass in a different key array so that we'll</span>
<a href="#l1.10199"></a><span id="l1.10199" class="difflineminus">-  // select (and load) the desired message</span>
<a href="#l1.10200"></a><span id="l1.10200" class="difflineplus">+  // select (and load) the desired message.</span>
<a href="#l1.10201"></a><span id="l1.10201"> </span>
<a href="#l1.10202"></a><span id="l1.10202">   AutoTArray&lt;nsMsgKey, 1&gt; preservedSelection;</span>
<a href="#l1.10203"></a><span id="l1.10203">   nsresult rv = SaveAndClearSelection(nullptr, preservedSelection);</span>
<a href="#l1.10204"></a><span id="l1.10204">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.10205"></a><span id="l1.10205"> </span>
<a href="#l1.10206"></a><span id="l1.10206" class="difflineminus">-  // now, restore our desired selection</span>
<a href="#l1.10207"></a><span id="l1.10207" class="difflineplus">+  // Now, restore our desired selection.</span>
<a href="#l1.10208"></a><span id="l1.10208">   AutoTArray&lt;nsMsgKey, 1&gt; keyArray;</span>
<a href="#l1.10209"></a><span id="l1.10209">   keyArray.AppendElement(aKey);</span>
<a href="#l1.10210"></a><span id="l1.10210"> </span>
<a href="#l1.10211"></a><span id="l1.10211" class="difflineminus">-  // if the key was not found</span>
<a href="#l1.10212"></a><span id="l1.10212" class="difflineplus">+  // If the key was not found</span>
<a href="#l1.10213"></a><span id="l1.10213">   // (this can happen with &quot;remember last selected message&quot;)</span>
<a href="#l1.10214"></a><span id="l1.10214" class="difflineminus">-  // nothing will be selected</span>
<a href="#l1.10215"></a><span id="l1.10215" class="difflineplus">+  // nothing will be selected.</span>
<a href="#l1.10216"></a><span id="l1.10216">   rv = RestoreSelection(aKey, keyArray);</span>
<a href="#l1.10217"></a><span id="l1.10217">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.10218"></a><span id="l1.10218">   return NS_OK;</span>
<a href="#l1.10219"></a><span id="l1.10219"> }</span>
<a href="#l1.10220"></a><span id="l1.10220"> </span>
<a href="#l1.10221"></a><span id="l1.10221"> NS_IMETHODIMP</span>
<a href="#l1.10222"></a><span id="l1.10222" class="difflineminus">-nsMsgDBView::CloneDBView(nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCmdUpdater, nsIMsgDBView **_retval)</span>
<a href="#l1.10223"></a><span id="l1.10223" class="difflineplus">+nsMsgDBView::CloneDBView(nsIMessenger *aMessengerInstance,</span>
<a href="#l1.10224"></a><span id="l1.10224" class="difflineplus">+                         nsIMsgWindow *aMsgWindow,</span>
<a href="#l1.10225"></a><span id="l1.10225" class="difflineplus">+                         nsIMsgDBViewCommandUpdater *aCmdUpdater,</span>
<a href="#l1.10226"></a><span id="l1.10226" class="difflineplus">+                         nsIMsgDBView **_retval)</span>
<a href="#l1.10227"></a><span id="l1.10227"> {</span>
<a href="#l1.10228"></a><span id="l1.10228">   nsMsgDBView* newMsgDBView = new nsMsgDBView();</span>
<a href="#l1.10229"></a><span id="l1.10229"> </span>
<a href="#l1.10230"></a><span id="l1.10230">   nsresult rv = CopyDBView(newMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l1.10231"></a><span id="l1.10231">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.10232"></a><span id="l1.10232"> </span>
<a href="#l1.10233"></a><span id="l1.10233">   NS_IF_ADDREF(*_retval = newMsgDBView);</span>
<a href="#l1.10234"></a><span id="l1.10234">   return NS_OK;</span>
<a href="#l1.10235"></a><span id="l1.10235"> }</span>
<a href="#l1.10236"></a><span id="l1.10236"> </span>
<a href="#l1.10237"></a><span id="l1.10237" class="difflineminus">-nsresult nsMsgDBView::CopyDBView(nsMsgDBView *aNewMsgDBView, nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCmdUpdater)</span>
<a href="#l1.10238"></a><span id="l1.10238" class="difflineplus">+nsresult</span>
<a href="#l1.10239"></a><span id="l1.10239" class="difflineplus">+nsMsgDBView::CopyDBView(nsMsgDBView *aNewMsgDBView,</span>
<a href="#l1.10240"></a><span id="l1.10240" class="difflineplus">+                        nsIMessenger *aMessengerInstance,</span>
<a href="#l1.10241"></a><span id="l1.10241" class="difflineplus">+                        nsIMsgWindow *aMsgWindow,</span>
<a href="#l1.10242"></a><span id="l1.10242" class="difflineplus">+                        nsIMsgDBViewCommandUpdater *aCmdUpdater)</span>
<a href="#l1.10243"></a><span id="l1.10243"> {</span>
<a href="#l1.10244"></a><span id="l1.10244">   NS_ENSURE_ARG_POINTER(aNewMsgDBView);</span>
<a href="#l1.10245"></a><span id="l1.10245">   if (aMsgWindow)</span>
<a href="#l1.10246"></a><span id="l1.10246">   {</span>
<a href="#l1.10247"></a><span id="l1.10247">     aNewMsgDBView-&gt;mMsgWindowWeak = do_GetWeakReference(aMsgWindow);</span>
<a href="#l1.10248"></a><span id="l1.10248">     aMsgWindow-&gt;SetOpenFolder(m_viewFolder? m_viewFolder : m_folder);</span>
<a href="#l1.10249"></a><span id="l1.10249">   }</span>
<a href="#l1.10250"></a><span id="l1.10250" class="difflineplus">+</span>
<a href="#l1.10251"></a><span id="l1.10251">   aNewMsgDBView-&gt;mMessengerWeak = do_GetWeakReference(aMessengerInstance);</span>
<a href="#l1.10252"></a><span id="l1.10252">   aNewMsgDBView-&gt;mCommandUpdater = aCmdUpdater;</span>
<a href="#l1.10253"></a><span id="l1.10253">   aNewMsgDBView-&gt;m_folder = m_folder;</span>
<a href="#l1.10254"></a><span id="l1.10254">   aNewMsgDBView-&gt;m_viewFlags = m_viewFlags;</span>
<a href="#l1.10255"></a><span id="l1.10255">   aNewMsgDBView-&gt;m_sortOrder = m_sortOrder;</span>
<a href="#l1.10256"></a><span id="l1.10256">   aNewMsgDBView-&gt;m_sortType = m_sortType;</span>
<a href="#l1.10257"></a><span id="l1.10257">   aNewMsgDBView-&gt;m_curCustomColumn = m_curCustomColumn;</span>
<a href="#l1.10258"></a><span id="l1.10258">   aNewMsgDBView-&gt;m_secondarySort = m_secondarySort;</span>
<a href="#l1.10259"></a><span id="l1.10259">   aNewMsgDBView-&gt;m_secondarySortOrder = m_secondarySortOrder;</span>
<a href="#l1.10260"></a><span id="l1.10260">   aNewMsgDBView-&gt;m_secondaryCustomColumn = m_secondaryCustomColumn;</span>
<a href="#l1.10261"></a><span id="l1.10261">   aNewMsgDBView-&gt;m_db = m_db;</span>
<a href="#l1.10262"></a><span id="l1.10262">   if (m_db)</span>
<a href="#l1.10263"></a><span id="l1.10263">     aNewMsgDBView-&gt;m_db-&gt;AddListener(aNewMsgDBView);</span>
<a href="#l1.10264"></a><span id="l1.10264" class="difflineplus">+</span>
<a href="#l1.10265"></a><span id="l1.10265">   aNewMsgDBView-&gt;mIsNews = mIsNews;</span>
<a href="#l1.10266"></a><span id="l1.10266">   aNewMsgDBView-&gt;mIsRss = mIsRss;</span>
<a href="#l1.10267"></a><span id="l1.10267">   aNewMsgDBView-&gt;mIsXFVirtual = mIsXFVirtual;</span>
<a href="#l1.10268"></a><span id="l1.10268">   aNewMsgDBView-&gt;mShowSizeInLines = mShowSizeInLines;</span>
<a href="#l1.10269"></a><span id="l1.10269">   aNewMsgDBView-&gt;mDeleteModel = mDeleteModel;</span>
<a href="#l1.10270"></a><span id="l1.10270">   aNewMsgDBView-&gt;m_flags = m_flags;</span>
<a href="#l1.10271"></a><span id="l1.10271">   aNewMsgDBView-&gt;m_levels = m_levels;</span>
<a href="#l1.10272"></a><span id="l1.10272">   aNewMsgDBView-&gt;m_keys = m_keys;</span>
<a href="#l1.10273"></a><span id="l1.10273" class="difflineat">@@ -7839,61 +8732,71 @@ NS_IMETHODIMP</span>
<a href="#l1.10274"></a><span id="l1.10274"> nsMsgDBView::GetSupportsThreading(bool *aResult)</span>
<a href="#l1.10275"></a><span id="l1.10275"> {</span>
<a href="#l1.10276"></a><span id="l1.10276">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l1.10277"></a><span id="l1.10277">   *aResult = true;</span>
<a href="#l1.10278"></a><span id="l1.10278">   return NS_OK;</span>
<a href="#l1.10279"></a><span id="l1.10279"> }</span>
<a href="#l1.10280"></a><span id="l1.10280"> </span>
<a href="#l1.10281"></a><span id="l1.10281"> NS_IMETHODIMP</span>
<a href="#l1.10282"></a><span id="l1.10282" class="difflineminus">-nsMsgDBView::FindIndexFromKey(nsMsgKey aMsgKey, bool aExpand, nsMsgViewIndex *aIndex)</span>
<a href="#l1.10283"></a><span id="l1.10283" class="difflineplus">+nsMsgDBView::FindIndexFromKey(nsMsgKey aMsgKey,</span>
<a href="#l1.10284"></a><span id="l1.10284" class="difflineplus">+                              bool aExpand,</span>
<a href="#l1.10285"></a><span id="l1.10285" class="difflineplus">+                              nsMsgViewIndex *aIndex)</span>
<a href="#l1.10286"></a><span id="l1.10286"> {</span>
<a href="#l1.10287"></a><span id="l1.10287">   NS_ENSURE_ARG_POINTER(aIndex);</span>
<a href="#l1.10288"></a><span id="l1.10288" class="difflineminus">-</span>
<a href="#l1.10289"></a><span id="l1.10289">   *aIndex = FindKey(aMsgKey, aExpand);</span>
<a href="#l1.10290"></a><span id="l1.10290">   return NS_OK;</span>
<a href="#l1.10291"></a><span id="l1.10291"> }</span>
<a href="#l1.10292"></a><span id="l1.10292"> </span>
<a href="#l1.10293"></a><span id="l1.10293"> NS_IMETHODIMP</span>
<a href="#l1.10294"></a><span id="l1.10294" class="difflineminus">-nsMsgDBView::FindIndexOfMsgHdr(nsIMsgDBHdr *aMsgHdr, bool aExpand, nsMsgViewIndex *aIndex)</span>
<a href="#l1.10295"></a><span id="l1.10295" class="difflineplus">+nsMsgDBView::FindIndexOfMsgHdr(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l1.10296"></a><span id="l1.10296" class="difflineplus">+                               bool aExpand,</span>
<a href="#l1.10297"></a><span id="l1.10297" class="difflineplus">+                               nsMsgViewIndex *aIndex)</span>
<a href="#l1.10298"></a><span id="l1.10298"> {</span>
<a href="#l1.10299"></a><span id="l1.10299">   NS_ENSURE_ARG(aMsgHdr);</span>
<a href="#l1.10300"></a><span id="l1.10300">   NS_ENSURE_ARG_POINTER(aIndex);</span>
<a href="#l1.10301"></a><span id="l1.10301"> </span>
<a href="#l1.10302"></a><span id="l1.10302">   if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.10303"></a><span id="l1.10303">   {</span>
<a href="#l1.10304"></a><span id="l1.10304">     nsMsgViewIndex threadIndex = ThreadIndexOfMsgHdr(aMsgHdr);</span>
<a href="#l1.10305"></a><span id="l1.10305">     if (threadIndex != nsMsgViewIndex_None)</span>
<a href="#l1.10306"></a><span id="l1.10306">     {</span>
<a href="#l1.10307"></a><span id="l1.10307">       if (aExpand &amp;&amp; (m_flags[threadIndex] &amp; nsMsgMessageFlags::Elided))</span>
<a href="#l1.10308"></a><span id="l1.10308">         ExpandByIndex(threadIndex, nullptr);</span>
<a href="#l1.10309"></a><span id="l1.10309" class="difflineplus">+</span>
<a href="#l1.10310"></a><span id="l1.10310">       *aIndex = FindHdr(aMsgHdr, threadIndex);</span>
<a href="#l1.10311"></a><span id="l1.10311">     }</span>
<a href="#l1.10312"></a><span id="l1.10312">     else</span>
<a href="#l1.10313"></a><span id="l1.10313" class="difflineplus">+    {</span>
<a href="#l1.10314"></a><span id="l1.10314">       *aIndex = nsMsgViewIndex_None;</span>
<a href="#l1.10315"></a><span id="l1.10315" class="difflineplus">+    }</span>
<a href="#l1.10316"></a><span id="l1.10316">   }</span>
<a href="#l1.10317"></a><span id="l1.10317">   else</span>
<a href="#l1.10318"></a><span id="l1.10318" class="difflineplus">+  {</span>
<a href="#l1.10319"></a><span id="l1.10319">     *aIndex = FindHdr(aMsgHdr);</span>
<a href="#l1.10320"></a><span id="l1.10320" class="difflineplus">+  }</span>
<a href="#l1.10321"></a><span id="l1.10321"> </span>
<a href="#l1.10322"></a><span id="l1.10322">   return NS_OK;</span>
<a href="#l1.10323"></a><span id="l1.10323"> }</span>
<a href="#l1.10324"></a><span id="l1.10324"> </span>
<a href="#l1.10325"></a><span id="l1.10325"> static void</span>
<a href="#l1.10326"></a><span id="l1.10326" class="difflineminus">-getDateFormatPref( nsIPrefBranch* _prefBranch, const char* _prefLocalName, mozilla::nsDateFormatSelector&amp; _format )</span>
<a href="#l1.10327"></a><span id="l1.10327" class="difflineminus">-{</span>
<a href="#l1.10328"></a><span id="l1.10328" class="difflineminus">-  // read</span>
<a href="#l1.10329"></a><span id="l1.10329" class="difflineplus">+getDateFormatPref(nsIPrefBranch* _prefBranch,</span>
<a href="#l1.10330"></a><span id="l1.10330" class="difflineplus">+                  const char* _prefLocalName,</span>
<a href="#l1.10331"></a><span id="l1.10331" class="difflineplus">+                  mozilla::nsDateFormatSelector&amp; _format )</span>
<a href="#l1.10332"></a><span id="l1.10332" class="difflineplus">+{</span>
<a href="#l1.10333"></a><span id="l1.10333" class="difflineplus">+  // Read.</span>
<a href="#l1.10334"></a><span id="l1.10334">   int32_t nFormatSetting( 0 );</span>
<a href="#l1.10335"></a><span id="l1.10335">   nsresult result = _prefBranch-&gt;GetIntPref( _prefLocalName, &amp;nFormatSetting );</span>
<a href="#l1.10336"></a><span id="l1.10336">   if ( NS_SUCCEEDED( result ) )</span>
<a href="#l1.10337"></a><span id="l1.10337">   {</span>
<a href="#l1.10338"></a><span id="l1.10338" class="difflineminus">-    // translate</span>
<a href="#l1.10339"></a><span id="l1.10339" class="difflineplus">+    // Translate.</span>
<a href="#l1.10340"></a><span id="l1.10340">     mozilla::nsDateFormatSelector res;</span>
<a href="#l1.10341"></a><span id="l1.10341">     res = static_cast&lt;mozilla::nsDateFormatSelector&gt;(nFormatSetting);</span>
<a href="#l1.10342"></a><span id="l1.10342" class="difflineminus">-    // transfer if valid</span>
<a href="#l1.10343"></a><span id="l1.10343" class="difflineminus">-    if ( ( res &gt;= mozilla::kDateFormatNone ) &amp;&amp; ( res &lt;= mozilla::kDateFormatWeekday ) )</span>
<a href="#l1.10344"></a><span id="l1.10344" class="difflineplus">+    // Transfer if valid.</span>
<a href="#l1.10345"></a><span id="l1.10345" class="difflineplus">+    if (res &gt;= mozilla::kDateFormatNone &amp;&amp; res &lt;= mozilla::kDateFormatWeekday)</span>
<a href="#l1.10346"></a><span id="l1.10346">       _format = res;</span>
<a href="#l1.10347"></a><span id="l1.10347">   }</span>
<a href="#l1.10348"></a><span id="l1.10348"> }</span>
<a href="#l1.10349"></a><span id="l1.10349"> </span>
<a href="#l1.10350"></a><span id="l1.10350"> nsresult nsMsgDBView::InitDisplayFormats()</span>
<a href="#l1.10351"></a><span id="l1.10351"> {</span>
<a href="#l1.10352"></a><span id="l1.10352">   m_dateFormatDefault   = mozilla::kDateFormatShort;</span>
<a href="#l1.10353"></a><span id="l1.10353">   m_dateFormatThisWeek  = mozilla::kDateFormatShort;</span>
<a href="#l1.10354"></a><span id="l1.10354" class="difflineat">@@ -7907,48 +8810,49 @@ nsresult nsMsgDBView::InitDisplayFormats</span>
<a href="#l1.10355"></a><span id="l1.10355">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.10356"></a><span id="l1.10356"> </span>
<a href="#l1.10357"></a><span id="l1.10357">   getDateFormatPref( dateFormatPrefs, &quot;default&quot;, m_dateFormatDefault );</span>
<a href="#l1.10358"></a><span id="l1.10358">   getDateFormatPref( dateFormatPrefs, &quot;thisweek&quot;, m_dateFormatThisWeek );</span>
<a href="#l1.10359"></a><span id="l1.10359">   getDateFormatPref( dateFormatPrefs, &quot;today&quot;, m_dateFormatToday );</span>
<a href="#l1.10360"></a><span id="l1.10360">   return rv;</span>
<a href="#l1.10361"></a><span id="l1.10361"> }</span>
<a href="#l1.10362"></a><span id="l1.10362"> </span>
<a href="#l1.10363"></a><span id="l1.10363" class="difflineminus">-void nsMsgDBView::SetMRUTimeForFolder(nsIMsgFolder *folder)</span>
<a href="#l1.10364"></a><span id="l1.10364" class="difflineplus">+void</span>
<a href="#l1.10365"></a><span id="l1.10365" class="difflineplus">+nsMsgDBView::SetMRUTimeForFolder(nsIMsgFolder *folder)</span>
<a href="#l1.10366"></a><span id="l1.10366"> {</span>
<a href="#l1.10367"></a><span id="l1.10367">   uint32_t seconds;</span>
<a href="#l1.10368"></a><span id="l1.10368">   PRTime2Seconds(PR_Now(), &amp;seconds);</span>
<a href="#l1.10369"></a><span id="l1.10369">   nsAutoCString nowStr;</span>
<a href="#l1.10370"></a><span id="l1.10370">   nowStr.AppendInt(seconds);</span>
<a href="#l1.10371"></a><span id="l1.10371">   folder-&gt;SetStringProperty(MRU_TIME_PROPERTY, nowStr);</span>
<a href="#l1.10372"></a><span id="l1.10372"> }</span>
<a href="#l1.10373"></a><span id="l1.10373"> </span>
<a href="#l1.10374"></a><span id="l1.10374" class="difflineminus">-</span>
<a href="#l1.10375"></a><span id="l1.10375"> NS_IMPL_ISUPPORTS(nsMsgDBView::nsMsgViewHdrEnumerator, nsISimpleEnumerator)</span>
<a href="#l1.10376"></a><span id="l1.10376"> </span>
<a href="#l1.10377"></a><span id="l1.10377"> nsMsgDBView::nsMsgViewHdrEnumerator::nsMsgViewHdrEnumerator(nsMsgDBView *view)</span>
<a href="#l1.10378"></a><span id="l1.10378"> {</span>
<a href="#l1.10379"></a><span id="l1.10379" class="difflineminus">-  // we need to clone the view because the caller may clear the</span>
<a href="#l1.10380"></a><span id="l1.10380" class="difflineplus">+  // We need to clone the view because the caller may clear the</span>
<a href="#l1.10381"></a><span id="l1.10381">   // current view immediately. It also makes it easier to expand all</span>
<a href="#l1.10382"></a><span id="l1.10382">   // if we're working on a copy.</span>
<a href="#l1.10383"></a><span id="l1.10383">   nsCOMPtr&lt;nsIMsgDBView&gt; clonedView;</span>
<a href="#l1.10384"></a><span id="l1.10384">   view-&gt;CloneDBView(nullptr, nullptr, nullptr, getter_AddRefs(clonedView));</span>
<a href="#l1.10385"></a><span id="l1.10385">   m_view = static_cast&lt;nsMsgDBView*&gt;(clonedView.get());</span>
<a href="#l1.10386"></a><span id="l1.10386" class="difflineminus">-  // make sure we enumerate over collapsed threads by expanding all.</span>
<a href="#l1.10387"></a><span id="l1.10387" class="difflineplus">+  // Make sure we enumerate over collapsed threads by expanding all.</span>
<a href="#l1.10388"></a><span id="l1.10388">   m_view-&gt;ExpandAll();</span>
<a href="#l1.10389"></a><span id="l1.10389">   m_curHdrIndex = 0;</span>
<a href="#l1.10390"></a><span id="l1.10390"> }</span>
<a href="#l1.10391"></a><span id="l1.10391"> </span>
<a href="#l1.10392"></a><span id="l1.10392"> nsMsgDBView::nsMsgViewHdrEnumerator::~nsMsgViewHdrEnumerator()</span>
<a href="#l1.10393"></a><span id="l1.10393"> {</span>
<a href="#l1.10394"></a><span id="l1.10394">   if (m_view)</span>
<a href="#l1.10395"></a><span id="l1.10395">     m_view-&gt;Close();</span>
<a href="#l1.10396"></a><span id="l1.10396"> }</span>
<a href="#l1.10397"></a><span id="l1.10397"> </span>
<a href="#l1.10398"></a><span id="l1.10398" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::nsMsgViewHdrEnumerator::GetNext(nsISupports **aItem)</span>
<a href="#l1.10399"></a><span id="l1.10399" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.10400"></a><span id="l1.10400" class="difflineplus">+nsMsgDBView::nsMsgViewHdrEnumerator::GetNext(nsISupports **aItem)</span>
<a href="#l1.10401"></a><span id="l1.10401"> {</span>
<a href="#l1.10402"></a><span id="l1.10402">   NS_ENSURE_ARG_POINTER(aItem);</span>
<a href="#l1.10403"></a><span id="l1.10403"> </span>
<a href="#l1.10404"></a><span id="l1.10404">   if (m_curHdrIndex &gt;= m_view-&gt;GetSize())</span>
<a href="#l1.10405"></a><span id="l1.10405">     return NS_ERROR_FAILURE;</span>
<a href="#l1.10406"></a><span id="l1.10406"> </span>
<a href="#l1.10407"></a><span id="l1.10407">   // Ignore dummy header. We won't have empty groups, so</span>
<a href="#l1.10408"></a><span id="l1.10408">   // we know the view index is good.</span>
<a href="#l1.10409"></a><span id="l1.10409" class="difflineat">@@ -7957,66 +8861,74 @@ NS_IMETHODIMP nsMsgDBView::nsMsgViewHdrE</span>
<a href="#l1.10410"></a><span id="l1.10410"> </span>
<a href="#l1.10411"></a><span id="l1.10411">   nsCOMPtr&lt;nsIMsgDBHdr&gt; nextHdr;</span>
<a href="#l1.10412"></a><span id="l1.10412"> </span>
<a href="#l1.10413"></a><span id="l1.10413">   nsresult rv = m_view-&gt;GetMsgHdrForViewIndex(m_curHdrIndex++, getter_AddRefs(nextHdr));</span>
<a href="#l1.10414"></a><span id="l1.10414">   nextHdr.forget(aItem);</span>
<a href="#l1.10415"></a><span id="l1.10415">   return rv;</span>
<a href="#l1.10416"></a><span id="l1.10416"> }</span>
<a href="#l1.10417"></a><span id="l1.10417"> </span>
<a href="#l1.10418"></a><span id="l1.10418" class="difflineminus">-NS_IMETHODIMP nsMsgDBView::nsMsgViewHdrEnumerator::HasMoreElements(bool *aResult)</span>
<a href="#l1.10419"></a><span id="l1.10419" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.10420"></a><span id="l1.10420" class="difflineplus">+nsMsgDBView::nsMsgViewHdrEnumerator::HasMoreElements(bool *aResult)</span>
<a href="#l1.10421"></a><span id="l1.10421"> {</span>
<a href="#l1.10422"></a><span id="l1.10422">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l1.10423"></a><span id="l1.10423">   *aResult = m_curHdrIndex &lt; m_view-&gt;GetSize();</span>
<a href="#l1.10424"></a><span id="l1.10424">   return NS_OK;</span>
<a href="#l1.10425"></a><span id="l1.10425"> }</span>
<a href="#l1.10426"></a><span id="l1.10426"> </span>
<a href="#l1.10427"></a><span id="l1.10427" class="difflineminus">-nsresult nsMsgDBView::GetViewEnumerator(nsISimpleEnumerator **enumerator)</span>
<a href="#l1.10428"></a><span id="l1.10428" class="difflineplus">+nsresult</span>
<a href="#l1.10429"></a><span id="l1.10429" class="difflineplus">+nsMsgDBView::GetViewEnumerator(nsISimpleEnumerator **enumerator)</span>
<a href="#l1.10430"></a><span id="l1.10430"> {</span>
<a href="#l1.10431"></a><span id="l1.10431">   NS_IF_ADDREF(*enumerator = new nsMsgViewHdrEnumerator(this));</span>
<a href="#l1.10432"></a><span id="l1.10432">   return (*enumerator) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.10433"></a><span id="l1.10433"> }</span>
<a href="#l1.10434"></a><span id="l1.10434"> </span>
<a href="#l1.10435"></a><span id="l1.10435" class="difflineminus">-nsresult nsMsgDBView::GetDBForHeader(nsIMsgDBHdr *msgHdr, nsIMsgDatabase **db)</span>
<a href="#l1.10436"></a><span id="l1.10436" class="difflineplus">+nsresult</span>
<a href="#l1.10437"></a><span id="l1.10437" class="difflineplus">+nsMsgDBView::GetDBForHeader(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.10438"></a><span id="l1.10438" class="difflineplus">+                            nsIMsgDatabase **db)</span>
<a href="#l1.10439"></a><span id="l1.10439"> {</span>
<a href="#l1.10440"></a><span id="l1.10440">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.10441"></a><span id="l1.10441">   nsresult rv = msgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l1.10442"></a><span id="l1.10442">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.10443"></a><span id="l1.10443">   return folder-&gt;GetMsgDatabase(db);</span>
<a href="#l1.10444"></a><span id="l1.10444"> }</span>
<a href="#l1.10445"></a><span id="l1.10445"> </span>
<a href="#l1.10446"></a><span id="l1.10446"> /**</span>
<a href="#l1.10447"></a><span id="l1.10447">  * Determine whether junk commands should be enabled on this view.</span>
<a href="#l1.10448"></a><span id="l1.10448">  * Junk commands are always enabled for mail. For nntp and rss, they</span>
<a href="#l1.10449"></a><span id="l1.10449">  * may be selectively enabled using an inherited folder property.</span>
<a href="#l1.10450"></a><span id="l1.10450">  *</span>
<a href="#l1.10451"></a><span id="l1.10451">  * @param  aViewIndex  view index of the message to check</span>
<a href="#l1.10452"></a><span id="l1.10452">  * @return             true if junk controls should be enabled</span>
<a href="#l1.10453"></a><span id="l1.10453">  */</span>
<a href="#l1.10454"></a><span id="l1.10454" class="difflineminus">-bool nsMsgDBView::JunkControlsEnabled(nsMsgViewIndex aViewIndex)</span>
<a href="#l1.10455"></a><span id="l1.10455" class="difflineplus">+bool</span>
<a href="#l1.10456"></a><span id="l1.10456" class="difflineplus">+nsMsgDBView::JunkControlsEnabled(nsMsgViewIndex aViewIndex)</span>
<a href="#l1.10457"></a><span id="l1.10457"> {</span>
<a href="#l1.10458"></a><span id="l1.10458">   // For normal mail, junk commands are always enabled.</span>
<a href="#l1.10459"></a><span id="l1.10459">   if (!(mIsNews || mIsRss || mIsXFVirtual))</span>
<a href="#l1.10460"></a><span id="l1.10460">     return true;</span>
<a href="#l1.10461"></a><span id="l1.10461"> </span>
<a href="#l1.10462"></a><span id="l1.10462" class="difflineminus">-  // we need to check per message or folder</span>
<a href="#l1.10463"></a><span id="l1.10463" class="difflineplus">+  // We need to check per message or folder.</span>
<a href="#l1.10464"></a><span id="l1.10464">   nsCOMPtr &lt;nsIMsgFolder&gt; folder = m_folder;</span>
<a href="#l1.10465"></a><span id="l1.10465">   if (!folder &amp;&amp; IsValidIndex(aViewIndex))</span>
<a href="#l1.10466"></a><span id="l1.10466">     GetFolderForViewIndex(aViewIndex, getter_AddRefs(folder));</span>
<a href="#l1.10467"></a><span id="l1.10467" class="difflineplus">+</span>
<a href="#l1.10468"></a><span id="l1.10468">   if (folder)</span>
<a href="#l1.10469"></a><span id="l1.10469">   {</span>
<a href="#l1.10470"></a><span id="l1.10470">     // Check if this is a mail message in search folders.</span>
<a href="#l1.10471"></a><span id="l1.10471">     if (mIsXFVirtual)</span>
<a href="#l1.10472"></a><span id="l1.10472">     {</span>
<a href="#l1.10473"></a><span id="l1.10473">       nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.10474"></a><span id="l1.10474">       folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.10475"></a><span id="l1.10475">       nsAutoCString type;</span>
<a href="#l1.10476"></a><span id="l1.10476">       if (server)</span>
<a href="#l1.10477"></a><span id="l1.10477">         server-&gt;GetType(type);</span>
<a href="#l1.10478"></a><span id="l1.10478" class="difflineminus">-      if (!(MsgLowerCaseEqualsLiteral(type, &quot;nntp&quot;) || MsgLowerCaseEqualsLiteral(type, &quot;rss&quot;)))</span>
<a href="#l1.10479"></a><span id="l1.10479" class="difflineplus">+</span>
<a href="#l1.10480"></a><span id="l1.10480" class="difflineplus">+      if (!(MsgLowerCaseEqualsLiteral(type, &quot;nntp&quot;) ||</span>
<a href="#l1.10481"></a><span id="l1.10481" class="difflineplus">+            MsgLowerCaseEqualsLiteral(type, &quot;rss&quot;)))</span>
<a href="#l1.10482"></a><span id="l1.10482">         return true;</span>
<a href="#l1.10483"></a><span id="l1.10483">     }</span>
<a href="#l1.10484"></a><span id="l1.10484"> </span>
<a href="#l1.10485"></a><span id="l1.10485">     // For rss and news, check the inherited folder property.</span>
<a href="#l1.10486"></a><span id="l1.10486">     nsAutoCString junkEnableOverride;</span>
<a href="#l1.10487"></a><span id="l1.10487">     folder-&gt;GetInheritedStringProperty(&quot;dobayes.mailnews@mozilla.org#junk&quot;,</span>
<a href="#l1.10488"></a><span id="l1.10488">                                        junkEnableOverride);</span>
<a href="#l1.10489"></a><span id="l1.10489">     if (junkEnableOverride.EqualsLiteral(&quot;true&quot;))</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

