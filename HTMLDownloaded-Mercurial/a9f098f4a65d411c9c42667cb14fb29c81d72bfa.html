<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 3621:a9f098f4a65d411c9c42667cb14fb29c81d72bfa</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ a9f098f4a65d411c9c42667cb14fb29c81d72bfa" />
<meta property="og:url" content="/comm-central/rev/a9f098f4a65d411c9c42667cb14fb29c81d72bfa" />
<meta property="og:description" content="merge of default" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / a9f098f4a65d411c9c42667cb14fb29c81d72bfa 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/a9f098f4a65d411c9c42667cb14fb29c81d72bfa">shortlog</a> |
<a href="/comm-central/log/a9f098f4a65d411c9c42667cb14fb29c81d72bfa">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/a9f098f4a65d411c9c42667cb14fb29c81d72bfa">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/a9f098f4a65d411c9c42667cb14fb29c81d72bfa">files</a> |
changeset |
<a href="/comm-central/raw-rev/a9f098f4a65d411c9c42667cb14fb29c81d72bfa">raw</a>  | <a href="/comm-central/archive/a9f098f4a65d411c9c42667cb14fb29c81d72bfa.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
merge of default
<span class="logtags"><span class="inbranchtag" title="add-protovis">add-protovis</span> </span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 01 Sep 2009 17:20:45 -0700</td></tr>
<tr><td>branch</td><td>add-protovis</td></tr>
<tr>
 <td>changeset 3621</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/a9f098f4a65d411c9c42667cb14fb29c81d72bfa">a9f098f4a65d411c9c42667cb14fb29c81d72bfa</a></td>
</tr>



<tr>
<td>parent 3615</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c6bfb9d50d7ffc546cbbd5b420aa84b06d7b495e">c6bfb9d50d7ffc546cbbd5b420aa84b06d7b495e</a> (current diff)
</td>
</tr>
<tr>
<td>parent 3487</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/de2502431ec30544ebf5942d068d39a802812938">de2502431ec30544ebf5942d068d39a802812938</a> (<a href="/comm-central/rev/de2502431ec30544ebf5942d068d39a802812938:a9f098f4a65d">diff</a>)
</td>
</tr>

<tr>
<td>child 3622</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/41f7c22e5f9744384683b2e1d4dfdf490f21607a">41f7c22e5f9744384683b2e1d4dfdf490f21607a</a>
</td>
</tr>
<tr>
<td>child 3624</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/96b37b501ea5c25ad20e12397bde8bce017f26f5">96b37b501ea5c25ad20e12397bde8bce017f26f5</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=a9f098f4a65d411c9c42667cb14fb29c81d72bfa">2927</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Thu, 10 Sep 2009 01:15:56 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0b161ed73eb6 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&newProject=comm-central&newRevision=b5e0aff84bf4077a47919481912ad0bd11c6a8d8&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&newProject=comm-central&newRevision=b5e0aff84bf4077a47919481912ad0bd11c6a8d8&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&newProject=comm-central&newRevision=b5e0aff84bf4077a47919481912ad0bd11c6a8d8&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">merge of default</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a9f098f4a65d411c9c42667cb14fb29c81d72bfa/.hgpatchinfo/add-protovis.dep">.hgpatchinfo/add-protovis.dep</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a9f098f4a65d411c9c42667cb14fb29c81d72bfa/.hgpatchinfo/add-protovis.dep">file</a> |
<a href="/comm-central/annotate/a9f098f4a65d411c9c42667cb14fb29c81d72bfa/.hgpatchinfo/add-protovis.dep">annotate</a> |
<a href="/comm-central/diff/a9f098f4a65d411c9c42667cb14fb29c81d72bfa/.hgpatchinfo/add-protovis.dep">diff</a> |
<a href="/comm-central/comparison/a9f098f4a65d411c9c42667cb14fb29c81d72bfa/.hgpatchinfo/add-protovis.dep">comparison</a> |
<a href="/comm-central/log/a9f098f4a65d411c9c42667cb14fb29c81d72bfa/.hgpatchinfo/add-protovis.dep">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.hgpatchinfo/add-protovis.dep</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.hgpatchinfo/add-protovis.dep</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,1 +1,1 @@</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineminus">-02903d938d67c49bb1e8dacd634d6a14cc385bbc</span>
<a href="#l1.5"></a><span id="l1.5">\ No newline at end of file</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+de2502431ec30544ebf5942d068d39a802812938</span>
<a href="#l1.7"></a><span id="l1.7">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/specialTabs.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/specialTabs.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -83,55 +83,62 @@ var specialTabs = {</span>
<a href="#l2.4"></a><span id="l2.4">       // to re-use the same tab.</span>
<a href="#l2.5"></a><span id="l2.5">       let regEx = new RegExp(&quot;#.*&quot;);</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">       let contentUrl = aContentPage.replace(regEx, &quot;&quot;);</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">       for (let selectedIndex = 0; selectedIndex &lt; tabInfo.length;</span>
<a href="#l2.10"></a><span id="l2.10">            ++selectedIndex) {</span>
<a href="#l2.11"></a><span id="l2.11">         if (tabInfo[selectedIndex].mode.name == this.name &amp;&amp;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-            tabInfo[selectedIndex].browser</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-                                  .getAttribute(&quot;src&quot;)</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+            tabInfo[selectedIndex].browser.currentURI.spec</span>
<a href="#l2.15"></a><span id="l2.15">                                   .replace(regEx, &quot;&quot;) == contentUrl) {</span>
<a href="#l2.16"></a><span id="l2.16">           // Ensure we go to the correct location on the page.</span>
<a href="#l2.17"></a><span id="l2.17">           tabInfo[selectedIndex].browser</span>
<a href="#l2.18"></a><span id="l2.18">                                 .setAttribute(&quot;src&quot;, aContentPage);</span>
<a href="#l2.19"></a><span id="l2.19">           return selectedIndex;</span>
<a href="#l2.20"></a><span id="l2.20">         }</span>
<a href="#l2.21"></a><span id="l2.21">       }</span>
<a href="#l2.22"></a><span id="l2.22">       return -1;</span>
<a href="#l2.23"></a><span id="l2.23">     },</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-    openTab: function onTabOpened(aTab, {contentPage: aContentPage}) {</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+    openTab: function onTabOpened(aTab, aArgs) {</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+      if (!&quot;contentPage&quot; in aArgs)</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+        throw(&quot;contentPage must be specified&quot;);</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+</span>
<a href="#l2.29"></a><span id="l2.29">       // First clone the page and set up the basics.</span>
<a href="#l2.30"></a><span id="l2.30">       let clone = document.getElementById(&quot;contentTab&quot;).firstChild.cloneNode(true);</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32">       clone.setAttribute(&quot;id&quot;, &quot;contentTab&quot; + this.lastBrowserId);</span>
<a href="#l2.33"></a><span id="l2.33">       clone.setAttribute(&quot;collapsed&quot;, false);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-      clone.setAttribute(&quot;type&quot;, &quot;content-primary&quot;);</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36">       aTab.panel.appendChild(clone);</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38">       // Start setting up the browser.</span>
<a href="#l2.39"></a><span id="l2.39">       aTab.browser = aTab.panel.getElementsByTagName(&quot;browser&quot;)[0];</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+      // As we're opening this tab, showTab may not get called, so set</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+      // the type according to if we're opening in background or not.</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+      let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+      aTab.browser.setAttribute(&quot;type&quot;, background ? &quot;content-targetable&quot; :</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+                                                     &quot;content-primary&quot;);</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+</span>
<a href="#l2.47"></a><span id="l2.47">       aTab.browser.setAttribute(&quot;id&quot;, &quot;contentTabBrowser&quot; + this.lastBrowserId);</span>
<a href="#l2.48"></a><span id="l2.48"> </span>
<a href="#l2.49"></a><span id="l2.49">       // Now initialise the find bar.</span>
<a href="#l2.50"></a><span id="l2.50">       aTab.findbar = aTab.panel.getElementsByTagName(&quot;findbar&quot;)[0];</span>
<a href="#l2.51"></a><span id="l2.51">       aTab.findbar.setAttribute(&quot;browserid&quot;,</span>
<a href="#l2.52"></a><span id="l2.52">                                 &quot;contentTabBrowser&quot; + this.lastBrowserId);</span>
<a href="#l2.53"></a><span id="l2.53"> </span>
<a href="#l2.54"></a><span id="l2.54">       // Now set up the listeners.</span>
<a href="#l2.55"></a><span id="l2.55">       this._setUpTitleListener(aTab);</span>
<a href="#l2.56"></a><span id="l2.56">       this._setUpCloseWindowListener(aTab);</span>
<a href="#l2.57"></a><span id="l2.57"> </span>
<a href="#l2.58"></a><span id="l2.58">       // Now start loading the content.</span>
<a href="#l2.59"></a><span id="l2.59">       aTab.title = this.loadingTabString;</span>
<a href="#l2.60"></a><span id="l2.60"> </span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-      aTab.browser.loadURI(aContentPage);</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+      aTab.browser.loadURI(aArgs.contentPage);</span>
<a href="#l2.63"></a><span id="l2.63"> </span>
<a href="#l2.64"></a><span id="l2.64">       this.lastBrowserId++;</span>
<a href="#l2.65"></a><span id="l2.65">     },</span>
<a href="#l2.66"></a><span id="l2.66">     closeTab: function onTabClosed(aTab) {</span>
<a href="#l2.67"></a><span id="l2.67">       aTab.browser.removeEventListener(&quot;DOMTitleChanged&quot;,</span>
<a href="#l2.68"></a><span id="l2.68">                                        aTab.titleListener, true);</span>
<a href="#l2.69"></a><span id="l2.69">       aTab.browser.removeEventListener(&quot;DOMWindowClose&quot;,</span>
<a href="#l2.70"></a><span id="l2.70">                                        aTab.closeListener, true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">copy from mail/locales/l10n.ini</span>
<a href="#l3.2"></a><span id="l3.2">copy to mail/locales/l10n-1.9.1.ini</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">copy from mail/locales/l10n.ini</span>
<a href="#l4.2"></a><span id="l4.2">copy to mail/locales/l10n-central.ini</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineminus">--- a/mail/locales/l10n.ini</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineplus">+++ b/mail/locales/l10n-central.ini</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineat">@@ -12,11 +12,11 @@ dirs = mail</span>
<a href="#l4.6"></a><span id="l4.6"> # RFE: that needs to be supported by compare-locales, too, though</span>
<a href="#l4.7"></a><span id="l4.7"> toolkit = mozilla/toolkit/locales/l10n.ini</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> [extras]</span>
<a href="#l4.10"></a><span id="l4.10"> dirs = mozilla/extensions/spellcheck</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12"> [include_toolkit]</span>
<a href="#l4.13"></a><span id="l4.13"> type = hg</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-mozilla = releases/mozilla-1.9.1</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+mozilla = mozilla-central</span>
<a href="#l4.16"></a><span id="l4.16"> repo = http://hg.mozilla.org/</span>
<a href="#l4.17"></a><span id="l4.17"> l10n.ini = toolkit/locales/l10n.ini</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/html/whatsnew.html</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,8 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+&lt;html&gt;</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+  &lt;head&gt;</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+    &lt;title&gt;What's New Content Test&lt;/title&gt; </span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+  &lt;/head&gt;</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+  &lt;body bgcolor=&quot;#FFFFFF&quot;&gt;</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+    &lt;h1&gt;What's New Content Test&lt;/h1&gt;</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+  &lt;/body&gt;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-content-tab.js</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,115 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ *</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+ *</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ * License.</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+ *</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+ *</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+ * Mozilla Messaging.</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+ *</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+ *   Mark Banner &lt;mark@standard8.plus.com&gt;</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+ *</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+ *</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+var MODULE_NAME = 'test-content-tab';</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+var MODULE_REQUIRES = ['window-helpers'];</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+var controller = {};</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+Components.utils.import('resource://mozmill/modules/controller.js', controller)</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+;</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+var mozmill = {};</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+Components.utils.import('resource://mozmill/modules/mozmill.js', mozmill);</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+var elementslib = {};</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+Components.utils.import('resource://mozmill/modules/elementslib.js', elementslib);</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+var windowHelper;</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+var mainController = null;</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+var mc;</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+// RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+// so we get the right path for the resources.</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+var url = collector.addHttpResource('../content-tabs/html', 'content-tabs');</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+var whatsUrl = url + &quot;whatsnew.html&quot;;</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+var setupModule = function (module) {</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+  windowHelper = collector.getModule('window-helpers');</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+  mc = mainController = windowHelper.wait_for_existing_window(&quot;mail:3pane&quot;);</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+  windowHelper.installInto(module);</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+  windowHelper.augment_controller(mc);</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+};</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+function test_content_tab_open() {</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+  let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+  // Set the pref so that what's new opens a local url</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+  Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+            .getService(Components.interfaces.nsIPrefBranch)</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+            .setCharPref(&quot;mailnews.start_page.override_url&quot;,</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+                         whatsUrl);</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+  mc.click(new elementslib.Elem(mc.menus.helpMenu.whatsNew));</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+  controller.sleep(0);</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+  // XXX When bug 508999 is fixed, remove the sleep and use the waitForEval</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+  // instead.</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+  // controller.waitForEval(&quot;subject.busy == false&quot;, 1000, 100, newTab);</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+  controller.sleep(400);</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+  if (mc.tabmail.tabContainer.childNodes.length != preCount + 1)</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+    throw new Error(&quot;The content tab didn't open&quot;);</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+  if (mc.tabmail.selectedTab.title != &quot;What's New Content Test&quot;)</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+    throw new Error(&quot;The content tab has an incorrect title&quot;);</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+  // Check that window.content is set up correctly wrt content-primary and</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+  // content-targetable.</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+  if (mc.window.content.location != whatsUrl)</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+    throw new Error(&quot;window.content is not set to the url loaded, incorrect type=\&quot;...\&quot;?&quot;);</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+}</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+function test_content_tab_open_same() {</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+  let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+  mc.click(new elementslib.Elem(mc.menus.helpMenu.whatsNew));</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+  controller.sleep(0);</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+  if (mc.tabmail.tabContainer.childNodes.length != preCount)</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+    throw new Error(&quot;A new content tab was opened when it shouldn't have been&quot;);</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+  // Double-check browser is still the same.</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+  if (mc.window.content.location != whatsUrl)</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+    throw new Error(&quot;window.content is not set to the url loaded, incorrect type=\&quot;...\&quot;?&quot;);</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+}</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+// XXX todo</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+// - Open second tab</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+// - test find bar</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+// - window.close within tab</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+// - zoom?</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/test/mozmill/mozmilltests.list</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/test/mozmill/mozmilltests.list</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,4 +1,5 @@</span>
<a href="#l7.4"></a><span id="l7.4"> folder-display</span>
<a href="#l7.5"></a><span id="l7.5"> junk-commands</span>
<a href="#l7.6"></a><span id="l7.6"> search-window</span>
<a href="#l7.7"></a><span id="l7.7"> content-policy</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+content-tabs</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/content/messengerdnd.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/content/messengerdnd.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -62,16 +62,17 @@ function CanDropOnFolderTree(index, orie</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5">     var trans = Components.classes[&quot;@mozilla.org/widget/transferable;1&quot;].createInstance(Components.interfaces.nsITransferable);</span>
<a href="#l8.6"></a><span id="l8.6">     if (! trans)</span>
<a href="#l8.7"></a><span id="l8.7">         return false;</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9">     trans.addDataFlavor(&quot;text/x-moz-message&quot;);</span>
<a href="#l8.10"></a><span id="l8.10">     trans.addDataFlavor(&quot;text/x-moz-folder&quot;);</span>
<a href="#l8.11"></a><span id="l8.11">     trans.addDataFlavor(&quot;text/x-moz-newsfolder&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+    trans.addDataFlavor(&quot;application/x-moz-file&quot;);</span>
<a href="#l8.13"></a><span id="l8.13">     trans.addDataFlavor(&quot;text/x-moz-url&quot;);</span>
<a href="#l8.14"></a><span id="l8.14">  </span>
<a href="#l8.15"></a><span id="l8.15">     var folderTree = GetFolderTree();</span>
<a href="#l8.16"></a><span id="l8.16">     var targetFolder = GetFolderResource(folderTree, index).QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l8.17"></a><span id="l8.17">     var targetUri = targetFolder.URI;</span>
<a href="#l8.18"></a><span id="l8.18">     var targetServer = targetFolder.server;</span>
<a href="#l8.19"></a><span id="l8.19">     var sourceServer, sourceFolder;</span>
<a href="#l8.20"></a><span id="l8.20">    </span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -84,16 +85,27 @@ function CanDropOnFolderTree(index, orie</span>
<a href="#l8.22"></a><span id="l8.22">         try</span>
<a href="#l8.23"></a><span id="l8.23">         {</span>
<a href="#l8.24"></a><span id="l8.24">             trans.getAnyTransferData (dataFlavor, dataObj, len );</span>
<a href="#l8.25"></a><span id="l8.25">         }</span>
<a href="#l8.26"></a><span id="l8.26">         catch (ex)</span>
<a href="#l8.27"></a><span id="l8.27">         {</span>
<a href="#l8.28"></a><span id="l8.28">             continue;   //no data so continue;</span>
<a href="#l8.29"></a><span id="l8.29">         }</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+        if (dataFlavor.value == &quot;application/x-moz-file&quot; &amp;&amp; dataObj)</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+        {</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+          if (orientation != Components.interfaces.nsITreeView.DROP_ON ||</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+              targetFolder.isServer ||</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+              !targetFolder.canFileMessages)</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+            return false;</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+          if (dataObj.value instanceof Components.interfaces.nsIFile)</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+            return dataObj.value.isFile();</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+          return false;</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+        }</span>
<a href="#l8.41"></a><span id="l8.41">         if (dataObj)</span>
<a href="#l8.42"></a><span id="l8.42">             dataObj = dataObj.value.QueryInterface(Components.interfaces.nsISupportsString);</span>
<a href="#l8.43"></a><span id="l8.43">         if (! dataObj)</span>
<a href="#l8.44"></a><span id="l8.44">             continue;</span>
<a href="#l8.45"></a><span id="l8.45"> </span>
<a href="#l8.46"></a><span id="l8.46">         // pull the URL out of the data object</span>
<a href="#l8.47"></a><span id="l8.47">         var sourceUri = dataObj.data.substring(0, len.value);</span>
<a href="#l8.48"></a><span id="l8.48">         if (! sourceUri)</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineat">@@ -243,32 +255,51 @@ function DropOnFolderTree(row, orientati</span>
<a href="#l8.50"></a><span id="l8.50">     var dragSession = dragService.getCurrentSession();</span>
<a href="#l8.51"></a><span id="l8.51">     if (! dragSession )</span>
<a href="#l8.52"></a><span id="l8.52">         return false;</span>
<a href="#l8.53"></a><span id="l8.53"> </span>
<a href="#l8.54"></a><span id="l8.54">     var trans = Components.classes[&quot;@mozilla.org/widget/transferable;1&quot;].createInstance(Components.interfaces.nsITransferable);</span>
<a href="#l8.55"></a><span id="l8.55">     trans.addDataFlavor(&quot;text/x-moz-message&quot;);</span>
<a href="#l8.56"></a><span id="l8.56">     trans.addDataFlavor(&quot;text/x-moz-folder&quot;);</span>
<a href="#l8.57"></a><span id="l8.57">     trans.addDataFlavor(&quot;text/x-moz-newsfolder&quot;);</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+    trans.addDataFlavor(&quot;application/x-moz-file&quot;);</span>
<a href="#l8.59"></a><span id="l8.59">     trans.addDataFlavor(&quot;text/x-moz-url&quot;);</span>
<a href="#l8.60"></a><span id="l8.60"> </span>
<a href="#l8.61"></a><span id="l8.61">     var list = Components.classes[&quot;@mozilla.org/array;1&quot;].createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+    var cs = Components.classes[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+                       .getService(Components.interfaces.nsIMsgCopyService);</span>
<a href="#l8.64"></a><span id="l8.64"> </span>
<a href="#l8.65"></a><span id="l8.65">     var dropMessage;</span>
<a href="#l8.66"></a><span id="l8.66">     var sourceUri;</span>
<a href="#l8.67"></a><span id="l8.67">     var sourceFolder;</span>
<a href="#l8.68"></a><span id="l8.68">     var sourceServer;</span>
<a href="#l8.69"></a><span id="l8.69"> 	</span>
<a href="#l8.70"></a><span id="l8.70">     for (var i = 0; i &lt; dragSession.numDropItems; i++)</span>
<a href="#l8.71"></a><span id="l8.71">     {</span>
<a href="#l8.72"></a><span id="l8.72">         dragSession.getData (trans, i);</span>
<a href="#l8.73"></a><span id="l8.73">         var dataObj = new Object();</span>
<a href="#l8.74"></a><span id="l8.74">         var flavor = new Object();</span>
<a href="#l8.75"></a><span id="l8.75">         var len = new Object();</span>
<a href="#l8.76"></a><span id="l8.76">         trans.getAnyTransferData(flavor, dataObj, len);</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+        </span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+        // shortcircuit external files and get out</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+        if (flavor.value == &quot;application/x-moz-file&quot; &amp;&amp; dataObj)</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+        {</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+          dataObj = dataObj.value.QueryInterface(Components.interfaces.nsIFile);</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+          if (!dataObj)</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+            return false; // don't know how this would ever happen</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+          if (dataObj.isFile())</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+          {</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+            let len = dataObj.leafName.length;</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+            if (len &gt; 4 &amp;&amp; dataObj.leafName.substr(len - 4).toLowerCase() == &quot;.eml&quot;)</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+              cs.CopyFileMessage(dataObj, targetFolder, null, false, 1, &quot;&quot;, null, msgWindow);</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+          }</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+          continue;</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+        }</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+        </span>
<a href="#l8.93"></a><span id="l8.93">         if (dataObj)</span>
<a href="#l8.94"></a><span id="l8.94">             dataObj = dataObj.value.QueryInterface(Components.interfaces.nsISupportsString);</span>
<a href="#l8.95"></a><span id="l8.95">         if (! dataObj)</span>
<a href="#l8.96"></a><span id="l8.96">             continue;</span>
<a href="#l8.97"></a><span id="l8.97"> </span>
<a href="#l8.98"></a><span id="l8.98">         // pull the URL out of the data object</span>
<a href="#l8.99"></a><span id="l8.99">         sourceUri = dataObj.data.substring(0, len.value);</span>
<a href="#l8.100"></a><span id="l8.100">         if (! sourceUri)</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineat">@@ -344,18 +375,16 @@ function DropOnFolderTree(row, orientati</span>
<a href="#l8.102"></a><span id="l8.102">     }</span>
<a href="#l8.103"></a><span id="l8.103"> </span>
<a href="#l8.104"></a><span id="l8.104">     if (list.length &lt; 1)</span>
<a href="#l8.105"></a><span id="l8.105">        return false;</span>
<a href="#l8.106"></a><span id="l8.106"> </span>
<a href="#l8.107"></a><span id="l8.107">     var isSourceNews = false;</span>
<a href="#l8.108"></a><span id="l8.108">     isSourceNews = isNewsURI(sourceUri);</span>
<a href="#l8.109"></a><span id="l8.109"> </span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-    var cs = Components.classes[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-                       .getService(Components.interfaces.nsIMsgCopyService);</span>
<a href="#l8.112"></a><span id="l8.112">     if (dropMessage) {</span>
<a href="#l8.113"></a><span id="l8.113">         var sourceMsgHdr = list.queryElementAt(0, Components.interfaces.nsIMsgDBHdr);</span>
<a href="#l8.114"></a><span id="l8.114">         sourceFolder = sourceMsgHdr.folder;</span>
<a href="#l8.115"></a><span id="l8.115">         sourceServer = sourceFolder.server;</span>
<a href="#l8.116"></a><span id="l8.116"> </span>
<a href="#l8.117"></a><span id="l8.117"> </span>
<a href="#l8.118"></a><span id="l8.118">         try {</span>
<a href="#l8.119"></a><span id="l8.119">             if (isSourceNews) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/suite/browser/public/nsIBookmarksService.idl</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/suite/browser/public/nsIBookmarksService.idl</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -38,20 +38,22 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> /**</span>
<a href="#l9.7"></a><span id="l9.7">  * The Browser Bookmarks service</span>
<a href="#l9.8"></a><span id="l9.8">  */</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+interface nsIRDFNode;</span>
<a href="#l9.13"></a><span id="l9.13"> interface nsIRDFResource;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+interface nsITransaction;</span>
<a href="#l9.15"></a><span id="l9.15"> interface nsITransactionManager;</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-[scriptable, uuid(4342a6ac-1b43-4121-b606-4bdf62de71ff)]</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+[scriptable, uuid(b3b8d09d-71b1-4654-b807-9288c2f16300)]</span>
<a href="#l9.19"></a><span id="l9.19"> interface nsIBookmarksService : nsISupports</span>
<a href="#l9.20"></a><span id="l9.20"> {</span>
<a href="#l9.21"></a><span id="l9.21">     const unsigned long BOOKMARK_DEFAULT_TYPE   = 0;</span>
<a href="#l9.22"></a><span id="l9.22">     const unsigned long BOOKMARK_SEARCH_TYPE    = 1;</span>
<a href="#l9.23"></a><span id="l9.23">     const unsigned long BOOKMARK_FIND_TYPE      = 2;</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25">     const long SORT_DESCENDING = -1;</span>
<a href="#l9.26"></a><span id="l9.26">     const long SORT_ASCENDING = 1;</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineat">@@ -100,16 +102,21 @@ interface nsIBookmarksService : nsISuppo</span>
<a href="#l9.28"></a><span id="l9.28">     </span>
<a href="#l9.29"></a><span id="l9.29">     AString getLastCharset(in AUTF8String aURL); </span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31">     string resolveKeyword(in wstring aName);</span>
<a href="#l9.32"></a><span id="l9.32">     </span>
<a href="#l9.33"></a><span id="l9.33">     void importSystemBookmarks(in nsIRDFResource aParentFolder);</span>
<a href="#l9.34"></a><span id="l9.34"> </span>
<a href="#l9.35"></a><span id="l9.35">     readonly attribute nsITransactionManager transactionManager;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+    nsITransaction createTransaction(in nsIRDFResource parent,</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+                                     in nsIRDFNode item,</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+                                     in unsigned long index,</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+                                     in boolean remove);</span>
<a href="#l9.41"></a><span id="l9.41"> };</span>
<a href="#l9.42"></a><span id="l9.42"> </span>
<a href="#l9.43"></a><span id="l9.43"> %{C++</span>
<a href="#l9.44"></a><span id="l9.44"> </span>
<a href="#l9.45"></a><span id="l9.45"> // {E638D760-8687-11d2-B530-000000000000}</span>
<a href="#l9.46"></a><span id="l9.46"> #define NS_BOOKMARKS_SERVICE_CID \</span>
<a href="#l9.47"></a><span id="l9.47"> { 0xe638d760, 0x8687, 0x11d2, { 0xb5, 0x30, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0 } }</span>
<a href="#l9.48"></a><span id="l9.48"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/suite/browser/src/nsBookmarksService.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/suite/browser/src/nsBookmarksService.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1617,16 +1617,117 @@ ElementArray::Clear()</span>
<a href="#l10.4"></a><span id="l10.4">     while (--index &gt;= 0)</span>
<a href="#l10.5"></a><span id="l10.5">     {</span>
<a href="#l10.6"></a><span id="l10.6">         ElementInfo* elementInfo = ElementAt(index);</span>
<a href="#l10.7"></a><span id="l10.7">         delete elementInfo;</span>
<a href="#l10.8"></a><span id="l10.8">     }</span>
<a href="#l10.9"></a><span id="l10.9">     nsAutoVoidArray::Clear();</span>
<a href="#l10.10"></a><span id="l10.10"> }</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+/**</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+ * The bookmark transaction knows how to assert and unassert arcs</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+ */</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+class BookmarkTransaction: public nsITransaction,</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+                           public nsIInterfaceRequestor</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+{</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+  NS_DECL_NSITRANSACTION</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+  NS_DECL_NSIINTERFACEREQUESTOR</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+private:</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+  nsBookmarksService* mBookmarksService;</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+  nsCOMPtr&lt;nsIRDFResource&gt; mParent;</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+  nsCOMPtr&lt;nsIRDFNode&gt; mItem;</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+  PRUint32 mIndex;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+  PRBool mRemove;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+  nsresult performTransaction(PRBool aRemove, PRBool aRenumber);</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+public:</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+  BookmarkTransaction(nsBookmarksService* aBookmarksService,</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+                      nsIRDFResource* aParent, nsIRDFNode* aItem,</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+                      PRUint32 aIndex, PRBool aRemove)</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+    : mBookmarksService(aBookmarksService),</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+      mParent(aParent),</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+      mItem(aItem),</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+      mIndex(aIndex),</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+      mRemove(aRemove) {}</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+};</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+NS_IMPL_ISUPPORTS2(BookmarkTransaction, nsITransaction, nsIInterfaceRequestor)</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+nsresult</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+BookmarkTransaction::performTransaction(PRBool aRemove, PRBool aRenumber)</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+{</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+  nsresult rv;</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+  nsCOMPtr&lt;nsIRDFContainer&gt; container(do_CreateInstance(&quot;@mozilla.org/rdf/container;1&quot;, &amp;rv));</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+    return rv;</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+  rv = container-&gt;Init(mBookmarksService, mParent);</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+    return rv;</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+  if (!aRemove)</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+    return container-&gt;InsertElementAt(mItem, mIndex, aRenumber);</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+  // We don't renumber the container when deleting bookmarks.</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+  // This makes it easy to undo the transaction by restoring the same index.</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+  return container-&gt;RemoveElement(mItem, PR_FALSE);</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+}</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+BookmarkTransaction::DoTransaction()</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+{</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+  return performTransaction(mRemove, PR_TRUE);</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+}</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+BookmarkTransaction::UndoTransaction()</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+{</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+  // We don't renumber the container when undoing transactions.</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+  // This makes it easy to redo the transaction by restoring the same index.</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+  return performTransaction(!mRemove, PR_FALSE);</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+}</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+BookmarkTransaction::RedoTransaction()</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+{</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+  // We don't renumber the container when redoing transactions.</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+  // This makes it easy to undo the transaction by restoring the same index.</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+  return performTransaction(mRemove, PR_FALSE);</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+}</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+BookmarkTransaction::GetIsTransient(PRBool *aIsTransient)</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+{</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aIsTransient);</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+  *aIsTransient = PR_FALSE;</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+}</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+BookmarkTransaction::Merge(nsITransaction* aTransaction, PRBool* aResult)</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+{</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+  *aResult = PR_FALSE;</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+}</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+BookmarkTransaction::GetInterface(REFNSIID aIID, void** aResult)</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+{</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+  nsISupports *result = nsnull;</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+  if (aIID.Equals(NS_GET_IID(nsIRDFNode))) {</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+    NS_ADDREF(result = mItem);</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+    *aResult = result;</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+    return NS_OK;</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+  }</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+  return NS_NOINTERFACE;</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+}</span>
<a href="#l10.113"></a><span id="l10.113"> </span>
<a href="#l10.114"></a><span id="l10.114"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.115"></a><span id="l10.115"> // nsBookmarksService implementation</span>
<a href="#l10.116"></a><span id="l10.116"> </span>
<a href="#l10.117"></a><span id="l10.117"> nsBookmarksService::nsBookmarksService() :</span>
<a href="#l10.118"></a><span id="l10.118">     mUpdateBatchNest(0),</span>
<a href="#l10.119"></a><span id="l10.119">     mDirty(PR_FALSE)</span>
<a href="#l10.120"></a><span id="l10.120"> </span>
<a href="#l10.121"></a><span id="l10.121" class="difflineat">@@ -3974,16 +4075,33 @@ nsBookmarksService::GetTransactionManage</span>
<a href="#l10.122"></a><span id="l10.122"> {</span>
<a href="#l10.123"></a><span id="l10.123">     NS_ENSURE_ARG_POINTER(aTransactionManager);</span>
<a href="#l10.124"></a><span id="l10.124"> </span>
<a href="#l10.125"></a><span id="l10.125">     NS_ADDREF(*aTransactionManager = mTransactionManager);</span>
<a href="#l10.126"></a><span id="l10.126"> </span>
<a href="#l10.127"></a><span id="l10.127">     return NS_OK;</span>
<a href="#l10.128"></a><span id="l10.128"> }</span>
<a href="#l10.129"></a><span id="l10.129"> </span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+nsBookmarksService::CreateTransaction(nsIRDFResource* aParent,</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+                                      nsIRDFNode* aItem,</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+                                      PRUint32 aIndex,</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+                                      PRBool aRemove,</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+                                      nsITransaction** aTransaction)</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+{</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aTransaction);</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+  NS_ENSURE_ARG(aItem);</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+  *aTransaction = new BookmarkTransaction(this, aParent, aItem, aIndex, aRemove);</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+  if (!*aTransaction)</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+  NS_ADDREF(*aTransaction);</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+}</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+</span>
<a href="#l10.147"></a><span id="l10.147"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.148"></a><span id="l10.148"> // nsIRDFDataSource</span>
<a href="#l10.149"></a><span id="l10.149"> </span>
<a href="#l10.150"></a><span id="l10.150"> NS_IMETHODIMP</span>
<a href="#l10.151"></a><span id="l10.151"> nsBookmarksService::GetURI(char* *aURI)</span>
<a href="#l10.152"></a><span id="l10.152"> {</span>
<a href="#l10.153"></a><span id="l10.153">     *aURI = NS_strdup(&quot;rdf:bookmarks&quot;);</span>
<a href="#l10.154"></a><span id="l10.154">     if (! *aURI)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/suite/common/bookmarks/bookmarks.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/suite/common/bookmarks/bookmarks.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -121,18 +121,16 @@ function initServices()</span>
<a href="#l11.4"></a><span id="l11.4">   } catch (e) {}</span>
<a href="#l11.5"></a><span id="l11.5"> }</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7"> function initBMService()</span>
<a href="#l11.8"></a><span id="l11.8"> {</span>
<a href="#l11.9"></a><span id="l11.9">   kBMSVCIID = Components.interfaces.nsIBookmarksService;</span>
<a href="#l11.10"></a><span id="l11.10">   BMDS  = RDF.GetDataSource(&quot;rdf:bookmarks&quot;);</span>
<a href="#l11.11"></a><span id="l11.11">   BMSVC = BMDS.QueryInterface(kBMSVCIID);</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  BookmarkTransaction.prototype.RDFC = RDFC;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-  BookmarkTransaction.prototype.BMDS = BMDS;</span>
<a href="#l11.14"></a><span id="l11.14"> }</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16"> /**</span>
<a href="#l11.17"></a><span id="l11.17">  * XXX - 04/16/01</span>
<a href="#l11.18"></a><span id="l11.18">  *  ACK! massive command name collision problems are causing big issues</span>
<a href="#l11.19"></a><span id="l11.19">  *  in getting this stuff to work in the Navigator window. For sanity's </span>
<a href="#l11.20"></a><span id="l11.20">  *  sake, we need to rename all the commands to be of the form cmd_bm_*</span>
<a href="#l11.21"></a><span id="l11.21">  *  otherwise there'll continue to be problems. For now, we're just </span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -670,37 +668,35 @@ var BookmarksCommand = {</span>
<a href="#l11.23"></a><span id="l11.23">         fileName = kFilePicker.file.path;</span>
<a href="#l11.24"></a><span id="l11.24">         if (!fileName) return;</span>
<a href="#l11.25"></a><span id="l11.25">       }</span>
<a href="#l11.26"></a><span id="l11.26">       else return;</span>
<a href="#l11.27"></a><span id="l11.27">     }</span>
<a href="#l11.28"></a><span id="l11.28">     catch (e) {</span>
<a href="#l11.29"></a><span id="l11.29">       return;</span>
<a href="#l11.30"></a><span id="l11.30">     }</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-    rTarget = RDF.GetResource(&quot;NC:BookmarksRoot&quot;);</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+    var rTarget = BookmarksUtils.getNewBookmarkFolder();</span>
<a href="#l11.33"></a><span id="l11.33">     RDFC.Init(BMDS, rTarget);</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-    var countBefore = parseInt(BookmarksUtils.getProperty(rTarget, RDF_NS+&quot;nextVal&quot;));</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+    var index = RDFC.GetCount();</span>
<a href="#l11.36"></a><span id="l11.36">     var args = [{ property: NC_NS+&quot;URL&quot;, literal: fileName}];</span>
<a href="#l11.37"></a><span id="l11.37">     this.doBookmarksCommand(rTarget, NC_NS_CMD+&quot;import&quot;, args);</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-    var countAfter = parseInt(BookmarksUtils.getProperty(rTarget, RDF_NS+&quot;nextVal&quot;));</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+    RDFC.Init(BMDS, rTarget); // changing the selection clobbers RDFC</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+    var count = RDFC.GetCount();</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+    if (index == count)</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+      return;</span>
<a href="#l11.43"></a><span id="l11.43"> </span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-    var transaction = new BookmarkImportTransaction(&quot;import&quot;);</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-    for (var index = countBefore; index &lt; countAfter; index++) {</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-      var nChildArc = RDFCU.IndexToOrdinalResource(index);</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-      var rChild    = BMDS.GetTarget(rTarget, nChildArc, true);</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-      transaction.item   .push(rChild);</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-      transaction.parent .push(rTarget);</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-      transaction.index  .push(index);</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-      transaction.isValid.push(true);</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+    var txmgr = BMSVC.transactionManager;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+    txmgr.beginBatch();</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+    while (++index &lt;= count) {</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+      var rChild = RDFC.RemoveElementAt(index, true);</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+      var txn = BMSVC.createTransaction(rTarget, rChild, index, false);</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+      txmgr.doTransaction(txn);</span>
<a href="#l11.58"></a><span id="l11.58">     }</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-    var isCancelled = !BookmarksUtils.any(transaction.isValid);</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-    if (!isCancelled) {</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-      BMSVC.transactionManager.doTransaction(transaction);</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-      BookmarksUtils.flushDataSource();</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-    }    </span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+    txmgr.endBatch();</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+    BookmarksUtils.flushDataSource();</span>
<a href="#l11.66"></a><span id="l11.66">   },</span>
<a href="#l11.67"></a><span id="l11.67"> </span>
<a href="#l11.68"></a><span id="l11.68">   exportBookmarks: function ()</span>
<a href="#l11.69"></a><span id="l11.69">   {</span>
<a href="#l11.70"></a><span id="l11.70">     try {</span>
<a href="#l11.71"></a><span id="l11.71">       const kFilePickerContractID = &quot;@mozilla.org/filepicker;1&quot;;</span>
<a href="#l11.72"></a><span id="l11.72">       const kFilePickerIID = Components.interfaces.nsIFilePicker;</span>
<a href="#l11.73"></a><span id="l11.73">       const kFilePicker = Components.classes[kFilePickerContractID].createInstance(kFilePickerIID);</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineat">@@ -1313,39 +1309,38 @@ var BookmarksUtils = {</span>
<a href="#l11.75"></a><span id="l11.75">         return true;</span>
<a href="#l11.76"></a><span id="l11.76">     }</span>
<a href="#l11.77"></a><span id="l11.77">     return false;</span>
<a href="#l11.78"></a><span id="l11.78">   },</span>
<a href="#l11.79"></a><span id="l11.79"> </span>
<a href="#l11.80"></a><span id="l11.80">   /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.81"></a><span id="l11.81">   removeSelection: function (aAction, aSelection)</span>
<a href="#l11.82"></a><span id="l11.82">   {</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-    var transaction     = new BookmarkRemoveTransaction(aAction);</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-    transaction.item    = new Array(aSelection.length);</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-    transaction.parent  = new Array(aSelection.length);</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-    transaction.index   = new Array(aSelection.length);</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-    transaction.isValid = BookmarksUtils.isSelectionValidForDeletion(aSelection);</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+    var isValid = BookmarksUtils.isSelectionValidForDeletion(aSelection);</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+    if (SOUND &amp;&amp; !BookmarksUtils.all(isValid))</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+      SOUND.beep();</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+    if (!BookmarksUtils.any(isValid))</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+      return false;</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+    var txmgr = BMSVC.transactionManager;</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+    txmgr.beginBatch();</span>
<a href="#l11.96"></a><span id="l11.96">     for (var i = 0; i &lt; aSelection.length; ++i) {</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-      transaction.item  [i] = aSelection.item  [i];</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-      transaction.parent[i] = aSelection.parent[i];</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-      if (transaction.isValid[i]) {</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+      if (isValid[i]) {</span>
<a href="#l11.101"></a><span id="l11.101">         RDFC.Init(BMDS, aSelection.parent[i]);</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-        transaction.index[i]  = RDFC.IndexOf(aSelection.item[i]);</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+        var index = RDFC.IndexOf(aSelection.item[i]);</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+        var txn = BMSVC.createTransaction(aSelection.parent[i], aSelection.item[i], index, true);</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+        txmgr.doTransaction(txn);</span>
<a href="#l11.106"></a><span id="l11.106">       }</span>
<a href="#l11.107"></a><span id="l11.107">     }</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-    if (SOUND &amp;&amp; aAction != &quot;move&quot; &amp;&amp; !BookmarksUtils.all(transaction.isValid))</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-      SOUND.beep();</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-    var isCancelled = !BookmarksUtils.any(transaction.isValid);</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-    if (!isCancelled) {</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-      BMSVC.transactionManager.doTransaction(transaction);</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-      if (aAction != &quot;move&quot;)</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-        BookmarksUtils.notifyBookmarksChanged();</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-        BookmarksUtils.flushDataSource();</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+    txmgr.endBatch();</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+    if (aAction != &quot;move&quot;) {</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+      BookmarksUtils.notifyBookmarksChanged();</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+      BookmarksUtils.flushDataSource();</span>
<a href="#l11.120"></a><span id="l11.120">     }</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-    return !isCancelled;</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+    return true;</span>
<a href="#l11.123"></a><span id="l11.123">   },</span>
<a href="#l11.124"></a><span id="l11.124">       // If the current bookmark is the IE Favorites folder, we have a little</span>
<a href="#l11.125"></a><span id="l11.125">       // extra work to do - set the pref |browser.bookmarks.import_system_favorites|</span>
<a href="#l11.126"></a><span id="l11.126">       // to ensure that we don't re-import next time. </span>
<a href="#l11.127"></a><span id="l11.127">       //if (aSelection[count].getAttribute(&quot;type&quot;) == (NC_NS + &quot;IEFavoriteFolder&quot;)) {</span>
<a href="#l11.128"></a><span id="l11.128">       //  const kPrefSvcContractID = &quot;@mozilla.org/preferences-service;1&quot;;</span>
<a href="#l11.129"></a><span id="l11.129">       //  const kPrefSvcIID = Components.interfaces.nsIPrefBranch;</span>
<a href="#l11.130"></a><span id="l11.130">       //  const kPrefSvc = Components.classes[kPrefSvcContractID].getService(kPrefSvcIID);</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineat">@@ -1356,60 +1351,61 @@ var BookmarksUtils = {</span>
<a href="#l11.132"></a><span id="l11.132">   {</span>
<a href="#l11.133"></a><span id="l11.133">     Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l11.134"></a><span id="l11.134">               .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l11.135"></a><span id="l11.135">               .notifyObservers(null, &quot;bookmarks-changed&quot;, &quot;&quot;);</span>
<a href="#l11.136"></a><span id="l11.136">   },</span>
<a href="#l11.137"></a><span id="l11.137"> </span>
<a href="#l11.138"></a><span id="l11.138">   insertSelection: function (aAction, aSelection, aTarget)</span>
<a href="#l11.139"></a><span id="l11.139">   {</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineminus">-    var transaction     = new BookmarkInsertTransaction(aAction);</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineminus">-    transaction.item    = new Array(aSelection.length);</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineminus">-    transaction.parent  = new Array(aSelection.length);</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineminus">-    transaction.index   = new Array(aSelection.length);</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineminus">-    if (aAction != &quot;move&quot;)</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineminus">-      transaction.isValid = BookmarksUtils.isSelectionValidForInsertion(aSelection, aTarget, aAction);</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineminus">-    else // isValid has already been determined in moveSelection</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineminus">-      transaction.isValid = aSelection.isValid;</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+    var isValid = BookmarksUtils.isSelectionValidForInsertion(aSelection, aTarget, aAction);</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+    if (SOUND &amp;&amp; !BookmarksUtils.all(isValid))</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+      SOUND.beep();</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+    if (!BookmarksUtils.any(isValid))</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+      return false;</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+    var txmgr = BMSVC.transactionManager;</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+    txmgr.beginBatch();</span>
<a href="#l11.156"></a><span id="l11.156">     var index = aTarget.index;</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-    for (var i=0; i&lt;aSelection.length; ++i) {</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-      var rSource = aSelection.item[i];</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineminus">-      </span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-      if (transaction.isValid[i]) {</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-        if (BMSVC.isBookmarkedResource(rSource))</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineminus">-          rSource = BMSVC.cloneResource(rSource);</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineminus">-        transaction.item  [i] = rSource;</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-        transaction.parent[i] = aTarget.parent;</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-        transaction.index [i] = index++;</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineminus">-      } else {</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineminus">-        transaction.item  [i] = rSource;</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineminus">-        transaction.parent[i] = aSelection.parent[i];</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-      } </span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+    for (var i = 0; i &lt; aSelection.length; ++i) {</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+      if (isValid[i]) {</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+        var txn = BMSVC.createTransaction(aTarget.parent, aSelection.item[i], index++, false);</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineplus">+        txmgr.doTransaction(txn);</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+      }</span>
<a href="#l11.175"></a><span id="l11.175">     }</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineminus">-    if (SOUND &amp;&amp; !BookmarksUtils.all(transaction.isValid))</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineminus">-      SOUND.beep();</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineminus">-    var isCancelled = !BookmarksUtils.any(transaction.isValid);</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-    if (!isCancelled) {</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineminus">-      BMSVC.transactionManager.doTransaction(transaction);</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineminus">-      BookmarksUtils.notifyBookmarksChanged();</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineminus">-      BookmarksUtils.flushDataSource();</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineminus">-    }</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">-    return !isCancelled;</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+    txmgr.endBatch();</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+    BookmarksUtils.notifyBookmarksChanged();</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+    BookmarksUtils.flushDataSource();</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+    return true;</span>
<a href="#l11.189"></a><span id="l11.189">   },</span>
<a href="#l11.190"></a><span id="l11.190"> </span>
<a href="#l11.191"></a><span id="l11.191">   moveSelection: function (aAction, aSelection, aTarget)</span>
<a href="#l11.192"></a><span id="l11.192">   {</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">-    aSelection.isValid = BookmarksUtils.isSelectionValidForInsertion(aSelection, aTarget, &quot;move&quot;);</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineminus">-    var transaction = new BookmarkMoveTransaction(aAction, aSelection, aTarget);</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineminus">-    var isCancelled = !BookmarksUtils.any(transaction.isValid);</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineminus">-    if (!isCancelled) {</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineminus">-      BMSVC.transactionManager.doTransaction(transaction);</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineminus">-    } else if (SOUND)</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+    var isValid = BookmarksUtils.isSelectionValidForInsertion(aSelection, aTarget, aAction);</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineplus">+    if (SOUND &amp;&amp; !BookmarksUtils.all(isValid))</span>
<a href="#l11.201"></a><span id="l11.201">       SOUND.beep();</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-    return !isCancelled;</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+    if (!BookmarksUtils.any(isValid))</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+      return false;</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+    var txmgr = BMSVC.transactionManager;</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+    txmgr.beginBatch();</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+    var index = aTarget.index;</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+    for (var i = 0; i &lt; aSelection.length; ++i) {</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+      if (isValid[i]) {</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+        RDFC.Init(BMDS, aSelection.parent[i]);</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+        var deleteIndex = RDFC.IndexOf(aSelection.item[i]);</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+        var deleteTxn = BMSVC.createTransaction(aSelection.parent[i], aSelection.item[i], deleteIndex, true);</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+        txmgr.doTransaction(deleteTxn);</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+        var insertTxn = BMSVC.createTransaction(aTarget.parent, aSelection.item[i], index++, false);</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+        txmgr.doTransaction(insertTxn);</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineplus">+      }</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+    }</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+    txmgr.endBatch();</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineplus">+    BookmarksUtils.flushDataSource();</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineplus">+    return true;</span>
<a href="#l11.222"></a><span id="l11.222">   }, </span>
<a href="#l11.223"></a><span id="l11.223"> </span>
<a href="#l11.224"></a><span id="l11.224">   getXferDataFromSelection: function (aSelection)</span>
<a href="#l11.225"></a><span id="l11.225">   {</span>
<a href="#l11.226"></a><span id="l11.226">     if (aSelection.length == 0)</span>
<a href="#l11.227"></a><span id="l11.227">       return null;</span>
<a href="#l11.228"></a><span id="l11.228">     var dataSet = new TransferDataSet();</span>
<a href="#l11.229"></a><span id="l11.229">     var data, item, itemUrl, itemName, parent, name;</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineat">@@ -1646,204 +1642,8 @@ var BookmarksUtils = {</span>
<a href="#l11.231"></a><span id="l11.231">     if (!target)</span>
<a href="#l11.232"></a><span id="l11.232">       return;</span>
<a href="#l11.233"></a><span id="l11.233"> </span>
<a href="#l11.234"></a><span id="l11.234">     var rSource   = RDF.GetResource(aEvent.target.id);</span>
<a href="#l11.235"></a><span id="l11.235">     var selection = BookmarksUtils.getSelectionFromResource(rSource);</span>
<a href="#l11.236"></a><span id="l11.236">     BookmarksCommand.openBookmark(selection, target, aDS, aEvent)</span>
<a href="#l11.237"></a><span id="l11.237">   }</span>
<a href="#l11.238"></a><span id="l11.238"> }</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineminus">-</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineminus">-</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineminus">-function BookmarkTransaction()</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineminus">-{</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineminus">-}</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineminus">-</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineminus">-BookmarkTransaction.prototype = {</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineminus">-  BATCH_LIMIT : 8,</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineminus">-  RDFC        : null,</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineminus">-  BMDS        : null,</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineminus">-</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineminus">-  beginUpdateBatch: function()</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineminus">-  {</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineminus">-    if (this.item.length &gt; this.BATCH_LIMIT) {</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineminus">-      this.BMDS.beginUpdateBatch();</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineminus">-    }</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineminus">-  },</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineminus">-</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineminus">-  endUpdateBatch: function()</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineminus">-  {</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineminus">-    if (this.item.length &gt; this.BATCH_LIMIT) {</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineminus">-      this.BMDS.endUpdateBatch();</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineminus">-    }</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineminus">-  },</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineminus">-</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineminus">-  // nsITransaction method stubs</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineminus">-  doTransaction: function() {},</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineminus">-  undoTransaction: function() {},</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineminus">-  redoTransaction: function() { this.doTransaction(); },</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineminus">-  get isTransient() { return false; },</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineminus">-  merge: function(aTransaction) { return false; },</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineminus">-</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineminus">-  // debugging helper</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineminus">-  get wrappedJSObject() { return this; }</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineminus">-}</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineminus">-</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineminus">-function BookmarkInsertTransaction (aAction)</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineminus">-{</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineminus">-  this.type    = &quot;insert&quot;;</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineminus">-  this.action  = aAction;</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineminus">-  this.item    = null;</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineminus">-  this.parent  = null;</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineminus">-  this.index   = null;</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineminus">-  this.isValid = null;</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineminus">-}</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineminus">-</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineminus">-BookmarkInsertTransaction.prototype =</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineminus">-{</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineminus">-  __proto__: BookmarkTransaction.prototype,</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineminus">-</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineminus">-  doTransaction: function ()</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineminus">-  {</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineminus">-    this.beginUpdateBatch();</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineminus">-    for (var i=0; i&lt;this.item.length; ++i) {</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineminus">-      if (this.isValid[i]) {</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineminus">-        this.RDFC.Init(this.BMDS, this.parent[i]);</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineminus">-        this.RDFC.InsertElementAt(this.item[i], this.index[i], true);</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineminus">-      }</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineminus">-    }</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineminus">-    this.endUpdateBatch();</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineminus">-  },</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineminus">-</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineminus">-  undoTransaction: function ()</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineminus">-  {</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineminus">-    this.beginUpdateBatch();</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineminus">-    // XXXvarga Can't use |RDFC| here because it's being &quot;reused&quot; elsewhere.</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineminus">-    var container = Components.classes[kRDFCContractID].createInstance(kRDFCIID);</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineminus">-    for (var i=this.item.length-1; i&gt;=0; i--) {</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineminus">-      if (this.isValid[i]) {</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineminus">-        container.Init(this.BMDS, this.parent[i]);</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineminus">-        container.RemoveElementAt(this.index[i], true);</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineminus">-      }</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineminus">-    }</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineminus">-    this.endUpdateBatch();</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineminus">-  }</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineminus">-</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineminus">-}</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineminus">-</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineminus">-function BookmarkRemoveTransaction (aAction)</span>
<a href="#l11.318"></a><span id="l11.318" class="difflineminus">-{</span>
<a href="#l11.319"></a><span id="l11.319" class="difflineminus">-  this.type    = &quot;remove&quot;;</span>
<a href="#l11.320"></a><span id="l11.320" class="difflineminus">-  this.action  = aAction;</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineminus">-  this.item    = null;</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineminus">-  this.parent  = null;</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineminus">-  this.index   = null;</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineminus">-  this.isValid = null;</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineminus">-}</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineminus">-</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineminus">-BookmarkRemoveTransaction.prototype =</span>
<a href="#l11.328"></a><span id="l11.328" class="difflineminus">-{</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineminus">-  __proto__: BookmarkTransaction.prototype,</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineminus">-</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineminus">-  doTransaction: function ()</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineminus">-  {</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineminus">-    this.beginUpdateBatch();</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineminus">-    for (var i=0; i&lt;this.item.length; ++i) {</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineminus">-      if (this.isValid[i]) {</span>
<a href="#l11.336"></a><span id="l11.336" class="difflineminus">-        this.RDFC.Init(this.BMDS, this.parent[i]);</span>
<a href="#l11.337"></a><span id="l11.337" class="difflineminus">-        this.RDFC.RemoveElementAt(this.index[i], false);</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineminus">-      }</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineminus">-    }</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineminus">-    this.endUpdateBatch();</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineminus">-  },</span>
<a href="#l11.342"></a><span id="l11.342" class="difflineminus">-</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineminus">-  undoTransaction: function ()</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineminus">-  {</span>
<a href="#l11.345"></a><span id="l11.345" class="difflineminus">-    this.beginUpdateBatch();</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineminus">-    for (var i=this.item.length-1; i&gt;=0; i--) {</span>
<a href="#l11.347"></a><span id="l11.347" class="difflineminus">-      if (this.isValid[i]) {</span>
<a href="#l11.348"></a><span id="l11.348" class="difflineminus">-        this.RDFC.Init(this.BMDS, this.parent[i]);</span>
<a href="#l11.349"></a><span id="l11.349" class="difflineminus">-        this.RDFC.InsertElementAt(this.item[i], this.index[i], false);</span>
<a href="#l11.350"></a><span id="l11.350" class="difflineminus">-      }</span>
<a href="#l11.351"></a><span id="l11.351" class="difflineminus">-    }</span>
<a href="#l11.352"></a><span id="l11.352" class="difflineminus">-    this.endUpdateBatch();</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineminus">-  }</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineminus">-</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineminus">-}</span>
<a href="#l11.356"></a><span id="l11.356" class="difflineminus">-</span>
<a href="#l11.357"></a><span id="l11.357" class="difflineminus">-function BookmarkMoveTransaction (aAction, aSelection, aTarget)</span>
<a href="#l11.358"></a><span id="l11.358" class="difflineminus">-{</span>
<a href="#l11.359"></a><span id="l11.359" class="difflineminus">-  this.type      = &quot;move&quot;;</span>
<a href="#l11.360"></a><span id="l11.360" class="difflineminus">-  this.action    = aAction;</span>
<a href="#l11.361"></a><span id="l11.361" class="difflineminus">-  this.selection = aSelection;</span>
<a href="#l11.362"></a><span id="l11.362" class="difflineminus">-  this.target    = aTarget;</span>
<a href="#l11.363"></a><span id="l11.363" class="difflineminus">-  this.isValid   = aSelection.isValid;</span>
<a href="#l11.364"></a><span id="l11.364" class="difflineminus">-}</span>
<a href="#l11.365"></a><span id="l11.365" class="difflineminus">-</span>
<a href="#l11.366"></a><span id="l11.366" class="difflineminus">-BookmarkMoveTransaction.prototype =</span>
<a href="#l11.367"></a><span id="l11.367" class="difflineminus">-{</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineminus">-  __proto__: BookmarkTransaction.prototype,</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineminus">-</span>
<a href="#l11.370"></a><span id="l11.370" class="difflineminus">-  beginUpdateBatch: function()</span>
<a href="#l11.371"></a><span id="l11.371" class="difflineminus">-  {</span>
<a href="#l11.372"></a><span id="l11.372" class="difflineminus">-    if (this.selection.length &gt; this.BATCH_LIMIT) {</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineminus">-      this.BMDS.beginUpdateBatch();</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineminus">-    }</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineminus">-  },</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineminus">-</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineminus">-  endUpdateBatch: function()</span>
<a href="#l11.378"></a><span id="l11.378" class="difflineminus">-  {</span>
<a href="#l11.379"></a><span id="l11.379" class="difflineminus">-    if (this.selection.length &gt; this.BATCH_LIMIT) {</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineminus">-      this.BMDS.endUpdateBatch();</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineminus">-    }</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineminus">-  },</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineminus">-</span>
<a href="#l11.384"></a><span id="l11.384" class="difflineminus">-  doTransaction: function ()</span>
<a href="#l11.385"></a><span id="l11.385" class="difflineminus">-  {</span>
<a href="#l11.386"></a><span id="l11.386" class="difflineminus">-    this.beginUpdateBatch();</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineminus">-    BookmarksUtils.removeSelection(&quot;move&quot;, this.selection);</span>
<a href="#l11.388"></a><span id="l11.388" class="difflineminus">-    BookmarksUtils.insertSelection(&quot;move&quot;, this.selection, this.target);</span>
<a href="#l11.389"></a><span id="l11.389" class="difflineminus">-    this.endUpdateBatch();</span>
<a href="#l11.390"></a><span id="l11.390" class="difflineminus">-  },</span>
<a href="#l11.391"></a><span id="l11.391" class="difflineminus">-</span>
<a href="#l11.392"></a><span id="l11.392" class="difflineminus">-  redoTransaction     : function () {}</span>
<a href="#l11.393"></a><span id="l11.393" class="difflineminus">-</span>
<a href="#l11.394"></a><span id="l11.394" class="difflineminus">-}</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineminus">-</span>
<a href="#l11.396"></a><span id="l11.396" class="difflineminus">-function BookmarkImportTransaction (aAction)</span>
<a href="#l11.397"></a><span id="l11.397" class="difflineminus">-{</span>
<a href="#l11.398"></a><span id="l11.398" class="difflineminus">-  this.type    = &quot;import&quot;;</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineminus">-  this.action  = aAction;</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineminus">-  this.item    = [];</span>
<a href="#l11.401"></a><span id="l11.401" class="difflineminus">-  this.parent  = [];</span>
<a href="#l11.402"></a><span id="l11.402" class="difflineminus">-  this.index   = [];</span>
<a href="#l11.403"></a><span id="l11.403" class="difflineminus">-  this.isValid = [];</span>
<a href="#l11.404"></a><span id="l11.404" class="difflineminus">-}</span>
<a href="#l11.405"></a><span id="l11.405" class="difflineminus">-</span>
<a href="#l11.406"></a><span id="l11.406" class="difflineminus">-BookmarkImportTransaction.prototype =</span>
<a href="#l11.407"></a><span id="l11.407" class="difflineminus">-{</span>
<a href="#l11.408"></a><span id="l11.408" class="difflineminus">-  __proto__: BookmarkTransaction.prototype,</span>
<a href="#l11.409"></a><span id="l11.409" class="difflineminus">-</span>
<a href="#l11.410"></a><span id="l11.410" class="difflineminus">-  undoTransaction: function ()</span>
<a href="#l11.411"></a><span id="l11.411" class="difflineminus">-  {</span>
<a href="#l11.412"></a><span id="l11.412" class="difflineminus">-    this.beginUpdateBatch();</span>
<a href="#l11.413"></a><span id="l11.413" class="difflineminus">-    for (var i=this.item.length-1; i&gt;=0; i--) {</span>
<a href="#l11.414"></a><span id="l11.414" class="difflineminus">-      if (this.isValid[i]) {</span>
<a href="#l11.415"></a><span id="l11.415" class="difflineminus">-        this.RDFC.Init(this.BMDS, this.parent[i]);</span>
<a href="#l11.416"></a><span id="l11.416" class="difflineminus">-        this.RDFC.RemoveElementAt(this.index[i], true);</span>
<a href="#l11.417"></a><span id="l11.417" class="difflineminus">-      }</span>
<a href="#l11.418"></a><span id="l11.418" class="difflineminus">-    }</span>
<a href="#l11.419"></a><span id="l11.419" class="difflineminus">-    this.endUpdateBatch();</span>
<a href="#l11.420"></a><span id="l11.420" class="difflineminus">-  },</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineminus">-   </span>
<a href="#l11.422"></a><span id="l11.422" class="difflineminus">-  redoTransaction: function ()</span>
<a href="#l11.423"></a><span id="l11.423" class="difflineminus">-  {</span>
<a href="#l11.424"></a><span id="l11.424" class="difflineminus">-    this.beginUpdateBatch();</span>
<a href="#l11.425"></a><span id="l11.425" class="difflineminus">-    for (var i=0; i&lt;this.item.length; ++i) {</span>
<a href="#l11.426"></a><span id="l11.426" class="difflineminus">-      if (this.isValid[i]) {</span>
<a href="#l11.427"></a><span id="l11.427" class="difflineminus">-        this.RDFC.Init(this.BMDS, this.parent[i]);</span>
<a href="#l11.428"></a><span id="l11.428" class="difflineminus">-        this.RDFC.InsertElementAt(this.item[i], this.index[i], true);</span>
<a href="#l11.429"></a><span id="l11.429" class="difflineminus">-      }</span>
<a href="#l11.430"></a><span id="l11.430" class="difflineminus">-    }</span>
<a href="#l11.431"></a><span id="l11.431" class="difflineminus">-    this.endUpdateBatch();</span>
<a href="#l11.432"></a><span id="l11.432" class="difflineminus">-  }</span>
<a href="#l11.433"></a><span id="l11.433" class="difflineminus">-</span>
<a href="#l11.434"></a><span id="l11.434" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/suite/common/bookmarks/bookmarksTree.xml</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/suite/common/bookmarks/bookmarksTree.xml</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -359,38 +359,31 @@</span>
<a href="#l12.4"></a><span id="l12.4">             }</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6">             selection.selectEventsSuppressed = false;</span>
<a href="#l12.7"></a><span id="l12.7">           }</span>
<a href="#l12.8"></a><span id="l12.8">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.9"></a><span id="l12.9">       &lt;/method&gt;</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11">       &lt;field name=&quot;_itemToBeToggled&quot;&gt;  []&lt;/field&gt;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-      &lt;field name=&quot;_parentToBeToggled&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l12.13"></a><span id="l12.13">       &lt;method name=&quot;preUpdateTreeSelection&quot;&gt;</span>
<a href="#l12.14"></a><span id="l12.14">         &lt;parameter name=&quot;aTxn&quot;/&gt;</span>
<a href="#l12.15"></a><span id="l12.15">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-          aTxn = aTxn.wrappedJSObject;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-          var type = aTxn.type;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-          // Skip transactions that aggregates nested &quot;insert&quot; or &quot;remove&quot; transactions.</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-          if (type != &quot;insert&quot; &amp;&amp; type != &quot;remove&quot;)</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-            return;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-          for (var i=0; i&lt;aTxn.item.length; ++i) {</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-            this._itemToBeToggled  .push(aTxn.item  [i]);</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-            this._parentToBeToggled.push(aTxn.parent[i]);</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-          }</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+          // aTxn could be null, or possibly some third-party transaction?</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+          if (aTxn instanceof Components.interfaces.nsIInterfaceRequestor)</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+            this._itemToBeToggled.push(aTxn.getInterface(Components.interfaces.nsIRDFNode));</span>
<a href="#l12.28"></a><span id="l12.28">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.29"></a><span id="l12.29">       &lt;/method&gt;</span>
<a href="#l12.30"></a><span id="l12.30"> </span>
<a href="#l12.31"></a><span id="l12.31">       &lt;method name=&quot;updateTreeSelection&quot;&gt;</span>
<a href="#l12.32"></a><span id="l12.32">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.33"></a><span id="l12.33">           this.treeBoxObject.view.selection.selectEventsSuppressed = true;</span>
<a href="#l12.34"></a><span id="l12.34">           this.treeBoxObject.view.selection.clearSelection();</span>
<a href="#l12.35"></a><span id="l12.35">           for (var i=0; i&lt;this._itemToBeToggled.length; ++i) {</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-            index = this.treeBuilder.getIndexOfResource(this._itemToBeToggled[i]);</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+            var index = this.treeBuilder.getIndexOfResource(this._itemToBeToggled[i]);</span>
<a href="#l12.38"></a><span id="l12.38">             if (index &gt;=0)</span>
<a href="#l12.39"></a><span id="l12.39">               this.treeBoxObject.view.selection.toggleSelect(index);</span>
<a href="#l12.40"></a><span id="l12.40">           }</span>
<a href="#l12.41"></a><span id="l12.41">           this.treeBoxObject.view.selection.selectEventsSuppressed = false;</span>
<a href="#l12.42"></a><span id="l12.42">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.43"></a><span id="l12.43">       &lt;/method&gt;</span>
<a href="#l12.44"></a><span id="l12.44"> </span>
<a href="#l12.45"></a><span id="l12.45">       &lt;method name=&quot;createTreeContextMenu&quot;&gt;</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineat">@@ -686,35 +679,32 @@</span>
<a href="#l12.47"></a><span id="l12.47">       &lt;!-- nsITransactionManager listener --&gt;</span>
<a href="#l12.48"></a><span id="l12.48">       &lt;field name=&quot;transactionListener&quot;&gt;&lt;![CDATA[</span>
<a href="#l12.49"></a><span id="l12.49">       ({</span>
<a href="#l12.50"></a><span id="l12.50"> </span>
<a href="#l12.51"></a><span id="l12.51">         mOuter: this,</span>
<a href="#l12.52"></a><span id="l12.52"> </span>
<a href="#l12.53"></a><span id="l12.53">         willDo: function (aTxmgr, aTxn) {</span>
<a href="#l12.54"></a><span id="l12.54">           this.mOuter._itemToBeToggled   = [];</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-          this.mOuter._parentToBeToggled = [];</span>
<a href="#l12.56"></a><span id="l12.56">         },</span>
<a href="#l12.57"></a><span id="l12.57"> </span>
<a href="#l12.58"></a><span id="l12.58">         didDo: function (aTxmgr, aTxn) {</span>
<a href="#l12.59"></a><span id="l12.59">           this.mOuter.preUpdateTreeSelection(aTxn);</span>
<a href="#l12.60"></a><span id="l12.60">         },</span>
<a href="#l12.61"></a><span id="l12.61"> </span>
<a href="#l12.62"></a><span id="l12.62">         willUndo: function (aTxmgr, aTxn) {</span>
<a href="#l12.63"></a><span id="l12.63">           this.mOuter._itemToBeToggled   = [];</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-          this.mOuter._parentToBeToggled = [];</span>
<a href="#l12.65"></a><span id="l12.65">         },</span>
<a href="#l12.66"></a><span id="l12.66"> </span>
<a href="#l12.67"></a><span id="l12.67">         didUndo: function (aTxmgr, aTxn) {</span>
<a href="#l12.68"></a><span id="l12.68">           this.mOuter.preUpdateTreeSelection(aTxn);</span>
<a href="#l12.69"></a><span id="l12.69">         },</span>
<a href="#l12.70"></a><span id="l12.70"> </span>
<a href="#l12.71"></a><span id="l12.71">         willRedo: function (aTxmgr, aTxn) {</span>
<a href="#l12.72"></a><span id="l12.72">           this.mOuter._itemToBeToggled   = [];</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-          this.mOuter._parentToBeToggled = [];</span>
<a href="#l12.74"></a><span id="l12.74">         },</span>
<a href="#l12.75"></a><span id="l12.75"> </span>
<a href="#l12.76"></a><span id="l12.76">         didRedo: function (aTxmgr, aTxn) {</span>
<a href="#l12.77"></a><span id="l12.77">           this.mOuter.preUpdateTreeSelection(aTxn);</span>
<a href="#l12.78"></a><span id="l12.78">         },</span>
<a href="#l12.79"></a><span id="l12.79"> </span>
<a href="#l12.80"></a><span id="l12.80">         didMerge       : function (aTxmgr, aTxn) {},</span>
<a href="#l12.81"></a><span id="l12.81">         didBeginBatch  : function (aTxmgr, aTxn) {},</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/suite/common/history/controller.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/suite/common/history/controller.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -101,30 +101,38 @@ PlacesController.prototype = {</span>
<a href="#l13.4"></a><span id="l13.4">             return true;</span>
<a href="#l13.5"></a><span id="l13.5">         }</span>
<a href="#l13.6"></a><span id="l13.6">       }</span>
<a href="#l13.7"></a><span id="l13.7">       return false;</span>
<a href="#l13.8"></a><span id="l13.8">     case &quot;placesCmd_open&quot;:</span>
<a href="#l13.9"></a><span id="l13.9">       var selectedNode = this._view.selectedNode;</span>
<a href="#l13.10"></a><span id="l13.10">       return selectedNode &amp;&amp; PlacesUtils.nodeIsURI(selectedNode);</span>
<a href="#l13.11"></a><span id="l13.11">     case &quot;placesCmd_delete:hostname&quot;:</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-      gDeleteByHostname.accessKey = PlacesUIUtils.getString(&quot;delete.hostname.accesskey&quot;);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+      gDeleteByHostname.setAttribute(&quot;accesskey&quot;,</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+                                     PlacesUIUtils.getString(&quot;delete.hostname.accesskey&quot;));</span>
<a href="#l13.15"></a><span id="l13.15">       if (gLastHostname) {</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-        gDeleteByHostname.label = PlacesUIUtils.getFormattedString(&quot;delete.hostname.true&quot;, [gLastHostname]);</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+        gDeleteByHostname.setAttribute(&quot;label&quot;,</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+                                       PlacesUIUtils.getFormattedString(&quot;delete.hostname.true&quot;,</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+                                                                        [gLastHostname]));</span>
<a href="#l13.20"></a><span id="l13.20">         return true;</span>
<a href="#l13.21"></a><span id="l13.21">       }</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-      gDeleteByHostname.label = PlacesUIUtils.getString(&quot;delete.hostname.false&quot;);</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+      gDeleteByHostname.setAttribute(&quot;label&quot;,</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+                                     PlacesUIUtils.getString(&quot;delete.hostname.false&quot;));</span>
<a href="#l13.25"></a><span id="l13.25">       return false;</span>
<a href="#l13.26"></a><span id="l13.26">     case &quot;placesCmd_delete:domain&quot;:</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-      gDeleteByDomain.accessKey = PlacesUIUtils.getString(&quot;delete.domain.accesskey&quot;);</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+      gDeleteByDomain.setAttribute(&quot;accesskey&quot;,</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+                                   PlacesUIUtils.getString(&quot;delete.domain.accesskey&quot;));</span>
<a href="#l13.30"></a><span id="l13.30">       if (gLastDomain) {</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-        gDeleteByDomain.label = PlacesUIUtils.getFormattedString(&quot;delete.domain.true&quot;, [gLastDomain]);</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+        gDeleteByDomain.setAttribute(&quot;label&quot;,</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+                                     PlacesUIUtils.getFormattedString(&quot;delete.domain.true&quot;,</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+                                                                      [gLastDomain]));</span>
<a href="#l13.35"></a><span id="l13.35">         return true;</span>
<a href="#l13.36"></a><span id="l13.36">       }</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-      gDeleteByDomain.label = PlacesUIUtils.getString(&quot;delete.domain.false&quot;);</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+      gDeleteByDomain.setAttribute(&quot;label&quot;,</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+                                   PlacesUIUtils.getString(&quot;delete.domain.false&quot;));</span>
<a href="#l13.40"></a><span id="l13.40">       return false;</span>
<a href="#l13.41"></a><span id="l13.41">     default:</span>
<a href="#l13.42"></a><span id="l13.42">       return false;</span>
<a href="#l13.43"></a><span id="l13.43">     }</span>
<a href="#l13.44"></a><span id="l13.44">   },</span>
<a href="#l13.45"></a><span id="l13.45"> </span>
<a href="#l13.46"></a><span id="l13.46">   doCommand: function PC_doCommand(aCommand) {</span>
<a href="#l13.47"></a><span id="l13.47">     switch (aCommand) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/suite/common/history/history-panel.xul</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/suite/common/history/history-panel.xul</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -78,16 +78,17 @@</span>
<a href="#l14.4"></a><span id="l14.4">     &lt;/toolbarbutton&gt;</span>
<a href="#l14.5"></a><span id="l14.5">   &lt;/hbox&gt;</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7">   &lt;tree id=&quot;historyTree&quot;</span>
<a href="#l14.8"></a><span id="l14.8">         class=&quot;sidebar-placesTree plain&quot;</span>
<a href="#l14.9"></a><span id="l14.9">         flex=&quot;1&quot;</span>
<a href="#l14.10"></a><span id="l14.10">         type=&quot;places&quot;</span>
<a href="#l14.11"></a><span id="l14.11">         context=&quot;placesContext&quot;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+        onselect=&quot;historyOnSelect();&quot;</span>
<a href="#l14.13"></a><span id="l14.13">         onkeypress=&quot;SidebarUtils.handleTreeKeyPress(event);&quot;</span>
<a href="#l14.14"></a><span id="l14.14">         onclick=&quot;SidebarUtils.handleTreeClick(this, event, true);&quot;</span>
<a href="#l14.15"></a><span id="l14.15">         onmousemove=&quot;SidebarUtils.handleTreeMouseMove(event);&quot;</span>
<a href="#l14.16"></a><span id="l14.16">         onmouseout=&quot;SidebarUtils.clearURLFromStatusBar();&quot;&gt;</span>
<a href="#l14.17"></a><span id="l14.17">     &lt;treecols context=&quot;&quot;&gt;</span>
<a href="#l14.18"></a><span id="l14.18">       &lt;treecol label=&quot;&amp;col.title.label;&quot; id=&quot;Name&quot; flex=&quot;4&quot;</span>
<a href="#l14.19"></a><span id="l14.19">                persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l14.20"></a><span id="l14.20">       &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/suite/common/history/history.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/suite/common/history/history.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -49,18 +49,18 @@ var gETLDService;</span>
<a href="#l15.4"></a><span id="l15.4"> var gDeleteByHostname;</span>
<a href="#l15.5"></a><span id="l15.5"> var gDeleteByDomain;</span>
<a href="#l15.6"></a><span id="l15.6"> var gHistoryStatus;</span>
<a href="#l15.7"></a><span id="l15.7"> var gHistoryGrouping = &quot;day&quot;;</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> function HistoryCommonInit()</span>
<a href="#l15.10"></a><span id="l15.10"> {</span>
<a href="#l15.11"></a><span id="l15.11">   gHistoryTree = document.getElementById(&quot;historyTree&quot;);</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  gDeleteByHostname = document.getElementById(&quot;menu_deleteByHostname&quot;);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-  gDeleteByDomain = document.getElementById(&quot;menu_deleteByDomain&quot;);</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+  gDeleteByHostname = document.getElementById(&quot;placesCmd_delete:hostname&quot;);</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+  gDeleteByDomain = document.getElementById(&quot;placesCmd_delete:domain&quot;);</span>
<a href="#l15.16"></a><span id="l15.16">   gHistoryStatus = document.getElementById(&quot;statusbar-display&quot;);</span>
<a href="#l15.17"></a><span id="l15.17">   gSearchBox = document.getElementById(&quot;search-box&quot;);</span>
<a href="#l15.18"></a><span id="l15.18"> </span>
<a href="#l15.19"></a><span id="l15.19">   gPrefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l15.20"></a><span id="l15.20">                            .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l15.21"></a><span id="l15.21">   PREF = gPrefService;    // need this for bookmarks.js</span>
<a href="#l15.22"></a><span id="l15.22"> </span>
<a href="#l15.23"></a><span id="l15.23">   try {</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineat">@@ -112,17 +112,18 @@ function historyOnSelect()</span>
<a href="#l15.25"></a><span id="l15.25">           gETLDService =</span>
<a href="#l15.26"></a><span id="l15.26">             Components.classes[&quot;@mozilla.org/network/effective-tld-service;1&quot;]</span>
<a href="#l15.27"></a><span id="l15.27">                       .getService(Components.interfaces.nsIEffectiveTLDService);</span>
<a href="#l15.28"></a><span id="l15.28">         gLastDomain = gETLDService.getBaseDomainFromHost(gLastHostname);</span>
<a href="#l15.29"></a><span id="l15.29">       } catch (e) {}</span>
<a href="#l15.30"></a><span id="l15.30">     }</span>
<a href="#l15.31"></a><span id="l15.31">   }</span>
<a href="#l15.32"></a><span id="l15.32"> </span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-  gHistoryStatus.label = url;</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+  if (gHistoryStatus)</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+    gHistoryStatus.label = url;</span>
<a href="#l15.36"></a><span id="l15.36"> </span>
<a href="#l15.37"></a><span id="l15.37">   updateHistoryCommands();</span>
<a href="#l15.38"></a><span id="l15.38"> }</span>
<a href="#l15.39"></a><span id="l15.39"> </span>
<a href="#l15.40"></a><span id="l15.40"> function UpdateViewColumns(aMenuItem)</span>
<a href="#l15.41"></a><span id="l15.41"> {</span>
<a href="#l15.42"></a><span id="l15.42">   while (aMenuItem) {</span>
<a href="#l15.43"></a><span id="l15.43">     // Each menuitem should be checked if its column is not hidden.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/suite/common/history/history.xul</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/suite/common/history/history.xul</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -75,20 +75,17 @@</span>
<a href="#l16.4"></a><span id="l16.4">              oncommand=&quot;focusElement(gSearchBox);&quot;/&gt;</span>
<a href="#l16.5"></a><span id="l16.5">   &lt;/commandset&gt;</span>
<a href="#l16.6"></a><span id="l16.6">   &lt;commandset id=&quot;selectEditMenuItems&quot;&gt;</span>
<a href="#l16.7"></a><span id="l16.7">     &lt;command id=&quot;cmd_cut&quot;/&gt;</span>
<a href="#l16.8"></a><span id="l16.8">     &lt;command id=&quot;cmd_copy&quot;/&gt;</span>
<a href="#l16.9"></a><span id="l16.9">     &lt;command id=&quot;cmd_delete&quot;/&gt;</span>
<a href="#l16.10"></a><span id="l16.10">     &lt;command id=&quot;cmd_selectAll&quot;/&gt;</span>
<a href="#l16.11"></a><span id="l16.11">   &lt;/commandset&gt;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  &lt;commandset id=&quot;placesCommands&quot;&gt;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-    &lt;command id=&quot;placesCmd_delete:hostname&quot; oncommand=&quot;goDoCommand('placesCmd_delete:hostname');&quot;/&gt;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-    &lt;command id=&quot;placesCmd_delete:domain&quot; oncommand=&quot;goDoCommand('placesCmd_delete:domain');&quot;/&gt;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-  &lt;/commandset&gt;</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+  &lt;commandset id=&quot;placesCommands&quot;/&gt;</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18">   &lt;broadcaster id=&quot;Communicator:WorkMode&quot;/&gt;</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20">   &lt;keyset id=&quot;tasksKeys&quot;&gt;</span>
<a href="#l16.21"></a><span id="l16.21">     &lt;!-- File Menu --&gt;</span>
<a href="#l16.22"></a><span id="l16.22">     &lt;key id=&quot;key_close&quot;/&gt;</span>
<a href="#l16.23"></a><span id="l16.23">     &lt;key id=&quot;key_quit&quot;/&gt;</span>
<a href="#l16.24"></a><span id="l16.24">     &lt;!-- Edit Menu --&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/suite/common/history/placesOverlay.xul</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/suite/common/history/placesOverlay.xul</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -73,16 +73,20 @@</span>
<a href="#l17.4"></a><span id="l17.4">               events=&quot;focus,sort&quot;</span>
<a href="#l17.5"></a><span id="l17.5">               oncommandupdate=&quot;updateHistoryCommands(this.firstChild);&quot;&gt;</span>
<a href="#l17.6"></a><span id="l17.6">     &lt;command id=&quot;placesCmd_open&quot;</span>
<a href="#l17.7"></a><span id="l17.7">              oncommand=&quot;goDoCommand('placesCmd_open');&quot;/&gt;</span>
<a href="#l17.8"></a><span id="l17.8">     &lt;command id=&quot;placesCmd_open:window&quot;</span>
<a href="#l17.9"></a><span id="l17.9">              oncommand=&quot;goDoCommand('placesCmd_open:window');&quot;/&gt;</span>
<a href="#l17.10"></a><span id="l17.10">     &lt;command id=&quot;placesCmd_open:tab&quot;</span>
<a href="#l17.11"></a><span id="l17.11">              oncommand=&quot;goDoCommand('placesCmd_open:tab');&quot;/&gt;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+    &lt;command id=&quot;placesCmd_delete:hostname&quot;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+             oncommand=&quot;goDoCommand('placesCmd_delete:hostname');&quot;/&gt;</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+    &lt;command id=&quot;placesCmd_delete:domain&quot;</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+             oncommand=&quot;goDoCommand('placesCmd_delete:domain');&quot;/&gt;</span>
<a href="#l17.16"></a><span id="l17.16">   &lt;/commandset&gt;</span>
<a href="#l17.17"></a><span id="l17.17"> </span>
<a href="#l17.18"></a><span id="l17.18">   &lt;popup id=&quot;placesContext&quot;</span>
<a href="#l17.19"></a><span id="l17.19">          onpopupshowing=&quot;this._view = PlacesUIUtils.getViewForNode(document.popupNode);</span>
<a href="#l17.20"></a><span id="l17.20">                          return this._view.buildContextMenu(this);&quot;</span>
<a href="#l17.21"></a><span id="l17.21">          onpopuphiding=&quot;this._view.destroyContextMenu();&quot;&gt;</span>
<a href="#l17.22"></a><span id="l17.22">     &lt;menuitem id=&quot;placesContext_open&quot;</span>
<a href="#l17.23"></a><span id="l17.23">               command=&quot;placesCmd_open&quot;</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineat">@@ -120,16 +124,22 @@</span>
<a href="#l17.25"></a><span id="l17.25">               accesskey=&quot;&amp;copyCmd.accesskey;&quot;</span>
<a href="#l17.26"></a><span id="l17.26">               selection=&quot;any&quot;/&gt;</span>
<a href="#l17.27"></a><span id="l17.27">     &lt;menuseparator id=&quot;placesContext_editSeparator&quot;/&gt;</span>
<a href="#l17.28"></a><span id="l17.28">     &lt;menuitem id=&quot;placesContext_delete&quot;</span>
<a href="#l17.29"></a><span id="l17.29">               command=&quot;cmd_delete&quot;</span>
<a href="#l17.30"></a><span id="l17.30">               label=&quot;&amp;deleteCmd.label;&quot;</span>
<a href="#l17.31"></a><span id="l17.31">               accesskey=&quot;&amp;deleteCmd.accesskey;&quot;</span>
<a href="#l17.32"></a><span id="l17.32">               selection=&quot;link|host|day&quot;/&gt;</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+    &lt;menuitem id=&quot;placesContext_deleteByHostname&quot;</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+              command=&quot;placesCmd_delete:hostname&quot;</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+              selection=&quot;link|host&quot;/&gt;</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+    &lt;menuitem id=&quot;placesContext_deleteByDomain&quot;</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+              command=&quot;placesCmd_delete:domain&quot;</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+              selection=&quot;link|host&quot;/&gt;</span>
<a href="#l17.39"></a><span id="l17.39">     &lt;menuitem id=&quot;placesContext_selectAll&quot;</span>
<a href="#l17.40"></a><span id="l17.40">               command=&quot;cmd_selectAll&quot;</span>
<a href="#l17.41"></a><span id="l17.41">               label=&quot;&amp;selectAllCmd.label;&quot;</span>
<a href="#l17.42"></a><span id="l17.42">               accesskey=&quot;&amp;selectAllCmd.accesskey;&quot;</span>
<a href="#l17.43"></a><span id="l17.43">               selection=&quot;any&quot;/&gt;</span>
<a href="#l17.44"></a><span id="l17.44">   &lt;/popup&gt;</span>
<a href="#l17.45"></a><span id="l17.45"> </span>
<a href="#l17.46"></a><span id="l17.46">   &lt;menupopup id=&quot;viewPopup&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/suite/mailnews/mailWidgets.xml</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/suite/mailnews/mailWidgets.xml</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1682,18 +1682,17 @@</span>
<a href="#l18.4"></a><span id="l18.4">           })</span>
<a href="#l18.5"></a><span id="l18.5">         ]]&gt;</span>
<a href="#l18.6"></a><span id="l18.6">       &lt;/field&gt;</span>
<a href="#l18.7"></a><span id="l18.7">       &lt;method name=&quot;setInitialSelection&quot;&gt;</span>
<a href="#l18.8"></a><span id="l18.8">         &lt;body&gt;</span>
<a href="#l18.9"></a><span id="l18.9">           &lt;![CDATA[</span>
<a href="#l18.10"></a><span id="l18.10">             var view = this.tree.view;</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-            if (!view.selection.currentColumn)</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-              view.selection.currentColumn = this.tree.columns.getFirstColumn();</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+            view.selection.currentColumn = this.tree.columns.getFirstColumn();</span>
<a href="#l18.15"></a><span id="l18.15"> </span>
<a href="#l18.16"></a><span id="l18.16">             view.selection.selectEventsSuppressed = true;</span>
<a href="#l18.17"></a><span id="l18.17">             for (var i = 0; i &lt; view.rowCount; i++) {</span>
<a href="#l18.18"></a><span id="l18.18">               if (view.isContainer(i)) {</span>
<a href="#l18.19"></a><span id="l18.19">                 if (view.isContainerEmpty(i) == view.isContainerOpen(i))</span>
<a href="#l18.20"></a><span id="l18.20">                   view.toggleOpenState(i);</span>
<a href="#l18.21"></a><span id="l18.21">                 if (view.isContainerOpen(i)) {</span>
<a href="#l18.22"></a><span id="l18.22">                   if (i + 1 == view.rowCount ||</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/suite/mailnews/mailWindowOverlay.xul</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/suite/mailnews/mailWindowOverlay.xul</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -1155,17 +1155,17 @@</span>
<a href="#l19.4"></a><span id="l19.4">                     checked=&quot;true&quot;</span>
<a href="#l19.5"></a><span id="l19.5">                     label=&quot;&amp;showMessengerToolbarCmd.label;&quot;</span>
<a href="#l19.6"></a><span id="l19.6">                     accesskey=&quot;&amp;showMessengerToolbarCmd.accesskey;&quot;</span>
<a href="#l19.7"></a><span id="l19.7">                     oncommand=&quot;goToggleToolbar('msgToolbar', 'menu_showMessengerToolbar')&quot;/&gt;</span>
<a href="#l19.8"></a><span id="l19.8">           &lt;menuitem id=&quot;menu_showLocationToolbar&quot;</span>
<a href="#l19.9"></a><span id="l19.9">                     type=&quot;checkbox&quot;</span>
<a href="#l19.10"></a><span id="l19.10">                     label=&quot;&amp;showLocationToolbarCmd.label;&quot;</span>
<a href="#l19.11"></a><span id="l19.11">                     accesskey=&quot;&amp;showLocationToolbarCmd.accesskey;&quot;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-                    oncommand=&quot;goToggleLocationToolbar('true');&quot;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+                    oncommand=&quot;goToggleToolbar('msgLocationToolbar', 'menu_showLocationToolbar');&quot;</span>
<a href="#l19.14"></a><span id="l19.14">                     observes=&quot;mailHideMenus&quot;</span>
<a href="#l19.15"></a><span id="l19.15">                     checked=&quot;false&quot; persist=&quot;checked&quot;/&gt;</span>
<a href="#l19.16"></a><span id="l19.16">           &lt;menuitem id=&quot;menu_showSearchToolbar&quot;</span>
<a href="#l19.17"></a><span id="l19.17">                     type=&quot;checkbox&quot;</span>
<a href="#l19.18"></a><span id="l19.18">                     checked=&quot;true&quot;</span>
<a href="#l19.19"></a><span id="l19.19">                     label=&quot;&amp;showSearchToolbarCmd.label;&quot;</span>
<a href="#l19.20"></a><span id="l19.20">                     accesskey=&quot;&amp;showSearchToolbarCmd.accesskey;&quot;</span>
<a href="#l19.21"></a><span id="l19.21">                     oncommand=&quot;goToggleToolbar('searchBox', 'menu_showSearchToolbar'); SearchBarToggled();&quot;</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -2289,18 +2289,18 @@</span>
<a href="#l19.23"></a><span id="l19.23">                 oncommand=&quot;goClickThrobber('messenger.throbber.url')&quot;</span>
<a href="#l19.24"></a><span id="l19.24">                 tooltiptext=&quot;&amp;throbber.tooltip;&quot;/&gt;</span>
<a href="#l19.25"></a><span id="l19.25">     &lt;/toolbaritem&gt;</span>
<a href="#l19.26"></a><span id="l19.26">   &lt;/toolbarpalette&gt;</span>
<a href="#l19.27"></a><span id="l19.27"> </span>
<a href="#l19.28"></a><span id="l19.28"> &lt;/toolbox&gt;</span>
<a href="#l19.29"></a><span id="l19.29"> </span>
<a href="#l19.30"></a><span id="l19.30"> &lt;toolbar id=&quot;msgLocationToolbar&quot;</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-         persist=&quot;collapsed&quot;</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-         collapsed=&quot;true&quot;</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+         persist=&quot;hidden&quot;</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+         hidden=&quot;true&quot;</span>
<a href="#l19.35"></a><span id="l19.35">          grippytooltiptext=&quot;&amp;locationToolbar.tooltip;&quot;</span>
<a href="#l19.36"></a><span id="l19.36">          nowindowdrag=&quot;true&quot;&gt;</span>
<a href="#l19.37"></a><span id="l19.37">   &lt;hbox align=&quot;center&quot; context=&quot;folderPaneContext&quot;&gt;</span>
<a href="#l19.38"></a><span id="l19.38">     &lt;image id=&quot;locationIcon&quot; class=&quot;folderMenuItem&quot;/&gt;</span>
<a href="#l19.39"></a><span id="l19.39">     &lt;menulist id=&quot;locationFolders&quot; class=&quot;folderMenuItem&quot;</span>
<a href="#l19.40"></a><span id="l19.40">               label=&quot; &quot; crop=&quot;center&quot;&gt;</span>
<a href="#l19.41"></a><span id="l19.41">       &lt;menupopup id=&quot;locationPopup&quot; height=&quot;400&quot;</span>
<a href="#l19.42"></a><span id="l19.42">                  oncommand=&quot;OnLocationTreeSelect(this);&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/suite/mailnews/msgMail3PaneWindow.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/suite/mailnews/msgMail3PaneWindow.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1035,22 +1035,21 @@ function UpdateAttachmentCol(aFirstTimeF</span>
<a href="#l20.4"></a><span id="l20.4">   if (aFirstTimeFlag)</span>
<a href="#l20.5"></a><span id="l20.5">     attachmentCol.addEventListener(&quot;DOMAttrModified&quot;, OnAttachmentColAttrModified, false);</span>
<a href="#l20.6"></a><span id="l20.6">   else</span>
<a href="#l20.7"></a><span id="l20.7">     threadTree.treeBoxObject.clearStyleAndImageCaches();</span>
<a href="#l20.8"></a><span id="l20.8"> }</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10"> function OnLocationToolbarAttrModified(event)</span>
<a href="#l20.11"></a><span id="l20.11"> {</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-    if (!/collapsed/.test(event.attrName))</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+    if (!/collapsed|hidden/.test(event.attrName))</span>
<a href="#l20.14"></a><span id="l20.14">         return;</span>
<a href="#l20.15"></a><span id="l20.15">     var searchBox = document.getElementById(&quot;searchBox&quot;);</span>
<a href="#l20.16"></a><span id="l20.16">     var desiredParent = document.getElementById(&quot;msgLocationToolbar&quot;);</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-    if (desiredParent.getAttribute(&quot;collapsed&quot;) == &quot;true&quot; ||</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-        desiredParent.getAttribute(&quot;moz-collapsed&quot;) == &quot;true&quot;)</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+    if (desiredParent.hidden || desiredParent.collapsed)</span>
<a href="#l20.20"></a><span id="l20.20">         desiredParent = document.getElementById(&quot;searchBoxHolder&quot;);</span>
<a href="#l20.21"></a><span id="l20.21">     if (searchBox.parentNode != desiredParent)</span>
<a href="#l20.22"></a><span id="l20.22">         desiredParent.appendChild(searchBox);</span>
<a href="#l20.23"></a><span id="l20.23"> }</span>
<a href="#l20.24"></a><span id="l20.24"> </span>
<a href="#l20.25"></a><span id="l20.25"> function OnLoadLocationTree()</span>
<a href="#l20.26"></a><span id="l20.26"> {</span>
<a href="#l20.27"></a><span id="l20.27">     var locationTree = document.getElementById('locationPopup').tree;</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineat">@@ -1090,26 +1089,16 @@ function UpdateLocationBar(resource)</span>
<a href="#l20.29"></a><span id="l20.29">         var name = names[i];</span>
<a href="#l20.30"></a><span id="l20.30">         var value = GetFolderAttribute(tree, resource, name);</span>
<a href="#l20.31"></a><span id="l20.31">         folders.setAttribute(name, value);</span>
<a href="#l20.32"></a><span id="l20.32">         icon.setAttribute(name, value);</span>
<a href="#l20.33"></a><span id="l20.33">     }</span>
<a href="#l20.34"></a><span id="l20.34">     folders.setAttribute('uri', resource.Value);</span>
<a href="#l20.35"></a><span id="l20.35"> }</span>
<a href="#l20.36"></a><span id="l20.36"> </span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-function goToggleLocationToolbar(toggle)</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-{</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-    // XXX hidden doesn't work, use collapsed instead</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-    var menu = document.getElementById(&quot;menu_showLocationToolbar&quot;);</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-    var toolbar = document.getElementById(&quot;msgLocationToolbar&quot;);</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-    var checked = toolbar.collapsed;</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-    menu.setAttribute('checked', checked);</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-    toolbar.setAttribute('collapsed', !checked);</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-}</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-</span>
<a href="#l20.47"></a><span id="l20.47"> function GetFolderDatasource()</span>
<a href="#l20.48"></a><span id="l20.48"> {</span>
<a href="#l20.49"></a><span id="l20.49">   return GetFolderTree().database;</span>
<a href="#l20.50"></a><span id="l20.50"> }</span>
<a href="#l20.51"></a><span id="l20.51"> </span>
<a href="#l20.52"></a><span id="l20.52"> /* Functions for accessing particular parts of the window*/</span>
<a href="#l20.53"></a><span id="l20.53"> function GetFolderTree()</span>
<a href="#l20.54"></a><span id="l20.54"> {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

