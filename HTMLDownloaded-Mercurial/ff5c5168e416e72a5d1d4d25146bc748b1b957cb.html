<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 20188:ff5c5168e416e72a5d1d4d25146bc748b1b957cb</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ ff5c5168e416e72a5d1d4d25146bc748b1b957cb" />
<meta property="og:url" content="/comm-central/rev/ff5c5168e416e72a5d1d4d25146bc748b1b957cb" />
<meta property="og:description" content="Bug 483980 - Allow history/bookmark observer components to register with a startup category" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / ff5c5168e416e72a5d1d4d25146bc748b1b957cb &#x2620;
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/ff5c5168e416e72a5d1d4d25146bc748b1b957cb">shortlog</a> |
<a href="/comm-central/log/ff5c5168e416e72a5d1d4d25146bc748b1b957cb">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/ff5c5168e416e72a5d1d4d25146bc748b1b957cb">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/ff5c5168e416e72a5d1d4d25146bc748b1b957cb">files</a> |
changeset |
<a href="/comm-central/raw-rev/ff5c5168e416e72a5d1d4d25146bc748b1b957cb">raw</a>  | <a href="/comm-central/archive/ff5c5168e416e72a5d1d4d25146bc748b1b957cb.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=483980">Bug 483980</a> - Allow history/bookmark observer components to register with a startup category
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">
<tr><td colspan="2" style="background:#ff3333;"><strong>&#x2620;&#x2620; backed out by <a style="font-family: monospace" href="/comm-central/rev/91cefe8b8b28">91cefe8b8b28</a> &#x2620; &#x2620;</strong></td></tr>
<tr><td>author</td><td>&#77;&#97;&#114;&#107;&#32;&#70;&#105;&#110;&#107;&#108;&#101;&#32;&#60;&#109;&#102;&#105;&#110;&#107;&#108;&#101;&#64;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#46;&#99;&#111;&#109;&#62;&#44;&#32;&#83;&#104;&#97;&#119;&#110;&#32;&#87;&#105;&#108;&#115;&#104;&#101;&#114;&#32;&#60;&#109;&#101;&#64;&#115;&#104;&#97;&#119;&#110;&#119;&#105;&#108;&#115;&#104;&#101;&#114;&#46;&#99;&#111;&#109;&#62;&#44;&#32;&#77;&#97;&#114;&#99;&#111;&#32;&#66;&#111;&#110;&#97;&#114;&#100;&#111;&#32;&#60;&#109;&#97;&#107;&#55;&#55;&#64;&#98;&#111;&#110;&#97;&#114;&#100;&#111;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 25 Mar 2009 15:31:36 -0500</td></tr>

<tr>
 <td>changeset 20188</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/ff5c5168e416e72a5d1d4d25146bc748b1b957cb">ff5c5168e416e72a5d1d4d25146bc748b1b957cb</a></td>
</tr>



<tr>
<td>parent 20187</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6b7acba9cf1b69123568182be28bfd41712fb9eb">6b7acba9cf1b69123568182be28bfd41712fb9eb</a>
</td>
</tr>

<tr>
<td>child 20189</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/91cefe8b8b285dc82436821b7cd0f1d032e85781">91cefe8b8b285dc82436821b7cd0f1d032e85781</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=ff5c5168e416e72a5d1d4d25146bc748b1b957cb">12352</a></td></tr>
<tr><td>push user</td><td>philip.chee@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 27 Sep 2016 08:56:11 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@9bd937fc0c12 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de&newProject=comm-central&newRevision=66094254572ec015e4e170847fdebd67a6cf6198&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de&newProject=comm-central&newRevision=66094254572ec015e4e170847fdebd67a6cf6198&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de&newProject=comm-central&newRevision=66094254572ec015e4e170847fdebd67a6cf6198&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=483980">483980</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=483980">Bug 483980</a> - Allow history/bookmark observer components to register with a startup category
This changeset allows for history and bookmark observers to be registered via
the category manager.  This means the bookmarks service does not have to be
initialized at startup to register observers with it, as well as the history
service.
r=sdwilsh
r=mak
r=dietrich</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff5c5168e416e72a5d1d4d25146bc748b1b957cb/suite/common/places/tests/autocomplete/head_000.js">suite/common/places/tests/autocomplete/head_000.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff5c5168e416e72a5d1d4d25146bc748b1b957cb/suite/common/places/tests/autocomplete/head_000.js">file</a> |
<a href="/comm-central/annotate/ff5c5168e416e72a5d1d4d25146bc748b1b957cb/suite/common/places/tests/autocomplete/head_000.js">annotate</a> |
<a href="/comm-central/diff/ff5c5168e416e72a5d1d4d25146bc748b1b957cb/suite/common/places/tests/autocomplete/head_000.js">diff</a> |
<a href="/comm-central/comparison/ff5c5168e416e72a5d1d4d25146bc748b1b957cb/suite/common/places/tests/autocomplete/head_000.js">comparison</a> |
<a href="/comm-central/log/ff5c5168e416e72a5d1d4d25146bc748b1b957cb/suite/common/places/tests/autocomplete/head_000.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff5c5168e416e72a5d1d4d25146bc748b1b957cb/suite/common/places/tests/autocomplete/tail_autocomplete.js">suite/common/places/tests/autocomplete/tail_autocomplete.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff5c5168e416e72a5d1d4d25146bc748b1b957cb/suite/common/places/tests/autocomplete/tail_autocomplete.js">file</a> |
<a href="/comm-central/annotate/ff5c5168e416e72a5d1d4d25146bc748b1b957cb/suite/common/places/tests/autocomplete/tail_autocomplete.js">annotate</a> |
<a href="/comm-central/diff/ff5c5168e416e72a5d1d4d25146bc748b1b957cb/suite/common/places/tests/autocomplete/tail_autocomplete.js">diff</a> |
<a href="/comm-central/comparison/ff5c5168e416e72a5d1d4d25146bc748b1b957cb/suite/common/places/tests/autocomplete/tail_autocomplete.js">comparison</a> |
<a href="/comm-central/log/ff5c5168e416e72a5d1d4d25146bc748b1b957cb/suite/common/places/tests/autocomplete/tail_autocomplete.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/common/places/tests/autocomplete/head_000.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/common/places/tests/autocomplete/head_000.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -134,8 +134,18 @@ function dump_table(aName)</span>
<a href="#l1.4"></a><span id="l1.4">     count++;</span>
<a href="#l1.5"></a><span id="l1.5">   }</span>
<a href="#l1.6"></a><span id="l1.6">   dump(&quot;*** There were a total of &quot; + count + &quot; rows of data.\n\n&quot;);</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">   stmt.reset();</span>
<a href="#l1.9"></a><span id="l1.9">   stmt.finalize();</span>
<a href="#l1.10"></a><span id="l1.10">   stmt = null;</span>
<a href="#l1.11"></a><span id="l1.11"> }</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+/**</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+ * Flushes any events in the event loop of the main thread.</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+ */</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+function flush_main_thread_events()</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+{</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+  let tm = Cc[&quot;@mozilla.org/thread-manager;1&quot;].getService(Ci.nsIThreadManager);</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+  while (tm.mainThread.hasPendingEvents())</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+    tm.mainThread.processNextEvent(false);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/suite/common/places/tests/autocomplete/tail_autocomplete.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,65 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+ *</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+ *</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+ * License.</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+ *</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+ * The Original Code is Places.</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+ *</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+ * Mozilla.org</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+ *</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+ *  Marco Bonardo &lt;mak77@bonardo.net&gt;</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+ *</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+ *</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+// put cleanup of the bookmarks test here.</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+// Run the event loop to be more like the browser, which normally runs the</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+// event loop long before code like this would run.</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+// Not doing so could cause us to close the connection before all tasks have</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+// been completed, and that would crash badly.</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+flush_main_thread_events();</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+// XPCShell doesn't dispatch quit-application, to ensure cleanup we have to</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+// dispatch it after each test run.</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+var os = Cc['@mozilla.org/observer-service;1'].</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+         getService(Ci.nsIObserverService);</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+os.notifyObservers(null, &quot;quit-application-granted&quot;, null);</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+os.notifyObservers(null, &quot;quit-application&quot;, null);</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+// Run the event loop, since we enqueue some statement finalization.</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+flush_main_thread_events();</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+// try to close the connection so we can remove places.sqlite</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+var pip = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+          getService(Ci.nsINavHistoryService).</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+          QueryInterface(Ci.nsPIPlacesDatabase);</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+if (pip.DBConnection.connectionReady) {</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+  pip.commitPendingChanges();</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+  pip.finalizeInternalStatements();</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+  pip.DBConnection.close();</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+  do_check_false(pip.DBConnection.connectionReady);</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

