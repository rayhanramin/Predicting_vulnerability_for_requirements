<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 3450:8f4aadd44e102040752f31290d21491b62b187e1</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 8f4aadd44e102040752f31290d21491b62b187e1" />
<meta property="og:url" content="/comm-central/rev/8f4aadd44e102040752f31290d21491b62b187e1" />
<meta property="og:description" content="fix various causes of corruption of offline imap store, r=standard8, sr=neil, 468595, plus limited unit test" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 8f4aadd44e102040752f31290d21491b62b187e1 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/8f4aadd44e102040752f31290d21491b62b187e1">shortlog</a> |
<a href="/comm-central/log/8f4aadd44e102040752f31290d21491b62b187e1">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/8f4aadd44e102040752f31290d21491b62b187e1">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/8f4aadd44e102040752f31290d21491b62b187e1">files</a> |
changeset |
<a href="/comm-central/raw-rev/8f4aadd44e102040752f31290d21491b62b187e1">raw</a>  | <a href="/comm-central/archive/8f4aadd44e102040752f31290d21491b62b187e1.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
fix various causes of corruption of offline imap store, r=standard8, sr=neil, 468595, plus limited unit test
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 29 Aug 2009 12:14:45 -0700</td></tr>

<tr>
 <td>changeset 3450</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/8f4aadd44e102040752f31290d21491b62b187e1">8f4aadd44e102040752f31290d21491b62b187e1</a></td>
</tr>



<tr>
<td>parent 3449</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/880ac704c5b75ddc9a19010239998daa1f16a027">880ac704c5b75ddc9a19010239998daa1f16a027</a>
</td>
</tr>

<tr>
<td>child 3451</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f3cf62cbdf2e916a7a317ef087b60f16eec4923e">f3cf62cbdf2e916a7a317ef087b60f16eec4923e</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=8f4aadd44e102040752f31290d21491b62b187e1">2802</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 29 Aug 2009 19:14:49 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@8f4aadd44e10 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8f4aadd44e102040752f31290d21491b62b187e1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8f4aadd44e102040752f31290d21491b62b187e1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8f4aadd44e102040752f31290d21491b62b187e1&newProject=comm-central&newRevision=8f4aadd44e102040752f31290d21491b62b187e1&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8f4aadd44e102040752f31290d21491b62b187e1&newProject=comm-central&newRevision=8f4aadd44e102040752f31290d21491b62b187e1&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8f4aadd44e102040752f31290d21491b62b187e1&newProject=comm-central&newRevision=8f4aadd44e102040752f31290d21491b62b187e1&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28standard8%29&revcount=50">standard8</a>, <a href="/comm-central/log?rev=reviewer%28neil%29&revcount=50">neil</a>, <a href="/comm-central/log?rev=reviewer%28468595%29&revcount=50">468595</a>, <a href="/comm-central/log?rev=reviewer%28plus%29&revcount=50">plus</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=468595">468595</a></td></tr>




</table></div>

<div class="page_body description">fix various causes of corruption of offline imap store, r=standard8, sr=neil, 468595, plus limited unit test</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/base/util/nsMsgDBFolder.h">mailnews/base/util/nsMsgDBFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/base/util/nsMsgDBFolder.h">file</a> |
<a href="/comm-central/annotate/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/base/util/nsMsgDBFolder.h">annotate</a> |
<a href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/base/util/nsMsgDBFolder.h">diff</a> |
<a href="/comm-central/comparison/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/base/util/nsMsgDBFolder.h">comparison</a> |
<a href="/comm-central/log/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/base/util/nsMsgDBFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/public/nsIImapMessageSink.idl">mailnews/imap/public/nsIImapMessageSink.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/public/nsIImapMessageSink.idl">file</a> |
<a href="/comm-central/annotate/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/public/nsIImapMessageSink.idl">annotate</a> |
<a href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/public/nsIImapMessageSink.idl">diff</a> |
<a href="/comm-central/comparison/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/public/nsIImapMessageSink.idl">comparison</a> |
<a href="/comm-central/log/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/public/nsIImapMessageSink.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/public/nsIImapUrl.idl">mailnews/imap/public/nsIImapUrl.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/public/nsIImapUrl.idl">file</a> |
<a href="/comm-central/annotate/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/public/nsIImapUrl.idl">annotate</a> |
<a href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/public/nsIImapUrl.idl">diff</a> |
<a href="/comm-central/comparison/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/public/nsIImapUrl.idl">comparison</a> |
<a href="/comm-central/log/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/public/nsIImapUrl.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapMailFolder.h">mailnews/imap/src/nsImapMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapMailFolder.h">file</a> |
<a href="/comm-central/annotate/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapMailFolder.h">annotate</a> |
<a href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapMailFolder.h">diff</a> |
<a href="/comm-central/comparison/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapMailFolder.h">comparison</a> |
<a href="/comm-central/log/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapService.cpp">mailnews/imap/src/nsImapService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapService.cpp">file</a> |
<a href="/comm-central/annotate/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapService.cpp">annotate</a> |
<a href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapService.cpp">diff</a> |
<a href="/comm-central/comparison/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapService.cpp">comparison</a> |
<a href="/comm-central/log/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapUrl.cpp">mailnews/imap/src/nsImapUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapUrl.cpp">file</a> |
<a href="/comm-central/annotate/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapUrl.cpp">annotate</a> |
<a href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapUrl.cpp">diff</a> |
<a href="/comm-central/comparison/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapUrl.cpp">comparison</a> |
<a href="/comm-central/log/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapUrl.h">mailnews/imap/src/nsImapUrl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapUrl.h">file</a> |
<a href="/comm-central/annotate/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapUrl.h">annotate</a> |
<a href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapUrl.h">diff</a> |
<a href="/comm-central/comparison/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapUrl.h">comparison</a> |
<a href="/comm-central/log/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/src/nsImapUrl.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">mailnews/imap/test/unit/test_imapStoreMsgOffline.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">file</a> |
<a href="/comm-central/annotate/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">annotate</a> |
<a href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">diff</a> |
<a href="/comm-central/comparison/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">comparison</a> |
<a href="/comm-central/log/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/imap/test/unit/test_imapStoreMsgOffline.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/test/data/external-attach-test">mailnews/test/data/external-attach-test</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/test/data/external-attach-test">file</a> |
<a href="/comm-central/annotate/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/test/data/external-attach-test">annotate</a> |
<a href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/test/data/external-attach-test">diff</a> |
<a href="/comm-central/comparison/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/test/data/external-attach-test">comparison</a> |
<a href="/comm-central/log/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/test/data/external-attach-test">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/test/data/image-attach-test">mailnews/test/data/image-attach-test</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/test/data/image-attach-test">file</a> |
<a href="/comm-central/annotate/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/test/data/image-attach-test">annotate</a> |
<a href="/comm-central/diff/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/test/data/image-attach-test">diff</a> |
<a href="/comm-central/comparison/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/test/data/image-attach-test">comparison</a> |
<a href="/comm-central/log/8f4aadd44e102040752f31290d21491b62b187e1/mailnews/test/data/image-attach-test">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1575,16 +1575,17 @@ nsresult nsMsgDBFolder::WriteStartOfNewL</span>
<a href="#l1.4"></a><span id="l1.4">   char *ct;</span>
<a href="#l1.5"></a><span id="l1.5">   PRUint32 writeCount;</span>
<a href="#l1.6"></a><span id="l1.6">   time_t now = time ((time_t*) 0);</span>
<a href="#l1.7"></a><span id="l1.7">   ct = ctime(&amp;now);</span>
<a href="#l1.8"></a><span id="l1.8">   ct[24] = 0;</span>
<a href="#l1.9"></a><span id="l1.9">   result = &quot;From - &quot;;</span>
<a href="#l1.10"></a><span id="l1.10">   result += ct;</span>
<a href="#l1.11"></a><span id="l1.11">   result += MSG_LINEBREAK;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+  m_bytesAddedToLocalMsg = result.Length();</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14">   nsCOMPtr &lt;nsISeekableStream&gt; seekable;</span>
<a href="#l1.15"></a><span id="l1.15">   nsInt64 curStorePos;</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17">   if (m_offlineHeader)</span>
<a href="#l1.18"></a><span id="l1.18">     seekable = do_QueryInterface(m_tempMessageStream);</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20">   if (seekable)</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineat">@@ -1601,24 +1602,24 @@ nsresult nsMsgDBFolder::WriteStartOfNewL</span>
<a href="#l1.22"></a><span id="l1.22">   {</span>
<a href="#l1.23"></a><span id="l1.23">     PRInt64 tellPos;</span>
<a href="#l1.24"></a><span id="l1.24">     seekable-&gt;Seek(PR_SEEK_CUR, 0); // seeking causes a flush, w/o syncing</span>
<a href="#l1.25"></a><span id="l1.25">     seekable-&gt;Tell(&amp;tellPos);</span>
<a href="#l1.26"></a><span id="l1.26">     curStorePos = tellPos;</span>
<a href="#l1.27"></a><span id="l1.27">     m_offlineHeader-&gt;SetStatusOffset((PRUint32) curStorePos);</span>
<a href="#l1.28"></a><span id="l1.28">   }</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-  result = &quot;X-Mozilla-Status: 0001&quot;;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-  result += MSG_LINEBREAK;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-  m_tempMessageStream-&gt;Write(result.get(), result.Length(),</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+  NS_NAMED_LITERAL_CSTRING(MozillaStatus, &quot;X-Mozilla-Status: 0001&quot; MSG_LINEBREAK);</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+  m_tempMessageStream-&gt;Write(MozillaStatus.get(), MozillaStatus.Length(),</span>
<a href="#l1.35"></a><span id="l1.35">                              &amp;writeCount);</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-  result =  &quot;X-Mozilla-Status2: 00000000&quot;;</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-  result += MSG_LINEBREAK;</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-  return m_tempMessageStream-&gt;Write(result.get(), result.Length(),</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-                             &amp;writeCount);</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+  m_bytesAddedToLocalMsg += writeCount;</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+  NS_NAMED_LITERAL_CSTRING(MozillaStatus2, &quot;X-Mozilla-Status2: 00000000&quot; MSG_LINEBREAK);</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+  m_bytesAddedToLocalMsg += MozillaStatus2.Length();</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+  return m_tempMessageStream-&gt;Write(MozillaStatus2.get(),</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+                                    MozillaStatus2.Length(), &amp;writeCount);</span>
<a href="#l1.45"></a><span id="l1.45"> }</span>
<a href="#l1.46"></a><span id="l1.46"> </span>
<a href="#l1.47"></a><span id="l1.47"> nsresult nsMsgDBFolder::StartNewOfflineMessage()</span>
<a href="#l1.48"></a><span id="l1.48"> {</span>
<a href="#l1.49"></a><span id="l1.49">   nsresult rv = NS_OK;</span>
<a href="#l1.50"></a><span id="l1.50">   if (!m_tempMessageStream)</span>
<a href="#l1.51"></a><span id="l1.51">     rv = GetOfflineStoreOutputStream(getter_AddRefs(m_tempMessageStream));</span>
<a href="#l1.52"></a><span id="l1.52">   else</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineat">@@ -1634,16 +1635,18 @@ nsresult nsMsgDBFolder::StartNewOfflineM</span>
<a href="#l1.54"></a><span id="l1.54">   return rv;</span>
<a href="#l1.55"></a><span id="l1.55"> }</span>
<a href="#l1.56"></a><span id="l1.56"> </span>
<a href="#l1.57"></a><span id="l1.57"> nsresult nsMsgDBFolder::EndNewOfflineMessage()</span>
<a href="#l1.58"></a><span id="l1.58"> {</span>
<a href="#l1.59"></a><span id="l1.59">   nsCOMPtr &lt;nsISeekableStream&gt; seekable;</span>
<a href="#l1.60"></a><span id="l1.60">   nsInt64 curStorePos;</span>
<a href="#l1.61"></a><span id="l1.61">   PRUint32 messageOffset;</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+  PRUint32 messageSize;</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+</span>
<a href="#l1.64"></a><span id="l1.64">   nsMsgKey messageKey;</span>
<a href="#l1.65"></a><span id="l1.65"> </span>
<a href="#l1.66"></a><span id="l1.66">   nsresult rv = GetDatabase();</span>
<a href="#l1.67"></a><span id="l1.67">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.68"></a><span id="l1.68"> </span>
<a href="#l1.69"></a><span id="l1.69">   m_offlineHeader-&gt;GetMessageKey(&amp;messageKey);</span>
<a href="#l1.70"></a><span id="l1.70">   if (m_tempMessageStream)</span>
<a href="#l1.71"></a><span id="l1.71">     seekable = do_QueryInterface(m_tempMessageStream);</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineat">@@ -1651,20 +1654,37 @@ nsresult nsMsgDBFolder::EndNewOfflineMes</span>
<a href="#l1.73"></a><span id="l1.73">   mDatabase-&gt;MarkOffline(messageKey, PR_TRUE, nsnull);</span>
<a href="#l1.74"></a><span id="l1.74">   if (seekable)</span>
<a href="#l1.75"></a><span id="l1.75">   {</span>
<a href="#l1.76"></a><span id="l1.76">     seekable-&gt;Seek(PR_SEEK_CUR, 0); // seeking causes a flush, w/o syncing</span>
<a href="#l1.77"></a><span id="l1.77">     PRInt64 tellPos;</span>
<a href="#l1.78"></a><span id="l1.78">     seekable-&gt;Tell(&amp;tellPos);</span>
<a href="#l1.79"></a><span id="l1.79">     curStorePos = tellPos;</span>
<a href="#l1.80"></a><span id="l1.80"> </span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+    // N.B. This only works if we've set the offline flag for the message,</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+    // so be careful about moving the call to MarkOffline above.</span>
<a href="#l1.83"></a><span id="l1.83">     m_offlineHeader-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l1.84"></a><span id="l1.84">     curStorePos -= messageOffset;</span>
<a href="#l1.85"></a><span id="l1.85">     m_offlineHeader-&gt;SetOfflineMessageSize(curStorePos);</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-    m_offlineHeader-&gt;SetLineCount(m_numOfflineMsgLines);</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+    m_offlineHeader-&gt;GetMessageSize(&amp;messageSize);</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+    messageSize += m_bytesAddedToLocalMsg;</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+    // unix/mac has a one byte line ending, but the imap server returns</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+    // crlf terminated lines.</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+    if (MSG_LINEBREAK_LEN == 1)</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+      messageSize -= m_numOfflineMsgLines;</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+    // We clear the offline flag on the message if the size</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+    // looks wrong.</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+    if ((PRUint32) curStorePos  &lt; messageSize)</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+    {</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+       mDatabase-&gt;MarkOffline(messageKey, PR_FALSE, nsnull);</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+       NS_ERROR(&quot;offline message too small&quot;);</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+    }</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+    else</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+      m_offlineHeader-&gt;SetLineCount(m_numOfflineMsgLines);</span>
<a href="#l1.103"></a><span id="l1.103">   }</span>
<a href="#l1.104"></a><span id="l1.104"> #ifdef _DEBUG</span>
<a href="#l1.105"></a><span id="l1.105">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l1.106"></a><span id="l1.106">   GetOfflineStoreInputStream(getter_AddRefs(inputStream));</span>
<a href="#l1.107"></a><span id="l1.107">   if (inputStream)</span>
<a href="#l1.108"></a><span id="l1.108">     NS_ASSERTION(VerifyOfflineMessage(m_offlineHeader, inputStream),</span>
<a href="#l1.109"></a><span id="l1.109">                  &quot;offline message doesn't start with From &quot;);</span>
<a href="#l1.110"></a><span id="l1.110"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -183,16 +183,17 @@ protected:</span>
<a href="#l2.4"></a><span id="l2.4">   PRBool mCharsetOverride;</span>
<a href="#l2.5"></a><span id="l2.5">   PRBool mAddListener;</span>
<a href="#l2.6"></a><span id="l2.6">   PRBool mNewMessages;</span>
<a href="#l2.7"></a><span id="l2.7">   PRBool mGettingNewMessages;</span>
<a href="#l2.8"></a><span id="l2.8">   nsMsgKey mLastMessageLoaded;</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10">   nsCOMPtr &lt;nsIMsgDBHdr&gt; m_offlineHeader;</span>
<a href="#l2.11"></a><span id="l2.11">   PRInt32 m_numOfflineMsgLines;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  PRInt32 m_bytesAddedToLocalMsg;</span>
<a href="#l2.13"></a><span id="l2.13">   // this is currently used when we do a save as of an imap or news message..</span>
<a href="#l2.14"></a><span id="l2.14">   nsCOMPtr&lt;nsIOutputStream&gt; m_tempMessageStream;</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16">   nsCOMPtr &lt;nsIMsgRetentionSettings&gt; m_retentionSettings;</span>
<a href="#l2.17"></a><span id="l2.17">   nsCOMPtr &lt;nsIMsgDownloadSettings&gt; m_downloadSettings;</span>
<a href="#l2.18"></a><span id="l2.18">   static NS_MSG_BASE_STATIC_MEMBER_(nsIAtom*) mFolderLoadedAtom;</span>
<a href="#l2.19"></a><span id="l2.19">   static NS_MSG_BASE_STATIC_MEMBER_(nsIAtom*) mDeleteOrMoveMsgCompletedAtom;</span>
<a href="#l2.20"></a><span id="l2.20">   static NS_MSG_BASE_STATIC_MEMBER_(nsIAtom*) mDeleteOrMoveMsgFailedAtom;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapMessageSink.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapMessageSink.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -36,32 +36,39 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;MailNewsTypes2.idl&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsIImapUrl.idl&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> interface nsIMsgMailNewsUrl;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-[scriptable, uuid(F9D64900-F83B-4265-A774-C1E7006C7EC4)]</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+[scriptable, uuid(33694e58-458b-4bbd-afbf-96d06f90676b)]</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15"> interface nsIImapMessageSink : nsISupports {</span>
<a href="#l3.16"></a><span id="l3.16">   // set up messge download output stream</span>
<a href="#l3.17"></a><span id="l3.17">   void setupMsgWriteStream(in nsIFile aFile, in boolean aAppendDummyEnvelope);</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-  void parseAdoptedMsgLine(in string aAdoptedMsgLine, in nsMsgKey aUidOfMsg);</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-    </span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-  void normalEndMsgWriteStream(in nsMsgKey aUidOfMessage, in boolean aMarkMsgRead, in nsIImapUrl aImapUrl);</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-    </span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+  /**</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+   * Used by the imap protocol code to notify the core backend code about</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+   * downloaded imap messages.</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+   *</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+   * @param aAdoptedMsgLine  a string with a lot of message lines,</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+   *                         separated by native line terminators.</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+   * @param aUidOfMsg        IMAP UID of the fetched message.</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+   * @param aImapUrl         IMAP Url used to fetch the message.</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+   */</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  void parseAdoptedMsgLine(in string aAdoptedMsgLine, in nsMsgKey aUidOfMsg,</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+                           in nsIImapUrl aImapUrl);</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+  void normalEndMsgWriteStream(in nsMsgKey aUidOfMessage,</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+                               in boolean aMarkMsgRead, in nsIImapUrl aImapUrl);</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+</span>
<a href="#l3.38"></a><span id="l3.38">   void abortMsgWriteStream();</span>
<a href="#l3.39"></a><span id="l3.39"> </span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-  attribute boolean notifyDownloadedLines;  // imap protocol doesn't notify message sink of downloaded</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-                                  // lines when it has a channelListener. This forces it to,</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-                                  // even if there is a channel listener.</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-</span>
<a href="#l3.44"></a><span id="l3.44">   void beginMessageUpload();</span>
<a href="#l3.45"></a><span id="l3.45"> </span>
<a href="#l3.46"></a><span id="l3.46">   /**</span>
<a href="#l3.47"></a><span id="l3.47">    *  Notify the message sink that one or more flags have changed</span>
<a href="#l3.48"></a><span id="l3.48">    *  For Condstore servers, also update the highestMod Sequence</span>
<a href="#l3.49"></a><span id="l3.49">    *  @param   aFlags         - The new flags for the message</span>
<a href="#l3.50"></a><span id="l3.50">    *  @param   aMessageKey    - The UID of the message that changed</span>
<a href="#l3.51"></a><span id="l3.51">    *  @param   aHighestModSeq - The highest mod seq the parser has seen</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapUrl.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapUrl.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -55,17 +55,17 @@ typedef long nsImapContentModifiedType;</span>
<a href="#l4.4"></a><span id="l4.4"> interface nsImapContentModifiedTypes</span>
<a href="#l4.5"></a><span id="l4.5"> {</span>
<a href="#l4.6"></a><span id="l4.6">   const long IMAP_CONTENT_NOT_MODIFIED = 0;</span>
<a href="#l4.7"></a><span id="l4.7">   const long IMAP_CONTENT_MODIFIED_VIEW_INLINE = 1;</span>
<a href="#l4.8"></a><span id="l4.8">   const long IMAP_CONTENT_MODIFIED_VIEW_AS_LINKS = 2;</span>
<a href="#l4.9"></a><span id="l4.9">   const long IMAP_CONTENT_FORCE_CONTENT_NOT_MODIFIED = 3;</span>
<a href="#l4.10"></a><span id="l4.10"> } ;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-[scriptable, uuid(1d1b0a42-af5e-40fa-a0d4-2455179083ce)]</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+[scriptable, uuid(2a85ea47-480b-4ed7-97ec-d96baa3f94ef)]</span>
<a href="#l4.14"></a><span id="l4.14"> interface nsIImapUrl : nsISupports</span>
<a href="#l4.15"></a><span id="l4.15"> {</span>
<a href="#l4.16"></a><span id="l4.16">   ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l4.17"></a><span id="l4.17">   // Getters and Setters for the imap specific event sinks to bind to to the url</span>
<a href="#l4.18"></a><span id="l4.18">   ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l4.19"></a><span id="l4.19">   attribute nsIImapMailFolderSink imapMailFolderSink;</span>
<a href="#l4.20"></a><span id="l4.20">   attribute nsIImapMessageSink imapMessageSink;</span>
<a href="#l4.21"></a><span id="l4.21">   attribute nsIImapServerSink imapServerSink;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -102,19 +102,30 @@ interface nsIImapUrl : nsISupports</span>
<a href="#l4.23"></a><span id="l4.23">   attribute nsImapContentModifiedType contentModified;</span>
<a href="#l4.24"></a><span id="l4.24">   attribute boolean fetchPartsOnDemand;  // set to true if we're fetching a msg for display and want to not download parts</span>
<a href="#l4.25"></a><span id="l4.25">   attribute boolean msgLoadingFromCache; // true if this msg load is coming from a cache, so we can know to mark it read</span>
<a href="#l4.26"></a><span id="l4.26">   attribute boolean externalLinkUrl; // true if we ran this url because the user clicked on a link.</span>
<a href="#l4.27"></a><span id="l4.27">   attribute boolean validUrl; // false if we couldn't parse url for whatever reason.</span>
<a href="#l4.28"></a><span id="l4.28">   attribute nsISupports copyState;</span>
<a href="#l4.29"></a><span id="l4.29">   attribute nsIFile msgFile;</span>
<a href="#l4.30"></a><span id="l4.30">   attribute nsIImapMockChannel mockChannel;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  attribute boolean shouldStoreMsgOffline; // set to true if we should store the msg for offline use if we can,</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-                                           // i.e., we're not doing mime parts on demand.</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-  attribute boolean rerunningUrl; // server disconnected first time so we're retrying</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+  /**</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+   * Set to true if we should store the msg(s) for offline use if we can,</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+   * e.g., we're fetching a message and the folder is configured for offline</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+   * use and we're not doing mime parts on demand.</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+   */</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  attribute boolean storeResultsOffline;</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+  /**</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+   * If we fallback from fetching by parts to fetching the whole message,</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+   *  because all the parts were inline, this tells us we should store</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+   * the message offline.</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+   */</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+  attribute boolean storeOfflineOnFallback;</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+  /// Server disconnected first time so we're retrying.</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+  attribute boolean rerunningUrl;</span>
<a href="#l4.48"></a><span id="l4.48"> </span>
<a href="#l4.49"></a><span id="l4.49">   /**</span>
<a href="#l4.50"></a><span id="l4.50">    * @{</span>
<a href="#l4.51"></a><span id="l4.51">    * This is used to tell the runner of the url more about the status of</span>
<a href="#l4.52"></a><span id="l4.52">    * the command, beyond whether it was successful or not. For example,</span>
<a href="#l4.53"></a><span id="l4.53">    * subtracting flags from a UID that doesn't exist isn't an error</span>
<a href="#l4.54"></a><span id="l4.54">    * (the server returns OK), but the backend code may want to know about it.</span>
<a href="#l4.55"></a><span id="l4.55">    */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -214,17 +214,16 @@ nsImapMailFolder::nsImapMailFolder() :</span>
<a href="#l5.4"></a><span id="l5.4">     m_folderIsNamespace(PR_FALSE),</span>
<a href="#l5.5"></a><span id="l5.5">     m_folderNeedsSubscribing(PR_FALSE),</span>
<a href="#l5.6"></a><span id="l5.6">     m_folderNeedsAdded(PR_FALSE),</span>
<a href="#l5.7"></a><span id="l5.7">     m_folderNeedsACLListed(PR_TRUE),</span>
<a href="#l5.8"></a><span id="l5.8">     m_performingBiff(PR_FALSE),</span>
<a href="#l5.9"></a><span id="l5.9">     m_folderQuotaCommandIssued(PR_FALSE),</span>
<a href="#l5.10"></a><span id="l5.10">     m_folderQuotaDataIsValid(PR_FALSE),</span>
<a href="#l5.11"></a><span id="l5.11">     m_updatingFolder(PR_FALSE),</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    m_downloadMessageForOfflineUse(PR_FALSE),</span>
<a href="#l5.13"></a><span id="l5.13">     m_downloadingFolderForOfflineUse(PR_FALSE),</span>
<a href="#l5.14"></a><span id="l5.14">     m_folderQuotaUsedKB(0),</span>
<a href="#l5.15"></a><span id="l5.15">     m_folderQuotaMaxKB(0),</span>
<a href="#l5.16"></a><span id="l5.16">     m_applyIncomingFilters(PR_FALSE)</span>
<a href="#l5.17"></a><span id="l5.17"> {</span>
<a href="#l5.18"></a><span id="l5.18">   MOZ_COUNT_CTOR(nsImapMailFolder); // double count these for now.</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20">   if (mImapHdrDownloadedAtom == nsnull)</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -4213,77 +4212,63 @@ NS_IMETHODIMP nsImapMailFolder::Download</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23">     rv = AcquireSemaphore(static_cast&lt;nsIMsgImapMailFolder*&gt;(this));</span>
<a href="#l5.24"></a><span id="l5.24">     if (NS_FAILED(rv))</span>
<a href="#l5.25"></a><span id="l5.25">     {</span>
<a href="#l5.26"></a><span id="l5.26">       m_downloadingFolderForOfflineUse = PR_FALSE;</span>
<a href="#l5.27"></a><span id="l5.27">       ThrowAlertMsg(&quot;operationFailedFolderBusy&quot;, msgWindow);</span>
<a href="#l5.28"></a><span id="l5.28">       return rv;</span>
<a href="#l5.29"></a><span id="l5.29">     }</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-    SetNotifyDownloadedLines(PR_TRUE);</span>
<a href="#l5.31"></a><span id="l5.31">     nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-    // selecting the folder with m_downloadingFolderForOfflineUse true will cause</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-    // us to fetch any message bodies we don't have.</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-    rv = imapService-&gt;SelectFolder(m_thread, this, listener, msgWindow, nsnull);</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+    // Selecting the folder with nsIImapUrl::shouldStoreMsgOffline true will</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+    // cause us to fetch any message bodies we don't have.</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+    rv = imapService-&gt;SelectFolder(m_thread, this, listener, msgWindow,</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+                                   getter_AddRefs(runningURI));</span>
<a href="#l5.43"></a><span id="l5.43">     if (NS_SUCCEEDED(rv))</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+    {</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+      nsCOMPtr&lt;nsIImapUrl&gt; imapUrl(do_QueryInterface(runningURI));</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+      if (imapUrl)</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+        imapUrl-&gt;SetStoreResultsOffline(PR_TRUE);</span>
<a href="#l5.48"></a><span id="l5.48">       m_urlRunning = PR_TRUE;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+    }</span>
<a href="#l5.50"></a><span id="l5.50">   }</span>
<a href="#l5.51"></a><span id="l5.51">   else</span>
<a href="#l5.52"></a><span id="l5.52">     rv = NS_MSG_FOLDER_UNREADABLE;</span>
<a href="#l5.53"></a><span id="l5.53">   return rv;</span>
<a href="#l5.54"></a><span id="l5.54"> }</span>
<a href="#l5.55"></a><span id="l5.55"> </span>
<a href="#l5.56"></a><span id="l5.56"> NS_IMETHODIMP</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-nsImapMailFolder::GetNotifyDownloadedLines(PRBool *notifyDownloadedLines)</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-{</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-  NS_ENSURE_ARG(notifyDownloadedLines);</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-  *notifyDownloadedLines = m_downloadMessageForOfflineUse;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-  return NS_OK;</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-}</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-nsImapMailFolder::SetNotifyDownloadedLines(PRBool notifyDownloadedLines)</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-{</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-  // ignore this if we're downloading the whole folder and someone says</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-  // to turn off downloading for offline use, which can happen if a 3rd party</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-  // app tries to stream a message while we're downloading for offline use.</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-  if (!notifyDownloadedLines &amp;&amp; m_downloadingFolderForOfflineUse)</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-  m_downloadMessageForOfflineUse = notifyDownloadedLines;</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-  return NS_OK;</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-}</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-nsImapMailFolder::ParseAdoptedMsgLine(const char *adoptedMessageLine, nsMsgKey uidOfMessage)</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-{</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+nsImapMailFolder::ParseAdoptedMsgLine(const char *adoptedMessageLine,</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+                                      nsMsgKey uidOfMessage,</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+                                      nsIImapUrl *aImapUrl)</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+{</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImapUrl);</span>
<a href="#l5.84"></a><span id="l5.84">   PRUint32 count = 0;</span>
<a href="#l5.85"></a><span id="l5.85">   nsresult rv;</span>
<a href="#l5.86"></a><span id="l5.86">   // remember the uid of the message we're downloading.</span>
<a href="#l5.87"></a><span id="l5.87">   m_curMsgUid = uidOfMessage;</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-  if (m_downloadMessageForOfflineUse &amp;&amp; !m_offlineHeader)</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+  if (!m_offlineHeader)</span>
<a href="#l5.90"></a><span id="l5.90">   {</span>
<a href="#l5.91"></a><span id="l5.91">     GetMessageHeader(uidOfMessage, getter_AddRefs(m_offlineHeader));</span>
<a href="#l5.92"></a><span id="l5.92">     rv = StartNewOfflineMessage();</span>
<a href="#l5.93"></a><span id="l5.93">   }</span>
<a href="#l5.94"></a><span id="l5.94">   // adoptedMessageLine is actually a string with a lot of message lines, separated by native line terminators</span>
<a href="#l5.95"></a><span id="l5.95">   // we need to count the number of MSG_LINEBREAK's to determine how much to increment m_numOfflineMsgLines by.</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-  if (m_downloadMessageForOfflineUse)</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-  {</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-    const char *nextLine = adoptedMessageLine;</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-    do</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-    {</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-      m_numOfflineMsgLines++;</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-      nextLine = PL_strstr(nextLine, MSG_LINEBREAK);</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-      if (nextLine)</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-        nextLine += MSG_LINEBREAK_LEN;</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineminus">-    }</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-    while (nextLine &amp;&amp; *nextLine);</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineminus">-  }</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+  const char *nextLine = adoptedMessageLine;</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+  do</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+  {</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+    m_numOfflineMsgLines++;</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+    nextLine = PL_strstr(nextLine, MSG_LINEBREAK);</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+    if (nextLine)</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+      nextLine += MSG_LINEBREAK_LEN;</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+  }</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+  while (nextLine &amp;&amp; *nextLine);</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+</span>
<a href="#l5.118"></a><span id="l5.118">   if (m_tempMessageStream)</span>
<a href="#l5.119"></a><span id="l5.119">   {</span>
<a href="#l5.120"></a><span id="l5.120">     nsCOMPtr &lt;nsISeekableStream&gt; seekable (do_QueryInterface(m_tempMessageStream));</span>
<a href="#l5.121"></a><span id="l5.121">     if (seekable)</span>
<a href="#l5.122"></a><span id="l5.122">       seekable-&gt;Seek(PR_SEEK_END, 0);</span>
<a href="#l5.123"></a><span id="l5.123">     rv = m_tempMessageStream-&gt;Write(adoptedMessageLine,</span>
<a href="#l5.124"></a><span id="l5.124">                 PL_strlen(adoptedMessageLine), &amp;count);</span>
<a href="#l5.125"></a><span id="l5.125">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineat">@@ -4767,20 +4752,23 @@ nsImapMailFolder::OnStartRunningUrl(nsIU</span>
<a href="#l5.127"></a><span id="l5.127"> </span>
<a href="#l5.128"></a><span id="l5.128"> NS_IMETHODIMP</span>
<a href="#l5.129"></a><span id="l5.129"> nsImapMailFolder::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode)</span>
<a href="#l5.130"></a><span id="l5.130"> {</span>
<a href="#l5.131"></a><span id="l5.131">   nsresult rv;</span>
<a href="#l5.132"></a><span id="l5.132">   PRBool endedOfflineDownload = PR_FALSE;</span>
<a href="#l5.133"></a><span id="l5.133">   m_urlRunning = PR_FALSE;</span>
<a href="#l5.134"></a><span id="l5.134">   m_updatingFolder = PR_FALSE;</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-  if (m_downloadingFolderForOfflineUse)</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+  nsCOMPtr &lt;nsIImapUrl&gt; imapUrl = do_QueryInterface(aUrl, &amp;rv);</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+  PRBool downloadingForOfflineUse;</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+  imapUrl-&gt;GetStoreResultsOffline(&amp;downloadingForOfflineUse);</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+  if (downloadingForOfflineUse)</span>
<a href="#l5.141"></a><span id="l5.141">   {</span>
<a href="#l5.142"></a><span id="l5.142">     ReleaseSemaphore(static_cast&lt;nsIMsgImapMailFolder*&gt;(this));</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-    m_downloadingFolderForOfflineUse = PR_FALSE;</span>
<a href="#l5.144"></a><span id="l5.144">     endedOfflineDownload = PR_TRUE;</span>
<a href="#l5.145"></a><span id="l5.145">     EndOfflineDownload();</span>
<a href="#l5.146"></a><span id="l5.146">   }</span>
<a href="#l5.147"></a><span id="l5.147">   nsCOMPtr&lt;nsIMsgMailSession&gt; session = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l5.148"></a><span id="l5.148">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.149"></a><span id="l5.149">   if (aUrl)</span>
<a href="#l5.150"></a><span id="l5.150">   {</span>
<a href="#l5.151"></a><span id="l5.151">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineat">@@ -4800,17 +4788,16 @@ nsImapMailFolder::OnStopRunningUrl(nsIUR</span>
<a href="#l5.153"></a><span id="l5.153">    if (imapUrl)</span>
<a href="#l5.154"></a><span id="l5.154">    {</span>
<a href="#l5.155"></a><span id="l5.155">       DisplayStatusMsg(imapUrl, EmptyString());</span>
<a href="#l5.156"></a><span id="l5.156">       nsImapAction imapAction = nsIImapUrl::nsImapTest;</span>
<a href="#l5.157"></a><span id="l5.157">       imapUrl-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l5.158"></a><span id="l5.158">       if (imapAction == nsIImapUrl::nsImapMsgFetch || imapAction == nsIImapUrl::nsImapMsgDownloadForOffline)</span>
<a href="#l5.159"></a><span id="l5.159">       {</span>
<a href="#l5.160"></a><span id="l5.160">         ReleaseSemaphore(static_cast&lt;nsIMsgImapMailFolder*&gt;(this));</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-        SetNotifyDownloadedLines(PR_FALSE);</span>
<a href="#l5.162"></a><span id="l5.162">         if (!endedOfflineDownload)</span>
<a href="#l5.163"></a><span id="l5.163">           EndOfflineDownload();</span>
<a href="#l5.164"></a><span id="l5.164">       }</span>
<a href="#l5.165"></a><span id="l5.165"> </span>
<a href="#l5.166"></a><span id="l5.166">       // Notify move, copy or delete (online operations)</span>
<a href="#l5.167"></a><span id="l5.167">       // Not sure whether nsImapDeleteMsg is even used, deletes in all three models use nsImapAddMsgFlags.</span>
<a href="#l5.168"></a><span id="l5.168">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l5.169"></a><span id="l5.169">       if (notifier &amp;&amp; m_copyState)</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineat">@@ -5386,20 +5373,18 @@ nsImapMailFolder::HeaderFetchCompleted(n</span>
<a href="#l5.171"></a><span id="l5.171">     PRBool notifiedBodies = PR_FALSE;</span>
<a href="#l5.172"></a><span id="l5.172">     if (m_downloadingFolderForOfflineUse || autoSyncOfflineStores ||</span>
<a href="#l5.173"></a><span id="l5.173">         autoDownloadNewHeaders)</span>
<a href="#l5.174"></a><span id="l5.174">     {</span>
<a href="#l5.175"></a><span id="l5.175">       nsTArray&lt;nsMsgKey&gt; keysToDownload;</span>
<a href="#l5.176"></a><span id="l5.176">       GetBodysToDownload(&amp;keysToDownload);</span>
<a href="#l5.177"></a><span id="l5.177">       if (!keysToDownload.IsEmpty())</span>
<a href="#l5.178"></a><span id="l5.178">       {</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-        SetNotifyDownloadedLines(PR_TRUE);</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-</span>
<a href="#l5.181"></a><span id="l5.181">         // this is the case when DownloadAllForOffline is called.</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineminus">-        if (m_downloadingFolderForOfflineUse)</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+        if (m_downloadingFolderForOfflineUse || autoDownloadNewHeaders)</span>
<a href="#l5.184"></a><span id="l5.184">         {</span>
<a href="#l5.185"></a><span id="l5.185">           notifiedBodies = PR_TRUE;</span>
<a href="#l5.186"></a><span id="l5.186">           aProtocol-&gt;NotifyBodysToDownload(keysToDownload.Elements(), keysToDownload.Length());</span>
<a href="#l5.187"></a><span id="l5.187">         }</span>
<a href="#l5.188"></a><span id="l5.188">         else</span>
<a href="#l5.189"></a><span id="l5.189">         {</span>
<a href="#l5.190"></a><span id="l5.190">           // create auto-sync state object lazily</span>
<a href="#l5.191"></a><span id="l5.191">           InitAutoSyncState();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -501,17 +501,16 @@ protected:</span>
<a href="#l6.4"></a><span id="l6.4">   PRPackedBool m_applyIncomingFilters; // apply filters to this folder, even if not the inbox</span>
<a href="#l6.5"></a><span id="l6.5">   nsMsgIMAPFolderACL *m_folderACL;</span>
<a href="#l6.6"></a><span id="l6.6">   PRUint32     m_aclFlags;</span>
<a href="#l6.7"></a><span id="l6.7">   PRUint32     m_supportedUserFlags;</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9">   static nsIAtom* mImapHdrDownloadedAtom;</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">   // offline imap support</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  PRBool m_downloadMessageForOfflineUse;</span>
<a href="#l6.13"></a><span id="l6.13">   PRBool m_downloadingFolderForOfflineUse;</span>
<a href="#l6.14"></a><span id="l6.14">   </span>
<a href="#l6.15"></a><span id="l6.15">   // auto-sync (preemptive download) support</span>
<a href="#l6.16"></a><span id="l6.16">   nsRefPtr&lt;nsAutoSyncState&gt; m_autoSyncStateObj;</span>
<a href="#l6.17"></a><span id="l6.17">   </span>
<a href="#l6.18"></a><span id="l6.18">   // Quota support</span>
<a href="#l6.19"></a><span id="l6.19">   nsCString m_folderQuotaRoot;</span>
<a href="#l6.20"></a><span id="l6.20">   PRUint32 m_folderQuotaUsedKB;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -2373,16 +2373,17 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l7.4"></a><span id="l7.4">             SetProgressString(IMAP_FOLDER_RECEIVING_MESSAGE_OF);</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6">             m_progressIndex = 0;</span>
<a href="#l7.7"></a><span id="l7.7">             m_progressCount = CountMessagesInIdString(messageIdString.get());</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9">             // we need to set this so we'll get the msg from the memory cache.</span>
<a href="#l7.10"></a><span id="l7.10">             if (m_imapAction == nsIImapUrl::nsImapMsgFetchPeek)</span>
<a href="#l7.11"></a><span id="l7.11">               SetContentModified(IMAP_CONTENT_NOT_MODIFIED);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+</span>
<a href="#l7.13"></a><span id="l7.13">             FetchMessage(messageIdString,</span>
<a href="#l7.14"></a><span id="l7.14">               (m_imapAction == nsIImapUrl::nsImapMsgPreview)</span>
<a href="#l7.15"></a><span id="l7.15">               ? kBodyStart : kEveryThingRFC822Peek);</span>
<a href="#l7.16"></a><span id="l7.16">             if (m_imapAction == nsIImapUrl::nsImapMsgPreview)</span>
<a href="#l7.17"></a><span id="l7.17">               HeaderFetchCompleted();</span>
<a href="#l7.18"></a><span id="l7.18">             SetProgressString(0);</span>
<a href="#l7.19"></a><span id="l7.19">           }</span>
<a href="#l7.20"></a><span id="l7.20">           else</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineat">@@ -2449,40 +2450,41 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l7.22"></a><span id="l7.22">               // need to set a flag in the url, I guess, equiv to allow_content_changed.</span>
<a href="#l7.23"></a><span id="l7.23">               PRBool allowedToBreakApart = PR_TRUE; // (ce  &amp;&amp; !DeathSignalReceived()) ? ce-&gt;URL_s-&gt;allow_content_change : PR_FALSE;</span>
<a href="#l7.24"></a><span id="l7.24">               PRBool mimePartSelectorDetected;</span>
<a href="#l7.25"></a><span id="l7.25">               PRBool urlOKToFetchByParts = PR_FALSE;</span>
<a href="#l7.26"></a><span id="l7.26">               m_runningUrl-&gt;GetMimePartSelectorDetected(&amp;mimePartSelectorDetected);</span>
<a href="#l7.27"></a><span id="l7.27">               m_runningUrl-&gt;GetFetchPartsOnDemand(&amp;urlOKToFetchByParts);</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29">               if (urlOKToFetchByParts &amp;&amp;</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-                allowedToBreakApart &amp;&amp;</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-                !GetShouldFetchAllParts() &amp;&amp;</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-                GetServerStateParser().ServerHasIMAP4Rev1Capability() /* &amp;&amp;</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+                  allowedToBreakApart &amp;&amp;</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+                  !GetShouldFetchAllParts() &amp;&amp;</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+                  GetServerStateParser().ServerHasIMAP4Rev1Capability() /* &amp;&amp;</span>
<a href="#l7.36"></a><span id="l7.36">                 !mimePartSelectorDetected */)  // if a ?part=, don't do BS.</span>
<a href="#l7.37"></a><span id="l7.37">               {</span>
<a href="#l7.38"></a><span id="l7.38">                 // OK, we're doing bodystructure</span>
<a href="#l7.39"></a><span id="l7.39"> </span>
<a href="#l7.40"></a><span id="l7.40">                 // Before fetching the bodystructure, let's check our body shell cache to see if</span>
<a href="#l7.41"></a><span id="l7.41">                 // we already have it around.</span>
<a href="#l7.42"></a><span id="l7.42">                 nsIMAPBodyShell *foundShell = NULL;</span>
<a href="#l7.43"></a><span id="l7.43">                 IMAP_ContentModifiedType modType = GetShowAttachmentsInline() ?</span>
<a href="#l7.44"></a><span id="l7.44">                   IMAP_CONTENT_MODIFIED_VIEW_INLINE :</span>
<a href="#l7.45"></a><span id="l7.45">                   IMAP_CONTENT_MODIFIED_VIEW_AS_LINKS ;</span>
<a href="#l7.46"></a><span id="l7.46"> </span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+                PRBool wasStoringMsgOffline;</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+                m_runningUrl-&gt;GetStoreResultsOffline(&amp;wasStoringMsgOffline);</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+                m_runningUrl-&gt;SetStoreOfflineOnFallback(wasStoringMsgOffline);</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+                m_runningUrl-&gt;SetStoreResultsOffline(PR_FALSE);</span>
<a href="#l7.51"></a><span id="l7.51">                 nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailurl = do_QueryInterface(m_runningUrl);</span>
<a href="#l7.52"></a><span id="l7.52">                 if (mailurl)</span>
<a href="#l7.53"></a><span id="l7.53">                 {</span>
<a href="#l7.54"></a><span id="l7.54">                   mailurl-&gt;SetAddToMemoryCache(PR_FALSE);</span>
<a href="#l7.55"></a><span id="l7.55">                   // need to proxy this over to the ui thread</span>
<a href="#l7.56"></a><span id="l7.56">                   if (m_imapMessageSink)</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-                  {</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-                    m_imapMessageSink-&gt;SetNotifyDownloadedLines(PR_FALSE);</span>
<a href="#l7.59"></a><span id="l7.59">                     m_imapMessageSink-&gt;SetImageCacheSessionForUrl(mailurl);</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-                  }</span>
<a href="#l7.61"></a><span id="l7.61"> </span>
<a href="#l7.62"></a><span id="l7.62">                 }</span>
<a href="#l7.63"></a><span id="l7.63">                 SetContentModified(modType);  // This will be looked at by the cache</span>
<a href="#l7.64"></a><span id="l7.64">                 if (bMessageIdsAreUids)</span>
<a href="#l7.65"></a><span id="l7.65">                 {</span>
<a href="#l7.66"></a><span id="l7.66">                   res = m_hostSessionList-&gt;FindShellInCacheForHost(GetImapServerKey(),</span>
<a href="#l7.67"></a><span id="l7.67">                     GetServerStateParser().GetSelectedMailboxName(), messageIdString.get(), modType, &amp;foundShell);</span>
<a href="#l7.68"></a><span id="l7.68">                   if (foundShell)</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineat">@@ -3159,19 +3161,18 @@ void nsImapProtocol::FetchMsgAttribute(c</span>
<a href="#l7.70"></a><span id="l7.70"> // this routine is used to fetch a message or messages, or headers for a</span>
<a href="#l7.71"></a><span id="l7.71"> // message...</span>
<a href="#l7.72"></a><span id="l7.72"> </span>
<a href="#l7.73"></a><span id="l7.73"> void nsImapProtocol::FallbackToFetchWholeMsg(const nsCString &amp;messageId, PRUint32 messageSize)</span>
<a href="#l7.74"></a><span id="l7.74"> {</span>
<a href="#l7.75"></a><span id="l7.75">   if (m_imapMessageSink &amp;&amp; m_runningUrl)</span>
<a href="#l7.76"></a><span id="l7.76">   {</span>
<a href="#l7.77"></a><span id="l7.77">     PRBool shouldStoreMsgOffline;</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-    m_runningUrl-&gt;GetShouldStoreMsgOffline(&amp;shouldStoreMsgOffline);</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-    if (shouldStoreMsgOffline)</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-      m_imapMessageSink-&gt;SetNotifyDownloadedLines(PR_TRUE);</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+    m_runningUrl-&gt;GetStoreOfflineOnFallback(&amp;shouldStoreMsgOffline);</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+    m_runningUrl-&gt;SetStoreResultsOffline(shouldStoreMsgOffline);</span>
<a href="#l7.83"></a><span id="l7.83">   }</span>
<a href="#l7.84"></a><span id="l7.84">   FetchTryChunking(messageId, kEveryThingRFC822, PR_TRUE, NULL, messageSize, PR_TRUE);</span>
<a href="#l7.85"></a><span id="l7.85"> }</span>
<a href="#l7.86"></a><span id="l7.86"> </span>
<a href="#l7.87"></a><span id="l7.87"> void</span>
<a href="#l7.88"></a><span id="l7.88"> nsImapProtocol::FetchMessage(const nsCString &amp;messageIds, </span>
<a href="#l7.89"></a><span id="l7.89">                              nsIMAPeFetchFields whatToFetch,</span>
<a href="#l7.90"></a><span id="l7.90">                              const char *fetchModifier,</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineat">@@ -3571,25 +3572,22 @@ nsImapProtocol::PostLineDownLoadEvent(co</span>
<a href="#l7.92"></a><span id="l7.92">       if (m_channelOutputStream)</span>
<a href="#l7.93"></a><span id="l7.93">       {</span>
<a href="#l7.94"></a><span id="l7.94">         nsresult rv = m_channelOutputStream-&gt;Write(line, PL_strlen(line), &amp;count);</span>
<a href="#l7.95"></a><span id="l7.95">         if (NS_SUCCEEDED(rv))</span>
<a href="#l7.96"></a><span id="l7.96">         {</span>
<a href="#l7.97"></a><span id="l7.97">           nsCOMPtr&lt;nsIRequest&gt; request = do_QueryInterface(m_mockChannel);</span>
<a href="#l7.98"></a><span id="l7.98">           m_channelListener-&gt;OnDataAvailable(request, m_channelContext, m_channelInputStream, 0, count);</span>
<a href="#l7.99"></a><span id="l7.99">         }</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-          // here is where we should echo the line to the local folder copy of an online message</span>
<a href="#l7.101"></a><span id="l7.101">       }</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-      if (m_imapMessageSink)</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-        m_imapMessageSink-&gt;GetNotifyDownloadedLines(&amp;echoLineToMessageSink);</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+      if (m_runningUrl)</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+        m_runningUrl-&gt;GetStoreResultsOffline(&amp;echoLineToMessageSink);</span>
<a href="#l7.106"></a><span id="l7.106">     }</span>
<a href="#l7.107"></a><span id="l7.107">     if (m_imapMessageSink &amp;&amp; line &amp;&amp; echoLineToMessageSink &amp;&amp; !GetPseudoInterrupted())</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-    {</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-      m_imapMessageSink-&gt;ParseAdoptedMsgLine(line, uidOfMessage);</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-    }</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+      m_imapMessageSink-&gt;ParseAdoptedMsgLine(line, uidOfMessage, m_runningUrl);</span>
<a href="#l7.112"></a><span id="l7.112">   }</span>
<a href="#l7.113"></a><span id="l7.113">   // ***** We need to handle the pseudo interrupt here *****</span>
<a href="#l7.114"></a><span id="l7.114"> }</span>
<a href="#l7.115"></a><span id="l7.115"> </span>
<a href="#l7.116"></a><span id="l7.116"> // Handle a line seen by the parser.</span>
<a href="#l7.117"></a><span id="l7.117"> // * The argument |lineCopy| must be nsnull or should contain the same string as</span>
<a href="#l7.118"></a><span id="l7.118"> //   |line|.  |lineCopy| will be modified.</span>
<a href="#l7.119"></a><span id="l7.119"> // * A line may be passed by parts, e.g., &quot;part1 part2\r\n&quot; may be passed as</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -525,17 +525,17 @@ NS_IMETHODIMP nsImapService::DisplayMess</span>
<a href="#l8.4"></a><span id="l8.4">       PRBool useMimePartsOnDemand = gMIMEOnDemand;</span>
<a href="#l8.5"></a><span id="l8.5">       PRBool shouldStoreMsgOffline = PR_FALSE;</span>
<a href="#l8.6"></a><span id="l8.6">       PRBool hasMsgOffline = PR_FALSE;</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; aMsgIncomingServer;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10">       if (imapMessageSink)</span>
<a href="#l8.11"></a><span id="l8.11">         imapMessageSink-&gt;GetMessageSizeFromDB(msgKey.get(), &amp;messageSize);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-      </span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+</span>
<a href="#l8.14"></a><span id="l8.14">       msgurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16">       rv = msgurl-&gt;GetServer(getter_AddRefs(aMsgIncomingServer));</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18">       if (NS_SUCCEEDED(rv) &amp;&amp; aMsgIncomingServer)</span>
<a href="#l8.19"></a><span id="l8.19">       {</span>
<a href="#l8.20"></a><span id="l8.20">         nsCOMPtr&lt;nsIImapIncomingServer&gt; aImapServer(do_QueryInterface(aMsgIncomingServer, &amp;rv));</span>
<a href="#l8.21"></a><span id="l8.21">         if (NS_SUCCEEDED(rv) &amp;&amp; aImapServer)</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -553,38 +553,20 @@ NS_IMETHODIMP nsImapService::DisplayMess</span>
<a href="#l8.23"></a><span id="l8.23">           useMimePartsOnDemand = PR_FALSE;</span>
<a href="#l8.24"></a><span id="l8.24">       }</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26">       if (folder)</span>
<a href="#l8.27"></a><span id="l8.27">       {</span>
<a href="#l8.28"></a><span id="l8.28">         folder-&gt;ShouldStoreMsgOffline(key, &amp;shouldStoreMsgOffline);</span>
<a href="#l8.29"></a><span id="l8.29">         folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l8.30"></a><span id="l8.30">       }</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-      if (!useMimePartsOnDemand || (messageSize &lt; (uint32) gMIMEOnDemandThreshold))</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-        //                allowedToBreakApart &amp;&amp; </span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-        //              !GetShouldFetchAllParts() &amp;&amp;</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-        //            GetServerStateParser().ServerHasIMAP4Rev1Capability() &amp;&amp;</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-      {</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-        imapUrl-&gt;SetFetchPartsOnDemand(PR_FALSE);</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-        // for now, lets try not adding these </span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-        msgurl-&gt;SetAddToMemoryCache(PR_TRUE);</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-      }</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-      else</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-      {</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-        // whenever we are displaying a message, we want to add it to the memory cache..</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-        imapUrl-&gt;SetFetchPartsOnDemand(PR_TRUE);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-        // if we happen to fetch the whole message, note in the url</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-        // whether we want to store this message offline.</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-        imapUrl-&gt;SetShouldStoreMsgOffline(shouldStoreMsgOffline);</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-        shouldStoreMsgOffline = PR_FALSE; // if we're fetching by parts, don't store offline</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-        msgurl-&gt;SetAddToMemoryCache(PR_FALSE);</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-      }</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-      if (imapMessageSink &amp;&amp; !hasMsgOffline)</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-        imapMessageSink-&gt;SetNotifyDownloadedLines(shouldStoreMsgOffline);</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+      imapUrl-&gt;SetStoreResultsOffline(shouldStoreMsgOffline);</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+      msgurl-&gt;SetAddToMemoryCache(!hasMsgOffline);</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+      imapUrl-&gt;SetFetchPartsOnDemand(</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+        useMimePartsOnDemand &amp;&amp; messageSize &gt;= (PRUint32) gMIMEOnDemandThreshold);</span>
<a href="#l8.57"></a><span id="l8.57"> </span>
<a href="#l8.58"></a><span id="l8.58">       if (hasMsgOffline)</span>
<a href="#l8.59"></a><span id="l8.59">         msgurl-&gt;SetMsgIsInLocalCache(PR_TRUE);</span>
<a href="#l8.60"></a><span id="l8.60"> </span>
<a href="#l8.61"></a><span id="l8.61">       nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l8.62"></a><span id="l8.62">       // Should the message fetch force a peek or a traditional fetch?</span>
<a href="#l8.63"></a><span id="l8.63">       // Force peek if there is a delay in marking read (or no auto-marking at all).</span>
<a href="#l8.64"></a><span id="l8.64">       // This is because a FETCH (BODY[]) will implicitly set tha \Seen flag on the msg,</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineat">@@ -615,28 +597,26 @@ nsresult nsImapService::FetchMimePart(ns</span>
<a href="#l8.66"></a><span id="l8.66">                                       nsIURI **aURL,</span>
<a href="#l8.67"></a><span id="l8.67">                                       nsISupports *aDisplayConsumer, </span>
<a href="#l8.68"></a><span id="l8.68">                                       const nsACString &amp;messageIdentifierList,</span>
<a href="#l8.69"></a><span id="l8.69">                                       const nsACString &amp;mimePart) </span>
<a href="#l8.70"></a><span id="l8.70"> {</span>
<a href="#l8.71"></a><span id="l8.71">   NS_ENSURE_ARG_POINTER(aImapUrl);</span>
<a href="#l8.72"></a><span id="l8.72">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l8.73"></a><span id="l8.73">   NS_ENSURE_ARG_POINTER(aImapMessage);</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-  </span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+</span>
<a href="#l8.76"></a><span id="l8.76">   // create a protocol instance to handle the request.</span>
<a href="#l8.77"></a><span id="l8.77">   // NOTE: once we start working with multiple connections, this step will be much more complicated...but for now</span>
<a href="#l8.78"></a><span id="l8.78">   // just create a connection and process the request.</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-  </span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-  nsresult rv;</span>
<a href="#l8.81"></a><span id="l8.81">   nsCAutoString urlSpec;</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-  rv = SetImapUrlSink(aImapMailFolder, aImapUrl);</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+  nsresult rv = SetImapUrlSink(aImapMailFolder, aImapUrl);</span>
<a href="#l8.84"></a><span id="l8.84">   nsImapAction actionToUse = aImapAction;</span>
<a href="#l8.85"></a><span id="l8.85">   if (actionToUse == nsImapUrl::nsImapOpenMimePart)</span>
<a href="#l8.86"></a><span id="l8.86">     actionToUse = nsIImapUrl::nsImapMsgFetch;</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-  </span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+</span>
<a href="#l8.89"></a><span id="l8.89">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(aImapUrl));</span>
<a href="#l8.90"></a><span id="l8.90">   if (aImapMailFolder &amp;&amp; msgurl &amp;&amp; !messageIdentifierList.IsEmpty())</span>
<a href="#l8.91"></a><span id="l8.91">   {</span>
<a href="#l8.92"></a><span id="l8.92">     PRBool useLocalCache = PR_FALSE;</span>
<a href="#l8.93"></a><span id="l8.93">     aImapMailFolder-&gt;HasMsgOffline(atoi(nsCString(messageIdentifierList).get()), &amp;useLocalCache);</span>
<a href="#l8.94"></a><span id="l8.94">     msgurl-&gt;SetMsgIsInLocalCache(useLocalCache);</span>
<a href="#l8.95"></a><span id="l8.95">   }</span>
<a href="#l8.96"></a><span id="l8.96">   rv = aImapUrl-&gt;SetImapMessageSink(aImapMessage);</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineat">@@ -1233,19 +1213,17 @@ NS_IMETHODIMP nsImapService::StreamMessa</span>
<a href="#l8.98"></a><span id="l8.98">         }</span>
<a href="#l8.99"></a><span id="l8.99">       }</span>
<a href="#l8.100"></a><span id="l8.100"> </span>
<a href="#l8.101"></a><span id="l8.101">       imapUrl-&gt;SetFetchPartsOnDemand(PR_FALSE);</span>
<a href="#l8.102"></a><span id="l8.102">       msgurl-&gt;SetAddToMemoryCache(PR_TRUE);</span>
<a href="#l8.103"></a><span id="l8.103"> </span>
<a href="#l8.104"></a><span id="l8.104">       PRBool shouldStoreMsgOffline = PR_FALSE;</span>
<a href="#l8.105"></a><span id="l8.105">       folder-&gt;ShouldStoreMsgOffline(key, &amp;shouldStoreMsgOffline);</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-      if (imapMessageSink &amp;&amp; !hasMsgOffline)</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-        imapMessageSink-&gt;SetNotifyDownloadedLines(shouldStoreMsgOffline);</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-      </span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+      imapUrl-&gt;SetStoreResultsOffline(shouldStoreMsgOffline);</span>
<a href="#l8.110"></a><span id="l8.110">       rv = GetMessageFromUrl(imapUrl, nsIImapUrl::nsImapMsgFetchPeek, folder,</span>
<a href="#l8.111"></a><span id="l8.111">                              imapMessageSink, aMsgWindow, aConsumer,</span>
<a href="#l8.112"></a><span id="l8.112">                              aConvertData, aURL);</span>
<a href="#l8.113"></a><span id="l8.113">     }</span>
<a href="#l8.114"></a><span id="l8.114">   }</span>
<a href="#l8.115"></a><span id="l8.115">   return rv;</span>
<a href="#l8.116"></a><span id="l8.116"> }</span>
<a href="#l8.117"></a><span id="l8.117"> </span>
<a href="#l8.118"></a><span id="l8.118" class="difflineat">@@ -3226,24 +3204,27 @@ NS_IMETHODIMP nsImapService::DownloadMes</span>
<a href="#l8.119"></a><span id="l8.119">   char hierarchyDelimiter = GetHierarchyDelimiter(aFolder);</span>
<a href="#l8.120"></a><span id="l8.120">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aFolder, nsnull,</span>
<a href="#l8.121"></a><span id="l8.121">                             urlSpec, hierarchyDelimiter);</span>
<a href="#l8.122"></a><span id="l8.122">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l8.123"></a><span id="l8.123">   {</span>
<a href="#l8.124"></a><span id="l8.124">     nsCOMPtr&lt;nsIURI&gt; runningURI;</span>
<a href="#l8.125"></a><span id="l8.125">     // need to pass in stream listener in order to get the channel created correctly</span>
<a href="#l8.126"></a><span id="l8.126">     nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(do_QueryInterface(aFolder, &amp;rv));</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-    imapMessageSink-&gt;SetNotifyDownloadedLines(PR_TRUE);</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-    rv = FetchMessage(imapUrl, nsImapUrl::nsImapMsgDownloadForOffline,aFolder, imapMessageSink, </span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-                      aMsgWindow, nsnull, messageIds, PR_FALSE, EmptyCString(), getter_AddRefs(runningURI));</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+    rv = FetchMessage(imapUrl, nsImapUrl::nsImapMsgDownloadForOffline,aFolder,</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+                      imapMessageSink, aMsgWindow, nsnull, messageIds,</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+                      PR_FALSE, EmptyCString(), getter_AddRefs(runningURI));</span>
<a href="#l8.133"></a><span id="l8.133">     if (runningURI &amp;&amp; aUrlListener)</span>
<a href="#l8.134"></a><span id="l8.134">     {</span>
<a href="#l8.135"></a><span id="l8.135">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(runningURI));</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+      nsCOMPtr&lt;nsIImapUrl&gt; imapUrl(do_QueryInterface(runningURI));</span>
<a href="#l8.137"></a><span id="l8.137">       if (msgurl)</span>
<a href="#l8.138"></a><span id="l8.138">         msgurl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+      if (imapUrl)</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+        imapUrl-&gt;SetStoreResultsOffline(PR_TRUE);</span>
<a href="#l8.141"></a><span id="l8.141">     }</span>
<a href="#l8.142"></a><span id="l8.142">   }</span>
<a href="#l8.143"></a><span id="l8.143">   return rv;</span>
<a href="#l8.144"></a><span id="l8.144"> }</span>
<a href="#l8.145"></a><span id="l8.145"> </span>
<a href="#l8.146"></a><span id="l8.146"> NS_IMETHODIMP nsImapService::MessageURIToMsgHdr(const char *uri, nsIMsgDBHdr **aRetVal)</span>
<a href="#l8.147"></a><span id="l8.147"> {</span>
<a href="#l8.148"></a><span id="l8.148">   NS_ENSURE_ARG_POINTER(uri);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUrl.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUrl.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -76,17 +76,18 @@ nsImapUrl::nsImapUrl()</span>
<a href="#l9.4"></a><span id="l9.4">   m_listOfMessageIds = nsnull;</span>
<a href="#l9.5"></a><span id="l9.5">   m_tokenPlaceHolder = nsnull;</span>
<a href="#l9.6"></a><span id="l9.6">   m_searchCriteriaString = nsnull;</span>
<a href="#l9.7"></a><span id="l9.7">   m_idsAreUids = PR_FALSE;</span>
<a href="#l9.8"></a><span id="l9.8">   m_mimePartSelectorDetected = PR_FALSE;</span>
<a href="#l9.9"></a><span id="l9.9">   m_allowContentChange = PR_TRUE;  // assume we can do MPOD.</span>
<a href="#l9.10"></a><span id="l9.10">   m_fetchPartsOnDemand = PR_FALSE; // but assume we're not doing it :-)</span>
<a href="#l9.11"></a><span id="l9.11">   m_msgLoadingFromCache = PR_FALSE;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  m_shouldStoreMsgOffline = PR_FALSE;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  m_storeResultsOffline = PR_FALSE;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  m_storeOfflineOnFallback = PR_FALSE;</span>
<a href="#l9.15"></a><span id="l9.15">   m_rerunningUrl = PR_FALSE;</span>
<a href="#l9.16"></a><span id="l9.16">   m_externalLinkUrl = PR_TRUE; // we'll start this at true, and set it false in nsImapService::CreateStartOfImapUrl</span>
<a href="#l9.17"></a><span id="l9.17">   m_contentModified = IMAP_CONTENT_NOT_MODIFIED;</span>
<a href="#l9.18"></a><span id="l9.18">   m_validUrl = PR_TRUE;  // assume the best.</span>
<a href="#l9.19"></a><span id="l9.19">   m_flags = 0;</span>
<a href="#l9.20"></a><span id="l9.20">   m_extraStatus = ImapStatusNone;</span>
<a href="#l9.21"></a><span id="l9.21">   m_onlineSubDirSeparator = '/';</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23" class="difflineat">@@ -1511,26 +1512,39 @@ NS_IMETHODIMP nsImapUrl::GetCharsetOverR</span>
<a href="#l9.24"></a><span id="l9.24"> }</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26"> NS_IMETHODIMP nsImapUrl::SetCharsetOverRide(const char * aCharacterSet)</span>
<a href="#l9.27"></a><span id="l9.27"> {</span>
<a href="#l9.28"></a><span id="l9.28">   mCharsetOverride = aCharacterSet;</span>
<a href="#l9.29"></a><span id="l9.29">   return NS_OK;</span>
<a href="#l9.30"></a><span id="l9.30"> }</span>
<a href="#l9.31"></a><span id="l9.31"> </span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetShouldStoreMsgOffline(PRBool *aShouldStoreMsgOffline)</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetStoreResultsOffline(PRBool *aStoreResultsOffline)</span>
<a href="#l9.34"></a><span id="l9.34"> {</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aShouldStoreMsgOffline);</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-  *aShouldStoreMsgOffline = m_shouldStoreMsgOffline;</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aStoreResultsOffline);</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+  *aStoreResultsOffline = m_storeResultsOffline;</span>
<a href="#l9.39"></a><span id="l9.39">   return NS_OK;</span>
<a href="#l9.40"></a><span id="l9.40"> }</span>
<a href="#l9.41"></a><span id="l9.41"> </span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetShouldStoreMsgOffline(PRBool aShouldStoreMsgOffline)</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetStoreResultsOffline(PRBool aStoreResultsOffline)</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+{</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+  m_storeResultsOffline = aStoreResultsOffline;</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+}</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetStoreOfflineOnFallback(PRBool *aStoreOfflineOnFallback)</span>
<a href="#l9.50"></a><span id="l9.50"> {</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-  m_shouldStoreMsgOffline = aShouldStoreMsgOffline;</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aStoreOfflineOnFallback);</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+  *aStoreOfflineOnFallback = m_storeOfflineOnFallback;</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+}</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetStoreOfflineOnFallback(PRBool aStoreOfflineOnFallback)</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+{</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+  m_storeOfflineOnFallback = aStoreOfflineOnFallback;</span>
<a href="#l9.60"></a><span id="l9.60">   return NS_OK;</span>
<a href="#l9.61"></a><span id="l9.61"> }</span>
<a href="#l9.62"></a><span id="l9.62"> </span>
<a href="#l9.63"></a><span id="l9.63"> NS_IMETHODIMP nsImapUrl::GetMessageHeader(nsIMsgDBHdr ** aMsgHdr)</span>
<a href="#l9.64"></a><span id="l9.64"> {</span>
<a href="#l9.65"></a><span id="l9.65">   nsCString uri;</span>
<a href="#l9.66"></a><span id="l9.66">   nsresult rv = GetUri(getter_Copies(uri));</span>
<a href="#l9.67"></a><span id="l9.67">   NS_ENSURE_SUCCESS(rv, rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUrl.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUrl.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -117,17 +117,19 @@ protected:</span>
<a href="#l10.4"></a><span id="l10.4">   PRPackedBool m_validUrl;</span>
<a href="#l10.5"></a><span id="l10.5">   PRPackedBool m_runningUrl;</span>
<a href="#l10.6"></a><span id="l10.6">   PRPackedBool m_idsAreUids;</span>
<a href="#l10.7"></a><span id="l10.7">   PRPackedBool m_mimePartSelectorDetected;</span>
<a href="#l10.8"></a><span id="l10.8">   PRPackedBool m_allowContentChange;  // if PR_FALSE, we can't use Mime parts on demand</span>
<a href="#l10.9"></a><span id="l10.9">   PRPackedBool m_fetchPartsOnDemand; // if PR_TRUE, we should fetch leave parts on server.</span>
<a href="#l10.10"></a><span id="l10.10">   PRPackedBool m_msgLoadingFromCache; // if PR_TRUE, we might need to mark read on server</span>
<a href="#l10.11"></a><span id="l10.11">   PRPackedBool m_externalLinkUrl; // if PR_TRUE, we're running this url because the user</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  PRPackedBool m_shouldStoreMsgOffline;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  // True if the fetch results should be put in the offline store.</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  PRPackedBool m_storeResultsOffline;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+  PRPackedBool m_storeOfflineOnFallback;</span>
<a href="#l10.16"></a><span id="l10.16">   PRPackedBool m_rerunningUrl; // first attempt running this failed with connection error; retrying</span>
<a href="#l10.17"></a><span id="l10.17">   nsImapContentModifiedType  m_contentModified;</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19">   PRInt32    m_extraStatus;</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21">   nsCString  m_userName;</span>
<a href="#l10.22"></a><span id="l10.22">   nsCString  m_serverKey;</span>
<a href="#l10.23"></a><span id="l10.23">   // event sinks</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapStoreMsgOffline.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,265 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/**</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+ * This test checks if the imap protocol code saves message to</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ * offline stores correctly, when we fetch the message for display.</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+ * It checks:</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+ *   - Normal messages, no attachments.</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+ *   - Message with inline attachment (e.g., image)</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+ *   - Message with non-inline attachment (e.g., .doc file)</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+ *   - Message with mix of attachment types.</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+ */</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+const nsMsgMessageFlags = Ci.nsMsgMessageFlags;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+var gMsgFile1 = do_get_file(&quot;../../mailnews/data/bugmail10&quot;);</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+const gMsgId1 = &quot;200806061706.m56H6RWT004933@mrapp54.mozilla.org&quot;;</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+var gMsgFile2 = do_get_file(&quot;../../mailnews/data/image-attach-test&quot;);</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+const gMsgId2 = &quot;4A947F73.5030709@xxx.com&quot;;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+var gMsgFile3 = do_get_file(&quot;../../mailnews/data/external-attach-test&quot;);</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+const gMsgId3 = &quot;876TY.5030709@xxx.com&quot;;</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+// We use this as a display consumer</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+var streamListener =</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+{</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+  _data: &quot;&quot;,</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+  QueryInterface:</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+    XPCOMUtils.generateQI([Ci.nsIStreamListener, Ci.nsIRequestObserver]),</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+  // nsIRequestObserver</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+  onStartRequest: function(aRequest, aContext) {</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+  },</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+  onStopRequest: function(aRequest, aContext, aStatusCode) {</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+    do_check_eq(aStatusCode, 0);</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+  },</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+  // nsIStreamListener</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+  onDataAvailable: function(aRequest, aContext, aInputStream, aOffset, aCount) {</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+    let scriptStream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+                         .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+    scriptStream.init(aInputStream);</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+    scriptStream.read(aCount);</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+  }</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+};</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+// Adds some messages directly to a mailbox (eg new mail)</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+function addMessagesToServer(messages, mailbox, localFolder)</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+{</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+  let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+                    .getService(Ci.nsIIOService);</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+  // For every message we have, we need to convert it to a file:/// URI</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+  messages.forEach(function (message)</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+  {</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+    let URI = ioService.newFileURI(message.file).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+    message.spec = URI.spec;</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+  });</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+  // Create the imapMessages and store them on the mailbox</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+  messages.forEach(function (message)</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+  {</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+    mailbox.addMessage(new imapMessage(message.spec, mailbox.uidnext++, []));</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+  });</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+}</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+var incomingServer, server;</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+function run_test() {</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+  // This is before any of the actual tests, so...</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+  gTest = 0;</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+  // The server doesn't support more than one connection</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+  prefBranch.setIntPref(&quot;mail.server.server1.max_cached_connections&quot;, 1);</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+  // Make sure no biff notifications happen</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+  // We aren't interested in downloading messages automatically</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.server.server1.offline_download&quot;, true);</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+  // make small threshhold for mpod so our test messages don't have to be big.</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+  // XXX We can't set this pref until the fake server supports body structure.</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+  // So for now, we'll leave it at the default value, which is larger than any of</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+  // our test messages.</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+  // prefBranch.setIntPref(&quot;mail.imap.mime_parts_on_demand_threshold&quot;, 3000);</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+  gIMAPDaemon = new imapDaemon();</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+  loadLocalMailAccount();</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+  let localAccount = acctMgr.createAccount();</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+  let identity = acctMgr.createIdentity();</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+  localAccount.addIdentity(identity);</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+  localAccount.defaultIdentity = identity;</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+  localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+  acctMgr.defaultAccount = localAccount;</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+  // Let's also have another account, using the same identity</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+  let imapAccount = acctMgr.createAccount();</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+  imapAccount.addIdentity(identity);</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+  imapAccount.defaultIdentity = identity;</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+  gMessenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+  gMsgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+                  .createInstance(Components.interfaces.nsIMsgWindow);</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+  // Get the server list...</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+  gIMAPIncomingServer.performExpand(null);</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+  gRootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+  gIMAPInbox = gRootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+  let msgImapFolder = gIMAPInbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+  // these hacks are required because we've created the inbox before</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+  // running initial folder discovery, and adding the folder bails</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+  // out before we set it as verified online, so we bail out, and</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+  // then remove the INBOX folder since it's not verified.</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+  msgImapFolder.hierarchyDelimiter = '/';</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+  msgImapFolder.verifiedAsOnlineFolder = true;</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+  // Add a couple of messages to the INBOX</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+  // this is synchronous, afaik</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+  addMessagesToServer([{file: gMsgFile1, messageId: gMsgId1},</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+                        {file: gMsgFile2, messageId: gMsgId2},</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+                        {file: gMsgFile3, messageId: gMsgId3},</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+//                         {file: gMsgFile5, messageId: gMsgId5},</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+                      ],</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+                        gIMAPDaemon.getMailbox(&quot;INBOX&quot;), gIMAPInbox);</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+  // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+  // all the operations.</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+  do_test_pending();</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+  //start first test</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+  doTest(1);</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+}</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+var gIMAPService;</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+const gTestArray =</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+[</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+  function updateFolder() {</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+    gIMAPInbox.updateFolderWithListener(null, URLListener);</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineplus">+  },</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineplus">+  function selectFirstMsg() {</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+  // We postpone creating the imap service until after we've set the prefs</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+  // that it reads on its startup.</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+  gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+                       .getService(Ci.nsIMsgMessageService);</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+    let db = gIMAPInbox.msgDatabase;</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+    let msg1 = db.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+    let url = new Object;</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+    gIMAPService.DisplayMessage(gIMAPInbox.getUriForMsg(msg1),</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+                                            streamListener,</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+                                            null,</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineplus">+                                            URLListener,</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+                                            null,</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+                                            url);</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+  },</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineplus">+  function select2ndMsg() {</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineplus">+    let msg1 = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineplus">+    do_check_neq(msg1.flags &amp; nsMsgMessageFlags.Offline, 0);</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+    let db = gIMAPInbox.msgDatabase;</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+    let msg2 = db.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+    let url = new Object;</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+    gIMAPService.DisplayMessage(gIMAPInbox.getUriForMsg(msg2),</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+                                            streamListener,</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+                                            null,</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+                                            URLListener,</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+                                            null,</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+                                            url);</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineplus">+  },</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineplus">+  function select3rdMsg() {</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineplus">+    let msg2 = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineplus">+    do_check_neq(msg2.flags &amp; nsMsgMessageFlags.Offline, 0);</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineplus">+    let db = gIMAPInbox.msgDatabase;</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+    let msg3 = db.getMsgHdrForMessageID(gMsgId3);</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+    let url = new Object;</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+    gIMAPService.DisplayMessage(gIMAPInbox.getUriForMsg(msg3),</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+                                            streamListener,</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineplus">+                                            null,</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+                                            URLListener,</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineplus">+                                            null,</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+                                            url);</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineplus">+  },</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+  function verify3rdMsg() {</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+    let msg3 = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId3);</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+    // can't turn this on because our fake server doesn't support body structure.</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+//    do_check_eq(msg3.flags &amp; nsMsgMessageFlags.Offline, 0);</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+    do_timeout(0, &quot;doTest(++gCurTestNum)&quot;);</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+  }</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+]</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+function doTest(test)</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+{</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+  if (test &lt;= gTestArray.length)</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+  {</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+    dump(&quot;Doing test &quot; + test + &quot;\n&quot;);</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+    gCurTestNum = test;</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineplus">+</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+    var testFn = gTestArray[test - 1];</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+    // Set a limit of ten seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineplus">+    do_timeout(10000, &quot;if (gCurTestNum == &quot;+test+&quot;) \</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineplus">+      do_throw('Notifications not received in 10000 ms for operation &quot;+testFn.name+&quot;, current status is '+gCurrStatus);&quot;);</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineplus">+    try {</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineplus">+    testFn();</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineplus">+    } catch(ex) {</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+      gServer.stop();</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineplus">+      do_throw ('TEST FAILED ' + ex);</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineplus">+    }</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineplus">+  }</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineplus">+  else</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineplus">+  {</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineplus">+    do_timeout(1000, &quot;endTest();&quot;);</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineplus">+  }</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineplus">+}</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineplus">+</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineplus">+// nsIURLListener implementation - runs next test</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+var URLListener =</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineplus">+{</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineplus">+  OnStartRunningUrl: function(aURL) {},</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineplus">+  OnStopRunningUrl: function(aURL, aStatus)</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineplus">+  {</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineplus">+    dump(&quot;in OnStopRunningURL &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineplus">+    do_check_eq(aStatus, 0);</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineplus">+    do_timeout(0, &quot;doTest(++gCurTestNum);&quot;);</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineplus">+  }</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+}</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineplus">+function endTest()</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineplus">+{</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineplus">+  // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineplus">+  // server</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineplus">+//  gMessages.clear();</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineplus">+  gMessenger = null;</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineplus">+  gMsgWindow = null;</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineplus">+  gRootFolder = null;</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineplus">+  gIMAPInbox = null;</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineplus">+  gIMAPTrashFolder = null;</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineplus">+  gServer.resetTest();</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineplus">+  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineplus">+  gIMAPIncomingServer = null;</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineplus">+  gLocalInboxFolder = null;</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineplus">+  gLocalIncomingServer = null;</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineplus">+  gServer.performTest();</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineplus">+  gServer.stop();</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineplus">+  let thread = gThreadManager.currentThread;</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineplus">+  while (thread.hasPendingEvents())</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineplus">+    thread.processNextEvent(true);</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineplus">+</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineplus">+  do_test_finished(); // for the one in run_test()</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/mailnews/test/data/external-attach-test</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,63 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+From - Fri Aug 26 16:47:38 2008</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+X-Identity-Key: id2</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+Message-ID: &lt;876TY.5030709@xxx.com&gt;</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+Date: Tue, 26 Aug 2009 17:18:59 -0700</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+From: Foo Bar &lt;xxx@xxx.com&gt;</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+Reply-To: xxx@xxx.com</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US; rv:1.9.1.3pre) Gecko/20090817 Shredder/3.0b4pre</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+MIME-Version: 1.0</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+To: asfd@asdf</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+Subject: external attach test</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+Content-Type: multipart/mixed;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+ boundary=&quot;------------080903080202020605050108&quot;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+This is a multi-part message in MIME format.</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+--------------080903080202020605050108</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+Content-Type: text/html; charset=ISO-8859-1</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+Content-Transfer-Encoding: 7bit</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+&lt;html&gt;</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+&lt;head&gt;</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=ISO-8859-1&quot;&gt;</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+  &lt;title&gt;image attach test&lt;/title&gt;</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+&lt;/head&gt;</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+&lt;body bgcolor=&quot;#ffffff&quot; text=&quot;#000000&quot;&gt;</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+test</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890&lt;br&gt;</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+test</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+&lt;/body&gt;</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+&lt;/html&gt;</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+--------------080903080202020605050108</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+Content-Type: application/pdf;</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+ name=&quot;check.exe&quot;</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+Content-Transfer-Encoding: base64</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+Content-Disposition: attachment;</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+ filename=&quot;check.pdf&quot;</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+R0lGODlhDQANAIMAAAAAAICAgP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+AAAAAAAAACH5BAAAAP8ALAAAAAANAA0AAAQnMMhJqbg4C6k77wJwfRogbsF1huaYsuz6mXRG</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+1varejqI+piKcBIBADs=</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+--------------080903080202020605050108--</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/mailnews/test/data/image-attach-test</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,63 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+From - Fri May 20 16:47:38 2008</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+X-Identity-Key: id2</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+Message-ID: &lt;4A947F73.5030709@xxx.com&gt;</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+Date: Tue, 25 Aug 2009 17:18:59 -0700</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+From: Foo Bar &lt;xxx@xxx.com&gt;</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+Reply-To: xxx@xxx.com</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US; rv:1.9.1.3pre) Gecko/20090817 Shredder/3.0b4pre</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+MIME-Version: 1.0</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+To: asfd@asdf</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+Subject: image attach test</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+Content-Type: multipart/mixed;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+ boundary=&quot;------------080903080202020605050108&quot;</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+This is a multi-part message in MIME format.</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+--------------080903080202020605050108</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+Content-Type: text/html; charset=ISO-8859-1</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+Content-Transfer-Encoding: 7bit</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+&lt;html&gt;</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+&lt;head&gt;</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=ISO-8859-1&quot;&gt;</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+  &lt;title&gt;image attach test&lt;/title&gt;</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+&lt;/head&gt;</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+&lt;body bgcolor=&quot;#ffffff&quot; text=&quot;#000000&quot;&gt;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+test</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890&lt;br&gt;</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+test</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890test</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+&lt;/body&gt;</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+&lt;/html&gt;</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+--------------080903080202020605050108</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+Content-Type: image/gif;</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+ name=&quot;check.gif&quot;</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+Content-Transfer-Encoding: base64</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+Content-Disposition: attachment;</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+ filename=&quot;check.gif&quot;</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+R0lGODlhDQANAIMAAAAAAICAgP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+AAAAAAAAACH5BAAAAP8ALAAAAAANAA0AAAQnMMhJqbg4C6k77wJwfRogbsF1huaYsuz6mXRG</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+1varejqI+piKcBIBADs=</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+--------------080903080202020605050108--</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

