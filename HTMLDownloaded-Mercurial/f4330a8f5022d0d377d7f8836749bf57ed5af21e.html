<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 5347:f4330a8f5022d0d377d7f8836749bf57ed5af21e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f4330a8f5022d0d377d7f8836749bf57ed5af21e" />
<meta property="og:url" content="/comm-central/rev/f4330a8f5022d0d377d7f8836749bf57ed5af21e" />
<meta property="og:description" content="Second bustage fix for bug 495020. Fix a couple of issues, one related to bug 495020 and one related to bug 545221." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f4330a8f5022d0d377d7f8836749bf57ed5af21e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f4330a8f5022d0d377d7f8836749bf57ed5af21e">shortlog</a> |
<a href="/comm-central/log/f4330a8f5022d0d377d7f8836749bf57ed5af21e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f4330a8f5022d0d377d7f8836749bf57ed5af21e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f4330a8f5022d0d377d7f8836749bf57ed5af21e">files</a> |
changeset |
<a href="/comm-central/raw-rev/f4330a8f5022d0d377d7f8836749bf57ed5af21e">raw</a>  | <a href="/comm-central/archive/f4330a8f5022d0d377d7f8836749bf57ed5af21e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Second bustage fix for <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=495020">bug 495020</a>. Fix a couple of issues, one related to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=495020">bug 495020</a> and one related to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=545221">bug 545221</a>.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#105;&#100;&#100;&#104;&#97;&#114;&#116;&#104;&#32;&#65;&#103;&#97;&#114;&#119;&#97;&#108;&#32;&#60;&#115;&#105;&#100;&#46;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 01 Apr 2010 20:06:51 +0530</td></tr>

<tr>
 <td>changeset 5347</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f4330a8f5022d0d377d7f8836749bf57ed5af21e">f4330a8f5022d0d377d7f8836749bf57ed5af21e</a></td>
</tr>



<tr>
<td>parent 5346</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1331ca255dd4851e434869d66cc9cdac368cbdde">1331ca255dd4851e434869d66cc9cdac368cbdde</a>
</td>
</tr>

<tr>
<td>child 5348</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0d37fec983676b139487b4e53f3f1ff4d139b87c">0d37fec983676b139487b4e53f3f1ff4d139b87c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f4330a8f5022d0d377d7f8836749bf57ed5af21e">4123</a></td></tr>
<tr><td>push user</td><td>sid.bugzilla@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 01 Apr 2010 14:39:15 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f4330a8f5022 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f4330a8f5022d0d377d7f8836749bf57ed5af21e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f4330a8f5022d0d377d7f8836749bf57ed5af21e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f4330a8f5022d0d377d7f8836749bf57ed5af21e&newProject=comm-central&newRevision=f4330a8f5022d0d377d7f8836749bf57ed5af21e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f4330a8f5022d0d377d7f8836749bf57ed5af21e&newProject=comm-central&newRevision=f4330a8f5022d0d377d7f8836749bf57ed5af21e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f4330a8f5022d0d377d7f8836749bf57ed5af21e&newProject=comm-central&newRevision=f4330a8f5022d0d377d7f8836749bf57ed5af21e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=495020">495020</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=545221">545221</a></td></tr>




</table></div>

<div class="page_body description">Second bustage fix for <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=495020">bug 495020</a>. Fix a couple of issues, one related to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=495020">bug 495020</a> and one related to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=545221">bug 545221</a>.

1. In test-display-message-with-folder-modes.js, the change in behaviour in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=495020">bug
495020</a> means that the message is in the view at the time it is attempted to be
displayed, thus the folder the message is in isn't expanded. Fix that by
selecting a different folder before changing modes.

2. In messageInjection.js, make sure we use createSubfolder for the inbox and
not addSubfolder. This causes an OnItemAdded notification, which the folder tree
view gets to know that it needs to update itself. Without the fix, the inbox
isn't displayed unless the folder mode is rebuilt. (This used to work earlier
because the default used to be smart folders, and we used to switch to all
folders after creating the inbox. <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=545221">Bug 545221</a> changed that.)</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f4330a8f5022d0d377d7f8836749bf57ed5af21e/mail/test/mozmill/folder-display/test-display-message-with-folder-modes.js">mail/test/mozmill/folder-display/test-display-message-with-folder-modes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f4330a8f5022d0d377d7f8836749bf57ed5af21e/mail/test/mozmill/folder-display/test-display-message-with-folder-modes.js">file</a> |
<a href="/comm-central/annotate/f4330a8f5022d0d377d7f8836749bf57ed5af21e/mail/test/mozmill/folder-display/test-display-message-with-folder-modes.js">annotate</a> |
<a href="/comm-central/diff/f4330a8f5022d0d377d7f8836749bf57ed5af21e/mail/test/mozmill/folder-display/test-display-message-with-folder-modes.js">diff</a> |
<a href="/comm-central/comparison/f4330a8f5022d0d377d7f8836749bf57ed5af21e/mail/test/mozmill/folder-display/test-display-message-with-folder-modes.js">comparison</a> |
<a href="/comm-central/log/f4330a8f5022d0d377d7f8836749bf57ed5af21e/mail/test/mozmill/folder-display/test-display-message-with-folder-modes.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f4330a8f5022d0d377d7f8836749bf57ed5af21e/mailnews/test/resources/messageInjection.js">mailnews/test/resources/messageInjection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f4330a8f5022d0d377d7f8836749bf57ed5af21e/mailnews/test/resources/messageInjection.js">file</a> |
<a href="/comm-central/annotate/f4330a8f5022d0d377d7f8836749bf57ed5af21e/mailnews/test/resources/messageInjection.js">annotate</a> |
<a href="/comm-central/diff/f4330a8f5022d0d377d7f8836749bf57ed5af21e/mailnews/test/resources/messageInjection.js">diff</a> |
<a href="/comm-central/comparison/f4330a8f5022d0d377d7f8836749bf57ed5af21e/mailnews/test/resources/messageInjection.js">comparison</a> |
<a href="/comm-central/log/f4330a8f5022d0d377d7f8836749bf57ed5af21e/mailnews/test/resources/messageInjection.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-display-message-with-folder-modes.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-display-message-with-folder-modes.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -46,29 +46,34 @@</span>
<a href="#l1.4"></a><span id="l1.4">  */</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> var MODULE_NAME = &quot;test-display-message-with-folder-modes&quot;;</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l1.9"></a><span id="l1.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> var folder;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+var dummyFolder;</span>
<a href="#l1.13"></a><span id="l1.13"> var smartInboxFolder;</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15"> var msgHdr;</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> function setupModule(module) {</span>
<a href="#l1.18"></a><span id="l1.18">   let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l1.19"></a><span id="l1.19">   fdh.installInto(module);</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21">   // This is a subfolder of the inbox so that</span>
<a href="#l1.22"></a><span id="l1.22">   // test_display_message_in_smart_folder_mode_works is able to test that we</span>
<a href="#l1.23"></a><span id="l1.23">   // don't attempt to expand any inboxes.</span>
<a href="#l1.24"></a><span id="l1.24">   inboxFolder.createSubfolder(&quot;DisplayMessageWithFolderModesA&quot;, null);</span>
<a href="#l1.25"></a><span id="l1.25">   folder = inboxFolder.getChildNamed(&quot;DisplayMessageWithFolderModesA&quot;);</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+  // This second folder is meant to act as a dummy folder to switch to when we</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+  // want to not be in folder.</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+  inboxFolder.createSubfolder(&quot;DisplayMessageWithFolderModesB&quot;, null);</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+  dummyFolder = inboxFolder.getChildNamed(&quot;DisplayMessageWithFolderModesB&quot;);</span>
<a href="#l1.30"></a><span id="l1.30">   make_new_sets_in_folder(folder, [{count: 5}]);</span>
<a href="#l1.31"></a><span id="l1.31">   // The message itself doesn't really matter, as long as there's at least one</span>
<a href="#l1.32"></a><span id="l1.32">   // in the inbox.</span>
<a href="#l1.33"></a><span id="l1.33">   make_new_sets_in_folder(inboxFolder, [{count: 1}]);</span>
<a href="#l1.34"></a><span id="l1.34"> }</span>
<a href="#l1.35"></a><span id="l1.35"> </span>
<a href="#l1.36"></a><span id="l1.36"> /**</span>
<a href="#l1.37"></a><span id="l1.37">  * Test that displaying a message causes a switch to the default folder mode if</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineat">@@ -95,39 +100,52 @@ function test_display_message_with_folde</span>
<a href="#l1.39"></a><span id="l1.39"> }</span>
<a href="#l1.40"></a><span id="l1.40"> </span>
<a href="#l1.41"></a><span id="l1.41"> /**</span>
<a href="#l1.42"></a><span id="l1.42">  * Test that displaying a message _does not_ cause a switch to the default</span>
<a href="#l1.43"></a><span id="l1.43">  * folder mode if the folder is present in the current folder mode.</span>
<a href="#l1.44"></a><span id="l1.44">  */</span>
<a href="#l1.45"></a><span id="l1.45"> function test_display_message_with_folder_present_in_current_folder_mode() {</span>
<a href="#l1.46"></a><span id="l1.46">   // Mark the folder as a favorite</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-  folder.flags |= Components.interfaces.nsMsgFolderFlags.Favorite;</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+  folder.flags |= Ci.nsMsgFolderFlags.Favorite;</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+  // Also mark the dummy folder as a favorite, in preparation for</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+  // test_display_message_in_smart_folder_mode_works</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+  dummyFolder.flags |= Ci.nsMsgFolderFlags.Favorite;</span>
<a href="#l1.52"></a><span id="l1.52"> </span>
<a href="#l1.53"></a><span id="l1.53">   // Make sure the folder doesn't appear in the favorite folder mode just</span>
<a href="#l1.54"></a><span id="l1.54">   // because it was selected last before switching</span>
<a href="#l1.55"></a><span id="l1.55">   be_in_folder(inboxFolder);</span>
<a href="#l1.56"></a><span id="l1.56"> </span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-  // Switch to favorite folders. Check that the folder is now in the view</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+  // Switch to favorite folders. Check that the folder is now in the view, as is</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+  // the dummy folder</span>
<a href="#l1.60"></a><span id="l1.60">   mc.folderTreeView.mode = &quot;favorite&quot;;</span>
<a href="#l1.61"></a><span id="l1.61">   assert_folder_visible(folder);</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+  assert_folder_visible(dummyFolder);</span>
<a href="#l1.63"></a><span id="l1.63"> </span>
<a href="#l1.64"></a><span id="l1.64">   // Try displaying a message</span>
<a href="#l1.65"></a><span id="l1.65">   display_message_in_folder_tab(msgHdr);</span>
<a href="#l1.66"></a><span id="l1.66"> </span>
<a href="#l1.67"></a><span id="l1.67">   assert_folder_mode(&quot;favorite&quot;);</span>
<a href="#l1.68"></a><span id="l1.68">   assert_folder_selected_and_displayed(folder);</span>
<a href="#l1.69"></a><span id="l1.69">   assert_selected_and_displayed(msgHdr);</span>
<a href="#l1.70"></a><span id="l1.70"> }</span>
<a href="#l1.71"></a><span id="l1.71"> </span>
<a href="#l1.72"></a><span id="l1.72"> /**</span>
<a href="#l1.73"></a><span id="l1.73">  * Test that displaying a message in smart folders mode causes the parent in the</span>
<a href="#l1.74"></a><span id="l1.74">  * view to expand.</span>
<a href="#l1.75"></a><span id="l1.75">  */</span>
<a href="#l1.76"></a><span id="l1.76"> function test_display_message_in_smart_folder_mode_works() {</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+  // Clear the message selection, otherwise msgHdr will still be displayed and</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+  // display_message_in_folder_tab(msgHdr) will be a no-op.</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+  select_none();</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+  // Switch to the dummy folder, otherwise msgHdr will be in the view and the</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+  // display message in folder tab logic will simply select the message without</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+  // bothering to expand any folders.</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+  be_in_folder(dummyFolder);</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+</span>
<a href="#l1.85"></a><span id="l1.85">   mc.folderTreeView.mode = &quot;smart&quot;;</span>
<a href="#l1.86"></a><span id="l1.86"> </span>
<a href="#l1.87"></a><span id="l1.87">   let rootFolder = folder.server.rootFolder;</span>
<a href="#l1.88"></a><span id="l1.88">   // Check that the folder is actually the child of the account root</span>
<a href="#l1.89"></a><span id="l1.89">   assert_folder_child_in_view(folder, rootFolder);</span>
<a href="#l1.90"></a><span id="l1.90"> </span>
<a href="#l1.91"></a><span id="l1.91">   // Collapse everything</span>
<a href="#l1.92"></a><span id="l1.92">   smartInboxFolder = get_smart_folder_named(&quot;Inbox&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/test/resources/messageInjection.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/test/resources/messageInjection.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -110,17 +110,18 @@ function configure_message_injection(aIn</span>
<a href="#l2.4"></a><span id="l2.4">     identity.email = &quot;sender@nul.nul&quot;;</span>
<a href="#l2.5"></a><span id="l2.5">     localAccount.addIdentity(identity);</span>
<a href="#l2.6"></a><span id="l2.6">     localAccount.defaultIdentity = identity;</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">     mis.incomingServer = acctMgr.localFoldersServer;</span>
<a href="#l2.9"></a><span id="l2.9">     // Note: Inbox is not created automatically when there is no deferred server,</span>
<a href="#l2.10"></a><span id="l2.10">     // so we need to create it.</span>
<a href="#l2.11"></a><span id="l2.11">     mis.rootFolder = mis.incomingServer.rootMsgFolder;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    mis.inboxFolder = mis.rootFolder.addSubfolder(&quot;Inbox&quot;);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    mis.rootFolder.createSubfolder(&quot;Inbox&quot;, null);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    mis.inboxFolder = mis.rootFolder.getChildNamed(&quot;Inbox&quot;);</span>
<a href="#l2.15"></a><span id="l2.15">     // a local inbox should have a Mail flag!</span>
<a href="#l2.16"></a><span id="l2.16">     mis.inboxFolder.setFlag(Ci.nsMsgFolderFlags.Mail);</span>
<a href="#l2.17"></a><span id="l2.17">     mis.inboxFolder.setFlag(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l2.18"></a><span id="l2.18">     _messageInjectionSetup.notifyListeners(&quot;onRealFolderCreated&quot;,</span>
<a href="#l2.19"></a><span id="l2.19">                                            [mis.inboxFolder]);</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21">     // Force an initialization of the Inbox folder database.</span>
<a href="#l2.22"></a><span id="l2.22">     let unused = mis.inboxFolder.prettiestName;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

